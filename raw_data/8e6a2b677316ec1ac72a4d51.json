{
    "url": "http://localhost:9999/cghr/cgForm/misc/test-lib/angualr-1.0.8.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/cghr/cgForm/misc/test-lib/angualr-1.0.8.js",
                "path": "/cghr/cgForm/misc/test-lib/angualr-1.0.8.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jZ2hyL2NnRm9ybS9taXNjL3Rlc3QtbGliL2FuZ3VhbHItMS4wLjguanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjA5Njk2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDE0OjU2OjI4IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxNDo1NjoyNSBHTVQNCg0KLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4wLjgKICogKGMpIDIwMTAtMjAxMiBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7fTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFVwcGVyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b1VwcGVyQ2FzZSgpIDogc3RyaW5nO307CgoKICAgIHZhciBtYW51YWxMb3dlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7fSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bYS16XS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpO30pCiAgICAgICAgICAgIDogczsKICAgIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICAgIGlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICAgIH0KCgogICAgdmFyIC8qKiBob2xkcyBtYWpvciB2ZXJzaW9uIG51bWJlciBmb3IgSUUgb3IgTmFOIGZvciByZWFsIGJyb3dzZXJzICovCiAgICAgICAgICAgIG1zaWUgICAgICAgICAgICAgID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSksCiAgICAgICAganFMaXRlLCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZyBzaW5jZSBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGFmdGVyIHVzLgogICAgICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgICAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgICAgIHB1c2ggICAgICAgICAgICAgID0gW10ucHVzaCwKICAgICAgICB0b1N0cmluZyAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgogICAgICAgIC8qKiBAbmFtZSBhbmd1bGFyICovCiAgICAgICAgICAgIGFuZ3VsYXIgICAgICAgICAgID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddOwoKCiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9iagogICAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGBvYmpgIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2Ugb2JqZWN0IChOb2RlTGlzdCwgQXJndW1lbnRzLCAuLi4pCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogICAgICAgIGlmICghb2JqIHx8ICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicpKSByZXR1cm4gZmFsc2U7CgogICAgICAgIC8vIFdlIGhhdmUgb24gb2JqZWN0IHdoaWNoIGhhcyBsZW5ndGggcHJvcGVydHkuIFNob3VsZCB3ZSB0cmVhdCBpdCBhcyBhcnJheT8KICAgICAgICBpZiAodHlwZW9mIG9iai5oYXNPd25Qcm9wZXJ0eSAhPSAnZnVuY3Rpb24nICYmCiAgICAgICAgICAgIHR5cGVvZiBvYmouY29uc3RydWN0b3IgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAvLyBUaGlzIGlzIGhlcmUgZm9yIElFODogaXQgaXMgYSBib2d1cyBvYmplY3QgdHJlYXQgaXQgYXMgYXJyYXk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgSlFMaXRlIHx8ICAgICAgICAgICAgICAgICAgICAgIC8vIEpRTGl0ZQogICAgICAgICAgICAgICAgKGpRdWVyeSAmJiBvYmogaW5zdGFuY2VvZiBqUXVlcnkpIHx8ICAgICAgICAgIC8vIGpRdWVyeQogICAgICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChvYmopICE9PSAnW29iamVjdCBPYmplY3RdJyB8fCAgIC8vIHNvbWUgYnJvd3NlciBuYXRpdmUgb2JqZWN0CiAgICAgICAgICAgICAgICB0eXBlb2Ygb2JqLmNhbGxlZSA9PT0gJ2Z1bmN0aW9uJzsgICAgICAgICAgICAgIC8vIGFyZ3VtZW50cyAob24gSUU4IGxvb2tzIGxpa2UgcmVndWxhciBvYmopCiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgICAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5KWAsIHdoZXJlIGB2YWx1ZWAKICAgICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIHdhcyBwcmV2aW91c2x5IGtub3duIGFzIGBhbmd1bGFyLmZvcmVhY2hgLgogICAgICoKICAgICA8cHJlPgogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5OwogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSl7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmIG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgICAgICAgICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBvYmoubGVuZ3RoOyBrZXkrKykKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gc29ydGVkS2V5cyhvYmopIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ga2V5cy5zb3J0KCk7CiAgICB9CgogICAgZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzOwogICAgfQoKCiAgICAvKioKICAgICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSkgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZShpbmRleCkgewogICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGRpZ2l0ID09IDU3IC8qJzknKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICAgICAgICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHVpZC51bnNoaWZ0KCcwJyk7CiAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTZXQgb3IgY2xlYXIgdGhlIGhhc2hrZXkgZm9yIGFuIG9iamVjdC4KICAgICAqIEBwYXJhbSBvYmogb2JqZWN0CiAgICAgKiBAcGFyYW0gaCB0aGUgaGFzaGtleSAoIXRydXRoeSB0byBkZWxldGUgdGhlIGhhc2hrZXkpCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldEhhc2hLZXkob2JqLCBoKSB7CiAgICAgICAgaWYgKGgpIHsKICAgICAgICAgICAgb2JqLiQkaGFzaEtleSA9IGg7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBkZWxldGUgb2JqLiQkaGFzaEtleTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZXh0ZW5kCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV4dGVuZHMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBgZHN0YCBieSBjb3B5aW5nIGFsbCBvZiB0aGUgcHJvcGVydGllcyBmcm9tIHRoZSBgc3JjYCBvYmplY3QocykKICAgICAqIHRvIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZHN0IERlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBzcmMgU291cmNlIG9iamVjdChzKS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJlZmVyZW5jZSB0byBgZHN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogICAgICAgIHZhciBoID0gZHN0LiQkaGFzaEtleTsKICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNldEhhc2hLZXkoZHN0LGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpIHt9LCB7cHJvdG90eXBlOnBhcmVudH0pKSgpLCBleHRyYSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLm5vb3AKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIG5vIG9wZXJhdGlvbnMuIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiBmb28oY2FsbGJhY2spIHsKICAgICAgIHZhciByZXN1bHQgPSBjYWxjdWxhdGVSZXN1bHQoKTsKICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgfQogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkge30KICAgIG5vb3AuJGluamVjdCA9IFtdOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICAqCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGFuZ3VsYXIuaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBpZGVudGl0eSgkKSB7cmV0dXJuICQ7fQogICAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7cmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiB2YWx1ZTt9O30KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSAhPSAndW5kZWZpbmVkJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICAgICAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYE9iamVjdGAgYnV0IG5vdCBgbnVsbGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXtyZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCc7fQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnO30KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNOdW1iZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKXsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IERhdGVdJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNBcnJheQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IEFycmF5XSc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBGdW5jdGlvbmAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nO30KCgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24gb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgUmVnRXhwYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IFJlZ0V4cF0nOwogICAgfQoKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAgICovCiAgICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdib29sZWFuJzsKICAgIH0KCgogICAgdmFyIHRyaW0gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gbmF0aXZlIHRyaW0gaXMgd2F5IGZhc3RlcjogaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhci10cmltLXRlc3QKICAgICAgICAvLyBidXQgSUUgZG9lc24ndCBoYXZlIGl0Li4uIDotKAogICAgICAgIC8vIFRPRE86IHdlIHNob3VsZCBtb3ZlIHRoaXMgaW50byBJRS9FUzUgcG9seWZpbGwKICAgICAgICBpZiAoIVN0cmluZy5wcm90b3R5cGUudHJpbSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS50cmltKCkgOiB2YWx1ZTsKICAgICAgICB9OwogICAgfSkoKTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAgICovCiAgICBmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiBub2RlICYmCiAgICAgICAgICAgIChub2RlLm5vZGVOYW1lICAvLyB3ZSBhcmUgYSBkaXJlY3QgZWxlbWVudAogICAgICAgICAgICAgICAgfHwgKG5vZGUuYmluZCAmJiBub2RlLmZpbmQpKTsgIC8vIHdlIGhhdmUgYSBiaW5kIGFuZCBmaW5kIG1ldGhvZCBwYXJ0IG9mIGpRdWVyeSBBUEkKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSBzdHIgJ2tleTEsa2V5MiwuLi4nCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7a2V5MTp0cnVlLCBrZXkyOnRydWUsIC4uLn0KICAgICAqLwogICAgZnVuY3Rpb24gbWFrZU1hcChzdHIpewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrICkKICAgICAgICAgICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKCiAgICBpZiAobXNpZSA8IDkpIHsKICAgICAgICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgICAgICAgICAgPyB1cHBlcmNhc2UoZWxlbWVudC5zY29wZU5hbWUgKyAnOicgKyBlbGVtZW50Lm5vZGVOYW1lKSA6IGVsZW1lbnQubm9kZU5hbWU7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICAgICAqIHRoZSBsZW5ndGggb2YgYSBzdHJpbmcuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW293blByb3BzT25seT1mYWxzZV0gQ291bnQgb25seSAib3duIiBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdAogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShvYmosIG93blByb3BzT25seSkgewogICAgICAgIHZhciBzaXplID0gMCwga2V5OwoKICAgICAgICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKXsKICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKQogICAgICAgICAgICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNpemU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluY2x1ZGVzKGFycmF5LCBvYmopIHsKICAgICAgICByZXR1cm4gaW5kZXhPZihhcnJheSwgb2JqKSAhPSAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICAgICAgICBpZiAoYXJyYXkuaW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2Yob2JqKTsKCiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gYXJyYXlSZW1vdmUoYXJyYXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogICAgICAgIGlmIChpbmRleCA+PTApCiAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgIk9QVElPTiI6CiAgICAgICAgICAgICAgICBjYXNlICJQUkUiOgogICAgICAgICAgICAgICAgY2FzZSAiVElUTEUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5jb3B5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAsIHdoaWNoIHNob3VsZCBiZSBhbiBvYmplY3Qgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICAgICAqICogSWYgYSBkZXN0aW5hdGlvbiBpcyBwcm92aWRlZCwgYWxsIG9mIGl0cyBlbGVtZW50cyAoZm9yIGFycmF5KSBvciBwcm9wZXJ0aWVzIChmb3Igb2JqZWN0cykKICAgICAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAgICAgKiAqIElmICBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5LCBgc291cmNlYCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICAgICAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSwgaW5jbHVkaW5nIHByaW1pdGl2ZXMsIGBudWxsYCwgYW5kIGB1bmRlZmluZWRgLgogICAgICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAgICAgKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgY29weSBvciB1cGRhdGVkIGBkZXN0aW5hdGlvbmAsIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weShzb3VyY2UsIGRlc3RpbmF0aW9uKXsKICAgICAgICBpZiAoaXNXaW5kb3coc291cmNlKSB8fCBpc1Njb3BlKHNvdXJjZSkpIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IFdpbmRvdyBvciBTY29wZSIpOwogICAgICAgIGlmICghZGVzdGluYXRpb24pIHsKICAgICAgICAgICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGF0ZShzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIHt9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBFcnJvcigiQ2FuJ3QgY29weSBlcXVpdmFsZW50IG9iamVjdHMgb3IgYXJyYXlzIik7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgICAgICAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uW2tleV0gPSBjb3B5KHNvdXJjZVtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEhhc2hLZXkoZGVzdGluYXRpb24saCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgICAgZm9yKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgICAgIGlmIChzcmMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuc3Vic3RyKDAsIDIpICE9PSAnJCQnKSB7CiAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZHN0OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhciBleHByZXNzaW9ucywgYXJyYXlzIGFuZAogICAgICogb2JqZWN0cy4KICAgICAqCiAgICAgKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogICAgICoKICAgICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgICAqICogQm90aCB2YWx1ZXMgYXJlIE5hTi4gKEluIEphdmFzU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICAgICAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YXNTY3JpcHQsCiAgICAgKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAgICAgKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogICAgICoKICAgICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzaW9uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAgICAgKiB0aGF0IGJlZ2luIHdpdGggYCRgIGFyZSBpZ25vcmVkLgogICAgICoKICAgICAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gbzEgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYXJndW1lbnRzIGFyZSBlcXVhbC4KICAgICAqLwogICAgZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogICAgICAgIGlmIChvMSA9PT0gbzIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICAgICAgICB2YXIgdDEgPSB0eXBlb2YgbzEsIHQyID0gdHlwZW9mIG8yLCBsZW5ndGgsIGtleSwga2V5U2V0OwogICAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgICAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG8xKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihrZXk9MDsga2V5PGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAobzEpICYmIGlzUmVnRXhwKG8yKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvMS50b1N0cmluZygpID09IG8yLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1Njb3BlKG8xKSB8fCBpc1Njb3BlKG8yKSB8fCBpc1dpbmRvdyhvMSkgfHwgaXNXaW5kb3cobzIpIHx8IGlzQXJyYXkobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAga2V5U2V0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZm9yKGtleSBpbiBvMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvcihrZXkgaW4gbzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZXlTZXRba2V5XSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSkKICAgICAgICAgICAgICAgICAgICA6IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICAgICAgaWYgKC9eXCQrLy50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmICBkb2N1bWVudCA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgdmFsID0gJyRET0NVTUVOVCc7CiAgICAgICAgfSBlbHNlIGlmIChpc1Njb3BlKHZhbHVlKSkgewogICAgICAgICAgICB2YWwgPSAnJFNDT1BFJzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWw7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnRvSnNvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXJpYWxpemVzIGlucHV0IGludG8gYSBKU09OLWZvcm1hdHRlZCBzdHJpbmcuIFByb3BlcnRpZXMgd2l0aCBsZWFkaW5nICQgY2hhcmFjdGVycyB3aWxsIGJlCiAgICAgKiBzdHJpcHBlZCBzaW5jZSBhbmd1bGFyIHVzZXMgdGhpcyBub3RhdGlvbiBpbnRlcm5hbGx5LgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogICAgICogQHJldHVybnMge3N0cmluZ3x1bmRlZmluZWR9IEpzb25pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGpzb24gSlNPTiBzdHJpbmcgdG8gZGVzZXJpYWxpemUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICAgICAqLwogICAgZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogICAgICAgIHJldHVybiBpc1N0cmluZyhqc29uKQogICAgICAgICAgICA/IEpTT04ucGFyc2UoanNvbikKICAgICAgICAgICAgOiBqc29uOwogICAgfQoKCiAgICBmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgICAgICAgICB2YWx1ZSA9ICEodiA9PSAnZicgfHwgdiA9PSAnMCcgfHwgdiA9PSAnZmFsc2UnIHx8IHYgPT0gJ25vJyB8fCB2ID09ICduJyB8fCB2ID09ICdbXScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgICAgICAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgIC8vIEFzIFBlciBET00gU3RhbmRhcmRzCiAgICAgICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICAgICAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgICAgICAgICAgZWxlbUh0bWwuCiAgICAgICAgICAgICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9ePChbXHdcLV0rKS8sIGZ1bmN0aW9uKG1hdGNoLCBub2RlTmFtZSkgeyByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsgfSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogVHJpZXMgdG8gZGVjb2RlIHRoZSBVUkkgY29tcG9uZW50IHdpdGhvdXQgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0gc3RyIHZhbHVlIHBvdGVudGlhbCBVUkkgY29tcG9uZW50IHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBjYW4gYmUgZGVjb2RlZAogICAgICogd2l0aCB0aGUgZGVjb2RlVVJJQ29tcG9uZW50IGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiB0cnlEZWNvZGVVUklDb21wb25lbnQodmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgLy8gSWdub3JlIGFueSBpbnZhbGlkIHVyaSBjb21wb25lbnQKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEByZXR1cm5zIE9iamVjdC48KHN0cmluZ3xib29sZWFuKT4KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgICAgICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24oa2V5VmFsdWUpewogICAgICAgICAgICBpZiAoIGtleVZhbHVlICkgewogICAgICAgICAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgIGtleSA9IHRyeURlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICAgICAgICAgICAgaWYgKCBpc0RlZmluZWQoa2V5KSApIHsKICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IGlzRGVmaW5lZChrZXlfdmFsdWVbMV0pID8gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICBmdW5jdGlvbiB0b0tleVZhbHVlKG9iaikgewogICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwogICAgfQoKCiAgICAvKioKICAgICAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZG9lc24ndCBmb2xsb3cKICAgICAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogICAgICogc2VnbWVudHM6CiAgICAgKiAgICBzZWdtZW50ICAgICAgID0gKnBjaGFyCiAgICAgKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogICAgICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogICAgICAgIHJldHVybiBlbmNvZGVVcmlRdWVyeSh2YWwsIHRydWUpLgogICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJCL2dpLCAnKycpOwogICAgfQoKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGludGVuZGVkIGZvciBlbmNvZGluZyAqa2V5KiBvciAqdmFsdWUqIHBhcnRzIG9mIHF1ZXJ5IGNvbXBvbmVudC4gV2UgbmVlZCBhIGN1c3RvbQogICAgICogbWV0aG9kIGJlY3Vhc2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgICAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAgICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICByZXBsYWNlKC8lNDAvZ2ksICdAJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzQS9naSwgJzonKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyQy9naSwgJywnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTIwL2csIChwY3RFbmNvZGVTcGFjZXMgPyAnJTIwJyA6ICcrJykpOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0FwcAogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICAgICAqICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZX0gbmFtZSB0byBsb2FkLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byBhdXRvLWJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4gT25seQogICAgICogb25lIG5nQXBwIGRpcmVjdGl2ZSBjYW4gYmUgdXNlZCBwZXIgSFRNTCBkb2N1bWVudC4gVGhlIGRpcmVjdGl2ZQogICAgICogZGVzaWduYXRlcyB0aGUgcm9vdCBvZiB0aGUgYXBwbGljYXRpb24gYW5kIGlzIHR5cGljYWxseSBwbGFjZWQKICAgICAqIGF0IHRoZSByb290IG9mIHRoZSBwYWdlLgogICAgICoKICAgICAqIFRoZSBmaXJzdCBuZ0FwcCBmb3VuZCBpbiB0aGUgZG9jdW1lbnQgd2lsbCBiZSBhdXRvLWJvb3RzdHJhcHBlZC4gVG8gdXNlIG11bHRpcGxlIGFwcGxpY2F0aW9ucyBpbiBhbgogICAgICogSFRNTCBkb2N1bWVudCB5b3UgbXVzdCBtYW51YWxseSBib290c3RyYXAgdGhlbSB1c2luZyB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9LgogICAgICogQXBwbGljYXRpb25zIGNhbm5vdCBiZSBuZXN0ZWQuCiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUgYmVsb3cgaWYgdGhlIGBuZ0FwcGAgZGlyZWN0aXZlIHdvdWxkIG5vdCBiZSBwbGFjZWQKICAgICAqIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZSBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQKICAgICAqIGFuZCB0aGUgYHt7IDErMiB9fWAgd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICAgICAqCiAgICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0IHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBJIGNhbiBhZGQ6IDEgKyAyID0gIHt7IDErMiB9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBuYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGFwcGVuZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChuYW1lKSk7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoJzonLCAnXFw6Jyk7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwpIHsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUpLCBhcHBlbmQpOwogICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSArICdcXDonKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbJyArIG5hbWUgKyAnXScpLCBhcHBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKCFhcHBFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICc7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBOR19BUFBfQ0xBU1NfUkVHRVhQLmV4ZWMoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IChtYXRjaFsyXSB8fCAnJykucmVwbGFjZSgvXHMrL2csICcsJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgbmdTY2VuYXJpby1iYXNlZCBlbmQtdG8tZW5kIHRlc3RzIGNhbm5vdCB1c2UgdGhpcyBmdW5jdGlvbiB0byBib290c3RyYXAgbWFudWFsbHkuCiAgICAgKiBUaGV5IG11c3QgdXNlIHtAbGluayBhcGkvbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzIHx8IFtdOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KCduZycpOwogICAgICAgICAgICB2YXIgaW5qZWN0b3IgPSBjcmVhdGVJbmplY3Rvcihtb2R1bGVzKTsKICAgICAgICAgICAgaW5qZWN0b3IuaW52b2tlKFsnJHJvb3RTY29wZScsICckcm9vdEVsZW1lbnQnLCAnJGNvbXBpbGUnLCAnJGluamVjdG9yJywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvcikgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKCckaW5qZWN0b3InLCBpbmplY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfV0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuIGluamVjdG9yOwogICAgICAgIH07CgogICAgICAgIHZhciBOR19ERUZFUl9CT09UU1RSQVAgPSAvXk5HX0RFRkVSX0JPT1RTVFJBUCEvOwoKICAgICAgICBpZiAod2luZG93ICYmICFOR19ERUZFUl9CT09UU1RSQVAudGVzdCh3aW5kb3cubmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGRvQm9vdHN0cmFwKCk7CiAgICAgICAgfQoKICAgICAgICB3aW5kb3cubmFtZSA9IHdpbmRvdy5uYW1lLnJlcGxhY2UoTkdfREVGRVJfQk9PVFNUUkFQLCAnJyk7CiAgICAgICAgYW5ndWxhci5yZXN1bWVCb290c3RyYXAgPSBmdW5jdGlvbihleHRyYU1vZHVsZXMpIHsKICAgICAgICAgICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CiAgICBmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcil7CiAgICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICdfJzsKICAgICAgICByZXR1cm4gbmFtZS5yZXBsYWNlKFNOQUtFX0NBU0VfUkVHRVhQLCBmdW5jdGlvbihsZXR0ZXIsIHBvcykgewogICAgICAgICAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAgICAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICAgICAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgICAgIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogICAgICAgIGlmIChqUXVlcnkpIHsKICAgICAgICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICAgICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgICAgICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICAgICAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIE1ldGhvZCBzaWduYXR1cmU6IEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKG5hbWUsIGRpc3BhdGNoVGhpcywgZmlsdGVyRWxlbXMsIGdldHRlcklmTm9Bcmd1bWVudHMpCiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdlbXB0eScsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnaHRtbCcsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganFMaXRlID0gSlFMaXRlOwogICAgICAgIH0KICAgICAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgJyIgKyAobmFtZSB8fCAnPycpICsgIicgaXMgIiArIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgICAgICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgICAgICB9CgogICAgICAgIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAgICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NpYmxlIGZyb20gdGhlIG9iamVjdCBieSBwYXRoLiBBbnkgdW5kZWZpbmVkIHRyYXZlcnNhbHMgYXJlIGlnbm9yZWQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogc3RhcnRpbmcgb2JqZWN0CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBwYXRoIHRvIHRyYXZlcnNlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49dHJ1ZX0gYmluZEZuVG9TY29wZQogICAgICogQHJldHVybnMgdmFsdWUgYXMgYWNjZXNzaWJsZSBieSBwYXRoCiAgICAgKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnRlcmZhY2UKICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogICAgICovCgogICAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnN1cmUoZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpLCAnbW9kdWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZyBhbmQgcmVnaXN0ZXJpbmcgQW5ndWxhciBtb2R1bGVzLiBBbGwKICAgICAgICAgICAgICogbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIyBNb2R1bGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsZWN0aW9uIG9mIHNlcnZpY2VzLCBkaXJlY3RpdmVzLCBmaWx0ZXJzLCBhbmQgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICogYGFuZ3VsYXIubW9kdWxlYCBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICAgICAgICogbXlNb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGVuIHlvdSBjYW4gY3JlYXRlIGFuIGluamVjdG9yIGFuZCBsb2FkIHlvdXIgbW9kdWxlcyBsaWtlIHRoaXM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIHZhciBpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZycsICdNeU1vZHVsZSddKQogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSG93ZXZlciBpdCdzIG1vcmUgbGlrZWx5IHRoYXQgeW91J2xsIGp1c3QgdXNlCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPj19IHJlcXVpcmVzIElmIHNwZWNpZmllZCB0aGVuIG5ldyBtb2R1bGUgaXMgYmVpbmcgY3JlYXRlZC4gSWYgdW5zcGVjaWZpZWQgdGhlbiB0aGUKICAgICAgICAgICAgICogICAgICAgIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdObyBtb2R1bGU6ICcgKyBuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxBcnJheS48Kj4+fSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBpbnZva2VRdWV1ZSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48RnVuY3Rpb24+fSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbmZpZyA9IGludm9rZUxhdGVyKCckaW5qZWN0b3InLCAnaW52b2tlJyk7CgogICAgICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7YW5ndWxhci5Nb2R1bGV9ICovCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBQcml2YXRlIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnZva2VRdWV1ZTogaW52b2tlUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgIF9ydW5CbG9ja3M6IHJ1bkJsb2NrcywKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcmVxdWlyZXMKICAgICAgICAgICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBMaXN0IG9mIG1vZHVsZSBuYW1lcyB3aGljaCBtdXN0IGJlIGxvYWRlZCBiZWZvcmUgdGhpcyBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBIb2xkcyB0aGUgbGlzdCBvZiBtb2R1bGVzIHdoaWNoIHRoZSBpbmplY3RvciB3aWxsIGxvYWQgYmVmb3JlIHRoZSBjdXJyZW50IG1vZHVsZSBpcyBsb2FkZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlczogcmVxdWlyZXMsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gTmFtZSBvZiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCgoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlclR5cGUgQ29uc3RydWN0aW9uIGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIgJHByb3ZpZGUucHJvdmlkZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3Byb3ZpZGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmYWN0b3J5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJGdW5jdGlvbiBGdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdmYWN0b3J5JyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdzZXJ2aWNlJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSN2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IFNlcnZpY2UgaW5zdGFuY2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlICRwcm92aWRlLnZhbHVlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICd2YWx1ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uc3RhbnQKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGNvbnN0YW50IG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBvYmplY3QgQ29uc3RhbnQgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIHRoZSBjb25zdGFudCBhcmUgZml4ZWQsIHRoZXkgZ2V0IGFwcGxpZWQgYmVmb3JlIG90aGVyIHByb3ZpZGUgbWV0aG9kcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI2NvbnN0YW50ICRwcm92aWRlLmNvbnN0YW50KCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3RhbnQ6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdjb25zdGFudCcsICd1bnNoaWZ0JyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEZpbHRlciBuYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBmaWx0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRmaWx0ZXJQcm92aWRlciNyZWdpc3RlciAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgZGlyZWN0aXZlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAgICAgICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gb24gbW9kdWxlIGxvYWQuIFVzZWZ1bCBmb3Igc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggbmVlZHMgdG8gYmUgcGVyZm9ybWVkIG9uIG1vZHVsZSBsb2FkaW5nLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGluaXRpYWxpemF0aW9uRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGFmdGVyIGluamVjdG9yIGNyZWF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggc2hvdWxkIGJlIHBlcmZvcm1lZCB3aGVuIHRoZSBpbmplY3RvciBpcyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBydW46IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChibG9jayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWdGbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcoY29uZmlnRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgICAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogICAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgICAqLwogICAgdmFyIHZlcnNpb24gPSB7CiAgICAgICAgZnVsbDogJzEuMC44JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAwLAogICAgICAgIGRvdDogOCwKICAgICAgICBjb2RlTmFtZTogJ2J1YmJsZS1idXJzdCcKICAgIH07CgoKICAgIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKXsKICAgICAgICBleHRlbmQoYW5ndWxhciwgewogICAgICAgICAgICAnYm9vdHN0cmFwJzogYm9vdHN0cmFwLAogICAgICAgICAgICAnY29weSc6IGNvcHksCiAgICAgICAgICAgICdleHRlbmQnOiBleHRlbmQsCiAgICAgICAgICAgICdlcXVhbHMnOiBlcXVhbHMsCiAgICAgICAgICAgICdlbGVtZW50JzoganFMaXRlLAogICAgICAgICAgICAnZm9yRWFjaCc6IGZvckVhY2gsCiAgICAgICAgICAgICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICAgICAgICAgICAnbm9vcCc6bm9vcCwKICAgICAgICAgICAgJ2JpbmQnOmJpbmQsCiAgICAgICAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAgICAgICAnaWRlbnRpdHknOmlkZW50aXR5LAogICAgICAgICAgICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAgICAgICAgICAgJ2lzRGVmaW5lZCc6IGlzRGVmaW5lZCwKICAgICAgICAgICAgJ2lzU3RyaW5nJzogaXNTdHJpbmcsCiAgICAgICAgICAgICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAgICAgICAgICAgJ2lzT2JqZWN0JzogaXNPYmplY3QsCiAgICAgICAgICAgICdpc051bWJlcic6IGlzTnVtYmVyLAogICAgICAgICAgICAnaXNFbGVtZW50JzogaXNFbGVtZW50LAogICAgICAgICAgICAnaXNBcnJheSc6IGlzQXJyYXksCiAgICAgICAgICAgICd2ZXJzaW9uJzogdmVyc2lvbiwKICAgICAgICAgICAgJ2lzRGF0ZSc6IGlzRGF0ZSwKICAgICAgICAgICAgJ2xvd2VyY2FzZSc6IGxvd2VyY2FzZSwKICAgICAgICAgICAgJ3VwcGVyY2FzZSc6IHVwcGVyY2FzZSwKICAgICAgICAgICAgJ2NhbGxiYWNrcyc6IHtjb3VudGVyOiAwfQogICAgICAgIH0pOwoKICAgICAgICBhbmd1bGFyTW9kdWxlID0gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogICAgICAgIH0KCiAgICAgICAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgICAgICAgICBmdW5jdGlvbiBuZ01vZHVsZSgkcHJvdmlkZSkgewogICAgICAgICAgICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJyRjb21waWxlJywgJENvbXBpbGVQcm92aWRlcikuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQ6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYTogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdDogc2NyaXB0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb246IG9wdGlvbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdCaW5kOiBuZ0JpbmREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZEh0bWxVbnNhZmU6IG5nQmluZEh0bWxVbnNhZmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZFRlbXBsYXRlOiBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzczogbmdDbGFzc0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NsYXNzT2RkOiBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NzcDogbmdDc3BEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ29udHJvbGxlcjogbmdDb250cm9sbGVyRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0Zvcm06IG5nRm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdOb25CaW5kYWJsZTogbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdQbHVyYWxpemU6IG5nUGx1cmFsaXplRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU2hvdzogbmdTaG93RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmlldzogbmdWaWV3RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZTogJFJvdXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiAkUm91dGVQYXJhbXNQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAgICAgKiBBbmd1bGFyJ3MgbGl0ZSB2ZXJzaW9uIG9mIGpRdWVyeSBwcm92aWRlcyBvbmx5IHRoZSBmb2xsb3dpbmcgalF1ZXJ5IG1ldGhvZHM6CiAgICAgKgogICAgICogLSBbYWRkQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICAgICAqIC0gW2FmdGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAgICAgKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAgICAgKiAtIFthdHRyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICAgICAqIC0gW2JpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2JpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAgICogLSBbY2hpbGRyZW4oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbY2xvbmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICAgICAqIC0gW2NvbnRlbnRzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jb250ZW50cy8pCiAgICAgKiAtIFtjc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nzcy8pCiAgICAgKiAtIFtkYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICAgICAqIC0gW2VxKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lcS8pCiAgICAgKiAtIFtmaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9maW5kLykgLSBMaW1pdGVkIHRvIGxvb2t1cHMgYnkgdGFnIG5hbWUKICAgICAqIC0gW2hhc0NsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9oYXNDbGFzcy8pCiAgICAgKiAtIFtodG1sKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9odG1sLykKICAgICAqIC0gW25leHQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL25leHQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtwYXJlbnQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW3ByZXBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogICAgICogLSBbcHJvcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAgICAgKiAtIFtyZWFkeSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogICAgICogLSBbcmVtb3ZlKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogICAgICogLSBbcmVtb3ZlQXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAgICAgKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogICAgICogLSBbcmVtb3ZlRGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAgICAgKiAtIFtyZXBsYWNlV2l0aCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogICAgICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAgICAgKiAtIFt0b2dnbGVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogICAgICogLSBbdHJpZ2dlckhhbmRsZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBEb2Vzbid0IHBhc3MgbmF0aXZlIGV2ZW50IG9iamVjdHMgdG8gaGFuZGxlcnMuCiAgICAgKiAtIFt1bmJpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3VuYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICAgKiAtIFt2YWwoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAgICAgKiAtIFt3cmFwKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICAgICAqCiAgICAgKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogICAgICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICAgICAqCiAgICAgKiAjIyMgRXZlbnRzCiAgICAgKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAgICAgKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFuZCAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogICAgICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICAgICAqICMjIyBNZXRob2RzCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTt9CiAgICAgICAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7fSksCiAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICAgICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCiAgICBmdW5jdGlvbiBqcU5leHRJZCgpIHsgcmV0dXJuICsranFJZDsgfQoKCiAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgIHZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwoKICAgIC8qKgogICAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgICAqLwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCwgZnVuY3Rpb24oXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyBJbiBjb25qdW5jdGlvbiB3aXRoIGJpbmRKUXVlcnkgaW50ZXJjZXB0cyBhbGwgalF1ZXJ5J3MgRE9NIGRlc3RydWN0aW9uIGFwaXMgYW5kIGZpcmVzIGEKLy8gJGRlc3Ryb3kgZXZlbnQgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLgovLwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZShuYW1lLCBkaXNwYXRjaFRoaXMsIGZpbHRlckVsZW1zLCBnZXR0ZXJJZk5vQXJndW1lbnRzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgICAgICBvcmlnaW5hbEpxRm4gPSBvcmlnaW5hbEpxRm4uJG9yaWdpbmFsIHx8IG9yaWdpbmFsSnFGbjsKICAgICAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICAgICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBhdGNoKHBhcmFtKSB7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmlsdGVyRWxlbXMgJiYgcGFyYW0gPyBbdGhpcy5maWx0ZXIocGFyYW0pXSA6IFt0aGlzXSwKICAgICAgICAgICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICAgICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICAgICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbjsKCiAgICAgICAgICAgIGlmICghZ2V0dGVySWZOb0FyZ3VtZW50cyB8fCBwYXJhbSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB3aGlsZShsaXN0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHNldCA9IGxpc3Quc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBmb3Ioc2V0SW5kZXggPSAwLCBzZXRMZW5ndGggPSBzZXQubGVuZ3RoOyBzZXRJbmRleCA8IHNldExlbmd0aDsgc2V0SW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IoY2hpbGRJbmRleCA9IDAsIGNoaWxkTGVuZ3RoID0gKGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEluZGV4IDwgY2hpbGRMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxKcUZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSlFMaXRlKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSlFMaXRlKSkgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkgJiYgZWxlbWVudC5jaGFyQXQoMCkgIT0gJzwnKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignc2VsZWN0b3JzIG5vdCBpbXBsZW1lbnRlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgLy8gUmVhZCBhYm91dCB0aGUgTm9TY29wZSBlbGVtZW50cyBoZXJlOgogICAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKyBlbGVtZW50OyAvLyBJRSBpbnNhbml0eSB0byBtYWtlIE5vU2NvcGUgZWxlbWVudHMgd29yayEKICAgICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKGRpdi5maXJzdENoaWxkKTsgLy8gcmVtb3ZlIHRoZSBzdXBlcmZsdW91cyBkaXYKICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgICAgICAgICB0aGlzLnJlbW92ZSgpOyAvLyBkZXRhY2ggdGhlIGVsZW1lbnRzIGZyb20gdGhlIHRlbXBvcmFyeSBET00gZGl2LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURlYWxvYyhlbGVtZW50KXsKICAgICAgICBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpOwogICAgICAgIGZvciAoIHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVVbmJpbmQoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICB2YXIgZXZlbnRzID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICAgICAgICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgICAgICAgICAgZm9yRWFjaChldmVudHMsIGZ1bmN0aW9uKGV2ZW50SGFuZGxlciwgdHlwZSkgewogICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50SGFuZGxlcik7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRzW3R5cGVdKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShldmVudHNbdHlwZV0gfHwgW10sIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpIHsKICAgICAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgICAgIGlmIChleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICBKUUxpdGVVbmJpbmQoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRhID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgICAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAgICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgICAgICBpZiAoIWRhdGEgJiYgIWlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGtleURlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gKCgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgICAgICAgIGluZGV4T2YoICIgIiArIHNlbGVjdG9yICsgIiAiICkgPiAtMSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKAogICAgICAgICAgICAgICAgICAgICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgICAgICAgICAgaWYgKCFKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBjc3NDbGFzcykpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKyB0cmltKGNzc0NsYXNzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVBZGROb2Rlcyhyb290LCBlbGVtZW50cykgewogICAgICAgIGlmIChlbGVtZW50cykgewogICAgICAgICAgICBlbGVtZW50cyA9ICghZWxlbWVudHMubm9kZU5hbWUgJiYgaXNEZWZpbmVkKGVsZW1lbnRzLmxlbmd0aCkgJiYgIWlzV2luZG93KGVsZW1lbnRzKSkKICAgICAgICAgICAgICAgID8gZWxlbWVudHMKICAgICAgICAgICAgICAgIDogWyBlbGVtZW50cyBdOwogICAgICAgICAgICBmb3IodmFyIGk9MDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUNvbnRyb2xsZXIoZWxlbWVudCwgbmFtZSkgewogICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgICAgIGlmKGVsZW1lbnRbMF0ubm9kZVR5cGUgPT0gOSkgewogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWUpKSByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbikgewogICAgICAgICAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgICAgICAgICAgICBpZiAoZmlyZWQpIHJldHVybjsKICAgICAgICAgICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuYmluZCgnRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgICAgICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAgICAgICAgICBKUUxpdGUod2luZG93KS5iaW5kKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAgIH0sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbihlKXsgdmFsdWUucHVzaCgnJyArIGUpO30pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIChpbmRleCA+PSAwKSA/IGpxTGl0ZSh0aGlzW2luZGV4XSkgOiBqcUxpdGUodGhpc1t0aGlzLmxlbmd0aCArIGluZGV4XSk7CiAgICAgICAgfSwKCiAgICAgICAgbGVuZ3RoOiAwLAogICAgICAgIHB1c2g6IHB1c2gsCiAgICAgICAgc29ydDogW10uc29ydCwKICAgICAgICBzcGxpY2U6IFtdLnNwbGljZQogICAgfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgovLyB0aGVzZSBmdW5jdGlvbnMgcmV0dXJuIHNlbGYgb24gc2V0dGVyIGFuZAovLyB2YWx1ZSBvbiBnZXQuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEJPT0xFQU5fQVRUUiA9IHt9OwogICAgZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCcuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICAgIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0nLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRzY29wZScpOwogICAgICAgIH0sCgogICAgICAgIGNvbnRyb2xsZXI6IEpRTGl0ZUNvbnRyb2xsZXIgLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJGluamVjdG9yJyk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCxuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUpOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2YWw7CgogICAgICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgc29tZSBJRSBzcGVjaWZpYyB3ZWlyZG5lc3MgdGhhdCBqUXVlcnkgMS42LjQgZG9lcyBub3Qgc3VyZSB3aHkKICAgICAgICAgICAgICAgICAgICB2YWwgPSBlbGVtZW50LmN1cnJlbnRTdHlsZSAmJiBlbGVtZW50LmN1cnJlbnRTdHlsZVtuYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09PSAnJykgdmFsID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhbCA9IHZhbCB8fCBlbGVtZW50LnN0eWxlW25hbWVdOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBqcXVlcnkgd2VpcmRuZXNzIDotLwogICAgICAgICAgICAgICAgICAgIHZhbCA9ICh2YWwgPT09ICcnKSA/IHVuZGVmaW5lZCA6IHZhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgICAgICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpfHwgbm9vcCkuc3BlY2lmaWVkKQogICAgICAgICAgICAgICAgICAgICAgICA/IGxvd2VyY2FzZWROYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgLy8gdGhlIGV4dHJhIGFyZ3VtZW50ICIyIiBpcyB0byBnZXQgdGhlIHJpZ2h0IHRoaW5nIGZvciBhLmhyZWYgaW4gSUUsIHNlZSBqUXVlcnkgY29kZQogICAgICAgICAgICAgICAgLy8gc29tZSBlbGVtZW50cyAoZS5nLiBEb2N1bWVudCkgZG9uJ3QgaGF2ZSBnZXQgYXR0cmlidXRlLCBzbyByZXR1cm4gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSwgMik7CiAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgbm9uLWV4aXN0aW5nIGF0dHJpYnV0ZXMgdG8gdW5kZWZpbmVkIChhcyBqUXVlcnkpCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcHJvcDogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogZXh0ZW5kKChtc2llIDwgOSkKICAgICAgICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICovKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVyVGV4dDsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVWYWx1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgIH0sIHskZHY6Jyd9KSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZU5hbWVfKGVsZW1lbnQpID09PSAnU0VMRUNUJyAmJiBlbGVtZW50Lm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5vcHRpb25zLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG9wdGlvbi52YWx1ZSB8fCBvcHRpb24udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgaHRtbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogICAgICAgIC8qKgogICAgICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAgICAgKi8KICAgICAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgICAgICB2YXIgaSwga2V5OwoKICAgICAgICAgICAgLy8gSlFMaXRlSGFzQ2xhc3MgaGFzIG9ubHkgdHdvIGFyZ3VtZW50cywgYnV0IGlzIGEgZ2V0dGVyLW9ubHkgZm4sIHNvIHdlIG5lZWQgdG8gc3BlY2lhbC1jYXNlIGl0CiAgICAgICAgICAgIC8vIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uLgogICAgICAgICAgICBpZiAoKChmbi5sZW5ndGggPT0gMiAmJiAoZm4gIT09IEpRTGl0ZUhhc0NsYXNzICYmIGZuICE9PSBKUUxpdGVDb250cm9sbGVyKSkgPyBhcmcxIDogYXJnMikgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGFyZzEpKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgICAgICAgICAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbiA9PT0gSlFMaXRlRGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YSgpIHRha2VzIHRoZSB3aG9sZSBvYmplY3QgaW4galF1ZXJ5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGFyZzEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBrZXksIGFyZzFba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHJlYWQsIHNvIHJlYWQgdGhlIGZpcnN0IGNoaWxkLgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKHRoaXNbMF0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIHNvIGFwcGx5IHRvIGFsbCBjaGlsZHJlbgogICAgICAgICAgICAgICAgZm9yKGk9MDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZuLiRkdjsKICAgICAgICB9OwogICAgfSk7CgogICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykgewogICAgICAgIHZhciBldmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQsIHR5cGUpIHsKICAgICAgICAgICAgaWYgKCFldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgcHJldmVudC5jYWxsKGV2ZW50KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgICAgICAgICAgLy8gYXMgdGhleSB3b3VsZCBjYXVzZSBtZW1vcnkgbGVha3MgaW4gSUU4LgogICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgYmluZDogZnVuY3Rpb24gYmluZEZuKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgICAgICAgICBoYW5kbGUgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgICAgICAgICAgaWYgKCFldmVudHMpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJywgZXZlbnRzID0ge30pOwogICAgICAgICAgICBpZiAoIWhhbmRsZSkgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnLCBoYW5kbGUgPSBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSk7CgogICAgICAgICAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zKCBidXAgKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGJ1cCApICYgMTYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCBhLCBiICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggYiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGIgPT09IGEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZSA6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXIgOiAibW91c2VvdmVyIn0KICAgICAgICAgICAgICAgICAgICAgICAgYmluZEZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCwgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFjb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZShldmVudCwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHVuYmluZDogSlFMaXRlVW5iaW5kLAoKICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgICAgICAgICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudHM6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsKICAgICAgICB9LAoKICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JhcDogZnVuY3Rpb24oZWxlbWVudCwgd3JhcE5vZGUpIHsKICAgICAgICAgICAgd3JhcE5vZGUgPSBqcUxpdGUod3JhcE5vZGUpWzBdOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cmFwTm9kZS5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBKUUxpdGVBZGRDbGFzcywKICAgICAgICByZW1vdmVDbGFzczogSlFMaXRlUmVtb3ZlQ2xhc3MsCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25kaXRpb24pKSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAhSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgbmV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0sCgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogSlFMaXRlQ2xvbmUsCgogICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudE5hbWUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gKEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50Rm5zLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogICAgICAgIC8qKgogICAgICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICAgICAqLwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yKHZhciBpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8gdGhpcyA6IHZhbHVlOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KXsKICAgICAgICBmb3JFYWNoKGFycmF5LCB0aGlzLnB1dCwgdGhpcyk7CiAgICB9CiAgICBIYXNoTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZSBrZXkgdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkga2V5IHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqIEByZXR1cm5zIHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkKICAgICAgICAgKi8KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzW2tleSA9IGhhc2hLZXkoa2V5KV07CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQSBtYXAgd2hlcmUgbXVsdGlwbGUgdmFsdWVzIGNhbiBiZSBhZGRlZCB0byB0aGUgc2FtZSBrZXkgc3VjaCB0aGF0IHRoZXkgZm9ybSBhIHF1ZXVlLgogICAgICogQHJldHVybnMge0hhc2hRdWV1ZU1hcH0KICAgICAqLwogICAgZnVuY3Rpb24gSGFzaFF1ZXVlTWFwKCkge30KICAgIEhhc2hRdWV1ZU1hcC5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogU2FtZSBhcyBhcnJheSBwdXNoLCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHB1c2g6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSBbdmFsdWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHNoaWZ0LCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHNoaWZ0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5WzBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXkuc2hpZnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHJldHVybiB0aGUgZmlyc3QgaXRlbSB3aXRob3V0IGRlbGV0aW5nIGl0CiAgICAgICAgICovCiAgICAgICAgcGVlazogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNbaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmluamVjdG9yCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogICAgICogZGVwZW5kZW5jeSBpbmplY3Rpb24gKHNlZSB7QGxpbmsgZ3VpZGUvZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICAgICAqCgogICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5tb2R1bGV9LiBUaGUgYG5nYCBtb2R1bGUgbXVzdCBiZSBleHBsaWNpdGx5IGFkZGVkLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEluamVjdG9yIGZ1bmN0aW9uLiBTZWUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFR5cGljYWwgdXNhZ2UKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGNyZWF0ZSBhbiBpbmplY3RvcgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJ10pOwogICAgICoKICAgICAqICAgLy8gdXNlIHRoZSBpbmplY3RvciB0byBraWNrIG9mZiB5b3VyIGFwcGxpY2F0aW9uCiAgICAgKiAgIC8vIHVzZSB0aGUgdHlwZSBpbmZlcmVuY2UgdG8gYXV0byBpbmplY3QgYXJndW1lbnRzLCBvciB1c2UgaW1wbGljaXQgaW5qZWN0aW9uCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRkb2N1bWVudCl7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvdmVydmlldwogICAgICogQG5hbWUgQVVUTwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICovCgogICAgdmFyIEZOX0FSR1MgPSAvXmZ1bmN0aW9uXHMqW15cKF0qXChccyooW15cKV0qKVwpL207CiAgICB2YXIgRk5fQVJHX1NQTElUID0gLywvOwogICAgdmFyIEZOX0FSRyA9IC9eXHMqKF8/KShcUys/KVwxXHMqJC87CiAgICB2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwogICAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgICAgICB2YXIgJGluamVjdCwKICAgICAgICAgICAgZm5UZXh0LAogICAgICAgICAgICBhcmdEZWNsLAogICAgICAgICAgICBsYXN0OwoKICAgICAgICBpZiAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICAgICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgICAgICAgICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgdW5kZXJzY29yZSwgbmFtZSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRpbmplY3QucHVzaChuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgICAgICAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAgICAgICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnRBcmdGbihmbiwgJ2ZuJywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkaW5qZWN0OwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYCRpbmplY3RvcmAgaXMgdXNlZCB0byByZXRyaWV2ZSBvYmplY3QgaW5zdGFuY2VzIGFzIGRlZmluZWQgYnkKICAgICAqIHtAbGluayBBVVRPLiRwcm92aWRlIHByb3ZpZGVyfSwgaW5zdGFudGlhdGUgdHlwZXMsIGludm9rZSBtZXRob2RzLAogICAgICogYW5kIGxvYWQgbW9kdWxlcy4KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIGFsd2F5cyBob2xkcyB0cnVlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKCk7CiAgICAgKiAgIGV4cGVjdCgkaW5qZWN0b3IuZ2V0KCckaW5qZWN0b3InKSkudG9CZSgkaW5qZWN0b3IpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkaW5qZWN0b3IpewogKiAgICAgcmV0dXJuICRpbmplY3RvcjsKICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAgICAgKgogICAgICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogICAgICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAgICAgKgogICAgICogICAvLyBhbm5vdGF0ZWQKICAgICAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogICAgICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogICAgICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICAgICAqCiAgICAgKiAgIC8vIGlubGluZQogICAgICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyMgSW5mZXJlbmNlCiAgICAgKgogICAgICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uIGNhbiB0aGVuIGJlCiAgICAgKiBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aCBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbgogICAgICogdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqCiAgICAgKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogICAgICogQnkgYWRkaW5nIGEgYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiAjIyBJbmxpbmUKICAgICAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2dldAogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogICAgICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyFmdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4gVGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjb21lIGZvcm0gdGhlIGZ1bmN0aW9uIGFubm90YXRpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBpbnZva2VzIHRoZSBuZXcgb3BlcmF0b3IgYW5kIHN1cHBsaWVzCiAgICAgKiBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZSBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFR5cGUgQW5ub3RhdGVkIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNhbm5vdGF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMgdXNlZCBieSB0aGUgaW5qZWN0b3IKICAgICAqIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZQogICAgICogd2F5cyBpbiB3aGljaCB0aGUgZnVuY3Rpb24gY2FuIGJlIGFubm90YXRlZCB3aXRoIHRoZSBuZWVkZWQgZGVwZW5kZW5jaWVzLgogICAgICoKICAgICAqICMgQXJndW1lbnQgbmFtZXMKICAgICAqCiAgICAgKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lIGJ5IGNvbnZlcnRpbmcKICAgICAqIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAgICAgKgogICAgICogICAvLyBUaGVuCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IHdvcmsgd2l0aCBjb2RlIG1pbmZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nIGFubm90YXRpb24gc3RyYXRlZ2llcwogICAgICogYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgICAqCiAgICAgKiBJZiBhIGZ1bmN0aW9uIGhhcyBhbiBgJGluamVjdGAgcHJvcGVydHkgYW5kIGl0cyB2YWx1ZSBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIHRoZSBzdHJpbmdzIHJlcHJlc2VudCBuYW1lcyBvZgogICAgICogc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAgICAgKiA8cHJlPgogICAgICogICAvLyBHaXZlbgogICAgICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICAgICAqICAgLy8gRGVmaW5lIGZ1bmN0aW9uIGRlcGVuZGVuY2llcwogICAgICogICBNeUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJHNjb3BlJywgJyRyb3V0ZSddOwogICAgICoKICAgICAqICAgLy8gVGhlbgogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIFRoZSBhcnJheSBub3RhdGlvbgogICAgICoKICAgICAqIEl0IGlzIG9mdGVuIGRlc2lyYWJsZSB0byBpbmxpbmUgSW5qZWN0ZWQgZnVuY3Rpb25zIGFuZCB0aGF0J3Mgd2hlbiBzZXR0aW5nIHRoZSBgJGluamVjdGAgcHJvcGVydHkgaXMgdmVyeQogICAgICogaW5jb252ZW5pZW50LiBJbiB0aGVzZSBzaXR1YXRpb25zIHVzaW5nIHRoZSBhcnJheSBub3RhdGlvbiB0byBzcGVjaWZ5IHRoZSBkZXBlbmRlbmNpZXMgaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcwogICAgICogbWluaWZpY2F0aW9uIGlzIGEgYmV0dGVyIGNob2ljZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBXZSB3aXNoIHRvIHdyaXRlIHRoaXMgKG5vdCBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbiBzYWZlKQogICAgICogICBpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUsICRyb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gV2UgYXJlIGZvcmNlZCB0byB3cml0ZSBicmVhayBpbmxpbmluZwogICAgICogICB2YXIgdG1wRm4gPSBmdW5jdGlvbihvYmZ1c2NhdGVkQ29tcGlsZSwgb2JmdXNjYXRlZFJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfTsKICAgICAqICAgdG1wRm4uJGluamVjdCA9IFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddOwogICAgICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogICAgICoKICAgICAqICAgLy8gVG8gYmV0dGVyIHN1cHBvcnQgaW5saW5lIGZ1bmN0aW9uIHRoZSBpbmxpbmUgYW5ub3RhdGlvbiBpcyBzdXBwb3J0ZWQKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfV0pOwogICAgICoKICAgICAqICAgLy8gVGhlcmVmb3JlCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZSgKICAgICAqICAgICAgWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmdXNfJGNvbXBpbGUsIG9iZnVzXyRyb290U2NvcGUpIHt9XSkKICAgICAqICAgICkudG9FcXVhbChbJyRjb21waWxlJywgJyRyb290U2NvcGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufEFycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBmbiBGdW5jdGlvbiBmb3Igd2hpY2ggZGVwZW5kZW50IHNlcnZpY2UgbmFtZXMgbmVlZCB0byBiZSByZXRyaWV2ZWQgYXMgZGVzY3JpYmVkCiAgICAgKiAgIGFib3ZlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gVGhlIG5hbWVzIG9mIHRoZSBzZXJ2aWNlcyB3aGljaCB0aGUgZnVuY3Rpb24gcmVxdWlyZXMuCiAgICAgKi8KCgoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2UgYCRwcm92aWRlYCB0byByZWdpc3RlciBuZXcgcHJvdmlkZXJzIHdpdGggdGhlIGAkaW5qZWN0b3JgLiBUaGUgcHJvdmlkZXJzIGFyZSB0aGUgZmFjdG9yaWVzIGZvciB0aGUgaW5zdGFuY2UuCiAgICAgKiBUaGUgcHJvdmlkZXJzIHNoYXJlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGluc3RhbmNlIHRoZXkgY3JlYXRlIHdpdGggYFByb3ZpZGVyYCBzdWZmaXhlZCB0byB0aGVtLgogICAgICoKICAgICAqIEEgcHJvdmlkZXIgaXMgYW4gb2JqZWN0IHdpdGggYSBgJGdldCgpYCBtZXRob2QuIFRoZSBpbmplY3RvciBjYWxscyB0aGUgYCRnZXRgIG1ldGhvZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgICAqIGEgc2VydmljZS4gVGhlIFByb3ZpZGVyIGNhbiBoYXZlIGFkZGl0aW9uYWwgbWV0aG9kcyB3aGljaCB3b3VsZCBhbGxvdyBmb3IgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgZnVuY3Rpb24gR3JlZXRQcm92aWRlcigpIHsKICogICAgIHZhciBzYWx1dGF0aW9uID0gJ0hlbGxvJzsKICoKICogICAgIHRoaXMuc2FsdXRhdGlvbiA9IGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgc2FsdXRhdGlvbiA9IHRleHQ7CiAqICAgICB9OwogKgogKiAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogKiAgICAgICAgIHJldHVybiBzYWx1dGF0aW9uICsgJyAnICsgbmFtZSArICchJzsKICogICAgICAgfTsKICogICAgIH07CiAqICAgfQogICAgICoKICAgICAqICAgZGVzY3JpYmUoJ0dyZWV0ZXInLCBmdW5jdGlvbigpewogKgogKiAgICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oJHByb3ZpZGUpIHsKICogICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJ2dyZWV0JywgR3JlZXRQcm92aWRlcik7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGdyZWV0JywgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdIZWxsbyBhbmd1bGFyIScpOwogKiAgICAgfSkpOwogKgogKiAgICAgaXQoJ3Nob3VsZCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHNhbHV0YXRpb24nLCBmdW5jdGlvbigpIHsKICogICAgICAgbW9kdWxlKGZ1bmN0aW9uKGdyZWV0UHJvdmlkZXIpIHsKICogICAgICAgICBncmVldFByb3ZpZGVyLnNhbHV0YXRpb24oJ0Fob2onKTsKICogICAgICAgfSk7CiAqICAgICAgIGluamVjdChmdW5jdGlvbihncmVldCkgewogKiAgICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdBaG9qIGFuZ3VsYXIhJyk7CiAqICAgICAgIH0pOwogKiAgICAgfSk7CiAqIDwvcHJlPgogKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBSZWdpc3RlciBhIHByb3ZpZGVyIGZvciBhIHNlcnZpY2UuIFRoZSBwcm92aWRlcnMgY2FuIGJlIHJldHJpZXZlZCBhbmQgY2FuIGhhdmUgYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG1ldGhvZHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKyAnUHJvdmlkZXInYCBrZXkuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICAgICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICAgKiAgICAgICAgICAgICAgIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZmFjdG9yeQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgb25seSBgJGdldGAgbWV0aG9kIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZCBmb3IKICAgICAqIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciByZWdpc3RlcmluZyBzZXJ2aWNlIG9mIGdpdmVuIGNsYXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSN2YWx1ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgdGhlIGAkZ2V0YCBtZXRob2QgaXMgYSBjb25zdGFudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIGNvbnN0YW50IHZhbHVlLCBidXQgdW5saWtlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUgaW5qZWN0ZWQKICAgICAqIGludG8gY29uZmlndXJhdGlvbiBmdW5jdGlvbiAob3RoZXIgbW9kdWxlcykgYW5kIGl0IGlzIG5vdCBpbnRlcmNlcHRhYmxlIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZGVjb3JhdG9yCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRGVjb3JhdGlvbiBvZiBzZXJ2aWNlLCBhbGxvd3MgdGhlIGRlY29yYXRvciB0byBpbnRlcmNlcHQgdGhlIHNlcnZpY2UgaW5zdGFuY2UgY3JlYXRpb24uIFRoZQogICAgICogcmV0dXJuZWQgaW5zdGFuY2UgbWF5IGJlIHRoZSBvcmlnaW5hbCBpbnN0YW5jZSwgb3IgYSBuZXcgaW5zdGFuY2Ugd2hpY2ggZGVsZWdhdGVzIHRvIHRoZQogICAgICogb3JpZ2luYWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAgICAgKiAgICBpbnN0YW50aWF0ZWQuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnZva2UKICogICAgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLiBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogICAgICoKICAgICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAgICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogICAgICovCgoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICAgICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgICAgICAgIHBhdGggPSBbXSwKICAgICAgICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm92aWRlckluamVjdG9yID0gY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmtub3duIHByb3ZpZGVyOiAiICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZSA9IHt9LAogICAgICAgICAgICBpbnN0YW5jZUluamVjdG9yID0gKGluc3RhbmNlQ2FjaGUuJGluamVjdG9yID0KICAgICAgICAgICAgICAgIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoaW5zdGFuY2VDYWNoZSwgZnVuY3Rpb24oc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24oZm4pIHsgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7IH0pOwoKICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3RvcjsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gJHByb3ZpZGVyCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIGZ1bmN0aW9uIHN1cHBvcnRPYmplY3QoZGVsZWdhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvdmlkZXIgJyArIG5hbWUgKyAnIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7IHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsgfQoKICAgICAgICBmdW5jdGlvbiBzZXJ2aWNlKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsdWUpIHsgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWx1ZSkpOyB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVjb3JhdG9yKHNlcnZpY2VOYW1lLCBkZWNvckZuKSB7CiAgICAgICAgICAgIHZhciBvcmlnUHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlTmFtZSArIHByb3ZpZGVyU3VmZml4KSwKICAgICAgICAgICAgICAgIG9yaWckZ2V0ID0gb3JpZ1Byb3ZpZGVyLiRnZXQ7CgogICAgICAgICAgICBvcmlnUHJvdmlkZXIuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTW9kdWxlIExvYWRpbmcKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKXsKICAgICAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgICAgICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMucHV0KG1vZHVsZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVGbiA9IGFuZ3VsYXJNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gaW52b2tlQXJnc1swXSA9PSAnJGluamVjdG9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHByb3ZpZGVySW5qZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgbW9kdWxlOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBTdHJpbmcobW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2VOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdTZXJ2aWNlIG5hbWUgZXhwZWN0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdDaXJjdWxhciBkZXBlbmRlbmN5OiAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICAkaW5qZWN0ID0gYW5ub3RhdGUoZm4pLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCwgaSwKICAgICAgICAgICAgICAgICAgICBrZXk7CgogICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gJGluamVjdFtpXTsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSBvcHRpbWl6YXRpb246IGh0dHA6Ly9qc3BlcmYuY29tL2FwcGx5LXZzLWNhbGwtdnMtaW52b2tlCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYgPyAtMSA6IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMDogcmV0dXJuIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMTogcmV0dXJuIGZuKGFyZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDI6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAzOiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNDogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDU6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA2OiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNzogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDg6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA5OiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10sIGFyZ3NbOF0sIGFyZ3NbOV0pOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgICAgICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgICAgICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRhbmNob3JTY3JvbGwKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHRvIHJlbGF0ZWQgZWxlbWVudCwKICAgICAqIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAqIHtAbGluayBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCBIdG1sNSBzcGVjfS4KICAgICAqCiAgICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgICAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICAgICAqLwogICAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgICAgICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2NhdGlvbicsICckcm9vdFNjb3BlJywgZnVuY3Rpb24oJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIGZpbHRlci5maWx0ZXIsIGFzIGl0IGFjY2VwdHMgb25seSBpbnN0YW5jZXMgb2YgQXJyYXkKICAgICAgICAgICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAgICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAgICAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG9lcyBub3Qgc2Nyb2xsIHdoZW4gdXNlciBjbGlja3Mgb24gYW5jaG9yIGxpbmsgdGhhdCBpcyBjdXJyZW50bHkgb24KICAgICAgICAgICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7cmV0dXJuICRsb2NhdGlvbi5oYXNoKCk7fSwKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2hBY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhzY3JvbGwpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc2Nyb2xsOwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogISBUaGlzIGlzIGEgcHJpdmF0ZSB1bmRvY3VtZW50ZWQgc2VydmljZSAhCiAgICAgKgogICAgICogQG5hbWUgbmcuJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkbG9nCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoaXMgb2JqZWN0IGhhcyB0d28gZ29hbHM6CiAgICAgKgogICAgICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogICAgICogLSBhYnN0cmFjdCBhd2F5IGFsbCB0aGUgYnJvd3NlciBzcGVjaWZpYyBmZWF0dXJlcyBhbmQgaW5jb25zaXN0ZW5jaWVzCiAgICAgKgogICAgICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIG5nTW9jay4kYnJvd3NlciBtb2NrIGltcGxlbWVudGF0aW9ufSBvZiB0aGUgYCRicm93c2VyYAogICAgICogc2VydmljZSwgd2hpY2ggY2FuIGJlIHVzZWQgZm9yIGNvbnZlbmllbnQgdGVzdGluZyBvZiB0aGUgYXBwbGljYXRpb24gd2l0aG91dCB0aGUgaW50ZXJhY3Rpb24gd2l0aAogICAgICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogICAgICovCiAgICAvKioKICAgICAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogICAgICogQHBhcmFtIHtvYmplY3R9IGRvY3VtZW50IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBYSFIgWE1MSHR0cFJlcXVlc3QgY29uc3RydWN0b3IuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gJHNuaWZmZXIgJHNuaWZmZXIgc2VydmljZQogICAgICovCiAgICBmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICByYXdEb2N1bWVudCA9IGRvY3VtZW50WzBdLAogICAgICAgICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwKICAgICAgICAgICAgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5LAogICAgICAgICAgICBzZXRUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQsCiAgICAgICAgICAgIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkcyA9IHt9OwoKICAgICAgICBzZWxmLmlzTW9jayA9IGZhbHNlOwoKICAgICAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogICAgICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSB0aGlzIHRlbXBvcmFyeSBhcGkKICAgICAgICBzZWxmLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QgPSBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdDsKICAgICAgICBzZWxmLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSBmdW5jdGlvbigpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAgICAgICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZShvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICAgICAgICovCiAgICAgICAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKCiAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gUG9sbCBXYXRjaGVyIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgICAgICAgcG9sbFRpbWVvdXQ7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2FkZFBvbGxGbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICAgICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICAgICAgICAgIHBvbGxGbnMucHVzaChmbik7CiAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gaW50ZXJ2YWwgSG93IG9mdGVuIHNob3VsZCBicm93c2VyIGNhbGwgcG9sbCBmdW5jdGlvbnMgKG1zKQogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gc2V0VGltZW91dCBSZWZlcmVuY2UgdG8gYSByZWFsIG9yIGZha2UgYHNldFRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ29uZmlndXJlcyB0aGUgcG9sbGVyIHRvIHJ1biBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscywgdXNpbmcgdGhlIHNwZWNpZmllZAogICAgICAgICAqIHNldFRpbWVvdXQgZm4gYW5kIGtpY2tzIGl0IG9mZi4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBzdGFydFBvbGxlcihpbnRlcnZhbCwgc2V0VGltZW91dCkgewogICAgICAgICAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBVUkwgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyksCiAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gbnVsbDsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjdXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBHRVRURVI6CiAgICAgICAgICogV2l0aG91dCBhbnkgYXJndW1lbnQsIHRoaXMgbWV0aG9kIGp1c3QgcmV0dXJucyBjdXJyZW50IHZhbHVlIG9mIGxvY2F0aW9uLmhyZWYuCiAgICAgICAgICoKICAgICAgICAgKiBTRVRURVI6CiAgICAgICAgICogV2l0aCBhdCBsZWFzdCBvbmUgYXJndW1lbnQsIHRoaXMgbWV0aG9kIHNldHMgdXJsIHRvIG5ldyB2YWx1ZS4KICAgICAgICAgKiBJZiBodG1sNSBoaXN0b3J5IGFwaSBzdXBwb3J0ZWQsIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUgaXMgdXNlZCwgb3RoZXJ3aXNlCiAgICAgICAgICogbG9jYXRpb24uaHJlZi9sb2NhdGlvbi5yZXBsYWNlIGlzIHVzZWQuCiAgICAgICAgICogUmV0dXJucyBpdHMgb3duIGluc3RhbmNlIHRvIGFsbG93IGNoYWluaW5nCiAgICAgICAgICoKICAgICAgICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIGNoYW5nZSB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwgKHdoZW4gdXNlZCBhcyBzZXR0ZXIpCiAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gcmVwbGFjZSBTaG91bGQgbmV3IHVybCByZXBsYWNlIGN1cnJlbnQgaGlzdG9yeSByZWNvcmQgPwogICAgICAgICAqLwogICAgICAgIHNlbGYudXJsID0gZnVuY3Rpb24odXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIC8vIHNldHRlcgogICAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gdXJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBsYXN0QnJvd3NlclVybCA9IHVybDsKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2UpIGhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JhenkgT3BlcmEgQnVnOiBodHRwOi8vbXkub3BlcmEuY29tL2NvbW11bml0eS9mb3J1bXMvdG9waWMuZG1sP2lkPTExODU0NjIKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZUVsZW1lbnQuYXR0cignaHJlZicsIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gdXJsOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICAgICAgICAgIC8vIGdldHRlcgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLSB0aGUgcmVwbGFjZWRVcmwgaXMgYSB3b3JrYXJvdW5kIGZvciBhbiBJRTgtOSBpc3N1ZSB3aXRoIGxvY2F0aW9uLnJlcGxhY2UgbWV0aG9kIHRoYXQgZG9lc24ndCB1cGRhdGUKICAgICAgICAgICAgICAgIC8vICAgbG9jYXRpb24uaHJlZiBzeW5jaHJvbm91c2x5CiAgICAgICAgICAgICAgICAvLyAtIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICAgICAgICAgICAgcmV0dXJuIHJlcGxhY2VkVXJsIHx8IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csIiciKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gc2VsZi51cmwoKSkgcmV0dXJuOwoKICAgICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgICAgICAgICBmb3JFYWNoKHVybENoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI29uVXJsQ2hhbmdlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICogQFRPRE8odm9qdGEpOiByZWZhY3RvciB0byB1c2Ugbm9kZSdzIHN5bnRheCBmb3IgZXZlbnRzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqCiAgICAgICAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBieSBvdXRzaWRlIG9mIGFuZ3VsYXI6CiAgICAgICAgICogLSB1c2VyIHR5cGVzIGRpZmZlcmVudCB1cmwgaW50byBhZGRyZXNzIGJhcgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gaGlzdG9yeSAoZm9yd2FyZC9iYWNrKSBidXR0b24KICAgICAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGEgbGluawogICAgICAgICAqCiAgICAgICAgICogSXQncyBub3QgY2FsbGVkIHdoZW4gdXJsIGlzIGNoYW5nZWQgYnkgJGJyb3dzZXIudXJsKCkgbWV0aG9kCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBuZXcgdXJsIGFzIHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciB1cmwgY2hhbmdlcyBpbiBhbmd1bGFyIGFwcHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZyl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqIEByZXR1cm4ge2Z1bmN0aW9uKHN0cmluZyl9IFJldHVybnMgdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXIgZm4gLSBoYW5keSBpZiB0aGUgZm4gaXMgYW5vbnltb3VzLgogICAgICAgICAqLwogICAgICAgIHNlbGYub25VcmxDaGFuZ2UgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAgICAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAgICAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAgICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIHBvbGxpbmcKICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTWlzYyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nPX0KICAgICAgICAgKi8KICAgICAgICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gYmFzZUVsZW1lbnQuYXR0cignaHJlZicpOwogICAgICAgICAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXmh0dHBzP1w6XC9cL1teXC9dKi8sICcnKSA6ICcnOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gQ29va2llcyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBsYXN0Q29va2llcyA9IHt9OwogICAgICAgIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgICAgICAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2Nvb2tpZXMKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29ra2llIHZhbHVlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICAgICAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgICAgICAgKiA8dWw+CiAgICAgICAgICogICA8bGk+Y29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkgaXQ8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSwgdmFsdWUpIC0+IHNldCBuYW1lIHRvIHZhbHVlLCBpZiB2YWx1ZSBpcyB1bmRlZmluZWQgZGVsZXRlIHRoZSBjb29raWU8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0IHdheSk8L2xpPgogICAgICAgICAqIDwvdWw+CiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAgICAgICAqLwogICAgICAgIHNlbGYuY29va2llcyA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjb29raWVMZW5ndGgsIGNvb2tpZUFycmF5LCBjb29raWUsIGksIGluZGV4OwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgIj07cGF0aD0iICsgY29va2llUGF0aCArICI7ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llTGVuZ3RoID0gKHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICc9JyArIGVzY2FwZSh2YWx1ZSkgKyAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBwZXIgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMjEwOS50eHQgYnJvd3NlciBtdXN0IGFsbG93IGF0IG1pbmltdW06CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gMzAwIGNvb2tpZXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gNDA5NiBieXRlcyBwZXIgY29va2llCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIisKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggKyAiID4gNDA5NiBieXRlcykhIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICAgICAgICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZSA9IGNvb2tpZUFycmF5W2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSB1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKDAsIGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb2xsb3cgYXJlIGZvciBsZXNzIHNwZWNpZmljIHBhdGhzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llc1tuYW1lXSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoaW5kZXggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdENvb2tpZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9uaW91c2x5IHZpYSBgc2V0VGltZW91dChmbiwgZGVsYXkpYC4KICAgICAgICAgKgogICAgICAgICAqIFVubGlrZSB3aGVuIGNhbGxpbmcgYHNldFRpbWVvdXRgIGRpcmVjdGx5LCBpbiB0ZXN0IHRoaXMgZnVuY3Rpb24gaXMgbW9ja2VkIGFuZCBpbnN0ZWFkIG9mIHVzaW5nCiAgICAgICAgICogYHNldFRpbWVvdXRgIGluIHRlc3RzLCB0aGUgZm5zIGFyZSBxdWV1ZWQgaW4gYW4gYXJyYXksIHdoaWNoIGNhbiBiZSBwcm9ncmFtbWF0aWNhbGx5IGZsdXNoZWQKICAgICAgICAgKiB2aWEgYCRicm93c2VyLmRlZmVyLmZsdXNoKClgLgogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2VsZi5kZWZlciA9IGZ1bmN0aW9uKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdOwogICAgICAgICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgICAgICAgICB9LCBkZWxheSB8fCAwKTsKICAgICAgICAgICAgcGVuZGluZ0RlZmVySWRzW3RpbWVvdXRJZF0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGltZW91dElkOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlci5jYW5jZWwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIuZGVmZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENhbmNlbHMgYSBkZWZlcmVkIHRhc2sgaWRlbnRpZmllZCB3aXRoIGBkZWZlcklkYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gZGVmZXJJZCBUb2tlbiByZXR1cm5lZCBieSB0aGUgYCRicm93c2VyLmRlZmVyYCBmdW5jdGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWx5IGNhbmNlbGVkLgogICAgICAgICAqLwogICAgICAgIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgICAgICAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGRlZmVySWQpOwogICAgICAgICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICB9CgogICAgZnVuY3Rpb24gJEJyb3dzZXJQcm92aWRlcigpewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uKCAkd2luZG93LCAgICRsb2csICAgJHNuaWZmZXIsICAgJGRvY3VtZW50KXsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyBjYWNoZSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8gdGhlbS4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICoKICAgICAqICB2YXIgY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAgICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdjYWNoZUlkJykpLnRvQmUoY2FjaGUpOwogICAgICogIGV4cGVjdCgkY2FjaGVGYWN0b3J5LmdldCgnbm9TdWNoQ2FjaGVJZCcpKS5ub3QudG9CZURlZmluZWQoKTsKICAgICAqCiAgICAgKiAgY2FjaGUucHV0KCJrZXkiLCAidmFsdWUiKTsKICAgICAqICBjYWNoZS5wdXQoImFub3RoZXIga2V5IiwgImFub3RoZXIgdmFsdWUiKTsKICAgICAqCiAgICAgKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOyAvLyBTaW5jZSB3ZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogICAgICoKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIHRoZSBuZXdseSBjcmVhdGVkIGNhY2hlLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0IHRoYXQgc3BlY2lmaWVzIHRoZSBjYWNoZSBiZWhhdmlvci4gUHJvcGVydGllczoKICAgICAqCiAgICAgKiAgIC0gYHtudW1iZXI9fWAgYGNhcGFjaXR5YCDigJQgdHVybnMgdGhlIGNhY2hlIGludG8gTFJVIGNhY2hlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IE5ld2x5IGNyZWF0ZWQgY2FjaGUgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBzZXQgb2YgbWV0aG9kczoKICAgICAqCiAgICAgKiAtIGB7b2JqZWN0fWAgYGluZm8oKWAg4oCUIFJldHVybnMgaWQsIHNpemUsIGFuZCBvcHRpb25zIG9mIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUuCiAgICAgKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogICAgICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgICAgICAgICAgZnVuY3Rpb24gY2FjaGVGYWN0b3J5KGNhY2hlSWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdjYWNoZUlkICcgKyBjYWNoZUlkICsgJyB0YWtlbicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzaXplID0gMCwKICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgICAgICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbHJ1RW50cnkpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IGZyZXNoRW5kKSBmcmVzaEVuZCA9IGxydUVudHJ5LnA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBzdGFsZUVuZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgaW5mbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRjYWNoZUZhY3RvcnkjaW5mbwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGFsbCB0aGUgb2YgdGhlIGNhY2hlcyB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IC0ga2V5LXZhbHVlIG1hcCBvZiBgY2FjaGVJZGAgdG8gdGhlIHJlc3VsdCBvZiBjYWxsaW5nIGBjYWNoZSNpbmZvYAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FjaGVGYWN0b3J5LmluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgICAgICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24oY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5I2dldAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogR2V0IGFjY2VzcyB0byBhIGNhY2hlIG9iamVjdCBieSB0aGUgYGNhY2hlSWRgIHVzZWQgd2hlbiBpdCB3YXMgY3JlYXRlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiBhIGNhY2hlIHRvIGFjY2Vzcy4KICAgICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQ2FjaGUgb2JqZWN0IGlkZW50aWZpZWQgYnkgdGhlIGNhY2hlSWQgb3IgdW5kZWZpbmVkIGlmIG5vIHN1Y2ggY2FjaGUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24oY2FjaGVJZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICByZXR1cm4gY2FjaGVGYWN0b3J5OwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kdGVtcGxhdGVDYWNoZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGZpcnN0IHRpbWUgYSB0ZW1wbGF0ZSBpcyB1c2VkLCBpdCBpcyBsb2FkZWQgaW4gdGhlIHRlbXBsYXRlIGNhY2hlIGZvciBxdWljayByZXRyaWV2YWwuICBZb3UgY2FuCiAgICAgKiBsb2FkIHRlbXBsYXRlcyBkaXJlY3RseSBpbnRvIHRoZSBjYWNoZSBpbiBhIGBzY3JpcHRgIHRhZywgb3IgYnkgY29uc3VtaW5nIHRoZSBgJHRlbXBsYXRlQ2FjaGVgCiAgICAgKiBzZXJ2aWNlIGRpcmVjdGx5LgogICAgICoKICAgICAqIEFkZGluZyB2aWEgdGhlIGBzY3JpcHRgIHRhZzoKICAgICAqIDxwcmU+CiAgICAgKiA8aHRtbCBuZy1hcHA+CiAgICAgKiA8aGVhZD4KICAgICAqIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlSWQuaHRtbCI+CiAgICAgKiAgIFRoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlCiAgICAgKiA8L3NjcmlwdD4KICAgICAqIDwvaGVhZD4KICAgICAqICAgLi4uCiAgICAgKiA8L2h0bWw+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogdGhlIGBzY3JpcHRgIHRhZyBjb250YWluaW5nIHRoZSB0ZW1wbGF0ZSBkb2VzIG5vdCBuZWVkIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBgaGVhZGAgb2YgdGhlIGRvY3VtZW50LCBidXQKICAgICAqIGl0IG11c3QgYmUgYmVsb3cgdGhlIGBuZy1hcHBgIGRlZmluaXRpb24uCiAgICAgKgogICAgICogQWRkaW5nIHZpYSB0aGUgJHRlbXBsYXRlQ2FjaGUgc2VydmljZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pOwogICAgICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAqICAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0ZW1wbGF0ZUlkLmh0bWwnLCAnVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUnKTsKICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogICAgICogPHByZT4KICAgICAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBvciBnZXQgaXQgdmlhIEphdmFzY3JpcHQ6CiAgICAgKiA8cHJlPgogICAgICogJHRlbXBsYXRlQ2FjaGUuZ2V0KCd0ZW1wbGF0ZUlkLmh0bWwnKQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCd0ZW1wbGF0ZXMnKTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICAgICAqCiAgICAgKiBET00tcmVsYXRlZCB2YXJpYWJsZXM6CiAgICAgKgogICAgICogLSAibm9kZSIgLSBET00gTm9kZQogICAgICogLSAiZWxlbWVudCIgLSBET00gRWxlbWVudCBvciBOb2RlCiAgICAgKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogICAgICoKICAgICAqCiAgICAgKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogICAgICoKICAgICAqIC0gImxpbmtGbiIgLSBsaW5raW5nIGZuIG9mIGEgc2luZ2xlIGRpcmVjdGl2ZQogICAgICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAgICAgKiAtICJjb21wb3NpdGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBjb21waWxhdGlvbiByb290IChub2RlTGlzdCkKICAgICAqLwoKCiAgICB2YXIgTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiA9ICdOb24tYXNzaWduYWJsZSBtb2RlbCBleHByZXNzaW9uOiAnOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGNvbXBpbGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogICAgICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogICAgICoKICAgICAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICAgICAqIGV4ZWN1dGVzIGNvcnJlc3BvbmRpbmcgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogICAgICogaW5zdGFuY2UgZnVuY3Rpb25zIGludG8gYSBzaW5nbGUgdGVtcGxhdGUgZnVuY3Rpb24gd2hpY2ggaXMgdGhlbiByZXR1cm5lZC4KICAgICAqCiAgICAgKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2gKICAgICAqIGNhc2UgZWFjaCBjYWxsIHJlc3VsdHMgaW4gYSB2aWV3IHRoYXQgaXMgYSBET00gY2xvbmUgb2YgdGhlIG9yaWdpbmFsIHRlbXBsYXRlLgogICAgICoKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJjb21waWxlIj4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIC8vIGRlY2xhcmUgYSBuZXcgbW9kdWxlLCBhbmQgaW5qZWN0IHRoZSAkY29tcGlsZVByb3ZpZGVyCiAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgIC8vIGNvbmZpZ3VyZSBuZXcgJ2NvbXBpbGUnIGRpcmVjdGl2ZSBieSBwYXNzaW5nIGEgZGlyZWN0aXZlCiAgICAgICAgLy8gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gaW5qZWN0cyB0aGUgJyRjb21waWxlJwogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZSBmYWN0b3J5IGNyZWF0ZXMgYSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBmb3IgY2hhbmdlcwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBpdCBpbnRvIHRoZSBjdXJyZW50IERPTQogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBuZXcgRE9NIGFuZCBsaW5rIGl0IHRvIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAvLyBzY29wZS4KICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBnZXQgaW50byBpbmZpbml0ZSBsb29wIGNvbXBpbGluZyBvdXJzZWx2ZXMKICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLm5hbWUgPSAnQW5ndWxhcic7CiAgICAgICAgJHNjb3BlLmh0bWwgPSAnSGVsbG8ge3tuYW1lfX0nOwogICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJodG1sIj48L3RleHRhcmVhPiA8YnI+CiAgICAgPGRpdiBjb21waWxlPSJodG1sIj48L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGF1dG8gY29tcGlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoJ2Rpdltjb21waWxlXScpLnRleHQoKSkudG9CZSgnSGVsbG8gQW5ndWxhcicpOwogICAgICAgaW5wdXQoJ2h0bWwnKS5lbnRlcigne3tuYW1lfX0hJyk7CiAgICAgICBleHBlY3QoZWxlbWVudCgnZGl2W2NvbXBpbGVdJykudGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZSBmdW5jdGlvbiBhdmFpbGFibGUgdG8gZGlyZWN0aXZlcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhQcmlvcml0eSBvbmx5IGFwcGx5IGRpcmVjdGl2ZXMgbG93ZXIgdGhlbiBnaXZlbiBwcmlvcml0eSAoT25seSBlZmZlY3RzIHRoZQogICAgICogICAgICAgICAgICAgICAgIHJvb3QgZWxlbWVudChzKSwgbm90IHRoZWlyIGNoaWxkcmVuKQogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHNjb3BlWywgY2xvbmVBdHRhY2hGbl0pfSBhIGxpbmsgZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBiaW5kIHRlbXBsYXRlCiAgICAgKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICAgICAqCiAgICAgKiAgKiBgc2NvcGVgIC0gQSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBTY29wZX0gdG8gYmluZCB0by4KICAgICAqICAqIGBjbG9uZUF0dGFjaEZuYCAtIElmIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZCwgdGhlbiB0aGUgbGluayBmdW5jdGlvbiB3aWxsIGNsb25lIHRoZQogICAgICogICAgICAgICAgICAgICBgdGVtcGxhdGVgIGFuZCBjYWxsIHRoZSBgY2xvbmVBdHRhY2hGbmAgZnVuY3Rpb24gYWxsb3dpbmcgdGhlIGNhbGxlciB0byBhdHRhY2ggdGhlCiAgICAgKiAgICAgICAgICAgICAgIGNsb25lZCBlbGVtZW50cyB0byB0aGUgRE9NIGRvY3VtZW50IGF0IHRoZSBhcHByb3ByaWF0ZSBwbGFjZS4gVGhlIGBjbG9uZUF0dGFjaEZuYCBpcwogICAgICogICAgICAgICAgICAgICBjYWxsZWQgYXM6IDxicj4gYGNsb25lQXR0YWNoRm4oY2xvbmVkRWxlbWVudCwgc2NvcGUpYCB3aGVyZToKICAgICAqCiAgICAgKiAgICAgICogYGNsb25lZEVsZW1lbnRgIC0gaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgYGVsZW1lbnRgIHBhc3NlZCBpbnRvIHRoZSBjb21waWxlci4KICAgICAqICAgICAgKiBgc2NvcGVgIC0gaXMgdGhlIGN1cnJlbnQgc2NvcGUgd2l0aCB3aGljaCB0aGUgbGlua2luZyBmdW5jdGlvbiBpcyB3b3JraW5nIHdpdGguCiAgICAgKgogICAgICogQ2FsbGluZyB0aGUgbGlua2luZyBmdW5jdGlvbiByZXR1cm5zIHRoZSBlbGVtZW50IG9mIHRoZSB0ZW1wbGF0ZS4gSXQgaXMgZWl0aGVyIHRoZSBvcmlnaW5hbCBlbGVtZW50CiAgICAgKiBwYXNzZWQgaW4sIG9yIHRoZSBjbG9uZSBvZiB0aGUgZWxlbWVudCBpZiB0aGUgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLgogICAgICoKICAgICAqIEFmdGVyIGxpbmtpbmcgdGhlIHZpZXcgaXMgbm90IHVwZGF0ZWQgdW50aWwgYWZ0ZXIgYSBjYWxsIHRvICRkaWdlc3Qgd2hpY2ggdHlwaWNhbGx5IGlzIGRvbmUgYnkKICAgICAqIEFuZ3VsYXIgYXV0b21hdGljYWxseS4KICAgICAqCiAgICAgKiBJZiB5b3UgbmVlZCBhY2Nlc3MgdG8gdGhlIGJvdW5kIHZpZXcsIHRoZXJlIGFyZSB0d28gd2F5cyB0byBkbyBpdDoKICAgICAqCiAgICAgKiAtIElmIHlvdSBhcmUgbm90IGFza2luZyB0aGUgbGlua2luZyBmdW5jdGlvbiB0byBjbG9uZSB0aGUgdGVtcGxhdGUsIGNyZWF0ZSB0aGUgRE9NIGVsZW1lbnQocykKICAgICAqICAgYmVmb3JlIHlvdSBzZW5kIHRoZW0gdG8gdGhlIGNvbXBpbGVyIGFuZCBrZWVwIHRoaXMgcmVmZXJlbmNlIGFyb3VuZC4KICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8cD57e3RvdGFsfX08L3A+Jykoc2NvcGUpOwogICAgICogICA8L3ByZT4KICAgICAqCiAgICAgKiAtIGlmIG9uIHRoZSBvdGhlciBoYW5kLCB5b3UgbmVlZCB0aGUgZWxlbWVudCB0byBiZSBjbG9uZWQsIHRoZSB2aWV3IHJlZmVyZW5jZSBmcm9tIHRoZSBvcmlnaW5hbAogICAgICogICBleGFtcGxlIHdvdWxkIG5vdCBwb2ludCB0byB0aGUgY2xvbmUsIGJ1dCByYXRoZXIgdG8gdGhlIG9yaWdpbmFsIHRlbXBsYXRlIHRoYXQgd2FzIGNsb25lZC4gSW4KICAgICAqICAgdGhpcyBjYXNlLCB5b3UgY2FuIGFjY2VzcyB0aGUgY2xvbmUgdmlhIHRoZSBjbG9uZUF0dGFjaEZuOgogICAgICogICA8cHJlPgogICAgICogICAgIHZhciB0ZW1wbGF0ZUhUTUwgPSBhbmd1bGFyLmVsZW1lbnQoJzxwPnt7dG90YWx9fTwvcD4nKSwKICAgICAqICAgICAgICAgc2NvcGUgPSAuLi4uOwogICAgICoKICAgICAqICAgICB2YXIgY2xvbmVkRWxlbWVudCA9ICRjb21waWxlKHRlbXBsYXRlSFRNTCkoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7CiAqICAgICAgIC8vYXR0YWNoIHRoZSBjbG9uZSB0byBET00gZG9jdW1lbnQgYXQgdGhlIHJpZ2h0IHBsYWNlCiAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAgICAgKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKi8KICAgICRDb21waWxlUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICAgIGZ1bmN0aW9uICRDb21waWxlUHJvdmlkZXIoJHByb3ZpZGUpIHsKICAgICAgICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICAgICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd1wtX10rKVxzKyguKikkLywKICAgICAgICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3XC1fXSspKD86XDooW147XSspKT87PykvLAogICAgICAgICAgICBNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SID0gJ1RlbXBsYXRlIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHdhczogJywKICAgICAgICAgICAgdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooaHR0cHM/fGZ0cHxtYWlsdG98ZmlsZSk6LzsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgbmV3IGRpcmVjdGl2ZSB3aXRoIHRoZSBjb21waWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGRpcmVjdGl2ZSBpbiBjYW1lbC1jYXNlLiAoaWUgPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaCB3aWxsIG1hdGNoIGFzCiAgICAgICAgICogICAgICAgICAgICAgICAgPGNvZGU+bmctYmluZDwvY29kZT4pLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258QXJyYXl9IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdG9yeSBmdW5jdGlvbi4gU2VlIHtAbGluayBndWlkZS9kaXJlY3RpdmV9IGZvciBtb3JlCiAgICAgICAgICogICAgICAgICAgICAgICAgaW5mby4KICAgICAgICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5kaXJlY3RpdmUgPSBmdW5jdGlvbiByZWdpc3RlckRpcmVjdGl2ZShuYW1lLCBkaXJlY3RpdmVGYWN0b3J5KSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhuYW1lKSkgewogICAgICAgICAgICAgICAgYXNzZXJ0QXJnKGRpcmVjdGl2ZUZhY3RvcnksICdkaXJlY3RpdmUnKTsKICAgICAgICAgICAgICAgIGlmICghaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBTdWZmaXgsIFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24oZGlyZWN0aXZlRmFjdG9yeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSB7IGNvbXBpbGU6IHZhbHVlRm4oZGlyZWN0aXZlKSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLmNvbXBpbGUgPSB2YWx1ZUZuKGRpcmVjdGl2ZS5saW5rKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgPSBkaXJlY3RpdmUubmFtZSB8fCBuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlIHx8IChkaXJlY3RpdmUuY29udHJvbGxlciAmJiBkaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgICAgICAgICAgICAgfV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXS5wdXNoKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yRWFjaChuYW1lLCByZXZlcnNlUGFyYW1zKHJlZ2lzdGVyRGlyZWN0aXZlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIjdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgICAgICoKICAgICAgICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50byBhbgogICAgICAgICAqIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcyB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYHVybFNhbml0aXphdGlvbldoaXRlbGlzdGAgcmVndWxhcgogICAgICAgICAqIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlIHRoZQogICAgICAgICAqIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGl0IGlzIHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy51cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgICAgICAgICB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbCiAgICAgICAgICAgICckaW5qZWN0b3InLCAnJGludGVycG9sYXRlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRwYXJzZScsCiAgICAgICAgICAgICckY29udHJvbGxlcicsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgICAkaW50ZXJwb2xhdGUsICAgJGV4Y2VwdGlvbkhhbmRsZXIsICAgJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUsICAgJHBhcnNlLAogICAgICAgICAgICAgICAgICAgICAkY29udHJvbGxlciwgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCkgewoKICAgICAgICAgICAgICAgIHZhciBBdHRyaWJ1dGVzID0gZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyID0gYXR0ciB8fCB7fTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgQXR0cmlidXRlcy5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogU2V0IGEgbm9ybWFsaXplZCBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgaW4gYSB3YXkgc3VjaCB0aGF0IGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKQogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGJvb2xlYW59IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuIElmIGBudWxsYCBhdHRyaWJ1dGUgd2lsbCBiZSBkZWxldGVkLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF0dHJOYW1lIE9wdGlvbmFsIG5vbmUgbm9ybWFsaXplZCBuYW1lLiBEZWZhdWx0cyB0byBrZXkuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTmFtZV8odGhpcy4kJGVsZW1lbnRbMF0pID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbk5vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhyZWYgcHJvcGVydHkgYWx3YXlzIHJldHVybnMgbm9ybWFsaXplZCBhYnNvbHV0ZSB1cmwsIHNvIHdlIGNhbiBtYXRjaCBhZ2FpbnN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxTYW5pdGl6YXRpb25Ob2RlLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFZhbCAhPT0gJycgJiYgIW5vcm1hbGl6ZWRWYWwubWF0Y2godXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogT2JzZXJ2ZSBhbiBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBvYnNlcnZlciB3aWxsIG5ldmVyIGJlIGNhbGxlZCwgaWYgZ2l2ZW4gYXR0cmlidXRlIGlzIG5vdCBpbnRlcnBvbGF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpIC4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCopfSBmbiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBhdHRyaWJ1dGUgdmFsdWUgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKil9IHRoZSBgZm5gIEZ1bmN0aW9uIHBhc3NlZCBpbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkb2JzZXJ2ZTogZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCRvYnNlcnZlcnMgPSAoYXR0cnMuJCRvYnNlcnZlcnMgfHwgKGF0dHJzLiQkb2JzZXJ2ZXJzID0ge30pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sICA9PSAnfX0nKQogICAgICAgICAgICAgICAgICAgICAgICA/IGlkZW50aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gZGVub3JtYWxpemVUZW1wbGF0ZSh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZTsKCiAgICAgICAgICAgICAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IGFsd2F5cyByZXdyYXBzLCB3aGVyZWFzIHdlIG5lZWQgdG8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNlbGVjdG9yIHNvIHRoYXQgd2UgY2FuIG1vZGlmeSBpdC4KICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlcyA9IGpxTGl0ZSgkY29tcGlsZU5vZGVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAgICAgICAgICAgICAgIC8vIG5vdCBiZSBhYmxlIHRvIGF0dGFjaCBzY29wZSBkYXRhIHRvIHRoZW0sIHNvIHdlIHdpbGwgd3JhcCB0aGVtIGluIDxzcGFuPgogICAgICAgICAgICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24obm9kZSwgaW5kZXgpewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbil7CiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0gY2xvbmVDb25uZWN0Rm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gSlFMaXRlUHJvdG90eXBlLmNsb25lLmNhbGwoJGNvbXBpbGVOb2RlcykgLy8gSU1QT1JUQU5UISEhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRjb21waWxlTm9kZXM7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggc2NvcGUgb25seSB0byBub24tdGV4dCBub2Rlcy4KICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSAkbGlua05vZGUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gJGxpbmtOb2RlW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiBlbGVtZW50ICovIHx8IG5vZGUubm9kZVR5cGUgPT0gOSAvKiBkb2N1bWVudCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsaW5rTm9kZS5lcShpKS5kYXRhKCckc2NvcGUnLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRsaW5rTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbG9uZUNvbm5lY3RGbikgY2xvbmVDb25uZWN0Rm4oJGxpbmtOb2RlLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb3NpdGVMaW5rRm4pIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgJGxpbmtOb2RlLCAkbGlua05vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gd3JvbmdNb2RlKGxvY2FsTmFtZSwgbW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbnN1cHBvcnRlZCAnIiArIG1vZGUgKyAiJyBmb3IgJyIgKyBsb2NhbE5hbWUgKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQ29tcGlsZSBmdW5jdGlvbiBtYXRjaGVzIGVhY2ggbm9kZSBpbiBub2RlTGlzdCBhZ2FpbnN0IHRoZSBkaXJlY3RpdmVzLiBPbmNlIGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbnMgcmV0dXJuIHZhbHVlcyAtIHRoZSBsaW5raW5nIGZ1bmN0aW9ucyAtIGFyZSBjb21iaW5lZCBpbnRvIGEgY29tcG9zaXRlIGxpbmtpbmcKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uLCB3aGljaCBpcyB0aGUgYSBsaW5raW5nIGZ1bmN0aW9uIGZvciB0aGUgbm9kZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGVMaXN0fSBub2RlTGlzdCBhbiBhcnJheSBvZiBub2RlcyBvciBOb2RlTGlzdCB0byBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gJHJvb3RFbGVtZW50IElmIHRoZSBub2RlTGlzdCBpcyB0aGUgcm9vdCBvZiB0aGUgY29tcGlsYXRpb24gdHJlZSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHJvb3RFbGVtZW50IG11c3QgYmUgc2V0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBvZiB0aGUgY29tcGlsZSByb290LiBUaGlzIGlzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heCBkaXJlY3RpdmUgcHJpb3JpdHkKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHs/ZnVuY3Rpb259IEEgY29tcG9zaXRlIGxpbmtpbmcgZnVuY3Rpb24gb2YgYWxsIG9mIHRoZSBtYXRjaGVkIGRpcmVjdGl2ZXMgb3IgbnVsbC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZU5vZGVzKG5vZGVMaXN0LCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0ZucyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgZGlyZWN0aXZlcywgYXR0cnMsIGxpbmtGbkZvdW5kOwoKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbnMucHVzaChjaGlsZExpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiwgaSwgaWksIG47CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gbm9kZUxpc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gc3RhYmxlTm9kZUxpc3Rbbl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuID0gbGlua0Zuc1tpKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldyhpc09iamVjdChub2RlTGlua0ZuLnNjb3BlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxTGl0ZShub2RlKS5kYXRhKCckc2NvcGUnLCBjaGlsZFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gbm9kZUxpbmtGbi50cmFuc2NsdWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFRyYW5zY2x1ZGVGbiB8fCAoIWJvdW5kVHJhbnNjbHVkZUZuICYmIHRyYW5zY2x1ZGVGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjbG9uZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZVNjb3BlLCBjbG9uZUZuKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmQoJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlU2NvcGUsIHRyYW5zY2x1ZGVTY29wZS4kZGVzdHJveSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAgICAgICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKG5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIHRoZSBub2RlIG5hbWU6IDxkaXJlY3RpdmU+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGF0dHIsIG5hbWUsIG5OYW1lLCB2YWx1ZSwgbkF0dHJzID0gbm9kZS5hdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaiA9IDAsIGpqID0gbkF0dHJzICYmIG5BdHRycy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1zaWUgfHwgbXNpZSA+PSA4IHx8IGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQgY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMgb24gaXQuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sIGpxQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXJtaW5hbFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsgLy8gcHJldmVudCBmdXJ0aGVyIHByb2Nlc3Npbmcgb2YgZGlyZWN0aXZlcwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCdpc29sYXRlZCBzY29wZScsIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1pc29sYXRlLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRjb21waWxlTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG5ld1Njb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZS5uYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLmNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgiJyIgKyBkaXJlY3RpdmVOYW1lICsgIicgY29udHJvbGxlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0sIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUudHJhbnNjbHVkZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIHRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnICcgKyBkaXJlY3RpdmVOYW1lICsgJzogJyArIHRlbXBsYXRlQXR0cnNbZGlyZWN0aXZlTmFtZV0gKyAnICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZSgkdGVtcGxhdGVbMF0pLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuLCB0ZXJtaW5hbFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKSkuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKCc8ZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmltKGRpcmVjdGl2ZVZhbHVlKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SICsgZGlyZWN0aXZlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tYmluZSBkaXJlY3RpdmVzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUgYW5kIGZyb20gdGhlIHRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gdGFrZSB0aGUgYXJyYXkgb2YgZGlyZWN0aXZlcyBmb3IgdGhpcyBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCB3ZXJlIGFscmVhZHkgYXBwbGllZCBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBjb2xsZWN0IGRpcmVjdGl2ZXMgZnJvbSB0aGUgdGVtcGxhdGUsIGFkZCB0aGVtIHRvIHRoZSBzZWNvbmQgZ3JvdXAgYW5kIHNvcnQgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gYXBwZW5kIHRoZSBzZWNvbmQgZ3JvdXAgd2l0aCBuZXcgZGlyZWN0aXZlcyB0byB0aGUgZmlyc3QgZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5jb25jYXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3REaXJlY3RpdmVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnNwbGljZShpICsgMSwgZGlyZWN0aXZlcy5sZW5ndGggLSAoaSArIDEpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RlbXBsYXRlQXR0cnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModGVtcGxhdGVBdHRycywgbmV3VGVtcGxhdGVBdHRycyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZVVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywganFDb2xsZWN0aW9uLCBkaXJlY3RpdmUucmVwbGFjZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiA9IGRpcmVjdGl2ZS5jb21waWxlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpbmtGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhudWxsLCBsaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobGlua0ZuLnByZSwgbGlua0ZuLnBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkY29tcGlsZU5vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZXJtaW5hbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50ZXJtaW5hbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZTsKICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgPSB0cmFuc2NsdWRlRGlyZWN0aXZlICYmIGNoaWxkVHJhbnNjbHVkZUZuOwoKICAgICAgICAgICAgICAgICAgICAvLyBtaWdodCBiZSBub3JtYWwgb3IgZGVsYXllZCBub2RlTGlua0ZuIGRlcGVuZGluZyBvbiBpZiB0ZW1wbGF0ZVVybCBpcyBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVMaW5rRm47CgogICAgICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZExpbmtGbnMocHJlLCBwb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVMaW5rRm5zLnB1c2gocHJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdC5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udHJvbGxlcnMocmVxdWlyZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLCByZXRyaWV2YWxNZXRob2QgPSAnZGF0YScsIG9wdGlvbmFsID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoKHZhbHVlID0gcmVxdWlyZS5jaGFyQXQoMCkpID09ICdeJyB8fCB2YWx1ZSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlID0gcmVxdWlyZS5zdWJzdHIoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWV2YWxNZXRob2QgPSAnaW5oZXJpdGVkRGF0YSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAkZWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiTm8gY29udHJvbGxlcjogIiArIHJlcXVpcmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlcXVpcmUsIGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSlccyooXHcqKVxzKiQvOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlLiRwYXJlbnQgfHwgc2NvcGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uKGRlZmluaXRvbiwgc2NvcGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdG9uLm1hdGNoKExPQ0FMX1JFR0VYUCkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gbWF0Y2hbMl18fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCwgcGFyZW50U2V0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kJGlzb2xhdGVCaW5kaW5nc1tzY29wZU5hbWVdID0gbW9kZSArIGF0dHJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0AnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgY2hhbmdlLCBvciB3ZSB3aWxsIHRocm93IHRoaXMgZXhjZXB0aW9uIG9uIGV2ZXJ5ICRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgYXR0cnNbYXR0ck5hbWVdICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAoZGlyZWN0aXZlOiAnICsgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUgKyAnKScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQocGFyZW50U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFZhbHVlICE9PSBzY29wZVtzY29wZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwYXJlbnQgY2hhbmdlZCBhbmQgaXQgaGFzIHByZWNlZGVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBwYXJlbnQgY2FuIGJlIGFzc2lnbmVkIHRoZW4gZG8gc28KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChwYXJlbnRTY29wZSwgcGFyZW50VmFsdWUgPSBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICcmJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24obG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChwYXJlbnRTY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUgKyAnOiAnICsgZGVmaW5pdG9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IGJvdW5kVHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBwcmVMaW5rRm5zW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4ucmVxdWlyZSwgJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gJiYgY2hpbGRMaW5rRm4oc2NvcGUsIGxpbmtOb2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUE9TVExJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHBvc3RMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbG9va3MgdXAgdGhlIGRpcmVjdGl2ZSBhbmQgZGVjb3JhdGVzIGl0IHdpdGggZXhjZXB0aW9uIGhhbmRsaW5nIGFuZCBwcm9wZXIgcGFyYW1ldGVycy4gV2UKICAgICAgICAgICAgICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAgICAgICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICAgICAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgKiAgICogYENgOiBjbGFzcwogICAgICAgICAgICAgICAgICogICAqIGBNYDogY29tbWVudAogICAgICAgICAgICAgICAgICogQHJldHVybnMgdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGREaXJlY3RpdmUodERpcmVjdGl2ZXMsIG5hbWUsIGxvY2F0aW9uLCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAobWF4UHJpb3JpdHkgPT09IHVuZGVmaW5lZCB8fCBtYXhQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAgICAgICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICs9IChrZXkgPT09ICdzdHlsZScgPyAnOycgOiAnICcpICsgc3JjW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3QuJHNldChrZXksIHZhbHVlLCB0cnVlLCBzcmNBdHRyW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzcmMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFsnY2xhc3MnXSA9IChkc3RbJ2NsYXNzJ10gPyBkc3RbJ2NsYXNzJ10gKyAnICcgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYXR0cignc3R5bGUnLCAkZWxlbWVudC5hdHRyKCdzdHlsZScpICsgJzsnICsgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdEF0dHJba2V5XSA9IHNyY0F0dHJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQsIHJlcGxhY2UsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oY29udGVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVOb2RlLCB0ZW1wVGVtcGxhdGVBdHRycywgJHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGNvbnRlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKCc8ZGl2PicgKyB0cmltKGNvbnRlbnQpICsgJzwvZGl2PicpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKE1VTFRJX1JPT1RfVEVNUExBVEVfRVJST1IgKyBjb250ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgZGlyZWN0aXZlcywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRBdHRycywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuID0gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0QXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVbMF0uY2hpbGROb2RlcywgY2hpbGRUcmFuc2NsdWRlRm4pOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShsaW5rUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gY29tcGlsZU5vZGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBKUUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGxpbmtSb290RWxlbWVudCwganFMaXRlKGJlZm9yZVRlbXBsYXRlTGlua05vZGUpLCBsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihyZXNwb25zZSwgY29kZSwgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignRmFpbGVkIHRvIGxvYWQgdGVtcGxhdGU6ICcgKyBjb25maWcudXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkZWxheWVkTm9kZUxpbmtGbihpZ25vcmVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5rUXVldWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2gocm9vdEVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogU29ydGluZyBmdW5jdGlvbiBmb3IgYm91bmQgZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGIucHJpb3JpdHkgLSBhLnByaW9yaXR5OwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdNdWx0aXBsZSBkaXJlY3RpdmVzIFsnICsgcHJldmlvdXNEaXJlY3RpdmUubmFtZSArICcsICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgKyAnXSBhc2tpbmcgZm9yICcgKyB3aGF0ICsgJyBvbjogJyArICBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHRleHQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gdGV4dEludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gcGFyZW50LmRhdGEoJyRiaW5kaW5nJykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MocGFyZW50LmRhdGEoJyRiaW5kaW5nJywgYmluZGluZ3MpLCAnbmctYmluZGluZycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAvLyBubyBpbnRlcnBvbGF0aW9uIGZvdW5kIC0+IGlnbm9yZQogICAgICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgcmV0dXJuOwoKCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZTogdmFsdWVGbihmdW5jdGlvbiBhdHRySW50ZXJwb2xhdGVMaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkJG9ic2VydmVycyA9IChhdHRyLiQkb2JzZXJ2ZXJzIHx8IChhdHRyLiQkb2JzZXJ2ZXJzID0ge30pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gaW50ZXJwb2xhdGUgY2xhc3NlcyBhZ2FpbiwgaW4gdGhlIGNhc2UgdGhlIGVsZW1lbnQgd2FzIHJlcGxhY2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHRoZXJlZm9yZSB0aGUgdHdvIGNsYXNzIGF0dHJzIGdvdCBtZXJnZWQgLSB3ZSB3YW50IHRvIGludGVycG9sYXRlIHRoZSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGF0dHJbbmFtZV0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoJCRvYnNlcnZlcnNbbmFtZV0gfHwgKCQkb2JzZXJ2ZXJzW25hbWVdID0gW10pKS4kJGludGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChhdHRyLiQkb2JzZXJ2ZXJzICYmIGF0dHIuJCRvYnNlcnZlcnNbbmFtZV0uJCRzY29wZSB8fCBzY29wZSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFRoaXMgaXMgYSBzcGVjaWFsIGpxTGl0ZS5yZXBsYWNlV2l0aCwgd2hpY2ggY2FuIHJlcGxhY2UgaXRlbXMgd2hpY2gKICAgICAgICAgICAgICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pxTGl0ZT19ICRyb290RWxlbWVudCBUaGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlLiBVc2VkIHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAgICAgICAgICAgICAqICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtKcUxpdGV9ICRlbGVtZW50IFRoZSBqcUxpdGUgZWxlbWVudCB3aGljaCB3ZSBhcmUgZ29pbmcgdG8gcmVwbGFjZS4gV2Uga2VlcCB0aGUgc2hlbGwsCiAgICAgICAgICAgICAgICAgKiAgICBidXQgcmVwbGFjZSBpdHMgRE9NIG5vZGUgcmVmZXJlbmNlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtOb2RlfSBuZXdOb2RlIFRoZSBuZXcgRE9NIG5vZGUuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGVsZW1lbnQsIG5ld05vZGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkTm9kZSA9ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBvbGROb2RlLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGksIGlpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBvbGROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50W2ldID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbmV3Tm9kZVtqcUxpdGUuZXhwYW5kb10gPSBvbGROb2RlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudFswXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaVJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4KICAgICAqLwoKCgogICAgLyoqCiAgICAgKiBDbG9zdXJlIGNvbXBpbGVyIHR5cGUgaW5mb3JtYXRpb24KICAgICAqLwoKICAgIGZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oCiAgICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgICAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwKICAgICAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgICAgIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgogICAgICAgICl7fQoKICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigKICAgICAgICAvKiBub2Rlc2V0TGlua2luZ0ZuICovIG5vZGVzZXRMaW5raW5nRm4sCiAgICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgICAvKiBOb2RlICovIG5vZGUsCiAgICAgICAgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwKICAgICAgICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KICAgICAgICApe30KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogICAgICogY29udHJvbGxlcnMuCiAgICAgKgogICAgICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogICAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICAgICAgICB2YXIgY29udHJvbGxlcnMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbnRyb2xsZXJQcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAgICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAgICAgICAqLwogICAgICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICBpZiAoaXNPYmplY3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVycywgbmFtZSkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJzW25hbWVdID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJHdpbmRvdycsIGZ1bmN0aW9uKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlcgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGgge0BsaW5rIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgKICAgICAqIEJDIHZlcnNpb259LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnN0cnVjdG9yLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGNvbnN0cnVjdG9yKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIG5hbWUsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBuYW1lLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oY29uc3RydWN0b3IsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IsIGxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZG9jdW1lbnQKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogICAgICogZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbih3aW5kb3cpewogICAgICAgICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRleGNlcHRpb25IYW5kbGVyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICAgKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICAgICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICAgKgogICAgICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICAgICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICAgICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbigkbG9nKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihleGNlcHRpb24sIGNhdXNlKSB7CiAgICAgICAgICAgICAgICAkbG9nLmVycm9yLmFwcGx5KCRsb2csIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGludGVycG9sYXRpb24gbWFya3VwLiBEZWZhdWx0cyB0byBge3tgIGFuZCBgfX1gLgogICAgICovCiAgICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogICAgICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBlbmRpbmcgc3ltYm9sIHRvLgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5lbmRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCBmdW5jdGlvbigkcGFyc2UpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0U3ltYm9sTGVuZ3RoID0gc3RhcnRTeW1ib2wubGVuZ3RoLAogICAgICAgICAgICAgICAgZW5kU3ltYm9sTGVuZ3RoID0gZW5kU3ltYm9sLmxlbmd0aDsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlCiAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHBhcnNlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBDb21waWxlcyBhIHN0cmluZyB3aXRoIG1hcmt1cCBpbnRvIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFRoaXMgc2VydmljZSBpcyB1c2VkIGJ5IHRoZQogICAgICAgICAgICAgKiBIVE1MIHtAbGluayBuZy4kY29tcGlsZSAkY29tcGlsZX0gc2VydmljZSBmb3IgZGF0YSBiaW5kaW5nLiBTZWUKICAgICAgICAgICAgICoge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyICRpbnRlcnBvbGF0ZVByb3ZpZGVyfSBmb3IgY29uZmlndXJpbmcgdGhlCiAgICAgICAgICAgICAqIGludGVycG9sYXRpb24gbWFya3VwLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgPHByZT4KICAgICAgICAgICAgIHZhciAkaW50ZXJwb2xhdGUgPSAuLi47IC8vIGluamVjdGVkCiAgICAgICAgICAgICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWV9fSEnKTsKICAgICAgICAgICAgIGV4cGVjdChleHAoe25hbWU6J0FuZ3VsYXInfSkudG9FcXVhbCgnSGVsbG8gQW5ndWxhciEnKTsKICAgICAgICAgICAgIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICAgICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQpfSBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gY29tcHV0ZSB0aGUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAqICAgIHN0cmluZy4gVGhlIGZ1bmN0aW9uIGhhcyB0aGVzZSBwYXJhbWV0ZXJzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YDogYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzIGFyZSBldmFsdWF0ZWQKICAgICAgICAgICAgICogICAgICBhZ2FpbnN0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gJGludGVycG9sYXRlKHRleHQsIG11c3RIYXZlRXhwcmVzc2lvbikgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGZuLAogICAgICAgICAgICAgICAgICAgIGV4cCwKICAgICAgICAgICAgICAgICAgICBjb25jYXQgPSBbXTsKCiAgICAgICAgICAgICAgICB3aGlsZShpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmICggKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAoKGVuZEluZGV4ID0gdGV4dC5pbmRleE9mKGVuZFN5bWJvbCwgc3RhcnRJbmRleCArIHN0YXJ0U3ltYm9sTGVuZ3RoKSkgIT0gLTEpICkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uICB8fCBoYXNJbnRlcnBvbGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY29uY2F0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBsZW5ndGgsIHBhcnQ7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFydCAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmNhdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJGludGVycG9sYXRlOwogICAgICAgIH1dOwogICAgfQoKICAgIHZhciBVUkxfTUFUQ0ggPSAvXihbXjpdKyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXHs/W1x3XC4tXSpcfT8pKDooWzAtOV0rKSk/KFwvW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBQQVRIX01BVENIID0gL14oW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBIQVNIX01BVENIID0gUEFUSF9NQVRDSCwKICAgICAgICBERUZBVUxUX1BPUlRTID0geydodHRwJzogODAsICdodHRwcyc6IDQ0MywgJ2Z0cCc6IDIxfTsKCgogICAgLyoqCiAgICAgKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBQYXRoIHRvIGVuY29kZQogICAgICogQHJldHVybnMge3N0cmluZ30KICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlUGF0aChwYXRoKSB7CiAgICAgICAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLycpLAogICAgICAgICAgICBpID0gc2VnbWVudHMubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIHNlZ21lbnRzW2ldID0gZW5jb2RlVXJpU2VnbWVudChzZWdtZW50c1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VnbWVudHMuam9pbignLycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmlwSGFzaCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hdGNoVXJsKHVybCwgb2JqKSB7CiAgICAgICAgdmFyIG1hdGNoID0gVVJMX01BVENILmV4ZWModXJsKTsKCiAgICAgICAgbWF0Y2ggPSB7CiAgICAgICAgICAgIHByb3RvY29sOiBtYXRjaFsxXSwKICAgICAgICAgICAgaG9zdDogbWF0Y2hbM10sCiAgICAgICAgICAgIHBvcnQ6IGludChtYXRjaFs1XSkgfHwgREVGQVVMVF9QT1JUU1ttYXRjaFsxXV0gfHwgbnVsbCwKICAgICAgICAgICAgcGF0aDogbWF0Y2hbNl0gfHwgJy8nLAogICAgICAgICAgICBzZWFyY2g6IG1hdGNoWzhdLAogICAgICAgICAgICBoYXNoOiBtYXRjaFsxMF0KICAgICAgICB9OwoKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgIG9iai4kJHByb3RvY29sID0gbWF0Y2gucHJvdG9jb2w7CiAgICAgICAgICAgIG9iai4kJGhvc3QgPSBtYXRjaC5ob3N0OwogICAgICAgICAgICBvYmouJCRwb3J0ID0gbWF0Y2gucG9ydDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KCgogICAgZnVuY3Rpb24gY29tcG9zZVByb3RvY29sSG9zdFBvcnQocHJvdG9jb2wsIGhvc3QsIHBvcnQpIHsKICAgICAgICByZXR1cm4gcHJvdG9jb2wgKyAnOi8vJyArIGhvc3QgKyAocG9ydCA9PSBERUZBVUxUX1BPUlRTW3Byb3RvY29sXSA/ICcnIDogJzonICsgcG9ydCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCkgewogICAgICAgIHJldHVybiBiYXNlUGF0aC5zdWJzdHIoMCwgYmFzZVBhdGgubGFzdEluZGV4T2YoJy8nKSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0h0bWw1VXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGh0bWw1IHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgIT0gYmFzZVBhdGggfHwgaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgfHwKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaGFzaGJhbmcgdXJsIC0+IGh0bWw1IHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKwogICAgICAgICAgICAgICAgcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSArIG1hdGNoLmhhc2guc3Vic3RyKGhhc2hQcmVmaXgubGVuZ3RoKTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0hhc2hiYW5nVXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGhhc2hiYW5nIHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgPT0gYmFzZVBhdGggJiYgIWlzVW5kZWZpbmVkKG1hdGNoLmhhc2gpICYmCiAgICAgICAgICAgIG1hdGNoLmhhc2guaW5kZXhPZihoYXNoUHJlZml4KSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgICAgICAvLyBjb252ZXJ0IGh0bWw1IHVybCAtPiBoYXNoYmFuZyB1cmwKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gbWF0Y2guc2VhcmNoICYmICc/JyArIG1hdGNoLnNlYXJjaCB8fCAnJywKICAgICAgICAgICAgICAgIGhhc2ggPSBtYXRjaC5oYXNoICYmICcjJyArIG1hdGNoLmhhc2ggfHwgJycsCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSwKICAgICAgICAgICAgICAgIHBhdGggPSBtYXRjaC5wYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCk7CgogICAgICAgICAgICBpZiAobWF0Y2gucGF0aC5pbmRleE9mKHBhdGhQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKyBiYXNlUGF0aCArCiAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgcGF0aCArIHNlYXJjaCArIGhhc2g7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uVXJsIHJlcHJlc2VudHMgYW4gdXJsCiAgICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gSFRNTDUgbW9kZSBpcyBlbmFibGVkIGFuZCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSFRNTDUgdXJsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aFByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvblVybCh1cmwsIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpIHsKICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeCB8fCAnJzsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaHRtbDUgKHJlZ3VsYXIpIHVybCBzdHJpbmcgaW50byBwcm9wZXJ0aWVzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0Fic29sdXRlVXJsIEhUTUw1IHVybAogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24obmV3QWJzb2x1dGVVcmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwobmV3QWJzb2x1dGVVcmwsIHRoaXMpOwoKICAgICAgICAgICAgaWYgKG1hdGNoLnBhdGguaW5kZXhPZihwYXRoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgbmV3QWJzb2x1dGVVcmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2guaGFzaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gY29tcG9zZVByb3RvY29sSG9zdFBvcnQodGhpcy4kJHByb3RvY29sLCB0aGlzLiQkaG9zdCwgdGhpcy4kJHBvcnQpICsKICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggKyB0aGlzLiQkdXJsOwogICAgICAgIH07CgoKICAgICAgICB0aGlzLiQkcmV3cml0ZUFwcFVybCA9IGZ1bmN0aW9uKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZihhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGRpc2FibGVkIG9yIG5vdCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTGVnYWN5IHVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHZhciBiYXNlUGF0aDsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwodXJsLCB0aGlzKTsKCgogICAgICAgICAgICBpZiAobWF0Y2guaGFzaCAmJiBtYXRjaC5oYXNoLmluZGV4T2YoaGFzaFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIHVybCArICciLCBtaXNzaW5nIGhhc2ggcHJlZml4ICInICsgaGFzaFByZWZpeCArICciICEnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmFzZVBhdGggPSBtYXRjaC5wYXRoICsgKG1hdGNoLnNlYXJjaCA/ICc/JyArIG1hdGNoLnNlYXJjaCA6ICcnKTsKICAgICAgICAgICAgbWF0Y2ggPSBIQVNIX01BVENILmV4ZWMoKG1hdGNoLmhhc2ggfHwgJycpLnN1YnN0cihoYXNoUHJlZml4Lmxlbmd0aCkpOwogICAgICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gKG1hdGNoWzFdLmNoYXJBdCgwKSA9PSAnLycgPyAnJyA6ICcvJykgKyBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbMV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHBhdGggPSAnJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUobWF0Y2hbM10pOwogICAgICAgICAgICB0aGlzLiQkaGFzaCA9IG1hdGNoWzVdICYmIGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFs1XSkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgaGFzaGJhbmcgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gY29tcG9zZVByb3RvY29sSG9zdFBvcnQodGhpcy4kJHByb3RvY29sLCB0aGlzLiQkaG9zdCwgdGhpcy4kJHBvcnQpICsKICAgICAgICAgICAgICAgIGJhc2VQYXRoICsgKHRoaXMuJCR1cmwgPyAnIycgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZUFwcFVybCA9IGZ1bmN0aW9uKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZihhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIExvY2F0aW9uVXJsLnByb3RvdHlwZSA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogSGFzIGFueSBjaGFuZ2UgYmVlbiByZXBsYWNpbmcgPwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgJCRyZXBsYWNlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNhYnNVcmwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBmdWxsIHVybCByZXByZXNlbnRhdGlvbiB3aXRoIGFsbCBzZWdtZW50cyBlbmNvZGVkIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAgICAgKiB7QGxpbmsgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgUkZDIDM5ODZ9LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBmdWxsIHVybAogICAgICAgICAqLwogICAgICAgIGFic1VybDogbG9jYXRpb25HZXR0ZXIoJyQkYWJzVXJsJyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jdXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHVybCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKSB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB1cmwgTmV3IHVybCB3aXRob3V0IGJhc2UgcHJlZml4IChlLmcuIGAvcGF0aD9hPWIjaGFzaGApCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSB1cmwKICAgICAgICAgKi8KICAgICAgICB1cmw6IGZ1bmN0aW9uKHVybCwgcmVwbGFjZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdXJsOwoKICAgICAgICAgICAgdmFyIG1hdGNoID0gUEFUSF9NQVRDSC5leGVjKHVybCk7CiAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgICBpZiAobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pIHRoaXMuc2VhcmNoKG1hdGNoWzNdIHx8ICcnKTsKICAgICAgICAgICAgdGhpcy5oYXNoKG1hdGNoWzVdIHx8ICcnLCByZXBsYWNlKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcHJvdG9jb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwcm90b2NvbCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgICAgICAgKi8KICAgICAgICBwcm90b2NvbDogbG9jYXRpb25HZXR0ZXIoJyQkcHJvdG9jb2wnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNob3N0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKi8KICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcG9ydAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgICAgICAgKi8KICAgICAgICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcGF0aAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwYXRoIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBOb3RlOiBQYXRoIHNob3VsZCBhbHdheXMgYmVnaW4gd2l0aCBmb3J3YXJkIHNsYXNoICgvKSwgdGhpcyBtZXRob2Qgd2lsbCBhZGQgdGhlIGZvcndhcmQgc2xhc2gKICAgICAgICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwYXRoIE5ldyBwYXRoCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICAgICAgICovCiAgICAgICAgcGF0aDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkcGF0aCcsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdDxzdHJpbmcsc3RyaW5nPj19IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvciBoYXNoIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZywgdGhlbiBgcGFyYW1WYWx1ZWAgd2lsbCBvdmVycmlkZSBvbmx5IGEKICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHNlYXJjaAogICAgICAgICAqLwogICAgICAgIHNlYXJjaDogZnVuY3Rpb24oc2VhcmNoLCBwYXJhbVZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChzZWFyY2gpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCRzZWFyY2g7CgogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHBhcmFtVmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1WYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gaXNTdHJpbmcoc2VhcmNoKSA/IHBhcnNlS2V5VmFsdWUoc2VhcmNoKSA6IHNlYXJjaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNoYXNoCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gaGFzaCBOZXcgaGFzaCBmcmFnbWVudAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaGFzaAogICAgICAgICAqLwogICAgICAgIGhhc2g6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJGhhc2gnLCBpZGVudGl0eSksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcmVwbGFjZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIElmIGNhbGxlZCwgYWxsIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGR1cmluZyBjdXJyZW50IGAkZGlnZXN0YCB3aWxsIGJlIHJlcGxhY2luZyBjdXJyZW50IGhpc3RvcnkKICAgICAgICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICAgICAgICovCiAgICAgICAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuJCRyZXBsYWNlID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9IGluaGVyaXQoTG9jYXRpb25VcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCh1cmwsIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VFeHRyYSkgewogICAgICAgIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24oYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZVVybCArIGJhc2VFeHRyYSArICcjJyArIGhhc2hQcmVmaXggICsgYWJzb2x1dGVMaW5rVXJsLnN1YnN0cihhcHBCYXNlVXJsLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSk7CgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwoKICAgICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBwcmVwcm9jZXNzKHZhbHVlKTsKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvY2F0aW9uCiAgICAgKgogICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJHNuaWZmZXIKICAgICAqIEByZXF1aXJlcyAkcm9vdEVsZW1lbnQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSAkbG9jYXRpb24gc2VydmljZSBwYXJzZXMgdGhlIFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciAoYmFzZWQgb24gdGhlCiAgICAgKiB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vd2luZG93LmxvY2F0aW9uIHdpbmRvdy5sb2NhdGlvbn0pIGFuZCBtYWtlcyB0aGUgVVJMCiAgICAgKiBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4gQ2hhbmdlcyB0byB0aGUgVVJMIGluIHRoZSBhZGRyZXNzIGJhciBhcmUgcmVmbGVjdGVkIGludG8KICAgICAqICRsb2NhdGlvbiBzZXJ2aWNlIGFuZCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBhcmUgcmVmbGVjdGVkIGludG8gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIuCiAgICAgKgogICAgICogKipUaGUgJGxvY2F0aW9uIHNlcnZpY2U6KioKICAgICAqCiAgICAgKiAtIEV4cG9zZXMgdGhlIGN1cnJlbnQgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLCBzbyB5b3UgY2FuCiAgICAgKiAgIC0gV2F0Y2ggYW5kIG9ic2VydmUgdGhlIFVSTC4KICAgICAqICAgLSBDaGFuZ2UgdGhlIFVSTC4KICAgICAqIC0gU3luY2hyb25pemVzIHRoZSBVUkwgd2l0aCB0aGUgYnJvd3NlciB3aGVuIHRoZSB1c2VyCiAgICAgKiAgIC0gQ2hhbmdlcyB0aGUgYWRkcmVzcyBiYXIuCiAgICAgKiAgIC0gQ2xpY2tzIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIChvciBjbGlja3MgYSBIaXN0b3J5IGxpbmspLgogICAgICogICAtIENsaWNrcyBvbiBhIGxpbmsuCiAgICAgKiAtIFJlcHJlc2VudHMgdGhlIFVSTCBvYmplY3QgYXMgYSBzZXQgb2YgbWV0aG9kcyAocHJvdG9jb2wsIGhvc3QsIHBvcnQsIHBhdGgsIHNlYXJjaCwgaGFzaCkuCiAgICAgKgogICAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuc2VydmljZXMuJGxvY2F0aW9uIERldmVsb3BlciBHdWlkZTogQW5ndWxhcgogKiBTZXJ2aWNlczogVXNpbmcgJGxvY2F0aW9ufQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCl7CiAgICAgICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChwcmVmaXgpKSB7CiAgICAgICAgICAgICAgICBoYXNoUHJlZml4ID0gcHJlZml4OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFzaFByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2h0bWw1TW9kZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbW9kZSBVc2UgSFRNTDUgc3RyYXRlZ3kgaWYgYXZhaWxhYmxlLgogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5odG1sNU1vZGUgPSBmdW5jdGlvbihtb2RlKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgICAgICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoLAogICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybCA9ICRicm93c2VyLnVybCgpLAogICAgICAgICAgICAgICAgICAgIGluaXRVcmxQYXJ0cyA9IG1hdGNoVXJsKGluaXRVcmwpLAogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmw7CgogICAgICAgICAgICAgICAgaWYgKGh0bWw1TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoID0gJGJyb3dzZXIuYmFzZUhyZWYoKSB8fCAnLyc7CiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCk7CiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KGluaXRVcmxQYXJ0cy5wcm90b2NvbCwgaW5pdFVybFBhcnRzLmhvc3QsIGluaXRVcmxQYXJ0cy5wb3J0KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25VcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IdG1sNVVybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IYXNoYmFuZ1VybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoUHJlZml4LCBhcHBCYXNlVXJsLCBiYXNlUGF0aC5zdWJzdHIocGF0aFByZWZpeC5sZW5ndGggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpbml0VXJsUGFydHMucGF0aCB8fCAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5zZWFyY2ggPyAoJz8nICsgaW5pdFVybFBhcnRzLnNlYXJjaCkgOiAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyMnICsgaGFzaFByZWZpeCArICcvJzsKCiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uID0gbmV3IExvY2F0aW9uSGFzaGJhbmdVcmwoaW5pdFVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGVBcHBVcmwoYWJzSHJlZik7CgogICAgICAgICAgICAgICAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdFVybCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgICAgICAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24obmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBuZXdVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsICRsb2NhdGlvbi5hYnNVcmwoKSkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi5hYnNVcmwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBicm93c2VyCiAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiAkbG9jYXRpb25XYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGJyb3dzZXIudXJsKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjaGFuZ2VDb3VudGVyIHx8IG9sZFVybCAhPSAkbG9jYXRpb24uYWJzVXJsKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlQ291bnRlcisrOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2cKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgICAqCiAgICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICBNZXNzYWdlOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbigkd2luZG93KXsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNsb2cKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIGxvZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2luZm8KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZXJyb3IKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wOwoKICAgICAgICAgICAgICAgIGlmIChsb2dGbi5hcHBseSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGZvcm1hdEVycm9yKGFyZykpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2UgYXJlIElFIHdoaWNoIGVpdGhlciBkb2Vzbid0IGhhdmUgd2luZG93LmNvbnNvbGUgPT4gdGhpcyBpcyBub29wIGFuZCB3ZSBkbyBub3RoaW5nLAogICAgICAgICAgICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgICAgICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIE9QRVJBVE9SUyA9IHsKICAgICAgICAnbnVsbCc6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbDt9LAogICAgICAgICd0cnVlJzpmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCiAgICAgICAgJ2ZhbHNlJzpmdW5jdGlvbigpe3JldHVybiBmYWxzZTt9LAogICAgICAgIHVuZGVmaW5lZDpub29wLAogICAgICAgICcrJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgICAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0RlZmluZWQoYik/Yjp1bmRlZmluZWQ7fSwKICAgICAgICAnLSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe2E9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsgcmV0dXJuIChpc0RlZmluZWQoYSk/YTowKS0oaXNEZWZpbmVkKGIpP2I6MCk7fSwKICAgICAgICAnKic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykqYihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJy8nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpL2Ioc2VsZiwgbG9jYWxzKTt9LAogICAgICAgICclJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSViKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnXic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyleYihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJz0nOm5vb3AsCiAgICAgICAgJz09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJyE9JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9YihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJzwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPGIoc2VsZiwgbG9jYWxzKTt9LAogICAgICAgICc+JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT5iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnPD0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPD1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnPj0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPj1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJiZiKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnfHwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpfHxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmYihzZWxmLCBsb2NhbHMpO30sCi8vICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGF8Yjt9LAogICAgICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7fSwKICAgICAgICAnISc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhKXtyZXR1cm4gIWEoc2VsZiwgbG9jYWxzKTt9CiAgICB9OwogICAgdmFyIEVTQ0FQRSA9IHsibiI6IlxuIiwgImYiOiJcZiIsICJyIjoiXHIiLCAidCI6Ilx0IiwgInYiOiJcdiIsICInIjoiJyIsICciJzonIid9OwoKICAgIGZ1bmN0aW9uIGxleCh0ZXh0LCBjc3ApewogICAgICAgIHZhciB0b2tlbnMgPSBbXSwKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAganNvbiA9IFtdLAogICAgICAgICAgICBjaCwKICAgICAgICAgICAgbGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBpZiAoaXMoJyJcJycpKSB7CiAgICAgICAgICAgICAgICByZWFkU3RyaW5nKGNoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihjaCkgfHwgaXMoJy4nKSAmJiBpc051bWJlcihwZWVrKCkpKSB7CiAgICAgICAgICAgICAgICByZWFkTnVtYmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNJZGVudChjaCkpIHsKICAgICAgICAgICAgICAgIHJlYWRJZGVudCgpOwogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllcnMgY2FuIG9ubHkgYmUgaWYgdGhlIHByZWNlZGluZyBjaGFyIHdhcyBhIHsgb3IgLAogICAgICAgICAgICAgICAgaWYgKHdhcygneywnKSAmJiBqc29uWzBdPT0neycgJiYKICAgICAgICAgICAgICAgICAgICAodG9rZW49dG9rZW5zW3Rva2Vucy5sZW5ndGgtMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4uanNvbiA9IHRva2VuLnRleHQuaW5kZXhPZignLicpID09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzKCcoKXt9W10uLDs6JykpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDppbmRleCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OmNoLAogICAgICAgICAgICAgICAgICAgIGpzb246KHdhcygnOlssJykgJiYgaXMoJ3tbJykpIHx8IGlzKCd9XTosJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGlzKCd7WycpKSBqc29uLnVuc2hpZnQoY2gpOwogICAgICAgICAgICAgICAgaWYgKGlzKCd9XScpKSBqc29uLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjaDIgPSBjaCArIHBlZWsoKSwKICAgICAgICAgICAgICAgICAgICBmbiA9IE9QRVJBVE9SU1tjaF0sCiAgICAgICAgICAgICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgICAgICAgICBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OmluZGV4LCB0ZXh0OmNoMiwgZm46Zm4yfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6aW5kZXgsIHRleHQ6Y2gsIGZuOmZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXgrMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENoID0gY2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbnM7CgogICAgICAgIGZ1bmN0aW9uIGlzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGNoKSAhPSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcyhjaGFycykgewogICAgICAgICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlaygpIHsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ICsgMSA8IHRleHQubGVuZ3RoID8gdGV4dC5jaGFyQXQoaW5kZXggKyAxKSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc051bWJlcihjaCkgewogICAgICAgICAgICByZXR1cm4gJzAnIDw9IGNoICYmIGNoIDw9ICc5JzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBjaCA9PSAnICcgfHwgY2ggPT0gJ1xyJyB8fCBjaCA9PSAnXHQnIHx8CiAgICAgICAgICAgICAgICBjaCA9PSAnXG4nIHx8IGNoID09ICdcdicgfHwgY2ggPT0gJ1x1MDBBMCc7IC8vIElFIHRyZWF0cyBub24tYnJlYWtpbmcgc3BhY2UgYXMgXHUwMEEwCiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSWRlbnQoY2gpIHsKICAgICAgICAgICAgcmV0dXJuICdhJyA8PSBjaCAmJiBjaCA8PSAneicgfHwKICAgICAgICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAgICAgICdfJyA9PSBjaCB8fCBjaCA9PSAnJCc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXhwT3BlcmF0b3IoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICctJyB8fCBjaCA9PSAnKycgfHwgaXNOdW1iZXIoY2gpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJMZXhlciBFcnJvcjogIiArIGVycm9yICsgIiBhdCBjb2x1bW4iICsKICAgICAgICAgICAgICAgIChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAgIi0iICsgaW5kZXggKyAiIFsiICsgdGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAiXSIKICAgICAgICAgICAgICAgICAgICA6ICIgIiArIGVuZCkgKwogICAgICAgICAgICAgICAgIiBpbiBleHByZXNzaW9uIFsiICsgdGV4dCArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZE51bWJlcigpIHsKICAgICAgICAgICAgdmFyIG51bWJlciA9ICIiOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0ZXh0LmNoYXJBdChpbmRleCkpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBwZWVrQ2ggPSBwZWVrKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICdlJyAmJiBpc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICghcGVla0NoIHx8ICFpc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OnN0YXJ0LCB0ZXh0Om51bWJlciwganNvbjp0cnVlLAogICAgICAgICAgICAgICAgZm46ZnVuY3Rpb24oKSB7cmV0dXJuIG51bWJlcjt9fSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRJZGVudCgpIHsKICAgICAgICAgICAgdmFyIGlkZW50ID0gIiIsCiAgICAgICAgICAgICAgICBzdGFydCA9IGluZGV4LAogICAgICAgICAgICAgICAgbGFzdERvdCwgcGVla0luZGV4LCBtZXRob2ROYW1lLCBjaDsKCiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicgfHwgaXNJZGVudChjaCkgfHwgaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJykgbGFzdERvdCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIGlkZW50ICs9IGNoOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vY2hlY2sgaWYgdGhpcyBpcyBub3QgYSBtZXRob2QgaW52b2NhdGlvbiBhbmQgaWYgaXQgaXMgYmFjayBvdXQgdG8gbGFzdCBkb3QKICAgICAgICAgICAgaWYgKGxhc3REb3QpIHsKICAgICAgICAgICAgICAgIHBlZWtJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgd2hpbGUocGVla0luZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KHBlZWtJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICcoJykgewogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZGVudCA9IGlkZW50LnN1YnN0cigwLCBsYXN0RG90IC0gc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IHBlZWtJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6c3RhcnQsCiAgICAgICAgICAgICAgICB0ZXh0OmlkZW50CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoT1BFUkFUT1JTLmhhc093blByb3BlcnR5KGlkZW50KSkgewogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSB0b2tlbi5qc29uID0gT1BFUkFUT1JTW2lkZW50XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBnZXR0ZXJGbihpZGVudCwgY3NwKTsKICAgICAgICAgICAgICAgIHRva2VuLmZuID0gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2VsZiwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldHRlcihzZWxmLCBpZGVudCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CgogICAgICAgICAgICBpZiAobWV0aG9kTmFtZSkgewogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4Omxhc3REb3QsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogJy4nLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogbWV0aG9kTmFtZSwKICAgICAgICAgICAgICAgICAgICBqc29uOiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlYWRTdHJpbmcocXVvdGUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIjsKICAgICAgICAgICAgdmFyIHJhd1N0cmluZyA9IHF1b3RlOwogICAgICAgICAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICByYXdTdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICd1JykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGV4ID0gdGV4dC5zdWJzdHJpbmcoaW5kZXggKyAxLCBpbmRleCArIDUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoICJJbnZhbGlkIHVuaWNvZGUgZXNjYXBlIFtcXHUiICsgaGV4ICsgIl0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXAgPSBFU0NBUEVbY2hdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gcmVwOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IGNoOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PSAnXFwnKSB7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gcXVvdGUpIHsKICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6c3RhcnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6cmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6c3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBqc29uOnRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZuOmZ1bmN0aW9uKCkgeyByZXR1cm4gc3RyaW5nOyB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93RXJyb3IoIlVudGVybWluYXRlZCBxdW90ZSIsIHN0YXJ0KTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHBhcnNlcih0ZXh0LCBqc29uLCAkZmlsdGVyLCBjc3ApewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmKGpzb24pewogICAgICAgICAgICAvLyBUaGUgZXh0cmEgbGV2ZWwgb2YgYWxpYXNpbmcgaXMgaGVyZSwganVzdCBpbiBjYXNlIHRoZSBsZXhlciBtaXNzZXMgc29tZXRoaW5nLCBzbyB0aGF0CiAgICAgICAgICAgIC8vIHdlIHByZXZlbnQgYW55IGFjY2lkZW50YWwgZXhlY3V0aW9uIGluIEpTT04uCiAgICAgICAgICAgIGFzc2lnbm1lbnQgPSBsb2dpY2FsT1I7CiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9CiAgICAgICAgICAgICAgICBmaWVsZEFjY2VzcyA9CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0SW5kZXggPQogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJDaGFpbiA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB7dGV4dDp0ZXh0LCBpbmRleDowfSk7IH07CiAgICAgICAgICAgIHZhbHVlID0gcHJpbWFyeSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gc3RhdGVtZW50cygpOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBhbiB1bmV4cGVjdGVkIHRva2VuIiwgdG9rZW5zWzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIGZ1bmN0aW9uIHRocm93RXJyb3IobXNnLCB0b2tlbikgewogICAgICAgICAgICB0aHJvdyBFcnJvcigiU3ludGF4IEVycm9yOiBUb2tlbiAnIiArIHRva2VuLnRleHQgKwogICAgICAgICAgICAgICAgIicgIiArIG1zZyArICIgYXQgY29sdW1uICIgKwogICAgICAgICAgICAgICAgKHRva2VuLmluZGV4ICsgMSkgKyAiIG9mIHRoZSBleHByZXNzaW9uIFsiICsKICAgICAgICAgICAgICAgIHRleHQgKyAiXSBzdGFydGluZyBhdCBbIiArIHRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVla1Rva2VuKCkgewogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBleHByZXNzaW9uOiAiICsgdGV4dCk7CiAgICAgICAgICAgIHJldHVybiB0b2tlbnNbMF07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKGUxLCBlMiwgZTMsIGU0KSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zWzBdOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0b2tlbi50ZXh0OwogICAgICAgICAgICAgICAgaWYgKHQ9PWUxIHx8IHQ9PWUyIHx8IHQ9PWUzIHx8IHQ9PWU0IHx8CiAgICAgICAgICAgICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwZWN0KGUxLCBlMiwgZTMsIGU0KXsKICAgICAgICAgICAgdmFyIHRva2VuID0gcGVlayhlMSwgZTIsIGUzLCBlNCk7CiAgICAgICAgICAgIGlmICh0b2tlbikgewogICAgICAgICAgICAgICAgaWYgKGpzb24gJiYgIXRva2VuLmpzb24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRva2Vucy5zaGlmdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN1bWUoZTEpewogICAgICAgICAgICBpZiAoIWV4cGVjdChlMSkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbIiArIGUxICsgIl0iLCBwZWVrKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeUZuKGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCByaWdodCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBiaW5hcnlGbihsZWZ0LCBmbiwgcmlnaHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgbGVmdCwgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc3RhdGVtZW50cygpIHsKICAgICAgICAgICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc3RhdGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVtZW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGVtZW50KHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9maWx0ZXJDaGFpbigpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnfCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZmlsdGVyKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlsdGVyKCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgdmFyIGZuID0gJGZpbHRlcih0b2tlbi50ZXh0KTsKICAgICAgICAgICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBpbnB1dCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cHJlc3Npb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhc3NpZ25tZW50KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfYXNzaWdubWVudCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz0nKSkpIHsKICAgICAgICAgICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgIl0gY2FuIG5vdCBiZSBhc3NpZ25lZCB0byIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJpZ2h0ID0gbG9naWNhbE9SKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQuYXNzaWduKHNjb3BlLCByaWdodChzY29wZSwgbG9jYWxzKSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9naWNhbE9SKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGxvZ2ljYWxBTkQoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8fCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbG9naWNhbEFORCgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxBTkQoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXF1YWxpdHkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXF1YWxpdHkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gcmVsYXRpb25hbCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywnIT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCctJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIG11bHRpcGxpY2F0aXZlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbXVsdGlwbGljYXRpdmUoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdW5hcnkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAoKHRva2VuID0gZXhwZWN0KCcqJywnLycsJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgICAgICAgIHdoaWxlICgobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSU1QT1NTSUJMRSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpZWxkQWNjZXNzKG9iamVjdCkgewogICAgICAgICAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIGNzcCk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSwgbG9jYWxzLCBzZWxmKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcihzZWxmIHx8IG9iamVjdChzY29wZSwgbG9jYWxzKSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9vYmplY3RJbmRleChvYmopIHsKICAgICAgICAgICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCgKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIG8gPSBvYmooc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgdiwgcDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHYgPSBvW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh2ICYmIHYudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246ZnVuY3Rpb24oc2VsZiwgdmFsdWUsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmooc2VsZiwgbG9jYWxzKVtpbmRleEZuKHNlbGYsIGxvY2FscyldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKXsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHRHZXR0ZXIgPyBjb250ZXh0R2V0dGVyKHNjb3BlLCBsb2NhbHMpIDogc2NvcGU7CgogICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZm5QdHIgPSBmbihzY29wZSwgbG9jYWxzLCBjb250ZXh0KSB8fCBub29wOwogICAgICAgICAgICAgICAgLy8gSUUgc3R1cGlkaXR5IQogICAgICAgICAgICAgICAgcmV0dXJuIGZuUHRyLmFwcGx5CiAgICAgICAgICAgICAgICAgICAgPyBmblB0ci5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICAgICAgICAgICAgICAgIDogZm5QdHIoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIHVzZWQgd2l0aCBqc29uIGFycmF5IGRlY2xhcmF0aW9uCiAgICAgICAgZnVuY3Rpb24gYXJyYXlEZWNsYXJhdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICddJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChleHByZXNzaW9uKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGVsZW1lbnRGbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvYmplY3QgKCkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVzID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICd9JykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6a2V5LCB2YWx1ZTp2YWx1ZX0pOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ30nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHNldHRlcihvYmosIHBhdGgsIHNldFZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LnNoaWZ0KCk7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICAgICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgICB9CiAgICAgICAgb2JqW2VsZW1lbnQuc2hpZnQoKV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgdmFyIGdldHRlckZuQ2FjaGUgPSB7fTsKCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICAgICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAgICovCiAgICBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgaWYgKHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkxIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkzIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXk0IHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3ApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwLCB2YWw7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gY3NwU2FmZUdldHRlckZuKAogICAgICAgICAgICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdCiAgICAgICAgICAgICAgICAgICAgKShzY29wZSwgbG9jYWxzKTsKCiAgICAgICAgICAgICAgICAgICAgbG9jYWxzID0gdW5kZWZpbmVkOyAvLyBjbGVhciBhZnRlciBmaXJzdCBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGkgPCBwYXRoS2V5c0xlbmd0aCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSAndmFyIGwsIGZuLCBwO1xuJzsKICAgICAgICAgICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgICAgICAgICAgY29kZSArPSAnaWYocyA9PT0gbnVsbCB8fCBzID09PSB1bmRlZmluZWQpIHJldHVybiBzO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAgICAgICAgICdzPScrIChpbmRleAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHA9cztcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7IHJldHVybiBjb2RlOyB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRwYXJzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAgICAgKiAgIHZhciBzZXR0ZXIgPSBnZXR0ZXIuYXNzaWduOwogICAgICogICB2YXIgY29udGV4dCA9IHt1c2VyOntuYW1lOidhbmd1bGFyJ319OwogICAgICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogICAgICoKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0KSkudG9FcXVhbCgnYW5ndWxhcicpOwogICAgICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAgICAgKiAgIGV4cGVjdChjb250ZXh0LnVzZXIubmFtZSkudG9FcXVhbCgnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0LCBsb2NhbHMpKS50b0VxdWFsKCdsb2NhbCcpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0aXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKgogICAgICogICAgVGhlIHJldHVybiBmdW5jdGlvbiBhbHNvIGhhcyBhbiBgYXNzaWduYCBwcm9wZXJ0eSwgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgd2hpY2gKICAgICAqICAgIGFsbG93cyBvbmUgdG8gc2V0IHZhbHVlcyB0byBleHByZXNzaW9ucy4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihleHApIHsKICAgICAgICAgICAgICAgIHN3aXRjaCh0eXBlb2YgZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gY2FjaGVbZXhwXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBjYWNoZVtleHBdID0gIHBhcnNlcihleHAsIGZhbHNlLCAkZmlsdGVyLCAkc25pZmZlci5jc3ApOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cDsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kcQogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcHJvbWlzZS9kZWZlcnJlZCBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbS3JpcyBLb3dhbCdzIFFdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkuCiAgICAgKgogICAgICogW1RoZSBDb21tb25KUyBQcm9taXNlIHByb3Bvc2FsXShodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcykgZGVzY3JpYmVzIGEgcHJvbWlzZSBhcyBhbgogICAgICogaW50ZXJmYWNlIGZvciBpbnRlcmFjdGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IHJlcHJlc2VudHMgdGhlIHJlc3VsdCBvZiBhbiBhY3Rpb24gdGhhdCBpcwogICAgICogcGVyZm9ybWVkIGFzeW5jaHJvbm91c2x5LCBhbmQgbWF5IG9yIG1heSBub3QgYmUgZmluaXNoZWQgYXQgYW55IGdpdmVuIHBvaW50IGluIHRpbWUuCiAgICAgKgogICAgICogRnJvbSB0aGUgcGVyc3BlY3RpdmUgb2YgZGVhbGluZyB3aXRoIGVycm9yIGhhbmRsaW5nLCBkZWZlcnJlZCBhbmQgcHJvbWlzZSBBUElzIGFyZSB0bwogICAgICogYXN5bmNocm9ub3VzIHByb2dyYW1taW5nIHdoYXQgYHRyeWAsIGBjYXRjaGAgYW5kIGB0aHJvd2Aga2V5d29yZHMgYXJlIHRvIHN5bmNocm9ub3VzIHByb2dyYW1taW5nLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGZvciB0aGUgcHVycG9zZSBvZiB0aGlzIGV4YW1wbGUgbGV0J3MgYXNzdW1lIHRoYXQgdmFyaWFibGVzIGAkcWAgYW5kIGBzY29wZWAgYXJlCiAgICAgKiAgIC8vIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCBsZXhpY2FsIHNjb3BlICh0aGV5IGNvdWxkIGhhdmUgYmVlbiBpbmplY3RlZCBvciBwYXNzZWQgaW4pLgogICAgICoKICAgICAqICAgZnVuY3Rpb24gYXN5bmNHcmVldChuYW1lKSB7CiAqICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKgogKiAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICogICAgICAgLy8gc2luY2UgdGhpcyBmbiBleGVjdXRlcyBhc3luYyBpbiBhIGZ1dHVyZSB0dXJuIG9mIHRoZSBldmVudCBsb29wLCB3ZSBuZWVkIHRvIHdyYXAKICogICAgICAgLy8gb3VyIGNvZGUgaW50byBhbiAkYXBwbHkgY2FsbCBzbyB0aGF0IHRoZSBtb2RlbCBjaGFuZ2VzIGFyZSBwcm9wZXJseSBvYnNlcnZlZC4KICogICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogKiAgICAgICAgIGlmIChva1RvR3JlZXQobmFtZSkpIHsKICogICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoJ0hlbGxvLCAnICsgbmFtZSArICchJyk7CiAqICAgICAgICAgfSBlbHNlIHsKICogICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgnR3JlZXRpbmcgJyArIG5hbWUgKyAnIGlzIG5vdCBhbGxvd2VkLicpOwogKiAgICAgICAgIH0KICogICAgICAgfSk7CiAqICAgICB9LCAxMDAwKTsKICoKICogICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogKiAgIH0KICAgICAqCiAgICAgKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogICAgICogICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICogICAgIGFsZXJ0KCdTdWNjZXNzOiAnICsgZ3JlZXRpbmcpOwogKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogKiAgICAgYWxlcnQoJ0ZhaWxlZDogJyArIHJlYXNvbik7CiAqICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBBdCBmaXJzdCBpdCBtaWdodCBub3QgYmUgb2J2aW91cyB3aHkgdGhpcyBleHRyYSBjb21wbGV4aXR5IGlzIHdvcnRoIHRoZSB0cm91YmxlLiBUaGUgcGF5b2ZmCiAgICAgKiBjb21lcyBpbiB0aGUgd2F5IG9mCiAgICAgKiBbZ3VhcmFudGVlcyB0aGF0IHByb21pc2UgYW5kIGRlZmVycmVkIEFQSXMgbWFrZV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC91bmNvbW1vbmpzL2Jsb2IvbWFzdGVyL3Byb21pc2VzL3NwZWNpZmljYXRpb24ubWQpLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSB0aGUgcHJvbWlzZSBhcGkgYWxsb3dzIGZvciBjb21wb3NpdGlvbiB0aGF0IGlzIHZlcnkgaGFyZCB0byBkbyB3aXRoIHRoZQogICAgICogdHJhZGl0aW9uYWwgY2FsbGJhY2sgKFtDUFNdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29udGludWF0aW9uLXBhc3Npbmdfc3R5bGUpKSBhcHByb2FjaC4KICAgICAqIEZvciBtb3JlIG9uIHRoaXMgcGxlYXNlIHNlZSB0aGUgW1EgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKSBlc3BlY2lhbGx5IHRoZQogICAgICogc2VjdGlvbiBvbiBzZXJpYWwgb3IgcGFyYWxsZWwgam9pbmluZyBvZiBwcm9taXNlcy4KICAgICAqCiAgICAgKgogICAgICogIyBUaGUgRGVmZXJyZWQgQVBJCiAgICAgKgogICAgICogQSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQgaXMgY29uc3RydWN0ZWQgYnkgY2FsbGluZyBgJHEuZGVmZXIoKWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIGRlZmVycmVkIG9iamVjdCBpcyB0byBleHBvc2UgdGhlIGFzc29jaWF0ZWQgUHJvbWlzZSBpbnN0YW5jZSBhcyB3ZWxsIGFzIEFQSXMKICAgICAqIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHNpZ25hbGluZyB0aGUgc3VjY2Vzc2Z1bCBvciB1bnN1Y2Nlc3NmdWwgY29tcGxldGlvbiBvZiB0aGUgdGFzay4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHJlc29sdmUodmFsdWUpYCDigJMgcmVzb2x2ZXMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgdmFsdWVgLiBJZiB0aGUgdmFsdWUgaXMgYSByZWplY3Rpb24KICAgICAqICAgY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLCB0aGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGluc3RlYWQuCiAgICAgKiAtIGByZWplY3QocmVhc29uKWAg4oCTIHJlamVjdHMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgcmVhc29uYC4gVGhpcyBpcyBlcXVpdmFsZW50IHRvCiAgICAgKiAgIHJlc29sdmluZyBpdCB3aXRoIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YC4KICAgICAqCiAgICAgKiAqKlByb3BlcnRpZXMqKgogICAgICoKICAgICAqIC0gcHJvbWlzZSDigJMgYHtQcm9taXNlfWAg4oCTIHByb21pc2Ugb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlZmVycmVkLgogICAgICoKICAgICAqCiAgICAgKiAjIFRoZSBQcm9taXNlIEFQSQogICAgICoKICAgICAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogICAgICogY2FsbGluZyBgZGVmZXJyZWQucHJvbWlzZWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAgICAgKiBvZiB0aGUgZGVmZXJyZWQgdGFzayB3aGVuIGl0IGNvbXBsZXRlcy4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKWAg4oCTIHJlZ2FyZGxlc3Mgb2Ygd2hlbiB0aGUgcHJvbWlzZSB3YXMgb3Igd2lsbCBiZSByZXNvbHZlZAogICAgICogICBvciByZWplY3RlZCwgYHRoZW5gIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkgYXMgc29vbiBhcyB0aGUgcmVzdWx0CiAgICAgKiAgIGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQ6IHRoZSByZXN1bHQgb3IgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAqCiAgICAgKiAgIFRoaXMgbWV0aG9kICpyZXR1cm5zIGEgbmV3IHByb21pc2UqIHdoaWNoIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogICAgICogICBgc3VjY2Vzc0NhbGxiYWNrYCBvciBgZXJyb3JDYWxsYmFja2AuCiAgICAgKgogICAgICoKICAgICAqICMgQ2hhaW5pbmcgcHJvbWlzZXMKICAgICAqCiAgICAgKiBCZWNhdXNlIGNhbGxpbmcgdGhlIGB0aGVuYCBtZXRob2Qgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkgcG9zc2libGUKICAgICAqIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAgICAgKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICogCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICogCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gcUZhY3RvcnkoZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICAgICAgICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICAgICAgICB9XTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RzIGEgcHJvbWlzZSBtYW5hZ2VyLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZnVuY3Rpb24pfSBuZXh0VGljayBGdW5jdGlvbiBmb3IgZXhlY3V0aW5nIGZ1bmN0aW9ucyBpbiB0aGUgbmV4dCB0dXJuLgogICAgICogQHBhcmFtIHtmdW5jdGlvbiguLi4qKX0gZXhjZXB0aW9uSGFuZGxlciBGdW5jdGlvbiBpbnRvIHdoaWNoIHVuZXhwZWN0ZWQgZXhjZXB0aW9ucyBhcmUgcGFzc2VkIGZvcgogICAgICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFByb21pc2UgbWFuYWdlci4KICAgICAqLwogICAgZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHEKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDcmVhdGVzIGEgYERlZmVycmVkYCBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhIHRhc2sgd2hpY2ggd2lsbCBmaW5pc2ggaW4gdGhlIGZ1dHVyZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtEZWZlcnJlZH0gUmV0dXJucyBhIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZC4KICAgICAgICAgKi8KICAgICAgICB2YXIgZGVmZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlZih2YWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbihjYWxsYmFja1swXSwgY2FsbGJhY2tbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlamVjdChyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgIHByb21pc2U6IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChlcnJiYWNrIHx8IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLnB1c2goW3dyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2tdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICAgICAgfTsKCgogICAgICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudGhlbikgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoY2FsbGJhY2sodmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI3JlamVjdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgICAgICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgICAgICAgKiBhIHByb21pc2UgY2hhaW4sIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LgogICAgICAgICAqCiAgICAgICAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICAgICAgICogYHJlamVjdGAgYXMgdGhlIGB0aHJvd2Aga2V5d29yZCBpbiBKYXZhU2NyaXB0LiBUaGlzIGFsc28gbWVhbnMgdGhhdCBpZiB5b3UgImNhdGNoIiBhbiBlcnJvciB2aWEKICAgICAgICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgICAgICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAgICAgICAqIGByZWplY3RgLgogICAgICAgICAqCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgKiAgICAgLy8gc3VjY2VzczogZG8gc29tZXRoaW5nIGFuZCByZXNvbHZlIHByb21pc2VCCiAgICogICAgIC8vICAgICAgICAgIHdpdGggdGhlIG9sZCBvciBhIG5ldyByZXN1bHQKICAgKiAgICAgcmV0dXJuIHJlc3VsdDsKICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAqICAgICAvLyBlcnJvcjogaGFuZGxlIHRoZSBlcnJvciBpZiBwb3NzaWJsZSBhbmQKICAgKiAgICAgLy8gICAgICAgIHJlc29sdmUgcHJvbWlzZUIgd2l0aCBuZXdQcm9taXNlT3JWYWx1ZSwKICAgKiAgICAgLy8gICAgICAgIG90aGVyd2lzZSBmb3J3YXJkIHRoZSByZWplY3Rpb24gdG8gcHJvbWlzZUIKICAgKiAgICAgaWYgKGNhbkhhbmRsZShyZWFzb24pKSB7CiAgICogICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGFuZCByZWNvdmVyCiAgICogICAgICByZXR1cm4gbmV3UHJvbWlzZU9yVmFsdWU7CiAgICogICAgIH0KICAgKiAgICAgcmV0dXJuICRxLnJlamVjdChyZWFzb24pOwogICAqICAgfSk7CiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHJlYXNvbiBDb25zdGFudCwgbWVzc2FnZSwgZXhjZXB0aW9uIG9yIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlamVjdGlvbiByZWFzb24uCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICAgICAgICovCiAgICAgICAgdmFyIHJlamVjdCA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjd2hlbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICAgICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAgICAgKi8KICAgICAgICB2YXIgd2hlbiA9IGZ1bmN0aW9uKHZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlcnJiYWNrIHx8IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShyZWYodmFsdWUpLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaykpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh3cmFwcGVkRXJyYmFjayhyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICB9OwoKCiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdENhbGxiYWNrKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0RXJyYmFjayhyZWFzb24pIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdChyZWFzb24pOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI2FsbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbWJpbmVzIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gYWxsIG9mIHRoZSBpbnB1dAogICAgICAgICAqIHByb21pc2VzIGFyZSByZXNvbHZlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvZiBwcm9taXNlcy4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5IG9mIHZhbHVlcywKICAgICAgICAgKiAgIGVhY2ggdmFsdWUgY29ycmVzcG9uZGluZyB0byB0aGUgcHJvbWlzZSBhdCB0aGUgc2FtZSBpbmRleCBpbiB0aGUgYHByb21pc2VzYCBhcnJheS4gSWYgYW55IG9mCiAgICAgICAgICogICB0aGUgcHJvbWlzZXMgaXMgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbiwgdGhpcyByZXN1bHRpbmcgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggdGhlCiAgICAgICAgICogICBzYW1lIHJlamVjdGlvbi4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGNvdW50ZXIgPSBwcm9taXNlcy5sZW5ndGgsCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICBpZiAoY291bnRlcikgewogICAgICAgICAgICAgICAgZm9yRWFjaChwcm9taXNlcywgZnVuY3Rpb24ocHJvbWlzZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggaW4gcmVzdWx0cykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzW2luZGV4XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgtLWNvdW50ZXIpKSBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggaW4gcmVzdWx0cykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkZWZlcjogZGVmZXIsCiAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICB3aGVuOiB3aGVuLAogICAgICAgICAgICBhbGw6IGFsbAogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm91dGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgcm91dGVzLiBTZWUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IGZvciBhbiBleGFtcGxlLgogICAgICovCiAgICBmdW5jdGlvbiAkUm91dGVQcm92aWRlcigpewogICAgICAgIHZhciByb3V0ZXMgPSB7fTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLnBhdGhgKS4gSWYgYCRsb2NhdGlvbi5wYXRoYAogICAgICAgICAqICAgIGNvbnRhaW5zIHJlZHVuZGFudCB0cmFpbGluZyBzbGFzaCBvciBpcyBtaXNzaW5nIG9uZSwgdGhlIHJvdXRlIHdpbGwgc3RpbGwgbWF0Y2ggYW5kIHRoZQogICAgICAgICAqICAgIGAkbG9jYXRpb24ucGF0aGAgd2lsbCBiZSB1cGRhdGVkIHRvIGFkZCBvciBkcm9wIHRoZSB0cmFpbGluZyBzbGFzaCB0byBleGFjdGx5IG1hdGNoIHRoZQogICAgICAgICAqICAgIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiAgICBgcGF0aGAgY2FuIGNvbnRhaW4gbmFtZWQgZ3JvdXBzIHN0YXJ0aW5nIHdpdGggYSBjb2xvbiAoYDpuYW1lYCkuIEFsbCBjaGFyYWN0ZXJzIHVwIHRvIHRoZQogICAgICAgICAqICAgIG5leHQgc2xhc2ggYXJlIG1hdGNoZWQgYW5kIHN0b3JlZCBpbiBgJHJvdXRlUGFyYW1zYCB1bmRlciB0aGUgZ2l2ZW4gYG5hbWVgIGFmdGVyIHRoZSByb3V0ZQogICAgICAgICAqICAgIGlzIHJlc29sdmVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHJvdXRlIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YCBvbiByb3V0ZQogICAgICAgICAqICAgIG1hdGNoLgogICAgICAgICAqCiAgICAgICAgICogICAgT2JqZWN0IHByb3BlcnRpZXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBjb250cm9sbGVyYCDigJMgYHsoc3RyaW5nfGZ1bmN0aW9uKCk9fWAg4oCTIENvbnRyb2xsZXIgZm4gdGhhdCBzaG91bGQgYmUgYXNzb2NpYXRlZCB3aXRoIG5ld2x5CiAgICAgICAgICogICAgICBjcmVhdGVkIHNjb3BlIG9yIHRoZSBuYW1lIG9mIGEge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIgcmVnaXN0ZXJlZCBjb250cm9sbGVyfQogICAgICAgICAqICAgICAgaWYgcGFzc2VkIGFzIGEgc3RyaW5nLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlYCDigJMgYHtzdHJpbmc9fWAg4oCTICBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30gb3IKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIG5nSW5jbHVkZX0gZGlyZWN0aXZlcy4KICAgICAgICAgKiAgICAgIHRoaXMgcHJvcGVydHkgdGFrZXMgcHJlY2VkZW5jZSBvdmVyIGB0ZW1wbGF0ZVVybGAuCiAgICAgICAgICogICAgLSBgdGVtcGxhdGVVcmxgIOKAkyBge3N0cmluZz19YCDigJMgcGF0aCB0byBhbiBodG1sIHRlbXBsYXRlIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30uCiAgICAgICAgICogICAgLSBgcmVzb2x2ZWAgLSBge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbj49fWAgLSBBbiBvcHRpb25hbCBtYXAgb2YgZGVwZW5kZW5jaWVzIHdoaWNoIHNob3VsZAogICAgICAgICAqICAgICAgYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gSWYgYW55IG9mIHRoZXNlIGRlcGVuZGVuY2llcyBhcmUgcHJvbWlzZXMsIHRoZXkgd2lsbCBiZQogICAgICAgICAqICAgICAgcmVzb2x2ZWQgYW5kIGNvbnZlcnRlZCB0byBhIHZhbHVlIGJlZm9yZSB0aGUgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQgYW5kIHRoZQogICAgICAgICAqICAgICAgYCRyb3V0ZUNoYW5nZVN1Y2Nlc3NgIGV2ZW50IGlzIGZpcmVkLiBUaGUgbWFwIG9iamVjdCBpczoKICAgICAgICAgKgogICAgICAgICAqICAgICAgLSBga2V5YCDigJMgYHtzdHJpbmd9YDogYSBuYW1lIG9mIGEgZGVwZW5kZW5jeSB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBjb250cm9sbGVyLgogICAgICAgICAqICAgICAgLSBgZmFjdG9yeWAgLSBge3N0cmluZ3xmdW5jdGlvbn1gOiBJZiBgc3RyaW5nYCB0aGVuIGl0IGlzIGFuIGFsaWFzIGZvciBhIHNlcnZpY2UuCiAgICAgICAgICogICAgICAgIE90aGVyd2lzZSBpZiBmdW5jdGlvbiwgdGhlbiBpdCBpcyB7QGxpbmsgYXBpL0FVVE8uJGluamVjdG9yI2ludm9rZSBpbmplY3RlZH0KICAgICAgICAgKiAgICAgICAgYW5kIHRoZSByZXR1cm4gdmFsdWUgaXMgdHJlYXRlZCBhcyB0aGUgZGVwZW5kZW5jeS4gSWYgdGhlIHJlc3VsdCBpcyBhIHByb21pc2UsIGl0IGlzIHJlc29sdmVkCiAgICAgICAgICogICAgICAgIGJlZm9yZSBpdHMgdmFsdWUgaXMgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gQmUgYXdhcmUgdGhhdCBgbmdSb3V0ZS4kcm91dGVQYXJhbXNgIHdpbGwKICAgICAgICAgKiAgICAgICAgc3RpbGwgcmVmZXIgdG8gdGhlIHByZXZpb3VzIHJvdXRlIHdpdGhpbiB0aGVzZSByZXNvbHZlIGZ1bmN0aW9ucy4gIFVzZSBgJHJvdXRlLmN1cnJlbnQucGFyYW1zYAogICAgICAgICAqICAgICAgICB0byBhY2Nlc3MgdGhlIG5ldyByb3V0ZSBwYXJhbWV0ZXJzLCBpbnN0ZWFkLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgcmVkaXJlY3RUb2Ag4oCTIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0g4oCTIHZhbHVlIHRvIHVwZGF0ZQogICAgICAgICAqICAgICAge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb259IHBhdGggd2l0aCBhbmQgdHJpZ2dlciByb3V0ZSByZWRpcmVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgYHJlZGlyZWN0VG9gIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0LjxzdHJpbmc+fWAgLSByb3V0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgIGAkbG9jYXRpb24ucGF0aCgpYCBieSBhcHBseWluZyB0aGUgY3VycmVudCByb3V0ZSB0ZW1wbGF0ZVVybC4KICAgICAgICAgKiAgICAgIC0gYHtzdHJpbmd9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5wYXRoKClgCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0fWAgLSBjdXJyZW50IGAkbG9jYXRpb24uc2VhcmNoKClgCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIFRoZSBjdXN0b20gYHJlZGlyZWN0VG9gIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHN0cmluZyB3aGljaCB3aWxsIGJlIHVzZWQKICAgICAgICAgKiAgICAgIHRvIHVwZGF0ZSBgJGxvY2F0aW9uLnBhdGgoKWAgYW5kIGAkbG9jYXRpb24uc2VhcmNoKClgLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgW3JlbG9hZE9uU2VhcmNoPXRydWVdYCAtIHtib29sZWFuPX0gLSByZWxvYWQgcm91dGUgd2hlbiBvbmx5ICRsb2NhdGlvbi5zZWFyY2goKQogICAgICAgICAqICAgIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIElmIHRoZSBvcHRpb24gaXMgc2V0IHRvIGBmYWxzZWAgYW5kIHVybCBpbiB0aGUgYnJvd3NlciBjaGFuZ2VzLCB0aGVuCiAgICAgICAgICogICAgICBgJHJvdXRlVXBkYXRlYCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGUgcm9vdCBzY29wZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHNlbGYKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBuZXcgcm91dGUgZGVmaW5pdGlvbiB0byB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLndoZW4gPSBmdW5jdGlvbihwYXRoLCByb3V0ZSkgewogICAgICAgICAgICByb3V0ZXNbcGF0aF0gPSBleHRlbmQoe3JlbG9hZE9uU2VhcmNoOiB0cnVlfSwgcm91dGUpOwoKICAgICAgICAgICAgLy8gY3JlYXRlIHJlZGlyZWN0aW9uIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICAgICAgICAgIGlmIChwYXRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVkaXJlY3RQYXRoID0gKHBhdGhbcGF0aC5sZW5ndGgtMV0gPT0gJy8nKQogICAgICAgICAgICAgICAgICAgID8gcGF0aC5zdWJzdHIoMCwgcGF0aC5sZW5ndGgtMSkKICAgICAgICAgICAgICAgICAgICA6IHBhdGggKycvJzsKCiAgICAgICAgICAgICAgICByb3V0ZXNbcmVkaXJlY3RQYXRoXSA9IHtyZWRpcmVjdFRvOiBwYXRofTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI290aGVyd2lzZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm91dGVQcm92aWRlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyByb3V0ZSBkZWZpbml0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHJvdXRlIGNoYW5nZSB3aGVuIG5vIG90aGVyIHJvdXRlIGRlZmluaXRpb24KICAgICAgICAgKiBpcyBtYXRjaGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAuCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqLwogICAgICAgIHRoaXMub3RoZXJ3aXNlID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMud2hlbihudWxsLCBwYXJhbXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRsb2NhdGlvbicsICckcm91dGVQYXJhbXMnLCAnJHEnLCAnJGluamVjdG9yJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywKICAgICAgICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGxvY2F0aW9uLCAgICRyb3V0ZVBhcmFtcywgICAkcSwgICAkaW5qZWN0b3IsICAgJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjdXJyZW50IFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogVGhlIHJvdXRlIGRlZmluaXRpb24gY29udGFpbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtIGBjb250cm9sbGVyYDogVGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgYXMgZGVmaW5lIGluIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gYGxvY2Fsc2A6IEEgbWFwIG9mIGxvY2FscyB3aGljaCBpcyB1c2VkIGJ5IHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlcn0gc2VydmljZSBmb3IKICAgICAgICAgICAgICAgICAqICAgICBjb250cm9sbGVyIGluc3RhbnRpYXRpb24uIFRoZSBgbG9jYWxzYCBjb250YWluCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgYHJlc29sdmVgIG1hcC4gQWRkaXRpb25hbGx5IHRoZSBgbG9jYWxzYCBhbHNvIGNvbnRhaW46CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgIC0gYCRzY29wZWAgLSBUaGUgY3VycmVudCByb3V0ZSBzY29wZS4KICAgICAgICAgICAgICAgICAqICAgICAtIGAkdGVtcGxhdGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSByb3V0ZXMgQXJyYXkgb2YgYWxsIGNvbmZpZ3VyZWQgcm91dGVzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogSXMgdXNlZCBmb3IgZGVlcC1saW5raW5nIFVSTHMgdG8gY29udHJvbGxlcnMgYW5kIHZpZXdzIChIVE1MIHBhcnRpYWxzKS4KICAgICAgICAgICAgICAgICAqIEl0IHdhdGNoZXMgYCRsb2NhdGlvbi51cmwoKWAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgcGF0aCB0byBhbiBleGlzdGluZyByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFlvdSBjYW4gZGVmaW5lIHJvdXRlcyB0aHJvdWdoIHtAbGluayBuZy4kcm91dGVQcm92aWRlciAkcm91dGVQcm92aWRlcn0ncyBBUEkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgaXMgdHlwaWNhbGx5IHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmUgYW5kIHRoZSB7QGxpbmsgbmcuJHJvdXRlUGFyYW1zICRyb3V0ZVBhcmFtc30gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgY2hhbmdpbmcgdGhlIFVSTCBoYXNoIGNhdXNlcyB0aGUgYCRyb3V0ZWAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZQogICAgICAgICAgICAgICAgIFVSTCwgYW5kIHRoZSBgbmdWaWV3YCBwdWxscyBpbiB0aGUgcGFydGlhbC4KCiAgICAgICAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZXhhbXBsZSBpcyB1c2luZyB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBpbmxpbmVkIHRlbXBsYXRlc30KICAgICAgICAgICAgICAgICB0byBnZXQgaXQgd29ya2luZyBvbiBqc2ZpZGRsZSBhcyB3ZWxsLgoKICAgICAgICAgICAgICAgICA8ZXhhbXBsZSBtb2R1bGU9Im5nVmlldyI+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICAgICAgICAgQ2hvb3NlOgogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieS9jaC8xIj5Nb2J5OiBDaDE8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL0dhdHNieSI+R2F0c2J5PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9TY2FybGV0Ij5TY2FybGV0IExldHRlcjwvYT48YnIvPgoKICAgICAgICAgICAgICAgICA8ZGl2IG5nLXZpZXc+PC9kaXY+CiAgICAgICAgICAgICAgICAgPGhyIC8+CgogICAgICAgICAgICAgICAgIDxwcmU+JGxvY2F0aW9uLnBhdGgoKSA9IHt7JGxvY2F0aW9uLnBhdGgoKX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybCA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmx9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQucGFyYW1zID0ge3skcm91dGUuY3VycmVudC5wYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZSA9IHt7JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGVQYXJhbXMgPSB7eyRyb3V0ZVBhcmFtc319PC9wcmU+CiAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJib29rLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImNoYXB0ZXIuaHRtbCI+CiAgICAgICAgICAgICAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICAgICAgICAgICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgICAgICAgICAgICAgIENoYXB0ZXIgSWQ6IHt7cGFyYW1zLmNoYXB0ZXJJZH19CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnLCBbXSwgZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEJvb2tDbnRsLAogICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAvLyBJIHdpbGwgY2F1c2UgYSAxIHNlY29uZCBkZWxheQogICAgICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oJHEsICR0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgdmFyIGRlbGF5ID0gJHEuZGVmZXIoKTsKICAgICAgICAgICAgICAgICAkdGltZW91dChkZWxheS5yZXNvbHZlLCAxMDAwKTsKICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkucHJvbWlzZTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0pOwogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQvY2gvOmNoYXB0ZXJJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICAgfSk7CgogICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE1haW5DbnRsKCRzY29wZSwgJHJvdXRlLCAkcm91dGVQYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlUGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgIHZhciBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQ2hhcHRlciBJZFw6IDEvKTsKCiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgICBzbGVlcCgyKTsgLy8gcHJvbWlzZXMgYXJlIG5vdCBwYXJ0IG9mIHNjZW5hcmlvIHdhaXRpbmcKICAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQm9va0NudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlU3RhcnQKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSByb3V0ZSBjaGFuZ2UuIEF0IHRoaXMgIHBvaW50IHRoZSByb3V0ZSBzZXJ2aWNlcyBzdGFydHMKICAgICAgICAgICAgICAgICAqIHJlc29sdmluZyBhbGwgb2YgdGhlIGRlcGVuZGVuY2llcyBuZWVkZWQgZm9yIHRoZSByb3V0ZSBjaGFuZ2UgdG8gb2NjdXJzLgogICAgICAgICAgICAgICAgICogVHlwaWNhbGx5IHRoaXMgaW52b2x2ZXMgZmV0Y2hpbmcgdGhlIHZpZXcgdGVtcGxhdGUgYXMgd2VsbCBhcyBhbnkgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICAgKiBkZWZpbmVkIGluIGByZXNvbHZlYCByb3V0ZSBwcm9wZXJ0eS4gT25jZSAgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgKiBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgaXMgZmlyZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gbmV4dCBGdXR1cmUgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSBjdXJyZW50IEN1cnJlbnQgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIHJvdXRlIGRlcGVuZGVuY2llcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IGxpc3RlbnMgZm9yIHRoZSBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAqIHRvIGluc3RhbnRpYXRlIHRoZSBjb250cm9sbGVyIGFuZCByZW5kZXIgdGhlIHZpZXcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZXxVbmRlZmluZWR9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLCBvciB1bmRlZmluZWQgaWYgY3VycmVudCBpcyBmaXJzdCByb3V0ZSBlbnRlcmVkLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VFcnJvcgogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIGlmIGFueSBvZiB0aGUgcmVzb2x2ZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcHJldmlvdXMgUHJldmlvdXMgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSByZWplY3Rpb24gUmVqZWN0aW9uIG9mIHRoZSBwcm9taXNlLiBVc3VhbGx5IHRoZSBlcnJvciBvZiB0aGUgZmFpbGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZVVwZGF0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgYHJlbG9hZE9uU2VhcmNoYCBwcm9wZXJ0eSBoYXMgYmVlbiBzZXQgdG8gZmFsc2UsIGFuZCB3ZSBhcmUgcmV1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogaW5zdGFuY2Ugb2YgdGhlIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgZm9yY2VSZWxvYWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAkcm91dGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlczogcm91dGVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlI3JlbG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBDYXVzZXMgYCRyb3V0ZWAgc2VydmljZSB0byByZWxvYWQgdGhlIGN1cnJlbnQgcm91dGUgZXZlbiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gaGFzbid0IGNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEFzIGEgcmVzdWx0IG9mIHRoYXQsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30KICAgICAgICAgICAgICAgICAgICAgICAgICogY3JlYXRlcyBuZXcgc2NvcGUsIHJlaW5zdGFudGlhdGVzIHRoZSBjb250cm9sbGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlUmVsb2FkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyh1cGRhdGVSb3V0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgdXBkYXRlUm91dGUpOwoKICAgICAgICAgICAgICAgIHJldHVybiAkcm91dGU7CgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBwYXJhbSBvbiB7c3RyaW5nfSBjdXJyZW50IHVybAogICAgICAgICAgICAgICAgICogQHBhcmFtIHdoZW4ge3N0cmluZ30gcm91dGUgd2hlbiB0ZW1wbGF0ZSB0byBtYXRjaCB0aGUgdXJsIGFnYWluc3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm4gez9PYmplY3R9CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHN3aXRjaFJvdXRlTWF0Y2hlcihvbiwgd2hlbikgewogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IHRoaXMgY29kZSBpcyBjb252b2x1dGVkIGFuZCBpbmVmZmljaWVudCwgd2Ugc2hvdWxkIGNvbnN0cnVjdCB0aGUgcm91dGUgbWF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAvLyAgIHJlZ2V4IG9ubHkgb25jZSBhbmQgdGhlbiByZXVzZSBpdAoKICAgICAgICAgICAgICAgICAgICAvLyBFc2NhcGUgcmVnZXhwIHNwZWNpYWwgY2hhcmFjdGVycy4KICAgICAgICAgICAgICAgICAgICB3aGVuID0gJ14nICsgd2hlbi5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgIlxcJCYiKSArICckJzsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVnZXggPSAnJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGRzdCA9IHt9OwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmUgPSAvOihcdyspL2csCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtTWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RNYXRjaGVkSW5kZXggPSAwOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKHBhcmFtTWF0Y2ggPSByZS5leGVjKHdoZW4pKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIGVhY2ggOnBhcmFtIGluIGB3aGVuYCBhbmQgcmVwbGFjZSBpdCB3aXRoIGEgY2FwdHVyaW5nIGdyb3VwLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgYWxsIG90aGVyIHNlY3Rpb25zIG9mIHdoZW4gdW5jaGFuZ2VkLgogICAgICAgICAgICAgICAgICAgICAgICByZWdleCArPSB3aGVuLnNsaWNlKGxhc3RNYXRjaGVkSW5kZXgsIHBhcmFtTWF0Y2guaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWdleCArPSAnKFteXFwvXSopJzsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnB1c2gocGFyYW1NYXRjaFsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RNYXRjaGVkSW5kZXggPSByZS5sYXN0SW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB0cmFpbGluZyBwYXRoIHBhcnQuCiAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gd2hlbi5zdWJzdHIobGFzdE1hdGNoZWRJbmRleCk7CgogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IG9uLm1hdGNoKG5ldyBSZWdFeHAocmVnZXgpKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChwYXJhbXMsIGZ1bmN0aW9uKG5hbWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3RbbmFtZV0gPSBtYXRjaFtpbmRleCArIDFdOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gZHN0IDogbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVSb3V0ZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHBhcnNlUm91dGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9ICRyb3V0ZS5jdXJyZW50OwoKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBsYXN0ICYmIG5leHQuJCRyb3V0ZSA9PT0gbGFzdC4kJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICYmIGVxdWFscyhuZXh0LnBhdGhQYXJhbXMsIGxhc3QucGF0aFBhcmFtcykgJiYgIW5leHQucmVsb2FkT25TZWFyY2ggJiYgIWZvcmNlUmVsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QucGFyYW1zID0gbmV4dC5wYXJhbXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvcHkobGFzdC5wYXJhbXMsICRyb3V0ZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlVXBkYXRlJywgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0IHx8IGxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VSZWxvYWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdGFydCcsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm91dGUuY3VycmVudCA9IG5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dC5yZWRpcmVjdFRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5leHQucmVkaXJlY3RUbykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoaW50ZXJwb2xhdGUobmV4dC5yZWRpcmVjdFRvLCBuZXh0LnBhcmFtcykpLnNlYXJjaChuZXh0LnBhcmFtcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnVybChuZXh0LnJlZGlyZWN0VG8obmV4dC5wYXRoUGFyYW1zLCAkbG9jYXRpb24ucGF0aCgpLCAkbG9jYXRpb24uc2VhcmNoKCkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRxLndoZW4obmV4dCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXh0LnJlc29sdmUgfHwge30sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goaXNTdHJpbmcodmFsdWUpID8gJGluamVjdG9yLmdldCh2YWx1ZSkgOiAkaW5qZWN0b3IuaW52b2tlKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlID0gbmV4dC50ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQodGVtcGxhdGUgPSBuZXh0LnRlbXBsYXRlVXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSAkaHR0cC5nZXQodGVtcGxhdGUsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7IHJldHVybiByZXNwb25zZS5kYXRhOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKCckdGVtcGxhdGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHEuYWxsKHZhbHVlcykudGhlbihmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNba2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZ0ZXIgcm91dGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICRyb3V0ZS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0LmxvY2FscyA9IGxvY2FsczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHkobmV4dC5wYXJhbXMsICRyb3V0ZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdWNjZXNzJywgbmV4dCwgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZUVycm9yJywgbmV4dCwgbGFzdCwgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0aGUgY3VycmVudCBhY3RpdmUgcm91dGUsIGJ5IG1hdGNoaW5nIGl0IGFnYWluc3QgdGhlIFVSTAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBwYXJzZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIC8vIE1hdGNoIGEgcm91dGUKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW1zLCBtYXRjaDsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJvdXRlcywgZnVuY3Rpb24ocm91dGUsIHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCAmJiAocGFyYW1zID0gc3dpdGNoUm91dGVNYXRjaGVyKCRsb2NhdGlvbi5wYXRoKCksIHBhdGgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBleHRlbmQoe30sICRsb2NhdGlvbi5zZWFyY2goKSwgcGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUGFyYW1zOiBwYXJhbXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLiQkcm91dGUgPSByb3V0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIE5vIHJvdXRlIG1hdGNoZWQ7IGZhbGxiYWNrIHRvICJvdGhlcndpc2UiIHJvdXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoIHx8IHJvdXRlc1tudWxsXSAmJiBpbmhlcml0KHJvdXRlc1tudWxsXSwge3BhcmFtczoge30sIHBhdGhQYXJhbXM6e319KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIGludGVycG9sYXRpb24gb2YgdGhlIHJlZGlyZWN0IHBhdGggd2l0aCB0aGUgcGFyYW1ldHJzCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludGVycG9sYXRlKHN0cmluZywgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2goKHN0cmluZ3x8JycpLnNwbGl0KCc6JyksIGZ1bmN0aW9uKHNlZ21lbnQsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goc2VnbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VnbWVudE1hdGNoID0gc2VnbWVudC5tYXRjaCgvKFx3KykoLiopLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gc2VnbWVudE1hdGNoWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGFyYW1zW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goc2VnbWVudE1hdGNoWzJdIHx8ICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHJvdXRlUGFyYW1zCiAgICAgKiBAcmVxdWlyZXMgJHJvdXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDdXJyZW50IHNldCBvZiByb3V0ZSBwYXJhbWV0ZXJzLiBUaGUgcm91dGUgcGFyYW1ldGVycyBhcmUgYSBjb21iaW5hdGlvbiBvZiB0aGUKICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9ufSBgc2VhcmNoKClgLCBhbmQgYHBhdGgoKWAuIFRoZSBgcGF0aGAgcGFyYW1ldGVycwogICAgICogYXJlIGV4dHJhY3RlZCB3aGVuIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gcGF0aCBpcyBtYXRjaGVkLgogICAgICoKICAgICAqIEluIGNhc2Ugb2YgcGFyYW1ldGVyIG5hbWUgY29sbGlzaW9uLCBgcGF0aGAgcGFyYW1zIHRha2UgcHJlY2VkZW5jZSBvdmVyIGBzZWFyY2hgIHBhcmFtcy4KICAgICAqCiAgICAgKiBUaGUgc2VydmljZSBndWFyYW50ZWVzIHRoYXQgdGhlIGlkZW50aXR5IG9mIHRoZSBgJHJvdXRlUGFyYW1zYCBvYmplY3Qgd2lsbCByZW1haW4gdW5jaGFuZ2VkCiAgICAgKiAoYnV0IGl0cyBwcm9wZXJ0aWVzIHdpbGwgbGlrZWx5IGNoYW5nZSkgZXZlbiB3aGVuIGEgcm91dGUgY2hhbmdlIG9jY3Vycy4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgdGhlIGAkcm91dGVQYXJhbXNgIGFyZSBvbmx5IHVwZGF0ZWQgKmFmdGVyKiBhIHJvdXRlIGNoYW5nZSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LgogICAgICogVGhpcyBtZWFucyB0aGF0IHlvdSBjYW5ub3QgcmVseSBvbiBgJHJvdXRlUGFyYW1zYCBiZWluZyBjb3JyZWN0IGluIHJvdXRlIHJlc29sdmUgZnVuY3Rpb25zLgogICAgICogSW5zdGVhZCB5b3UgY2FuIHVzZSBgJHJvdXRlLmN1cnJlbnQucGFyYW1zYCB0byBhY2Nlc3MgdGhlIG5ldyByb3V0ZSdzIHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAgLy8gR2l2ZW46CiAgICAgKiAgLy8gVVJMOiBodHRwOi8vc2VydmVyLmNvbS9pbmRleC5odG1sIy9DaGFwdGVyLzEvU2VjdGlvbi8yP3NlYXJjaD1tb2J5CiAgICAgKiAgLy8gUm91dGU6IC9DaGFwdGVyLzpjaGFwdGVySWQvU2VjdGlvbi86c2VjdGlvbklkCiAgICAgKiAgLy8KICAgICAqICAvLyBUaGVuCiAgICAgKiAgJHJvdXRlUGFyYW1zID09PiB7Y2hhcHRlcklkOjEsIHNlY3Rpb25JZDoyLCBzZWFyY2g6J21vYnknfQogICAgICogPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVBhcmFtc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4oe30pOwogICAgfQoKICAgIC8qKgogICAgICogREVTSUdOIE5PVEVTCiAgICAgKgogICAgICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogICAgICoKICAgICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICAgKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAgICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogICAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAgICoKICAgICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgICAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAoc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgICAqCiAgICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICAgKgogICAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICAgKiBhcmUgZXhwZW5zaXZlIHRvIGNvbnN0cnVjdC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICAgKiBhc3N1bWluZyB0aGF0IHRoZSBtb2RlbCBpcyB1bnN0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBjaGlsZCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGFuZCBwcm92aWRlCiAgICAgKiBldmVudCBwcm9jZXNzaW5nIGxpZmUtY3ljbGUuIFNlZSB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpewogICAgICAgIHZhciBUVEwgPSAxMDsKCiAgICAgICAgdGhpcy5kaWdlc3RUdGwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFRUTDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLAogICAgICAgICAgICBmdW5jdGlvbiggJGluamVjdG9yLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRwYXJzZSkgewoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICAgICAgICAgICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIuaW5qZWN0b3IoWyduZyddKS5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSkgewogICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGUuJG5ldygpOwogICAgICAgICAgIHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnV29ybGQnOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwodW5kZWZpbmVkKTsKCiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBzY29wZS5ncmVldGluZyA9IHNjb3BlLnNhbHV0YXRpb24gKyAnICcgKyBzY29wZS5uYW1lICsgJyEnOwogICAgICAgICAgIH0pOyAvLyBpbml0aWFsaXplIHRoZSB3YXRjaAoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ01pc2tvJzsKICAgICAgICAgICAvLyBzdGlsbCBvbGQgdmFsdWUsIHNpbmNlIHdhdGNoZXMgaGF2ZSBub3QgYmVlbiBjYWxsZWQgeWV0CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsgLy8gZmlyZSBhbGwgIHRoZSB3YXRjaGVzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKCdIZWxsbyBNaXNrbyEnKTsKICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgSW5oZXJpdGFuY2UKICAgICAgICAgICAgICAgICAqIEEgc2NvcGUgY2FuIGluaGVyaXQgZnJvbSBhIHBhcmVudCBzY29wZSwgYXMgaW4gdGhpcyBleGFtcGxlOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gJHJvb3RTY29wZTsKICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuJG5ldygpOwoKICAgICAgICAgICAgICAgICBwYXJlbnQuc2FsdXRhdGlvbiA9ICJIZWxsbyI7CiAgICAgICAgICAgICAgICAgY2hpbGQubmFtZSA9ICJXb3JsZCI7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CgogICAgICAgICAgICAgICAgIGNoaWxkLnNhbHV0YXRpb24gPSAiV2VsY29tZSI7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ1dlbGNvbWUnKTsKICAgICAgICAgICAgICAgICBleHBlY3QocGFyZW50LnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBwcm92aWRlcnMgTWFwIG9mIHNlcnZpY2UgZmFjdG9yeSB3aGljaCBuZWVkIHRvIGJlIHByb3ZpZGVkCiAgICAgICAgICAgICAgICAgKiAgICAgZm9yIHRoZSBjdXJyZW50IHNjb3BlLiBEZWZhdWx0cyB0byB7QGxpbmsgbmd9LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgKj49fSBpbnN0YW5jZUNhY2hlIFByb3ZpZGVzIHByZS1pbnN0YW50aWF0ZWQgc2VydmljZXMgd2hpY2ggc2hvdWxkCiAgICAgICAgICAgICAgICAgKiAgICAgYXBwZW5kL292ZXJyaWRlIHNlcnZpY2VzIHByb3ZpZGVkIGJ5IGBwcm92aWRlcnNgLiBUaGlzIGlzIGhhbmR5IHdoZW4gdW5pdC10ZXN0aW5nIGFuZCBoYXZpbmcKICAgICAgICAgICAgICAgICAqICAgICB0aGUgbmVlZCB0byBvdmVycmlkZSBhIGRlZmF1bHQgc2VydmljZS4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE5ld2x5IGNyZWF0ZWQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTY29wZSgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkcGhhc2UgPSB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkd2F0Y2hlcnMgPQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXNbJ3RoaXMnXSA9IHRoaXMuJHJvb3QgPSAgdGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgICAgICAgICAqLwoKCiAgICAgICAgICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24oaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgQ2hpbGQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGlzb2xhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiByZW1vdmUgYXQgc29tZSBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0FQSS1DSEFOR0U6IFVzZSAkY29udHJvbGxlciB0byBpbnN0YW50aWF0ZSBjb250cm9sbGVycy4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkID0gZnVuY3Rpb24oKSB7fTsgLy8gc2hvdWxkIGJlIGFub255bW91czsgVGhpcyBpcyBzbyB0aGF0IHdoZW4gdGhlIG1pbmlmaWVyIG11bmdlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIG5hbWUgaXQgZG9lcyBub3QgYmVjb21lIHJhbmRvbSBzZXQgb2YgY2hhcnMuIFRoZXNlIHdpbGwgdGhlbiBzaG93IHVwIGFzIGNsYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuYW1lIGluIHRoZSBkZWJ1Z2dlci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IG5ldyBDaGlsZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkWyd0aGlzJ10gPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJHBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkYXN5bmNRdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJHdhdGNoZXJzID0gY2hpbGQuJCRuZXh0U2libGluZyA9IGNoaWxkLiQkY2hpbGRIZWFkID0gY2hpbGQuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkVGFpbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRjaGlsZEhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2gKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUmVnaXN0ZXJzIGEgYGxpc3RlbmVyYCBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuZXZlciB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIC0gVGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGNhbGxlZCBvbiBldmVyeSBjYWxsIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiAgIHNob3VsZCByZXR1cm4gdGhlIHZhbHVlIHdoaWNoIHdpbGwgYmUgd2F0Y2hlZC4gKFNpbmNlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfQogICAgICAgICAgICAgICAgICAgICAqICAgcmVydW5zIHdoZW4gaXQgZGV0ZWN0cyBjaGFuZ2VzIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIKICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIGJlIGlkZW1wb3RlbnQuKQogICAgICAgICAgICAgICAgICAgICAqIC0gVGhlIGBsaXN0ZW5lcmAgaXMgY2FsbGVkIG9ubHkgd2hlbiB0aGUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCBgd2F0Y2hFeHByZXNzaW9uYCBhbmQgdGhlCiAgICAgICAgICAgICAgICAgICAgICogICBwcmV2aW91cyBjYWxsIHRvIGB3YXRjaEV4cHJlc3Npb25gIGFyZSBub3QgZXF1YWwgKHdpdGggdGhlIGV4Y2VwdGlvbiBvZiB0aGUgaW5pdGlhbCBydW4sCiAgICAgICAgICAgICAgICAgICAgICogICBzZWUgYmVsb3cpLiBUaGUgaW5lcXVhbGl0eSBpcyBkZXRlcm1pbmVkIGFjY29yZGluZyB0bwogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBmdW5jdGlvbi4gVG8gc2F2ZSB0aGUgdmFsdWUgb2YgdGhlIG9iamVjdCBmb3IgbGF0ZXIgY29tcGFyaXNvbiwgdGhlCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgYW5ndWxhci5jb3B5fSBmdW5jdGlvbiBpcyB1c2VkLiBJdCBhbHNvIG1lYW5zIHRoYXQgd2F0Y2hpbmcgY29tcGxleCBvcHRpb25zIHdpbGwKICAgICAgICAgICAgICAgICAgICAgKiAgIGhhdmUgYWR2ZXJzZSBtZW1vcnkgYW5kIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucy4KICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSB3YXRjaCBgbGlzdGVuZXJgIG1heSBjaGFuZ2UgdGhlIG1vZGVsLCB3aGljaCBtYXkgdHJpZ2dlciBvdGhlciBgbGlzdGVuZXJgcyB0byBmaXJlLiBUaGlzCiAgICAgICAgICAgICAgICAgICAgICogICBpcyBhY2hpZXZlZCBieSByZXJ1bm5pbmcgdGhlIHdhdGNoZXJzIHVudGlsIG5vIGNoYW5nZXMgYXJlIGRldGVjdGVkLiBUaGUgcmVydW4gaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICogICBsaW1pdCBpcyAxMCB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AgZGVhZGxvY2suCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gaXMgY2FsbGVkLAogICAgICAgICAgICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoIG5vIGBsaXN0ZW5lcmAuIChTaW5jZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgICAgICAgICAgICAgICAqIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlIHdoZW4gYSBjaGFuZ2UgaXMKICAgICAgICAgICAgICAgICAgICAgKiBkZXRlY3RlZCwgYmUgcHJlcGFyZWQgZm9yIG11bHRpcGxlIGNhbGxzIHRvIHlvdXIgbGlzdGVuZXIuKQogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXIgYSB3YXRjaGVyIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgc2NvcGUsIHRoZSBgbGlzdGVuZXJgIGZuIGlzIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICAgICAgICAgICAgICAgICAqICh2aWEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYyAkZXZhbEFzeW5jfSkgdG8gaW5pdGlhbGl6ZSB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB3YXRjaGVyLiBJbiByYXJlIGNhc2VzLCB0aGlzIGlzIHVuZGVzaXJhYmxlIGJlY2F1c2UgdGhlIGxpc3RlbmVyIGlzIGNhbGxlZCB3aGVuIHRoZSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgKiBvZiBgd2F0Y2hFeHByZXNzaW9uYCBkaWRuJ3QgY2hhbmdlLiBUbyBkZXRlY3QgdGhpcyBzY2VuYXJpbyB3aXRoaW4gdGhlIGBsaXN0ZW5lcmAgZm4sIHlvdQogICAgICAgICAgICAgICAgICAgICAqIGNhbiBjb21wYXJlIHRoZSBgbmV3VmFsYCBhbmQgYG9sZFZhbGAuIElmIHRoZXNlIHR3byB2YWx1ZXMgYXJlIGlkZW50aWNhbCAoYD09PWApIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgICAgICogbGlzdGVuZXIgd2FzIGNhbGxlZCBkdWUgdG8gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIC8vIGxldCdzIGFzc3VtZSB0aGF0IHNjb3BlIHdhcyBkZXBlbmRlbmN5IGluamVjdGVkIGFzIHRoZSAkcm9vdFNjb3BlCiAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOyB9KTsKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIC8vIG5vIHZhcmlhYmxlIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpfSB3YXRjaEV4cHJlc3Npb24gRXhwcmVzc2lvbiB0aGF0IGlzIGV2YWx1YXRlZCBvbiBlYWNoCiAgICAgICAgICAgICAgICAgICAgICogICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZS4gQSBjaGFuZ2UgaW4gdGhlIHJldHVybiB2YWx1ZSB0cmlnZ2VycyBhCiAgICAgICAgICAgICAgICAgICAgICogICAgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYHNjb3BlYCBhcyBhIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBsaXN0ZW5lciBDYWxsYmFjayBjYWxsZWQgd2hlbmV2ZXIgdGhlIHJldHVybiB2YWx1ZSBvZgogICAgICAgICAgICAgICAgICAgICAqICAgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUsIHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlcyBhcyBwYXJhbWV0ZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gb2JqZWN0RXF1YWxpdHkgQ29tcGFyZSBvYmplY3QgZm9yIGVxdWFsaXR5IHJhdGhlciB0aGFuIGZvciByZWZlcmVuY2UuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7bGlzdGVuRm4oc2NvcGUpO307CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZSB0aGUgbW9kZWwsIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICogZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUgbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93CiAgICAgICAgICAgICAgICAgICAgICogYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFVzdWFsbHkgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAgICAgICAgICAgICAgICogSW5zdGVhZCBhIGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluIGEKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gIHdpdGgge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgICAgICAgICAgICAgICAqIHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFlvdSBtYXkgaGF2ZSBhIG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCBmcm9tIHdpdGhpbiB1bml0LXRlc3RzLCB0byBzaW11bGF0ZSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBsaWZlLWN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3YXRjaCwgdmFsdWUsIGxhc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzeW5jUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSwgdHRsID0gVFRMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwgY3VycmVudCwgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHgsIGxvZ01zZzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luUGhhc2UoJyRkaWdlc3QnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzeW5jUXVldWUgPSBjdXJyZW50LiQkYXN5bmNRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC4kZXZhbChhc3luY1F1ZXVlLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2F0Y2ggJiYgKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkaXJ0eSAmJiAhKHR0bC0tKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihUVEwgKyAnICRkaWdlc3QoKSBpdGVyYXRpb25zIHJlYWNoZWQuIEFib3J0aW5nIVxuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdXYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6ICcgKyB0b0pzb24od2F0Y2hMb2cpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHNjb3BlIGJlaW5nIGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQnJvYWRjYXN0ZWQgd2hlbiBhIHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4gYXJlIGJlaW5nIGRlc3Ryb3llZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAgICAgICAgICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgc2NvcGUgKGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuKSBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFJlbW92YWwgaW1wbGllcwogICAgICAgICAgICAgICAgICAgICAqIHRoYXQgY2FsbHMgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHdpbGwgbm8gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgICogcHJvcGFnYXRlIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uIFJlbW92YWwgYWxzbyBpbXBsaWVzIHRoYXQgdGhlIGN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAgKiBzY29wZSBpcyBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGAkZGVzdHJveSgpYCBpcyB1c3VhbGx5IHVzZWQgYnkgZGlyZWN0aXZlcyBzdWNoIGFzCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gZm9yIG1hbmFnaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHVucm9sbGluZyBvZiB0aGUgbG9vcC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEp1c3QgYmVmb3JlIGEgc2NvcGUgaXMgZGVzdHJveWVkIGEgYCRkZXN0cm95YCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGlzIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGNoYW5jZSB0bwogICAgICAgICAgICAgICAgICAgICAqIHBlcmZvcm0gYW55IG5lY2Vzc2FyeSBjbGVhbnVwLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICAgICAgICAgICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCBkZXN0cm95IHRoZSByb290IHNjb3BlIG9yIGEgc2NvcGUgdGhhdCBoYXMgYmVlbiBhbHJlYWR5IGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZSA9PSB0aGlzIHx8IHRoaXMuJCRkZXN0cm95ZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuJHBhcmVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGJyb2FkY2FzdCgnJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRIZWFkID09IHRoaXMpIHBhcmVudC4kJGNoaWxkSGVhZCA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZFRhaWwgPSB0aGlzLiQkcHJldlNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkcHJldlNpYmxpbmcpIHRoaXMuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJG5leHRTaWJsaW5nKSB0aGlzLiQkbmV4dFNpYmxpbmcuJCRwcmV2U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZzsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYm9ndXMgY29kZSB0aGF0IHdvcmtzIGFyb3VuZCBDaHJvbWUncyBHQyBsZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMTMxMyNpc3N1ZWNvbW1lbnQtMTAzNzg0NTEKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kcGFyZW50ID0gdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkSGVhZCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZXhwcmVzc2lvbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUgcmV0dXJuaW5nIHRoZSByZXN1bHQuIEFueSBleGNlcHRpb25zIGluIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGV4cHJlc3Npb24gYXJlIHByb3BhZ2F0ZWQgKHVuY2F1Z2h0KS4gVGhpcyBpcyB1c2VmdWwgd2hlbiBldmFsdWF0aW5nIEFuZ3VsYXIgZXhwcmVzc2lvbnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmEgPSAxOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5iID0gMjsKCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnYStiJykpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRldmFsOiBmdW5jdGlvbihleHByLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwYXJzZShleHByKSh0aGlzLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYwogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUgY3VycmVudCBzY29wZSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRldmFsQXN5bmNgIG1ha2VzIG5vIGd1YXJhbnRlZXMgYXMgdG8gd2hlbiB0aGUgYGV4cHJlc3Npb25gIHdpbGwgYmUgZXhlY3V0ZWQsIG9ubHkgdGhhdDoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgaW4gdGhlIGN1cnJlbnQgc2NyaXB0IGV4ZWN1dGlvbiBjb250ZXh0IChiZWZvcmUgYW55IERPTSByZW5kZXJpbmcpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgICAgICAgICAgICAgICAqICAgICBgZXhwcmVzc2lvbmAgZXhlY3V0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGV2YWxBc3luYzogZnVuY3Rpb24oZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKGV4cHIpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIgZnJhbWV3b3JrLgogICAgICAgICAgICAgICAgICAgICAqIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUtY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKiBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKiAyLiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAqICAgIHdhcyBleGVjdXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luUGhhc2UoJyRhcHBseScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGV2YWwoZXhwcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkb24KICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogTGlzdGVucyBvbiBldmVudHMgb2YgYSBnaXZlbiB0eXBlLiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQgJGVtaXR9IGZvciBkaXNjdXNzaW9uIG9mCiAgICAgICAgICAgICAgICAgICAgICogZXZlbnQgbGlmZSBjeWNsZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3JtYXQgaXM6IGBmdW5jdGlvbihldmVudCwgYXJncy4uLilgLiBUaGUgYGV2ZW50YCBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgKiBwYXNzZWQgaW50byB0aGUgbGlzdGVuZXIgaGFzIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlczoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgdGFyZ2V0U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgc2NvcGUgb24gd2hpY2ggdGhlIGV2ZW50IHdhcyBgJGVtaXRgLWVkIG9yIGAkYnJvYWRjYXN0YC1lZC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYGN1cnJlbnRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBjdXJyZW50IHNjb3BlIHdoaWNoIGlzIGhhbmRsaW5nIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYG5hbWVgIC0gYHtzdHJpbmd9YDogTmFtZSBvZiB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBzdG9wUHJvcGFnYXRpb25gIC0gYHtmdW5jdGlvbj19YDogY2FsbGluZyBgc3RvcFByb3BhZ2F0aW9uYCBmdW5jdGlvbiB3aWxsIGNhbmNlbCBmdXJ0aGVyIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgIHByb3BhZ2F0aW9uIChhdmFpbGFibGUgb25seSBmb3IgZXZlbnRzIHRoYXQgd2VyZSBgJGVtaXRgLWVkKS4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHByZXZlbnREZWZhdWx0YCAtIGB7ZnVuY3Rpb259YDogY2FsbGluZyBgcHJldmVudERlZmF1bHRgIHNldHMgYGRlZmF1bHRQcmV2ZW50ZWRgIGZsYWcgdG8gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYGRlZmF1bHRQcmV2ZW50ZWRgIC0gYHtib29sZWFufWA6IHRydWUgaWYgYHByZXZlbnREZWZhdWx0YCB3YXMgY2FsbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBsaXN0ZW4gb24uCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudCwgYXJncy4uLil9IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRvbjogZnVuY3Rpb24obmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZAogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzIGNhbmNlbHMgaXQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRlbWl0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbXB0eSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7c3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTAsIGxlbmd0aD1uYW1lZExpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgICAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbW1pdGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTAsIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8IChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyICRyb290U2NvcGUgPSBuZXcgU2NvcGUoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJHJvb3RTY29wZS4kJHBoYXNlICsgJyBhbHJlYWR5IGluIHByb2dyZXNzJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICAgICAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7fQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kc25pZmZlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzaGNoYW5nZSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudCA/CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogICAgICovCiAgICBmdW5jdGlvbiAkU25pZmZlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpIHsKICAgICAgICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgICAgICAgICAgYW5kcm9pZCA9IGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpKSwKICAgICAgICAgICAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAoISR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8ICR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNyksCiAgICAgICAgICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJRTkgaW1wbGVtZW50cyAnaW5wdXQnIGV2ZW50IGl0J3Mgc28gZnViYXJlZCB0aGF0IHdlIHJhdGhlciBwcmV0ZW5kIHRoYXQgaXQgZG9lc24ndCBoYXZlCiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIEluIHBhcnRpY3VsYXIgdGhlIGV2ZW50IGlzIG5vdCBmaXJlZCB3aGVuIGJhY2tzcGFjZSBvciBkZWxldGUga2V5IGFyZSBwcmVzc2VkIG9yCiAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBjdXQgb3BlcmF0aW9uIGlzIHBlcmZvcm1lZC4KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQgPT0gJ2lucHV0JyAmJiBtc2llID09IDkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50U3VwcG9ydFtldmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXZFbG0gPSAkd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudFN1cHBvcnRbZXZlbnRdID0gJ29uJyArIGV2ZW50IGluIGRpdkVsbTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IGN1cnJlbnRseSB0aGVyZSBpcyBubyB3YXkgdG8gZmVhdHVyZSBkZXRlY3QgQ1NQIHdpdGhvdXQgdHJpZ2dlcmluZyBhbGVydHMKICAgICAgICAgICAgICAgIGNzcDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogICAgICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogICAgICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAgICAgKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAgICAgKgogICAgICogRXhwcmVzc2lvbnMsIGxpa2UgdGhlIG9uZSBkZWZpbmVkIGZvciB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZSBpbiB0aGUgZXhhbXBsZQogICAgICogYmVsb3csIGFyZSBldmFsdWF0ZWQgd2l0aCByZXNwZWN0IHRvIHRoZSBjdXJyZW50IHNjb3BlLiAgVGhlcmVmb3JlLCB0aGVyZSBpcwogICAgICogbm8gcmlzayBvZiBpbmFkdmVydGVudGx5IGNvZGluZyBpbiBhIGRlcGVuZGVuY3kgb24gYSBnbG9iYWwgdmFsdWUgaW4gc3VjaCBhbgogICAgICogZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkd2luZG93KSB7CiAgICAgICAgICAgJHNjb3BlLiR3aW5kb3cgPSAkd2luZG93OwogICAgICAgICAgICRzY29wZS5ncmVldGluZyA9ICdIZWxsbywgV29ybGQhJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJncmVldGluZyIgLz4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkd2luZG93LmFsZXJ0KGdyZWV0aW5nKSI+QUxFUlQ8L2J1dHRvbj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGRpc3BsYXkgdGhlIGdyZWV0aW5nIGluIHRoZSBpbnB1dCBib3gnLCBmdW5jdGlvbigpIHsKICAgICAgIGlucHV0KCdncmVldGluZycpLmVudGVyKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAvLyBJZiB3ZSBjbGljayB0aGUgYnV0dG9uIGl0IHdpbGwgYmxvY2sgdGhlIHRlc3QgcnVubmVyCiAgICAgICAvLyBlbGVtZW50KCc6YnV0dG9uJykuY2xpY2soKTsKICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gJFdpbmRvd1Byb3ZpZGVyKCl7CiAgICAgICAgdGhpcy4kZ2V0ID0gdmFsdWVGbih3aW5kb3cpOwogICAgfQoKICAgIC8qKgogICAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICAgIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogICAgICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICAgICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAgICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAgICAgKgogICAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICAgKiBAc2VlIHBhcnNlSGVhZGVycwogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAgICAgKgogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICAgKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAoIWhlYWRlcnNPYmopIGhlYWRlcnNPYmogPSAgcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9ufEFycmF5LjxmdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogICAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGRhdGEgPSBmbihkYXRhLCBoZWFkZXJzKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMpIHsKICAgICAgICByZXR1cm4gMjAwIDw9IHN0YXR1cyAmJiBzdGF0dXMgPCAzMDA7CiAgICB9CgoKICAgIGZ1bmN0aW9uICRIdHRwUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIEpTT05fU1RBUlQgPSAvXlxzKihcW3xce1teXHtdKS8sCiAgICAgICAgICAgIEpTT05fRU5EID0gL1tcfVxdXVxzKiQvLAogICAgICAgICAgICBQUk9URUNUSU9OX1BSRUZJWCA9IC9eXClcXVx9Jyw/XG4vOwoKICAgICAgICB2YXIgJGNvbmZpZyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIC8vIHRyYW5zZm9ybSBpbmNvbWluZyByZXNwb25zZSBkYXRhCiAgICAgICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBbZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShQUk9URUNUSU9OX1BSRUZJWCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24oZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBjb21tb246IHsKICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicsCiAgICAgICAgICAgICAgICAgICAgJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J30sCiAgICAgICAgICAgICAgICBwdXQ6ICB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMgPSB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGh0dHBCYWNrZW5kJywgJyRicm93c2VyJywgJyRjYWNoZUZhY3RvcnknLCAnJHJvb3RTY29wZScsICckcScsICckaW5qZWN0b3InLAogICAgICAgICAgICBmdW5jdGlvbigkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyksCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uKGludGVyY2VwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgaXNTdHJpbmcoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaHR0cEJhY2tlbmQKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnkKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHEKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBjb3JlIEFuZ3VsYXIgc2VydmljZSB0aGF0IGZhY2lsaXRhdGVzIGNvbW11bmljYXRpb24gd2l0aCB0aGUgcmVtb3RlCiAgICAgICAgICAgICAgICAgKiBIVFRQIHNlcnZlcnMgdmlhIHRoZSBicm93c2VyJ3Mge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3htbGh0dHByZXF1ZXN0CiAgICAgKiBYTUxIdHRwUmVxdWVzdH0gb2JqZWN0IG9yIHZpYSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIHVuaXQgdGVzdGluZyBhcHBsaWNhdGlvbnMgdGhhdCB1c2UgYCRodHRwYCBzZXJ2aWNlLCBzZWUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kICRodHRwQmFja2VuZCBtb2NrfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgYSBoaWdoZXIgbGV2ZWwgb2YgYWJzdHJhY3Rpb24sIHBsZWFzZSBjaGVjayBvdXQgdGhlIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZQogICAgICogJHJlc291cmNlfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSAkaHR0cCBBUEkgaXMgYmFzZWQgb24gdGhlIHtAbGluayBuZy4kcSBkZWZlcnJlZC9wcm9taXNlIEFQSXN9IGV4cG9zZWQgYnkKICAgICAgICAgICAgICAgICAqIHRoZSAkcSBzZXJ2aWNlLiBXaGlsZSBmb3Igc2ltcGxlIHVzYWdlIHBhdHRlcm5zIHRoaXMgZG9lc24ndCBtYXR0ZXIgbXVjaCwgZm9yIGFkdmFuY2VkIHVzYWdlCiAgICAgICAgICAgICAgICAgKiBpdCBpcyBpbXBvcnRhbnQgdG8gZmFtaWxpYXJpemUgeW91cnNlbGYgd2l0aCB0aGVzZSBBUElzIGFuZCB0aGUgZ3VhcmFudGVlcyB0aGV5IHByb3ZpZGUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgR2VuZXJhbCB1c2FnZQogICAgICAgICAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIGEgc2luZ2xlIGFyZ3VtZW50IOKAlCBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0IOKAlAogICAgICAgICAgICAgICAgICogdGhhdCBpcyB1c2VkIHRvIGdlbmVyYXRlIGFuIEhUVFAgcmVxdWVzdCBhbmQgcmV0dXJucyAgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAgICAgICAgICAgICAqIHdpdGggdHdvICRodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAkaHR0cCh7bWV0aG9kOiAnR0VUJywgdXJsOiAnL3NvbWVVcmwnfSkuCiAgICAgICAgICAgICAgICAgKiAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gdGhpcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICogICAgICAgLy8gd2hlbiB0aGUgcmVzcG9uc2UgaXMgYXZhaWxhYmxlCiAgICAgKiAgICAgfSkuCiAgICAgICAgICAgICAgICAgKiAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIGNhbGxlZCBhc3luY2hyb25vdXNseSBpZiBhbiBlcnJvciBvY2N1cnMKICAgICAqICAgICAgIC8vIG9yIHNlcnZlciByZXR1cm5zIHJlc3BvbnNlIHdpdGggYW4gZXJyb3Igc3RhdHVzLgogICAgICogICAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2luY2UgdGhlIHJldHVybmVkIHZhbHVlIG9mIGNhbGxpbmcgdGhlICRodHRwIGZ1bmN0aW9uIGlzIGEgYHByb21pc2VgLCB5b3UgY2FuIGFsc28gdXNlCiAgICAgICAgICAgICAgICAgKiB0aGUgYHRoZW5gIG1ldGhvZCB0byByZWdpc3RlciBjYWxsYmFja3MsIGFuZCB0aGVzZSBjYWxsYmFja3Mgd2lsbCByZWNlaXZlIGEgc2luZ2xlIGFyZ3VtZW50IOKAkwogICAgICAgICAgICAgICAgICogYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVzcG9uc2UuIFNlZSB0aGUgQVBJIHNpZ25hdHVyZSBhbmQgdHlwZSBpbmZvIGJlbG93IGZvciBtb3JlCiAgICAgICAgICAgICAgICAgKiBkZXRhaWxzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEgcmVzcG9uc2Ugc3RhdHVzIGNvZGUgYmV0d2VlbiAyMDAgYW5kIDI5OSBpcyBjb25zaWRlcmVkIGEgc3VjY2VzcyBzdGF0dXMgYW5kCiAgICAgICAgICAgICAgICAgKiB3aWxsIHJlc3VsdCBpbiB0aGUgc3VjY2VzcyBjYWxsYmFjayBiZWluZyBjYWxsZWQuIE5vdGUgdGhhdCBpZiB0aGUgcmVzcG9uc2UgaXMgYSByZWRpcmVjdCwKICAgICAgICAgICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0IHdpbGwgdHJhbnNwYXJlbnRseSBmb2xsb3cgaXQsIG1lYW5pbmcgdGhhdCB0aGUgZXJyb3IgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgICAgICAgICAgICAgICAqIGNhbGxlZCBmb3Igc3VjaCByZXNwb25zZXMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTaG9ydGN1dCBtZXRob2RzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2luY2UgYWxsIGludm9jYXRpb25zIG9mIHRoZSAkaHR0cCBzZXJ2aWNlIHJlcXVpcmUgcGFzc2luZyBpbiBhbiBIVFRQIG1ldGhvZCBhbmQgVVJMLCBhbmQKICAgICAgICAgICAgICAgICAqIFBPU1QvUFVUIHJlcXVlc3RzIHJlcXVpcmUgcmVxdWVzdCBkYXRhIHRvIGJlIHByb3ZpZGVkIGFzIHdlbGwsIHNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgICAgICAgICAqIHdlcmUgY3JlYXRlZDoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAkaHR0cC5nZXQoJy9zb21lVXJsJykuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICogICAkaHR0cC5wb3N0KCcvc29tZVVybCcsIGRhdGEpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIENvbXBsZXRlIGxpc3Qgb2Ygc2hvcnRjdXQgbWV0aG9kczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNnZXQgJGh0dHAuZ2V0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjaGVhZCAkaHR0cC5oZWFkfQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcG9zdCAkaHR0cC5wb3N0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcHV0ICRodHRwLnB1dH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2RlbGV0ZSAkaHR0cC5kZWxldGV9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNqc29ucCAkaHR0cC5qc29ucH0KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZXR0aW5nIEhUVFAgSGVhZGVycwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSAkaHR0cCBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgY2VydGFpbiBIVFRQIGhlYWRlcnMgdG8gYWxsIHJlcXVlc3RzLiBUaGVzZSBkZWZhdWx0cwogICAgICAgICAgICAgICAgICogY2FuIGJlIGZ1bGx5IGNvbmZpZ3VyZWQgYnkgYWNjZXNzaW5nIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzYCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgKiBvYmplY3QsIHdoaWNoIGN1cnJlbnRseSBjb250YWlucyB0aGlzIGRlZmF1bHQgY29uZmlndXJhdGlvbjoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uYCAoaGVhZGVycyB0aGF0IGFyZSBjb21tb24gZm9yIGFsbCByZXF1ZXN0cyk6CiAgICAgICAgICAgICAgICAgKiAgIC0gYEFjY2VwdDogYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKiAvICpgCiAgICAgICAgICAgICAgICAgKiAgIC0gYFgtUmVxdWVzdGVkLVdpdGg6IFhNTEh0dHBSZXF1ZXN0YAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnBvc3RgOiAoaGVhZGVyIGRlZmF1bHRzIGZvciBQT1NUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucHV0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBQVVQgcmVxdWVzdHMpCiAgICAgICAgICAgICAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbHkgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhlc2UgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICogb2JqZWN0cy4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCBvciBQVVQsIHNpbXBseSBhZGQgYSBuZXcgb2JqZWN0CiAgICAgICAgICAgICAgICAgKiB3aXRoIHRoZSBsb3dlcmNhc2VkIEhUVFAgbWV0aG9kIG5hbWUgYXMgdGhlIGtleSwgZS5nLgogICAgICAgICAgICAgICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5nZXRbJ015LUhlYWRlciddPSd2YWx1ZSdgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEFkZGl0aW9uYWxseSwgdGhlIGRlZmF1bHRzIGNhbiBiZSBzZXQgYXQgcnVudGltZSB2aWEgdGhlIGAkaHR0cC5kZWZhdWx0c2Agb2JqZWN0IGluIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgKiBmYXNoaW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQm90aCByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzIGNhbiBiZSB0cmFuc2Zvcm1lZCB1c2luZyB0cmFuc2Zvcm0gZnVuY3Rpb25zLiBCeSBkZWZhdWx0LCBBbmd1bGFyCiAgICAgICAgICAgICAgICAgKiBhcHBsaWVzIHRoZXNlIHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBSZXF1ZXN0IHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIElmIHRoZSBgZGF0YWAgcHJvcGVydHkgb2YgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBvYmplY3QgY29udGFpbnMgYW4gb2JqZWN0LCBzZXJpYWxpemUgaXQgaW50bwogICAgICAgICAgICAgICAgICogICBKU09OIGZvcm1hdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBSZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIC0gSWYgWFNSRiBwcmVmaXggaXMgZGV0ZWN0ZWQsIHN0cmlwIGl0IChzZWUgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMgc2VjdGlvbiBiZWxvdykuCiAgICAgICAgICAgICAgICAgKiAgLSBJZiBKU09OIHJlc3BvbnNlIGlzIGRldGVjdGVkLCBkZXNlcmlhbGl6ZSBpdCB1c2luZyBhIEpTT04gcGFyc2VyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGdsb2JhbGx5IGF1Z21lbnQgb3Igb3ZlcnJpZGUgdGhlIGRlZmF1bHQgdHJhbnNmb3JtcywgbW9kaWZ5IHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0YCBhbmQKICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzLiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBieSBkZWZhdWx0IGFuCiAgICAgICAgICAgICAgICAgKiBhcnJheSBvZiB0cmFuc2Zvcm0gZnVuY3Rpb25zLCB3aGljaCBhbGxvd3MgeW91IHRvIGBwdXNoYCBvciBgdW5zaGlmdGAgYSBuZXcgdHJhbnNmb3JtYXRpb24gZnVuY3Rpb24gaW50byB0aGUKICAgICAgICAgICAgICAgICAqIHRyYW5zZm9ybWF0aW9uIGNoYWluLiBZb3UgY2FuIGFsc28gZGVjaWRlIHRvIGNvbXBsZXRlbHkgb3ZlcnJpZGUgYW55IGRlZmF1bHQgdHJhbnNmb3JtYXRpb25zIGJ5IGFzc2lnbmluZyB5b3VyCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbnMgdG8gdGhlc2UgcHJvcGVydGllcyBkaXJlY3RseSB3aXRob3V0IHRoZSBhcnJheSB3cmFwcGVyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbWlsYXJseSwgdG8gbG9jYWxseSBvdmVycmlkZSB0aGUgcmVxdWVzdC9yZXNwb25zZSB0cmFuc2Zvcm1zLCBhdWdtZW50IHRoZSBgdHJhbnNmb3JtUmVxdWVzdGAgYW5kL29yCiAgICAgICAgICAgICAgICAgKiBgdHJhbnNmb3JtUmVzcG9uc2VgIHByb3BlcnRpZXMgb2YgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHBhc3NlZCBpbnRvIGAkaHR0cGAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgQ2FjaGluZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGVuYWJsZSBjYWNoaW5nLCBzZXQgdGhlIGNvbmZpZ3VyYXRpb24gcHJvcGVydHkgYGNhY2hlYCB0byBgdHJ1ZWAuIFdoZW4gdGhlIGNhY2hlIGlzCiAgICAgICAgICAgICAgICAgKiBlbmFibGVkLCBgJGh0dHBgIHN0b3JlcyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGluIGxvY2FsIGNhY2hlLiBOZXh0IHRpbWUgdGhlCiAgICAgICAgICAgICAgICAgKiByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSB0aGUgY2FjaGUgd2l0aG91dCBzZW5kaW5nIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCBldmVuIGlmIHRoZSByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSBjYWNoZSwgZGVsaXZlcnkgb2YgdGhlIGRhdGEgaXMgYXN5bmNocm9ub3VzIGluCiAgICAgICAgICAgICAgICAgKiB0aGUgc2FtZSB3YXkgdGhhdCByZWFsIHJlcXVlc3RzIGFyZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgR0VUIHJlcXVlc3RzIGZvciB0aGUgc2FtZSBVUkwgdGhhdCBzaG91bGQgYmUgY2FjaGVkIHVzaW5nIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgKiBjYWNoZSwgYnV0IHRoZSBjYWNoZSBpcyBub3QgcG9wdWxhdGVkIHlldCwgb25seSBvbmUgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdpbGwgYmUgbWFkZSBhbmQKICAgICAgICAgICAgICAgICAqIHRoZSByZW1haW5pbmcgcmVxdWVzdHMgd2lsbCBiZSBmdWxmaWxsZWQgdXNpbmcgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGZpcnN0IHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgUmVzcG9uc2UgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAgICAgICAgICogYXN5bmNocm9ub3VzIHByZXByb2Nlc3Npbmcgb2YgcmVjZWl2ZWQgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUgYWJsZSB0byBpbnRlcmNlcHQKICAgICAgICAgICAgICAgICAqIHJlc3BvbnNlcyBmb3IgaHR0cCByZXF1ZXN0cyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICAgICAgICAgICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAqIHByb21pc2UgYXBpc30gdG8gZnVsZmlsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZXByb2Nlc3NpbmcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSAkaHR0cFByb3ZpZGVyIGJ5CiAgICAgICAgICAgICAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgICAgICAgICAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IgIOKAlCBhIGZ1bmN0aW9uIHRoYXQKICAgICAgICAgICAgICAgICAqIHRha2VzIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IGFuZCByZXR1cm5zIHRoZSBvcmlnaW5hbCBvciBhIG5ldyBwcm9taXNlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciBhcyBhIHNlcnZpY2UKICAgICAgICAgICAgICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlc3BvbnNlKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVzcG9uc2UpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBXaGVuIGRlc2lnbmluZyB3ZWIgYXBwbGljYXRpb25zLCBjb25zaWRlciBzZWN1cml0eSB0aHJlYXRzIGZyb206CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgKiAgIEpTT04gdnVsbmVyYWJpbGl0eX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCb3RoIHNlcnZlciBhbmQgdGhlIGNsaWVudCBtdXN0IGNvb3BlcmF0ZSBpbiBvcmRlciB0byBlbGltaW5hdGUgdGhlc2UgdGhyZWF0cy4gQW5ndWxhciBjb21lcwogICAgICAgICAgICAgICAgICogcHJlLWNvbmZpZ3VyZWQgd2l0aCBzdHJhdGVnaWVzIHRoYXQgYWRkcmVzcyB0aGVzZSBpc3N1ZXMsIGJ1dCBmb3IgdGhpcyB0byB3b3JrIGJhY2tlbmQgc2VydmVyCiAgICAgICAgICAgICAgICAgKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBKU09OIFZ1bG5lcmFiaWxpdHkgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEge0BsaW5rIGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweAogICAgICogSlNPTiB2dWxuZXJhYmlsaXR5fSBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9IHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogICAgICAgICAgICAgICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiApXX0nLAogICAgICAgICAgICAgICAgICogWydvbmUnLCd0d28nXQogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5IFhTUkZ9IGlzIGEgdGVjaG5pcXVlIGJ5IHdoaWNoCiAgICAgICAgICAgICAgICAgKiBhbiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgYSBtZWNoYW5pc20KICAgICAgICAgICAgICAgICAqIHRvIGNvdW50ZXIgWFNSRi4gV2hlbiBwZXJmb3JtaW5nIFhIUiByZXF1ZXN0cywgdGhlICRodHRwIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgYFhTUkYtVE9LRU5gIGFuZCBzZXRzIGl0IGFzIHRoZSBIVFRQIGhlYWRlciBgWC1YU1JGLVRPS0VOYC4gU2luY2Ugb25seSBKYXZhU2NyaXB0IHRoYXQKICAgICAgICAgICAgICAgICAqIHJ1bnMgb24geW91ciBkb21haW4gY291bGQgcmVhZCB0aGUgY29va2llLCB5b3VyIHNlcnZlciBjYW4gYmUgYXNzdXJlZCB0aGF0IHRoZSBYSFIgY2FtZSBmcm9tCiAgICAgICAgICAgICAgICAgKiBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gdGFrZSBhZHZhbnRhZ2Ugb2YgdGhpcywgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gc2V0IGEgdG9rZW4gaW4gYSBKYXZhU2NyaXB0IHJlYWRhYmxlIHNlc3Npb24KICAgICAgICAgICAgICAgICAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIHRoZSBmaXJzdCBIVFRQIEdFVCByZXF1ZXN0LiBPbiBzdWJzZXF1ZW50IFhIUiByZXF1ZXN0cyB0aGUKICAgICAgICAgICAgICAgICAqIHNlcnZlciBjYW4gdmVyaWZ5IHRoYXQgdGhlIGNvb2tpZSBtYXRjaGVzIGBYLVhTUkYtVE9LRU5gIEhUVFAgaGVhZGVyLCBhbmQgdGhlcmVmb3JlIGJlIHN1cmUKICAgICAgICAgICAgICAgICAqIHRoYXQgb25seSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4gY291bGQgaGF2ZSBzZW50IHRoZSByZXF1ZXN0LiBUaGUgdG9rZW4gbXVzdCBiZQogICAgICAgICAgICAgICAgICogdW5pcXVlIGZvciBlYWNoIHVzZXIgYW5kIG11c3QgYmUgdmVyaWZpYWJsZSBieSB0aGUgc2VydmVyICh0byBwcmV2ZW50IHRoZSBKYXZhU2NyaXB0IGZyb20gbWFraW5nCiAgICAgICAgICAgICAgICAgKiB1cCBpdHMgb3duIHRva2VucykuIFdlIHJlY29tbWVuZCB0aGF0IHRoZSB0b2tlbiBpcyBhIGRpZ2VzdCBvZiB5b3VyIHNpdGUncyBhdXRoZW50aWNhdGlvbgogICAgICAgICAgICAgICAgICogY29va2llIHdpdGggYSB7QGxpbmsgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FsdF8oY3J5cHRvZ3JhcGh5KSBzYWx0fSBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIHJlcXVlc3QgdG8gYmUgbWFkZSBhbmQgaG93IGl0IHNob3VsZCBiZQogICAgICAgICAgICAgICAgICogICAgcHJvY2Vzc2VkLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAtICoqbWV0aG9kKiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgbWV0aG9kIChlLmcuICdHRVQnLCAnUE9TVCcsIGV0YykKICAgICAgICAgICAgICAgICAqICAgIC0gKip1cmwqKiDigJMgYHtzdHJpbmd9YCDigJMgQWJzb2x1dGUgb3IgcmVsYXRpdmUgVVJMIG9mIHRoZSByZXNvdXJjZSB0aGF0IGlzIGJlaW5nIHJlcXVlc3RlZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipwYXJhbXMqKiDigJMgYHtPYmplY3QuPHN0cmluZ3xPYmplY3Q+fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIG9iamVjdHMgd2hpY2ggd2lsbCBiZSB0dXJuZWQgdG8KICAgICAgICAgICAgICAgICAqICAgICAgYD9rZXkxPXZhbHVlMSZrZXkyPXZhbHVlMmAgYWZ0ZXIgdGhlIHVybC4gSWYgdGhlIHZhbHVlIGlzIG5vdCBhIHN0cmluZywgaXQgd2lsbCBiZSBKU09OaWZpZWQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgRGF0YSB0byBiZSBzZW50IGFzIHRoZSByZXF1ZXN0IG1lc3NhZ2UgZGF0YS4KICAgICAgICAgICAgICAgICAqICAgIC0gKipoZWFkZXJzKiog4oCTIGB7T2JqZWN0fWAg4oCTIE1hcCBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyBIVFRQIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlcXVlc3QqKiDigJMgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgICAgICAgICAgICAgKiAgICAgIHRyYW5zZm9ybSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdWNoIGZ1bmN0aW9ucy4gVGhlIHRyYW5zZm9ybSBmdW5jdGlvbiB0YWtlcyB0aGUgaHR0cAogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0IGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKmNhY2hlKiog4oCTIGB7Ym9vbGVhbnxDYWNoZX1gIOKAkyBJZiB0cnVlLCBhIGRlZmF1bHQgJGh0dHAgY2FjaGUgd2lsbCBiZSB1c2VkIHRvIGNhY2hlIHRoZQogICAgICAgICAgICAgICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICAgICAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgICAgICAgICAgICAgKiAgICAgIGNhY2hpbmcuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcn1gIOKAkyB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip3aXRoQ3JlZGVudGlhbHMqKiAtIGB7Ym9vbGVhbn1gIC0gd2hldGhlciB0byB0byBzZXQgdGhlIGB3aXRoQ3JlZGVudGlhbHNgIGZsYWcgb24gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vaHR0cF9hY2Nlc3NfY29udHJvbCNzZWN0aW9uXzUKICAgICAqICAgICAgcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgICAgICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAgICAgICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAgICAgICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybSBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibWV0aG9kIj4KICAgICAgICAgICAgICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnR0VUJywgJ2h0dHAtaGVsbG8uaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPlNhbXBsZSBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OUCcsICdodHRwOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPkludmFsaWQgSlNPTlA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBGZXRjaEN0cmwoJHNjb3BlLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKICAgICAgICAgICAgJHNjb3BlLm1ldGhvZCA9ICdHRVQnOwogICAgICAgICAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgICAgICAgICAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkc2NvcGUuY29kZSA9IG51bGw7CiAgICAgICAgICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICAgICAgICAgJGh0dHAoe21ldGhvZDogJHNjb3BlLm1ldGhvZCwgdXJsOiAkc2NvcGUudXJsLCBjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YSB8fCAiUmVxdWVzdCBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZU1vZGVsID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKICAgICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgICAgICRzY29wZS51cmwgPSB1cmw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9Imh0dHAtaGVsbG8uaHRtbCI+CiAgICAgICAgICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgR0VUIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvSGVsbG8sIFwkaHR0cCEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiU2FtcGxlIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvU3VwZXIgSGVybyEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0JlKCdSZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gJGh0dHAoY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcVRyYW5zZm9ybUZuID0gY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICByZXNwVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxSGVhZGVycyA9IGV4dGVuZCh7fSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gZXh0ZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeydYLVhTUkYtVE9LRU4nOiAkYnJvd3Nlci5jb29raWVzKClbJ1hTUkYtVE9LRU4nXX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29uZmlnLmhlYWRlcnMuY29tbW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbmZpZy5oZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0KICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxRGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVyTmFtZSwgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSwgaGVhZGVyTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gdXNpbmcgZm9yLWluIGluc3RlYWQgb2YgZm9yRWFjaCB0byBhdm9pZCB1bmVjZXNzYXJ5IGl0ZXJhdGlvbiBhZnRlciBoZWFkZXIgaGFzIGJlZW4gZm91bmQKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGRlZkhlYWRlck5hbWUgaW4gZGVmSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSA9IGxvd2VyY2FzZShkZWZIZWFkZXJOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihoZWFkZXJOYW1lIGluIGNvbmZpZy5oZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXJOYW1lKSA9PT0gbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXFIZWFkZXJzW2RlZkhlYWRlck5hbWVdID0gZGVmSGVhZGVyc1tkZWZIZWFkZXJOYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb3dlcmNhc2UoaGVhZGVyKSA9PT0gJ2NvbnRlbnQtdHlwZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcmVxSGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihyZXFIZWFkZXJzKSwgcmVxVHJhbnNmb3JtRm4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpOwoKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGZ1dHVyZSByZXNwb25zZQogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9ycywgZnVuY3Rpb24oaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGludGVyY2VwdG9yKHByb21pc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3AgPSBleHRlbmQoe30sIHJlc3BvbnNlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0cmFuc2Zvcm1EYXRhKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLmhlYWRlcnMsIHJlc3BUcmFuc2Zvcm1GbikKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHJlc3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJHEucmVqZWN0KHJlc3ApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMgPSBbXTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2dldAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgR0VUYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlbGV0ZQogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgREVMRVRFYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2hlYWQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEhFQURgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjanNvbnAKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEpTT05QYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICBTaG91bGQgY29udGFpbiBgSlNPTl9DQUxMQkFDS2Agc3RyaW5nLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHMoJ2dldCcsICdkZWxldGUnLCAnaGVhZCcsICdqc29ucCcpOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcG9zdAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUE9TVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNwdXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBVVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YSgncG9zdCcsICdwdXQnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjZGVmYXVsdHMKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBSdW50aW1lIGVxdWl2YWxlbnQgb2YgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzYCBwcm9wZXJ0eS4gQWxsb3dzIGNvbmZpZ3VyYXRpb24gb2YKICAgICAgICAgICAgICAgICAqIGRlZmF1bHQgaGVhZGVycyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTZWUgIlNldHRpbmcgSFRUUCBIZWFkZXJzIiBhbmQgIlRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzIiBzZWN0aW9ucyBhYm92ZS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMgPSAkY29uZmlnOwoKCiAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHA7CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kcyhuYW1lcykgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkaHR0cFtuYW1lXSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogTWFrZXMgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogISEhIEFDQ0VTU0VTIENMT1NVUkUgVkFSUzoKICAgICAgICAgICAgICAgICAqICRodHRwQmFja2VuZCwgJGNvbmZpZywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuY2FjaGUgJiYgY29uZmlnLm1ldGhvZCA9PSAnR0VUJykgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSA9IGlzT2JqZWN0KGNvbmZpZy5jYWNoZSkgPyBjb25maWcuY2FjaGUgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZFJlc3AudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkUmVzcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VydmluZyBmcm9tIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgY29weShjYWNoZWRSZXNwWzJdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHV0IHRoZSBwcm9taXNlIGZvciB0aGUgbm9uLXRyYW5zZm9ybWVkIHJlc3BvbnNlIGludG8gY2FjaGUgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIHdvbid0IGhhdmUgdGhlIHJlc3BvbnNlIGluIGNhY2hlLCBzZW5kIHRoZSByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZChjb25maWcubWV0aG9kLCB1cmwsIHJlcURhdGEsIGRvbmUsIHJlcUhlYWRlcnMsIGNvbmZpZy50aW1lb3V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIENhbGxiYWNrIHJlZ2lzdGVyZWQgdG8gJGh0dHBCYWNrZW5kKCk6CiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FjaGVzIHRoZSByZXNwb25zZSBpZiBkZXNpcmVkCiAgICAgICAgICAgICAgICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FsbHMgJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3VjY2VzcyhzdGF0dXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgcHJvbWlzZSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlLnJlbW92ZSh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gaW5kZXhPZigkaHR0cC5wZW5kaW5nUmVxdWVzdHMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuNi4wIik7IH0gY2F0Y2ggKGUxKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuMy4wIik7IH0gY2F0Y2ggKGUyKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAiKTsgfSBjYXRjaCAoZTMpIHt9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBYTUxIdHRwUmVxdWVzdC4iKTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGh0dHBCYWNrZW5kCiAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVFRQIGJhY2tlbmQgdXNlZCBieSB0aGUge0BsaW5rIG5nLiRodHRwIHNlcnZpY2V9IHRoYXQgZGVsZWdhdGVzIHRvCiAgICAgKiBYTUxIdHRwUmVxdWVzdCBvYmplY3Qgb3IgSlNPTlAgYW5kIGRlYWxzIHdpdGggYnJvd3NlciBpbmNvbXBhdGliaWxpdGllcy4KICAgICAqCiAgICAgKiBZb3Ugc2hvdWxkIG5ldmVyIG5lZWQgdG8gdXNlIHRoaXMgc2VydmljZSBkaXJlY3RseSwgaW5zdGVhZCB1c2UgdGhlIGhpZ2hlci1sZXZlbCBhYnN0cmFjdGlvbnM6CiAgICAgKiB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IG9yIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZSAkcmVzb3VyY2V9LgogICAgICoKICAgICAqIER1cmluZyB0ZXN0aW5nIHRoaXMgaW1wbGVtZW50YXRpb24gaXMgc3dhcHBlZCB3aXRoIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kIG1vY2sKICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRicm93c2VyLCAkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLAogICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLCAkd2luZG93LmxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoJzonLCAnJykpOwogICAgICAgIH1dOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQsIGxvY2F0aW9uUHJvdG9jb2wpIHsKICAgICAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgICAgICByZXR1cm4gZnVuY3Rpb24obWV0aG9kLCB1cmwsIHBvc3QsIGNhbGxiYWNrLCBoZWFkZXJzLCB0aW1lb3V0LCB3aXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICAgICAgJGJyb3dzZXIuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCgpOwogICAgICAgICAgICB1cmwgPSB1cmwgfHwgJGJyb3dzZXIudXJsKCk7CgogICAgICAgICAgICBpZiAobG93ZXJjYXNlKG1ldGhvZCkgPT0gJ2pzb25wJykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrSWQgPSAnXycgKyAoY2FsbGJhY2tzLmNvdW50ZXIrKykudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgMjAwLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2NhbGxiYWNrSWRdOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYSFIoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzOwoKICAgICAgICAgICAgICAgIC8vIEluIElFNiBhbmQgNywgdGhpcyBtaWdodCBiZSBjYWxsZWQgc3luY2hyb25vdXNseSB3aGVuIHhoci5zZW5kIGJlbG93IGlzIGNhbGxlZCBhbmQgdGhlCiAgICAgICAgICAgICAgICAvLyByZXNwb25zZSBpcyBpbiB0aGUgY2FjaGUuIHRoZSBwcm9taXNlIGFwaSB3aWxsIGVuc3VyZSB0aGF0IHRvIHRoZSBhcHAgY29kZSB0aGUgYXBpIGlzCiAgICAgICAgICAgICAgICAvLyBhbHdheXMgYXN5bmMKICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSBvbmNlIEZpcmVmb3ggMjEgZ2V0cyByZWxlYXNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVnaW46IHdvcmthcm91bmQgdG8gb3ZlcmNvbWUgRmlyZWZveCBDT1JTIGh0dHAgcmVzcG9uc2UgaGVhZGVycyBidWcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjA4NzM1CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggYWxyZWFkeSBwYXRjaGVkIGluIG5pZ2h0bHkuIFNob3VsZCBsYW5kIGluIEZpcmVmb3ggMjEuCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDT1JTICJzaW1wbGUgcmVzcG9uc2UgaGVhZGVycyIgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2ltcGxlSGVhZGVycyA9IFsiQ2FjaGUtQ29udHJvbCIsICJDb250ZW50LUxhbmd1YWdlIiwgIkNvbnRlbnQtVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGlyZXMiLCAiTGFzdC1Nb2RpZmllZCIsICJQcmFnbWEiXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzaW1wbGVIZWFkZXJzLCBmdW5jdGlvbiAoaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKGhlYWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyArPSBoZWFkZXIgKyAiOiAiICsgdmFsdWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuZCBvZiB0aGUgd29ya2Fyb3VuZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzIHx8IHhoci5zdGF0dXMsIHhoci5yZXNwb25zZVRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKHdpdGhDcmVkZW50aWFscykgewogICAgICAgICAgICAgICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHhoci5zZW5kKHBvc3QgfHwgJycpOwoKICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyRGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZykgewogICAgICAgICAgICAgICAgLy8gVVJMX01BVENIIGlzIGRlZmluZWQgaW4gc3JjL3NlcnZpY2UvbG9jYXRpb24uanMKICAgICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9ICh1cmwubWF0Y2goVVJMX01BVENIKSB8fCBbJycsIGxvY2F0aW9uUHJvdG9jb2xdKVsxXTsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3RG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSBkb25lKCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsKICAgICAgICAgICAgc2NyaXB0LnNyYyA9IHVybDsKCiAgICAgICAgICAgIGlmIChtc2llKSB7CiAgICAgICAgICAgICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSBkb25lV3JhcHBlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25lcnJvciA9IGRvbmVXcmFwcGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICByYXdEb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvY2FsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogJGxvY2FsZSBzZXJ2aWNlIHByb3ZpZGVzIGxvY2FsaXphdGlvbiBydWxlcyBmb3IgdmFyaW91cyBBbmd1bGFyIGNvbXBvbmVudHMuIEFzIG9mIHJpZ2h0IG5vdyB0aGUKICAgICAqIG9ubHkgcHVibGljIGFwaSBpczoKICAgICAqCiAgICAgKiAqIGBpZGAg4oCTIGB7c3RyaW5nfWAg4oCTIGxvY2FsZSBpZCBmb3JtYXR0ZWQgYXMgYGxhbmd1YWdlSWQtY291bnRyeUlkYCAoZS5nLiBgZW4tdXNgKQogICAgICovCiAgICBmdW5jdGlvbiAkTG9jYWxlUHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgICAgICAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICAgICAgICAgICAgICBHUk9VUF9TRVA6ICcsJywKICAgICAgICAgICAgICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgICAgICAgICAgICAgICB7IC8vIERlY2ltYWwgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEZyYWM6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NQcmU6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1ByZTogJy0nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICAgICAgICAgICAgICAgIH0seyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJyknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgREFURVRJTUVfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIE1PTlRIOiAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlRNT05USDogICdKYW4sRmViLE1hcixBcHIsTWF5LEp1bixKdWwsQXVnLFNlcCxPY3QsTm92LERlYycuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBEQVk6ICdTdW5kYXksTW9uZGF5LFR1ZXNkYXksV2VkbmVzZGF5LFRodXJzZGF5LEZyaWRheSxTYXR1cmRheScuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVERBWTogJ1N1bixNb24sVHVlLFdlZCxUaHUsRnJpLFNhdCcuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBBTVBNUzogWydBTScsJ1BNJ10sCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtOiAnTU1NIGQsIHkgaDptbTpzcyBhJywKICAgICAgICAgICAgICAgICAgICBzaG9ydDogJ00vZC95eSBoOm1tIGEnLAogICAgICAgICAgICAgICAgICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBsb25nRGF0ZTogJ01NTU0gZCwgeScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtRGF0ZTogJ01NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgICAgICAgICAgICAgICAgIG1lZGl1bVRpbWU6ICdoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0VGltZTogJ2g6bW0gYScKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbihudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHEsICAgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZHMgPSB7fTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiR0aW1lb3V0CiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldFRpbWVvdXRgLiBUaGUgYGZuYCBmdW5jdGlvbiBpcyB3cmFwcGVkIGludG8gYSB0cnkvY2F0Y2gKICAgICAgICAgICAgICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAgICAgICAgICAgICogdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCBhbmQgdGhlIHRpbWVvdXQgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIHtAbGluayBuZ01vY2suJHRpbWVvdXQgYCR0aW1lb3V0LmZsdXNoKClgfSB0bwogICAgICAgICAgICAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvc2UgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWxheWVkLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gW2ludm9rZUFwcGx5PXRydWVdIElmIHNldCB0byBgZmFsc2VgIHNraXBzIG1vZGVsIGRpcnR5IGNoZWNraW5nLCBvdGhlcndpc2UKICAgICAgICAgICAgICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgICAgICAgICAgICAqICAgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggaXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgYGZuYCBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gdGltZW91dChmbiwgZGVsYXksIGludm9rZUFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRJZCwgY2xlYW51cDsKCiAgICAgICAgICAgICAgICAgICAgdGltZW91dElkID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZuKCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdGltZW91dElkID0gdGltZW91dElkOwogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkc1t0aW1lb3V0SWRdID0gZGVmZXJyZWQ7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHRpbWVvdXQjY2FuY2VsCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHRpbWVvdXQKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICAgICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgICAgKiAgIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXhlIHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gcmVnaXN0ZXI7CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH1dOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICAgICAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmZpbHRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICAgKiAgIGBhcnJheWAuCiAgICAgKgogICAgICogICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgLSBgc3RyaW5nYDogUHJlZGljYXRlIHRoYXQgcmVzdWx0cyBpbiBhIHN1YnN0cmluZyBtYXRjaCB1c2luZyB0aGUgdmFsdWUgb2YgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgc3RyaW5nLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICAgICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogICAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgICAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogICAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAgICogICAgIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UgZWxlbWVudHMgdGhhdAogICAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDxocj4KICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2giPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCdtJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSk7CgogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0pvaG4nLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBleHByZXNzaW9uKSB7CiAgICAgICAgICAgIGlmICghaXNBcnJheShhcnJheSkpIHJldHVybiBhcnJheTsKICAgICAgICAgICAgdmFyIHByZWRpY2F0ZXMgPSBbXTsKICAgICAgICAgICAgcHJlZGljYXRlcy5jaGVjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24ob2JqLCB0ZXh0KXsKICAgICAgICAgICAgICAgIGlmICh0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoJycgKyBvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXJyYXkiOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHskOmV4cHJlc3Npb259OwogICAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwcmVzc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaCh2YWx1ZSwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGVzLmNoZWNrKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6Y3VycmVuY3kKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRm9ybWF0cyBhIG51bWJlciBhcyBhIGN1cnJlbmN5IChpZSAkMSwyMzQuNTYpLiBXaGVuIG5vIGN1cnJlbmN5IHN5bWJvbCBpcyBwcm92aWRlZCwgZGVmYXVsdAogICAgICogc3ltYm9sIGZvciBjdXJyZW50IGxvY2FsZSBpcyB1c2VkLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgSW5wdXQgdG8gZmlsdGVyLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBzeW1ib2wgQ3VycmVuY3kgc3ltYm9sIG9yIGlkZW50aWZpZXIgdG8gYmUgZGlzcGxheWVkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuZy1tb2RlbD0iYW1vdW50Ij4gPGJyPgogICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKToge3thbW91bnQgfCBjdXJyZW5jeX19PGJyPgogICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdCB3aXRoIDEyMzQuNTYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJ1VTRCQxLDIzNC41NicpOwogICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2Ftb3VudCcpLmVudGVyKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnKCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCcoVVNEJDEsMjM0LjAwKScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYW1vdW50LCBjdXJyZW5jeVN5bWJvbCl7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIGN1cnJlbmN5U3ltYm9sID0gZm9ybWF0cy5DVVJSRU5DWV9TWU07CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROdW1iZXIoYW1vdW50LCBmb3JtYXRzLlBBVFRFUk5TWzFdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwgMikuCiAgICAgICAgICAgICAgICByZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bnVtYmVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICAgICAqCiAgICAgKiBJZiB0aGUgaW5wdXQgaXMgbm90IGEgbnVtYmVyIGFuIGVtcHR5IHN0cmluZyBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IG51bWJlciBOdW1iZXIgdG8gZm9ybWF0LgogICAgICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyk9fSBmcmFjdGlvblNpemUgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBudW1iZXIgdG8uCiAgICAgKiBJZiB0aGlzIGlzIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBmcmFjdGlvbiBzaXplIGlzIGNvbXB1dGVkIGZyb20gdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbnVtYmVyCiAgICAgKiBmb3JtYXR0aW5nIHBhdHRlcm4uIEluIHRoZSBjYXNlIG9mIHRoZSBkZWZhdWx0IGxvY2FsZSwgaXQgd2lsbCBiZSAzLgogICAgICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudmFsID0gMTIzNC41Njc4OTsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmctbW9kZWw9J3ZhbCc+PGJyPgogICAgIERlZmF1bHQgZm9ybWF0dGluZzoge3t2YWwgfCBudW1iZXJ9fTxicj4KICAgICBObyBmcmFjdGlvbnM6IHt7dmFsIHwgbnVtYmVyOjB9fTxicj4KICAgICBOZWdhdGl2ZSBudW1iZXI6IHt7LXZhbCB8IG51bWJlcjo0fX0KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXInKSkudG9CZSgnMSwyMzQuNTY4Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS50b0JlKCcxLDIzNScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMywzNzQnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKCiAgICBudW1iZXJGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gbnVtYmVyRmlsdGVyKCRsb2NhbGUpIHsKICAgICAgICB2YXIgZm9ybWF0cyA9ICRsb2NhbGUuTlVNQkVSX0ZPUk1BVFM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG51bWJlciwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROdW1iZXIobnVtYmVyLCBmb3JtYXRzLlBBVFRFUk5TWzBdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoKHdob2xlLmxlbmd0aCAtIGkpJWxncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICAgICAgICAgIHdoaWxlKGZyYWN0aW9uLmxlbmd0aCA8IGZyYWN0aW9uU2l6ZSkgewogICAgICAgICAgICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAoZnJhY3Rpb25TaXplID4gMCAmJiBudW1iZXIgPiAtMSAmJiBudW1iZXIgPCAxKSB7CiAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgPSBudW1iZXIudG9GaXhlZChmcmFjdGlvblNpemUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgICAgIHZhciBuZWcgPSAnJzsKICAgICAgICBpZiAobnVtIDwgMCkgewogICAgICAgICAgICBuZWcgPSAgJy0nOwogICAgICAgICAgICBudW0gPSAtbnVtOwogICAgICAgIH0KICAgICAgICBudW0gPSAnJyArIG51bTsKICAgICAgICB3aGlsZShudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgICAgICAgaWYgKHRyaW0pCiAgICAgICAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICAgICAgcmV0dXJuIG5lZyArIG51bTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICAgICAgICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMiApIHZhbHVlID0gMTI7CiAgICAgICAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0cykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgICAgICAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHRpbWVab25lR2V0dGVyKGRhdGUpIHsKICAgICAgICB2YXIgem9uZSA9IC0xICogZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgIHZhciBwYWRkZWRab25lID0gKHpvbmUgPj0gMCkgPyAiKyIgOiAiIjsKCiAgICAgICAgcGFkZGVkWm9uZSArPSBwYWROdW1iZXIoTWF0aFt6b25lID4gMCA/ICdmbG9vcicgOiAnY2VpbCddKHpvbmUgLyA2MCksIDIpICsKICAgICAgICAgICAgcGFkTnVtYmVyKE1hdGguYWJzKHpvbmUgJSA2MCksIDIpOwoKICAgICAgICByZXR1cm4gcGFkZGVkWm9uZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhbXBtR2V0dGVyKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgICByZXR1cm4gZGF0ZS5nZXRIb3VycygpIDwgMTIgPyBmb3JtYXRzLkFNUE1TWzBdIDogZm9ybWF0cy5BTVBNU1sxXTsKICAgIH0KCiAgICB2YXIgREFURV9GT1JNQVRTID0gewogICAgICAgIHl5eXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgNCksCiAgICAgICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICAgICAgICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICAgICAgIE1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnLCB0cnVlKSwKICAgICAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgICAgIGRkOiBkYXRlR2V0dGVyKCdEYXRlJywgMiksCiAgICAgICAgZDogZGF0ZUdldHRlcignRGF0ZScsIDEpLAogICAgICAgIEhIOiBkYXRlR2V0dGVyKCdIb3VycycsIDIpLAogICAgICAgIEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMSksCiAgICAgICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICAgICAgbW06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAyKSwKICAgICAgICBtOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMSksCiAgICAgICAgc3M6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAyKSwKICAgICAgICBzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMSksCiAgICAgICAgRUVFRTogZGF0ZVN0ckdldHRlcignRGF5JyksCiAgICAgICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICAgICBhOiBhbXBtR2V0dGVyLAogICAgICAgIFo6IHRpbWVab25lR2V0dGVyCiAgICB9OwoKICAgIHZhciBEQVRFX0ZPUk1BVFNfU1BMSVQgPSAvKCg/OlteeU1kSGhtc2FaRSddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8WikpKC4qKS8sCiAgICAgICAgTlVNQkVSX1NUUklORyA9IC9eXGQrJC87CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAgICAgKgogICAgICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAgICAgKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogICAgICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICAgICAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICAgICAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogICAgICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICAgICAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICAgICAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICAgICAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogICAgICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogICAgICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICAgICAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogICAgICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICAgICAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gYW0vcG0sIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogICAgICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogICAgICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICAgICAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICAgICAqICAgKiBgJ2EnYDogYW0vcG0gbWFya2VyCiAgICAgKiAgICogYCdaJ2A6IDQgZGlnaXQgKCtzaWduKSByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXpvbmUgb2Zmc2V0ICgtMTIwMC0rMTIwMCkKICAgICAqCiAgICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYWxzbyBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZyBwcmVkZWZpbmVkCiAgICAgKiAgIHtAbGluayBndWlkZS9pMThuIGxvY2FsaXphYmxlIGZvcm1hdHN9OgogICAgICoKICAgICAqICAgKiBgJ21lZGl1bSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NIGQsIHkgaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZQogICAgICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogICAgICogICAqIGAnc2hvcnQnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSBoOm1tIGEnYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiA5LzMvMTAgMTI6MDUgcG0pCiAgICAgKiAgICogYCdmdWxsRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnRUVFRSwgTU1NTSBkLHknYCBmb3IgZW5fVVMgIGxvY2FsZQogICAgICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAgICAgKiAgICogYCdsb25nRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTApCiAgICAgKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogICAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgcG0pCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAgICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IHNpbmdsZSBxdW90ZSwgdXNlIHR3byBzaW5nbGUgcXVvdGVzIGluIGEgc2VxdWVuY2UKICAgICAqICAgKGUuZy4gYCJoICdvJydjbG9jayciYCkuCiAgICAgKgogICAgICogQHBhcmFtIHsoRGF0ZXxudW1iZXJ8c3RyaW5nKX0gZGF0ZSBEYXRlIHRvIGZvcm1hdCBlaXRoZXIgYXMgRGF0ZSBvYmplY3QsIG1pbGxpc2Vjb25kcyAoc3RyaW5nIG9yCiAgICAgKiAgICBudW1iZXIpIG9yIHZhcmlvdXMgSVNPIDg2MDEgZGF0ZXRpbWUgc3RyaW5nIGZvcm1hdHMgKGUuZy4geXl5eS1NTS1kZFRISDptbTpzcy5TU1NaIGFuZCBpdHMKICAgICAqICAgIHNob3J0ZXIgdmVyc2lvbnMgbGlrZSB5eXl5LU1NLWRkVEhIOm1tWiwgeXl5eS1NTS1kZCBvciB5eXl5TU1kZFRISG1tc3NaKS4gSWYgbm8gdGltZXpvbmUgaXMKICAgICAqICAgIHNwZWNpZmllZCBpbiB0aGUgc3RyaW5nIGlucHV0LCB0aGUgdGltZSBpcyBjb25zaWRlcmVkIHRvIGJlIGluIHRoZSBsb2NhbCB0aW1lem9uZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAgICAgKiAgICBgbWVkaXVtRGF0ZWAgaXMgdXNlZC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBzdHJpbmcgb3IgdGhlIGlucHV0IGlmIGlucHV0IGlzIG5vdCByZWNvZ25pemVkIGFzIGRhdGUvbWlsbGlzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+OgogICAgIHt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTxicj4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnI+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAge3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08YnI+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goL09jdCAyXGQsIDIwMTAgXGR7MSwyfTpcZHsyfTpcZHsyfSAoQU18UE0pLyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJyIpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCInMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnIikpLgogICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KEFNfFBNKS8pOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gZGF0ZUZpbHRlcigkbG9jYWxlKSB7CgoKICAgICAgICB2YXIgUl9JU084NjAxX1NUUiA9IC9eKFxkezR9KS0/KFxkXGQpLT8oXGRcZCkoPzpUKFxkXGQpKD86Oj8oXGRcZCkoPzo6PyhcZFxkKSg/OlwuKFxkKykpPyk/KT8oWnwoWystXSkoXGRcZCk6PyhcZFxkKSk/KT8kLzsKICAgICAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZyl7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdHpNaW4gID0gMDsKICAgICAgICAgICAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcihpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0hvdXJzKGludChtYXRjaFs0XXx8MCkgLSB0ekhvdXIsIGludChtYXRjaFs1XXx8MCkgLSB0ek1pbiwgaW50KG1hdGNoWzZdfHwwKSwgaW50KG1hdGNoWzddfHwwKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KCgogICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICAgICAgICAgICAgdmFyIHRleHQgPSAnJywKICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICBmbiwgbWF0Y2g7CgogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJ21lZGl1bURhdGUnOwogICAgICAgICAgICBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICAgICAgICAgICAgaWYgKE5VTUJFUl9TVFJJTkcudGVzdChkYXRlKSkgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBpbnQoZGF0ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBqc29uU3RyaW5nVG9EYXRlKGRhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFpc0RhdGUoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgICAgICAgICAgICB0ZXh0ICs9IGZuID8gZm4oZGF0ZSwgJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTKQogICAgICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpqc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogICAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGU6CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24ganNvbkZpbHRlcigpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICovCiAgICB2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjp1cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICovCiAgICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bGltaXRUbwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBhcyBzcGVjaWZpZWQgYnkgdGhlCiAgICAgKiB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkuIElmIHRoZSBgbGltaXRgIG51bWJlciBpcwogICAgICogICAgIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUKICAgICAqICAgICBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN1Yi1hcnJheSBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5IGhhZCBsZXNzIHRoYW4gYGxpbWl0YAogICAgICogICAgIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxpbWl0ID0gMzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGltaXQiPgogICAgIDxwPk91dHB1dDoge3sgbnVtYmVycyB8IGxpbWl0VG86bGltaXQgfX08L3A+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCl7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBsaW1pdCkgewogICAgICAgICAgICBpZiAoIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CiAgICAgICAgICAgIHZhciBvdXQgPSBbXSwKICAgICAgICAgICAgICAgIGksIG47CgogICAgICAgICAgICAvLyBjaGVjayB0aGF0IGFycmF5IGlzIGl0ZXJhYmxlCiAgICAgICAgICAgIGlmICghYXJyYXkgfHwgIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkKICAgICAgICAgICAgICAgIHJldHVybiBvdXQ7CgogICAgICAgICAgICAvLyBpZiBhYnMobGltaXQpIGV4Y2VlZHMgbWF4aW11bSBsZW5ndGgsIHRyaW0gaXQKICAgICAgICAgICAgaWYgKGxpbWl0ID4gYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICAgIGVsc2UgaWYgKGxpbWl0IDwgLWFycmF5Lmxlbmd0aCkKICAgICAgICAgICAgICAgIGxpbWl0ID0gLWFycmF5Lmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgbiA9IGxpbWl0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaSA9IGFycmF5Lmxlbmd0aCArIGxpbWl0OwogICAgICAgICAgICAgICAgbiA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgICAgICAgICAgICBvdXQucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6b3JkZXJCeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBPcmRlcnMgYSBzcGVjaWZpZWQgYGFycmF5YCBieSB0aGUgYGV4cHJlc3Npb25gIHByZWRpY2F0ZS4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0b24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNvcnQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCopfHN0cmluZ3xBcnJheS48KGZ1bmN0aW9uKCopfHN0cmluZyk+fSBleHByZXNzaW9uIEEgcHJlZGljYXRlIHRvIGJlCiAgICAgKiAgICB1c2VkIGJ5IHRoZSBjb21wYXJhdG9yIHRvIGRldGVybWluZSB0aGUgb3JkZXIgb2YgZWxlbWVudHMuCiAgICAgKgogICAgICogICAgQ2FuIGJlIG9uZSBvZjoKICAgICAqCiAgICAgKiAgICAtIGBmdW5jdGlvbmA6IEdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogICAgICogICAgICBgPGAsIGA9YCwgYD5gIG9wZXJhdG9yLgogICAgICogICAgLSBgc3RyaW5nYDogQW4gQW5ndWxhciBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBvYmplY3QgdG8gb3JkZXIgYnksIHN1Y2ggYXMgJ25hbWUnCiAgICAgKiAgICAgIHRvIHNvcnQgYnkgYSBwcm9wZXJ0eSBjYWxsZWQgJ25hbWUnLiBPcHRpb25hbGx5IHByZWZpeGVkIHdpdGggYCtgIG9yIGAtYCB0byBjb250cm9sCiAgICAgKiAgICAgIGFzY2VuZGluZyBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGZvciBleGFtcGxlLCArbmFtZSBvciAtbmFtZSkuCiAgICAgKiAgICAtIGBBcnJheWA6IEFuIGFycmF5IG9mIGZ1bmN0aW9uIG9yIHN0cmluZyBwcmVkaWNhdGVzLiBUaGUgZmlyc3QgcHJlZGljYXRlIGluIHRoZSBhcnJheQogICAgICogICAgICBpcyB1c2VkIGZvciBzb3J0aW5nLCBidXQgd2hlbiB0d28gaXRlbXMgYXJlIGVxdWl2YWxlbnQsIHRoZSBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJldmVyc2UgUmV2ZXJzZSB0aGUgb3JkZXIgdGhlIGFycmF5LgogICAgICogQHJldHVybnMge0FycmF5fSBTb3J0ZWQgY29weSBvZiB0aGUgc291cmNlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuZnJpZW5kcyA9CiAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWFyeScsIHBob25lOic1NTUtOTg3NicsIGFnZToxOX0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMScsIGFnZToyMX0sCiAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnLCBhZ2U6Mjl9XQogICAgICAgICAgICRzY29wZS5wcmVkaWNhdGUgPSAnLWFnZSc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgICA8aHIvPgogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgICA8dHI+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAoPGEgaHJlZiBuZy1jbGljaz0icHJlZGljYXRlID0gJy1uYW1lJzsgcmV2ZXJzZT1mYWxzZSI+XjwvYT4pPC90aD4KICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ3Bob25lJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+UGhvbmUgTnVtYmVyPC9hPjwvdGg+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgICA8L3RyPgogICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgb3JkZXJCeTpwcmVkaWNhdGU6cmV2ZXJzZSI+CiAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgYmUgcmV2ZXJzZSBvcmRlcmVkIGJ5IGFnZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ByZWRpY2F0ZScpKS50b0JlKCctYWdlJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgIHRvRXF1YWwoWyczNScsICcyOScsICcyMScsICcxOScsICcxMCddKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0p1bGllJywgJ01pa2UnLCAnTWFyeScsICdKb2huJ10pOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJOYW1lIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0FkYW0nLCAnSm9obicsICdKdWxpZScsICdNYXJ5JywgJ01pa2UnXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgIHRvRXF1YWwoWyczNScsICcxMCcsICcyOScsICcxOScsICcyMSddKTsKCiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMoIlBob25lIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLnBob25lJykpLgogICAgICAgICAgIHRvRXF1YWwoWyc1NTUtOTg3NicsICc1NTUtODc2NScsICc1NTUtNTY3OCcsICc1NTUtNDMyMScsICc1NTUtMTIxMiddKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ0p1bGllJywgJ0FkYW0nLCAnTWlrZScsICdKb2huJ10pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKICAgIGZ1bmN0aW9uIG9yZGVyQnlGaWx0ZXIoJHBhcnNlKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGU6IFtzb3J0UHJlZGljYXRlXTsKICAgICAgICAgICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICAgICAgICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLGdldChiKSk7CiAgICAgICAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgYXJyYXlDb3B5LnB1c2goYXJyYXlbaV0pOyB9CiAgICAgICAgICAgIHJldHVybiBhcnJheUNvcHkuc29ydChyZXZlcnNlQ29tcGFyYXRvcihjb21wYXJhdG9yLCByZXZlcnNlT3JkZXIpKTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBhcmF0b3IobzEsIG8yKXsKICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvcnRQcmVkaWNhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tcCA9IHNvcnRQcmVkaWNhdGVbaV0obzEsIG8yKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcCAhPT0gMCkgcmV0dXJuIGNvbXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXZlcnNlQ29tcGFyYXRvcihjb21wLCBkZXNjZW5kaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbihhLGIpe3JldHVybiBjb21wKGIsYSk7fQogICAgICAgICAgICAgICAgICAgIDogY29tcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgICAgICAgICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgICAgICAgICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgICAgICAgICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgICAgIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6YQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICAgICAqIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICAgICAqCiAgICAgKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICAgICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Im1vZGVsLiRzYXZlKCkiPlNhdmU8L2E+YAogICAgICovCiAgICB2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAgICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgICAgICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgICAgICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgICAgICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoJ2hyZWYnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIcmVmCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogICAgICogdGhlIHBhZ2Ugb3BlbiB0byBhIHdyb25nIFVSTCwgaWYgdGhlIHVzZXIgY2xpY2tzIHRoYXQgbGluayBiZWZvcmUKICAgICAqIGFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIHt7aGFzaH19IHdpdGggYWN0dWFsIFVSTCwgdGhlCiAgICAgKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICAgICAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgQQogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVGhpcyBleGFtcGxlIHVzZXMgYGxpbmtgIHZhcmlhYmxlIGluc2lkZSBgaHJlZmAgYXR0cmlidXRlOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0xJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTEnKS5hdHRyKCdocmVmJykpLnRvQmUoIiIpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMicpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0yJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0zJykuYXR0cignaHJlZicpKS50b0JlKCIvMTIzIik7CgogICAgICAgICAgZWxlbWVudCgnI2xpbmstMycpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoYnJvd3NlcigpLndpbmRvdygpLnBhdGgoKSkudG9FcXVhbCgnLzEyMycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nLWhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgnNicpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLnVybCgpKS50b0VxdWFsKCcvNicpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NyYwogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IElNRwogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEaXNhYmxlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAgICAgKiA8cHJlPgogICAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICAgKiA8L2Rpdj4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBkaXNhYmxlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nRGlzYWJsZWRgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hlY2tlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBjaGVja2VkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdtYXN0ZXInKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNdWx0aXBsZQogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nTXVsdGlwbGVgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICA8c2VsZWN0IGlkPSJzZWxlY3QiIG5nLW11bHRpcGxlPSJjaGVja2VkIj4KICAgICA8b3B0aW9uPk1pc2tvPC9vcHRpb24+CiAgICAgPG9wdGlvbj5JZ29yPC9vcHRpb24+CiAgICAgPG9wdGlvbj5Wb2p0YTwvb3B0aW9uPgogICAgIDxvcHRpb24+RGk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBtdWx0aXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IFNFTEVDVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ011bHRpcGxlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUmVhZG9ubHkKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NlbGVjdGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHNlbGVjdGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlZCB0aGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgICAgPHNlbGVjdD4KICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnc2VsZWN0ZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IE9QVElPTgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24ocHJvcE5hbWUsIGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbm9ybWFsaXplZF0sIGZ1bmN0aW9uIG5nQm9vbGVhbkF0dHJXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCAhIXZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgoKLy8gbmctc3JjLCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKICAgIGZvckVhY2goWydzcmMnLCAnaHJlZiddLCBmdW5jdGlvbihhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUobm9ybWFsaXplZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGNhbGxpbmcgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdmb28nKSBkb2Vzbid0IGRvIGFueXRoaW5nLCBzbyB3ZSBuZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHNldCB0aGUgcHJvcGVydHkgYXMgd2VsbCB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIGVmZmVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtc2llKSBlbGVtZW50LnByb3AoYXR0ck5hbWUsIGF0dHJbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgogICAgdmFyIG51bGxGb3JtQ3RybCA9IHsKICAgICAgICAkYWRkQ29udHJvbDogbm9vcCwKICAgICAgICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAgICAgICAkc2V0VmFsaWRpdHk6IG5vb3AsCiAgICAgICAgJHNldERpcnR5OiBub29wCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICAgKiAgZm9ybXMsIHdoZXJlOgogICAgICoKICAgICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcykg4oCUIHN1Y2ggYXMgYHJlcXVpcmVkYCwgYHVybGAgb3IgYGVtYWlsYCksCiAgICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIHdpdGggZ2l2ZW4gZXJyb3IuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHN0YXRlIG9mIHRoZW0sCiAgICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICAgKgogICAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICAgKgogICAgICovCi8vYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICBGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJ107CiAgICBmdW5jdGlvbiBGb3JtQ29udHJvbGxlcihlbGVtZW50LCBhdHRycykgewogICAgICAgIHZhciBmb3JtID0gdGhpcywKICAgICAgICAgICAgcGFyZW50Rm9ybSA9IGVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICAgICAgICBlcnJvcnMgPSBmb3JtLiRlcnJvciA9IHt9OwoKICAgICAgICAvLyBpbml0IHN0YXRlCiAgICAgICAgZm9ybS4kbmFtZSA9IGF0dHJzLm5hbWUgfHwgYXR0cnMubmdGb3JtOwogICAgICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CgogICAgICAgIHBhcmVudEZvcm0uJGFkZENvbnRyb2woZm9ybSk7CgogICAgICAgIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAgICAgICBlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKCiAgICAgICAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKICAgICAgICAgICAgZWxlbWVudC4KICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSkuCiAgICAgICAgICAgICAgICBhZGRDbGFzcygoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmICFmb3JtLmhhc093blByb3BlcnR5KGNvbnRyb2wuJG5hbWUpKSB7CiAgICAgICAgICAgICAgICBmb3JtW2NvbnRyb2wuJG5hbWVdID0gY29udHJvbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRyZW1vdmVDb250cm9sCiAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBEZXJlZ2lzdGVyIGEgY29udHJvbCBmcm9tIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgZGVzdHJveWVkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHJlbW92ZUNvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbihxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgICAgICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0VmFsaWRpdHkKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMgdGhlIHZhbGlkaXR5IG9mIGEgZm9ybSBjb250cm9sLgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0RGlydHkKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMgdGhlIGZvcm0gdG8gYSBkaXJ0eSBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gYWRkIHRoZSAnbmctZGlydHknIGNsYXNzIGFuZCBzZXQgdGhlIGZvcm0gdG8gYSBkaXJ0eQogICAgICAgICAqIHN0YXRlIChuZy1kaXJ0eSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHNldERpcnR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH07CgogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0KICAgICAqIEByZXN0cmljdCBFQUMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogICAgICogZG9lcyBub3QgYWxsb3cgbmVzdGluZyBvZiBmb3JtIGVsZW1lbnRzLiBJdCBpcyB1c2VmdWwgdG8gbmVzdCBmb3JtcywgZm9yIGV4YW1wbGUgaWYgdGhlIHZhbGlkaXR5IG9mIGEKICAgICAqIHN1Yi1ncm91cCBvZiBjb250cm9scyBuZWVkcyB0byBiZSBkZXRlcm1pbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZXxuZ0Zvcm0gTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgICAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAgICAgKgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERpcmVjdGl2ZSB0aGF0IGluc3RhbnRpYXRlcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgICAqCiAgICAgKiBJZiBgbmFtZWAgYXR0cmlidXRlIGlzIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciBpcyBwdWJsaXNoZWQgb250byB0aGUgY3VycmVudCBzY29wZSB1bmRlcgogICAgICogdGhpcyBuYW1lLgogICAgICoKICAgICAqICMgQWxpYXM6IHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfQogICAgICoKICAgICAqIEluIGFuZ3VsYXIgZm9ybXMgY2FuIGJlIG5lc3RlZC4gVGhpcyBtZWFucyB0aGF0IHRoZSBvdXRlciBmb3JtIGlzIHZhbGlkIHdoZW4gYWxsIG9mIHRoZSBjaGlsZAogICAgICogZm9ybXMgYXJlIHZhbGlkIGFzIHdlbGwuIEhvd2V2ZXIgYnJvd3NlcnMgZG8gbm90IGFsbG93IG5lc3Rpbmcgb2YgYDxmb3JtPmAgZWxlbWVudHMsIGZvciB0aGlzCiAgICAgKiByZWFzb24gYW5ndWxhciBwcm92aWRlcyB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gYWxpYXMKICAgICAqIHdoaWNoIGJlaGF2ZXMgaWRlbnRpY2FsIHRvIGA8Zm9ybT5gIGJ1dCBhbGxvd3MgZm9ybSBuZXN0aW5nLgogICAgICoKICAgICAqCiAgICAgKiAjIENTUyBjbGFzc2VzCiAgICAgKiAgLSBgbmctdmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyB2YWxpZC4KICAgICAqICAtIGBuZy1pbnZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgICAqICAtIGBuZy1wcmlzdGluZWAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHByaXN0aW5lLgogICAgICogIC0gYG5nLWRpcnR5YCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgZGlydHkuCiAgICAgKgogICAgICoKICAgICAqICMgU3VibWl0dGluZyBhIGZvcm0gYW5kIHByZXZlbnRpbmcgZGVmYXVsdCBhY3Rpb24KICAgICAqCiAgICAgKiBTaW5jZSB0aGUgcm9sZSBvZiBmb3JtcyBpbiBjbGllbnQtc2lkZSBBbmd1bGFyIGFwcGxpY2F0aW9ucyBpcyBkaWZmZXJlbnQgdGhhbiBpbiBjbGFzc2ljYWwKICAgICAqIHJvdW5kdHJpcCBhcHBzLCBpdCBpcyBkZXNpcmFibGUgZm9yIHRoZSBicm93c2VyIG5vdCB0byB0cmFuc2xhdGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbnRvIGEgZnVsbAogICAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICAgKiB0byBoYW5kbGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbiBhcHBsaWNhdGlvbiBzcGVjaWZpYyB3YXkuCiAgICAgKgogICAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgICAqIGA8Zm9ybT5gIGVsZW1lbnQgaGFzIGFuIGBhY3Rpb25gIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAgICogYSBmb3JtIGlzIHN1Ym1pdHRlZDoKICAgICAqCiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmUgb24gdGhlIGZpcnN0CiAgICAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAgICAgKgogICAgICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgbmdTdWJtaXQgb3IgbmdDbGljayBkaXJlY3RpdmVzLiBUaGlzCiAgICAgKiBpcyBiZWNhdXNlIG9mIHRoZSBmb2xsb3dpbmcgZm9ybSBzdWJtaXNzaW9uIHJ1bGVzIGNvbWluZyBmcm9tIHRoZSBodG1sIHNwZWM6CiAgICAgKgogICAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICAgKiAoYG5nU3VibWl0YCkKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBoYXMgMisgaW5wdXQgZmllbGRzIGFuZCBubyBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuIGhpdHRpbmcgZW50ZXIKICAgICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBvbmUgb3IgbW9yZSBpbnB1dCBmaWVsZHMgYW5kIG9uZSBvciBtb3JlIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4KICAgICAqIGhpdHRpbmcgZW50ZXIgaW4gYW55IG9mIHRoZSBpbnB1dCBmaWVsZHMgd2lsbCB0cmlnZ2VyIHRoZSBjbGljayBoYW5kbGVyIG9uIHRoZSAqZmlyc3QqIGJ1dHRvbiBvcgogICAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnVzZXJUeXBlID0gJ2d1ZXN0JzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgPHR0PnVzZXJUeXBlID0ge3t1c2VyVHlwZX19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPC9mb3JtPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3VzZXJUeXBlJykuZW50ZXIoJycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGZvcm1EaXJlY3RpdmVGYWN0b3J5ID0gZnVuY3Rpb24oaXNOZ0Zvcm0pIHsKICAgICAgICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgICAgICAgICAgIHZhciBmb3JtRGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvLyBJRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1bnJlZ2lzdGVyIHRoZSBwcmV2ZW50RGVmYXVsdCBsaXN0ZW5lciBzbyB0aGF0IHdlIGRvbid0IG5vdCBsZWFrIG1lbW9yeSBidXQgaW4gYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdheSB0aGF0IHdpbGwgYWNoaWV2ZSB0aGUgcHJldmVudGlvbiBvZiB0aGUgZGVmYXVsdCBhY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbYWxpYXNdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVyLCBudWxsRm9ybUN0cmwpOyAvL3N0b3AgcHJvcGFnYXRpbmcgY2hpbGQgZGVzdHJ1Y3Rpb24gaGFuZGxlcnMgdXB3YXJkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBpc05nRm9ybSA/IGV4dGVuZChjb3B5KGZvcm1EaXJlY3RpdmUpLCB7cmVzdHJpY3Q6ICdFQUMnfSkgOiBmb3JtRGlyZWN0aXZlOwogICAgICAgIH1dOwogICAgfTsKCiAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KCk7CiAgICB2YXIgbmdGb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkodHJ1ZSk7CgogICAgdmFyIFVSTF9SRUdFWFAgPSAvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvOwogICAgdmFyIEVNQUlMX1JFR0VYUCA9IC9eW0EtWmEtejAtOS5fJSstXStAW0EtWmEtejAtOS4tXStcLltBLVphLXpdezIsNn0kLzsKICAgIHZhciBOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKICAgIHZhciBpbnB1dFR5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU3RhbmRhcmQgSFRNTCB0ZXh0IGlucHV0IHdpdGggYW5ndWxhciBkYXRhIGJpbmRpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlx3KiQvOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFNpbmdsZSB3b3JkOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IgogICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgIFNpbmdsZSB3b3JkIG9ubHkhPC9zcGFuPgoKICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ2d1ZXN0Jyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG11bHRpIHdvcmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignaGVsbG8gd29ybGQnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAgICAgICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZSA9IDEyOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIE51bWJlcjogPGlucHV0IHR5cGU9Im51bWJlciIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgbWluPSIwIiBtYXg9Ijk5IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IubnVtYmVyIj4KICAgICAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWV9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJzEyJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcxMjMnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnbnVtYmVyJzogbnVtYmVySW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC51cmwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgICAgICAgKiB2YWxpZCBVUkwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaHR0cDovL2dvb2dsZS5jb20nOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnaHR0cDovL2dvb2dsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndXJsJzogdXJsSW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5lbWFpbAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgICAgICAgKiBhZGRyZXNzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQucmFkaW8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvcn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbG9yJykpLnRvRXF1YWwoJ2JsdWUnKTsKCiAgICAgICAgICAgIGlucHV0KCdjb2xvcicpLnNlbGVjdCgncmVkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdZRVMnKTsKCiAgICAgICAgICAgIGlucHV0KCd2YWx1ZTEnKS5jaGVjaygpOwogICAgICAgICAgICBpbnB1dCgndmFsdWUyJykuY2hlY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgICAgICdoaWRkZW4nOiBub29wLAogICAgICAgICdidXR0b24nOiBub29wLAogICAgICAgICdzdWJtaXQnOiBub29wLAogICAgICAgICdyZXNldCc6IG5vb3AKICAgIH07CgoKICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdHJpbShlbGVtZW50LnZhbCgpKTsKCiAgICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAgICAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnaW5wdXQnLCBsaXN0ZW5lcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRpbWVvdXQ7CgogICAgICAgICAgICB2YXIgZGVmZXJMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYmluZCgna2V5ZG93bicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgICAgICAgICAgICAvLyBpZ25vcmUKICAgICAgICAgICAgICAgIC8vICAgIGNvbW1hbmQgICAgICAgICAgICBtb2RpZmllcnMgICAgICAgICAgICAgICAgICAgYXJyb3dzCiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGRlZmVyTGlzdGVuZXIoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2UsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogICAgICAgICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ3Bhc3RlIGN1dCcsIGRlZmVyTGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQudmFsKGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgICAgIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3I7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IHJlZ2V4cC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3BhdHRlcm4nLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmIChwYXR0ZXJuKSB7CiAgICAgICAgICAgIGlmIChwYXR0ZXJuLm1hdGNoKC9eXC8oLiopXC8kLykpIHsKICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBuZXcgUmVnRXhwKHBhdHRlcm4uc3Vic3RyKDEsIHBhdHRlcm4ubGVuZ3RoIC0gMikpOwogICAgICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm4sIHZhbHVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGF0dGVybk9iaiB8fCAhcGF0dGVybk9iai50ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdHRlcm4gKyAnIHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgJyArIHBhdHRlcm5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPCBtaW5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW5sZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtYXggbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWF4bGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtYXhsZW5ndGggPSBpbnQoYXR0ci5uZ01heGxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPiBtYXhsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4bGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGlzRW1wdHkodmFsdWUpOwogICAgICAgICAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNFbXB0eSh2YWx1ZSkgPyAnJyA6ICcnICsgdmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChhdHRyLm1pbikgewogICAgICAgICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgICAgICAgIHZhciBtaW5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA8IG1pbikgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW4nLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChhdHRyLm1heCkgewogICAgICAgICAgICB2YXIgbWF4ID0gcGFyc2VGbG9hdChhdHRyLm1heCk7CiAgICAgICAgICAgIHZhciBtYXhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgVVJMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbWFpbElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgdmFyIGVtYWlsVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRbMF0uY2hlY2tlZCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlVmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgICAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAgICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS51c2VyTmFtZS4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgICAgbmctbWlubGVuZ3RoPSIzIiBuZy1tYXhsZW5ndGg9IjEwIj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5tYXhsZW5ndGgiPgogICAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgICAgPC9mb3JtPgogICAgIDxocj4KICAgICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiRlcnJvciA9IHt7bXlGb3JtLnVzZXJOYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5tYXhsZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5tYXhsZW5ndGh9fTwvdHQ+PGJyPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eSB3aGVuIHJlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5uYW1lJykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSB2YWxpZCBpZiBlbXB0eSB3aGVuIG1pbiBsZW5ndGggaXMgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoiIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3h4Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWlubGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpCiAgICAgICAgICAgIC50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWF4bGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBpbnB1dERpcmVjdGl2ZSA9IFsnJGJyb3dzZXInLCAnJHNuaWZmZXInLCBmdW5jdGlvbigkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICAoaW5wdXRUeXBlW2xvd2VyY2FzZShhdHRyLnR5cGUpXSB8fCBpbnB1dFR5cGUudGV4dCkoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLAogICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgdmFyIFZBTElEX0NMQVNTID0gJ25nLXZhbGlkJywKICAgICAgICBJTlZBTElEX0NMQVNTID0gJ25nLWludmFsaWQnLAogICAgICAgIFBSSVNUSU5FX0NMQVNTID0gJ25nLXByaXN0aW5lJywKICAgICAgICBESVJUWV9DTEFTUyA9ICduZy1kaXJ0eSc7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAkdmlld1ZhbHVlIEFjdHVhbCBzdHJpbmcgdmFsdWUgaW4gdGhlIHZpZXcuCiAgICAgKiBAcHJvcGVydHkgeyp9ICRtb2RlbFZhbHVlIFRoZSB2YWx1ZSBpbiB0aGUgbW9kZWwsIHRoYXQgdGhlIGNvbnRyb2wgaXMgYm91bmQgdG8uCiAgICAgKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICRwYXJzZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLCBhcyBhIHBpcGVsaW5lLCB3aGVuZXZlcgogICAgIHRoZSBjb250cm9sIHJlYWRzIHZhbHVlIGZyb20gdGhlIERPTS4gIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZQogICAgIHRocm91Z2ggdG8gdGhlIG5leHQuIFVzZWQgdG8gc2FuaXRpemUgLyBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRpb24uCgogICAgIEZvciB2YWxpZGF0aW9uLCB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJGZvcm1hdHRlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgICAgKiAgICAgdGhlIG1vZGVsIHZhbHVlIGNoYW5nZXMuIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZSB0aHJvdWdoIHRvIHRoZQogICAgICogICAgIG5leHQuIFVzZWQgdG8gZm9ybWF0IC8gY29udmVydCB2YWx1ZXMgZm9yIGRpc3BsYXkgaW4gdGhlIGNvbnRyb2wgYW5kIHZhbGlkYXRpb24uCiAgICAgKiAgICAgIDxwcmU+CiAgICAgKiAgICAgIGZ1bmN0aW9uIGZvcm1hdHRlcih2YWx1ZSkgewogKiAgICAgICAgaWYgKHZhbHVlKSB7CiAqICAgICAgICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogKiAgICAgICAgfQogKiAgICAgIH0KICAgICAqICAgICAgbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICAgKiAgICAgIDwvcHJlPgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBiamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbCB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgZXJyb3Igb24gdGhlIGNvbnRyb2wuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGUsIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICAgKiBzcGVjaWZpY2FsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAgICogRE9NIGV2ZW50cy4gVGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgaXMgbWVhbnQgdG8gYmUgZXh0ZW5kZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGVyZSwgdGhlCiAgICAgKiBkaXJlY3RpdmUgcHJvdmlkZXMgRE9NIG1hbmlwdWxhdGlvbiBhbmQgdGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgdGhlIGRhdGEtYmluZGluZy4KICAgICAqIE5vdGUgdGhhdCB5b3UgY2Fubm90IHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIGluIGEgZGlyZWN0aXZlIHdpdGggYW4gaXNvbGF0ZWQgc2NvcGUsCiAgICAgKiBhcywgaW4gdGhhdCBjYXNlLCB0aGUgYG5nLW1vZGVsYCB2YWx1ZSBnZXRzIHB1dCBpbnRvIHRoZSBpc29sYXRlZCBzY29wZSBhbmQgZG9lcyBub3QgZ2V0CiAgICAgKiBwcm9wb2dhdGVkIHRvIHRoZSBwYXJlbnQgc2NvcGUuCiAgICAgKgogICAgICoKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gdXNlIGBOZ01vZGVsQ29udHJvbGxlcmAgd2l0aCBhIGN1c3RvbSBjb250cm9sIHRvIGFjaGlldmUKICAgICAqIGRhdGEtYmluZGluZy4gTm90aWNlIGhvdyBkaWZmZXJlbnQgZGlyZWN0aXZlcyAoYGNvbnRlbnRlZGl0YWJsZWAsIGBuZy1tb2RlbGAsIGFuZCBgcmVxdWlyZWRgKQogICAgICogY29sbGFib3JhdGUgdG9nZXRoZXIgdG8gYWNoaWV2ZSB0aGUgZGVzaXJlZCByZXN1bHQuCiAgICAgKgogICAgICogPGV4YW1wbGUgbW9kdWxlPSJjdXN0b21Db250cm9sIj4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICB9CgogICAgIC5uZy1pbnZhbGlkIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZWQ7CiAgICAgIH0KCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbXSkuCiAgICAgZGlyZWN0aXZlKCdjb250ZW50ZWRpdGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywgLy8gZ2V0IGEgaG9sZCBvZiBOZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHsKICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCgogICAgICAgICAgICAgIC8vIFNwZWNpZnkgaG93IFVJIHNob3VsZCBiZSB1cGRhdGVkCiAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwobmdNb2RlbC4kdmlld1ZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIGNoYW5nZSBldmVudHMgdG8gZW5hYmxlIGJpbmRpbmcKICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkocmVhZCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCgogICAgICAgICAgICAgIC8vIFdyaXRlIGRhdGEgdG8gdGhlIG1vZGVsCiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgIHZhciBodG1sID0gZWxlbWVudC5odG1sKCk7CiAgICAgICAgICAgICAgICAvLyBXaGVuIHdlIGNsZWFyIHRoZSBjb250ZW50IGVkaXRhYmxlIHRoZSBicm93c2VyIGxlYXZlcyBhIDxicj4gYmVoaW5kCiAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgaWYoIGF0dHJzLnN0cmlwQnIgJiYgaHRtbCA9PSAnPGJyPicgKSB7CiAgICAgICAgICAgICAgICAgIGh0bWwgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5nTW9kZWwuJHNldFZpZXdWYWx1ZShodG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgIHN0cmlwLWJyPSJ0cnVlIgogICAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgICAgPGhyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idXNlckNvbnRlbnQiPjwvdGV4dGFyZWE+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNvbnRlbnRFZGl0YWJsZSA9IGVsZW1lbnQoJ1tjb250ZW50ZWRpdGFibGVdJyk7CgogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCdDaGFuZ2UgbWUhJyk7CiAgICAgICAgaW5wdXQoJ3VzZXJDb250ZW50JykuZW50ZXIoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICAqIDwvZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBOZ01vZGVsQ29udHJvbGxlciA9IFsnJHNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRhdHRycycsICckZWxlbWVudCcsICckcGFyc2UnLAogICAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlKSB7CiAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgICAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgICAgICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICAgICAgICAgICAgaWYgKCFuZ01vZGVsU2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgJGF0dHIubmdNb2RlbCArCiAgICAgICAgICAgICAgICAgICAgJyAoJyArIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSArICcpJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgICAgICAkZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSA9PT0gIWlzVmFsaWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSkgaW52YWxpZENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPSAhaXNWYWxpZDsKICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSk7CgogICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkLCB0aGlzKTsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWaWV3VmFsdWUKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZWFkIGEgdmFsdWUgZnJvbSB2aWV3LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGZyb20gd2l0aGluIGEgRE9NIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAqIEZvciBleGFtcGxlIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0gZGlyZWN0aXZlcyBjYWxsIGl0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJdCBpbnRlcm5hbGx5IGNhbGxzIGFsbCBgJHBhcnNlcnNgIChpbmNsdWRpbmcgdmFsaWRhdG9ycykgYW5kIHVwZGF0ZXMgdGhlIGAkbW9kZWxWYWx1ZWAgYW5kIHRoZSBhY3R1YWwgbW9kZWwgcGF0aC4KICAgICAgICAgICAgICogTGFzdGx5IGl0IGNhbGxzIGFsbCByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIGNoYW5nZSB0byBkaXJ0eQogICAgICAgICAgICAgICAgaWYgKHRoaXMuJHByaXN0aW5lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kcGFyc2VycywgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsU2V0KCRzY29wZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gbW9kZWwgLT4gdmFsdWUKICAgICAgICAgICAgdmFyIGN0cmwgPSB0aGlzOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBuZ01vZGVsR2V0KCRzY29wZSk7CgogICAgICAgICAgICAgICAgLy8gaWYgc2NvcGUgbW9kZWwgdmFsdWUgYW5kIG5nTW9kZWwgdmFsdWUgYXJlIG91dCBvZiBzeW5jCiAgICAgICAgICAgICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBpZHggPSBmb3JtYXR0ZXJzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKGlkeC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm9ybWF0dGVyc1tpZHhdKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElzIGEgZGlyZWN0aXZlIHRoYXQgdGVsbHMgQW5ndWxhciB0byBkbyB0d28td2F5IGRhdGEgYmluZGluZy4gSXQgd29ya3MgdG9nZXRoZXIgd2l0aCBgaW5wdXRgLAogICAgICogYHNlbGVjdGAsIGB0ZXh0YXJlYWAuIFlvdSBjYW4gZWFzaWx5IHdyaXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMgdG8gdXNlIGBuZ01vZGVsYCBhcyB3ZWxsLgogICAgICoKICAgICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICAgKgogICAgICogLSBiaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAgICogICByZXF1aXJlLAogICAgICogLSBwcm92aWRpbmcgdmFsaWRhdGlvbiBiZWhhdmlvciAoaS5lLiByZXF1aXJlZCwgbnVtYmVyLCBlbWFpbCwgdXJsKSwKICAgICAqIC0ga2VlcGluZyBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKSwKICAgICAqIC0gc2V0dGluZyByZWxhdGVkIGNzcyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApLAogICAgICogLSByZWdpc3RlciB0aGUgY29udHJvbCB3aXRoIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICAgKgogICAgICogTm90ZTogYG5nTW9kZWxgIHdpbGwgdHJ5IHRvIGJpbmQgdG8gdGhlIHByb3BlcnR5IGdpdmVuIGJ5IGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24gb24gdGhlCiAgICAgKiBjdXJyZW50IHNjb3BlLiBJZiB0aGUgcHJvcGVydHkgZG9lc24ndCBhbHJlYWR5IGV4aXN0IG9uIHRoaXMgc2NvcGUsIGl0IHdpbGwgYmUgY3JlYXRlZAogICAgICogaW1wbGljaXRseSBhbmQgYWRkZWQgdG8gdGhlIHNjb3BlLgogICAgICoKICAgICAqIEZvciBiYXNpYyBleGFtcGxlcywgaG93IHRvIHVzZSBgbmdNb2RlbGAsIHNlZToKICAgICAqCiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQgdGV4dH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5jaGVja2JveCBjaGVja2JveH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5yYWRpbyByYWRpb30KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIgbnVtYmVyfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsIGVtYWlsfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnVybCB1cmx9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnRleHRhcmVhIHRleHRhcmVhfQogICAgICoKICAgICAqLwogICAgdmFyIG5nTW9kZWxEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICAgIC8vIG5vdGlmeSBvdGhlcnMsIGVzcGVjaWFsbHkgcGFyZW50IGZvcm1zCgogICAgICAgICAgICAgICAgdmFyIG1vZGVsQ3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsID0gY3RybHNbMV0gfHwgbnVsbEZvcm1DdHJsOwoKICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRhZGRDb250cm9sKG1vZGVsQ3RybCk7CgogICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoYW5nZQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV2YWx1YXRlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAgICoKICAgICAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxkb2M6ZXhhbXBsZT4KICAgICAqICAgPGRvYzpzb3VyY2U+CiAgICAgKiAgICAgPHNjcmlwdD4KICAgICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAqICAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwOwogKiAgICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAqICAgICAgICAgfTsKICogICAgICAgfQogICAgICogICAgIDwvc2NyaXB0PgogICAgICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIG5nLWNoYW5nZT0iY2hhbmdlKCkiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTEiIC8+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAgICAgKiAgICAgICA8bGFiZWwgZm9yPSJuZy1jaGFuZ2UtZXhhbXBsZTIiPkNvbmZpcm1lZDwvbGFiZWw+PGJyIC8+CiAgICAgKiAgICAgICBkZWJ1ZyA9IHt7Y29uZmlybWVkfX08YnIgLz4KICAgICAqICAgICAgIGNvdW50ZXIgPSB7e2NvdW50ZXJ9fQogICAgICogICAgIDwvZGl2PgogICAgICogICA8L2RvYzpzb3VyY2U+CiAgICAgKiAgIDxkb2M6c2NlbmFyaW8+CiAgICAgKiAgICAgaXQoJ3Nob3VsZCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIHZpZXcnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMCcpOwogKiAgICAgICBlbGVtZW50KCcjbmctY2hhbmdlLWV4YW1wbGUxJykuY2xpY2soKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMScpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICogICAgIH0pOwogICAgICoKICAgICAqICAgICBpdCgnc2hvdWxkIG5vdCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTInKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKiAgIDwvZG9jOnNjZW5hcmlvPgogICAgICogPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIubmdDaGFuZ2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCgogICAgdmFyIHJlcXVpcmVkRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIucmVxdWlyZWQgJiYgKGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlID09PSBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy51bnNoaWZ0KHZhbGlkYXRvcik7CgogICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3IoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTGlzdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGV4dCBpbnB1dCB0aGF0IGNvbnZlcnRzIGJldHdlZW4gY29tbWEtc2VwYXJhdGVkIHN0cmluZyBpbnRvIGFuIGFycmF5IG9mIHN0cmluZ3MuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdMaXN0IG9wdGlvbmFsIGRlbGltaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNwbGl0IHRoZSB2YWx1ZS4gSWYKICAgICAqICAgc3BlY2lmaWVkIGluIGZvcm0gYC9zb21ldGhpbmcvYCB0aGVuIHRoZSB2YWx1ZSB3aWxsIGJlIGNvbnZlcnRlZCBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWlza28nLCAndm9qdGEnXTsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgIDxicj4KICAgICA8dHQ+bmFtZXMgPSB7e25hbWVzfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiRlcnJvciA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1siaWdvciIsIm1pc2tvIiwidm9qdGEiXScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnc3Bhbi5lcnJvcicpLmNzcygnZGlzcGxheScpKS50b0JlKCdub25lJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ25hbWVzJykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnc3Bhbi5lcnJvcicpLmNzcygnZGlzcGxheScpKS5ub3QoKS50b0JlKCdub25lJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nTGlzdERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgICAgICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaXN0ID0gW107CgogICAgICAgICAgICAgICAgICAgIGlmICh2aWV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2aWV3VmFsdWUuc3BsaXQoc2VwYXJhdG9yKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CgogICAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbih0cGwsIHRwbEF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nVmFsdWUsIGZ1bmN0aW9uIHZhbHVlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICAgICAqIHdpdGggdGhlIHZhbHVlIG9mIGEgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIHVwZGF0ZSB0aGUgdGV4dCBjb250ZW50IHdoZW4gdGhlIHZhbHVlIG9mIHRoYXQKICAgICAqIGV4cHJlc3Npb24gY2hhbmdlcy4KICAgICAqCiAgICAgKiBUeXBpY2FsbHksIHlvdSBkb24ndCB1c2UgYG5nQmluZGAgZGlyZWN0bHksIGJ1dCBpbnN0ZWFkIHlvdSB1c2UgdGhlIGRvdWJsZSBjdXJseSBtYXJrdXAgbGlrZQogICAgICogYHt7IGV4cHJlc3Npb24gfX1gIHdoaWNoIGlzIHNpbWlsYXIgYnV0IGxlc3MgdmVyYm9zZS4KICAgICAqCiAgICAgKiBJdCBpcyBwcmVmZXJyYWJsZSB0byB1c2UgYG5nQmluZGAgaW5zdGVhZCBvZiBge3sgZXhwcmVzc2lvbiB9fWAgd2hlbiBhIHRlbXBsYXRlIGlzIG1vbWVudGFyaWx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4KICAgICAqIGVsZW1lbnQgYXR0cmlidXRlLCBpdCBtYWtlcyB0aGUgYmluZGluZ3MgaW52aXNpYmxlIHRvIHRoZSB1c2VyIHdoaWxlIHRoZSBwYWdlIGlzIGxvYWRpbmcuCiAgICAgKgogICAgICogQW4gYWx0ZXJuYXRpdmUgc29sdXRpb24gdG8gdGhpcyBwcm9ibGVtIHdvdWxkIGJlIHVzaW5nIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9IGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXaGlybGVkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnbmFtZScpLmVudGVyKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCd3b3JsZCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZFRlbXBsYXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICAgICAqIHRleHQgY29udGVudCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgaW50ZXJwb2xhdGlvbiBvZiB0aGUgdGVtcGxhdGUKICAgICAqIGluIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGF0dHJpYnV0ZS4KICAgICAqIFVubGlrZSBgbmdCaW5kYCwgdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAgICAgKiBleHByZXNzaW9ucy4gVGhpcyBkaXJlY3RpdmUgaXMgbmVlZGVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogICAgICogKHN1Y2ggYXMgVElUTEUgYW5kIE9QVElPTikgY2Fubm90IGNvbnRhaW4gU1BBTiBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0JpbmRUZW1wbGF0ZSB0ZW1wbGF0ZSBvZiBmb3JtCiAgICAgKiAgIDx0dD57ezwvdHQ+IDx0dD5leHByZXNzaW9uPC90dD4gPHR0Pn19PC90dD4gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuc2FsdXRhdGlvbiA9ICdIZWxsbyc7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV29ybGQnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBTYWx1dGF0aW9uOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InNhbHV0YXRpb24iPjxicj4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgIHRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLgogICAgICAgICAgIHRvQmUoJ1dvcmxkJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdzYWx1dGF0aW9uJykuZW50ZXIoJ0dyZWV0aW5ncycpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnbmFtZScpLmVudGVyKCd1c2VyJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgIHRvQmUoJ0dyZWV0aW5ncycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS4KICAgICAgICAgICB0b0JlKCd1c2VyJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnRleHQodmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbFVuc2FmZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIGJpbmRpbmcgdGhhdCB3aWxsIGlubmVySFRNTCB0aGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGBleHByZXNzaW9uYCBpbnRvIHRoZSBjdXJyZW50CiAgICAgKiBlbGVtZW50LiAqVGhlIGlubmVySFRNTC1lZCBjb250ZW50IHdpbGwgbm90IGJlIHNhbml0aXplZCEqIFlvdSBzaG91bGQgdXNlIHRoaXMgZGlyZWN0aXZlIG9ubHkgaWYKICAgICAqIHtAbGluayBuZ1Nhbml0aXplLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IGRpcmVjdGl2ZSBpcyB0b28KICAgICAqIHJlc3RyaWN0aXZlIGFuZCB3aGVuIHlvdSBhYnNvbHV0ZWx5IHRydXN0IHRoZSBzb3VyY2Ugb2YgdGhlIGNvbnRlbnQgeW91IGFyZSBiaW5kaW5nIHRvLgogICAgICoKICAgICAqIFNlZSB7QGxpbmsgbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBkb2NzIGZvciBleGFtcGxlcy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kSHRtbFVuc2FmZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgICAqLwogICAgdmFyIG5nQmluZEh0bWxVbnNhZmVEaXJlY3RpdmUgPSBbZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbFVuc2FmZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWxVbnNhZmUsIGZ1bmN0aW9uIG5nQmluZEh0bWxVbnNhZmVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBvbGRWYWwgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltuYW1lXSwgbmdDbGFzc1dhdGNoQWN0aW9uLCB0cnVlKTsKCiAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ2NsYXNzJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBuZ0NsYXNzID0gc2NvcGUuJGV2YWwoYXR0cltuYW1lXSk7CiAgICAgICAgICAgICAgICBuZ0NsYXNzV2F0Y2hBY3Rpb24obmdDbGFzcywgbmdDbGFzcyk7CiAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24oJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kICE9PSBvbGQkaW5kZXggJiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsb2xkVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhuZXdWYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkVmFsID0gY29weShuZXdWYWwpOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChjbGFzc1ZhbCkgJiYgIWlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgY2xhc3NWYWwgPSBtYXAoY2xhc3NWYWwsIGZ1bmN0aW9uKHYsIGspIHsgaWYgKHYpIHJldHVybiBrIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhpc0FycmF5KGNsYXNzVmFsKSA/IGNsYXNzVmFsLmpvaW4oJyAnKSA6IGNsYXNzVmFsKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZENsYXNzKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoY2xhc3NWYWwpICYmICFpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzVmFsID0gbWFwKGNsYXNzVmFsLCBmdW5jdGlvbih2LCBrKSB7IGlmICh2KSByZXR1cm4gayB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoaXNBcnJheShjbGFzc1ZhbCkgPyBjbGFzc1ZhbC5qb2luKCcgJykgOiBjbGFzc1ZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NgIGFsbG93cyB5b3UgdG8gc2V0IENTUyBjbGFzc2VzIG9uIEhUTUwgYW4gZWxlbWVudCwgZHluYW1pY2FsbHksIGJ5IGRhdGFiaW5kaW5nCiAgICAgKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICAgICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4gSW4gdGhlIGNhc2Ugb2YgYSBtYXAsIHRoZQogICAgICogICBuYW1lcyBvZiB0aGUgcHJvcGVydGllcyB3aG9zZSB2YWx1ZXMgYXJlIHRydXRoeSB3aWxsIGJlIGFkZGVkIGFzIGNzcyBjbGFzc2VzIHRvIHRoZQogICAgICogICBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15VmFyPSdteS1jbGFzcyciPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgICA8YnI+CiAgICAgPHNwYW4gbmctY2xhc3M9Im15VmFyIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAubXktY2xhc3MgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpmaXJzdCcpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpsYXN0JykuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLm5vdCgpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc0RpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCcnLCB0cnVlKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzT2RkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NPZGQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogICAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgIHt7bmFtZX19CiAgICAgPC9zcGFuPgogICAgIDwvbGk+CiAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NPZGREaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnT2RkJywgMCk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzc0V2ZW4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IGl0IHdvcmtzIGluCiAgICAgKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2VzIGFmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICAgICAqCiAgICAgKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiBhIHNjb3BlIG9mIGFuCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc0V2ZW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlCiAgICAgKiAgIHJlc3VsdCBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgPC9zcGFuPgogICAgIDwvbGk+CiAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NFdmVuRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ0V2ZW4nLCAxKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHByZXZlbnQgdGhlIEFuZ3VsYXIgaHRtbCB0ZW1wbGF0ZSBmcm9tIGJlaW5nIGJyaWVmbHkKICAgICAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3ICh1bmNvbXBpbGVkKSBmb3JtIHdoaWxlIHlvdXIgYXBwbGljYXRpb24gaXMgbG9hZGluZy4gVXNlIHRoaXMKICAgICAqIGRpcmVjdGl2ZSB0byBhdm9pZCB0aGUgdW5kZXNpcmFibGUgZmxpY2tlciBlZmZlY3QgY2F1c2VkIGJ5IHRoZSBodG1sIHRlbXBsYXRlIGRpc3BsYXkuCiAgICAgKgogICAgICogVGhlIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgYDxib2R5PmAgZWxlbWVudCwgYnV0IHR5cGljYWxseSBhIGZpbmUtZ3JhaW5lZCBhcHBsaWNhdGlvbiBpcwogICAgICogcHJlZmVyZWQgaW4gb3JkZXIgdG8gYmVuZWZpdCBmcm9tIHByb2dyZXNzaXZlIHJlbmRlcmluZyBvZiB0aGUgYnJvd3NlciB2aWV3LgogICAgICoKICAgICAqIGBuZ0Nsb2FrYCB3b3JrcyBpbiBjb29wZXJhdGlvbiB3aXRoIGEgY3NzIHJ1bGUgdGhhdCBpcyBlbWJlZGRlZCB3aXRoaW4gYGFuZ3VsYXIuanNgIGFuZAogICAgICogIGBhbmd1bGFyLm1pbi5qc2AgZmlsZXMuIEZvbGxvd2luZyBpcyB0aGUgY3NzIHJ1bGU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIFtuZ1w6Y2xvYWtdLCBbbmctY2xvYWtdLCBbZGF0YS1uZy1jbG9ha10sIFt4LW5nLWNsb2FrXSwgLm5nLWNsb2FrLCAueC1uZy1jbG9hayB7CiAqICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogKiB9CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBXaGVuIHRoaXMgY3NzIHJ1bGUgaXMgbG9hZGVkIGJ5IHRoZSBicm93c2VyLCBhbGwgaHRtbCBlbGVtZW50cyAoaW5jbHVkaW5nIHRoZWlyIGNoaWxkcmVuKSB0aGF0CiAgICAgKiBhcmUgdGFnZ2VkIHdpdGggdGhlIGBuZy1jbG9ha2AgZGlyZWN0aXZlIGFyZSBoaWRkZW4uIFdoZW4gQW5ndWxhciBjb21lcyBhY3Jvc3MgdGhpcyBkaXJlY3RpdmUKICAgICAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgd2hpY2gKICAgICAqIG1ha2VzIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAgICAgKgogICAgICogRm9yIHRoZSBiZXN0IHJlc3VsdCwgYGFuZ3VsYXIuanNgIHNjcmlwdCBtdXN0IGJlIGxvYWRlZCBpbiB0aGUgaGVhZCBzZWN0aW9uIG9mIHRoZSBodG1sIGZpbGU7CiAgICAgKiBhbHRlcm5hdGl2ZWx5LCB0aGUgY3NzIHJ1bGUgKGFib3ZlKSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogICAgICogYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICAgICAqIGNhbm5vdCBtYXRjaCB0aGUgYFtuZ1w6Y2xvYWtdYCBzZWxlY3Rvci4gVG8gd29yayBhcm91bmQgdGhpcyBsaW1pdGF0aW9uLCB5b3UgbXVzdCBhZGQgdGhlIGNzcwogICAgICogY2xhc3MgYG5nQ2xvYWtgIGluIGFkZGl0aW9uIHRvIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUxIiBuZy1jbG9haz57eyAnaGVsbG8nIH19PC9kaXY+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIHRlbXBsYXRlIGRpcmVjdGl2ZSBhbmQgY3NzIGNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjdGVtcGxhdGUxJykuYXR0cignbmctY2xvYWsnKSkuCiAgICAgICAgICAgbm90KCkudG9CZURlZmluZWQoKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTInKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ0Nsb2FrRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAgICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAgICAgKgogICAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgICAqCiAgICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgZGF0YSBpbiBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICAgKiAqIENvbnRyb2xsZXIg4oCUIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogICAgICogICBtZXRob2RzIHRoYXQgdHlwaWNhbGx5IGV4cHJlc3MgdGhlIGJ1c2luZXNzIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICAgICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSAkc2NvcGUgYnkgdGhlIGNvbnRyb2xsZXIgKHNlZSBzb3VyY2UgdGFiKS4gVGhlc2UgbWV0aG9kcyBjYW4KICAgICAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIE5vdGljZSB0aGF0IGFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5CiAgICAgKiByZWZsZWN0ZWQgaW4gdGhlIFZpZXcgd2l0aG91dCB0aGUgbmVlZCBmb3IgYSBtYW51YWwgdXBkYXRlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgJHNjb3BlLmNvbnRhY3RzID0gWwogICAgICAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAgICAgICAgICAgIHt0eXBlOidlbWFpbCcsIHZhbHVlOidqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKCiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICB9OwoKICAgICAkc2NvcGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogICAgICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5jbGVhckNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0KSB7CiAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAgICAgICAgICB9OwogICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlciI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICAgQ29udGFjdDoKICAgICA8dWw+CiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICA8L2xpPgogICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICA8L3VsPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgZGl2PjppbnB1dCcpLnZhbCgpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMSkgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMikgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwoKICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBhOmNvbnRhaW5zKCJjbGVhciIpJykuY2xpY2soKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3QgaW5wdXQnKS52YWwoKSkudG9CZSgnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3QgYTpjb250YWlucygiYWRkIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgICBjb250cm9sbGVyOiAnQCcKICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDc3AKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGVsZW1lbnQgaHRtbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICAgKgogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICoKICAgICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBCeSBhcHBseWluZyBgbmdDc3BgCiAgICAgKiBpdCBpcyBiZSBwb3NzaWJsZSB0byBvcHQgaW50byB0aGUgQ1NQIGNvbXBhdGlibGUgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICAgICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICAgKiBiZSByYWlzZWQuCiAgICAgKgogICAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgIDxwcmU+CiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24oJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcmlvcml0eTogMTAwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc25pZmZlci5jc3AgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ0NsaWNrIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbgogICAgICogZWxlbWVudCBpcyBjbGlja2VkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgSW5jcmVtZW50CiAgICAgPC9idXR0b24+CiAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICAvKgogICAgICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAgICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKgogICAgICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICAgICAqLwogICAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgICBmb3JFYWNoKAogICAgICAgICdjbGljayBkYmxjbGljayBtb3VzZWRvd24gbW91c2V1cCBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2Vtb3ZlIG1vdXNlZW50ZXIgbW91c2VsZWF2ZSBzdWJtaXQnLnNwbGl0KCcgJyksCiAgICAgICAgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB2YXIgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIG5hbWUpOwogICAgICAgICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24oJHBhcnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cltkaXJlY3RpdmVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKGxvd2VyY2FzZShuYW1lKSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZXZlbnR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9XTsKICAgICAgICB9CiAgICApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRGJsY2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZGJsY2xpY2sgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogZGJsY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWRvd24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNldXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNldXAgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW92ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VvdmVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VlbnRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VlbnRlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZW50ZXIuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWxlYXZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWxlYXZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VsZWF2ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlbW92ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZW1vdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nS2V5dXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlwcmVzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5cHJlc3MuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSAqKmJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYW4gYGFjdGlvbmAKICAgICAqIGF0dHJpYnV0ZSoqLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2hlbGxvJzsKICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGV4dCkgewogICAgICAgICAgICAgIHRoaXMubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5nLXN1Ym1pdD0ic3VibWl0KCkiIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1siaGVsbG8iXScpOwogICAgICAgICBleHBlY3QoaW5wdXQoJ3RleHQnKS52YWwoKSkudG9CZSgnJyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGlnbm9yZSBlbXB0eSBzdHJpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlCiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICAgICAqCiAgICAgKiBLZWVwIGluIG1pbmQgdGhhdCBTYW1lIE9yaWdpbiBQb2xpY3kgYXBwbGllcyB0byBpbmNsdWRlZCByZXNvdXJjZXMKICAgICAqIChlLmcuIG5nSW5jbHVkZSB3b24ndCB3b3JrIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgb24gYWxsIGJyb3dzZXJzIGFuZCBmb3IKICAgICAqICBmaWxlOi8vIGFjY2VzcyBvbiBzb21lIGJyb3dzZXJzKS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdJbmNsdWRlfHNyYyBhbmd1bGFyIGV4cHJlc3Npb24gZXZhbHVhdGluZyB0byBVUkwuIElmIHRoZSBzb3VyY2UgaXMgYSBzdHJpbmcgY29uc3RhbnQsCiAgICAgKiAgICAgICAgICAgICAgICAgbWFrZSBzdXJlIHlvdSB3cmFwIGl0IGluIHF1b3RlcywgZS5nLiBgc3JjPSInbXlQYXJ0aWFsVGVtcGxhdGUuaHRtbCciYC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF1dG9zY3JvbGwgV2hldGhlciBgbmdJbmNsdWRlYCBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbAogKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAgICoKICAgICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJ0ZW1wbGF0ZSIgbmctb3B0aW9ucz0idC5uYW1lIGZvciB0IGluIHRlbXBsYXRlcyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1pbmNsdWRlIHNyYz0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS50ZW1wbGF0ZXMgPQogICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30KICAgICAgICAgICwgeyBuYW1lOiAndGVtcGxhdGUyLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTIuaHRtbCd9IF07CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlID0gJHNjb3BlLnRlbXBsYXRlc1swXTsKICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTEuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMS5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLWluY2x1ZGVdJykudGV4dCgpKS4KICAgICAgICAgdG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJzEnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICBzZWxlY3QoJ3RlbXBsYXRlJykub3B0aW9uKCcnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdJbmNsdWRlRGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckYW5jaG9yU2Nyb2xsJywgJyRjb21waWxlJywKICAgICAgICBmdW5jdGlvbigkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkYW5jaG9yU2Nyb2xsLCAgICRjb21waWxlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjRXhwID0gYXR0ci5uZ0luY2x1ZGUgfHwgYXR0ci5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICBhdXRvU2Nyb2xsRXhwID0gYXR0ci5hdXRvc2Nyb2xsOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhckNvbnRlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goc3JjRXhwLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgIT09IGNoYW5nZUNvdW50ZXIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSBjaGlsZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwocmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKGNoaWxkU2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhdXRvU2Nyb2xsRXhwKSAmJiAoIWF1dG9TY3JvbGxFeHAgfHwgc2NvcGUuJGV2YWwoYXV0b1Njcm9sbEV4cCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChvbmxvYWRFeHApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0luaXRgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgaW5pdGlhbGl6YXRpb24gdGFza3MgdG8gYmUgZXhlY3V0ZWQKICAgICAqICBiZWZvcmUgdGhlIHRlbXBsYXRlIGVudGVycyBleGVjdXRpb24gbW9kZSBkdXJpbmcgYm9vdHN0cmFwLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0luaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImdyZWV0aW5nPSdIZWxsbyc7IHBlcnNvbj0nV29ybGQnIj4KICAgICB7e2dyZWV0aW5nfX0ge3twZXJzb259fSEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGdyZWV0aW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdncmVldGluZycpKS50b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QoYmluZGluZygncGVyc29uJykpLnRvQmUoJ1dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdJbml0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRycy5uZ0luaXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdOb25CaW5kYWJsZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNvbWV0aW1lcyBpdCBpcyBuZWNlc3NhcnkgdG8gd3JpdGUgY29kZSB3aGljaCBsb29rcyBsaWtlIGJpbmRpbmdzIGJ1dCB3aGljaCBzaG91bGQgYmUgbGVmdCBhbG9uZQogICAgICogYnkgYW5ndWxhci4gVXNlIGBuZ05vbkJpbmRhYmxlYCB0byBtYWtlIGFuZ3VsYXIgaWdub3JlIGEgY2h1bmsgb2YgSFRNTC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogSW4gdGhpcyBleGFtcGxlIHRoZXJlIGFyZSB0d28gbG9jYXRpb24gd2hlcmUgYSBzaW1wbGUgYmluZGluZyAoYHt7fX1gKSBpcyBwcmVzZW50LCBidXQgdGhlIG9uZQogICAgICogd3JhcHBlZCBpbiBgbmdOb25CaW5kYWJsZWAgaXMgbGVmdCBhbG9uZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgPGRpdiBuZy1ub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1ub24tYmluZGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJzEgKyAyJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2RpdjpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoeyB0ZXJtaW5hbDogdHJ1ZSwgcHJpb3JpdHk6IDEwMDAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdQbHVyYWxpemUKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogIyBPdmVydmlldwogICAgICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAgICAgKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogICAgICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAgICAgKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAqIHBsdXJhbCBjYXRlZ29yaWVzfSBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogICAgICoKICAgICAqICMgUGx1cmFsIGNhdGVnb3JpZXMgYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcwogICAgICogVGhlcmUgYXJlIHR3bwogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogKiBwbHVyYWwgY2F0ZWdvcmllc30gaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBXaGlsZSBhIHB1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICAgKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICAgKgogICAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdC4KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICo8L3ByZT4KICAgICAqCiAgICAgKiBJbiB0aGUgZXhhbXBsZSwgYCIwOiBOb2JvZHkgaXMgdmlld2luZy4iYCBpcyBhbiBleHBsaWNpdCBudW1iZXIgcnVsZS4gSWYgeW91IGRpZCBub3QKICAgICAqIHNwZWNpZnkgdGhpcyBydWxlLCAwIHdvdWxkIGJlIG1hdGNoZWQgdG8gdGhlICJvdGhlciIgY2F0ZWdvcnkgYW5kICIwIHBlb3BsZSBhcmUgdmlld2luZyIKICAgICAqIHdvdWxkIGJlIHNob3duIGluc3RlYWQgb2YgIk5vYm9keSBpcyB2aWV3aW5nIi4gWW91IGNhbiBzcGVjaWZ5IGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGZvcgogICAgICogb3RoZXIgbnVtYmVycywgZm9yIGV4YW1wbGUgMTIsIHNvIHRoYXQgaW5zdGVhZCBvZiBzaG93aW5nICIxMiBwZW9wbGUgYXJlIHZpZXdpbmciLCB5b3UgY2FuCiAgICAgKiBzaG93ICJhIGRvemVuIHBlb3BsZSBhcmUgdmlld2luZyIuCiAgICAgKgogICAgICogWW91IGNhbiB1c2UgYSBzZXQgb2YgY2xvc2VkIGJyYWNlcyhge31gKSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgbnVtYmVyIHRoYXQgeW91IHdhbnQgc3Vic3RpdHV0ZWQKICAgICAqIGludG8gcGx1cmFsaXplZCBzdHJpbmdzLiBJbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwgQW5ndWxhciB3aWxsIHJlcGxhY2UgYHt9YCB3aXRoCiAgICAgKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICAgICAqIGZvciA8c3BhbiBuZy1ub24tYmluZGFibGU+e3tudW1iZXJFeHByZXNzaW9ufX08L3NwYW4+LgogICAgICoKICAgICAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICAgICAqIFRoZSBgb2Zmc2V0YCBhdHRyaWJ1dGUgYWxsb3dzIGZ1cnRoZXIgY3VzdG9taXphdGlvbiBvZiBwbHVyYWxpemVkIHRleHQsIHdoaWNoIGNhbiByZXN1bHQgaW4KICAgICAqIGEgYmV0dGVyIHVzZXIgZXhwZXJpZW5jZS4gRm9yIGV4YW1wbGUsIGluc3RlYWQgb2YgdGhlIG1lc3NhZ2UgIjQgcGVvcGxlIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLAogICAgICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogICAgICogVGhlIG9mZnNldCBhdHRyaWJ1dGUgYWxsb3dzIHlvdSB0byBvZmZzZXQgYSBudW1iZXIgYnkgYW55IGRlc2lyZWQgdmFsdWUuCiAgICAgKiBMZXQncyB0YWtlIGEgbG9vayBhdCBhbiBleGFtcGxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICAgICAqICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIE5vdGljZSB0aGF0IHdlIGFyZSBzdGlsbCB1c2luZyB0d28gcGx1cmFsIGNhdGVnb3JpZXMob25lLCBvdGhlciksIGJ1dCB3ZSBhZGRlZAogICAgICogdGhyZWUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIDAsIDEgYW5kIDIuCiAgICAgKiBXaGVuIG9uZSBwZXJzb24sIHBlcmhhcHMgSm9obiwgdmlld3MgdGhlIGRvY3VtZW50LCAiSm9obiBpcyB2aWV3aW5nIiB3aWxsIGJlIHNob3duLgogICAgICogV2hlbiB0aHJlZSBwZW9wbGUgdmlldyB0aGUgZG9jdW1lbnQsIG5vIGV4cGxpY2l0IG51bWJlciBydWxlIGlzIGZvdW5kLCBzbwogICAgICogYW4gb2Zmc2V0IG9mIDIgaXMgdGFrZW4gb2ZmIDMsIGFuZCBBbmd1bGFyIHVzZXMgMSB0byBkZWNpZGUgdGhlIHBsdXJhbCBjYXRlZ29yeS4KICAgICAqIEluIHRoaXMgY2FzZSwgcGx1cmFsIGNhdGVnb3J5ICdvbmUnIGlzIG1hdGNoZWQgYW5kICJKb2huLCBNYXJyeSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZyIKICAgICAqIGlzIHNob3duLgogICAgICoKICAgICAqIE5vdGUgdGhhdCB3aGVuIHlvdSBzcGVjaWZ5IG9mZnNldHMsIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvcgogICAgICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICAgICAqIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvciAwLCAxLCAyIGFuZCAzLiBZb3UgbXVzdCBhbHNvIHByb3ZpZGUgcGx1cmFsIHN0cmluZ3MgZm9yCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllcyAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xleHByZXNzaW9ufSBjb3VudCBUaGUgdmFyaWFibGUgdG8gYmUgYm91bmRlZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb2Rpbmcgc3RyaW5ncy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjEgPSAnSWdvcic7CiAgICAgICAgICAgICRzY29wZS5wZXJzb24yID0gJ01pc2tvJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIHNpbXBsZSBwbHVyYWxpemF0aW9uIHJ1bGVzIGZvciBlbiBsb2NhbGUgLS0tPgogICAgIFdpdGhvdXQgT2Zmc2V0OgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT48YnI+CgogICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgIFdpdGggT2Zmc2V0KDIpOgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzEgcGVyc29uIGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yIGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzAnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgYW5kIE1pc2tvIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCczJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCczIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCc0IHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYmluZGVkIG5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjEnKS5lbnRlcignRGknKTsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb24yJykuZW50ZXIoJ1ZvanRhJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBCUkFDRSA9IC97fS9nOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgdmFyIG51bWJlckV4cCA9IGF0dHIuY291bnQsCiAgICAgICAgICAgICAgICAgICAgd2hlbkV4cCA9IGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB0aGlzIGlzIGJlY2F1c2Ugd2UgaGF2ZSB7e319IGluIGF0dHJzCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gYXR0ci5vZmZzZXQgfHwgMCwKICAgICAgICAgICAgICAgICAgICB3aGVucyA9IHNjb3BlLiRldmFsKHdoZW5FeHApLAogICAgICAgICAgICAgICAgICAgIHdoZW5zRXhwRm5zID0ge30sCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCk7CgogICAgICAgICAgICAgICAgZm9yRWFjaCh3aGVucywgZnVuY3Rpb24oZXhwcmVzc2lvbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnNba2V5XSA9CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCArIGVuZFN5bWJvbCkpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiBleHBsaWNpdCBudW1iZXIgcnVsZSBzdWNoIGFzIDEsIDIsIDMuLi4gaXMgZGVmaW5lZCwganVzdCB1c2UgaXQuIE90aGVyd2lzZSwKICAgICAgICAgICAgICAgICAgICAgICAgLy9jaGVjayBpdCBhZ2FpbnN0IHBsdXJhbGl6YXRpb24gcnVsZXMgaW4gJGxvY2FsZSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuc0V4cEZuc1t2YWx1ZV0oc2NvcGUsIGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dChuZXdWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdSZXBlYXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAgICAgKiBpbnN0YW5jZSBnZXRzIGl0cyBvd24gc2NvcGUsIHdoZXJlIHRoZSBnaXZlbiBsb29wIHZhcmlhYmxlIGlzIHNldCB0byB0aGUgY3VycmVudCBjb2xsZWN0aW9uIGl0ZW0sCiAgICAgKiBhbmQgYCRpbmRleGAgaXMgc2V0IHRvIHRoZSBpdGVtIGluZGV4IG9yIGtleS4KICAgICAqCiAgICAgKiBTcGVjaWFsIHByb3BlcnRpZXMgYXJlIGV4cG9zZWQgb24gdGhlIGxvY2FsIHNjb3BlIG9mIGVhY2ggdGVtcGxhdGUgaW5zdGFuY2UsIGluY2x1ZGluZzoKICAgICAqCiAgICAgKiAgICogYCRpbmRleGAg4oCTIGB7bnVtYmVyfWAg4oCTIGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpCiAgICAgKiAgICogYCRmaXJzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGZpcnN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJG1pZGRsZWAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJGxhc3RgIOKAkyBge2Jvb2xlYW59YCDigJMgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUd28KICAgICAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICAgICAqCiAgICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogICAgICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYHRyYWNrIGluIGNkLnRyYWNrc2AuCiAgICAgKgogICAgICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogICAgICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgICAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBhZ2U6MjV9LCB7bmFtZTonTWFyeScsIGFnZToyOH1dIj4KICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyI+CiAgICAgW3t7JGluZGV4ICsgMX19XSB7e2ZyaWVuZC5uYW1lfX0gd2hvIGlzIHt7ZnJpZW5kLmFnZX19IHllYXJzIG9sZC4KICAgICA8L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1yZXBlYXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICB2YXIgciA9IHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLnJlcGVhdGVyKCd1bCBsaScpOwogICAgICAgICAgIGV4cGVjdChyLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgICAgZXhwZWN0KHIucm93KDApKS50b0VxdWFsKFsiMSIsIkpvaG4iLCIyNSJdKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMSkpLnRvRXF1YWwoWyIyIiwiTWFyeSIsIjI4Il0pOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdSZXBlYXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGl0ZXJTdGFydEVsZW1lbnQsIGF0dHIpewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBhdHRyLm5nUmVwZWF0OwogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKiguKylccytpblxzKyguKilccyokLyksCiAgICAgICAgICAgICAgICAgICAgbGhzLCByaHMsIHZhbHVlSWRlbnQsIGtleUlkZW50OwogICAgICAgICAgICAgICAgaWYgKCEgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgbmdSZXBlYXQgaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgYnV0IGdvdCAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxocyA9IG1hdGNoWzFdOwogICAgICAgICAgICAgICAgcmhzID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgICBtYXRjaCA9IGxocy5tYXRjaCgvXig/OihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSkkLyk7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIidpdGVtJyBpbiAnaXRlbSBpbiBjb2xsZWN0aW9uJyBzaG91bGQgYmUgaWRlbnRpZmllciBvciAoa2V5LCB2YWx1ZSkgYnV0IGdvdCAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgIGxocyArICInLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWVJZGVudCA9IG1hdGNoWzNdIHx8IG1hdGNoWzFdOwogICAgICAgICAgICAgICAga2V5SWRlbnQgPSBtYXRjaFsyXTsKCiAgICAgICAgICAgICAgICAvLyBTdG9yZSBhIGxpc3Qgb2YgZWxlbWVudHMgZnJvbSBwcmV2aW91cyBydW4uIFRoaXMgaXMgYSBoYXNoIHdoZXJlIGtleSBpcyB0aGUgaXRlbSBmcm9tIHRoZQogICAgICAgICAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgLy8gICAtIHNjb3BlOiBib3VuZCBzY29wZQogICAgICAgICAgICAgICAgLy8gICAtIGVsZW1lbnQ6IHByZXZpb3VzIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIGFuIGFycmF5IG9mIHRoZXNlIG9iamVjdHMgc2luY2UgdGhlIHNhbWUgb2JqZWN0IGNhbiBiZSByZXR1cm5lZCBmcm9tIHRoZSBpdGVyYXRvci4KICAgICAgICAgICAgICAgIC8vIFdlIGV4cGVjdCB0aGlzIHRvIGJlIGEgcmFyZSBjYXNlLgogICAgICAgICAgICAgICAgdmFyIGxhc3RPcmRlciA9IG5ldyBIYXNoUXVldWVNYXAoKTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdSZXBlYXRXYXRjaChzY29wZSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBzY29wZS4kZXZhbChyaHMpLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBpdGVyU3RhcnRFbGVtZW50LCAgICAgLy8gY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgbm9kZQogICAgICAgICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdE9yZGVyIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGxhc3RPcmRlciBvbiB0aGUgbmV4dCBpdGVyYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlciA9IG5ldyBIYXNoUXVldWVNYXAoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlCb3VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDsgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpbmRleH0KCgoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnNvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSA9IGNvbGxlY3Rpb24gfHwgW107CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kID0gYXJyYXkubGVuZ3RoLTE7CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGFycmF5KSA/IGluZGV4IDogYXJyYXlbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QgPSBsYXN0T3JkZXIuc2hpZnQodmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYWxyZWFkeSBzZWVuIHRoaXMgb2JqZWN0LCB0aGVuIHdlIG5lZWQgdG8gcmV1c2UgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHNjb3BlL2VsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBsYXN0LnNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gbGFzdC5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBsYXN0LmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV4aXN0aW5nIGl0ZW0gd2hpY2ggZ290IG1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdC5pbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWF5IGJlIGEgbm9vcCwgaWYgdGhlIGVsZW1lbnQgaXMgbmV4dCwgYnV0IEkgZG9uJ3Qga25vdyBvZiBhIGdvb2Qgd2F5IHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmlndXJlIHRoaXMgb3V0LCAgc2luY2UgaXQgd291bGQgcmVxdWlyZSBleHRyYSBET00gYWNjZXNzLCBzbyBsZXQncyBqdXN0IGhvcGUgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBicm93c2VycyByZWFsaXplcyB0aGF0IGl0IGlzIG5vb3AsIGFuZCB0cmVhdHMgaXQgYXMgc3VjaC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IuYWZ0ZXIobGFzdC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBsYXN0LmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcgaXRlbSB3aGljaCB3ZSBkb24ndCBrbm93IGFib3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlW3ZhbHVlSWRlbnRdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlJZGVudCkgY2hpbGRTY29wZVtrZXlJZGVudF0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGluZGV4ID0gaW5kZXg7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGxhc3QgPSAoaW5kZXggPT09IGFycmF5Qm91bmQpOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRtaWRkbGUgPSAhKGNoaWxkU2NvcGUuJGZpcnN0IHx8IGNoaWxkU2NvcGUuJGxhc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rZXIoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGNoaWxkU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IChjdXJzb3IgPSBjbG9uZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vc2hyaW5rIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbGFzdE9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0T3JkZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBsYXN0T3JkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJyYXkucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsYXN0T3JkZXIgPSBuZXh0T3JkZXI7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1Nob3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdTaG93YCBhbmQgYG5nSGlkZWAgZGlyZWN0aXZlcyBzaG93IG9yIGhpZGUgYSBwb3J0aW9uIG9mIHRoZSBET00gdHJlZSAoSFRNTCkKICAgICAqIGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU2hvdyBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5CiAgICAgKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIFNob3c6IDxzcGFuIG5nLXNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+IDxici8+CiAgICAgSGlkZTogPHNwYW4gbmctaGlkZT0iY2hlY2tlZCI+SSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLjwvc3Bhbj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CgogICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwovL1RPRE8obWlza28pOiByZWZhY3RvciB0byByZW1vdmUgZWxlbWVudCBmcm9tIHRoZSBET00KICAgIHZhciBuZ1Nob3dEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cil7CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdkaXNwbGF5JywgdG9Cb29sZWFuKHZhbHVlKSA/ICcnIDogJ25vbmUnKTsKICAgICAgICB9KTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0hpZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdIaWRlYCBhbmQgYG5nU2hvd2AgZGlyZWN0aXZlcyBoaWRlIG9yIHNob3cgYSBwb3J0aW9uIG9mIHRoZSBET00gdHJlZSAoSFRNTCkKICAgICAqIGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSGlkZSBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5IHRoZW4KICAgICAqICAgICB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIFNob3c6IDxzcGFuIG5nLXNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdSBjaGVja2JveCBpcyBjaGVja2VkPzwvc3Bhbj4gPGJyLz4KICAgICBIaWRlOiA8c3BhbiBuZy1oaWRlPSJjaGVja2VkIj5JIGhpZGUgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwoKICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KLy9UT0RPKG1pc2tvKTogcmVmYWN0b3IgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSB0aGUgRE9NCiAgICB2YXIgbmdIaWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAgICAgICBlbGVtZW50LmNzcygnZGlzcGxheScsIHRvQm9vbGVhbih2YWx1ZSkgPyAnbm9uZScgOiAnJyk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N0eWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICAgICAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAgICAgKiAgICAgIGtleXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0ic2V0IiBuZy1jbGljaz0ibXlTdHlsZT17Y29sb3I6J3JlZCd9Ij4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVN0eWxlPXt9Ij4KICAgICA8YnIvPgogICAgIDxzcGFuIG5nLXN0eWxlPSJteVN0eWxlIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICA8cHJlPm15U3R5bGU9e3tteVN0eWxlfX08L3ByZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICBzcGFuIHsKICAgICAgICAgY29sb3I6IGJsYWNrOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdHlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b25bdmFsdWU9c2V0XScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMjU1LCAwLCAwKScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1N0eWxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgICAgICAgICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24odmFsLCBzdHlsZSkgeyBlbGVtZW50LmNzcyhzdHlsZSwgJycpO30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXdTdHlsZXMpIGVsZW1lbnQuY3NzKG5ld1N0eWxlcyk7CiAgICAgICAgfSwgdHJ1ZSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N3aXRjaAogICAgICogQHJlc3RyaWN0IEVBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb25kaXRpb25hbGx5IGNoYW5nZSB0aGUgRE9NIHN0cnVjdHVyZS4KICAgICAqCiAgICAgKiBAdXNhZ2UKICAgICAqIDxBTlkgbmctc3dpdGNoPSJleHByZXNzaW9uIj4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvQU5ZPgogICAgICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMiI+Li4uPC9BTlk+CiAgICAgKiAgIC4uLgogICAgICogICA8QU5ZIG5nLXN3aXRjaC1kZWZhdWx0Pi4uLjwvQU5ZPgogICAgICogPC9BTlk+CiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKiBAcGFyYW0geyp9IG5nU3dpdGNofG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmctc3dpdGNoLXdoZW48L3R0Pi4KICAgICAqIEBwYXJhbURlc2NyaXB0aW9uCiAgICAgKiBPbiBjaGlsZCBlbG1lbnRzIGFkZDoKICAgICAqCiAgICAgKiAqIGBuZ1N3aXRjaFdoZW5gOiB0aGUgY2FzZSBzdGF0ZW1lbnQgdG8gbWF0Y2ggYWdhaW5zdC4gSWYgbWF0Y2ggdGhlbiB0aGlzCiAgICAgKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuCiAgICAgKiAqIGBuZ1N3aXRjaERlZmF1bHRgOiB0aGUgZGVmYXVsdCBjYXNlIHdoZW4gbm8gb3RoZXIgY2Fzc2VzIG1hdGNoLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLml0ZW1zID0gWydzZXR0aW5ncycsICdob21lJywgJ290aGVyJ107CiAgICAgICAgICAgICRzY29wZS5zZWxlY3Rpb24gPSAkc2NvcGUuaXRlbXNbMF07CiAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJzZWxlY3Rpb24iIG5nLW9wdGlvbnM9Iml0ZW0gZm9yIGl0ZW0gaW4gaXRlbXMiPgogICAgIDwvc2VsZWN0PgogICAgIDx0dD5zZWxlY3Rpb249e3tzZWxlY3Rpb259fTwvdHQ+CiAgICAgPGhyLz4KICAgICA8ZGl2IG5nLXN3aXRjaCBvbj0ic2VsZWN0aW9uIiA+CiAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgIDxzcGFuIG5nLXN3aXRjaC13aGVuPSJob21lIj5Ib21lIFNwYW48L3NwYW4+CiAgICAgPHNwYW4gbmctc3dpdGNoLWRlZmF1bHQ+ZGVmYXVsdDwvc3Bhbj4KICAgICA8L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvU2V0dGluZ3MgRGl2Lyk7CiAgICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignaG9tZScpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL0hvbWUgU3Bhbi8pOwogICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgc2VsZWN0IGRlYWZhdWx0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHNlbGVjdCgnc2VsZWN0aW9uJykub3B0aW9uKCdvdGhlcicpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL2RlZmF1bHQvKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgTkdfU1dJVENIID0gJ25nLXN3aXRjaCc7CiAgICB2YXIgbmdTd2l0Y2hEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICByZXF1aXJlOiAnbmdTd2l0Y2gnLAogICAgICAgIC8vIGFza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgICAgICAgICB0aGlzLmNhc2VzID0ge307CiAgICAgICAgfV0sCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgdmFyIHdhdGNoRXhwciA9IGF0dHIubmdTd2l0Y2ggfHwgYXR0ci5vbiwKICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCwKICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGU7CgogICAgICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBzZWxlY3RlZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoc2VsZWN0ZWRUcmFuc2NsdWRlID0gY3RybC5jYXNlc1snIScgKyB2YWx1ZV0gfHwgY3RybC5jYXNlc1snPyddKSkgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIuY2hhbmdlKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZShzZWxlY3RlZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBjYXNlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gdHJhbnNjbHVkZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snPyddID0gdHJhbnNjbHVkZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1RyYW5zY2x1ZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEluc2VydCB0aGUgdHJhbnNjbHVkZWQgRE9NIGhlcmUuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnRpdGxlID0gJ0xvcmVtIElwc3VtJzsKICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QgcXVpIGRvbG9yZW0gaXBzdW0gcXVpYSBkb2xvci4uLic7CiAgICAgICAgIH0KCiAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgIHNjb3BlOiB7IHRpdGxlOidAJyB9LAogICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAnPGRpdiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogZ3JheSI+e3t0aXRsZX19PC9kaXY+JyArCiAgICAgJzxkaXYgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAnPC9kaXY+JwogICAgIH07CiAgICAgfSk7CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgbmctbW9kZWw9InRpdGxlIj48YnI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ0ZXh0Ij48L3RleHRhcmVhPiA8YnIvPgogICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ3RpdGxlJykuZW50ZXIoJ1RJVExFJyk7CiAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdURVhUJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndGl0bGUnKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ1RFWFQnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICBjb250cm9sbGVyOiBbJyR0cmFuc2NsdWRlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHRyYW5zY2x1ZGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3CiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdWaWV3YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGNvbXBsZW1lbnRzIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZSBieQogICAgICogaW5jbHVkaW5nIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvZiB0aGUgY3VycmVudCByb3V0ZSBpbnRvIHRoZSBtYWluIGxheW91dCAoYGluZGV4Lmh0bWxgKSBmaWxlLgogICAgICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogICAgICogY29uZmlndXJhdGlvbiBvZiB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgIENob29zZToKICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgIDxociAvPgoKICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdib29rLmh0bWwnLAogICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bAogICAgICAgICAgfSk7CiAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQ2hhcHRlckNudGwKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpOwogICAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAkc2NvcGUuJGxvY2F0aW9uID0gJGxvY2F0aW9uOwogICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJCb29rQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KCiAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCdhOmNvbnRhaW5zKCJNb2J5OiBDaDEiKScpLmNsaWNrKCk7CiAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9Cb29rIElkXDogTW9ieS8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3IyR2aWV3Q29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nVmlldyBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nVmlldyBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdWaWV3RGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcm91dGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsCiAgICAgICAgJyRjb250cm9sbGVyJywKICAgICAgICBmdW5jdGlvbigkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkcm91dGUsICAgJGFuY2hvclNjcm9sbCwgICAkY29tcGlsZSwKICAgICAgICAgICAgICAgICAkY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0U2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS4kb24oJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZSgpOwoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVzdHJveUxhc3RTY29wZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RTY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRlbnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lMYXN0U2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9ICRyb3V0ZS5jdXJyZW50ICYmICRyb3V0ZS5jdXJyZW50LmxvY2FscywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gbG9jYWxzICYmIGxvY2Fscy4kdGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95TGFzdFNjb3BlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmsgPSAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSAkcm91dGUuY3VycmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZSA9IGN1cnJlbnQuc2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzLiRzY29wZSA9IGxhc3RTY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIoY3VycmVudC5jb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobGFzdFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZW1pdCgnJHZpZXdDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGV2YWwob25sb2FkRXhwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAkYW5jaG9yU2Nyb2xsIG1pZ2h0IGxpc3RlbiBvbiBldmVudC4uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2NyaXB0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBMb2FkIGNvbnRlbnQgb2YgYSBzY3JpcHQgdGFnLCB3aXRoIHR5cGUgYHRleHQvbmctdGVtcGxhdGVgLCBpbnRvIGAkdGVtcGxhdGVDYWNoZWAsIHNvIHRoYXQgdGhlCiAgICAgKiB0ZW1wbGF0ZSBjYW4gYmUgdXNlZCBieSBgbmdJbmNsdWRlYCwgYG5nVmlld2Agb3IgZGlyZWN0aXZlIHRlbXBsYXRlcy4KICAgICAqCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICogQHBhcmFtIHsndGV4dC9uZy10ZW1wbGF0ZSd9IHR5cGUgbXVzdCBiZSBzZXQgdG8gYCd0ZXh0L25nLXRlbXBsYXRlJ2AKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSIvdHBsLmh0bWwiPgogICAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICAgIDwvc2NyaXB0PgoKICAgICA8YSBuZy1jbGljaz0iY3VycmVudFRwbD0nL3RwbC5odG1sJyIgaWQ9InRwbC1saW5rIj5Mb2FkIGlubGluZWQgdGVtcGxhdGU8L2E+CiAgICAgPGRpdiBpZD0idHBsLWNvbnRlbnQiIG5nLWluY2x1ZGUgc3JjPSJjdXJyZW50VHBsIj48L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUgZGVmaW5lZCBpbnNpZGUgc2NyaXB0IHRhZycsIGZ1bmN0aW9uKCkgewogICAgICAgIGVsZW1lbnQoJyN0cGwtbGluaycpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyN0cGwtY29udGVudCcpLnRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0aGUgdGVtcGxhdGUvKTsKICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIHNjcmlwdERpcmVjdGl2ZSA9IFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2VsZWN0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogIyBgbmdPcHRpb25zYAogICAgICoKICAgICAqIE9wdGlvbmFsbHkgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAgICAgKiBlbGVtZW50cyBmb3IgYSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgYW4gYXJyYXkgb3IgYW4gb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICAgKiBgbmdPcHRpb25zYCBleHByZXNzaW9uLgogICAgICoKICAgICAqIFdoZW4gYW4gaXRlbSBpbiB0aGUgYDxzZWxlY3Q+YCBtZW51IGlzIHNlbGVjdGVkLCB0aGUgdmFsdWUgb2YgYXJyYXkgZWxlbWVudCBvciBvYmplY3QgcHJvcGVydHkKICAgICAqIHJlcHJlc2VudGVkIGJ5IHRoZSBzZWxlY3RlZCBvcHRpb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgaWRlbnRpZmllZCBieSB0aGUgYG5nTW9kZWxgCiAgICAgKiBkaXJlY3RpdmUgb2YgdGhlIHBhcmVudCBzZWxlY3QgZWxlbWVudC4KICAgICAqCiAgICAgKiBPcHRpb25hbGx5LCBhIHNpbmdsZSBoYXJkLWNvZGVkIGA8b3B0aW9uPmAgZWxlbWVudCwgd2l0aCB0aGUgdmFsdWUgc2V0IHRvIGFuIGVtcHR5IHN0cmluZywgY2FuCiAgICAgKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICAgICAqIG9wdGlvbi4gU2VlIGV4YW1wbGUgYmVsb3cgZm9yIGRlbW9uc3RyYXRpb24uCiAgICAgKgogICAgICogTm90ZTogYG5nT3B0aW9uc2AgcHJvdmlkZXMgaXRlcmF0b3IgZmFjaWxpdHkgZm9yIGA8b3B0aW9uPmAgZWxlbWVudCB3aGljaCBzaG91bGQgYmUgdXNlZCBpbnN0ZWFkCiAgICAgKiBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSB3aGVuIHlvdSB3YW50IHRoZQogICAgICogYHNlbGVjdGAgbW9kZWwgdG8gYmUgYm91bmQgdG8gYSBub24tc3RyaW5nIHZhbHVlLiBUaGlzIGlzIGJlY2F1c2UgYW4gb3B0aW9uIGVsZW1lbnQgY2FuIGN1cnJlbnRseQogICAgICogYmUgYm91bmQgdG8gc3RyaW5nIHZhbHVlcyBvbmx5LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgVGhlIGNvbnRyb2wgaXMgY29uc2lkZXJlZCB2YWxpZCBvbmx5IGlmIHZhbHVlIGlzIGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7Y29tcHJlaGVuc2lvbl9leHByZXNzaW9uPX0gbmdPcHRpb25zIGluIG9uZSBvZiB0aGUgZm9sbG93aW5nIGZvcm1zOgogICAgICoKICAgICAqICAgKiBmb3IgYXJyYXkgZGF0YSBzb3VyY2VzOgogICAgICogICAgICogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBsYWJlbGAgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAKICAgICAqICAgICAgICAgKipgZm9yYCBgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICoKICAgICAqIFdoZXJlOgogICAgICoKICAgICAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqICAgKiBgdmFsdWVgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGVhY2ggaXRlbSBpbiB0aGUgYGFycmF5YCBvciBlYWNoIHByb3BlcnR5IHZhbHVlCiAgICAgKiAgICAgIG9mIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICAgKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICAgKiAgICogYGxhYmVsYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB0aGUgbGFiZWwgZm9yIGA8b3B0aW9uPmAgZWxlbWVudC4gVGhlCiAgICAgKiAgICAgYGV4cHJlc3Npb25gIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLgogICAgICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICAgICAqICAgICAgZWxlbWVudC4gSWYgbm90IHNwZWNpZmllZCwgYHNlbGVjdGAgZXhwcmVzc2lvbiB3aWxsIGRlZmF1bHQgdG8gYHZhbHVlYC4KICAgICAqICAgKiBgZ3JvdXBgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHVzZWQgdG8gZ3JvdXAgb3B0aW9ucyB1c2luZyB0aGUgYDxvcHRncm91cD5gCiAgICAgKiAgICAgIERPTSBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gTXlDbnRybCgkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgIHtuYW1lOidibGFjaycsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid3aGl0ZScsIHNoYWRlOidsaWdodCd9LAogICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J2JsdWUnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZToneWVsbG93Jywgc2hhZGU6J2xpZ2h0J30KICAgICAgICAgIF07CiAgICAgICAgICAkc2NvcGUuY29sb3IgPSAkc2NvcGUuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNeUNudHJsIj4KICAgICA8dWw+CiAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9ImNvbG9yLm5hbWUiPgogICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMuc3BsaWNlKCRpbmRleCwgMSkiPlg8L2E+XQogICAgIDwvbGk+CiAgICAgPGxpPgogICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMucHVzaCh7fSkiPmFkZDwvYT5dCiAgICAgPC9saT4KICAgICA8L3VsPgogICAgIDxoci8+CiAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgIENvbG9yIChudWxsIGFsbG93ZWQpOgogICAgIDxzcGFuICBjbGFzcz0ibnVsbGFibGUiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob3NlIGNvbG9yIC0tPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPC9zcGFuPjxici8+CgogICAgIENvbG9yIGdyb3VwZWQgYnkgc2hhZGU6CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29sb3IiIG5nLW9wdGlvbnM9ImMubmFtZSBncm91cCBieSBjLnNoYWRlIGZvciBjIGluIGNvbG9ycyI+CiAgICAgPC9zZWxlY3Q+PGJyLz4KCgogICAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICA8aHIvPgogICAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOmNvbG9yfSAgfX0KICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICBuZy1zdHlsZT0ieydiYWNrZ3JvdW5kLWNvbG9yJzpjb2xvci5uYW1lfSI+CiAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1vcHRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgncmVkJyk7CiAgICAgICAgICAgc2VsZWN0KCdjb2xvcicpLm9wdGlvbignMCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgdXNpbmcoJy5udWxsYWJsZScpLnNlbGVjdCgnY29sb3InKS5vcHRpb24oJycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ251bGwnKTsKICAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKICAgIHZhciBuZ09wdGlvbnNEaXJlY3RpdmUgPSB2YWx1ZUZuKHsgdGVybWluYWw6IHRydWUgfSk7CiAgICB2YXIgc2VsZWN0RGlyZWN0aXZlID0gWyckY29tcGlsZScsICckcGFyc2UnLCBmdW5jdGlvbigkY29tcGlsZSwgICAkcGFyc2UpIHsKICAgICAgICAvLzAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3NzAKICAgICAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKiguKj8pKD86XHMrYXNccysoLio/KSk/KD86XHMrZ3JvdXBccytieVxzKyguKikpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd1xkXSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XGRdKilccyosXHMqKFtcJFx3XVtcJFx3XGRdKilccypcKSkpXHMraW5ccysoLiopJC8sCiAgICAgICAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRlbGVtZW50LCAkc2NvcGUsICRhdHRycykgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNNYXAgPSB7fSwKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybCA9IG51bGxNb2RlbEN0cmwsCiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiwKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uOwoKCiAgICAgICAgICAgICAgICBzZWxmLmRhdGFib3VuZCA9ICRhdHRycy5uZ01vZGVsOwoKCiAgICAgICAgICAgICAgICBzZWxmLmluaXQgPSBmdW5jdGlvbihuZ01vZGVsQ3RybF8sIG51bGxPcHRpb25fLCB1bmtub3duT3B0aW9uXykgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uID0gdW5rbm93bk9wdGlvbl87CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuYWRkT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNPcHRpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zTWFwW3ZhbHVlXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyVW5rbm93bk9wdGlvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnByZXBlbmQodW5rbm93bk9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBzZWxmLmhhc09wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZGlzYWJsZSB1bmtub3duIG9wdGlvbiBzbyB0aGF0IHdlIGRvbid0IGRvIHdvcmsgd2hlbiB0aGUgd2hvbGUgc2VsZWN0IGlzIGJlaW5nIGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IG5vb3A7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICAgIC8vIGlmIG5nTW9kZWwgaXMgbm90IGRlZmluZWQsIHdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcKICAgICAgICAgICAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gY3RybHNbMV0sCiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBhdHRyLm11bHRpcGxlLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNFeHAgPSBhdHRyLm5nT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uID0gZmFsc2UsIC8vIGlmIGZhbHNlLCB1c2VyIHdpbGwgbm90IGJlIGFibGUgdG8gc2VsZWN0IGl0ICh1c2VkIGJ5IG5nT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiwKICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgICAgICAgICAgICBvcHRpb25UZW1wbGF0ZSA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSksCiAgICAgICAgICAgICAgICAgICAgb3B0R3JvdXBUZW1wbGF0ZSA9anFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgIC8vIGZpbmQgIm51bGwiIG9wdGlvbgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuaW5pdChuZ01vZGVsQ3RybCwgbnVsbE9wdGlvbiwgdW5rbm93bk9wdGlvbik7CgogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUgJiYgKGF0dHIucmVxdWlyZWQgfHwgYXR0ci5uZ1JlcXVpcmVkKSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXF1aXJlZFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCAhYXR0ci5yZXF1aXJlZCB8fCAodmFsdWUgJiYgdmFsdWUubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kcGFyc2Vycy5wdXNoKHJlcXVpcmVkVmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kZm9ybWF0dGVycy51bnNoaWZ0KHJlcXVpcmVkVmFsaWRhdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRWYWxpZGF0b3IobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNFeHApIE9wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlKSBNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2luZ2xlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBuZ01vZGVsQ3RybCwgc2VsZWN0Q3RybCkgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE11bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaXNEZWZpbmVkKGl0ZW1zLmdldChvcHRpb24udmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBkbyBpdCBvbiBlYWNoIHdhdGNoIHNpbmNlIG5nTW9kZWwgd2F0Y2hlcyByZWZlcmVuY2UsIGJ1dAogICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gd29yayBvZiBhbiBhcnJheSwgc28gd2UgbmVlZCB0byBzZWUgaWYgYW55dGhpbmcgd2FzIGluc2VydGVkL3JlbW92ZWQKICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gc2VsZWN0TXVsdGlwbGVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlcXVhbHMobGFzdFZpZXcsIGN0cmwuJHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWaWV3ID0gY29weShjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gT3B0aW9ucyhzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCEgKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIG5nT3B0aW9ucyBpbiBmb3JtIG9mICdfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCBnb3QgJyIgKyBvcHRpb25zRXhwICsgIicuIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFtbe2VsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOicnfV1dOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuaHRtbCgnJykgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGxhYmVsIGZyb20gdGhlIGVsZW1lbnQuIHd0Zj8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCBvcHRpb25FbGVtZW50LCBpbmRleCwgZ3JvdXBJbmRleCwgbGVuZ3RoLCBncm91cExlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleU5hbWUpIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIgPSByZW5kZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8odm9qdGEpOiBjYW4ndCB3ZSBvcHRpbWl6ZSB0aGlzID8KICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2gocmVuZGVyKTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXBzID0geycnOltdfSwgLy8gVGVtcG9yYXJ5IGxvY2F0aW9uIGZvciB0aGUgb3B0aW9uIGdyb3VwcyBiZWZvcmUgd2UgcmVuZGVyIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMgPSBbJyddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCwgZXhpc3RpbmdPcHRpb25zLCBleGlzdGluZ09wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cyA9IGtleU5hbWUgPyBzb3J0ZWRLZXlzKHZhbHVlcykgOiB2YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cExlbmd0aCwgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCwgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBmYWxzZSwgLy8gbm90aGluZyBpcyBzZWxlY3RlZCB5ZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5TmFtZSA/IGxvY2Fsc1trZXlOYW1lXT1rZXlzW2luZGV4XTppbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWRTZXQucmVtb3ZlKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4LCAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6JycsIGxhYmVsOicnLCBzZWxlY3RlZDohc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonPycsIGxhYmVsOicnLCBzZWxlY3RlZDp0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25Hcm91cFtpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCsxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucG9wKCkuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoID4gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgICAgICAgICAgYWRkT3B0aW9uOiBub29wLAogICAgICAgICAgICByZW1vdmVPcHRpb246IG5vb3AKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LnRleHQoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucGFyZW50KCkuZGF0YShzZWxlY3RDdHJsTmFtZSk7IC8vIGluIGNhc2Ugd2UgYXJlIGluIG9wdGdyb3VwCgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RDdHJsICYmIHNlbGVjdEN0cmwuZGF0YWJvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBzb21lIHJlYXNvbiBPcGVyYSBkZWZhdWx0cyB0byB0cnVlIGFuZCBpZiBub3Qgb3ZlcnJpZGRlbiB0aGlzIG1lc3NlcyB1cCB0aGUgcmVwZWF0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIHZpZXcgdG8gZHJpdmUgdGhlIGluaXRpYWxpemF0aW9uIG9mIHRoZSBtb2RlbCBhbnl3YXkuCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybCA9IG51bGxTZWxlY3RDdHJsOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlV2F0Y2hBY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBuZXdWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1ZhbCAhPT0gb2xkVmFsKSBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24obmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVybWluYWw6IHRydWUKICAgIH0pOwoKICAgIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUgYW5ndWxhci5lbGVtZW50KCkucmVhZCgpCiAgICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgICBiaW5kSlF1ZXJ5KCk7CgogICAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICAgIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9ha3tkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9bmdcXDpmb3Jte2Rpc3BsYXk6YmxvY2s7fTwvc3R5bGU+Jyk7",
                "body": "LyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4wLjgKICogKGMpIDIwMTAtMjAxMiBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7fTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFVwcGVyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b1VwcGVyQ2FzZSgpIDogc3RyaW5nO307CgoKICAgIHZhciBtYW51YWxMb3dlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7fSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bYS16XS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpO30pCiAgICAgICAgICAgIDogczsKICAgIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICAgIGlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICAgIH0KCgogICAgdmFyIC8qKiBob2xkcyBtYWpvciB2ZXJzaW9uIG51bWJlciBmb3IgSUUgb3IgTmFOIGZvciByZWFsIGJyb3dzZXJzICovCiAgICAgICAgICAgIG1zaWUgICAgICAgICAgICAgID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSksCiAgICAgICAganFMaXRlLCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZyBzaW5jZSBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGFmdGVyIHVzLgogICAgICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgICAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgICAgIHB1c2ggICAgICAgICAgICAgID0gW10ucHVzaCwKICAgICAgICB0b1N0cmluZyAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgogICAgICAgIC8qKiBAbmFtZSBhbmd1bGFyICovCiAgICAgICAgICAgIGFuZ3VsYXIgICAgICAgICAgID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddOwoKCiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9iagogICAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGBvYmpgIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2Ugb2JqZWN0IChOb2RlTGlzdCwgQXJndW1lbnRzLCAuLi4pCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogICAgICAgIGlmICghb2JqIHx8ICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicpKSByZXR1cm4gZmFsc2U7CgogICAgICAgIC8vIFdlIGhhdmUgb24gb2JqZWN0IHdoaWNoIGhhcyBsZW5ndGggcHJvcGVydHkuIFNob3VsZCB3ZSB0cmVhdCBpdCBhcyBhcnJheT8KICAgICAgICBpZiAodHlwZW9mIG9iai5oYXNPd25Qcm9wZXJ0eSAhPSAnZnVuY3Rpb24nICYmCiAgICAgICAgICAgIHR5cGVvZiBvYmouY29uc3RydWN0b3IgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAvLyBUaGlzIGlzIGhlcmUgZm9yIElFODogaXQgaXMgYSBib2d1cyBvYmplY3QgdHJlYXQgaXQgYXMgYXJyYXk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgSlFMaXRlIHx8ICAgICAgICAgICAgICAgICAgICAgIC8vIEpRTGl0ZQogICAgICAgICAgICAgICAgKGpRdWVyeSAmJiBvYmogaW5zdGFuY2VvZiBqUXVlcnkpIHx8ICAgICAgICAgIC8vIGpRdWVyeQogICAgICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChvYmopICE9PSAnW29iamVjdCBPYmplY3RdJyB8fCAgIC8vIHNvbWUgYnJvd3NlciBuYXRpdmUgb2JqZWN0CiAgICAgICAgICAgICAgICB0eXBlb2Ygb2JqLmNhbGxlZSA9PT0gJ2Z1bmN0aW9uJzsgICAgICAgICAgICAgIC8vIGFyZ3VtZW50cyAob24gSUU4IGxvb2tzIGxpa2UgcmVndWxhciBvYmopCiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgICAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5KWAsIHdoZXJlIGB2YWx1ZWAKICAgICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIHdhcyBwcmV2aW91c2x5IGtub3duIGFzIGBhbmd1bGFyLmZvcmVhY2hgLgogICAgICoKICAgICA8cHJlPgogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5OwogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSl7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmIG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgICAgICAgICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBvYmoubGVuZ3RoOyBrZXkrKykKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gc29ydGVkS2V5cyhvYmopIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ga2V5cy5zb3J0KCk7CiAgICB9CgogICAgZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzOwogICAgfQoKCiAgICAvKioKICAgICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSkgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZShpbmRleCkgewogICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGRpZ2l0ID09IDU3IC8qJzknKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICAgICAgICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHVpZC51bnNoaWZ0KCcwJyk7CiAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTZXQgb3IgY2xlYXIgdGhlIGhhc2hrZXkgZm9yIGFuIG9iamVjdC4KICAgICAqIEBwYXJhbSBvYmogb2JqZWN0CiAgICAgKiBAcGFyYW0gaCB0aGUgaGFzaGtleSAoIXRydXRoeSB0byBkZWxldGUgdGhlIGhhc2hrZXkpCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldEhhc2hLZXkob2JqLCBoKSB7CiAgICAgICAgaWYgKGgpIHsKICAgICAgICAgICAgb2JqLiQkaGFzaEtleSA9IGg7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBkZWxldGUgb2JqLiQkaGFzaEtleTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZXh0ZW5kCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV4dGVuZHMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBgZHN0YCBieSBjb3B5aW5nIGFsbCBvZiB0aGUgcHJvcGVydGllcyBmcm9tIHRoZSBgc3JjYCBvYmplY3QocykKICAgICAqIHRvIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZHN0IERlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBzcmMgU291cmNlIG9iamVjdChzKS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJlZmVyZW5jZSB0byBgZHN0YC4KICAgICAqLwogICAgZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogICAgICAgIHZhciBoID0gZHN0LiQkaGFzaEtleTsKICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNldEhhc2hLZXkoZHN0LGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpIHt9LCB7cHJvdG90eXBlOnBhcmVudH0pKSgpLCBleHRyYSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLm5vb3AKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIG5vIG9wZXJhdGlvbnMuIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiBmb28oY2FsbGJhY2spIHsKICAgICAgIHZhciByZXN1bHQgPSBjYWxjdWxhdGVSZXN1bHQoKTsKICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgfQogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkge30KICAgIG5vb3AuJGluamVjdCA9IFtdOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICAqCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGFuZ3VsYXIuaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBpZGVudGl0eSgkKSB7cmV0dXJuICQ7fQogICAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7cmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiB2YWx1ZTt9O30KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSAhPSAndW5kZWZpbmVkJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICAgICAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYE9iamVjdGAgYnV0IG5vdCBgbnVsbGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXtyZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCc7fQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnO30KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNOdW1iZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJzt9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKXsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IERhdGVdJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNBcnJheQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IEFycmF5XSc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBGdW5jdGlvbmAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nO30KCgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24gb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgUmVnRXhwYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IFJlZ0V4cF0nOwogICAgfQoKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAgICovCiAgICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdib29sZWFuJzsKICAgIH0KCgogICAgdmFyIHRyaW0gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gbmF0aXZlIHRyaW0gaXMgd2F5IGZhc3RlcjogaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhci10cmltLXRlc3QKICAgICAgICAvLyBidXQgSUUgZG9lc24ndCBoYXZlIGl0Li4uIDotKAogICAgICAgIC8vIFRPRE86IHdlIHNob3VsZCBtb3ZlIHRoaXMgaW50byBJRS9FUzUgcG9seWZpbGwKICAgICAgICBpZiAoIVN0cmluZy5wcm90b3R5cGUudHJpbSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS50cmltKCkgOiB2YWx1ZTsKICAgICAgICB9OwogICAgfSkoKTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAgICovCiAgICBmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiBub2RlICYmCiAgICAgICAgICAgIChub2RlLm5vZGVOYW1lICAvLyB3ZSBhcmUgYSBkaXJlY3QgZWxlbWVudAogICAgICAgICAgICAgICAgfHwgKG5vZGUuYmluZCAmJiBub2RlLmZpbmQpKTsgIC8vIHdlIGhhdmUgYSBiaW5kIGFuZCBmaW5kIG1ldGhvZCBwYXJ0IG9mIGpRdWVyeSBBUEkKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSBzdHIgJ2tleTEsa2V5MiwuLi4nCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7a2V5MTp0cnVlLCBrZXkyOnRydWUsIC4uLn0KICAgICAqLwogICAgZnVuY3Rpb24gbWFrZU1hcChzdHIpewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrICkKICAgICAgICAgICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKCiAgICBpZiAobXNpZSA8IDkpIHsKICAgICAgICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgICAgICAgICAgPyB1cHBlcmNhc2UoZWxlbWVudC5zY29wZU5hbWUgKyAnOicgKyBlbGVtZW50Lm5vZGVOYW1lKSA6IGVsZW1lbnQubm9kZU5hbWU7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICAgICAqIHRoZSBsZW5ndGggb2YgYSBzdHJpbmcuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW293blByb3BzT25seT1mYWxzZV0gQ291bnQgb25seSAib3duIiBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdAogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShvYmosIG93blByb3BzT25seSkgewogICAgICAgIHZhciBzaXplID0gMCwga2V5OwoKICAgICAgICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKXsKICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKQogICAgICAgICAgICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNpemU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluY2x1ZGVzKGFycmF5LCBvYmopIHsKICAgICAgICByZXR1cm4gaW5kZXhPZihhcnJheSwgb2JqKSAhPSAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICAgICAgICBpZiAoYXJyYXkuaW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2Yob2JqKTsKCiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gYXJyYXlSZW1vdmUoYXJyYXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogICAgICAgIGlmIChpbmRleCA+PTApCiAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgIk9QVElPTiI6CiAgICAgICAgICAgICAgICBjYXNlICJQUkUiOgogICAgICAgICAgICAgICAgY2FzZSAiVElUTEUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5jb3B5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAsIHdoaWNoIHNob3VsZCBiZSBhbiBvYmplY3Qgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICAgICAqICogSWYgYSBkZXN0aW5hdGlvbiBpcyBwcm92aWRlZCwgYWxsIG9mIGl0cyBlbGVtZW50cyAoZm9yIGFycmF5KSBvciBwcm9wZXJ0aWVzIChmb3Igb2JqZWN0cykKICAgICAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAgICAgKiAqIElmICBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5LCBgc291cmNlYCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICAgICAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSwgaW5jbHVkaW5nIHByaW1pdGl2ZXMsIGBudWxsYCwgYW5kIGB1bmRlZmluZWRgLgogICAgICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAgICAgKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgY29weSBvciB1cGRhdGVkIGBkZXN0aW5hdGlvbmAsIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weShzb3VyY2UsIGRlc3RpbmF0aW9uKXsKICAgICAgICBpZiAoaXNXaW5kb3coc291cmNlKSB8fCBpc1Njb3BlKHNvdXJjZSkpIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IFdpbmRvdyBvciBTY29wZSIpOwogICAgICAgIGlmICghZGVzdGluYXRpb24pIHsKICAgICAgICAgICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGF0ZShzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIHt9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBFcnJvcigiQ2FuJ3QgY29weSBlcXVpdmFsZW50IG9iamVjdHMgb3IgYXJyYXlzIik7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgICAgICAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uW2tleV0gPSBjb3B5KHNvdXJjZVtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEhhc2hLZXkoZGVzdGluYXRpb24saCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgICAgZm9yKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgICAgIGlmIChzcmMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuc3Vic3RyKDAsIDIpICE9PSAnJCQnKSB7CiAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZHN0OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhciBleHByZXNzaW9ucywgYXJyYXlzIGFuZAogICAgICogb2JqZWN0cy4KICAgICAqCiAgICAgKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogICAgICoKICAgICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgICAqICogQm90aCB2YWx1ZXMgYXJlIE5hTi4gKEluIEphdmFzU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICAgICAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YXNTY3JpcHQsCiAgICAgKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAgICAgKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogICAgICoKICAgICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzaW9uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAgICAgKiB0aGF0IGJlZ2luIHdpdGggYCRgIGFyZSBpZ25vcmVkLgogICAgICoKICAgICAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gbzEgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYXJndW1lbnRzIGFyZSBlcXVhbC4KICAgICAqLwogICAgZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogICAgICAgIGlmIChvMSA9PT0gbzIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICAgICAgICB2YXIgdDEgPSB0eXBlb2YgbzEsIHQyID0gdHlwZW9mIG8yLCBsZW5ndGgsIGtleSwga2V5U2V0OwogICAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgICAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG8xKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihrZXk9MDsga2V5PGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAobzEpICYmIGlzUmVnRXhwKG8yKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvMS50b1N0cmluZygpID09IG8yLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1Njb3BlKG8xKSB8fCBpc1Njb3BlKG8yKSB8fCBpc1dpbmRvdyhvMSkgfHwgaXNXaW5kb3cobzIpIHx8IGlzQXJyYXkobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAga2V5U2V0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZm9yKGtleSBpbiBvMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvcihrZXkgaW4gbzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZXlTZXRba2V5XSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSkKICAgICAgICAgICAgICAgICAgICA6IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICAgICAgaWYgKC9eXCQrLy50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmICBkb2N1bWVudCA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgdmFsID0gJyRET0NVTUVOVCc7CiAgICAgICAgfSBlbHNlIGlmIChpc1Njb3BlKHZhbHVlKSkgewogICAgICAgICAgICB2YWwgPSAnJFNDT1BFJzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWw7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnRvSnNvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXJpYWxpemVzIGlucHV0IGludG8gYSBKU09OLWZvcm1hdHRlZCBzdHJpbmcuIFByb3BlcnRpZXMgd2l0aCBsZWFkaW5nICQgY2hhcmFjdGVycyB3aWxsIGJlCiAgICAgKiBzdHJpcHBlZCBzaW5jZSBhbmd1bGFyIHVzZXMgdGhpcyBub3RhdGlvbiBpbnRlcm5hbGx5LgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogICAgICogQHJldHVybnMge3N0cmluZ3x1bmRlZmluZWR9IEpzb25pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGpzb24gSlNPTiBzdHJpbmcgdG8gZGVzZXJpYWxpemUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICAgICAqLwogICAgZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogICAgICAgIHJldHVybiBpc1N0cmluZyhqc29uKQogICAgICAgICAgICA/IEpTT04ucGFyc2UoanNvbikKICAgICAgICAgICAgOiBqc29uOwogICAgfQoKCiAgICBmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgICAgICAgICB2YWx1ZSA9ICEodiA9PSAnZicgfHwgdiA9PSAnMCcgfHwgdiA9PSAnZmFsc2UnIHx8IHYgPT0gJ25vJyB8fCB2ID09ICduJyB8fCB2ID09ICdbXScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgICAgICAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgIC8vIEFzIFBlciBET00gU3RhbmRhcmRzCiAgICAgICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICAgICAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgICAgICAgICAgZWxlbUh0bWwuCiAgICAgICAgICAgICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9ePChbXHdcLV0rKS8sIGZ1bmN0aW9uKG1hdGNoLCBub2RlTmFtZSkgeyByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsgfSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogVHJpZXMgdG8gZGVjb2RlIHRoZSBVUkkgY29tcG9uZW50IHdpdGhvdXQgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0gc3RyIHZhbHVlIHBvdGVudGlhbCBVUkkgY29tcG9uZW50IHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBjYW4gYmUgZGVjb2RlZAogICAgICogd2l0aCB0aGUgZGVjb2RlVVJJQ29tcG9uZW50IGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiB0cnlEZWNvZGVVUklDb21wb25lbnQodmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgLy8gSWdub3JlIGFueSBpbnZhbGlkIHVyaSBjb21wb25lbnQKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEByZXR1cm5zIE9iamVjdC48KHN0cmluZ3xib29sZWFuKT4KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgICAgICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24oa2V5VmFsdWUpewogICAgICAgICAgICBpZiAoIGtleVZhbHVlICkgewogICAgICAgICAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgIGtleSA9IHRyeURlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICAgICAgICAgICAgaWYgKCBpc0RlZmluZWQoa2V5KSApIHsKICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IGlzRGVmaW5lZChrZXlfdmFsdWVbMV0pID8gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICBmdW5jdGlvbiB0b0tleVZhbHVlKG9iaikgewogICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwogICAgfQoKCiAgICAvKioKICAgICAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZG9lc24ndCBmb2xsb3cKICAgICAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogICAgICogc2VnbWVudHM6CiAgICAgKiAgICBzZWdtZW50ICAgICAgID0gKnBjaGFyCiAgICAgKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogICAgICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogICAgICAgIHJldHVybiBlbmNvZGVVcmlRdWVyeSh2YWwsIHRydWUpLgogICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJCL2dpLCAnKycpOwogICAgfQoKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGludGVuZGVkIGZvciBlbmNvZGluZyAqa2V5KiBvciAqdmFsdWUqIHBhcnRzIG9mIHF1ZXJ5IGNvbXBvbmVudC4gV2UgbmVlZCBhIGN1c3RvbQogICAgICogbWV0aG9kIGJlY3Vhc2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgICAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAgICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICByZXBsYWNlKC8lNDAvZ2ksICdAJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzQS9naSwgJzonKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyQy9naSwgJywnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTIwL2csIChwY3RFbmNvZGVTcGFjZXMgPyAnJTIwJyA6ICcrJykpOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0FwcAogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICAgICAqICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZX0gbmFtZSB0byBsb2FkLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byBhdXRvLWJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4gT25seQogICAgICogb25lIG5nQXBwIGRpcmVjdGl2ZSBjYW4gYmUgdXNlZCBwZXIgSFRNTCBkb2N1bWVudC4gVGhlIGRpcmVjdGl2ZQogICAgICogZGVzaWduYXRlcyB0aGUgcm9vdCBvZiB0aGUgYXBwbGljYXRpb24gYW5kIGlzIHR5cGljYWxseSBwbGFjZWQKICAgICAqIGF0IHRoZSByb290IG9mIHRoZSBwYWdlLgogICAgICoKICAgICAqIFRoZSBmaXJzdCBuZ0FwcCBmb3VuZCBpbiB0aGUgZG9jdW1lbnQgd2lsbCBiZSBhdXRvLWJvb3RzdHJhcHBlZC4gVG8gdXNlIG11bHRpcGxlIGFwcGxpY2F0aW9ucyBpbiBhbgogICAgICogSFRNTCBkb2N1bWVudCB5b3UgbXVzdCBtYW51YWxseSBib290c3RyYXAgdGhlbSB1c2luZyB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9LgogICAgICogQXBwbGljYXRpb25zIGNhbm5vdCBiZSBuZXN0ZWQuCiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUgYmVsb3cgaWYgdGhlIGBuZ0FwcGAgZGlyZWN0aXZlIHdvdWxkIG5vdCBiZSBwbGFjZWQKICAgICAqIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZSBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQKICAgICAqIGFuZCB0aGUgYHt7IDErMiB9fWAgd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICAgICAqCiAgICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0IHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBJIGNhbiBhZGQ6IDEgKyAyID0gIHt7IDErMiB9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBuYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGFwcGVuZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChuYW1lKSk7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoJzonLCAnXFw6Jyk7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwpIHsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUpLCBhcHBlbmQpOwogICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSArICdcXDonKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbJyArIG5hbWUgKyAnXScpLCBhcHBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKCFhcHBFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICc7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBOR19BUFBfQ0xBU1NfUkVHRVhQLmV4ZWMoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IChtYXRjaFsyXSB8fCAnJykucmVwbGFjZSgvXHMrL2csICcsJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgbmdTY2VuYXJpby1iYXNlZCBlbmQtdG8tZW5kIHRlc3RzIGNhbm5vdCB1c2UgdGhpcyBmdW5jdGlvbiB0byBib290c3RyYXAgbWFudWFsbHkuCiAgICAgKiBUaGV5IG11c3QgdXNlIHtAbGluayBhcGkvbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzIHx8IFtdOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KCduZycpOwogICAgICAgICAgICB2YXIgaW5qZWN0b3IgPSBjcmVhdGVJbmplY3Rvcihtb2R1bGVzKTsKICAgICAgICAgICAgaW5qZWN0b3IuaW52b2tlKFsnJHJvb3RTY29wZScsICckcm9vdEVsZW1lbnQnLCAnJGNvbXBpbGUnLCAnJGluamVjdG9yJywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvcikgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKCckaW5qZWN0b3InLCBpbmplY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfV0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuIGluamVjdG9yOwogICAgICAgIH07CgogICAgICAgIHZhciBOR19ERUZFUl9CT09UU1RSQVAgPSAvXk5HX0RFRkVSX0JPT1RTVFJBUCEvOwoKICAgICAgICBpZiAod2luZG93ICYmICFOR19ERUZFUl9CT09UU1RSQVAudGVzdCh3aW5kb3cubmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGRvQm9vdHN0cmFwKCk7CiAgICAgICAgfQoKICAgICAgICB3aW5kb3cubmFtZSA9IHdpbmRvdy5uYW1lLnJlcGxhY2UoTkdfREVGRVJfQk9PVFNUUkFQLCAnJyk7CiAgICAgICAgYW5ndWxhci5yZXN1bWVCb290c3RyYXAgPSBmdW5jdGlvbihleHRyYU1vZHVsZXMpIHsKICAgICAgICAgICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CiAgICBmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcil7CiAgICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICdfJzsKICAgICAgICByZXR1cm4gbmFtZS5yZXBsYWNlKFNOQUtFX0NBU0VfUkVHRVhQLCBmdW5jdGlvbihsZXR0ZXIsIHBvcykgewogICAgICAgICAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAgICAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICAgICAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgICAgIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogICAgICAgIGlmIChqUXVlcnkpIHsKICAgICAgICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICAgICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgICAgICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICAgICAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIE1ldGhvZCBzaWduYXR1cmU6IEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKG5hbWUsIGRpc3BhdGNoVGhpcywgZmlsdGVyRWxlbXMsIGdldHRlcklmTm9Bcmd1bWVudHMpCiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdlbXB0eScsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnaHRtbCcsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganFMaXRlID0gSlFMaXRlOwogICAgICAgIH0KICAgICAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgJyIgKyAobmFtZSB8fCAnPycpICsgIicgaXMgIiArIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgICAgICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgICAgICB9CgogICAgICAgIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAgICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NpYmxlIGZyb20gdGhlIG9iamVjdCBieSBwYXRoLiBBbnkgdW5kZWZpbmVkIHRyYXZlcnNhbHMgYXJlIGlnbm9yZWQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogc3RhcnRpbmcgb2JqZWN0CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBwYXRoIHRvIHRyYXZlcnNlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49dHJ1ZX0gYmluZEZuVG9TY29wZQogICAgICogQHJldHVybnMgdmFsdWUgYXMgYWNjZXNzaWJsZSBieSBwYXRoCiAgICAgKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnRlcmZhY2UKICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogICAgICovCgogICAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnN1cmUoZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpLCAnbW9kdWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZyBhbmQgcmVnaXN0ZXJpbmcgQW5ndWxhciBtb2R1bGVzLiBBbGwKICAgICAgICAgICAgICogbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIyBNb2R1bGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsZWN0aW9uIG9mIHNlcnZpY2VzLCBkaXJlY3RpdmVzLCBmaWx0ZXJzLCBhbmQgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICogYGFuZ3VsYXIubW9kdWxlYCBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICAgICAgICogbXlNb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGVuIHlvdSBjYW4gY3JlYXRlIGFuIGluamVjdG9yIGFuZCBsb2FkIHlvdXIgbW9kdWxlcyBsaWtlIHRoaXM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIHZhciBpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZycsICdNeU1vZHVsZSddKQogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSG93ZXZlciBpdCdzIG1vcmUgbGlrZWx5IHRoYXQgeW91J2xsIGp1c3QgdXNlCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPj19IHJlcXVpcmVzIElmIHNwZWNpZmllZCB0aGVuIG5ldyBtb2R1bGUgaXMgYmVpbmcgY3JlYXRlZC4gSWYgdW5zcGVjaWZpZWQgdGhlbiB0aGUKICAgICAgICAgICAgICogICAgICAgIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdObyBtb2R1bGU6ICcgKyBuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxBcnJheS48Kj4+fSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBpbnZva2VRdWV1ZSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48RnVuY3Rpb24+fSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbmZpZyA9IGludm9rZUxhdGVyKCckaW5qZWN0b3InLCAnaW52b2tlJyk7CgogICAgICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7YW5ndWxhci5Nb2R1bGV9ICovCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBQcml2YXRlIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnZva2VRdWV1ZTogaW52b2tlUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgIF9ydW5CbG9ja3M6IHJ1bkJsb2NrcywKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcmVxdWlyZXMKICAgICAgICAgICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBMaXN0IG9mIG1vZHVsZSBuYW1lcyB3aGljaCBtdXN0IGJlIGxvYWRlZCBiZWZvcmUgdGhpcyBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBIb2xkcyB0aGUgbGlzdCBvZiBtb2R1bGVzIHdoaWNoIHRoZSBpbmplY3RvciB3aWxsIGxvYWQgYmVmb3JlIHRoZSBjdXJyZW50IG1vZHVsZSBpcyBsb2FkZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlczogcmVxdWlyZXMsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gTmFtZSBvZiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCgoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlclR5cGUgQ29uc3RydWN0aW9uIGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIgJHByb3ZpZGUucHJvdmlkZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3Byb3ZpZGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmYWN0b3J5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJGdW5jdGlvbiBGdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdmYWN0b3J5JyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdzZXJ2aWNlJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSN2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IFNlcnZpY2UgaW5zdGFuY2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlICRwcm92aWRlLnZhbHVlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICd2YWx1ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uc3RhbnQKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGNvbnN0YW50IG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBvYmplY3QgQ29uc3RhbnQgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIHRoZSBjb25zdGFudCBhcmUgZml4ZWQsIHRoZXkgZ2V0IGFwcGxpZWQgYmVmb3JlIG90aGVyIHByb3ZpZGUgbWV0aG9kcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI2NvbnN0YW50ICRwcm92aWRlLmNvbnN0YW50KCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3RhbnQ6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdjb25zdGFudCcsICd1bnNoaWZ0JyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEZpbHRlciBuYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBmaWx0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRmaWx0ZXJQcm92aWRlciNyZWdpc3RlciAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgZGlyZWN0aXZlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAgICAgICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gb24gbW9kdWxlIGxvYWQuIFVzZWZ1bCBmb3Igc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggbmVlZHMgdG8gYmUgcGVyZm9ybWVkIG9uIG1vZHVsZSBsb2FkaW5nLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGluaXRpYWxpemF0aW9uRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGFmdGVyIGluamVjdG9yIGNyZWF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggc2hvdWxkIGJlIHBlcmZvcm1lZCB3aGVuIHRoZSBpbmplY3RvciBpcyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBydW46IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChibG9jayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWdGbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcoY29uZmlnRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgICAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogICAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgICAqLwogICAgdmFyIHZlcnNpb24gPSB7CiAgICAgICAgZnVsbDogJzEuMC44JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAwLAogICAgICAgIGRvdDogOCwKICAgICAgICBjb2RlTmFtZTogJ2J1YmJsZS1idXJzdCcKICAgIH07CgoKICAgIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKXsKICAgICAgICBleHRlbmQoYW5ndWxhciwgewogICAgICAgICAgICAnYm9vdHN0cmFwJzogYm9vdHN0cmFwLAogICAgICAgICAgICAnY29weSc6IGNvcHksCiAgICAgICAgICAgICdleHRlbmQnOiBleHRlbmQsCiAgICAgICAgICAgICdlcXVhbHMnOiBlcXVhbHMsCiAgICAgICAgICAgICdlbGVtZW50JzoganFMaXRlLAogICAgICAgICAgICAnZm9yRWFjaCc6IGZvckVhY2gsCiAgICAgICAgICAgICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICAgICAgICAgICAnbm9vcCc6bm9vcCwKICAgICAgICAgICAgJ2JpbmQnOmJpbmQsCiAgICAgICAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAgICAgICAnaWRlbnRpdHknOmlkZW50aXR5LAogICAgICAgICAgICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAgICAgICAgICAgJ2lzRGVmaW5lZCc6IGlzRGVmaW5lZCwKICAgICAgICAgICAgJ2lzU3RyaW5nJzogaXNTdHJpbmcsCiAgICAgICAgICAgICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAgICAgICAgICAgJ2lzT2JqZWN0JzogaXNPYmplY3QsCiAgICAgICAgICAgICdpc051bWJlcic6IGlzTnVtYmVyLAogICAgICAgICAgICAnaXNFbGVtZW50JzogaXNFbGVtZW50LAogICAgICAgICAgICAnaXNBcnJheSc6IGlzQXJyYXksCiAgICAgICAgICAgICd2ZXJzaW9uJzogdmVyc2lvbiwKICAgICAgICAgICAgJ2lzRGF0ZSc6IGlzRGF0ZSwKICAgICAgICAgICAgJ2xvd2VyY2FzZSc6IGxvd2VyY2FzZSwKICAgICAgICAgICAgJ3VwcGVyY2FzZSc6IHVwcGVyY2FzZSwKICAgICAgICAgICAgJ2NhbGxiYWNrcyc6IHtjb3VudGVyOiAwfQogICAgICAgIH0pOwoKICAgICAgICBhbmd1bGFyTW9kdWxlID0gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogICAgICAgIH0KCiAgICAgICAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgICAgICAgICBmdW5jdGlvbiBuZ01vZHVsZSgkcHJvdmlkZSkgewogICAgICAgICAgICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJyRjb21waWxlJywgJENvbXBpbGVQcm92aWRlcikuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQ6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYTogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdDogc2NyaXB0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb246IG9wdGlvbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdCaW5kOiBuZ0JpbmREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZEh0bWxVbnNhZmU6IG5nQmluZEh0bWxVbnNhZmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZFRlbXBsYXRlOiBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzczogbmdDbGFzc0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NsYXNzT2RkOiBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NzcDogbmdDc3BEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ29udHJvbGxlcjogbmdDb250cm9sbGVyRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0Zvcm06IG5nRm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdOb25CaW5kYWJsZTogbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdQbHVyYWxpemU6IG5nUGx1cmFsaXplRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU2hvdzogbmdTaG93RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmlldzogbmdWaWV3RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZTogJFJvdXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiAkUm91dGVQYXJhbXNQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAgICAgKiBBbmd1bGFyJ3MgbGl0ZSB2ZXJzaW9uIG9mIGpRdWVyeSBwcm92aWRlcyBvbmx5IHRoZSBmb2xsb3dpbmcgalF1ZXJ5IG1ldGhvZHM6CiAgICAgKgogICAgICogLSBbYWRkQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICAgICAqIC0gW2FmdGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAgICAgKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAgICAgKiAtIFthdHRyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICAgICAqIC0gW2JpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2JpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAgICogLSBbY2hpbGRyZW4oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbY2xvbmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICAgICAqIC0gW2NvbnRlbnRzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jb250ZW50cy8pCiAgICAgKiAtIFtjc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nzcy8pCiAgICAgKiAtIFtkYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICAgICAqIC0gW2VxKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lcS8pCiAgICAgKiAtIFtmaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9maW5kLykgLSBMaW1pdGVkIHRvIGxvb2t1cHMgYnkgdGFnIG5hbWUKICAgICAqIC0gW2hhc0NsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9oYXNDbGFzcy8pCiAgICAgKiAtIFtodG1sKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9odG1sLykKICAgICAqIC0gW25leHQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL25leHQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtwYXJlbnQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW3ByZXBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogICAgICogLSBbcHJvcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAgICAgKiAtIFtyZWFkeSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogICAgICogLSBbcmVtb3ZlKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogICAgICogLSBbcmVtb3ZlQXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAgICAgKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogICAgICogLSBbcmVtb3ZlRGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAgICAgKiAtIFtyZXBsYWNlV2l0aCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogICAgICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAgICAgKiAtIFt0b2dnbGVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogICAgICogLSBbdHJpZ2dlckhhbmRsZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBEb2Vzbid0IHBhc3MgbmF0aXZlIGV2ZW50IG9iamVjdHMgdG8gaGFuZGxlcnMuCiAgICAgKiAtIFt1bmJpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3VuYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICAgKiAtIFt2YWwoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAgICAgKiAtIFt3cmFwKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICAgICAqCiAgICAgKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogICAgICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICAgICAqCiAgICAgKiAjIyMgRXZlbnRzCiAgICAgKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAgICAgKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFuZCAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogICAgICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICAgICAqICMjIyBNZXRob2RzCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTt9CiAgICAgICAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7fSksCiAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICAgICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCiAgICBmdW5jdGlvbiBqcU5leHRJZCgpIHsgcmV0dXJuICsranFJZDsgfQoKCiAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgIHZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwoKICAgIC8qKgogICAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgICAqLwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCwgZnVuY3Rpb24oXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyBJbiBjb25qdW5jdGlvbiB3aXRoIGJpbmRKUXVlcnkgaW50ZXJjZXB0cyBhbGwgalF1ZXJ5J3MgRE9NIGRlc3RydWN0aW9uIGFwaXMgYW5kIGZpcmVzIGEKLy8gJGRlc3Ryb3kgZXZlbnQgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLgovLwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZShuYW1lLCBkaXNwYXRjaFRoaXMsIGZpbHRlckVsZW1zLCBnZXR0ZXJJZk5vQXJndW1lbnRzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgICAgICBvcmlnaW5hbEpxRm4gPSBvcmlnaW5hbEpxRm4uJG9yaWdpbmFsIHx8IG9yaWdpbmFsSnFGbjsKICAgICAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICAgICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBhdGNoKHBhcmFtKSB7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmlsdGVyRWxlbXMgJiYgcGFyYW0gPyBbdGhpcy5maWx0ZXIocGFyYW0pXSA6IFt0aGlzXSwKICAgICAgICAgICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICAgICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICAgICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbjsKCiAgICAgICAgICAgIGlmICghZ2V0dGVySWZOb0FyZ3VtZW50cyB8fCBwYXJhbSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB3aGlsZShsaXN0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHNldCA9IGxpc3Quc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBmb3Ioc2V0SW5kZXggPSAwLCBzZXRMZW5ndGggPSBzZXQubGVuZ3RoOyBzZXRJbmRleCA8IHNldExlbmd0aDsgc2V0SW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IoY2hpbGRJbmRleCA9IDAsIGNoaWxkTGVuZ3RoID0gKGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEluZGV4IDwgY2hpbGRMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxKcUZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSlFMaXRlKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSlFMaXRlKSkgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkgJiYgZWxlbWVudC5jaGFyQXQoMCkgIT0gJzwnKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignc2VsZWN0b3JzIG5vdCBpbXBsZW1lbnRlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgLy8gUmVhZCBhYm91dCB0aGUgTm9TY29wZSBlbGVtZW50cyBoZXJlOgogICAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKyBlbGVtZW50OyAvLyBJRSBpbnNhbml0eSB0byBtYWtlIE5vU2NvcGUgZWxlbWVudHMgd29yayEKICAgICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKGRpdi5maXJzdENoaWxkKTsgLy8gcmVtb3ZlIHRoZSBzdXBlcmZsdW91cyBkaXYKICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgICAgICAgICB0aGlzLnJlbW92ZSgpOyAvLyBkZXRhY2ggdGhlIGVsZW1lbnRzIGZyb20gdGhlIHRlbXBvcmFyeSBET00gZGl2LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURlYWxvYyhlbGVtZW50KXsKICAgICAgICBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpOwogICAgICAgIGZvciAoIHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVVbmJpbmQoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICB2YXIgZXZlbnRzID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICAgICAgICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgICAgICAgICAgZm9yRWFjaChldmVudHMsIGZ1bmN0aW9uKGV2ZW50SGFuZGxlciwgdHlwZSkgewogICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50SGFuZGxlcik7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRzW3R5cGVdKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShldmVudHNbdHlwZV0gfHwgW10sIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpIHsKICAgICAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgICAgIGlmIChleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICBKUUxpdGVVbmJpbmQoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRhID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgICAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAgICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgICAgICBpZiAoIWRhdGEgJiYgIWlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGtleURlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gKCgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgICAgICAgIGluZGV4T2YoICIgIiArIHNlbGVjdG9yICsgIiAiICkgPiAtMSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKAogICAgICAgICAgICAgICAgICAgICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgICAgICAgICAgaWYgKCFKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBjc3NDbGFzcykpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKyB0cmltKGNzc0NsYXNzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVBZGROb2Rlcyhyb290LCBlbGVtZW50cykgewogICAgICAgIGlmIChlbGVtZW50cykgewogICAgICAgICAgICBlbGVtZW50cyA9ICghZWxlbWVudHMubm9kZU5hbWUgJiYgaXNEZWZpbmVkKGVsZW1lbnRzLmxlbmd0aCkgJiYgIWlzV2luZG93KGVsZW1lbnRzKSkKICAgICAgICAgICAgICAgID8gZWxlbWVudHMKICAgICAgICAgICAgICAgIDogWyBlbGVtZW50cyBdOwogICAgICAgICAgICBmb3IodmFyIGk9MDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUNvbnRyb2xsZXIoZWxlbWVudCwgbmFtZSkgewogICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgICAgIGlmKGVsZW1lbnRbMF0ubm9kZVR5cGUgPT0gOSkgewogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWUpKSByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbikgewogICAgICAgICAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgICAgICAgICAgICBpZiAoZmlyZWQpIHJldHVybjsKICAgICAgICAgICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuYmluZCgnRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgICAgICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAgICAgICAgICBKUUxpdGUod2luZG93KS5iaW5kKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAgIH0sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbihlKXsgdmFsdWUucHVzaCgnJyArIGUpO30pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIChpbmRleCA+PSAwKSA/IGpxTGl0ZSh0aGlzW2luZGV4XSkgOiBqcUxpdGUodGhpc1t0aGlzLmxlbmd0aCArIGluZGV4XSk7CiAgICAgICAgfSwKCiAgICAgICAgbGVuZ3RoOiAwLAogICAgICAgIHB1c2g6IHB1c2gsCiAgICAgICAgc29ydDogW10uc29ydCwKICAgICAgICBzcGxpY2U6IFtdLnNwbGljZQogICAgfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgovLyB0aGVzZSBmdW5jdGlvbnMgcmV0dXJuIHNlbGYgb24gc2V0dGVyIGFuZAovLyB2YWx1ZSBvbiBnZXQuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEJPT0xFQU5fQVRUUiA9IHt9OwogICAgZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCcuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICAgIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0nLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRzY29wZScpOwogICAgICAgIH0sCgogICAgICAgIGNvbnRyb2xsZXI6IEpRTGl0ZUNvbnRyb2xsZXIgLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJGluamVjdG9yJyk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCxuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUpOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2YWw7CgogICAgICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgc29tZSBJRSBzcGVjaWZpYyB3ZWlyZG5lc3MgdGhhdCBqUXVlcnkgMS42LjQgZG9lcyBub3Qgc3VyZSB3aHkKICAgICAgICAgICAgICAgICAgICB2YWwgPSBlbGVtZW50LmN1cnJlbnRTdHlsZSAmJiBlbGVtZW50LmN1cnJlbnRTdHlsZVtuYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09PSAnJykgdmFsID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhbCA9IHZhbCB8fCBlbGVtZW50LnN0eWxlW25hbWVdOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBqcXVlcnkgd2VpcmRuZXNzIDotLwogICAgICAgICAgICAgICAgICAgIHZhbCA9ICh2YWwgPT09ICcnKSA/IHVuZGVmaW5lZCA6IHZhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgICAgICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpfHwgbm9vcCkuc3BlY2lmaWVkKQogICAgICAgICAgICAgICAgICAgICAgICA/IGxvd2VyY2FzZWROYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgLy8gdGhlIGV4dHJhIGFyZ3VtZW50ICIyIiBpcyB0byBnZXQgdGhlIHJpZ2h0IHRoaW5nIGZvciBhLmhyZWYgaW4gSUUsIHNlZSBqUXVlcnkgY29kZQogICAgICAgICAgICAgICAgLy8gc29tZSBlbGVtZW50cyAoZS5nLiBEb2N1bWVudCkgZG9uJ3QgaGF2ZSBnZXQgYXR0cmlidXRlLCBzbyByZXR1cm4gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSwgMik7CiAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgbm9uLWV4aXN0aW5nIGF0dHJpYnV0ZXMgdG8gdW5kZWZpbmVkIChhcyBqUXVlcnkpCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcHJvcDogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogZXh0ZW5kKChtc2llIDwgOSkKICAgICAgICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICovKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVyVGV4dDsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVWYWx1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgIH0sIHskZHY6Jyd9KSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZU5hbWVfKGVsZW1lbnQpID09PSAnU0VMRUNUJyAmJiBlbGVtZW50Lm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5vcHRpb25zLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG9wdGlvbi52YWx1ZSB8fCBvcHRpb24udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgaHRtbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogICAgICAgIC8qKgogICAgICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAgICAgKi8KICAgICAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgICAgICB2YXIgaSwga2V5OwoKICAgICAgICAgICAgLy8gSlFMaXRlSGFzQ2xhc3MgaGFzIG9ubHkgdHdvIGFyZ3VtZW50cywgYnV0IGlzIGEgZ2V0dGVyLW9ubHkgZm4sIHNvIHdlIG5lZWQgdG8gc3BlY2lhbC1jYXNlIGl0CiAgICAgICAgICAgIC8vIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uLgogICAgICAgICAgICBpZiAoKChmbi5sZW5ndGggPT0gMiAmJiAoZm4gIT09IEpRTGl0ZUhhc0NsYXNzICYmIGZuICE9PSBKUUxpdGVDb250cm9sbGVyKSkgPyBhcmcxIDogYXJnMikgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGFyZzEpKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgICAgICAgICAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbiA9PT0gSlFMaXRlRGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGF0YSgpIHRha2VzIHRoZSB3aG9sZSBvYmplY3QgaW4galF1ZXJ5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGFyZzEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBrZXksIGFyZzFba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHJlYWQsIHNvIHJlYWQgdGhlIGZpcnN0IGNoaWxkLgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKHRoaXNbMF0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIHNvIGFwcGx5IHRvIGFsbCBjaGlsZHJlbgogICAgICAgICAgICAgICAgZm9yKGk9MDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZuLiRkdjsKICAgICAgICB9OwogICAgfSk7CgogICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykgewogICAgICAgIHZhciBldmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQsIHR5cGUpIHsKICAgICAgICAgICAgaWYgKCFldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgcHJldmVudC5jYWxsKGV2ZW50KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgICAgICAgICAgLy8gYXMgdGhleSB3b3VsZCBjYXVzZSBtZW1vcnkgbGVha3MgaW4gSUU4LgogICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgYmluZDogZnVuY3Rpb24gYmluZEZuKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgICAgICAgICBoYW5kbGUgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgICAgICAgICAgaWYgKCFldmVudHMpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJywgZXZlbnRzID0ge30pOwogICAgICAgICAgICBpZiAoIWhhbmRsZSkgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnLCBoYW5kbGUgPSBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSk7CgogICAgICAgICAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zKCBidXAgKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGJ1cCApICYgMTYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCBhLCBiICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggYiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGIgPT09IGEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZSA6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXIgOiAibW91c2VvdmVyIn0KICAgICAgICAgICAgICAgICAgICAgICAgYmluZEZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCwgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFjb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZShldmVudCwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHVuYmluZDogSlFMaXRlVW5iaW5kLAoKICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgICAgICAgICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudHM6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsKICAgICAgICB9LAoKICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JhcDogZnVuY3Rpb24oZWxlbWVudCwgd3JhcE5vZGUpIHsKICAgICAgICAgICAgd3JhcE5vZGUgPSBqcUxpdGUod3JhcE5vZGUpWzBdOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cmFwTm9kZS5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBKUUxpdGVBZGRDbGFzcywKICAgICAgICByZW1vdmVDbGFzczogSlFMaXRlUmVtb3ZlQ2xhc3MsCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25kaXRpb24pKSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAhSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgbmV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0sCgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogSlFMaXRlQ2xvbmUsCgogICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudE5hbWUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gKEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50Rm5zLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogICAgICAgIC8qKgogICAgICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICAgICAqLwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yKHZhciBpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8gdGhpcyA6IHZhbHVlOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KXsKICAgICAgICBmb3JFYWNoKGFycmF5LCB0aGlzLnB1dCwgdGhpcyk7CiAgICB9CiAgICBIYXNoTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZSBrZXkgdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkga2V5IHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqIEByZXR1cm5zIHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkKICAgICAgICAgKi8KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzW2tleSA9IGhhc2hLZXkoa2V5KV07CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQSBtYXAgd2hlcmUgbXVsdGlwbGUgdmFsdWVzIGNhbiBiZSBhZGRlZCB0byB0aGUgc2FtZSBrZXkgc3VjaCB0aGF0IHRoZXkgZm9ybSBhIHF1ZXVlLgogICAgICogQHJldHVybnMge0hhc2hRdWV1ZU1hcH0KICAgICAqLwogICAgZnVuY3Rpb24gSGFzaFF1ZXVlTWFwKCkge30KICAgIEhhc2hRdWV1ZU1hcC5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogU2FtZSBhcyBhcnJheSBwdXNoLCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHB1c2g6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSBbdmFsdWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHNoaWZ0LCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHNoaWZ0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5WzBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXkuc2hpZnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHJldHVybiB0aGUgZmlyc3QgaXRlbSB3aXRob3V0IGRlbGV0aW5nIGl0CiAgICAgICAgICovCiAgICAgICAgcGVlazogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNbaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmluamVjdG9yCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogICAgICogZGVwZW5kZW5jeSBpbmplY3Rpb24gKHNlZSB7QGxpbmsgZ3VpZGUvZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICAgICAqCgogICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5tb2R1bGV9LiBUaGUgYG5nYCBtb2R1bGUgbXVzdCBiZSBleHBsaWNpdGx5IGFkZGVkLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEluamVjdG9yIGZ1bmN0aW9uLiBTZWUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFR5cGljYWwgdXNhZ2UKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGNyZWF0ZSBhbiBpbmplY3RvcgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJ10pOwogICAgICoKICAgICAqICAgLy8gdXNlIHRoZSBpbmplY3RvciB0byBraWNrIG9mZiB5b3VyIGFwcGxpY2F0aW9uCiAgICAgKiAgIC8vIHVzZSB0aGUgdHlwZSBpbmZlcmVuY2UgdG8gYXV0byBpbmplY3QgYXJndW1lbnRzLCBvciB1c2UgaW1wbGljaXQgaW5qZWN0aW9uCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRkb2N1bWVudCl7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvdmVydmlldwogICAgICogQG5hbWUgQVVUTwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICovCgogICAgdmFyIEZOX0FSR1MgPSAvXmZ1bmN0aW9uXHMqW15cKF0qXChccyooW15cKV0qKVwpL207CiAgICB2YXIgRk5fQVJHX1NQTElUID0gLywvOwogICAgdmFyIEZOX0FSRyA9IC9eXHMqKF8/KShcUys/KVwxXHMqJC87CiAgICB2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwogICAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgICAgICB2YXIgJGluamVjdCwKICAgICAgICAgICAgZm5UZXh0LAogICAgICAgICAgICBhcmdEZWNsLAogICAgICAgICAgICBsYXN0OwoKICAgICAgICBpZiAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICAgICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgICAgICAgICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgdW5kZXJzY29yZSwgbmFtZSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRpbmplY3QucHVzaChuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgICAgICAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAgICAgICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnRBcmdGbihmbiwgJ2ZuJywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkaW5qZWN0OwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYCRpbmplY3RvcmAgaXMgdXNlZCB0byByZXRyaWV2ZSBvYmplY3QgaW5zdGFuY2VzIGFzIGRlZmluZWQgYnkKICAgICAqIHtAbGluayBBVVRPLiRwcm92aWRlIHByb3ZpZGVyfSwgaW5zdGFudGlhdGUgdHlwZXMsIGludm9rZSBtZXRob2RzLAogICAgICogYW5kIGxvYWQgbW9kdWxlcy4KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIGFsd2F5cyBob2xkcyB0cnVlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKCk7CiAgICAgKiAgIGV4cGVjdCgkaW5qZWN0b3IuZ2V0KCckaW5qZWN0b3InKSkudG9CZSgkaW5qZWN0b3IpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkaW5qZWN0b3IpewogKiAgICAgcmV0dXJuICRpbmplY3RvcjsKICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAgICAgKgogICAgICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogICAgICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAgICAgKgogICAgICogICAvLyBhbm5vdGF0ZWQKICAgICAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogICAgICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogICAgICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICAgICAqCiAgICAgKiAgIC8vIGlubGluZQogICAgICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyMgSW5mZXJlbmNlCiAgICAgKgogICAgICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uIGNhbiB0aGVuIGJlCiAgICAgKiBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aCBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbgogICAgICogdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqCiAgICAgKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogICAgICogQnkgYWRkaW5nIGEgYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiAjIyBJbmxpbmUKICAgICAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2dldAogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogICAgICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyFmdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4gVGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjb21lIGZvcm0gdGhlIGZ1bmN0aW9uIGFubm90YXRpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBpbnZva2VzIHRoZSBuZXcgb3BlcmF0b3IgYW5kIHN1cHBsaWVzCiAgICAgKiBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZSBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFR5cGUgQW5ub3RhdGVkIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNhbm5vdGF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMgdXNlZCBieSB0aGUgaW5qZWN0b3IKICAgICAqIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZQogICAgICogd2F5cyBpbiB3aGljaCB0aGUgZnVuY3Rpb24gY2FuIGJlIGFubm90YXRlZCB3aXRoIHRoZSBuZWVkZWQgZGVwZW5kZW5jaWVzLgogICAgICoKICAgICAqICMgQXJndW1lbnQgbmFtZXMKICAgICAqCiAgICAgKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lIGJ5IGNvbnZlcnRpbmcKICAgICAqIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAgICAgKgogICAgICogICAvLyBUaGVuCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IHdvcmsgd2l0aCBjb2RlIG1pbmZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nIGFubm90YXRpb24gc3RyYXRlZ2llcwogICAgICogYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgICAqCiAgICAgKiBJZiBhIGZ1bmN0aW9uIGhhcyBhbiBgJGluamVjdGAgcHJvcGVydHkgYW5kIGl0cyB2YWx1ZSBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIHRoZSBzdHJpbmdzIHJlcHJlc2VudCBuYW1lcyBvZgogICAgICogc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAgICAgKiA8cHJlPgogICAgICogICAvLyBHaXZlbgogICAgICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICAgICAqICAgLy8gRGVmaW5lIGZ1bmN0aW9uIGRlcGVuZGVuY2llcwogICAgICogICBNeUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJHNjb3BlJywgJyRyb3V0ZSddOwogICAgICoKICAgICAqICAgLy8gVGhlbgogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIFRoZSBhcnJheSBub3RhdGlvbgogICAgICoKICAgICAqIEl0IGlzIG9mdGVuIGRlc2lyYWJsZSB0byBpbmxpbmUgSW5qZWN0ZWQgZnVuY3Rpb25zIGFuZCB0aGF0J3Mgd2hlbiBzZXR0aW5nIHRoZSBgJGluamVjdGAgcHJvcGVydHkgaXMgdmVyeQogICAgICogaW5jb252ZW5pZW50LiBJbiB0aGVzZSBzaXR1YXRpb25zIHVzaW5nIHRoZSBhcnJheSBub3RhdGlvbiB0byBzcGVjaWZ5IHRoZSBkZXBlbmRlbmNpZXMgaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcwogICAgICogbWluaWZpY2F0aW9uIGlzIGEgYmV0dGVyIGNob2ljZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBXZSB3aXNoIHRvIHdyaXRlIHRoaXMgKG5vdCBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbiBzYWZlKQogICAgICogICBpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUsICRyb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gV2UgYXJlIGZvcmNlZCB0byB3cml0ZSBicmVhayBpbmxpbmluZwogICAgICogICB2YXIgdG1wRm4gPSBmdW5jdGlvbihvYmZ1c2NhdGVkQ29tcGlsZSwgb2JmdXNjYXRlZFJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfTsKICAgICAqICAgdG1wRm4uJGluamVjdCA9IFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddOwogICAgICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogICAgICoKICAgICAqICAgLy8gVG8gYmV0dGVyIHN1cHBvcnQgaW5saW5lIGZ1bmN0aW9uIHRoZSBpbmxpbmUgYW5ub3RhdGlvbiBpcyBzdXBwb3J0ZWQKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfV0pOwogICAgICoKICAgICAqICAgLy8gVGhlcmVmb3JlCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZSgKICAgICAqICAgICAgWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmdXNfJGNvbXBpbGUsIG9iZnVzXyRyb290U2NvcGUpIHt9XSkKICAgICAqICAgICkudG9FcXVhbChbJyRjb21waWxlJywgJyRyb290U2NvcGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufEFycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBmbiBGdW5jdGlvbiBmb3Igd2hpY2ggZGVwZW5kZW50IHNlcnZpY2UgbmFtZXMgbmVlZCB0byBiZSByZXRyaWV2ZWQgYXMgZGVzY3JpYmVkCiAgICAgKiAgIGFib3ZlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gVGhlIG5hbWVzIG9mIHRoZSBzZXJ2aWNlcyB3aGljaCB0aGUgZnVuY3Rpb24gcmVxdWlyZXMuCiAgICAgKi8KCgoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2UgYCRwcm92aWRlYCB0byByZWdpc3RlciBuZXcgcHJvdmlkZXJzIHdpdGggdGhlIGAkaW5qZWN0b3JgLiBUaGUgcHJvdmlkZXJzIGFyZSB0aGUgZmFjdG9yaWVzIGZvciB0aGUgaW5zdGFuY2UuCiAgICAgKiBUaGUgcHJvdmlkZXJzIHNoYXJlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGluc3RhbmNlIHRoZXkgY3JlYXRlIHdpdGggYFByb3ZpZGVyYCBzdWZmaXhlZCB0byB0aGVtLgogICAgICoKICAgICAqIEEgcHJvdmlkZXIgaXMgYW4gb2JqZWN0IHdpdGggYSBgJGdldCgpYCBtZXRob2QuIFRoZSBpbmplY3RvciBjYWxscyB0aGUgYCRnZXRgIG1ldGhvZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgICAqIGEgc2VydmljZS4gVGhlIFByb3ZpZGVyIGNhbiBoYXZlIGFkZGl0aW9uYWwgbWV0aG9kcyB3aGljaCB3b3VsZCBhbGxvdyBmb3IgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgZnVuY3Rpb24gR3JlZXRQcm92aWRlcigpIHsKICogICAgIHZhciBzYWx1dGF0aW9uID0gJ0hlbGxvJzsKICoKICogICAgIHRoaXMuc2FsdXRhdGlvbiA9IGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgc2FsdXRhdGlvbiA9IHRleHQ7CiAqICAgICB9OwogKgogKiAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogKiAgICAgICAgIHJldHVybiBzYWx1dGF0aW9uICsgJyAnICsgbmFtZSArICchJzsKICogICAgICAgfTsKICogICAgIH07CiAqICAgfQogICAgICoKICAgICAqICAgZGVzY3JpYmUoJ0dyZWV0ZXInLCBmdW5jdGlvbigpewogKgogKiAgICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oJHByb3ZpZGUpIHsKICogICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJ2dyZWV0JywgR3JlZXRQcm92aWRlcik7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGdyZWV0JywgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdIZWxsbyBhbmd1bGFyIScpOwogKiAgICAgfSkpOwogKgogKiAgICAgaXQoJ3Nob3VsZCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHNhbHV0YXRpb24nLCBmdW5jdGlvbigpIHsKICogICAgICAgbW9kdWxlKGZ1bmN0aW9uKGdyZWV0UHJvdmlkZXIpIHsKICogICAgICAgICBncmVldFByb3ZpZGVyLnNhbHV0YXRpb24oJ0Fob2onKTsKICogICAgICAgfSk7CiAqICAgICAgIGluamVjdChmdW5jdGlvbihncmVldCkgewogKiAgICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdBaG9qIGFuZ3VsYXIhJyk7CiAqICAgICAgIH0pOwogKiAgICAgfSk7CiAqIDwvcHJlPgogKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBSZWdpc3RlciBhIHByb3ZpZGVyIGZvciBhIHNlcnZpY2UuIFRoZSBwcm92aWRlcnMgY2FuIGJlIHJldHJpZXZlZCBhbmQgY2FuIGhhdmUgYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG1ldGhvZHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKyAnUHJvdmlkZXInYCBrZXkuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICAgICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICAgKiAgICAgICAgICAgICAgIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZmFjdG9yeQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgb25seSBgJGdldGAgbWV0aG9kIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZCBmb3IKICAgICAqIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciByZWdpc3RlcmluZyBzZXJ2aWNlIG9mIGdpdmVuIGNsYXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSN2YWx1ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgdGhlIGAkZ2V0YCBtZXRob2QgaXMgYSBjb25zdGFudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIGNvbnN0YW50IHZhbHVlLCBidXQgdW5saWtlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUgaW5qZWN0ZWQKICAgICAqIGludG8gY29uZmlndXJhdGlvbiBmdW5jdGlvbiAob3RoZXIgbW9kdWxlcykgYW5kIGl0IGlzIG5vdCBpbnRlcmNlcHRhYmxlIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZGVjb3JhdG9yCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRGVjb3JhdGlvbiBvZiBzZXJ2aWNlLCBhbGxvd3MgdGhlIGRlY29yYXRvciB0byBpbnRlcmNlcHQgdGhlIHNlcnZpY2UgaW5zdGFuY2UgY3JlYXRpb24uIFRoZQogICAgICogcmV0dXJuZWQgaW5zdGFuY2UgbWF5IGJlIHRoZSBvcmlnaW5hbCBpbnN0YW5jZSwgb3IgYSBuZXcgaW5zdGFuY2Ugd2hpY2ggZGVsZWdhdGVzIHRvIHRoZQogICAgICogb3JpZ2luYWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAgICAgKiAgICBpbnN0YW50aWF0ZWQuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnZva2UKICogICAgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLiBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogICAgICoKICAgICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAgICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogICAgICovCgoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICAgICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgICAgICAgIHBhdGggPSBbXSwKICAgICAgICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm92aWRlckluamVjdG9yID0gY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmtub3duIHByb3ZpZGVyOiAiICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZSA9IHt9LAogICAgICAgICAgICBpbnN0YW5jZUluamVjdG9yID0gKGluc3RhbmNlQ2FjaGUuJGluamVjdG9yID0KICAgICAgICAgICAgICAgIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoaW5zdGFuY2VDYWNoZSwgZnVuY3Rpb24oc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24oZm4pIHsgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7IH0pOwoKICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3RvcjsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gJHByb3ZpZGVyCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIGZ1bmN0aW9uIHN1cHBvcnRPYmplY3QoZGVsZWdhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvdmlkZXIgJyArIG5hbWUgKyAnIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7IHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsgfQoKICAgICAgICBmdW5jdGlvbiBzZXJ2aWNlKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsdWUpIHsgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWx1ZSkpOyB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVjb3JhdG9yKHNlcnZpY2VOYW1lLCBkZWNvckZuKSB7CiAgICAgICAgICAgIHZhciBvcmlnUHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlTmFtZSArIHByb3ZpZGVyU3VmZml4KSwKICAgICAgICAgICAgICAgIG9yaWckZ2V0ID0gb3JpZ1Byb3ZpZGVyLiRnZXQ7CgogICAgICAgICAgICBvcmlnUHJvdmlkZXIuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTW9kdWxlIExvYWRpbmcKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKXsKICAgICAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgICAgICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMucHV0KG1vZHVsZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVGbiA9IGFuZ3VsYXJNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gaW52b2tlQXJnc1swXSA9PSAnJGluamVjdG9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHByb3ZpZGVySW5qZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgbW9kdWxlOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBTdHJpbmcobW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2VOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdTZXJ2aWNlIG5hbWUgZXhwZWN0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdDaXJjdWxhciBkZXBlbmRlbmN5OiAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICAkaW5qZWN0ID0gYW5ub3RhdGUoZm4pLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCwgaSwKICAgICAgICAgICAgICAgICAgICBrZXk7CgogICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gJGluamVjdFtpXTsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSBvcHRpbWl6YXRpb246IGh0dHA6Ly9qc3BlcmYuY29tL2FwcGx5LXZzLWNhbGwtdnMtaW52b2tlCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYgPyAtMSA6IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMDogcmV0dXJuIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMTogcmV0dXJuIGZuKGFyZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDI6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAzOiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNDogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDU6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA2OiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNzogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDg6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA5OiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDogcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10sIGFyZ3NbOF0sIGFyZ3NbOV0pOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgICAgICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgICAgICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRhbmNob3JTY3JvbGwKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHRvIHJlbGF0ZWQgZWxlbWVudCwKICAgICAqIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAqIHtAbGluayBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCBIdG1sNSBzcGVjfS4KICAgICAqCiAgICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgICAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICAgICAqLwogICAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgICAgICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2NhdGlvbicsICckcm9vdFNjb3BlJywgZnVuY3Rpb24oJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIGZpbHRlci5maWx0ZXIsIGFzIGl0IGFjY2VwdHMgb25seSBpbnN0YW5jZXMgb2YgQXJyYXkKICAgICAgICAgICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAgICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAgICAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG9lcyBub3Qgc2Nyb2xsIHdoZW4gdXNlciBjbGlja3Mgb24gYW5jaG9yIGxpbmsgdGhhdCBpcyBjdXJyZW50bHkgb24KICAgICAgICAgICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7cmV0dXJuICRsb2NhdGlvbi5oYXNoKCk7fSwKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2hBY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhzY3JvbGwpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc2Nyb2xsOwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogISBUaGlzIGlzIGEgcHJpdmF0ZSB1bmRvY3VtZW50ZWQgc2VydmljZSAhCiAgICAgKgogICAgICogQG5hbWUgbmcuJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkbG9nCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoaXMgb2JqZWN0IGhhcyB0d28gZ29hbHM6CiAgICAgKgogICAgICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogICAgICogLSBhYnN0cmFjdCBhd2F5IGFsbCB0aGUgYnJvd3NlciBzcGVjaWZpYyBmZWF0dXJlcyBhbmQgaW5jb25zaXN0ZW5jaWVzCiAgICAgKgogICAgICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIG5nTW9jay4kYnJvd3NlciBtb2NrIGltcGxlbWVudGF0aW9ufSBvZiB0aGUgYCRicm93c2VyYAogICAgICogc2VydmljZSwgd2hpY2ggY2FuIGJlIHVzZWQgZm9yIGNvbnZlbmllbnQgdGVzdGluZyBvZiB0aGUgYXBwbGljYXRpb24gd2l0aG91dCB0aGUgaW50ZXJhY3Rpb24gd2l0aAogICAgICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogICAgICovCiAgICAvKioKICAgICAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogICAgICogQHBhcmFtIHtvYmplY3R9IGRvY3VtZW50IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBYSFIgWE1MSHR0cFJlcXVlc3QgY29uc3RydWN0b3IuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gJHNuaWZmZXIgJHNuaWZmZXIgc2VydmljZQogICAgICovCiAgICBmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICByYXdEb2N1bWVudCA9IGRvY3VtZW50WzBdLAogICAgICAgICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwKICAgICAgICAgICAgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5LAogICAgICAgICAgICBzZXRUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQsCiAgICAgICAgICAgIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkcyA9IHt9OwoKICAgICAgICBzZWxmLmlzTW9jayA9IGZhbHNlOwoKICAgICAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogICAgICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSB0aGlzIHRlbXBvcmFyeSBhcGkKICAgICAgICBzZWxmLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QgPSBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdDsKICAgICAgICBzZWxmLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSBmdW5jdGlvbigpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAgICAgICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZShvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICAgICAgICovCiAgICAgICAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKCiAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gUG9sbCBXYXRjaGVyIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgICAgICAgcG9sbFRpbWVvdXQ7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2FkZFBvbGxGbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICAgICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICAgICAgICAgIHBvbGxGbnMucHVzaChmbik7CiAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gaW50ZXJ2YWwgSG93IG9mdGVuIHNob3VsZCBicm93c2VyIGNhbGwgcG9sbCBmdW5jdGlvbnMgKG1zKQogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gc2V0VGltZW91dCBSZWZlcmVuY2UgdG8gYSByZWFsIG9yIGZha2UgYHNldFRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ29uZmlndXJlcyB0aGUgcG9sbGVyIHRvIHJ1biBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscywgdXNpbmcgdGhlIHNwZWNpZmllZAogICAgICAgICAqIHNldFRpbWVvdXQgZm4gYW5kIGtpY2tzIGl0IG9mZi4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBzdGFydFBvbGxlcihpbnRlcnZhbCwgc2V0VGltZW91dCkgewogICAgICAgICAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBVUkwgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyksCiAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gbnVsbDsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjdXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBHRVRURVI6CiAgICAgICAgICogV2l0aG91dCBhbnkgYXJndW1lbnQsIHRoaXMgbWV0aG9kIGp1c3QgcmV0dXJucyBjdXJyZW50IHZhbHVlIG9mIGxvY2F0aW9uLmhyZWYuCiAgICAgICAgICoKICAgICAgICAgKiBTRVRURVI6CiAgICAgICAgICogV2l0aCBhdCBsZWFzdCBvbmUgYXJndW1lbnQsIHRoaXMgbWV0aG9kIHNldHMgdXJsIHRvIG5ldyB2YWx1ZS4KICAgICAgICAgKiBJZiBodG1sNSBoaXN0b3J5IGFwaSBzdXBwb3J0ZWQsIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUgaXMgdXNlZCwgb3RoZXJ3aXNlCiAgICAgICAgICogbG9jYXRpb24uaHJlZi9sb2NhdGlvbi5yZXBsYWNlIGlzIHVzZWQuCiAgICAgICAgICogUmV0dXJucyBpdHMgb3duIGluc3RhbmNlIHRvIGFsbG93IGNoYWluaW5nCiAgICAgICAgICoKICAgICAgICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIGNoYW5nZSB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwgKHdoZW4gdXNlZCBhcyBzZXR0ZXIpCiAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gcmVwbGFjZSBTaG91bGQgbmV3IHVybCByZXBsYWNlIGN1cnJlbnQgaGlzdG9yeSByZWNvcmQgPwogICAgICAgICAqLwogICAgICAgIHNlbGYudXJsID0gZnVuY3Rpb24odXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIC8vIHNldHRlcgogICAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gdXJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBsYXN0QnJvd3NlclVybCA9IHVybDsKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2UpIGhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JhenkgT3BlcmEgQnVnOiBodHRwOi8vbXkub3BlcmEuY29tL2NvbW11bml0eS9mb3J1bXMvdG9waWMuZG1sP2lkPTExODU0NjIKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZUVsZW1lbnQuYXR0cignaHJlZicsIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gdXJsOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VkVXJsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICAgICAgICAgIC8vIGdldHRlcgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLSB0aGUgcmVwbGFjZWRVcmwgaXMgYSB3b3JrYXJvdW5kIGZvciBhbiBJRTgtOSBpc3N1ZSB3aXRoIGxvY2F0aW9uLnJlcGxhY2UgbWV0aG9kIHRoYXQgZG9lc24ndCB1cGRhdGUKICAgICAgICAgICAgICAgIC8vICAgbG9jYXRpb24uaHJlZiBzeW5jaHJvbm91c2x5CiAgICAgICAgICAgICAgICAvLyAtIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICAgICAgICAgICAgcmV0dXJuIHJlcGxhY2VkVXJsIHx8IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csIiciKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gc2VsZi51cmwoKSkgcmV0dXJuOwoKICAgICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgICAgICAgICBmb3JFYWNoKHVybENoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI29uVXJsQ2hhbmdlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICogQFRPRE8odm9qdGEpOiByZWZhY3RvciB0byB1c2Ugbm9kZSdzIHN5bnRheCBmb3IgZXZlbnRzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqCiAgICAgICAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBieSBvdXRzaWRlIG9mIGFuZ3VsYXI6CiAgICAgICAgICogLSB1c2VyIHR5cGVzIGRpZmZlcmVudCB1cmwgaW50byBhZGRyZXNzIGJhcgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gaGlzdG9yeSAoZm9yd2FyZC9iYWNrKSBidXR0b24KICAgICAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGEgbGluawogICAgICAgICAqCiAgICAgICAgICogSXQncyBub3QgY2FsbGVkIHdoZW4gdXJsIGlzIGNoYW5nZWQgYnkgJGJyb3dzZXIudXJsKCkgbWV0aG9kCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBuZXcgdXJsIGFzIHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciB1cmwgY2hhbmdlcyBpbiBhbmd1bGFyIGFwcHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZyl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqIEByZXR1cm4ge2Z1bmN0aW9uKHN0cmluZyl9IFJldHVybnMgdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXIgZm4gLSBoYW5keSBpZiB0aGUgZm4gaXMgYW5vbnltb3VzLgogICAgICAgICAqLwogICAgICAgIHNlbGYub25VcmxDaGFuZ2UgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAgICAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAgICAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAgICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIHBvbGxpbmcKICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTWlzYyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nPX0KICAgICAgICAgKi8KICAgICAgICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gYmFzZUVsZW1lbnQuYXR0cignaHJlZicpOwogICAgICAgICAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXmh0dHBzP1w6XC9cL1teXC9dKi8sICcnKSA6ICcnOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gQ29va2llcyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBsYXN0Q29va2llcyA9IHt9OwogICAgICAgIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgICAgICAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2Nvb2tpZXMKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29ra2llIHZhbHVlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICAgICAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgICAgICAgKiA8dWw+CiAgICAgICAgICogICA8bGk+Y29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkgaXQ8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSwgdmFsdWUpIC0+IHNldCBuYW1lIHRvIHZhbHVlLCBpZiB2YWx1ZSBpcyB1bmRlZmluZWQgZGVsZXRlIHRoZSBjb29raWU8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0IHdheSk8L2xpPgogICAgICAgICAqIDwvdWw+CiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAgICAgICAqLwogICAgICAgIHNlbGYuY29va2llcyA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjb29raWVMZW5ndGgsIGNvb2tpZUFycmF5LCBjb29raWUsIGksIGluZGV4OwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgIj07cGF0aD0iICsgY29va2llUGF0aCArICI7ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llTGVuZ3RoID0gKHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICc9JyArIGVzY2FwZSh2YWx1ZSkgKyAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBwZXIgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMjEwOS50eHQgYnJvd3NlciBtdXN0IGFsbG93IGF0IG1pbmltdW06CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gMzAwIGNvb2tpZXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gNDA5NiBieXRlcyBwZXIgY29va2llCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIisKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggKyAiID4gNDA5NiBieXRlcykhIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICAgICAgICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZSA9IGNvb2tpZUFycmF5W2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSB1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKDAsIGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb2xsb3cgYXJlIGZvciBsZXNzIHNwZWNpZmljIHBhdGhzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llc1tuYW1lXSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoaW5kZXggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdENvb2tpZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9uaW91c2x5IHZpYSBgc2V0VGltZW91dChmbiwgZGVsYXkpYC4KICAgICAgICAgKgogICAgICAgICAqIFVubGlrZSB3aGVuIGNhbGxpbmcgYHNldFRpbWVvdXRgIGRpcmVjdGx5LCBpbiB0ZXN0IHRoaXMgZnVuY3Rpb24gaXMgbW9ja2VkIGFuZCBpbnN0ZWFkIG9mIHVzaW5nCiAgICAgICAgICogYHNldFRpbWVvdXRgIGluIHRlc3RzLCB0aGUgZm5zIGFyZSBxdWV1ZWQgaW4gYW4gYXJyYXksIHdoaWNoIGNhbiBiZSBwcm9ncmFtbWF0aWNhbGx5IGZsdXNoZWQKICAgICAgICAgKiB2aWEgYCRicm93c2VyLmRlZmVyLmZsdXNoKClgLgogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2VsZi5kZWZlciA9IGZ1bmN0aW9uKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdOwogICAgICAgICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgICAgICAgICB9LCBkZWxheSB8fCAwKTsKICAgICAgICAgICAgcGVuZGluZ0RlZmVySWRzW3RpbWVvdXRJZF0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGltZW91dElkOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlci5jYW5jZWwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIuZGVmZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENhbmNlbHMgYSBkZWZlcmVkIHRhc2sgaWRlbnRpZmllZCB3aXRoIGBkZWZlcklkYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gZGVmZXJJZCBUb2tlbiByZXR1cm5lZCBieSB0aGUgYCRicm93c2VyLmRlZmVyYCBmdW5jdGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWx5IGNhbmNlbGVkLgogICAgICAgICAqLwogICAgICAgIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgICAgICAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGRlZmVySWQpOwogICAgICAgICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICB9CgogICAgZnVuY3Rpb24gJEJyb3dzZXJQcm92aWRlcigpewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uKCAkd2luZG93LCAgICRsb2csICAgJHNuaWZmZXIsICAgJGRvY3VtZW50KXsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyBjYWNoZSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8gdGhlbS4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICoKICAgICAqICB2YXIgY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAgICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdjYWNoZUlkJykpLnRvQmUoY2FjaGUpOwogICAgICogIGV4cGVjdCgkY2FjaGVGYWN0b3J5LmdldCgnbm9TdWNoQ2FjaGVJZCcpKS5ub3QudG9CZURlZmluZWQoKTsKICAgICAqCiAgICAgKiAgY2FjaGUucHV0KCJrZXkiLCAidmFsdWUiKTsKICAgICAqICBjYWNoZS5wdXQoImFub3RoZXIga2V5IiwgImFub3RoZXIgdmFsdWUiKTsKICAgICAqCiAgICAgKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOyAvLyBTaW5jZSB3ZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogICAgICoKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIHRoZSBuZXdseSBjcmVhdGVkIGNhY2hlLgogICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0IHRoYXQgc3BlY2lmaWVzIHRoZSBjYWNoZSBiZWhhdmlvci4gUHJvcGVydGllczoKICAgICAqCiAgICAgKiAgIC0gYHtudW1iZXI9fWAgYGNhcGFjaXR5YCDigJQgdHVybnMgdGhlIGNhY2hlIGludG8gTFJVIGNhY2hlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IE5ld2x5IGNyZWF0ZWQgY2FjaGUgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBzZXQgb2YgbWV0aG9kczoKICAgICAqCiAgICAgKiAtIGB7b2JqZWN0fWAgYGluZm8oKWAg4oCUIFJldHVybnMgaWQsIHNpemUsIGFuZCBvcHRpb25zIG9mIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUuCiAgICAgKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogICAgICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgICAgICAgICAgZnVuY3Rpb24gY2FjaGVGYWN0b3J5KGNhY2hlSWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdjYWNoZUlkICcgKyBjYWNoZUlkICsgJyB0YWtlbicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzaXplID0gMCwKICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgICAgICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbHJ1RW50cnkpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IGZyZXNoRW5kKSBmcmVzaEVuZCA9IGxydUVudHJ5LnA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBzdGFsZUVuZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgaW5mbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRjYWNoZUZhY3RvcnkjaW5mbwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGFsbCB0aGUgb2YgdGhlIGNhY2hlcyB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IC0ga2V5LXZhbHVlIG1hcCBvZiBgY2FjaGVJZGAgdG8gdGhlIHJlc3VsdCBvZiBjYWxsaW5nIGBjYWNoZSNpbmZvYAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FjaGVGYWN0b3J5LmluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgICAgICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24oY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5I2dldAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogR2V0IGFjY2VzcyB0byBhIGNhY2hlIG9iamVjdCBieSB0aGUgYGNhY2hlSWRgIHVzZWQgd2hlbiBpdCB3YXMgY3JlYXRlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiBhIGNhY2hlIHRvIGFjY2Vzcy4KICAgICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQ2FjaGUgb2JqZWN0IGlkZW50aWZpZWQgYnkgdGhlIGNhY2hlSWQgb3IgdW5kZWZpbmVkIGlmIG5vIHN1Y2ggY2FjaGUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24oY2FjaGVJZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICByZXR1cm4gY2FjaGVGYWN0b3J5OwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kdGVtcGxhdGVDYWNoZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGZpcnN0IHRpbWUgYSB0ZW1wbGF0ZSBpcyB1c2VkLCBpdCBpcyBsb2FkZWQgaW4gdGhlIHRlbXBsYXRlIGNhY2hlIGZvciBxdWljayByZXRyaWV2YWwuICBZb3UgY2FuCiAgICAgKiBsb2FkIHRlbXBsYXRlcyBkaXJlY3RseSBpbnRvIHRoZSBjYWNoZSBpbiBhIGBzY3JpcHRgIHRhZywgb3IgYnkgY29uc3VtaW5nIHRoZSBgJHRlbXBsYXRlQ2FjaGVgCiAgICAgKiBzZXJ2aWNlIGRpcmVjdGx5LgogICAgICoKICAgICAqIEFkZGluZyB2aWEgdGhlIGBzY3JpcHRgIHRhZzoKICAgICAqIDxwcmU+CiAgICAgKiA8aHRtbCBuZy1hcHA+CiAgICAgKiA8aGVhZD4KICAgICAqIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlSWQuaHRtbCI+CiAgICAgKiAgIFRoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlCiAgICAgKiA8L3NjcmlwdD4KICAgICAqIDwvaGVhZD4KICAgICAqICAgLi4uCiAgICAgKiA8L2h0bWw+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAqKk5vdGU6KiogdGhlIGBzY3JpcHRgIHRhZyBjb250YWluaW5nIHRoZSB0ZW1wbGF0ZSBkb2VzIG5vdCBuZWVkIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBgaGVhZGAgb2YgdGhlIGRvY3VtZW50LCBidXQKICAgICAqIGl0IG11c3QgYmUgYmVsb3cgdGhlIGBuZy1hcHBgIGRlZmluaXRpb24uCiAgICAgKgogICAgICogQWRkaW5nIHZpYSB0aGUgJHRlbXBsYXRlQ2FjaGUgc2VydmljZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pOwogICAgICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAqICAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0ZW1wbGF0ZUlkLmh0bWwnLCAnVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUnKTsKICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogICAgICogPHByZT4KICAgICAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBvciBnZXQgaXQgdmlhIEphdmFzY3JpcHQ6CiAgICAgKiA8cHJlPgogICAgICogJHRlbXBsYXRlQ2FjaGUuZ2V0KCd0ZW1wbGF0ZUlkLmh0bWwnKQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCd0ZW1wbGF0ZXMnKTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICAgICAqCiAgICAgKiBET00tcmVsYXRlZCB2YXJpYWJsZXM6CiAgICAgKgogICAgICogLSAibm9kZSIgLSBET00gTm9kZQogICAgICogLSAiZWxlbWVudCIgLSBET00gRWxlbWVudCBvciBOb2RlCiAgICAgKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogICAgICoKICAgICAqCiAgICAgKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogICAgICoKICAgICAqIC0gImxpbmtGbiIgLSBsaW5raW5nIGZuIG9mIGEgc2luZ2xlIGRpcmVjdGl2ZQogICAgICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAgICAgKiAtICJjb21wb3NpdGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBjb21waWxhdGlvbiByb290IChub2RlTGlzdCkKICAgICAqLwoKCiAgICB2YXIgTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiA9ICdOb24tYXNzaWduYWJsZSBtb2RlbCBleHByZXNzaW9uOiAnOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGNvbXBpbGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogICAgICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogICAgICoKICAgICAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICAgICAqIGV4ZWN1dGVzIGNvcnJlc3BvbmRpbmcgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogICAgICogaW5zdGFuY2UgZnVuY3Rpb25zIGludG8gYSBzaW5nbGUgdGVtcGxhdGUgZnVuY3Rpb24gd2hpY2ggaXMgdGhlbiByZXR1cm5lZC4KICAgICAqCiAgICAgKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2gKICAgICAqIGNhc2UgZWFjaCBjYWxsIHJlc3VsdHMgaW4gYSB2aWV3IHRoYXQgaXMgYSBET00gY2xvbmUgb2YgdGhlIG9yaWdpbmFsIHRlbXBsYXRlLgogICAgICoKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJjb21waWxlIj4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIC8vIGRlY2xhcmUgYSBuZXcgbW9kdWxlLCBhbmQgaW5qZWN0IHRoZSAkY29tcGlsZVByb3ZpZGVyCiAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgIC8vIGNvbmZpZ3VyZSBuZXcgJ2NvbXBpbGUnIGRpcmVjdGl2ZSBieSBwYXNzaW5nIGEgZGlyZWN0aXZlCiAgICAgICAgLy8gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gaW5qZWN0cyB0aGUgJyRjb21waWxlJwogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZSBmYWN0b3J5IGNyZWF0ZXMgYSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBmb3IgY2hhbmdlcwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBpdCBpbnRvIHRoZSBjdXJyZW50IERPTQogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBuZXcgRE9NIGFuZCBsaW5rIGl0IHRvIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAvLyBzY29wZS4KICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBnZXQgaW50byBpbmZpbml0ZSBsb29wIGNvbXBpbGluZyBvdXJzZWx2ZXMKICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLm5hbWUgPSAnQW5ndWxhcic7CiAgICAgICAgJHNjb3BlLmh0bWwgPSAnSGVsbG8ge3tuYW1lfX0nOwogICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJodG1sIj48L3RleHRhcmVhPiA8YnI+CiAgICAgPGRpdiBjb21waWxlPSJodG1sIj48L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGF1dG8gY29tcGlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoJ2Rpdltjb21waWxlXScpLnRleHQoKSkudG9CZSgnSGVsbG8gQW5ndWxhcicpOwogICAgICAgaW5wdXQoJ2h0bWwnKS5lbnRlcigne3tuYW1lfX0hJyk7CiAgICAgICBleHBlY3QoZWxlbWVudCgnZGl2W2NvbXBpbGVdJykudGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZSBmdW5jdGlvbiBhdmFpbGFibGUgdG8gZGlyZWN0aXZlcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhQcmlvcml0eSBvbmx5IGFwcGx5IGRpcmVjdGl2ZXMgbG93ZXIgdGhlbiBnaXZlbiBwcmlvcml0eSAoT25seSBlZmZlY3RzIHRoZQogICAgICogICAgICAgICAgICAgICAgIHJvb3QgZWxlbWVudChzKSwgbm90IHRoZWlyIGNoaWxkcmVuKQogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHNjb3BlWywgY2xvbmVBdHRhY2hGbl0pfSBhIGxpbmsgZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBiaW5kIHRlbXBsYXRlCiAgICAgKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICAgICAqCiAgICAgKiAgKiBgc2NvcGVgIC0gQSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBTY29wZX0gdG8gYmluZCB0by4KICAgICAqICAqIGBjbG9uZUF0dGFjaEZuYCAtIElmIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZCwgdGhlbiB0aGUgbGluayBmdW5jdGlvbiB3aWxsIGNsb25lIHRoZQogICAgICogICAgICAgICAgICAgICBgdGVtcGxhdGVgIGFuZCBjYWxsIHRoZSBgY2xvbmVBdHRhY2hGbmAgZnVuY3Rpb24gYWxsb3dpbmcgdGhlIGNhbGxlciB0byBhdHRhY2ggdGhlCiAgICAgKiAgICAgICAgICAgICAgIGNsb25lZCBlbGVtZW50cyB0byB0aGUgRE9NIGRvY3VtZW50IGF0IHRoZSBhcHByb3ByaWF0ZSBwbGFjZS4gVGhlIGBjbG9uZUF0dGFjaEZuYCBpcwogICAgICogICAgICAgICAgICAgICBjYWxsZWQgYXM6IDxicj4gYGNsb25lQXR0YWNoRm4oY2xvbmVkRWxlbWVudCwgc2NvcGUpYCB3aGVyZToKICAgICAqCiAgICAgKiAgICAgICogYGNsb25lZEVsZW1lbnRgIC0gaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgYGVsZW1lbnRgIHBhc3NlZCBpbnRvIHRoZSBjb21waWxlci4KICAgICAqICAgICAgKiBgc2NvcGVgIC0gaXMgdGhlIGN1cnJlbnQgc2NvcGUgd2l0aCB3aGljaCB0aGUgbGlua2luZyBmdW5jdGlvbiBpcyB3b3JraW5nIHdpdGguCiAgICAgKgogICAgICogQ2FsbGluZyB0aGUgbGlua2luZyBmdW5jdGlvbiByZXR1cm5zIHRoZSBlbGVtZW50IG9mIHRoZSB0ZW1wbGF0ZS4gSXQgaXMgZWl0aGVyIHRoZSBvcmlnaW5hbCBlbGVtZW50CiAgICAgKiBwYXNzZWQgaW4sIG9yIHRoZSBjbG9uZSBvZiB0aGUgZWxlbWVudCBpZiB0aGUgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLgogICAgICoKICAgICAqIEFmdGVyIGxpbmtpbmcgdGhlIHZpZXcgaXMgbm90IHVwZGF0ZWQgdW50aWwgYWZ0ZXIgYSBjYWxsIHRvICRkaWdlc3Qgd2hpY2ggdHlwaWNhbGx5IGlzIGRvbmUgYnkKICAgICAqIEFuZ3VsYXIgYXV0b21hdGljYWxseS4KICAgICAqCiAgICAgKiBJZiB5b3UgbmVlZCBhY2Nlc3MgdG8gdGhlIGJvdW5kIHZpZXcsIHRoZXJlIGFyZSB0d28gd2F5cyB0byBkbyBpdDoKICAgICAqCiAgICAgKiAtIElmIHlvdSBhcmUgbm90IGFza2luZyB0aGUgbGlua2luZyBmdW5jdGlvbiB0byBjbG9uZSB0aGUgdGVtcGxhdGUsIGNyZWF0ZSB0aGUgRE9NIGVsZW1lbnQocykKICAgICAqICAgYmVmb3JlIHlvdSBzZW5kIHRoZW0gdG8gdGhlIGNvbXBpbGVyIGFuZCBrZWVwIHRoaXMgcmVmZXJlbmNlIGFyb3VuZC4KICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8cD57e3RvdGFsfX08L3A+Jykoc2NvcGUpOwogICAgICogICA8L3ByZT4KICAgICAqCiAgICAgKiAtIGlmIG9uIHRoZSBvdGhlciBoYW5kLCB5b3UgbmVlZCB0aGUgZWxlbWVudCB0byBiZSBjbG9uZWQsIHRoZSB2aWV3IHJlZmVyZW5jZSBmcm9tIHRoZSBvcmlnaW5hbAogICAgICogICBleGFtcGxlIHdvdWxkIG5vdCBwb2ludCB0byB0aGUgY2xvbmUsIGJ1dCByYXRoZXIgdG8gdGhlIG9yaWdpbmFsIHRlbXBsYXRlIHRoYXQgd2FzIGNsb25lZC4gSW4KICAgICAqICAgdGhpcyBjYXNlLCB5b3UgY2FuIGFjY2VzcyB0aGUgY2xvbmUgdmlhIHRoZSBjbG9uZUF0dGFjaEZuOgogICAgICogICA8cHJlPgogICAgICogICAgIHZhciB0ZW1wbGF0ZUhUTUwgPSBhbmd1bGFyLmVsZW1lbnQoJzxwPnt7dG90YWx9fTwvcD4nKSwKICAgICAqICAgICAgICAgc2NvcGUgPSAuLi4uOwogICAgICoKICAgICAqICAgICB2YXIgY2xvbmVkRWxlbWVudCA9ICRjb21waWxlKHRlbXBsYXRlSFRNTCkoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7CiAqICAgICAgIC8vYXR0YWNoIHRoZSBjbG9uZSB0byBET00gZG9jdW1lbnQgYXQgdGhlIHJpZ2h0IHBsYWNlCiAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAgICAgKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKi8KICAgICRDb21waWxlUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICAgIGZ1bmN0aW9uICRDb21waWxlUHJvdmlkZXIoJHByb3ZpZGUpIHsKICAgICAgICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICAgICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd1wtX10rKVxzKyguKikkLywKICAgICAgICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3XC1fXSspKD86XDooW147XSspKT87PykvLAogICAgICAgICAgICBNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SID0gJ1RlbXBsYXRlIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHdhczogJywKICAgICAgICAgICAgdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooaHR0cHM/fGZ0cHxtYWlsdG98ZmlsZSk6LzsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgbmV3IGRpcmVjdGl2ZSB3aXRoIHRoZSBjb21waWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGRpcmVjdGl2ZSBpbiBjYW1lbC1jYXNlLiAoaWUgPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaCB3aWxsIG1hdGNoIGFzCiAgICAgICAgICogICAgICAgICAgICAgICAgPGNvZGU+bmctYmluZDwvY29kZT4pLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258QXJyYXl9IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdG9yeSBmdW5jdGlvbi4gU2VlIHtAbGluayBndWlkZS9kaXJlY3RpdmV9IGZvciBtb3JlCiAgICAgICAgICogICAgICAgICAgICAgICAgaW5mby4KICAgICAgICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5kaXJlY3RpdmUgPSBmdW5jdGlvbiByZWdpc3RlckRpcmVjdGl2ZShuYW1lLCBkaXJlY3RpdmVGYWN0b3J5KSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhuYW1lKSkgewogICAgICAgICAgICAgICAgYXNzZXJ0QXJnKGRpcmVjdGl2ZUZhY3RvcnksICdkaXJlY3RpdmUnKTsKICAgICAgICAgICAgICAgIGlmICghaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBTdWZmaXgsIFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24oZGlyZWN0aXZlRmFjdG9yeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSB7IGNvbXBpbGU6IHZhbHVlRm4oZGlyZWN0aXZlKSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLmNvbXBpbGUgPSB2YWx1ZUZuKGRpcmVjdGl2ZS5saW5rKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgPSBkaXJlY3RpdmUubmFtZSB8fCBuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlIHx8IChkaXJlY3RpdmUuY29udHJvbGxlciAmJiBkaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgICAgICAgICAgICAgfV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXS5wdXNoKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yRWFjaChuYW1lLCByZXZlcnNlUGFyYW1zKHJlZ2lzdGVyRGlyZWN0aXZlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIjdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgICAgICoKICAgICAgICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50byBhbgogICAgICAgICAqIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcyB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYHVybFNhbml0aXphdGlvbldoaXRlbGlzdGAgcmVndWxhcgogICAgICAgICAqIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlIHRoZQogICAgICAgICAqIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGl0IGlzIHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy51cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgICAgICAgICB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbCiAgICAgICAgICAgICckaW5qZWN0b3InLCAnJGludGVycG9sYXRlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRwYXJzZScsCiAgICAgICAgICAgICckY29udHJvbGxlcicsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgICAkaW50ZXJwb2xhdGUsICAgJGV4Y2VwdGlvbkhhbmRsZXIsICAgJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUsICAgJHBhcnNlLAogICAgICAgICAgICAgICAgICAgICAkY29udHJvbGxlciwgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCkgewoKICAgICAgICAgICAgICAgIHZhciBBdHRyaWJ1dGVzID0gZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyID0gYXR0ciB8fCB7fTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgQXR0cmlidXRlcy5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogU2V0IGEgbm9ybWFsaXplZCBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgaW4gYSB3YXkgc3VjaCB0aGF0IGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKQogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGJvb2xlYW59IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuIElmIGBudWxsYCBhdHRyaWJ1dGUgd2lsbCBiZSBkZWxldGVkLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF0dHJOYW1lIE9wdGlvbmFsIG5vbmUgbm9ybWFsaXplZCBuYW1lLiBEZWZhdWx0cyB0byBrZXkuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTmFtZV8odGhpcy4kJGVsZW1lbnRbMF0pID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbk5vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhyZWYgcHJvcGVydHkgYWx3YXlzIHJldHVybnMgbm9ybWFsaXplZCBhYnNvbHV0ZSB1cmwsIHNvIHdlIGNhbiBtYXRjaCBhZ2FpbnN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxTYW5pdGl6YXRpb25Ob2RlLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFZhbCAhPT0gJycgJiYgIW5vcm1hbGl6ZWRWYWwubWF0Y2godXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogT2JzZXJ2ZSBhbiBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBvYnNlcnZlciB3aWxsIG5ldmVyIGJlIGNhbGxlZCwgaWYgZ2l2ZW4gYXR0cmlidXRlIGlzIG5vdCBpbnRlcnBvbGF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpIC4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCopfSBmbiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBhdHRyaWJ1dGUgdmFsdWUgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKil9IHRoZSBgZm5gIEZ1bmN0aW9uIHBhc3NlZCBpbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkb2JzZXJ2ZTogZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCRvYnNlcnZlcnMgPSAoYXR0cnMuJCRvYnNlcnZlcnMgfHwgKGF0dHJzLiQkb2JzZXJ2ZXJzID0ge30pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sICA9PSAnfX0nKQogICAgICAgICAgICAgICAgICAgICAgICA/IGlkZW50aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gZGVub3JtYWxpemVUZW1wbGF0ZSh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZTsKCiAgICAgICAgICAgICAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IGFsd2F5cyByZXdyYXBzLCB3aGVyZWFzIHdlIG5lZWQgdG8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNlbGVjdG9yIHNvIHRoYXQgd2UgY2FuIG1vZGlmeSBpdC4KICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlcyA9IGpxTGl0ZSgkY29tcGlsZU5vZGVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAgICAgICAgICAgICAgIC8vIG5vdCBiZSBhYmxlIHRvIGF0dGFjaCBzY29wZSBkYXRhIHRvIHRoZW0sIHNvIHdlIHdpbGwgd3JhcCB0aGVtIGluIDxzcGFuPgogICAgICAgICAgICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24obm9kZSwgaW5kZXgpewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbil7CiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0gY2xvbmVDb25uZWN0Rm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gSlFMaXRlUHJvdG90eXBlLmNsb25lLmNhbGwoJGNvbXBpbGVOb2RlcykgLy8gSU1QT1JUQU5UISEhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRjb21waWxlTm9kZXM7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggc2NvcGUgb25seSB0byBub24tdGV4dCBub2Rlcy4KICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSAkbGlua05vZGUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gJGxpbmtOb2RlW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiBlbGVtZW50ICovIHx8IG5vZGUubm9kZVR5cGUgPT0gOSAvKiBkb2N1bWVudCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsaW5rTm9kZS5lcShpKS5kYXRhKCckc2NvcGUnLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRsaW5rTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbG9uZUNvbm5lY3RGbikgY2xvbmVDb25uZWN0Rm4oJGxpbmtOb2RlLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb3NpdGVMaW5rRm4pIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgJGxpbmtOb2RlLCAkbGlua05vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gd3JvbmdNb2RlKGxvY2FsTmFtZSwgbW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbnN1cHBvcnRlZCAnIiArIG1vZGUgKyAiJyBmb3IgJyIgKyBsb2NhbE5hbWUgKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQ29tcGlsZSBmdW5jdGlvbiBtYXRjaGVzIGVhY2ggbm9kZSBpbiBub2RlTGlzdCBhZ2FpbnN0IHRoZSBkaXJlY3RpdmVzLiBPbmNlIGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbnMgcmV0dXJuIHZhbHVlcyAtIHRoZSBsaW5raW5nIGZ1bmN0aW9ucyAtIGFyZSBjb21iaW5lZCBpbnRvIGEgY29tcG9zaXRlIGxpbmtpbmcKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uLCB3aGljaCBpcyB0aGUgYSBsaW5raW5nIGZ1bmN0aW9uIGZvciB0aGUgbm9kZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGVMaXN0fSBub2RlTGlzdCBhbiBhcnJheSBvZiBub2RlcyBvciBOb2RlTGlzdCB0byBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gJHJvb3RFbGVtZW50IElmIHRoZSBub2RlTGlzdCBpcyB0aGUgcm9vdCBvZiB0aGUgY29tcGlsYXRpb24gdHJlZSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHJvb3RFbGVtZW50IG11c3QgYmUgc2V0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBvZiB0aGUgY29tcGlsZSByb290LiBUaGlzIGlzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heCBkaXJlY3RpdmUgcHJpb3JpdHkKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHs/ZnVuY3Rpb259IEEgY29tcG9zaXRlIGxpbmtpbmcgZnVuY3Rpb24gb2YgYWxsIG9mIHRoZSBtYXRjaGVkIGRpcmVjdGl2ZXMgb3IgbnVsbC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZU5vZGVzKG5vZGVMaXN0LCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0ZucyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgZGlyZWN0aXZlcywgYXR0cnMsIGxpbmtGbkZvdW5kOwoKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbnMucHVzaChjaGlsZExpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiwgaSwgaWksIG47CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gbm9kZUxpc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gc3RhYmxlTm9kZUxpc3Rbbl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuID0gbGlua0Zuc1tpKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldyhpc09iamVjdChub2RlTGlua0ZuLnNjb3BlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxTGl0ZShub2RlKS5kYXRhKCckc2NvcGUnLCBjaGlsZFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gbm9kZUxpbmtGbi50cmFuc2NsdWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFRyYW5zY2x1ZGVGbiB8fCAoIWJvdW5kVHJhbnNjbHVkZUZuICYmIHRyYW5zY2x1ZGVGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjbG9uZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZVNjb3BlLCBjbG9uZUZuKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmQoJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlU2NvcGUsIHRyYW5zY2x1ZGVTY29wZS4kZGVzdHJveSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAgICAgICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKG5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIHRoZSBub2RlIG5hbWU6IDxkaXJlY3RpdmU+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGF0dHIsIG5hbWUsIG5OYW1lLCB2YWx1ZSwgbkF0dHJzID0gbm9kZS5hdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaiA9IDAsIGpqID0gbkF0dHJzICYmIG5BdHRycy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1zaWUgfHwgbXNpZSA+PSA4IHx8IGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQgY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMgb24gaXQuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sIGpxQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXJtaW5hbFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsgLy8gcHJldmVudCBmdXJ0aGVyIHByb2Nlc3Npbmcgb2YgZGlyZWN0aXZlcwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCdpc29sYXRlZCBzY29wZScsIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1pc29sYXRlLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRjb21waWxlTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG5ld1Njb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZS5uYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLmNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgiJyIgKyBkaXJlY3RpdmVOYW1lICsgIicgY29udHJvbGxlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0sIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUudHJhbnNjbHVkZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIHRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnICcgKyBkaXJlY3RpdmVOYW1lICsgJzogJyArIHRlbXBsYXRlQXR0cnNbZGlyZWN0aXZlTmFtZV0gKyAnICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZSgkdGVtcGxhdGVbMF0pLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuLCB0ZXJtaW5hbFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKSkuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKCc8ZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmltKGRpcmVjdGl2ZVZhbHVlKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SICsgZGlyZWN0aXZlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tYmluZSBkaXJlY3RpdmVzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUgYW5kIGZyb20gdGhlIHRlbXBsYXRlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gdGFrZSB0aGUgYXJyYXkgb2YgZGlyZWN0aXZlcyBmb3IgdGhpcyBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCB3ZXJlIGFscmVhZHkgYXBwbGllZCBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBjb2xsZWN0IGRpcmVjdGl2ZXMgZnJvbSB0aGUgdGVtcGxhdGUsIGFkZCB0aGVtIHRvIHRoZSBzZWNvbmQgZ3JvdXAgYW5kIHNvcnQgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gYXBwZW5kIHRoZSBzZWNvbmQgZ3JvdXAgd2l0aCBuZXcgZGlyZWN0aXZlcyB0byB0aGUgZmlyc3QgZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5jb25jYXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3REaXJlY3RpdmVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnNwbGljZShpICsgMSwgZGlyZWN0aXZlcy5sZW5ndGggLSAoaSArIDEpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RlbXBsYXRlQXR0cnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModGVtcGxhdGVBdHRycywgbmV3VGVtcGxhdGVBdHRycyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZVVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywganFDb2xsZWN0aW9uLCBkaXJlY3RpdmUucmVwbGFjZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiA9IGRpcmVjdGl2ZS5jb21waWxlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpbmtGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhudWxsLCBsaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobGlua0ZuLnByZSwgbGlua0ZuLnBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkY29tcGlsZU5vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZXJtaW5hbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50ZXJtaW5hbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZTsKICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgPSB0cmFuc2NsdWRlRGlyZWN0aXZlICYmIGNoaWxkVHJhbnNjbHVkZUZuOwoKICAgICAgICAgICAgICAgICAgICAvLyBtaWdodCBiZSBub3JtYWwgb3IgZGVsYXllZCBub2RlTGlua0ZuIGRlcGVuZGluZyBvbiBpZiB0ZW1wbGF0ZVVybCBpcyBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVMaW5rRm47CgogICAgICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZExpbmtGbnMocHJlLCBwb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVMaW5rRm5zLnB1c2gocHJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdC5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udHJvbGxlcnMocmVxdWlyZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLCByZXRyaWV2YWxNZXRob2QgPSAnZGF0YScsIG9wdGlvbmFsID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoKHZhbHVlID0gcmVxdWlyZS5jaGFyQXQoMCkpID09ICdeJyB8fCB2YWx1ZSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlID0gcmVxdWlyZS5zdWJzdHIoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWV2YWxNZXRob2QgPSAnaW5oZXJpdGVkRGF0YSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAkZWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiTm8gY29udHJvbGxlcjogIiArIHJlcXVpcmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlcXVpcmUsIGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSlccyooXHcqKVxzKiQvOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlLiRwYXJlbnQgfHwgc2NvcGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uKGRlZmluaXRvbiwgc2NvcGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdG9uLm1hdGNoKExPQ0FMX1JFR0VYUCkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gbWF0Y2hbMl18fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCwgcGFyZW50U2V0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kJGlzb2xhdGVCaW5kaW5nc1tzY29wZU5hbWVdID0gbW9kZSArIGF0dHJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0AnOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgY2hhbmdlLCBvciB3ZSB3aWxsIHRocm93IHRoaXMgZXhjZXB0aW9uIG9uIGV2ZXJ5ICRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgYXR0cnNbYXR0ck5hbWVdICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAoZGlyZWN0aXZlOiAnICsgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUgKyAnKScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQocGFyZW50U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFZhbHVlICE9PSBzY29wZVtzY29wZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwYXJlbnQgY2hhbmdlZCBhbmQgaXQgaGFzIHByZWNlZGVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBwYXJlbnQgY2FuIGJlIGFzc2lnbmVkIHRoZW4gZG8gc28KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChwYXJlbnRTY29wZSwgcGFyZW50VmFsdWUgPSBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICcmJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24obG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChwYXJlbnRTY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUgKyAnOiAnICsgZGVmaW5pdG9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IGJvdW5kVHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBwcmVMaW5rRm5zW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4ucmVxdWlyZSwgJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gJiYgY2hpbGRMaW5rRm4oc2NvcGUsIGxpbmtOb2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUE9TVExJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHBvc3RMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbG9va3MgdXAgdGhlIGRpcmVjdGl2ZSBhbmQgZGVjb3JhdGVzIGl0IHdpdGggZXhjZXB0aW9uIGhhbmRsaW5nIGFuZCBwcm9wZXIgcGFyYW1ldGVycy4gV2UKICAgICAgICAgICAgICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAgICAgICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICAgICAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgKiAgICogYENgOiBjbGFzcwogICAgICAgICAgICAgICAgICogICAqIGBNYDogY29tbWVudAogICAgICAgICAgICAgICAgICogQHJldHVybnMgdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGREaXJlY3RpdmUodERpcmVjdGl2ZXMsIG5hbWUsIGxvY2F0aW9uLCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAobWF4UHJpb3JpdHkgPT09IHVuZGVmaW5lZCB8fCBtYXhQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAgICAgICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICs9IChrZXkgPT09ICdzdHlsZScgPyAnOycgOiAnICcpICsgc3JjW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3QuJHNldChrZXksIHZhbHVlLCB0cnVlLCBzcmNBdHRyW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzcmMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFsnY2xhc3MnXSA9IChkc3RbJ2NsYXNzJ10gPyBkc3RbJ2NsYXNzJ10gKyAnICcgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYXR0cignc3R5bGUnLCAkZWxlbWVudC5hdHRyKCdzdHlsZScpICsgJzsnICsgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdEF0dHJba2V5XSA9IHNyY0F0dHJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQsIHJlcGxhY2UsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oY29udGVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVOb2RlLCB0ZW1wVGVtcGxhdGVBdHRycywgJHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGNvbnRlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKCc8ZGl2PicgKyB0cmltKGNvbnRlbnQpICsgJzwvZGl2PicpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKE1VTFRJX1JPT1RfVEVNUExBVEVfRVJST1IgKyBjb250ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgZGlyZWN0aXZlcywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRBdHRycywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuID0gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0QXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVbMF0uY2hpbGROb2RlcywgY2hpbGRUcmFuc2NsdWRlRm4pOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShsaW5rUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gY29tcGlsZU5vZGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBKUUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGxpbmtSb290RWxlbWVudCwganFMaXRlKGJlZm9yZVRlbXBsYXRlTGlua05vZGUpLCBsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihyZXNwb25zZSwgY29kZSwgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignRmFpbGVkIHRvIGxvYWQgdGVtcGxhdGU6ICcgKyBjb25maWcudXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkZWxheWVkTm9kZUxpbmtGbihpZ25vcmVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5rUXVldWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2gocm9vdEVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogU29ydGluZyBmdW5jdGlvbiBmb3IgYm91bmQgZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGIucHJpb3JpdHkgLSBhLnByaW9yaXR5OwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdNdWx0aXBsZSBkaXJlY3RpdmVzIFsnICsgcHJldmlvdXNEaXJlY3RpdmUubmFtZSArICcsICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgKyAnXSBhc2tpbmcgZm9yICcgKyB3aGF0ICsgJyBvbjogJyArICBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHRleHQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gdGV4dEludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gcGFyZW50LmRhdGEoJyRiaW5kaW5nJykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MocGFyZW50LmRhdGEoJyRiaW5kaW5nJywgYmluZGluZ3MpLCAnbmctYmluZGluZycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAvLyBubyBpbnRlcnBvbGF0aW9uIGZvdW5kIC0+IGlnbm9yZQogICAgICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgcmV0dXJuOwoKCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZTogdmFsdWVGbihmdW5jdGlvbiBhdHRySW50ZXJwb2xhdGVMaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkJG9ic2VydmVycyA9IChhdHRyLiQkb2JzZXJ2ZXJzIHx8IChhdHRyLiQkb2JzZXJ2ZXJzID0ge30pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gaW50ZXJwb2xhdGUgY2xhc3NlcyBhZ2FpbiwgaW4gdGhlIGNhc2UgdGhlIGVsZW1lbnQgd2FzIHJlcGxhY2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHRoZXJlZm9yZSB0aGUgdHdvIGNsYXNzIGF0dHJzIGdvdCBtZXJnZWQgLSB3ZSB3YW50IHRvIGludGVycG9sYXRlIHRoZSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGF0dHJbbmFtZV0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoJCRvYnNlcnZlcnNbbmFtZV0gfHwgKCQkb2JzZXJ2ZXJzW25hbWVdID0gW10pKS4kJGludGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChhdHRyLiQkb2JzZXJ2ZXJzICYmIGF0dHIuJCRvYnNlcnZlcnNbbmFtZV0uJCRzY29wZSB8fCBzY29wZSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFRoaXMgaXMgYSBzcGVjaWFsIGpxTGl0ZS5yZXBsYWNlV2l0aCwgd2hpY2ggY2FuIHJlcGxhY2UgaXRlbXMgd2hpY2gKICAgICAgICAgICAgICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pxTGl0ZT19ICRyb290RWxlbWVudCBUaGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlLiBVc2VkIHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAgICAgICAgICAgICAqICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtKcUxpdGV9ICRlbGVtZW50IFRoZSBqcUxpdGUgZWxlbWVudCB3aGljaCB3ZSBhcmUgZ29pbmcgdG8gcmVwbGFjZS4gV2Uga2VlcCB0aGUgc2hlbGwsCiAgICAgICAgICAgICAgICAgKiAgICBidXQgcmVwbGFjZSBpdHMgRE9NIG5vZGUgcmVmZXJlbmNlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtOb2RlfSBuZXdOb2RlIFRoZSBuZXcgRE9NIG5vZGUuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGVsZW1lbnQsIG5ld05vZGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkTm9kZSA9ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBvbGROb2RlLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGksIGlpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBvbGROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50W2ldID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbmV3Tm9kZVtqcUxpdGUuZXhwYW5kb10gPSBvbGROb2RlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudFswXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaVJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4KICAgICAqLwoKCgogICAgLyoqCiAgICAgKiBDbG9zdXJlIGNvbXBpbGVyIHR5cGUgaW5mb3JtYXRpb24KICAgICAqLwoKICAgIGZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oCiAgICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgICAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwKICAgICAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgICAgIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgogICAgICAgICl7fQoKICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigKICAgICAgICAvKiBub2Rlc2V0TGlua2luZ0ZuICovIG5vZGVzZXRMaW5raW5nRm4sCiAgICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgICAvKiBOb2RlICovIG5vZGUsCiAgICAgICAgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwKICAgICAgICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KICAgICAgICApe30KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogICAgICogY29udHJvbGxlcnMuCiAgICAgKgogICAgICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogICAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICAgICAgICB2YXIgY29udHJvbGxlcnMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbnRyb2xsZXJQcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAgICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAgICAgICAqLwogICAgICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICBpZiAoaXNPYmplY3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVycywgbmFtZSkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJzW25hbWVdID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJHdpbmRvdycsIGZ1bmN0aW9uKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlcgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGgge0BsaW5rIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgKICAgICAqIEJDIHZlcnNpb259LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnN0cnVjdG9yLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGNvbnN0cnVjdG9yKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIG5hbWUsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBuYW1lLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oY29uc3RydWN0b3IsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IsIGxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZG9jdW1lbnQKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogICAgICogZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbih3aW5kb3cpewogICAgICAgICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRleGNlcHRpb25IYW5kbGVyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICAgKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICAgICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICAgKgogICAgICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICAgICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICAgICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbigkbG9nKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihleGNlcHRpb24sIGNhdXNlKSB7CiAgICAgICAgICAgICAgICAkbG9nLmVycm9yLmFwcGx5KCRsb2csIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGludGVycG9sYXRpb24gbWFya3VwLiBEZWZhdWx0cyB0byBge3tgIGFuZCBgfX1gLgogICAgICovCiAgICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogICAgICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBlbmRpbmcgc3ltYm9sIHRvLgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5lbmRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCBmdW5jdGlvbigkcGFyc2UpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0U3ltYm9sTGVuZ3RoID0gc3RhcnRTeW1ib2wubGVuZ3RoLAogICAgICAgICAgICAgICAgZW5kU3ltYm9sTGVuZ3RoID0gZW5kU3ltYm9sLmxlbmd0aDsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlCiAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHBhcnNlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBDb21waWxlcyBhIHN0cmluZyB3aXRoIG1hcmt1cCBpbnRvIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFRoaXMgc2VydmljZSBpcyB1c2VkIGJ5IHRoZQogICAgICAgICAgICAgKiBIVE1MIHtAbGluayBuZy4kY29tcGlsZSAkY29tcGlsZX0gc2VydmljZSBmb3IgZGF0YSBiaW5kaW5nLiBTZWUKICAgICAgICAgICAgICoge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyICRpbnRlcnBvbGF0ZVByb3ZpZGVyfSBmb3IgY29uZmlndXJpbmcgdGhlCiAgICAgICAgICAgICAqIGludGVycG9sYXRpb24gbWFya3VwLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgPHByZT4KICAgICAgICAgICAgIHZhciAkaW50ZXJwb2xhdGUgPSAuLi47IC8vIGluamVjdGVkCiAgICAgICAgICAgICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWV9fSEnKTsKICAgICAgICAgICAgIGV4cGVjdChleHAoe25hbWU6J0FuZ3VsYXInfSkudG9FcXVhbCgnSGVsbG8gQW5ndWxhciEnKTsKICAgICAgICAgICAgIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICAgICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQpfSBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gY29tcHV0ZSB0aGUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAqICAgIHN0cmluZy4gVGhlIGZ1bmN0aW9uIGhhcyB0aGVzZSBwYXJhbWV0ZXJzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YDogYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzIGFyZSBldmFsdWF0ZWQKICAgICAgICAgICAgICogICAgICBhZ2FpbnN0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gJGludGVycG9sYXRlKHRleHQsIG11c3RIYXZlRXhwcmVzc2lvbikgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGZuLAogICAgICAgICAgICAgICAgICAgIGV4cCwKICAgICAgICAgICAgICAgICAgICBjb25jYXQgPSBbXTsKCiAgICAgICAgICAgICAgICB3aGlsZShpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmICggKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAoKGVuZEluZGV4ID0gdGV4dC5pbmRleE9mKGVuZFN5bWJvbCwgc3RhcnRJbmRleCArIHN0YXJ0U3ltYm9sTGVuZ3RoKSkgIT0gLTEpICkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uICB8fCBoYXNJbnRlcnBvbGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY29uY2F0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBsZW5ndGgsIHBhcnQ7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFydCAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmNhdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJGludGVycG9sYXRlOwogICAgICAgIH1dOwogICAgfQoKICAgIHZhciBVUkxfTUFUQ0ggPSAvXihbXjpdKyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXHs/W1x3XC4tXSpcfT8pKDooWzAtOV0rKSk/KFwvW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBQQVRIX01BVENIID0gL14oW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBIQVNIX01BVENIID0gUEFUSF9NQVRDSCwKICAgICAgICBERUZBVUxUX1BPUlRTID0geydodHRwJzogODAsICdodHRwcyc6IDQ0MywgJ2Z0cCc6IDIxfTsKCgogICAgLyoqCiAgICAgKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBQYXRoIHRvIGVuY29kZQogICAgICogQHJldHVybnMge3N0cmluZ30KICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlUGF0aChwYXRoKSB7CiAgICAgICAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLycpLAogICAgICAgICAgICBpID0gc2VnbWVudHMubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIHNlZ21lbnRzW2ldID0gZW5jb2RlVXJpU2VnbWVudChzZWdtZW50c1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VnbWVudHMuam9pbignLycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmlwSGFzaCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hdGNoVXJsKHVybCwgb2JqKSB7CiAgICAgICAgdmFyIG1hdGNoID0gVVJMX01BVENILmV4ZWModXJsKTsKCiAgICAgICAgbWF0Y2ggPSB7CiAgICAgICAgICAgIHByb3RvY29sOiBtYXRjaFsxXSwKICAgICAgICAgICAgaG9zdDogbWF0Y2hbM10sCiAgICAgICAgICAgIHBvcnQ6IGludChtYXRjaFs1XSkgfHwgREVGQVVMVF9QT1JUU1ttYXRjaFsxXV0gfHwgbnVsbCwKICAgICAgICAgICAgcGF0aDogbWF0Y2hbNl0gfHwgJy8nLAogICAgICAgICAgICBzZWFyY2g6IG1hdGNoWzhdLAogICAgICAgICAgICBoYXNoOiBtYXRjaFsxMF0KICAgICAgICB9OwoKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgIG9iai4kJHByb3RvY29sID0gbWF0Y2gucHJvdG9jb2w7CiAgICAgICAgICAgIG9iai4kJGhvc3QgPSBtYXRjaC5ob3N0OwogICAgICAgICAgICBvYmouJCRwb3J0ID0gbWF0Y2gucG9ydDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KCgogICAgZnVuY3Rpb24gY29tcG9zZVByb3RvY29sSG9zdFBvcnQocHJvdG9jb2wsIGhvc3QsIHBvcnQpIHsKICAgICAgICByZXR1cm4gcHJvdG9jb2wgKyAnOi8vJyArIGhvc3QgKyAocG9ydCA9PSBERUZBVUxUX1BPUlRTW3Byb3RvY29sXSA/ICcnIDogJzonICsgcG9ydCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCkgewogICAgICAgIHJldHVybiBiYXNlUGF0aC5zdWJzdHIoMCwgYmFzZVBhdGgubGFzdEluZGV4T2YoJy8nKSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0h0bWw1VXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGh0bWw1IHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgIT0gYmFzZVBhdGggfHwgaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgfHwKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaGFzaGJhbmcgdXJsIC0+IGh0bWw1IHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKwogICAgICAgICAgICAgICAgcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSArIG1hdGNoLmhhc2guc3Vic3RyKGhhc2hQcmVmaXgubGVuZ3RoKTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0hhc2hiYW5nVXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGhhc2hiYW5nIHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgPT0gYmFzZVBhdGggJiYgIWlzVW5kZWZpbmVkKG1hdGNoLmhhc2gpICYmCiAgICAgICAgICAgIG1hdGNoLmhhc2guaW5kZXhPZihoYXNoUHJlZml4KSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgICAgICAvLyBjb252ZXJ0IGh0bWw1IHVybCAtPiBoYXNoYmFuZyB1cmwKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gbWF0Y2guc2VhcmNoICYmICc/JyArIG1hdGNoLnNlYXJjaCB8fCAnJywKICAgICAgICAgICAgICAgIGhhc2ggPSBtYXRjaC5oYXNoICYmICcjJyArIG1hdGNoLmhhc2ggfHwgJycsCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSwKICAgICAgICAgICAgICAgIHBhdGggPSBtYXRjaC5wYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCk7CgogICAgICAgICAgICBpZiAobWF0Y2gucGF0aC5pbmRleE9mKHBhdGhQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKyBiYXNlUGF0aCArCiAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgcGF0aCArIHNlYXJjaCArIGhhc2g7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uVXJsIHJlcHJlc2VudHMgYW4gdXJsCiAgICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gSFRNTDUgbW9kZSBpcyBlbmFibGVkIGFuZCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSFRNTDUgdXJsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aFByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvblVybCh1cmwsIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpIHsKICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeCB8fCAnJzsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaHRtbDUgKHJlZ3VsYXIpIHVybCBzdHJpbmcgaW50byBwcm9wZXJ0aWVzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0Fic29sdXRlVXJsIEhUTUw1IHVybAogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24obmV3QWJzb2x1dGVVcmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwobmV3QWJzb2x1dGVVcmwsIHRoaXMpOwoKICAgICAgICAgICAgaWYgKG1hdGNoLnBhdGguaW5kZXhPZihwYXRoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgbmV3QWJzb2x1dGVVcmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2guaGFzaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gY29tcG9zZVByb3RvY29sSG9zdFBvcnQodGhpcy4kJHByb3RvY29sLCB0aGlzLiQkaG9zdCwgdGhpcy4kJHBvcnQpICsKICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggKyB0aGlzLiQkdXJsOwogICAgICAgIH07CgoKICAgICAgICB0aGlzLiQkcmV3cml0ZUFwcFVybCA9IGZ1bmN0aW9uKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZihhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGRpc2FibGVkIG9yIG5vdCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTGVnYWN5IHVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHZhciBiYXNlUGF0aDsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwodXJsLCB0aGlzKTsKCgogICAgICAgICAgICBpZiAobWF0Y2guaGFzaCAmJiBtYXRjaC5oYXNoLmluZGV4T2YoaGFzaFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIHVybCArICciLCBtaXNzaW5nIGhhc2ggcHJlZml4ICInICsgaGFzaFByZWZpeCArICciICEnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmFzZVBhdGggPSBtYXRjaC5wYXRoICsgKG1hdGNoLnNlYXJjaCA/ICc/JyArIG1hdGNoLnNlYXJjaCA6ICcnKTsKICAgICAgICAgICAgbWF0Y2ggPSBIQVNIX01BVENILmV4ZWMoKG1hdGNoLmhhc2ggfHwgJycpLnN1YnN0cihoYXNoUHJlZml4Lmxlbmd0aCkpOwogICAgICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gKG1hdGNoWzFdLmNoYXJBdCgwKSA9PSAnLycgPyAnJyA6ICcvJykgKyBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbMV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHBhdGggPSAnJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUobWF0Y2hbM10pOwogICAgICAgICAgICB0aGlzLiQkaGFzaCA9IG1hdGNoWzVdICYmIGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFs1XSkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgaGFzaGJhbmcgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gY29tcG9zZVByb3RvY29sSG9zdFBvcnQodGhpcy4kJHByb3RvY29sLCB0aGlzLiQkaG9zdCwgdGhpcy4kJHBvcnQpICsKICAgICAgICAgICAgICAgIGJhc2VQYXRoICsgKHRoaXMuJCR1cmwgPyAnIycgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZUFwcFVybCA9IGZ1bmN0aW9uKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZihhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIExvY2F0aW9uVXJsLnByb3RvdHlwZSA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogSGFzIGFueSBjaGFuZ2UgYmVlbiByZXBsYWNpbmcgPwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgJCRyZXBsYWNlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNhYnNVcmwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBmdWxsIHVybCByZXByZXNlbnRhdGlvbiB3aXRoIGFsbCBzZWdtZW50cyBlbmNvZGVkIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAgICAgKiB7QGxpbmsgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgUkZDIDM5ODZ9LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBmdWxsIHVybAogICAgICAgICAqLwogICAgICAgIGFic1VybDogbG9jYXRpb25HZXR0ZXIoJyQkYWJzVXJsJyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jdXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHVybCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKSB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB1cmwgTmV3IHVybCB3aXRob3V0IGJhc2UgcHJlZml4IChlLmcuIGAvcGF0aD9hPWIjaGFzaGApCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSB1cmwKICAgICAgICAgKi8KICAgICAgICB1cmw6IGZ1bmN0aW9uKHVybCwgcmVwbGFjZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdXJsOwoKICAgICAgICAgICAgdmFyIG1hdGNoID0gUEFUSF9NQVRDSC5leGVjKHVybCk7CiAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgICBpZiAobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pIHRoaXMuc2VhcmNoKG1hdGNoWzNdIHx8ICcnKTsKICAgICAgICAgICAgdGhpcy5oYXNoKG1hdGNoWzVdIHx8ICcnLCByZXBsYWNlKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcHJvdG9jb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwcm90b2NvbCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgICAgICAgKi8KICAgICAgICBwcm90b2NvbDogbG9jYXRpb25HZXR0ZXIoJyQkcHJvdG9jb2wnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNob3N0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKi8KICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcG9ydAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgICAgICAgKi8KICAgICAgICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcGF0aAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwYXRoIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBOb3RlOiBQYXRoIHNob3VsZCBhbHdheXMgYmVnaW4gd2l0aCBmb3J3YXJkIHNsYXNoICgvKSwgdGhpcyBtZXRob2Qgd2lsbCBhZGQgdGhlIGZvcndhcmQgc2xhc2gKICAgICAgICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwYXRoIE5ldyBwYXRoCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICAgICAgICovCiAgICAgICAgcGF0aDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkcGF0aCcsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdDxzdHJpbmcsc3RyaW5nPj19IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvciBoYXNoIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZywgdGhlbiBgcGFyYW1WYWx1ZWAgd2lsbCBvdmVycmlkZSBvbmx5IGEKICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHNlYXJjaAogICAgICAgICAqLwogICAgICAgIHNlYXJjaDogZnVuY3Rpb24oc2VhcmNoLCBwYXJhbVZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChzZWFyY2gpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCRzZWFyY2g7CgogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHBhcmFtVmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1WYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gaXNTdHJpbmcoc2VhcmNoKSA/IHBhcnNlS2V5VmFsdWUoc2VhcmNoKSA6IHNlYXJjaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNoYXNoCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gaGFzaCBOZXcgaGFzaCBmcmFnbWVudAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaGFzaAogICAgICAgICAqLwogICAgICAgIGhhc2g6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJGhhc2gnLCBpZGVudGl0eSksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcmVwbGFjZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIElmIGNhbGxlZCwgYWxsIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGR1cmluZyBjdXJyZW50IGAkZGlnZXN0YCB3aWxsIGJlIHJlcGxhY2luZyBjdXJyZW50IGhpc3RvcnkKICAgICAgICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICAgICAgICovCiAgICAgICAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuJCRyZXBsYWNlID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9IGluaGVyaXQoTG9jYXRpb25VcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCh1cmwsIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VFeHRyYSkgewogICAgICAgIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24oYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZVVybCArIGJhc2VFeHRyYSArICcjJyArIGhhc2hQcmVmaXggICsgYWJzb2x1dGVMaW5rVXJsLnN1YnN0cihhcHBCYXNlVXJsLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSk7CgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwoKICAgICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBwcmVwcm9jZXNzKHZhbHVlKTsKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvY2F0aW9uCiAgICAgKgogICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJHNuaWZmZXIKICAgICAqIEByZXF1aXJlcyAkcm9vdEVsZW1lbnQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSAkbG9jYXRpb24gc2VydmljZSBwYXJzZXMgdGhlIFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciAoYmFzZWQgb24gdGhlCiAgICAgKiB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vd2luZG93LmxvY2F0aW9uIHdpbmRvdy5sb2NhdGlvbn0pIGFuZCBtYWtlcyB0aGUgVVJMCiAgICAgKiBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4gQ2hhbmdlcyB0byB0aGUgVVJMIGluIHRoZSBhZGRyZXNzIGJhciBhcmUgcmVmbGVjdGVkIGludG8KICAgICAqICRsb2NhdGlvbiBzZXJ2aWNlIGFuZCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBhcmUgcmVmbGVjdGVkIGludG8gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIuCiAgICAgKgogICAgICogKipUaGUgJGxvY2F0aW9uIHNlcnZpY2U6KioKICAgICAqCiAgICAgKiAtIEV4cG9zZXMgdGhlIGN1cnJlbnQgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLCBzbyB5b3UgY2FuCiAgICAgKiAgIC0gV2F0Y2ggYW5kIG9ic2VydmUgdGhlIFVSTC4KICAgICAqICAgLSBDaGFuZ2UgdGhlIFVSTC4KICAgICAqIC0gU3luY2hyb25pemVzIHRoZSBVUkwgd2l0aCB0aGUgYnJvd3NlciB3aGVuIHRoZSB1c2VyCiAgICAgKiAgIC0gQ2hhbmdlcyB0aGUgYWRkcmVzcyBiYXIuCiAgICAgKiAgIC0gQ2xpY2tzIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIChvciBjbGlja3MgYSBIaXN0b3J5IGxpbmspLgogICAgICogICAtIENsaWNrcyBvbiBhIGxpbmsuCiAgICAgKiAtIFJlcHJlc2VudHMgdGhlIFVSTCBvYmplY3QgYXMgYSBzZXQgb2YgbWV0aG9kcyAocHJvdG9jb2wsIGhvc3QsIHBvcnQsIHBhdGgsIHNlYXJjaCwgaGFzaCkuCiAgICAgKgogICAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuc2VydmljZXMuJGxvY2F0aW9uIERldmVsb3BlciBHdWlkZTogQW5ndWxhcgogKiBTZXJ2aWNlczogVXNpbmcgJGxvY2F0aW9ufQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCl7CiAgICAgICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChwcmVmaXgpKSB7CiAgICAgICAgICAgICAgICBoYXNoUHJlZml4ID0gcHJlZml4OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFzaFByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2h0bWw1TW9kZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbW9kZSBVc2UgSFRNTDUgc3RyYXRlZ3kgaWYgYXZhaWxhYmxlLgogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5odG1sNU1vZGUgPSBmdW5jdGlvbihtb2RlKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgICAgICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoLAogICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybCA9ICRicm93c2VyLnVybCgpLAogICAgICAgICAgICAgICAgICAgIGluaXRVcmxQYXJ0cyA9IG1hdGNoVXJsKGluaXRVcmwpLAogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmw7CgogICAgICAgICAgICAgICAgaWYgKGh0bWw1TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoID0gJGJyb3dzZXIuYmFzZUhyZWYoKSB8fCAnLyc7CiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCk7CiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KGluaXRVcmxQYXJ0cy5wcm90b2NvbCwgaW5pdFVybFBhcnRzLmhvc3QsIGluaXRVcmxQYXJ0cy5wb3J0KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25VcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IdG1sNVVybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IYXNoYmFuZ1VybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoUHJlZml4LCBhcHBCYXNlVXJsLCBiYXNlUGF0aC5zdWJzdHIocGF0aFByZWZpeC5sZW5ndGggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpbml0VXJsUGFydHMucGF0aCB8fCAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5zZWFyY2ggPyAoJz8nICsgaW5pdFVybFBhcnRzLnNlYXJjaCkgOiAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyMnICsgaGFzaFByZWZpeCArICcvJzsKCiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uID0gbmV3IExvY2F0aW9uSGFzaGJhbmdVcmwoaW5pdFVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGVBcHBVcmwoYWJzSHJlZik7CgogICAgICAgICAgICAgICAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdFVybCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgICAgICAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24obmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBuZXdVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsICRsb2NhdGlvbi5hYnNVcmwoKSkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi5hYnNVcmwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBicm93c2VyCiAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiAkbG9jYXRpb25XYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGJyb3dzZXIudXJsKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjaGFuZ2VDb3VudGVyIHx8IG9sZFVybCAhPSAkbG9jYXRpb24uYWJzVXJsKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlQ291bnRlcisrOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2cKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgICAqCiAgICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICBNZXNzYWdlOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbigkd2luZG93KXsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNsb2cKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIGxvZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2luZm8KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZXJyb3IKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wOwoKICAgICAgICAgICAgICAgIGlmIChsb2dGbi5hcHBseSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGZvcm1hdEVycm9yKGFyZykpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2UgYXJlIElFIHdoaWNoIGVpdGhlciBkb2Vzbid0IGhhdmUgd2luZG93LmNvbnNvbGUgPT4gdGhpcyBpcyBub29wIGFuZCB3ZSBkbyBub3RoaW5nLAogICAgICAgICAgICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgICAgICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIE9QRVJBVE9SUyA9IHsKICAgICAgICAnbnVsbCc6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbDt9LAogICAgICAgICd0cnVlJzpmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCiAgICAgICAgJ2ZhbHNlJzpmdW5jdGlvbigpe3JldHVybiBmYWxzZTt9LAogICAgICAgIHVuZGVmaW5lZDpub29wLAogICAgICAgICcrJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgICAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0RlZmluZWQoYik/Yjp1bmRlZmluZWQ7fSwKICAgICAgICAnLSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe2E9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsgcmV0dXJuIChpc0RlZmluZWQoYSk/YTowKS0oaXNEZWZpbmVkKGIpP2I6MCk7fSwKICAgICAgICAnKic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykqYihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJy8nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpL2Ioc2VsZiwgbG9jYWxzKTt9LAogICAgICAgICclJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSViKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnXic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyleYihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJz0nOm5vb3AsCiAgICAgICAgJz09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJyE9JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9YihzZWxmLCBsb2NhbHMpO30sCiAgICAgICAgJzwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPGIoc2VsZiwgbG9jYWxzKTt9LAogICAgICAgICc+JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT5iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnPD0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPD1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnPj0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPj1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJiZiKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnfHwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpfHxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICAgICAnJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmYihzZWxmLCBsb2NhbHMpO30sCi8vICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGF8Yjt9LAogICAgICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7fSwKICAgICAgICAnISc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhKXtyZXR1cm4gIWEoc2VsZiwgbG9jYWxzKTt9CiAgICB9OwogICAgdmFyIEVTQ0FQRSA9IHsibiI6IlxuIiwgImYiOiJcZiIsICJyIjoiXHIiLCAidCI6Ilx0IiwgInYiOiJcdiIsICInIjoiJyIsICciJzonIid9OwoKICAgIGZ1bmN0aW9uIGxleCh0ZXh0LCBjc3ApewogICAgICAgIHZhciB0b2tlbnMgPSBbXSwKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAganNvbiA9IFtdLAogICAgICAgICAgICBjaCwKICAgICAgICAgICAgbGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBpZiAoaXMoJyJcJycpKSB7CiAgICAgICAgICAgICAgICByZWFkU3RyaW5nKGNoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihjaCkgfHwgaXMoJy4nKSAmJiBpc051bWJlcihwZWVrKCkpKSB7CiAgICAgICAgICAgICAgICByZWFkTnVtYmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNJZGVudChjaCkpIHsKICAgICAgICAgICAgICAgIHJlYWRJZGVudCgpOwogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllcnMgY2FuIG9ubHkgYmUgaWYgdGhlIHByZWNlZGluZyBjaGFyIHdhcyBhIHsgb3IgLAogICAgICAgICAgICAgICAgaWYgKHdhcygneywnKSAmJiBqc29uWzBdPT0neycgJiYKICAgICAgICAgICAgICAgICAgICAodG9rZW49dG9rZW5zW3Rva2Vucy5sZW5ndGgtMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4uanNvbiA9IHRva2VuLnRleHQuaW5kZXhPZignLicpID09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzKCcoKXt9W10uLDs6JykpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDppbmRleCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OmNoLAogICAgICAgICAgICAgICAgICAgIGpzb246KHdhcygnOlssJykgJiYgaXMoJ3tbJykpIHx8IGlzKCd9XTosJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGlzKCd7WycpKSBqc29uLnVuc2hpZnQoY2gpOwogICAgICAgICAgICAgICAgaWYgKGlzKCd9XScpKSBqc29uLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjaDIgPSBjaCArIHBlZWsoKSwKICAgICAgICAgICAgICAgICAgICBmbiA9IE9QRVJBVE9SU1tjaF0sCiAgICAgICAgICAgICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgICAgICAgICBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OmluZGV4LCB0ZXh0OmNoMiwgZm46Zm4yfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6aW5kZXgsIHRleHQ6Y2gsIGZuOmZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXgrMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENoID0gY2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbnM7CgogICAgICAgIGZ1bmN0aW9uIGlzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGNoKSAhPSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcyhjaGFycykgewogICAgICAgICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlaygpIHsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ICsgMSA8IHRleHQubGVuZ3RoID8gdGV4dC5jaGFyQXQoaW5kZXggKyAxKSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc051bWJlcihjaCkgewogICAgICAgICAgICByZXR1cm4gJzAnIDw9IGNoICYmIGNoIDw9ICc5JzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBjaCA9PSAnICcgfHwgY2ggPT0gJ1xyJyB8fCBjaCA9PSAnXHQnIHx8CiAgICAgICAgICAgICAgICBjaCA9PSAnXG4nIHx8IGNoID09ICdcdicgfHwgY2ggPT0gJ1x1MDBBMCc7IC8vIElFIHRyZWF0cyBub24tYnJlYWtpbmcgc3BhY2UgYXMgXHUwMEEwCiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSWRlbnQoY2gpIHsKICAgICAgICAgICAgcmV0dXJuICdhJyA8PSBjaCAmJiBjaCA8PSAneicgfHwKICAgICAgICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAgICAgICdfJyA9PSBjaCB8fCBjaCA9PSAnJCc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXhwT3BlcmF0b3IoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICctJyB8fCBjaCA9PSAnKycgfHwgaXNOdW1iZXIoY2gpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJMZXhlciBFcnJvcjogIiArIGVycm9yICsgIiBhdCBjb2x1bW4iICsKICAgICAgICAgICAgICAgIChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAgIi0iICsgaW5kZXggKyAiIFsiICsgdGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAiXSIKICAgICAgICAgICAgICAgICAgICA6ICIgIiArIGVuZCkgKwogICAgICAgICAgICAgICAgIiBpbiBleHByZXNzaW9uIFsiICsgdGV4dCArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZE51bWJlcigpIHsKICAgICAgICAgICAgdmFyIG51bWJlciA9ICIiOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0ZXh0LmNoYXJBdChpbmRleCkpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBwZWVrQ2ggPSBwZWVrKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICdlJyAmJiBpc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICghcGVla0NoIHx8ICFpc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OnN0YXJ0LCB0ZXh0Om51bWJlciwganNvbjp0cnVlLAogICAgICAgICAgICAgICAgZm46ZnVuY3Rpb24oKSB7cmV0dXJuIG51bWJlcjt9fSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRJZGVudCgpIHsKICAgICAgICAgICAgdmFyIGlkZW50ID0gIiIsCiAgICAgICAgICAgICAgICBzdGFydCA9IGluZGV4LAogICAgICAgICAgICAgICAgbGFzdERvdCwgcGVla0luZGV4LCBtZXRob2ROYW1lLCBjaDsKCiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicgfHwgaXNJZGVudChjaCkgfHwgaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJykgbGFzdERvdCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIGlkZW50ICs9IGNoOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vY2hlY2sgaWYgdGhpcyBpcyBub3QgYSBtZXRob2QgaW52b2NhdGlvbiBhbmQgaWYgaXQgaXMgYmFjayBvdXQgdG8gbGFzdCBkb3QKICAgICAgICAgICAgaWYgKGxhc3REb3QpIHsKICAgICAgICAgICAgICAgIHBlZWtJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgd2hpbGUocGVla0luZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KHBlZWtJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICcoJykgewogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZGVudCA9IGlkZW50LnN1YnN0cigwLCBsYXN0RG90IC0gc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IHBlZWtJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6c3RhcnQsCiAgICAgICAgICAgICAgICB0ZXh0OmlkZW50CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoT1BFUkFUT1JTLmhhc093blByb3BlcnR5KGlkZW50KSkgewogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSB0b2tlbi5qc29uID0gT1BFUkFUT1JTW2lkZW50XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBnZXR0ZXJGbihpZGVudCwgY3NwKTsKICAgICAgICAgICAgICAgIHRva2VuLmZuID0gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2VsZiwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldHRlcihzZWxmLCBpZGVudCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CgogICAgICAgICAgICBpZiAobWV0aG9kTmFtZSkgewogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4Omxhc3REb3QsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogJy4nLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogbWV0aG9kTmFtZSwKICAgICAgICAgICAgICAgICAgICBqc29uOiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlYWRTdHJpbmcocXVvdGUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIjsKICAgICAgICAgICAgdmFyIHJhd1N0cmluZyA9IHF1b3RlOwogICAgICAgICAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICByYXdTdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICd1JykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGV4ID0gdGV4dC5zdWJzdHJpbmcoaW5kZXggKyAxLCBpbmRleCArIDUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoICJJbnZhbGlkIHVuaWNvZGUgZXNjYXBlIFtcXHUiICsgaGV4ICsgIl0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXAgPSBFU0NBUEVbY2hdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gcmVwOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IGNoOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PSAnXFwnKSB7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gcXVvdGUpIHsKICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6c3RhcnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6cmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6c3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBqc29uOnRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZuOmZ1bmN0aW9uKCkgeyByZXR1cm4gc3RyaW5nOyB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93RXJyb3IoIlVudGVybWluYXRlZCBxdW90ZSIsIHN0YXJ0KTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHBhcnNlcih0ZXh0LCBqc29uLCAkZmlsdGVyLCBjc3ApewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmKGpzb24pewogICAgICAgICAgICAvLyBUaGUgZXh0cmEgbGV2ZWwgb2YgYWxpYXNpbmcgaXMgaGVyZSwganVzdCBpbiBjYXNlIHRoZSBsZXhlciBtaXNzZXMgc29tZXRoaW5nLCBzbyB0aGF0CiAgICAgICAgICAgIC8vIHdlIHByZXZlbnQgYW55IGFjY2lkZW50YWwgZXhlY3V0aW9uIGluIEpTT04uCiAgICAgICAgICAgIGFzc2lnbm1lbnQgPSBsb2dpY2FsT1I7CiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9CiAgICAgICAgICAgICAgICBmaWVsZEFjY2VzcyA9CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0SW5kZXggPQogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJDaGFpbiA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB7dGV4dDp0ZXh0LCBpbmRleDowfSk7IH07CiAgICAgICAgICAgIHZhbHVlID0gcHJpbWFyeSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gc3RhdGVtZW50cygpOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBhbiB1bmV4cGVjdGVkIHRva2VuIiwgdG9rZW5zWzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIGZ1bmN0aW9uIHRocm93RXJyb3IobXNnLCB0b2tlbikgewogICAgICAgICAgICB0aHJvdyBFcnJvcigiU3ludGF4IEVycm9yOiBUb2tlbiAnIiArIHRva2VuLnRleHQgKwogICAgICAgICAgICAgICAgIicgIiArIG1zZyArICIgYXQgY29sdW1uICIgKwogICAgICAgICAgICAgICAgKHRva2VuLmluZGV4ICsgMSkgKyAiIG9mIHRoZSBleHByZXNzaW9uIFsiICsKICAgICAgICAgICAgICAgIHRleHQgKyAiXSBzdGFydGluZyBhdCBbIiArIHRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVla1Rva2VuKCkgewogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBleHByZXNzaW9uOiAiICsgdGV4dCk7CiAgICAgICAgICAgIHJldHVybiB0b2tlbnNbMF07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKGUxLCBlMiwgZTMsIGU0KSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zWzBdOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0b2tlbi50ZXh0OwogICAgICAgICAgICAgICAgaWYgKHQ9PWUxIHx8IHQ9PWUyIHx8IHQ9PWUzIHx8IHQ9PWU0IHx8CiAgICAgICAgICAgICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwZWN0KGUxLCBlMiwgZTMsIGU0KXsKICAgICAgICAgICAgdmFyIHRva2VuID0gcGVlayhlMSwgZTIsIGUzLCBlNCk7CiAgICAgICAgICAgIGlmICh0b2tlbikgewogICAgICAgICAgICAgICAgaWYgKGpzb24gJiYgIXRva2VuLmpzb24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRva2Vucy5zaGlmdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN1bWUoZTEpewogICAgICAgICAgICBpZiAoIWV4cGVjdChlMSkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbIiArIGUxICsgIl0iLCBwZWVrKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeUZuKGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCByaWdodCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBiaW5hcnlGbihsZWZ0LCBmbiwgcmlnaHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgbGVmdCwgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc3RhdGVtZW50cygpIHsKICAgICAgICAgICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc3RhdGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVtZW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGVtZW50KHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9maWx0ZXJDaGFpbigpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnfCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZmlsdGVyKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlsdGVyKCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgdmFyIGZuID0gJGZpbHRlcih0b2tlbi50ZXh0KTsKICAgICAgICAgICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBpbnB1dCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cHJlc3Npb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhc3NpZ25tZW50KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfYXNzaWdubWVudCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz0nKSkpIHsKICAgICAgICAgICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgIl0gY2FuIG5vdCBiZSBhc3NpZ25lZCB0byIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJpZ2h0ID0gbG9naWNhbE9SKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQuYXNzaWduKHNjb3BlLCByaWdodChzY29wZSwgbG9jYWxzKSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9naWNhbE9SKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGxvZ2ljYWxBTkQoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8fCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbG9naWNhbEFORCgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxBTkQoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXF1YWxpdHkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXF1YWxpdHkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gcmVsYXRpb25hbCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywnIT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCctJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIG11bHRpcGxpY2F0aXZlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbXVsdGlwbGljYXRpdmUoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdW5hcnkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAoKHRva2VuID0gZXhwZWN0KCcqJywnLycsJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgICAgICAgIHdoaWxlICgobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSU1QT1NTSUJMRSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpZWxkQWNjZXNzKG9iamVjdCkgewogICAgICAgICAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIGNzcCk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSwgbG9jYWxzLCBzZWxmKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcihzZWxmIHx8IG9iamVjdChzY29wZSwgbG9jYWxzKSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9vYmplY3RJbmRleChvYmopIHsKICAgICAgICAgICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCgKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIG8gPSBvYmooc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgdiwgcDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHYgPSBvW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh2ICYmIHYudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246ZnVuY3Rpb24oc2VsZiwgdmFsdWUsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmooc2VsZiwgbG9jYWxzKVtpbmRleEZuKHNlbGYsIGxvY2FscyldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKXsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHRHZXR0ZXIgPyBjb250ZXh0R2V0dGVyKHNjb3BlLCBsb2NhbHMpIDogc2NvcGU7CgogICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZm5QdHIgPSBmbihzY29wZSwgbG9jYWxzLCBjb250ZXh0KSB8fCBub29wOwogICAgICAgICAgICAgICAgLy8gSUUgc3R1cGlkaXR5IQogICAgICAgICAgICAgICAgcmV0dXJuIGZuUHRyLmFwcGx5CiAgICAgICAgICAgICAgICAgICAgPyBmblB0ci5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICAgICAgICAgICAgICAgIDogZm5QdHIoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIHVzZWQgd2l0aCBqc29uIGFycmF5IGRlY2xhcmF0aW9uCiAgICAgICAgZnVuY3Rpb24gYXJyYXlEZWNsYXJhdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICddJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChleHByZXNzaW9uKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGVsZW1lbnRGbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvYmplY3QgKCkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVzID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICd9JykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6a2V5LCB2YWx1ZTp2YWx1ZX0pOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ30nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHNldHRlcihvYmosIHBhdGgsIHNldFZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LnNoaWZ0KCk7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICAgICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgICB9CiAgICAgICAgb2JqW2VsZW1lbnQuc2hpZnQoKV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgdmFyIGdldHRlckZuQ2FjaGUgPSB7fTsKCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICAgICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAgICovCiAgICBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgaWYgKHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkxIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkzIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXk0IHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3ApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwLCB2YWw7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gY3NwU2FmZUdldHRlckZuKAogICAgICAgICAgICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdCiAgICAgICAgICAgICAgICAgICAgKShzY29wZSwgbG9jYWxzKTsKCiAgICAgICAgICAgICAgICAgICAgbG9jYWxzID0gdW5kZWZpbmVkOyAvLyBjbGVhciBhZnRlciBmaXJzdCBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGkgPCBwYXRoS2V5c0xlbmd0aCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSAndmFyIGwsIGZuLCBwO1xuJzsKICAgICAgICAgICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgICAgICAgICAgY29kZSArPSAnaWYocyA9PT0gbnVsbCB8fCBzID09PSB1bmRlZmluZWQpIHJldHVybiBzO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAgICAgICAgICdzPScrIChpbmRleAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHA9cztcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7IHJldHVybiBjb2RlOyB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRwYXJzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAgICAgKiAgIHZhciBzZXR0ZXIgPSBnZXR0ZXIuYXNzaWduOwogICAgICogICB2YXIgY29udGV4dCA9IHt1c2VyOntuYW1lOidhbmd1bGFyJ319OwogICAgICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogICAgICoKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0KSkudG9FcXVhbCgnYW5ndWxhcicpOwogICAgICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAgICAgKiAgIGV4cGVjdChjb250ZXh0LnVzZXIubmFtZSkudG9FcXVhbCgnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0LCBsb2NhbHMpKS50b0VxdWFsKCdsb2NhbCcpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0aXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKgogICAgICogICAgVGhlIHJldHVybiBmdW5jdGlvbiBhbHNvIGhhcyBhbiBgYXNzaWduYCBwcm9wZXJ0eSwgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgd2hpY2gKICAgICAqICAgIGFsbG93cyBvbmUgdG8gc2V0IHZhbHVlcyB0byBleHByZXNzaW9ucy4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihleHApIHsKICAgICAgICAgICAgICAgIHN3aXRjaCh0eXBlb2YgZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gY2FjaGVbZXhwXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBjYWNoZVtleHBdID0gIHBhcnNlcihleHAsIGZhbHNlLCAkZmlsdGVyLCAkc25pZmZlci5jc3ApOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cDsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kcQogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcHJvbWlzZS9kZWZlcnJlZCBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbS3JpcyBLb3dhbCdzIFFdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkuCiAgICAgKgogICAgICogW1RoZSBDb21tb25KUyBQcm9taXNlIHByb3Bvc2FsXShodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcykgZGVzY3JpYmVzIGEgcHJvbWlzZSBhcyBhbgogICAgICogaW50ZXJmYWNlIGZvciBpbnRlcmFjdGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IHJlcHJlc2VudHMgdGhlIHJlc3VsdCBvZiBhbiBhY3Rpb24gdGhhdCBpcwogICAgICogcGVyZm9ybWVkIGFzeW5jaHJvbm91c2x5LCBhbmQgbWF5IG9yIG1heSBub3QgYmUgZmluaXNoZWQgYXQgYW55IGdpdmVuIHBvaW50IGluIHRpbWUuCiAgICAgKgogICAgICogRnJvbSB0aGUgcGVyc3BlY3RpdmUgb2YgZGVhbGluZyB3aXRoIGVycm9yIGhhbmRsaW5nLCBkZWZlcnJlZCBhbmQgcHJvbWlzZSBBUElzIGFyZSB0bwogICAgICogYXN5bmNocm9ub3VzIHByb2dyYW1taW5nIHdoYXQgYHRyeWAsIGBjYXRjaGAgYW5kIGB0aHJvd2Aga2V5d29yZHMgYXJlIHRvIHN5bmNocm9ub3VzIHByb2dyYW1taW5nLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGZvciB0aGUgcHVycG9zZSBvZiB0aGlzIGV4YW1wbGUgbGV0J3MgYXNzdW1lIHRoYXQgdmFyaWFibGVzIGAkcWAgYW5kIGBzY29wZWAgYXJlCiAgICAgKiAgIC8vIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCBsZXhpY2FsIHNjb3BlICh0aGV5IGNvdWxkIGhhdmUgYmVlbiBpbmplY3RlZCBvciBwYXNzZWQgaW4pLgogICAgICoKICAgICAqICAgZnVuY3Rpb24gYXN5bmNHcmVldChuYW1lKSB7CiAqICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKgogKiAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICogICAgICAgLy8gc2luY2UgdGhpcyBmbiBleGVjdXRlcyBhc3luYyBpbiBhIGZ1dHVyZSB0dXJuIG9mIHRoZSBldmVudCBsb29wLCB3ZSBuZWVkIHRvIHdyYXAKICogICAgICAgLy8gb3VyIGNvZGUgaW50byBhbiAkYXBwbHkgY2FsbCBzbyB0aGF0IHRoZSBtb2RlbCBjaGFuZ2VzIGFyZSBwcm9wZXJseSBvYnNlcnZlZC4KICogICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogKiAgICAgICAgIGlmIChva1RvR3JlZXQobmFtZSkpIHsKICogICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoJ0hlbGxvLCAnICsgbmFtZSArICchJyk7CiAqICAgICAgICAgfSBlbHNlIHsKICogICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgnR3JlZXRpbmcgJyArIG5hbWUgKyAnIGlzIG5vdCBhbGxvd2VkLicpOwogKiAgICAgICAgIH0KICogICAgICAgfSk7CiAqICAgICB9LCAxMDAwKTsKICoKICogICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogKiAgIH0KICAgICAqCiAgICAgKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogICAgICogICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICogICAgIGFsZXJ0KCdTdWNjZXNzOiAnICsgZ3JlZXRpbmcpOwogKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogKiAgICAgYWxlcnQoJ0ZhaWxlZDogJyArIHJlYXNvbik7CiAqICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBBdCBmaXJzdCBpdCBtaWdodCBub3QgYmUgb2J2aW91cyB3aHkgdGhpcyBleHRyYSBjb21wbGV4aXR5IGlzIHdvcnRoIHRoZSB0cm91YmxlLiBUaGUgcGF5b2ZmCiAgICAgKiBjb21lcyBpbiB0aGUgd2F5IG9mCiAgICAgKiBbZ3VhcmFudGVlcyB0aGF0IHByb21pc2UgYW5kIGRlZmVycmVkIEFQSXMgbWFrZV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC91bmNvbW1vbmpzL2Jsb2IvbWFzdGVyL3Byb21pc2VzL3NwZWNpZmljYXRpb24ubWQpLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSB0aGUgcHJvbWlzZSBhcGkgYWxsb3dzIGZvciBjb21wb3NpdGlvbiB0aGF0IGlzIHZlcnkgaGFyZCB0byBkbyB3aXRoIHRoZQogICAgICogdHJhZGl0aW9uYWwgY2FsbGJhY2sgKFtDUFNdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29udGludWF0aW9uLXBhc3Npbmdfc3R5bGUpKSBhcHByb2FjaC4KICAgICAqIEZvciBtb3JlIG9uIHRoaXMgcGxlYXNlIHNlZSB0aGUgW1EgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKSBlc3BlY2lhbGx5IHRoZQogICAgICogc2VjdGlvbiBvbiBzZXJpYWwgb3IgcGFyYWxsZWwgam9pbmluZyBvZiBwcm9taXNlcy4KICAgICAqCiAgICAgKgogICAgICogIyBUaGUgRGVmZXJyZWQgQVBJCiAgICAgKgogICAgICogQSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQgaXMgY29uc3RydWN0ZWQgYnkgY2FsbGluZyBgJHEuZGVmZXIoKWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIGRlZmVycmVkIG9iamVjdCBpcyB0byBleHBvc2UgdGhlIGFzc29jaWF0ZWQgUHJvbWlzZSBpbnN0YW5jZSBhcyB3ZWxsIGFzIEFQSXMKICAgICAqIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHNpZ25hbGluZyB0aGUgc3VjY2Vzc2Z1bCBvciB1bnN1Y2Nlc3NmdWwgY29tcGxldGlvbiBvZiB0aGUgdGFzay4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHJlc29sdmUodmFsdWUpYCDigJMgcmVzb2x2ZXMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgdmFsdWVgLiBJZiB0aGUgdmFsdWUgaXMgYSByZWplY3Rpb24KICAgICAqICAgY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLCB0aGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGluc3RlYWQuCiAgICAgKiAtIGByZWplY3QocmVhc29uKWAg4oCTIHJlamVjdHMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgcmVhc29uYC4gVGhpcyBpcyBlcXVpdmFsZW50IHRvCiAgICAgKiAgIHJlc29sdmluZyBpdCB3aXRoIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YC4KICAgICAqCiAgICAgKiAqKlByb3BlcnRpZXMqKgogICAgICoKICAgICAqIC0gcHJvbWlzZSDigJMgYHtQcm9taXNlfWAg4oCTIHByb21pc2Ugb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlZmVycmVkLgogICAgICoKICAgICAqCiAgICAgKiAjIFRoZSBQcm9taXNlIEFQSQogICAgICoKICAgICAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogICAgICogY2FsbGluZyBgZGVmZXJyZWQucHJvbWlzZWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAgICAgKiBvZiB0aGUgZGVmZXJyZWQgdGFzayB3aGVuIGl0IGNvbXBsZXRlcy4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKWAg4oCTIHJlZ2FyZGxlc3Mgb2Ygd2hlbiB0aGUgcHJvbWlzZSB3YXMgb3Igd2lsbCBiZSByZXNvbHZlZAogICAgICogICBvciByZWplY3RlZCwgYHRoZW5gIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkgYXMgc29vbiBhcyB0aGUgcmVzdWx0CiAgICAgKiAgIGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQ6IHRoZSByZXN1bHQgb3IgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAqCiAgICAgKiAgIFRoaXMgbWV0aG9kICpyZXR1cm5zIGEgbmV3IHByb21pc2UqIHdoaWNoIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogICAgICogICBgc3VjY2Vzc0NhbGxiYWNrYCBvciBgZXJyb3JDYWxsYmFja2AuCiAgICAgKgogICAgICoKICAgICAqICMgQ2hhaW5pbmcgcHJvbWlzZXMKICAgICAqCiAgICAgKiBCZWNhdXNlIGNhbGxpbmcgdGhlIGB0aGVuYCBtZXRob2Qgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkgcG9zc2libGUKICAgICAqIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAgICAgKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICogCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICogCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gcUZhY3RvcnkoZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICAgICAgICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICAgICAgICB9XTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RzIGEgcHJvbWlzZSBtYW5hZ2VyLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZnVuY3Rpb24pfSBuZXh0VGljayBGdW5jdGlvbiBmb3IgZXhlY3V0aW5nIGZ1bmN0aW9ucyBpbiB0aGUgbmV4dCB0dXJuLgogICAgICogQHBhcmFtIHtmdW5jdGlvbiguLi4qKX0gZXhjZXB0aW9uSGFuZGxlciBGdW5jdGlvbiBpbnRvIHdoaWNoIHVuZXhwZWN0ZWQgZXhjZXB0aW9ucyBhcmUgcGFzc2VkIGZvcgogICAgICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFByb21pc2UgbWFuYWdlci4KICAgICAqLwogICAgZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHEKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDcmVhdGVzIGEgYERlZmVycmVkYCBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhIHRhc2sgd2hpY2ggd2lsbCBmaW5pc2ggaW4gdGhlIGZ1dHVyZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtEZWZlcnJlZH0gUmV0dXJucyBhIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZC4KICAgICAgICAgKi8KICAgICAgICB2YXIgZGVmZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlZih2YWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbihjYWxsYmFja1swXSwgY2FsbGJhY2tbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlamVjdChyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgIHByb21pc2U6IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChlcnJiYWNrIHx8IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLnB1c2goW3dyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2tdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICAgICAgfTsKCgogICAgICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudGhlbikgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoY2FsbGJhY2sodmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI3JlamVjdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgICAgICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgICAgICAgKiBhIHByb21pc2UgY2hhaW4sIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LgogICAgICAgICAqCiAgICAgICAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICAgICAgICogYHJlamVjdGAgYXMgdGhlIGB0aHJvd2Aga2V5d29yZCBpbiBKYXZhU2NyaXB0LiBUaGlzIGFsc28gbWVhbnMgdGhhdCBpZiB5b3UgImNhdGNoIiBhbiBlcnJvciB2aWEKICAgICAgICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgICAgICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAgICAgICAqIGByZWplY3RgLgogICAgICAgICAqCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgKiAgICAgLy8gc3VjY2VzczogZG8gc29tZXRoaW5nIGFuZCByZXNvbHZlIHByb21pc2VCCiAgICogICAgIC8vICAgICAgICAgIHdpdGggdGhlIG9sZCBvciBhIG5ldyByZXN1bHQKICAgKiAgICAgcmV0dXJuIHJlc3VsdDsKICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAqICAgICAvLyBlcnJvcjogaGFuZGxlIHRoZSBlcnJvciBpZiBwb3NzaWJsZSBhbmQKICAgKiAgICAgLy8gICAgICAgIHJlc29sdmUgcHJvbWlzZUIgd2l0aCBuZXdQcm9taXNlT3JWYWx1ZSwKICAgKiAgICAgLy8gICAgICAgIG90aGVyd2lzZSBmb3J3YXJkIHRoZSByZWplY3Rpb24gdG8gcHJvbWlzZUIKICAgKiAgICAgaWYgKGNhbkhhbmRsZShyZWFzb24pKSB7CiAgICogICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGFuZCByZWNvdmVyCiAgICogICAgICByZXR1cm4gbmV3UHJvbWlzZU9yVmFsdWU7CiAgICogICAgIH0KICAgKiAgICAgcmV0dXJuICRxLnJlamVjdChyZWFzb24pOwogICAqICAgfSk7CiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHJlYXNvbiBDb25zdGFudCwgbWVzc2FnZSwgZXhjZXB0aW9uIG9yIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlamVjdGlvbiByZWFzb24uCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICAgICAgICovCiAgICAgICAgdmFyIHJlamVjdCA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjd2hlbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICAgICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAgICAgKi8KICAgICAgICB2YXIgd2hlbiA9IGZ1bmN0aW9uKHZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlcnJiYWNrIHx8IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShyZWYodmFsdWUpLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaykpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh3cmFwcGVkRXJyYmFjayhyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICB9OwoKCiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdENhbGxiYWNrKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0RXJyYmFjayhyZWFzb24pIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdChyZWFzb24pOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI2FsbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbWJpbmVzIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gYWxsIG9mIHRoZSBpbnB1dAogICAgICAgICAqIHByb21pc2VzIGFyZSByZXNvbHZlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvZiBwcm9taXNlcy4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5IG9mIHZhbHVlcywKICAgICAgICAgKiAgIGVhY2ggdmFsdWUgY29ycmVzcG9uZGluZyB0byB0aGUgcHJvbWlzZSBhdCB0aGUgc2FtZSBpbmRleCBpbiB0aGUgYHByb21pc2VzYCBhcnJheS4gSWYgYW55IG9mCiAgICAgICAgICogICB0aGUgcHJvbWlzZXMgaXMgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbiwgdGhpcyByZXN1bHRpbmcgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggdGhlCiAgICAgICAgICogICBzYW1lIHJlamVjdGlvbi4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGNvdW50ZXIgPSBwcm9taXNlcy5sZW5ndGgsCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICBpZiAoY291bnRlcikgewogICAgICAgICAgICAgICAgZm9yRWFjaChwcm9taXNlcywgZnVuY3Rpb24ocHJvbWlzZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggaW4gcmVzdWx0cykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzW2luZGV4XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgtLWNvdW50ZXIpKSBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggaW4gcmVzdWx0cykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkZWZlcjogZGVmZXIsCiAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICB3aGVuOiB3aGVuLAogICAgICAgICAgICBhbGw6IGFsbAogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm91dGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgcm91dGVzLiBTZWUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IGZvciBhbiBleGFtcGxlLgogICAgICovCiAgICBmdW5jdGlvbiAkUm91dGVQcm92aWRlcigpewogICAgICAgIHZhciByb3V0ZXMgPSB7fTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLnBhdGhgKS4gSWYgYCRsb2NhdGlvbi5wYXRoYAogICAgICAgICAqICAgIGNvbnRhaW5zIHJlZHVuZGFudCB0cmFpbGluZyBzbGFzaCBvciBpcyBtaXNzaW5nIG9uZSwgdGhlIHJvdXRlIHdpbGwgc3RpbGwgbWF0Y2ggYW5kIHRoZQogICAgICAgICAqICAgIGAkbG9jYXRpb24ucGF0aGAgd2lsbCBiZSB1cGRhdGVkIHRvIGFkZCBvciBkcm9wIHRoZSB0cmFpbGluZyBzbGFzaCB0byBleGFjdGx5IG1hdGNoIHRoZQogICAgICAgICAqICAgIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiAgICBgcGF0aGAgY2FuIGNvbnRhaW4gbmFtZWQgZ3JvdXBzIHN0YXJ0aW5nIHdpdGggYSBjb2xvbiAoYDpuYW1lYCkuIEFsbCBjaGFyYWN0ZXJzIHVwIHRvIHRoZQogICAgICAgICAqICAgIG5leHQgc2xhc2ggYXJlIG1hdGNoZWQgYW5kIHN0b3JlZCBpbiBgJHJvdXRlUGFyYW1zYCB1bmRlciB0aGUgZ2l2ZW4gYG5hbWVgIGFmdGVyIHRoZSByb3V0ZQogICAgICAgICAqICAgIGlzIHJlc29sdmVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHJvdXRlIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YCBvbiByb3V0ZQogICAgICAgICAqICAgIG1hdGNoLgogICAgICAgICAqCiAgICAgICAgICogICAgT2JqZWN0IHByb3BlcnRpZXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBjb250cm9sbGVyYCDigJMgYHsoc3RyaW5nfGZ1bmN0aW9uKCk9fWAg4oCTIENvbnRyb2xsZXIgZm4gdGhhdCBzaG91bGQgYmUgYXNzb2NpYXRlZCB3aXRoIG5ld2x5CiAgICAgICAgICogICAgICBjcmVhdGVkIHNjb3BlIG9yIHRoZSBuYW1lIG9mIGEge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIgcmVnaXN0ZXJlZCBjb250cm9sbGVyfQogICAgICAgICAqICAgICAgaWYgcGFzc2VkIGFzIGEgc3RyaW5nLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlYCDigJMgYHtzdHJpbmc9fWAg4oCTICBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30gb3IKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIG5nSW5jbHVkZX0gZGlyZWN0aXZlcy4KICAgICAgICAgKiAgICAgIHRoaXMgcHJvcGVydHkgdGFrZXMgcHJlY2VkZW5jZSBvdmVyIGB0ZW1wbGF0ZVVybGAuCiAgICAgICAgICogICAgLSBgdGVtcGxhdGVVcmxgIOKAkyBge3N0cmluZz19YCDigJMgcGF0aCB0byBhbiBodG1sIHRlbXBsYXRlIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkKICAgICAgICAgKiAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30uCiAgICAgICAgICogICAgLSBgcmVzb2x2ZWAgLSBge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbj49fWAgLSBBbiBvcHRpb25hbCBtYXAgb2YgZGVwZW5kZW5jaWVzIHdoaWNoIHNob3VsZAogICAgICAgICAqICAgICAgYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gSWYgYW55IG9mIHRoZXNlIGRlcGVuZGVuY2llcyBhcmUgcHJvbWlzZXMsIHRoZXkgd2lsbCBiZQogICAgICAgICAqICAgICAgcmVzb2x2ZWQgYW5kIGNvbnZlcnRlZCB0byBhIHZhbHVlIGJlZm9yZSB0aGUgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQgYW5kIHRoZQogICAgICAgICAqICAgICAgYCRyb3V0ZUNoYW5nZVN1Y2Nlc3NgIGV2ZW50IGlzIGZpcmVkLiBUaGUgbWFwIG9iamVjdCBpczoKICAgICAgICAgKgogICAgICAgICAqICAgICAgLSBga2V5YCDigJMgYHtzdHJpbmd9YDogYSBuYW1lIG9mIGEgZGVwZW5kZW5jeSB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBjb250cm9sbGVyLgogICAgICAgICAqICAgICAgLSBgZmFjdG9yeWAgLSBge3N0cmluZ3xmdW5jdGlvbn1gOiBJZiBgc3RyaW5nYCB0aGVuIGl0IGlzIGFuIGFsaWFzIGZvciBhIHNlcnZpY2UuCiAgICAgICAgICogICAgICAgIE90aGVyd2lzZSBpZiBmdW5jdGlvbiwgdGhlbiBpdCBpcyB7QGxpbmsgYXBpL0FVVE8uJGluamVjdG9yI2ludm9rZSBpbmplY3RlZH0KICAgICAgICAgKiAgICAgICAgYW5kIHRoZSByZXR1cm4gdmFsdWUgaXMgdHJlYXRlZCBhcyB0aGUgZGVwZW5kZW5jeS4gSWYgdGhlIHJlc3VsdCBpcyBhIHByb21pc2UsIGl0IGlzIHJlc29sdmVkCiAgICAgICAgICogICAgICAgIGJlZm9yZSBpdHMgdmFsdWUgaXMgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gQmUgYXdhcmUgdGhhdCBgbmdSb3V0ZS4kcm91dGVQYXJhbXNgIHdpbGwKICAgICAgICAgKiAgICAgICAgc3RpbGwgcmVmZXIgdG8gdGhlIHByZXZpb3VzIHJvdXRlIHdpdGhpbiB0aGVzZSByZXNvbHZlIGZ1bmN0aW9ucy4gIFVzZSBgJHJvdXRlLmN1cnJlbnQucGFyYW1zYAogICAgICAgICAqICAgICAgICB0byBhY2Nlc3MgdGhlIG5ldyByb3V0ZSBwYXJhbWV0ZXJzLCBpbnN0ZWFkLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgcmVkaXJlY3RUb2Ag4oCTIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0g4oCTIHZhbHVlIHRvIHVwZGF0ZQogICAgICAgICAqICAgICAge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb259IHBhdGggd2l0aCBhbmQgdHJpZ2dlciByb3V0ZSByZWRpcmVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgYHJlZGlyZWN0VG9gIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0LjxzdHJpbmc+fWAgLSByb3V0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgIGAkbG9jYXRpb24ucGF0aCgpYCBieSBhcHBseWluZyB0aGUgY3VycmVudCByb3V0ZSB0ZW1wbGF0ZVVybC4KICAgICAgICAgKiAgICAgIC0gYHtzdHJpbmd9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5wYXRoKClgCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0fWAgLSBjdXJyZW50IGAkbG9jYXRpb24uc2VhcmNoKClgCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIFRoZSBjdXN0b20gYHJlZGlyZWN0VG9gIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHN0cmluZyB3aGljaCB3aWxsIGJlIHVzZWQKICAgICAgICAgKiAgICAgIHRvIHVwZGF0ZSBgJGxvY2F0aW9uLnBhdGgoKWAgYW5kIGAkbG9jYXRpb24uc2VhcmNoKClgLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgW3JlbG9hZE9uU2VhcmNoPXRydWVdYCAtIHtib29sZWFuPX0gLSByZWxvYWQgcm91dGUgd2hlbiBvbmx5ICRsb2NhdGlvbi5zZWFyY2goKQogICAgICAgICAqICAgIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIElmIHRoZSBvcHRpb24gaXMgc2V0IHRvIGBmYWxzZWAgYW5kIHVybCBpbiB0aGUgYnJvd3NlciBjaGFuZ2VzLCB0aGVuCiAgICAgICAgICogICAgICBgJHJvdXRlVXBkYXRlYCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGUgcm9vdCBzY29wZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHNlbGYKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBuZXcgcm91dGUgZGVmaW5pdGlvbiB0byB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLndoZW4gPSBmdW5jdGlvbihwYXRoLCByb3V0ZSkgewogICAgICAgICAgICByb3V0ZXNbcGF0aF0gPSBleHRlbmQoe3JlbG9hZE9uU2VhcmNoOiB0cnVlfSwgcm91dGUpOwoKICAgICAgICAgICAgLy8gY3JlYXRlIHJlZGlyZWN0aW9uIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICAgICAgICAgIGlmIChwYXRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVkaXJlY3RQYXRoID0gKHBhdGhbcGF0aC5sZW5ndGgtMV0gPT0gJy8nKQogICAgICAgICAgICAgICAgICAgID8gcGF0aC5zdWJzdHIoMCwgcGF0aC5sZW5ndGgtMSkKICAgICAgICAgICAgICAgICAgICA6IHBhdGggKycvJzsKCiAgICAgICAgICAgICAgICByb3V0ZXNbcmVkaXJlY3RQYXRoXSA9IHtyZWRpcmVjdFRvOiBwYXRofTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI290aGVyd2lzZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm91dGVQcm92aWRlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyByb3V0ZSBkZWZpbml0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHJvdXRlIGNoYW5nZSB3aGVuIG5vIG90aGVyIHJvdXRlIGRlZmluaXRpb24KICAgICAgICAgKiBpcyBtYXRjaGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAuCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqLwogICAgICAgIHRoaXMub3RoZXJ3aXNlID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMud2hlbihudWxsLCBwYXJhbXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRsb2NhdGlvbicsICckcm91dGVQYXJhbXMnLCAnJHEnLCAnJGluamVjdG9yJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywKICAgICAgICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGxvY2F0aW9uLCAgICRyb3V0ZVBhcmFtcywgICAkcSwgICAkaW5qZWN0b3IsICAgJGh0dHAsICAgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjdXJyZW50IFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogVGhlIHJvdXRlIGRlZmluaXRpb24gY29udGFpbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtIGBjb250cm9sbGVyYDogVGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgYXMgZGVmaW5lIGluIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gYGxvY2Fsc2A6IEEgbWFwIG9mIGxvY2FscyB3aGljaCBpcyB1c2VkIGJ5IHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlcn0gc2VydmljZSBmb3IKICAgICAgICAgICAgICAgICAqICAgICBjb250cm9sbGVyIGluc3RhbnRpYXRpb24uIFRoZSBgbG9jYWxzYCBjb250YWluCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgYHJlc29sdmVgIG1hcC4gQWRkaXRpb25hbGx5IHRoZSBgbG9jYWxzYCBhbHNvIGNvbnRhaW46CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgIC0gYCRzY29wZWAgLSBUaGUgY3VycmVudCByb3V0ZSBzY29wZS4KICAgICAgICAgICAgICAgICAqICAgICAtIGAkdGVtcGxhdGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSByb3V0ZXMgQXJyYXkgb2YgYWxsIGNvbmZpZ3VyZWQgcm91dGVzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogSXMgdXNlZCBmb3IgZGVlcC1saW5raW5nIFVSTHMgdG8gY29udHJvbGxlcnMgYW5kIHZpZXdzIChIVE1MIHBhcnRpYWxzKS4KICAgICAgICAgICAgICAgICAqIEl0IHdhdGNoZXMgYCRsb2NhdGlvbi51cmwoKWAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgcGF0aCB0byBhbiBleGlzdGluZyByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFlvdSBjYW4gZGVmaW5lIHJvdXRlcyB0aHJvdWdoIHtAbGluayBuZy4kcm91dGVQcm92aWRlciAkcm91dGVQcm92aWRlcn0ncyBBUEkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgaXMgdHlwaWNhbGx5IHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmUgYW5kIHRoZSB7QGxpbmsgbmcuJHJvdXRlUGFyYW1zICRyb3V0ZVBhcmFtc30gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgY2hhbmdpbmcgdGhlIFVSTCBoYXNoIGNhdXNlcyB0aGUgYCRyb3V0ZWAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZQogICAgICAgICAgICAgICAgIFVSTCwgYW5kIHRoZSBgbmdWaWV3YCBwdWxscyBpbiB0aGUgcGFydGlhbC4KCiAgICAgICAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZXhhbXBsZSBpcyB1c2luZyB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBpbmxpbmVkIHRlbXBsYXRlc30KICAgICAgICAgICAgICAgICB0byBnZXQgaXQgd29ya2luZyBvbiBqc2ZpZGRsZSBhcyB3ZWxsLgoKICAgICAgICAgICAgICAgICA8ZXhhbXBsZSBtb2R1bGU9Im5nVmlldyI+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICAgICAgICAgQ2hvb3NlOgogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieS9jaC8xIj5Nb2J5OiBDaDE8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL0dhdHNieSI+R2F0c2J5PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9TY2FybGV0Ij5TY2FybGV0IExldHRlcjwvYT48YnIvPgoKICAgICAgICAgICAgICAgICA8ZGl2IG5nLXZpZXc+PC9kaXY+CiAgICAgICAgICAgICAgICAgPGhyIC8+CgogICAgICAgICAgICAgICAgIDxwcmU+JGxvY2F0aW9uLnBhdGgoKSA9IHt7JGxvY2F0aW9uLnBhdGgoKX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybCA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmx9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQucGFyYW1zID0ge3skcm91dGUuY3VycmVudC5wYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZSA9IHt7JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGVQYXJhbXMgPSB7eyRyb3V0ZVBhcmFtc319PC9wcmU+CiAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJib29rLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImNoYXB0ZXIuaHRtbCI+CiAgICAgICAgICAgICAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICAgICAgICAgICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgICAgICAgICAgICAgIENoYXB0ZXIgSWQ6IHt7cGFyYW1zLmNoYXB0ZXJJZH19CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnLCBbXSwgZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEJvb2tDbnRsLAogICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAvLyBJIHdpbGwgY2F1c2UgYSAxIHNlY29uZCBkZWxheQogICAgICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oJHEsICR0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgdmFyIGRlbGF5ID0gJHEuZGVmZXIoKTsKICAgICAgICAgICAgICAgICAkdGltZW91dChkZWxheS5yZXNvbHZlLCAxMDAwKTsKICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkucHJvbWlzZTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0pOwogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQvY2gvOmNoYXB0ZXJJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICAgfSk7CgogICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE1haW5DbnRsKCRzY29wZSwgJHJvdXRlLCAkcm91dGVQYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlUGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgIHZhciBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQ2hhcHRlciBJZFw6IDEvKTsKCiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgICBzbGVlcCgyKTsgLy8gcHJvbWlzZXMgYXJlIG5vdCBwYXJ0IG9mIHNjZW5hcmlvIHdhaXRpbmcKICAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQm9va0NudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlU3RhcnQKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSByb3V0ZSBjaGFuZ2UuIEF0IHRoaXMgIHBvaW50IHRoZSByb3V0ZSBzZXJ2aWNlcyBzdGFydHMKICAgICAgICAgICAgICAgICAqIHJlc29sdmluZyBhbGwgb2YgdGhlIGRlcGVuZGVuY2llcyBuZWVkZWQgZm9yIHRoZSByb3V0ZSBjaGFuZ2UgdG8gb2NjdXJzLgogICAgICAgICAgICAgICAgICogVHlwaWNhbGx5IHRoaXMgaW52b2x2ZXMgZmV0Y2hpbmcgdGhlIHZpZXcgdGVtcGxhdGUgYXMgd2VsbCBhcyBhbnkgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICAgKiBkZWZpbmVkIGluIGByZXNvbHZlYCByb3V0ZSBwcm9wZXJ0eS4gT25jZSAgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgKiBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgaXMgZmlyZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gbmV4dCBGdXR1cmUgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSBjdXJyZW50IEN1cnJlbnQgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIHJvdXRlIGRlcGVuZGVuY2llcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IGxpc3RlbnMgZm9yIHRoZSBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAqIHRvIGluc3RhbnRpYXRlIHRoZSBjb250cm9sbGVyIGFuZCByZW5kZXIgdGhlIHZpZXcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZXxVbmRlZmluZWR9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLCBvciB1bmRlZmluZWQgaWYgY3VycmVudCBpcyBmaXJzdCByb3V0ZSBlbnRlcmVkLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VFcnJvcgogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIGlmIGFueSBvZiB0aGUgcmVzb2x2ZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcHJldmlvdXMgUHJldmlvdXMgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSByZWplY3Rpb24gUmVqZWN0aW9uIG9mIHRoZSBwcm9taXNlLiBVc3VhbGx5IHRoZSBlcnJvciBvZiB0aGUgZmFpbGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZVVwZGF0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgYHJlbG9hZE9uU2VhcmNoYCBwcm9wZXJ0eSBoYXMgYmVlbiBzZXQgdG8gZmFsc2UsIGFuZCB3ZSBhcmUgcmV1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogaW5zdGFuY2Ugb2YgdGhlIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgZm9yY2VSZWxvYWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAkcm91dGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlczogcm91dGVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlI3JlbG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBDYXVzZXMgYCRyb3V0ZWAgc2VydmljZSB0byByZWxvYWQgdGhlIGN1cnJlbnQgcm91dGUgZXZlbiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gaGFzbid0IGNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEFzIGEgcmVzdWx0IG9mIHRoYXQsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30KICAgICAgICAgICAgICAgICAgICAgICAgICogY3JlYXRlcyBuZXcgc2NvcGUsIHJlaW5zdGFudGlhdGVzIHRoZSBjb250cm9sbGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlUmVsb2FkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyh1cGRhdGVSb3V0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgdXBkYXRlUm91dGUpOwoKICAgICAgICAgICAgICAgIHJldHVybiAkcm91dGU7CgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBwYXJhbSBvbiB7c3RyaW5nfSBjdXJyZW50IHVybAogICAgICAgICAgICAgICAgICogQHBhcmFtIHdoZW4ge3N0cmluZ30gcm91dGUgd2hlbiB0ZW1wbGF0ZSB0byBtYXRjaCB0aGUgdXJsIGFnYWluc3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm4gez9PYmplY3R9CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHN3aXRjaFJvdXRlTWF0Y2hlcihvbiwgd2hlbikgewogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IHRoaXMgY29kZSBpcyBjb252b2x1dGVkIGFuZCBpbmVmZmljaWVudCwgd2Ugc2hvdWxkIGNvbnN0cnVjdCB0aGUgcm91dGUgbWF0Y2hpbmcKICAgICAgICAgICAgICAgICAgICAvLyAgIHJlZ2V4IG9ubHkgb25jZSBhbmQgdGhlbiByZXVzZSBpdAoKICAgICAgICAgICAgICAgICAgICAvLyBFc2NhcGUgcmVnZXhwIHNwZWNpYWwgY2hhcmFjdGVycy4KICAgICAgICAgICAgICAgICAgICB3aGVuID0gJ14nICsgd2hlbi5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgIlxcJCYiKSArICckJzsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVnZXggPSAnJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGRzdCA9IHt9OwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmUgPSAvOihcdyspL2csCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtTWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RNYXRjaGVkSW5kZXggPSAwOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKHBhcmFtTWF0Y2ggPSByZS5leGVjKHdoZW4pKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIGVhY2ggOnBhcmFtIGluIGB3aGVuYCBhbmQgcmVwbGFjZSBpdCB3aXRoIGEgY2FwdHVyaW5nIGdyb3VwLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgYWxsIG90aGVyIHNlY3Rpb25zIG9mIHdoZW4gdW5jaGFuZ2VkLgogICAgICAgICAgICAgICAgICAgICAgICByZWdleCArPSB3aGVuLnNsaWNlKGxhc3RNYXRjaGVkSW5kZXgsIHBhcmFtTWF0Y2guaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWdleCArPSAnKFteXFwvXSopJzsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnB1c2gocGFyYW1NYXRjaFsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RNYXRjaGVkSW5kZXggPSByZS5sYXN0SW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB0cmFpbGluZyBwYXRoIHBhcnQuCiAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gd2hlbi5zdWJzdHIobGFzdE1hdGNoZWRJbmRleCk7CgogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IG9uLm1hdGNoKG5ldyBSZWdFeHAocmVnZXgpKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChwYXJhbXMsIGZ1bmN0aW9uKG5hbWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3RbbmFtZV0gPSBtYXRjaFtpbmRleCArIDFdOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gZHN0IDogbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVSb3V0ZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHBhcnNlUm91dGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9ICRyb3V0ZS5jdXJyZW50OwoKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBsYXN0ICYmIG5leHQuJCRyb3V0ZSA9PT0gbGFzdC4kJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICYmIGVxdWFscyhuZXh0LnBhdGhQYXJhbXMsIGxhc3QucGF0aFBhcmFtcykgJiYgIW5leHQucmVsb2FkT25TZWFyY2ggJiYgIWZvcmNlUmVsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QucGFyYW1zID0gbmV4dC5wYXJhbXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvcHkobGFzdC5wYXJhbXMsICRyb3V0ZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlVXBkYXRlJywgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0IHx8IGxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VSZWxvYWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdGFydCcsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm91dGUuY3VycmVudCA9IG5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dC5yZWRpcmVjdFRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5leHQucmVkaXJlY3RUbykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoaW50ZXJwb2xhdGUobmV4dC5yZWRpcmVjdFRvLCBuZXh0LnBhcmFtcykpLnNlYXJjaChuZXh0LnBhcmFtcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnVybChuZXh0LnJlZGlyZWN0VG8obmV4dC5wYXRoUGFyYW1zLCAkbG9jYXRpb24ucGF0aCgpLCAkbG9jYXRpb24uc2VhcmNoKCkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRxLndoZW4obmV4dCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXh0LnJlc29sdmUgfHwge30sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goaXNTdHJpbmcodmFsdWUpID8gJGluamVjdG9yLmdldCh2YWx1ZSkgOiAkaW5qZWN0b3IuaW52b2tlKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlID0gbmV4dC50ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQodGVtcGxhdGUgPSBuZXh0LnRlbXBsYXRlVXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSAkaHR0cC5nZXQodGVtcGxhdGUsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7IHJldHVybiByZXNwb25zZS5kYXRhOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKCckdGVtcGxhdGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHEuYWxsKHZhbHVlcykudGhlbihmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNba2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZ0ZXIgcm91dGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICRyb3V0ZS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0LmxvY2FscyA9IGxvY2FsczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHkobmV4dC5wYXJhbXMsICRyb3V0ZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdWNjZXNzJywgbmV4dCwgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZUVycm9yJywgbmV4dCwgbGFzdCwgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0aGUgY3VycmVudCBhY3RpdmUgcm91dGUsIGJ5IG1hdGNoaW5nIGl0IGFnYWluc3QgdGhlIFVSTAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBwYXJzZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIC8vIE1hdGNoIGEgcm91dGUKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW1zLCBtYXRjaDsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJvdXRlcywgZnVuY3Rpb24ocm91dGUsIHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCAmJiAocGFyYW1zID0gc3dpdGNoUm91dGVNYXRjaGVyKCRsb2NhdGlvbi5wYXRoKCksIHBhdGgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBleHRlbmQoe30sICRsb2NhdGlvbi5zZWFyY2goKSwgcGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUGFyYW1zOiBwYXJhbXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLiQkcm91dGUgPSByb3V0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIE5vIHJvdXRlIG1hdGNoZWQ7IGZhbGxiYWNrIHRvICJvdGhlcndpc2UiIHJvdXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoIHx8IHJvdXRlc1tudWxsXSAmJiBpbmhlcml0KHJvdXRlc1tudWxsXSwge3BhcmFtczoge30sIHBhdGhQYXJhbXM6e319KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIGludGVycG9sYXRpb24gb2YgdGhlIHJlZGlyZWN0IHBhdGggd2l0aCB0aGUgcGFyYW1ldHJzCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludGVycG9sYXRlKHN0cmluZywgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2goKHN0cmluZ3x8JycpLnNwbGl0KCc6JyksIGZ1bmN0aW9uKHNlZ21lbnQsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goc2VnbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VnbWVudE1hdGNoID0gc2VnbWVudC5tYXRjaCgvKFx3KykoLiopLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gc2VnbWVudE1hdGNoWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGFyYW1zW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goc2VnbWVudE1hdGNoWzJdIHx8ICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHJvdXRlUGFyYW1zCiAgICAgKiBAcmVxdWlyZXMgJHJvdXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDdXJyZW50IHNldCBvZiByb3V0ZSBwYXJhbWV0ZXJzLiBUaGUgcm91dGUgcGFyYW1ldGVycyBhcmUgYSBjb21iaW5hdGlvbiBvZiB0aGUKICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9ufSBgc2VhcmNoKClgLCBhbmQgYHBhdGgoKWAuIFRoZSBgcGF0aGAgcGFyYW1ldGVycwogICAgICogYXJlIGV4dHJhY3RlZCB3aGVuIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gcGF0aCBpcyBtYXRjaGVkLgogICAgICoKICAgICAqIEluIGNhc2Ugb2YgcGFyYW1ldGVyIG5hbWUgY29sbGlzaW9uLCBgcGF0aGAgcGFyYW1zIHRha2UgcHJlY2VkZW5jZSBvdmVyIGBzZWFyY2hgIHBhcmFtcy4KICAgICAqCiAgICAgKiBUaGUgc2VydmljZSBndWFyYW50ZWVzIHRoYXQgdGhlIGlkZW50aXR5IG9mIHRoZSBgJHJvdXRlUGFyYW1zYCBvYmplY3Qgd2lsbCByZW1haW4gdW5jaGFuZ2VkCiAgICAgKiAoYnV0IGl0cyBwcm9wZXJ0aWVzIHdpbGwgbGlrZWx5IGNoYW5nZSkgZXZlbiB3aGVuIGEgcm91dGUgY2hhbmdlIG9jY3Vycy4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgdGhlIGAkcm91dGVQYXJhbXNgIGFyZSBvbmx5IHVwZGF0ZWQgKmFmdGVyKiBhIHJvdXRlIGNoYW5nZSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LgogICAgICogVGhpcyBtZWFucyB0aGF0IHlvdSBjYW5ub3QgcmVseSBvbiBgJHJvdXRlUGFyYW1zYCBiZWluZyBjb3JyZWN0IGluIHJvdXRlIHJlc29sdmUgZnVuY3Rpb25zLgogICAgICogSW5zdGVhZCB5b3UgY2FuIHVzZSBgJHJvdXRlLmN1cnJlbnQucGFyYW1zYCB0byBhY2Nlc3MgdGhlIG5ldyByb3V0ZSdzIHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAgLy8gR2l2ZW46CiAgICAgKiAgLy8gVVJMOiBodHRwOi8vc2VydmVyLmNvbS9pbmRleC5odG1sIy9DaGFwdGVyLzEvU2VjdGlvbi8yP3NlYXJjaD1tb2J5CiAgICAgKiAgLy8gUm91dGU6IC9DaGFwdGVyLzpjaGFwdGVySWQvU2VjdGlvbi86c2VjdGlvbklkCiAgICAgKiAgLy8KICAgICAqICAvLyBUaGVuCiAgICAgKiAgJHJvdXRlUGFyYW1zID09PiB7Y2hhcHRlcklkOjEsIHNlY3Rpb25JZDoyLCBzZWFyY2g6J21vYnknfQogICAgICogPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVBhcmFtc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4oe30pOwogICAgfQoKICAgIC8qKgogICAgICogREVTSUdOIE5PVEVTCiAgICAgKgogICAgICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogICAgICoKICAgICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICAgKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAgICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogICAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAgICoKICAgICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgICAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAoc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgICAqCiAgICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICAgKgogICAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICAgKiBhcmUgZXhwZW5zaXZlIHRvIGNvbnN0cnVjdC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICAgKiBhc3N1bWluZyB0aGF0IHRoZSBtb2RlbCBpcyB1bnN0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBjaGlsZCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGFuZCBwcm92aWRlCiAgICAgKiBldmVudCBwcm9jZXNzaW5nIGxpZmUtY3ljbGUuIFNlZSB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpewogICAgICAgIHZhciBUVEwgPSAxMDsKCiAgICAgICAgdGhpcy5kaWdlc3RUdGwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFRUTDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLAogICAgICAgICAgICBmdW5jdGlvbiggJGluamVjdG9yLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRwYXJzZSkgewoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICAgICAgICAgICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIuaW5qZWN0b3IoWyduZyddKS5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSkgewogICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGUuJG5ldygpOwogICAgICAgICAgIHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnV29ybGQnOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwodW5kZWZpbmVkKTsKCiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBzY29wZS5ncmVldGluZyA9IHNjb3BlLnNhbHV0YXRpb24gKyAnICcgKyBzY29wZS5uYW1lICsgJyEnOwogICAgICAgICAgIH0pOyAvLyBpbml0aWFsaXplIHRoZSB3YXRjaAoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ01pc2tvJzsKICAgICAgICAgICAvLyBzdGlsbCBvbGQgdmFsdWUsIHNpbmNlIHdhdGNoZXMgaGF2ZSBub3QgYmVlbiBjYWxsZWQgeWV0CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsgLy8gZmlyZSBhbGwgIHRoZSB3YXRjaGVzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKCdIZWxsbyBNaXNrbyEnKTsKICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgSW5oZXJpdGFuY2UKICAgICAgICAgICAgICAgICAqIEEgc2NvcGUgY2FuIGluaGVyaXQgZnJvbSBhIHBhcmVudCBzY29wZSwgYXMgaW4gdGhpcyBleGFtcGxlOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gJHJvb3RTY29wZTsKICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuJG5ldygpOwoKICAgICAgICAgICAgICAgICBwYXJlbnQuc2FsdXRhdGlvbiA9ICJIZWxsbyI7CiAgICAgICAgICAgICAgICAgY2hpbGQubmFtZSA9ICJXb3JsZCI7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CgogICAgICAgICAgICAgICAgIGNoaWxkLnNhbHV0YXRpb24gPSAiV2VsY29tZSI7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ1dlbGNvbWUnKTsKICAgICAgICAgICAgICAgICBleHBlY3QocGFyZW50LnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBwcm92aWRlcnMgTWFwIG9mIHNlcnZpY2UgZmFjdG9yeSB3aGljaCBuZWVkIHRvIGJlIHByb3ZpZGVkCiAgICAgICAgICAgICAgICAgKiAgICAgZm9yIHRoZSBjdXJyZW50IHNjb3BlLiBEZWZhdWx0cyB0byB7QGxpbmsgbmd9LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgKj49fSBpbnN0YW5jZUNhY2hlIFByb3ZpZGVzIHByZS1pbnN0YW50aWF0ZWQgc2VydmljZXMgd2hpY2ggc2hvdWxkCiAgICAgICAgICAgICAgICAgKiAgICAgYXBwZW5kL292ZXJyaWRlIHNlcnZpY2VzIHByb3ZpZGVkIGJ5IGBwcm92aWRlcnNgLiBUaGlzIGlzIGhhbmR5IHdoZW4gdW5pdC10ZXN0aW5nIGFuZCBoYXZpbmcKICAgICAgICAgICAgICAgICAqICAgICB0aGUgbmVlZCB0byBvdmVycmlkZSBhIGRlZmF1bHQgc2VydmljZS4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE5ld2x5IGNyZWF0ZWQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTY29wZSgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkcGhhc2UgPSB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkd2F0Y2hlcnMgPQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXNbJ3RoaXMnXSA9IHRoaXMuJHJvb3QgPSAgdGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgICAgICAgICAqLwoKCiAgICAgICAgICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24oaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgQ2hpbGQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGlzb2xhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiByZW1vdmUgYXQgc29tZSBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0FQSS1DSEFOR0U6IFVzZSAkY29udHJvbGxlciB0byBpbnN0YW50aWF0ZSBjb250cm9sbGVycy4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkID0gZnVuY3Rpb24oKSB7fTsgLy8gc2hvdWxkIGJlIGFub255bW91czsgVGhpcyBpcyBzbyB0aGF0IHdoZW4gdGhlIG1pbmlmaWVyIG11bmdlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIG5hbWUgaXQgZG9lcyBub3QgYmVjb21lIHJhbmRvbSBzZXQgb2YgY2hhcnMuIFRoZXNlIHdpbGwgdGhlbiBzaG93IHVwIGFzIGNsYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuYW1lIGluIHRoZSBkZWJ1Z2dlci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IG5ldyBDaGlsZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkWyd0aGlzJ10gPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJHBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkYXN5bmNRdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJHdhdGNoZXJzID0gY2hpbGQuJCRuZXh0U2libGluZyA9IGNoaWxkLiQkY2hpbGRIZWFkID0gY2hpbGQuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkVGFpbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRjaGlsZEhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2gKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUmVnaXN0ZXJzIGEgYGxpc3RlbmVyYCBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuZXZlciB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIC0gVGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGNhbGxlZCBvbiBldmVyeSBjYWxsIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiAgIHNob3VsZCByZXR1cm4gdGhlIHZhbHVlIHdoaWNoIHdpbGwgYmUgd2F0Y2hlZC4gKFNpbmNlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfQogICAgICAgICAgICAgICAgICAgICAqICAgcmVydW5zIHdoZW4gaXQgZGV0ZWN0cyBjaGFuZ2VzIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIKICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIGJlIGlkZW1wb3RlbnQuKQogICAgICAgICAgICAgICAgICAgICAqIC0gVGhlIGBsaXN0ZW5lcmAgaXMgY2FsbGVkIG9ubHkgd2hlbiB0aGUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCBgd2F0Y2hFeHByZXNzaW9uYCBhbmQgdGhlCiAgICAgICAgICAgICAgICAgICAgICogICBwcmV2aW91cyBjYWxsIHRvIGB3YXRjaEV4cHJlc3Npb25gIGFyZSBub3QgZXF1YWwgKHdpdGggdGhlIGV4Y2VwdGlvbiBvZiB0aGUgaW5pdGlhbCBydW4sCiAgICAgICAgICAgICAgICAgICAgICogICBzZWUgYmVsb3cpLiBUaGUgaW5lcXVhbGl0eSBpcyBkZXRlcm1pbmVkIGFjY29yZGluZyB0bwogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBmdW5jdGlvbi4gVG8gc2F2ZSB0aGUgdmFsdWUgb2YgdGhlIG9iamVjdCBmb3IgbGF0ZXIgY29tcGFyaXNvbiwgdGhlCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgYW5ndWxhci5jb3B5fSBmdW5jdGlvbiBpcyB1c2VkLiBJdCBhbHNvIG1lYW5zIHRoYXQgd2F0Y2hpbmcgY29tcGxleCBvcHRpb25zIHdpbGwKICAgICAgICAgICAgICAgICAgICAgKiAgIGhhdmUgYWR2ZXJzZSBtZW1vcnkgYW5kIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucy4KICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSB3YXRjaCBgbGlzdGVuZXJgIG1heSBjaGFuZ2UgdGhlIG1vZGVsLCB3aGljaCBtYXkgdHJpZ2dlciBvdGhlciBgbGlzdGVuZXJgcyB0byBmaXJlLiBUaGlzCiAgICAgICAgICAgICAgICAgICAgICogICBpcyBhY2hpZXZlZCBieSByZXJ1bm5pbmcgdGhlIHdhdGNoZXJzIHVudGlsIG5vIGNoYW5nZXMgYXJlIGRldGVjdGVkLiBUaGUgcmVydW4gaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICogICBsaW1pdCBpcyAxMCB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AgZGVhZGxvY2suCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gaXMgY2FsbGVkLAogICAgICAgICAgICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoIG5vIGBsaXN0ZW5lcmAuIChTaW5jZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgICAgICAgICAgICAgICAqIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlIHdoZW4gYSBjaGFuZ2UgaXMKICAgICAgICAgICAgICAgICAgICAgKiBkZXRlY3RlZCwgYmUgcHJlcGFyZWQgZm9yIG11bHRpcGxlIGNhbGxzIHRvIHlvdXIgbGlzdGVuZXIuKQogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXIgYSB3YXRjaGVyIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgc2NvcGUsIHRoZSBgbGlzdGVuZXJgIGZuIGlzIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICAgICAgICAgICAgICAgICAqICh2aWEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYyAkZXZhbEFzeW5jfSkgdG8gaW5pdGlhbGl6ZSB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB3YXRjaGVyLiBJbiByYXJlIGNhc2VzLCB0aGlzIGlzIHVuZGVzaXJhYmxlIGJlY2F1c2UgdGhlIGxpc3RlbmVyIGlzIGNhbGxlZCB3aGVuIHRoZSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgKiBvZiBgd2F0Y2hFeHByZXNzaW9uYCBkaWRuJ3QgY2hhbmdlLiBUbyBkZXRlY3QgdGhpcyBzY2VuYXJpbyB3aXRoaW4gdGhlIGBsaXN0ZW5lcmAgZm4sIHlvdQogICAgICAgICAgICAgICAgICAgICAqIGNhbiBjb21wYXJlIHRoZSBgbmV3VmFsYCBhbmQgYG9sZFZhbGAuIElmIHRoZXNlIHR3byB2YWx1ZXMgYXJlIGlkZW50aWNhbCAoYD09PWApIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgICAgICogbGlzdGVuZXIgd2FzIGNhbGxlZCBkdWUgdG8gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIC8vIGxldCdzIGFzc3VtZSB0aGF0IHNjb3BlIHdhcyBkZXBlbmRlbmN5IGluamVjdGVkIGFzIHRoZSAkcm9vdFNjb3BlCiAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOyB9KTsKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIC8vIG5vIHZhcmlhYmxlIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpfSB3YXRjaEV4cHJlc3Npb24gRXhwcmVzc2lvbiB0aGF0IGlzIGV2YWx1YXRlZCBvbiBlYWNoCiAgICAgICAgICAgICAgICAgICAgICogICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZS4gQSBjaGFuZ2UgaW4gdGhlIHJldHVybiB2YWx1ZSB0cmlnZ2VycyBhCiAgICAgICAgICAgICAgICAgICAgICogICAgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYHNjb3BlYCBhcyBhIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBsaXN0ZW5lciBDYWxsYmFjayBjYWxsZWQgd2hlbmV2ZXIgdGhlIHJldHVybiB2YWx1ZSBvZgogICAgICAgICAgICAgICAgICAgICAqICAgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUsIHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlcyBhcyBwYXJhbWV0ZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gb2JqZWN0RXF1YWxpdHkgQ29tcGFyZSBvYmplY3QgZm9yIGVxdWFsaXR5IHJhdGhlciB0aGFuIGZvciByZWZlcmVuY2UuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7bGlzdGVuRm4oc2NvcGUpO307CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZSB0aGUgbW9kZWwsIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICogZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUgbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93CiAgICAgICAgICAgICAgICAgICAgICogYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFVzdWFsbHkgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAgICAgICAgICAgICAgICogSW5zdGVhZCBhIGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluIGEKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gIHdpdGgge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgICAgICAgICAgICAgICAqIHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFlvdSBtYXkgaGF2ZSBhIG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCBmcm9tIHdpdGhpbiB1bml0LXRlc3RzLCB0byBzaW11bGF0ZSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBsaWZlLWN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3YXRjaCwgdmFsdWUsIGxhc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzeW5jUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSwgdHRsID0gVFRMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwgY3VycmVudCwgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHgsIGxvZ01zZzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luUGhhc2UoJyRkaWdlc3QnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzeW5jUXVldWUgPSBjdXJyZW50LiQkYXN5bmNRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC4kZXZhbChhc3luY1F1ZXVlLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2F0Y2ggJiYgKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkaXJ0eSAmJiAhKHR0bC0tKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihUVEwgKyAnICRkaWdlc3QoKSBpdGVyYXRpb25zIHJlYWNoZWQuIEFib3J0aW5nIVxuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdXYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6ICcgKyB0b0pzb24od2F0Y2hMb2cpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHNjb3BlIGJlaW5nIGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQnJvYWRjYXN0ZWQgd2hlbiBhIHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4gYXJlIGJlaW5nIGRlc3Ryb3llZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAgICAgICAgICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgc2NvcGUgKGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuKSBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFJlbW92YWwgaW1wbGllcwogICAgICAgICAgICAgICAgICAgICAqIHRoYXQgY2FsbHMgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHdpbGwgbm8gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgICogcHJvcGFnYXRlIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uIFJlbW92YWwgYWxzbyBpbXBsaWVzIHRoYXQgdGhlIGN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAgKiBzY29wZSBpcyBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGAkZGVzdHJveSgpYCBpcyB1c3VhbGx5IHVzZWQgYnkgZGlyZWN0aXZlcyBzdWNoIGFzCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gZm9yIG1hbmFnaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHVucm9sbGluZyBvZiB0aGUgbG9vcC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEp1c3QgYmVmb3JlIGEgc2NvcGUgaXMgZGVzdHJveWVkIGEgYCRkZXN0cm95YCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGlzIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGNoYW5jZSB0bwogICAgICAgICAgICAgICAgICAgICAqIHBlcmZvcm0gYW55IG5lY2Vzc2FyeSBjbGVhbnVwLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICAgICAgICAgICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCBkZXN0cm95IHRoZSByb290IHNjb3BlIG9yIGEgc2NvcGUgdGhhdCBoYXMgYmVlbiBhbHJlYWR5IGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZSA9PSB0aGlzIHx8IHRoaXMuJCRkZXN0cm95ZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuJHBhcmVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGJyb2FkY2FzdCgnJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRIZWFkID09IHRoaXMpIHBhcmVudC4kJGNoaWxkSGVhZCA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZFRhaWwgPSB0aGlzLiQkcHJldlNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkcHJldlNpYmxpbmcpIHRoaXMuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJG5leHRTaWJsaW5nKSB0aGlzLiQkbmV4dFNpYmxpbmcuJCRwcmV2U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZzsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYm9ndXMgY29kZSB0aGF0IHdvcmtzIGFyb3VuZCBDaHJvbWUncyBHQyBsZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMTMxMyNpc3N1ZWNvbW1lbnQtMTAzNzg0NTEKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kcGFyZW50ID0gdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkSGVhZCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZXhwcmVzc2lvbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUgcmV0dXJuaW5nIHRoZSByZXN1bHQuIEFueSBleGNlcHRpb25zIGluIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGV4cHJlc3Npb24gYXJlIHByb3BhZ2F0ZWQgKHVuY2F1Z2h0KS4gVGhpcyBpcyB1c2VmdWwgd2hlbiBldmFsdWF0aW5nIEFuZ3VsYXIgZXhwcmVzc2lvbnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmEgPSAxOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5iID0gMjsKCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnYStiJykpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRldmFsOiBmdW5jdGlvbihleHByLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwYXJzZShleHByKSh0aGlzLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYwogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUgY3VycmVudCBzY29wZSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRldmFsQXN5bmNgIG1ha2VzIG5vIGd1YXJhbnRlZXMgYXMgdG8gd2hlbiB0aGUgYGV4cHJlc3Npb25gIHdpbGwgYmUgZXhlY3V0ZWQsIG9ubHkgdGhhdDoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgaW4gdGhlIGN1cnJlbnQgc2NyaXB0IGV4ZWN1dGlvbiBjb250ZXh0IChiZWZvcmUgYW55IERPTSByZW5kZXJpbmcpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgICAgICAgICAgICAgICAqICAgICBgZXhwcmVzc2lvbmAgZXhlY3V0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGV2YWxBc3luYzogZnVuY3Rpb24oZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKGV4cHIpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIgZnJhbWV3b3JrLgogICAgICAgICAgICAgICAgICAgICAqIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUtY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKiBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKiAyLiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAqICAgIHdhcyBleGVjdXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luUGhhc2UoJyRhcHBseScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGV2YWwoZXhwcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkb24KICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogTGlzdGVucyBvbiBldmVudHMgb2YgYSBnaXZlbiB0eXBlLiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQgJGVtaXR9IGZvciBkaXNjdXNzaW9uIG9mCiAgICAgICAgICAgICAgICAgICAgICogZXZlbnQgbGlmZSBjeWNsZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3JtYXQgaXM6IGBmdW5jdGlvbihldmVudCwgYXJncy4uLilgLiBUaGUgYGV2ZW50YCBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgKiBwYXNzZWQgaW50byB0aGUgbGlzdGVuZXIgaGFzIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlczoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgdGFyZ2V0U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgc2NvcGUgb24gd2hpY2ggdGhlIGV2ZW50IHdhcyBgJGVtaXRgLWVkIG9yIGAkYnJvYWRjYXN0YC1lZC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYGN1cnJlbnRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBjdXJyZW50IHNjb3BlIHdoaWNoIGlzIGhhbmRsaW5nIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYG5hbWVgIC0gYHtzdHJpbmd9YDogTmFtZSBvZiB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBzdG9wUHJvcGFnYXRpb25gIC0gYHtmdW5jdGlvbj19YDogY2FsbGluZyBgc3RvcFByb3BhZ2F0aW9uYCBmdW5jdGlvbiB3aWxsIGNhbmNlbCBmdXJ0aGVyIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgIHByb3BhZ2F0aW9uIChhdmFpbGFibGUgb25seSBmb3IgZXZlbnRzIHRoYXQgd2VyZSBgJGVtaXRgLWVkKS4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHByZXZlbnREZWZhdWx0YCAtIGB7ZnVuY3Rpb259YDogY2FsbGluZyBgcHJldmVudERlZmF1bHRgIHNldHMgYGRlZmF1bHRQcmV2ZW50ZWRgIGZsYWcgdG8gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYGRlZmF1bHRQcmV2ZW50ZWRgIC0gYHtib29sZWFufWA6IHRydWUgaWYgYHByZXZlbnREZWZhdWx0YCB3YXMgY2FsbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBsaXN0ZW4gb24uCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudCwgYXJncy4uLil9IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRvbjogZnVuY3Rpb24obmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZAogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzIGNhbmNlbHMgaXQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRlbWl0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbXB0eSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7c3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTAsIGxlbmd0aD1uYW1lZExpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgICAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbW1pdGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTAsIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8IChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyICRyb290U2NvcGUgPSBuZXcgU2NvcGUoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJHJvb3RTY29wZS4kJHBoYXNlICsgJyBhbHJlYWR5IGluIHByb2dyZXNzJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICAgICAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7fQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kc25pZmZlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzaGNoYW5nZSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudCA/CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogICAgICovCiAgICBmdW5jdGlvbiAkU25pZmZlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpIHsKICAgICAgICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgICAgICAgICAgYW5kcm9pZCA9IGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpKSwKICAgICAgICAgICAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAoISR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8ICR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNyksCiAgICAgICAgICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJRTkgaW1wbGVtZW50cyAnaW5wdXQnIGV2ZW50IGl0J3Mgc28gZnViYXJlZCB0aGF0IHdlIHJhdGhlciBwcmV0ZW5kIHRoYXQgaXQgZG9lc24ndCBoYXZlCiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIEluIHBhcnRpY3VsYXIgdGhlIGV2ZW50IGlzIG5vdCBmaXJlZCB3aGVuIGJhY2tzcGFjZSBvciBkZWxldGUga2V5IGFyZSBwcmVzc2VkIG9yCiAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBjdXQgb3BlcmF0aW9uIGlzIHBlcmZvcm1lZC4KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQgPT0gJ2lucHV0JyAmJiBtc2llID09IDkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50U3VwcG9ydFtldmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXZFbG0gPSAkd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudFN1cHBvcnRbZXZlbnRdID0gJ29uJyArIGV2ZW50IGluIGRpdkVsbTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IGN1cnJlbnRseSB0aGVyZSBpcyBubyB3YXkgdG8gZmVhdHVyZSBkZXRlY3QgQ1NQIHdpdGhvdXQgdHJpZ2dlcmluZyBhbGVydHMKICAgICAgICAgICAgICAgIGNzcDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogICAgICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogICAgICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAgICAgKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAgICAgKgogICAgICogRXhwcmVzc2lvbnMsIGxpa2UgdGhlIG9uZSBkZWZpbmVkIGZvciB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZSBpbiB0aGUgZXhhbXBsZQogICAgICogYmVsb3csIGFyZSBldmFsdWF0ZWQgd2l0aCByZXNwZWN0IHRvIHRoZSBjdXJyZW50IHNjb3BlLiAgVGhlcmVmb3JlLCB0aGVyZSBpcwogICAgICogbm8gcmlzayBvZiBpbmFkdmVydGVudGx5IGNvZGluZyBpbiBhIGRlcGVuZGVuY3kgb24gYSBnbG9iYWwgdmFsdWUgaW4gc3VjaCBhbgogICAgICogZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkd2luZG93KSB7CiAgICAgICAgICAgJHNjb3BlLiR3aW5kb3cgPSAkd2luZG93OwogICAgICAgICAgICRzY29wZS5ncmVldGluZyA9ICdIZWxsbywgV29ybGQhJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJncmVldGluZyIgLz4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkd2luZG93LmFsZXJ0KGdyZWV0aW5nKSI+QUxFUlQ8L2J1dHRvbj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGRpc3BsYXkgdGhlIGdyZWV0aW5nIGluIHRoZSBpbnB1dCBib3gnLCBmdW5jdGlvbigpIHsKICAgICAgIGlucHV0KCdncmVldGluZycpLmVudGVyKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAvLyBJZiB3ZSBjbGljayB0aGUgYnV0dG9uIGl0IHdpbGwgYmxvY2sgdGhlIHRlc3QgcnVubmVyCiAgICAgICAvLyBlbGVtZW50KCc6YnV0dG9uJykuY2xpY2soKTsKICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gJFdpbmRvd1Byb3ZpZGVyKCl7CiAgICAgICAgdGhpcy4kZ2V0ID0gdmFsdWVGbih3aW5kb3cpOwogICAgfQoKICAgIC8qKgogICAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICAgIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogICAgICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICAgICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAgICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAgICAgKgogICAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICAgKiBAc2VlIHBhcnNlSGVhZGVycwogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAgICAgKgogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICAgKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAoIWhlYWRlcnNPYmopIGhlYWRlcnNPYmogPSAgcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9ufEFycmF5LjxmdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogICAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGRhdGEgPSBmbihkYXRhLCBoZWFkZXJzKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMpIHsKICAgICAgICByZXR1cm4gMjAwIDw9IHN0YXR1cyAmJiBzdGF0dXMgPCAzMDA7CiAgICB9CgoKICAgIGZ1bmN0aW9uICRIdHRwUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIEpTT05fU1RBUlQgPSAvXlxzKihcW3xce1teXHtdKS8sCiAgICAgICAgICAgIEpTT05fRU5EID0gL1tcfVxdXVxzKiQvLAogICAgICAgICAgICBQUk9URUNUSU9OX1BSRUZJWCA9IC9eXClcXVx9Jyw/XG4vOwoKICAgICAgICB2YXIgJGNvbmZpZyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIC8vIHRyYW5zZm9ybSBpbmNvbWluZyByZXNwb25zZSBkYXRhCiAgICAgICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBbZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShQUk9URUNUSU9OX1BSRUZJWCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24oZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBjb21tb246IHsKICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicsCiAgICAgICAgICAgICAgICAgICAgJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J30sCiAgICAgICAgICAgICAgICBwdXQ6ICB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMgPSB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGh0dHBCYWNrZW5kJywgJyRicm93c2VyJywgJyRjYWNoZUZhY3RvcnknLCAnJHJvb3RTY29wZScsICckcScsICckaW5qZWN0b3InLAogICAgICAgICAgICBmdW5jdGlvbigkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyksCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uKGludGVyY2VwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgaXNTdHJpbmcoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3IpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaHR0cEJhY2tlbmQKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnkKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHEKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBjb3JlIEFuZ3VsYXIgc2VydmljZSB0aGF0IGZhY2lsaXRhdGVzIGNvbW11bmljYXRpb24gd2l0aCB0aGUgcmVtb3RlCiAgICAgICAgICAgICAgICAgKiBIVFRQIHNlcnZlcnMgdmlhIHRoZSBicm93c2VyJ3Mge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3htbGh0dHByZXF1ZXN0CiAgICAgKiBYTUxIdHRwUmVxdWVzdH0gb2JqZWN0IG9yIHZpYSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIHVuaXQgdGVzdGluZyBhcHBsaWNhdGlvbnMgdGhhdCB1c2UgYCRodHRwYCBzZXJ2aWNlLCBzZWUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kICRodHRwQmFja2VuZCBtb2NrfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgYSBoaWdoZXIgbGV2ZWwgb2YgYWJzdHJhY3Rpb24sIHBsZWFzZSBjaGVjayBvdXQgdGhlIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZQogICAgICogJHJlc291cmNlfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSAkaHR0cCBBUEkgaXMgYmFzZWQgb24gdGhlIHtAbGluayBuZy4kcSBkZWZlcnJlZC9wcm9taXNlIEFQSXN9IGV4cG9zZWQgYnkKICAgICAgICAgICAgICAgICAqIHRoZSAkcSBzZXJ2aWNlLiBXaGlsZSBmb3Igc2ltcGxlIHVzYWdlIHBhdHRlcm5zIHRoaXMgZG9lc24ndCBtYXR0ZXIgbXVjaCwgZm9yIGFkdmFuY2VkIHVzYWdlCiAgICAgICAgICAgICAgICAgKiBpdCBpcyBpbXBvcnRhbnQgdG8gZmFtaWxpYXJpemUgeW91cnNlbGYgd2l0aCB0aGVzZSBBUElzIGFuZCB0aGUgZ3VhcmFudGVlcyB0aGV5IHByb3ZpZGUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgR2VuZXJhbCB1c2FnZQogICAgICAgICAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIGEgc2luZ2xlIGFyZ3VtZW50IOKAlCBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0IOKAlAogICAgICAgICAgICAgICAgICogdGhhdCBpcyB1c2VkIHRvIGdlbmVyYXRlIGFuIEhUVFAgcmVxdWVzdCBhbmQgcmV0dXJucyAgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAgICAgICAgICAgICAqIHdpdGggdHdvICRodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAkaHR0cCh7bWV0aG9kOiAnR0VUJywgdXJsOiAnL3NvbWVVcmwnfSkuCiAgICAgICAgICAgICAgICAgKiAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gdGhpcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICogICAgICAgLy8gd2hlbiB0aGUgcmVzcG9uc2UgaXMgYXZhaWxhYmxlCiAgICAgKiAgICAgfSkuCiAgICAgICAgICAgICAgICAgKiAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIGNhbGxlZCBhc3luY2hyb25vdXNseSBpZiBhbiBlcnJvciBvY2N1cnMKICAgICAqICAgICAgIC8vIG9yIHNlcnZlciByZXR1cm5zIHJlc3BvbnNlIHdpdGggYW4gZXJyb3Igc3RhdHVzLgogICAgICogICAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2luY2UgdGhlIHJldHVybmVkIHZhbHVlIG9mIGNhbGxpbmcgdGhlICRodHRwIGZ1bmN0aW9uIGlzIGEgYHByb21pc2VgLCB5b3UgY2FuIGFsc28gdXNlCiAgICAgICAgICAgICAgICAgKiB0aGUgYHRoZW5gIG1ldGhvZCB0byByZWdpc3RlciBjYWxsYmFja3MsIGFuZCB0aGVzZSBjYWxsYmFja3Mgd2lsbCByZWNlaXZlIGEgc2luZ2xlIGFyZ3VtZW50IOKAkwogICAgICAgICAgICAgICAgICogYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVzcG9uc2UuIFNlZSB0aGUgQVBJIHNpZ25hdHVyZSBhbmQgdHlwZSBpbmZvIGJlbG93IGZvciBtb3JlCiAgICAgICAgICAgICAgICAgKiBkZXRhaWxzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEgcmVzcG9uc2Ugc3RhdHVzIGNvZGUgYmV0d2VlbiAyMDAgYW5kIDI5OSBpcyBjb25zaWRlcmVkIGEgc3VjY2VzcyBzdGF0dXMgYW5kCiAgICAgICAgICAgICAgICAgKiB3aWxsIHJlc3VsdCBpbiB0aGUgc3VjY2VzcyBjYWxsYmFjayBiZWluZyBjYWxsZWQuIE5vdGUgdGhhdCBpZiB0aGUgcmVzcG9uc2UgaXMgYSByZWRpcmVjdCwKICAgICAgICAgICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0IHdpbGwgdHJhbnNwYXJlbnRseSBmb2xsb3cgaXQsIG1lYW5pbmcgdGhhdCB0aGUgZXJyb3IgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgICAgICAgICAgICAgICAqIGNhbGxlZCBmb3Igc3VjaCByZXNwb25zZXMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTaG9ydGN1dCBtZXRob2RzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2luY2UgYWxsIGludm9jYXRpb25zIG9mIHRoZSAkaHR0cCBzZXJ2aWNlIHJlcXVpcmUgcGFzc2luZyBpbiBhbiBIVFRQIG1ldGhvZCBhbmQgVVJMLCBhbmQKICAgICAgICAgICAgICAgICAqIFBPU1QvUFVUIHJlcXVlc3RzIHJlcXVpcmUgcmVxdWVzdCBkYXRhIHRvIGJlIHByb3ZpZGVkIGFzIHdlbGwsIHNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgICAgICAgICAqIHdlcmUgY3JlYXRlZDoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAkaHR0cC5nZXQoJy9zb21lVXJsJykuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICogICAkaHR0cC5wb3N0KCcvc29tZVVybCcsIGRhdGEpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIENvbXBsZXRlIGxpc3Qgb2Ygc2hvcnRjdXQgbWV0aG9kczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNnZXQgJGh0dHAuZ2V0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjaGVhZCAkaHR0cC5oZWFkfQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcG9zdCAkaHR0cC5wb3N0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcHV0ICRodHRwLnB1dH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2RlbGV0ZSAkaHR0cC5kZWxldGV9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNqc29ucCAkaHR0cC5qc29ucH0KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZXR0aW5nIEhUVFAgSGVhZGVycwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSAkaHR0cCBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgY2VydGFpbiBIVFRQIGhlYWRlcnMgdG8gYWxsIHJlcXVlc3RzLiBUaGVzZSBkZWZhdWx0cwogICAgICAgICAgICAgICAgICogY2FuIGJlIGZ1bGx5IGNvbmZpZ3VyZWQgYnkgYWNjZXNzaW5nIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzYCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgKiBvYmplY3QsIHdoaWNoIGN1cnJlbnRseSBjb250YWlucyB0aGlzIGRlZmF1bHQgY29uZmlndXJhdGlvbjoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uYCAoaGVhZGVycyB0aGF0IGFyZSBjb21tb24gZm9yIGFsbCByZXF1ZXN0cyk6CiAgICAgICAgICAgICAgICAgKiAgIC0gYEFjY2VwdDogYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKiAvICpgCiAgICAgICAgICAgICAgICAgKiAgIC0gYFgtUmVxdWVzdGVkLVdpdGg6IFhNTEh0dHBSZXF1ZXN0YAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnBvc3RgOiAoaGVhZGVyIGRlZmF1bHRzIGZvciBQT1NUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucHV0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBQVVQgcmVxdWVzdHMpCiAgICAgICAgICAgICAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbHkgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhlc2UgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICogb2JqZWN0cy4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCBvciBQVVQsIHNpbXBseSBhZGQgYSBuZXcgb2JqZWN0CiAgICAgICAgICAgICAgICAgKiB3aXRoIHRoZSBsb3dlcmNhc2VkIEhUVFAgbWV0aG9kIG5hbWUgYXMgdGhlIGtleSwgZS5nLgogICAgICAgICAgICAgICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5nZXRbJ015LUhlYWRlciddPSd2YWx1ZSdgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEFkZGl0aW9uYWxseSwgdGhlIGRlZmF1bHRzIGNhbiBiZSBzZXQgYXQgcnVudGltZSB2aWEgdGhlIGAkaHR0cC5kZWZhdWx0c2Agb2JqZWN0IGluIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgKiBmYXNoaW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQm90aCByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzIGNhbiBiZSB0cmFuc2Zvcm1lZCB1c2luZyB0cmFuc2Zvcm0gZnVuY3Rpb25zLiBCeSBkZWZhdWx0LCBBbmd1bGFyCiAgICAgICAgICAgICAgICAgKiBhcHBsaWVzIHRoZXNlIHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBSZXF1ZXN0IHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIElmIHRoZSBgZGF0YWAgcHJvcGVydHkgb2YgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBvYmplY3QgY29udGFpbnMgYW4gb2JqZWN0LCBzZXJpYWxpemUgaXQgaW50bwogICAgICAgICAgICAgICAgICogICBKU09OIGZvcm1hdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBSZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIC0gSWYgWFNSRiBwcmVmaXggaXMgZGV0ZWN0ZWQsIHN0cmlwIGl0IChzZWUgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMgc2VjdGlvbiBiZWxvdykuCiAgICAgICAgICAgICAgICAgKiAgLSBJZiBKU09OIHJlc3BvbnNlIGlzIGRldGVjdGVkLCBkZXNlcmlhbGl6ZSBpdCB1c2luZyBhIEpTT04gcGFyc2VyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGdsb2JhbGx5IGF1Z21lbnQgb3Igb3ZlcnJpZGUgdGhlIGRlZmF1bHQgdHJhbnNmb3JtcywgbW9kaWZ5IHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0YCBhbmQKICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzLiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBieSBkZWZhdWx0IGFuCiAgICAgICAgICAgICAgICAgKiBhcnJheSBvZiB0cmFuc2Zvcm0gZnVuY3Rpb25zLCB3aGljaCBhbGxvd3MgeW91IHRvIGBwdXNoYCBvciBgdW5zaGlmdGAgYSBuZXcgdHJhbnNmb3JtYXRpb24gZnVuY3Rpb24gaW50byB0aGUKICAgICAgICAgICAgICAgICAqIHRyYW5zZm9ybWF0aW9uIGNoYWluLiBZb3UgY2FuIGFsc28gZGVjaWRlIHRvIGNvbXBsZXRlbHkgb3ZlcnJpZGUgYW55IGRlZmF1bHQgdHJhbnNmb3JtYXRpb25zIGJ5IGFzc2lnbmluZyB5b3VyCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbnMgdG8gdGhlc2UgcHJvcGVydGllcyBkaXJlY3RseSB3aXRob3V0IHRoZSBhcnJheSB3cmFwcGVyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbWlsYXJseSwgdG8gbG9jYWxseSBvdmVycmlkZSB0aGUgcmVxdWVzdC9yZXNwb25zZSB0cmFuc2Zvcm1zLCBhdWdtZW50IHRoZSBgdHJhbnNmb3JtUmVxdWVzdGAgYW5kL29yCiAgICAgICAgICAgICAgICAgKiBgdHJhbnNmb3JtUmVzcG9uc2VgIHByb3BlcnRpZXMgb2YgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHBhc3NlZCBpbnRvIGAkaHR0cGAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgQ2FjaGluZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGVuYWJsZSBjYWNoaW5nLCBzZXQgdGhlIGNvbmZpZ3VyYXRpb24gcHJvcGVydHkgYGNhY2hlYCB0byBgdHJ1ZWAuIFdoZW4gdGhlIGNhY2hlIGlzCiAgICAgICAgICAgICAgICAgKiBlbmFibGVkLCBgJGh0dHBgIHN0b3JlcyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGluIGxvY2FsIGNhY2hlLiBOZXh0IHRpbWUgdGhlCiAgICAgICAgICAgICAgICAgKiByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSB0aGUgY2FjaGUgd2l0aG91dCBzZW5kaW5nIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCBldmVuIGlmIHRoZSByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSBjYWNoZSwgZGVsaXZlcnkgb2YgdGhlIGRhdGEgaXMgYXN5bmNocm9ub3VzIGluCiAgICAgICAgICAgICAgICAgKiB0aGUgc2FtZSB3YXkgdGhhdCByZWFsIHJlcXVlc3RzIGFyZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgR0VUIHJlcXVlc3RzIGZvciB0aGUgc2FtZSBVUkwgdGhhdCBzaG91bGQgYmUgY2FjaGVkIHVzaW5nIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgKiBjYWNoZSwgYnV0IHRoZSBjYWNoZSBpcyBub3QgcG9wdWxhdGVkIHlldCwgb25seSBvbmUgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdpbGwgYmUgbWFkZSBhbmQKICAgICAgICAgICAgICAgICAqIHRoZSByZW1haW5pbmcgcmVxdWVzdHMgd2lsbCBiZSBmdWxmaWxsZWQgdXNpbmcgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGZpcnN0IHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgUmVzcG9uc2UgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAgICAgICAgICogYXN5bmNocm9ub3VzIHByZXByb2Nlc3Npbmcgb2YgcmVjZWl2ZWQgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUgYWJsZSB0byBpbnRlcmNlcHQKICAgICAgICAgICAgICAgICAqIHJlc3BvbnNlcyBmb3IgaHR0cCByZXF1ZXN0cyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICAgICAgICAgICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAqIHByb21pc2UgYXBpc30gdG8gZnVsZmlsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZXByb2Nlc3NpbmcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSAkaHR0cFByb3ZpZGVyIGJ5CiAgICAgICAgICAgICAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgICAgICAgICAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IgIOKAlCBhIGZ1bmN0aW9uIHRoYXQKICAgICAgICAgICAgICAgICAqIHRha2VzIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IGFuZCByZXR1cm5zIHRoZSBvcmlnaW5hbCBvciBhIG5ldyBwcm9taXNlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciBhcyBhIHNlcnZpY2UKICAgICAgICAgICAgICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlc3BvbnNlKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVzcG9uc2UpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBXaGVuIGRlc2lnbmluZyB3ZWIgYXBwbGljYXRpb25zLCBjb25zaWRlciBzZWN1cml0eSB0aHJlYXRzIGZyb206CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgKiAgIEpTT04gdnVsbmVyYWJpbGl0eX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCb3RoIHNlcnZlciBhbmQgdGhlIGNsaWVudCBtdXN0IGNvb3BlcmF0ZSBpbiBvcmRlciB0byBlbGltaW5hdGUgdGhlc2UgdGhyZWF0cy4gQW5ndWxhciBjb21lcwogICAgICAgICAgICAgICAgICogcHJlLWNvbmZpZ3VyZWQgd2l0aCBzdHJhdGVnaWVzIHRoYXQgYWRkcmVzcyB0aGVzZSBpc3N1ZXMsIGJ1dCBmb3IgdGhpcyB0byB3b3JrIGJhY2tlbmQgc2VydmVyCiAgICAgICAgICAgICAgICAgKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBKU09OIFZ1bG5lcmFiaWxpdHkgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEge0BsaW5rIGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweAogICAgICogSlNPTiB2dWxuZXJhYmlsaXR5fSBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9IHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogICAgICAgICAgICAgICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiApXX0nLAogICAgICAgICAgICAgICAgICogWydvbmUnLCd0d28nXQogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5IFhTUkZ9IGlzIGEgdGVjaG5pcXVlIGJ5IHdoaWNoCiAgICAgICAgICAgICAgICAgKiBhbiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgYSBtZWNoYW5pc20KICAgICAgICAgICAgICAgICAqIHRvIGNvdW50ZXIgWFNSRi4gV2hlbiBwZXJmb3JtaW5nIFhIUiByZXF1ZXN0cywgdGhlICRodHRwIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgYFhTUkYtVE9LRU5gIGFuZCBzZXRzIGl0IGFzIHRoZSBIVFRQIGhlYWRlciBgWC1YU1JGLVRPS0VOYC4gU2luY2Ugb25seSBKYXZhU2NyaXB0IHRoYXQKICAgICAgICAgICAgICAgICAqIHJ1bnMgb24geW91ciBkb21haW4gY291bGQgcmVhZCB0aGUgY29va2llLCB5b3VyIHNlcnZlciBjYW4gYmUgYXNzdXJlZCB0aGF0IHRoZSBYSFIgY2FtZSBmcm9tCiAgICAgICAgICAgICAgICAgKiBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gdGFrZSBhZHZhbnRhZ2Ugb2YgdGhpcywgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gc2V0IGEgdG9rZW4gaW4gYSBKYXZhU2NyaXB0IHJlYWRhYmxlIHNlc3Npb24KICAgICAgICAgICAgICAgICAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIHRoZSBmaXJzdCBIVFRQIEdFVCByZXF1ZXN0LiBPbiBzdWJzZXF1ZW50IFhIUiByZXF1ZXN0cyB0aGUKICAgICAgICAgICAgICAgICAqIHNlcnZlciBjYW4gdmVyaWZ5IHRoYXQgdGhlIGNvb2tpZSBtYXRjaGVzIGBYLVhTUkYtVE9LRU5gIEhUVFAgaGVhZGVyLCBhbmQgdGhlcmVmb3JlIGJlIHN1cmUKICAgICAgICAgICAgICAgICAqIHRoYXQgb25seSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4gY291bGQgaGF2ZSBzZW50IHRoZSByZXF1ZXN0LiBUaGUgdG9rZW4gbXVzdCBiZQogICAgICAgICAgICAgICAgICogdW5pcXVlIGZvciBlYWNoIHVzZXIgYW5kIG11c3QgYmUgdmVyaWZpYWJsZSBieSB0aGUgc2VydmVyICh0byBwcmV2ZW50IHRoZSBKYXZhU2NyaXB0IGZyb20gbWFraW5nCiAgICAgICAgICAgICAgICAgKiB1cCBpdHMgb3duIHRva2VucykuIFdlIHJlY29tbWVuZCB0aGF0IHRoZSB0b2tlbiBpcyBhIGRpZ2VzdCBvZiB5b3VyIHNpdGUncyBhdXRoZW50aWNhdGlvbgogICAgICAgICAgICAgICAgICogY29va2llIHdpdGggYSB7QGxpbmsgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FsdF8oY3J5cHRvZ3JhcGh5KSBzYWx0fSBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIHJlcXVlc3QgdG8gYmUgbWFkZSBhbmQgaG93IGl0IHNob3VsZCBiZQogICAgICAgICAgICAgICAgICogICAgcHJvY2Vzc2VkLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAtICoqbWV0aG9kKiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgbWV0aG9kIChlLmcuICdHRVQnLCAnUE9TVCcsIGV0YykKICAgICAgICAgICAgICAgICAqICAgIC0gKip1cmwqKiDigJMgYHtzdHJpbmd9YCDigJMgQWJzb2x1dGUgb3IgcmVsYXRpdmUgVVJMIG9mIHRoZSByZXNvdXJjZSB0aGF0IGlzIGJlaW5nIHJlcXVlc3RlZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipwYXJhbXMqKiDigJMgYHtPYmplY3QuPHN0cmluZ3xPYmplY3Q+fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIG9iamVjdHMgd2hpY2ggd2lsbCBiZSB0dXJuZWQgdG8KICAgICAgICAgICAgICAgICAqICAgICAgYD9rZXkxPXZhbHVlMSZrZXkyPXZhbHVlMmAgYWZ0ZXIgdGhlIHVybC4gSWYgdGhlIHZhbHVlIGlzIG5vdCBhIHN0cmluZywgaXQgd2lsbCBiZSBKU09OaWZpZWQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgRGF0YSB0byBiZSBzZW50IGFzIHRoZSByZXF1ZXN0IG1lc3NhZ2UgZGF0YS4KICAgICAgICAgICAgICAgICAqICAgIC0gKipoZWFkZXJzKiog4oCTIGB7T2JqZWN0fWAg4oCTIE1hcCBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyBIVFRQIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlcXVlc3QqKiDigJMgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgICAgICAgICAgICAgKiAgICAgIHRyYW5zZm9ybSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdWNoIGZ1bmN0aW9ucy4gVGhlIHRyYW5zZm9ybSBmdW5jdGlvbiB0YWtlcyB0aGUgaHR0cAogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0IGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKmNhY2hlKiog4oCTIGB7Ym9vbGVhbnxDYWNoZX1gIOKAkyBJZiB0cnVlLCBhIGRlZmF1bHQgJGh0dHAgY2FjaGUgd2lsbCBiZSB1c2VkIHRvIGNhY2hlIHRoZQogICAgICAgICAgICAgICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICAgICAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgICAgICAgICAgICAgKiAgICAgIGNhY2hpbmcuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcn1gIOKAkyB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip3aXRoQ3JlZGVudGlhbHMqKiAtIGB7Ym9vbGVhbn1gIC0gd2hldGhlciB0byB0byBzZXQgdGhlIGB3aXRoQ3JlZGVudGlhbHNgIGZsYWcgb24gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vaHR0cF9hY2Nlc3NfY29udHJvbCNzZWN0aW9uXzUKICAgICAqICAgICAgcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgICAgICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAgICAgICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAgICAgICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybSBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibWV0aG9kIj4KICAgICAgICAgICAgICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnR0VUJywgJ2h0dHAtaGVsbG8uaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPlNhbXBsZSBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OUCcsICdodHRwOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPkludmFsaWQgSlNPTlA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBGZXRjaEN0cmwoJHNjb3BlLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKICAgICAgICAgICAgJHNjb3BlLm1ldGhvZCA9ICdHRVQnOwogICAgICAgICAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgICAgICAgICAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkc2NvcGUuY29kZSA9IG51bGw7CiAgICAgICAgICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICAgICAgICAgJGh0dHAoe21ldGhvZDogJHNjb3BlLm1ldGhvZCwgdXJsOiAkc2NvcGUudXJsLCBjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YSB8fCAiUmVxdWVzdCBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZU1vZGVsID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKICAgICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgICAgICRzY29wZS51cmwgPSB1cmw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9Imh0dHAtaGVsbG8uaHRtbCI+CiAgICAgICAgICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgR0VUIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvSGVsbG8sIFwkaHR0cCEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiU2FtcGxlIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvU3VwZXIgSGVybyEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0JlKCdSZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gJGh0dHAoY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcVRyYW5zZm9ybUZuID0gY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICByZXNwVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxSGVhZGVycyA9IGV4dGVuZCh7fSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gZXh0ZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeydYLVhTUkYtVE9LRU4nOiAkYnJvd3Nlci5jb29raWVzKClbJ1hTUkYtVE9LRU4nXX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29uZmlnLmhlYWRlcnMuY29tbW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbmZpZy5oZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0KICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxRGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVyTmFtZSwgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSwgaGVhZGVyTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gdXNpbmcgZm9yLWluIGluc3RlYWQgb2YgZm9yRWFjaCB0byBhdm9pZCB1bmVjZXNzYXJ5IGl0ZXJhdGlvbiBhZnRlciBoZWFkZXIgaGFzIGJlZW4gZm91bmQKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGRlZkhlYWRlck5hbWUgaW4gZGVmSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSA9IGxvd2VyY2FzZShkZWZIZWFkZXJOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihoZWFkZXJOYW1lIGluIGNvbmZpZy5oZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXJOYW1lKSA9PT0gbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXFIZWFkZXJzW2RlZkhlYWRlck5hbWVdID0gZGVmSGVhZGVyc1tkZWZIZWFkZXJOYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb3dlcmNhc2UoaGVhZGVyKSA9PT0gJ2NvbnRlbnQtdHlwZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcmVxSGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihyZXFIZWFkZXJzKSwgcmVxVHJhbnNmb3JtRm4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpOwoKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGZ1dHVyZSByZXNwb25zZQogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9ycywgZnVuY3Rpb24oaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGludGVyY2VwdG9yKHByb21pc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3AgPSBleHRlbmQoe30sIHJlc3BvbnNlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0cmFuc2Zvcm1EYXRhKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLmhlYWRlcnMsIHJlc3BUcmFuc2Zvcm1GbikKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHJlc3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJHEucmVqZWN0KHJlc3ApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMgPSBbXTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2dldAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgR0VUYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlbGV0ZQogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgREVMRVRFYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2hlYWQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEhFQURgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjanNvbnAKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEpTT05QYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICBTaG91bGQgY29udGFpbiBgSlNPTl9DQUxMQkFDS2Agc3RyaW5nLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHMoJ2dldCcsICdkZWxldGUnLCAnaGVhZCcsICdqc29ucCcpOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcG9zdAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUE9TVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNwdXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBVVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YSgncG9zdCcsICdwdXQnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjZGVmYXVsdHMKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBSdW50aW1lIGVxdWl2YWxlbnQgb2YgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzYCBwcm9wZXJ0eS4gQWxsb3dzIGNvbmZpZ3VyYXRpb24gb2YKICAgICAgICAgICAgICAgICAqIGRlZmF1bHQgaGVhZGVycyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTZWUgIlNldHRpbmcgSFRUUCBIZWFkZXJzIiBhbmQgIlRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzIiBzZWN0aW9ucyBhYm92ZS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMgPSAkY29uZmlnOwoKCiAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHA7CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kcyhuYW1lcykgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkaHR0cFtuYW1lXSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogTWFrZXMgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogISEhIEFDQ0VTU0VTIENMT1NVUkUgVkFSUzoKICAgICAgICAgICAgICAgICAqICRodHRwQmFja2VuZCwgJGNvbmZpZywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuY2FjaGUgJiYgY29uZmlnLm1ldGhvZCA9PSAnR0VUJykgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSA9IGlzT2JqZWN0KGNvbmZpZy5jYWNoZSkgPyBjb25maWcuY2FjaGUgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZFJlc3AudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkUmVzcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VydmluZyBmcm9tIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgY29weShjYWNoZWRSZXNwWzJdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHV0IHRoZSBwcm9taXNlIGZvciB0aGUgbm9uLXRyYW5zZm9ybWVkIHJlc3BvbnNlIGludG8gY2FjaGUgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIHdvbid0IGhhdmUgdGhlIHJlc3BvbnNlIGluIGNhY2hlLCBzZW5kIHRoZSByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZChjb25maWcubWV0aG9kLCB1cmwsIHJlcURhdGEsIGRvbmUsIHJlcUhlYWRlcnMsIGNvbmZpZy50aW1lb3V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIENhbGxiYWNrIHJlZ2lzdGVyZWQgdG8gJGh0dHBCYWNrZW5kKCk6CiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FjaGVzIHRoZSByZXNwb25zZSBpZiBkZXNpcmVkCiAgICAgICAgICAgICAgICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FsbHMgJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3VjY2VzcyhzdGF0dXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgcHJvbWlzZSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlLnJlbW92ZSh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gaW5kZXhPZigkaHR0cC5wZW5kaW5nUmVxdWVzdHMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuNi4wIik7IH0gY2F0Y2ggKGUxKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuMy4wIik7IH0gY2F0Y2ggKGUyKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAiKTsgfSBjYXRjaCAoZTMpIHt9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBYTUxIdHRwUmVxdWVzdC4iKTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGh0dHBCYWNrZW5kCiAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVFRQIGJhY2tlbmQgdXNlZCBieSB0aGUge0BsaW5rIG5nLiRodHRwIHNlcnZpY2V9IHRoYXQgZGVsZWdhdGVzIHRvCiAgICAgKiBYTUxIdHRwUmVxdWVzdCBvYmplY3Qgb3IgSlNPTlAgYW5kIGRlYWxzIHdpdGggYnJvd3NlciBpbmNvbXBhdGliaWxpdGllcy4KICAgICAqCiAgICAgKiBZb3Ugc2hvdWxkIG5ldmVyIG5lZWQgdG8gdXNlIHRoaXMgc2VydmljZSBkaXJlY3RseSwgaW5zdGVhZCB1c2UgdGhlIGhpZ2hlci1sZXZlbCBhYnN0cmFjdGlvbnM6CiAgICAgKiB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IG9yIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZSAkcmVzb3VyY2V9LgogICAgICoKICAgICAqIER1cmluZyB0ZXN0aW5nIHRoaXMgaW1wbGVtZW50YXRpb24gaXMgc3dhcHBlZCB3aXRoIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kIG1vY2sKICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRicm93c2VyLCAkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLAogICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLCAkd2luZG93LmxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoJzonLCAnJykpOwogICAgICAgIH1dOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQsIGxvY2F0aW9uUHJvdG9jb2wpIHsKICAgICAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgICAgICByZXR1cm4gZnVuY3Rpb24obWV0aG9kLCB1cmwsIHBvc3QsIGNhbGxiYWNrLCBoZWFkZXJzLCB0aW1lb3V0LCB3aXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICAgICAgJGJyb3dzZXIuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCgpOwogICAgICAgICAgICB1cmwgPSB1cmwgfHwgJGJyb3dzZXIudXJsKCk7CgogICAgICAgICAgICBpZiAobG93ZXJjYXNlKG1ldGhvZCkgPT0gJ2pzb25wJykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrSWQgPSAnXycgKyAoY2FsbGJhY2tzLmNvdW50ZXIrKykudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgMjAwLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2NhbGxiYWNrSWRdOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYSFIoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzOwoKICAgICAgICAgICAgICAgIC8vIEluIElFNiBhbmQgNywgdGhpcyBtaWdodCBiZSBjYWxsZWQgc3luY2hyb25vdXNseSB3aGVuIHhoci5zZW5kIGJlbG93IGlzIGNhbGxlZCBhbmQgdGhlCiAgICAgICAgICAgICAgICAvLyByZXNwb25zZSBpcyBpbiB0aGUgY2FjaGUuIHRoZSBwcm9taXNlIGFwaSB3aWxsIGVuc3VyZSB0aGF0IHRvIHRoZSBhcHAgY29kZSB0aGUgYXBpIGlzCiAgICAgICAgICAgICAgICAvLyBhbHdheXMgYXN5bmMKICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSBvbmNlIEZpcmVmb3ggMjEgZ2V0cyByZWxlYXNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVnaW46IHdvcmthcm91bmQgdG8gb3ZlcmNvbWUgRmlyZWZveCBDT1JTIGh0dHAgcmVzcG9uc2UgaGVhZGVycyBidWcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjA4NzM1CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggYWxyZWFkeSBwYXRjaGVkIGluIG5pZ2h0bHkuIFNob3VsZCBsYW5kIGluIEZpcmVmb3ggMjEuCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDT1JTICJzaW1wbGUgcmVzcG9uc2UgaGVhZGVycyIgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2ltcGxlSGVhZGVycyA9IFsiQ2FjaGUtQ29udHJvbCIsICJDb250ZW50LUxhbmd1YWdlIiwgIkNvbnRlbnQtVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGlyZXMiLCAiTGFzdC1Nb2RpZmllZCIsICJQcmFnbWEiXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzaW1wbGVIZWFkZXJzLCBmdW5jdGlvbiAoaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKGhlYWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyArPSBoZWFkZXIgKyAiOiAiICsgdmFsdWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuZCBvZiB0aGUgd29ya2Fyb3VuZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzIHx8IHhoci5zdGF0dXMsIHhoci5yZXNwb25zZVRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKHdpdGhDcmVkZW50aWFscykgewogICAgICAgICAgICAgICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHhoci5zZW5kKHBvc3QgfHwgJycpOwoKICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyRGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZykgewogICAgICAgICAgICAgICAgLy8gVVJMX01BVENIIGlzIGRlZmluZWQgaW4gc3JjL3NlcnZpY2UvbG9jYXRpb24uanMKICAgICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9ICh1cmwubWF0Y2goVVJMX01BVENIKSB8fCBbJycsIGxvY2F0aW9uUHJvdG9jb2xdKVsxXTsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3RG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSBkb25lKCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsKICAgICAgICAgICAgc2NyaXB0LnNyYyA9IHVybDsKCiAgICAgICAgICAgIGlmIChtc2llKSB7CiAgICAgICAgICAgICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSBkb25lV3JhcHBlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25lcnJvciA9IGRvbmVXcmFwcGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICByYXdEb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvY2FsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogJGxvY2FsZSBzZXJ2aWNlIHByb3ZpZGVzIGxvY2FsaXphdGlvbiBydWxlcyBmb3IgdmFyaW91cyBBbmd1bGFyIGNvbXBvbmVudHMuIEFzIG9mIHJpZ2h0IG5vdyB0aGUKICAgICAqIG9ubHkgcHVibGljIGFwaSBpczoKICAgICAqCiAgICAgKiAqIGBpZGAg4oCTIGB7c3RyaW5nfWAg4oCTIGxvY2FsZSBpZCBmb3JtYXR0ZWQgYXMgYGxhbmd1YWdlSWQtY291bnRyeUlkYCAoZS5nLiBgZW4tdXNgKQogICAgICovCiAgICBmdW5jdGlvbiAkTG9jYWxlUHJvdmlkZXIoKXsKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgICAgICAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICAgICAgICAgICAgICBHUk9VUF9TRVA6ICcsJywKICAgICAgICAgICAgICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgICAgICAgICAgICAgICB7IC8vIERlY2ltYWwgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEZyYWM6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NQcmU6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1ByZTogJy0nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICAgICAgICAgICAgICAgIH0seyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJyknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgREFURVRJTUVfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIE1PTlRIOiAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlRNT05USDogICdKYW4sRmViLE1hcixBcHIsTWF5LEp1bixKdWwsQXVnLFNlcCxPY3QsTm92LERlYycuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBEQVk6ICdTdW5kYXksTW9uZGF5LFR1ZXNkYXksV2VkbmVzZGF5LFRodXJzZGF5LEZyaWRheSxTYXR1cmRheScuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVERBWTogJ1N1bixNb24sVHVlLFdlZCxUaHUsRnJpLFNhdCcuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBBTVBNUzogWydBTScsJ1BNJ10sCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtOiAnTU1NIGQsIHkgaDptbTpzcyBhJywKICAgICAgICAgICAgICAgICAgICBzaG9ydDogJ00vZC95eSBoOm1tIGEnLAogICAgICAgICAgICAgICAgICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBsb25nRGF0ZTogJ01NTU0gZCwgeScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtRGF0ZTogJ01NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgICAgICAgICAgICAgICAgIG1lZGl1bVRpbWU6ICdoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0VGltZTogJ2g6bW0gYScKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbihudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHEsICAgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZHMgPSB7fTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiR0aW1lb3V0CiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldFRpbWVvdXRgLiBUaGUgYGZuYCBmdW5jdGlvbiBpcyB3cmFwcGVkIGludG8gYSB0cnkvY2F0Y2gKICAgICAgICAgICAgICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAgICAgICAgICAgICogdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCBhbmQgdGhlIHRpbWVvdXQgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIHtAbGluayBuZ01vY2suJHRpbWVvdXQgYCR0aW1lb3V0LmZsdXNoKClgfSB0bwogICAgICAgICAgICAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvc2UgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWxheWVkLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gW2ludm9rZUFwcGx5PXRydWVdIElmIHNldCB0byBgZmFsc2VgIHNraXBzIG1vZGVsIGRpcnR5IGNoZWNraW5nLCBvdGhlcndpc2UKICAgICAgICAgICAgICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgICAgICAgICAgICAqICAgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggaXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgYGZuYCBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gdGltZW91dChmbiwgZGVsYXksIGludm9rZUFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXRJZCwgY2xlYW51cDsKCiAgICAgICAgICAgICAgICAgICAgdGltZW91dElkID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZuKCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdGltZW91dElkID0gdGltZW91dElkOwogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkc1t0aW1lb3V0SWRdID0gZGVmZXJyZWQ7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHRpbWVvdXQjY2FuY2VsCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHRpbWVvdXQKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICAgICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgICAgKiAgIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXhlIHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gcmVnaXN0ZXI7CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH1dOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICAgICAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmZpbHRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICAgKiAgIGBhcnJheWAuCiAgICAgKgogICAgICogICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgLSBgc3RyaW5nYDogUHJlZGljYXRlIHRoYXQgcmVzdWx0cyBpbiBhIHN1YnN0cmluZyBtYXRjaCB1c2luZyB0aGUgdmFsdWUgb2YgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgc3RyaW5nLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICAgICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogICAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgICAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogICAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAgICogICAgIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UgZWxlbWVudHMgdGhhdAogICAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDxocj4KICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2giPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCdtJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSk7CgogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0pvaG4nLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBleHByZXNzaW9uKSB7CiAgICAgICAgICAgIGlmICghaXNBcnJheShhcnJheSkpIHJldHVybiBhcnJheTsKICAgICAgICAgICAgdmFyIHByZWRpY2F0ZXMgPSBbXTsKICAgICAgICAgICAgcHJlZGljYXRlcy5jaGVjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24ob2JqLCB0ZXh0KXsKICAgICAgICAgICAgICAgIGlmICh0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoJycgKyBvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXJyYXkiOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHskOmV4cHJlc3Npb259OwogICAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwcmVzc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaCh2YWx1ZSwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGVzLmNoZWNrKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6Y3VycmVuY3kKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRm9ybWF0cyBhIG51bWJlciBhcyBhIGN1cnJlbmN5IChpZSAkMSwyMzQuNTYpLiBXaGVuIG5vIGN1cnJlbmN5IHN5bWJvbCBpcyBwcm92aWRlZCwgZGVmYXVsdAogICAgICogc3ltYm9sIGZvciBjdXJyZW50IGxvY2FsZSBpcyB1c2VkLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgSW5wdXQgdG8gZmlsdGVyLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBzeW1ib2wgQ3VycmVuY3kgc3ltYm9sIG9yIGlkZW50aWZpZXIgdG8gYmUgZGlzcGxheWVkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuZy1tb2RlbD0iYW1vdW50Ij4gPGJyPgogICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKToge3thbW91bnQgfCBjdXJyZW5jeX19PGJyPgogICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdCB3aXRoIDEyMzQuNTYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJ1VTRCQxLDIzNC41NicpOwogICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2Ftb3VudCcpLmVudGVyKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnKCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCcoVVNEJDEsMjM0LjAwKScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYW1vdW50LCBjdXJyZW5jeVN5bWJvbCl7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIGN1cnJlbmN5U3ltYm9sID0gZm9ybWF0cy5DVVJSRU5DWV9TWU07CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROdW1iZXIoYW1vdW50LCBmb3JtYXRzLlBBVFRFUk5TWzFdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwgMikuCiAgICAgICAgICAgICAgICByZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bnVtYmVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICAgICAqCiAgICAgKiBJZiB0aGUgaW5wdXQgaXMgbm90IGEgbnVtYmVyIGFuIGVtcHR5IHN0cmluZyBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IG51bWJlciBOdW1iZXIgdG8gZm9ybWF0LgogICAgICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyk9fSBmcmFjdGlvblNpemUgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBudW1iZXIgdG8uCiAgICAgKiBJZiB0aGlzIGlzIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBmcmFjdGlvbiBzaXplIGlzIGNvbXB1dGVkIGZyb20gdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbnVtYmVyCiAgICAgKiBmb3JtYXR0aW5nIHBhdHRlcm4uIEluIHRoZSBjYXNlIG9mIHRoZSBkZWZhdWx0IGxvY2FsZSwgaXQgd2lsbCBiZSAzLgogICAgICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudmFsID0gMTIzNC41Njc4OTsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmctbW9kZWw9J3ZhbCc+PGJyPgogICAgIERlZmF1bHQgZm9ybWF0dGluZzoge3t2YWwgfCBudW1iZXJ9fTxicj4KICAgICBObyBmcmFjdGlvbnM6IHt7dmFsIHwgbnVtYmVyOjB9fTxicj4KICAgICBOZWdhdGl2ZSBudW1iZXI6IHt7LXZhbCB8IG51bWJlcjo0fX0KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXInKSkudG9CZSgnMSwyMzQuNTY4Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS50b0JlKCcxLDIzNScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMywzNzQnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKCiAgICBudW1iZXJGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gbnVtYmVyRmlsdGVyKCRsb2NhbGUpIHsKICAgICAgICB2YXIgZm9ybWF0cyA9ICRsb2NhbGUuTlVNQkVSX0ZPUk1BVFM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG51bWJlciwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROdW1iZXIobnVtYmVyLCBmb3JtYXRzLlBBVFRFUk5TWzBdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoKHdob2xlLmxlbmd0aCAtIGkpJWxncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICAgICAgICAgIHdoaWxlKGZyYWN0aW9uLmxlbmd0aCA8IGZyYWN0aW9uU2l6ZSkgewogICAgICAgICAgICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAoZnJhY3Rpb25TaXplID4gMCAmJiBudW1iZXIgPiAtMSAmJiBudW1iZXIgPCAxKSB7CiAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgPSBudW1iZXIudG9GaXhlZChmcmFjdGlvblNpemUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgICAgIHZhciBuZWcgPSAnJzsKICAgICAgICBpZiAobnVtIDwgMCkgewogICAgICAgICAgICBuZWcgPSAgJy0nOwogICAgICAgICAgICBudW0gPSAtbnVtOwogICAgICAgIH0KICAgICAgICBudW0gPSAnJyArIG51bTsKICAgICAgICB3aGlsZShudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgICAgICAgaWYgKHRyaW0pCiAgICAgICAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICAgICAgcmV0dXJuIG5lZyArIG51bTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICAgICAgICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMiApIHZhbHVlID0gMTI7CiAgICAgICAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0cykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgICAgICAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHRpbWVab25lR2V0dGVyKGRhdGUpIHsKICAgICAgICB2YXIgem9uZSA9IC0xICogZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgIHZhciBwYWRkZWRab25lID0gKHpvbmUgPj0gMCkgPyAiKyIgOiAiIjsKCiAgICAgICAgcGFkZGVkWm9uZSArPSBwYWROdW1iZXIoTWF0aFt6b25lID4gMCA/ICdmbG9vcicgOiAnY2VpbCddKHpvbmUgLyA2MCksIDIpICsKICAgICAgICAgICAgcGFkTnVtYmVyKE1hdGguYWJzKHpvbmUgJSA2MCksIDIpOwoKICAgICAgICByZXR1cm4gcGFkZGVkWm9uZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhbXBtR2V0dGVyKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgICByZXR1cm4gZGF0ZS5nZXRIb3VycygpIDwgMTIgPyBmb3JtYXRzLkFNUE1TWzBdIDogZm9ybWF0cy5BTVBNU1sxXTsKICAgIH0KCiAgICB2YXIgREFURV9GT1JNQVRTID0gewogICAgICAgIHl5eXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgNCksCiAgICAgICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICAgICAgICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICAgICAgIE1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnLCB0cnVlKSwKICAgICAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgICAgIGRkOiBkYXRlR2V0dGVyKCdEYXRlJywgMiksCiAgICAgICAgZDogZGF0ZUdldHRlcignRGF0ZScsIDEpLAogICAgICAgIEhIOiBkYXRlR2V0dGVyKCdIb3VycycsIDIpLAogICAgICAgIEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMSksCiAgICAgICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICAgICAgbW06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAyKSwKICAgICAgICBtOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMSksCiAgICAgICAgc3M6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAyKSwKICAgICAgICBzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMSksCiAgICAgICAgRUVFRTogZGF0ZVN0ckdldHRlcignRGF5JyksCiAgICAgICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICAgICBhOiBhbXBtR2V0dGVyLAogICAgICAgIFo6IHRpbWVab25lR2V0dGVyCiAgICB9OwoKICAgIHZhciBEQVRFX0ZPUk1BVFNfU1BMSVQgPSAvKCg/OlteeU1kSGhtc2FaRSddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8WikpKC4qKS8sCiAgICAgICAgTlVNQkVSX1NUUklORyA9IC9eXGQrJC87CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAgICAgKgogICAgICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAgICAgKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogICAgICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICAgICAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICAgICAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogICAgICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICAgICAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICAgICAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICAgICAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogICAgICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogICAgICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICAgICAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogICAgICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICAgICAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gYW0vcG0sIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogICAgICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogICAgICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICAgICAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICAgICAqICAgKiBgJ2EnYDogYW0vcG0gbWFya2VyCiAgICAgKiAgICogYCdaJ2A6IDQgZGlnaXQgKCtzaWduKSByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXpvbmUgb2Zmc2V0ICgtMTIwMC0rMTIwMCkKICAgICAqCiAgICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYWxzbyBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZyBwcmVkZWZpbmVkCiAgICAgKiAgIHtAbGluayBndWlkZS9pMThuIGxvY2FsaXphYmxlIGZvcm1hdHN9OgogICAgICoKICAgICAqICAgKiBgJ21lZGl1bSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NIGQsIHkgaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZQogICAgICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogICAgICogICAqIGAnc2hvcnQnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSBoOm1tIGEnYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiA5LzMvMTAgMTI6MDUgcG0pCiAgICAgKiAgICogYCdmdWxsRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnRUVFRSwgTU1NTSBkLHknYCBmb3IgZW5fVVMgIGxvY2FsZQogICAgICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAgICAgKiAgICogYCdsb25nRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTApCiAgICAgKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogICAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgcG0pCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAgICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IHNpbmdsZSBxdW90ZSwgdXNlIHR3byBzaW5nbGUgcXVvdGVzIGluIGEgc2VxdWVuY2UKICAgICAqICAgKGUuZy4gYCJoICdvJydjbG9jayciYCkuCiAgICAgKgogICAgICogQHBhcmFtIHsoRGF0ZXxudW1iZXJ8c3RyaW5nKX0gZGF0ZSBEYXRlIHRvIGZvcm1hdCBlaXRoZXIgYXMgRGF0ZSBvYmplY3QsIG1pbGxpc2Vjb25kcyAoc3RyaW5nIG9yCiAgICAgKiAgICBudW1iZXIpIG9yIHZhcmlvdXMgSVNPIDg2MDEgZGF0ZXRpbWUgc3RyaW5nIGZvcm1hdHMgKGUuZy4geXl5eS1NTS1kZFRISDptbTpzcy5TU1NaIGFuZCBpdHMKICAgICAqICAgIHNob3J0ZXIgdmVyc2lvbnMgbGlrZSB5eXl5LU1NLWRkVEhIOm1tWiwgeXl5eS1NTS1kZCBvciB5eXl5TU1kZFRISG1tc3NaKS4gSWYgbm8gdGltZXpvbmUgaXMKICAgICAqICAgIHNwZWNpZmllZCBpbiB0aGUgc3RyaW5nIGlucHV0LCB0aGUgdGltZSBpcyBjb25zaWRlcmVkIHRvIGJlIGluIHRoZSBsb2NhbCB0aW1lem9uZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAgICAgKiAgICBgbWVkaXVtRGF0ZWAgaXMgdXNlZC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBzdHJpbmcgb3IgdGhlIGlucHV0IGlmIGlucHV0IGlzIG5vdCByZWNvZ25pemVkIGFzIGRhdGUvbWlsbGlzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+OgogICAgIHt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTxicj4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnI+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAge3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08YnI+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goL09jdCAyXGQsIDIwMTAgXGR7MSwyfTpcZHsyfTpcZHsyfSAoQU18UE0pLyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJyIpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCInMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnIikpLgogICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KEFNfFBNKS8pOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gZGF0ZUZpbHRlcigkbG9jYWxlKSB7CgoKICAgICAgICB2YXIgUl9JU084NjAxX1NUUiA9IC9eKFxkezR9KS0/KFxkXGQpLT8oXGRcZCkoPzpUKFxkXGQpKD86Oj8oXGRcZCkoPzo6PyhcZFxkKSg/OlwuKFxkKykpPyk/KT8oWnwoWystXSkoXGRcZCk6PyhcZFxkKSk/KT8kLzsKICAgICAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZyl7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdHpNaW4gID0gMDsKICAgICAgICAgICAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcihpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0hvdXJzKGludChtYXRjaFs0XXx8MCkgLSB0ekhvdXIsIGludChtYXRjaFs1XXx8MCkgLSB0ek1pbiwgaW50KG1hdGNoWzZdfHwwKSwgaW50KG1hdGNoWzddfHwwKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KCgogICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICAgICAgICAgICAgdmFyIHRleHQgPSAnJywKICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICBmbiwgbWF0Y2g7CgogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJ21lZGl1bURhdGUnOwogICAgICAgICAgICBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICAgICAgICAgICAgaWYgKE5VTUJFUl9TVFJJTkcudGVzdChkYXRlKSkgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBpbnQoZGF0ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBqc29uU3RyaW5nVG9EYXRlKGRhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFpc0RhdGUoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgICAgICAgICAgICB0ZXh0ICs9IGZuID8gZm4oZGF0ZSwgJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTKQogICAgICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpqc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogICAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGU6CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24ganNvbkZpbHRlcigpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICovCiAgICB2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjp1cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICovCiAgICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bGltaXRUbwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBhcyBzcGVjaWZpZWQgYnkgdGhlCiAgICAgKiB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkuIElmIHRoZSBgbGltaXRgIG51bWJlciBpcwogICAgICogICAgIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUKICAgICAqICAgICBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN1Yi1hcnJheSBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5IGhhZCBsZXNzIHRoYW4gYGxpbWl0YAogICAgICogICAgIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxpbWl0ID0gMzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGltaXQiPgogICAgIDxwPk91dHB1dDoge3sgbnVtYmVycyB8IGxpbWl0VG86bGltaXQgfX08L3A+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCl7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBsaW1pdCkgewogICAgICAgICAgICBpZiAoIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CiAgICAgICAgICAgIHZhciBvdXQgPSBbXSwKICAgICAgICAgICAgICAgIGksIG47CgogICAgICAgICAgICAvLyBjaGVjayB0aGF0IGFycmF5IGlzIGl0ZXJhYmxlCiAgICAgICAgICAgIGlmICghYXJyYXkgfHwgIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkKICAgICAgICAgICAgICAgIHJldHVybiBvdXQ7CgogICAgICAgICAgICAvLyBpZiBhYnMobGltaXQpIGV4Y2VlZHMgbWF4aW11bSBsZW5ndGgsIHRyaW0gaXQKICAgICAgICAgICAgaWYgKGxpbWl0ID4gYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICAgIGVsc2UgaWYgKGxpbWl0IDwgLWFycmF5Lmxlbmd0aCkKICAgICAgICAgICAgICAgIGxpbWl0ID0gLWFycmF5Lmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgbiA9IGxpbWl0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaSA9IGFycmF5Lmxlbmd0aCArIGxpbWl0OwogICAgICAgICAgICAgICAgbiA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgICAgICAgICAgICBvdXQucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6b3JkZXJCeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBPcmRlcnMgYSBzcGVjaWZpZWQgYGFycmF5YCBieSB0aGUgYGV4cHJlc3Npb25gIHByZWRpY2F0ZS4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0b24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNvcnQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCopfHN0cmluZ3xBcnJheS48KGZ1bmN0aW9uKCopfHN0cmluZyk+fSBleHByZXNzaW9uIEEgcHJlZGljYXRlIHRvIGJlCiAgICAgKiAgICB1c2VkIGJ5IHRoZSBjb21wYXJhdG9yIHRvIGRldGVybWluZSB0aGUgb3JkZXIgb2YgZWxlbWVudHMuCiAgICAgKgogICAgICogICAgQ2FuIGJlIG9uZSBvZjoKICAgICAqCiAgICAgKiAgICAtIGBmdW5jdGlvbmA6IEdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogICAgICogICAgICBgPGAsIGA9YCwgYD5gIG9wZXJhdG9yLgogICAgICogICAgLSBgc3RyaW5nYDogQW4gQW5ndWxhciBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBvYmplY3QgdG8gb3JkZXIgYnksIHN1Y2ggYXMgJ25hbWUnCiAgICAgKiAgICAgIHRvIHNvcnQgYnkgYSBwcm9wZXJ0eSBjYWxsZWQgJ25hbWUnLiBPcHRpb25hbGx5IHByZWZpeGVkIHdpdGggYCtgIG9yIGAtYCB0byBjb250cm9sCiAgICAgKiAgICAgIGFzY2VuZGluZyBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGZvciBleGFtcGxlLCArbmFtZSBvciAtbmFtZSkuCiAgICAgKiAgICAtIGBBcnJheWA6IEFuIGFycmF5IG9mIGZ1bmN0aW9uIG9yIHN0cmluZyBwcmVkaWNhdGVzLiBUaGUgZmlyc3QgcHJlZGljYXRlIGluIHRoZSBhcnJheQogICAgICogICAgICBpcyB1c2VkIGZvciBzb3J0aW5nLCBidXQgd2hlbiB0d28gaXRlbXMgYXJlIGVxdWl2YWxlbnQsIHRoZSBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJldmVyc2UgUmV2ZXJzZSB0aGUgb3JkZXIgdGhlIGFycmF5LgogICAgICogQHJldHVybnMge0FycmF5fSBTb3J0ZWQgY29weSBvZiB0aGUgc291cmNlIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuZnJpZW5kcyA9CiAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWFyeScsIHBob25lOic1NTUtOTg3NicsIGFnZToxOX0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMScsIGFnZToyMX0sCiAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnLCBhZ2U6Mjl9XQogICAgICAgICAgICRzY29wZS5wcmVkaWNhdGUgPSAnLWFnZSc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgICA8aHIvPgogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgICA8dHI+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAoPGEgaHJlZiBuZy1jbGljaz0icHJlZGljYXRlID0gJy1uYW1lJzsgcmV2ZXJzZT1mYWxzZSI+XjwvYT4pPC90aD4KICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ3Bob25lJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+UGhvbmUgTnVtYmVyPC9hPjwvdGg+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgICA8L3RyPgogICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgb3JkZXJCeTpwcmVkaWNhdGU6cmV2ZXJzZSI+CiAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgYmUgcmV2ZXJzZSBvcmRlcmVkIGJ5IGFnZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ByZWRpY2F0ZScpKS50b0JlKCctYWdlJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgIHRvRXF1YWwoWyczNScsICcyOScsICcyMScsICcxOScsICcxMCddKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0p1bGllJywgJ01pa2UnLCAnTWFyeScsICdKb2huJ10pOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJOYW1lIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0FkYW0nLCAnSm9obicsICdKdWxpZScsICdNYXJ5JywgJ01pa2UnXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgIHRvRXF1YWwoWyczNScsICcxMCcsICcyOScsICcxOScsICcyMSddKTsKCiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMoIlBob25lIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLnBob25lJykpLgogICAgICAgICAgIHRvRXF1YWwoWyc1NTUtOTg3NicsICc1NTUtODc2NScsICc1NTUtNTY3OCcsICc1NTUtNDMyMScsICc1NTUtMTIxMiddKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ0p1bGllJywgJ0FkYW0nLCAnTWlrZScsICdKb2huJ10pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKICAgIGZ1bmN0aW9uIG9yZGVyQnlGaWx0ZXIoJHBhcnNlKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGU6IFtzb3J0UHJlZGljYXRlXTsKICAgICAgICAgICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICAgICAgICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLGdldChiKSk7CiAgICAgICAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgYXJyYXlDb3B5LnB1c2goYXJyYXlbaV0pOyB9CiAgICAgICAgICAgIHJldHVybiBhcnJheUNvcHkuc29ydChyZXZlcnNlQ29tcGFyYXRvcihjb21wYXJhdG9yLCByZXZlcnNlT3JkZXIpKTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBhcmF0b3IobzEsIG8yKXsKICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvcnRQcmVkaWNhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tcCA9IHNvcnRQcmVkaWNhdGVbaV0obzEsIG8yKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcCAhPT0gMCkgcmV0dXJuIGNvbXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXZlcnNlQ29tcGFyYXRvcihjb21wLCBkZXNjZW5kaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbihhLGIpe3JldHVybiBjb21wKGIsYSk7fQogICAgICAgICAgICAgICAgICAgIDogY29tcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgICAgICAgICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgICAgICAgICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgICAgICAgICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgICAgIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6YQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICAgICAqIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICAgICAqCiAgICAgKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICAgICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Im1vZGVsLiRzYXZlKCkiPlNhdmU8L2E+YAogICAgICovCiAgICB2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAgICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgICAgICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgICAgICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgICAgICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoJ2hyZWYnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIcmVmCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogICAgICogdGhlIHBhZ2Ugb3BlbiB0byBhIHdyb25nIFVSTCwgaWYgdGhlIHVzZXIgY2xpY2tzIHRoYXQgbGluayBiZWZvcmUKICAgICAqIGFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIHt7aGFzaH19IHdpdGggYWN0dWFsIFVSTCwgdGhlCiAgICAgKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICAgICAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgQQogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVGhpcyBleGFtcGxlIHVzZXMgYGxpbmtgIHZhcmlhYmxlIGluc2lkZSBgaHJlZmAgYXR0cmlidXRlOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0xJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTEnKS5hdHRyKCdocmVmJykpLnRvQmUoIiIpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMicpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0yJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0zJykuYXR0cignaHJlZicpKS50b0JlKCIvMTIzIik7CgogICAgICAgICAgZWxlbWVudCgnI2xpbmstMycpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoYnJvd3NlcigpLndpbmRvdygpLnBhdGgoKSkudG9FcXVhbCgnLzEyMycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nLWhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgnNicpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLnVybCgpKS50b0VxdWFsKCcvNicpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NyYwogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IElNRwogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEaXNhYmxlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAgICAgKiA8cHJlPgogICAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICAgKiA8L2Rpdj4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBkaXNhYmxlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nRGlzYWJsZWRgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hlY2tlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBjaGVja2VkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdtYXN0ZXInKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNdWx0aXBsZQogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nTXVsdGlwbGVgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICA8c2VsZWN0IGlkPSJzZWxlY3QiIG5nLW11bHRpcGxlPSJjaGVja2VkIj4KICAgICA8b3B0aW9uPk1pc2tvPC9vcHRpb24+CiAgICAgPG9wdGlvbj5JZ29yPC9vcHRpb24+CiAgICAgPG9wdGlvbj5Wb2p0YTwvb3B0aW9uPgogICAgIDxvcHRpb24+RGk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBtdWx0aXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IFNFTEVDVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ011bHRpcGxlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUmVhZG9ubHkKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NlbGVjdGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHNlbGVjdGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlZCB0aGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgICAgPHNlbGVjdD4KICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnc2VsZWN0ZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IE9QVElPTgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24ocHJvcE5hbWUsIGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbm9ybWFsaXplZF0sIGZ1bmN0aW9uIG5nQm9vbGVhbkF0dHJXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCAhIXZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgoKLy8gbmctc3JjLCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKICAgIGZvckVhY2goWydzcmMnLCAnaHJlZiddLCBmdW5jdGlvbihhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUobm9ybWFsaXplZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGNhbGxpbmcgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdmb28nKSBkb2Vzbid0IGRvIGFueXRoaW5nLCBzbyB3ZSBuZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHNldCB0aGUgcHJvcGVydHkgYXMgd2VsbCB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIGVmZmVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtc2llKSBlbGVtZW50LnByb3AoYXR0ck5hbWUsIGF0dHJbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgogICAgdmFyIG51bGxGb3JtQ3RybCA9IHsKICAgICAgICAkYWRkQ29udHJvbDogbm9vcCwKICAgICAgICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAgICAgICAkc2V0VmFsaWRpdHk6IG5vb3AsCiAgICAgICAgJHNldERpcnR5OiBub29wCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICAgKiAgZm9ybXMsIHdoZXJlOgogICAgICoKICAgICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcykg4oCUIHN1Y2ggYXMgYHJlcXVpcmVkYCwgYHVybGAgb3IgYGVtYWlsYCksCiAgICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIHdpdGggZ2l2ZW4gZXJyb3IuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHN0YXRlIG9mIHRoZW0sCiAgICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICAgKgogICAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICAgKgogICAgICovCi8vYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICBGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJ107CiAgICBmdW5jdGlvbiBGb3JtQ29udHJvbGxlcihlbGVtZW50LCBhdHRycykgewogICAgICAgIHZhciBmb3JtID0gdGhpcywKICAgICAgICAgICAgcGFyZW50Rm9ybSA9IGVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICAgICAgICBlcnJvcnMgPSBmb3JtLiRlcnJvciA9IHt9OwoKICAgICAgICAvLyBpbml0IHN0YXRlCiAgICAgICAgZm9ybS4kbmFtZSA9IGF0dHJzLm5hbWUgfHwgYXR0cnMubmdGb3JtOwogICAgICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CgogICAgICAgIHBhcmVudEZvcm0uJGFkZENvbnRyb2woZm9ybSk7CgogICAgICAgIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAgICAgICBlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKCiAgICAgICAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKICAgICAgICAgICAgZWxlbWVudC4KICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSkuCiAgICAgICAgICAgICAgICBhZGRDbGFzcygoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmICFmb3JtLmhhc093blByb3BlcnR5KGNvbnRyb2wuJG5hbWUpKSB7CiAgICAgICAgICAgICAgICBmb3JtW2NvbnRyb2wuJG5hbWVdID0gY29udHJvbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRyZW1vdmVDb250cm9sCiAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBEZXJlZ2lzdGVyIGEgY29udHJvbCBmcm9tIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgZGVzdHJveWVkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHJlbW92ZUNvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbihxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgICAgICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0VmFsaWRpdHkKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMgdGhlIHZhbGlkaXR5IG9mIGEgZm9ybSBjb250cm9sLgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0RGlydHkKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMgdGhlIGZvcm0gdG8gYSBkaXJ0eSBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gYWRkIHRoZSAnbmctZGlydHknIGNsYXNzIGFuZCBzZXQgdGhlIGZvcm0gdG8gYSBkaXJ0eQogICAgICAgICAqIHN0YXRlIChuZy1kaXJ0eSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHNldERpcnR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH07CgogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0KICAgICAqIEByZXN0cmljdCBFQUMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogICAgICogZG9lcyBub3QgYWxsb3cgbmVzdGluZyBvZiBmb3JtIGVsZW1lbnRzLiBJdCBpcyB1c2VmdWwgdG8gbmVzdCBmb3JtcywgZm9yIGV4YW1wbGUgaWYgdGhlIHZhbGlkaXR5IG9mIGEKICAgICAqIHN1Yi1ncm91cCBvZiBjb250cm9scyBuZWVkcyB0byBiZSBkZXRlcm1pbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZXxuZ0Zvcm0gTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgICAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAgICAgKgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERpcmVjdGl2ZSB0aGF0IGluc3RhbnRpYXRlcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgICAqCiAgICAgKiBJZiBgbmFtZWAgYXR0cmlidXRlIGlzIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciBpcyBwdWJsaXNoZWQgb250byB0aGUgY3VycmVudCBzY29wZSB1bmRlcgogICAgICogdGhpcyBuYW1lLgogICAgICoKICAgICAqICMgQWxpYXM6IHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfQogICAgICoKICAgICAqIEluIGFuZ3VsYXIgZm9ybXMgY2FuIGJlIG5lc3RlZC4gVGhpcyBtZWFucyB0aGF0IHRoZSBvdXRlciBmb3JtIGlzIHZhbGlkIHdoZW4gYWxsIG9mIHRoZSBjaGlsZAogICAgICogZm9ybXMgYXJlIHZhbGlkIGFzIHdlbGwuIEhvd2V2ZXIgYnJvd3NlcnMgZG8gbm90IGFsbG93IG5lc3Rpbmcgb2YgYDxmb3JtPmAgZWxlbWVudHMsIGZvciB0aGlzCiAgICAgKiByZWFzb24gYW5ndWxhciBwcm92aWRlcyB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gYWxpYXMKICAgICAqIHdoaWNoIGJlaGF2ZXMgaWRlbnRpY2FsIHRvIGA8Zm9ybT5gIGJ1dCBhbGxvd3MgZm9ybSBuZXN0aW5nLgogICAgICoKICAgICAqCiAgICAgKiAjIENTUyBjbGFzc2VzCiAgICAgKiAgLSBgbmctdmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyB2YWxpZC4KICAgICAqICAtIGBuZy1pbnZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgICAqICAtIGBuZy1wcmlzdGluZWAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHByaXN0aW5lLgogICAgICogIC0gYG5nLWRpcnR5YCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgZGlydHkuCiAgICAgKgogICAgICoKICAgICAqICMgU3VibWl0dGluZyBhIGZvcm0gYW5kIHByZXZlbnRpbmcgZGVmYXVsdCBhY3Rpb24KICAgICAqCiAgICAgKiBTaW5jZSB0aGUgcm9sZSBvZiBmb3JtcyBpbiBjbGllbnQtc2lkZSBBbmd1bGFyIGFwcGxpY2F0aW9ucyBpcyBkaWZmZXJlbnQgdGhhbiBpbiBjbGFzc2ljYWwKICAgICAqIHJvdW5kdHJpcCBhcHBzLCBpdCBpcyBkZXNpcmFibGUgZm9yIHRoZSBicm93c2VyIG5vdCB0byB0cmFuc2xhdGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbnRvIGEgZnVsbAogICAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICAgKiB0byBoYW5kbGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbiBhcHBsaWNhdGlvbiBzcGVjaWZpYyB3YXkuCiAgICAgKgogICAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgICAqIGA8Zm9ybT5gIGVsZW1lbnQgaGFzIGFuIGBhY3Rpb25gIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAgICogYSBmb3JtIGlzIHN1Ym1pdHRlZDoKICAgICAqCiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmUgb24gdGhlIGZpcnN0CiAgICAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAgICAgKgogICAgICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgbmdTdWJtaXQgb3IgbmdDbGljayBkaXJlY3RpdmVzLiBUaGlzCiAgICAgKiBpcyBiZWNhdXNlIG9mIHRoZSBmb2xsb3dpbmcgZm9ybSBzdWJtaXNzaW9uIHJ1bGVzIGNvbWluZyBmcm9tIHRoZSBodG1sIHNwZWM6CiAgICAgKgogICAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICAgKiAoYG5nU3VibWl0YCkKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBoYXMgMisgaW5wdXQgZmllbGRzIGFuZCBubyBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuIGhpdHRpbmcgZW50ZXIKICAgICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBvbmUgb3IgbW9yZSBpbnB1dCBmaWVsZHMgYW5kIG9uZSBvciBtb3JlIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4KICAgICAqIGhpdHRpbmcgZW50ZXIgaW4gYW55IG9mIHRoZSBpbnB1dCBmaWVsZHMgd2lsbCB0cmlnZ2VyIHRoZSBjbGljayBoYW5kbGVyIG9uIHRoZSAqZmlyc3QqIGJ1dHRvbiBvcgogICAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnVzZXJUeXBlID0gJ2d1ZXN0JzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgPHR0PnVzZXJUeXBlID0ge3t1c2VyVHlwZX19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPC9mb3JtPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3VzZXJUeXBlJykuZW50ZXIoJycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGZvcm1EaXJlY3RpdmVGYWN0b3J5ID0gZnVuY3Rpb24oaXNOZ0Zvcm0pIHsKICAgICAgICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgICAgICAgICAgIHZhciBmb3JtRGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvLyBJRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1bnJlZ2lzdGVyIHRoZSBwcmV2ZW50RGVmYXVsdCBsaXN0ZW5lciBzbyB0aGF0IHdlIGRvbid0IG5vdCBsZWFrIG1lbW9yeSBidXQgaW4gYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdheSB0aGF0IHdpbGwgYWNoaWV2ZSB0aGUgcHJldmVudGlvbiBvZiB0aGUgZGVmYXVsdCBhY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbYWxpYXNdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVyLCBudWxsRm9ybUN0cmwpOyAvL3N0b3AgcHJvcGFnYXRpbmcgY2hpbGQgZGVzdHJ1Y3Rpb24gaGFuZGxlcnMgdXB3YXJkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBpc05nRm9ybSA/IGV4dGVuZChjb3B5KGZvcm1EaXJlY3RpdmUpLCB7cmVzdHJpY3Q6ICdFQUMnfSkgOiBmb3JtRGlyZWN0aXZlOwogICAgICAgIH1dOwogICAgfTsKCiAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KCk7CiAgICB2YXIgbmdGb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkodHJ1ZSk7CgogICAgdmFyIFVSTF9SRUdFWFAgPSAvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvOwogICAgdmFyIEVNQUlMX1JFR0VYUCA9IC9eW0EtWmEtejAtOS5fJSstXStAW0EtWmEtejAtOS4tXStcLltBLVphLXpdezIsNn0kLzsKICAgIHZhciBOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKICAgIHZhciBpbnB1dFR5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU3RhbmRhcmQgSFRNTCB0ZXh0IGlucHV0IHdpdGggYW5ndWxhciBkYXRhIGJpbmRpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlx3KiQvOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFNpbmdsZSB3b3JkOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IgogICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgIFNpbmdsZSB3b3JkIG9ubHkhPC9zcGFuPgoKICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ2d1ZXN0Jyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG11bHRpIHdvcmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignaGVsbG8gd29ybGQnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAgICAgICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZSA9IDEyOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIE51bWJlcjogPGlucHV0IHR5cGU9Im51bWJlciIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgbWluPSIwIiBtYXg9Ijk5IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IubnVtYmVyIj4KICAgICAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWV9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJzEyJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcxMjMnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnbnVtYmVyJzogbnVtYmVySW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC51cmwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgICAgICAgKiB2YWxpZCBVUkwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaHR0cDovL2dvb2dsZS5jb20nOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnaHR0cDovL2dvb2dsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndXJsJzogdXJsSW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5lbWFpbAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgICAgICAgKiBhZGRyZXNzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQucmFkaW8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvcn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbG9yJykpLnRvRXF1YWwoJ2JsdWUnKTsKCiAgICAgICAgICAgIGlucHV0KCdjb2xvcicpLnNlbGVjdCgncmVkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdZRVMnKTsKCiAgICAgICAgICAgIGlucHV0KCd2YWx1ZTEnKS5jaGVjaygpOwogICAgICAgICAgICBpbnB1dCgndmFsdWUyJykuY2hlY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgICAgICdoaWRkZW4nOiBub29wLAogICAgICAgICdidXR0b24nOiBub29wLAogICAgICAgICdzdWJtaXQnOiBub29wLAogICAgICAgICdyZXNldCc6IG5vb3AKICAgIH07CgoKICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdHJpbShlbGVtZW50LnZhbCgpKTsKCiAgICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAgICAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnaW5wdXQnLCBsaXN0ZW5lcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRpbWVvdXQ7CgogICAgICAgICAgICB2YXIgZGVmZXJMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYmluZCgna2V5ZG93bicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgICAgICAgICAgICAvLyBpZ25vcmUKICAgICAgICAgICAgICAgIC8vICAgIGNvbW1hbmQgICAgICAgICAgICBtb2RpZmllcnMgICAgICAgICAgICAgICAgICAgYXJyb3dzCiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGRlZmVyTGlzdGVuZXIoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2UsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogICAgICAgICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ3Bhc3RlIGN1dCcsIGRlZmVyTGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQudmFsKGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgICAgIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3I7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IHJlZ2V4cC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3BhdHRlcm4nLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmIChwYXR0ZXJuKSB7CiAgICAgICAgICAgIGlmIChwYXR0ZXJuLm1hdGNoKC9eXC8oLiopXC8kLykpIHsKICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBuZXcgUmVnRXhwKHBhdHRlcm4uc3Vic3RyKDEsIHBhdHRlcm4ubGVuZ3RoIC0gMikpOwogICAgICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm4sIHZhbHVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGF0dGVybk9iaiB8fCAhcGF0dGVybk9iai50ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdHRlcm4gKyAnIHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgJyArIHBhdHRlcm5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPCBtaW5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW5sZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtYXggbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWF4bGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtYXhsZW5ndGggPSBpbnQoYXR0ci5uZ01heGxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPiBtYXhsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4bGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGlzRW1wdHkodmFsdWUpOwogICAgICAgICAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNFbXB0eSh2YWx1ZSkgPyAnJyA6ICcnICsgdmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChhdHRyLm1pbikgewogICAgICAgICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgICAgICAgIHZhciBtaW5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA8IG1pbikgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW4nLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChhdHRyLm1heCkgewogICAgICAgICAgICB2YXIgbWF4ID0gcGFyc2VGbG9hdChhdHRyLm1heCk7CiAgICAgICAgICAgIHZhciBtYXhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgVVJMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbWFpbElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgdmFyIGVtYWlsVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRbMF0uY2hlY2tlZCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlVmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgICAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAgICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS51c2VyTmFtZS4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgICAgbmctbWlubGVuZ3RoPSIzIiBuZy1tYXhsZW5ndGg9IjEwIj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5tYXhsZW5ndGgiPgogICAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgICAgPC9mb3JtPgogICAgIDxocj4KICAgICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiRlcnJvciA9IHt7bXlGb3JtLnVzZXJOYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5tYXhsZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5tYXhsZW5ndGh9fTwvdHQ+PGJyPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eSB3aGVuIHJlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5uYW1lJykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSB2YWxpZCBpZiBlbXB0eSB3aGVuIG1pbiBsZW5ndGggaXMgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoiIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3h4Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWlubGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpCiAgICAgICAgICAgIC50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWF4bGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBpbnB1dERpcmVjdGl2ZSA9IFsnJGJyb3dzZXInLCAnJHNuaWZmZXInLCBmdW5jdGlvbigkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICAoaW5wdXRUeXBlW2xvd2VyY2FzZShhdHRyLnR5cGUpXSB8fCBpbnB1dFR5cGUudGV4dCkoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLAogICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgdmFyIFZBTElEX0NMQVNTID0gJ25nLXZhbGlkJywKICAgICAgICBJTlZBTElEX0NMQVNTID0gJ25nLWludmFsaWQnLAogICAgICAgIFBSSVNUSU5FX0NMQVNTID0gJ25nLXByaXN0aW5lJywKICAgICAgICBESVJUWV9DTEFTUyA9ICduZy1kaXJ0eSc7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAkdmlld1ZhbHVlIEFjdHVhbCBzdHJpbmcgdmFsdWUgaW4gdGhlIHZpZXcuCiAgICAgKiBAcHJvcGVydHkgeyp9ICRtb2RlbFZhbHVlIFRoZSB2YWx1ZSBpbiB0aGUgbW9kZWwsIHRoYXQgdGhlIGNvbnRyb2wgaXMgYm91bmQgdG8uCiAgICAgKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICRwYXJzZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLCBhcyBhIHBpcGVsaW5lLCB3aGVuZXZlcgogICAgIHRoZSBjb250cm9sIHJlYWRzIHZhbHVlIGZyb20gdGhlIERPTS4gIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZQogICAgIHRocm91Z2ggdG8gdGhlIG5leHQuIFVzZWQgdG8gc2FuaXRpemUgLyBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRpb24uCgogICAgIEZvciB2YWxpZGF0aW9uLCB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJGZvcm1hdHRlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgICAgKiAgICAgdGhlIG1vZGVsIHZhbHVlIGNoYW5nZXMuIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZSB0aHJvdWdoIHRvIHRoZQogICAgICogICAgIG5leHQuIFVzZWQgdG8gZm9ybWF0IC8gY29udmVydCB2YWx1ZXMgZm9yIGRpc3BsYXkgaW4gdGhlIGNvbnRyb2wgYW5kIHZhbGlkYXRpb24uCiAgICAgKiAgICAgIDxwcmU+CiAgICAgKiAgICAgIGZ1bmN0aW9uIGZvcm1hdHRlcih2YWx1ZSkgewogKiAgICAgICAgaWYgKHZhbHVlKSB7CiAqICAgICAgICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogKiAgICAgICAgfQogKiAgICAgIH0KICAgICAqICAgICAgbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICAgKiAgICAgIDwvcHJlPgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBiamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbCB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgZXJyb3Igb24gdGhlIGNvbnRyb2wuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGUsIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICAgKiBzcGVjaWZpY2FsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAgICogRE9NIGV2ZW50cy4gVGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgaXMgbWVhbnQgdG8gYmUgZXh0ZW5kZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGVyZSwgdGhlCiAgICAgKiBkaXJlY3RpdmUgcHJvdmlkZXMgRE9NIG1hbmlwdWxhdGlvbiBhbmQgdGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgdGhlIGRhdGEtYmluZGluZy4KICAgICAqIE5vdGUgdGhhdCB5b3UgY2Fubm90IHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIGluIGEgZGlyZWN0aXZlIHdpdGggYW4gaXNvbGF0ZWQgc2NvcGUsCiAgICAgKiBhcywgaW4gdGhhdCBjYXNlLCB0aGUgYG5nLW1vZGVsYCB2YWx1ZSBnZXRzIHB1dCBpbnRvIHRoZSBpc29sYXRlZCBzY29wZSBhbmQgZG9lcyBub3QgZ2V0CiAgICAgKiBwcm9wb2dhdGVkIHRvIHRoZSBwYXJlbnQgc2NvcGUuCiAgICAgKgogICAgICoKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gdXNlIGBOZ01vZGVsQ29udHJvbGxlcmAgd2l0aCBhIGN1c3RvbSBjb250cm9sIHRvIGFjaGlldmUKICAgICAqIGRhdGEtYmluZGluZy4gTm90aWNlIGhvdyBkaWZmZXJlbnQgZGlyZWN0aXZlcyAoYGNvbnRlbnRlZGl0YWJsZWAsIGBuZy1tb2RlbGAsIGFuZCBgcmVxdWlyZWRgKQogICAgICogY29sbGFib3JhdGUgdG9nZXRoZXIgdG8gYWNoaWV2ZSB0aGUgZGVzaXJlZCByZXN1bHQuCiAgICAgKgogICAgICogPGV4YW1wbGUgbW9kdWxlPSJjdXN0b21Db250cm9sIj4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICB9CgogICAgIC5uZy1pbnZhbGlkIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZWQ7CiAgICAgIH0KCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbXSkuCiAgICAgZGlyZWN0aXZlKCdjb250ZW50ZWRpdGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywgLy8gZ2V0IGEgaG9sZCBvZiBOZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHsKICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCgogICAgICAgICAgICAgIC8vIFNwZWNpZnkgaG93IFVJIHNob3VsZCBiZSB1cGRhdGVkCiAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwobmdNb2RlbC4kdmlld1ZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIGNoYW5nZSBldmVudHMgdG8gZW5hYmxlIGJpbmRpbmcKICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkocmVhZCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCgogICAgICAgICAgICAgIC8vIFdyaXRlIGRhdGEgdG8gdGhlIG1vZGVsCiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgIHZhciBodG1sID0gZWxlbWVudC5odG1sKCk7CiAgICAgICAgICAgICAgICAvLyBXaGVuIHdlIGNsZWFyIHRoZSBjb250ZW50IGVkaXRhYmxlIHRoZSBicm93c2VyIGxlYXZlcyBhIDxicj4gYmVoaW5kCiAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgaWYoIGF0dHJzLnN0cmlwQnIgJiYgaHRtbCA9PSAnPGJyPicgKSB7CiAgICAgICAgICAgICAgICAgIGh0bWwgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5nTW9kZWwuJHNldFZpZXdWYWx1ZShodG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgIHN0cmlwLWJyPSJ0cnVlIgogICAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgICAgPGhyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idXNlckNvbnRlbnQiPjwvdGV4dGFyZWE+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNvbnRlbnRFZGl0YWJsZSA9IGVsZW1lbnQoJ1tjb250ZW50ZWRpdGFibGVdJyk7CgogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCdDaGFuZ2UgbWUhJyk7CiAgICAgICAgaW5wdXQoJ3VzZXJDb250ZW50JykuZW50ZXIoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICAqIDwvZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBOZ01vZGVsQ29udHJvbGxlciA9IFsnJHNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRhdHRycycsICckZWxlbWVudCcsICckcGFyc2UnLAogICAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlKSB7CiAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgICAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgICAgICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICAgICAgICAgICAgaWYgKCFuZ01vZGVsU2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgJGF0dHIubmdNb2RlbCArCiAgICAgICAgICAgICAgICAgICAgJyAoJyArIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSArICcpJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgICAgICAkZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSA9PT0gIWlzVmFsaWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSkgaW52YWxpZENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPSAhaXNWYWxpZDsKICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSk7CgogICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkLCB0aGlzKTsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWaWV3VmFsdWUKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZWFkIGEgdmFsdWUgZnJvbSB2aWV3LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGZyb20gd2l0aGluIGEgRE9NIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAqIEZvciBleGFtcGxlIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0gZGlyZWN0aXZlcyBjYWxsIGl0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJdCBpbnRlcm5hbGx5IGNhbGxzIGFsbCBgJHBhcnNlcnNgIChpbmNsdWRpbmcgdmFsaWRhdG9ycykgYW5kIHVwZGF0ZXMgdGhlIGAkbW9kZWxWYWx1ZWAgYW5kIHRoZSBhY3R1YWwgbW9kZWwgcGF0aC4KICAgICAgICAgICAgICogTGFzdGx5IGl0IGNhbGxzIGFsbCByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIGNoYW5nZSB0byBkaXJ0eQogICAgICAgICAgICAgICAgaWYgKHRoaXMuJHByaXN0aW5lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kcGFyc2VycywgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsU2V0KCRzY29wZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gbW9kZWwgLT4gdmFsdWUKICAgICAgICAgICAgdmFyIGN0cmwgPSB0aGlzOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBuZ01vZGVsR2V0KCRzY29wZSk7CgogICAgICAgICAgICAgICAgLy8gaWYgc2NvcGUgbW9kZWwgdmFsdWUgYW5kIG5nTW9kZWwgdmFsdWUgYXJlIG91dCBvZiBzeW5jCiAgICAgICAgICAgICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBpZHggPSBmb3JtYXR0ZXJzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKGlkeC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm9ybWF0dGVyc1tpZHhdKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElzIGEgZGlyZWN0aXZlIHRoYXQgdGVsbHMgQW5ndWxhciB0byBkbyB0d28td2F5IGRhdGEgYmluZGluZy4gSXQgd29ya3MgdG9nZXRoZXIgd2l0aCBgaW5wdXRgLAogICAgICogYHNlbGVjdGAsIGB0ZXh0YXJlYWAuIFlvdSBjYW4gZWFzaWx5IHdyaXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMgdG8gdXNlIGBuZ01vZGVsYCBhcyB3ZWxsLgogICAgICoKICAgICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICAgKgogICAgICogLSBiaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAgICogICByZXF1aXJlLAogICAgICogLSBwcm92aWRpbmcgdmFsaWRhdGlvbiBiZWhhdmlvciAoaS5lLiByZXF1aXJlZCwgbnVtYmVyLCBlbWFpbCwgdXJsKSwKICAgICAqIC0ga2VlcGluZyBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKSwKICAgICAqIC0gc2V0dGluZyByZWxhdGVkIGNzcyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApLAogICAgICogLSByZWdpc3RlciB0aGUgY29udHJvbCB3aXRoIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICAgKgogICAgICogTm90ZTogYG5nTW9kZWxgIHdpbGwgdHJ5IHRvIGJpbmQgdG8gdGhlIHByb3BlcnR5IGdpdmVuIGJ5IGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24gb24gdGhlCiAgICAgKiBjdXJyZW50IHNjb3BlLiBJZiB0aGUgcHJvcGVydHkgZG9lc24ndCBhbHJlYWR5IGV4aXN0IG9uIHRoaXMgc2NvcGUsIGl0IHdpbGwgYmUgY3JlYXRlZAogICAgICogaW1wbGljaXRseSBhbmQgYWRkZWQgdG8gdGhlIHNjb3BlLgogICAgICoKICAgICAqIEZvciBiYXNpYyBleGFtcGxlcywgaG93IHRvIHVzZSBgbmdNb2RlbGAsIHNlZToKICAgICAqCiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQgdGV4dH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5jaGVja2JveCBjaGVja2JveH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5yYWRpbyByYWRpb30KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIgbnVtYmVyfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsIGVtYWlsfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnVybCB1cmx9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnRleHRhcmVhIHRleHRhcmVhfQogICAgICoKICAgICAqLwogICAgdmFyIG5nTW9kZWxEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICAgIC8vIG5vdGlmeSBvdGhlcnMsIGVzcGVjaWFsbHkgcGFyZW50IGZvcm1zCgogICAgICAgICAgICAgICAgdmFyIG1vZGVsQ3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsID0gY3RybHNbMV0gfHwgbnVsbEZvcm1DdHJsOwoKICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRhZGRDb250cm9sKG1vZGVsQ3RybCk7CgogICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoYW5nZQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV2YWx1YXRlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAgICoKICAgICAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxkb2M6ZXhhbXBsZT4KICAgICAqICAgPGRvYzpzb3VyY2U+CiAgICAgKiAgICAgPHNjcmlwdD4KICAgICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAqICAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwOwogKiAgICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAqICAgICAgICAgfTsKICogICAgICAgfQogICAgICogICAgIDwvc2NyaXB0PgogICAgICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIG5nLWNoYW5nZT0iY2hhbmdlKCkiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTEiIC8+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAgICAgKiAgICAgICA8bGFiZWwgZm9yPSJuZy1jaGFuZ2UtZXhhbXBsZTIiPkNvbmZpcm1lZDwvbGFiZWw+PGJyIC8+CiAgICAgKiAgICAgICBkZWJ1ZyA9IHt7Y29uZmlybWVkfX08YnIgLz4KICAgICAqICAgICAgIGNvdW50ZXIgPSB7e2NvdW50ZXJ9fQogICAgICogICAgIDwvZGl2PgogICAgICogICA8L2RvYzpzb3VyY2U+CiAgICAgKiAgIDxkb2M6c2NlbmFyaW8+CiAgICAgKiAgICAgaXQoJ3Nob3VsZCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIHZpZXcnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMCcpOwogKiAgICAgICBlbGVtZW50KCcjbmctY2hhbmdlLWV4YW1wbGUxJykuY2xpY2soKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMScpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICogICAgIH0pOwogICAgICoKICAgICAqICAgICBpdCgnc2hvdWxkIG5vdCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTInKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKiAgIDwvZG9jOnNjZW5hcmlvPgogICAgICogPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIubmdDaGFuZ2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCgogICAgdmFyIHJlcXVpcmVkRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIucmVxdWlyZWQgJiYgKGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlID09PSBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy51bnNoaWZ0KHZhbGlkYXRvcik7CgogICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3IoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTGlzdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGV4dCBpbnB1dCB0aGF0IGNvbnZlcnRzIGJldHdlZW4gY29tbWEtc2VwYXJhdGVkIHN0cmluZyBpbnRvIGFuIGFycmF5IG9mIHN0cmluZ3MuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdMaXN0IG9wdGlvbmFsIGRlbGltaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNwbGl0IHRoZSB2YWx1ZS4gSWYKICAgICAqICAgc3BlY2lmaWVkIGluIGZvcm0gYC9zb21ldGhpbmcvYCB0aGVuIHRoZSB2YWx1ZSB3aWxsIGJlIGNvbnZlcnRlZCBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWlza28nLCAndm9qdGEnXTsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgIDxicj4KICAgICA8dHQ+bmFtZXMgPSB7e25hbWVzfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiRlcnJvciA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1siaWdvciIsIm1pc2tvIiwidm9qdGEiXScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnc3Bhbi5lcnJvcicpLmNzcygnZGlzcGxheScpKS50b0JlKCdub25lJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ25hbWVzJykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnc3Bhbi5lcnJvcicpLmNzcygnZGlzcGxheScpKS5ub3QoKS50b0JlKCdub25lJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nTGlzdERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgICAgICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaXN0ID0gW107CgogICAgICAgICAgICAgICAgICAgIGlmICh2aWV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2aWV3VmFsdWUuc3BsaXQoc2VwYXJhdG9yKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CgogICAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbih0cGwsIHRwbEF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nVmFsdWUsIGZ1bmN0aW9uIHZhbHVlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICAgICAqIHdpdGggdGhlIHZhbHVlIG9mIGEgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIHVwZGF0ZSB0aGUgdGV4dCBjb250ZW50IHdoZW4gdGhlIHZhbHVlIG9mIHRoYXQKICAgICAqIGV4cHJlc3Npb24gY2hhbmdlcy4KICAgICAqCiAgICAgKiBUeXBpY2FsbHksIHlvdSBkb24ndCB1c2UgYG5nQmluZGAgZGlyZWN0bHksIGJ1dCBpbnN0ZWFkIHlvdSB1c2UgdGhlIGRvdWJsZSBjdXJseSBtYXJrdXAgbGlrZQogICAgICogYHt7IGV4cHJlc3Npb24gfX1gIHdoaWNoIGlzIHNpbWlsYXIgYnV0IGxlc3MgdmVyYm9zZS4KICAgICAqCiAgICAgKiBJdCBpcyBwcmVmZXJyYWJsZSB0byB1c2UgYG5nQmluZGAgaW5zdGVhZCBvZiBge3sgZXhwcmVzc2lvbiB9fWAgd2hlbiBhIHRlbXBsYXRlIGlzIG1vbWVudGFyaWx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4KICAgICAqIGVsZW1lbnQgYXR0cmlidXRlLCBpdCBtYWtlcyB0aGUgYmluZGluZ3MgaW52aXNpYmxlIHRvIHRoZSB1c2VyIHdoaWxlIHRoZSBwYWdlIGlzIGxvYWRpbmcuCiAgICAgKgogICAgICogQW4gYWx0ZXJuYXRpdmUgc29sdXRpb24gdG8gdGhpcyBwcm9ibGVtIHdvdWxkIGJlIHVzaW5nIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9IGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXaGlybGVkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnbmFtZScpLmVudGVyKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCd3b3JsZCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZFRlbXBsYXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICAgICAqIHRleHQgY29udGVudCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgaW50ZXJwb2xhdGlvbiBvZiB0aGUgdGVtcGxhdGUKICAgICAqIGluIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGF0dHJpYnV0ZS4KICAgICAqIFVubGlrZSBgbmdCaW5kYCwgdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAgICAgKiBleHByZXNzaW9ucy4gVGhpcyBkaXJlY3RpdmUgaXMgbmVlZGVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogICAgICogKHN1Y2ggYXMgVElUTEUgYW5kIE9QVElPTikgY2Fubm90IGNvbnRhaW4gU1BBTiBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0JpbmRUZW1wbGF0ZSB0ZW1wbGF0ZSBvZiBmb3JtCiAgICAgKiAgIDx0dD57ezwvdHQ+IDx0dD5leHByZXNzaW9uPC90dD4gPHR0Pn19PC90dD4gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuc2FsdXRhdGlvbiA9ICdIZWxsbyc7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV29ybGQnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBTYWx1dGF0aW9uOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InNhbHV0YXRpb24iPjxicj4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgIHRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLgogICAgICAgICAgIHRvQmUoJ1dvcmxkJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdzYWx1dGF0aW9uJykuZW50ZXIoJ0dyZWV0aW5ncycpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnbmFtZScpLmVudGVyKCd1c2VyJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgIHRvQmUoJ0dyZWV0aW5ncycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS4KICAgICAgICAgICB0b0JlKCd1c2VyJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnRleHQodmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbFVuc2FmZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIGJpbmRpbmcgdGhhdCB3aWxsIGlubmVySFRNTCB0aGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGBleHByZXNzaW9uYCBpbnRvIHRoZSBjdXJyZW50CiAgICAgKiBlbGVtZW50LiAqVGhlIGlubmVySFRNTC1lZCBjb250ZW50IHdpbGwgbm90IGJlIHNhbml0aXplZCEqIFlvdSBzaG91bGQgdXNlIHRoaXMgZGlyZWN0aXZlIG9ubHkgaWYKICAgICAqIHtAbGluayBuZ1Nhbml0aXplLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IGRpcmVjdGl2ZSBpcyB0b28KICAgICAqIHJlc3RyaWN0aXZlIGFuZCB3aGVuIHlvdSBhYnNvbHV0ZWx5IHRydXN0IHRoZSBzb3VyY2Ugb2YgdGhlIGNvbnRlbnQgeW91IGFyZSBiaW5kaW5nIHRvLgogICAgICoKICAgICAqIFNlZSB7QGxpbmsgbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBkb2NzIGZvciBleGFtcGxlcy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kSHRtbFVuc2FmZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgICAqLwogICAgdmFyIG5nQmluZEh0bWxVbnNhZmVEaXJlY3RpdmUgPSBbZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbFVuc2FmZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWxVbnNhZmUsIGZ1bmN0aW9uIG5nQmluZEh0bWxVbnNhZmVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBvbGRWYWwgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltuYW1lXSwgbmdDbGFzc1dhdGNoQWN0aW9uLCB0cnVlKTsKCiAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ2NsYXNzJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBuZ0NsYXNzID0gc2NvcGUuJGV2YWwoYXR0cltuYW1lXSk7CiAgICAgICAgICAgICAgICBuZ0NsYXNzV2F0Y2hBY3Rpb24obmdDbGFzcywgbmdDbGFzcyk7CiAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24oJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kICE9PSBvbGQkaW5kZXggJiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsb2xkVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhuZXdWYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkVmFsID0gY29weShuZXdWYWwpOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChjbGFzc1ZhbCkgJiYgIWlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgY2xhc3NWYWwgPSBtYXAoY2xhc3NWYWwsIGZ1bmN0aW9uKHYsIGspIHsgaWYgKHYpIHJldHVybiBrIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhpc0FycmF5KGNsYXNzVmFsKSA/IGNsYXNzVmFsLmpvaW4oJyAnKSA6IGNsYXNzVmFsKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZENsYXNzKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoY2xhc3NWYWwpICYmICFpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzVmFsID0gbWFwKGNsYXNzVmFsLCBmdW5jdGlvbih2LCBrKSB7IGlmICh2KSByZXR1cm4gayB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoaXNBcnJheShjbGFzc1ZhbCkgPyBjbGFzc1ZhbC5qb2luKCcgJykgOiBjbGFzc1ZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NgIGFsbG93cyB5b3UgdG8gc2V0IENTUyBjbGFzc2VzIG9uIEhUTUwgYW4gZWxlbWVudCwgZHluYW1pY2FsbHksIGJ5IGRhdGFiaW5kaW5nCiAgICAgKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICAgICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4gSW4gdGhlIGNhc2Ugb2YgYSBtYXAsIHRoZQogICAgICogICBuYW1lcyBvZiB0aGUgcHJvcGVydGllcyB3aG9zZSB2YWx1ZXMgYXJlIHRydXRoeSB3aWxsIGJlIGFkZGVkIGFzIGNzcyBjbGFzc2VzIHRvIHRoZQogICAgICogICBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15VmFyPSdteS1jbGFzcyciPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgICA8YnI+CiAgICAgPHNwYW4gbmctY2xhc3M9Im15VmFyIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAubXktY2xhc3MgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpmaXJzdCcpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpsYXN0JykuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLm5vdCgpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc0RpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCcnLCB0cnVlKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzT2RkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NPZGQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogICAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgIHt7bmFtZX19CiAgICAgPC9zcGFuPgogICAgIDwvbGk+CiAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NPZGREaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnT2RkJywgMCk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzc0V2ZW4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IGl0IHdvcmtzIGluCiAgICAgKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2VzIGFmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICAgICAqCiAgICAgKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiBhIHNjb3BlIG9mIGFuCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc0V2ZW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlCiAgICAgKiAgIHJlc3VsdCBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgPC9zcGFuPgogICAgIDwvbGk+CiAgICAgPC9vbD4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NFdmVuRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ0V2ZW4nLCAxKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHByZXZlbnQgdGhlIEFuZ3VsYXIgaHRtbCB0ZW1wbGF0ZSBmcm9tIGJlaW5nIGJyaWVmbHkKICAgICAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3ICh1bmNvbXBpbGVkKSBmb3JtIHdoaWxlIHlvdXIgYXBwbGljYXRpb24gaXMgbG9hZGluZy4gVXNlIHRoaXMKICAgICAqIGRpcmVjdGl2ZSB0byBhdm9pZCB0aGUgdW5kZXNpcmFibGUgZmxpY2tlciBlZmZlY3QgY2F1c2VkIGJ5IHRoZSBodG1sIHRlbXBsYXRlIGRpc3BsYXkuCiAgICAgKgogICAgICogVGhlIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgYDxib2R5PmAgZWxlbWVudCwgYnV0IHR5cGljYWxseSBhIGZpbmUtZ3JhaW5lZCBhcHBsaWNhdGlvbiBpcwogICAgICogcHJlZmVyZWQgaW4gb3JkZXIgdG8gYmVuZWZpdCBmcm9tIHByb2dyZXNzaXZlIHJlbmRlcmluZyBvZiB0aGUgYnJvd3NlciB2aWV3LgogICAgICoKICAgICAqIGBuZ0Nsb2FrYCB3b3JrcyBpbiBjb29wZXJhdGlvbiB3aXRoIGEgY3NzIHJ1bGUgdGhhdCBpcyBlbWJlZGRlZCB3aXRoaW4gYGFuZ3VsYXIuanNgIGFuZAogICAgICogIGBhbmd1bGFyLm1pbi5qc2AgZmlsZXMuIEZvbGxvd2luZyBpcyB0aGUgY3NzIHJ1bGU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIFtuZ1w6Y2xvYWtdLCBbbmctY2xvYWtdLCBbZGF0YS1uZy1jbG9ha10sIFt4LW5nLWNsb2FrXSwgLm5nLWNsb2FrLCAueC1uZy1jbG9hayB7CiAqICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogKiB9CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBXaGVuIHRoaXMgY3NzIHJ1bGUgaXMgbG9hZGVkIGJ5IHRoZSBicm93c2VyLCBhbGwgaHRtbCBlbGVtZW50cyAoaW5jbHVkaW5nIHRoZWlyIGNoaWxkcmVuKSB0aGF0CiAgICAgKiBhcmUgdGFnZ2VkIHdpdGggdGhlIGBuZy1jbG9ha2AgZGlyZWN0aXZlIGFyZSBoaWRkZW4uIFdoZW4gQW5ndWxhciBjb21lcyBhY3Jvc3MgdGhpcyBkaXJlY3RpdmUKICAgICAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgd2hpY2gKICAgICAqIG1ha2VzIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAgICAgKgogICAgICogRm9yIHRoZSBiZXN0IHJlc3VsdCwgYGFuZ3VsYXIuanNgIHNjcmlwdCBtdXN0IGJlIGxvYWRlZCBpbiB0aGUgaGVhZCBzZWN0aW9uIG9mIHRoZSBodG1sIGZpbGU7CiAgICAgKiBhbHRlcm5hdGl2ZWx5LCB0aGUgY3NzIHJ1bGUgKGFib3ZlKSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogICAgICogYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICAgICAqIGNhbm5vdCBtYXRjaCB0aGUgYFtuZ1w6Y2xvYWtdYCBzZWxlY3Rvci4gVG8gd29yayBhcm91bmQgdGhpcyBsaW1pdGF0aW9uLCB5b3UgbXVzdCBhZGQgdGhlIGNzcwogICAgICogY2xhc3MgYG5nQ2xvYWtgIGluIGFkZGl0aW9uIHRvIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUxIiBuZy1jbG9haz57eyAnaGVsbG8nIH19PC9kaXY+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIHRlbXBsYXRlIGRpcmVjdGl2ZSBhbmQgY3NzIGNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjdGVtcGxhdGUxJykuYXR0cignbmctY2xvYWsnKSkuCiAgICAgICAgICAgbm90KCkudG9CZURlZmluZWQoKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTInKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ0Nsb2FrRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAgICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAgICAgKgogICAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgICAqCiAgICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgZGF0YSBpbiBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICAgKiAqIENvbnRyb2xsZXIg4oCUIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogICAgICogICBtZXRob2RzIHRoYXQgdHlwaWNhbGx5IGV4cHJlc3MgdGhlIGJ1c2luZXNzIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICAgICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSAkc2NvcGUgYnkgdGhlIGNvbnRyb2xsZXIgKHNlZSBzb3VyY2UgdGFiKS4gVGhlc2UgbWV0aG9kcyBjYW4KICAgICAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIE5vdGljZSB0aGF0IGFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5CiAgICAgKiByZWZsZWN0ZWQgaW4gdGhlIFZpZXcgd2l0aG91dCB0aGUgbmVlZCBmb3IgYSBtYW51YWwgdXBkYXRlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgJHNjb3BlLmNvbnRhY3RzID0gWwogICAgICAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAgICAgICAgICAgIHt0eXBlOidlbWFpbCcsIHZhbHVlOidqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKCiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICB9OwoKICAgICAkc2NvcGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogICAgICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5jbGVhckNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0KSB7CiAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAgICAgICAgICB9OwogICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlciI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICAgQ29udGFjdDoKICAgICA8dWw+CiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICA8L2xpPgogICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICA8L3VsPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgZGl2PjppbnB1dCcpLnZhbCgpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMSkgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMikgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwoKICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBhOmNvbnRhaW5zKCJjbGVhciIpJykuY2xpY2soKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3QgaW5wdXQnKS52YWwoKSkudG9CZSgnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3QgYTpjb250YWlucygiYWRkIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgICBjb250cm9sbGVyOiAnQCcKICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDc3AKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGVsZW1lbnQgaHRtbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICAgKgogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICoKICAgICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBCeSBhcHBseWluZyBgbmdDc3BgCiAgICAgKiBpdCBpcyBiZSBwb3NzaWJsZSB0byBvcHQgaW50byB0aGUgQ1NQIGNvbXBhdGlibGUgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICAgICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICAgKiBiZSByYWlzZWQuCiAgICAgKgogICAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgIDxwcmU+CiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24oJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcmlvcml0eTogMTAwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc25pZmZlci5jc3AgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ0NsaWNrIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbgogICAgICogZWxlbWVudCBpcyBjbGlja2VkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgSW5jcmVtZW50CiAgICAgPC9idXR0b24+CiAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICAvKgogICAgICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAgICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKgogICAgICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICAgICAqLwogICAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgICBmb3JFYWNoKAogICAgICAgICdjbGljayBkYmxjbGljayBtb3VzZWRvd24gbW91c2V1cCBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2Vtb3ZlIG1vdXNlZW50ZXIgbW91c2VsZWF2ZSBzdWJtaXQnLnNwbGl0KCcgJyksCiAgICAgICAgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB2YXIgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIG5hbWUpOwogICAgICAgICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24oJHBhcnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cltkaXJlY3RpdmVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKGxvd2VyY2FzZShuYW1lKSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZXZlbnR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9XTsKICAgICAgICB9CiAgICApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRGJsY2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZGJsY2xpY2sgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogZGJsY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWRvd24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNldXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNldXAgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW92ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VvdmVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VlbnRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VlbnRlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZW50ZXIuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWxlYXZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWxlYXZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VsZWF2ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlbW92ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZW1vdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nS2V5dXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlwcmVzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5cHJlc3MuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSAqKmJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYW4gYGFjdGlvbmAKICAgICAqIGF0dHJpYnV0ZSoqLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2hlbGxvJzsKICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGV4dCkgewogICAgICAgICAgICAgIHRoaXMubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5nLXN1Ym1pdD0ic3VibWl0KCkiIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1siaGVsbG8iXScpOwogICAgICAgICBleHBlY3QoaW5wdXQoJ3RleHQnKS52YWwoKSkudG9CZSgnJyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGlnbm9yZSBlbXB0eSBzdHJpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlCiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICAgICAqCiAgICAgKiBLZWVwIGluIG1pbmQgdGhhdCBTYW1lIE9yaWdpbiBQb2xpY3kgYXBwbGllcyB0byBpbmNsdWRlZCByZXNvdXJjZXMKICAgICAqIChlLmcuIG5nSW5jbHVkZSB3b24ndCB3b3JrIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgb24gYWxsIGJyb3dzZXJzIGFuZCBmb3IKICAgICAqICBmaWxlOi8vIGFjY2VzcyBvbiBzb21lIGJyb3dzZXJzKS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdJbmNsdWRlfHNyYyBhbmd1bGFyIGV4cHJlc3Npb24gZXZhbHVhdGluZyB0byBVUkwuIElmIHRoZSBzb3VyY2UgaXMgYSBzdHJpbmcgY29uc3RhbnQsCiAgICAgKiAgICAgICAgICAgICAgICAgbWFrZSBzdXJlIHlvdSB3cmFwIGl0IGluIHF1b3RlcywgZS5nLiBgc3JjPSInbXlQYXJ0aWFsVGVtcGxhdGUuaHRtbCciYC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF1dG9zY3JvbGwgV2hldGhlciBgbmdJbmNsdWRlYCBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbAogKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAgICoKICAgICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJ0ZW1wbGF0ZSIgbmctb3B0aW9ucz0idC5uYW1lIGZvciB0IGluIHRlbXBsYXRlcyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1pbmNsdWRlIHNyYz0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS50ZW1wbGF0ZXMgPQogICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30KICAgICAgICAgICwgeyBuYW1lOiAndGVtcGxhdGUyLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTIuaHRtbCd9IF07CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlID0gJHNjb3BlLnRlbXBsYXRlc1swXTsKICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTEuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMS5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLWluY2x1ZGVdJykudGV4dCgpKS4KICAgICAgICAgdG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJzEnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICBzZWxlY3QoJ3RlbXBsYXRlJykub3B0aW9uKCcnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdJbmNsdWRlRGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckYW5jaG9yU2Nyb2xsJywgJyRjb21waWxlJywKICAgICAgICBmdW5jdGlvbigkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkYW5jaG9yU2Nyb2xsLCAgICRjb21waWxlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjRXhwID0gYXR0ci5uZ0luY2x1ZGUgfHwgYXR0ci5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICBhdXRvU2Nyb2xsRXhwID0gYXR0ci5hdXRvc2Nyb2xsOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhckNvbnRlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goc3JjRXhwLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgIT09IGNoYW5nZUNvdW50ZXIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSBjaGlsZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwocmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKGNoaWxkU2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhdXRvU2Nyb2xsRXhwKSAmJiAoIWF1dG9TY3JvbGxFeHAgfHwgc2NvcGUuJGV2YWwoYXV0b1Njcm9sbEV4cCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChvbmxvYWRFeHApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0luaXRgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgaW5pdGlhbGl6YXRpb24gdGFza3MgdG8gYmUgZXhlY3V0ZWQKICAgICAqICBiZWZvcmUgdGhlIHRlbXBsYXRlIGVudGVycyBleGVjdXRpb24gbW9kZSBkdXJpbmcgYm9vdHN0cmFwLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0luaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImdyZWV0aW5nPSdIZWxsbyc7IHBlcnNvbj0nV29ybGQnIj4KICAgICB7e2dyZWV0aW5nfX0ge3twZXJzb259fSEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGdyZWV0aW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdncmVldGluZycpKS50b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QoYmluZGluZygncGVyc29uJykpLnRvQmUoJ1dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdJbml0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRycy5uZ0luaXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdOb25CaW5kYWJsZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNvbWV0aW1lcyBpdCBpcyBuZWNlc3NhcnkgdG8gd3JpdGUgY29kZSB3aGljaCBsb29rcyBsaWtlIGJpbmRpbmdzIGJ1dCB3aGljaCBzaG91bGQgYmUgbGVmdCBhbG9uZQogICAgICogYnkgYW5ndWxhci4gVXNlIGBuZ05vbkJpbmRhYmxlYCB0byBtYWtlIGFuZ3VsYXIgaWdub3JlIGEgY2h1bmsgb2YgSFRNTC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogSW4gdGhpcyBleGFtcGxlIHRoZXJlIGFyZSB0d28gbG9jYXRpb24gd2hlcmUgYSBzaW1wbGUgYmluZGluZyAoYHt7fX1gKSBpcyBwcmVzZW50LCBidXQgdGhlIG9uZQogICAgICogd3JhcHBlZCBpbiBgbmdOb25CaW5kYWJsZWAgaXMgbGVmdCBhbG9uZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgPGRpdiBuZy1ub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1ub24tYmluZGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJzEgKyAyJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2RpdjpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoeyB0ZXJtaW5hbDogdHJ1ZSwgcHJpb3JpdHk6IDEwMDAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdQbHVyYWxpemUKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogIyBPdmVydmlldwogICAgICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAgICAgKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogICAgICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAgICAgKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAqIHBsdXJhbCBjYXRlZ29yaWVzfSBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogICAgICoKICAgICAqICMgUGx1cmFsIGNhdGVnb3JpZXMgYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcwogICAgICogVGhlcmUgYXJlIHR3bwogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogKiBwbHVyYWwgY2F0ZWdvcmllc30gaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBXaGlsZSBhIHB1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICAgKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICAgKgogICAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdC4KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICo8L3ByZT4KICAgICAqCiAgICAgKiBJbiB0aGUgZXhhbXBsZSwgYCIwOiBOb2JvZHkgaXMgdmlld2luZy4iYCBpcyBhbiBleHBsaWNpdCBudW1iZXIgcnVsZS4gSWYgeW91IGRpZCBub3QKICAgICAqIHNwZWNpZnkgdGhpcyBydWxlLCAwIHdvdWxkIGJlIG1hdGNoZWQgdG8gdGhlICJvdGhlciIgY2F0ZWdvcnkgYW5kICIwIHBlb3BsZSBhcmUgdmlld2luZyIKICAgICAqIHdvdWxkIGJlIHNob3duIGluc3RlYWQgb2YgIk5vYm9keSBpcyB2aWV3aW5nIi4gWW91IGNhbiBzcGVjaWZ5IGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGZvcgogICAgICogb3RoZXIgbnVtYmVycywgZm9yIGV4YW1wbGUgMTIsIHNvIHRoYXQgaW5zdGVhZCBvZiBzaG93aW5nICIxMiBwZW9wbGUgYXJlIHZpZXdpbmciLCB5b3UgY2FuCiAgICAgKiBzaG93ICJhIGRvemVuIHBlb3BsZSBhcmUgdmlld2luZyIuCiAgICAgKgogICAgICogWW91IGNhbiB1c2UgYSBzZXQgb2YgY2xvc2VkIGJyYWNlcyhge31gKSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgbnVtYmVyIHRoYXQgeW91IHdhbnQgc3Vic3RpdHV0ZWQKICAgICAqIGludG8gcGx1cmFsaXplZCBzdHJpbmdzLiBJbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwgQW5ndWxhciB3aWxsIHJlcGxhY2UgYHt9YCB3aXRoCiAgICAgKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICAgICAqIGZvciA8c3BhbiBuZy1ub24tYmluZGFibGU+e3tudW1iZXJFeHByZXNzaW9ufX08L3NwYW4+LgogICAgICoKICAgICAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICAgICAqIFRoZSBgb2Zmc2V0YCBhdHRyaWJ1dGUgYWxsb3dzIGZ1cnRoZXIgY3VzdG9taXphdGlvbiBvZiBwbHVyYWxpemVkIHRleHQsIHdoaWNoIGNhbiByZXN1bHQgaW4KICAgICAqIGEgYmV0dGVyIHVzZXIgZXhwZXJpZW5jZS4gRm9yIGV4YW1wbGUsIGluc3RlYWQgb2YgdGhlIG1lc3NhZ2UgIjQgcGVvcGxlIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLAogICAgICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogICAgICogVGhlIG9mZnNldCBhdHRyaWJ1dGUgYWxsb3dzIHlvdSB0byBvZmZzZXQgYSBudW1iZXIgYnkgYW55IGRlc2lyZWQgdmFsdWUuCiAgICAgKiBMZXQncyB0YWtlIGEgbG9vayBhdCBhbiBleGFtcGxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICAgICAqICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIE5vdGljZSB0aGF0IHdlIGFyZSBzdGlsbCB1c2luZyB0d28gcGx1cmFsIGNhdGVnb3JpZXMob25lLCBvdGhlciksIGJ1dCB3ZSBhZGRlZAogICAgICogdGhyZWUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIDAsIDEgYW5kIDIuCiAgICAgKiBXaGVuIG9uZSBwZXJzb24sIHBlcmhhcHMgSm9obiwgdmlld3MgdGhlIGRvY3VtZW50LCAiSm9obiBpcyB2aWV3aW5nIiB3aWxsIGJlIHNob3duLgogICAgICogV2hlbiB0aHJlZSBwZW9wbGUgdmlldyB0aGUgZG9jdW1lbnQsIG5vIGV4cGxpY2l0IG51bWJlciBydWxlIGlzIGZvdW5kLCBzbwogICAgICogYW4gb2Zmc2V0IG9mIDIgaXMgdGFrZW4gb2ZmIDMsIGFuZCBBbmd1bGFyIHVzZXMgMSB0byBkZWNpZGUgdGhlIHBsdXJhbCBjYXRlZ29yeS4KICAgICAqIEluIHRoaXMgY2FzZSwgcGx1cmFsIGNhdGVnb3J5ICdvbmUnIGlzIG1hdGNoZWQgYW5kICJKb2huLCBNYXJyeSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZyIKICAgICAqIGlzIHNob3duLgogICAgICoKICAgICAqIE5vdGUgdGhhdCB3aGVuIHlvdSBzcGVjaWZ5IG9mZnNldHMsIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvcgogICAgICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICAgICAqIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvciAwLCAxLCAyIGFuZCAzLiBZb3UgbXVzdCBhbHNvIHByb3ZpZGUgcGx1cmFsIHN0cmluZ3MgZm9yCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllcyAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xleHByZXNzaW9ufSBjb3VudCBUaGUgdmFyaWFibGUgdG8gYmUgYm91bmRlZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb2Rpbmcgc3RyaW5ncy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjEgPSAnSWdvcic7CiAgICAgICAgICAgICRzY29wZS5wZXJzb24yID0gJ01pc2tvJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIHNpbXBsZSBwbHVyYWxpemF0aW9uIHJ1bGVzIGZvciBlbiBsb2NhbGUgLS0tPgogICAgIFdpdGhvdXQgT2Zmc2V0OgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT48YnI+CgogICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgIFdpdGggT2Zmc2V0KDIpOgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzEgcGVyc29uIGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yIGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzAnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgYW5kIE1pc2tvIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCczJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCczIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCc0IHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYmluZGVkIG5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjEnKS5lbnRlcignRGknKTsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb24yJykuZW50ZXIoJ1ZvanRhJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBCUkFDRSA9IC97fS9nOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgdmFyIG51bWJlckV4cCA9IGF0dHIuY291bnQsCiAgICAgICAgICAgICAgICAgICAgd2hlbkV4cCA9IGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB0aGlzIGlzIGJlY2F1c2Ugd2UgaGF2ZSB7e319IGluIGF0dHJzCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gYXR0ci5vZmZzZXQgfHwgMCwKICAgICAgICAgICAgICAgICAgICB3aGVucyA9IHNjb3BlLiRldmFsKHdoZW5FeHApLAogICAgICAgICAgICAgICAgICAgIHdoZW5zRXhwRm5zID0ge30sCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCk7CgogICAgICAgICAgICAgICAgZm9yRWFjaCh3aGVucywgZnVuY3Rpb24oZXhwcmVzc2lvbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnNba2V5XSA9CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCArIGVuZFN5bWJvbCkpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiBleHBsaWNpdCBudW1iZXIgcnVsZSBzdWNoIGFzIDEsIDIsIDMuLi4gaXMgZGVmaW5lZCwganVzdCB1c2UgaXQuIE90aGVyd2lzZSwKICAgICAgICAgICAgICAgICAgICAgICAgLy9jaGVjayBpdCBhZ2FpbnN0IHBsdXJhbGl6YXRpb24gcnVsZXMgaW4gJGxvY2FsZSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuc0V4cEZuc1t2YWx1ZV0oc2NvcGUsIGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dChuZXdWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdSZXBlYXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAgICAgKiBpbnN0YW5jZSBnZXRzIGl0cyBvd24gc2NvcGUsIHdoZXJlIHRoZSBnaXZlbiBsb29wIHZhcmlhYmxlIGlzIHNldCB0byB0aGUgY3VycmVudCBjb2xsZWN0aW9uIGl0ZW0sCiAgICAgKiBhbmQgYCRpbmRleGAgaXMgc2V0IHRvIHRoZSBpdGVtIGluZGV4IG9yIGtleS4KICAgICAqCiAgICAgKiBTcGVjaWFsIHByb3BlcnRpZXMgYXJlIGV4cG9zZWQgb24gdGhlIGxvY2FsIHNjb3BlIG9mIGVhY2ggdGVtcGxhdGUgaW5zdGFuY2UsIGluY2x1ZGluZzoKICAgICAqCiAgICAgKiAgICogYCRpbmRleGAg4oCTIGB7bnVtYmVyfWAg4oCTIGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpCiAgICAgKiAgICogYCRmaXJzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGZpcnN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJG1pZGRsZWAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJGxhc3RgIOKAkyBge2Jvb2xlYW59YCDigJMgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUd28KICAgICAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICAgICAqCiAgICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogICAgICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYHRyYWNrIGluIGNkLnRyYWNrc2AuCiAgICAgKgogICAgICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogICAgICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgICAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBhZ2U6MjV9LCB7bmFtZTonTWFyeScsIGFnZToyOH1dIj4KICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyI+CiAgICAgW3t7JGluZGV4ICsgMX19XSB7e2ZyaWVuZC5uYW1lfX0gd2hvIGlzIHt7ZnJpZW5kLmFnZX19IHllYXJzIG9sZC4KICAgICA8L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1yZXBlYXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICB2YXIgciA9IHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLnJlcGVhdGVyKCd1bCBsaScpOwogICAgICAgICAgIGV4cGVjdChyLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgICAgZXhwZWN0KHIucm93KDApKS50b0VxdWFsKFsiMSIsIkpvaG4iLCIyNSJdKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMSkpLnRvRXF1YWwoWyIyIiwiTWFyeSIsIjI4Il0pOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdSZXBlYXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGl0ZXJTdGFydEVsZW1lbnQsIGF0dHIpewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBhdHRyLm5nUmVwZWF0OwogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKiguKylccytpblxzKyguKilccyokLyksCiAgICAgICAgICAgICAgICAgICAgbGhzLCByaHMsIHZhbHVlSWRlbnQsIGtleUlkZW50OwogICAgICAgICAgICAgICAgaWYgKCEgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgbmdSZXBlYXQgaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgYnV0IGdvdCAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxocyA9IG1hdGNoWzFdOwogICAgICAgICAgICAgICAgcmhzID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgICBtYXRjaCA9IGxocy5tYXRjaCgvXig/OihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSkkLyk7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIidpdGVtJyBpbiAnaXRlbSBpbiBjb2xsZWN0aW9uJyBzaG91bGQgYmUgaWRlbnRpZmllciBvciAoa2V5LCB2YWx1ZSkgYnV0IGdvdCAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgIGxocyArICInLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWVJZGVudCA9IG1hdGNoWzNdIHx8IG1hdGNoWzFdOwogICAgICAgICAgICAgICAga2V5SWRlbnQgPSBtYXRjaFsyXTsKCiAgICAgICAgICAgICAgICAvLyBTdG9yZSBhIGxpc3Qgb2YgZWxlbWVudHMgZnJvbSBwcmV2aW91cyBydW4uIFRoaXMgaXMgYSBoYXNoIHdoZXJlIGtleSBpcyB0aGUgaXRlbSBmcm9tIHRoZQogICAgICAgICAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgLy8gICAtIHNjb3BlOiBib3VuZCBzY29wZQogICAgICAgICAgICAgICAgLy8gICAtIGVsZW1lbnQ6IHByZXZpb3VzIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIGFuIGFycmF5IG9mIHRoZXNlIG9iamVjdHMgc2luY2UgdGhlIHNhbWUgb2JqZWN0IGNhbiBiZSByZXR1cm5lZCBmcm9tIHRoZSBpdGVyYXRvci4KICAgICAgICAgICAgICAgIC8vIFdlIGV4cGVjdCB0aGlzIHRvIGJlIGEgcmFyZSBjYXNlLgogICAgICAgICAgICAgICAgdmFyIGxhc3RPcmRlciA9IG5ldyBIYXNoUXVldWVNYXAoKTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdSZXBlYXRXYXRjaChzY29wZSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBzY29wZS4kZXZhbChyaHMpLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBpdGVyU3RhcnRFbGVtZW50LCAgICAgLy8gY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgbm9kZQogICAgICAgICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdE9yZGVyIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGxhc3RPcmRlciBvbiB0aGUgbmV4dCBpdGVyYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlciA9IG5ldyBIYXNoUXVldWVNYXAoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlCb3VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDsgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpbmRleH0KCgoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnNvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSA9IGNvbGxlY3Rpb24gfHwgW107CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kID0gYXJyYXkubGVuZ3RoLTE7CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGFycmF5KSA/IGluZGV4IDogYXJyYXlbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QgPSBsYXN0T3JkZXIuc2hpZnQodmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYWxyZWFkeSBzZWVuIHRoaXMgb2JqZWN0LCB0aGVuIHdlIG5lZWQgdG8gcmV1c2UgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHNjb3BlL2VsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBsYXN0LnNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gbGFzdC5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBsYXN0LmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV4aXN0aW5nIGl0ZW0gd2hpY2ggZ290IG1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdC5pbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWF5IGJlIGEgbm9vcCwgaWYgdGhlIGVsZW1lbnQgaXMgbmV4dCwgYnV0IEkgZG9uJ3Qga25vdyBvZiBhIGdvb2Qgd2F5IHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmlndXJlIHRoaXMgb3V0LCAgc2luY2UgaXQgd291bGQgcmVxdWlyZSBleHRyYSBET00gYWNjZXNzLCBzbyBsZXQncyBqdXN0IGhvcGUgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBicm93c2VycyByZWFsaXplcyB0aGF0IGl0IGlzIG5vb3AsIGFuZCB0cmVhdHMgaXQgYXMgc3VjaC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IuYWZ0ZXIobGFzdC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBsYXN0LmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcgaXRlbSB3aGljaCB3ZSBkb24ndCBrbm93IGFib3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlW3ZhbHVlSWRlbnRdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlJZGVudCkgY2hpbGRTY29wZVtrZXlJZGVudF0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGluZGV4ID0gaW5kZXg7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGxhc3QgPSAoaW5kZXggPT09IGFycmF5Qm91bmQpOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRtaWRkbGUgPSAhKGNoaWxkU2NvcGUuJGZpcnN0IHx8IGNoaWxkU2NvcGUuJGxhc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rZXIoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGNoaWxkU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IChjdXJzb3IgPSBjbG9uZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vc2hyaW5rIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbGFzdE9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0T3JkZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBsYXN0T3JkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJyYXkucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsYXN0T3JkZXIgPSBuZXh0T3JkZXI7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1Nob3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdTaG93YCBhbmQgYG5nSGlkZWAgZGlyZWN0aXZlcyBzaG93IG9yIGhpZGUgYSBwb3J0aW9uIG9mIHRoZSBET00gdHJlZSAoSFRNTCkKICAgICAqIGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU2hvdyBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5CiAgICAgKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIFNob3c6IDxzcGFuIG5nLXNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+IDxici8+CiAgICAgSGlkZTogPHNwYW4gbmctaGlkZT0iY2hlY2tlZCI+SSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLjwvc3Bhbj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CgogICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwovL1RPRE8obWlza28pOiByZWZhY3RvciB0byByZW1vdmUgZWxlbWVudCBmcm9tIHRoZSBET00KICAgIHZhciBuZ1Nob3dEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cil7CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdkaXNwbGF5JywgdG9Cb29sZWFuKHZhbHVlKSA/ICcnIDogJ25vbmUnKTsKICAgICAgICB9KTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0hpZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdIaWRlYCBhbmQgYG5nU2hvd2AgZGlyZWN0aXZlcyBoaWRlIG9yIHNob3cgYSBwb3J0aW9uIG9mIHRoZSBET00gdHJlZSAoSFRNTCkKICAgICAqIGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSGlkZSBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5IHRoZW4KICAgICAqICAgICB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIFNob3c6IDxzcGFuIG5nLXNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdSBjaGVja2JveCBpcyBjaGVja2VkPzwvc3Bhbj4gPGJyLz4KICAgICBIaWRlOiA8c3BhbiBuZy1oaWRlPSJjaGVja2VkIj5JIGhpZGUgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwoKICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KLy9UT0RPKG1pc2tvKTogcmVmYWN0b3IgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSB0aGUgRE9NCiAgICB2YXIgbmdIaWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAgICAgICBlbGVtZW50LmNzcygnZGlzcGxheScsIHRvQm9vbGVhbih2YWx1ZSkgPyAnbm9uZScgOiAnJyk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N0eWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICAgICAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAgICAgKiAgICAgIGtleXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0ic2V0IiBuZy1jbGljaz0ibXlTdHlsZT17Y29sb3I6J3JlZCd9Ij4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVN0eWxlPXt9Ij4KICAgICA8YnIvPgogICAgIDxzcGFuIG5nLXN0eWxlPSJteVN0eWxlIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICA8cHJlPm15U3R5bGU9e3tteVN0eWxlfX08L3ByZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICBzcGFuIHsKICAgICAgICAgY29sb3I6IGJsYWNrOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdHlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b25bdmFsdWU9c2V0XScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMjU1LCAwLCAwKScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1N0eWxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgICAgICAgICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24odmFsLCBzdHlsZSkgeyBlbGVtZW50LmNzcyhzdHlsZSwgJycpO30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXdTdHlsZXMpIGVsZW1lbnQuY3NzKG5ld1N0eWxlcyk7CiAgICAgICAgfSwgdHJ1ZSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N3aXRjaAogICAgICogQHJlc3RyaWN0IEVBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb25kaXRpb25hbGx5IGNoYW5nZSB0aGUgRE9NIHN0cnVjdHVyZS4KICAgICAqCiAgICAgKiBAdXNhZ2UKICAgICAqIDxBTlkgbmctc3dpdGNoPSJleHByZXNzaW9uIj4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvQU5ZPgogICAgICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMiI+Li4uPC9BTlk+CiAgICAgKiAgIC4uLgogICAgICogICA8QU5ZIG5nLXN3aXRjaC1kZWZhdWx0Pi4uLjwvQU5ZPgogICAgICogPC9BTlk+CiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKiBAcGFyYW0geyp9IG5nU3dpdGNofG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmctc3dpdGNoLXdoZW48L3R0Pi4KICAgICAqIEBwYXJhbURlc2NyaXB0aW9uCiAgICAgKiBPbiBjaGlsZCBlbG1lbnRzIGFkZDoKICAgICAqCiAgICAgKiAqIGBuZ1N3aXRjaFdoZW5gOiB0aGUgY2FzZSBzdGF0ZW1lbnQgdG8gbWF0Y2ggYWdhaW5zdC4gSWYgbWF0Y2ggdGhlbiB0aGlzCiAgICAgKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuCiAgICAgKiAqIGBuZ1N3aXRjaERlZmF1bHRgOiB0aGUgZGVmYXVsdCBjYXNlIHdoZW4gbm8gb3RoZXIgY2Fzc2VzIG1hdGNoLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLml0ZW1zID0gWydzZXR0aW5ncycsICdob21lJywgJ290aGVyJ107CiAgICAgICAgICAgICRzY29wZS5zZWxlY3Rpb24gPSAkc2NvcGUuaXRlbXNbMF07CiAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJzZWxlY3Rpb24iIG5nLW9wdGlvbnM9Iml0ZW0gZm9yIGl0ZW0gaW4gaXRlbXMiPgogICAgIDwvc2VsZWN0PgogICAgIDx0dD5zZWxlY3Rpb249e3tzZWxlY3Rpb259fTwvdHQ+CiAgICAgPGhyLz4KICAgICA8ZGl2IG5nLXN3aXRjaCBvbj0ic2VsZWN0aW9uIiA+CiAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgIDxzcGFuIG5nLXN3aXRjaC13aGVuPSJob21lIj5Ib21lIFNwYW48L3NwYW4+CiAgICAgPHNwYW4gbmctc3dpdGNoLWRlZmF1bHQ+ZGVmYXVsdDwvc3Bhbj4KICAgICA8L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvU2V0dGluZ3MgRGl2Lyk7CiAgICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignaG9tZScpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL0hvbWUgU3Bhbi8pOwogICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgc2VsZWN0IGRlYWZhdWx0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHNlbGVjdCgnc2VsZWN0aW9uJykub3B0aW9uKCdvdGhlcicpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL2RlZmF1bHQvKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgTkdfU1dJVENIID0gJ25nLXN3aXRjaCc7CiAgICB2YXIgbmdTd2l0Y2hEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICByZXF1aXJlOiAnbmdTd2l0Y2gnLAogICAgICAgIC8vIGFza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgICAgICAgICB0aGlzLmNhc2VzID0ge307CiAgICAgICAgfV0sCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgdmFyIHdhdGNoRXhwciA9IGF0dHIubmdTd2l0Y2ggfHwgYXR0ci5vbiwKICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCwKICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGU7CgogICAgICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBzZWxlY3RlZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoc2VsZWN0ZWRUcmFuc2NsdWRlID0gY3RybC5jYXNlc1snIScgKyB2YWx1ZV0gfHwgY3RybC5jYXNlc1snPyddKSkgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIuY2hhbmdlKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZShzZWxlY3RlZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBjYXNlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gdHJhbnNjbHVkZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snPyddID0gdHJhbnNjbHVkZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1RyYW5zY2x1ZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEluc2VydCB0aGUgdHJhbnNjbHVkZWQgRE9NIGhlcmUuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnRpdGxlID0gJ0xvcmVtIElwc3VtJzsKICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QgcXVpIGRvbG9yZW0gaXBzdW0gcXVpYSBkb2xvci4uLic7CiAgICAgICAgIH0KCiAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgIHNjb3BlOiB7IHRpdGxlOidAJyB9LAogICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAnPGRpdiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogZ3JheSI+e3t0aXRsZX19PC9kaXY+JyArCiAgICAgJzxkaXYgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAnPC9kaXY+JwogICAgIH07CiAgICAgfSk7CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgbmctbW9kZWw9InRpdGxlIj48YnI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ0ZXh0Ij48L3RleHRhcmVhPiA8YnIvPgogICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ3RpdGxlJykuZW50ZXIoJ1RJVExFJyk7CiAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdURVhUJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndGl0bGUnKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ1RFWFQnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICBjb250cm9sbGVyOiBbJyR0cmFuc2NsdWRlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHRyYW5zY2x1ZGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3CiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdWaWV3YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGNvbXBsZW1lbnRzIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZSBieQogICAgICogaW5jbHVkaW5nIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvZiB0aGUgY3VycmVudCByb3V0ZSBpbnRvIHRoZSBtYWluIGxheW91dCAoYGluZGV4Lmh0bWxgKSBmaWxlLgogICAgICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogICAgICogY29uZmlndXJhdGlvbiBvZiB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgIENob29zZToKICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgIDxociAvPgoKICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdib29rLmh0bWwnLAogICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bAogICAgICAgICAgfSk7CiAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQ2hhcHRlckNudGwKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpOwogICAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAkc2NvcGUuJGxvY2F0aW9uID0gJGxvY2F0aW9uOwogICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJCb29rQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KCiAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCdhOmNvbnRhaW5zKCJNb2J5OiBDaDEiKScpLmNsaWNrKCk7CiAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9Cb29rIElkXDogTW9ieS8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3IyR2aWV3Q29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nVmlldyBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nVmlldyBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdWaWV3RGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcm91dGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsCiAgICAgICAgJyRjb250cm9sbGVyJywKICAgICAgICBmdW5jdGlvbigkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkcm91dGUsICAgJGFuY2hvclNjcm9sbCwgICAkY29tcGlsZSwKICAgICAgICAgICAgICAgICAkY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0U2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS4kb24oJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZSgpOwoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVzdHJveUxhc3RTY29wZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RTY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRlbnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lMYXN0U2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9ICRyb3V0ZS5jdXJyZW50ICYmICRyb3V0ZS5jdXJyZW50LmxvY2FscywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gbG9jYWxzICYmIGxvY2Fscy4kdGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95TGFzdFNjb3BlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmsgPSAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSAkcm91dGUuY3VycmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZSA9IGN1cnJlbnQuc2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzLiRzY29wZSA9IGxhc3RTY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIoY3VycmVudC5jb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobGFzdFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZW1pdCgnJHZpZXdDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGV2YWwob25sb2FkRXhwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAkYW5jaG9yU2Nyb2xsIG1pZ2h0IGxpc3RlbiBvbiBldmVudC4uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2NyaXB0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBMb2FkIGNvbnRlbnQgb2YgYSBzY3JpcHQgdGFnLCB3aXRoIHR5cGUgYHRleHQvbmctdGVtcGxhdGVgLCBpbnRvIGAkdGVtcGxhdGVDYWNoZWAsIHNvIHRoYXQgdGhlCiAgICAgKiB0ZW1wbGF0ZSBjYW4gYmUgdXNlZCBieSBgbmdJbmNsdWRlYCwgYG5nVmlld2Agb3IgZGlyZWN0aXZlIHRlbXBsYXRlcy4KICAgICAqCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICogQHBhcmFtIHsndGV4dC9uZy10ZW1wbGF0ZSd9IHR5cGUgbXVzdCBiZSBzZXQgdG8gYCd0ZXh0L25nLXRlbXBsYXRlJ2AKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSIvdHBsLmh0bWwiPgogICAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICAgIDwvc2NyaXB0PgoKICAgICA8YSBuZy1jbGljaz0iY3VycmVudFRwbD0nL3RwbC5odG1sJyIgaWQ9InRwbC1saW5rIj5Mb2FkIGlubGluZWQgdGVtcGxhdGU8L2E+CiAgICAgPGRpdiBpZD0idHBsLWNvbnRlbnQiIG5nLWluY2x1ZGUgc3JjPSJjdXJyZW50VHBsIj48L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUgZGVmaW5lZCBpbnNpZGUgc2NyaXB0IHRhZycsIGZ1bmN0aW9uKCkgewogICAgICAgIGVsZW1lbnQoJyN0cGwtbGluaycpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyN0cGwtY29udGVudCcpLnRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0aGUgdGVtcGxhdGUvKTsKICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIHNjcmlwdERpcmVjdGl2ZSA9IFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2VsZWN0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogIyBgbmdPcHRpb25zYAogICAgICoKICAgICAqIE9wdGlvbmFsbHkgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAgICAgKiBlbGVtZW50cyBmb3IgYSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgYW4gYXJyYXkgb3IgYW4gb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICAgKiBgbmdPcHRpb25zYCBleHByZXNzaW9uLgogICAgICoKICAgICAqIFdoZW4gYW4gaXRlbSBpbiB0aGUgYDxzZWxlY3Q+YCBtZW51IGlzIHNlbGVjdGVkLCB0aGUgdmFsdWUgb2YgYXJyYXkgZWxlbWVudCBvciBvYmplY3QgcHJvcGVydHkKICAgICAqIHJlcHJlc2VudGVkIGJ5IHRoZSBzZWxlY3RlZCBvcHRpb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgaWRlbnRpZmllZCBieSB0aGUgYG5nTW9kZWxgCiAgICAgKiBkaXJlY3RpdmUgb2YgdGhlIHBhcmVudCBzZWxlY3QgZWxlbWVudC4KICAgICAqCiAgICAgKiBPcHRpb25hbGx5LCBhIHNpbmdsZSBoYXJkLWNvZGVkIGA8b3B0aW9uPmAgZWxlbWVudCwgd2l0aCB0aGUgdmFsdWUgc2V0IHRvIGFuIGVtcHR5IHN0cmluZywgY2FuCiAgICAgKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICAgICAqIG9wdGlvbi4gU2VlIGV4YW1wbGUgYmVsb3cgZm9yIGRlbW9uc3RyYXRpb24uCiAgICAgKgogICAgICogTm90ZTogYG5nT3B0aW9uc2AgcHJvdmlkZXMgaXRlcmF0b3IgZmFjaWxpdHkgZm9yIGA8b3B0aW9uPmAgZWxlbWVudCB3aGljaCBzaG91bGQgYmUgdXNlZCBpbnN0ZWFkCiAgICAgKiBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSB3aGVuIHlvdSB3YW50IHRoZQogICAgICogYHNlbGVjdGAgbW9kZWwgdG8gYmUgYm91bmQgdG8gYSBub24tc3RyaW5nIHZhbHVlLiBUaGlzIGlzIGJlY2F1c2UgYW4gb3B0aW9uIGVsZW1lbnQgY2FuIGN1cnJlbnRseQogICAgICogYmUgYm91bmQgdG8gc3RyaW5nIHZhbHVlcyBvbmx5LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgVGhlIGNvbnRyb2wgaXMgY29uc2lkZXJlZCB2YWxpZCBvbmx5IGlmIHZhbHVlIGlzIGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7Y29tcHJlaGVuc2lvbl9leHByZXNzaW9uPX0gbmdPcHRpb25zIGluIG9uZSBvZiB0aGUgZm9sbG93aW5nIGZvcm1zOgogICAgICoKICAgICAqICAgKiBmb3IgYXJyYXkgZGF0YSBzb3VyY2VzOgogICAgICogICAgICogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBsYWJlbGAgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAKICAgICAqICAgICAgICAgKipgZm9yYCBgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICoKICAgICAqIFdoZXJlOgogICAgICoKICAgICAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqICAgKiBgdmFsdWVgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGVhY2ggaXRlbSBpbiB0aGUgYGFycmF5YCBvciBlYWNoIHByb3BlcnR5IHZhbHVlCiAgICAgKiAgICAgIG9mIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICAgKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICAgKiAgICogYGxhYmVsYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB0aGUgbGFiZWwgZm9yIGA8b3B0aW9uPmAgZWxlbWVudC4gVGhlCiAgICAgKiAgICAgYGV4cHJlc3Npb25gIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLgogICAgICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICAgICAqICAgICAgZWxlbWVudC4gSWYgbm90IHNwZWNpZmllZCwgYHNlbGVjdGAgZXhwcmVzc2lvbiB3aWxsIGRlZmF1bHQgdG8gYHZhbHVlYC4KICAgICAqICAgKiBgZ3JvdXBgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHVzZWQgdG8gZ3JvdXAgb3B0aW9ucyB1c2luZyB0aGUgYDxvcHRncm91cD5gCiAgICAgKiAgICAgIERPTSBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gTXlDbnRybCgkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgIHtuYW1lOidibGFjaycsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid3aGl0ZScsIHNoYWRlOidsaWdodCd9LAogICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J2JsdWUnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZToneWVsbG93Jywgc2hhZGU6J2xpZ2h0J30KICAgICAgICAgIF07CiAgICAgICAgICAkc2NvcGUuY29sb3IgPSAkc2NvcGUuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNeUNudHJsIj4KICAgICA8dWw+CiAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9ImNvbG9yLm5hbWUiPgogICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMuc3BsaWNlKCRpbmRleCwgMSkiPlg8L2E+XQogICAgIDwvbGk+CiAgICAgPGxpPgogICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMucHVzaCh7fSkiPmFkZDwvYT5dCiAgICAgPC9saT4KICAgICA8L3VsPgogICAgIDxoci8+CiAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgIENvbG9yIChudWxsIGFsbG93ZWQpOgogICAgIDxzcGFuICBjbGFzcz0ibnVsbGFibGUiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob3NlIGNvbG9yIC0tPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPC9zcGFuPjxici8+CgogICAgIENvbG9yIGdyb3VwZWQgYnkgc2hhZGU6CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29sb3IiIG5nLW9wdGlvbnM9ImMubmFtZSBncm91cCBieSBjLnNoYWRlIGZvciBjIGluIGNvbG9ycyI+CiAgICAgPC9zZWxlY3Q+PGJyLz4KCgogICAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICA8aHIvPgogICAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOmNvbG9yfSAgfX0KICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICBuZy1zdHlsZT0ieydiYWNrZ3JvdW5kLWNvbG9yJzpjb2xvci5uYW1lfSI+CiAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1vcHRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgncmVkJyk7CiAgICAgICAgICAgc2VsZWN0KCdjb2xvcicpLm9wdGlvbignMCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgdXNpbmcoJy5udWxsYWJsZScpLnNlbGVjdCgnY29sb3InKS5vcHRpb24oJycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ251bGwnKTsKICAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKICAgIHZhciBuZ09wdGlvbnNEaXJlY3RpdmUgPSB2YWx1ZUZuKHsgdGVybWluYWw6IHRydWUgfSk7CiAgICB2YXIgc2VsZWN0RGlyZWN0aXZlID0gWyckY29tcGlsZScsICckcGFyc2UnLCBmdW5jdGlvbigkY29tcGlsZSwgICAkcGFyc2UpIHsKICAgICAgICAvLzAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3NzAKICAgICAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKiguKj8pKD86XHMrYXNccysoLio/KSk/KD86XHMrZ3JvdXBccytieVxzKyguKikpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd1xkXSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XGRdKilccyosXHMqKFtcJFx3XVtcJFx3XGRdKilccypcKSkpXHMraW5ccysoLiopJC8sCiAgICAgICAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRlbGVtZW50LCAkc2NvcGUsICRhdHRycykgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNNYXAgPSB7fSwKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybCA9IG51bGxNb2RlbEN0cmwsCiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiwKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uOwoKCiAgICAgICAgICAgICAgICBzZWxmLmRhdGFib3VuZCA9ICRhdHRycy5uZ01vZGVsOwoKCiAgICAgICAgICAgICAgICBzZWxmLmluaXQgPSBmdW5jdGlvbihuZ01vZGVsQ3RybF8sIG51bGxPcHRpb25fLCB1bmtub3duT3B0aW9uXykgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uID0gdW5rbm93bk9wdGlvbl87CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuYWRkT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNPcHRpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zTWFwW3ZhbHVlXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyVW5rbm93bk9wdGlvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnByZXBlbmQodW5rbm93bk9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBzZWxmLmhhc09wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZGlzYWJsZSB1bmtub3duIG9wdGlvbiBzbyB0aGF0IHdlIGRvbid0IGRvIHdvcmsgd2hlbiB0aGUgd2hvbGUgc2VsZWN0IGlzIGJlaW5nIGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IG5vb3A7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICAgIC8vIGlmIG5nTW9kZWwgaXMgbm90IGRlZmluZWQsIHdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcKICAgICAgICAgICAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gY3RybHNbMV0sCiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBhdHRyLm11bHRpcGxlLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNFeHAgPSBhdHRyLm5nT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uID0gZmFsc2UsIC8vIGlmIGZhbHNlLCB1c2VyIHdpbGwgbm90IGJlIGFibGUgdG8gc2VsZWN0IGl0ICh1c2VkIGJ5IG5nT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiwKICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgICAgICAgICAgICBvcHRpb25UZW1wbGF0ZSA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSksCiAgICAgICAgICAgICAgICAgICAgb3B0R3JvdXBUZW1wbGF0ZSA9anFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgIC8vIGZpbmQgIm51bGwiIG9wdGlvbgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuaW5pdChuZ01vZGVsQ3RybCwgbnVsbE9wdGlvbiwgdW5rbm93bk9wdGlvbik7CgogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUgJiYgKGF0dHIucmVxdWlyZWQgfHwgYXR0ci5uZ1JlcXVpcmVkKSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXF1aXJlZFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCAhYXR0ci5yZXF1aXJlZCB8fCAodmFsdWUgJiYgdmFsdWUubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kcGFyc2Vycy5wdXNoKHJlcXVpcmVkVmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kZm9ybWF0dGVycy51bnNoaWZ0KHJlcXVpcmVkVmFsaWRhdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRWYWxpZGF0b3IobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNFeHApIE9wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlKSBNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2luZ2xlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBuZ01vZGVsQ3RybCwgc2VsZWN0Q3RybCkgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE11bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaXNEZWZpbmVkKGl0ZW1zLmdldChvcHRpb24udmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBkbyBpdCBvbiBlYWNoIHdhdGNoIHNpbmNlIG5nTW9kZWwgd2F0Y2hlcyByZWZlcmVuY2UsIGJ1dAogICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gd29yayBvZiBhbiBhcnJheSwgc28gd2UgbmVlZCB0byBzZWUgaWYgYW55dGhpbmcgd2FzIGluc2VydGVkL3JlbW92ZWQKICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gc2VsZWN0TXVsdGlwbGVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlcXVhbHMobGFzdFZpZXcsIGN0cmwuJHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWaWV3ID0gY29weShjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gT3B0aW9ucyhzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCEgKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIG5nT3B0aW9ucyBpbiBmb3JtIG9mICdfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCBnb3QgJyIgKyBvcHRpb25zRXhwICsgIicuIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFtbe2VsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOicnfV1dOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuaHRtbCgnJykgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGxhYmVsIGZyb20gdGhlIGVsZW1lbnQuIHd0Zj8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCBvcHRpb25FbGVtZW50LCBpbmRleCwgZ3JvdXBJbmRleCwgbGVuZ3RoLCBncm91cExlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleU5hbWUpIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIgPSByZW5kZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8odm9qdGEpOiBjYW4ndCB3ZSBvcHRpbWl6ZSB0aGlzID8KICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2gocmVuZGVyKTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXBzID0geycnOltdfSwgLy8gVGVtcG9yYXJ5IGxvY2F0aW9uIGZvciB0aGUgb3B0aW9uIGdyb3VwcyBiZWZvcmUgd2UgcmVuZGVyIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMgPSBbJyddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCwgZXhpc3RpbmdPcHRpb25zLCBleGlzdGluZ09wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cyA9IGtleU5hbWUgPyBzb3J0ZWRLZXlzKHZhbHVlcykgOiB2YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cExlbmd0aCwgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCwgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBmYWxzZSwgLy8gbm90aGluZyBpcyBzZWxlY3RlZCB5ZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5TmFtZSA/IGxvY2Fsc1trZXlOYW1lXT1rZXlzW2luZGV4XTppbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWRTZXQucmVtb3ZlKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4LCAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6JycsIGxhYmVsOicnLCBzZWxlY3RlZDohc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonPycsIGxhYmVsOicnLCBzZWxlY3RlZDp0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25Hcm91cFtpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCsxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucG9wKCkuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoID4gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgICAgICAgICAgYWRkT3B0aW9uOiBub29wLAogICAgICAgICAgICByZW1vdmVPcHRpb246IG5vb3AKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LnRleHQoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucGFyZW50KCkuZGF0YShzZWxlY3RDdHJsTmFtZSk7IC8vIGluIGNhc2Ugd2UgYXJlIGluIG9wdGdyb3VwCgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RDdHJsICYmIHNlbGVjdEN0cmwuZGF0YWJvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBzb21lIHJlYXNvbiBPcGVyYSBkZWZhdWx0cyB0byB0cnVlIGFuZCBpZiBub3Qgb3ZlcnJpZGRlbiB0aGlzIG1lc3NlcyB1cCB0aGUgcmVwZWF0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIHZpZXcgdG8gZHJpdmUgdGhlIGluaXRpYWxpemF0aW9uIG9mIHRoZSBtb2RlbCBhbnl3YXkuCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybCA9IG51bGxTZWxlY3RDdHJsOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlV2F0Y2hBY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBuZXdWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1ZhbCAhPT0gb2xkVmFsKSBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24obmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVybWluYWw6IHRydWUKICAgIH0pOwoKICAgIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUgYW5ndWxhci5lbGVtZW50KCkucmVhZCgpCiAgICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgICBiaW5kSlF1ZXJ5KCk7CgogICAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICAgIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9ha3tkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9bmdcXDpmb3Jte2Rpc3BsYXk6YmxvY2s7fTwvc3R5bGU+Jyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 14:56:25 GMT",
                    "Content-Length": "609696",
                    "Date": "Thu, 06 Nov 2014 14:56:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}