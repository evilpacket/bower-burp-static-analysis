{
    "url": "http://localhost:9999/p-js/util/dist/util-bundled.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/p-js/util/dist/util-bundled.js",
                "path": "/p-js/util/dist/util-bundled.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9wLWpzL3V0aWwvZGlzdC91dGlsLWJ1bmRsZWQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTAyMzMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjI6MDk6NTEgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIyOjA5OjUxIEdNVA0KDQovKiBnbG9iYWwgXywgJCAqLwp2YXIgVXRpbCA9IChmdW5jdGlvbihfLCAkKSB7CgkvKioKCSAqIExlZ2FjeSBzdXBwb3J0LgoJICogVGhpcyBidWlsZCBjb21lcyB3aXRoIEJhY2tib25lIGFuZCBIYW5kbGViYXJzLgoJICovCgkvKiBleHBvcnRlZCBVdGlsICovCgl2YXIgVXRpbCA9IHsKCQl2ZXJzaW9uOiAiMi4yLjEiLAoJCWJ1aWxkOiAiVGh1IEFwciAyNCAyMDE0IDExOjM3OjE2IgoJfTsKCS8vIEJFR0lOIFRISVJEIFBBUlRZIENPREUKCS8qIGdsb2JhbCBIYW5kbGViYXJzICovCgkvKiEKCQoJIGhhbmRsZWJhcnMgdjEuMy4wCgkKCUNvcHlyaWdodCAoQykgMjAxMSBieSBZZWh1ZGEgS2F0egoJCglQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CglvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAoJaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwoJdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAoJY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCglmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoJCglUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgoJYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgkKCVRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCglJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKCUZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQoJQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoJTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKCU9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KCVRIRSBTT0ZUV0FSRS4KCQoJQGxpY2Vuc2UKCSovCgkvKiBleHBvcnRlZCBIYW5kbGViYXJzICovCgl2YXIgSGFuZGxlYmFycyA9IChmdW5jdGlvbigpIHsKCS8vIGhhbmRsZWJhcnMvc2FmZS1zdHJpbmcuanMKCXZhciBfX21vZHVsZTNfXyA9IChmdW5jdGlvbigpIHsKCSAgInVzZSBzdHJpY3QiOwoJICB2YXIgX19leHBvcnRzX187CgkgIC8vIEJ1aWxkIG91dCBvdXIgYmFzaWMgU2FmZVN0cmluZyB0eXBlCgkgIGZ1bmN0aW9uIFNhZmVTdHJpbmcoc3RyaW5nKSB7CgkgICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CgkgIH0KCQoJICBTYWZlU3RyaW5nLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAiIiArIHRoaXMuc3RyaW5nOwoJICB9OwoJCgkgIF9fZXhwb3J0c19fID0gU2FmZVN0cmluZzsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoKTsKCQoJLy8gaGFuZGxlYmFycy91dGlscy5qcwoJdmFyIF9fbW9kdWxlMl9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXykgewoJICAidXNlIHN0cmljdCI7CgkgIHZhciBfX2V4cG9ydHNfXyA9IHt9OwoJICAvKmpzaGludCAtVzAwNCAqLwoJICB2YXIgU2FmZVN0cmluZyA9IF9fZGVwZW5kZW5jeTFfXzsKCQoJICB2YXIgZXNjYXBlID0gewoJICAgICImIjogIiZhbXA7IiwKCSAgICAiPCI6ICImbHQ7IiwKCSAgICAiPiI6ICImZ3Q7IiwKCSAgICAnIic6ICImcXVvdDsiLAoJICAgICInIjogIiYjeDI3OyIsCgkgICAgImAiOiAiJiN4NjA7IgoJICB9OwoJCgkgIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwoJICB2YXIgcG9zc2libGUgPSAvWyY8PiInYF0vOwoJCgkgIGZ1bmN0aW9uIGVzY2FwZUNoYXIoY2hyKSB7CgkgICAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7CgkgIH0KCQoJICBmdW5jdGlvbiBleHRlbmQob2JqLCB2YWx1ZSkgewoJICAgIGZvcih2YXIga2V5IGluIHZhbHVlKSB7CgkgICAgICBpZihPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkpIHsKCSAgICAgICAgb2JqW2tleV0gPSB2YWx1ZVtrZXldOwoJICAgICAgfQoJICAgIH0KCSAgfQoJCgkgIF9fZXhwb3J0c19fLmV4dGVuZCA9IGV4dGVuZDt2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoJICBfX2V4cG9ydHNfXy50b1N0cmluZyA9IHRvU3RyaW5nOwoJICAvLyBTb3VyY2VkIGZyb20gbG9kYXNoCgkgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9iZXN0aWVqcy9sb2Rhc2gvYmxvYi9tYXN0ZXIvTElDRU5TRS50eHQKCSAgdmFyIGlzRnVuY3Rpb24gPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7CgkgIH07CgkgIC8vIGZhbGxiYWNrIGZvciBvbGRlciB2ZXJzaW9ucyBvZiBDaHJvbWUgYW5kIFNhZmFyaQoJICBpZiAoaXNGdW5jdGlvbigveC8pKSB7CgkgICAgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBGdW5jdGlvbl0nOwoJICAgIH07CgkgIH0KCSAgdmFyIGlzRnVuY3Rpb247CgkgIF9fZXhwb3J0c19fLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwoJICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpID8gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IEFycmF5XScgOiBmYWxzZTsKCSAgfTsKCSAgX19leHBvcnRzX18uaXNBcnJheSA9IGlzQXJyYXk7CgkKCSAgZnVuY3Rpb24gZXNjYXBlRXhwcmVzc2lvbihzdHJpbmcpIHsKCSAgICAvLyBkb24ndCBlc2NhcGUgU2FmZVN0cmluZ3MsIHNpbmNlIHRoZXkncmUgYWxyZWFkeSBzYWZlCgkgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIFNhZmVTdHJpbmcpIHsKCSAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKCSAgICB9IGVsc2UgaWYgKCFzdHJpbmcgJiYgc3RyaW5nICE9PSAwKSB7CgkgICAgICByZXR1cm4gIiI7CgkgICAgfQoJCgkgICAgLy8gRm9yY2UgYSBzdHJpbmcgY29udmVyc2lvbiBhcyB0aGlzIHdpbGwgYmUgZG9uZSBieSB0aGUgYXBwZW5kIHJlZ2FyZGxlc3MgYW5kCgkgICAgLy8gdGhlIHJlZ2V4IHRlc3Qgd2lsbCBkbyB0aGlzIHRyYW5zcGFyZW50bHkgYmVoaW5kIHRoZSBzY2VuZXMsIGNhdXNpbmcgaXNzdWVzIGlmCgkgICAgLy8gYW4gb2JqZWN0J3MgdG8gc3RyaW5nIGhhcyBlc2NhcGVkIGNoYXJhY3RlcnMgaW4gaXQuCgkgICAgc3RyaW5nID0gIiIgKyBzdHJpbmc7CgkKCSAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KCSAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoYmFkQ2hhcnMsIGVzY2FwZUNoYXIpOwoJICB9CgkKCSAgX19leHBvcnRzX18uZXNjYXBlRXhwcmVzc2lvbiA9IGVzY2FwZUV4cHJlc3Npb247ZnVuY3Rpb24gaXNFbXB0eSh2YWx1ZSkgewoJICAgIGlmICghdmFsdWUgJiYgdmFsdWUgIT09IDApIHsKCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH0gZWxzZSBpZiAoaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAwKSB7CgkgICAgICByZXR1cm4gdHJ1ZTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgfQoJCgkgIF9fZXhwb3J0c19fLmlzRW1wdHkgPSBpc0VtcHR5OwoJICByZXR1cm4gX19leHBvcnRzX187Cgl9KShfX21vZHVsZTNfXyk7CgkKCS8vIGhhbmRsZWJhcnMvZXhjZXB0aW9uLmpzCgl2YXIgX19tb2R1bGU0X18gPSAoZnVuY3Rpb24oKSB7CgkgICJ1c2Ugc3RyaWN0IjsKCSAgdmFyIF9fZXhwb3J0c19fOwoJCgkgIHZhciBlcnJvclByb3BzID0gWydkZXNjcmlwdGlvbicsICdmaWxlTmFtZScsICdsaW5lTnVtYmVyJywgJ21lc3NhZ2UnLCAnbmFtZScsICdudW1iZXInLCAnc3RhY2snXTsKCQoJICBmdW5jdGlvbiBFeGNlcHRpb24obWVzc2FnZSwgbm9kZSkgewoJICAgIHZhciBsaW5lOwoJICAgIGlmIChub2RlICYmIG5vZGUuZmlyc3RMaW5lKSB7CgkgICAgICBsaW5lID0gbm9kZS5maXJzdExpbmU7CgkKCSAgICAgIG1lc3NhZ2UgKz0gJyAtICcgKyBsaW5lICsgJzonICsgbm9kZS5maXJzdENvbHVtbjsKCSAgICB9CgkKCSAgICB2YXIgdG1wID0gRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgbWVzc2FnZSk7CgkKCSAgICAvLyBVbmZvcnR1bmF0ZWx5IGVycm9ycyBhcmUgbm90IGVudW1lcmFibGUgaW4gQ2hyb21lIChhdCBsZWFzdCksIHNvIGBmb3IgcHJvcCBpbiB0bXBgIGRvZXNuJ3Qgd29yay4KCSAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCBlcnJvclByb3BzLmxlbmd0aDsgaWR4KyspIHsKCSAgICAgIHRoaXNbZXJyb3JQcm9wc1tpZHhdXSA9IHRtcFtlcnJvclByb3BzW2lkeF1dOwoJICAgIH0KCQoJICAgIGlmIChsaW5lKSB7CgkgICAgICB0aGlzLmxpbmVOdW1iZXIgPSBsaW5lOwoJICAgICAgdGhpcy5jb2x1bW4gPSBub2RlLmZpcnN0Q29sdW1uOwoJICAgIH0KCSAgfQoJCgkgIEV4Y2VwdGlvbi5wcm90b3R5cGUgPSBuZXcgRXJyb3IoKTsKCQoJICBfX2V4cG9ydHNfXyA9IEV4Y2VwdGlvbjsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoKTsKCQoJLy8gaGFuZGxlYmFycy9iYXNlLmpzCgl2YXIgX19tb2R1bGUxX18gPSAoZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18pIHsKCSAgInVzZSBzdHJpY3QiOwoJICB2YXIgX19leHBvcnRzX18gPSB7fTsKCSAgdmFyIFV0aWxzID0gX19kZXBlbmRlbmN5MV9fOwoJICB2YXIgRXhjZXB0aW9uID0gX19kZXBlbmRlbmN5Ml9fOwoJCgkgIHZhciBWRVJTSU9OID0gIjEuMy4wIjsKCSAgX19leHBvcnRzX18uVkVSU0lPTiA9IFZFUlNJT047dmFyIENPTVBJTEVSX1JFVklTSU9OID0gNDsKCSAgX19leHBvcnRzX18uQ09NUElMRVJfUkVWSVNJT04gPSBDT01QSUxFUl9SRVZJU0lPTjsKCSAgdmFyIFJFVklTSU9OX0NIQU5HRVMgPSB7CgkgICAgMTogJzw9IDEuMC5yYy4yJywgLy8gMS4wLnJjLjIgaXMgYWN0dWFsbHkgcmV2MiBidXQgZG9lc24ndCByZXBvcnQgaXQKCSAgICAyOiAnPT0gMS4wLjAtcmMuMycsCgkgICAgMzogJz09IDEuMC4wLXJjLjQnLAoJICAgIDQ6ICc+PSAxLjAuMCcKCSAgfTsKCSAgX19leHBvcnRzX18uUkVWSVNJT05fQ0hBTkdFUyA9IFJFVklTSU9OX0NIQU5HRVM7CgkgIHZhciBpc0FycmF5ID0gVXRpbHMuaXNBcnJheSwKCSAgICAgIGlzRnVuY3Rpb24gPSBVdGlscy5pc0Z1bmN0aW9uLAoJICAgICAgdG9TdHJpbmcgPSBVdGlscy50b1N0cmluZywKCSAgICAgIG9iamVjdFR5cGUgPSAnW29iamVjdCBPYmplY3RdJzsKCQoJICBmdW5jdGlvbiBIYW5kbGViYXJzRW52aXJvbm1lbnQoaGVscGVycywgcGFydGlhbHMpIHsKCSAgICB0aGlzLmhlbHBlcnMgPSBoZWxwZXJzIHx8IHt9OwoJICAgIHRoaXMucGFydGlhbHMgPSBwYXJ0aWFscyB8fCB7fTsKCQoJICAgIHJlZ2lzdGVyRGVmYXVsdEhlbHBlcnModGhpcyk7CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5IYW5kbGViYXJzRW52aXJvbm1lbnQgPSBIYW5kbGViYXJzRW52aXJvbm1lbnQ7SGFuZGxlYmFyc0Vudmlyb25tZW50LnByb3RvdHlwZSA9IHsKCSAgICBjb25zdHJ1Y3RvcjogSGFuZGxlYmFyc0Vudmlyb25tZW50LAoJCgkgICAgbG9nZ2VyOiBsb2dnZXIsCgkgICAgbG9nOiBsb2csCgkKCSAgICByZWdpc3RlckhlbHBlcjogZnVuY3Rpb24obmFtZSwgZm4sIGludmVyc2UpIHsKCSAgICAgIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CgkgICAgICAgIGlmIChpbnZlcnNlIHx8IGZuKSB7IHRocm93IG5ldyBFeGNlcHRpb24oJ0FyZyBub3Qgc3VwcG9ydGVkIHdpdGggbXVsdGlwbGUgaGVscGVycycpOyB9CgkgICAgICAgIFV0aWxzLmV4dGVuZCh0aGlzLmhlbHBlcnMsIG5hbWUpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQoJICAgICAgICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmbjsKCSAgICAgIH0KCSAgICB9LAoJCgkgICAgcmVnaXN0ZXJQYXJ0aWFsOiBmdW5jdGlvbihuYW1lLCBzdHIpIHsKCSAgICAgIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CgkgICAgICAgIFV0aWxzLmV4dGVuZCh0aGlzLnBhcnRpYWxzLCAgbmFtZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCQoJICBmdW5jdGlvbiByZWdpc3RlckRlZmF1bHRIZWxwZXJzKGluc3RhbmNlKSB7CgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihhcmcpIHsKCSAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIk1pc3NpbmcgaGVscGVyOiAnIiArIGFyZyArICInIik7CgkgICAgICB9CgkgICAgfSk7CgkKCSAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewoJICAgICAgdmFyIGludmVyc2UgPSBvcHRpb25zLmludmVyc2UgfHwgZnVuY3Rpb24oKSB7fSwgZm4gPSBvcHRpb25zLmZuOwoJCgkgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgkKCSAgICAgIGlmKGNvbnRleHQgPT09IHRydWUpIHsKCSAgICAgICAgcmV0dXJuIGZuKHRoaXMpOwoJICAgICAgfSBlbHNlIGlmKGNvbnRleHQgPT09IGZhbHNlIHx8IGNvbnRleHQgPT0gbnVsbCkgewoJICAgICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKCSAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShjb250ZXh0KSkgewoJICAgICAgICBpZihjb250ZXh0Lmxlbmd0aCA+IDApIHsKCSAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuaGVscGVycy5lYWNoKGNvbnRleHQsIG9wdGlvbnMpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gZm4oY29udGV4dCk7CgkgICAgICB9CgkgICAgfSk7CgkKCSAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignZWFjaCcsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CgkgICAgICB2YXIgaSA9IDAsIHJldCA9ICIiLCBkYXRhOwoJCgkgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgkKCSAgICAgIGlmIChvcHRpb25zLmRhdGEpIHsKCSAgICAgICAgZGF0YSA9IGNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CgkgICAgICB9CgkKCSAgICAgIGlmKGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIGlmIChpc0FycmF5KGNvbnRleHQpKSB7CgkgICAgICAgICAgZm9yKHZhciBqID0gY29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CgkgICAgICAgICAgICBpZiAoZGF0YSkgewoJICAgICAgICAgICAgICBkYXRhLmluZGV4ID0gaTsKCSAgICAgICAgICAgICAgZGF0YS5maXJzdCA9IChpID09PSAwKTsKCSAgICAgICAgICAgICAgZGF0YS5sYXN0ICA9IChpID09PSAoY29udGV4dC5sZW5ndGgtMSkpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0ID0gcmV0ICsgZm4oY29udGV4dFtpXSwgeyBkYXRhOiBkYXRhIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBmb3IodmFyIGtleSBpbiBjb250ZXh0KSB7CgkgICAgICAgICAgICBpZihjb250ZXh0Lmhhc093blByb3BlcnR5KGtleSkpIHsKCSAgICAgICAgICAgICAgaWYoZGF0YSkgeyAKCSAgICAgICAgICAgICAgICBkYXRhLmtleSA9IGtleTsgCgkgICAgICAgICAgICAgICAgZGF0YS5pbmRleCA9IGk7CgkgICAgICAgICAgICAgICAgZGF0YS5maXJzdCA9IChpID09PSAwKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2tleV0sIHtkYXRhOiBkYXRhfSk7CgkgICAgICAgICAgICAgIGkrKzsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0KCQoJICAgICAgaWYoaSA9PT0gMCl7CgkgICAgICAgIHJldCA9IGludmVyc2UodGhpcyk7CgkgICAgICB9CgkKCSAgICAgIHJldHVybiByZXQ7CgkgICAgfSk7CgkKCSAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignaWYnLCBmdW5jdGlvbihjb25kaXRpb25hbCwgb3B0aW9ucykgewoJICAgICAgaWYgKGlzRnVuY3Rpb24oY29uZGl0aW9uYWwpKSB7IGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWwuY2FsbCh0aGlzKTsgfQoJCgkgICAgICAvLyBEZWZhdWx0IGJlaGF2aW9yIGlzIHRvIHJlbmRlciB0aGUgcG9zaXRpdmUgcGF0aCBpZiB0aGUgdmFsdWUgaXMgdHJ1dGh5IGFuZCBub3QgZW1wdHkuCgkgICAgICAvLyBUaGUgYGluY2x1ZGVaZXJvYCBvcHRpb24gbWF5IGJlIHNldCB0byB0cmVhdCB0aGUgY29uZHRpb25hbCBhcyBwdXJlbHkgbm90IGVtcHR5IGJhc2VkIG9uIHRoZQoJICAgICAgLy8gYmVoYXZpb3Igb2YgaXNFbXB0eS4gRWZmZWN0aXZlbHkgdGhpcyBkZXRlcm1pbmVzIGlmIDAgaXMgaGFuZGxlZCBieSB0aGUgcG9zaXRpdmUgcGF0aCBvciBuZWdhdGl2ZS4KCSAgICAgIGlmICgoIW9wdGlvbnMuaGFzaC5pbmNsdWRlWmVybyAmJiAhY29uZGl0aW9uYWwpIHx8IFV0aWxzLmlzRW1wdHkoY29uZGl0aW9uYWwpKSB7CgkgICAgICAgIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKCSAgICAgIH0KCSAgICB9KTsKCQoJICAgIGluc3RhbmNlLnJlZ2lzdGVySGVscGVyKCd1bmxlc3MnLCBmdW5jdGlvbihjb25kaXRpb25hbCwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIGluc3RhbmNlLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb25kaXRpb25hbCwge2ZuOiBvcHRpb25zLmludmVyc2UsIGludmVyc2U6IG9wdGlvbnMuZm4sIGhhc2g6IG9wdGlvbnMuaGFzaH0pOwoJICAgIH0pOwoJCgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ3dpdGgnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgkKCSAgICAgIGlmICghVXRpbHMuaXNFbXB0eShjb250ZXh0KSkgcmV0dXJuIG9wdGlvbnMuZm4oY29udGV4dCk7CgkgICAgfSk7CgkKCSAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignbG9nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewoJICAgICAgdmFyIGxldmVsID0gb3B0aW9ucy5kYXRhICYmIG9wdGlvbnMuZGF0YS5sZXZlbCAhPSBudWxsID8gcGFyc2VJbnQob3B0aW9ucy5kYXRhLmxldmVsLCAxMCkgOiAxOwoJICAgICAgaW5zdGFuY2UubG9nKGxldmVsLCBjb250ZXh0KTsKCSAgICB9KTsKCSAgfQoJCgkgIHZhciBsb2dnZXIgPSB7CgkgICAgbWV0aG9kTWFwOiB7IDA6ICdkZWJ1ZycsIDE6ICdpbmZvJywgMjogJ3dhcm4nLCAzOiAnZXJyb3InIH0sCgkKCSAgICAvLyBTdGF0ZSBlbnVtCgkgICAgREVCVUc6IDAsCgkgICAgSU5GTzogMSwKCSAgICBXQVJOOiAyLAoJICAgIEVSUk9SOiAzLAoJICAgIGxldmVsOiAzLAoJCgkgICAgLy8gY2FuIGJlIG92ZXJyaWRkZW4gaW4gdGhlIGhvc3QgZW52aXJvbm1lbnQKCSAgICBsb2c6IGZ1bmN0aW9uKGxldmVsLCBvYmopIHsKCSAgICAgIGlmIChsb2dnZXIubGV2ZWwgPD0gbGV2ZWwpIHsKCSAgICAgICAgdmFyIG1ldGhvZCA9IGxvZ2dlci5tZXRob2RNYXBbbGV2ZWxdOwoJICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGVbbWV0aG9kXSkgewoJICAgICAgICAgIGNvbnNvbGVbbWV0aG9kXS5jYWxsKGNvbnNvbGUsIG9iaik7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgkgIF9fZXhwb3J0c19fLmxvZ2dlciA9IGxvZ2dlcjsKCSAgZnVuY3Rpb24gbG9nKGxldmVsLCBvYmopIHsgbG9nZ2VyLmxvZyhsZXZlbCwgb2JqKTsgfQoJCgkgIF9fZXhwb3J0c19fLmxvZyA9IGxvZzt2YXIgY3JlYXRlRnJhbWUgPSBmdW5jdGlvbihvYmplY3QpIHsKCSAgICB2YXIgb2JqID0ge307CgkgICAgVXRpbHMuZXh0ZW5kKG9iaiwgb2JqZWN0KTsKCSAgICByZXR1cm4gb2JqOwoJICB9OwoJICBfX2V4cG9ydHNfXy5jcmVhdGVGcmFtZSA9IGNyZWF0ZUZyYW1lOwoJICByZXR1cm4gX19leHBvcnRzX187Cgl9KShfX21vZHVsZTJfXywgX19tb2R1bGU0X18pOwoJCgkvLyBoYW5kbGViYXJzL3J1bnRpbWUuanMKCXZhciBfX21vZHVsZTVfXyA9IChmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZGVwZW5kZW5jeTJfXywgX19kZXBlbmRlbmN5M19fKSB7CgkgICJ1c2Ugc3RyaWN0IjsKCSAgdmFyIF9fZXhwb3J0c19fID0ge307CgkgIHZhciBVdGlscyA9IF9fZGVwZW5kZW5jeTFfXzsKCSAgdmFyIEV4Y2VwdGlvbiA9IF9fZGVwZW5kZW5jeTJfXzsKCSAgdmFyIENPTVBJTEVSX1JFVklTSU9OID0gX19kZXBlbmRlbmN5M19fLkNPTVBJTEVSX1JFVklTSU9OOwoJICB2YXIgUkVWSVNJT05fQ0hBTkdFUyA9IF9fZGVwZW5kZW5jeTNfXy5SRVZJU0lPTl9DSEFOR0VTOwoJCgkgIGZ1bmN0aW9uIGNoZWNrUmV2aXNpb24oY29tcGlsZXJJbmZvKSB7CgkgICAgdmFyIGNvbXBpbGVyUmV2aXNpb24gPSBjb21waWxlckluZm8gJiYgY29tcGlsZXJJbmZvWzBdIHx8IDEsCgkgICAgICAgIGN1cnJlbnRSZXZpc2lvbiA9IENPTVBJTEVSX1JFVklTSU9OOwoJCgkgICAgaWYgKGNvbXBpbGVyUmV2aXNpb24gIT09IGN1cnJlbnRSZXZpc2lvbikgewoJICAgICAgaWYgKGNvbXBpbGVyUmV2aXNpb24gPCBjdXJyZW50UmV2aXNpb24pIHsKCSAgICAgICAgdmFyIHJ1bnRpbWVWZXJzaW9ucyA9IFJFVklTSU9OX0NIQU5HRVNbY3VycmVudFJldmlzaW9uXSwKCSAgICAgICAgICAgIGNvbXBpbGVyVmVyc2lvbnMgPSBSRVZJU0lPTl9DSEFOR0VTW2NvbXBpbGVyUmV2aXNpb25dOwoJICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUZW1wbGF0ZSB3YXMgcHJlY29tcGlsZWQgd2l0aCBhbiBvbGRlciB2ZXJzaW9uIG9mIEhhbmRsZWJhcnMgdGhhbiB0aGUgY3VycmVudCBydW50aW1lLiAiKwoJICAgICAgICAgICAgICAiUGxlYXNlIHVwZGF0ZSB5b3VyIHByZWNvbXBpbGVyIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitydW50aW1lVmVyc2lvbnMrIikgb3IgZG93bmdyYWRlIHlvdXIgcnVudGltZSB0byBhbiBvbGRlciB2ZXJzaW9uICgiK2NvbXBpbGVyVmVyc2lvbnMrIikuIik7CgkgICAgICB9IGVsc2UgewoJICAgICAgICAvLyBVc2UgdGhlIGVtYmVkZGVkIHZlcnNpb24gaW5mbyBzaW5jZSB0aGUgcnVudGltZSBkb2Vzbid0IGtub3cgYWJvdXQgdGhpcyByZXZpc2lvbiB5ZXQKCSAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiVGVtcGxhdGUgd2FzIHByZWNvbXBpbGVkIHdpdGggYSBuZXdlciB2ZXJzaW9uIG9mIEhhbmRsZWJhcnMgdGhhbiB0aGUgY3VycmVudCBydW50aW1lLiAiKwoJICAgICAgICAgICAgICAiUGxlYXNlIHVwZGF0ZSB5b3VyIHJ1bnRpbWUgdG8gYSBuZXdlciB2ZXJzaW9uICgiK2NvbXBpbGVySW5mb1sxXSsiKS4iKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5jaGVja1JldmlzaW9uID0gY2hlY2tSZXZpc2lvbjsvLyBUT0RPOiBSZW1vdmUgdGhpcyBsaW5lIGFuZCBicmVhayB1cCBjb21waWxlUGFydGlhbAoJCgkgIGZ1bmN0aW9uIHRlbXBsYXRlKHRlbXBsYXRlU3BlYywgZW52KSB7CgkgICAgaWYgKCFlbnYpIHsKCSAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIk5vIGVudmlyb25tZW50IHBhc3NlZCB0byB0ZW1wbGF0ZSIpOwoJICAgIH0KCQoJICAgIC8vIE5vdGU6IFVzaW5nIGVudi5WTSByZWZlcmVuY2VzIHJhdGhlciB0aGFuIGxvY2FsIHZhciByZWZlcmVuY2VzIHRocm91Z2hvdXQgdGhpcyBzZWN0aW9uIHRvIGFsbG93CgkgICAgLy8gZm9yIGV4dGVybmFsIHVzZXJzIHRvIG92ZXJyaWRlIHRoZXNlIGFzIHBzdWVkby1zdXBwb3J0ZWQgQVBJcy4KCSAgICB2YXIgaW52b2tlUGFydGlhbFdyYXBwZXIgPSBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewoJICAgICAgdmFyIHJlc3VsdCA9IGVudi5WTS5pbnZva2VQYXJ0aWFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsgcmV0dXJuIHJlc3VsdDsgfQoJCgkgICAgICBpZiAoZW52LmNvbXBpbGUpIHsKCSAgICAgICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoJICAgICAgICBwYXJ0aWFsc1tuYW1lXSA9IGVudi5jb21waWxlKHBhcnRpYWwsIHsgZGF0YTogZGF0YSAhPT0gdW5kZWZpbmVkIH0sIGVudik7CgkgICAgICAgIHJldHVybiBwYXJ0aWFsc1tuYW1lXShjb250ZXh0LCBvcHRpb25zKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgY29tcGlsZWQgd2hlbiBydW5uaW5nIGluIHJ1bnRpbWUtb25seSBtb2RlIik7CgkgICAgICB9CgkgICAgfTsKCQoJICAgIC8vIEp1c3QgYWRkIHdhdGVyCgkgICAgdmFyIGNvbnRhaW5lciA9IHsKCSAgICAgIGVzY2FwZUV4cHJlc3Npb246IFV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCgkgICAgICBpbnZva2VQYXJ0aWFsOiBpbnZva2VQYXJ0aWFsV3JhcHBlciwKCSAgICAgIHByb2dyYW1zOiBbXSwKCSAgICAgIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CgkgICAgICAgIHZhciBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV07CgkgICAgICAgIGlmKGRhdGEpIHsKCSAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHByb2dyYW0oaSwgZm4sIGRhdGEpOwoJICAgICAgICB9IGVsc2UgaWYgKCFwcm9ncmFtV3JhcHBlcikgewoJICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IHByb2dyYW0oaSwgZm4pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKCSAgICAgIH0sCgkgICAgICBtZXJnZTogZnVuY3Rpb24ocGFyYW0sIGNvbW1vbikgewoJICAgICAgICB2YXIgcmV0ID0gcGFyYW0gfHwgY29tbW9uOwoJCgkgICAgICAgIGlmIChwYXJhbSAmJiBjb21tb24gJiYgKHBhcmFtICE9PSBjb21tb24pKSB7CgkgICAgICAgICAgcmV0ID0ge307CgkgICAgICAgICAgVXRpbHMuZXh0ZW5kKHJldCwgY29tbW9uKTsKCSAgICAgICAgICBVdGlscy5leHRlbmQocmV0LCBwYXJhbSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHJldDsKCSAgICAgIH0sCgkgICAgICBwcm9ncmFtV2l0aERlcHRoOiBlbnYuVk0ucHJvZ3JhbVdpdGhEZXB0aCwKCSAgICAgIG5vb3A6IGVudi5WTS5ub29wLAoJICAgICAgY29tcGlsZXJJbmZvOiBudWxsCgkgICAgfTsKCQoJICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgIHZhciBuYW1lc3BhY2UgPSBvcHRpb25zLnBhcnRpYWwgPyBvcHRpb25zIDogZW52LAoJICAgICAgICAgIGhlbHBlcnMsCgkgICAgICAgICAgcGFydGlhbHM7CgkKCSAgICAgIGlmICghb3B0aW9ucy5wYXJ0aWFsKSB7CgkgICAgICAgIGhlbHBlcnMgPSBvcHRpb25zLmhlbHBlcnM7CgkgICAgICAgIHBhcnRpYWxzID0gb3B0aW9ucy5wYXJ0aWFsczsKCSAgICAgIH0KCSAgICAgIHZhciByZXN1bHQgPSB0ZW1wbGF0ZVNwZWMuY2FsbCgKCSAgICAgICAgICAgIGNvbnRhaW5lciwKCSAgICAgICAgICAgIG5hbWVzcGFjZSwgY29udGV4dCwKCSAgICAgICAgICAgIGhlbHBlcnMsCgkgICAgICAgICAgICBwYXJ0aWFscywKCSAgICAgICAgICAgIG9wdGlvbnMuZGF0YSk7CgkKCSAgICAgIGlmICghb3B0aW9ucy5wYXJ0aWFsKSB7CgkgICAgICAgIGVudi5WTS5jaGVja1JldmlzaW9uKGNvbnRhaW5lci5jb21waWxlckluZm8pOwoJICAgICAgfQoJCgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH0KCQoJICBfX2V4cG9ydHNfXy50ZW1wbGF0ZSA9IHRlbXBsYXRlO2Z1bmN0aW9uIHByb2dyYW1XaXRoRGVwdGgoaSwgZm4sIGRhdGEgLyosICRkZXB0aCAqLykgewoJICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKCQoJICAgIHZhciBwcm9nID0gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkKCSAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBbY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGFdLmNvbmNhdChhcmdzKSk7CgkgICAgfTsKCSAgICBwcm9nLnByb2dyYW0gPSBpOwoJICAgIHByb2cuZGVwdGggPSBhcmdzLmxlbmd0aDsKCSAgICByZXR1cm4gcHJvZzsKCSAgfQoJCgkgIF9fZXhwb3J0c19fLnByb2dyYW1XaXRoRGVwdGggPSBwcm9ncmFtV2l0aERlcHRoO2Z1bmN0aW9uIHByb2dyYW0oaSwgZm4sIGRhdGEpIHsKCSAgICB2YXIgcHJvZyA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCgkgICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwoJICAgIH07CgkgICAgcHJvZy5wcm9ncmFtID0gaTsKCSAgICBwcm9nLmRlcHRoID0gMDsKCSAgICByZXR1cm4gcHJvZzsKCSAgfQoJCgkgIF9fZXhwb3J0c19fLnByb2dyYW0gPSBwcm9ncmFtO2Z1bmN0aW9uIGludm9rZVBhcnRpYWwocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKCSAgICB2YXIgb3B0aW9ucyA9IHsgcGFydGlhbDogdHJ1ZSwgaGVscGVyczogaGVscGVycywgcGFydGlhbHM6IHBhcnRpYWxzLCBkYXRhOiBkYXRhIH07CgkKCSAgICBpZihwYXJ0aWFsID09PSB1bmRlZmluZWQpIHsKCSAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKCSAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CgkgICAgICByZXR1cm4gcGFydGlhbChjb250ZXh0LCBvcHRpb25zKTsKCSAgICB9CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5pbnZva2VQYXJ0aWFsID0gaW52b2tlUGFydGlhbDtmdW5jdGlvbiBub29wKCkgeyByZXR1cm4gIiI7IH0KCQoJICBfX2V4cG9ydHNfXy5ub29wID0gbm9vcDsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoX19tb2R1bGUyX18sIF9fbW9kdWxlNF9fLCBfX21vZHVsZTFfXyk7CgkKCS8vIGhhbmRsZWJhcnMucnVudGltZS5qcwoJdmFyIF9fbW9kdWxlMF9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZGVwZW5kZW5jeTRfXywgX19kZXBlbmRlbmN5NV9fKSB7CgkgICJ1c2Ugc3RyaWN0IjsKCSAgdmFyIF9fZXhwb3J0c19fOwoJICAvKmdsb2JhbHMgSGFuZGxlYmFyczogdHJ1ZSAqLwoJICB2YXIgYmFzZSA9IF9fZGVwZW5kZW5jeTFfXzsKCQoJICAvLyBFYWNoIG9mIHRoZXNlIGF1Z21lbnQgdGhlIEhhbmRsZWJhcnMgb2JqZWN0LiBObyBuZWVkIHRvIHNldHVwIGhlcmUuCgkgIC8vIChUaGlzIGlzIGRvbmUgdG8gZWFzaWx5IHNoYXJlIGNvZGUgYmV0d2VlbiBjb21tb25qcyBhbmQgYnJvd3NlIGVudnMpCgkgIHZhciBTYWZlU3RyaW5nID0gX19kZXBlbmRlbmN5Ml9fOwoJICB2YXIgRXhjZXB0aW9uID0gX19kZXBlbmRlbmN5M19fOwoJICB2YXIgVXRpbHMgPSBfX2RlcGVuZGVuY3k0X187CgkgIHZhciBydW50aW1lID0gX19kZXBlbmRlbmN5NV9fOwoJCgkgIC8vIEZvciBjb21wYXRpYmlsaXR5IGFuZCB1c2FnZSBvdXRzaWRlIG9mIG1vZHVsZSBzeXN0ZW1zLCBtYWtlIHRoZSBIYW5kbGViYXJzIG9iamVjdCBhIG5hbWVzcGFjZQoJICB2YXIgY3JlYXRlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGhiID0gbmV3IGJhc2UuSGFuZGxlYmFyc0Vudmlyb25tZW50KCk7CgkKCSAgICBVdGlscy5leHRlbmQoaGIsIGJhc2UpOwoJICAgIGhiLlNhZmVTdHJpbmcgPSBTYWZlU3RyaW5nOwoJICAgIGhiLkV4Y2VwdGlvbiA9IEV4Y2VwdGlvbjsKCSAgICBoYi5VdGlscyA9IFV0aWxzOwoJCgkgICAgaGIuVk0gPSBydW50aW1lOwoJICAgIGhiLnRlbXBsYXRlID0gZnVuY3Rpb24oc3BlYykgewoJICAgICAgcmV0dXJuIHJ1bnRpbWUudGVtcGxhdGUoc3BlYywgaGIpOwoJICAgIH07CgkKCSAgICByZXR1cm4gaGI7CgkgIH07CgkKCSAgdmFyIEhhbmRsZWJhcnMgPSBjcmVhdGUoKTsKCSAgSGFuZGxlYmFycy5jcmVhdGUgPSBjcmVhdGU7CgkKCSAgX19leHBvcnRzX18gPSBIYW5kbGViYXJzOwoJICByZXR1cm4gX19leHBvcnRzX187Cgl9KShfX21vZHVsZTFfXywgX19tb2R1bGUzX18sIF9fbW9kdWxlNF9fLCBfX21vZHVsZTJfXywgX19tb2R1bGU1X18pOwoJCgkgIHJldHVybiBfX21vZHVsZTBfXzsKCX0pKCk7CgkvLyBqc2hpbnQgaWdub3JlOnN0YXJ0CglVdGlsLkhhbmRsZWJhcnMgPSBIYW5kbGViYXJzOwoJLy8ganNoaW50IGlnbm9yZTplbmQKCS8vIGNoYW5nZSAidGhpcyIgdG8gYSBjdXN0b20gc2NvcGUgdGhhdCBoYXMgXyBhbmQgJC4KCXZhciBCYWNrYm9uZSA9IFV0aWwuQmFja2JvbmUgPSAoZnVuY3Rpb24oKSB7CgkJLy8gICAgIEJhY2tib25lLmpzIDEuMS4yCgkJCgkJLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKCQkvLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgkJLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKCQkvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgkJCgkJKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCQkKCQkgIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgoJCSAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewoJCSAgICBkZWZpbmUoWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKCQkgICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAoJCSAgICAgIC8vIG90aGVycyB0aGF0IG1heSBzdGlsbCBleHBlY3QgYSBnbG9iYWwgQmFja2JvbmUuCgkJICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CgkJICAgIH0pOwoJCQoJCSAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgoJCSAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkgICAgdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgkJICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgkJCgkJICAvLyBGaW5hbGx5LCBhcyBhIGJyb3dzZXIgZ2xvYmFsLgoJCSAgfSBlbHNlIHsKCQkgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKCQkgIH0KCQkKCQl9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgkJCgkJICAvLyBJbml0aWFsIFNldHVwCgkJICAvLyAtLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKCQkgIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KCQkgIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCQkKCQkgIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCgkJICB2YXIgYXJyYXkgPSBbXTsKCQkgIHZhciBwdXNoID0gYXJyYXkucHVzaDsKCQkgIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwoJCSAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCQkKCQkgIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCgkJICBCYWNrYm9uZS5WRVJTSU9OID0gJzEuMS4yJzsKCQkKCQkgIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwoJCSAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KCQkgIEJhY2tib25lLiQgPSAkOwoJCQoJCSAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCgkJICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCgkJICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkJICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwoJCSAgICByZXR1cm4gdGhpczsKCQkgIH07CgkJCgkJICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCgkJICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKCQkgIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCgkJICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoJCQoJCSAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CgkJICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCgkJICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKCQkgIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KCQkgIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgkJCgkJICAvLyBCYWNrYm9uZS5FdmVudHMKCQkgIC8vIC0tLS0tLS0tLS0tLS0tLQoJCQoJCSAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAoJCSAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawoJCSAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KCQkgIC8vIHN1Y2Nlc3Npb24uCgkJICAvLwoJCSAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKCQkgIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CgkJICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CgkJICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwoJCSAgLy8KCQkgIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgkJCgkJICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gYSBgY2FsbGJhY2tgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kCgkJICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgoJCSAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCQkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwoJCSAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwoJCSAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKCQkgICAgICBldmVudHMucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBjb250ZXh0OiBjb250ZXh0LCBjdHg6IGNvbnRleHQgfHwgdGhpc30pOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCgkJICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCgkJICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwoJCSAgICAgIHZhciBzZWxmID0gdGhpczsKCQkgICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKCQkgICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwoJCSAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgICAgICB9KTsKCQkgICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwoJCSAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCQkgICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAoJCSAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCgkJICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KCQkgICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCSAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwoJCSAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKCQkgICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CgkJICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CgkJICAgICAgICByZXR1cm4gdGhpczsKCQkgICAgICB9CgkJICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CgkJICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwoJCSAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewoJCSAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKCQkgICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKCQkgICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewoJCSAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CgkJICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2suX2NhbGxiYWNrKSB8fAoJCSAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CgkJICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKCQkgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICB9CgkJICAgICAgICAgIH0KCQkgICAgICAgICAgaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwoJCSAgICAgICAgfQoJCSAgICAgIH0KCQkKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCgkJICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCgkJICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KCQkgICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgoJCSAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkJICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwoJCSAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwoJCSAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CgkJICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CgkJICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwoJCSAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCgkJICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCgkJICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCQkgICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKCQkgICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKCQkgICAgICB2YXIgcmVtb3ZlID0gIW5hbWUgJiYgIWNhbGxiYWNrOwoJCSAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkJICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwoJCSAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CgkJICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CgkJICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCQkgICAgICAgIGlmIChyZW1vdmUgfHwgXy5pc0VtcHR5KG9iai5fZXZlbnRzKSkgZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKCQkgICAgICB9CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0KCQkKCQkgIH07CgkJCgkJICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgoJCSAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCQkKCQkgIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CgkJICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAoJCSAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KCQkgIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewoJCSAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoJCQoJCSAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KCQkgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewoJCSAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkJICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKCQkgICAgICB9CgkJICAgICAgcmV0dXJuIGZhbHNlOwoJCSAgICB9CgkJCgkJICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCgkJICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKCQkgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoJCSAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKCQkgICAgICB9CgkJICAgICAgcmV0dXJuIGZhbHNlOwoJCSAgICB9CgkJCgkJICAgIHJldHVybiB0cnVlOwoJCSAgfTsKCQkKCQkgIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCgkJICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCgkJICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCgkJICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewoJCSAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CgkJICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKCQkgICAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwoJCSAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwoJCSAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKCQkgICAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwoJCSAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKCQkgICAgfQoJCSAgfTsKCQkKCQkgIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgkJCgkJICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwoJCSAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwoJCSAgLy8gbGlzdGVuaW5nIHRvLgoJCSAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKCQkgICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkJICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG8gfHwgKHRoaXMuX2xpc3RlbmluZ1RvID0ge30pOwoJCSAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwoJCSAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKCQkgICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJCSAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9OwoJCSAgfSk7CgkJCgkJICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCQkgIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CgkJICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCQkKCQkgIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KCQkgIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KCQkgIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoJCQoJCSAgLy8gQmFja2JvbmUuTW9kZWwKCQkgIC8vIC0tLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQoJCSAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgoJCSAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgoJCSAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgkJCgkJICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKCQkgIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgoJCSAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CgkJICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CgkJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwoJCSAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKCQkgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwoJCSAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKCQkgICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwoJCSAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CgkJICAgIHRoaXMuY2hhbmdlZCA9IHt9OwoJCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgIH07CgkJCgkJICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KCQkgIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgkJCgkJICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KCQkgICAgY2hhbmdlZDogbnVsbCwKCQkKCQkgICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KCQkgICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoJCQoJCSAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCgkJICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KCQkgICAgaWRBdHRyaWJ1dGU6ICdpZCcsCgkJCgkJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCQkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoJCQoJCSAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCgkJICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCgkJICAgIC8vIGN1c3RvbSBzeW5jaW5nIHNlbWFudGljcyBmb3IgKnRoaXMqIHBhcnRpY3VsYXIgbW9kZWwuCgkJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgoJCSAgICBnZXQ6IGZ1bmN0aW9uKGF0dHIpIHsKCQkgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCgkJICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewoJCSAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBhdHRyaWJ1dGUgY29udGFpbnMgYSB2YWx1ZSB0aGF0IGlzIG5vdCBudWxsCgkJICAgIC8vIG9yIHVuZGVmaW5lZC4KCQkgICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuZ2V0KGF0dHIpICE9IG51bGw7CgkJICAgIH0sCgkJCgkJICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYC4gVGhpcyBpcwoJCSAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKCQkgICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCgkJICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKCQkgICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwoJCSAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgkJCgkJICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCgkJICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CgkJICAgICAgICBhdHRycyA9IGtleTsKCQkgICAgICAgIG9wdGlvbnMgPSB2YWw7CgkJICAgICAgfSBlbHNlIHsKCQkgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwoJCSAgICAgIH0KCQkKCQkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCQoJCSAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgoJCSAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkJCgkJICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgoJCSAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CgkJICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CgkJICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CgkJICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CgkJICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCQkKCQkgICAgICBpZiAoIWNoYW5naW5nKSB7CgkJICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkJICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKCQkgICAgICB9CgkJICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCQkKCQkgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgoJCSAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgkJCgkJICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgoJCSAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewoJCSAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgkJICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBjaGFuZ2VzLnB1c2goYXR0cik7CgkJICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CgkJICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKCQkgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CgkJICAgICAgICB9CgkJICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKCQkgICAgICB9CgkJCgkJICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCgkJICAgICAgaWYgKCFzaWxlbnQpIHsKCQkgICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CgkJICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoYW5nZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJCgkJICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgoJCSAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCgkJICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCQkgICAgICBpZiAoIXNpbGVudCkgewoJCSAgICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKCQkgICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CgkJICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKCQkgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwoJCSAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAoJCSAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCgkJICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KCQkgICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICB2YXIgYXR0cnMgPSB7fTsKCQkgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwoJCSAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgoJCSAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgoJCSAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CgkJICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKCQkgICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKCQkgICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CgkJICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCgkJICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KCQkgICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKCQkgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KCQkgICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKCQkgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwoJCSAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKCQkgICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CgkJICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CgkJICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CgkJICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CgkJICAgICAgfQoJCSAgICAgIHJldHVybiBjaGFuZ2VkOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKCQkgICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCgkJICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CgkJICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKCQkgICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKCQkgICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KCQkgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKCQkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCgkJICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKCQkgICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCgkJICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCQkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCQkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkJICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCQkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgfTsKCQkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkJICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgoJCSAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKCQkgICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KCQkgICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKCQkgICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoJCQoJCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJCSAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJCSAgICAgICAgYXR0cnMgPSBrZXk7CgkJICAgICAgICBvcHRpb25zID0gdmFsOwoJCSAgICAgIH0gZWxzZSB7CgkJICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKCQkgICAgICB9CgkJCgkJICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoJCQoJCSAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKCQkgICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgoJCSAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KCQkgICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewoJCSAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCQkgICAgICB9IGVsc2UgewoJCSAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCQkgICAgICB9CgkJCgkJICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgoJCSAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKCQkgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQoJCSAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCgkJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCQkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCQkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkJICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgoJCSAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgkJICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKCQkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKCQkgICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewoJCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgIH07CgkJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoJCQoJCSAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwoJCSAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKCQkgICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCQkKCQkgICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCgkJICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCQkKCQkgICAgICByZXR1cm4geGhyOwoJCSAgICB9LAoJCQoJCSAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCgkJICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCgkJICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCgkJICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCQkgICAgICB2YXIgbW9kZWwgPSB0aGlzOwoJCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJCQoJCSAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkJICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwoJCSAgICAgIH07CgkJCgkJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewoJCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CgkJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgfTsKCQkKCQkgICAgICBpZiAodGhpcy5pc05ldygpKSB7CgkJICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKCQkgICAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgICB9CgkJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoJCQoJCSAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CgkJICAgICAgcmV0dXJuIHhocjsKCQkgICAgfSwKCQkKCQkgICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCgkJICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKCQkgICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KCQkgICAgdXJsOiBmdW5jdGlvbigpIHsKCQkgICAgICB2YXIgYmFzZSA9CgkJICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CgkJICAgICAgICBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fAoJCSAgICAgICAgdXJsRXJyb3IoKTsKCQkgICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKCQkgICAgICByZXR1cm4gYmFzZS5yZXBsYWNlKC8oW15cL10pJC8sICckMS8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCgkJICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KCQkgICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKCQkgICAgICByZXR1cm4gcmVzcDsKCQkgICAgfSwKCQkKCQkgICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCgkJICAgIGNsb25lOiBmdW5jdGlvbigpIHsKCQkgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgoJCSAgICBpc05ldzogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgoJCSAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlKHt9LCBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7IHZhbGlkYXRlOiB0cnVlIH0pKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKCQkgICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgoJCSAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CgkJICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKCQkgICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKCQkgICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CgkJICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CgkJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwoJCSAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfQoJCQoJCSAgfSk7CgkJCgkJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCgkJICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgkJCgkJICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KCQkgIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewoJCSAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJCSAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwoJCSAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwoJCSAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CgkJICAgIH07CgkJICB9KTsKCQkKCQkgIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KCQkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCQkKCQkgIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCgkJICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKCQkgIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgoJCSAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwoJCSAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KCQkgIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgoJCQoJCSAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCgkJICAvLyBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KCQkgIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KCQkgIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCSAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CgkJICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwoJCSAgICB0aGlzLl9yZXNldCgpOwoJCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CgkJICB9OwoJCQoJCSAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgoJCSAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKCQkgIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiBmYWxzZX07CgkJCgkJICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgoJCSAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoJCQoJCSAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCgkJICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KCQkgICAgbW9kZWw6IE1vZGVsLAoJCQoJCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCQkKCQkgICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQoJCSAgICAvLyBtb2RlbHMnIGF0dHJpYnV0ZXMuCgkJICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwoJCSAgICB9LAoJCQoJCSAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KCQkgICAgc3luYzogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCgkJICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoe21lcmdlOiBmYWxzZX0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmVtb3ZlIGEgbW9kZWwsIG9yIGEgbGlzdCBvZiBtb2RlbHMgZnJvbSB0aGUgc2V0LgoJCSAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJCSAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKCQkgICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IFttb2RlbHNdIDogXy5jbG9uZShtb2RlbHMpOwoJCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKCQkgICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwoJCSAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CgkJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwoJCSAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwoJCSAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoLS07CgkJICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkJICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKCQkgICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICAgICAgfQoJCSAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICB9CgkJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAoJCSAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CgkJICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAoJCSAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KCQkgICAgc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCQkgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CgkJICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKCQkgICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CgkJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CgkJICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwoJCSAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CgkJICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKCQkgICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CgkJICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKCQkgICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCQkgICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CgkJICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwoJCQoJCSAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKCQkgICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgoJCSAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKCQkgICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CgkJICAgICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKCQkgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlIHx8ICdpZCddOwoJCSAgICAgICAgfQoJCQoJCSAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKCQkgICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCgkJICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKCQkgICAgICAgICAgaWYgKHJlbW92ZSkgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CgkJICAgICAgICAgIGlmIChtZXJnZSkgewoJCSAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwoJCSAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IGV4aXN0aW5nLnBhcnNlKGF0dHJzLCBvcHRpb25zKTsKCQkgICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJCSAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CgkJICAgICAgICAgIH0KCQkgICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgkJCgkJICAgICAgICAvLyBJZiB0aGlzIGlzIGEgbmV3LCB2YWxpZCBtb2RlbCwgcHVzaCBpdCB0byB0aGUgYHRvQWRkYCBsaXN0LgoJCSAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKCQkgICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwoJCSAgICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKCQkgICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgkJICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CgkJICAgICAgICB9CgkJCgkJICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCgkJICAgICAgICBtb2RlbCA9IGV4aXN0aW5nIHx8IG1vZGVsOwoJCSAgICAgICAgaWYgKG9yZGVyICYmIChtb2RlbC5pc05ldygpIHx8ICFtb2RlbE1hcFttb2RlbC5pZF0pKSBvcmRlci5wdXNoKG1vZGVsKTsKCQkgICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCgkJICAgICAgaWYgKHJlbW92ZSkgewoJCSAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CgkJICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCgkJICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewoJCSAgICAgICAgaWYgKHNvcnRhYmxlKSBzb3J0ID0gdHJ1ZTsKCQkgICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKCQkgICAgICAgIGlmIChhdCAhPSBudWxsKSB7CgkJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkgICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CgkJICAgICAgICAgIH0KCQkgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKCQkgICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKCQkgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9yZGVyZWRNb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKCQkgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBTaWxlbnRseSBzb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLgoJCSAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoJCQoJCSAgICAgIC8vIFVubGVzcyBzaWxlbmNlZCwgaXQncyB0aW1lIHRvIGZpcmUgYWxsIGFwcHJvcHJpYXRlIGFkZC9zb3J0IGV2ZW50cy4KCQkgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkJICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICAgIChtb2RlbCA9IHRvQWRkW2ldKS50cmlnZ2VyKCdhZGQnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCgkJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKCQkgICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwoJCSAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCgkJICAgIC8vIFVzZWZ1bCBmb3IgYnVsayBvcGVyYXRpb25zIGFuZCBvcHRpbWl6YXRpb25zLgoJCSAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQkgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKCQkgICAgICB9CgkJICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwoJCSAgICAgIHRoaXMuX3Jlc2V0KCk7CgkJICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJCSAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gbW9kZWxzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJCSAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJCSAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJCSAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CgkJICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJCSAgICAgIHJldHVybiBtb2RlbDsKCQkgICAgfSwKCQkKCQkgICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KCQkgICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgoJCSAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CgkJICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJCSAgICAgIHJldHVybiBtb2RlbDsKCQkgICAgfSwKCQkKCQkgICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgoJCSAgICBzbGljZTogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIHNsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmd1bWVudHMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCgkJICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CgkJICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJCSAgICAgIHJldHVybiB0aGlzLl9ieUlkW29ial0gfHwgdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF07CgkJICAgIH0sCgkJCgkJICAgIC8vIEdldCB0aGUgbW9kZWwgYXQgdGhlIGdpdmVuIGluZGV4LgoJCSAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKCQkgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKCQkgICAgLy8gYGZpbHRlcmAuCgkJICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKCQkgICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CgkJICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24obW9kZWwpIHsKCQkgICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewoJCSAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiB0cnVlOwoJCSAgICAgIH0pOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKCQkgICAgLy8gb2YgYGZpbmRgLgoJCSAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CgkJICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCgkJICAgIC8vIG5vcm1hbCBjaXJjdW1zdGFuY2VzLCBhcyB0aGUgc2V0IHdpbGwgbWFpbnRhaW4gc29ydCBvcmRlciBhcyBlYWNoIGl0ZW0KCQkgICAgLy8gaXMgYWRkZWQuCgkJICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICBpZiAoIXRoaXMuY29tcGFyYXRvcikgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwoJCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJCgkJICAgICAgLy8gUnVuIHNvcnQgYmFzZWQgb24gdHlwZSBvZiBgY29tcGFyYXRvcmAuCgkJICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CgkJICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CgkJICAgICAgfSBlbHNlIHsKCQkgICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwoJCSAgICAgIH0KCQkKCQkgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KCQkgICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKCQkgICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCgkJICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQoJCSAgICAvLyBkYXRhIHdpbGwgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGByZXNldGAgbWV0aG9kIGluc3RlYWQgb2YgYHNldGAuCgkJICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkJICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwoJCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCQkgICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwoJCSAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKCQkgICAgICB9OwoJCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKCQkgICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKCQkgICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KCQkgICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJCSAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpIHJldHVybiBmYWxzZTsKCQkgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwoJCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCQkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCQkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCkgewoJCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwoJCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgIH07CgkJICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gbW9kZWw7CgkJICAgIH0sCgkJCgkJICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKCQkgICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCgkJICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHJlc3A7CgkJICAgIH0sCgkJCgkJICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgoJCSAgICBjbG9uZTogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgoJCSAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KCQkgICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQkgICAgICB0aGlzLmxlbmd0aCA9IDA7CgkJICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKCQkgICAgICB0aGlzLl9ieUlkICA9IHt9OwoJCSAgICB9LAoJCQoJCSAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwoJCSAgICAvLyBjb2xsZWN0aW9uLgoJCSAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewoJCSAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CgkJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkJICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKCQkgICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CgkJICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKCQkgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBtb2RlbC52YWxpZGF0aW9uRXJyb3IsIG9wdGlvbnMpOwoJCSAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfSwKCQkKCQkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCgkJICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJICAgICAgdGhpcy5fYnlJZFttb2RlbC5jaWRdID0gbW9kZWw7CgkJICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CgkJICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKSBtb2RlbC5jb2xsZWN0aW9uID0gdGhpczsKCQkgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldmVyIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KCQkgICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQkgICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CgkJICAgICAgbW9kZWwub2ZmKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBJbnRlcm5hbCBtZXRob2QgY2FsbGVkIGV2ZXJ5IHRpbWUgYSBtb2RlbCBpbiB0aGUgc2V0IGZpcmVzIGFuIGV2ZW50LgoJCSAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCgkJICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQoJCSAgICAvLyBpbiBvdGhlciBjb2xsZWN0aW9ucyBhcmUgaWdub3JlZC4KCQkgICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CgkJICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CgkJICAgICAgaWYgKGV2ZW50ID09PSAnZGVzdHJveScpIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CgkJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwoJCSAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CgkJICAgICAgfQoJCSAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCSAgICB9CgkJCgkJICB9KTsKCQkKCQkgIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgoJCSAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKCQkgIC8vIHJpZ2h0IGhlcmU6CgkJICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCgkJICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCgkJICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKCQkgICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAoJCSAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCgkJICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5JywgJ2NoYWluJywgJ3NhbXBsZSddOwoJCQoJCSAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgoJCSAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewoJCSAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CgkJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CgkJICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKCQkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJCSAgICB9OwoJCSAgfSk7CgkJCgkJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KCQkgIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5JywgJ2luZGV4QnknXTsKCQkKCQkgIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KCQkgIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCQkgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CgkJICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKCQkgICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwoJCSAgICAgIH07CgkJICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwoJCSAgICB9OwoJCSAgfSk7CgkJCgkJICAvLyBCYWNrYm9uZS5WaWV3CgkJICAvLyAtLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBCYWNrYm9uZSBWaWV3cyBhcmUgYWxtb3N0IG1vcmUgY29udmVudGlvbiB0aGFuIHRoZXkgYXJlIGFjdHVhbCBjb2RlLiBBIFZpZXcKCQkgIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCgkJICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKCQkgIC8vIGV2ZW4gdGhlIHN1cnJvdW5kaW5nIGZyYW1lIHdoaWNoIHdyYXBzIHlvdXIgd2hvbGUgYXBwLiBEZWZpbmluZyBhIGNodW5rIG9mCgkJICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CgkJICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KCQkgIC8vIHJlYWN0IHRvIHNwZWNpZmljIGNoYW5nZXMgaW4gdGhlIHN0YXRlIG9mIHlvdXIgbW9kZWxzLgoJCQoJCSAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCgkJICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgoJCSAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKCQkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQkgICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CgkJICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKCQkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKCQkgIH07CgkJCgkJICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KCQkgIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoJCQoJCSAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCgkJICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCQkKCQkgIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCQkgIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCQkKCQkgICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KCQkgICAgdGFnTmFtZTogJ2RpdicsCgkJCgkJICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQoJCSAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KCQkgICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCQkgICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CgkJICAgIH0sCgkJCgkJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCQkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoJCQoJCSAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKCQkgICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQoJCSAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgoJCSAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQoJCSAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCgkJICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CgkJICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CgkJICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAoJCSAgICAvLyByZS1kZWxlZ2F0aW9uLgoJCSAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewoJCSAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CgkJICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwoJCSAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKCQkgICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCgkJICAgIC8vCgkJICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCgkJICAgIC8vCgkJICAgIC8vICAgICB7CgkJICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKCQkgICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnLAoJCSAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CgkJICAgIC8vICAgICB9CgkJICAgIC8vCgkJICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgoJCSAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCgkJICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgoJCSAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKCQkgICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCgkJICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKCQkgICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKCQkgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKCQkgICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CgkJICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CgkJICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKCQkgICAgICAgIGlmICghbWV0aG9kKSBjb250aW51ZTsKCQkKCQkgICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwoJCSAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwoJCSAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CgkJICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKCQkgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKCQkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwoJCSAgICAgICAgfSBlbHNlIHsKCQkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgoJCSAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKCQkgICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCgkJICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCgkJICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAoJCSAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCgkJICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgoJCSAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CgkJICAgICAgaWYgKCF0aGlzLmVsKSB7CgkJICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CgkJICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKCQkgICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CgkJICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKCQkgICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKCQkgICAgICB9IGVsc2UgewoJCSAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CgkJICAgICAgfQoJCSAgICB9CgkJCgkJICB9KTsKCQkKCQkgIC8vIEJhY2tib25lLnN5bmMKCQkgIC8vIC0tLS0tLS0tLS0tLS0KCQkKCQkgIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKCQkgIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQoJCSAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKCQkgIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CgkJICAvLwoJCSAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCgkJICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgoJCSAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCgkJICAvLwoJCSAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCgkJICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCgkJICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCgkJICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkJICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCgkJICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KCQkgIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CgkJICAgIHZhciB0eXBlID0gbWV0aG9kTWFwW21ldGhvZF07CgkJCgkJICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KCQkgICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CgkJICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAoJCSAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgoJCSAgICB9KTsKCQkKCQkgICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KCQkgICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCQkKCQkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KCQkgICAgaWYgKCFvcHRpb25zLnVybCkgewoJCSAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CgkJICAgIH0KCQkKCQkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgoJCSAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CgkJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwoJCSAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwoJCSAgICB9CgkJCgkJICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCgkJICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CgkJICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CgkJICAgIH0KCQkKCQkgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCgkJICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJCSAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKCQkgICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKCQkgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CgkJICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CgkJICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CgkJICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwoJCSAgICAgICAgaWYgKGJlZm9yZVNlbmQpIHJldHVybiBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgICAgfTsKCQkgICAgfQoJCQoJCSAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCgkJICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKCQkgICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKCQkgICAgfQoJCQoJCSAgICAvLyBJZiB3ZSdyZSBzZW5kaW5nIGEgYFBBVENIYCByZXF1ZXN0LCBhbmQgd2UncmUgaW4gYW4gb2xkIEludGVybmV0IEV4cGxvcmVyCgkJICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKCQkgICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgoJCSAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdQQVRDSCcgJiYgbm9YaHJQYXRjaCkgewoJCSAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKCQkgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKCQkgICAgICB9OwoJCSAgICB9CgkJCgkJICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCgkJICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CgkJICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKCQkgICAgcmV0dXJuIHhocjsKCQkgIH07CgkJCgkJICB2YXIgbm9YaHJQYXRjaCA9CgkJICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKCQkgICAgICAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCQkKCQkgIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgoJCSAgdmFyIG1ldGhvZE1hcCA9IHsKCQkgICAgJ2NyZWF0ZSc6ICdQT1NUJywKCQkgICAgJ3VwZGF0ZSc6ICdQVVQnLAoJCSAgICAncGF0Y2gnOiAgJ1BBVENIJywKCQkgICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAoJCSAgICAncmVhZCc6ICAgJ0dFVCcKCQkgIH07CgkJCgkJICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgoJCSAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgoJCSAgQmFja2JvbmUuYWpheCA9IGZ1bmN0aW9uKCkgewoJCSAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CgkJICB9OwoJCQoJCSAgLy8gQmFja2JvbmUuUm91dGVyCgkJICAvLyAtLS0tLS0tLS0tLS0tLS0KCQkKCQkgIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCgkJICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgoJCSAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQkgICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwoJCSAgICB0aGlzLl9iaW5kUm91dGVzKCk7CgkJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCSAgfTsKCQkKCQkgIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKCQkgIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCgkJICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKCQkgIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CgkJICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwoJCSAgdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCQkKCQkgIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJCSAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgkJCgkJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCQkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoJCQoJCSAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgoJCSAgICAvLwoJCSAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CgkJICAgIC8vICAgICAgIC4uLgoJCSAgICAvLyAgICAgfSk7CgkJICAgIC8vCgkJICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKCQkgICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwoJCSAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKCQkgICAgICAgIGNhbGxiYWNrID0gbmFtZTsKCQkgICAgICAgIG5hbWUgPSAnJzsKCQkgICAgICB9CgkJICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwoJCSAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwoJCSAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CgkJICAgICAgICB2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKCQkgICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKCQkgICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKCQkgICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwoJCSAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CgkJICAgICAgfSk7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCgkJICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgoJCSAgICBleGVjdXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYXJncykgewoJCSAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCgkJICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewoJCSAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKCQkgICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAoJCSAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgoJCSAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CgkJICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwoJCSAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwoJCSAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsKCQkgICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CgkJICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwoJCSAgICAgIH0KCQkgICAgfSwKCQkKCQkgICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKCQkgICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgoJCSAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKCQkgICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCgkJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKCQkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CgkJICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwoJCSAgICAgICAgICAgICAgICAgICB9KQoJCSAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKCQkgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCgkJICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKCQkgICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCgkJICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CgkJICAgICAgdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwoJCSAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CgkJICAgICAgICAvLyBEb24ndCBkZWNvZGUgdGhlIHNlYXJjaCBwYXJhbXMuCgkJICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpIHJldHVybiBwYXJhbSB8fCBudWxsOwoJCSAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CgkJICAgICAgfSk7CgkJICAgIH0KCQkKCQkgIH0pOwoJCQoJCSAgLy8gQmFja2JvbmUuSGlzdG9yeQoJCSAgLy8gLS0tLS0tLS0tLS0tLS0tLQoJCQoJCSAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCgkJICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKCQkgIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCgkJICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCgkJICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCgkJICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKCQkgICAgdGhpcy5oYW5kbGVycyA9IFtdOwoJCSAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CgkJCgkJICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgoJCSAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkgICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJCSAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoJCSAgICB9CgkJICB9OwoJCQoJCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgoJCSAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCQkKCQkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCgkJICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoJCQoJCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KCQkgIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCQkKCQkgIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KCQkgIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgkJCgkJICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2guCgkJICB2YXIgcGF0aFN0cmlwcGVyID0gLyMuKiQvOwoJCQoJCSAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwoJCSAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgkJCgkJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkJICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgkJCgkJICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwoJCSAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCgkJICAgIGludGVydmFsOiA1MCwKCQkKCQkgICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KCQkgICAgYXRSb290OiBmdW5jdGlvbigpIHsKCQkgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwoJCSAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KCQkgICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CgkJICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCQkgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCgkJICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCgkJICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKCQkgICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewoJCSAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CgkJICAgICAgICAgIGZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CgkJICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwoJCSAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwoJCSAgICAgICAgfSBlbHNlIHsKCQkgICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKCQkgICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KCQkgICAgc3RhcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CgkJICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCQkKCQkgICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwoJCSAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CgkJICAgICAgdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgkJICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CgkJICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwoJCSAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKCQkgICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKCQkgICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CgkJICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoJCSAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgkJCgkJICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KCQkgICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCQkKCQkgICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwoJCSAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwoJCSAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCgkJICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCgkJICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewoJCSAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwoJCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewoJCSAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CgkJICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCQkgICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKCQkgICAgICB9CgkJCgkJICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKCQkgICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCgkJICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoJCSAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwoJCQoJCSAgICAgIC8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCgkJICAgICAgLy8gcmVxdWVzdGVkLgoJCSAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCQkKCQkgICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAoJCSAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KCQkgICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICF0aGlzLmF0Um9vdCgpKSB7CgkJICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwoJCSAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CgkJICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAoJCSAgICAgICAgICByZXR1cm4gdHJ1ZTsKCQkKCQkgICAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CgkJICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgoJCSAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewoJCSAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkJICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKCQkgICAgICAgIH0KCQkKCQkgICAgICB9CgkJCgkJICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CgkJICAgIH0sCgkJCgkJICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAoJCSAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KCQkgICAgc3RvcDogZnVuY3Rpb24oKSB7CgkJICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCQkgICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKCQkgICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgoJCSAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgoJCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CgkJICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwoJCSAgICB9LAoJCQoJCSAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKCQkgICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCgkJICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CgkJICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CgkJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKCQkgICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwoJCSAgICAgIH0KCQkgICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwoJCSAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKCQkgICAgICB0aGlzLmxvYWRVcmwoKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKCQkgICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKCQkgICAgLy8gcmV0dXJucyBgZmFsc2VgLgoJCSAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewoJCSAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwoJCSAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CgkJICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewoJCSAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKCQkgICAgICAgICAgcmV0dXJuIHRydWU7CgkJICAgICAgICB9CgkJICAgICAgfSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKCQkgICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwoJCSAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KCQkgICAgLy8KCQkgICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQoJCSAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgoJCSAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgoJCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCQkgICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwoJCSAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6ICEhb3B0aW9uc307CgkJCgkJICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCQkKCQkgICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCgkJICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoJCQoJCSAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwoJCSAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCQkKCQkgICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCgkJICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKCQkKCQkgICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgoJCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCQkgICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgkJCgkJICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKCQkgICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgoJCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJCSAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKCQkgICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCgkJICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CgkJICAgICAgICAgIC8vIHdhbnQgdGhpcy4KCQkgICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CgkJICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJCSAgICAgICAgfQoJCQoJCSAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQoJCSAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgoJCSAgICAgIH0gZWxzZSB7CgkJICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKCQkgICAgICB9CgkJICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCgkJICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgoJCSAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CgkJICAgICAgaWYgKHJlcGxhY2UpIHsKCQkgICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CgkJICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CgkJICAgICAgfSBlbHNlIHsKCQkgICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KCQkgICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKCQkgICAgICB9CgkJICAgIH0KCQkKCQkgIH0pOwoJCQoJCSAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCgkJICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgkJCgkJICAvLyBIZWxwZXJzCgkJICAvLyAtLS0tLS0tCgkJCgkJICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KCQkgIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCgkJICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgoJCSAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CgkJICAgIHZhciBwYXJlbnQgPSB0aGlzOwoJCSAgICB2YXIgY2hpbGQ7CgkJCgkJICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCQkgICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJCSAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkJICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CgkJICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwoJCSAgICB9IGVsc2UgewoJCSAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwoJCSAgICB9CgkJCgkJICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgoJCSAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgkJCgkJICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCgkJICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkJICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CgkJICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwoJCSAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoJCQoJCSAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCQkgICAgLy8gaWYgc3VwcGxpZWQuCgkJICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoJCQoJCSAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkJICAgIC8vIGxhdGVyLgoJCSAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoJCQoJCSAgICByZXR1cm4gY2hpbGQ7CgkJICB9OwoJCQoJCSAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KCQkgIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgkJCgkJICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCgkJICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKCQkgICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CgkJICB9OwoJCQoJCSAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCgkJICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQkgICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKCQkgICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKCQkgICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkgICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkgICAgfTsKCQkgIH07CgkJCgkJICByZXR1cm4gQmFja2JvbmU7CgkJCgkJfSkpOwoJCUJhY2tib25lID0gdGhpcy5CYWNrYm9uZTsKCQlCYWNrYm9uZS4kID0gdGhpcy4kOwoJCXJldHVybiBCYWNrYm9uZTsKCX0pLmFwcGx5KHsKCQlfOiBfLAoJCSQ6ICQKCX0pOwoJLy8gRU5EIFRISVJEIFBBUlRZIENPREUKCS8qZ2xvYmFsIEJhY2tib25lLCBVdGlsKi8KCS8qIGdsb2JhbCBfLCBVdGlsICovCgkvKiBleHBvcnRlZCBMb2dnZXIgKi8KCXZhciBMb2dnZXIgPSAoZnVuY3Rpb24oKSB7CgkJdmFyIGNvbG9ycyA9IHsKCQkJZGVidWc6ICJibHVlIiwKCQkJaW5mbzogImdyZWVuIiwKCQkJbG9nOiAiIzMzMyIsCgkJCXdhcm46ICJvcmFuZ2UiLAoJCQllcnJvcjogInJlZCIKCQl9LAoJCQlub29wID0gZnVuY3Rpb24oKSB7fSwKCQkJcG9zdE1lc3NhZ2UgPSB3aW5kb3cucG9zdE1lc3NhZ2UgfHwgbm9vcCwKCQkJY29uc29sZVByb3BzID0gWyJkZWJ1ZyIsICJsb2ciLCAiaW5mbyIsICJlcnJvciIsICJ3YXJuIl0sCgkJCWNvbnNvbGUgPSB3aW5kb3cuY29uc29sZSB8fCB7fTsKCQkvLyBwb2xseWZpbGwgCgkJXy5lYWNoKGNvbnNvbGVQcm9wcywgZnVuY3Rpb24ocHJvcCkgewoJCQlpZiAoIWNvbnNvbGVbcHJvcF0pIHsKCQkJCWNvbnNvbGVbcHJvcF0gPSBub29wOwoJCQl9CgkJfSk7CgkKCQlmdW5jdGlvbiBMb2dnZXIobmFtZSkgewoJCQl0aGlzLnByZWZpeCA9IG5hbWUgfHwgIkxvZ2dlciI7CgkJCV8uYmluZEFsbCh0aGlzLCAiZGVidWciLCAiaW5mbyIsICJsb2ciLCAid2FybiIsICJlcnJvciIpOyAvLyBzbyBsb2dnZXJzIGNhbiBiZSBldmVudCBoYW5kbGVycy4KCQl9CgkKCQlmdW5jdGlvbiBkb0xvZyhsZXZlbCwgbG9nZ2VyLCBhcmdzKSB7CgkJCXZhciBsb2dnZXJzID0gTG9nZ2VyLmdldEZpbHRlcnMoKTsKCQkJaWYgKGxvZ2dlcnMuaW5kZXhPZigiYWxsIikgIT09IC0xIHx8IGxvZ2dlci5wcmVmaXgudG9Mb3dlckNhc2UoKS5pbmRleE9mKGxvZ2dlcnMpICE9PSAtMSkgewoJCQkJdmFyIHByZWZpeCA9ICJbIiArIGxvZ2dlci5wcmVmaXggKyAiXSI7CgkJCQlhcmdzID0gXy50b0FycmF5KGFyZ3MpOwoJCQkJcG9zdE1lc3NhZ2UoImxvZ01lc3NhZ2U6PHNwYW4gc3R5bGU9XCJjb2xvcjoiICsgY29sb3JzW2xldmVsXSArICJcIj4iICsgcHJlZml4ICsgIiAiICsgYXJncyArICI8L3NwYW4+IiwgIioiKTsKCQkJCWFyZ3MudW5zaGlmdChwcmVmaXgpOwoJCQkJY29uc29sZVtsZXZlbF0uYXBwbHkoY29uc29sZSwgYXJncyk7CgkJCX0KCQl9CgkJXy5leHRlbmQoTG9nZ2VyLnByb3RvdHlwZSwgewoJCQlkZWJ1ZzogZnVuY3Rpb24oKSB7CgkJCQlkb0xvZygiZGVidWciLCB0aGlzLCBhcmd1bWVudHMpOwoJCQl9LAoJCQlpbmZvOiBmdW5jdGlvbigpIHsKCQkJCWRvTG9nKCJpbmZvIiwgdGhpcywgYXJndW1lbnRzKTsKCQkJfSwKCQkJbG9nOiBmdW5jdGlvbigpIHsKCQkJCWRvTG9nKCJsb2ciLCB0aGlzLCBhcmd1bWVudHMpOwoJCQl9LAoJCQl3YXJuOiBmdW5jdGlvbigpIHsKCQkJCWRvTG9nKCJ3YXJuIiwgdGhpcywgYXJndW1lbnRzKTsKCQkJfSwKCQkJZXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkJZG9Mb2coImVycm9yIiwgdGhpcywgYXJndW1lbnRzKTsKCQkJfQoJCX0pOwoJCUxvZ2dlci5nZXRGaWx0ZXJzID0gZnVuY3Rpb24oKSB7CgkJCWlmICghTG9nZ2VyLmZpdGVycykgewoJCQkJcmV0dXJuICIiOwoJCQl9CgkJCXJldHVybiBMb2dnZXIuZmlsdGVycy50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7CgkJfTsKCQlyZXR1cm4gTG9nZ2VyOwoJfSkoKTsKCVV0aWwuTG9nZ2VyID0gTG9nZ2VyOwoJVXRpbC5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CglVdGlsLkV2ZW50cyA9IEJhY2tib25lLkV2ZW50czsKCS8qIGdsb2JhbCBVdGlsLCBMb2dnZXIsIF8sIEJhY2tib25lKi8KCS8qIGV4cG9ydGVkIE1vZHVsZSAqLwoJLyoqCgkgKiBTaW1wbGUgYmFzZSBjbGFzcyBmdW5jdGlvbmFsaXR5LgoJICogU3ViY2xhc3MgZ2V0IGFuIG9wdGlvbnMgYW5kIGEgbG9nZ2VyLgoJICogQW4gaW5pdGlhbGl6ZSBtZXRob2QgYW5kIGEgZGVzdHJveSBtZXRob2QuCgkgKiBBbmQgQmFja2JvbmUuRXZlbnRzLgoJICovCgl2YXIgTW9kdWxlID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJdGhpcy5sb2dnZXIgPSBuZXcgTG9nZ2VyKHRoaXMub3B0aW9ucy5sb2dnZXJOYW1lIHx8IHRoaXMubmFtZSB8fCB0aGlzLm1vZHVsZUlkIHx8ICJMb2dnZXIiKTsKCQl0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CglNb2R1bGUucHJvdG90eXBlID0gewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCkge30sCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RvcExpc3RlbmluZygpOwoJCX0KCX07CglfLmV4dGVuZChNb2R1bGUucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMpOwoJTW9kdWxlLmV4dGVuZCA9IFV0aWwuZXh0ZW5kOwoJVXRpbC5Nb2R1bGUgPSBNb2R1bGU7CgkvKmdsb2JhbCBVdGlsLCBfICovCgl2YXIgdGVtcGxhdGVQcmVwcm9jZXNzID0gZnVuY3Rpb24odGV4dCkgewoJICAgIC8vIGZpcnN0LCBzdXBwb3J0IGxlZ2FjeSB0ZW1wbGF0ZSBmb3JtYXQgb2Yge2RhdGF9CgkgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvXHt7MSx9L2csICJ7eyIpLnJlcGxhY2UoL1x9ezEsfS9nLCAifX0iKQoJICAgIC8vIHdlIG5lZWQgdG8gYm90aCBzdXBwb3J0IHt1cml9IGFuZCB7dXJpLmlkfSwgdGhlcmUgaXMgYW4gb2J2aW91cyBjb25mbGljdCB0aGVyZS4KCSAgICAucmVwbGFjZSgvXHt1cmlcLi8sICJ7dXJpUGFydHMuIikKCSAgICAvLyBsYXN0LCBzY29wZSB0aGUgZGF0YSwgdGhpcyBsZXRzIHVzIGhhdmUgdW5kZWZpbmVkIHZhcnMuCgkgICAgLnJlcGxhY2UoL1x7ezIsfS9nLCAie3tkYXRhLiIpOwoJfTsKCQoJLyoqCgkgKiB0ZXh0IGNhbiBiZSBhIHNpbmdsZSBzdHJpbmcsIGFuIG9iamVjdCB3aXRoIHN0cmluZyBwcm9wZXJpdGVzLCBvciBhbiBhcnJheSBvZiBzdHJpbmdzLgoJICovCglVdGlsLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwga2V5cykgewoJICAgIC8vIHBhcnNlIHN0cmluZ3MgbGlrZSB7dXJpfQoJICAgIGlmIChfLmlzU3RyaW5nKHRleHQpKSB7CgkgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKHRlbXBsYXRlUHJlcHJvY2Vzcyh0ZXh0KSwgewoJICAgICAgICAgICAgZGF0YTogZGF0YQoJICAgICAgICB9LCB7CgkgICAgICAgICAgICBpbnRlcnBvbGF0ZTogL1x7XHsoLis/KVx9XH0vZwoJICAgICAgICB9KTsKCSAgICB9IGVsc2UgewoJICAgICAgICBfKHRleHQpLmVhY2goZnVuY3Rpb24ocHJvcCwga2V5KSB7CgkgICAgICAgICAgICBpZiAoIWtleXMgfHwgXy5jb250YWlucyhrZXlzLCBrZXkpKSB7CgkgICAgICAgICAgICAgICAgLy8gZG8gYW4gZXh0cmEgY2hlY2sgdG8gbWFrZSBzdXJlIHRoZXJlIGlzIGEgdGVtcGxhdGUsIHBlcmhhcHMgZW5oYW5jaW5nIHBlcmZvcm1hbmNlLgoJICAgICAgICAgICAgICAgIGlmIChfLmlzU3RyaW5nKHByb3ApICYmIHByb3AuaW5kZXhPZigieyIpICE9PSAtMSkgewoJICAgICAgICAgICAgICAgICAgICB0ZXh0W2tleV0gPSBfLnRlbXBsYXRlKHRlbXBsYXRlUHJlcHJvY2Vzcyhwcm9wKSwgewoJICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YQoJICAgICAgICAgICAgICAgICAgICB9LCB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnBvbGF0ZTogL1x7XHsoLis/KVx9XH0vZwoJICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICByZXR1cm4gdGV4dDsKCSAgICB9Cgl9OwoJLyoqCgkgKiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8gdGhlIFRlbXBsYXRlUHJveHkgaW4gZmxhc2guCgkgKi8KCVV0aWwuYnVpbGRUZW1wbGF0ZURhdGEgPSBmdW5jdGlvbihwbGF5ZXIsIGV4dHJhRGF0YSkgewoJICAgIHZhciBkYXRhID0gXy5leHRlbmQoe30sIHBsYXllci5jb25maWcsIGV4dHJhRGF0YSksCgkgICAgICAgIHNwbGl0VXJpID0gZGF0YS51cmkuc3BsaXQoIjoiKTsKCSAgICAvLyBidWlsZCB1cmkKCSAgICBkYXRhLnVyaVBhcnRzID0gewoJICAgICAgICBuYW1lc3BhY2U6IHNwbGl0VXJpWzNdLAoJICAgICAgICBpZDogc3BsaXRVcmlbNF0KCSAgICB9OwoJICAgIGRhdGEuY3VycmVudE1ldGFkYXRhID0gcGxheWVyLmN1cnJlbnRNZXRhZGF0YSA/IHBsYXllci5jdXJyZW50TWV0YWRhdGEgOiBudWxsOwoJICAgIC8vIG1ldGFkYXRhIGZvciBsZWdhY3kKCSAgICBkYXRhLm1ldGFkYXRhID0gcGxheWVyLmN1cnJlbnRNZXRhZGF0YSA/IHBsYXllci5jdXJyZW50TWV0YWRhdGEucnNzIDogbnVsbDsKCSAgICBkYXRhLnBsYXlsaXN0TWV0YWRhdGEgPSBwbGF5ZXIucGxheWxpc3RNZXRhZGF0YTsKCSAgICAvLyBmdXR1cmUgdGVtcGFsZXMgY2FuIGp1c3QgYWNjZXNzIHByb3BlcnRpZXMgb24gdGhlIGVtYmVkIGFwaS4KCSAgICBkYXRhLnBsYXllciA9IHBsYXllcjsKCSAgICAvLyBsZWdhY3kgdGhpcyBpcyBpbiBmbGFzaCBwbGF5ZXIsIG5vdCBzdXJlIGlmIHVzZWQuCgkgICAgZGF0YS5hcHAgPSB7CgkgICAgICAgIHdpZHRoOiBkYXRhLndpZHRoLAoJICAgICAgICBoZWlnaHQ6IGRhdGEuaGVpZ2h0CgkgICAgfTsKCSAgICByZXR1cm4gZGF0YTsKCX07CgkvKiBnbG9iYWwgXywgQmFja2JvbmUsIFV0aWwqLwoJLyoqCgkgKiBNYW5hZ2UgYnJvd3NlciBmdWxsIHNjcmVlbiBtZXRob2RzIGZvciBhIHZhcmlldHkgb2YgdmVuZG9yIHByZWZpeGVzLgoJICovCglVdGlsLkZ1bGxTY3JlZW4gPSAoZnVuY3Rpb24oZG9jdW1lbnQpIHsKCQl2YXIgY2FuY2VsRnVuYyA9IGRvY3VtZW50LmNhbmNlbEZ1bGxTY3JlZW4gfHwgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuLAoJCQlGdWxsU2NyZWVuID0gXy5leHRlbmQoe30sIEJhY2tib25lLkV2ZW50cywgewoJCQkJdG9nZ2xlOiBmdW5jdGlvbihlbGVtZW50KSB7CgkJCQkJaWYgKEZ1bGxTY3JlZW4uaXNGdWxsU2NyZWVuKCkpIHsKCQkJCQkJcmV0dXJuIEZ1bGxTY3JlZW4uY2FuY2VsRnVsbFNjcmVlbigpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBGdWxsU2NyZWVuLnJlcXVlc3RGdWxsU2NyZWVuKGVsZW1lbnQpOwoJCQkJCX0KCQkJCX0sCgkJCQlyZXF1ZXN0RnVsbFNjcmVlbjogZnVuY3Rpb24oZWxlbWVudCkgewoJCQkJCWVsZW1lbnQgPSBlbGVtZW50IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCQkJCQl2YXIgcmVxdWVzdEZ1bmMgPSBlbGVtZW50LnJlcXVlc3RGdWxsU2NyZWVuIHx8IGVsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4gfHwgZWxlbWVudC53ZWJraXRSZXF1ZXN0RnVsbFNjcmVlbjsKCQkJCQlpZiAoXy5pc0Z1bmN0aW9uKHJlcXVlc3RGdW5jKSkgewoJCQkJCQlyZXF1ZXN0RnVuYy5jYWxsKGVsZW1lbnQpOwoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSwKCQkJCWNhbmNlbEZ1bGxTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQkJCWlmIChfLmlzRnVuY3Rpb24oY2FuY2VsRnVuYykpIHsKCQkJCQkJY2FuY2VsRnVuYy5jYWxsKGRvY3VtZW50KTsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgkJCQlpc0Z1bGxTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAoKGRvY3VtZW50LmZ1bGxTY3JlZW5FbGVtZW50ICE9PSB1bmRlZmluZWQgJiYgZG9jdW1lbnQuZnVsbFNjcmVlbkVsZW1lbnQgIT09IG51bGwpIHx8IChkb2N1bWVudC5tb3pGdWxsU2NyZWVuICE9PSB1bmRlZmluZWQgJiYgZG9jdW1lbnQubW96RnVsbFNjcmVlbiA9PT0gdHJ1ZSkgfHwgKGRvY3VtZW50LndlYmtpdElzRnVsbFNjcmVlbiAhPT0gdW5kZWZpbmVkICYmIGRvY3VtZW50LndlYmtpdElzRnVsbFNjcmVlbiA9PT0gdHJ1ZSkpOwoJCQkJfSwKCQkJCUV2ZW50czogewoJCQkJCUZVTExfU0NSRUVOX0NIQU5HRTogImZ1bGxzY3JlZW5DaGFuZ2UiCgkJCQl9CgkJCX0pLAoJCQl2ZW5kb3JGdWxsc2NyZWVuQ2hhbmdlOwoJCWlmIChkb2N1bWVudC5mdWxsU2NyZWVuRW5hYmxlZCB8fCBkb2N1bWVudC5mdWxsc2NyZWVuRW5hYmxlZCkgewoJCQl2ZW5kb3JGdWxsc2NyZWVuQ2hhbmdlID0gImZ1bGxzY3JlZW5jaGFuZ2UiOwoJCX0gZWxzZSBpZiAoZG9jdW1lbnQubW96RnVsbHNjcmVlbkVuYWJsZWQgfHwgZG9jdW1lbnQubW96RnVsbFNjcmVlbkVuYWJsZWQpIHsKCQkJdmVuZG9yRnVsbHNjcmVlbkNoYW5nZSA9ICJtb3pmdWxsc2NyZWVuY2hhbmdlIjsKCQl9IGVsc2UgaWYgKGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50LndlYmtpdEZ1bGxTY3JlZW5FbmFibGVkKSB7CgkJCXZlbmRvckZ1bGxzY3JlZW5DaGFuZ2UgPSAid2Via2l0ZnVsbHNjcmVlbmNoYW5nZSI7CgkJfQoJCWlmICh2ZW5kb3JGdWxsc2NyZWVuQ2hhbmdlKSB7CgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIodmVuZG9yRnVsbHNjcmVlbkNoYW5nZSwgZnVuY3Rpb24oKSB7CgkJCQlGdWxsU2NyZWVuLnRyaWdnZXIoRnVsbFNjcmVlbi5FdmVudHMuRlVMTF9TQ1JFRU5fQ0hBTkdFLCB7CgkJCQkJdHlwZTogRnVsbFNjcmVlbi5FdmVudHMuRlVMTF9TQ1JFRU5fQ0hBTkdFLAoJCQkJCWRhdGE6IEZ1bGxTY3JlZW4uaXNGdWxsU2NyZWVuKCkKCQkJCX0pOwoJCQl9LCBmYWxzZSk7CgkJfQoJCXJldHVybiBGdWxsU2NyZWVuOwoJfSkoZG9jdW1lbnQpOwoJLyogZ2xvYmFsIFV0aWwsIF8qLwoJdmFyIFBsYXlsaXN0ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoJUGxheWxpc3QuRXZlbnRzID0gewoJCUlOREVYX0NIQU5HRTogInBsYXlsaXN0OmluZGV4IiwKCQlSRUFEWTogInBsYXlsaXN0OnJlYWR5IiwKCQlJVEVNX1JFQURZOiAicGxheWxpc3Q6aXRlbTpyZWFkeSIKCX07CglQbGF5bGlzdC5wcm90b3R5cGUgPSBfLmV4dGVuZCh7CgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJCWlmICh0aGlzLm9wdGlvbnMubWV0YWRhdGEpIHsKCQkJCXRoaXMubWV0YWRhdGEgPSB0aGlzLm9wdGlvbnMubWV0YWRhdGE7CgkJCQl0aGlzLmN1cnJlbnRJdGVtID0gdGhpcy5nZXRDdXJyZW50SXRlbSgpOwoJCQl9CgkJfSwKCQljdXJyZW50SW5kZXg6IDAsCgkJY3VycmVudEl0ZW06IG51bGwsCgkJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5tZXRhZGF0YS5pdGVtc1t0aGlzLmhhc1ByZXZpb3VzKCkgPyB0aGlzLmN1cnJlbnRJbmRleCAtIDEgOiB0aGlzLmN1cnJlbnRJbmRleF07CgkJfSwKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGl0ZW1zID0gdGhpcy5tZXRhZGF0YS5pdGVtczsKCQkJcmV0dXJuIHRoaXMuaGFzTmV4dCgpID8gaXRlbXNbdGhpcy5jdXJyZW50SW5kZXggKyAxXSA6IGl0ZW1zW3RoaXMuY3VycmVudEluZGV4XTsKCQl9LAoJCXByZXZpb3VzOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc2V0SW5kZXgodGhpcy5jdXJyZW50SW5kZXggLSAxKTsKCQl9LAoJCW5leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zZXRJbmRleCh0aGlzLmN1cnJlbnRJbmRleCArIDEpOwoJCX0sCgkJaGFzTmV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmN1cnJlbnRJbmRleCA8IHRoaXMubWV0YWRhdGEuaXRlbXMubGVuZ3RoIC0gMTsKCQl9LAoJCWhhc1ByZXZpb3VzOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuY3VycmVudEluZGV4ID4gMDsKCQl9LAoJCWdldEN1cnJlbnRJdGVtOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMubWV0YWRhdGEuaXRlbXNbdGhpcy5jdXJyZW50SW5kZXhdOwoJCX0sCgkJc2V0SW5kZXg6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCWlmIChpbmRleCA+IHRoaXMubWV0YWRhdGEuaXRlbXMubGVuZ3RoIC0gMSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKGluZGV4ICE9PSB0aGlzLmN1cnJlbnRJbmRleCkgewoJCQkJdGhpcy5jdXJyZW50SW5kZXggPSBpbmRleDsKCQkJCXRoaXMudXBkYXRlQ3VycmVudCgpOwoJCQkJdGhpcy5vbkluZGV4Q2hhbmdlKCk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJb25JbmRleENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMudHJpZ2dlcihQbGF5bGlzdC5FdmVudHMuSU5ERVhfQ0hBTkdFLCB7CgkJCQl0eXBlOiBQbGF5bGlzdC5FdmVudHMuSU5ERVhfQ0hBTkdFLAoJCQkJZGF0YTogdGhpcy5jdXJyZW50SW5kZXgKCQkJfSk7CgkJfSwKCQlnZXRJdGVtQXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCXZhciBpdGVtcyA9IHRoaXMubWV0YWRhdGEuaXRlbXM7CgkJCWlmIChpbmRleCA8IDAgfHwgaW5kZXggPiBpdGVtcy5sZW5ndGggLSAxKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIlBsYXlsaXN0IGluZGV4ICIgKyBpbmRleCArICIgaXMgb3V0IG9mIHJhbmdlIFswLSIgKyBpdGVtcy5sZW5ndGggKyAiXSIpOwoJCQl9CgkJCXJldHVybiBpdGVtc1tpbmRleF07CgkJfSwKCQl1cGRhdGVDdXJyZW50OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5jdXJyZW50SXRlbSA9IHRoaXMubWV0YWRhdGEuaXRlbXNbdGhpcy5jdXJyZW50SW5kZXhdOwoJCX0KCX0sIFV0aWwuRXZlbnRzKTsKCVBsYXlsaXN0LmV4dGVuZCA9IFV0aWwuZXh0ZW5kOwoJVXRpbC5QbGF5bGlzdCA9IFBsYXlsaXN0OwoJcmV0dXJuIFV0aWw7Cn0pKF8sICQpOw==",
                "body": "LyogZ2xvYmFsIF8sICQgKi8KdmFyIFV0aWwgPSAoZnVuY3Rpb24oXywgJCkgewoJLyoqCgkgKiBMZWdhY3kgc3VwcG9ydC4KCSAqIFRoaXMgYnVpbGQgY29tZXMgd2l0aCBCYWNrYm9uZSBhbmQgSGFuZGxlYmFycy4KCSAqLwoJLyogZXhwb3J0ZWQgVXRpbCAqLwoJdmFyIFV0aWwgPSB7CgkJdmVyc2lvbjogIjIuMi4xIiwKCQlidWlsZDogIlRodSBBcHIgMjQgMjAxNCAxMTozNzoxNiIKCX07CgkvLyBCRUdJTiBUSElSRCBQQVJUWSBDT0RFCgkvKiBnbG9iYWwgSGFuZGxlYmFycyAqLwoJLyohCgkKCSBoYW5kbGViYXJzIHYxLjMuMAoJCglDb3B5cmlnaHQgKEMpIDIwMTEgYnkgWWVodWRhIEthdHoKCQoJUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQoJb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKCWluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKCXRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKCWNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwoJZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKCQoJVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KCWFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoJCglUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgoJSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCglGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKCUFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKCUxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCglPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCglUSEUgU09GVFdBUkUuCgkKCUBsaWNlbnNlCgkqLwoJLyogZXhwb3J0ZWQgSGFuZGxlYmFycyAqLwoJdmFyIEhhbmRsZWJhcnMgPSAoZnVuY3Rpb24oKSB7CgkvLyBoYW5kbGViYXJzL3NhZmUtc3RyaW5nLmpzCgl2YXIgX19tb2R1bGUzX18gPSAoZnVuY3Rpb24oKSB7CgkgICJ1c2Ugc3RyaWN0IjsKCSAgdmFyIF9fZXhwb3J0c19fOwoJICAvLyBCdWlsZCBvdXQgb3VyIGJhc2ljIFNhZmVTdHJpbmcgdHlwZQoJICBmdW5jdGlvbiBTYWZlU3RyaW5nKHN0cmluZykgewoJICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwoJICB9CgkKCSAgU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gIiIgKyB0aGlzLnN0cmluZzsKCSAgfTsKCQoJICBfX2V4cG9ydHNfXyA9IFNhZmVTdHJpbmc7CgkgIHJldHVybiBfX2V4cG9ydHNfXzsKCX0pKCk7CgkKCS8vIGhhbmRsZWJhcnMvdXRpbHMuanMKCXZhciBfX21vZHVsZTJfXyA9IChmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18pIHsKCSAgInVzZSBzdHJpY3QiOwoJICB2YXIgX19leHBvcnRzX18gPSB7fTsKCSAgLypqc2hpbnQgLVcwMDQgKi8KCSAgdmFyIFNhZmVTdHJpbmcgPSBfX2RlcGVuZGVuY3kxX187CgkKCSAgdmFyIGVzY2FwZSA9IHsKCSAgICAiJiI6ICImYW1wOyIsCgkgICAgIjwiOiAiJmx0OyIsCgkgICAgIj4iOiAiJmd0OyIsCgkgICAgJyInOiAiJnF1b3Q7IiwKCSAgICAiJyI6ICImI3gyNzsiLAoJICAgICJgIjogIiYjeDYwOyIKCSAgfTsKCQoJICB2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYF0vZzsKCSAgdmFyIHBvc3NpYmxlID0gL1smPD4iJ2BdLzsKCQoJICBmdW5jdGlvbiBlc2NhcGVDaGFyKGNocikgewoJICAgIHJldHVybiBlc2NhcGVbY2hyXSB8fCAiJmFtcDsiOwoJICB9CgkKCSAgZnVuY3Rpb24gZXh0ZW5kKG9iaiwgdmFsdWUpIHsKCSAgICBmb3IodmFyIGtleSBpbiB2YWx1ZSkgewoJICAgICAgaWYoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrZXkpKSB7CgkgICAgICAgIG9ialtrZXldID0gdmFsdWVba2V5XTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5leHRlbmQgPSBleHRlbmQ7dmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCSAgX19leHBvcnRzX18udG9TdHJpbmcgPSB0b1N0cmluZzsKCSAgLy8gU291cmNlZCBmcm9tIGxvZGFzaAoJICAvLyBodHRwczovL2dpdGh1Yi5jb20vYmVzdGllanMvbG9kYXNoL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CgkgIHZhciBpc0Z1bmN0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nOwoJICB9OwoJICAvLyBmYWxsYmFjayBmb3Igb2xkZXIgdmVyc2lvbnMgb2YgQ2hyb21lIGFuZCBTYWZhcmkKCSAgaWYgKGlzRnVuY3Rpb24oL3gvKSkgewoJICAgIGlzRnVuY3Rpb24gPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJzsKCSAgICB9OwoJICB9CgkgIHZhciBpc0Z1bmN0aW9uOwoJICBfX2V4cG9ydHNfXy5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKCSAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSA/IHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBBcnJheV0nIDogZmFsc2U7CgkgIH07CgkgIF9fZXhwb3J0c19fLmlzQXJyYXkgPSBpc0FycmF5OwoJCgkgIGZ1bmN0aW9uIGVzY2FwZUV4cHJlc3Npb24oc3RyaW5nKSB7CgkgICAgLy8gZG9uJ3QgZXNjYXBlIFNhZmVTdHJpbmdzLCBzaW5jZSB0aGV5J3JlIGFscmVhZHkgc2FmZQoJICAgIGlmIChzdHJpbmcgaW5zdGFuY2VvZiBTYWZlU3RyaW5nKSB7CgkgICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CgkgICAgfSBlbHNlIGlmICghc3RyaW5nICYmIHN0cmluZyAhPT0gMCkgewoJICAgICAgcmV0dXJuICIiOwoJICAgIH0KCQoJICAgIC8vIEZvcmNlIGEgc3RyaW5nIGNvbnZlcnNpb24gYXMgdGhpcyB3aWxsIGJlIGRvbmUgYnkgdGhlIGFwcGVuZCByZWdhcmRsZXNzIGFuZAoJICAgIC8vIHRoZSByZWdleCB0ZXN0IHdpbGwgZG8gdGhpcyB0cmFuc3BhcmVudGx5IGJlaGluZCB0aGUgc2NlbmVzLCBjYXVzaW5nIGlzc3VlcyBpZgoJICAgIC8vIGFuIG9iamVjdCdzIHRvIHN0cmluZyBoYXMgZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGl0LgoJICAgIHN0cmluZyA9ICIiICsgc3RyaW5nOwoJCgkgICAgaWYoIXBvc3NpYmxlLnRlc3Qoc3RyaW5nKSkgeyByZXR1cm4gc3RyaW5nOyB9CgkgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKCSAgfQoJCgkgIF9fZXhwb3J0c19fLmVzY2FwZUV4cHJlc3Npb24gPSBlc2NhcGVFeHByZXNzaW9uO2Z1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKCSAgICBpZiAoIXZhbHVlICYmIHZhbHVlICE9PSAwKSB7CgkgICAgICByZXR1cm4gdHJ1ZTsKCSAgICB9IGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMCkgewoJICAgICAgcmV0dXJuIHRydWU7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5pc0VtcHR5ID0gaXNFbXB0eTsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoX19tb2R1bGUzX18pOwoJCgkvLyBoYW5kbGViYXJzL2V4Y2VwdGlvbi5qcwoJdmFyIF9fbW9kdWxlNF9fID0gKGZ1bmN0aW9uKCkgewoJICAidXNlIHN0cmljdCI7CgkgIHZhciBfX2V4cG9ydHNfXzsKCQoJICB2YXIgZXJyb3JQcm9wcyA9IFsnZGVzY3JpcHRpb24nLCAnZmlsZU5hbWUnLCAnbGluZU51bWJlcicsICdtZXNzYWdlJywgJ25hbWUnLCAnbnVtYmVyJywgJ3N0YWNrJ107CgkKCSAgZnVuY3Rpb24gRXhjZXB0aW9uKG1lc3NhZ2UsIG5vZGUpIHsKCSAgICB2YXIgbGluZTsKCSAgICBpZiAobm9kZSAmJiBub2RlLmZpcnN0TGluZSkgewoJICAgICAgbGluZSA9IG5vZGUuZmlyc3RMaW5lOwoJCgkgICAgICBtZXNzYWdlICs9ICcgLSAnICsgbGluZSArICc6JyArIG5vZGUuZmlyc3RDb2x1bW47CgkgICAgfQoJCgkgICAgdmFyIHRtcCA9IEVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwoJCgkgICAgLy8gVW5mb3J0dW5hdGVseSBlcnJvcnMgYXJlIG5vdCBlbnVtZXJhYmxlIGluIENocm9tZSAoYXQgbGVhc3QpLCBzbyBgZm9yIHByb3AgaW4gdG1wYCBkb2Vzbid0IHdvcmsuCgkgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgZXJyb3JQcm9wcy5sZW5ndGg7IGlkeCsrKSB7CgkgICAgICB0aGlzW2Vycm9yUHJvcHNbaWR4XV0gPSB0bXBbZXJyb3JQcm9wc1tpZHhdXTsKCSAgICB9CgkKCSAgICBpZiAobGluZSkgewoJICAgICAgdGhpcy5saW5lTnVtYmVyID0gbGluZTsKCSAgICAgIHRoaXMuY29sdW1uID0gbm9kZS5maXJzdENvbHVtbjsKCSAgICB9CgkgIH0KCQoJICBFeGNlcHRpb24ucHJvdG90eXBlID0gbmV3IEVycm9yKCk7CgkKCSAgX19leHBvcnRzX18gPSBFeGNlcHRpb247CgkgIHJldHVybiBfX2V4cG9ydHNfXzsKCX0pKCk7CgkKCS8vIGhhbmRsZWJhcnMvYmFzZS5qcwoJdmFyIF9fbW9kdWxlMV9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fKSB7CgkgICJ1c2Ugc3RyaWN0IjsKCSAgdmFyIF9fZXhwb3J0c19fID0ge307CgkgIHZhciBVdGlscyA9IF9fZGVwZW5kZW5jeTFfXzsKCSAgdmFyIEV4Y2VwdGlvbiA9IF9fZGVwZW5kZW5jeTJfXzsKCQoJICB2YXIgVkVSU0lPTiA9ICIxLjMuMCI7CgkgIF9fZXhwb3J0c19fLlZFUlNJT04gPSBWRVJTSU9OO3ZhciBDT01QSUxFUl9SRVZJU0lPTiA9IDQ7CgkgIF9fZXhwb3J0c19fLkNPTVBJTEVSX1JFVklTSU9OID0gQ09NUElMRVJfUkVWSVNJT047CgkgIHZhciBSRVZJU0lPTl9DSEFOR0VTID0gewoJICAgIDE6ICc8PSAxLjAucmMuMicsIC8vIDEuMC5yYy4yIGlzIGFjdHVhbGx5IHJldjIgYnV0IGRvZXNuJ3QgcmVwb3J0IGl0CgkgICAgMjogJz09IDEuMC4wLXJjLjMnLAoJICAgIDM6ICc9PSAxLjAuMC1yYy40JywKCSAgICA0OiAnPj0gMS4wLjAnCgkgIH07CgkgIF9fZXhwb3J0c19fLlJFVklTSU9OX0NIQU5HRVMgPSBSRVZJU0lPTl9DSEFOR0VTOwoJICB2YXIgaXNBcnJheSA9IFV0aWxzLmlzQXJyYXksCgkgICAgICBpc0Z1bmN0aW9uID0gVXRpbHMuaXNGdW5jdGlvbiwKCSAgICAgIHRvU3RyaW5nID0gVXRpbHMudG9TdHJpbmcsCgkgICAgICBvYmplY3RUeXBlID0gJ1tvYmplY3QgT2JqZWN0XSc7CgkKCSAgZnVuY3Rpb24gSGFuZGxlYmFyc0Vudmlyb25tZW50KGhlbHBlcnMsIHBhcnRpYWxzKSB7CgkgICAgdGhpcy5oZWxwZXJzID0gaGVscGVycyB8fCB7fTsKCSAgICB0aGlzLnBhcnRpYWxzID0gcGFydGlhbHMgfHwge307CgkKCSAgICByZWdpc3RlckRlZmF1bHRIZWxwZXJzKHRoaXMpOwoJICB9CgkKCSAgX19leHBvcnRzX18uSGFuZGxlYmFyc0Vudmlyb25tZW50ID0gSGFuZGxlYmFyc0Vudmlyb25tZW50O0hhbmRsZWJhcnNFbnZpcm9ubWVudC5wcm90b3R5cGUgPSB7CgkgICAgY29uc3RydWN0b3I6IEhhbmRsZWJhcnNFbnZpcm9ubWVudCwKCQoJICAgIGxvZ2dlcjogbG9nZ2VyLAoJICAgIGxvZzogbG9nLAoJCgkgICAgcmVnaXN0ZXJIZWxwZXI6IGZ1bmN0aW9uKG5hbWUsIGZuLCBpbnZlcnNlKSB7CgkgICAgICBpZiAodG9TdHJpbmcuY2FsbChuYW1lKSA9PT0gb2JqZWN0VHlwZSkgewoJICAgICAgICBpZiAoaW52ZXJzZSB8fCBmbikgeyB0aHJvdyBuZXcgRXhjZXB0aW9uKCdBcmcgbm90IHN1cHBvcnRlZCB3aXRoIG11bHRpcGxlIGhlbHBlcnMnKTsgfQoJICAgICAgICBVdGlscy5leHRlbmQodGhpcy5oZWxwZXJzLCBuYW1lKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmIChpbnZlcnNlKSB7IGZuLm5vdCA9IGludmVyc2U7IH0KCSAgICAgICAgdGhpcy5oZWxwZXJzW25hbWVdID0gZm47CgkgICAgICB9CgkgICAgfSwKCQoJICAgIHJlZ2lzdGVyUGFydGlhbDogZnVuY3Rpb24obmFtZSwgc3RyKSB7CgkgICAgICBpZiAodG9TdHJpbmcuY2FsbChuYW1lKSA9PT0gb2JqZWN0VHlwZSkgewoJICAgICAgICBVdGlscy5leHRlbmQodGhpcy5wYXJ0aWFscywgIG5hbWUpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5wYXJ0aWFsc1tuYW1lXSA9IHN0cjsKCSAgICAgIH0KCSAgICB9CgkgIH07CgkKCSAgZnVuY3Rpb24gcmVnaXN0ZXJEZWZhdWx0SGVscGVycyhpbnN0YW5jZSkgewoJICAgIGluc3RhbmNlLnJlZ2lzdGVySGVscGVyKCdoZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oYXJnKSB7CgkgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJNaXNzaW5nIGhlbHBlcjogJyIgKyBhcmcgKyAiJyIpOwoJICAgICAgfQoJICAgIH0pOwoJCgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2Jsb2NrSGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCQoJICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoJCgkgICAgICBpZihjb250ZXh0ID09PSB0cnVlKSB7CgkgICAgICAgIHJldHVybiBmbih0aGlzKTsKCSAgICAgIH0gZWxzZSBpZihjb250ZXh0ID09PSBmYWxzZSB8fCBjb250ZXh0ID09IG51bGwpIHsKCSAgICAgICAgcmV0dXJuIGludmVyc2UodGhpcyk7CgkgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoY29udGV4dCkpIHsKCSAgICAgICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIGZuKGNvbnRleHQpOwoJICAgICAgfQoJICAgIH0pOwoJCgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICB2YXIgZm4gPSBvcHRpb25zLmZuLCBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlOwoJICAgICAgdmFyIGkgPSAwLCByZXQgPSAiIiwgZGF0YTsKCQoJICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoJCgkgICAgICBpZiAob3B0aW9ucy5kYXRhKSB7CgkgICAgICAgIGRhdGEgPSBjcmVhdGVGcmFtZShvcHRpb25zLmRhdGEpOwoJICAgICAgfQoJCgkgICAgICBpZihjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0ID09PSAnb2JqZWN0JykgewoJICAgICAgICBpZiAoaXNBcnJheShjb250ZXh0KSkgewoJICAgICAgICAgIGZvcih2YXIgaiA9IGNvbnRleHQubGVuZ3RoOyBpPGo7IGkrKykgewoJICAgICAgICAgICAgaWYgKGRhdGEpIHsKCSAgICAgICAgICAgICAgZGF0YS5pbmRleCA9IGk7CgkgICAgICAgICAgICAgIGRhdGEuZmlyc3QgPSAoaSA9PT0gMCk7CgkgICAgICAgICAgICAgIGRhdGEubGFzdCAgPSAoaSA9PT0gKGNvbnRleHQubGVuZ3RoLTEpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgZm9yKHZhciBrZXkgaW4gY29udGV4dCkgewoJICAgICAgICAgICAgaWYoY29udGV4dC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICAgICAgICAgIGlmKGRhdGEpIHsgCgkgICAgICAgICAgICAgICAgZGF0YS5rZXkgPSBrZXk7IAoJICAgICAgICAgICAgICAgIGRhdGEuaW5kZXggPSBpOwoJICAgICAgICAgICAgICAgIGRhdGEuZmlyc3QgPSAoaSA9PT0gMCk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgcmV0ID0gcmV0ICsgZm4oY29udGV4dFtrZXldLCB7ZGF0YTogZGF0YX0pOwoJICAgICAgICAgICAgICBpKys7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICB9CgkKCSAgICAgIGlmKGkgPT09IDApewoJICAgICAgICByZXQgPSBpbnZlcnNlKHRoaXMpOwoJICAgICAgfQoJCgkgICAgICByZXR1cm4gcmV0OwoJICAgIH0pOwoJCgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2lmJywgZnVuY3Rpb24oY29uZGl0aW9uYWwsIG9wdGlvbnMpIHsKCSAgICAgIGlmIChpc0Z1bmN0aW9uKGNvbmRpdGlvbmFsKSkgeyBjb25kaXRpb25hbCA9IGNvbmRpdGlvbmFsLmNhbGwodGhpcyk7IH0KCQoJICAgICAgLy8gRGVmYXVsdCBiZWhhdmlvciBpcyB0byByZW5kZXIgdGhlIHBvc2l0aXZlIHBhdGggaWYgdGhlIHZhbHVlIGlzIHRydXRoeSBhbmQgbm90IGVtcHR5LgoJICAgICAgLy8gVGhlIGBpbmNsdWRlWmVyb2Agb3B0aW9uIG1heSBiZSBzZXQgdG8gdHJlYXQgdGhlIGNvbmR0aW9uYWwgYXMgcHVyZWx5IG5vdCBlbXB0eSBiYXNlZCBvbiB0aGUKCSAgICAgIC8vIGJlaGF2aW9yIG9mIGlzRW1wdHkuIEVmZmVjdGl2ZWx5IHRoaXMgZGV0ZXJtaW5lcyBpZiAwIGlzIGhhbmRsZWQgYnkgdGhlIHBvc2l0aXZlIHBhdGggb3IgbmVnYXRpdmUuCgkgICAgICBpZiAoKCFvcHRpb25zLmhhc2guaW5jbHVkZVplcm8gJiYgIWNvbmRpdGlvbmFsKSB8fCBVdGlscy5pc0VtcHR5KGNvbmRpdGlvbmFsKSkgewoJICAgICAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CgkgICAgICB9CgkgICAgfSk7CgkKCSAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29uZGl0aW9uYWwsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiBpbnN0YW5jZS5oZWxwZXJzWydpZiddLmNhbGwodGhpcywgY29uZGl0aW9uYWwsIHtmbjogb3B0aW9ucy5pbnZlcnNlLCBpbnZlcnNlOiBvcHRpb25zLmZuLCBoYXNoOiBvcHRpb25zLmhhc2h9KTsKCSAgICB9KTsKCQoJICAgIGluc3RhbmNlLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewoJICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoJCgkgICAgICBpZiAoIVV0aWxzLmlzRW1wdHkoY29udGV4dCkpIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwoJICAgIH0pOwoJCgkgICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBsZXZlbCA9IG9wdGlvbnMuZGF0YSAmJiBvcHRpb25zLmRhdGEubGV2ZWwgIT0gbnVsbCA/IHBhcnNlSW50KG9wdGlvbnMuZGF0YS5sZXZlbCwgMTApIDogMTsKCSAgICAgIGluc3RhbmNlLmxvZyhsZXZlbCwgY29udGV4dCk7CgkgICAgfSk7CgkgIH0KCQoJICB2YXIgbG9nZ2VyID0gewoJICAgIG1ldGhvZE1hcDogeyAwOiAnZGVidWcnLCAxOiAnaW5mbycsIDI6ICd3YXJuJywgMzogJ2Vycm9yJyB9LAoJCgkgICAgLy8gU3RhdGUgZW51bQoJICAgIERFQlVHOiAwLAoJICAgIElORk86IDEsCgkgICAgV0FSTjogMiwKCSAgICBFUlJPUjogMywKCSAgICBsZXZlbDogMywKCQoJICAgIC8vIGNhbiBiZSBvdmVycmlkZGVuIGluIHRoZSBob3N0IGVudmlyb25tZW50CgkgICAgbG9nOiBmdW5jdGlvbihsZXZlbCwgb2JqKSB7CgkgICAgICBpZiAobG9nZ2VyLmxldmVsIDw9IGxldmVsKSB7CgkgICAgICAgIHZhciBtZXRob2QgPSBsb2dnZXIubWV0aG9kTWFwW2xldmVsXTsKCSAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiBjb25zb2xlW21ldGhvZF0pIHsKCSAgICAgICAgICBjb25zb2xlW21ldGhvZF0uY2FsbChjb25zb2xlLCBvYmopOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICB9OwoJICBfX2V4cG9ydHNfXy5sb2dnZXIgPSBsb2dnZXI7CgkgIGZ1bmN0aW9uIGxvZyhsZXZlbCwgb2JqKSB7IGxvZ2dlci5sb2cobGV2ZWwsIG9iaik7IH0KCQoJICBfX2V4cG9ydHNfXy5sb2cgPSBsb2c7dmFyIGNyZWF0ZUZyYW1lID0gZnVuY3Rpb24ob2JqZWN0KSB7CgkgICAgdmFyIG9iaiA9IHt9OwoJICAgIFV0aWxzLmV4dGVuZChvYmosIG9iamVjdCk7CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCSAgX19leHBvcnRzX18uY3JlYXRlRnJhbWUgPSBjcmVhdGVGcmFtZTsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoX19tb2R1bGUyX18sIF9fbW9kdWxlNF9fKTsKCQoJLy8gaGFuZGxlYmFycy9ydW50aW1lLmpzCgl2YXIgX19tb2R1bGU1X18gPSAoZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18sIF9fZGVwZW5kZW5jeTNfXykgewoJICAidXNlIHN0cmljdCI7CgkgIHZhciBfX2V4cG9ydHNfXyA9IHt9OwoJICB2YXIgVXRpbHMgPSBfX2RlcGVuZGVuY3kxX187CgkgIHZhciBFeGNlcHRpb24gPSBfX2RlcGVuZGVuY3kyX187CgkgIHZhciBDT01QSUxFUl9SRVZJU0lPTiA9IF9fZGVwZW5kZW5jeTNfXy5DT01QSUxFUl9SRVZJU0lPTjsKCSAgdmFyIFJFVklTSU9OX0NIQU5HRVMgPSBfX2RlcGVuZGVuY3kzX18uUkVWSVNJT05fQ0hBTkdFUzsKCQoJICBmdW5jdGlvbiBjaGVja1JldmlzaW9uKGNvbXBpbGVySW5mbykgewoJICAgIHZhciBjb21waWxlclJldmlzaW9uID0gY29tcGlsZXJJbmZvICYmIGNvbXBpbGVySW5mb1swXSB8fCAxLAoJICAgICAgICBjdXJyZW50UmV2aXNpb24gPSBDT01QSUxFUl9SRVZJU0lPTjsKCQoJICAgIGlmIChjb21waWxlclJldmlzaW9uICE9PSBjdXJyZW50UmV2aXNpb24pIHsKCSAgICAgIGlmIChjb21waWxlclJldmlzaW9uIDwgY3VycmVudFJldmlzaW9uKSB7CgkgICAgICAgIHZhciBydW50aW1lVmVyc2lvbnMgPSBSRVZJU0lPTl9DSEFOR0VTW2N1cnJlbnRSZXZpc2lvbl0sCgkgICAgICAgICAgICBjb21waWxlclZlcnNpb25zID0gUkVWSVNJT05fQ0hBTkdFU1tjb21waWxlclJldmlzaW9uXTsKCSAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiVGVtcGxhdGUgd2FzIHByZWNvbXBpbGVkIHdpdGggYW4gb2xkZXIgdmVyc2lvbiBvZiBIYW5kbGViYXJzIHRoYW4gdGhlIGN1cnJlbnQgcnVudGltZS4gIisKCSAgICAgICAgICAgICAgIlBsZWFzZSB1cGRhdGUgeW91ciBwcmVjb21waWxlciB0byBhIG5ld2VyIHZlcnNpb24gKCIrcnVudGltZVZlcnNpb25zKyIpIG9yIGRvd25ncmFkZSB5b3VyIHJ1bnRpbWUgdG8gYW4gb2xkZXIgdmVyc2lvbiAoIitjb21waWxlclZlcnNpb25zKyIpLiIpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgLy8gVXNlIHRoZSBlbWJlZGRlZCB2ZXJzaW9uIGluZm8gc2luY2UgdGhlIHJ1bnRpbWUgZG9lc24ndCBrbm93IGFib3V0IHRoaXMgcmV2aXNpb24geWV0CgkgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRlbXBsYXRlIHdhcyBwcmVjb21waWxlZCB3aXRoIGEgbmV3ZXIgdmVyc2lvbiBvZiBIYW5kbGViYXJzIHRoYW4gdGhlIGN1cnJlbnQgcnVudGltZS4gIisKCSAgICAgICAgICAgICAgIlBsZWFzZSB1cGRhdGUgeW91ciBydW50aW1lIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitjb21waWxlckluZm9bMV0rIikuIik7CgkgICAgICB9CgkgICAgfQoJICB9CgkKCSAgX19leHBvcnRzX18uY2hlY2tSZXZpc2lvbiA9IGNoZWNrUmV2aXNpb247Ly8gVE9ETzogUmVtb3ZlIHRoaXMgbGluZSBhbmQgYnJlYWsgdXAgY29tcGlsZVBhcnRpYWwKCQoJICBmdW5jdGlvbiB0ZW1wbGF0ZSh0ZW1wbGF0ZVNwZWMsIGVudikgewoJICAgIGlmICghZW52KSB7CgkgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJObyBlbnZpcm9ubWVudCBwYXNzZWQgdG8gdGVtcGxhdGUiKTsKCSAgICB9CgkKCSAgICAvLyBOb3RlOiBVc2luZyBlbnYuVk0gcmVmZXJlbmNlcyByYXRoZXIgdGhhbiBsb2NhbCB2YXIgcmVmZXJlbmNlcyB0aHJvdWdob3V0IHRoaXMgc2VjdGlvbiB0byBhbGxvdwoJICAgIC8vIGZvciBleHRlcm5hbCB1c2VycyB0byBvdmVycmlkZSB0aGVzZSBhcyBwc3VlZG8tc3VwcG9ydGVkIEFQSXMuCgkgICAgdmFyIGludm9rZVBhcnRpYWxXcmFwcGVyID0gZnVuY3Rpb24ocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKCSAgICAgIHZhciByZXN1bHQgPSBlbnYuVk0uaW52b2tlUGFydGlhbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7IHJldHVybiByZXN1bHQ7IH0KCQoJICAgICAgaWYgKGVudi5jb21waWxlKSB7CgkgICAgICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKCSAgICAgICAgcGFydGlhbHNbbmFtZV0gPSBlbnYuY29tcGlsZShwYXJ0aWFsLCB7IGRhdGE6IGRhdGEgIT09IHVuZGVmaW5lZCB9LCBlbnYpOwoJICAgICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwoJICAgICAgfQoJICAgIH07CgkKCSAgICAvLyBKdXN0IGFkZCB3YXRlcgoJICAgIHZhciBjb250YWluZXIgPSB7CgkgICAgICBlc2NhcGVFeHByZXNzaW9uOiBVdGlscy5lc2NhcGVFeHByZXNzaW9uLAoJICAgICAgaW52b2tlUGFydGlhbDogaW52b2tlUGFydGlhbFdyYXBwZXIsCgkgICAgICBwcm9ncmFtczogW10sCgkgICAgICBwcm9ncmFtOiBmdW5jdGlvbihpLCBmbiwgZGF0YSkgewoJICAgICAgICB2YXIgcHJvZ3JhbVdyYXBwZXIgPSB0aGlzLnByb2dyYW1zW2ldOwoJICAgICAgICBpZihkYXRhKSB7CgkgICAgICAgICAgcHJvZ3JhbVdyYXBwZXIgPSBwcm9ncmFtKGksIGZuLCBkYXRhKTsKCSAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKCSAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBwcm9ncmFtKGksIGZuKTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gcHJvZ3JhbVdyYXBwZXI7CgkgICAgICB9LAoJICAgICAgbWVyZ2U6IGZ1bmN0aW9uKHBhcmFtLCBjb21tb24pIHsKCSAgICAgICAgdmFyIHJldCA9IHBhcmFtIHx8IGNvbW1vbjsKCQoJICAgICAgICBpZiAocGFyYW0gJiYgY29tbW9uICYmIChwYXJhbSAhPT0gY29tbW9uKSkgewoJICAgICAgICAgIHJldCA9IHt9OwoJICAgICAgICAgIFV0aWxzLmV4dGVuZChyZXQsIGNvbW1vbik7CgkgICAgICAgICAgVXRpbHMuZXh0ZW5kKHJldCwgcGFyYW0pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiByZXQ7CgkgICAgICB9LAoJICAgICAgcHJvZ3JhbVdpdGhEZXB0aDogZW52LlZNLnByb2dyYW1XaXRoRGVwdGgsCgkgICAgICBub29wOiBlbnYuVk0ubm9vcCwKCSAgICAgIGNvbXBpbGVySW5mbzogbnVsbAoJICAgIH07CgkKCSAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgICAgICB2YXIgbmFtZXNwYWNlID0gb3B0aW9ucy5wYXJ0aWFsID8gb3B0aW9ucyA6IGVudiwKCSAgICAgICAgICBoZWxwZXJzLAoJICAgICAgICAgIHBhcnRpYWxzOwoJCgkgICAgICBpZiAoIW9wdGlvbnMucGFydGlhbCkgewoJICAgICAgICBoZWxwZXJzID0gb3B0aW9ucy5oZWxwZXJzOwoJICAgICAgICBwYXJ0aWFscyA9IG9wdGlvbnMucGFydGlhbHM7CgkgICAgICB9CgkgICAgICB2YXIgcmVzdWx0ID0gdGVtcGxhdGVTcGVjLmNhbGwoCgkgICAgICAgICAgICBjb250YWluZXIsCgkgICAgICAgICAgICBuYW1lc3BhY2UsIGNvbnRleHQsCgkgICAgICAgICAgICBoZWxwZXJzLAoJICAgICAgICAgICAgcGFydGlhbHMsCgkgICAgICAgICAgICBvcHRpb25zLmRhdGEpOwoJCgkgICAgICBpZiAoIW9wdGlvbnMucGFydGlhbCkgewoJICAgICAgICBlbnYuVk0uY2hlY2tSZXZpc2lvbihjb250YWluZXIuY29tcGlsZXJJbmZvKTsKCSAgICAgIH0KCQoJICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9OwoJICB9CgkKCSAgX19leHBvcnRzX18udGVtcGxhdGUgPSB0ZW1wbGF0ZTtmdW5jdGlvbiBwcm9ncmFtV2l0aERlcHRoKGksIGZuLCBkYXRhIC8qLCAkZGVwdGggKi8pIHsKCSAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CgkKCSAgICB2YXIgcHJvZyA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCgkgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwoJICAgIH07CgkgICAgcHJvZy5wcm9ncmFtID0gaTsKCSAgICBwcm9nLmRlcHRoID0gYXJncy5sZW5ndGg7CgkgICAgcmV0dXJuIHByb2c7CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5wcm9ncmFtV2l0aERlcHRoID0gcHJvZ3JhbVdpdGhEZXB0aDtmdW5jdGlvbiBwcm9ncmFtKGksIGZuLCBkYXRhKSB7CgkgICAgdmFyIHByb2cgPSBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQoJICAgICAgcmV0dXJuIGZuKGNvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhKTsKCSAgICB9OwoJICAgIHByb2cucHJvZ3JhbSA9IGk7CgkgICAgcHJvZy5kZXB0aCA9IDA7CgkgICAgcmV0dXJuIHByb2c7CgkgIH0KCQoJICBfX2V4cG9ydHNfXy5wcm9ncmFtID0gcHJvZ3JhbTtmdW5jdGlvbiBpbnZva2VQYXJ0aWFsKHBhcnRpYWwsIG5hbWUsIGNvbnRleHQsIGhlbHBlcnMsIHBhcnRpYWxzLCBkYXRhKSB7CgkgICAgdmFyIG9wdGlvbnMgPSB7IHBhcnRpYWw6IHRydWUsIGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoJCgkgICAgaWYocGFydGlhbCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CgkgICAgfSBlbHNlIGlmKHBhcnRpYWwgaW5zdGFuY2VvZiBGdW5jdGlvbikgewoJICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CgkgICAgfQoJICB9CgkKCSAgX19leHBvcnRzX18uaW52b2tlUGFydGlhbCA9IGludm9rZVBhcnRpYWw7ZnVuY3Rpb24gbm9vcCgpIHsgcmV0dXJuICIiOyB9CgkKCSAgX19leHBvcnRzX18ubm9vcCA9IG5vb3A7CgkgIHJldHVybiBfX2V4cG9ydHNfXzsKCX0pKF9fbW9kdWxlMl9fLCBfX21vZHVsZTRfXywgX19tb2R1bGUxX18pOwoJCgkvLyBoYW5kbGViYXJzLnJ1bnRpbWUuanMKCXZhciBfX21vZHVsZTBfXyA9IChmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZGVwZW5kZW5jeTJfXywgX19kZXBlbmRlbmN5M19fLCBfX2RlcGVuZGVuY3k0X18sIF9fZGVwZW5kZW5jeTVfXykgewoJICAidXNlIHN0cmljdCI7CgkgIHZhciBfX2V4cG9ydHNfXzsKCSAgLypnbG9iYWxzIEhhbmRsZWJhcnM6IHRydWUgKi8KCSAgdmFyIGJhc2UgPSBfX2RlcGVuZGVuY3kxX187CgkKCSAgLy8gRWFjaCBvZiB0aGVzZSBhdWdtZW50IHRoZSBIYW5kbGViYXJzIG9iamVjdC4gTm8gbmVlZCB0byBzZXR1cCBoZXJlLgoJICAvLyAoVGhpcyBpcyBkb25lIHRvIGVhc2lseSBzaGFyZSBjb2RlIGJldHdlZW4gY29tbW9uanMgYW5kIGJyb3dzZSBlbnZzKQoJICB2YXIgU2FmZVN0cmluZyA9IF9fZGVwZW5kZW5jeTJfXzsKCSAgdmFyIEV4Y2VwdGlvbiA9IF9fZGVwZW5kZW5jeTNfXzsKCSAgdmFyIFV0aWxzID0gX19kZXBlbmRlbmN5NF9fOwoJICB2YXIgcnVudGltZSA9IF9fZGVwZW5kZW5jeTVfXzsKCQoJICAvLyBGb3IgY29tcGF0aWJpbGl0eSBhbmQgdXNhZ2Ugb3V0c2lkZSBvZiBtb2R1bGUgc3lzdGVtcywgbWFrZSB0aGUgSGFuZGxlYmFycyBvYmplY3QgYSBuYW1lc3BhY2UKCSAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBoYiA9IG5ldyBiYXNlLkhhbmRsZWJhcnNFbnZpcm9ubWVudCgpOwoJCgkgICAgVXRpbHMuZXh0ZW5kKGhiLCBiYXNlKTsKCSAgICBoYi5TYWZlU3RyaW5nID0gU2FmZVN0cmluZzsKCSAgICBoYi5FeGNlcHRpb24gPSBFeGNlcHRpb247CgkgICAgaGIuVXRpbHMgPSBVdGlsczsKCQoJICAgIGhiLlZNID0gcnVudGltZTsKCSAgICBoYi50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHNwZWMpIHsKCSAgICAgIHJldHVybiBydW50aW1lLnRlbXBsYXRlKHNwZWMsIGhiKTsKCSAgICB9OwoJCgkgICAgcmV0dXJuIGhiOwoJICB9OwoJCgkgIHZhciBIYW5kbGViYXJzID0gY3JlYXRlKCk7CgkgIEhhbmRsZWJhcnMuY3JlYXRlID0gY3JlYXRlOwoJCgkgIF9fZXhwb3J0c19fID0gSGFuZGxlYmFyczsKCSAgcmV0dXJuIF9fZXhwb3J0c19fOwoJfSkoX19tb2R1bGUxX18sIF9fbW9kdWxlM19fLCBfX21vZHVsZTRfXywgX19tb2R1bGUyX18sIF9fbW9kdWxlNV9fKTsKCQoJICByZXR1cm4gX19tb2R1bGUwX187Cgl9KSgpOwoJLy8ganNoaW50IGlnbm9yZTpzdGFydAoJVXRpbC5IYW5kbGViYXJzID0gSGFuZGxlYmFyczsKCS8vIGpzaGludCBpZ25vcmU6ZW5kCgkvLyBjaGFuZ2UgInRoaXMiIHRvIGEgY3VzdG9tIHNjb3BlIHRoYXQgaGFzIF8gYW5kICQuCgl2YXIgQmFja2JvbmUgPSBVdGlsLkJhY2tib25lID0gKGZ1bmN0aW9uKCkgewoJCS8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoJCQoJCS8vICAgICAoYykgMjAxMC0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCgkJLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoJCS8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CgkJLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoJCQoJCShmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgkJCgkJICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KCQkgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQkgICAgZGVmaW5lKFsndW5kZXJzY29yZScsICdqcXVlcnknLCAnZXhwb3J0cyddLCBmdW5jdGlvbihfLCAkLCBleHBvcnRzKSB7CgkJICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKCQkgICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgoJCSAgICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJCSAgICB9KTsKCQkKCQkgIC8vIE5leHQgZm9yIE5vZGUuanMgb3IgQ29tbW9uSlMuIGpRdWVyeSBtYXkgbm90IGJlIG5lZWRlZCBhcyBhIG1vZHVsZS4KCQkgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CgkJICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoJCSAgICBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8pOwoJCQoJCSAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KCQkgIH0gZWxzZSB7CgkJICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CgkJICB9CgkJCgkJfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoJCQoJCSAgLy8gSW5pdGlhbCBTZXR1cAoJCSAgLy8gLS0tLS0tLS0tLS0tLQoJCQoJCSAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCgkJICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCgkJICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgkJCgkJICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgoJCSAgdmFyIGFycmF5ID0gW107CgkJICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CgkJICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKCQkgIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgkJCgkJICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgoJCSAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgkJCgkJICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKCQkgIC8vIHRoZSBgJGAgdmFyaWFibGUuCgkJICBCYWNrYm9uZS4kID0gJDsKCQkKCQkgIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQoJCSAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgoJCSAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJCSAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKCQkgICAgcmV0dXJuIHRoaXM7CgkJICB9OwoJCQoJCSAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgoJCSAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCgkJICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJCSAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCQkKCQkgIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAoJCSAgLy8gYGFwcGxpY2F0aW9uL2pzb25gIHJlcXVlc3RzIC4uLiB3aWxsIGVuY29kZSB0aGUgYm9keSBhcwoJCSAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCgkJICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkJICBCYWNrYm9uZS5lbXVsYXRlSlNPTiA9IGZhbHNlOwoJCQoJCSAgLy8gQmFja2JvbmUuRXZlbnRzCgkJICAvLyAtLS0tLS0tLS0tLS0tLS0KCQkKCQkgIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKCQkgIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKCQkgIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCgkJICAvLyBzdWNjZXNzaW9uLgoJCSAgLy8KCQkgIC8vICAgICB2YXIgb2JqZWN0ID0ge307CgkJICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwoJCSAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwoJCSAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKCQkgIC8vCgkJICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoJCQoJCSAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAoJCSAgICAvLyB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KCQkgICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCQkgICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKCQkgICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CgkJICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQoJCSAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgoJCSAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCQkgICAgICB2YXIgc2VsZiA9IHRoaXM7CgkJICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CgkJICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKCQkgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgICAgfSk7CgkJICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKCQkgICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkJICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCQkgICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAoJCSAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCgkJICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCQkgICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKCQkgICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CgkJICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewoJCSAgICAgICAgdGhpcy5fZXZlbnRzID0gdm9pZCAwOwoJCSAgICAgICAgcmV0dXJuIHRoaXM7CgkJICAgICAgfQoJCSAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwoJCSAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkgICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKCQkgICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKCQkgICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CgkJICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CgkJICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKCQkgICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwoJCSAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKCQkgICAgICAgICAgICAgICAgICAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewoJCSAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CgkJICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICB9CgkJICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJCgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQoJCSAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQoJCSAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCgkJICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCQkgICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewoJCSAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKCQkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKCQkgICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwoJCSAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoJCSAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKCQkgICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgoJCSAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgoJCSAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkJICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CgkJICAgICAgaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CgkJICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKCQkgICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJCSAgICAgIGlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKCQkgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewoJCSAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwoJCSAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CgkJICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CgkJICAgICAgfQoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9CgkJCgkJICB9OwoJCQoJCSAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KCQkgIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgkJCgkJICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAoJCSAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKCQkgIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCgkJICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKCQkgICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCQkKCQkgICAgLy8gSGFuZGxlIGV2ZW50IG1hcHMuCgkJICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKCQkgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewoJCSAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CgkJICAgICAgfQoJCSAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfQoJCQoJCSAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgoJCSAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CgkJICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKCQkgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CgkJICAgICAgfQoJCSAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfQoJCQoJCSAgICByZXR1cm4gdHJ1ZTsKCQkgIH07CgkJCgkJICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgoJCSAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAoJCSAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgoJCSAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKCQkgICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwoJCSAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CgkJICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKCQkgICAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSk7IHJldHVybjsKCQkgICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CgkJICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKCQkgICAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOyByZXR1cm47CgkJICAgIH0KCQkgIH07CgkJCgkJICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoJCQoJCSAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KCQkgIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKCQkgIC8vIGxpc3RlbmluZyB0by4KCQkgIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbihpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CgkJICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewoJCSAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKCQkgICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbklkIHx8IChvYmouX2xpc3RlbklkID0gXy51bmlxdWVJZCgnbCcpKTsKCQkgICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CgkJICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCQkgICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfTsKCQkgIH0pOwoJCQoJCSAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgkJICBFdmVudHMuYmluZCAgID0gRXZlbnRzLm9uOwoJCSAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgkJCgkJICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCgkJICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCgkJICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCQkKCQkgIC8vIEJhY2tib25lLk1vZGVsCgkJICAvLyAtLS0tLS0tLS0tLS0tLQoJCQoJCSAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KCQkgIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KCQkgIC8vIEEgZGlzY3JldGUgY2h1bmsgb2YgZGF0YSBhbmQgYSBidW5jaCBvZiB1c2VmdWwsIHJlbGF0ZWQgbWV0aG9kcyBmb3IKCQkgIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoJCQoJCSAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggdGhlIHNwZWNpZmllZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCgkJICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KCQkgIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewoJCSAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwoJCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCSAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKCQkgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CgkJICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKCQkgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CgkJICAgIGF0dHJzID0gXy5kZWZhdWx0cyh7fSwgYXR0cnMsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKTsKCQkgICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJCSAgICB0aGlzLmNoYW5nZWQgPSB7fTsKCQkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICB9OwoJCQoJCSAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCgkJICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoJCQoJCSAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB3aG9zZSBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIuCgkJICAgIGNoYW5nZWQ6IG51bGwsCgkJCgkJICAgIC8vIFRoZSB2YWx1ZSByZXR1cm5lZCBkdXJpbmcgdGhlIGxhc3QgZmFpbGVkIHZhbGlkYXRpb24uCgkJICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCQkKCQkgICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAoJCSAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCgkJICAgIGlkQXR0cmlidXRlOiAnaWQnLAoJCQoJCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCQkKCQkgICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgoJCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAoJCSAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgoJCSAgICBzeW5jOiBmdW5jdGlvbigpIHsKCQkgICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KCQkgICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgoJCSAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKCQkgICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAoJCSAgICAvLyBvciB1bmRlZmluZWQuCgkJICAgIGhhczogZnVuY3Rpb24oYXR0cikgewoJCSAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKCQkgICAgLy8gdGhlIGNvcmUgcHJpbWl0aXZlIG9wZXJhdGlvbiBvZiBhIG1vZGVsLCB1cGRhdGluZyB0aGUgZGF0YSBhbmQgbm90aWZ5aW5nCgkJICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgoJCSAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkJICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKCQkgICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoJCQoJCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJCSAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJCSAgICAgICAgYXR0cnMgPSBrZXk7CgkJICAgICAgICBvcHRpb25zID0gdmFsOwoJCSAgICAgIH0gZWxzZSB7CgkJICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKCQkgICAgICB9CgkJCgkJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQkKCQkgICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KCQkgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoJCQoJCSAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KCQkgICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwoJCSAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwoJCSAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwoJCSAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwoJCSAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgkJCgkJICAgICAgaWYgKCFjaGFuZ2luZykgewoJCSAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJCSAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CgkJICAgICAgfQoJCSAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgkJCgkJICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KCQkgICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoJCQoJCSAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KCQkgICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKCQkgICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwoJCSAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwoJCSAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewoJCSAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CgkJICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwoJCSAgICAgICAgfQoJCSAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgoJCSAgICAgIGlmICghc2lsZW50KSB7CgkJICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSBvcHRpb25zOwoJCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CgkJICAgICAgICB9CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KCQkgICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgoJCSAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7CgkJICAgICAgaWYgKCFzaWxlbnQpIHsKCQkgICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CgkJICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLl9wZW5kaW5nOwoJCSAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CgkJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CgkJICAgICAgICB9CgkJICAgICAgfQoJCSAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKCQkgICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKCQkgICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgoJCSAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewoJCSAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCgkJICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgdmFyIGF0dHJzID0ge307CgkJICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKCQkgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KCQkgICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KCQkgICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewoJCSAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CgkJICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCgkJICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAoJCSAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQoJCSAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCgkJICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCgkJICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCgkJICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CgkJICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKCQkgICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CgkJICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwoJCSAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewoJCSAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwoJCSAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwoJCSAgICAgIH0KCQkgICAgICByZXR1cm4gY2hhbmdlZDsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CgkJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgoJCSAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewoJCSAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CgkJICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCgkJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCgkJICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQoJCSAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCgkJICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgoJCSAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewoJCSAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgIH07CgkJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoJCSAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KCQkgICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCgkJICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCgkJICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkJICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCQkKCQkgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KCQkgICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKCQkgICAgICAgIGF0dHJzID0ga2V5OwoJCSAgICAgICAgb3B0aW9ucyA9IHZhbDsKCQkgICAgICB9IGVsc2UgewoJCSAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CgkJICAgICAgfQoJCQoJCSAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCQkKCQkgICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCgkJICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKCQkgICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCgkJICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKCQkgICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkJICAgICAgfSBlbHNlIHsKCQkgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KCQkgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CgkJICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKCQkgICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgoJCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewoJCSAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KCQkgICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoJCSAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CgkJICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CgkJICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKCQkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkgICAgICB9OwoJCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCQkKCQkgICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKCQkgICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CgkJICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgkJCgkJICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgoJCSAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgkJCgkJICAgICAgcmV0dXJuIHhocjsKCQkgICAgfSwKCQkKCQkgICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgoJCSAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgoJCSAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgoJCSAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCQkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCQkKCQkgICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJCSAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKCQkgICAgICB9OwoJCQoJCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCQkgICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwoJCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgIH07CgkJCgkJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewoJCSAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CgkJICAgICAgICByZXR1cm4gZmFsc2U7CgkJICAgICAgfQoJCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCQkKCQkgICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwoJCSAgICAgIHJldHVybiB4aHI7CgkJICAgIH0sCgkJCgkJICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQoJCSAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CgkJICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCgkJICAgIHVybDogZnVuY3Rpb24oKSB7CgkJICAgICAgdmFyIGJhc2UgPQoJCSAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAoJCSAgICAgICAgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwKCQkgICAgICAgIHVybEVycm9yKCk7CgkJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CgkJICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CgkJICAgIH0sCgkJCgkJICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgoJCSAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCgkJICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHJlc3A7CgkJICAgIH0sCgkJCgkJICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgoJCSAgICBjbG9uZTogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KCQkgICAgaXNOZXc6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiAhdGhpcy5oYXModGhpcy5pZEF0dHJpYnV0ZSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KCQkgICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCgkJICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KCQkgICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewoJCSAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CgkJICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CgkJICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwoJCSAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwoJCSAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zLCB7dmFsaWRhdGlvbkVycm9yOiBlcnJvcn0pKTsKCQkgICAgICByZXR1cm4gZmFsc2U7CgkJICAgIH0KCQkKCQkgIH0pOwoJCQoJCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgoJCSAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoJCQoJCSAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgTW9kZWwjYXR0cmlidXRlc2AuCgkJICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCQkgICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKCQkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCQkgICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKCQkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJCSAgICB9OwoJCSAgfSk7CgkJCgkJICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCgkJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwoJCSAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CgkJICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KCQkgIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKCQkgIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCgkJICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCQkKCQkgIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgoJCSAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCgkJICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuCgkJICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCQkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCQkgICAgaWYgKG9wdGlvbnMubW9kZWwpIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwoJCSAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKCQkgICAgdGhpcy5fcmVzZXQoKTsKCQkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJCSAgfTsKCQkKCQkgIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KCQkgIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CgkJICB2YXIgYWRkT3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogZmFsc2V9OwoJCQoJCSAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KCQkgIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCQkKCQkgICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgoJCSAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCgkJICAgIG1vZGVsOiBNb2RlbCwKCQkKCQkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkJICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgkJCgkJICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKCQkgICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgoJCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCgkJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgoJCSAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJCSAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KCQkgICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCQkgICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CgkJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKCQkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCSAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CgkJICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKCQkgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwoJCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwoJCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKCQkgICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKCQkgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CgkJICAgICAgICB0aGlzLmxlbmd0aC0tOwoJCSAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewoJCSAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CgkJICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CgkJICAgICAgfQoJCSAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKCQkgICAgfSwKCQkKCQkgICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKCQkgICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAoJCSAgICAvLyBhbHJlYWR5IGV4aXN0IGluIHRoZSBjb2xsZWN0aW9uLCBhcyBuZWNlc3NhcnkuIFNpbWlsYXIgdG8gKipNb2RlbCNzZXQqKiwKCQkgICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCgkJICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkJICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldE9wdGlvbnMpOwoJCSAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CgkJICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwoJCSAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gKG1vZGVscyA/IFttb2RlbHNdIDogW10pIDogXy5jbG9uZShtb2RlbHMpOwoJCSAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKCQkgICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwoJCSAgICAgIHZhciB0YXJnZXRNb2RlbCA9IHRoaXMubW9kZWw7CgkJICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwoJCSAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CgkJICAgICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CgkJICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwoJCSAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCQkKCQkgICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCgkJICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KCQkgICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CgkJICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewoJCSAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CgkJICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKCQkgICAgICAgIH0KCQkKCQkgICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCgkJICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgoJCSAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CgkJICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwoJCSAgICAgICAgICBpZiAobWVyZ2UpIHsKCQkgICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKCQkgICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CgkJICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKCQkgICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwoJCSAgICAgICAgICB9CgkJICAgICAgICAgIG1vZGVsc1tpXSA9IGV4aXN0aW5nOwoJCQoJCSAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KCQkgICAgICAgIH0gZWxzZSBpZiAoYWRkKSB7CgkJICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKCQkgICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkJICAgICAgICAgIHRvQWRkLnB1c2gobW9kZWwpOwoJCSAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwoJCSAgICAgICAgfQoJCQoJCSAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgoJCSAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKCQkgICAgICAgIGlmIChvcmRlciAmJiAobW9kZWwuaXNOZXcoKSB8fCAhbW9kZWxNYXBbbW9kZWwuaWRdKSkgb3JkZXIucHVzaChtb2RlbCk7CgkJICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgoJCSAgICAgIGlmIChyZW1vdmUpIHsKCQkgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewoJCSAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKCQkgICAgICB9CgkJCgkJICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLgoJCSAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKCQkgICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CgkJICAgICAgICB0aGlzLmxlbmd0aCArPSB0b0FkZC5sZW5ndGg7CgkJICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewoJCSAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJICAgICAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGF0ICsgaSwgMCwgdG9BZGRbaV0pOwoJCSAgICAgICAgICB9CgkJICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICBpZiAob3JkZXIpIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CgkJICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CgkJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgICAgIHRoaXMubW9kZWxzLnB1c2gob3JkZXJlZE1vZGVsc1tpXSk7CgkJICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICB9CgkJCgkJICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KCQkgICAgICBpZiAoc29ydCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCQkKCQkgICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCgkJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewoJCSAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCSAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgoJCSAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKCQkgICAgfSwKCQkKCQkgICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCgkJICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKCQkgICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgoJCSAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KCQkgICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSwgb3B0aW9ucyk7CgkJICAgICAgfQoJCSAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKCQkgICAgICB0aGlzLl9yZXNldCgpOwoJCSAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKCQkgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CgkJICAgICAgcmV0dXJuIG1vZGVsczsKCQkgICAgfSwKCQkKCQkgICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCQkgICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCQkgICAgcG9wOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwoJCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gbW9kZWw7CgkJICAgIH0sCgkJCgkJICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCgkJICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KCQkgICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwoJCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gbW9kZWw7CgkJICAgIH0sCgkJCgkJICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KCQkgICAgc2xpY2U6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgoJCSAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewoJCSAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKCQkgICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwoJCSAgICB9LAoJCQoJCSAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KCQkgICAgYXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkJICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCgkJICAgIC8vIGBmaWx0ZXJgLgoJCSAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMsIGZpcnN0KSB7CgkJICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwoJCSAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CgkJICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKCQkgICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gdHJ1ZTsKCQkgICAgICB9KTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCgkJICAgIC8vIG9mIGBmaW5kYC4KCQkgICAgZmluZFdoZXJlOiBmdW5jdGlvbihhdHRycykgewoJCSAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgoJCSAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCgkJICAgIC8vIGlzIGFkZGVkLgoJCSAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKCQkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCQoJCSAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgoJCSAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewoJCSAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwoJCSAgICAgIH0gZWxzZSB7CgkJICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKCQkgICAgICB9CgkJCgkJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCgkJICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CgkJICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CgkJICAgIH0sCgkJCgkJICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQoJCSAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKCQkgICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgoJCSAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewoJCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCQkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkJICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy5yZXNldCA/ICdyZXNldCcgOiAnc2V0JzsKCQkgICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKCQkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwoJCSAgICAgICAgY29sbGVjdGlvbi50cmlnZ2VyKCdzeW5jJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgfTsKCQkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkJICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCgkJICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCgkJICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCgkJICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCQkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCQkgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CgkJICAgICAgaWYgKCFvcHRpb25zLndhaXQpIHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CgkJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3ApIHsKCQkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKCQkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkgICAgICB9OwoJCSAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CgkJICAgICAgcmV0dXJuIG1vZGVsOwoJCSAgICB9LAoJCQoJCSAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCgkJICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgoJCSAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewoJCSAgICAgIHJldHVybiByZXNwOwoJCSAgICB9LAoJCQoJCSAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KCQkgICAgY2xvbmU6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KCQkgICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCgkJICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CgkJICAgICAgdGhpcy5sZW5ndGggPSAwOwoJCSAgICAgIHRoaXMubW9kZWxzID0gW107CgkJICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKCQkgICAgfSwKCQkKCQkgICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKCQkgICAgLy8gY29sbGVjdGlvbi4KCQkgICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCQkgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgcmV0dXJuIGF0dHJzOwoJCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJCSAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CgkJICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwoJCSAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKSByZXR1cm4gbW9kZWw7CgkJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gZmFsc2U7CgkJICAgIH0sCgkJCgkJICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBjcmVhdGUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgoJCSAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJCSAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwoJCSAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwoJCSAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CgkJICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CgkJICAgIH0sCgkJCgkJICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCgkJICAgIF9yZW1vdmVSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwoJCSAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KCQkgICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgoJCSAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKCQkgICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCgkJICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50LCBtb2RlbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewoJCSAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwoJCSAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CgkJICAgICAgaWYgKG1vZGVsICYmIGV2ZW50ID09PSAnY2hhbmdlOicgKyBtb2RlbC5pZEF0dHJpYnV0ZSkgewoJCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKCQkgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwoJCSAgICAgIH0KCQkgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgICAgfQoJCQoJCSAgfSk7CgkJCgkJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KCQkgIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCgkJICAvLyByaWdodCBoZXJlOgoJCSAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAoJCSAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAoJCSAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCgkJICAgICdtYXgnLCAnbWluJywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLCAnaW5pdGlhbCcsICdyZXN0JywKCQkgICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAoJCSAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbicsICdzYW1wbGUnXTsKCQkKCQkgIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KCQkgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCQkgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJCSAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwoJCSAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CgkJICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKCQkgICAgfTsKCQkgIH0pOwoJCQoJCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCgkJICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgkJCgkJICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCgkJICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CgkJICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewoJCSAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CgkJICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKCQkgICAgICB9OwoJCSAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKCQkgICAgfTsKCQkgIH0pOwoJCQoJCSAgLy8gQmFja2JvbmUuVmlldwoJCSAgLy8gLS0tLS0tLS0tLS0tLQoJCQoJCSAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CgkJICAvLyBpcyBzaW1wbHkgYSBKYXZhU2NyaXB0IG9iamVjdCB0aGF0IHJlcHJlc2VudHMgYSBsb2dpY2FsIGNodW5rIG9mIFVJIGluIHRoZQoJCSAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCgkJICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgoJCSAgLy8gVUkgYXMgYSAqKlZpZXcqKiBhbGxvd3MgeW91IHRvIGRlZmluZSB5b3VyIERPTSBldmVudHMgZGVjbGFyYXRpdmVseSwgd2l0aG91dAoJCSAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCgkJICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCQkKCQkgIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAoJCSAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KCQkgIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CgkJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwoJCSAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CgkJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCSAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkJICB9OwoJCQoJCSAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCgkJICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCQkKCQkgIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgoJCSAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgkJCgkJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkJICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgkJCgkJICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCgkJICAgIHRhZ05hbWU6ICdkaXYnLAoJCQoJCSAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKCQkgICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCgkJICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CgkJICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCQkKCQkgICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCgkJICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKCQkgICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KCQkgICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKCQkgICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgoJCSAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewoJCSAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwoJCSAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKCQkgICAgLy8gcmUtZGVsZWdhdGlvbi4KCQkgICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsKCQkgICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwoJCSAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKCQkgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CgkJICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgoJCSAgICAvLwoJCSAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgoJCSAgICAvLwoJCSAgICAvLyAgICAgewoJCSAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCgkJICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKCQkgICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQoJCSAgICAvLyAgICAgfQoJCSAgICAvLwoJCSAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KCQkgICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgoJCSAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KCQkgICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCgkJICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgoJCSAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CgkJICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CgkJICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CgkJICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewoJCSAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwoJCSAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CgkJICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgkJCgkJICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKCQkgICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkgICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwoJCSAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CgkJICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CgkJICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKCQkgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CgkJICAgICAgICB9CgkJICAgICAgfQoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KCQkgICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCgkJICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgoJCSAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkgICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CgkJICAgICAgcmV0dXJuIHRoaXM7CgkJICAgIH0sCgkJCgkJICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgoJCSAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKCQkgICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQoJCSAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KCQkgICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewoJCSAgICAgIGlmICghdGhpcy5lbCkgewoJCSAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwoJCSAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CgkJICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwoJCSAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CgkJICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CgkJICAgICAgfSBlbHNlIHsKCQkgICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwoJCSAgICAgIH0KCQkgICAgfQoJCQoJCSAgfSk7CgkJCgkJICAvLyBCYWNrYm9uZS5zeW5jCgkJICAvLyAtLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCgkJICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKCQkgIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CgkJICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgoJCSAgLy8KCQkgIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgoJCSAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KCQkgIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgoJCSAgLy8KCQkgIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwoJCSAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAoJCSAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAoJCSAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgoJCSAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQoJCSAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCgkJICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewoJCSAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoJCQoJCSAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCgkJICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewoJCSAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwKCQkgICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KCQkgICAgfSk7CgkJCgkJICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCgkJICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgkJCgkJICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCgkJICAgIGlmICghb3B0aW9ucy51cmwpIHsKCQkgICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwoJCSAgICB9CgkJCgkJICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KCQkgICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewoJCSAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKCQkgICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKCQkgICAgfQoJCQoJCSAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgoJCSAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewoJCSAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwoJCSAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9OwoJCSAgICB9CgkJCgkJICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAoJCSAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KCQkgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CgkJICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CgkJICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwoJCSAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwoJCSAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgewoJCSAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKCQkgICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCSAgICAgIH07CgkJICAgIH0KCQkKCQkgICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgoJCSAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkJICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CgkJICAgIH0KCQkKCQkgICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgoJCSAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CgkJICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KCQkgICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKCQkgICAgICBwYXJhbXMueGhyID0gZnVuY3Rpb24oKSB7CgkJICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CgkJICAgICAgfTsKCQkgICAgfQoJCQoJCSAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgoJCSAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwoJCSAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CgkJICAgIHJldHVybiB4aHI7CgkJICB9OwoJCQoJCSAgdmFyIG5vWGhyUGF0Y2ggPQoJCSAgICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmCgkJICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgkJCgkJICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KCQkgIHZhciBtZXRob2RNYXAgPSB7CgkJICAgICdjcmVhdGUnOiAnUE9TVCcsCgkJICAgICd1cGRhdGUnOiAnUFVUJywKCQkgICAgJ3BhdGNoJzogICdQQVRDSCcsCgkJICAgICdkZWxldGUnOiAnREVMRVRFJywKCQkgICAgJ3JlYWQnOiAgICdHRVQnCgkJICB9OwoJCQoJCSAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KCQkgIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KCQkgIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKCQkgICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwoJCSAgfTsKCQkKCQkgIC8vIEJhY2tib25lLlJvdXRlcgoJCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgkJCgkJICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQoJCSAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KCQkgIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKCQkgICAgdGhpcy5fYmluZFJvdXRlcygpOwoJCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkgIH07CgkJCgkJICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCgkJICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgoJCSAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CgkJICB2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwoJCSAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKCQkgIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgkJCgkJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCQkgIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoJCQoJCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCQkKCQkgICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKCQkgICAgLy8KCQkgICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewoJCSAgICAvLyAgICAgICAuLi4KCQkgICAgLy8gICAgIH0pOwoJCSAgICAvLwoJCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CgkJICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKCQkgICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CgkJICAgICAgICBjYWxsYmFjayA9IG5hbWU7CgkJICAgICAgICBuYW1lID0gJyc7CgkJICAgICAgfQoJCSAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKCQkgICAgICB2YXIgcm91dGVyID0gdGhpczsKCQkgICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewoJCSAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CgkJICAgICAgICByb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CgkJICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CgkJICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKCQkgICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwoJCSAgICAgIH0pOwoJCSAgICAgIHJldHVybiB0aGlzOwoJCSAgICB9LAoJCQoJCSAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgoJCSAgICAvLyBleGNlbGxlbnQgcGxhY2UgdG8gZG8gcHJlLXJvdXRlIHNldHVwIG9yIHBvc3Qtcm91dGUgY2xlYW51cC4KCQkgICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKCQkgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgoJCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCQkgICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKCQkgICAgICByZXR1cm4gdGhpczsKCQkgICAgfSwKCQkKCQkgICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCgkJICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKCQkgICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KCQkgICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJCSAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKCQkgICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKCQkgICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CgkJICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewoJCSAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKCQkgICAgICB9CgkJICAgIH0sCgkJCgkJICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCgkJICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KCQkgICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CgkJICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQoJCSAgICAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCgkJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewoJCSAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKCQkgICAgICAgICAgICAgICAgICAgfSkKCQkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CgkJICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgoJCSAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCgkJICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgoJCSAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewoJCSAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKCQkgICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewoJCSAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgoJCSAgICAgICAgaWYgKGkgPT09IHBhcmFtcy5sZW5ndGggLSAxKSByZXR1cm4gcGFyYW0gfHwgbnVsbDsKCQkgICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwoJCSAgICAgIH0pOwoJCSAgICB9CgkJCgkJICB9KTsKCQkKCQkgIC8vIEJhY2tib25lLkhpc3RvcnkKCQkgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCQkKCQkgIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgoJCSAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCgkJICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQoJCSAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAoJCSAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgoJCSAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CgkJICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKCQkgICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoJCQoJCSAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KCQkgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgkJICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCQkgICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKCQkgICAgfQoJCSAgfTsKCQkKCQkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KCQkgIHZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CgkJCgkJICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgoJCSAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCQkKCQkgIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCgkJICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgkJCgkJICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCgkJICB2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoJCQoJCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgoJCSAgdmFyIHBhdGhTdHJpcHBlciA9IC8jLiokLzsKCQkKCQkgIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KCQkgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoJCQoJCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJCSAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoJCQoJCSAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKCQkgICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgoJCSAgICBpbnRlcnZhbDogNTAsCgkJCgkJICAgIC8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CgkJICAgIGF0Um9vdDogZnVuY3Rpb24oKSB7CgkJICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgkJICAgIH0sCgkJCgkJICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKCQkgICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCgkJICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewoJCSAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKCQkgICAgfSwKCQkKCQkgICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAoJCSAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgoJCSAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CgkJICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKCQkgICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewoJCSAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwoJCSAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKCQkgICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKCQkgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CgkJICAgICAgICB9CgkJICAgICAgfQoJCSAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCQkgICAgfSwKCQkKCQkgICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCgkJICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCgkJICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CgkJICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwoJCSAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgkJCgkJICAgICAgLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLiBEbyB3ZSBuZWVkIGFuIGlmcmFtZT8KCQkgICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwoJCSAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJCSAgICAgIHRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290OwoJCSAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKCQkgICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CgkJICAgICAgdGhpcy5faGFzUHVzaFN0YXRlICAgID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CgkJICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJCSAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCQkgICAgICB2YXIgb2xkSUUgICAgICAgICAgICAgPSAoaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNykpOwoJCQoJCSAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCgkJICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgkJCgkJICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCSAgICAgICAgdmFyIGZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIj4nKTsKCQkgICAgICAgIHRoaXMuaWZyYW1lID0gZnJhbWUuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKCQkgICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwoJCSAgICAgIH0KCQkKCQkgICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgoJCSAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgoJCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCQkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKCQkgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKCQkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CgkJICAgICAgfQoJCQoJCSAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCgkJICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgoJCSAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCQkgICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKCQkKCQkgICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQoJCSAgICAgIC8vIHJlcXVlc3RlZC4KCQkgICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgkJCgkJICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKCQkgICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCgkJICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewoJCSAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKCQkgICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwoJCSAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKCQkgICAgICAgICAgcmV0dXJuIHRydWU7CgkJCgkJICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQoJCSAgICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KCQkgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKCQkgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwoJCSAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CgkJICAgICAgICB9CgkJCgkJICAgICAgfQoJCQoJCSAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKCQkgICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCgkJICAgIHN0b3A6IGZ1bmN0aW9uKCkgewoJCSAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CgkJICAgICAgaWYgKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CgkJICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgkJICAgIH0sCgkJCgkJICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKCQkgICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KCQkgICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewoJCSAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKCQkgICAgfSwKCQkKCQkgICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCgkJICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgoJCSAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewoJCSAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJCSAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CgkJICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKCQkgICAgICB9CgkJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKCQkgICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CgkJICAgICAgdGhpcy5sb2FkVXJsKCk7CgkJICAgIH0sCgkJCgkJICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCgkJICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCgkJICAgIC8vIHJldHVybnMgYGZhbHNlYC4KCQkgICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKCQkgICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKCQkgICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewoJCSAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKCQkgICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CgkJICAgICAgICAgIHJldHVybiB0cnVlOwoJCSAgICAgICAgfQoJCSAgICAgIH0pOwoJCSAgICB9LAoJCQoJCSAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCgkJICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKCQkgICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCgkJICAgIC8vCgkJICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKCQkgICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKCQkgICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KCQkgICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkJICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKCQkgICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoJCQoJCSAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgkJCgkJICAgICAgLy8gU3RyaXAgdGhlIGhhc2ggZm9yIG1hdGNoaW5nLgoJCSAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCQkKCQkgICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKCQkgICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgkJCgkJICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgoJCSAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgkJCgkJICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KCQkgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CgkJICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoJCQoJCSAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCgkJICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KCQkgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCSAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKCQkgICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CgkJICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQoJCSAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAoJCSAgICAgICAgICAvLyB3YW50IHRoaXMuCgkJICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwoJCSAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKCQkgICAgICAgIH0KCQkKCQkgICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KCQkgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KCQkgICAgICB9IGVsc2UgewoJCSAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CgkJICAgICAgfQoJCSAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwoJCSAgICB9LAoJCQoJCSAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwoJCSAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KCQkgICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewoJCSAgICAgIGlmIChyZXBsYWNlKSB7CgkJICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwoJCSAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwoJCSAgICAgIH0gZWxzZSB7CgkJICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCgkJICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CgkJICAgICAgfQoJCSAgICB9CgkJCgkJICB9KTsKCQkKCQkgIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgoJCSAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoJCQoJCSAgLy8gSGVscGVycwoJCSAgLy8gLS0tLS0tLQoJCQoJCSAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCgkJICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAoJCSAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KCQkgIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewoJCSAgICB2YXIgcGFyZW50ID0gdGhpczsKCQkgICAgdmFyIGNoaWxkOwoJCQoJCSAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CgkJICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCQkgICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJCSAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewoJCSAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKCQkgICAgfSBlbHNlIHsKCQkgICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKCQkgICAgfQoJCQoJCSAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCQkgICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoJCQoJCSAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJCSAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJCSAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwoJCSAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCQkgICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCQkKCQkgICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCgkJICAgIC8vIGlmIHN1cHBsaWVkLgoJCSAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCQkKCQkgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJCSAgICAvLyBsYXRlci4KCQkgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCQkKCQkgICAgcmV0dXJuIGNoaWxkOwoJCSAgfTsKCQkKCQkgIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCgkJICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoJCQoJCSAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgoJCSAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CgkJICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwoJCSAgfTsKCQkKCQkgIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgoJCSAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CgkJICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CgkJICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJICAgIH07CgkJICB9OwoJCQoJCSAgcmV0dXJuIEJhY2tib25lOwoJCQoJCX0pKTsKCQlCYWNrYm9uZSA9IHRoaXMuQmFja2JvbmU7CgkJQmFja2JvbmUuJCA9IHRoaXMuJDsKCQlyZXR1cm4gQmFja2JvbmU7Cgl9KS5hcHBseSh7CgkJXzogXywKCQkkOiAkCgl9KTsKCS8vIEVORCBUSElSRCBQQVJUWSBDT0RFCgkvKmdsb2JhbCBCYWNrYm9uZSwgVXRpbCovCgkvKiBnbG9iYWwgXywgVXRpbCAqLwoJLyogZXhwb3J0ZWQgTG9nZ2VyICovCgl2YXIgTG9nZ2VyID0gKGZ1bmN0aW9uKCkgewoJCXZhciBjb2xvcnMgPSB7CgkJCWRlYnVnOiAiYmx1ZSIsCgkJCWluZm86ICJncmVlbiIsCgkJCWxvZzogIiMzMzMiLAoJCQl3YXJuOiAib3JhbmdlIiwKCQkJZXJyb3I6ICJyZWQiCgkJfSwKCQkJbm9vcCA9IGZ1bmN0aW9uKCkge30sCgkJCXBvc3RNZXNzYWdlID0gd2luZG93LnBvc3RNZXNzYWdlIHx8IG5vb3AsCgkJCWNvbnNvbGVQcm9wcyA9IFsiZGVidWciLCAibG9nIiwgImluZm8iLCAiZXJyb3IiLCAid2FybiJdLAoJCQljb25zb2xlID0gd2luZG93LmNvbnNvbGUgfHwge307CgkJLy8gcG9sbHlmaWxsIAoJCV8uZWFjaChjb25zb2xlUHJvcHMsIGZ1bmN0aW9uKHByb3ApIHsKCQkJaWYgKCFjb25zb2xlW3Byb3BdKSB7CgkJCQljb25zb2xlW3Byb3BdID0gbm9vcDsKCQkJfQoJCX0pOwoJCgkJZnVuY3Rpb24gTG9nZ2VyKG5hbWUpIHsKCQkJdGhpcy5wcmVmaXggPSBuYW1lIHx8ICJMb2dnZXIiOwoJCQlfLmJpbmRBbGwodGhpcywgImRlYnVnIiwgImluZm8iLCAibG9nIiwgIndhcm4iLCAiZXJyb3IiKTsgLy8gc28gbG9nZ2VycyBjYW4gYmUgZXZlbnQgaGFuZGxlcnMuCgkJfQoJCgkJZnVuY3Rpb24gZG9Mb2cobGV2ZWwsIGxvZ2dlciwgYXJncykgewoJCQl2YXIgbG9nZ2VycyA9IExvZ2dlci5nZXRGaWx0ZXJzKCk7CgkJCWlmIChsb2dnZXJzLmluZGV4T2YoImFsbCIpICE9PSAtMSB8fCBsb2dnZXIucHJlZml4LnRvTG93ZXJDYXNlKCkuaW5kZXhPZihsb2dnZXJzKSAhPT0gLTEpIHsKCQkJCXZhciBwcmVmaXggPSAiWyIgKyBsb2dnZXIucHJlZml4ICsgIl0iOwoJCQkJYXJncyA9IF8udG9BcnJheShhcmdzKTsKCQkJCXBvc3RNZXNzYWdlKCJsb2dNZXNzYWdlOjxzcGFuIHN0eWxlPVwiY29sb3I6IiArIGNvbG9yc1tsZXZlbF0gKyAiXCI+IiArIHByZWZpeCArICIgIiArIGFyZ3MgKyAiPC9zcGFuPiIsICIqIik7CgkJCQlhcmdzLnVuc2hpZnQocHJlZml4KTsKCQkJCWNvbnNvbGVbbGV2ZWxdLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwoJCQl9CgkJfQoJCV8uZXh0ZW5kKExvZ2dlci5wcm90b3R5cGUsIHsKCQkJZGVidWc6IGZ1bmN0aW9uKCkgewoJCQkJZG9Mb2coImRlYnVnIiwgdGhpcywgYXJndW1lbnRzKTsKCQkJfSwKCQkJaW5mbzogZnVuY3Rpb24oKSB7CgkJCQlkb0xvZygiaW5mbyIsIHRoaXMsIGFyZ3VtZW50cyk7CgkJCX0sCgkJCWxvZzogZnVuY3Rpb24oKSB7CgkJCQlkb0xvZygibG9nIiwgdGhpcywgYXJndW1lbnRzKTsKCQkJfSwKCQkJd2FybjogZnVuY3Rpb24oKSB7CgkJCQlkb0xvZygid2FybiIsIHRoaXMsIGFyZ3VtZW50cyk7CgkJCX0sCgkJCWVycm9yOiBmdW5jdGlvbigpIHsKCQkJCWRvTG9nKCJlcnJvciIsIHRoaXMsIGFyZ3VtZW50cyk7CgkJCX0KCQl9KTsKCQlMb2dnZXIuZ2V0RmlsdGVycyA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoIUxvZ2dlci5maXRlcnMpIHsKCQkJCXJldHVybiAiIjsKCQkJfQoJCQlyZXR1cm4gTG9nZ2VyLmZpbHRlcnMudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpOwoJCX07CgkJcmV0dXJuIExvZ2dlcjsKCX0pKCk7CglVdGlsLkxvZ2dlciA9IExvZ2dlcjsKCVV0aWwuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwoJVXRpbC5FdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7CgkvKiBnbG9iYWwgVXRpbCwgTG9nZ2VyLCBfLCBCYWNrYm9uZSovCgkvKiBleHBvcnRlZCBNb2R1bGUgKi8KCS8qKgoJICogU2ltcGxlIGJhc2UgY2xhc3MgZnVuY3Rpb25hbGl0eS4KCSAqIFN1YmNsYXNzIGdldCBhbiBvcHRpb25zIGFuZCBhIGxvZ2dlci4KCSAqIEFuIGluaXRpYWxpemUgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLgoJICogQW5kIEJhY2tib25lLkV2ZW50cy4KCSAqLwoJdmFyIE1vZHVsZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXRoaXMubG9nZ2VyID0gbmV3IExvZ2dlcih0aGlzLm9wdGlvbnMubG9nZ2VyTmFtZSB8fCB0aGlzLm5hbWUgfHwgdGhpcy5tb2R1bGVJZCB8fCAiTG9nZ2VyIik7CgkJdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoJTW9kdWxlLnByb3RvdHlwZSA9IHsKCQlpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9LAoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKCQl9Cgl9OwoJXy5leHRlbmQoTW9kdWxlLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzKTsKCU1vZHVsZS5leHRlbmQgPSBVdGlsLmV4dGVuZDsKCVV0aWwuTW9kdWxlID0gTW9kdWxlOwoJLypnbG9iYWwgVXRpbCwgXyAqLwoJdmFyIHRlbXBsYXRlUHJlcHJvY2VzcyA9IGZ1bmN0aW9uKHRleHQpIHsKCSAgICAvLyBmaXJzdCwgc3VwcG9ydCBsZWdhY3kgdGVtcGxhdGUgZm9ybWF0IG9mIHtkYXRhfQoJICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoL1x7ezEsfS9nLCAie3siKS5yZXBsYWNlKC9cfXsxLH0vZywgIn19IikKCSAgICAvLyB3ZSBuZWVkIHRvIGJvdGggc3VwcG9ydCB7dXJpfSBhbmQge3VyaS5pZH0sIHRoZXJlIGlzIGFuIG9idmlvdXMgY29uZmxpY3QgdGhlcmUuCgkgICAgLnJlcGxhY2UoL1x7dXJpXC4vLCAie3VyaVBhcnRzLiIpCgkgICAgLy8gbGFzdCwgc2NvcGUgdGhlIGRhdGEsIHRoaXMgbGV0cyB1cyBoYXZlIHVuZGVmaW5lZCB2YXJzLgoJICAgIC5yZXBsYWNlKC9ce3syLH0vZywgInt7ZGF0YS4iKTsKCX07CgkKCS8qKgoJICogdGV4dCBjYW4gYmUgYSBzaW5nbGUgc3RyaW5nLCBhbiBvYmplY3Qgd2l0aCBzdHJpbmcgcHJvcGVyaXRlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncy4KCSAqLwoJVXRpbC50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIGtleXMpIHsKCSAgICAvLyBwYXJzZSBzdHJpbmdzIGxpa2Uge3VyaX0KCSAgICBpZiAoXy5pc1N0cmluZyh0ZXh0KSkgewoJICAgICAgICByZXR1cm4gXy50ZW1wbGF0ZSh0ZW1wbGF0ZVByZXByb2Nlc3ModGV4dCksIHsKCSAgICAgICAgICAgIGRhdGE6IGRhdGEKCSAgICAgICAgfSwgewoJICAgICAgICAgICAgaW50ZXJwb2xhdGU6IC9ce1x7KC4rPylcfVx9L2cKCSAgICAgICAgfSk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgXyh0ZXh0KS5lYWNoKGZ1bmN0aW9uKHByb3AsIGtleSkgewoJICAgICAgICAgICAgaWYgKCFrZXlzIHx8IF8uY29udGFpbnMoa2V5cywga2V5KSkgewoJICAgICAgICAgICAgICAgIC8vIGRvIGFuIGV4dHJhIGNoZWNrIHRvIG1ha2Ugc3VyZSB0aGVyZSBpcyBhIHRlbXBsYXRlLCBwZXJoYXBzIGVuaGFuY2luZyBwZXJmb3JtYW5jZS4KCSAgICAgICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhwcm9wKSAmJiBwcm9wLmluZGV4T2YoInsiKSAhPT0gLTEpIHsKCSAgICAgICAgICAgICAgICAgICAgdGV4dFtrZXldID0gXy50ZW1wbGF0ZSh0ZW1wbGF0ZVByZXByb2Nlc3MocHJvcCksIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKCSAgICAgICAgICAgICAgICAgICAgfSwgewoJICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGU6IC9ce1x7KC4rPylcfVx9L2cKCSAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICAgICAgcmV0dXJuIHRleHQ7CgkgICAgfQoJfTsKCS8qKgoJICogVGhpcyBpcyBlcXVpdmFsZW50IHRvIHRoZSBUZW1wbGF0ZVByb3h5IGluIGZsYXNoLgoJICovCglVdGlsLmJ1aWxkVGVtcGxhdGVEYXRhID0gZnVuY3Rpb24ocGxheWVyLCBleHRyYURhdGEpIHsKCSAgICB2YXIgZGF0YSA9IF8uZXh0ZW5kKHt9LCBwbGF5ZXIuY29uZmlnLCBleHRyYURhdGEpLAoJICAgICAgICBzcGxpdFVyaSA9IGRhdGEudXJpLnNwbGl0KCI6Iik7CgkgICAgLy8gYnVpbGQgdXJpCgkgICAgZGF0YS51cmlQYXJ0cyA9IHsKCSAgICAgICAgbmFtZXNwYWNlOiBzcGxpdFVyaVszXSwKCSAgICAgICAgaWQ6IHNwbGl0VXJpWzRdCgkgICAgfTsKCSAgICBkYXRhLmN1cnJlbnRNZXRhZGF0YSA9IHBsYXllci5jdXJyZW50TWV0YWRhdGEgPyBwbGF5ZXIuY3VycmVudE1ldGFkYXRhIDogbnVsbDsKCSAgICAvLyBtZXRhZGF0YSBmb3IgbGVnYWN5CgkgICAgZGF0YS5tZXRhZGF0YSA9IHBsYXllci5jdXJyZW50TWV0YWRhdGEgPyBwbGF5ZXIuY3VycmVudE1ldGFkYXRhLnJzcyA6IG51bGw7CgkgICAgZGF0YS5wbGF5bGlzdE1ldGFkYXRhID0gcGxheWVyLnBsYXlsaXN0TWV0YWRhdGE7CgkgICAgLy8gZnV0dXJlIHRlbXBhbGVzIGNhbiBqdXN0IGFjY2VzcyBwcm9wZXJ0aWVzIG9uIHRoZSBlbWJlZCBhcGkuCgkgICAgZGF0YS5wbGF5ZXIgPSBwbGF5ZXI7CgkgICAgLy8gbGVnYWN5IHRoaXMgaXMgaW4gZmxhc2ggcGxheWVyLCBub3Qgc3VyZSBpZiB1c2VkLgoJICAgIGRhdGEuYXBwID0gewoJICAgICAgICB3aWR0aDogZGF0YS53aWR0aCwKCSAgICAgICAgaGVpZ2h0OiBkYXRhLmhlaWdodAoJICAgIH07CgkgICAgcmV0dXJuIGRhdGE7Cgl9OwoJLyogZ2xvYmFsIF8sIEJhY2tib25lLCBVdGlsKi8KCS8qKgoJICogTWFuYWdlIGJyb3dzZXIgZnVsbCBzY3JlZW4gbWV0aG9kcyBmb3IgYSB2YXJpZXR5IG9mIHZlbmRvciBwcmVmaXhlcy4KCSAqLwoJVXRpbC5GdWxsU2NyZWVuID0gKGZ1bmN0aW9uKGRvY3VtZW50KSB7CgkJdmFyIGNhbmNlbEZ1bmMgPSBkb2N1bWVudC5jYW5jZWxGdWxsU2NyZWVuIHx8IGRvY3VtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4gfHwgZG9jdW1lbnQud2Via2l0Q2FuY2VsRnVsbFNjcmVlbiwKCQkJRnVsbFNjcmVlbiA9IF8uZXh0ZW5kKHt9LCBCYWNrYm9uZS5FdmVudHMsIHsKCQkJCXRvZ2dsZTogZnVuY3Rpb24oZWxlbWVudCkgewoJCQkJCWlmIChGdWxsU2NyZWVuLmlzRnVsbFNjcmVlbigpKSB7CgkJCQkJCXJldHVybiBGdWxsU2NyZWVuLmNhbmNlbEZ1bGxTY3JlZW4oKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gRnVsbFNjcmVlbi5yZXF1ZXN0RnVsbFNjcmVlbihlbGVtZW50KTsKCQkJCQl9CgkJCQl9LAoJCQkJcmVxdWVzdEZ1bGxTY3JlZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQkJCQllbGVtZW50ID0gZWxlbWVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgkJCQkJdmFyIHJlcXVlc3RGdW5jID0gZWxlbWVudC5yZXF1ZXN0RnVsbFNjcmVlbiB8fCBlbGVtZW50Lm1velJlcXVlc3RGdWxsU2NyZWVuIHx8IGVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW47CgkJCQkJaWYgKF8uaXNGdW5jdGlvbihyZXF1ZXN0RnVuYykpIHsKCQkJCQkJcmVxdWVzdEZ1bmMuY2FsbChlbGVtZW50KTsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgkJCQljYW5jZWxGdWxsU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJCQlpZiAoXy5pc0Z1bmN0aW9uKGNhbmNlbEZ1bmMpKSB7CgkJCQkJCWNhbmNlbEZ1bmMuY2FsbChkb2N1bWVudCk7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9LAoJCQkJaXNGdWxsU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gKChkb2N1bWVudC5mdWxsU2NyZWVuRWxlbWVudCAhPT0gdW5kZWZpbmVkICYmIGRvY3VtZW50LmZ1bGxTY3JlZW5FbGVtZW50ICE9PSBudWxsKSB8fCAoZG9jdW1lbnQubW96RnVsbFNjcmVlbiAhPT0gdW5kZWZpbmVkICYmIGRvY3VtZW50Lm1vekZ1bGxTY3JlZW4gPT09IHRydWUpIHx8IChkb2N1bWVudC53ZWJraXRJc0Z1bGxTY3JlZW4gIT09IHVuZGVmaW5lZCAmJiBkb2N1bWVudC53ZWJraXRJc0Z1bGxTY3JlZW4gPT09IHRydWUpKTsKCQkJCX0sCgkJCQlFdmVudHM6IHsKCQkJCQlGVUxMX1NDUkVFTl9DSEFOR0U6ICJmdWxsc2NyZWVuQ2hhbmdlIgoJCQkJfQoJCQl9KSwKCQkJdmVuZG9yRnVsbHNjcmVlbkNoYW5nZTsKCQlpZiAoZG9jdW1lbnQuZnVsbFNjcmVlbkVuYWJsZWQgfHwgZG9jdW1lbnQuZnVsbHNjcmVlbkVuYWJsZWQpIHsKCQkJdmVuZG9yRnVsbHNjcmVlbkNoYW5nZSA9ICJmdWxsc2NyZWVuY2hhbmdlIjsKCQl9IGVsc2UgaWYgKGRvY3VtZW50Lm1vekZ1bGxzY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50Lm1vekZ1bGxTY3JlZW5FbmFibGVkKSB7CgkJCXZlbmRvckZ1bGxzY3JlZW5DaGFuZ2UgPSAibW96ZnVsbHNjcmVlbmNoYW5nZSI7CgkJfSBlbHNlIGlmIChkb2N1bWVudC53ZWJraXRGdWxsc2NyZWVuRW5hYmxlZCB8fCBkb2N1bWVudC53ZWJraXRGdWxsU2NyZWVuRW5hYmxlZCkgewoJCQl2ZW5kb3JGdWxsc2NyZWVuQ2hhbmdlID0gIndlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UiOwoJCX0KCQlpZiAodmVuZG9yRnVsbHNjcmVlbkNoYW5nZSkgewoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKHZlbmRvckZ1bGxzY3JlZW5DaGFuZ2UsIGZ1bmN0aW9uKCkgewoJCQkJRnVsbFNjcmVlbi50cmlnZ2VyKEZ1bGxTY3JlZW4uRXZlbnRzLkZVTExfU0NSRUVOX0NIQU5HRSwgewoJCQkJCXR5cGU6IEZ1bGxTY3JlZW4uRXZlbnRzLkZVTExfU0NSRUVOX0NIQU5HRSwKCQkJCQlkYXRhOiBGdWxsU2NyZWVuLmlzRnVsbFNjcmVlbigpCgkJCQl9KTsKCQkJfSwgZmFsc2UpOwoJCX0KCQlyZXR1cm4gRnVsbFNjcmVlbjsKCX0pKGRvY3VtZW50KTsKCS8qIGdsb2JhbCBVdGlsLCBfKi8KCXZhciBQbGF5bGlzdCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCVBsYXlsaXN0LkV2ZW50cyA9IHsKCQlJTkRFWF9DSEFOR0U6ICJwbGF5bGlzdDppbmRleCIsCgkJUkVBRFk6ICJwbGF5bGlzdDpyZWFkeSIsCgkJSVRFTV9SRUFEWTogInBsYXlsaXN0Oml0ZW06cmVhZHkiCgl9OwoJUGxheWxpc3QucHJvdG90eXBlID0gXy5leHRlbmQoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoJCQlpZiAodGhpcy5vcHRpb25zLm1ldGFkYXRhKSB7CgkJCQl0aGlzLm1ldGFkYXRhID0gdGhpcy5vcHRpb25zLm1ldGFkYXRhOwoJCQkJdGhpcy5jdXJyZW50SXRlbSA9IHRoaXMuZ2V0Q3VycmVudEl0ZW0oKTsKCQkJfQoJCX0sCgkJY3VycmVudEluZGV4OiAwLAoJCWN1cnJlbnRJdGVtOiBudWxsLAoJCWdldFByZXZpb3VzOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMubWV0YWRhdGEuaXRlbXNbdGhpcy5oYXNQcmV2aW91cygpID8gdGhpcy5jdXJyZW50SW5kZXggLSAxIDogdGhpcy5jdXJyZW50SW5kZXhdOwoJCX0sCgkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCXZhciBpdGVtcyA9IHRoaXMubWV0YWRhdGEuaXRlbXM7CgkJCXJldHVybiB0aGlzLmhhc05leHQoKSA/IGl0ZW1zW3RoaXMuY3VycmVudEluZGV4ICsgMV0gOiBpdGVtc1t0aGlzLmN1cnJlbnRJbmRleF07CgkJfSwKCQlwcmV2aW91czogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnNldEluZGV4KHRoaXMuY3VycmVudEluZGV4IC0gMSk7CgkJfSwKCQluZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc2V0SW5kZXgodGhpcy5jdXJyZW50SW5kZXggKyAxKTsKCQl9LAoJCWhhc05leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jdXJyZW50SW5kZXggPCB0aGlzLm1ldGFkYXRhLml0ZW1zLmxlbmd0aCAtIDE7CgkJfSwKCQloYXNQcmV2aW91czogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmN1cnJlbnRJbmRleCA+IDA7CgkJfSwKCQlnZXRDdXJyZW50SXRlbTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm1ldGFkYXRhLml0ZW1zW3RoaXMuY3VycmVudEluZGV4XTsKCQl9LAoJCXNldEluZGV4OiBmdW5jdGlvbihpbmRleCkgewoJCQlpZiAoaW5kZXggPiB0aGlzLm1ldGFkYXRhLml0ZW1zLmxlbmd0aCAtIDEpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIGlmIChpbmRleCAhPT0gdGhpcy5jdXJyZW50SW5kZXgpIHsKCQkJCXRoaXMuY3VycmVudEluZGV4ID0gaW5kZXg7CgkJCQl0aGlzLnVwZGF0ZUN1cnJlbnQoKTsKCQkJCXRoaXMub25JbmRleENoYW5nZSgpOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoJCW9uSW5kZXhDaGFuZ2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnRyaWdnZXIoUGxheWxpc3QuRXZlbnRzLklOREVYX0NIQU5HRSwgewoJCQkJdHlwZTogUGxheWxpc3QuRXZlbnRzLklOREVYX0NIQU5HRSwKCQkJCWRhdGE6IHRoaXMuY3VycmVudEluZGV4CgkJCX0pOwoJCX0sCgkJZ2V0SXRlbUF0OiBmdW5jdGlvbihpbmRleCkgewoJCQl2YXIgaXRlbXMgPSB0aGlzLm1ldGFkYXRhLml0ZW1zOwoJCQlpZiAoaW5kZXggPCAwIHx8IGluZGV4ID4gaXRlbXMubGVuZ3RoIC0gMSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCJQbGF5bGlzdCBpbmRleCAiICsgaW5kZXggKyAiIGlzIG91dCBvZiByYW5nZSBbMC0iICsgaXRlbXMubGVuZ3RoICsgIl0iKTsKCQkJfQoJCQlyZXR1cm4gaXRlbXNbaW5kZXhdOwoJCX0sCgkJdXBkYXRlQ3VycmVudDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuY3VycmVudEl0ZW0gPSB0aGlzLm1ldGFkYXRhLml0ZW1zW3RoaXMuY3VycmVudEluZGV4XTsKCQl9Cgl9LCBVdGlsLkV2ZW50cyk7CglQbGF5bGlzdC5leHRlbmQgPSBVdGlsLmV4dGVuZDsKCVV0aWwuUGxheWxpc3QgPSBQbGF5bGlzdDsKCXJldHVybiBVdGlsOwp9KShfLCAkKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 22:09:51 GMT",
                    "Content-Length": "90233",
                    "Date": "Fri, 07 Nov 2014 22:09:51 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}