{
    "url": "http://localhost:9999/fredyang/bower-hm.js/hm.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statements:<ul><li>var currentHas...= l ...Path+ \"#\" + newHash;</li><li>location.href = newUrl;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/fredyang/bower-hm.js/hm.js",
                "path": "/fredyang/bower-hm.js/hm.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mcmVkeWFuZy9ib3dlci1obS5qcy9obS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjMyNDEwDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAzOjE2OjM5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMzoxNjozOSBHTVQNCg0KIC8qIQogICogSG0uanMgSmF2YVNjcmlwdCBMaWJyYXJ5IHYxLjAuMAogICogwqkgRnJlZCBZYW5nIC0gaHR0cDovL3NlbWFudGljc3dvcmtzLmNvbQogICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICAqIERhdGU6IFR1ZSBBcHIgMSAxOToxNTo1MCAyMDE0IC0wNzAwCiAgKi8KKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKmpzaGludCBzbWFydHRhYnM6dHJ1ZSwgZXZpbDp0cnVlLCBleHByOnRydWUsIG5ld2NhcDogZmFsc2UsIHZhbGlkdGhpczogdHJ1ZSAqLwoJLyoqCgkgKiBhIHdyYXBwZXIgb3ZlciBhIE5vZGUgY29uc3RydWN0b3IsCgkgKiBbdmFsdWVdIGlzIG9wdGlvbmFsCgkgKi8KCXZhciBobSA9IHdpbmRvdy5obSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcmV0dXJuIG5ldyBOb2RlKCBwYXRoLCB2YWx1ZSApOwoJCX0sCgkJTm9kZSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcGF0aCA9IHBhdGggfHwgIiI7CgkJCXRoaXMucGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBwYXRoLCB0cnVlIC8qIGNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5ICovICk7CgkJCWlmICghaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRoaXMuc2V0KCB2YWx1ZSApOwoJCQl9CgkJfSwKCQlkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCQlsb2NhbFN0b3JhZ2UgPSB3aW5kb3cubG9jYWxTdG9yYWdlLAoJCXNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKCQloaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCgkJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgkJYWxlcnQgPSB3aW5kb3cuYWxlcnQsCgkJY29uZmlybSA9IHdpbmRvdy5jb25maXJtLAoJCWhtRm4sCgkJZXh0ZW5kID0gJC5leHRlbmQsCgkJcmVwb3NpdG9yeSA9IHt9LAoJCWlzQXJyYXkgPSAkLmlzQXJyYXksCgkJaXNGdW5jdGlvbiA9ICQuaXNGdW5jdGlvbiwKCQlwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6IHVuZGVmaW5lZCwgJ2Jvb2xlYW4nOiB1bmRlZmluZWQsICdudW1iZXInOiB1bmRlZmluZWQsICdzdHJpbmcnOiB1bmRlZmluZWQgfSwKCQlzaGFkb3dOYW1lc3BhY2UgPSAiX19obSIsCgkJclNoYWRvd0tleSA9IC9eX19obVwuKFteXC5dKz8pKD86XC58JCkvLAoJLy90cnkgdG8gbWF0Y2ggeHh4IGluIHN0cmluZyB0aGlzLmdldCgieHh4IikKCQlyV2F0Y2hlZFBhdGggPSAvdGhpc1wuKD86Z2V0KVxzKlwoXHMqKFsnIl0pKFtcKlwuXHdcL10rKVwxXHMqXCkvZywKCgkvL2tleSBpcyB3YXRjaGVkUGF0aHMKCS8vdmFsdWUgaXMgYXJyYXkgb2Ygd2F0Y2hpbmdQYXRocwoJCXdhdGNoVGFibGUgPSB7fSwKCQlkZWZhdWx0T3B0aW9ucyA9IHt9LAoJCXJvb3ROb2RlLAoJCXNoYWRvd1Jvb3QgPSByZXBvc2l0b3J5W3NoYWRvd05hbWVzcGFjZV0gPSB7fSwKCQloYXNPd24gPSByZXBvc2l0b3J5Lmhhc093blByb3BlcnR5LAoJCUFycmF5ID0gd2luZG93LkFycmF5LAoJCWFycmF5UHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAoJCXN0cmluZ1Byb3RvdHlwZSA9IFN0cmluZy5wcm90b3R5cGUsCgkJc2xpY2UgPSBhcnJheVByb3RvdHlwZS5zbGljZSwKCQl0cmlnZ2VyLAoJCWJlZm9yZVVwZGF0ZSA9ICJiZWZvcmVVcGRhdGUiLAoJCWFmdGVyVXBkYXRlID0gImFmdGVyVXBkYXRlIiwKCQliZWZvcmVDcmVhdGUgPSAiYmVmb3JlQ3JlYXRlIiwKCQlhZnRlckNyZWF0ZSA9ICJhZnRlckNyZWF0ZSIsCgkJckpTT04gPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCgkJclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dCA9IC9eXC4oXC4qKShbXC5cKl0pLywKCQlyTWFpblBhdGggPSAvXlwuPCguKikvLAoJCXJCZWdpbkRvdE9yU3RhciA9IC9eW1wuXCpdLywKCQlyRG90U3RhciA9IC9bXC5cKl0vLAoJCXJIYXNoT3JEb3QgPSAvIyt8XC4vZywKCQlySGFzaCA9IC8jKy9nLAoJCVJlZ0V4cCA9IHdpbmRvdy5SZWdFeHAsCgkJclBhcmVudEtleSA9IC9eKC4rKVtcLlwqXVx3KyQvLAoJCW1lcmdlUGF0aCwKCQlySW5kZXggPSAvXi4rXC4oXHcrKSR8XHcrLywKCQl1dGlsLAoJCWlzVW5kZWZpbmVkLAoJCWlzUHJpbWl0aXZlLAoJCWlzU3RyaW5nLAoJCWlzT2JqZWN0LAoJCWlzQm9vbGVhbiwKCQlpc051bWVyaWMgPSAkLmlzTnVtZXJpYywKCQlpc1Byb21pc2UsCgkJdG9UeXBlZFZhbHVlLAoJCXRvUGh5c2ljYWxQYXRoLAoJCXRvTG9naWNhbFBhdGgsCgkJY2xlYXJPYmosCgkJJGZuID0gJC5mbiwKCQljbG9uZSwKCQlyU3VwcGxhbnQgPSAvXHsoW15ce1x9XSopXH0vZzsKCgoKCWZ1bmN0aW9uIGF1Z21lbnQoIHByb3RvdHlwZSwgZXh0ZW5zaW9uICkgewoJCWZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKCQkJaWYgKCFwcm90b3R5cGVba2V5XSkgewoJCQkJcHJvdG90eXBlW2tleV0gPSBleHRlbnNpb25ba2V5XTsKCQkJfQoJCX0KCX0KCglhdWdtZW50KCBhcnJheVByb3RvdHlwZSwgewoJCWluZGV4T2Y6IGZ1bmN0aW9uKCBvYmosIHN0YXJ0ICkgewoJCQlmb3IgKHZhciBpID0gKHN0YXJ0IHx8IDApOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewoJCQkJaWYgKHRoaXNbaV0gPT0gb2JqKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIC0xOwoJCX0sCgoJCWNvbnRhaW5zOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuICh0aGlzLmluZGV4T2YoIGl0ZW0gKSAhPT0gLTEpOwoJCX0sCgoJCXJlbW92ZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXZhciBwb3NpdGlvbiA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQlpZiAocG9zaXRpb24gIT0gLTEpIHsKCQkJCXRoaXMuc3BsaWNlKCBwb3NpdGlvbiwgMSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXJlbW92ZUF0OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJCXRoaXMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlwdXNoVW5pcXVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJaWYgKCF0aGlzLmNvbnRhaW5zKCBpdGVtICkpIHsKCQkJCXRoaXMucHVzaCggaXRlbSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCW1lcmdlOiBmdW5jdGlvbiggaXRlbXMgKSB7CgkJCWlmIChpdGVtcyAmJiBpdGVtcy5sZW5ndGgpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLnB1c2hVbmlxdWUoIGl0ZW1zW2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQkvL2l0IGNhbiBiZSBzb3J0T2JqZWN0KCkKCQkvL3NvcnRPYmplY3QoYnkpCgkJc29ydE9iamVjdDogZnVuY3Rpb24oIGJ5LCBhc2MgKSB7CgkJCWlmIChpc1VuZGVmaW5lZCggYXNjICkpIHsKCQkJCWlmIChpc1VuZGVmaW5lZCggYnkgKSkgewoJCQkJCWFzYyA9IHRydWU7CgkJCQkJYnkgPSB1bmRlZmluZWQ7CgkJCQl9IGVsc2UgewoJCQkJCWlmIChpc1N0cmluZyggYnkgKSkgewoJCQkJCQlhc2MgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWFzYyA9IGJ5OwoJCQkJCQlieSA9IHVuZGVmaW5lZDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWlmIChieSkgewoJCQkJdGhpcy5zb3J0KCBmdW5jdGlvbiggYSwgYiApIHsKCQkJCQl2YXIgYXYgPSBhW2J5XTsKCQkJCQl2YXIgYnYgPSBiW2J5XTsKCQkJCQlpZiAoYXYgPT0gYnYpIHsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfQoJCQkJCXJldHVybiAgYXNjID8gKGF2ID4gYnYpID8gMSA6IC0xIDoKCQkJCQkJKGF2ID4gYnYpID8gLTEgOiAxOwoJCQkJfSApOwoJCQl9IGVsc2UgewoJCQkJYXNjID8gdGhpcy5zb3J0KCkgOiB0aGlzLnNvcnQoKS5yZXZlcnNlKCk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJfSApOwoKCWF1Z21lbnQoIHN0cmluZ1Byb3RvdHlwZSwgewoJCXN0YXJ0c1dpdGg6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gdGhpcy5pbmRleE9mKCB0ZXh0ICkgPT09IDA7CgkJfSwKCQljb250YWluczogZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0aGlzLmluZGV4T2YoIHRleHQgKSAhPT0gLTE7CgkJfSwKCQllbmRzV2l0aDogZnVuY3Rpb24oIHN1ZmZpeCApIHsKCQkJcmV0dXJuIHRoaXMuaW5kZXhPZiggc3VmZml4LCB0aGlzLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGggKSAhPT0gLTE7CgkJfSwKCQlzdXBwbGFudDogZnVuY3Rpb24oIG9iaiApIHsKCQkJcmV0dXJuIHRoaXMucmVwbGFjZSggclN1cHBsYW50LAoJCQkJZnVuY3Rpb24oIGEsIGIgKSB7CgkJCQkJdmFyIHIgPSBvYmpbYl07CgkJCQkJcmV0dXJuIHR5cGVvZiByID8gciA6IGE7CgkJCQl9ICk7CgkJfSwKCQlmb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc291cmNlID0gdGhpczsKCQkJJC5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7CgkJCQlzb3VyY2UgPSBzb3VyY2UucmVwbGFjZSggbmV3IFJlZ0V4cCggIlxceyIgKyBpbmRleCArICJcXH0iLCAiZyIgKSwgdmFsdWUgKTsKCQkJfSApOwoJCQlyZXR1cm4gc291cmNlOwoJCX0KCX0gKTsKCglobUZuID0gTm9kZS5wcm90b3R5cGUgPSBobS5mbiA9IGhtLnByb3RvdHlwZSA9IHsKCgkJY29uc3RydWN0b3I6IE5vZGUsCgoJCXRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucGF0aDsKCQl9LAoKCQkvL2dldCgpCgkJLy9nZXQodHJ1ZSkKCQkvLwoJCS8vc3ViUGF0aCBjYW4gYmUgbnVsbCwgdW5kZWZpbmVkLCAiIiwgb3IgImFueSBzdHJpbmciCgkJLy9nZXQoc3ViUGF0aCkKCQkvL2dldChzdWJQYXRoLCBwMSwgcDIpCgkJLy8KCQkvL2RvZXMgbm90IHN1cHBvcnQgdGhlIGZvbGxvd2luZywgYXMgd2lsbCBiZSBpbXBsZW1lbnRlZCBhcyBnZXQoKHN1YlBhdGggPSBwMSksIHAyKQoJCS8vZ2V0KHAxLCBwMikKCQlnZXQ6IGZ1bmN0aW9uKCBzdWJQYXRoIC8qLCBwMSwgcDIsIC4uIGZvciBwYXJhbWV0ZXJzIG9mIG1vZGVsIGZ1bmN0aW9ucyovICkgewoKCQkJdmFyIGN1cnJlbnRWYWx1ZSwgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoLCB0cnVlICk7CgoJCQlpZiAoYWNjZXNzb3IpIHsKCgkJCQlpZiAoaXNGdW5jdGlvbiggYWNjZXNzb3IuaG9zdE9iaiApKSB7CgoJCQkJCXJldHVybiBhY2Nlc3Nvci5ob3N0T2JqLmFwcGx5KCB0aGlzLmNkKCAiLi4iICksIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgoJCQkJfQoJCQkJZWxzZSB7CgoJCQkJCWN1cnJlbnRWYWx1ZSA9ICFhY2Nlc3Nvci5pbmRleCA/CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmogOgoJCQkJCQlhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCQkJaWYgKGlzRnVuY3Rpb24oIGN1cnJlbnRWYWx1ZSApKSB7CgoJCQkJCQkvL2luc2lkZSB0aGUgZnVuY3Rpb24sICJ0aGlzIiByZWZlciB0aGUgcGFyZW50IG1vZGVsIG9mIGFjY2Vzc29yLnBoeXNpY2FsUGF0aAoJCQkJCQlyZXR1cm4gY3VycmVudFZhbHVlLmFwcGx5KCB0aGlzLmNkKCBzdWJQYXRoICkuY2QoICIuLiIgKSwgc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICkgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXJldHVybiBjdXJyZW50VmFsdWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCS8vZWxzZSByZXR1cm4gdW5kZWZpbmVkCgkJfSwKCgkJZ2V0SnNvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggdGhpcy5nZXQuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsKCQl9LAoKCQlyYXc6IGZ1bmN0aW9uKCBzdWJQYXRoLCB2YWx1ZSApIHsKCQkJdmFyIGFjY2Vzc29yOwoJCQlpZiAoaXNGdW5jdGlvbiggc3ViUGF0aCApKSB7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCQkJaWYgKCF2YWx1ZSkgewoJCQkJYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoLCB0cnVlICk7CgkJCQlpZiAoYWNjZXNzb3IpIHsKCQkJCQlyZXR1cm4gIWFjY2Vzc29yLmluZGV4ID8KCQkJCQkJYWNjZXNzb3IuaG9zdE9iaiA6CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJCXRoaXMudXBkYXRlKCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSA6CgkJCQkJdGhpcy5jcmVhdGUoIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApOwoJCQl9CgoJCX0sCgoJCS8vcmV0dXJuIG5vZGUKCQkvL3lvdSBjYW4gdXNlIG5vZGUuc2V0IHRvIGNhbGwgdGhlIGZ1bmN0aW9uIGF0IHRoZSBwYXRoCgkJLy90aGUgZnVuY3Rpb24gY29udGV4dCBpcyBib3VuZCB0byBjdXJyZW50IHByb3h5J3MgcGFyZW50CgkJLy93aGF0IGlzIGRpZmZlcmVudCBmb3IgZ2V0IGZ1bmN0aW9uIGlzIHRoYXQsIHNldCB3aWxsIHJldHVybiBhIHByb3h5CgkJLy9hbmQgZ2V0IHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGZ1bmN0aW9uCgkJc2V0OiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlICkgewoJCQkvL2FsbG93IHNldChwYXRoLCB1bmRlZmluZWQpCgkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCWlmICh0aGlzLnBhdGggPT09ICIiKSB7CgkJCQkJdGhyb3cgInJvb3Qgb2JqZWN0IGNhbiBub3QgY2hhbmdlZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJvb3ROb2RlLnNldCggdGhpcy5wYXRoLCBmb3JjZSwgc3ViUGF0aCApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgoJCQl2YXIgYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgkJCQlyb290Tm9kZS5zZXQoIGZvcmNlLCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCXZhciBjdXJyZW50VmFsdWUgPSBhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCWlmIChpc0Z1bmN0aW9uKCBjdXJyZW50VmFsdWUgKSkgewoKCQkJCS8vaW5zaWRlIHRoZSBmdW5jdGlvbiwgInRoaXMiIHJlZmVyIHRoZSBwYXJlbnQgbW9kZWwgb2YgYWNjZXNzb3IucGh5c2ljYWxQYXRoCgkJCQljdXJyZW50VmFsdWUuYXBwbHkoIHRoaXMuY2QoIHN1YlBhdGggKS5jZCggIi4uIiApLCBzbGljZS5jYWxsKCBhcmdzLCAxICkgKTsKCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJCXRoaXMudXBkYXRlKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICkgOgoJCQkJCXRoaXMuY3JlYXRlKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgoJCQl9CgkJfSwKCgkJYWNjZXNzb3I6IGZ1bmN0aW9uKCBzdWJQYXRoLCByZWFkT25seSAvKmludGVybmFsIHVzZSBvbmx5Ki8gKSB7CgkJCS8vaWYgaXQgaXMgbm90IHJlYWRPbmx5LCBhbmQgYWNjZXNzIG91dCBvZiBib3VuZGFyeSwgaXQgd2lsbCB0aHJvdyBleGNlcHRpb24KCQkJaWYgKHN1YlBhdGggPT09IDApIHsKCQkJCXN1YlBhdGggPSAiMCI7CgkJCX0KCgkJCXZhciBpLAoJCQkJaW5kZXgsCgkJCS8vdGhlIGhvc3RPYmogc3RhcnQgZnJvbSByb290CgkJCQlob3N0T2JqID0gcmVwb3NpdG9yeSwKCQkJLy90aGUgZnVsbFBhdGggY2FuIGJlIGxvZ2ljYWxQYXRoICwgZm9yIGV4YW1wbGUgaG0oInBlcnNvbiIpLmdldFBhdGgoIioiKTsKCQkJLy9pdCBjYW4gYWxzbyBiZSBhIHBoeXNpY2FsUGF0aCBsaWtlIGhtKCJwZXJzb24qIikuZ2V0UGF0aCgpOwoJCQkJZnVsbFBhdGggPSB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSwKCQkJLy9tYWtlIHN1cmUgd2UgYXJlIHdvcmtpbmcgb24gYSBwaHlzaWNhbFBhdGgKCQkJCXBoeXNpY2FsUGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBmdWxsUGF0aCwgdHJ1ZSAvKmNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5Ki8gKSwKCQkJCXBhcnRzID0gcGh5c2ljYWxQYXRoLnNwbGl0KCAiLiIgKTsKCgkJCWlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHsKCgkJCQlpbmRleCA9IHBoeXNpY2FsUGF0aDsKCgkJCX0gZWxzZSB7CgoJCQkJLy9pbmRleCBpcyB0aGUgbGFzdCBwYXJ0CgkJCQlpbmRleCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdOwoKCQkJCS8vdHJhdmVyc2UgdG8gdGhlIHNlY29uZCBsYXN0IG5vZGUgaW4gdGhlIHBhcnRzIGhpZXJhcmNoeQoJCQkJZm9yIChpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKykgewoJCQkJCWhvc3RPYmogPSBob3N0T2JqW3BhcnRzW2ldXTsKCQkJCQlpZiAoaG9zdE9iaiA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKGlzUHJpbWl0aXZlKCBob3N0T2JqICkpIHsKCQkJCWlmIChyZWFkT25seSkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXRocm93ICJpbnZhbGlkIHVwZGF0ZSBvbiB1bnJlYWNoYWJsZSBub2RlICciICsgdG9Mb2dpY2FsUGF0aCggZnVsbFBhdGggKSArICInIjsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHsKCQkJCXBoeXNpY2FsUGF0aDogcGh5c2ljYWxQYXRoLAoJCQkJaG9zdE9iajogaG9zdE9iaiwKCQkJCWluZGV4OiBpbmRleAoJCQl9OwoJCX0sCgoJCWNyZWF0ZTogZnVuY3Rpb24oIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgLyogYWNjZXNzb3IgaXMgdXNlZCBpbnRlcm5hbGx5ICovICkgewoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCWFjY2Vzc29yID0gdmFsdWU7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gZm9yY2U7CgkJCQlmb3JjZSA9IGZhbHNlOwoJCQl9CgoJCQlhY2Nlc3NvciA9IGFjY2Vzc29yIHx8IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCgkJCXZhciBwaHlzaWNhbFBhdGggPSBhY2Nlc3Nvci5waHlzaWNhbFBhdGg7CgoJCQl2YXIgaG9zdE9iaiA9IGFjY2Vzc29yLmhvc3RPYmosCgkJCQlpbmRleCA9IGFjY2Vzc29yLmluZGV4LAoJCQkJaXNIb3N0T2JqQXJyYXkgPSBpc0FycmF5KCBob3N0T2JqICk7CgoJCQlpZiAoaXNIb3N0T2JqQXJyYXkgJiYgaXNOdW1lcmljKCBpbmRleCApKSB7CgkJCQlpZiAoaW5kZXggPiBob3N0T2JqLmxlbmd0aCkgewoJCQkJCXRocm93ICJ5b3UgY2FuIG5vdCBhZGQgaXRlbSB3aXRoIGhvbGUgaW4gYXJyYXkiOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaWYgKGluZGV4IGluIGhvc3RPYmopIHsKCQkJCQl0aHJvdyAidmFsdWUgYXQgcGF0aDogJyIgKyB0b0xvZ2ljYWxQYXRoKCBhY2Nlc3Nvci5waHlzaWNhbFBhdGggKSArICInIGhhcyBiZWVuIGRlZmluZWQsICIgKwoJCQkJCSAgICAgICJ0cnkgdXNlIHVwZGF0ZSBtZXRob2QgaW5zdGVhZCI7CgkJCQl9CgkJCX0KCgkJCWlmICghZm9yY2UgJiYgdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGJlZm9yZUNyZWF0ZSwgdmFsdWUgKS5oYXNFcnJvcigpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmIChpc0hvc3RPYmpBcnJheSAmJiBpc051bWVyaWMoIGluZGV4ICkpIHsKCQkJCWlmIChpbmRleCA9PSBob3N0T2JqLmxlbmd0aCkgewoJCQkJCWhvc3RPYmpbaW5kZXhdID0gdmFsdWU7CgoJCQkJfSBlbHNlIGlmIChpbmRleCA8IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJLy9pbnNlcnQgYW4gaXRlbSB4IGludG8gYXJyYXkgWyAxLCAyLCAzXSBhdCBwb3NpdGlvbiAyLAoJCQkJCS8vIGFuZCBpdCBiZWNvbWVzIFsxLCB4LCAyLCAzXQoJCQkJCWhvc3RPYmouc3BsaWNlKCBhY2Nlc3Nvci5pbmRleCwgMCwgdmFsdWUgKTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQlob3N0T2JqW2FjY2Vzc29yLmluZGV4XSA9IHZhbHVlOwoJCQl9CgoJCQl0cmF2ZXJzZU1vZGVsKCBwaHlzaWNhbFBhdGgsIHZhbHVlICk7CgkJCXRyaWdnZXIoIHBoeXNpY2FsUGF0aCwgcGh5c2ljYWxQYXRoLCBhZnRlckNyZWF0ZSwgdmFsdWUgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZXh0ZW5kOiBmdW5jdGlvbiggc3ViUGF0aCwgb2JqZWN0ICkgewoJCQl2YXIgbmV3TW9kZWw7CgkJCWlmICghb2JqZWN0KSB7CgkJCQlvYmplY3QgPSBzdWJQYXRoOwoJCQkJbmV3TW9kZWwgPSB0aGlzOwoJCQl9IGVsc2UgewoJCQkJbmV3TW9kZWwgPSB0aGlzLmNkKCBzdWJQYXRoICk7CgkJCX0KCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgewoJCQkJbmV3TW9kZWwuc2V0KCBrZXksIG9iamVjdFtrZXldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLyogYWNjZXNzb3IgaXMgdXNlZCBpbnRlcm5hbGx5ICovCgkJLy91cGRhdGUodmFsdWUpCgkJLy91cGRhdGUoc3ViUGF0aCwgdmFsdWUpCgkJLy9tb3N0IG9mIHRoZSB0aW1lIGZvcmNlIGlzIG5vdCB1c2VkLCBieSBkZWZhdWx0IGlzIGl0IGlzIGZhbHNlCgkJLy9ieSBpbiBjYXNlIHlvdSB3YW50IHRvIGJ5cGFzcyB2YWxpZGF0aW9uIHlvdSBjYW4gZXhwbGljaXRseSBzZXQgdG8gdHJ1ZQoJCXVwZGF0ZTogZnVuY3Rpb24oIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSB7CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQlpZiAodGhpcy5wYXRoID09PSAiIikgewoJCQkJCXRocm93ICJyb290IG9iamVjdCBjYW4gbm90IHVwZGF0ZWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyb290Tm9kZS51cGRhdGUoIHRoaXMucGF0aCwgZm9yY2UgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfQoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCWFjY2Vzc29yID0gdmFsdWU7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gZm9yY2U7CgkJCQlmb3JjZSA9IGZhbHNlOwoJCQl9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewoJCQkJcm9vdE5vZGUudXBkYXRlKCBmb3JjZSwgdGhpcy5wYXRoLCBzdWJQYXRoICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJYWNjZXNzb3IgPSBhY2Nlc3NvciB8fCB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgoJCQlpZiAoISggYWNjZXNzb3IuaW5kZXggaW4gYWNjZXNzb3IuaG9zdE9iaiApKSB7CgkJCQl0aHJvdyAidmFsdWUgYXQgcGF0aDogJyIgKyB0b0xvZ2ljYWxQYXRoKCBhY2Nlc3Nvci5waHlzaWNhbFBhdGggKSArICInIGhhcyBiZWVuIG5vdCBkZWZpbmVkLCAiICsKCQkJCSAgICAgICJ0cnkgdXNlIGNyZWF0ZSBtZXRob2QgaW5zdGVhZCI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSBhY2Nlc3Nvci5waHlzaWNhbFBhdGg7CgoJCQl2YXIgb3JpZ2luYWxWYWx1ZSA9IGFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoJCQkvL3VzZSAiPT0iIGlzIHB1cnBvc2VmdWwsIHdlIHdhbnQgaXQgdG8gYmUgZmxleGlibGUuCgkJCS8vIElmIG1vZGVsIHZhbHVlIGlzIG51bGwsIGFuZCB0ZXh0Qm94IHZhbHVlIGlzICIiLCBiZWNhdXNlIG51bGwgPT0gIiIsCgkJCS8vIHNvIHRoYXQgIiIgY2FuIG5vdCBiZSBzZXQsIHNhbWUgZm9yICI5IiBhbmQgOQoJCQlpZiAob3JpZ2luYWxWYWx1ZSA9PSB2YWx1ZSkgewoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCWlmICghZm9yY2UgJiYgdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGJlZm9yZVVwZGF0ZSwgdmFsdWUsIG9yaWdpbmFsVmFsdWUgKS5oYXNFcnJvcigpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdID0gdmFsdWU7CgoJCQl0cmF2ZXJzZU1vZGVsKCBwaHlzaWNhbFBhdGgsIHZhbHVlICk7CgoJCQlpZiAoIWZvcmNlKSB7CgkJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYWZ0ZXJVcGRhdGUsIHZhbHVlLCBvcmlnaW5hbFZhbHVlICk7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWRlbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCWlmIChpc1VuZGVmaW5lZCggc3ViUGF0aCApKSB7CgkJCQlpZiAodGhpcy5wYXRoKSB7CgkJCQkJcmV0dXJuIHJvb3ROb2RlLmRlbCggdGhpcy5wYXRoICk7CgkJCQl9CgkJCQl0aHJvdyAicm9vdCBjYW4gbm90IGJlIGRlbGV0ZWQiOwoJCQl9CgoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICksCgkJCQlob3N0T2JqID0gYWNjZXNzb3IuaG9zdE9iaiwKCQkJCXBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aCwKCQkJCXJlbW92ZWRWYWx1ZSA9IGhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdLAoJCQkJaXNIb3N0T2JqZWN0QXJyYXkgPSBpc0FycmF5KCBob3N0T2JqICk7CgoJCQlpZiAodHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJiZWZvcmVEZWwiLCB1bmRlZmluZWQsIHJlbW92ZWRWYWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJkdXJpbmdEZWwiLCB1bmRlZmluZWQsIHJlbW92ZWRWYWx1ZSApOwoKCQkJaWYgKGlzSG9zdE9iamVjdEFycmF5KSB7CgoJCQkJaG9zdE9iai5zcGxpY2UoIGFjY2Vzc29yLmluZGV4LCAxICk7CgoJCQl9IGVsc2UgewoKCQkJCWRlbGV0ZSBob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCX0KCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb25EZWxldGVIYW5kbGVycy5sZW5ndGg7IGkrKykgewoJCQkJb25EZWxldGVIYW5kbGVyc1tpXSggcGh5c2ljYWxQYXRoLCByZW1vdmVkVmFsdWUgKTsKCQkJfQoKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlckRlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICk7CgkJCXJldHVybiByZW1vdmVkVmFsdWU7CgkJfSwKCgkJY3JlYXRlSWZVbmRlZmluZWQ6IGZ1bmN0aW9uKCBzdWJQYXRoLCB2YWx1ZSApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCB2YWx1ZSApKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWx1ZSBhcmd1bWVudCI7CgkJCX0KCQkJdmFyIGFjY2Vzc29yID0gdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJdGhpcyA6CgkJCQl0aGlzLmNyZWF0ZSggc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJaWYgKGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmopIHsKCQkJCXRoaXMudXBkYXRlKCBzdWJQYXRoLCAhYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF0sIGFjY2Vzc29yICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLy9uYXZpZ2F0aW9uIG1ldGhvZHMKCQlwdXNoU3RhY2s6IGZ1bmN0aW9uKCBuZXdOb2RlICkgewoJCQluZXdOb2RlLnByZXZpb3VzID0gdGhpczsKCQkJcmV0dXJuIG5ld05vZGU7CgkJfSwKCgkJY2Q6IGZ1bmN0aW9uKCByZWxhdGl2ZVBhdGggKSB7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaG0oIHRoaXMuZ2V0UGF0aCggcmVsYXRpdmVQYXRoICkgKSApOwoJCX0sCgoJCXBhcmVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmNkKCAiLi4iICk7CgkJfSwKCgkJc2hhZG93OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuY2QoICIqIiApOwoJCX0sCgoJCXNpYmxpbmc6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQlyZXR1cm4gdGhpcy5jZCggIi4uIiArIHBhdGggKTsKCQl9LAoKCQltYWluOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaG0oIGdldE1haW5QYXRoKCB0aGlzLnBhdGggKSApICk7CgkJfSwKCgkJLy8tLS0tLS0tLS0tLS0tLXBhdGggbWV0aG9kcy0tLS0tLS0tLS0tLS0tLQoJCWdldFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQkvL2pvaW4gdGhlIGNvbnRleHQgYW5kIHN1YlBhdGggdG9nZXRoZXIsIGJ1dCBpdCBpcyBzdGlsbCBhIGxvZ2ljYWwgcGF0aAoJCQlyZXR1cm4gbWVyZ2VQYXRoKCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQl9LAoKCQkvL3RvIGdldCB0aGUgbG9naWNhbFBhdGggb2YgY3VycmVudCBtb2RlbCwgbGVhdmUgc3ViUGF0aCBlbXB0eQoJCWxvZ2ljYWxQYXRoOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJcmV0dXJuIHRvTG9naWNhbFBhdGgoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApICk7CgkJfSwKCgkJLy90byBnZXQgdGhlIHBoeXNpY2FsUGF0aCBvZiBjdXJyZW50IG1vZGVsLCBsZWF2ZSBzdWJQYXRoIGVtcHR5CgkJcGh5c2ljYWxQYXRoOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJcmV0dXJuIHRvUGh5c2ljYWxQYXRoKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSApOwoJCX0sCgoJCXBhdGhDb250ZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGNvbnRleHRPZlBhdGgoIHRoaXMucGF0aCApOwoJCX0sCgoJCXBhdGhJbmRleDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBpbmRleE9mUGF0aCggdGhpcy5wYXRoICk7CgkJfSwKCgkJLy9jYWxsIHRoZSBuYXRpdmUgbWV0aG9kIG9mIHRoZSB3cmFwcGVkIHZhbHVlCgkJaW52b2tlVW53cmFwcGVkOiBmdW5jdGlvbiggbWV0aG9kTmFtZSAvKiwgcDEsIHAyLCAuLi4qLyApIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKCQkJCXRocm93ICJtZXRob2ROYW1lIGlzIG1pc3NpbmciOwoJCQl9CgoJCQl2YXIgY29udGV4dCA9IHRoaXMuZ2V0KCk7CgkJCXJldHVybiBjb250ZXh0W21ldGhvZE5hbWVdLmFwcGx5KCBjb250ZXh0LCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoJCX0sCgoJCS8vcmVnaW9uIGFycmF5IG1ldGhvZHMKCQlpbmRleE9mOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCkuaW5kZXhPZiggaXRlbSApOwoJCX0sCgoJCWNvbnRhaW5zOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuICh0aGlzLmluZGV4T2YoIGl0ZW0gKSAhPT0gLTEpOwoJCX0sCgoJCWZpcnN0OiBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBmbiA/IHRoaXMuZmlsdGVyKCBmbiApWzBdIDogdGhpcy5nZXQoICIwIiApOwoJCX0sCgoJCWxhc3Q6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwoJCQlyZXR1cm4gdmFsdWVbdmFsdWUubGVuZ3RoIC0gMV07CgkJfSwKCgkJcHVzaDogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl0aGlzLmNyZWF0ZSggdGhpcy5nZXQoKS5sZW5ndGgsIGFyZ3VtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXB1c2hVbmlxdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gIXRoaXMuY29udGFpbnMoIGl0ZW0gKSA/CgkJCQl0aGlzLnB1c2goIGl0ZW0gKSA6CgkJCQl0aGlzOwoJCX0sCgoJCXBvcDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnJlbW92ZUF0KCB0aGlzLmdldCgpLmxlbmd0aCAtIDEgKTsKCQl9LAoKCQlzaGlmdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmRlbCggMCApOwoJCX0sCgoJCXVuc2hpZnQ6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGUoIDAsIGl0ZW0gKTsKCQl9LAoKCQlpbnNlcnRBdDogZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGUoIGluZGV4LCBpdGVtICk7CgkJfSwKCgkJdXBkYXRlQXQ6IGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsKCQkJcmV0dXJuIHRoaXMudXBkYXRlKCBpbmRleCwgaXRlbSApOwoJCX0sCgoJCXJlbW92ZUF0OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJCXJldHVybiB0aGlzLmRlbCggaW5kZXggKTsKCQl9LAoKCQltb3ZlOiBmdW5jdGlvbiggZnJvbUluZGV4LCB0b0luZGV4ICkgewoJCQl2YXIgY291bnQgPSB0aGlzLmNvdW50KCk7CgoJCQlpZiAoZnJvbUluZGV4ICE9PSB0b0luZGV4ICYmCgkJCSAgICBmcm9tSW5kZXggPj0gMCAmJiBmcm9tSW5kZXggPCBjb3VudCAmJgoJCQkgICAgdG9JbmRleCA+PSAwICYmIHRvSW5kZXggPCBjb3VudCkgewoKCQkJCXZhciBpdGVtID0gdGhpcy5kZWwoIGZyb21JbmRleCApOwoJCQkJdGhpcy5pbnNlcnRBdCggdG9JbmRleCwgaXRlbSApOwoJCQkJdHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJtb3ZlIiwgdG9JbmRleCwgZnJvbUluZGV4ICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVwbGFjZUl0ZW06IGZ1bmN0aW9uKCBvbGRJdGVtLCBuZXdJdGVtICkgewoJCQlpZiAob2xkSXRlbSA9PSBuZXdJdGVtKSB7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJdmFyIGluZGV4ID0gdGhpcy5pbmRleE9mKCBvbGRJdGVtICk7CgoJCQlpZiAoaW5kZXggIT0gLTEpIHsKCQkJCXJldHVybiB0aGlzLnVwZGF0ZUF0KCBpbmRleCwgbmV3SXRlbSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXJlbW92ZUl0ZW06IGZ1bmN0aW9uKCBpdGVtICkgewoJCQl2YXIgaW5kZXggPSB0aGlzLmluZGV4T2YoIGl0ZW0gKTsKCQkJcmV0dXJuIGluZGV4ICE9PSAtMSA/IHRoaXMucmVtb3ZlQXQoIGluZGV4ICkgOiB0aGlzOwoJCX0sCgoJCXJlbW92ZUl0ZW1zOiBmdW5jdGlvbiggaXRlbXMgKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJCXRoaXMucmVtb3ZlSXRlbSggaXRlbXNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljbGVhcjogZnVuY3Rpb24oKSB7CgkJCXZhciBpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCQlvbGRJdGVtcyA9IGl0ZW1zLnNwbGljZSggMCwgaXRlbXMubGVuZ3RoICk7CgoJCQl0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgImFmdGVyQ3JlYXRlIiwgaXRlbXMsIG9sZEl0ZW1zICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWNvdW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCkubGVuZ3RoOwoJCX0sCgoJCS8vZm4gaXMgbGlrZSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHsgcmV0dXJuIGl0ZW0gPT0gMTsgfTsKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuICQoIHRoaXMuZ2V0KCkgKS5maWx0ZXIoIGZuICkuZ2V0KCk7CgkJfSwKCgkJLy9mbjogZnVuY3Rpb24gKGluZGV4LCBpdGVtLCBpdGVtcykge30KCQllYWNoOiBmdW5jdGlvbiggZGlyZWN0QWNjZXNzLCBmbiApIHsKCQkJaWYgKCFpc0Jvb2xlYW4oIGRpcmVjdEFjY2VzcyApKSB7CgkJCQlmbiA9IGRpcmVjdEFjY2VzczsKCQkJCWRpcmVjdEFjY2VzcyA9IGZhbHNlOwoJCQl9CgoJCQl2YXIgaGFzQ2hhbmdlLCBpLCBzdGF0dXMsIGl0ZW1zLCBpdGVtTW9kZWw7CgoJCQlpZiAoZGlyZWN0QWNjZXNzKSB7CgoJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoKCQkJCWZvciAoaSA9IGl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJLy90aGlzIGluIHRoZSBmbiByZWZlciB0byB0aGUgcGFyZW50IGFycmF5CgkJCQkJc3RhdHVzID0gZm4uY2FsbCggaXRlbXNbaV0sIGksIGl0ZW1zW2ldLCBpdGVtcyApOwoJCQkJCWlmIChzdGF0dXMgPT09IHRydWUpIHsKCQkJCQkJaGFzQ2hhbmdlID0gdHJ1ZTsKCQkJCQl9IGVsc2UgaWYgKHN0YXR1cyA9PT0gZmFsc2UpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCWlmIChoYXNDaGFuZ2UpIHsKCQkJCQl0aGlzLmNoYW5nZSgpOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoaSA9IHRoaXMuY291bnQoKSAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJLy90aGlzIGluIHRoZSBmbiwgcmVmZXIgdG8gdGhlIHBhcmVudCBtb2RlbAoJCQkJCWl0ZW1Nb2RlbCA9IHRoaXMuY2QoIGkgKTsKCQkJCQlpZiAoZm4uY2FsbCggaXRlbU1vZGVsLCBpLCBpdGVtTW9kZWwsIHRoaXMgKSA9PT0gZmFsc2UpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCW1hcDogZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gJC5tYXAoIHRoaXMuZ2V0KCksIGZuICk7CgkJfSwKCgkJc29ydDogZnVuY3Rpb24oIGJ5LCBhc2MgKSB7CgkJCXJldHVybiB0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgImFmdGVyVXBkYXRlIiwgdGhpcy5nZXQoKS5zb3J0T2JqZWN0KCBieSwgYXNjICkgKTsKCQl9LAoJCS8vI2VuZHJlZ2lvbgoKCQkvLy0tLS0tLS1tb2RlbCB3YXRjaCBtZXRob2QgLS0tLS0tLS0tLS0KCQl3YXRjaDogZnVuY3Rpb24oIC8qdGFyZ2V0UGF0aDEsIHRhcmdldFBhdGgyLCAuLiovICkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJd2F0Y2goIHRoaXMucGF0aCwgYXJndW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJdW53YXRjaDogZnVuY3Rpb24oIC8qdGFyZ2V0UGF0aDEsIHRhcmdldFBhdGgyLCAuLiovICkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJdW53YXRjaCggdGhpcy5wYXRoLCBhcmd1bWVudHNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvL2VuZHJlZ2lvbgoKCQkvLy0tLS0tLS1vdGhlciBtZXRob2RzLS0tLS0tLS0tCgkJaXNFbXB0eTogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXZhciB2YWx1ZSA9IHRoaXMuZ2V0KCBzdWJQYXRoICk7CgkJCXJldHVybiAhdmFsdWUgPyB0cnVlIDoKCQkJCSFpc0FycmF5KCB2YWx1ZSApID8gZmFsc2UgOgoJCQkJCSh2YWx1ZS5sZW5ndGggPT09IDApOwoJCX0sCgoJCWlzU2hhZG93OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucGF0aC5zdGFydHNXaXRoKCBzaGFkb3dOYW1lc3BhY2UgKTsKCQl9LAoKCQl0b0pTT046IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gSlNPTi5zdHJpbmdpZnkoIHRoaXMuZ2V0KCBzdWJQYXRoICkgKTsKCQl9LAoKCQljb21wYXJlOiBmdW5jdGlvbiggZXhwcmVzc2lvbiApIHsKCQkJaWYgKGV4cHJlc3Npb24pIHsKCQkJCWV4cHJlc3Npb24gPSB0b1R5cGVkVmFsdWUoIGV4cHJlc3Npb24gKTsKCQkJCWlmIChpc1N0cmluZyggZXhwcmVzc2lvbiApKSB7CgkJCQkJaWYgKHRoaXMuZ2V0KCkgPT0gZXhwcmVzc2lvbikgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0cnkgewoJCQkJCQkJcmV0dXJuIGV2YWwoICJ0aGlzLmdldCgpIiArIGV4cHJlc3Npb24gKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gdGhpcy5nZXQoKSA9PSBleHByZXNzaW9uOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuaXNFbXB0eSgpOwoJCQl9CgkJfSwKCgkJc2F2ZUxvY2FsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHRoaXMuZ2V0KCBzdWJQYXRoICkgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZ2V0TG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICkgKTsKCQl9LAoKCQlyZXN0b3JlTG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyb290Tm9kZS5zZXQoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCB0aGlzLmdldExvY2FsKCBzdWJQYXRoICkgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJY2xlYXJMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXV0aWwubG9jYWwoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCB1bmRlZmluZWQgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX07CgoJZnVuY3Rpb24gZXhwYW5kVG9IYXNoZXMoICQwICkgewoJCXJldHVybiAkMCA9PT0gIi4iID8gIiMiIDogLy9pZiBpdCBpcyAiLiIgY29udmVydCB0byAiIyIKCQkJbmV3IEFycmF5KCAkMC5sZW5ndGggKyAyICkuam9pbiggIiMiICk7IC8vLy9pZiBpdCBpcyAiIyIgY29udmVydCB0byAiIyMiCgl9CgoJdmFyIG9uQWRkT3JVcGRhdGVIYW5kbGVycyA9IFtmdW5jdGlvbiAvKmluZmVyTm9kZURlcGVuZGVuY2llcyovICggY29udGV4dCwgaW5kZXgsIHZhbHVlICkgewoKCQkvL29ubHkgdHJ5IHRvIHBhcnNlIGZ1bmN0aW9uIGJvZHkKCQkvL2lmIGl0IGlzIGEgcGFyYW1ldGVyLWxlc3MgZnVuY3Rpb24KCQkvL29yIGl0IGhhcyBhIG1hZ2ljIGZ1bmN0aW9uIG5hbWUgIl8iCgkJaWYgKCFpc0Z1bmN0aW9uKCB2YWx1ZSApIHx8ICh2YWx1ZS5uYW1lICYmIHZhbHVlLm5hbWUuc3RhcnRzV2l0aCggIl8iICkpKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBmdW5jdGlvbkJvZHkgPSB2YWx1ZS50b1N0cmluZygpLAoJCQlwYXRoID0gY29udGV4dCA/IGNvbnRleHQgKyAiLiIgKyBpbmRleCA6IGluZGV4LAoJCQl3YXRjaGVkUGF0aHMgPSBleHRyYWN0V2F0Y2hlZFBhdGhzKCBmdW5jdGlvbkJvZHkgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCB3YXRjaGVkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJd2F0Y2goIHBhdGgsIGNvbnRleHQgPyBtZXJnZVBhdGgoIGNvbnRleHQsIHdhdGNoZWRQYXRoc1tpXSApIDogd2F0Y2hlZFBhdGhzW2ldICk7CgkJfQoJfV07CgoJZnVuY3Rpb24gcHJvY2Vzc05ld05vZGUoIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvbkFkZE9yVXBkYXRlSGFuZGxlcnMubGVuZ3RoOyBpKyspIHsKCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CgkJfQoJfQoKCWZ1bmN0aW9uIGdldE1haW5QYXRoKCBzaGFkb3dQYXRoICkgewoJCWlmIChzaGFkb3dQYXRoID09PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJcmV0dXJuICIiOwoJCX0KCQl2YXIgbWF0Y2ggPSByU2hhZG93S2V5LmV4ZWMoIHNoYWRvd1BhdGggKTsKCQlyZXR1cm4gbWF0Y2ggPyBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCggbWF0Y2hbMV0gKSA6IHNoYWRvd1BhdGg7Cgl9CgoJZnVuY3Rpb24gY29udmVydFNoYWRvd0tleVRvTWFpblBhdGgoIGtleSApIHsKCQlyZXR1cm4ga2V5LnJlcGxhY2UoIHJIYXNoLCByZWR1Y2VUb0RvdCApOwoJfQoKCWZ1bmN0aW9uIHJlZHVjZVRvRG90KCBoYXNoZXMgKSB7CgkJcmV0dXJuIGhhc2hlcyA9PSAiIyIgPyAiLiIgOiAvLyBpZiBpcyAjIHJldHVybiAuCgkJCW5ldyBBcnJheSggaGFzaGVzLmxlbmd0aCApLmpvaW4oICIjIiApOyAvLyBpZiBpdCBpcyAjIyByZXR1cm4gIwoJfQoKCS8qIHByb2Nlc3NDdXJyZW50IGlzIHVzZWQgaW50ZXJuYWxseSwgZG9uJ3QgdXNlIGl0ICovCglmdW5jdGlvbiB0cmF2ZXJzZU1vZGVsKCBtb2RlbFBhdGgsIG1vZGVsVmFsdWUsIHByb2Nlc3NDdXJyZW50ICkgewoJCXZhciBjb250ZXh0UGF0aCwKCQkJaW5kZXhQYXRoLAoJCQlpbmRleE9mTGFzdERvdCA9IG1vZGVsUGF0aC5sYXN0SW5kZXhPZiggIi4iICk7CgoJCWlmIChpc1VuZGVmaW5lZCggcHJvY2Vzc0N1cnJlbnQgKSkgewoJCQlwcm9jZXNzQ3VycmVudCA9IHRydWU7CgkJfQoKCQlpZiAocHJvY2Vzc0N1cnJlbnQpIHsKCgkJCWlmIChpbmRleE9mTGFzdERvdCA9PT0gLTEpIHsKCQkJCWNvbnRleHRQYXRoID0gIiI7CgkJCQlpbmRleFBhdGggPSBtb2RlbFBhdGg7CgkJCX0gZWxzZSB7CgkJCQljb250ZXh0UGF0aCA9IG1vZGVsUGF0aC5zdWJzdHJpbmcoIDAsIGluZGV4T2ZMYXN0RG90ICk7CgkJCQlpbmRleFBhdGggPSBtb2RlbFBhdGguc3Vic3RyaW5nKCBpbmRleE9mTGFzdERvdCArIDEgKTsKCQkJfQoKCQkJcHJvY2Vzc05ld05vZGUoIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKTsKCQl9CgoJCWlmICghaXNQcmltaXRpdmUoIG1vZGVsVmFsdWUgKSkgewoKCQkJZm9yIChpbmRleFBhdGggaW4gbW9kZWxWYWx1ZSkgewoKCQkJCS8vZG8gbm90IHJlbW92ZSB0aGUgaGFzT3duUHJvcGVydHkgY2hlY2shIQoJCQkJLy9pZiAoaGFzT3duLmNhbGwoIG1vZGVsVmFsdWUsIGluZGV4ICkpIHsKCQkJCXByb2Nlc3NOZXdOb2RlKCBtb2RlbFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZVtpbmRleFBhdGhdICk7CgkJCQl0cmF2ZXJzZU1vZGVsKCBtb2RlbFBhdGggKyAiLiIgKyBpbmRleFBhdGgsIG1vZGVsVmFsdWVbaW5kZXhQYXRoXSwgZmFsc2UgKTsKCQkJCS8vfQoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHdhdGNoKCB3YXRjaGluZ1BhdGgsIHdhdGNoZWRQYXRoICkgewoJCXdhdGNoZWRQYXRoID0gdG9QaHlzaWNhbFBhdGgoIHdhdGNoZWRQYXRoICk7CgkJdmFyIHJlZmVyZW5jaW5nUGF0aHMgPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQlpZiAoIXJlZmVyZW5jaW5nUGF0aHMpIHsKCQkJd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF0gPSByZWZlcmVuY2luZ1BhdGhzID0gW107CgkJfQoJCXJlZmVyZW5jaW5nUGF0aHMucHVzaFVuaXF1ZSggd2F0Y2hpbmdQYXRoICk7Cgl9CgoJZnVuY3Rpb24gdW53YXRjaCggd2F0Y2hpbmdQYXRoLCB3YXRjaGVkUGF0aCApIHsKCQl3YXRjaGVkUGF0aCA9IHRvUGh5c2ljYWxQYXRoKCB3YXRjaGVkUGF0aCApOwoJCXZhciB3YXRjaGluZ1BhdGhzID0gd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJd2F0Y2hpbmdQYXRocy5yZW1vdmUoIHdhdGNoaW5nUGF0aCApOwoJCWlmICghd2F0Y2hpbmdQYXRocy5sZW5ndGgpIHsKCQkJZGVsZXRlIHdhdGNoVGFibGVbd2F0Y2hlZFBhdGhdOwoJCX0KCX0KCglmdW5jdGlvbiBleHRyYWN0V2F0Y2hlZFBhdGhzKCBmdW5jdGlvbkJvZHkgKSB7CgkJdmFyIG1lbWJlck1hdGNoLAoJCQlydG4gPSBbXTsKCgkJd2hpbGUgKChtZW1iZXJNYXRjaCA9IHJXYXRjaGVkUGF0aC5leGVjKCBmdW5jdGlvbkJvZHkgKSApKSB7CgkJCXJ0bi5wdXNoVW5pcXVlKCBtZW1iZXJNYXRjaFsyXSApOwoJCX0KCQlyZXR1cm4gcnRuOwoJfQoKCWZ1bmN0aW9uIGNvbnRleHRPZlBhdGgoIHBhdGggKSB7CgkJdmFyIG1hdGNoID0gclBhcmVudEtleS5leGVjKCBwYXRoICk7CgkJcmV0dXJuIG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwoJfQoKCWZ1bmN0aW9uIGluZGV4T2ZQYXRoKCBwYXRoICkgewoJCXZhciBtYXRjaCA9IHJJbmRleC5leGVjKCBwYXRoICk7CgkJcmV0dXJuIG1hdGNoWzFdIHx8IG1hdGNoWzBdOwoJfQoKCXZhciBkdW1teSA9IHt9OwoKCXZhciBDbGFzcyA9IGZ1bmN0aW9uIF8oIHNlZWQgKSB7CgkJdmFyIHRlbXA7CgoJCWlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgewoJCQl0ZW1wID0gbmV3IF8oIGR1bW15ICk7CgkJCXJldHVybiBfLmFwcGx5KCB0ZW1wLCBhcmd1bWVudHMgKTsKCQl9CgoJCWlmIChhcmd1bWVudHNbMF0gPT09IGR1bW15KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdGhpcy5pbml0aWFsaXplLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIHN1cGVyUHJvdG90eXBlOwoJZXh0ZW5kKCBDbGFzcy5wcm90b3R5cGUsIHsKCgkJY2FsbFByb3RvOiBmdW5jdGlvbiggbWV0aG9kTmFtZSApIHsKCQkJdmFyIG1ldGhvZCA9IHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlW21ldGhvZE5hbWVdOwoJCQlyZXR1cm4gbWV0aG9kLmFwcGx5KCB0aGlzLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoJCX0sCgoJCS8vaW5zdGFuY2UuY2FsbEJhc2UoIm1ldGhvZDEiLCBwMSwgcDIsLi4uKTsKCQljYWxsQmFzZTogZnVuY3Rpb24oIG1ldGhvZE5hbWUgKSB7CgkJCS8vc3VwZXJQcm90b3R5cGUgaXMgZ2xvYmFsIG9iamVjdCwgd2UgdXNlIHRoaXMKCQkJLy8gYmVjYXVzZSBhc3N1bWUganMgaW4gYnJvd3NlciBpcyBhIHNpbmdsZSB0aHJlYWRlZAoKCQkJLy9zdGFydGluZyBmcm9tICJ0aGlzIiBpbnN0YW5jZQoJCQlzdXBlclByb3RvdHlwZSA9IHN1cGVyUHJvdG90eXBlIHx8IHRoaXM7CgkJCXN1cGVyUHJvdG90eXBlID0gc3VwZXJQcm90b3R5cGUuY29uc3RydWN0b3IuX19zdXBlcl9fOwoKCQkJaWYgKCFzdXBlclByb3RvdHlwZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbWV0aG9kID0gc3VwZXJQcm90b3R5cGVbbWV0aG9kTmFtZV07CgkJCXZhciBydG4gPSBtZXRob2QuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgoJCQkvL3doZW4gaXQgZG9uZSwgc2V0IGl0IGJhY2sgdG8gbnVsbAoJCQlzdXBlclByb3RvdHlwZSA9IG51bGw7CgkJCXJldHVybiBydG47CgkJfSwKCgkJLyogdGhlIHN1YlR5cGUncyBpbml0aWFsaXplIHNob3VsZCBiZSBsaWtlCgkJICoKCQkgaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHNlZWQgKSB7CgkJIC8vZG8gdGhpbmdzCgkJIHRoaXMuY2FsbEJhc2UoICJpbml0aWFsaXplIiwgc2VlZCApOwoJCSB9LAoJCSAqLwoJCS8vdGhlIGRlZmF1bHQgaW5pdGlhbGl6ZSBpcyB0byBleHRlbmQgdGhlIGluc3RhbmNlIHdpdGggc2VlZCBkYXRhCgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHNlZWQgKSB7CgkJCWV4dGVuZCggdGhpcywgc2VlZCApOwoJCX0sCgoJCS8vdGhpcyBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuIEpTT04uc3RyaW5naWZ5KCkgaXMgY2FsbGVkCgkJdG9KU09OOiBmdW5jdGlvbigpIHsKCQkJdmFyIHJ0biA9IGV4dGVuZCggdHJ1ZSwge30sIHRoaXMgKTsKCgkJCWZvciAodmFyIGtleSBpbiBydG4pIHsKCQkJCWlmIChrZXkuc3RhcnRzV2l0aCggIl9fIiApKSB7CgkJCQkJZGVsZXRlIHJ0bltrZXldOwoJCQkJfQoJCQl9CgkJCXJldHVybiBydG47CgkJfQoKCX0gKTsKCglleHRlbmQoIENsYXNzLCB7CgoJCS8vY3JlYXRlIGFuIGFycmF5IG9mIGl0ZW1zIG9mIHRoZSBzYW1lIHR5cGUKCQkvL2lmIFlvdSBoYXZlIGEgc3ViVHlwZSBjYWxsZWQgUGVyc29uCgkJLy95b3UgY2FuIFBlcnNvbi5saXN0KFsgc2VlZDEsIHNlZWQyIF0pOwoJCS8vdG8gY3JlYXRlIGFuIGFycmF5IG9mIHR5cGVkIGl0ZW1zCgkJbGlzdDogZnVuY3Rpb24oIHNlZWRzICkgewoKCQkJdmFyIGksCgkJCQlzZWVkLAoJCQkJcnRuID0gW10sCgkJCQlpdGVtSXNPYmplY3Q7CgoJCQlpZiAoaXNVbmRlZmluZWQoIHNlZWRzICkpIHsKCgkJCQlyZXR1cm4gcnRuOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIWlzQXJyYXkoIHNlZWRzICkpIHsKCgkJCQkJc2VlZHMgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMgKTsKCgkJCQl9CgoJCQkJaXRlbUlzT2JqZWN0ID0gc2VlZHMuaXRlbUlzT2JqZWN0OwoKCQkJCWZvciAoaSA9IDA7IGkgPCBzZWVkcy5sZW5ndGg7IGkrKykgewoJCQkJCXNlZWQgPSBzZWVkc1tpXTsKCgkJCQkJcnRuLnB1c2goCgkJCQkJCWl0ZW1Jc09iamVjdCB8fCAhaXNBcnJheSggc2VlZCApID8KCQkJCQkJCXNlZWRzIGluc3RhbmNlb2YgdGhpcyA/IHRoaXMgOiBuZXcgdGhpcyggc2VlZCApIDoKCQkJCQkJCXRoaXMuYXBwbHkoIG51bGwsIHNlZWQgKQoJCQkJCSk7CgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8vdG8gY3JlYXRlIGEgbmV3IFR5cGUgY2FsbAoKCQlleHRlbmQ6IGZ1bmN0aW9uKCBpbnN0YW5jZU1lbWJlcnMsIHN0YXRpY01lbWJlcnMgKSB7CgkJCXZhciBDaGlsZCwKCQkJCVBhcmVudCA9IHRoaXM7CgoJCQkvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CgkJCS8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCQkJLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJCQlpZiAoaW5zdGFuY2VNZW1iZXJzICYmIGluc3RhbmNlTWVtYmVycy5oYXNPd25Qcm9wZXJ0eSggImNvbnN0cnVjdG9yIiApKSB7CgkJCQlDaGlsZCA9IGluc3RhbmNlTWVtYmVycy5jb25zdHJ1Y3RvcjsKCQkJfSBlbHNlIHsKCQkJCUNoaWxkID0gZnVuY3Rpb24gXygpIHsKCQkJCQl2YXIgdGVtcDsKCgkJCQkJaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSB7CgkJCQkJCXRlbXAgPSBuZXcgXyggZHVtbXkgKTsKCQkJCQkJcmV0dXJuIF8uYXBwbHkoIHRlbXAsIGFyZ3VtZW50cyApOwoJCQkJCX0KCgkJCQkJaWYgKGFyZ3VtZW50c1swXSA9PT0gZHVtbXkpIHsKCQkJCQkJcmV0dXJuIHRoaXM7CgkJCQkJfQoJCQkJCS8vdGhpcyBpcyBzaW1pbGFyIGxpa2UgOiBiYXNlKGFyZ3VtZW50cykKCQkJCQlQYXJlbnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfTsKCQkJfQoKCQkJLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkJCWV4dGVuZCggQ2hpbGQsIFBhcmVudCwgc3RhdGljTWVtYmVycyApOwoKCQkJLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKCQkJLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCQkJdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gQ2hpbGQ7IH07CgkJCVN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBQYXJlbnQucHJvdG90eXBlOwoJCQlDaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlKCk7CgoJCQkvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCQkJLy8gaWYgc3VwcGxpZWQuCgkJCWlmIChpbnN0YW5jZU1lbWJlcnMpIHsKCQkJCWV4dGVuZCggQ2hpbGQucHJvdG90eXBlLCBpbnN0YW5jZU1lbWJlcnMgKTsKCQkJfQoKCQkJLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJCQkvLyBsYXRlci4KCQkJQ2hpbGQuX19zdXBlcl9fID0gUGFyZW50LnByb3RvdHlwZTsKCgkJCXJldHVybiBDaGlsZDsKCQl9CgoJfSApOwoKCS8vaGVscGVycwoJZXh0ZW5kKCBobSwgewoKCQlDbGFzczogQ2xhc3MsCgoJCXV0aWw6IHV0aWwgPSB7CgoJCQkvL3VzZXIgZG8gbm90IG5lZWQgdG8gdXNlIGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5IHBhcmFtZXRlcgoJCQkvL2l0IGlzIGZvciBpbnRlcm5hbCB1c2UKCQkJLy9pdCBpcyBvbmx5IHVzZWQgaW4gdHdvIHBsYWNlcy4gSXQgaXMsIHdoZW4gYSBtb2RlbCBpcyBjcmVhdGVkCgkJCS8vIGFuZCB3aGVuIGFjY2Vzc29yIGlzIGJ1aWxkLAoJCQkvLyBldmVuIGluIHRoZXNlIHR3byBjYXNlIHdoZW4gdGhlIHBhcmFtZXRlciBpcyB0cnVlLAoJCQkvLyBzaGFkb3cgaXMgbm90IG5lY2Vzc2FyeSBjcmVhdGVkCgkJCS8vIGl0IGlzIG9ubHkgY3JlYXRlZCB3aGVuCgkJCS8vIHRoZSB0aGUgcGh5c2ljYWwgcGF0aCBpcyBwb2ludGluZyB0byBhIHNoYWRvdwoJCQkvLyBhbmQgdGhlIG1haW4gbW9kZWwgaGFzIGJlZW4gY3JlYXRlZAoJCQkvLyBhbmQgdGhlIHNoYWRvdydzIHBhcmVudCBpcyBhbiBvYmplY3QKCQkJdG9QaHlzaWNhbFBhdGg6IHRvUGh5c2ljYWxQYXRoID0gZnVuY3Rpb24oIGxvZ2ljYWxQYXRoLCBjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAvKiBpbnRlcm5hbCB1c2UqLyApIHsKCgkJCQl2YXIgbWF0Y2gsIHJ0biA9ICIiLCBsZWZ0Q29udGV4dCA9ICIiLCBtYWluVmFsdWUsIHNoYWRvd0tleSwgbWFpblBhdGg7CgoJCQkJd2hpbGUgKChtYXRjaCA9IHJEb3RTdGFyLmV4ZWMoIGxvZ2ljYWxQYXRoICkpKSB7CgkJCQkJLy9yZXNldCBsb2dpY2FsIFBhdGggdG8gdGhlIHJlbWFpbmluZyBvZiB0aGUgc2VhcmNoIHRleHQKCQkJCQlsb2dpY2FsUGF0aCA9IFJlZ0V4cC5yaWdodENvbnRleHQ7CgkJCQkJbGVmdENvbnRleHQgPSBSZWdFeHAubGVmdENvbnRleHQ7CgoJCQkJCWlmIChtYXRjaFswXSA9PSAiLiIpIHsKCgkJCQkJCWlmIChydG4pIHsKCQkJCQkJCS8vbWFpblBhdGggPSBydG4gKyAiLiIgKyBsZWZ0Q29udGV4dAoJCQkJCQkJaWYgKHJ0biA9PSBzaGFkb3dOYW1lc3BhY2UgJiYgY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYgIXNoYWRvd1Jvb3RbbGVmdENvbnRleHRdKSB7CgkJCQkJCQkJbWFpblBhdGggPSBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCggbGVmdENvbnRleHQgKTsKCQkJCQkJCQlpZiAoIWlzVW5kZWZpbmVkKCByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoJCQkJCQkJCQlzaGFkb3dSb290W2xlZnRDb250ZXh0XSA9IHt9OwoJCQkJCQkJCX0KCQkJCQkJCQkvLyFpc1VuZGVmaW5lZCggcm9vdE5vZGUuZ2V0KCBtYWluUGF0aCApICkKCQkJCQkJCQkvKglpZiAoY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYKCQkJCQkJCQkgIXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSAmJgoJCQkJCQkJCSBydG4gIT0gc2hhZG93TmFtZXNwYWNlICYmCgkJCQkJCQkJICFpc1VuZGVmaW5lZCggbWFpblZhbHVlID0gcm9vdE5vZGUuZ2V0KCBtYWluUGF0aCApICkpIHsKCQkJCQkJCQkgKi8KCQkJCQkJCX0KCQkJCQkJCXJ0biA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0OwoJCQkJCQkJLy9zaGFkb3dSb290W3NoYWRvd0tleV0KCQkJCQkJCS8vaWYgKHJ0biA9PSkKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJ0biA9IGxlZnRDb250ZXh0OwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvL2lmIG1hdGNoIGlzICIqIiwgdGhlbiBpdCBpcyBzaGFkb3cKCQkJCQkJLy9pZiBydG4gaXMgbm90IGVtcHR5IHNvIGZhcgoJCQkJCQlpZiAocnRuKSB7CgkJCQkJCQkvL3NoYWRvd0tleSB3aWxsIGJlCgkJCQkJCQkvL2NvbnZlcnRNYWluUGF0aFRvU2hhZG93S2V5CgkJCQkJCQlzaGFkb3dLZXkgPSAoIHJ0biA/IHJ0bi5yZXBsYWNlKCBySGFzaE9yRG90LCBleHBhbmRUb0hhc2hlcyApIDogcnRuKSArICIjIiArIGxlZnRDb250ZXh0OwoJCQkJCQkJbWFpblBhdGggPSBydG4gKyAiLiIgKyBsZWZ0Q29udGV4dDsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWlmIChsZWZ0Q29udGV4dCkgewoJCQkJCQkJCXNoYWRvd0tleSA9IGxlZnRDb250ZXh0OwoJCQkJCQkJCW1haW5QYXRoID0gbGVmdENvbnRleHQ7CgoJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJc2hhZG93S2V5ID0gIiI7CgkJCQkJCQkJbWFpblBhdGggPSAiIjsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJcnRuID0gc2hhZG93TmFtZXNwYWNlICsgKHNoYWRvd0tleSA/ICIuIiArIHNoYWRvd0tleSA6ICIiKTsKCgkJCQkJCS8vb25seSB3aGVuIG1haW4gbW9kZWwgZXhpc3RzICwgYW5kIGhvc3Qgb2YgdGhlIG9iamVjdCBleGlzdHMKCQkJCQkJLy90aGVuIGNyZWF0ZSBzaGFkb3cKCQkJCQkJaWYgKGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5ICYmICFzaGFkb3dSb290W3NoYWRvd0tleV0gJiYKCQkJCQkJICAgIHJ0biAhPSBzaGFkb3dOYW1lc3BhY2UgJiYgIWlzVW5kZWZpbmVkKCBtYWluVmFsdWUgPSByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoKCQkJCQkJCXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSA9IHt9OwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiAhbG9naWNhbFBhdGggPyBydG4gOgoJCQkJCXJ0biA/IHJ0biArICIuIiArIGxvZ2ljYWxQYXRoIDoKCQkJCQkJbG9naWNhbFBhdGg7CgkJCX0sCgkJCXRvTG9naWNhbFBhdGg6IHRvTG9naWNhbFBhdGggPSBmdW5jdGlvbiggcGh5c2ljYWxQYXRoICkgewoKCQkJCXZhciBpbmRleCwgbG9naWNhbFBhdGgsIG1haW5QYXRoLCBtYXRjaDsKCgkJCQlpZiAocGh5c2ljYWxQYXRoID09PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJCQlyZXR1cm4gIioiOwoJCQkJfQoKCQkJCW1hdGNoID0gclNoYWRvd0tleS5leGVjKCBwaHlzaWNhbFBhdGggKTsKCQkJCWlmIChtYXRjaCkgewoJCQkJCS8vIGlmIHBoeXNpY2FsIHBhdGggaXMgbGlrZSBfX2htLmtleS54CgkJCQkJLy8gY29udmVydCB0aGUga2V5IHBhdGggaW50byBtYWluUGF0aAoJCQkJCWluZGV4ID0gUmVnRXhwLnJpZ2h0Q29udGV4dDsKCQkJCQltYWluUGF0aCA9IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBtYXRjaFsxXSApOwoJCQkJCWxvZ2ljYWxQYXRoID0gbWFpblBhdGggKyAiKiIgKyBpbmRleDsKCQkJCQlyZXR1cm4gdG9Mb2dpY2FsUGF0aCggbG9naWNhbFBhdGggKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlyZXR1cm4gcGh5c2ljYWxQYXRoOwoJCQkJfQoKCQkJfSwKCgkJCS8qam9pbiB0aGUgY29udGV4dCBhbmQgc3ViUGF0aCB0b2dldGhlciwgaWYgcGF0aCBpcyBub3QgbmVjZXNzYXJ5IHRoZSBzYW1lIGFzIGxvZ2ljYWwgcGF0aAoJCQkgKmNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggYnkgZGVmYXVsdCBpcyB0cnVlLCBzbyB0aGF0IGlmIHlvdSBzcGVjaWZ5IHN1YlBhdGggYXMgImIiCgkJCSAqIGFuZCAgY29udGV4dCBpcyAiYSIsIGl0IHdpbGwgYmUgbWVyZ2VkIHRvICJhLmIiIC4gSWYgZXhwbGljaXRseSBzcGVjaWZ5CgkJCSAqIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggdG8gZmFsc2UsIHRoZXkgd2lsbCBub3QgYmUgbWVyZ2VkLCBzbyB0aGUgImIiIHdpbGwgYmUKCQkJICogcmV0dXJuZWQgYXMgbWVyZ2UgcGF0aCovCgkJCW1lcmdlUGF0aDogbWVyZ2VQYXRoID0gZnVuY3Rpb24oIGNvbnRleHRQYXRoLCBzdWJQYXRoLCBjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoCgkJCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qdXNlZCBpbnRlcm5hbGx5Ki8gKSB7CgkJCQlpZiAoc3ViUGF0aCA9PSAiXyIpIHsKCgkJCQkJcmV0dXJuICJfIjsKCgkJCQl9IGVsc2UgaWYgKGNvbnRleHRQYXRoID09ICJfIikgewoKCQkJCQlpZiAoc3ViUGF0aCAmJiBzdWJQYXRoLnN0YXJ0c1dpdGgoICIvIiApKSB7CgoJCQkJCQljb250ZXh0UGF0aCA9ICIiOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJcmV0dXJuICJfIjsKCQkJCQl9CgkJCQl9CgoJCQkJY29udGV4dFBhdGggPSB0b1BoeXNpY2FsUGF0aCggY29udGV4dFBhdGggKTsKCgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAoIWlzVW5kZWZpbmVkKCBzdWJQYXRoICkgJiYgc3ViUGF0aCAhPT0gbnVsbCkgewoJCQkJCXN1YlBhdGggPSBzdWJQYXRoICsgIiI7CgkJCQkJaWYgKHN1YlBhdGguc3RhcnRzV2l0aCggIi8iICkpIHsKCQkJCQkJcmV0dXJuIHN1YlBhdGguc3Vic3RyKCAxICk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGlzVW5kZWZpbmVkKCBjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoICkpIHsKCQkJCQljb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoID0gdHJ1ZTsKCQkJCX0KCgkJCQlpZiAoY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCAmJiBzdWJQYXRoICYmIGNvbnRleHRQYXRoICYmICFyQmVnaW5Eb3RPclN0YXIudGVzdCggc3ViUGF0aCApKSB7CgkJCQkJc3ViUGF0aCA9ICIuIiArIHN1YlBhdGg7CgkJCQl9CgoJCQkJaWYgKCFzdWJQYXRoIHx8IHN1YlBhdGggPT0gIi4iKSB7CgoJCQkJCXJldHVybiBjb250ZXh0UGF0aDsKCgkJCQl9IGVsc2UgaWYgKCFyQmVnaW5Eb3RPclN0YXIudGVzdCggc3ViUGF0aCApKSB7CgoJCQkJCXJldHVybiBzdWJQYXRoOwoKCQkJCX0gZWxzZSBpZiAoKG1hdGNoID0gclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dC5leGVjKCBzdWJQYXRoICkpKSB7CgkJCQkJLy9pZiBzdWJQYXRoIGlzIGxpa2UgLi54eXogb3IgLip4eXoKCQkJCQl2YXIgc3RlcHNUb0dvVXAgPSAxICsgKG1hdGNoWzFdID8gbWF0Y2hbMV0ubGVuZ3RoIDogMCksCgkJCQkJCXJlbWFpbmluZyA9IFJlZ0V4cC5yaWdodENvbnRleHQsCgkJCQkJCW1lcmdlZENvbnRleHQgPSBjb250ZXh0UGF0aDsKCgkJCQkJd2hpbGUgKHN0ZXBzVG9Hb1VwKSB7CgkJCQkJCW1lcmdlZENvbnRleHQgPSBjb250ZXh0T2ZQYXRoKCBtZXJnZWRDb250ZXh0ICk7CgkJCQkJCXN0ZXBzVG9Hb1VwLS07CgkJCQkJfQoKCQkJCQkvL3VzZSBydWxlJ3MgY29udGV4dCBhcyBjb250ZXh0CgkJCQkJLy8uLiBvciAuKgoJCQkJCS8vJDIgaXMgZWl0aGVyICIuIiBvciAiKiIKCQkJCQlyZXR1cm4gcmVtYWluaW5nID8KCQkJCQkJKG1lcmdlZENvbnRleHQgPyBtZXJnZWRDb250ZXh0ICsgbWF0Y2hbMl0gKyByZW1haW5pbmcgOiByZW1haW5pbmcpIDoKCQkJCQkJKG1hdGNoWzJdID09PSAiKiIgPyBtZXJnZWRDb250ZXh0ICsgIioiIDogbWVyZ2VkQ29udGV4dCk7CgoJCQkJCS8vaWYgc3ViUGF0aCBpcyBsaWtlIC5hYiBvciAqYWIKCQkJCX0gZWxzZSBpZiAoKG1hdGNoID0gck1haW5QYXRoLmV4ZWMoIHN1YlBhdGggKSkpIHsKCgkJCQkJcmV0dXJuIG1lcmdlUGF0aCggZ2V0TWFpblBhdGgoIGNvbnRleHRQYXRoICksIG1hdGNoWzFdICk7CgoJCQkJfQoJCQkJcmV0dXJuIGNvbnRleHRQYXRoICsgc3ViUGF0aDsKCQkJfSwKCgkJCWlzVW5kZWZpbmVkOiBpc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKCBvYmogKSB7CgkJCQlyZXR1cm4gKG9iaiA9PT0gdW5kZWZpbmVkKTsKCQkJfSwKCQkJaXNQcmltaXRpdmU6IGlzUHJpbWl0aXZlID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCXJldHVybiAob2JqID09PSBudWxsICkgfHwgKHR5cGVvZihvYmopIGluIHByaW1pdGl2ZVR5cGVzKTsKCQkJfSwKCQkJaXNTdHJpbmc6IGlzU3RyaW5nID0gZnVuY3Rpb24oIHZhbCApIHsKCQkJCXJldHVybiB0eXBlb2YgdmFsID09PSAic3RyaW5nIjsKCQkJfSwKCQkJaXNPYmplY3Q6IGlzT2JqZWN0ID0gZnVuY3Rpb24oIHZhbCApIHsKCQkJCXJldHVybiAkLnR5cGUoIHZhbCApID09PSAib2JqZWN0IjsKCQkJfSwKCQkJaXNCb29sZWFuOiBpc0Jvb2xlYW4gPSBmdW5jdGlvbiggb2JqZWN0ICkgewoJCQkJcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJib29sZWFuIjsKCQkJfSwKCQkJdG9UeXBlZFZhbHVlOiB0b1R5cGVkVmFsdWUgPSBmdW5jdGlvbiggc3RyaW5nVmFsdWUgKSB7CgkJCQlpZiAoaXNTdHJpbmcoIHN0cmluZ1ZhbHVlICkpIHsKCQkJCQlzdHJpbmdWYWx1ZSA9ICQudHJpbSggc3RyaW5nVmFsdWUgKTsKCQkJCQl0cnkgewoJCQkJCQlzdHJpbmdWYWx1ZSA9IHN0cmluZ1ZhbHVlID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQkJCXN0cmluZ1ZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCQkJCXN0cmluZ1ZhbHVlID09PSAibnVsbCIgPyBudWxsIDoKCQkJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJ1bmRlZmluZWQiID8gdW5kZWZpbmVkIDoKCQkJCQkJCQkJCWlzTnVtZXJpYyggc3RyaW5nVmFsdWUgKSA/IHBhcnNlRmxvYXQoIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCS8vRGF0ZS5wYXJzZSggc3RyaW5nVmFsdWUgKSA/IG5ldyBEYXRlKCBzdHJpbmdWYWx1ZSApIDoKCQkJCQkJCQkJCQlySlNPTi50ZXN0KCBzdHJpbmdWYWx1ZSApID8gJC5wYXJzZUpTT04oIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCQlzdHJpbmdWYWx1ZTsKCQkJCQl9IGNhdGNoIChlKSB7fQoJCQkJfQoJCQkJcmV0dXJuIHN0cmluZ1ZhbHVlOwoJCQl9LAoJCQlpc1Byb21pc2U6IGlzUHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJCQlyZXR1cm4gISEob2JqZWN0ICYmIG9iamVjdC5wcm9taXNlICYmIG9iamVjdC5kb25lICYmIG9iamVjdC5mYWlsKTsKCQkJfSwKCQkJY2xlYXJPYmo6IGNsZWFyT2JqID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCWlmIChpc1ByaW1pdGl2ZSggb2JqICkpIHsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJCWZvciAodmFyIGtleSBpbiBvYmopIHsKCQkJCQlpZiAoaGFzT3duLmNhbGwoIG9iaiwga2V5ICkpIHsKCQkJCQkJb2JqW2tleV0gPSBjbGVhck9iaiggb2JqW2tleV0gKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gb2JqOwoJCQl9LAoJCQljbG9uZTogY2xvbmUgPSBmdW5jdGlvbiggb3JpZ2luYWwsIGRlZXBDbG9uZSApIHsKCQkJCXJldHVybiBpc1ByaW1pdGl2ZSggb3JpZ2luYWwgKSA/IG9yaWdpbmFsIDoKCQkJCQlpc0FycmF5KCBvcmlnaW5hbCApID8gb3JpZ2luYWwuc2xpY2UoIDAgKSA6CgkJCQkJCWlzRnVuY3Rpb24oIG9yaWdpbmFsICkgPyBvcmlnaW5hbCA6CgkJCQkJCQlleHRlbmQoICEhZGVlcENsb25lLCB7fSwgb3JpZ2luYWwgKTsKCQkJfSwKCgkJCWxvY2FsOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCQlyZXR1cm4gSlNPTi5wYXJzZSggbG9jYWxTdG9yYWdlLmdldEl0ZW0oIGtleSApICk7CgkJCQl9IGVsc2UgewoJCQkJCWlmIChpc1VuZGVmaW5lZCggdmFsdWUgKSkgewoJCQkJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgga2V5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIGtleSwgSlNPTi5zdHJpbmdpZnkoIHZhbHVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl0b1N0cmluZzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJcmV0dXJuICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogIiIgKyB2YWx1ZTsKCQkJfSwKCgoJCQllbmNvZGVIdG1sOiBmdW5jdGlvbiggc3RyICkgewoJCQkJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7CgkJCQlkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBzdHIgKSApOwoJCQkJcmV0dXJuIGRpdi5pbm5lckhUTUw7CgkJCX0KCgkJfSwKCgkJLy90aGlzIGlzIHVzZWQgdG8gcHJvY2VzcyB0aGUgbmV3IG5vZGUgYWRkZWQgdG8gcmVwb3NpdG9yeQoJCW9uQWRkT3JVcGRhdGVOb2RlOiBmdW5jdGlvbiggZm4gKSB7CgkJCWlmIChmbikgewoJCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzLnB1c2goIGZuICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvbkFkZE9yVXBkYXRlSGFuZGxlcnM7CgkJCX0KCQl9LAoKCQlvbkRlbGV0ZU5vZGU6IGZ1bmN0aW9uKCBmbiApIHsKCQkJaWYgKGZuKSB7CgkJCQlvbkRlbGV0ZUhhbmRsZXJzLnB1c2goIGZuICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvbkRlbGV0ZUhhbmRsZXJzOwoJCQl9CgkJfSwKCgkJLy91c2UgdGhpcyBmb3IgY29uZmlndXJlIG9wdGlvbnMKCQlvcHRpb25zOiBkZWZhdWx0T3B0aW9ucwoJfSApOwoKCXZhciBvbkRlbGV0ZUhhbmRsZXJzID0gWwoJCWZ1bmN0aW9uIC8qcmVtb3ZlTW9kZWxMaW5rc0FuZFNoYWRvd3MqLyAoIHBoeXNpY2FsUGF0aCwgcmVtb3ZlZFZhbHVlICkgewoKCQkJdmFyIHdhdGNoZWRQYXRoLAoJCQkJbWFpblBhdGgsCgkJCQlwaHlzaWNhbFBhdGhPZlNoYWRvdywKCQkJCWxvZ2ljYWxTaGFkb3dQYXRoLAoJCQkJbG9naWNhbFBhdGggPSB0b0xvZ2ljYWxQYXRoKCBwaHlzaWNhbFBhdGggKTsKCgkJCS8vcmVtb3ZlIG1vZGVsTGlua3Mgd2hvc2UgcHVibGlzaGVyUGF0aCA9PSBwaHlzaWNhbFBhdGgKCQkJZm9yICh3YXRjaGVkUGF0aCBpbiB3YXRjaFRhYmxlKSB7CgkJCQl1bndhdGNoKCBwaHlzaWNhbFBhdGgsIHdhdGNoZWRQYXRoICk7CgkJCX0KCgkJCS8vcmVtb3ZlIG1vZGVsTGlua3Mgd2hvc2Ugc3Vic2NyaWJlciA9PSBwaHlzaWNhbFBhdGgKCQkJZm9yICh3YXRjaGVkUGF0aCBpbiB3YXRjaFRhYmxlKSB7CgkJCQlpZiAod2F0Y2hlZFBhdGguc3RhcnRzV2l0aCggcGh5c2ljYWxQYXRoICkpIHsKCQkJCQlkZWxldGUgd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJCQl9CgkJCX0KCgkJCS8vZGVsZXRlIHNoYWRvdyBvYmplY3RzLAoJCQkvLyB3aGljaCBhcmUgdW5kZXIgdGhlIGRpcmVjdCBzaGFkb3cgb2YgbWFpbiBwYXRoCgkJCWZvciAobWFpblBhdGggaW4gc2hhZG93Um9vdCkgewoKCQkJCXBoeXNpY2FsUGF0aE9mU2hhZG93ID0gc2hhZG93TmFtZXNwYWNlICsgIi4iICsgbWFpblBhdGg7CgkJCQlsb2dpY2FsU2hhZG93UGF0aCA9IHRvTG9naWNhbFBhdGgoIHBoeXNpY2FsUGF0aE9mU2hhZG93ICk7CgoJCQkJaWYgKGxvZ2ljYWxTaGFkb3dQYXRoID09IGxvZ2ljYWxQYXRoIHx8CgkJCQkgICAgbG9naWNhbFNoYWRvd1BhdGguc3RhcnRzV2l0aCggbG9naWNhbFBhdGggKyAiKiIgKSB8fAoJCQkJICAgIGxvZ2ljYWxTaGFkb3dQYXRoLnN0YXJ0c1dpdGgoIGxvZ2ljYWxQYXRoICsgIi4iICkpIHsKCQkJCQlyb290Tm9kZS5kZWwoIHBoeXNpY2FsUGF0aE9mU2hhZG93ICk7CgkJCQl9CgkJCX0KCQl9CgldOwoKCSQoICJnZXQsc2V0LGRlbCxleHRlbmQiLnNwbGl0KCAiLCIgKSApLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7CgkJaG1bdmFsdWVdID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiByb290Tm9kZVt2YWx1ZV0uYXBwbHkoIHJvb3ROb2RlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCX07Cgl9ICk7CgoJcm9vdE5vZGUgPSBobSgpOwoKCSRmbi5obURhdGEgPSBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgoJCXZhciBkYXRhID0gdGhpcy5kYXRhKCAiaG1EYXRhIiApOwoKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoKCQkJcmV0dXJuIGRhdGE7CgoJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoKCQkJcmV0dXJuIGRhdGEgJiYgZGF0YVtuYW1lXTsKCgkJfSBlbHNlIHsKCQkJLy9hcmd1bWVudHMubGVuZ3RoID09IDIKCQkJaWYgKGlzVW5kZWZpbmVkKCBkYXRhICkpIHsKCQkJCXRoaXMuZGF0YSggImhtRGF0YSIsIGRhdGEgPSB7fSApOwoJCQl9CgkJCWRhdGFbbmFtZV0gPSB2YWx1ZTsKCQl9Cgl9OwoKCS8qCXBhdGhzV2F0Y2hpbmc6IGZ1bmN0aW9uKCkgewoJIHZhciBrZXksIGxpbmtzLCBydG4gPSBbXSwgcGF0aCA9IHRoaXMucGF0aDsKCSBmb3IgKGtleSBpbiBtb2RlbExpbmtzKSB7CgkgbGlua3MgPSBtb2RlbExpbmtzW2tleV07CgkgaWYgKGxpbmtzLmNvbnRhaW5zKCBwYXRoICkpIHsKCSBydG4ucHVzaCgga2V5ICk7CgkgfQoJIH0KCSByZXR1cm4gcnRuOwoJIH0sCgoJICwqLwoKCgovLzxAZGVwZW5kcz5tb2RlbC5qczwvQGRlcGVuZHM+CgoKCgl2YXIgd29ya2Zsb3dTdG9yZSwKCQlyU3BhY2VzID0gL1sgXSsvLAoJCXJFbmRXaXRoU3RhckRvdCA9IC9cKlwuJC8sCgkJckRvdE9yU3RhciA9IC9cLnxcKi9nLAoJLy9yT3JpZ2luYWxFdmVudCA9IC9eKC4rPykoXC5cZCspPyQvLAoJCXN1YnNjcmlwdGlvbk1hbmFnZXIsCgkJdmlld0lkID0gMCwKCQlySW5pdCA9IC9pbml0KFxkKikvLAoJCXdvcmtmbG93LAoJLy90aGUgaGFuZGxlciBzdHJpbmcgc2hvdWxkIGJlIGxpa2UKCS8vICJnZXQgc2V0IGNvbnZlcnQgZmluYWxpemUgaW5pdGlhbGl6ZSIKCQlhY3Rpdml0eVR5cGVzID0gImdldCxzZXQsY29udmVydCxmaW5hbGl6ZSxpbml0aWFsaXplIi5zcGxpdCggIiwiICk7CgoJZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIHJldHVyblRydWUoKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJZnVuY3Rpb24gRXZlbnQoIHB1Ymxpc2hlciwgb3JpZ2luYWxQdWJsaXNoZXIsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKSB7CgkJdGhpcy5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICk7CgkJdGhpcy5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBvcmlnaW5hbFB1Ymxpc2hlciApOwoJCXRoaXMudHlwZSA9IGV2ZW50VHlwZTsKCQl0aGlzLm9yaWdpbmFsVHlwZSA9IGV2ZW50VHlwZTsKCQl0aGlzLnByb3Bvc2VkID0gcHJvcG9zZWQ7CgkJdGhpcy5yZW1vdmVkID0gcmVtb3ZlZDsKCX0KCglFdmVudC5wcm90b3R5cGUgPSB7CgkJY29uc3RydWN0b3I6IEV2ZW50LAoKCQkvKglpc09yaWdpbmFsOiBmdW5jdGlvbigpIHsKCQkgcmV0dXJuIHRoaXMucHVibGlzaGVyLnBhdGggPT0gdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOwoJCSB9LAoKCQkgaXNCdWJibGVVcDogZnVuY3Rpb24oKSB7CgkJIHJldHVybiAodGhpcy5wdWJsaXNoZXIucGF0aCAhPSB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgpICYmCgkJICh0aGlzLnB1Ymxpc2hlci5wYXRoLnN0YXJ0c1dpdGgoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGF0aCApKTsKCQkgfSwqLwoJCWlzRGVwZW5kZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICghdGhpcy5wdWJsaXNoZXIucGF0aC5zdGFydHNXaXRoKCB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggKSk7CgkJfSwKCgkJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJfSwKCgkJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCQl0aGlzLmlzQ2FzY2FkZVN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCX0sCgoJCXN0b3BDYXNjYWRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc0Nhc2NhZGVTdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQllcnJvcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaGFzRXJyb3IgPSByZXR1cm5UcnVlOwoJCX0sCgoJCWFib3J0OiBhYm9ydCwKCQlpc0Nhc2NhZGVTdG9wcGVkOiByZXR1cm5GYWxzZSwKCQlpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCgkJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJCWlzQWJvcnRlZDogcmV0dXJuRmFsc2UsCgkJaGFzRXJyb3I6IHJldHVybkZhbHNlLAoJCWxldmVsOiAwCgl9OwoKCS8vIHJhaXNlIG1vZGVsIGV2ZW50LAoJdHJpZ2dlciA9IGZ1bmN0aW9uKCBwYXRoLCBvcmlnaW5hbFBhdGgsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKSB7CgoJCXZhciBlID0gbmV3IEV2ZW50KCBwYXRoLCBvcmlnaW5hbFBhdGgsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKTsKCgkJLy9ldmVudCBjYW4gYmUgY2hhbmdlZCBpbnNpZGUgdGhlIGZ1bmN0aW9uCgkJY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKTsKCgkJaWYgKCFlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgJiYgZS5wdWJsaXNoZXIucGF0aCkgewoKCQkJaWYgKGUuaXNEZXBlbmRlbnQoKSkgewoJCQkJLy9pZiBpcyBkZXBlbmRlbnQgZXZlbnQsIHRoZSBvcmlnaW5hbCBldmVudCBoYXMgYmVlbgoJCQkJLy8gYnViYmxlZCB1cCBpbiBpdHMgZGlyZWN0IGhpZXJhcmNoeQoJCQkJLy93ZSBuZWVkIHRvIGNoYW5nZSB0aGUgaGllcmFyY2h5IGJ5IHNldHRpbmcgdGhlIHRhcmdldAoJCQkJZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoID0gZS5wdWJsaXNoZXIucGF0aDsKCQkJfQoKCQkJLy9jb250aW51ZSB0byB0aGUgc2FtZSBpbnN0YW5jZSBvZiBldmVudCBvYmplY3QKCQkJZG8gewoKCQkJCWUucHVibGlzaGVyLnBhdGggPSBlLnB1Ymxpc2hlci5wYXRoQ29udGV4dCgpOwoJCQkJZS5sZXZlbCsrOwoJCQkJZS50eXBlID0gZS5vcmlnaW5hbFR5cGUgKyAiLiIgKyBlLmxldmVsOwoJCQkJY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKTsKCgkJCX0gd2hpbGUgKCFlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgJiYgZS5wdWJsaXNoZXIucGF0aCk7CgkJfQoKCQkvL3Jlc3RvcmUgcHJldmlvdXMgdmFsdWVzCgkJZS50eXBlID0gZXZlbnRUeXBlOwoJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCA9IG9yaWdpbmFsUGF0aDsKCQllLnB1Ymxpc2hlci5wYXRoID0gcGF0aDsKCQlyZXR1cm4gZTsKCX07CgoKCXN1YnNjcmlwdGlvbk1hbmFnZXIgPSAoZnVuY3Rpb24oKSB7CgoJCXZhciBzdWJzY3JpcHRpb25TdG9yZSA9IFsgXTsKCgkJLy90YXJnZXQgaXMgZWl0aGVyIHB1Ymxpc2hlciBvciBzdWJzY3JpYmVyCgkJZnVuY3Rpb24gY2FuUmVtb3ZlU3Vic2NyaXB0aW9uRGF0YSggdGFyZ2V0LCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJCWlmICh0YXJnZXQgPT09IHB1Ymxpc2hlciB8fCB0YXJnZXQgPT09IHN1YnNjcmliZXIpIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9IGVsc2UgewoJCQkJLy9pZiB0YXJnZXQgaXMgbW9kZWwgcGF0aAoJCQkJaWYgKGlzU3RyaW5nKCB0YXJnZXQgKSkgewoJCQkJCXJldHVybiAoIGlzU3RyaW5nKCBwdWJsaXNoZXIgKSAmJiBwdWJsaXNoZXIuc3RhcnRzV2l0aCggdGFyZ2V0ICsgIi4iICkpIHx8CgkJCQkJICAgICAgICggaXNTdHJpbmcoIHN1YnNjcmliZXIgKSAmJiBzdWJzY3JpYmVyLnN0YXJ0c1dpdGgoIHRhcmdldCArICIuIiApKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gZ2V0U3Vic2NyaXB0aW9uc0J5KCB0YXJnZXQsIG1hdGNoICkgewoJCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgkJCQl0YXJnZXQgPSB0b1BoeXNpY2FsUGF0aCggdGFyZ2V0ICk7CgkJCX0KCgkJCXZhciBydG4gPSBbXTsKCQkJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGkgPCBzdWJzY3JpcHRpb25TdG9yZS5sZW5ndGg7IGkrKykgewoJCQkJaXRlbSA9IHN1YnNjcmlwdGlvblN0b3JlW2ldOwoJCQkJaWYgKG1hdGNoKCBpdGVtLCB0YXJnZXQgKSkgewoJCQkJCXJ0bi5wdXNoKCBpdGVtICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJCXJldHVybiB7CgoJCQkvL3N1YnNjcmlwdGlvbnMgd2hvc2UgcHVibGlzaGVyIGlzIHRoZSBwYXJhbWV0ZXIKCQkJLy9wdWJsaXNoZXIgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5UHVibGlzaGVyOiBmdW5jdGlvbiggcHVibGlzaGVyICkgewoJCQkJcmV0dXJuIGdldFN1YnNjcmlwdGlvbnNCeSggcHVibGlzaGVyLCBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnB1Ymxpc2hlciA9PSB0YXJnZXQ7CgkJCQl9ICk7CgkJCX0sCgoJCQkvL3N1YnNjcmlwdGlvbnMgd2hvc2Ugc3Vic2NyaWJlciBpcyB0aGUgcGFyYW1ldGVyCgkJCS8vc3Vic2NyaWJlciBjYW4gYmUgYSBtb2RlbCBwYXRoIG9yIGRvbSBlbGVtZW50LCBvciBvYmplY3QKCQkJZ2V0QnlTdWJzY3JpYmVyOiBmdW5jdGlvbiggc3Vic2NyaWJlciApIHsKCQkJCXJldHVybiBnZXRTdWJzY3JpcHRpb25zQnkoIHN1YnNjcmliZXIsIGZ1bmN0aW9uKCBpdGVtLCB0YXJnZXQgKSB7CgkJCQkJcmV0dXJuIGl0ZW0uc3Vic2NyaWJlciA9PSB0YXJnZXQ7CgkJCQl9ICk7CgkJCX0sCgoJCQkvL29iamVjdCBjYW4gYmUgYSBtb2RlbCBwYXRoIG9yIGRvbSBlbGVtZW50LCBvciBvYmplY3QKCQkJZ2V0Qnk6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIgKSB7CgkJCQlyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIGZ1bmN0aW9uIG1hdGNoKCBpdGVtLCB0YXJnZXQgKSB7CgkJCQkJcmV0dXJuIGl0ZW0uc3Vic2NyaWJlciA9PSB0YXJnZXQgfHwgaXRlbS5wdWJsaXNoZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0QWxsOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzdWJzY3JpcHRpb25TdG9yZTsKCQkJfSwKCgkJCWFkZDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApIHsKCQkJCWlmIChpc1N0cmluZyggcHVibGlzaGVyICkpIHsKCgkJCQkJdmFyIGV2ZW50cyA9IGV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKTsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgc3BlY2lhbCA9IHRoaXMuc3BlY2lhbFtldmVudHNbaV1dOwoJCQkJCQlzcGVjaWFsICYmIHNwZWNpYWwuc2V0dXAgJiYgc3BlY2lhbC5zZXR1cCggc3Vic2NyaWJlciwgcHVibGlzaGVyICk7CgkJCQkJfQoJCQkJfQoKCQkJCXN1YnNjcmlwdGlvblN0b3JlLnB1c2goIHsKCQkJCQlwdWJsaXNoZXI6IHB1Ymxpc2hlciwKCQkJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyLAoJCQkJCWV2ZW50VHlwZXM6IGV2ZW50VHlwZXMsCgkJCQkJaGFuZGxlcjogaGFuZGxlcgoJCQkJfSApOwoJCQl9LAoKCQkJcmVtb3ZlQnk6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIgKSB7CgoJCQkJdmFyIGksCgkJCQkJaiwKCQkJCQlzcGVjaWFsLAoJCQkJCXN1YnNjcmlwdGlvbiwKCQkJCQloYW5kbGVyLAoJCQkJCXN1YnNjcmlwdGlvbnNSZW1vdmVkID0gW107CgoJCQkJZm9yIChpID0gc3Vic2NyaXB0aW9uU3RvcmUubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQlzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25TdG9yZVtpXTsKCQkJCQloYW5kbGVyID0gc3Vic2NyaXB0aW9uLmhhbmRsZXI7CgoJCQkJCWlmIChjYW5SZW1vdmVTdWJzY3JpcHRpb25EYXRhKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIsIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICkpIHsKCgkJCQkJCS8vaWYgcHVibGlzaGVyIGlzIGFuIHZpZXcgb2JqZWN0LCBuZWVkIHRvIHVuYmluZCBvciB1bmRlbGVnYXRlCgkJCQkJCS8vdGhlIGpRdWVyeSBldmVudCBoYW5kbGVyCgkJCQkJCWlmICghaXNTdHJpbmcoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSkgewoJCQkJCQkJaWYgKGhhbmRsZXIuZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCQkJCSQoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKS51bmRlbGVnYXRlKCBoYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IsIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCSQoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKS51bmJpbmQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJc3Vic2NyaXB0aW9uc1JlbW92ZWQucHVzaCggc3Vic2NyaXB0aW9uU3RvcmUuc3BsaWNlKCBpLCAxIClbMF0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJZm9yIChpID0gc3Vic2NyaXB0aW9uc1JlbW92ZWQubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQlzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zUmVtb3ZlZFtpXTsKCQkJCQlpZiAoaXNTdHJpbmcoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSkgewoJCQkJCQl2YXIgZXZlbnRzID0gc3Vic2NyaXB0aW9uLmV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKTsKCQkJCQkJZm9yIChqID0gMDsgaiA8IGV2ZW50cy5sZW5ndGg7IGorKykgewoJCQkJCQkJc3BlY2lhbCA9IHRoaXMuc3BlY2lhbFtldmVudHNbal1dOwoJCQkJCQkJc3BlY2lhbCAmJiBzcGVjaWFsLnRlYXJkb3duICYmIHNwZWNpYWwudGVhcmRvd24oIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyLCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlzcGVjaWFsOiB7CgkJCQkvKnZhbGlkaXR5Q2hhbmdlZDogewoJCQkJIHNldHVwOiBmdW5jdGlvbiAocHVibGlzaGVyLCBzdWJzY3JpYmVyKSB7fSwKCQkJCSB0ZWFyZG93bjogZnVuY3Rpb24gKHB1Ymxpc2hlciwgc3Vic2NyaWJlcikge30KCQkJCSB9CgkJCQkgKi8KCQkJfQoKCQl9OwoJfSkoKTsKCglmdW5jdGlvbiBnZXRNZW1iZXIoIGUgKSB7CgoJCXZhciBoYW5kbGVyID0gZS5oYW5kbGVyLAoJCQlwcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLmdldE5hbWUsCgkJLy9nZXRTdWJQcm9wZXJ0eSBpcyB1c2VkIGZvciBwcm9wZXJ0aWVzIGxpa2UgY3NzLCBhdHRyLCBwcm9wCgkJCXN1YlByb3BlcnR5TmFtZSA9IGhhbmRsZXIuZ2V0UGFyYXMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlyZXR1cm4gc3ViUHJvcGVydHlOYW1lID8gcHVibGlzaGVyW3Byb3BlcnR5TmFtZV0oIHN1YlByb3BlcnR5TmFtZSApIDoKCQkJaXNGdW5jdGlvbiggcHVibGlzaGVyW3Byb3BlcnR5TmFtZV0gKSA/IHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdKCkgOgoJCQkJcHVibGlzaGVyW3Byb3BlcnR5TmFtZV07Cgl9CgoJZnVuY3Rpb24gc2V0TWVtYmVyKCB2YWx1ZSwgZSApIHsKCQl2YXIgaGFuZGxlciA9IGUuaGFuZGxlciwKCQkJcHJvcGVydHlOYW1lID0gaGFuZGxlci5zZXROYW1lLAoJCS8vc2V0U3ViUHJvcGVydHkgaXMgdXNlZCBmb3IgcHJvcGVydGllcyBsaWtlIGNzcywgYXR0ciwgcHJvcAoJCQlzdWJQcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLnNldFBhcmFzLAoJCQlzdWJzY3JpYmVyID0gdGhpczsKCgkJc3ViUHJvcGVydHlOYW1lID8gc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdKCBzdWJQcm9wZXJ0eU5hbWUsIHZhbHVlICkgOgoJCQlpc0Z1bmN0aW9uKCBzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0gKSA/IHN1YnNjcmliZXJbcHJvcGVydHlOYW1lXSggdmFsdWUgKSA6CgkJCQlzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKCX0KCglleHRlbmQoIGhtLCB7CgoJCS8vRXZlbnQ6IEV2ZW50LAoKCQl0cmlnZ2VyOiB0cmlnZ2VyLAoKCQlzdWJzY3JpcHRpb246IHN1YnNjcmlwdGlvbk1hbmFnZXIsCgoJCS8vaGFuZGxlciBjYW4gYmUgYSBmdW5jdGlvbiAoZSkge30KCQkvLyBhIHN0cmluZyBsaWtlICJnZXQgc2V0IGNvbnZlcnQgaW50IgoJCS8vb3IgIipnZXQgKnNldCAqY29udmVydCAqaW50IgoJCS8vb3IgaXQgY2FuIGJlICIqY29tbW9uSGFuZGxlciIKCQkvL29yIGl0IGNhbiBiZSB7IGdldDp4eCwgc2V0Onh4LCBjb252ZXJ0Onh4LCBpbml0aWFsaXplOiB4eH0KCQkvL2l0IGNhbiBiZSBhIGphdmFzY3JpcHQgb2JqZWN0LCBkb20gZWxlbWVudCwgYnV0IGl0IGNhbiBub3QgYmUgYSBqUXVlcnkgb2JqZWN0CgkJLy9zdWJzY3JpYmVyIGNhbiBiZSBudWxsLCAiXyIsICJudWxsIiwgdW5kZWZpbmVkIHRvIHJlcHJlc2VudCBhIGNhc2Ugd2hlcmUgdGhlcmUgaXMgbm90IHN1YnNjcmliZXIKCQkvL2lmIHN1YnNjcmliZXIgaXMgIiIsIGl0IG1lYW5zIHRoZSB0aGUgcm9vdCBtb2RlbCwgdGhlIHJlcG9zaXRvcnkgb2JqZWN0CgkJc3ViOiBmdW5jdGlvbiggc3Vic2NyaWJlciwgcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoKCQkJaWYgKHN1YnNjcmliZXIgaW5zdGFuY2VvZiBobSkgewoJCQkJc3Vic2NyaWJlciA9IHN1YnNjcmliZXIucGF0aDsKCQkJfQoKCQkJaWYgKHB1Ymxpc2hlciBpbnN0YW5jZW9mIGhtKSB7CgkJCQlwdWJsaXNoZXIgPSBwdWJsaXNoZXIucGF0aDsKCQkJfQoKCQkJaWYgKGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgJiYgc3Vic2NyaWJlci5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJc3Vic2NyaWJlciA9ICQoIHN1YnNjcmliZXIuc3Vic3RyKCAxICkgKTsKCQkJfQoKCQkJaWYgKHN1YnNjcmliZXIgJiYgc3Vic2NyaWJlci5qcXVlcnkpIHsKCQkJCS8vc3Vic2NyaWJlciBpcyBsaWtlICQoKQoJCQkJLy9uZWVkIHRvIGNvbnZlcnQgalF1ZXJ5IG9iamVjdCBpbnRvIGRvbSBvciByYXcgZWxlbWVudAoJCQkJaWYgKCFzdWJzY3JpYmVyLmxlbmd0aCAmJiAhc3Vic2NyaWJlci5zZWxlY3RvcikgewoJCQkJCXN1YnNjcmliZXIgPSBudWxsOwoJCQkJfSBlbHNlIHsKCQkJCQlzdWJzY3JpYmVyLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbWVudCApIHsKCQkJCQkJLy91bndyYXAgalF1ZXJ5IGVsZW1lbnQKCQkJCQkJaG0uc3ViKCBlbGVtZW50LCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKTsKCQkJCQl9ICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQlpZiAoaXNTdHJpbmcoIHB1Ymxpc2hlciApICYmIHB1Ymxpc2hlci5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJcHVibGlzaGVyID0gJCggcHVibGlzaGVyLnN1YnN0ciggMSApICk7CgkJCX0KCgkJCWlmIChwdWJsaXNoZXIgJiYgcHVibGlzaGVyLmpxdWVyeSkgewoJCQkJcHVibGlzaGVyLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbWVudCApIHsKCQkJCQlobS5zdWIoIHN1YnNjcmliZXIsIGVsZW1lbnQsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKTsKCQkJCX0gKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCFwdWJsaXNoZXIgJiYgcHVibGlzaGVyICE9PSAiIikgewoJCQkJdGhyb3cgInB1Ymxpc2hlciBjYW4gbm90IGJlIG51bGwiOwoJCQl9CgoJCQlpZiAoIWV2ZW50VHlwZXMpIHsKCQkJCXRocm93ICJldmVudFR5cGVzIGNhbiBub3QgYmUgbnVsbCI7CgkJCX0KCgkJCS8vYWxsb3cgc3Vic2NyaWJlciAiIiwgYmVjYXVzZSB0aGlzIGlzIHRoZSBwYXRoIG9mIHJvb3QgbW9kZWwKCQkJaWYgKHN1YnNjcmliZXIgPT09ICJfIiB8fCBzdWJzY3JpYmVyID09ICJudWxsIiB8fCBzdWJzY3JpYmVyID09PSBudWxsKSB7CgkJCQlzdWJzY3JpYmVyID0gdW5kZWZpbmVkOwoJCQl9CgoJCQlpZiAod29ya2Zsb3dPcHRpb25zID09PSAiXyIpIHsKCQkJCXdvcmtmbG93T3B0aW9ucyA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJdmFyIGlzUHVibGlzaGVyTW9kZWwgPSBpc1N0cmluZyggcHVibGlzaGVyICksCgkJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCQl2aWV3SWRNYW5hZ2VyLm1hcmsoIHB1Ymxpc2hlciApOwoJCQl2aWV3SWRNYW5hZ2VyLm1hcmsoIHN1YnNjcmliZXIgKTsKCgkJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgYSBtb2RlbAoJCQkJcHVibGlzaGVyID0gdG9QaHlzaWNhbFBhdGgoIHB1Ymxpc2hlciApOwoJCQl9CgoJCQlpZiAoaXNTdWJzY3JpYmVyTW9kZWwpIHsKCQkJCS8vc3Vic2NyaWJlciBpcyBhIG1vZGVsCgkJCQlzdWJzY3JpYmVyID0gdG9QaHlzaWNhbFBhdGgoIHN1YnNjcmliZXIgKTsKCgkJCX0KCgkJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgoJCQkJc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyLCBldmVudFR5cGVzLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zICk7CgoJCQl9IGVsc2UgewoKCQkJCXN1YnNjcmliZVZpZXdFdmVudCggcHVibGlzaGVyLCBldmVudFR5cGVzLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCX0KCQl9LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCAvKiBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKi8gKSB7CgkJCXJldHVybiB0aGlzLnN1Yi5hcHBseSggdGhpcywgW251bGxdLmNvbmNhdCggc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX0sCgoJCS8vYSB3b3JrZmxvd1Byb3RvdHlwZSBjYW4gYmUgYSBzdHJpbmcgbGlrZSAiZ2V0IHNldCBjb252ZXJ0IGluaXRpYWxpemUgZmluYWxpemUiCgkJLy8gb3IgaXQgY2FuIGJlIGFuIG9iamVjdAoJCS8qCgkJIHsKCQkgZ2V0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBzZXQ6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGNvbnZlcnQ6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGluaXRpYWxpemU6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGZpbmFsaXplOiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9CgkJIH0KCQkgKi8KCQl3b3JrZmxvdzogd29ya2Zsb3cgPSBmdW5jdGlvbiggbmFtZSwgd29ya2Zsb3dQcm90b3R5cGUgKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQl3b3JrZmxvd1N0b3JlW2tleV0gPSBidWlsZFdvcmtmbG93KCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBuYW1lICkpIHsKCQkJCXJldHVybiB3b3JrZmxvd1N0b3JlOwoJCQl9CgoJCQlpZiAoaXNVbmRlZmluZWQoIHdvcmtmbG93UHJvdG90eXBlICkpIHsKCQkJCXJldHVybiB3b3JrZmxvd1N0b3JlW25hbWVdOwoJCQl9CgoJCQl3b3JrZmxvd1N0b3JlW25hbWVdID0gYnVpbGRXb3JrZmxvdyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCQkJcmV0dXJuIHdvcmtmbG93U3RvcmVbbmFtZV07CgoJCX0sCgkJLy9jb21tb24gZ2V0dGVyIGFuZCBzZXR0ZXIgYXJlIHNwZWNpYWwgYWN0aXZpdHkgaW4gdGhleSB3YXkgdGhleSBhcmUgdXNlZAoJCS8vb3RoZXIgYWN0aXZpdGllcyB1c2UgdGhlIGtleSBkaXJlY3RseSB0byByZWZlcmVuY2UgdGhlIGFjdGl2aXRpZXMKCQkvLyBidXQgZ2V0dGVycyBhbmQgc2V0dGVycyBuZWVkIHRvIHVzZSAiKmtleSIgdG8gcmVmZXJlbmNlIGdldHRlcnMgYW5kIHNldHRlcnMKCQkvLyBpZiB5b3VyIGdldHRlci9zZXR0ZXIga2V5IGRvZXMgbm90IGJlZ2luIHdpdGggIioiLCB0aGVuIGl0IHdpbGwgdXNlIHRoZSBkZWZhdWx0R2V0CgkJLy9vciBkZWZhdWx0U2V0LCBhbmQgdGhleSBrZXkgd2lsbCBiZWNvbWUgdGhlIGdldFByb3BlcnR5LCBhbmQgb3B0aW9uYWxseSwKCQkvLyB1c2Ugb3B0aW9ucyB0byBwYXNzIHRoZSBnZXRQcm9wIHZhbHVlLCB0aGUgZGVmYXVsdEdldC9kZWZhdWx0U2V0CgkJLy8gYXJlIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5IGxpa2Ugb3RoZXIgY29tbW9uIGdldHRlcnMgb3Igc2V0dGVycwoJCWFjdGl2aXR5OiB7CgoJCQkvL2luaXRpYWxpemUoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgd29ya2Zsb3dPcHRpb25zICk7CgkJCS8vaW5zaWRlIGluaXRpYWxpemUgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgd2luZG93CgkJCWluaXRpYWxpemU6IHt9LAoKCQkJLy92YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJCS8vaW5zaWRlIHRoZSBnZXR0ZXIgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQkvL2dldChlKQoJCQlnZXQ6IHsKCQkJCWdldE1lbWJlcjogZ2V0TWVtYmVyLAoKCQkJCS8vdGhlIG9yaWdpbmFsIGdldCBpcyAiZ2V0IiBjdXJyZW50CgkJCQkvL2JlY2F1c2Ugb2YgZXZlbnQgYnViYmxpbmcsIHRoZSBkZWZhdWx0IGdldCBtZXRob2QgZm9yIG1vZGVsCgkJCQkvL3dpbGwgbm90IHJldHVybiB0aGUgdmFsdWUgeW91IHdhbnQsIHNvIG5lZWQgdG8gZ2V0T3JpZ2luYWwKCQkJCWdldE9yaWdpbmFsOiBmdW5jdGlvbiggZSApIHsKCQkJCQlyZXR1cm4gZS5vcmlnaW5hbFB1Ymxpc2hlci5nZXQoKTsKCQkJCX0sCgoJCQkJLy9pZiB3ZSB3YW50IHRvIGNhbGwgYSBtZW1iZXIgImZvbyIgb2YgcHVibGlzaGVyIG1vZGVsCgkJCQkvL2J1dCB3ZSBkb24ndCB3YW50IHRvIGRvIGFueXRoaW5nIHRvIHRoZSBzdWJzY3JpYmVyLCB3ZSBtYXkgd2FudCB0byB1c2UgZXhwcmVzc2lvbgoJCQkJLy8iKmZha2VHZXQgZm9vIgoKCQkJCS8vJGNsaWNrOml0ZW1zfCplZGl0U2hhZG93SXRlbQoJCQkJLy8kY2xpY2s6aXRlbXMqcXVlcnlSZXN1bHR8KmVkaXRTaGFkb3dJdGVtCgkJCQkvL3dvcmtmbG93KGhhbmRsZXIpIC0tPm5ld1NoYWRvd0l0ZW06ICIqZmFrZUdldCBuZXdTaGFkb3dJdGVtIiwKCQkJCWZha2VHZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBkdW1teTsKCQkJCX0KCQkJfSwKCgkJCS8vaGFuZGxlci5zZXQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJLy9pbnNpZGUgc2V0dGVyIGZ1bmN0aW9uICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQkvL3NldCh2YWx1ZSwgZSkKCQkJc2V0OiB7CgkJCQlzZXRNZW1iZXI6IHNldE1lbWJlciwKCgkJCQkvL2JlY2F1c2UgaG0uanMgd2FudCB0byBzdXBwb3J0IHNpbXBsaWZpZWQgYWN0aXZpdHkgZXhwcmVzc2lvbgoJCQkJLy9ydWxlIDEKCQkJCS8vICJ2YWwiLCB3aGVuIHB1Ymxpc2hlciBpcyB2aWV3LCBzdWJzY3JpYmVyIGlzIG1vZGVsLCB3aGljaCBtZWFucyAidmFsIiB2aWV3LAoJCQkJLy8ic2V0IiBtb2RlbAoJCQkJLy9ydWxlIDIKCQkJCS8vb3IgImh0bWwiLCB3aGVuIHB1Ymxpc2hlciBpcyBtb2RlbCwgc3Vic2NyaWJlciBpcyB2aWV3LCB3aGljaCBtZWFucyAiZ2V0IiBtb2RlbAoJCQkJLy8iaHRtbCIgdmlldy4KCgkJCQkvL3NvIGlmIHB1Ymxpc2hlciBpcyBtb2RlbCwgc3Vic2NyaWJlciBpcyB2aWV3LiBXZSBqdXN0IHdhbnQgdG8gY2FsbCBhIG1ldGhvZCAiZ2V0IgoJCQkJLy9vbiBtb2RlbCB3aGljaCBtb2RpZnkgbW9kZWwsIGJ1dCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgYW55IG1ldGhvZCBvbiB2aWV3LgoJCQkJLy93ZSBhcmUgaW4gZGlsZW1tYSBiZWNhdXNlIG9mIHJ1bGUgMiwgd2UgZG9uJ3QgaGF2ZSBhIGRlZmF1bHQgbWV0aG9kIGZvciBhIHZpZXcuCgkJCQkvL2EgY2FzZSBpbiB1c2UgaXMgdGhhdAoJCQkJLy9zaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkJCWZha2VTZXQ6ICQubm9vcAoKCQkJfSwKCgkJCS8vaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCS8vaW5zaWRlIGNvbnZlcnRlciBmdW5jdGlvbiAndGhpcycgcmVmZXIgdG8gc3Vic2NyaWJlcgoJCQljb252ZXJ0OiB7CgoJCQkJdG9TdHJpbmc6IHV0aWwudG9TdHJpbmcsCgoJCQkJdG9UeXBlZFZhbHVlOiB1dGlsLnRvVHlwZWRWYWx1ZSwKCgkJCQl0b051bWJlcjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJldHVybiArdmFsdWU7CgkJCQl9LAoKCQkJCXRvRGF0ZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJldHVybiBuZXcgRGF0ZSggdmFsdWUgKTsKCQkJCX0KCQkJfSwKCgkJCS8vaGFuZGxlci5maW5hbGl6ZS5jYWxsKCBzdWJzY3JpYmVyLCB2YWx1ZSwgZSApOwoJCQkvL2luc2lkZSB0aGUgYWZ0ZXJTZXQgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQlmaW5hbGl6ZTogewoJCQkJLy8JCQkJc2F2ZUxvY2FsOiBmdW5jdGlvbiggdmFsdWUsIGUgKSB7CgkJCQkvLwkJCQkJdXRpbC5sb2NhbCggZS5wdWJsaXNoZXIucGF0aCwgdmFsdWUgKTsKCQkJCS8vCQkJCX0KCQkJfQoJCX0KCX0gKTsKCgl3b3JrZmxvd1N0b3JlID0gewoKCQljaGFuZ2U6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCXJvb3ROb2RlLmNoYW5nZSggZS5oYW5kbGVyLm9wdGlvbnMgKTsKCQkJfQoJCX0sCgkJc2F2ZUxvY2FsOiB7CgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgcGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlobSggcGF0aCApLnNhdmVMb2NhbCgpOwoJCQkJfSwgMSApOwoJCQl9CgkJfQoJfTsKCgl2YXIgdmlld0lkTWFuYWdlciA9IHsKCgkJZ2V0SWQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIgKTsKCQl9LAoKCQl1bk1hcms6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiwgdW5kZWZpbmVkICk7CgkJfSwKCgkJbWFyazogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmIChpc09iamVjdCggZWxlbSApICYmICEkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiApKSB7CgkJCQkkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiwgKyt2aWV3SWQgKTsKCQkJfQoJCX0KCX07CgoJLy8gLS0tLS0tLS0gcHJpdmF0ZSAtLS0tLS0tLS0tLS0tIC8vCgkvL3RoZSByZWFzb24gdGhhdCB3ZSB3YW50IHRvIGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMgaXMgdGhhdAoJLy93aGVuIHVuYmluZCBvciB1bmRlbGVnYXRlIHRoZSB2aWV3RXZlbnRUeXBlcywgd2Ugd2FudCB0byB0aGUgdmlld0V2ZW50VHlwZXMKCS8vYXMgdW5pcXVlIGFzIHBvc3NpYmxlLCBjaGVjayB0aGUgdW5zdWJzY3JpYmUgbWV0aG9kCgkvLwoJLy9pbnB1dDogZ2V0VW5pcXVlVmlld0V2ZW50VHlwZXMoImNsaWNrIGRibENsaWNrIiwgdmlld1dpdGhWaWV3SWQzLCAiY3VzdG9tZXIiKQoJLy9vdXRwdXQ6ICJjbGljay5fX2htLjMuY3VzdG9tZXIgZGJsQ2xpY2suX19obS4zLmN1c3RvbWVyIgoJLy9pbnB1dDogZ2V0VW5pcXVlVmlld0V2ZW50VHlwZXMoImNsaWNrIGRibENsaWNrIiwgdmlld1dpdGhWaWV3SWQzLCB2aWV3V2l0aFZpZXdJZDQpCgkvL291dHB1dDogImNsaWNrLl9faG0uMy40IGRibENsaWNrLl9faG0uMy40IgoJLy9pdCB0cnkgdG8gYXBwZW5kIGFuIGV2ZW50IG5hbWUgd2l0aCBhbmQgIi5fX2htLnZpZXdJZC5zdWJzY3JpYmVySWQiCglmdW5jdGlvbiBidWlsZFVuaXF1ZVZpZXdFdmVudFR5cGVzKCBvcmlnaW5hbEV2ZW50VHlwZXMsIHB1Ymxpc2hlclZpZXcsIHN1YnNjcmliZXIgKSB7CgoJCXZhciBwdWJsaXNoZXJWaWV3SWQgPSB2aWV3SWRNYW5hZ2VyLmdldElkKCBwdWJsaXNoZXJWaWV3ICk7CgoJCS8qCWlmIG9yaWdpbmFsIHZpZXdFdmVudHMgaXMgImNsaWNrIGRibENsaWNrIiwKCQkgYW5kIGl0IGJpbmQgdG8gcGF0aCAiZmlyc3ROYW1lIiwgaXQgd2lsbCBjb252ZXJ0IHRvCgkJIGNsaWNrLl9faG0uZmlyc3ROYW1lIGRibENsaWNrLl9faG0uZmlyc3ROYW1lLCB0aGUgcmVhc29uIGlzIHRoYXQKCQkgd2hlbiBwYXRoIGlzIGRlbGV0ZWQsIHRoZSBtZXRob2QgdW5iaW5kKG9iamVjdCkgbmVlZCB0byB1bmJpbmQKCQkgZXZlbnQgYnkgYSBuYW1lc3BhY2UsIGlmIGZpcnN0TmFtZSBpcyBkZWxldGVkLCB3ZSBjYW4gdW5iaW5kICIuX19obS5maXJzdE5hbWUiKi8KCQlyZXR1cm4gJC5tYXAoCgkJCW9yaWdpbmFsRXZlbnRUeXBlcy5zcGxpdCggclNwYWNlcyApLAoJCQlmdW5jdGlvbiggb3JpZ2luYWxFdmVudE5hbWUgKSB7CgkJCQlyZXR1cm4gaXNTdHJpbmcoIHN1YnNjcmliZXIgKSA/CgkJCQkJb3JpZ2luYWxFdmVudE5hbWUgKyAiLiIgKyBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBwdWJsaXNoZXJWaWV3SWQgKyAiLiIgKyBzdWJzY3JpYmVyIDoKCQkJCQlvcmlnaW5hbEV2ZW50TmFtZSArICIuIiArIHNoYWRvd05hbWVzcGFjZSArICIuIiArIHB1Ymxpc2hlclZpZXdJZCArICIuIiArIHZpZXdJZE1hbmFnZXIuZ2V0SWQoIHN1YnNjcmliZXIgKTsKCQkJfQoJCSkuam9pbiggIiAiICk7Cgl9CgoJLy9pZiBvYmplY3QgaXMgZG9tIGVsZW1lbnQgb3IgalF1ZXJ5IHNlbGVjdG9yIHRoZW4gd3JhcCBpbnRvIGpRdWVyeQoJLy9pZiBvYmplY3QgaXMgbW9kZWwgcGF0aCwgd3JhcCBpdCBpbnRvIG1vZGVsCgkvL2lmIGl0IGlzIHB1cmUgb2JqZWN0LCByZXR1cm4gYXMgaXQgaXMKCS8vaWYgaXQgaXMgXywgcmV0dXJuIG51bGwKCWZ1bmN0aW9uIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSB7CgkJaWYgKGlzU3RyaW5nKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSkgewoJCQlyZXR1cm4gaG0oIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApOwoKCQl9IGVsc2UgaWYgKGlzT2JqZWN0KCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSAmJiAhcHVibGlzaGVyT3JTdWJzY3JpYmVyLm5vZGVUeXBlKSB7CgkJCS8vbm90IGEgRE9NIGVsZW1lbnQKCQkJcmV0dXJuIHB1Ymxpc2hlck9yU3Vic2NyaWJlcjsKCgkJfSBlbHNlIGlmICghaXNVbmRlZmluZWQoIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApKSB7CgoJCQlyZXR1cm4gJCggcHVibGlzaGVyT3JTdWJzY3JpYmVyICk7CgkJfQoJfQoKCWZ1bmN0aW9uIHJlcGxhY2VEb3RPclN0YXIoIG1hdGNoICkgewoJCS8vaWYgbWF0Y2ggaXMgIi4iLCBub3JtYWxpemUgaXQgdG8gIlxcLiIKCQkvL2lmIG1hdGNoIGlzICIqIiwgbm9ybWFsaXplIGl0IHRvICIuKiIKCQlyZXR1cm4gbWF0Y2ggPT0gIi4iID8gIlxcLiIgOiAiLioiOwoJfQoKCS8vaWYgb25lIG9mIHRoZSBzdWJzY3JpYmVkIGV2ZW50cyBpcyBtYXRjaGVkIHdpdGggdHJpZ2dlcmluZyBldmVudAoJLy9yZXR1cm4gdGhhdCBzdWJzY3JpYmVkIGV2ZW50CglmdW5jdGlvbiBnZXRNYXRjaGVkU3Vic2NyaWJlZEV2ZW50KCBzdWJzY3JpYmVkRXZlbnRzLCB0cmlnZ2VyaW5nRXZlbnQgKSB7CgoJCXZhciBtYXRjaCwKCQkJc291cmNlLAoJCQlyTWF0Y2hXaXRoVHJpZ2dlcmluZ0V2ZW50LAoJCQlldmVudFN1YnNjcmliZWQsCgkJCWlzRW5kV2l0aFN0YXJEb3QsCgkJCWk7CgoJCWlmIChzdWJzY3JpYmVkRXZlbnRzID09PSAiKiIpIHsKCQkJcmV0dXJuICIqIjsKCQl9CgoJCXN1YnNjcmliZWRFdmVudHMgPSBzdWJzY3JpYmVkRXZlbnRzLnNwbGl0KCByU3BhY2VzICk7CgoJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpYmVkRXZlbnRzLmxlbmd0aDsgaSsrKSB7CgoJCQlldmVudFN1YnNjcmliZWQgPSBzdWJzY3JpYmVkRXZlbnRzW2ldOwoKCQkJaXNFbmRXaXRoU3RhckRvdCA9IHJFbmRXaXRoU3RhckRvdC50ZXN0KCBldmVudFN1YnNjcmliZWQgKTsKCgkJCXNvdXJjZSA9IGlzRW5kV2l0aFN0YXJEb3QgPwoJCQkJLy9pZiBldmVudFN1YnNjcmliZWQgaXMgbGlrZSAiKi4iIG9yICJiZWZvcmUqLiI7CgkJCQlldmVudFN1YnNjcmliZWQucmVwbGFjZSggckVuZFdpdGhTdGFyRG90LCAiIiApIDoKCQkJCWV2ZW50U3Vic2NyaWJlZDsKCgkJCXNvdXJjZSA9IHNvdXJjZS5yZXBsYWNlKCByRG90T3JTdGFyLCByZXBsYWNlRG90T3JTdGFyICk7CgoJCQlzb3VyY2UgPSBpc0VuZFdpdGhTdGFyRG90ID8gIl4iICsgc291cmNlIDogIl4iICsgc291cmNlICsgIiQiOwoKCQkJck1hdGNoV2l0aFRyaWdnZXJpbmdFdmVudCA9IG5ldyBSZWdFeHAoIHNvdXJjZSwgImkiICk7CgoJCQltYXRjaCA9IHJNYXRjaFdpdGhUcmlnZ2VyaW5nRXZlbnQudGVzdCggdHJpZ2dlcmluZ0V2ZW50ICk7CgoJCQlpZiAobWF0Y2gpIHsKCQkJCWlmIChpc0VuZFdpdGhTdGFyRG90KSB7CgkJCQkJLy9pbiBvdGhlciBicm93c2VyLCBpbiB0aGUgZm9sbG93aW5nIGlzIGVub3VnaAoJCQkJCS8vdmFyIHJlbWFpbmluZyA9IFJlZ0V4cC5yaWdodENvbnRleHQ7CgkJCQkJLy8KCQkJCQkvL2hvd2V2ZXIgaW4gSUUgaGFzIGEgYnVnIHRoYXQsIGlmIHJUZW1wIGlzIC9eLywgUmVnRXhwLnJpZ2h0Q29udGV4dCByZXR1cm4gIiIKCQkJCQkvL3doaWxlIG90aGVyIGJyb3dzZXIgUmVnRXhwLnJpZ2h0Q29udGV4dCByZXR1cm4gdGhlIHJlbWFpbmluZwoJCQkJCS8vc2VlIGh0dHA6Ly9qc2Jpbi5jb20vaWtha3V3LzIvZWRpdAoJCQkJCXZhciByZW1haW5pbmcgPSBzb3VyY2UgPT0gIl4iID8gdHJpZ2dlcmluZ0V2ZW50IDogUmVnRXhwLnJpZ2h0Q29udGV4dDsKCgkJCQkJLy9pZiByZW1haW5pbmcgaXMgZW1wdHkgb3IgcmVtYWluaW5nIGRvZXMgbm90IGNvbnRhaW5zICIuIgoJCQkJCWlmICghcmVtYWluaW5nIHx8ICFyZW1haW5pbmcuY29udGFpbnMoICIuIiApKSB7CgkJCQkJCXJldHVybiBzdWJzY3JpYmVkRXZlbnRzW2ldOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHN1YnNjcmliZWRFdmVudHNbaV07CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy9jaGVjayBpZiBzdWJzY3JpcHRpb24gbWF0Y2hlZCB3aXRoIHRoZSB0cmlnZ2VyaW5nIGV2ZW50LAoJLy8gYW5kIGludm9rZSBpdHMgd29ya2Zsb3csIGFuZCBhbHNvIGNhc2NhZGUgdGhlIGV2ZW50cyB0bwoJLy9ob3Jpem9udGFsbHksIGUgaXMgbXV0YWJsZQoJZnVuY3Rpb24gY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKSB7CgoJCXZhciBzdWJzY3JpcHRpb24sCgkJCXdhdGNoaW5nUGF0aHMsCgkJCWNhc2NhZGVFdmVudCwKCQkJaSwKCQkJaiwKCQkJc3Vic2NyaXB0aW9uc0J5UHVibGlzaGVyID0gZS5wdWJsaXNoZXIuc3Vic1RvTWUoKTsKCgkJZm9yIChpID0gMDsgaSA8IHN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlci5sZW5ndGg7IGkrKykgewoKCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc0J5UHVibGlzaGVyW2ldOwoKCQkJZS5tYXRjaGVkVHlwZSA9IGdldE1hdGNoZWRTdWJzY3JpYmVkRXZlbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCBlLnR5cGUgKTsKCgkJCWlmIChlLm1hdGNoZWRUeXBlKSB7CgkJCQlleGVjdXRlSGFuZGxlciggdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICksIHN1YnNjcmlwdGlvbi5oYW5kbGVyLCBlICk7CgkJCX0KCgkJCWlmIChlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJaWYgKCFlLmlzQ2FzY2FkZVN0b3BwZWQoKSkgewoKCQkJd2F0Y2hpbmdQYXRocyA9IHdhdGNoVGFibGVbZS5wdWJsaXNoZXIucGF0aF07CgoJCQlpZiAod2F0Y2hpbmdQYXRocykgewoJCQkJZm9yIChqID0gMDsgaiA8IHdhdGNoaW5nUGF0aHMubGVuZ3RoOyBqKyspIHsKCgkJCQkJY2FzY2FkZUV2ZW50ID0gdHJpZ2dlcigKCQkJCQkJd2F0Y2hpbmdQYXRoc1tqXSwKCQkJCQkJZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoLAoJCQkJCQllLnR5cGUKCQkJCQkpOwoKCQkJCQlpZiAoY2FzY2FkZUV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgfHwgY2FzY2FkZUV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGNhc2NhZGVFdmVudC5oYXNFcnJvcigpKSB7CgkJCQkJCWUuZXJyb3IoKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoKCWZ1bmN0aW9uIGV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCB0cmlnZ2VyRGF0YSApIHsKCgoJCXZhciB2YWx1ZSwKCQkJY2xvbmVkRXZlbnRBcmc7CgoJCWUuaGFuZGxlciA9IGhhbmRsZXI7CgkJZS5zdWJzY3JpYmVyID0gc3Vic2NyaWJlcjsKCgkJaWYgKCFpc1VuZGVmaW5lZCggdHJpZ2dlckRhdGEgKSkgewoJCQkvL2luIHRoZSBnZXQgbWV0aG9kICJ0aGlzIiByZWZlciB0byB0aGUgaGFuZGxlcgoJCQl2YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJfSBlbHNlIHsKCQkJLy9pbiB0aGUgZ2V0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJdmFsdWUgPSBoYW5kbGVyLmdldC5jYWxsKCBzdWJzY3JpYmVyLCBlICk7CgkJfQoKCQlpZiAoZS5pc0Fib3J0ZWQoKSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoaXNQcm9taXNlKCB2YWx1ZSApKSB7CgkJCWNsb25lZEV2ZW50QXJnID0gZXh0ZW5kKCB0cnVlLCB7fSwgZSApOwoJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkJLy9pbiB0aGUgY29udmVydCBtZXRob2QgInRoaXMiIHJlZmVyIHRvIHRoZSBoYW5kbGVyCgkJCQkJdmFsdWUgPSBoYW5kbGVyLmNvbnZlcnQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJCX0KCgkJCQlpZiAoaGFuZGxlci5zZXQgfHwgaGFuZGxlci5maW5hbGl6ZSkgewoJCQkJCS8vbWFrZSBzdXJlIGl0IGlzIGEgcmVhbCBwcm9taXNlIG9iamVjdAoJCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQkJdmFsdWUuZG9uZSggZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCQkJc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBjbG9uZWRFdmVudEFyZyApOwoJCQkJCQl9ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0gKTsKCQl9IGVsc2UgewoJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkvL2luIHRoZSBjb252ZXJ0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJCXZhbHVlID0gaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCX0KCgkJCWlmIChoYW5kbGVyLnNldCB8fCBoYW5kbGVyLmZpbmFsaXplKSB7CgkJCQkvL21ha2Ugc3VyZSBpdCBpcyBhIHJlYWwgcHJvbWlzZSBvYmplY3QKCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQljbG9uZWRFdmVudEFyZyA9IGV4dGVuZCggdHJ1ZSwge30sIGUgKTsKCQkJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJCXNldEFuZEZpbmFsaXplKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCB2YWx1ZSwgY2xvbmVkRXZlbnRBcmcgKTsKCQkJCQl9ICk7CgoJCQkJfSBlbHNlIHsKCQkJCQlzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBlICkgewoJCWlmICh2YWx1ZSA9PT0gZHVtbXkpIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoJCWhhbmRsZXIuc2V0ICYmIGhhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJaGFuZGxlci5maW5hbGl6ZSAmJiBoYW5kbGVyLmZpbmFsaXplLmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7Cgl9CgoJZnVuY3Rpb24gc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyUGF0aCwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCgkJdmFyIG1hdGNoLAoJCQlkZWxheU1pbmlTZWNvbmQsCgkJCWluaXRFdmVudCwKCQkJZXZlbnRzOwoKCQlldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCAiICIgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJbWF0Y2ggPSBySW5pdC5leGVjKCBldmVudHNbaV0gKTsKCQkJaWYgKG1hdGNoKSB7CgkJCQlpbml0RXZlbnQgPSBldmVudHNbaV07CgkJCQlkZWxheU1pbmlTZWNvbmQgPSArbWF0Y2hbMV07CgkJCQlldmVudHMuc3BsaWNlKCBpLCAxICk7CgkJCQlldmVudFR5cGVzID0gZXZlbnRzLmpvaW4oICIgIiApOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWhhbmRsZXIgPSBidWlsZEhhbmRsZXIoIGhhbmRsZXIsIHB1Ymxpc2hlclBhdGgsIHN1YnNjcmliZXIsIG9wdGlvbnMgKTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJc3Vic2NyaXB0aW9uTWFuYWdlci5hZGQoIHN1YnNjcmliZXIsIHB1Ymxpc2hlclBhdGgsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKTsKCQl9CgoJCWlmIChpbml0RXZlbnQpIHsKCQkJdmFyIGluaXQgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBlID0gbmV3IEV2ZW50KCBwdWJsaXNoZXJQYXRoLCBwdWJsaXNoZXJQYXRoLCBpbml0RXZlbnQgKTsKCQkJCWV4ZWN1dGVIYW5kbGVyKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggc3Vic2NyaWJlciApLCBoYW5kbGVyLCBlICk7CgkJCX07CgoJCQlpZiAoZGVsYXlNaW5pU2Vjb25kKSB7CgkJCQlzZXRUaW1lb3V0KCBpbml0LCBkZWxheU1pbmlTZWNvbmQgKTsKCQkJfSBlbHNlIHsKCQkJCWluaXQoKTsKCQkJfQoJCX0KCX0KCgkvL3N1YnNjcmliZSBqUXVlcnkgZXZlbnQKCWZ1bmN0aW9uIHN1YnNjcmliZVZpZXdFdmVudCggdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJLy9nZXQvc2V0L2NvbnZlcnQvW2luaXRdL1tvcHRpb25zXQoJCXZhciBuZWVkSW5pdCwKCQkJZXZlbnRTZWVkRGF0YSwKCQkJdGVtcDsKCgkJdGVtcCA9IGV2ZW50VHlwZXMuc3BsaXQoICIgIiApOwoKCQlpZiAodGVtcC5jb250YWlucyggImluaXQiICkpIHsKCQkJbmVlZEluaXQgPSB0cnVlOwoJCQlldmVudFR5cGVzID0gdGVtcC5yZW1vdmUoICJpbml0IiApLmpvaW4oICIgIiApOwoJCX0KCgkJaGFuZGxlciA9IGJ1aWxkSGFuZGxlciggaGFuZGxlciwgdmlld1B1Ymxpc2hlciwgc3Vic2NyaWJlciwgb3B0aW9ucyApOwoKCQlldmVudFNlZWREYXRhID0gewoJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyCgkJfTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJZXZlbnRUeXBlcyA9IGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMoIGV2ZW50VHlwZXMsIHZpZXdQdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCWlmIChkZWxlZ2F0ZVNlbGVjdG9yKSB7CgkJCQloYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IgPSBkZWxlZ2F0ZVNlbGVjdG9yOwoJCQkJJCggdmlld1B1Ymxpc2hlciApLmRlbGVnYXRlKCBkZWxlZ2F0ZVNlbGVjdG9yLCBldmVudFR5cGVzLCBldmVudFNlZWREYXRhLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCX0gZWxzZSB7CgkJCQkkKCB2aWV3UHVibGlzaGVyICkuYmluZCggZXZlbnRUeXBlcywgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQl9CgoJCQkvL3dlIGhhdmUgcGFzc2VkIGhhbmRsZXIsIHN1YnNjcmliZXIsIG9wdGlvbnMgYXMgalF1ZXJ5IGV2ZW50U2VlZERhdGEsCgkJCS8vd2Ugc3RpbGwgbmVlZCB0byBhZGQgdGhlbSB0byBzdWJzY3JpcHRpb25zIHNvIHRoYXQKCQkJLy90aGUgdmlldyBldmVudCBoYW5kbGVyIGNhbiBiZSB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQlzdWJzY3JpcHRpb25NYW5hZ2VyLmFkZCggc3Vic2NyaWJlciwgdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApOwoKCQkJaWYgKG5lZWRJbml0KSB7CgkJCQlpZiAoZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCSQoIHZpZXdQdWJsaXNoZXIgKS5maW5kKCBkZWxlZ2F0ZVNlbGVjdG9yICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCB2aWV3UHVibGlzaGVyICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSBpZiAobmVlZEluaXQpIHsKCgkJCSQoIHZpZXdQdWJsaXNoZXIgKS5vbmUoICJpbml0IiwgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCSQoIHZpZXdQdWJsaXNoZXIgKS50cmlnZ2VyKCAiaW5pdCIgKTsKCgkJfQoJfQoKCWZ1bmN0aW9uIGFib3J0KCkgewoJCXRoaXMuaXNBYm9ydGVkID0gcmV0dXJuVHJ1ZTsKCX0KCgkvL3RoZSBnZW5lcmFsIGpRdWVyeSBldmVudCBoYW5kbGVyCglmdW5jdGlvbiB2aWV3SGFuZGxlckdhdGV3YXkoIGUgKSB7CgkJZS5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggZS5jdXJyZW50VGFyZ2V0ICk7CgkJZS5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBlLnRhcmdldCApOwoJCWUuaXNBYm9ydGVkID0gcmV0dXJuRmFsc2U7CgkJZS5hYm9ydCA9IGFib3J0OwoJCXZhciBzdWJzY3JpYmVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIGUuZGF0YS5zdWJzY3JpYmVyICk7CgoJCXZhciBoYW5kbGVyID0gZS5kYXRhLmhhbmRsZXI7CgkJZGVsZXRlIGUuZGF0YTsKCgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CgkJCWV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQl9IGVsc2UgewoJCQlleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSApOwoJCX0KCX0KCglmdW5jdGlvbiBidWlsZEhhbmRsZXIoIHdvcmtmbG93UHJvdG90eXBlLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQl2YXIgaGFuZGxlcjsKCgkJd29ya2Zsb3dQcm90b3R5cGUgPSB3b3JrZmxvd1Byb3RvdHlwZSB8fCAiIjsKCgkJaWYgKGlzU3RyaW5nKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gYnVpbGRIYW5kbGVyRnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaW5pdGlhbGl6ZU9wdGlvbnMgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZSwKCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJfSwKCQkJCXdvcmtmbG93UHJvdG90eXBlCgkJCSk7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIHdvcmtmbG93UHJvdG90eXBlICkgJiYgd29ya2Zsb3dQcm90b3R5cGUuZ2V0KSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQl9LCB3b3JrZmxvd1Byb3RvdHlwZSApOwoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICk7CgoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCQljb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCAic2V0IiwgaGFuZGxlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICk7CgkJLy8KCQljb252ZXJ0U3RyaW5nQWN0aXZpdHlUb0Z1bmN0aW9uKCAiY29udmVydCIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvLyBleGFtcGxlIG9mIHdvcmtmbG93U3RyaW5nCgkvLyB6ZXJvIHRva2VuLCB0aGUgc3Vic2NyaWJlciBtdXN0IGJlIGZ1bmN0aW9uIGluIHJlcG9zaXRvcnkKCS8vCgkvLyBzaW5nbGUgdG9rZW4gbGlrZSAiKndvcmtmbG93IiwgInZhbCIsICJodG1sIiwgIiNwYXRoIiwKCS8vICJ2YWwiIHdpbGwgZXhwYW5kIHRvICJ2YWwgc2V0IiBvciAiZ2V0IHZhbCIgZGVwZW5kaW5nIHRoZSB0eXBlIG9mIHB1Ymxpc2hlcgoJLy8KCS8vIG11bHRpcGxlIHRva2VucywgYWxsIHRva2VuIGNhbiBzdGFydHMgd2l0aCAiKiIsICIjIiwKCS8vIGJ1dCBvbmx5ICJnZXQiIGFuZCAic2V0IiB0b2tlbiBjYW4gc3RhcnQgbm9ybWFsIGNoYXJhY3RlcnMsCgkvLyBzdWNoIGFzICJ2YWwiLCAiaHRtbCIKCWZ1bmN0aW9uIGJ1aWxkSGFuZGxlckZyb21TdHJpbmcoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQkvL2dldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplCgkJdmFyIGhhbmRsZXIsCgkJCWVtYmVkZGVkSGFuZGxlciwKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPT0gMSkgewoKCQkJaWYgKHdvcmtmbG93U3RyaW5nLnN0YXJ0c1dpdGgoICIqIiApKSB7CgoJCQkJaGFuZGxlciA9IHdvcmtmbG93U3RvcmVbd29ya2Zsb3dTdHJpbmcuc3Vic3RyKCAxICldOwoJCQkJaWYgKCFoYW5kbGVyKSB7CgkJCQkJdGhyb3cgImNvbW1vbiB3b3JrZmxvdyAiICsgd29ya2Zsb3dTdHJpbmcgKyAiIGRvZXMgbm90IGV4aXN0IjsKCQkJCX0KCgkJCQloYW5kbGVyID0gZXh0ZW5kKCB7fSwgaGFuZGxlciApOwoKCQkJfSBlbHNlIGlmICh3b3JrZmxvd1N0cmluZy5zdGFydHNXaXRoKCAiIyIgKSkgewoKCQkJCWVtYmVkZGVkSGFuZGxlciA9IGdldEVtYmVkZGVkQWN0aXZpdHkoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggZW1iZWRkZWRIYW5kbGVyICkpIHsKCQkJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJCWdldDogZW1iZWRkZWRIYW5kbGVyLAoJCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJCX0sIGVtYmVkZGVkSGFuZGxlciApOwoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggZW1iZWRkZWRIYW5kbGVyICkgJiYgZW1iZWRkZWRIYW5kbGVyLmdldCkgewoJCQkJCWhhbmRsZXIgPSBleHRlbmQoIHsKCQkJCQkJb3B0aW9uczogaW5pdGlhbGl6ZU9wdGlvbnMKCQkJCQl9LCBlbWJlZGRlZEhhbmRsZXIgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCgkJCQloYW5kbGVyID0gaW5mZXJIYW5kbGVyRnJvbVB1Ymxpc2hlclN1YnNjcmliZXJXaXRoU2luZ2xlQWN0aXZpdHkoCgkJCQkJcHVibGlzaGVyLAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJd29ya2Zsb3dTdHJpbmcgKTsKCgkJCX0gZWxzZSB7CgkJCQkvL2VpdGhlciBtb2RlbCBpcyBlbXB0eSBvciB2aWV3IGlzIGVtcHR5LAoJCQkJLy8gYW5kIHRoZSB3b3JrZmxvdyBzdHJpbmcgaXMgYSBzaW5nbGUKCQkJCS8va2V5LCBhbmQgdGhlIGtleSBpcyBub3Qgd29ya2Zsb3cgdHlwZQoJCQkJdGhyb3cgImludmFsaWQgaGFuZGxlciI7CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy90aGlzIGlzIHRoZSBjYXNlCgkJCS8vYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxCgoJCQloYW5kbGVyID0geyB9OwoKCQkJLy9hY3Rpdml0eVR5cGVzIGlzIFtnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZV0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhY3Rpdml0eVR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJCQlhY3Rpdml0eU5hbWUgPSBhY3Rpdml0eU5hbWVzW2ldOyAvL2FjdGl2aXR5TmFtZSBpcyB0aGUgdG9rZW4gaW4gd29ya2Zsb3cgc3RyaW5nCgkJCQlhY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGVzW2ldOyAvL2FjdGl2aXR5VHlwZSBpcyBvbmUgb2YgZ2V0LHNldCxjb252ZXJ0LGZpbmFsaXplLGluaXRpYWxpemUKCgkJCQlpZiAoYWN0aXZpdHlOYW1lICYmIChhY3Rpdml0eU5hbWUgIT09ICJfIiAmJiBhY3Rpdml0eU5hbWUgIT0gIm51bGwiKSkgewoJCQkJCWhhbmRsZXJbYWN0aXZpdHlUeXBlXSA9IGFjdGl2aXR5TmFtZTsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvL2dldCBlbWJlZGRlZCBoYW5kbGVyIGhlbHBlciBieSBwYXRoCgkvL3RoZSBwYXRoIHNob3VsZCBiZSBhIHBhdGggcHJlZml4IHdpdGggIiMiCgkvL3RoYXQgcGF0aCBjYW4gYmUgYWJzb2x1dGUgcGF0aCBsaWtlICIjL2EuYiIKCS8vb3IgaXQgY2FuIGJlIHJlbGF0aXZlIHBhdGggcmVsYXRpdmUgdG8gc3Vic2NyaWJlciBtb2RlbCBvciBwdWJsaXNoZXIgbW9kZWwKCWZ1bmN0aW9uIGdldEVtYmVkZGVkQWN0aXZpdHkoIGFjdGl2aXR5TmFtZVByZWZpeFdpdGhTaGFycENoYXJhY3RlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoKCQl2YXIgbW9kZWxQYXRoID0gYWN0aXZpdHlOYW1lUHJlZml4V2l0aFNoYXJwQ2hhcmFjdGVyLnN1YnN0ciggMSApOwoKCQltb2RlbFBhdGggPSBpc1N0cmluZyggc3Vic2NyaWJlciApID8gbWVyZ2VQYXRoKCBzdWJzY3JpYmVyLCBtb2RlbFBhdGggKSA6CgkJCWlzU3RyaW5nKCBwdWJsaXNoZXIgKSA/IG1lcmdlUGF0aCggcHVibGlzaGVyLCBtb2RlbFBhdGggKSA6CgkJCQltb2RlbFBhdGg7CgoJCXJldHVybiByb290Tm9kZS5yYXcoIG1vZGVsUGF0aCApOwoJfQoKCWZ1bmN0aW9uIGluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93T3B0aW9ucyApIHsKCgkJdmFyIGluaXRpYWxpemUgPSBoYW5kbGVyLmluaXRpYWxpemU7CgoJCWlmIChpc1N0cmluZyggaW5pdGlhbGl6ZSApKSB7CgkJCWlmIChpbml0aWFsaXplLnN0YXJ0c1dpdGgoICIqIiApKSB7CgkJCQlpbml0aWFsaXplID0gaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZVtpbml0aWFsaXplLnN1YnN0cmluZyggMSApXTsKCQkJCWlmICghaW5pdGlhbGl6ZSkgewoJCQkJCXRocm93ICJpbml0aWFsaXplIGFjdGl2aXR5IGRvZXMgbm90IGV4aXN0ISI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl2YXIgcGF0aCA9IGluaXRpYWxpemU7CgkJCQlpZiAoIXJvb3ROb2RlLnJhdyggcGF0aCApKSB7CgkJCQkJdGhyb3cgImluaXRpYWxpemUgYWN0aXZpdHkgZG9lcyBub3QgZXhpc3QgYXQgcGF0aCAiICsgcGF0aDsKCQkJCX0KCQkJCWluaXRpYWxpemUgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJCXJvb3ROb2RlLnNldCggcGF0aCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoaW5pdGlhbGl6ZSkgewoJCQlpbml0aWFsaXplKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICksIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpYmVyICksIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCB3b3JrZmxvd09wdGlvbnMgKSkgewoJCQloYW5kbGVyLm9wdGlvbnMgPSB3b3JrZmxvd09wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGluZmVySGFuZGxlckZyb21QdWJsaXNoZXJTdWJzY3JpYmVyV2l0aFNpbmdsZUFjdGl2aXR5KCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGFjdGl2aXR5TmFtZSApIHsKCQkvL25vdyB3b3JrZmxvd1N0cmluZyBkb2VzIG5vdCBzdGFydHNXaXRoICosIGl0IGlzIG5vdCBhIHdvcmtmbG93IHR5cGUKCQkvL2luZmVyIGhhbmRsZXIgZnJvbSBwdWJsaXNoZXIgYW5kIHN1YnNjcmliZXIKCQkvLwoJCXZhciBoYW5kbGVyLAoJCQlpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCS8vaWYgcHVibGlzaGVyIGlzIG1vZGVsLCB0aGVuIHRoZSBsb2dpYyBpcwoJCQkvL3dpbGwgZ2V0IG1vZGVsJ3MgdmFsdWUgdXNpbmcgZGVmYXVsdCBnZXQgYWN0aXZpdHksCgkJCS8vYW5kIHVwZGF0ZSB0aGUgdmlldyB1c2luZyB3b3JrZmxvdyBvciAgZGVmYXVsdCAic2V0IiBhY3Rpdml0eQoJCQkvLwoJCQloYW5kbGVyID0gewoKCQkJCWdldDogImdldCIsCgoJCQkJLy9pZiB3b3JrZmxvd1N0cmluZyBpcyBub3QgZW1wdHksIGl0IGlzIHRoZSBzZXQgbWV0aG9kLCBmb3IgZXhhbXBsZQoJCQkJLy8kKCIjbGFibGUiKS5zdWIoaG0oIm1lc3NhZ2UiKSwgInRleHQiKTsKCQkJCS8vCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5LAoJCQkJLy8gdGhlbiBpdCBzaG91bGQgYmUgdGhlIGNhc2Ugd2hlbiBtb2RlbCBzdWJzY3JpYmUgbW9kZWwKCQkJCS8vY29weSB2YWx1ZSBvZiBvbmUgbm9kZSB0byBhbiBvdGhlciBub2RlCgkJCQkvL2htKCJtZXNzYWdlIikuc3ViKGhtKCJuYW1lIiksICJhZnRlclVwZGF0ZSIpOwoJCQkJc2V0OiBhY3Rpdml0eU5hbWUgfHwgInNldCIKCgoJCQl9OwoKCQl9IGVsc2UgaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgoJCQkvLyBtb2RlbCBzdWJzY3JpYmUgdmlldyBldmVudAoKCQkJaWYgKGFjdGl2aXR5TmFtZSkgewoJCQkJLy9obSgibmFtZSIpLnN1YigkKCIjdGV4dEJveCIsICJjaGFuZ2UiKTsKCQkJCWhhbmRsZXIgPSB7CgkJCQkJZ2V0OiBhY3Rpdml0eU5hbWUsCgkJCQkJc2V0OiAic2V0IgoJCQkJfTsKCQkJfSBlbHNlIHsKCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5CgkJCQkvL3doZW4gbW9kZWwgc3Vic2NyaWJlIHZpZXcgd2l0aG91dCBoYW5kbGVyCgkJCQkvL3RoZSBtb2RlbCBpcyB0aGUgaGFuZGxlciBieSBpdHNlbGYKCQkJCS8vZS5nCgkJCQkvL2htKCJmdW5jdGlvbk5vZGUiKS5zdWJzY3JpYmUoJCgiYnV0dG9uIiksICJjbGljayIpOwoJCQkJdmFyIHRlbXAgPSByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKTsKCQkJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wICkpIHsKCgkJCQkJaGFuZGxlciA9IHsKCQkJCQkJZ2V0OiByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKQoJCQkJCX07CgoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggdGVtcCApICYmIHRlbXAuZ2V0KSB7CgoJCQkJCWhhbmRsZXIgPSB0ZW1wOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy92aWV3IHN1YnNjcmliZSB2aWV3J3MgZXZlbnQKCQkJLy90aGlzIGlzIHJhcmVseSB0aGUgY2FzZSwgYnV0IGl0IGlzIHN0aWxsIHN1cHBvcnRlZAoJCQkvL2ZvciBleGFtcGxlLCBhIGxhYmVsIHN1YnNjcmliZSB0aGUgY2hhbmdlIG9mIGFub3RoZXIgbGFiZWwKCQkJLy8kKCIjbGFibGUyIikuc3ViKCIjbGFibGUxIiwgInRleHQiKTsKCQkJaGFuZGxlciA9IHsKCQkJCWdldDogYWN0aXZpdHlOYW1lLAoJCQkJc2V0OiBhY3Rpdml0eU5hbWUKCQkJfTsKCQl9CgoJCXJldHVybiBoYW5kbGVyOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQl2YXIgd29ya2Zsb3c7CgoJCWlmIChpc1N0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJd29ya2Zsb3cgPSBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApIHx8IChpc09iamVjdCggd29ya2Zsb3dQcm90b3R5cGUgKSAmJiB3b3JrZmxvd1Byb3RvdHlwZS5nZXQpKSB7CgoJCQl3b3JrZmxvdyA9IHdvcmtmbG93UHJvdG90eXBlOwoJCQlpZiAoaXNGdW5jdGlvbiggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJCXdvcmtmbG93ID0gZXh0ZW5kKAoJCQkJCXsKCQkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZQoJCQkJCX0sCgkJCQkJd29ya2Zsb3cgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJpbml0aWFsaXplIiwgd29ya2Zsb3cgKTsKCQkvLwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJzZXQiLCB3b3JrZmxvdyApOwoJCS8vCgkJY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggImNvbnZlcnQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIHdvcmtmbG93ICk7CgoJCXJldHVybiB3b3JrZmxvdzsKCX0KCglmdW5jdGlvbiBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dTdHJpbmcgKSB7CgoJCXZhciB3b3JrZmxvdywKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxKSB7CgoJCQl3b3JrZmxvdyA9IHsgfTsKCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYWN0aXZpdHlUeXBlcy5sZW5ndGg7IGkrKykgewoJCQkJYWN0aXZpdHlOYW1lID0gYWN0aXZpdHlOYW1lc1tpXTsKCQkJCWFjdGl2aXR5VHlwZSA9IGFjdGl2aXR5VHlwZXNbaV07CgoJCQkJaWYgKGFjdGl2aXR5TmFtZSAmJiAoYWN0aXZpdHlOYW1lICE9PSAiXyIgJiYgYWN0aXZpdHlOYW1lICE9ICJudWxsIikpIHsKCQkJCQl3b3JrZmxvd1thY3Rpdml0eVR5cGVdID0gYWN0aXZpdHlOYW1lOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdGhyb3cgImludmFsaWQgd29ya2Zsb3cgdHlwZSI7CgkJfQoKCQlyZXR1cm4gd29ya2Zsb3c7Cgl9CgoJZnVuY3Rpb24gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApIHsKCQlyZXR1cm4gaG0uYWN0aXZpdHlbYWN0aXZpdHlUeXBlXTsKCX0KCgkvLyBwdWJsaXNoZXIsIHN1YnNjcmliZXIgaXMgb3B0aW9uYWwKCS8vYWNjZXNzb3IgZWl0aGVyICJnZXQiIG9yICJzZXQiCglmdW5jdGlvbiBjb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCBhY2Nlc3NvclR5cGUsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApIHsKCgkJLy9ieSBkZWZhdWx0IHdvcmtmbG93LmdldCA9PSAiZ2V0Iiwgd29ya2Zsb3cuc2V0ID0gInNldCIKCQl2YXIgYWNjZXNzb3JLZXkgPSBoYW5kbGVyW2FjY2Vzc29yVHlwZV07CgoJCWlmIChhY2Nlc3NvcktleSAmJiBpc1N0cmluZyggYWNjZXNzb3JLZXkgKSkgewoKCQkJdmFyIGFjY2Vzc29ycyA9IGdldEFjdGl2aXR5U2V0KCBhY2Nlc3NvclR5cGUgKTsKCgkJCWlmIChhY2Nlc3NvcktleS5zdGFydHNXaXRoKCAiKiIgKSkgewoKCQkJCWFjY2Vzc29yS2V5ID0gYWNjZXNzb3JLZXkuc3Vic3RyKCAxICk7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvcnNbYWNjZXNzb3JLZXldOwoKCQkJCWlmICghaGFuZGxlclthY2Nlc3NvclR5cGVdKSB7CgkJCQkJdGhyb3cgYWNjZXNzb3JLZXkgKyAiIGRvZXMgbm90IGV4aXN0cyAiICsgYWNjZXNzb3JUeXBlICsgIiBBY3Rpdml0eSI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKGFjY2Vzc29yS2V5LnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY2Nlc3NvclR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWNjZXNzb3JLZXksIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIga2V5cyA9IGFjY2Vzc29yS2V5LnNwbGl0KCAiKiIgKTsKCgkJCQkvL3VzZSBkZWZhdWx0R2V0IG9yIGRlZmF1bHRTZXQgYW5kIHBhcnNlU3VicywgaWYgYWNjZXNzb3JLZXkgZG9lcyBub3QgYmVnaW4gd2l0aCAiKiIKCQkJCS8vIGhhbmRsZXIuc2V0UHJvcGVydHkgPSBhY2Nlc3NvcktleSBvcgoJCQkJLy8gaGFuZGxlci5nZXRQcm9wZXJ0eSA9IGFjY2Vzc29yS2V5CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvclR5cGUgPT0gImdldCIgPyBnZXRNZW1iZXIgOiBzZXRNZW1iZXI7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZSArICJOYW1lIl0gPSBrZXlzWzBdOwoKCQkJCWlmIChrZXlzWzFdKSB7CgkJCQkJLy9hY2Nlc3NvcktleSA9ICJjc3MqY29sb3IiCgkJCQkJaGFuZGxlclthY2Nlc3NvclR5cGUgKyAiUGFyYXMiXSA9IGtleXNbMV07CgkJCQl9CgoJCQkJaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCQkJCQl2YXIgcHVibGlzaGVyT3JTdWJzY3JpYmVyID0gYWNjZXNzb3JUeXBlID09ICJnZXQiID8gcHVibGlzaGVyIDogc3Vic2NyaWJlcjsKCQkJCQllbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBrZXlzWzBdLCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBlbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBhY3Rpdml0eU5hbWUsIHRhcmdldCApIHsKCQl2YXIgbWlzc2luZ01lbWJlcjsKCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgoJCQlpZiAoIWhtRm5bYWN0aXZpdHlOYW1lXSkgewoKCQkJCW1pc3NpbmdNZW1iZXIgPSB0cnVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWlmICh0YXJnZXQubm9kZVR5cGUpIHsKCQkJCWlmICghJGZuW2FjdGl2aXR5TmFtZV0pIHsKCQkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmICghKGFjdGl2aXR5TmFtZSBpbiB0YXJnZXQpKSB7CgkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJfQoJCX0KCgkJaWYgKG1pc3NpbmdNZW1iZXIpIHsKCQkJdGhyb3cgKGFjY2Vzc29yVHlwZSA9PSAiZ2V0IiA/ICJwdWJsaXNoZXIiIDogInN1YnNjcmliZXIiKSArCgkJCSAgICAgICIgZG9lcyBub3QgaGF2ZSBhIG1lbWJlciAiICsgYWN0aXZpdHlOYW1lOwoJCX0KCX0KCgkvL2FjdGl2aXR5VHlwZSBpcyBsaWtlIGluaXRpYWxpemUsIGNvbnZlcnQsIGZpbmFsaXplCgkvL2FjdGl2aXR5VHlwZSBmb3IgImdldCIsICJzZXQiIGlzIHRha2VuIGNhcmUgYnkgY29udmVydFN0cmluZ0FjY2Vzc29yVG9GdW5jdGlvbgoJZnVuY3Rpb24gY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggYWN0aXZpdHlUeXBlLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJLy9iZWNhdXNlIGl0IGlzIG9wdGlvbmFsLCB3ZSBuZWVkIG1ha2Ugc3VyZSBoYW5kbGVyIHdhbnQgdG8gaGF2ZSB0aGlzIG1ldGhvZAoJCXZhciBhY3Rpdml0eU5hbWUgPSBoYW5kbGVyW2FjdGl2aXR5VHlwZV07CgkJaWYgKGlzU3RyaW5nKCBhY3Rpdml0eU5hbWUgKSkgewoKCQkJaWYgKGFjdGl2aXR5TmFtZS5zdGFydHNXaXRoKCAiKiIgKSkgewoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApW2FjdGl2aXR5TmFtZS5zdWJzdHIoIDEgKV07CgkJCQlpZiAoIWhhbmRsZXJbYWN0aXZpdHlUeXBlXSkgewoJCQkJCXRocm93ICBhY3Rpdml0eU5hbWUgKyAiQWN0aXZpdHkgZG9lcyBub3QgZXhpc3RzIjsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoYWN0aXZpdHlOYW1lLnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWN0aXZpdHlOYW1lLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCX0gZWxzZSB7CgkJCQl0aHJvdyAnYWN0aXZpdHkgb3RoZXIgdGhhbiAiZ2V0IiBhbmQgInNldCIgIG11c3QgYmVnaW4gd2l0aCAiKiIgb3IgIiMiICc7CgoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHVuc3Vic2NyaWJlKCB0YXJnZXQgKSB7CgkJaWYgKGlzT2JqZWN0KCB0YXJnZXQgKSkgewoJCQlpZiAoIXZpZXdJZE1hbmFnZXIuZ2V0SWQoIHRhcmdldCApKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmlld0lkTWFuYWdlci51bk1hcmsoIHRhcmdldCApOwoJCX0KCQlzdWJzY3JpcHRpb25NYW5hZ2VyLnJlbW92ZUJ5KCB0YXJnZXQgKTsKCX0KCglobS5vbkRlbGV0ZU5vZGUoIHVuc3Vic2NyaWJlICk7CgoJLy9zdWJzY3JpcHRpb24gc2hvcnRjdXQgbWV0aG9kIGZvciBtb2RlbAoJZXh0ZW5kKCBobUZuLCB7CgoJCXRyaWdnZXI6IGZ1bmN0aW9uKCBzdWJQYXRoLCBldmVudE5hbWUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQl0aHJvdyAibWlzc2luZyBhcmd1bWVudHMiOwoJCQl9CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzKSB7CgkJCQlyZW1vdmVkID0gcHJvcG9zZWQ7CgkJCQlwcm9wb3NlZCA9IGV2ZW50TmFtZTsKCQkJCWV2ZW50TmFtZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSB0aGlzLnBoeXNpY2FsUGF0aCggc3ViUGF0aCApOwoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgZXZlbnROYW1lLCBwcm9wb3NlZCwgcmVtb3ZlZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl2YXIgcGh5c2ljYWxQYXRoID0gdGhpcy5waHlzaWNhbFBhdGgoIHN1YlBhdGggKSwKCQkJCXZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlclVwZGF0ZSIsIHZhbHVlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWI6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCQkJaG0uc3ViKCB0aGlzLnBhdGgsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlobS5zdWIoIG51bGwsIHRoaXMsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YkJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoJCQlobS5zdWIoIHN1YnNjcmliZXIsIHRoaXMucGF0aCwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YnNUb01lOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5UHVibGlzaGVyKCB0aGlzLnBhdGggKTsKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3Vic0Zyb21NZTogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeVN1YnNjcmliZXIoIHRoaXMucGF0aCApOwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzLnBhdGggKTsKCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8qCgkJIG1hcCBhbiBtb2RlbCBldmVudCB0byBhIG5ldyBtb2RlbCBldmVudCBiYXNlZCBvbiBhIGNvbmRpdGlvbiwgbGlrZSB0aGUgZm9sbG93aW5nCgoJCSBobSgiaW52ZW50b3J5IikubWFwRXZlbnQoCgkJICJhZnRlclVwZGF0ZSIsCgkJICJpbnZlbnRvcnlMb3ciLAoJCSBmdW5jdGlvbiAodmFsdWUpIHsKCQkgcmV0dXJuIHZhbHVlIDw9IDEwMDsKCQkgfQoJCSApOwoKCQkgY29uZGl0aW9uIGlzIG9wdGlvbmFsLCBpZiBpdCBpcyBtaXNzaW5nLCB0aGUgdGFyZ2V0IGV2ZW50IHdpbGwgYWx3YXlzIGJlIHRyaWdnZXJlZAoJCSB3aGVuIHRoZSBzb3VyY2UgZXZlbnQgaXMgdHJpZ2dlcmVkCgkJICovCgkJbWFwRXZlbnQ6IGZ1bmN0aW9uKCBzb3VyY2VFdmVudCwgdGFyZ2V0RXZlbnQsIGNvbmRpdGlvbiApIHsKCQkJY29uZGl0aW9uID0gY29uZGl0aW9uIHx8IHJldHVyblRydWU7CgkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIHRhcmdldEV2ZW50LCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJCX0KCQkJfSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljYWNoZWFibGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlobS5oYW5kbGUoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCAiaW5pdCBhZnRlcioiLCAiKnNhdmVMb2NhbCIgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX0gKTsKCgkvL3N1YnNjcmlwdGlvbiBzaG9ydGN1dCBtZXRob2QgZm9yIGpRdWVyeSBvYmplY3QKCWV4dGVuZCggJGZuLCB7CgoJCXN1YjogZnVuY3Rpb24oIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJaWYgKHRoaXMubGVuZ3RoKSB7CgkJCQlobS5zdWIoIHRoaXMsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlpZiAodGhpcy5sZW5ndGgpIHsKCQkJCWhtLnN1YiggbnVsbCwgdGhpcywgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWJCeTogZnVuY3Rpb24oIHN1YnNjcmliZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCWlmICh0aGlzLmxlbmd0aCkgewoJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCB0aGlzLCBldmVudHMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJc3Vic1RvTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlQdWJsaXNoZXIoIHRoaXNbMF0gKTsKCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCXN1YnNGcm9tTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlTdWJzY3JpYmVyKCB0aGlzWzBdICk7CgoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzWzBdICk7CgoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlyZW5kZXJWaWV3OiBmdW5jdGlvbiggcGF0aCwgd29ya2Zsb3csIG9wdGlvbnMgKSB7CgkJCWhtLnN1YiggdGhpcywgcGF0aCwgImluaXQiLCB3b3JrZmxvdywgb3B0aW9ucyApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKgoJCSBtYXAgYSB2aWV3IGV2ZW50IHRvIGEgbmV3IHZpZXcgZXZlbnQgYmFzZWQgb24gYSBjb25kaXRpb24sIGNvbmRpdGlvbiBpcyBvcHRpb25hbCwKCQkgaWYgaXQgaXMgbWlzc2luZywgdGhlIHRhcmdldCBldmVudCB3aWxsIGFsd2F5cyBiZSB0cmlnZ2VyZWQgd2hlbiB0aGUgc291cmNlCgkJIGV2ZW50IGlzIHRyaWdnZXJlZAoKCQkgdXNhZ2UKCQkgJCgiYnV0dG9uIikubWFwRXZlbnQoImNsaWNrIiwgInVwZGF0ZSIpOwoJCSAqLwoJCW1hcEV2ZW50OiBmdW5jdGlvbiggc291cmNlRXZlbnQsIHRhcmdldEV2ZW50LCBjb25kaXRpb24sIGV2ZW50RGF0YSApIHsKCQkJaWYgKGNvbmRpdGlvbikgewoJCQkJaWYgKCFpc0Z1bmN0aW9uKCBjb25kaXRpb24gKSkgewoJCQkJCWV2ZW50RGF0YSA9IGNvbmRpdGlvbjsKCQkJCQljb25kaXRpb24gPSByZXR1cm5UcnVlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY29uZGl0aW9uID0gcmV0dXJuVHJ1ZTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuaGFuZGxlKCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUudHlwZSA9IHRhcmdldEV2ZW50OwoJCQkJCWUuZXZlbnREYXRhID0gZXZlbnREYXRhOwoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIGUgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCgkvLyBjcmVhdGUgYSBzcGVjaWFsIGpRdWVyeSBldmVudCAoeSkgYmFzZWQgb24gYW4gZXhpc3RpbmcgalF1ZXJ5IGV2ZW50ICh4KQoJLy8gd2hlbiBldmVudCB4IGlzIHJhaXNlZCwgYW5kIGNvbmRpdGlvbiByZXR1cm5zIHRydWUsIGV2ZW50IHkgd2lsbCBiZSByYWlzZWQKCS8vCgkvLyB5b3UgY2FuIHN1YnNjcmliZSBldmVudCB5LCBqdXN0IGxpa2UgYW55IG90aGVyIGpRdWVyeSBldmVudCB1c2luZwoJLy8kKCJidXR0b24iKS5iaW5kKCJ5IiwgZm4pOwoJLy8KCS8vdW5saWtlICQoKS5tYXBFdmVudCgiY2xpY2siLCAieSIpLCB0aGlzIG1ldGhvZCBjcmVhdGUgYSBuZXcgZXZlbnQgdHlwZSBmb3IgYWxsCgkvL2pRdWVyeSBvYmplY3QKCWhtLm5ld0pxRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQsIGJhc2VFdmVudCwgY29uZGl0aW9uICkgewoJCWlmIChpc09iamVjdCggZXZlbnQgKSkgewoJCQlmb3IgKHZhciBrZXkgaW4gZXZlbnQpIHsKCQkJCWhtLm5ld0pxRXZlbnQoIGtleSwgZXZlbnRba2V5XVswXSwgZXZlbnRba2V5XVsxXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoY29uZGl0aW9uID09PSB0cnVlIHx8IGNvbmRpdGlvbi5jYWxsKCB0aGlzLCBlICkpIHsKCQkJCSQoIGUudGFyZ2V0ICkudHJpZ2dlciggZXh0ZW5kKCB7fSwgZSwgewoJCQkJCXR5cGU6IGV2ZW50LAoJCQkJCWN1cnJlbnRUYXJnZXQ6IGUudGFyZ2V0CgkJCQl9ICkgKTsKCQkJfQoJCX07CgoJCWlmICgkLmV2ZW50LnNwZWNpYWxbZXZlbnRdKSB7CgkJCXRocm93ICJldmVudCAnIiArIGV2ZW50ICsgIicgaGFzIGJlZW4gZGVmaW5lZCI7CgkJfQoKCQkkLmV2ZW50LnNwZWNpYWxbZXZlbnRdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggYmFzZUV2ZW50LCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIGJhc2VFdmVudCwgaGFuZGxlciApOwoJCQl9CgkJfTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIF9jbGVhbkRhdGFGb3JVbnN1YnNjcmliZSA9ICQuY2xlYW5EYXRhOwoJLy93aGVuIGFuIGRvbSBlbGVtZW50IGlzIHJlbW92ZSB1bnN1YnNjcmliZSBpdCBmaXJzdAoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdW5zdWJzY3JpYmUoIHRoaXMgKTsKCQl9ICk7CgkJX2NsZWFuRGF0YUZvclVuc3Vic2NyaWJlKCBlbGVtcyApOwoJfTsKCgl1dGlsLmdldFVuaXF1ZVZpZXdFdmVudFR5cGVzID0gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlczsKCXV0aWwuX3ZpZXdIYW5kbGVyR2F0ZXdheSA9IHZpZXdIYW5kbGVyR2F0ZXdheTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qczwvQGRlcGVuZHM+CgoKCXZhciByU3Vic2NyaXB0aW9uUHJvcGVydHkgPSAvKFshJF0/KShbXHcgXCtcLVwqXC5dKz8pOihbXHdcV10rPylccyooPzpbO11ccyp8JCkvZywKCQlyQmluZGluZ1RleHQgPSAvXihbXnxdKykoXHwoLiopKT8kLywKCQlyU3Vic2NyaXB0aW9uVmFsdWVTZXBhcmF0b3IgPSAvXHMqXHxccyovZzsKCglkZWZhdWx0T3B0aW9ucy5zdWJzQXR0ciA9ICJkYXRhLXN1YiI7CglkZWZhdWx0T3B0aW9ucy5hdXRvUGFyc2UgPSB0cnVlOwoKCWZ1bmN0aW9uIG1lcmdlT3B0aW9ucyggcGFyZW50T3B0aW9ucywgbG9jYWxPcHRpb25zICkgewoJCWlmIChsb2NhbE9wdGlvbnMgIT09ICJfIikgewoJCQlyZXR1cm4gIChsb2NhbE9wdGlvbnMgJiYgbG9jYWxPcHRpb25zLnN0YXJ0c1dpdGgoICJfIiApKSA/CgkJCQlsb2NhbE9wdGlvbnMuc3Vic3RyKCAxICkgOgoJCQkJcGFyZW50T3B0aW9ucyB8fCBsb2NhbE9wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGdldEluaGVyaXRlZE5hbWVzcGFjZSggZWxlbSApIHsKCgkJdmFyICRwYXJlbnQgPSAkKCBlbGVtICk7CgoJCXdoaWxlICgoJHBhcmVudCA9ICRwYXJlbnQucGFyZW50KCkpICYmICRwYXJlbnQubGVuZ3RoKSB7CgoJCQl2YXIgbnMgPSAkcGFyZW50LmhtRGF0YSggIm5zIiApOwoKCQkJaWYgKCFpc1VuZGVmaW5lZCggbnMgKSkgewoJCQkJcmV0dXJuIG5zOwoJCQl9CgkJfQoJCXJldHVybiAiIjsKCX0KCgl2YXIgcmVVbmRlcnNjb3JlID0gL18vZzsKCXZhciByZUF0dHJEYXNoID0gLy0oXHcpL2c7Cgl2YXIgckRhdGFBdHRyUHJlZml4ID0gL15kYXRhLS87CgoJdmFyIHJlcGxhY2VBdHRyRGFzaFdpdGhDYXBpdGFsQ2hhcmFjdGVyID0gZnVuY3Rpb24oIG1hdGNoLCAkMSApIHsKCQlyZXR1cm4gJDEudG9VcHBlckNhc2UoKTsKCX07CgoJLy9jb252ZXJ0IGFkZC1jbGFzcyB0byBhZGRDbGFzcwoJLy9jb252ZXJ0ICRlbnRlcl9ibHVyIHRvICRlbnRlciBibHVyCglmdW5jdGlvbiBub3JtYWxpemVBdHRyaWJ1dGVOYW1lKCBhdHRyaWJ1dGVOYW1lICkgewoJCWF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoIHJEYXRhQXR0clByZWZpeCwgIiIgKTsKCgkJLy9pZiBzdWJzY3JpcHRpb24gaW52b2x2ZSB3aXRoIG1vcmUgdGhhbiBvbmUgZXZlbnRzLCB5b3UgY2FuCgkJLy9jb25jYXRlbmF0ZSB0aGVtIHdpdGggIl8iLCBoZXJlIHdlIG5lZWQgdG8gcmV2ZXJ0IHRoZW0gYmFjawoJCS8vc3VjaCBhcyAiJGNsaWNrX21vdXNlb3ZlciIgbmVlZCB0byBiZSBjaGFuZ2VkIHRvICIkY2xpY2sgbW91c2VvdmVyIgoJCWlmIChhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIhIiApIHx8IGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiQiICkpIHsKCgkJCWF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoIHJlVW5kZXJzY29yZSwgIiAiICk7CgoJCX0KCQlyZXR1cm4gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByZUF0dHJEYXNoLCByZXBsYWNlQXR0ckRhc2hXaXRoQ2FwaXRhbENoYXJhY3RlciApOwoJfQoKCWZ1bmN0aW9uIGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICkgewoJCWlmIChlbGVtLm5vZGVUeXBlICE9PSAxKSB7CgkJCXJldHVybjsKCQl9CgkJdmFyIGksCgkJCWF0dHIsCgkJCWF0dHJpYnV0ZU5hbWUsCgkJCWF0dHJpYnV0ZXMgPSBlbGVtLmF0dHJpYnV0ZXMsCgkJCXN1YnNjcmlwdGlvblRleHQgPSBhdHRyaWJ1dGVzW2RlZmF1bHRPcHRpb25zLnN1YnNBdHRyXSAmJiBhdHRyaWJ1dGVzW2RlZmF1bHRPcHRpb25zLnN1YnNBdHRyXS5ub2RlVmFsdWUgfHwgIiI7CgoJCWZvciAoaSA9IDA7IGkgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAoYXR0ci5uYW1lICE9PSBkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cikgewoJCQkJYXR0cmlidXRlTmFtZSA9IG5vcm1hbGl6ZUF0dHJpYnV0ZU5hbWUoIGF0dHIubmFtZSApOwoJCQkJLy9pZiBhdHRyaWJ1dGVOYW1lIGlzIHJlY29nbml6ZWQgYnkgdGhlIEhtLmpzLAoJCQkJLy8gc3VjaCBhcyBucz0ieHh4IiwgYmluZGluZ05hbWU9Inh4eCIsICFldmVudD0ieHh4IiAsICRldmVudD0ieHh4IgoJCQkJLy9leHRyYWN0IHRoZW0gYW5kIGFwcGVuZCB0byB0aGUgc3Vic2NyaXB0aW9uIHRleHQKCQkJCWlmIChhdHRyaWJ1dGVOYW1lID09ICJucyIgfHwgX2JpbmRpbmdzW2F0dHJpYnV0ZU5hbWVdKSB7CgkJCQkJLy9pZiB0aGUgYXR0cmlidXRlIGRvZXMgbm90IGhhdmUgYSB2YWx1ZSBsaWtlIDxkaXYgZGVidWc+CgkJCQkJLy9pdCBpcyB0aGUgc2FtZSBhcyA8ZGl2IGRlYnVnPSIvIj4KCQkJCQlzdWJzY3JpcHRpb25UZXh0ID0gc3Vic2NyaXB0aW9uVGV4dCArICI7IiArIGF0dHJpYnV0ZU5hbWUgKyAiOiIgKyAoYXR0ci5ub2RlVmFsdWUgfHwgIi8iKTsKCgkJCQl9IGVsc2UgaWYgKGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiEiICkgfHwgYXR0cmlidXRlTmFtZS5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJCXZhciBub2RlVmFsdWVzID0gYXR0ci5ub2RlVmFsdWUuc3BsaXQoICI7IiApOwoJCQkJCWZvciAodmFyIGogPSAwOyBqIDwgbm9kZVZhbHVlcy5sZW5ndGg7IGorKykgewoJCQkJCQl2YXIgbm9kZVZhbHVlID0gbm9kZVZhbHVlc1tqXTsKCQkJCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHN1YnNjcmlwdGlvblRleHQgKyAiOyIgKyBhdHRyaWJ1dGVOYW1lICsgIjoiICsgbm9kZVZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJdmFyIHRhZ0JpbmRpbmdOYW1lID0gInRhZ18iICsgZWxlbS50YWdOYW1lOwoJCWlmIChfYmluZGluZ3NbdGFnQmluZGluZ05hbWVdKSB7CgkJCXN1YnNjcmlwdGlvblRleHQgPSBzdWJzY3JpcHRpb25UZXh0ICsgIjsiICsgdGFnQmluZGluZ05hbWUgKyAiOi4iOwoJCX0KCQlyZXR1cm4gc3Vic2NyaXB0aW9uVGV4dC5yZXBsYWNlKCAvXjsvLCAiIiApOwoJfQoKCS8vc3VwcG9ydAoJLy9uZXcgQmluZGluZygpCgkvL25ldyBCaW5kaW5nKHN1YnNjcmlwdGlvblRleHQsIHBhcmVudEJpbmRpbmcpCgkvL25ldyBCaW5kaW5nKCIkY2xpY2t8KmFsZXJ0O3ZhbDpwYXRoIiwgcGFyZW50QmluZGluZyk7CglmdW5jdGlvbiBCaW5kaW5nKCBzdWJzY3JpcHRpb25UZXh0LCBwYXJlbnRCaW5kaW5nLCBiaW5kaW5nTnMsIGJpbmRpbmdPcHRpb25zICkgewoKCQl2YXIgbnNQcm9wZXJ0eSwgbWF0Y2gsIGVtcHR5QmluZGluZzsKCgkJLy9oYW5kbGUgdGhlIGNhc2U6IG5ldyBCaW5kaW5nKCkKCQlpZiAoIXN1YnNjcmlwdGlvblRleHQpIHsKCQkJLy8KCQkJLy9zaGFyZWQgcHJvcGVydHkKCQkJdGhpcy5zdWJzY3JpcHRpb25zID0gW107CgkJCXJldHVybjsKCQl9CgoJCS8vaGFuZGxlIHRoZSBjYXNlIDogbmV3IEJpbmRpbmcgKGVsZW0pOwoJCWlmIChzdWJzY3JpcHRpb25UZXh0Lm5vZGVUeXBlKSB7CgkJCXZhciBlbGVtID0gc3Vic2NyaXB0aW9uVGV4dDsKCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHBhcmVudEJpbmRpbmcgfHwgZXh0cmFjdFN1YnNjcmlwdGlvblRleHQoIGVsZW0gKTsKCQkJaWYgKHN1YnNjcmlwdGlvblRleHQpIHsKCQkJCWVtcHR5QmluZGluZyA9IG5ldyBCaW5kaW5nKCk7CgkJCQllbXB0eUJpbmRpbmcuZWxlbSA9IGVsZW07CgkJCQllbXB0eUJpbmRpbmcubnMgPSBnZXRJbmhlcml0ZWROYW1lc3BhY2UoIGVsZW0gKTsKCQkJCXJldHVybiBuZXcgQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgZW1wdHlCaW5kaW5nICk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCFwYXJlbnRCaW5kaW5nKSB7CgkJCWVtcHR5QmluZGluZyA9IG5ldyBCaW5kaW5nKCk7CgkJCS8vZmFrZSBhbiBlbGVtCgkJCWVtcHR5QmluZGluZy5lbGVtID0ge307CgkJCXJldHVybiBuZXcgQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgZW1wdHlCaW5kaW5nICk7CgkJfQoKCQkvL2hhbmRsZSB0aGUgY2FzZTogbmV3IEJpbmRpbmcoc3Vic2NyaXB0aW9uVGV4dCwgcGFyZW50QmluZGluZyk7CgkJLy8KCQkvL3ByaXZhdGUgZGF0YQoJCXRoaXMuc3ViID0gW107CgkJdGhpcy5wdWIgPSBbXTsKCQl0aGlzLmJpbmRpbmdzID0gW107CgoJCXdoaWxlICgobWF0Y2ggPSByU3Vic2NyaXB0aW9uUHJvcGVydHkuZXhlYyggc3Vic2NyaXB0aW9uVGV4dCApKSkgewoKCQkJdmFyIHByZWZpeCA9IG1hdGNoWzFdLAoJCQkJcHJvcCA9ICQudHJpbSggbWF0Y2hbMl0gKSwKCQkJCXZhbHVlID0gJC50cmltKCBtYXRjaFszXSApOwoKCQkJaWYgKHByZWZpeCkgewoKCQkJCXRoaXNbcHJlZml4ID09ICIkIiA/ICJwdWIiIDogInN1YiJdLnB1c2goIHsgZXZlbnRUeXBlczogcHJvcCwgdmFsdWU6IHZhbHVlIH0gKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKHByb3AgPT0gIm5zIikgewoJCQkJCW5zUHJvcGVydHkgPSB2YWx1ZTsKCgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuYmluZGluZ3MucHVzaCggeyBiaW5kaW5nTmFtZTogcHJvcCwgdmFsdWU6IHZhbHVlfSApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLm5zID0gbWVyZ2VQYXRoKCBtZXJnZVBhdGgoIHBhcmVudEJpbmRpbmcubnMsIGJpbmRpbmdOcyApLCBuc1Byb3BlcnR5ICk7CgkJLy9zaGFyZWQgZGF0YQoJCXRoaXMudGV4dCA9IHN1YnNjcmlwdGlvblRleHQ7CgkJdGhpcy5lbGVtID0gcGFyZW50QmluZGluZy5lbGVtOwoJCS8vdGhpcyBpcyBhIHNpbmdsZXRvbgoJCS8vdGhpcy5zdWJzY3JpcHRpb25zID0gcGFyZW50QmluZGluZy5zdWJzY3JpcHRpb25zOwoKCQlpZiAocGFyZW50QmluZGluZy5jb250ZXh0KSB7CgoJCQl0aGlzLmNvbnRleHQgPSBwYXJlbnRCaW5kaW5nLmNvbnRleHQ7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmNvbnRleHQgPSB0aGlzOwoJCQl0aGlzLmR5bmFtaWNCaW5kaW5ncyA9IFtdOwoJCQl0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTsKCQkJJCggdGhpcy5lbGVtICkuaG1EYXRhKCAibnMiLCB0aGlzLm5zICk7CgkJfQoKCQl0aGlzLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoIHBhcmVudEJpbmRpbmcub3B0aW9ucywgYmluZGluZ09wdGlvbnMgKTsKCgkJdGhpcy5faW1wb3J0QmluZGluZ3MoKTsKCQl0aGlzLl9pbXBvcnRTdWJzY3JpcHRpb25zKCAic3ViIiApOwoJCXRoaXMuX2ltcG9ydFN1YnNjcmlwdGlvbnMoICJwdWIiICk7CgoJfQoKCUJpbmRpbmcucHJvdG90eXBlID0gewoKCQlfaW1wb3J0QmluZGluZ3M6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQliaW5kaW5nTmFtZSwKCQkJCXdlbGxrbm93bkJpbmRpbmcsCgkJCQliaW5kaW5nLAoJCQkJc3ViVGV4dFBhcnRzLAoJCQkJYmluZGluZ05zLAoJCQkJYmluZGluZ09wdGlvbnMsCgkJCQliaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CgoJCQlmb3IgKGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKCgkJCQliaW5kaW5nID0gYmluZGluZ3NbaV07CgkJCQliaW5kaW5nTmFtZSA9IGJpbmRpbmcuYmluZGluZ05hbWU7CgoJCQkJLy9pZiB2YWx1ZSBpcyAicGF0aHxvcHRpb24xfG9wdGlvbjIiCgkJCQkvLwoJCQkJc3ViVGV4dFBhcnRzID0gckJpbmRpbmdUZXh0LmV4ZWMoIGJpbmRpbmcudmFsdWUgKTsKCQkJCWJpbmRpbmdOcyA9IHN1YlRleHRQYXJ0c1sxXTsgLy8gInBhdGgiCgkJCQliaW5kaW5nT3B0aW9ucyA9IHN1YlRleHRQYXJ0c1szXTsgLy8ib3B0aW9uMXxvcHRpb24yIgoKCQkJCXdlbGxrbm93bkJpbmRpbmcgPSBfYmluZGluZ3NbYmluZGluZ05hbWVdOwoKCQkJCWlmIChpc0Z1bmN0aW9uKCB3ZWxsa25vd25CaW5kaW5nICkpIHsKCgkJCQkJdmFyIHRlbXAgPSBbCgkJCQkJCXdlbGxrbm93bkJpbmRpbmcsCgkJCQkJCXRoaXMuZWxlbSwKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBiaW5kaW5nTnMgKSwKCQkJCQkJdGhpcywKCQkJCQkJbWVyZ2VPcHRpb25zKCB0aGlzLm9wdGlvbnMsIGJpbmRpbmdPcHRpb25zICkKCQkJCQldOwoKCQkJCQlpZiAoYmluZGluZ05hbWUgPT0gInJ1bkZpcnN0IikgewoKCQkJCQkJdGhpcy5jb250ZXh0LnJ1bkZpcnN0ID0gdGVtcDsKCgkJCQkJfSBlbHNlIGlmIChiaW5kaW5nTmFtZSA9PSAicnVuTGFzdCIpIHsKCgkJCQkJCXRoaXMuY29udGV4dC5ydW5MYXN0ID0gdGVtcDsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXRoaXMuY29udGV4dC5keW5hbWljQmluZGluZ3MucHVzaCggdGVtcCApOwoJCQkJCX0KCgkJCQl9IGVsc2UgaWYgKGlzU3RyaW5nKCB3ZWxsa25vd25CaW5kaW5nICkpIHsKCgkJCQkJLy9yZWN1cnNpdmVseSBpbXBvcnQgcmVmZXJlbmNlZEJpbmRpbmcKCQkJCQluZXcgQmluZGluZyggd2VsbGtub3duQmluZGluZywgdGhpcywgYmluZGluZ05zLCBiaW5kaW5nT3B0aW9ucyApOwoKCQkJCX0KCQkJfQoJCX0sCgoJCS8vc3Vic2NyaXB0aW9uVHlwZSBpcyBlaXRoZXIgInB1YiIgb3IgInN1YiIKCQlfaW1wb3J0U3Vic2NyaXB0aW9uczogZnVuY3Rpb24oIHN1YnNjcmlwdGlvblR5cGUgKSB7CgoJCQl2YXIgaSwKCQkJCXN1YnNjcmlwdGlvbkVudHJ5LAoJCQkJc3Vic2NyaXB0aW9uUGFydHMsCgkJCQlwdWJsaXNoZXIsCgkJCQlldmVudFR5cGVzLAoJCQkJc3Vic2NyaWJlciwKCQkJCXN1YnNjcmlwdGlvbkVudHJpZXMgPSB0aGlzW3N1YnNjcmlwdGlvblR5cGVdOwoKCQkJZm9yIChpID0gMDsgaSA8IHN1YnNjcmlwdGlvbkVudHJpZXMubGVuZ3RoOyBpKyspIHsKCgkJCQlzdWJzY3JpcHRpb25FbnRyeSA9IHN1YnNjcmlwdGlvbkVudHJpZXNbaV07CgkJCQlldmVudFR5cGVzID0gc3Vic2NyaXB0aW9uRW50cnkuZXZlbnRUeXBlczsKCgkJCQlzdWJzY3JpcHRpb25QYXJ0cyA9IHN1YnNjcmlwdGlvbkVudHJ5LnZhbHVlLnNwbGl0KCByU3Vic2NyaXB0aW9uVmFsdWVTZXBhcmF0b3IgKTsKCgkJCQlpZiAoc3Vic2NyaXB0aW9uVHlwZSA9PSAic3ViIikgewoKCQkJCQkvL3BhdGh8aGFuZGxlcnxvcHRpb25zfGRlbGVnYXRlCgkJCQkJcHVibGlzaGVyID0gc3Vic2NyaXB0aW9uUGFydHNbMF07CgoJCQkJCXB1Ymxpc2hlciA9IHB1Ymxpc2hlci5zdGFydHNXaXRoKCAiJCIgKSA/CgkJCQkJCXB1Ymxpc2hlciA6IC8vcHVibGlzaGVyIGlzIGEgdmlldwoJCQkJCQltZXJnZVBhdGgoIHRoaXMubnMsIHB1Ymxpc2hlciApOwoKCQkJCQlzdWJzY3JpYmVyID0gdGhpcy5lbGVtOwoKCQkJCX0gZWxzZSB7CgkJCQkJLy9wYXRofGhhbmRsZXJ8b3B0aW9uc3xkZWxlZ2F0ZQoJCQkJCXB1Ymxpc2hlciA9IHRoaXMuZWxlbTsKCgkJCQkJc3Vic2NyaWJlciA9IHN1YnNjcmlwdGlvblBhcnRzWzBdOwoJCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpYmVyLnN0YXJ0c1dpdGgoICIkIiApID8KCQkJCQkJc3Vic2NyaWJlciA6IC8vc3Vic2NyaWJlciBpcyBhIHZpZXcKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBzdWJzY3JpYmVyICk7CgkJCQl9CgoJCQkJdGhpcy5hcHBlbmRTdWIoCgkJCQkJc3Vic2NyaWJlciwKCQkJCQlwdWJsaXNoZXIsCgkJCQkJZXZlbnRUeXBlcywKCQkJCQlzdWJzY3JpcHRpb25QYXJ0c1sxXSwgLy9oYW5kbGVyCgkJCQkJdG9UeXBlZFZhbHVlKCBtZXJnZU9wdGlvbnMoIHRoaXMub3B0aW9ucywgc3Vic2NyaXB0aW9uUGFydHNbMl0gKSApLCAvL29wdGlvbnMKCQkJCQlzdWJzY3JpcHRpb25QYXJ0c1szXSAvL2RlbGVnYXRlCgkJCQkpOwoJCQl9CgoJCX0sCgoJCWFwcGVuZFN1YjogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCXRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zLnB1c2goIHsKCQkJCXB1Ymxpc2hlcjogcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlczogZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXI6IHN1YnNjcmliZXIsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJb3B0aW9uczogb3B0aW9ucywKCQkJCWRlbGVnYXRlOiBkZWxlZ2F0ZQoJCQl9ICk7CgkJfSwKCgkJcHJlcGVuZFN1YjogZnVuY3Rpb24gcHJlcGVuZFN1Yiggc3Vic2NyaWJlciwgcHVibGlzaGVyLCBldmVudFR5cGVzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJdGhpcy5jb250ZXh0LnN1YnNjcmlwdGlvbnMudW5zaGlmdCggewoJCQkJcHVibGlzaGVyOiBwdWJsaXNoZXIsCgkJCQlldmVudFR5cGVzOiBldmVudFR5cGVzLAoJCQkJc3Vic2NyaWJlcjogc3Vic2NyaWJlciwKCQkJCWhhbmRsZXI6IGhhbmRsZXIsCgkJCQlvcHRpb25zOiBvcHRpb25zLAoJCQkJZGVsZWdhdGU6IGRlbGVnYXRlCgkJCX0gKTsKCQl9LAoKCQljbGVhclN1YnM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmNvbnRleHQuc3Vic2NyaXB0aW9ucy5zcGxpY2UoIDAsIHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGggKTsKCQl9Cgl9OwoKCWZ1bmN0aW9uIHBhcnNlU3VicyggZWxlbSApIHsKCgkJdmFyIHN1YnNjcmlwdGlvblRleHQsCgkJCWNvbnRleHQsCgkJCXN1YnNjcmlwdGlvbnMsCgkJCWksCgkJCXN1YnNjcmlwdGlvbiwKCQkJJGVsZW0gPSAkKCBlbGVtICk7CgoJCWlmICghJGVsZW0uaG1EYXRhKCAicGFyc2VkIiApICYmIChzdWJzY3JpcHRpb25UZXh0ID0gZXh0cmFjdFN1YnNjcmlwdGlvblRleHQoIGVsZW0gKSkpIHsKCgkJCWNvbnRleHQgPSBuZXcgQmluZGluZyggZWxlbSwgc3Vic2NyaXB0aW9uVGV4dCApOwoJCQlzdWJzY3JpcHRpb25zID0gY29udGV4dC5zdWJzY3JpcHRpb25zOwoKCQkJdmFyIHJ1bkZpcnN0ID0gY29udGV4dC5ydW5GaXJzdDsKCQkJaWYgKHJ1bkZpcnN0KSB7CgkJCQlydW5GaXJzdFswXSggcnVuRmlyc3RbMV0sIHJ1bkZpcnN0WzJdLCBydW5GaXJzdFszXSwgcnVuRmlyc3RbNF0gKTsKCQkJfQoKCQkJdmFyIGR5bmFtaWNCaW5kaW5ncyA9IGNvbnRleHQuZHluYW1pY0JpbmRpbmdzOwoJCQlmb3IgKGkgPSAwOyBpIDwgZHluYW1pY0JpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgZHluYW1pY0JpbmRpbmcgPSBkeW5hbWljQmluZGluZ3NbaV07CgkJCQlkeW5hbWljQmluZGluZ1swXSggZHluYW1pY0JpbmRpbmdbMV0sIGR5bmFtaWNCaW5kaW5nWzJdLCBkeW5hbWljQmluZGluZ1szXSwgZHluYW1pY0JpbmRpbmdbNF0gKTsKCQkJfQoKCQkJdmFyIHJ1bkxhc3QgPSBjb250ZXh0LnJ1bkxhc3Q7CgkJCWlmIChydW5MYXN0KSB7CgkJCQlydW5MYXN0WzBdKCBydW5MYXN0WzFdLCBydW5MYXN0WzJdLCBydW5MYXN0WzNdLCBydW5MYXN0WzRdICk7CgkJCX0KCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7CgoJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc1tpXTsKCQkJCWhtLnN1YigKCQkJCQlzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwKCQkJCQlzdWJzY3JpcHRpb24ucHVibGlzaGVyLAoJCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLAoJCQkJCXN1YnNjcmlwdGlvbi5oYW5kbGVyLAoJCQkJCXN1YnNjcmlwdGlvbi5vcHRpb25zLAoJCQkJCXN1YnNjcmlwdGlvbi5kZWxlZ2F0ZQoJCQkJKTsKCQkJfQoKCgkJCS8vCgkJCSRlbGVtLmhtRGF0YSggInBhcnNlZCIsIHRydWUgKTsKCQl9CgoJCSRlbGVtLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX0KCgkvL2RlbGF5IGF1dG8gcGFyc2UgdG8gd2F5IGZvciBzb21lIGRlcGVuZGVuY2llcyB0byByZXNvbHZlIGFzeW5jaHJvbm91c2x5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkKCBmdW5jdGlvbigpIHsKCQkJaWYgKGRlZmF1bHRPcHRpb25zLmF1dG9QYXJzZSkgewoJCQkJcGFyc2VTdWJzKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCQkJfQoJCX0gKTsKCX0sIDEgKTsKCgkkZm4ucGFyc2VTdWJzID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX07CgoJdmFyIGxvZ01vZGVsID0gaG0oICIqbG9nIiwgW10gKTsKCgl2YXIgX2JpbmRpbmdzID0ge307CgoJZnVuY3Rpb24gYmluZGluZ3MoIG5hbWUsIGRlZmluaXRpb24sIGlzVGFnICkgewoJCWlmICghbmFtZSkgewoJCQlyZXR1cm4gX2JpbmRpbmdzOwoJCX0KCgkJaWYgKCFkZWZpbml0aW9uKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQliaW5kaW5ncygga2V5LCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBfYmluZGluZ3NbbmFtZV07CgkJCX0KCQl9CgoJCWlmIChpc0FycmF5KCBkZWZpbml0aW9uICkpIHsKCQkJZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uY29uY2F0KCAiOyIgKTsKCQl9CgoJCV9iaW5kaW5nc1tpc1RhZyA/ICJ0YWdfIiArIG5hbWUudG9VcHBlckNhc2UoKSA6IG5hbWVdID0gZGVmaW5pdGlvbjsKCQlyZXR1cm4gdGhpczsKCX0KCglleHRlbmQoIGhtLCB7CgoJCWJpbmRpbmc6IGJpbmRpbmdzLAoKCgkJbG9nOiBmdW5jdGlvbiggbWVzc2FnZSwgY29sb3IgKSB7CgkJCW1lc3NhZ2UgPSBtZXNzYWdlICsgIiI7CgkJCW1lc3NhZ2UgPSBjb2xvciA/ICI8ZGl2IHN0eWxlPSdjb2xvcjoiICsgY29sb3IgKyAiJz4iICsgbWVzc2FnZSArICI8L2Rpdj4gIiA6IG1lc3NhZ2U7CgkJCWxvZ01vZGVsLnB1c2goIG1lc3NhZ2UgKTsKCQl9LAoKCQljbGVhcmxvZzogZnVuY3Rpb24oKSB7CgkJCWxvZ01vZGVsLmNsZWFyKCk7CgkJfQoJfSApOwoKCWZ1bmN0aW9uIGFkaG9jQmluZGluZyggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQlyb290Tm9kZS5nZXQoIHBhdGgsIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKTsKCX0KCgliaW5kaW5ncyggInJ1bkZpcnN0IiwgYWRob2NCaW5kaW5nICk7CgliaW5kaW5ncyggInJ1bkxhc3QiLCBhZGhvY0JpbmRpbmcgKTsKCgoJLy9zdGFydCBvZiBsb2FkZXIgY29yZS5qcwoJdmFyIHVybFN0b3JlID0ge30sCgkJcHJvbWlzZVN0b3JlID0ge30sCgkJZGVwZW5kZW5jeVN0b3JlID0ge30sCgkJbG9hZGVyRGVmaW5pdGlvblN0b3JlID0ge30sCgkJbG9hZGVyU3RvcmUgPSB7fSwKCQlkdW1teUxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQlyQ29tbWEgPSAvLC8sCgkJclNwYWNlID0gL1xzKy9nLAoJCXJRdWVyeSA9IC9cPy8sCgkJckZpbGVFeHQgPSAvXC4oXHcrKSQvLAoJCXJGaWxlTmFtZSA9IC8oLispXC5cdyskLywKCQlmaWxlRXh0ZW5zaW9uLAoJCWZpbGVOYW1lLAoJCWNvbW1vbkxvYWRlck1ldGhvZHMsCgkJY29tbW9uTG9hZEZpbHRlcnMsCgkJZGVwZW5kLAoJLy9tYXRjaCAiaHR0cDovL2RvbWFpbi5jb20iICwgIi9qa2oiCgkJckFic29sdXRlVXJsID0gL15odHRwW3NdPzpcL1wvfF5cLy8sCgkJclVybFBhcnRzID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKSk/KT8vLAoJCWFqYXhMb2NQYXJ0cyA9IHJVcmxQYXJ0cy5leGVjKCBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkgKSB8fCBbXSwKCQloYXNoVmFsdWUgPSAiIiwKCQloYXNoS2V5ID0gInYiLAoJCXJWZXJzaW9uSGFzaCwKCQlsb2FkQ2FsbGJhY2tzID0gW10sCgkJZmFpbENhbGxiYWNrcyA9IFtdLAoJCXVubG9hZENhbGxiYWNrcyA9IFtdLAoKCQlsb2FkZXJGaW5kZXJzLAoJCWZpbGVFeHRUb0xvYWRlck1hcHBlciA9IHt9LAoJCWJhc2VVcmwgPSAiIiwKCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZyBvdmVybG9hZGluZwoJLy9obS5sb2FkZXIoImFwcCIpOyAvL3JldHJpZXZlIGxvYWRlcgoJLy9obS5sb2FkZXIoImFwcCIsIGRlZmluaXRpb24pOyAvL2NyZWF0ZSBhIGxvYWRlciBmcm9tIHNjcmF0Y2gKCS8vaG0ubG9hZGVyKCJhcHAiLCAianMiLCBkZWZpbml0aW9uKTsgLy9jcmVhdGUgYSBsb2FkZXIgYnkgZXh0ZW5kaW5nIGEgbmV3IGxvYWRlcgoJCV9sb2FkZXIgPSBobS5sb2FkZXIgPSBmdW5jdGlvbiggbG9hZGVyTmFtZSwgYmFzZUxvYWRlck5hbWUsIGxvYWRlckRlZmluaXRpb24gKSB7CgoKCQkJLy9yZXRyaWV2ZSB0aGUgbG9hZGVyIGJ5IG5hbWUKCQkJaWYgKGlzVW5kZWZpbmVkKCBiYXNlTG9hZGVyTmFtZSApKSB7CgoJCQkJcmV0dXJuIGxvYWRlck5hbWUgPyBsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA6IGxvYWRlclN0b3JlOwoKCQkJfQoKCQkJLy9jcmVhdGUgYSBuZXcgbG9hZGVyCgkJCWlmICghaXNTdHJpbmcoIGJhc2VMb2FkZXJOYW1lICkpIHsKCQkJCWxvYWRlckRlZmluaXRpb24gPSBiYXNlTG9hZGVyTmFtZTsKCQkJCWJhc2VMb2FkZXJOYW1lID0gbnVsbDsKCQkJfQoKCQkJbG9hZGVyRGVmaW5pdGlvbiA9IGxvYWRlckRlZmluaXRpb25TdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKAoJCQkJdHJ1ZSwKCQkJCXt9LAoJCQkJbG9hZGVyRGVmaW5pdGlvblN0b3JlW2Jhc2VMb2FkZXJOYW1lXSwKCQkJCWxvYWRlckRlZmluaXRpb24gKTsKCgkJCXZhciBsb2FkZXIgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGxvYWRlckRlZmluaXRpb24gKTsKCgkJCSQuZWFjaCggImxvYWQsdW5sb2FkLHVybCxkZXBlbmQiLnNwbGl0KCAiLCIgKSwgZnVuY3Rpb24oIGluZGV4LCBtZXRob2ROYW1lICkgewoJCQkJdmFyIGNvbW1vbk1ldGhvZE5hbWUgPSBsb2FkZXJbbWV0aG9kTmFtZV07CgkJCQlpZiAoaXNTdHJpbmcoIGNvbW1vbk1ldGhvZE5hbWUgKSkgewoJCQkJCXZhciBsb2FkZXJNZXRob2QgPSBjb21tb25Mb2FkZXJNZXRob2RzW21ldGhvZE5hbWVdW2NvbW1vbk1ldGhvZE5hbWVdOwoJCQkJCWlmIChsb2FkZXJNZXRob2QpIHsKCQkJCQkJbG9hZGVyW21ldGhvZE5hbWVdID0gbG9hZGVyTWV0aG9kOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoKCQkJaWYgKCQuaXNQbGFpbk9iamVjdCggbG9hZGVyLmxvYWQgKSkgewoJCQkJLy9pdCBpcyBhIHBpcGVsaW5lLCBidXQgbm90IGEgZnVuY3Rpb24KCQkJCWxvYWRlci5sb2FkID0gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkZXIubG9hZCApOwoKCQkJfQoKCQkJaWYgKCEkLmlzRnVuY3Rpb24oIGxvYWRlci5sb2FkICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIGxvYWQgZnVuY3Rpb24gZnJvbSBsb2FkZXIiOwoJCQl9CgoJCQlsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKCB7fSwgbG9hZGVyU3RvcmVbYmFzZUxvYWRlck5hbWVdLCBsb2FkZXIgKTsKCQl9OwoKCWZ1bmN0aW9uIGludm9rZUNhbGxiYWNrcyggY2FsbGJhY2tzICkgewoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKCQkJCWNhbGxiYWNrc1tpXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9OwoJfQoKCXZhciBpbnZva2VGYWlsQ2FsbGJhY2tzID0gaW52b2tlQ2FsbGJhY2tzKCBmYWlsQ2FsbGJhY2tzICksCgkJaW52b2tlTG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggbG9hZENhbGxiYWNrcyApLAoJCWludm9rZVVubG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggdW5sb2FkQ2FsbGJhY2tzICk7CgoJZnVuY3Rpb24gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgoJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoKCQkJaWYgKGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIpIHsKCQkJCXZhciBpID0gMSwKCQkJCQlrZXlzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoKCQkJCS8vY3JlYXRlIGRlcGVuZGVuY3kgaW4gb3JkZXIKCQkJCXdoaWxlIChpIDwga2V5cy5sZW5ndGgpIHsKCQkJCQlkZXBlbmQoIGtleXNbaV0sIGtleXNbaSAtIDFdICk7CgkJCQkJaSsrOwoJCQkJfQoJCQkJYXNzZXRJZHMgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV07CgkJCX0KCgkJCXJldHVybiBsb2FkQXNzZXRzSW5QYXJhbGxlbCggYXNzZXRJZHMgKTsKCgkJfSBlbHNlIGlmIChpc0FycmF5KCBhc3NldElkcyApKSB7CgoJCQkvL2lmIGl0IGlzIGFzc2V0SWRBcnJheSwgbG9hZCBvbmUgYWZ0ZXIgcHJldmlvdXMgaXMgZnVsbHkgbG9hZGVkCgkJCXJldHVybiBsb2FkQXNzZXRzSW5TZXJpYWwoIGFzc2V0SWRzICk7CgoJCX0KCQl0aHJvdyAicmVzb3VyY2UgcGFyYW1ldGVyIHNob3VsZCBiZSBhbiBhcnJheSBvciBzdHJpbmciOwoJfQoKCS8vcmVzb3VyY2VTdHJpbmcgaXMgbGlrZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCWZ1bmN0aW9uIGxvYWRBc3NldHNJblBhcmFsbGVsKCBhc3NldElkU3RyaW5nICkgewoJCXZhciBwcm9taXNlcyA9IFtdLAoJCQlydG5Qcm9taXNlLAoJCQlyZXNvdXJjZUFycmF5ID0gc3BsaXRCeUNvbW1hKCBhc3NldElkU3RyaW5nICk7CgoJCWlmIChyZXNvdXJjZUFycmF5Lmxlbmd0aCA9PT0gMSkgewoJCQlydG5Qcm9taXNlID0gbG9hZFN0YW5kYWxvbmVBc3NldCggcmVzb3VyY2VBcnJheVswXSApOwoJCX0KCQllbHNlIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvdXJjZUFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCQlwcm9taXNlcy5wdXNoKCBsb2FkU3RhbmRhbG9uZUFzc2V0KCByZXNvdXJjZUFycmF5W2ldICkgKTsKCQkJfQoJCQlydG5Qcm9taXNlID0gJC53aGVuLmFwcGx5KCAkLCBwcm9taXNlcyApOwoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICkuZmFpbCggZnVuY3Rpb24oKSB7CgkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkU3RyaW5nICk7CgkJfSApOwoJfQoKCS8vcmVzb3VyY2VzIGNhbiBiZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCS8vaXQgY2FuIGJlIFsiYS5qcyIsICJiLmNzcyIsICJjLnRtcGwiXQoJLy9vciBbImEuanMsYi5jc3MiLCBbImMudG1wbCIsICJkLnRtcGwiXSwgImUuY3NzIl0gYW5kIHNvIG9uCgkvL2l0IHNlcmlhbCBsb2FkIHRoZSB0b3AgbGV2ZWwgcmVzb3VyY2UgdW5pdCwgd2l0aGluIGVhY2ggcmVzb3VyY2UgdW5pdCwgdXNlIHNtYXJ0CgkvL2xvYWRlcgoJZnVuY3Rpb24gbG9hZEFzc2V0c0luU2VyaWFsKCBhc3NldElkQXJyYXkgKSB7CgkJdmFyIHJ0blByb21pc2UsCgkJCWksCgkJCXRvUmVsZWFzZVJlc291cmNlID0gW10sCgkJCWN1cnJlbnRSZXNvdXJjZVN0cmluZ09yQXJyYXksCgkJCXNoYXJlZFN0YXRlID0gewoJCQkJb2s6IHRydWUKCQkJfTsKCgkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRBcnJheS5sZW5ndGg7IGkrKykgewoJCQljdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ID0gYXNzZXRJZEFycmF5W2ldOwoJCQl0b1JlbGVhc2VSZXNvdXJjZS5wdXNoKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICk7CgoJCQlpZiAoaSA9PT0gMCkgewoKCQkJCXJ0blByb21pc2UgPSBsb2FkQXNzZXRzKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICkKCQkJCQkuZmFpbCggbWFrZVJlbGVhc2VGbiggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSwgc2hhcmVkU3RhdGUgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlydG5Qcm9taXNlID0gcnRuUHJvbWlzZS5uZXh0TG9hZCggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSApCgkJCQkJLmZhaWwoIG1ha2VSZWxlYXNlRm4oIHRvUmVsZWFzZVJlc291cmNlLnNsaWNlKCksIHNoYXJlZFN0YXRlICkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICk7Cgl9CgoJZnVuY3Rpb24gbWFrZVJlbGVhc2VGbiggcmVzb3VyY2VTdHJpbmdPckFycmF5LCBzaGFyZWRTdGF0ZSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCWlmIChzaGFyZWRTdGF0ZS5vaykgewoJCQkJX2xvYWRlci51bmxvYWQoIHJlc291cmNlU3RyaW5nT3JBcnJheSApOwoJCQkJc2hhcmVkU3RhdGUub2sgPSBmYWxzZTsKCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldCggYXNzZXRJZCApIHsKCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoJCWlmIChsb2FkZXIpIHsKCgkJCXJldHVybiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICk7CgoJCX0gZWxzZSB7CgoKCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggZmlsZUV4dGVuc2lvbiggYXNzZXRJZCApICsgIi5sb2FkZXIiICkubmV4dExvYWQoIGFzc2V0SWQgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldFdpdGhMb2FkZXIoIGFzc2V0SWQsIGxvYWRlciApIHsKCgoJCXZhciBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQlpZiAoIXByb21pc2UpIHsKCgoJCQlwcm9taXNlID0gbG9hZGVyLmxvYWQoIGFzc2V0SWQgKTsKCgkJCWlmICghbG9hZGVyLm5vUmVmQ291bnQpIHsKCQkJCS8vYWRkIHRoZSBwcm9taXNlIHRvIGNhY2hlLAoJCQkJLy9pbiB0aGUgZnV0dXJlLCBpdCBjYW4gYmUgcmV0cmlldmVkIGJ5IGFjY2Vzc1Byb21pc2UoYXNzZXRJZCkKCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKTsKCQkJfQoJCX0KCgkJLy9wcmVsb2FkIGFzc2V0IHdpbGwgbmV2ZXIgYmUgY291bnRlZCBmb3IgcmVmZXJlbmNlCgkJLy9hcyB3ZSBkb24ndCB3YW50IHRoYXQgdG8gYmUgdW5sb2FkZWQKCQlpZiAocHJvbWlzZS5yZWZDb3VudCAhPT0gInN0YXRpY0xvYWRlZCIpIHsKCQkJcHJvbWlzZS5yZWZDb3VudCA9IHByb21pc2UucmVmQ291bnQgPyBwcm9taXNlLnJlZkNvdW50ICsgMSA6IDE7CgkJfQoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vcmV0cmlldmUgcHJvbWlzZSBieSBhc3NldElkIG9yCgkvL3NldCBwcm9taXNlIGJ5IGFzc2V0SWQKCWZ1bmN0aW9uIGFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKSB7CgkJaWYgKGFzc2V0SWQgPT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gcHJvbWlzZVN0b3JlOwoJCX0gZWxzZSB7CgkJCWlmIChwcm9taXNlID09PSB1bmRlZmluZWQpIHsKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkJCQkJcmV0dXJuIHByb21pc2VTdG9yZVthc3NldElkXTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVsZXRlIHByb21pc2VTdG9yZVthc3NldElkXTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXByb21pc2VTdG9yZVthc3NldElkXSA9IHByb21pc2U7CgkJCQlyZXR1cm4gcHJvbWlzZTsKCQkJfQoJCX0KCX0KCgkvL2FkZCBhIHByb21pc2UubmV4dExvYWQgbWV0aG9kIGR5bmFtaWNhbGx5LCBzbyB0aGF0IGl0IGNhbgoJLy9iZSB1c2VkIGxvYWQgb3RoZXIgYXNzZXQgd2hlbiBjdXJyZW50IHByb21pc2UgZmluaXNoZWQKCS8vdGhlIG5leHRMb2FkIG1ldGhvZCBpcyBhIHNtYXJ0TG9hZCBtZXRob2QsIHVzZSB0aGUgc2FtZSB3YXkgaW4gd2hpY2gKCS8veW91IGNhbGwgbG9hZGVyCglmdW5jdGlvbiBhdWdtZW50UHJvbWlzZSggcHJvbWlzZSApIHsKCQl2YXIgbmV4dERlZmVyID0gJC5EZWZlcnJlZCgpOwoKCQkvL25leHRMb2FkIG1ldGhvZCBsb2FkIGFmdGVyIHRoZSBjdXJyZW50IGN1cnJlbnRQcm9taXNlIGlzIGRvbmUKCQlwcm9taXNlLm5leHRMb2FkID0gZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciBuZXh0TG9hZEFyZ3VtZW50cyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoJCQlwcm9taXNlLnRoZW4oCgkJCQlmdW5jdGlvbigpIHsKCQkJCQlfbG9hZGVyLmxvYWQuYXBwbHkoIG51bGwsIG5leHRMb2FkQXJndW1lbnRzICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQluZXh0RGVmZXIucmVzb2x2ZS5hcHBseSggbmV4dERlZmVyLCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCW5leHREZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCQkJfSApOwoJCQkJfSwKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCW5leHREZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCX0gKTsKCgkJCXJldHVybiBhdWdtZW50UHJvbWlzZSggbmV4dERlZmVyLnByb21pc2UoKSApOwoJCX07CgoJCXByb21pc2UuYW5kTG9hZCA9IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudFByb21pc2UgPSBfbG9hZGVyLmFwcGx5KCBudWxsLCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCAkLndoZW4oIGN1cnJlbnRQcm9taXNlLCBwcm9taXNlICkgKTsKCQl9OwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCglmdW5jdGlvbiBzcGxpdEJ5Q29tbWEoIHRleHQgKSB7CgkJcmV0dXJuIHRleHQucmVwbGFjZSggclNwYWNlLCAiIiApLnNwbGl0KCByQ29tbWEgKTsKCX0KCglmdW5jdGlvbiBpc0Nyb3NzRG9tYWluKCB1cmwgKSB7CgkJdmFyIHBhcnRzID0gclVybFBhcnRzLmV4ZWMoIHVybC50b0xvd2VyQ2FzZSgpICk7CgkJcmV0dXJuICEhKCBwYXJ0cyAmJgoJCSAgICAgICAgICAgKCBwYXJ0c1sgMSBdICE9IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT0gYWpheExvY1BhcnRzWyAyIF0gfHwKCQkgICAgICAgICAgICAgKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSAhPQoJCSAgICAgICAgICAgICAoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgKQoJCQkpOwoJfQoKCWZ1bmN0aW9uIGZ1bGxVcmwoIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgewoKCQlkdW1teUxpbmsuaHJlZiA9IHJBYnNvbHV0ZVVybC50ZXN0KCB1cmxSZWxhdGl2ZVRvQmFzZVVybCApID8gdXJsUmVsYXRpdmVUb0Jhc2VVcmwgOgoJCQliYXNlVXJsICsgdXJsUmVsYXRpdmVUb0Jhc2VVcmw7CgoJCXJldHVybiBpc0Nyb3NzRG9tYWluKCB1cmxSZWxhdGl2ZVRvQmFzZVVybCApID8gZHVtbXlMaW5rLmhyZWYgOiBhZGRIYXNoKCBkdW1teUxpbmsuaHJlZiApOwoJfQoKCWZ1bmN0aW9uIGNvbnZlcnRMb2FkRmlsdGVyc1RvTG9hZE1ldGhvZCggbG9hZEZpbHRlcnMgKSB7CgoJCWZvciAodmFyIGtleSBpbiBsb2FkRmlsdGVycykgewoJCQlhdHRhY2hGaWx0ZXIoIGxvYWRGaWx0ZXJzLCBrZXkgKTsKCQl9CgoJCXZhciBzdGF0aWNMb2FkZWQgPSBsb2FkRmlsdGVycy5zdGF0aWNMb2FkZWQgfHwgY29tbW9uTG9hZEZpbHRlcnMuc3RhdGljTG9hZGVkLnJldHVybkZhbHNlLAoJCQlnZXRTb3VyY2UgPSBsb2FkRmlsdGVycy5nZXRTb3VyY2UgfHwgY29tbW9uTG9hZEZpbHRlcnMuZ2V0U291cmNlLmdldFRleHRCeUFqYXgsCgkJCWNvbXBpbGUgPSBsb2FkRmlsdGVycy5jb21waWxlID09PSB1bmRlZmluZWQgPyBjb21tb25Mb2FkRmlsdGVycy5jb21waWxlLmdsb2JhbEV2YWwgOiBsb2FkRmlsdGVycy5jb21waWxlLAoJCQljcm9zc1NpdGVMb2FkID0gbG9hZEZpbHRlcnMuY3Jvc3NTaXRlTG9hZCB8fCBjb21tb25Mb2FkRmlsdGVycy5jcm9zc1NpdGVMb2FkLmdldFNjcmlwdCwKCQkJYnVpbGREZXBlbmRlbmNpZXMgPSBsb2FkRmlsdGVycy5idWlsZERlcGVuZGVuY2llcyB8fCBjb21tb25Mb2FkRmlsdGVycy5idWlsZERlcGVuZGVuY2llcy5wYXJzZURlcGVuZFRhZywKCQkJYnVpbGRVbmxvYWQgPSBsb2FkRmlsdGVycy5idWlsZFVubG9hZCB8fCBjb21tb25Mb2FkRmlsdGVycy5idWlsZFVubG9hZC5wYXJzZVVubG9hZFRhZzsKCgkJaWYgKCFjb21waWxlICYmICFjcm9zc1NpdGVMb2FkKSB7CgkJCXRocm93ICJsb2FkZXIgbXVzdCBpbXBsZW1lbnQgYXQgbGVhc3Qgb25lIG9mIGNvbXBpbGUsIGNyb3NzU2l0ZUxvYWQiOwoJCX0KCgkJcmV0dXJuIGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJdXJsOwoKCQkJaWYgKHN0YXRpY0xvYWRlZCggYXNzZXRJZCApKSB7CgoJCQkJcHJvbWlzZS5yZWZDb3VudCA9ICJzdGF0aWNMb2FkZWQiOwoJCQkJZGVmZXIucmVzb2x2ZSgpOwoKCQkJfSBlbHNlIHsKCQkJCXVybCA9IF9sb2FkZXIudXJsKCBhc3NldElkICk7CgkJCQlpZiAoIWNvbXBpbGUgfHwgbG9hZEZpbHRlcnMuYnlQYXNzR2V0U291cmNlIHx8IGlzQ3Jvc3NEb21haW4oIHVybCApKSB7CgoJCQkJCWlmICghY3Jvc3NTaXRlTG9hZCkgewoJCQkJCQl0aHJvdyAibG9hZGVyIGRvZXMgbm90IHN1cHBvcnQgY3Jvc3MgZG9tYWluIGxvYWRpbmciOwoJCQkJCX0KCgkJCQkJcmV0dXJuIGNyb3NzU2l0ZUxvYWQoIGFzc2V0SWQgKTsKCgkJCQl9IGVsc2UgewoKCgkJCQkJZ2V0U291cmNlKCBhc3NldElkICkudGhlbigKCQkJCQkJZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgoKCQkJCQkJCWlmIChidWlsZFVubG9hZCkgewoKCgkJCQkJCQkJdmFyIHVubG9hZCA9IGJ1aWxkVW5sb2FkKCBzb3VyY2VDb2RlLCBhc3NldElkICk7CgoJCQkJCQkJCWlmICh1bmxvYWQpIHsKCgkJCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKS51bmxvYWQgPSB1bmxvYWQ7CgkJCQkJCQkJfQoKCQkJCQkJCX0KCgkJCQkJCQlpZiAoYnVpbGREZXBlbmRlbmNpZXMpIHsKCgoJCQkJCQkJCXZhciBlbWJlZGRlZERlcGVuZGVuY2llcyA9IGJ1aWxkRGVwZW5kZW5jaWVzKCBhc3NldElkLCBzb3VyY2VDb2RlICk7CgkJCQkJCQkJaWYgKGVtYmVkZGVkRGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJCWRlcGVuZCggYXNzZXRJZCwgZW1iZWRkZWREZXBlbmRlbmNpZXMgKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgoJCQkJCQkJdmFyIHJ1bmNvbXBpbGUgPSBmdW5jdGlvbigpIHsKCgoJCQkJCQkJCXZhciByZXN1bHQgPSBjb21waWxlICYmIGNvbXBpbGUoIGFzc2V0SWQsIHNvdXJjZUNvZGUgKTsKCQkJCQkJCQkvL2RlbGF5IGRlZmVyLnJlc29sdmUgYSBmb3Igd2hpbGUgdG8gd2FpdCBmb3IgdGhlIGNvbXBpbGUgcmVzdWx0CgkJCQkJCQkJLy90byB0YWtlIGVmZmVjdCwgaWYgY29tcGlsZSBpcyAkLmdsb2JhbEV2YWwKCQkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJaWYgKCFkZWZlci5kb250UmVzb2x2ZSkgewoJCQkJCQkJCQkJZGVmZXIucmVzb2x2ZSggcmVzdWx0ICk7CgkJCQkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJCQkJfQoJCQkJCQkJCX0sIDUgKTsKCQkJCQkJCX07CgoJCQkJCQkJdmFyIGRlcGVuZGVuY2llcyA9IGRlcGVuZCggYXNzZXRJZCApOwoKCQkJCQkJCS8vbG9hZCBkZXBlbmRlbmNpZXMgYmVjYXVzZSBpdCBjb21iaW5lcyBzdGF0aWMgZGVwZW5kZW50TW9kdWxlU3RyaW5nCgkJCQkJCQkvL2FuZCBkeW5hbWljIGRlcGVuZGVudE1vZHVsZVN0cmluZwoJCQkJCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJCQkJCV9sb2FkZXIubG9hZCggZGVwZW5kZW5jaWVzICkudGhlbiggcnVuY29tcGlsZSwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJCWRlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJCQl9ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJ1bmNvbXBpbGUoKTsKCQkJCQkJCX0KCgkJCQkJCX0sCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJZGVmZXIucmVqZWN0KCBhc3NldElkICk7CgkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJfQoJCQkJCSk7CgkJCQl9CgkJCQlpZiAoIWlzUmVzb2x2ZWQoIGRlZmVyICkpIHsKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHByb21pc2U7CgkJfTsKCX0KCgl2YXIgaXNSZXNvbHZlZCA9ICQuRGVmZXJyZWQoKS5pc1Jlc29sdmVkID8gZnVuY3Rpb24oIHByb21pc2UgKSB7CgkJcmV0dXJuIHByb21pc2UuaXNSZXNvbHZlZCgpOwoJfSA6IGZ1bmN0aW9uKCBwcm9taXNlICkgewoJCXJldHVybiBwcm9taXNlLnN0YXRlKCkgPT0gInJlc29sdmVkIjsKCX07CgoJZnVuY3Rpb24gYWRkSGFzaCggdXJsICkgewoJCXVybCA9IHJlbW92ZUhhc2goIHVybCApOwoJCXJldHVybiBoYXNoVmFsdWUgPwoJCQl1cmwgKyAoIHJRdWVyeS50ZXN0KCB1cmwgKSA/ICImIiA6ICI/IiApICsgaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZSA6CgkJCXVybDsKCX0KCglmdW5jdGlvbiByZW1vdmVIYXNoKCB1cmwgKSB7CgkJaWYgKGhhc2hWYWx1ZSA9PT0gIiIpIHsKCQkJcmV0dXJuIHVybDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHJWZXJzaW9uSGFzaCwgIiIgKTsKCQl9Cgl9CgoJJC5leHRlbmQoIF9sb2FkZXIsIHsKCgkJLy9mb3IgcGFyYWxsZWwgbG9hZGluZwoJCS8vCgkJLy8gbG9hZGVyLmxvYWQoYXNzZXRJZFN0cmluZykKCQkvLyBsb2FkZXIubG9hZChhc3NldElkU3RyaW5nLCB1c2VJbXBsaWNpdERlcGVuZGVuY2llcykKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHksIGFzc2V0SWRTdHJpbmcpCgkJLy8gbG9hZGVyLmxvYWQoaG9sZFJlYWR5LCBhc3NldElkU3RyaW5nLCB1c2VJbXBsaWNpdERlcGVuZGVuY2llcykKCQkvLwoJCS8vZm9yIHNlcmlhbCBsb2FkaW5nIGFuZCBtaXhlZCBzZXJpYWwvcGFyYWxsZWwgbG9hZGluZyBsb2FkZXIKCQkvLwoJCS8vIGxvYWRlci5sb2FkKGFzc2V0SWRBcnJheSkKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHkgYXNzZXRJZEFycmF5KQoJCS8vCgkJbG9hZDogZnVuY3Rpb24oIGhvbGRSZWFkeSwgYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgkJCXZhciBydG5Qcm9taXNlOwoJCQlpZiAoIWlzQm9vbGVhbiggaG9sZFJlYWR5ICkpIHsKCQkJCS8vYnkgZGVmYXVsdCBpdCBpcyBmYWxzZQoJCQkJaW5mZXJEZXBlbmRlbmNpZXNGcm9tSWRPcmRlciA9IGFzc2V0SWRzOwoJCQkJYXNzZXRJZHMgPSBob2xkUmVhZHk7CgkJCQlob2xkUmVhZHkgPSBmYWxzZTsKCQkJfQoJCQlpZiAoIWFzc2V0SWRzKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhvbGRSZWFkeSA9IGhvbGRSZWFkeSAmJiAhJC5pc1JlYWR5OwoKCQkJcnRuUHJvbWlzZSA9IGxvYWRBc3NldHMoIGFzc2V0SWRzLCBpbmZlckRlcGVuZGVuY2llc0Zyb21JZE9yZGVyICk7CgoJCQlpZiAoaG9sZFJlYWR5KSB7CgoJCQkJJC5ob2xkUmVhZHkoIHRydWUgKTsKCgkJCQlydG5Qcm9taXNlLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCSQuaG9sZFJlYWR5KCk7CgkJCQkJLy9zYW1lIGFzIHRoZSBmb2xsb3dpbmcKCQkJCQkvLyQuaG9sZFJlYWR5KCBmYWxzZSApOwoJCQkJCS8vJC5yZWFkeSggdHJ1ZSApOwoJCQkJfSApOwoJCQl9CgoJCQlyZXR1cm4gcnRuUHJvbWlzZS5kb25lKCBpbnZva2VMb2FkQ2FsbGJhY2tzICkuZmFpbCggaW52b2tlRmFpbENhbGxiYWNrcyApOwoJCX0sCgkJLy91bmxvYWQobG9hZENhbGxiYWNrKSBvciB1bmxvYWQodW5sb2FkQ2FsbGJhY2ssIHJlbW92ZT10cnVlKQoJCS8vdW5sb2FkKGFzc2V0SWRTdHJpbmcpCgkJLy91bmxvYWQoYXNzZXRJZEFycmF5KQoJCXVubG9hZDogZnVuY3Rpb24oIGFzc2V0SWRzLCByZW1vdmUgKSB7CgkJCXZhciBpLAoJCQkJYXNzZXRJZCwKCQkJCWRlcGVuZGVuY2llcywKCQkJCXByb21pc2U7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBhc3NldElkcyApKSB7CgkJCQlpZiAocmVtb3ZlKSB7CgkJCQkJdW5sb2FkQ2FsbGJhY2tzLnJlbW92ZSggYXNzZXRJZHMgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdW5sb2FkQ2FsbGJhY2tzLnB1c2goIGFzc2V0SWRzICk7CgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoJCQkJCWFzc2V0SWRzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoJCQkJfQoKCQkJCS8vaWYgdGhlcmUgaXMgb25seSBvbmUgbW9kdWxlCgkJCQlpZiAoYXNzZXRJZHMubGVuZ3RoICE9IDEpIHsKCgkJCQkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkc1tpXSApOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQkvL3VubG9hZCBzZXJ2ZXJhbCBtb2R1bGVzCgkJCQkJYXNzZXRJZCA9IGFzc2V0SWRzWzBdOwoJCQkJCXByb21pc2UgPSBhY2Nlc3NQcm9taXNlKCBhc3NldElkICk7CgoJCQkJCS8vbWFrZSBzdXJlIGl0IHdpbGwgbm90IHRocm93IGV4Y2VwdGlvbiB3aGVuCgkJCQkJLy8gdW5sb2FkaW5nIHNvbWUgbW9kdWxlIHdoaWNoIGlzIG5vdCBpbiBwYWdlCgkJCQkJaWYgKHByb21pc2UgJiYgcHJvbWlzZS5yZWZDb3VudCAhPSAic3RhdGljTG9hZGVkIikgewoKCQkJCQkJaWYgKC0tcHJvbWlzZS5yZWZDb3VudCA9PT0gMCB8fCByZW1vdmUpIHsKCQkJCQkJCXZhciB1bmxvYWQgPSBwcm9taXNlLnVubG9hZCB8fCBmaW5kTG9hZGVyKCBhc3NldElkICkudW5sb2FkOwoKCQkJCQkJCWlmICh1bmxvYWQpIHsKCQkJCQkJCQl1bmxvYWQoIGFzc2V0SWQgKTsKCQkJCQkJCX0KCgkJCQkJCQkvL2RlbGV0ZSB0aGUgcHJvbWlzZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUKCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHVuZGVmaW5lZCApOwoJCQkJCQkJZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci51bmxvYWQoIGRlcGVuZGVuY2llcywgcmVtb3ZlICk7CgkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCB1bmRlZmluZWQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJaW52b2tlVW5sb2FkQ2FsbGJhY2tzKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCgkJLy9yZWdpc3RlciBhIHVybCBmb3IgbW9kdWxlIGtleQoJCS8vb3IgZ2V0IHRoZSB1cmwgb2YgbW9kdWxlIGtleQoJCXVybDogZnVuY3Rpb24oIGFzc2V0SWQsIHVybCApIHsKCQkJaWYgKGlzT2JqZWN0KCBhc3NldElkICkpIHsKCQkJCWZvciAodmFyIGsgaW4gYXNzZXRJZCkgewoJCQkJCV9sb2FkZXIudXJsKCBrLCBhc3NldElkW2tdICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgcmVzb3VyY2UncyB1cmwgaXMgbm90IGluIGNhY2hlCgkJCS8vYW5kIHVzZXIgaXMgdHJ5aW5nIHRvIGdldCBpdAoJCQlpZiAodXJsID09PSB1bmRlZmluZWQpIHsKCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgoJCQkJCWlmICh1cmxTdG9yZVthc3NldElkXSkgewoJCQkJCQlyZXR1cm4gdXJsU3RvcmVbYXNzZXRJZF07CgkJCQkJfQoKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlyZXR1cm4gZnVsbFVybCgKCQkJCQkJbG9hZGVyICYmIGxvYWRlci51cmwgPyBsb2FkZXIudXJsKCBhc3NldElkICkgOgoJCQkJCQkJbG9hZGVyICYmIGxvYWRlci5maWxlRXh0ID8gZmlsZU5hbWUoIGFzc2V0SWQgKSArICIuIiArIGxvYWRlci5maWxlRXh0IDoKCQkJCQkJCQlhc3NldElkCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvL2FsbG93IGFjY2VzcyhrZXksIHVuZGVmaW5lZCkKCQkJCQkvL3RvIGRlbGV0ZSB0aGUga2V5IGZyb20gc3RvcmFnZQoJCQkJCWRlbGV0ZSB1cmxTdG9yZVthc3NldElkXTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQkvL3VzZXIgZXhwbGljaXQgcmVnaXN0ZXIgYW4gdXJsCgkJCQl2YXIgb2xkVXJsID0gX2xvYWRlci51cmwoIGFzc2V0SWQgKTsKCQkJCXZhciBuZXdVcmwgPSBmdWxsVXJsKCB1cmwgKTsKCgkJCQlpZiAob2xkVXJsICE9IG5ld1VybCkgewoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRQcm9taXNlICYmIGlzUmVzb2x2ZWQoIG9sZFByb21pc2UgKSkgewoJCQkJCQlyZWxvYWQoIGFzc2V0SWQsIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXJsU3RvcmVbYXNzZXRJZF0gPSBuZXdVcmw7CgkJCQkJCX0gKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cmxTdG9yZVthc3NldElkXSA9IG5ld1VybDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvLyBtZW1iZXJzIHRvIGNvbmZpZ3VyZSBsb2FkZXIKCgkJLy9hZGQgZGVwZW5kZW5jeSB0byBhIHJlc291cmNlIGtleQoJCS8vb3IgZ2V0IHRoZSBkZXBlbmRlbmN5IG9mIGEgcmVzb3VyY2Uga2V5CgkJLy91c2VyIGNhbiBzZXQgZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgbWFudWFsbHkgLCB3aGljaCBpcyBjYWxsZWQgc3RhdGljCgkJLy9kZXBlbmRlbnRSZXNvdXJjZVN0cmluZwoJCS8vIG9yIGNhbiB1c2UgbG9hZGVyLmRlcGVuZCBtZXRob2QgdG8gcmV0dXJuIGRlcGVuZGVudFJlc291cmNlU3RyaW5nIHdoaWNoIGlzIGNhbGxlZAoJCS8vZHluYW1pYyBkZXBlbmRlbnRSZXNvdXJjZVN0cmluZywKCQkvL29yIHdlIGNhbiBjb21iaW5lIHRoZW0gdG9nZXRoZXIKCQlkZXBlbmQ6IGRlcGVuZCA9IGZ1bmN0aW9uKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKSB7CgoJCQlpZiAoaXNPYmplY3QoIGFzc2V0SWQgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFzc2V0SWQpIHsKCQkJCQlkZXBlbmQoIGtleSwgYXNzZXRJZFtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChkZXBlbmRlbmNpZXMgPT09IHVuZGVmaW5lZCkgewoJCQkJLy9nZXQgZGVwZW5kZW5jaWVzCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQkJdmFyIHN0YXRpY0RlcGVuZGVuY2llcyA9IGRlcGVuZGVuY3lTdG9yZVthc3NldElkXTsKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlpZiAobG9hZGVyICYmIGxvYWRlci5kZXBlbmQpIHsKCQkJCQkJdmFyIGR5bmFtaWNEZXBlbmRlbmNpZXMgPSBsb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCWlmIChkeW5hbWljRGVwZW5kZW5jaWVzICYmIHN0YXRpY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXMgKyAiLCIgKyBzdGF0aWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSBpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gc3RhdGljRGVwZW5kZW5jaWVzOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuIHN0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQkvL2RlbGV0ZSBkZXBlbmRlbmNpZXMKCQkJCQlkZWxldGUgZGVwZW5kZW5jeVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChkZXBlbmRlbmNpZXMgPT09IHRydWUpIHsKCQkJCS8vZm9yIGRlYnVnZ2luZyBwdXJwdXNlIGxvYWRlci5kZXBlbmQoYXNzZXRJZCwgdHJ1ZSkKCQkJCXZhciBhc3NldElkcyA9IGRlcGVuZCggYXNzZXRJZCApOwoJCQkJYXNzZXRJZHMgPSBhc3NldElkcyAmJiBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQlpZiAoYXNzZXRJZHMpIHsKCQkJCQl2YXIgcnRuID0gW107CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhc3NldElkcy5sZW5ndGg7IGkrKykgewoJCQkJCQlpZiAoX2xvYWRlci5maWxlRXh0KCBhc3NldElkc1tpXSApICE9PSAibW9kdWxlIikgewoJCQkJCQkJcnRuLnB1c2hVbmlxdWUoIF9sb2FkZXIudXJsKCBhc3NldElkc1tpXSApICk7CgkJCQkJCX0KCQkJCQkJcnRuLm1lcmdlKCBkZXBlbmQoIGFzc2V0SWRzW2ldLCB0cnVlICkgKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJ0bjsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl2YXIgbmV3U3RhdGljRGVwZW5kZW5jaWVzID0gZ2V0TmV3U3RhdGljRGVwZW5kZW5jaWVzKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCXZhciBvbGRTdGF0aWNEZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmN5U3RvcmVbYXNzZXRJZF07CgoJCQkJaWYgKGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBuZXdTdGF0aWNEZXBlbmRlbmNpZXMsIG9sZFN0YXRpY0RlcGVuZGVuY2llcyApKSB7CgoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRTdGF0aWNEZXBlbmRlbmNpZXMgJiYgb2xkUHJvbWlzZSAmJiBpc1Jlc29sdmVkKCBvbGRQcm9taXNlICkpIHsKCQkJCQkJcmVsb2FkKCBhc3NldElkLCBmdW5jdGlvbigpIHsKCQkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQkJfSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvL3RoZSB1cmwgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgd2luZG93IGxvY2F0aW9uLCBmb3IgZXhhbXBsZSAianMvIgoJCS8vdGhlIHN1ZmZpeCAiLyIgaXMgaW1wb3J0YW50CgkJLy9pdCBpcyB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgcmVhbCByZWxhdGl2ZSB1cmwgb2YgcmVzb3VyY2Uga2V5CgkJYmFzZVVybDogZnVuY3Rpb24oIHVybFJlbGF0aXZlVG9QYWdlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHVybFJlbGF0aXZlVG9QYWdlICkpIHsKCQkJCXJldHVybiBiYXNlVXJsOwoJCQl9CgkJCWJhc2VVcmwgPSB1cmxSZWxhdGl2ZVRvUGFnZS5lbmRzV2l0aCggIi8iICkgPyB1cmxSZWxhdGl2ZVRvUGFnZSA6IHVybFJlbGF0aXZlVG9QYWdlICsgIi8iOwoJCX0sCgoJCS8vbG9hZGVyLmhhc2godHJ1ZSkgLS0+IHNldCBhIHRpbWVzdGFtcCBhcyBoYXNoID92PTIzNDc0ODM3NDgKCQkvL2xvYWRlci5oYXNoKDEseCkgLS0+ID94PTEKCQkvL2xvYWRlci5oYXNoKDEpIC0tPiA/dj0xCgkJaGFzaDogZnVuY3Rpb24oIHZhbHVlLCBrZXkgKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQloYXNoVmFsdWUgPSB2YWx1ZSA9PT0gdHJ1ZSA/ICQubm93KCkgOiB2YWx1ZTsKCQkJCWhhc2hLZXkgPSBrZXkgIT09IHVuZGVmaW5lZCA/IGtleSA6IChoYXNoS2V5IHx8ICJ2Iik7CgkJCQlyVmVyc2lvbkhhc2ggPSBuZXcgUmVnRXhwKCAiWz8mXSIgKyBoYXNoS2V5ICsgIj1bXiZdKiIgKTsKCQkJfQoJCQlyZXR1cm4gaGFzaFZhbHVlID09PSAiIiA/ICIiIDogaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZTsKCQl9LAoKCQkvL3N1cHBvcnQgbWV0aG9kIGxvYWQsIHVubG9hZCwgdXJsLCBkZXBlbmQKCQltZXRob2RzOiBjb21tb25Mb2FkZXJNZXRob2RzID0gewoKCQkJbG9hZDogewoJCQkJY2FjaGVJbWFnZTogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoKCQkJCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCB1cmwgKTsKCQkJCQl9OwoJCQkJCWltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7CgkJCQkJCWRlZmVyLnJlamVjdCggdXJsICk7CgkJCQkJfTsKCQkJCQlpbWcuc3JjID0gdXJsOwoJCQkJCXJldHVybiBwcm9taXNlOwoJCQkJfQoKCQkJfSwKCQkJdW5sb2FkOiB7CgkJCQlyZW1vdmVDc3NMaW5rVGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCQkJfSApLnJlbW92ZSgpOwoJCQkJfQoJCQl9LAoJCQl1cmw6IHsKCQkJCWFzc2V0SWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJCXJldHVybiBhc3NldElkOwoJCQkJfSwKCQkJCS8vdGhpcyB1cmwgZXhwZWN0IG1vZHVsZSBpcyBwdXQgaW50byBpdHMgZm9sZGVyIHVuZGVyIGJhc2VVcmwKCQkJCS8vaWYgdGhlIGxvYWRlciBuYW1lIGlzICJhcHAiLCB3ZSBzaG91bGQgcHV0IHRoZSByZXNvdXJjZSBmaWxlIGludG8KCQkJCS8vYmFzZVVybC9hcHAgZm9sZGVyCgkJCQlmb2xkZXI6IGZ1bmN0aW9uKCBhc3NldElkICkgewoKCQkJCQl2YXIgZmlsZUV4dCA9IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS5maWxlRXh0LAoJCQkJCQlmaWxlTmFtZSA9IGZpbGVFeHQgPyBfbG9hZGVyLmZpbGVOYW1lKCBhc3NldElkICkgKyAiLiIgKyBmaWxlRXh0IDoKCQkJCQkJCWFzc2V0SWQsCgkJCQkJCWxvYWRlck5hbWUgPSBfbG9hZGVyLmZpbGVFeHQoIGFzc2V0SWQgKTsKCgkJCQkJcmV0dXJuIGxvYWRlck5hbWUgKyAiLyIgKyBmaWxlTmFtZTsKCQkJCX0KCQkJfSwKCgkJCWRlcGVuZDogewoJCQkJLy9uYW1lOiBmdW5jdGlvbiAoYXNzZXRJZCkgewoJCQkJLy8gcmV0dXJuIGEgYXNzZXRJZFN0cmluZyBvciBhc3NldElkQXJyYXkKCQkJCS8vIHJldHVybiAiYS5odG1sLCBiLmpzIgoJCQkJLy8gfQoJCQl9CgkJfSwKCgkJbG9hZEZpbHRlcnM6IGNvbW1vbkxvYWRGaWx0ZXJzID0gewoKCQkJc3RhdGljTG9hZGVkOiB7CgkJCQkvL2RlZmF1bHQgc3RhdGljTG9hZGVkIGZpbHRlcgoJCQkJcmV0dXJuRmFsc2U6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgoJCQkJaGFzU2NyaXB0VGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gISEoJCggInNjcmlwdCIgKS5maWx0ZXIoCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuc3JjICkgPT09IHJlbW92ZUhhc2goIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJfSApLmxlbmd0aCk7CgkJCQl9CgoJCQl9LAoKCQkJZ2V0U291cmNlOiB7CgkJCQkvL3RoaXMgaXMgZGVmYXVsdCBnZXRTb3VyY2UgZmlsdGVyCgkJCQlnZXRUZXh0QnlBamF4OiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gJC5hamF4KCB7CgkJCQkJCXVybDogX2xvYWRlci51cmwoIGFzc2V0SWQgKSwKCQkJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJCQkJY2FjaGU6IHRydWUKCQkJCQl9ICk7CgkJCQl9CgkJCX0sCgoJCQljb21waWxlOiB7CgkJCQlnbG9iYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gJC5nbG9iYWxFdmFsKCBzb3VyY2VDb2RlICk7CgkJCQl9LAoJCQkJbG9jYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gZXZhbCggc291cmNlQ29kZSApOwoJCQkJfQoJCQl9LAoKCQkJY3Jvc3NTaXRlTG9hZDogewoJCQkJLy9jYW4gbm90IHVzZSAkLmdldFNjcmlwdCBkaXJlY3RseSwgYXMgbG9hZGVyLnJlc29sdmUKCQkJCWdldFNjcmlwdDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpOwoKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgoJCQkJCSQuZ2V0U2NyaXB0KCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCWRlZmVyLnJlc29sdmUoKTsKCQkJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCQkJfQoJCQkJCQkJfSwgNSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCWRlZmVyLnJlamVjdCgpOwoJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIHByb21pc2U7CgkJCQl9CgoKCQkJfSwKCgkJCWJ1aWxkVW5sb2FkOiB7CgkJCQlwYXJzZVVubG9hZFRhZzogZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgkJCQkJdmFyIHVubG9hZFN0YXRlbWVudHMgPSBydW5sb2FkU3RhdGVtZW50LmV4ZWMoIHNvdXJjZUNvZGUgKTsKCQkJCQlyZXR1cm4gdW5sb2FkU3RhdGVtZW50cyAmJgoJCQkJCSAgICAgICB1bmxvYWRTdGF0ZW1lbnRzWzFdICYmCgkJCQkJICAgICAgIG5ldyBGdW5jdGlvbiggdW5sb2FkU3RhdGVtZW50c1sxXSApOwoJCQkJfQoJCQl9LAoKCQkJYnVpbGREZXBlbmRlbmNpZXM6IHsKCQkJCXBhcnNlRGVwZW5kVGFnOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gckRlcGVuZEhlYWRlci5leGVjKCBzb3VyY2VDb2RlICk7CgkJCQkJcmV0dXJuIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzWzFdICkgfHwgbnVsbDsKCQkJCX0KCQkJfQoJCX0sCgoJCS8vZmluZCB0aGUgbmFtZSBvZiB0aGUgbG9hZGVyIGJhc2VkIG9uIGFzc2V0SWQKCQkvL3RoZSBmaXJzdCBsb2FkZXIgaXMgdXNlIHRoZSBleHRlbnNpb24gYXMgdGhlIGxvYWRlciBuYW1lCgkJLy9ob3dldmVyIHlvdSBjYW4gYWRkIHlvdXIgb3duIGxvYWRlcgoJCWZpbmRlcnM6IGxvYWRlckZpbmRlcnMgPSBbCgkJCS8vZmluZCBsb2FkZXIgYnkgYnkgZmlsZSBleHRlbnNpb25zIGRpcmVjdGx5CgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuIGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJfSwKCQkJLy9maW5kIGxvYWRlciBieSBieSBmaWxlIGV4dGVuc2lvbnMgdXNpbmcgbWFwcGVyCgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGV4dGVuc2lvbiA9IGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJCXZhciBtYXBwZWRUeXBlID0gZmlsZUV4dFRvTG9hZGVyTWFwcGVyW2V4dGVuc2lvbl07CgkJCQlpZiAobWFwcGVkVHlwZSkgewoJCQkJCXJldHVybiBtYXBwZWRUeXBlOwoJCQkJfQoJCQl9CgkJXSwKCgkJLy9pZiB5b3Ugd2FudCB0byBsb2FkIGEgZmlsZSAiKi5qcGciLCB3aGljaCBzaG91bGQgYmUgbG9hZGVkCgkJLy93aXRoICIqLmltZyIgbG9hZGVyIHlvdSBzaG91bGQgc3BlY2lmeSBsb2FkZXIubG9hZGVyLm1hcEZpbGVzKCJpbWciLCAianBnIik7CgkJbWFwRmlsZUV4dFRvTG9hZGVyOiBmdW5jdGlvbiggZmlsZUV4dGVuc2lvbnMsIGxvYWRlck5hbWUgKSB7CgkJCWZpbGVFeHRlbnNpb25zID0gc3BsaXRCeUNvbW1hKCBmaWxlRXh0ZW5zaW9ucyApOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVFeHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7CgkJCQlmaWxlRXh0VG9Mb2FkZXJNYXBwZXJbZmlsZUV4dGVuc2lvbnNbaV1dID0gbG9hZGVyTmFtZTsKCQkJfQoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyB4eXouanMKCQkvL3RoZW4gZmlsZUV4dCBpcyAianMiCgkJZmlsZUV4dDogZmlsZUV4dGVuc2lvbiA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVFeHQuZXhlYyggYXNzZXRJZCApWzFdOwoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyAiYS5iLmMiLCB0aGVuIGZpbGUgbmFtZSBpcyAiYS5iIgoJCWZpbGVOYW1lOiBmaWxlTmFtZSA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVOYW1lLmV4ZWMoIGFzc2V0SWQgKVsxXTsKCQl9LAoKCQkvL2RlZmluZSBhIG1vZHVsZSB3aXRoIGFuIGFzc2V0IGlkCgkJLy9kZXBlbmRlbmNpZXMgaXMgYW4gYXNzZXQgZXhwcmVzc2lvbiwgaXQgaXMgb3B0aW9uYWwKCQkvL2RlZmluZSB0aGUgbW9kdWxlIGluIHRoZSBsb2FkIG1ldGhvZAoJCWRlZmluZTogZnVuY3Rpb24oIGFzc2V0SWQsIGRlcGVuZGVuY2llcywgZGVmaW5lTW9kdWxlLCB1bmxvYWQgKSB7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBkZXBlbmRlbmNpZXMgKSkgewoJCQkJdW5sb2FkID0gZGVmaW5lTW9kdWxlOwoJCQkJZGVmaW5lTW9kdWxlID0gZGVwZW5kZW5jaWVzOwoJCQkJZGVwZW5kZW5jaWVzID0gbnVsbDsKCQkJfQoKCQkJdmFyIGRlZmVyLCBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQkJaWYgKCFwcm9taXNlKSB7CgkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiBsb2FkZXIuZGVmaW5lIGlzIGNhbGwgaW4gYSBzdGF0aWMgbG9hZGVkIGpzCgkJCQlkZWZlciA9ICQuRGVmZXJyZWQoKTsKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCk7CgkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQlhY2Nlc3NQcm9taXNlKCBhc3NldElkLCBwcm9taXNlICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlciA9IHByb21pc2UuZGVmZXI7CgkJCX0KCgkJCS8vdXNlIGRvbnRSZW9zbHZlIGZsYWcgdGVsbGluZyB0aGUgY29uc3VtZXIgZG9uJ3QgcmVzb2x2ZSBpdAoJCQkvL2FzIGl0IHdpbGwgYmUgdGFrZW4gY2FyZSBpbnNpZGUgaW1wb3J0Q29kZSwKCQkJcHJvbWlzZS5kZWZlci5kb250UmVzb2x2ZSA9IHRydWU7CgoJCQl2YXIgcnVuTW9kdWxlQ29kZSA9IGZ1bmN0aW9uKCByZXN1bHQgKSB7CgkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCXByb21pc2UudW5sb2FkID0gdW5sb2FkOwoJCQkJZGVmZXIgJiYgZGVmZXIucmVzb2x2ZSggZGVmaW5lTW9kdWxlKCByZXN1bHQgKSApOwoJCQl9OwoKCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJZGVwZW5kKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCS8vbG9hZCB0aGUgZGVwZW5kZW5jaWVzIGZpcnN0CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVuY2llcyApLmRvbmUoIHJ1bk1vZHVsZUNvZGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJcnVuTW9kdWxlQ29kZSgpOwoJCQl9CgoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9LAoKCQlkb25lOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJbG9hZENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlsb2FkQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlmYWlsOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJZmFpbENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlmYWlsQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlkZWZhdWx0TG9hZGVyOiAianMiCgoJfSApOwoKCWZ1bmN0aW9uIHJlbG9hZCggYXNzZXRJZCwgY2hhbmdlICkgewoKCQl2YXIgb2xkUHJvbWlzZUNhY2hlID0gJC5leHRlbmQoIHRydWUsIHt9LCBwcm9taXNlU3RvcmUgKTsKCQlfbG9hZGVyLnVubG9hZCggYXNzZXRJZCwgdHJ1ZSApOwoJCWNoYW5nZSAmJiBjaGFuZ2UoKTsKCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBhc3NldElkICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWZvciAodmFyIGtleSBpbiBvbGRQcm9taXNlQ2FjaGUpIHsKCQkJCWlmIChwcm9taXNlU3RvcmVba2V5XSAmJiBvbGRQcm9taXNlQ2FjaGVba2V5XSkgewoJCQkJCXByb21pc2VTdG9yZVtrZXldLnJlZkNvdW50ID0gb2xkUHJvbWlzZUNhY2hlW2tleV0ucmVmQ291bnQ7CgkJCQkJcHJvbWlzZVN0b3JlW2tleV0udXJsID0gb2xkUHJvbWlzZUNhY2hlW2tleV0udXJsOwoJCQkJCXByb21pc2VTdG9yZVtrZXldLmFzc2V0SWQgPSBvbGRQcm9taXNlQ2FjaGVba2V5XS5hc3NldElkOwoJCQkJfQoJCQl9CgkJfSApOwoJfQoKCWZ1bmN0aW9uIGdldE5ld1N0YXRpY0RlcGVuZGVuY2llcyggYXNzZXRJZCwgZGVwZW5kZW5jaWVzVG9TZXQgKSB7CgkJdmFyIHJ0biwKCQkJbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApLAoJCQlkeW5hbWljRGVwZW5kZW5jaWVzID0gbG9hZGVyICYmIGxvYWRlci5kZXBlbmQgJiYgbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQlpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQlydG4gPSBbXTsKCQkJZHluYW1pY0RlcGVuZGVuY2llcyA9IHNwbGl0QnlDb21tYSggZHluYW1pY0RlcGVuZGVuY2llcyApOwoJCQlkZXBlbmRlbmNpZXNUb1NldCA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzVG9TZXQgKTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXNUb1NldC5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFkeW5hbWljRGVwZW5kZW5jaWVzLmNvbnRhaW5zKCBkZXBlbmRlbmNpZXNUb1NldFtpXSApKSB7CgkJCQkJcnRuLnB1c2goIGRlcGVuZGVuY2llc1RvU2V0W2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bi5sZW5ndGggPyBydG4uam9pbigpIDogbnVsbDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZGVwZW5kZW5jaWVzVG9TZXQ7CgkJfQoJfQoKCWZ1bmN0aW9uIGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBkZXBlbmRlbmNpZXMxLCBkZXBlbmRlbmNpZXMyICkgewoJCWlmICgoZGVwZW5kZW5jaWVzMSAmJiAhZGVwZW5kZW5jaWVzMikgfHwKCQkgICAgZGVwZW5kZW5jaWVzMiAmJiAhZGVwZW5kZW5jaWVzMSkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgaWYgKCFkZXBlbmRlbmNpZXMxICYmICFkZXBlbmRlbmNpZXMyKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWRlcGVuZGVuY2llczEgPSBzcGxpdEJ5Q29tbWEoIGRlcGVuZGVuY2llczEgKS5zb3J0KCk7CgkJZGVwZW5kZW5jaWVzMiA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzMiApLnNvcnQoKTsKCQlpZiAoZGVwZW5kZW5jaWVzMS5sZW5ndGggIT0gZGVwZW5kZW5jaWVzMi5sZW5ndGgpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llczEubGVuZ3RoOyBpKyspIHsKCQkJaWYgKGRlcGVuZGVuY2llczFbaV0gIT0gZGVwZW5kZW5jaWVzMltpXSkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiBmaW5kTG9hZGVyKCBhc3NldElkICkgewoJCXZhciBsb2FkZXJOYW1lLCBpOwoJCWZvciAoaSA9IGxvYWRlckZpbmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJbG9hZGVyTmFtZSA9IGxvYWRlckZpbmRlcnNbaV0oIGFzc2V0SWQgKTsKCQkJaWYgKGxvYWRlck5hbWUpIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWxvYWRlck5hbWUgPSBsb2FkZXJOYW1lIHx8IF9sb2FkZXIuZGVmYXVsdExvYWRlcjsKCQlyZXR1cm4gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV07Cgl9CgoJZnVuY3Rpb24gYXR0YWNoRmlsdGVyKCBmaWx0ZXJzLCBmaWx0ZXJOYW1lICkgewoJCWlmIChpc1N0cmluZyggZmlsdGVyc1tmaWx0ZXJOYW1lXSApKSB7CgkJCWZpbHRlcnNbZmlsdGVyTmFtZV0gPSBjb21tb25Mb2FkRmlsdGVyc1tmaWx0ZXJOYW1lXVtmaWx0ZXJzW2ZpbHRlck5hbWVdXTsKCQl9Cgl9CgoKCXZhcgoKCS8vaWYgeW8gaGF2ZSBjb2RlIGxpa2UgdGhlIGZvbGxvd2luZyBpbiBqYXZhc2NyaXB0LAoJLy90aGUgcGFydCBkZWxldGUgd2luZG93LmRlcGVuZDIgd2lsbCBiZSBleHRyYWN0ZWQKCS8vIDxAdW5sb2FkPgoJLy9kZWxldGUgd2luZG93LmRlcGVuZDI7CgkvLzwvQHVubG9hZD4KCgkJcnVubG9hZFN0YXRlbWVudCA9IC88QHVubG9hZD4oW1x3XFddKz8pPFwvQHVubG9hZD4vaSwKCgkvL21hdGNoIHN0cmluZyAicmVmMiwgcmVmMSIgaW4KCS8vIDxAZGVwZW5kPgoJLy9yZWYyLCByZWYxCgkvLzxAZGVwZW5kPgoJCXJEZXBlbmRIZWFkZXIgPSAvPEBkZXBlbmQ+KFtcd1xXXSs/KTxcL0BkZXBlbmQ+L2k7CgoJLy9jcmVhdGUgYSBsb2FkIGZ1bmN0aW9uCglmdW5jdGlvbiByZXNvbHZlRGVwZW5kZW5jaWVzKCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkICkgewoJCXJldHVybiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgPSBfbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQkJaWYgKGRlcGVuZGVudFJlc291cmNlU3RyaW5nKSB7CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVudFJlc291cmNlU3RyaW5nICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggYXNzZXRJZCwgYWN0aW9uQWZ0ZXJEZXBlbmRlbmNpZXNSZXNvbHZlZCggYXNzZXRJZCApICk7CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkLCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkKCBhc3NldElkICkgKTsKCQkJfQoJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoJCX07Cgl9CgoJLy9hIHNwZWNpYWwgbW9kdWxlIHdoaWNoIGlzIGEgcGFja2FnZSBvZiBtb2R1bGVzLCBsaWtlIGEgY29udGFpbmVyCglfbG9hZGVyKCAicGFjayIsIHsKCQlsb2FkOiByZXNvbHZlRGVwZW5kZW5jaWVzKCAkLm5vb3AgKSwKCQl1cmw6ICJhc3NldElkIgoJfSApOwoKCS8vanMgYWRhcHRlciB0cnkgdG8gcGFyc2UgdGhlIGNvbnRlbnQgb2YganMgZmlsZQoJX2xvYWRlciggImpzIiwgewoJCWxvYWQ6IHsKCQkJc3RhdGljTG9hZGVkOiAiaGFzU2NyaXB0VGFnIgoJCQkvL3RoZSBmb2xsb3dpbmcgYXJlIGNvbW1lbnRlZCBvdXQsIGJlY2F1c2UgaXQgaXMgZGVmYXVsdCB2YWx1ZSBkZWZpbmVkIGluIGNvbnZlcnRMb2FkRmlsdGVyc1RvTG9hZE1ldGhvZAoJCQkvL2Nyb3NzU2l0ZUxvYWQ6ICJnZXRTY3JpcHQiLAoJCQkvL2dldFNvdXJjZTogImdldFRleHRCeUFqYXgiLAoJCQkvL2NvbXBpbGU6ICJnbG9iYWxFdmFsIiwKCQkJLy9idWlsZERlcGVuZGVuY2llczogInBhcnNlRGVwZW5kVGFnIiwKCQkJLy9idWlsZFVubG9hZDogInBhcnNlVW5sb2FkVGFnIgoJCX0sCgkJLy90aGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGlmIHlvdSBoYXZlIGEgc3ViIGxvYWRlciBpbmhlcml0cyBmcm9tCgkJLy9mcm9tIHRoaXMsIGFuZCB5b3UgZG9uJ3Qgd2FudCB0byBpbmhlcml0ZWQgc3ViIGxvYWRlciB0byBzcGVjaWZ5IHRoaXMgYWdhaW4KCQlmaWxlRXh0OiAianMiCgl9ICk7CgoJX2xvYWRlciggImpzbCIsICJqcyIsIHsKCQlsb2FkOiB7CgkJCWNvbXBpbGU6ICJsb2NhbEV2YWwiCgkJfQoJfSApOwoJLy9sb2FkZXIgaXMgamF2YXNjcmlwdCBmaWxlLCBpdCBkZWZpbmVzIGEgbG9hZGVyCglfbG9hZGVyKCAibG9hZGVyIiwgImpzIiwgewoJCXVybDogImZvbGRlciIKCX0gKTsKCgkvL2NzcyBhZGFwdGVyIHRyaWVzIHRvIHBhcnNlIHRoZSBjb250ZW50IG9mIGNzcyBmaWxlCglfbG9hZGVyKCAiY3NzIiwgewoJCWxvYWQ6IHsKCQkJc3RhdGljTG9hZGVkOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCXJldHVybiAhISgkKCAibGluayIgKS5maWx0ZXIoCgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZW1vdmVIYXNoKCB0aGlzLmhyZWYgKSA9PT0gcmVtb3ZlSGFzaCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApICYmICEkKCB0aGlzICkuYXR0ciggJ2xvYWRlZEJ5bG9hZGVyJyApOwoJCQkJCX0gKS5sZW5ndGgpOwoJCQl9LAoJCQljcm9zc1NpdGVMb2FkOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKTsKCgkJCQkkKCAiPGxpbmsgaHJlZj0nIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKyAiJyAiICsgInJlbD0nc3R5bGVzaGVldCcgdHlwZT0ndGV4dC9jc3MnIGxvYWRlZEJ5bG9hZGVyPScxJyAvPiIgKQoJCQkJCS5sb2FkKCBmdW5jdGlvbigpIHsKCQkJCQkJZGVmZXIucmVzb2x2ZSggYXNzZXRJZCApOwoJCQkJCX0gKQoJCQkJCS5hcHBlbmRUbyggImhlYWQiICk7CgoJCQkJcmV0dXJuIGRlZmVyLnByb21pc2UoKTsKCQkJfSwKCQkJLy9leHBsaWNpdGx5IHNwZWNpZnkgdGhhdCBsb2FkZXIgZG9lcyBub3QgbmVlZCBhIGNvbXBpbGUgZmlsdGVyCgkJCWNvbXBpbGU6IG51bGwKCQl9LAoKCQl1bmxvYWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkkKCAibGluayIgKS5maWx0ZXIoCgkJCQlmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCX0gKS5yZW1vdmUoKTsKCQl9LAoJCWZpbGVFeHQ6ICJjc3MiCgl9ICk7CgoJX2xvYWRlciggImltYWdlIiwgewoJCWxvYWQ6ICJjYWNoZUltYWdlIiwKCQlub1JlZkNvdW50OiB0cnVlCgl9ICk7CgoJLy9tYWtlIGltZyBsaW5rZXIgY2FuIGhhbmRsZSBtb2R1bGUgd2l0aCB0aGVzZSBmaWxlIGV4dGVuc2lvbgoJX2xvYWRlci5tYXBGaWxlRXh0VG9Mb2FkZXIoICJqcGcscG5nLGJtcCxnaWYiLCAiaW1hZ2UiICk7CgkvL2ZyZWQgdGVzdAoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanM8L0BkZXBlbmRzPgoKCgl2YXIgdGVtcGxhdGUsCgkJckJlZ2luV2l0aEFwayA9IC9eYXBrXC4oW14uXSspKFwuPykoLiopJC8sCgkJckJlZ2luV2l0aFN0YXIgPSAvXlwqLywKCQl0ZW1wbGF0ZUVuZ2luZUFkYXB0ZXJzID0ge30sCgkJdG1wbCA9IHsKCQkJaW5pdGlhbGl6ZTogIip0ZW1wbGF0ZU9wdGlvbnMiLAoJCQlnZXQ6ICJnZXQiLCAvL2V4dGVuc2libGUKCQkJY29udmVydDogIip0ZW1wbGF0ZSIsCgkJCXNldDogImh0bWwiLCAvL2V4dGVuc2libGUKCQkJZmluYWxpemU6ICIqcGFyc2VTdWJzIgoJCX07CgoJZnVuY3Rpb24gbmV3VGVtcGxhdGVIYW5kbGVyKCBnZXR0ZXIsIHNldHRlciwgZmluYWxpemVyICkgewoJCXJldHVybiBleHRlbmQoIHt9LCB0bXBsLAoJCQlpc09iamVjdCggZ2V0dGVyICkgPyBnZXR0ZXIgOiB7CgkJCQlnZXQ6IGdldHRlciwKCQkJCXNldDogc2V0dGVyLAoJCQkJZmluYWxpemU6IGZpbmFsaXplcgoJCQl9ICk7Cgl9CgoJLy9vcHRpb25zIGNhbiBiZSA6IHRlbXBsYXRlSWQsd3JhcEl0ZW0sZW5naW5lTmFtZQoJLy8KCS8vb3IgaXQgY2FuIGJlCgkvLyB7CgkvLyAgdGVtcGxhdGVJZDogInh4eCIsCgkvLyAgd3JhcEl0ZW06IHRydWUsCgkvLyAgZW5naW5lTmFtZTogInh4eCIKCS8vfQoJaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZS50ZW1wbGF0ZU9wdGlvbnMgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCWhhbmRsZXIudGVtcGxhdGVJZCA9ICQudHJpbSggb3B0aW9uc1swXSApOwoJCQloYW5kbGVyLndyYXBEYXRhSW5BcnJheSA9ICQudHJpbSggb3B0aW9uc1sxXSApID09ICJ0cnVlIjsKCQkJaGFuZGxlci5lbmdpbmVOYW1lID0gb3B0aW9uc1syXTsKCgkJfSBlbHNlIGlmIChpc09iamVjdCggb3B0aW9ucyApICYmIG9wdGlvbnMudGVtcGxhdGVJZCkgewoKCQkJZXh0ZW5kKCBoYW5kbGVyLCBvcHRpb25zICk7CgoJCX0gZWxzZSB7CgoJCQlpZiAoIShoYW5kbGVyLnRlbXBsYXRlSWQgPSBzdWJzY3JpYmVyLmhtRGF0YSggImVtYmVkZGVkVGVtcGxhdGUiICkpKSB7CgoJCQkJdmFyIHRlbXBsYXRlU291cmNlID0gJC50cmltKCBzdWJzY3JpYmVyLmh0bWwoKSApOwoJCQkJaWYgKHRlbXBsYXRlU291cmNlKSB7CgkJCQkJdGVtcGxhdGVTb3VyY2UgPSB0ZW1wbGF0ZVNvdXJjZS5yZXBsYWNlKCByVW5lc2NhcGVUb2tlbnMsIHVuZXNjYXBlVG9rZW5zICk7CgkJCQkJaGFuZGxlci50ZW1wbGF0ZUlkID0gIl9fIiArICQudXVpZCsrOwoJCQkJCXRlbXBsYXRlLmNvbXBpbGUoIGhhbmRsZXIudGVtcGxhdGVJZCwgdGVtcGxhdGVTb3VyY2UgKTsKCQkJCQlzdWJzY3JpYmVyLmhtRGF0YSggImVtYmVkZGVkVGVtcGxhdGUiLCBoYW5kbGVyLnRlbXBsYXRlSWQgKTsKCQkJCQlzdWJzY3JpYmVyLmVtcHR5KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIHRlbXBsYXRlIjsKCQkJCX0KCQkJfQoJCX0KCX07CgoJdmFyIHJVbmVzY2FwZVRva2VucyA9IC8mbHQ7fCZndDsvZzsKCXZhciB1bmVzY2FwZU1hcCA9IHsKCQkiJmx0OyI6ICI8IiwKCQkiJmd0OyI6ICI+IgoJfTsKCgl2YXIgdW5lc2NhcGVUb2tlbnMgPSBmdW5jdGlvbiggdG9rZW4gKSB7CgkJcmV0dXJuIHVuZXNjYXBlTWFwW3Rva2VuXSB8fCAiIjsKCX07CgoJZnVuY3Rpb24gUmVuZGVyQ29udGV4dCggZSApIHsKCQl0aGlzLm1vZGVsUGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJdGhpcy5lID0gZTsKCX0KCgkvL3Nob3J0Y3V0IHRvIHRoaXMuZS5wdWJsaXNoZXIuZ2V0KHh4eCk7CglSZW5kZXJDb250ZXh0LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcHVibGlzaGVyID0gdGhpcy5lLnB1Ymxpc2hlcjsKCQlyZXR1cm4gcHVibGlzaGVyLmdldC5hcHBseSggcHVibGlzaGVyLCBhcmd1bWVudHMgKTsKCX07CgoJLy90aGlzIGNvbnZlcnRlciBpcyB1c2VkIGluIGhhbmRsZXJzIHdoaWNoIGNhbiB3YW50IHRvIGNvbnZlcnQgZGF0YQoJLy8gdG8gbWFya3VwLCB0aGVzZSBoYW5kbGVyIGluY2x1ZGVzIGZvcmVhY2gsIGFuZCBuZXdUZW1wbGF0ZUhhbmRsZXIKCS8vd2hpY2ggaXMgdGhlIGNvcmUgb2YgYWxsIHRlbXBsYXRlSGFuZGxlcgoJaG0uYWN0aXZpdHkuY29udmVydC50ZW1wbGF0ZSA9IGZ1bmN0aW9uKCBkYXRhLCBlICkgewoKCQkvL2lmIGRhdGFTb3VyY2UgaXMgYW4gYXJyYXksIGl0IGhhcyBpdGVtKHMpCgkJLy9vciBkYXRhU291cmNlIGlzIG5vbi1hcnJheQoJCWlmIChkYXRhICYmCgkJICAgICgKCQkJICAgIChpc0FycmF5KCBkYXRhICkgJiYgZGF0YS5sZW5ndGgpIHx8ICFpc0FycmF5KCBkYXRhICkKCQkJICAgICkKCQkJKSB7CgoJCQkvL2lmIHdyYXBEYXRhSW5BcnJheSBpcyB0cnVlLCB3cmFwIGRhdGEgd2l0aCBbXSwgc28gdGhhdCBpdCBpcyBhbiBpdGVtIG9mIGFuIGFycmF5LCBleHBsaWNpdGx5CgkJCS8vc29tZSB0ZW1wbGF0ZSBlbmdpbmUgY2FuIGF1dG9tYXRpY2FsbHkgd3JhcCB5b3VyIGRhdGEgaWYgaXQgaXMgbm90IGFuIGFycmF5LgoJCQkvL2lmIHlvdSBkYXRhIGlzIGFscmVhZHkgaW4gYXJyYXksIGl0IHRyZWF0IGl0IGFzIGFuIGFycmF5IG9mIGl0ZW1zLgoJCQkvL2hvd2V2ZXIsIGlmIHlvdSB3YW50IHRvIHdhbnQgdG8gdHJlYXQgeW91ciBhcnJheSBhcyBpdGVtLCB5b3UgbmVlZCB0byB3cmFwIGl0IGJ5IHlvdXIKCQkJLy9zZWxmLCB3cmFwRGF0YUluQXJyYXkgaXMgZm9yIHRoaXMgcHVycG9zZQoKCQkJdmFyIHRlbXBsYXRlSWQsIHRlbXBsYXRlRGF0YSwgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgoJCQlpZiAod29ya2Zsb3cudGVtcGxhdGVJZCkgewoJCQkJdGVtcGxhdGVJZCA9IHdvcmtmbG93LnRlbXBsYXRlSWQ7CgkJCQl0ZW1wbGF0ZURhdGEgPSB3b3JrZmxvdy53cmFwRGF0YUluQXJyYXkgPyBbZGF0YV0gOiBkYXRhOwoJCQl9IGVsc2UgewoJCQkJdGVtcGxhdGVJZCA9IGRhdGE7CgkJCQl0ZW1wbGF0ZURhdGEgPSB7fTsKCQkJfQoKCQkJaWYgKCF0ZW1wbGF0ZUlkKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0KCgkJCS8vaGFuZGxlci50ZW1wbGF0ZUlkLCBoYW5kbGVyLndyYXBEYXRhSW5BcnJheSwgaGFuZGxlci5lbmdpbmVOYW1lIGlzCgkJCS8vYnVpbHQgaW4gZHVyaW5nIGluaXRpYWxpemF0aW9uICwgc2VlIGluaXRpYWxpemVycy50ZW1wbGF0ZU9wdGlvbnMKCQkJdmFyIGNvbnRlbnQgPSByZW5kZXJUZW1wbGF0ZSgKCgkJCQl0ZW1wbGF0ZUlkLAoKCQkJCXRlbXBsYXRlRGF0YSwKCgkJCQkvL3RoaXMgY29udGV4dCBjYW4gYmUgdXNlZCB0byBhY2Nlc3MgbW9kZWwgd2l0aGluIHRoZSB0ZW1wbGF0ZQoJCQkJbmV3IFJlbmRlckNvbnRleHQoIGUgKSwKCgkJCQl3b3JrZmxvdy5lbmdpbmVOYW1lICk7CgoJCQlpZiAoaXNQcm9taXNlKCBjb250ZW50ICkpIHsKCQkJCXJldHVybiBjb250ZW50OwoJCQl9CgkJCWlmIChpc1N0cmluZyggY29udGVudCApKSB7CgoJCQkJY29udGVudCA9ICQudHJpbSggY29udGVudCApOwoJCQl9CgoJCQkvL3RvIHdvcmsgYXJvdW5kIGEgYnVnIGluIGpRdWVyeQoJCQkvLyBodHRwOi8vanNmaWRkbGUubmV0L2pnU3JuLzEvCgkJCXJldHVybiAkKCAkKCAiPGRpdiAvPiIgKS5odG1sKCBjb250ZW50IClbMF0uY2hpbGROb2RlcyApOwoJCX0gZWxzZSB7CgkJCXJldHVybiAiIjsKCQl9Cgl9OwoKCS8vd2hlbiB0aGUgdGVtcGxhdGUgaXMgcmVuZGVyLCBuZWVkIHRvIHJlY3Vyc2l2ZWx5IGltcG9ydCBkZWNsYXJhdGl2ZSBzdWJzY3JpcHRpb25zCglobS5hY3Rpdml0eS5maW5hbGl6ZS5wYXJzZVN1YnMgPSBmdW5jdGlvbiggdmFsdWUsIGUgKSB7CgkJJCggdmFsdWUgKS5wYXJzZVN1YnMoKTsKCgl9OwoKCS8vYWRkIHJldXNhYmxlIGV2ZW50IGhhbmRsZXIKCWhtLndvcmtmbG93KCB7CgkJdG1wbDogdG1wbCwKCQlpbmNsdWRlOiBuZXdUZW1wbGF0ZUhhbmRsZXIoICJnZXQiLCAicmVwbGFjZVdpdGgiICkKCX0gKTsKCgliaW5kaW5ncyggewoKCQl0bXBsOiAiIWluaXQ6LnwqdG1wbCIsCgoJCXRtcGxPbkNoYW5nZTogIiFpbml0IGFmdGVyKi46LnwqdG1wbCIsCgoJCXRtcGxPbkNoaWxkQ2hhbmdlOiAiIWluaXQgYWZ0ZXIqLiBhZnRlciouMToufCp0bXBsIiwKCgkJdG1wbE9uQW55Q2hhbmdlOiAiIWluaXQgYWZ0ZXIqOi58KnRtcGwiLAoKCQlpbmNsdWRlOiAiIWluaXQ6LnwqaW5jbHVkZSIKCX0gKTsKCgkvL3RlbXBsYXRlT3B0aW9ucyBpcyB0ZW1wbGF0ZUlkLHdyYXBEYXRhSW5BcnJheSx0ZW1wbGF0ZUVuZ2luZU5hbWUKCS8vJCgiZGl2IikudG1wbCh0ZW1wbGF0ZUlkLCBwYXRoKQoJLy8kKCJkaXYiKS50bXBsKHRlbXBsYXRlSWQsIHBhdGgsIGZuKQoJLy9pZiB0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uIGlzIGEgZnVuY3Rpb24sIHRoZSBmdW5jdGlvbiBpcyB0cmVhdGVkCgkvL2FzIGZpbmFsaXplcgoJJGZuLnRtcGwgPSBmdW5jdGlvbiggdGVtcGxhdGVPcHRpb25zLCBtb2RlbFBhdGgsIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSB7CgoJCW1vZGVsUGF0aCA9IG1vZGVsUGF0aCB8fCAiIjsKCgkJaWYgKGlzRnVuY3Rpb24oIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSkgewoJCQl0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uID0gewoJCQkJZmluYWxpemU6IHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24KCQkJfTsKCQl9CgoJCXJldHVybiB0aGlzLnJlbmRlclZpZXcoCgoJCQltb2RlbFBhdGgsCgoJCQl0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uID8KCQkJCWV4dGVuZCgge30sIHRtcGwsIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSA6CgkJCQkiKnRtcGwiLAoKCQkJdGVtcGxhdGVPcHRpb25zCgkJKTsKCX07CgoJLy90ZW1wbGF0ZU9wdGlvbnMgaXMgdGVtcGxhdGVJZCx3cmFwRGF0YUluQXJyYXksdGVtcGxhdGVFbmdpbmVOYW1lCgkvLyQoImRpdiIpLmluY2x1ZGUocGF0aCwgdGVtcGxhdGVJZCkKCSRmbi5pbmNsdWRlID0gZnVuY3Rpb24oIHRlbXBsYXRlT3B0aW9ucywgbW9kZWxQYXRoLCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSB7CgoJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSkgewoJCQl0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gPSB7CgkJCQlmaW5hbGl6ZTogdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uCgkJCX07CgkJfQoKCQlyZXR1cm4gdGhpcy5yZW5kZXJWaWV3KAoJCQltb2RlbFBhdGgsCgkJCXRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiA/IGV4dGVuZCgge30sIGhtLndvcmtmbG93KCAicmVwbGFjZSIgKSwgdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uICkgOiAiKnJlcGxhY2UiLAoJCQl0ZW1wbGF0ZU9wdGlvbnMKCQkpOwoJfTsKCglmdW5jdGlvbiBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSApIHsKCQllbmdpbmVOYW1lID0gZW5naW5lTmFtZSB8fCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lOwoJCWlmICghZW5naW5lTmFtZSkgewoJCQl0aHJvdyAiZW5naW5lIG5hbWUgaXMgbm90IHNwZWNpZmllZCBvciBkZWZhdWx0IGVuZ2luZSBuYW1lIGlzIG51bGwiOwoJCX0KCQl2YXIgZW5naW5lQWRhcHRlciA9IHRlbXBsYXRlRW5naW5lQWRhcHRlcnNbZW5naW5lTmFtZV07CgkJaWYgKCFlbmdpbmVBZGFwdGVyKSB7CgkJCXRocm93ICJlbmdpbmUgJyIgKyBlbmdpbmVBZGFwdGVyICsgIicgY2FuIG5vdCBiZSBmb3VuZC4iOwoJCX0KCQlyZXR1cm4gZW5naW5lQWRhcHRlcjsKCgl9CgoJZnVuY3Rpb24gcmVuZGVyVGVtcGxhdGUoIHRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQsIGVuZ2luZU5hbWUgKSB7CgoJCXZhciBlbmdpbmVBZGFwdGVyID0gZ2V0VGVtcGxhdGVFbmdpbmUoIGVuZ2luZU5hbWUsIHRlbXBsYXRlSWQgKTsKCgkJdGVtcGxhdGVJZCA9ICQudHJpbSggdGVtcGxhdGVJZCApOwoKCQkvL3JlbW92ZSB0aGUgc3RhcnRpbmcgIioiIGZyb20gdGhlIHRlbXBsYXRlIGlkIHRvIGJlY29tZSB0aGUgcmVhbFRlbXBsYXRlSWQKCQl2YXIgcmVhbFRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkLnJlcGxhY2UoIHJCZWdpbldpdGhTdGFyLCAiIiApOwoKCQlpZiAoZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkKCByZWFsVGVtcGxhdGVJZCApKSB7CgoJCQlyZXR1cm4gZW5naW5lQWRhcHRlci5yZW5kZXIoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCByZW5kZXJDb250ZXh0ICk7CgoJCX0gZWxzZSBpZiAoZW5naW5lQWRhcHRlci5yZW5kZXJBc3luYykgewoKCQkJcmV0dXJuIGVuZ2luZUFkYXB0ZXIucmVuZGVyQXN5bmMoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCByZW5kZXJDb250ZXh0ICk7CgoJCX0gZWxzZSB7CgoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQljbG9uZUV2ZW50ID0gZXh0ZW5kKCB0cnVlLCB7fSwgcmVuZGVyQ29udGV4dC5lICksCgkJCQlwdWJsaXNoZXIgPSBleHRlbmQoIHRydWUsIHt9LCBjbG9uZUV2ZW50LnB1Ymxpc2hlciApLAoJCQkJY2xvbmVkQ29udGV4dCA9IGV4dGVuZCggdHJ1ZSwge30sIHJlbmRlckNvbnRleHQgKTsKCgkJCWNsb25lRXZlbnQucHVibGlzaGVyID0gcHVibGlzaGVyOwoJCQljbG9uZWRDb250ZXh0LmUgPSBjbG9uZUV2ZW50OwoKCQkJLy90ZW1wbGF0ZS5sb2FkIGlzIGltcGxlbWVudGVkIGluIGV4dGVybmFsLXRlbXBsYXRlLmpzCgkJCXRlbXBsYXRlLmxvYWQoIHRlbXBsYXRlSWQgKS5kb25lKCBmdW5jdGlvbigpIHsKCgkJCQl2YXIgY29udGVudCA9IGVuZ2luZUFkYXB0ZXIucmVuZGVyKCByZWFsVGVtcGxhdGVJZCwgZGF0YSwgY2xvbmVkQ29udGV4dCApLAoJCQkJCXJ0biA9ICQoIGNvbnRlbnQgKTsKCgkJCQlkZWZlci5yZXNvbHZlKCBydG4uc2VsZWN0b3IgfHwgIXJ0bi5sZW5ndGggPyBjb250ZW50IDogcnRuICk7CgoJCQl9ICk7CgoJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoKCQl9Cgl9CgoJaG0udGVtcGxhdGUgPSB0ZW1wbGF0ZSA9IHsKCgkJZGVmYXVsdEVuZ2luZTogIiIsCgoJCS8qCgkJIGhtLnRlbXBsYXRlLm15RW5naW5lID0gewoJCSByZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkge30sCgkJIGNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UgKSB7fSwKCQkgaXNUZW1wbGF0ZUxvYWRlZDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7fQoJCSB9OwoJCSAqLwoJCWVuZ2luZUFkYXB0ZXI6IGZ1bmN0aW9uKCBuYW1lLCBlbmdpbmVBZGFwdGVyICkgewoJCQlpZiAoIW5hbWUpIHsKCQkJCXJldHVybiB0ZW1wbGF0ZUVuZ2luZUFkYXB0ZXJzOwoJCQl9CgkJCWlmICghZW5naW5lQWRhcHRlcikgewoJCQkJcmV0dXJuIHRlbXBsYXRlRW5naW5lQWRhcHRlcnNbbmFtZV07CgkJCX0KCQkJZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkID0gZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkIHx8IHJldHVyblRydWU7CgkJCXRlbXBsYXRlRW5naW5lQWRhcHRlcnNbbmFtZV0gPSBlbmdpbmVBZGFwdGVyOwoJCQl0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lID0gbmFtZTsKCQl9LAoKCQkvL2R5bmFtaWNhbGx5IGxvYWQgYSB0ZW1wbGF0ZSBieSB0ZW1wbGF0ZUlkLAoJCS8vaXQgaXMgY2FsbGVkIGJ5IHRlbXBsYXRlLnJlbmRlcgoJCS8vVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gcmVxdWlyZWQgbG9hZGVyLmpzCgkJLy9idXQgeW91IGNhbiBvdmVycmlkZSB0aGlzLCBhbGwgeW91IG5lZWQKCQkvLyBpcyB0byByZXR1cm4gaXMgdGhhdCBhIHByb21pc2UsIHdoZW4gdGhlIHByb21pc2UgaXMKCQkvLyBkb25lLCB0aGUgdGVtcGxhdGUgc2hvdWxkIGJlIHJlYWR5IHRvIHVzZWQKCQlsb2FkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJLy93ZSBuZWVkIHRvIG1vZGlmeSB0aGUgaWQgYnkgYWRkaW5nIGFuIGV4dGVuc2lvbiB0byB0aGUgaWQKCQkJLy8gaG0ubG9hZGVyIHVzZSBleHRlbnNpb24gdG8gZGV0ZXJtaW5lIHdoYXQgbG9hZGVyIGlzIHVzZWQKCQkJLy8gaGFuZGxlIHRoZSBhY3R1YWwgbG9hZGluZyB3b3JrCgkJCXJldHVybiBfbG9hZGVyLmxvYWQoIHRlbXBsYXRlSWQuZW5kc1dpdGgoICIuaHRtbCIgKSA/IHRlbXBsYXRlSWQgOiB0ZW1wbGF0ZUlkICsgIi50ZW1wbGF0ZSIgKTsKCQl9LAoKCQkvL3RoaXMgc2hvdWxkIGJlIGNhbGxlZCBieSBobS50ZW1wbGF0ZS5sb2FkIGFmdGVyIHRoZSBtZXRob2QKCQkvL2dldCB0aGUgc291cmNlIG9mIHRoZSB0ZW1wbGF0ZQoJCWNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UsIGVuZ2luZU5hbWUgKSB7CgkJCXJldHVybiBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSApLmNvbXBpbGUoCgkJCQl0ZW1wbGF0ZUlkLmVuZHNXaXRoKCAiLnRlbXBsYXRlIiApID8gX2xvYWRlci5maWxlTmFtZSggdGVtcGxhdGVJZCApIDogdGVtcGxhdGVJZCwKCQkJCXNvdXJjZSApOwoJCX0sCgoJCS8vYnVpbGQgYSBjdXN0b21pemVkIGhhbmRsZXIgd2hpY2ggaGFuZGxlIHRoZSBjaGFuZ2Ugb2YgbW9kZWwKCQkvL2J5IGRlZmF1bHQKCQkvL2dldEZpbHRlciBpcyAiZ2V0IiB3aGljaCBpcyB0byBnZXQgbW9kZWwgdmFsdWUsCgkJLy8gaXQgY2FuIGJlIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIChlKSB7fQoJCS8vCgkJLy9zZXRGaWx0ZXIgaXMgImh0bWwiIHdoaWNoIGlzIHRvIGNoYW5nZSB0aGUgY29udGVudCBvZiB0aGUgdmlldwoJCS8vaXQgY2FuIGJlIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIChlLCB2YWx1ZSkKCQluZXdUZW1wbGF0ZUhhbmRsZXI6IG5ld1RlbXBsYXRlSGFuZGxlciwKCgkJdGVtcGxhdGVJZFRvVXJsOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCgkJCXZhciBtYXRjaCA9IHJCZWdpbldpdGhBcGsuZXhlYyggdGVtcGxhdGVJZCApOwoKCQkJcmV0dXJuIG1hdGNoID8KCQkJCS8vYXBrLmhlbGxvIC0tPiBhcHBsZXQvaGVsbG8vbWFpbi5odG1sCgkJCQkvL2Fway5oZWxsby5ieWUgLS0+IGFwcGxldC9oZWxsby9ieWUuaHRtbAoJCQkJImFway8iICsgbWF0Y2hbMV0gKyAiLyIgKyAobWF0Y2hbM10gfHwgIm1haW4iICkgKyAiLmh0bWwiIDoKCgkJCQkvL3h4eC5odG1sIC0tPiB4eHguaHRtbAoJCQkJLy94eHgueXl5Lmh0bWwgLS0+IHh4eC55eXkuaHRtbAoJCQkJdGVtcGxhdGVJZC5lbmRzV2l0aCggIi5odG1sIiApID8gdGVtcGxhdGVJZCA6CgoJCQkJCS8veHh4IC0tPiB4eHguaHRtbAoJCQkJCS8veHh4Lnl5eSAtLT4geHh4Lmh0bWwKCQkJCQl0ZW1wbGF0ZUlkLnNwbGl0KCAiLiIgKVswXSArICIuaHRtbCI7CgoJCX0KCgl9OwoKCV9sb2FkZXIoICJ0ZW1wbGF0ZSIsIHsKCgkJbG9hZDogewoJCQljb21waWxlOiBmdW5jdGlvbiggbW9kdWxlSWQsIHNvdXJjZUNvZGUgKSB7CgoJCQkJdmFyICRzY3JpcHRMaXN0ID0gJCggc291cmNlQ29kZSApOwoKCQkJCXZhciBoYXNTY3JpcHRUYWcgPSBmYWxzZTsKCQkJCSRzY3JpcHRMaXN0LmVhY2goIGZ1bmN0aW9uKCkgewoKCQkJCQlpZiAodGhpcy50YWdOYW1lID09ICJTQ1JJUFQiKSB7CgkJCQkJCWhhc1NjcmlwdFRhZyA9IHRydWU7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9ICk7CgoJCQkJaWYgKGhhc1NjcmlwdFRhZykgewoKCQkJCQkkc2NyaXB0TGlzdC5lYWNoKCBmdW5jdGlvbigpIHsKCgkJCQkJCWlmICh0aGlzLnRhZ05hbWUgPT0gIlNDUklQVCIpIHsKCgkJCQkJCQl2YXIgJHNvdXJjZUNvZGVDb250YWluZXIgPSAkKCB0aGlzICk7CgoJCQkJCQkJdGVtcGxhdGUuY29tcGlsZSgKCQkJCQkJCQl0aGlzLmlkLAoJCQkJCQkJCSRzb3VyY2VDb2RlQ29udGFpbmVyLmh0bWwoKSwKCQkJCQkJCQkkc291cmNlQ29kZUNvbnRhaW5lci5hdHRyKCAidHlwZSIgKSB8fCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lICk7CgkJCQkJCX0KCgkJCQkJfSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZW1wbGF0ZS5jb21waWxlKCBtb2R1bGVJZCwgc291cmNlQ29kZSwgdGVtcGxhdGUuZGVmYXVsdEVuZ2luZSApOwoJCQkJfQoKCQkJfSwKCQkJYnVpbGREZXBlbmRlbmNpZXM6ICJwYXJzZURlcGVuZHNUYWciCgkJfSwKCgkJdXJsOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJLy9maXJzdCB0cnVuY2F0ZSB0aGUgIi50ZW1wbGF0ZSIgaW4gdGhlIHRlbXBsYXRlSWQsIGFuZCBnZXQgdGhlIHJlYWwgdGVtcGxhdGVJZAoJCQlyZXR1cm4gdGVtcGxhdGUudGVtcGxhdGVJZFRvVXJsKCBfbG9hZGVyLmZpbGVOYW1lKCB0ZW1wbGF0ZUlkICkgKTsKCQl9Cgl9ICk7CgoJX2xvYWRlciggImh0bWwiLCAidGVtcGxhdGUiLCB7CgkJLy8JCWxvYWQ6IHsKCQkvLwkJCWNvbXBpbGU6IGZ1bmN0aW9uKCBtb2R1bGVJZCwgc291cmNlQ29kZSApIHsKCQkvLwkJCQlyZXR1cm4gdGVtcGxhdGUuY29tcGlsZSggbW9kdWxlSWQsIHNvdXJjZUNvZGUsIHRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgKTsKCQkvLwkJCX0KCQkvLwkJfQoKCQl1cmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQlyZXR1cm4gdGVtcGxhdGVJZDsKCQl9Cgl9ICk7CgoKCWlmICgkLnJlbmRlciAmJiAkLnRlbXBsYXRlcykgewoKCQl2YXIgZW5naW5lOwoKCgkJdGVtcGxhdGUuZW5naW5lQWRhcHRlciggImpzcmVuZGVyIiwgZW5naW5lID0gewoKCQkJcmVuZGVyOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgZGF0YSwgY29udGV4dCApIHsKCQkJCWlmICghJC5yZW5kZXJbdGVtcGxhdGVJZF0pIHsKCQkJCQl0aGlzLmNvbXBpbGUoIHRlbXBsYXRlSWQsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCB0ZW1wbGF0ZUlkICkuaW5uZXJIVE1MICk7CgkJCQl9CgkJCQlyZXR1cm4gJC5yZW5kZXJbdGVtcGxhdGVJZF0oIGRhdGEsIGNvbnRleHQgKTsKCQkJfSwKCgkJCWNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UgKSB7CgkJCQkkLnRlbXBsYXRlcyggdGVtcGxhdGVJZCwgewoJCQkJCW1hcmt1cDogc291cmNlLAoJCQkJCWRlYnVnOiBlbmdpbmUudGVtcGxhdGVEZWJ1Z01vZGUsCgkJCQkJYWxsb3dDb2RlOiBlbmdpbmUuYWxsb3dDb2RlSW5UZW1wbGF0ZQoJCQkJfSApOwoJCQl9LAoKCQkJaXNUZW1wbGF0ZUxvYWRlZDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7CgkJCQlyZXR1cm4gISEkLnJlbmRlclt0ZW1wbGF0ZUlkXSB8fCAhIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCB0ZW1wbGF0ZUlkICk7CgkJCX0sCgoJCQkvL3RlbXBsYXRlRGVidWdNb2RlIGlzIGpzUmVuZGVyIHNwZWNpZmljIHNldHRpbmcKCQkJdGVtcGxhdGVEZWJ1Z01vZGU6IGZhbHNlLAoKCQkJLy9hbGxvd0NvZGVJblRlbXBsYXRlIGlzIGpzUmVuZGVyIHNwZWNpZmljIHNldHRpbmcKCQkJYWxsb3dDb2RlSW5UZW1wbGF0ZTogdHJ1ZQoJCX0gKTsKCgkJdmFyIHRhZ3MgPSAkLnZpZXdzLnRhZ3M7CgoJCS8vdGhlIGZvbGxvd2luZyB0YWdzIGEganNyZW5kZXIgc3BlY2lmaWMgaGVscGVyCgkJdGFncyggewoKCQkJLy97e3RzIC99fSBzbyB0aGF0IGl0IGNhbiBlbWl0IGEgdGltZXN0YW1wCgkJCXRzOiBmdW5jdGlvbiB4KCkgewoJCQkJcmV0dXJuIHguZW5hYmxlZCA/CgkJCQkJIjxzcGFuIHN0eWxlPSdjb2xvcjpyZWQnIGRhdGEtc3ViPSdzaG93Oi8qdHMnPnVwZGF0ZWQgb246IiArICgrbmV3IERhdGUoKSArICIiKS5zdWJzdHJpbmcoIDcsIDEwICkgKyAiPC9zcGFuPiIgOgoJCQkJCSIiOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBwdWJsaXNoZXIgPSB0aGlzLmN0eC5lLnB1Ymxpc2hlcjsKCQkJCXJldHVybiBwdWJsaXNoZXIuZ2V0LmFwcGx5KCBwdWJsaXNoZXIsIGFyZ3VtZW50cyApOwoJCQl9LAoKCQkJcHJvcDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5kZXggPSB0aGlzLnRhZ0N0eC52aWV3LmluZGV4OwoKCQkJCWlmIChpc1VuZGVmaW5lZCggaW5kZXggKSkgewoJCQkJCS8vdGhpcyBpcyB0aGUgY2FzZSB3aGVuIHRlbXBsYXRlIGlzIHJlbmRlciB3aXRoCgkJCQkJLy8gYSBzaW5nbGUgZGF0YSBpdGVtIGluc3RlYWQgb2YgYXJyYXkKCQkJCQlpbmRleCA9ICh0aGlzLmN0eC5lLnB1Ymxpc2hlci5jb3VudCgpIC0gMSk7CgkJCQl9CgoJCQkJdmFyIGl0ZW1Ob2RlID0gdGhpcy5jdHguZS5wdWJsaXNoZXIuY2QoIGluZGV4ICk7CgkJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgYXJndW1lbnRzICk7CgkJCX0sCgoJCQkvL3t7Zml4ZWRSb3dJZCAvfX0KCQkJZml4ZWRSb3dJZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIi8iICsgdGhpcy5jdHgubW9kZWxQYXRoICsgIi50YWJsZS4iICsgdGhpcy5jdHguZS5wdWJsaXNoZXIuaXRlbUtleSggdGhpcy50YWdDdHgudmlldy5kYXRhICk7CgkJCX0sCgoJCQkvL3t7cm93SWQgL319CgkJCXJvd0lkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBpbmRleCA9IHRoaXMudGFnQ3R4LnZpZXcuaW5kZXgsCgkJCQkJcGF0aCA9IHRoaXMuY3R4Lm1vZGVsUGF0aDsKCgkJCQlpZiAoaXNVbmRlZmluZWQoIGluZGV4ICkpIHsKCQkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiB0ZW1wbGF0ZSBpcyByZW5kZXIgd2l0aAoJCQkJCS8vIGEgc2luZ2xlIGRhdGEgaXRlbSBpbnN0ZWFkIG9mIGFycmF5CgkJCQkJaW5kZXggPSAodGhpcy5jdHguZS5wdWJsaXNoZXIuY291bnQoKSAtIDEpOwoJCQkJfQoKCQkJCXJldHVybiAiLyIgKyBwYXRoICsgIi4iICsgaW5kZXg7CgkJCX0sCgoJCQkvL3t7bW9kZWxQYXRoIC99fQoJCQkvL2l0IHVzZWZ1bCB3aGVuICBpbiBodHRwOi8vanNiaW4uY29tL2V0YWNvYi82L2VkaXQKCQkJbW9kZWxQYXRoOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAiLyIgKyB0aGlzLmN0eC5tb2RlbFBhdGg7CgkJCX0KCgkJfSApOwoKCQl0YWdzLnRzLnJlbmRlci5lbmFibGVkID0gdHJ1ZTsKCgkJaG0oICIqdHMiLCBmYWxzZSApOwoKCX0KCgoKLy8KCgoJdmFyIEhhbmRsZWJhcnMgPSB3aW5kb3cuSGFuZGxlYmFyczsKCglpZiAoIWlzVW5kZWZpbmVkKCBIYW5kbGViYXJzICkpIHsKCgkJaG0udGVtcGxhdGUuZW5naW5lQWRhcHRlciggImhhbmRsZWJhcnMiLCB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoKCQkJCXJldHVybiBIYW5kbGViYXJzLnBhcnRpYWxzW3RlbXBsYXRlSWRdKCBkYXRhLCB7CgkJCQkJZGF0YToge3JlbmRlckNvbnRleHQ6IGNvbnRleHR9CgkJCQl9ICk7CgkJCX0sCgoJCQljb21waWxlOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgc291cmNlICkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRlbXBsYXRlSWQsIEhhbmRsZWJhcnMuY29tcGlsZSggc291cmNlICkgKTsKCQkJfSwKCgkJCWlzVGVtcGxhdGVMb2FkZWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkJcmV0dXJuICEhSGFuZGxlYmFycy5wYXJ0aWFsc1t0ZW1wbGF0ZUlkXTsKCQkJfQoKCQl9ICk7CgoJCS8ve3ttb2RlbFBhdGh9fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJtb2RlbFBhdGgiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJcmV0dXJuIG9wdGlvbnMuZGF0YS5yZW5kZXJDb250ZXh0Lm1vZGVsUGF0aDsKCQl9ICk7CgoJCS8ve3tyb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggInJvd0lkIiwgZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXJldHVybiAiLyIgKyBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dC5tb2RlbFBhdGggKyAiLiIgKyBvcHRpb25zLmRhdGEuaW5kZXggKyAiOyI7CgkJfSApOwoKCQkvL3t7Zml4ZWRSb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggImZpeGVkUm93SWQiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHJlbmRlckNvbnRleHQgPSBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dDsKCQkJcmV0dXJuICIvIiArIHJlbmRlckNvbnRleHQubW9kZWxQYXRoICsgIi50YWJsZS4iICsgcmVuZGVyQ29udGV4dC5lLnB1Ymxpc2hlci5pdGVtS2V5KCB0aGlzICk7CgkJfSApOwoKCQkvL3t7Z2V0ICIuLnNldFRvIiBuYW1lfX0KCQlIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCAiZ2V0IiwgZnVuY3Rpb24oKSB7CgkJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQkJbGFzdCA9IGFyZ3MubGVuZ3RoIC0gMSwKCQkJLy9hcmdzW2xhc3RdLmRhdGEgaXMgb3B0aW9ucy5kYXRhCgkJCQlyZW5kZXJDb250ZXh0ID0gYXJnc1tsYXN0XS5kYXRhLnJlbmRlckNvbnRleHQ7CgoJCQlyZXR1cm4gcmVuZGVyQ29udGV4dC5nZXQuYXBwbHkoIHJlbmRlckNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3MsIDAsIGxhc3QgKSApOwoJCX0gKTsKCgkJLy97e3twcm9wICJsaW5rIn19fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJwcm9wIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzbGljZSA9IFtdLnNsaWNlLAoJCQkJYXJncyA9IGFyZ3VtZW50cywKCQkJCWxhc3QgPSBhcmdzLmxlbmd0aCAtIDEsCgkJCQlvcHRpb25zID0gYXJnc1tsYXN0XSwKCQkJCWRhdGEgPSBvcHRpb25zLmRhdGEsCgkJCQlyZW5kZXJDb250ZXh0ID0gZGF0YS5yZW5kZXJDb250ZXh0LAoJCQkJaXRlbU5vZGUgPSByZW5kZXJDb250ZXh0LmUucHVibGlzaGVyLmNkKCBkYXRhLmluZGV4ICk7CgoJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgc2xpY2UuY2FsbCggYXJncywgMCwgbGFzdCApICk7CgkJfSApOwoKCQkkKCBmdW5jdGlvbigpIHsKCQkJJCggInNjcmlwdFt0eXBlPWhhbmRsZWJhcnNdIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRoaXMuaWQsIEhhbmRsZWJhcnMuY29tcGlsZSggJCggdGhpcyApWzBdLmlubmVySFRNTCApICk7CgkJCX0gKTsKCQl9ICk7CgoJfQoKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2Rvbid0IGNoYW5nZSBpdCB0byBiZWNhdXNlIHdlIHdhbnQgdG8gY29udHJvbCB0aGUgc2VhcmNoIG9yZGVyCgkvL2NoZWNrIGZpbmRWYWx1ZUFkYXB0ZXIoJGVsZW0sIGFkYXB0ZXJOYW1lKQoJLy97CgkvLyAgIG5hbWUxOiBhZGFwdGVyMSwKCS8vICAgbmFtZTI6IGFkYXB0ZXIyCgkvL30KCXZhciB2YWx1ZUFkYXB0ZXJzID0gWwoJCXsKCQkJLy90aGUgZGVmYXVsdCB2aWV3IGFkYXB0ZXIKCQkJbmFtZTogInRleHRCb3hPckRyb3BEb3duIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJaWYgKG1vZGVsVmFsdWUpIHsKCQkJCQlpZiAoJGVsZW1bMF0udGFnTmFtZSA9PSAiU0VMRUNUIikgewoJCQkJCQkkZWxlbS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKHRoaXMudmFsdWUgPT0gbW9kZWxWYWx1ZSkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGVsZW0uYXR0ciggInZhbHVlIiwgbW9kZWxWYWx1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0udmFsKCk7CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICgkZWxlbS52YWwoKSAhPT0gdmFsdWUpIHsKCQkJCQkkZWxlbS52YWwoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiByZXR1cm5UcnVlCgkJfSwKCQl7CgkJCW5hbWU6ICJjaGVja2JveCIsCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCAkZWxlbSwgbW9kZWxWYWx1ZSApIHsKCQkJCWlmIChtb2RlbFZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCgkJCQlpZiAodmFsdWUgPT0gInRydWUiKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9IGVsc2UgaWYgKHZhbHVlID09ICJmYWxzZSIpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKHZhbHVlICE9PSAib24iKSB7CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gZWxlbS5jaGVja2VkOwoJCQkJfQoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uIHNldENoZWNrYm94KCAkZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJaWYgKGlzQm9vbGVhbiggdmFsdWUgKSkgewoJCQkJCWVsZW0uY2hlY2tlZCA9IHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQllbGVtLmNoZWNrZWQgPSAodmFsdWUgPT0gZWxlbS52YWx1ZSk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICI6Y2hlY2tib3giICk7CgkJCX0KCQl9LAoJCXsKCQkJbmFtZTogInJhZGlvIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoKCQkJCWlmIChtb2RlbFZhbHVlID09ICRlbGVtWzBdLnZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQlpZiAoZS50eXBlID09ICJyZXNldFZhbCIgJiYgIWUucHVibGlzaGVyLmF0dHIoICJjaGVja2VkIiApKSB7CgkJCQkJZS5hYm9ydCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCQkJCWlmICh2YWx1ZSA9PSAidHJ1ZSIpIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgPT0gImZhbHNlIikgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgIT09ICJvbiIpIHsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBlbGVtLmNoZWNrZWQ7CgkJCQl9CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSwgZSApIHsKCQkJCXZhciBlbGVtID0gJGVsZW1bMF07CgkJCQlpZiAoIWVsZW0ubmFtZSkgewoJCQkJCWVsZW0ubmFtZSA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQl9CgkJCQllbGVtLmNoZWNrZWQgPSAoIHV0aWwudG9TdHJpbmcoIHZhbHVlICkgPT0gZWxlbS52YWx1ZSApOwoJCQl9LAoJCQltYXRjaDogZnVuY3Rpb24oICRlbGVtICkgewoJCQkJcmV0dXJuICRlbGVtLmlzKCAiOnJhZGlvIiApOwoJCQl9CgkJfSwKCQl7CgkJCW5hbWU6ICJsaXN0Qm94IiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAobW9kZWxWYWx1ZS5jb250YWlucyggdGhpcy52YWx1ZSApKSB7CgkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQl2YXIgb3B0aW9ucyA9IFtdOwoJCQkJJGVsZW0uY2hpbGRyZW4oICJvcHRpb246c2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJb3B0aW9ucy5wdXNoKCB0aGlzLnZhbHVlICk7CgkJCQl9ICk7CgkJCQlyZXR1cm4gb3B0aW9ucy5sZW5ndGggPyBvcHRpb25zIDogbnVsbDsKCQkJfSwKCQkJc2V0OiBmdW5jdGlvbiggJGVsZW0sIHZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl0aGlzLnNlbGVjdGVkID0gISEodmFsdWUgJiYgdmFsdWUuY29udGFpbnMoIHRoaXMudmFsdWUgKSk7CgkJCQl9ICk7CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICJzZWxlY3RbbXVsdGlwbGVdIiApOwoJCQl9CgkJfQoJXTsKCglmdW5jdGlvbiBmaW5kVmFsdWVBZGFwdGVyKCAkZWxlbSwgYWRhcHRlck5hbWUgKSB7CgkJdmFyIGksIGFkYXB0ZXI7CgoJCWlmIChhZGFwdGVyTmFtZSkgewoJCQlmb3IgKGkgPSB2YWx1ZUFkYXB0ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQlhZGFwdGVyID0gdmFsdWVBZGFwdGVyc1tpXTsKCQkJCWlmIChhZGFwdGVyLm5hbWUgPT0gYWRhcHRlck5hbWUpIHsKCQkJCQlyZXR1cm4gYWRhcHRlcjsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCS8vc2VhcmNoIGZyb20gdGFpbCB0byBoZWFkCgkJCWZvciAoaSA9IHZhbHVlQWRhcHRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCWFkYXB0ZXIgPSB2YWx1ZUFkYXB0ZXJzW2ldOwoJCQkJaWYgKGFkYXB0ZXIubWF0Y2ggJiYgYWRhcHRlci5tYXRjaCggJGVsZW0gKSkgewoJCQkJCXJldHVybiBhZGFwdGVyOwoJCQkJfQoJCQl9CgkJfQoJfQoKCWhtLmFjdGl2aXR5LmdldC5nZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiggZSApIHsKCQkvL2UuaGFuZGxlci5nZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLmdldFZpZXdWYWx1ZSggZS5wdWJsaXNoZXIsIGUgKTsKCX07CgoJaG0uYWN0aXZpdHkuc2V0LnNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkvL2UuaGFuZGxlci5zZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLnNldFZpZXdWYWx1ZSggdGhpcywgdmFsdWUsIGUgKTsKCX07CgoJZnVuY3Rpb24gaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBtb2RlbCwgdmlldywgaGFuZGxlciwgYWRhcHRlck5hbWUsIG1ldGhvZE5hbWUgKSB7CgoJCXZhciBhZGFwdGVyID0gZmluZFZhbHVlQWRhcHRlciggdmlldywgYWRhcHRlck5hbWUgKTsKCgkJaWYgKCFhZGFwdGVyIHx8ICFhZGFwdGVyW21ldGhvZE5hbWVdKSB7CgoJCQl0aHJvdyAiY2FuIG5vdCBmaW5kICIgKyBtZXRob2ROYW1lICsgIiBtZXRob2QgZm9yIHZpZXciOwoJCX0KCgkJLy9jcmVhdGUgaGFuZGxlci5nZXRWaWV3VmFsdWUgb3IgaGFuZGxlci5zZXRWaWV3VmFsdWUKCQloYW5kbGVyW21ldGhvZE5hbWUgKyAiVmlld1ZhbHVlIl0gPSBhZGFwdGVyW21ldGhvZE5hbWVdOwoKCQlpZiAoYWRhcHRlci5jb252ZXJ0KSB7CgkJCWhhbmRsZXIuY29udmVydCA9IGFkYXB0ZXIuY29udmVydDsKCQl9CgoJCS8vd2Ugd2FudCB0byBydW4gdGhlIGluaXRpYWxpemUgbWV0aG9kIG9ubHkgb25jZQoJCWlmICghdmlldy5obURhdGEoICJ2YWx1ZUJvdW5kIiApKSB7CgoJCQlhZGFwdGVyLmluaXRpYWxpemUgJiYgYWRhcHRlci5pbml0aWFsaXplKCB2aWV3LCBtb2RlbC5nZXQoKSApOwoKCQkJLy93aGVuICJyZXNldCIgZXZlbnQgaXMgdHJpZ2dlciB0byBwYXJlbnQgZm9ybSwgdGhlIGNoaWxkcmVuIGRvZXMKCQkJLy9ub3QgdHJpZ2dlciB0aGUgZXZlbnQsIHNvIHRoYXQgd2UgbmVlZCB0byB0cmlnZ2VyICJyZXNldFZhbCIgdG8gdXBkYXRlCgkJCS8vYmFjayB0aGUgb3JpZ2luYWwgdmFsdWUgdG8gbW9kYWwKCQkJdmlldy5wYXJlbnRzKCAiZm9ybSIgKS5iaW5kKCAicmVzZXQiLCBmdW5jdGlvbigpIHsKCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl2aWV3LnRyaWdnZXJIYW5kbGVyKCAicmVzZXRWYWwiICk7CgkJCQl9LCAxMCApOwoJCQl9ICk7CgoJCQl2aWV3LmhtRGF0YSggInZhbHVlQm91bmQiLCB0cnVlICk7CgoJCX0KCX0KCglobS53b3JrZmxvdyggewoKCQkvL3NldCB2aWV3IHZhbHVlIHdpdGggbW9kZWwgdmFsdWUKCQl1cGRhdGVWaWV3VmFsdWU6IHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lICkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIHZpZXcsIHRyeWluZyB0byBnZXRNb2RlbCBzZXRWaWV3CgkJCQlpbml0QWRhcHRlck1ldGhvZEZvclZpZXcoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lLCAic2V0IiApOwoKCQkJfSwKCQkJZ2V0OiAiZ2V0IiwKCQkJc2V0OiAiKnNldFZpZXdWYWx1ZSIKCQl9LAoKCQkvL3NldCBtb2RlbCB2YWx1ZSB3aXRoIHZpZXcgdmFsdWUKCQl1cGRhdGVNb2RlbFZhbHVlOiB7CgoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgYWRhcHRlck5hbWUgKSB7CgkJCQkvL3B1Ymxpc2hlciBpcyB2aWV3LCB0cnlpbmcgdG8gZ2V0VmlldyBzZXRNb2RlbAoJCQkJaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIHdvcmtmbG93LCBhZGFwdGVyTmFtZSwgImdldCIgKTsKCgkJCX0sCgkJCWdldDogIipnZXRWaWV3VmFsdWUiLAoJCQlzZXQ6ICJzZXQiCgkJfQoJfSApOwoKCS8vYWRkIHZhbHVlIGFkYXB0ZXIKCS8vdGhlIGxhc3QgYWRkZWQgdXNpbmcgdGhlIG1ldGhvZCwgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCS8qCgkgLy9hIHZpZXcgYWRhcHRlciBpcyBpcyBsaWtlCgkgewoJIC8vb3B0aW9uYWwgaWYgbWF0Y2ggZnVuY3Rpb24gaXMgcHJlc2VudAoJIG5hbWU6ICJhZGFwdGVyTmFtZSIsCgkgLy8KCSAvL29wdGlvbmFsIGlmIG5hbWUgaXMgcHJlc2VudAoJIG1hdGNoOiBmdW5jdGlvbiAoJGVsZW0pIHsgcmV0dXJuIHRydWU7IH0sCgkgLy8KCSAvL3ByZXBhcmUgJGVsZW1lbnQKCSBpbml0aWFsaXplOiBmdW5jdGlvbiAoJGVsZW0pIHt9CgkgLy8KCSAvL2dldCBhIHZhbHVlIGZyb20gZWxlbWVudAoJIGdldDogZnVuY3Rpb24gKCRlbGVtKSB7fSwKCSAvLwoJIC8vc2V0IGEgdmFsdWUgdG8gJGVsZW1lbnQKCSBzZXQ6IGZ1bmN0aW9uKCAkZWxlbSwgdmFsdWUgKSB7fSwKCSAvLwoJIC8vb3B0aW9uYWwsIGlmIGdldCBmdW5jdGlvbiBhbHJlYWR5IGNvbnZlcnQsIHlvdSBkb24ndCBuZWVkIHRoaXMKCSBjb252ZXJ0OiAiKmNvbW1vbkNvbnZlcnRBY3Rpdml0eU5hbWUiIG9yIGZ1bmN0aW9uICh2YWx1ZSkge30KCgkgfQoJICogKi8KCWhtLnZhbHVlQWRhcHRlciA9IGZ1bmN0aW9uKCBhZGFwdGVyICkgewoJCWlmIChhZGFwdGVyKSB7CgkJCXZhbHVlQWRhcHRlcnMucHVzaCggYWRhcHRlciApOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2YWx1ZUFkYXB0ZXJzOwoJCX0KCX07CgoJLy9keW5hbWljIGdyb3VwCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZwoJLy8KCS8vdmFsOnBhdGgKCS8vdmFsOnBhdGh8a2V5cHJlc3MKCS8vdmFsOnBhdGh8LHVwZGF0ZU1vZGVsCgkvL3ZhbDpwYXRofCx1cGRhdGVWaWV3CgkvL3ZhbDpwYXRofCwsZGF0ZQoJLy92YWw6cGF0aHx1cGRhdGVFdmVudCx1cGRhdGVEaXJlY3Rpb24sYWRhcHRlck5hbWUKCWJpbmRpbmdzKCB7CgkJdmFsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciB1cGRhdGVUYXJnZXQsCgkJCQl1cGRhdGVFdmVudCwKCQkJCWFkYXB0ZXJOYW1lOwoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgoJCQlpZiAoIW9wdGlvbnMpIHsKCQkJCXVwZGF0ZUV2ZW50ID0gImNoYW5nZSI7CgkJCX0gZWxzZSB7CgkJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCQl1cGRhdGVFdmVudCA9IG9wdGlvbnNbMF0gfHwgImNoYW5nZSI7IC8vYnkgZGVmYXVsdCBpdCBpcyAiY2hhbmdlIgoJCQkJdXBkYXRlVGFyZ2V0ID0gb3B0aW9uc1sxXTsgLy91bmRlZmluZWQsIHVwZGF0ZVZpZXcgb3IgdXBkYXRlTW9kZWwKCQkJCWFkYXB0ZXJOYW1lID0gb3B0aW9uc1syXTsKCQkJfQoKCQkJaWYgKCF1cGRhdGVUYXJnZXQgfHwgdXBkYXRlVGFyZ2V0ID09ICJ2aWV3IikgewoJCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MSBhZnRlcioiLCAiKnVwZGF0ZVZpZXdWYWx1ZSIsIGFkYXB0ZXJOYW1lICk7CgkJCX0KCgkJCWlmICghdXBkYXRlVGFyZ2V0IHx8IHVwZGF0ZVRhcmdldCA9PSAibW9kZWwiKSB7CgoJCQkJLy93aGVuIGZvcm0gaXMgcmVzZXQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIGZvcm0gdmFsdWUgaXMgcmVzZXQKCQkJCS8vIHRvIHZhbHVlIHNwZWNpZnkgInZhbHVlIiBhdHRyaWJ1dGUsIGhvd2V2ZXIgdGhlIGNoYW5nZSBldmVudCBkb2VzIG5vdCB0cmlnZ2VyLAoJCQkJLy8KCQkJCS8vc28gd2UgbmVlZCB0byB1c2UgYSBzcGVjaWFsIGV2ZW50ICJyZXNldFZhbCIgd2hpY2ggaXMgdHJpZ2dlcmVkCgkJCQkvLyB3aGVuIHRoZSBwYXJlbnQgZm9ybSBlbGVtZW50IGlzIHRyaWdnZXJlZAoJCQkJLy8gYnkgdXNpbmcgdGhpcyBldmVudCwgd2Ugd2FudCB0byB1cGRhdGUgbW9kZWwgZnJvbSB0aGUgdmlldyB2YWx1ZQoJCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCB1cGRhdGVFdmVudCArICIgcmVzZXRWYWwiLCAiKnVwZGF0ZU1vZGVsVmFsdWUiLCBhZGFwdGVyTmFtZSApOwoKCQkJfQoJCX0KCX0gKTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanMsIHRlbXBsYXRlLmpzPC9AZGVwZW5kcz4KCgoJZGVmYXVsdE9wdGlvbnMuY29uZmlybU1lc3NhZ2UgPSAiQXJlIHlvdSBzdXJlPyI7CgoJZnVuY3Rpb24gYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggZmVhdHVyZXMgKSB7CgkJZm9yICh2YXIgbmFtZSBpbiBmZWF0dXJlcykgewoJCQl2YXIgaXRlbSA9IGZlYXR1cmVzW25hbWVdOwoJCQliaW5kaW5ncyggbmFtZSwgaXRlbVswXSApOwoJCQlobS53b3JrZmxvdyggbmFtZSwgaXRlbVsxXSApOwoJCX0KCX0KCglobS5hY3Rpdml0eS5nZXQuY29tcGFyZVRydXRoeSA9IGZ1bmN0aW9uKCBlICkgewoJCXZhciBleHByZXNzaW9uID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoJCXJldHVybiBpc1VuZGVmaW5lZCggZXhwcmVzc2lvbiApID8KCQkJIXB1Ymxpc2hlci5pc0VtcHR5KCkgOgoJCQlwdWJsaXNoZXIuY29tcGFyZSggZXhwcmVzc2lvbiApOwoJfTsKCglobS5hY3Rpdml0eS5pbml0aWFsaXplLmV4dHJhY3RDbGFzcyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCXZhciBwYXJ0cyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCXdvcmtmbG93LmNsYXNzTmFtZSA9IHBhcnRzWzBdOwoJCXdvcmtmbG93Lm9wdGlvbnMgPSBwYXJ0c1sxXTsKCX07CgoJYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggewoKCQkvLy0tLS0tLS0tY2hhbmdpbmcgdmlldy0tLS0tLS0tLS0KCQlvcHRpb25zOiBbCgkJCSIhaW5pdCBhZnRlcio6Lnwqb3B0aW9ucyIsCgkJCS8vYWRkIG1vZGVsIHdvcmtmbG93cwoJCQkvL3JlbmRlciA8c2VsZWN0PiBvcHRpb25zCgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGgiPgoJCQkvLzxzZWxlY3Qgb3B0aW9ucz0ibW9kZWxQYXRofHByb3BlcnR5TmFtZSI+CgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGh8dGV4dENvbHVtbix2YWxDb2x1bW4iPgoJCQl7CgkJCQkvL3RoaXMgaXMgYWN0dWFsbHkgdGhlIGV4ZWN1dGUgZnVuY3Rpb24sIGluIHRoaXMgd29ya2Zsb3cKCQkJCS8vdGhlcmUgaXMgbm8gc2V0LCB0aGUgY29udGVudCBvZiB0aGUgdmlldyBpcyByZW5kZXIKCQkJCS8vaW4gdGhlIGdldCBmdW5jdGlvbi4KCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG9wdGlvbnMgPSBlLmhhbmRsZXIub3B0aW9ucywKCQkJCQkJc3Vic2NyaWJlciA9IHRoaXMsCgkJCQkJCXZhbHVlID0gc3Vic2NyaWJlci52YWwoKTsKCgkJCQkJc3Vic2NyaWJlci5jaGlsZHJlbiggIm9wdGlvbltsaXN0SXRlbV0iICkKCQkJCQkJLnJlbW92ZSgpLmVuZCgpLmFwcGVuZCgKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgaHRtbCA9ICIiOwoJCQkJCQkJJCggZS5wdWJsaXNoZXIuZ2V0KCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCQlodG1sICs9ICI8b3B0aW9uIGxpc3RJdGVtPScxJyB2YWx1ZT0nIiArIG9wdGlvbnMudmFsdWUoIHRoaXMgKSArICInPiIgKyBvcHRpb25zLm5hbWUoIHRoaXMgKSArICI8L29wdGlvbj4iOwoJCQkJCQkJfSApOwoJCQkJCQkJcmV0dXJuIGh0bWw7CgkJCQkJCX0gKS52YWwoIHZhbHVlICk7CgoJCQkJCWlmIChzdWJzY3JpYmVyLnZhbCgpICE9PSB2YWx1ZSkgewoJCQkJCQkkKCBzdWJzY3JpYmVyLnRyaWdnZXIoICJjaGFuZ2UiICkgKTsKCQkJCQl9CgkJCQl9LAoKCQkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCQkJCWlmIChvcHRpb25zKSB7CgoJCQkJCQl2YXIgcGFydHMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKSwKCQkJCQkJCXRleHRDb2x1bW4gPSBwYXJ0c1swXSwKCQkJCQkJCXZhbHVlQ29sdW1uID0gcGFydHNbMV0gfHwgcGFydHNbMF07CgoJCQkJCQl3b3JrZmxvdy5vcHRpb25zID0gewoJCQkJCQkJbmFtZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCQkJCQkJcmV0dXJuIGl0ZW1bdGV4dENvbHVtbl07CgkJCQkJCQl9LAoJCQkJCQkJdmFsdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQkJCQkJCXJldHVybiBpdGVtW3ZhbHVlQ29sdW1uXTsKCQkJCQkJCX0KCQkJCQkJfTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXdvcmtmbG93Lm9wdGlvbnMgPSB7CgkJCQkJCQluYW1lOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfSwKCQkJCQkJCXZhbHVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCXNob3c6IFsKCgkJCS8vZGF0YS1zdWI9ImBzaG93OnBhdGgiCgkJCSIhaW5pdCBhZnRlcio6Lnwqc2hvdyIsCgoJCQl7CgoJCQkJZ2V0OiAiKmNvbXBhcmVUcnV0aHkiLAoKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1t0cnV0aHkgPyAic2hvdyIgOiAiaGlkZSJdKCk7CgoJCQkJfQoJCQl9CgoJCV0sCgoJCWhpZGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqaGlkZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJLy91c2Ugc3Vic2NyaXB0aW9uIGdyb3VwIGluc3RlYWQKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1sgdHJ1dGh5ID8gImhpZGUiIDogInNob3ciXSgpOwoJCQkJfQoJCQl9CgkJXSwKCgkJZW5hYmxlOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmVuYWJsZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5ICkgewoKCQkJCQl0aGlzLmF0dHIoICJkaXNhYmxlZCIsICF0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWRpc2FibGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqZGlzYWJsZSIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHkgKSB7CgkJCQkJdGhpcy5hdHRyKCAiZGlzYWJsZWQiLCB0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWFkZENsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmFkZENsYXNzIiwKCQkJewoKCQkJCWluaXRpYWxpemU6ICIqZXh0cmFjdENsYXNzIiwKCgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5LCBlICkgewoKCQkJCQl0aGlzW3RydXRoeSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSggZS5oYW5kbGVyLmNsYXNzTmFtZSApOwoJCQkJfQoJCQl9CgkJXSwKCgkJcmVtb3ZlQ2xhc3M6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqcmVtb3ZlQ2xhc3MiLCB7CgoJCQkJaW5pdGlhbGl6ZTogIipleHRyYWN0Q2xhc3MiLAoKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCXRoaXNbdHJ1dGh5ID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKCBlLmhhbmRsZXIuY2xhc3NOYW1lICk7CgoJCQkJfQoJCQl9CgkJXSwKCiAgICAgICAgLy90aGUgY2xhc3MgbmFtZSBjYW4gYmUgcGFzc2VkIGFzIG9wdGlvbnMgcGFyYW1ldGVyCiAgICAgICAgLy9vciB0aGUgY2xhc3MgbmFtZSBpcyB0aGUgdmFsdWUgb2YgdGhlIG1vZGVsCiAgICAgICAgLy8KICAgICAgICAvL3RvZ2dsZS1jbGFzcz0ibW9kZWwiCiAgICAgICAgLy9vcgogICAgICAgIC8vPHAgIWFmdGVyVXBkYXRlPSJpc0hhcHB5fCpmYWtlR2V0IHRvZ2dsZUNsYXNzKmhhcHB5IiA+PC9wPgoJCXRvZ2dsZUNsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KnRvZ2dsZUNsYXNzIiwgewoKCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG1ldGhvZCwKCQkJCQkJcmV2ZXJzZSwKCQkJCQkJdmFsdWUgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCQkJY2xhc3NOYW1lID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQkJCWlmIChjbGFzc05hbWUpIHsKCQkJCQkJaWYgKGNsYXNzTmFtZS5zdGFydHNXaXRoKCAiISIgKSkgewoJCQkJCQkJcmV2ZXJzZSA9IHRydWU7CgkJCQkJCQljbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKCAxICk7CgkJCQkJCX0KCgkJCQkJCW1ldGhvZCA9IHZhbHVlIF4gcmV2ZXJzZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiOwoJCQkJCX0KCgkJCQkJaWYgKGUudHlwZSA9PSAiaW5pdCIpIHsKCgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLmFkZENsYXNzKCB2YWx1ZSApOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLnJlbW92ZUNsYXNzKCBlLnJlbW92ZWQgKS5hZGRDbGFzcyggdmFsdWUgKTsKCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQldLAoKCQkvL2ZvY3VzOippc0VkaXRNb2RlCgkJLy9mb2N1cyBvbiBhIHZpZXcgaWYgbW9kZWwgaXMgbm90IGVtcHR5CgkJZm9jdXM6IFsKCQkJIiFpbml0IGFmdGVyKjoufCpmb2N1cyIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCWlmICh0cnV0aHkpIHsKCQkJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXN1YnNjcmliZXIuZm9jdXMoKS5zZWxlY3QoKTsKCQkJCQkJfSwgMSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCWNvdW50OiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmNvdW50IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHZhbHVlID0gZS5wdWJsaXNoZXIuZ2V0KCksCgkJCQkJY291bnQgPSAoICJsZW5ndGgiIGluIHZhbHVlKSA/IHZhbHVlLmxlbmd0aCA6IHZhbHVlOwoKCQkJCXRoaXMudGV4dCggY291bnQgKTsKCQkJfQoJCV0sCgoJCWR1bXA6IFsKCgkJCSIhaW5pdCAqOi58KmR1bXAiLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIWUudHlwZS5zdGFydHNXaXRoKCAiYmVmb3JlIiApKSB7CgkJCQkJdGhpcy5odG1sKCAiPHNwYW4gc3R5bGU9J2NvbG9yOnJlZCc+IiArIGUucHVibGlzaGVyLnBhdGggKyAiIDogIiArIGUucHVibGlzaGVyLnRvSlNPTigpICsgIjwvc3Bhbj4iICk7CgkJCQl9CgkJCX0KCQldLAoKCQkvL2FsZXJ0OnBhdGggLy90aGlzIHdpbGwgYWxlcnQgdGhlIGRhdGEgaW4gbW9kZWwKCQkvL2FsZXJ0Ol98aGVsbG8gd29ybGQgLy90aGlzIHdpbGwgYWxlcnQgImhlbGxvIHdvcmxkIgoJCWFsZXJ0OiBbCgoJCQkiJGNsaWNrOi58KmFsZXJ0IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJYWxlcnQoIGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8gdGhpcy5nZXQoKSA6IGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCgkJXSwKCgkJbG9nOiBbCgoJCQkiJGNsaWNrOi58KmxvZyIsCgoJCQlmdW5jdGlvbiAoZSkgewoJCQkJaG0ubG9nKCBpc1VuZGVmaW5lZCggZS5oYW5kbGVyLm9wdGlvbnMgKSA/IHRoaXMuZ2V0KCkgOiBlLmhhbmRsZXIub3B0aW9ucyApOwoJCQl9CgkJXSwKCQlwcmV2ZW50RGVmYXVsdDogWwoKCQkJIiRjbGljazpffCpwcmV2ZW50RGVmYXVsdCIsCgoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCV0sCgoJCXN0b3BQcm9wYWdhdGlvbjogWwoKCQkJIiRjbGljazpffCpzdG9wUHJvcGFnYXRpb24iLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJXSwKCgkJLy9jb25maXJtOl8KCQkvL2NvbmZpcm06cGF0aAoJCS8vY29uZmlybTpffHlvdXIgbWVzc2FnZQoJCWNvbmZpcm06IFsKCgkJCS8vcmVwbGFjaW5nICIkY2xpY2s6LnwqY29uZmlybSIsIHdpdGggZHluYW1pYyBiaW5kaW5nLAoJCQkvL3NvIHRoYXQgaXQgY2FuIGJlIGZpeCB0aGUgcHJvYmxlbSBjYXVzZWQgYnkgbWFwRXZlbnQKCQkJLy9hcyBsb25nIGFzIGl0IGlzIHBsYWNlZCBiZWZvcmUgbWFwRXZlbnQgZHluYW1pYyBiaW5kaW5nCgkJCWZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBvcHRpb25zICkgewoJCQkJaG0uc3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNvbmZpcm0iLCBvcHRpb25zICk7CgkJCX0sCgoJCQlmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbWVzc2FnZSA9IGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8KCQkJCQl0aGlzICYmIHRoaXMucGF0aCAmJiB0aGlzLmdldCAmJiB0aGlzLmdldCgpIHx8IGRlZmF1bHRPcHRpb25zLmNvbmZpcm1NZXNzYWdlIDoKCQkJCQllLmhhbmRsZXIub3B0aW9uczsKCgkJCQlpZiAoIWNvbmZpcm0oIG1lc3NhZ2UgKSkgewoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQldLAoKCQkvLy8tLS0tLS1jaGFuZ2luZyBtb2RlbC0tLS0tLS0tLS0tLQoJCXNldFRvOiBbCgkJCSIkY2xpY2s6Lnwqc2V0VG8iLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvd0luc3RhbmNlLCBvcHRpb25zICkgewoJCQkJCXdvcmtmbG93SW5zdGFuY2Uuc2V0VG8gPSB0b1R5cGVkVmFsdWUoIG9wdGlvbnMgKTsKCQkJCX0sCgkJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJCXRoaXMuc2V0KCBlLmhhbmRsZXIuc2V0VG8gKTsKCQkJCX0KCQkJfQoJCV0sCgoJCSIwIjogWwoJCQkiJGNsaWNrOi58KjAiLAoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggMCApOwoJCQl9CgkJXSwKCgkJZW1wdHlTdHJpbmc6IFsKCQkJIiRjbGljazoufCplbXB0eSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCAiIiApOwoJCQl9CgkJXSwKCgkJIm51bGwiOiBbCgkJCSIkY2xpY2s6LnwqbnVsbCIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggbnVsbCApOwoJCQl9CgkJXSwKCgkJInRydWUiOiBbCgoJCQkiJGNsaWNrOi58KnRydWUiLAoKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIHRydWUgKTsKCQkJfQoJCV0sCgoJCSIrKyI6IFsKCQkJIiRjbGljazoufCorKyIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggdGhpcy5nZXQoKSArIDEgKTsKCQkJfQoJCV0sCgoJCSItLSI6IFsKCQkJIiRjbGljazoufCotLSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCB0aGlzLmdldCgpIC0gMSApOwoJCQl9CgkJXSwKCgkJImZhbHNlIjogWwoJCQkiJGNsaWNrOi58KmZhbHNlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIGZhbHNlICk7CgkJCX0KCQldLAoKCQl0b2dnbGU6IFsKCgkJCSIkY2xpY2s6LnwqdG9nZ2xlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJc3Vic2NyaWJlci5zZXQoICFzdWJzY3JpYmVyLmdldCgpICk7CgkJCX0KCQldLAoKCQlzb3J0SXRlbXM6IFsKCQkJIiRjbGljazoufCpzb3J0SXRlbXMiLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgb3B0aW9ucyApIHsKCQkJCQlvcHRpb25zID0gKG9wdGlvbnMgfHwgIiIpICYmIG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkJCXdvcmtmbG93LmJ5ID0gb3B0aW9uc1swXTsKCQkJCQkvL2JlY2F1c2Ugb3B0aW9uc1sxXSBkZWZhdWx0IGlzIHVuZGVmaW5lZAoJCQkJCS8vc28gYXNjIGlzIGJ5IGRlZmF1bHQKCQkJCQl3b3JrZmxvdy5hc2MgPSAhIW9wdGlvbnNbMV07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgkJCQkJdGhpcy5zb3J0KCB3b3JrZmxvdy5ieSwgd29ya2Zsb3cuYXNjICk7CgkJCQkJd29ya2Zsb3cuYXNjID0gIXdvcmtmbG93LmFzYzsKCQkJCX0KCQkJfQoJCV0sCgoJCWNsZWFyOiBbCgoJCQkiJGNsaWNrOi58KmNsZWFyIiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuY2xlYXIoKTsKCQkJfQoJCV0sCgoJCWRlbDogWwoJCQkiJGNsaWNrOi58KmRlbDtjb25maXJtOl98X0RvIHlvdSB3YW50IHRvIGRlbGV0ZSB0aGlzIGl0ZW0/IiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuZGVsKCk7CgkJCX0KCQldCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJY2FwdGlvbjogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQkkKCBlbGVtICkucHJlcGVuZCggIjxvcHRpb24gdmFsdWU9Jyc+IiArIChvcHRpb25zIHx8IGhtLmdldCggcGF0aCApIHx8ICIiKSArICI8L29wdGlvbj4iICk7CgkJfSwKCgkJYXV0b2ZvY3VzOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJfSwgMSApOwoJCX0sCgoJCW1hcEV2ZW50OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkkKCBlbGVtICkubWFwRXZlbnQoIG9wdGlvbnNbMF0sIG9wdGlvbnNbMV0sIG9wdGlvbnNbMl0gKTsKCgkJfSwKCgkJbWFwQ2xpY2s6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgb3B0aW9uc1swXSwgb3B0aW9uc1sxXSApOwoJCX0sCgoJCWxvZ1BhbmVsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCSQoIGVsZW0gKS5jc3MoICJsaXN0LXN0eWxlLXR5cGUiLCAiZGVjaW1hbCIgKS5jc3MoICJmb250LWZhbWlseSIsICJtb25vc3BhY2UsIHNlcmlmIiApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImluaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBhbGxMb2dzID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFsbExvZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLmFwcGVuZCggIjxsaT4iICsgYWxsTG9nc1tpXSArICI8L2xpPiIgKTsKCQkJCX0KCQkJfSApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImFmdGVyQ3JlYXRlLjEiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuYXBwZW5kKCAiPGxpPiIgKyBlLm9yaWdpbmFsUHVibGlzaGVyLnJhdygpICsgIjwvbGk+IiApOwoJCQl9ICk7CgoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgIipsb2ciLCAiYWZ0ZXJDcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuZW1wdHkoKTsKCQkJfSApOwoJCX0sCgoJCWNsZWFybG9nOiAiY2xlYXI6Lypsb2ciLAoKCQkvL2RhdGEtc3ViPSJlbmFibGVMYXRlcjpwYXRoIgoJCWVuYWJsZUxhdGVyOiAiIWFmdGVyKjoufCplbmFibGUiLAoKCQkvL2RhdGEtc3ViPSJkaXNhYmxlTGF0ZXI6cGF0aCIKCQlkaXNhYmxlTGF0ZXI6ICIhYWZ0ZXIqOi58KmRpc2FibGUiLAoKCQkvL2RhdGEtc3ViPSJodG1sOnBhdGgiCgkJaHRtbDogIiFpbml0IGFmdGVyKjoufGdldCBodG1sICp0b1N0cmluZyIsCgoJCS8vZGF0YS1zdWI9InRleHQ6cGF0aCIKCQl0ZXh0OiAiIWluaXQgYWZ0ZXIqOi58Z2V0IHRleHQgKnRvU3RyaW5nIiwKCgkJcmVtb3ZlSWZEZWw6ICIhZHVyaW5nRGVsOi58KmZha2VHZXQgcmVtb3ZlIiwKCgkJZW1wdHlJZkRlbDogIiFkdXJpbmdEZWw6LnwqZmFrZUdldCBlbXB0eSIKCgl9ICk7CgoJaG0ubmV3SnFFdmVudCggewoKCQllbnRlcjogWyJrZXl1cCIsIGZ1bmN0aW9uKCBlICkgewoJCQlyZXR1cm4gKGUua2V5Q29kZSA9PT0gMTMpOwoJCX1dLAoKCQllc2M6IFsia2V5dXAiLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuIChlLmtleUNvZGUgPT09IDI3KTsKCQl9XSwKCgkJY3RybGNsaWNrOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiBlLmN0cmxLZXk7CgkJfV0KCX0gKTsKCgoKLy8KLyoKIDxAZGVwZW5kcz4KIHN1YnNjcmlwdGlvbi5qcywKIG1vZGVsLmpzCiA8L0BkZXBlbmRzPgogKi8KCgoJdmFyIG1ldGhvZE1hcCA9IHsKCQkiY3JlYXRlIjogIlBPU1QiLAoJCSJ1cGRhdGUiOiAiUFVUIiwKCQkiZGVzdHJveSI6ICJERUxFVEUiLAoJCSJmZXRjaCI6ICJHRVQiCgl9OwoKCXZhciBlbnRpdHlTdGF0ZSA9IHsKCQlkZXRhY2hlZDogMCwKCQl1bmNoYW5nZWQ6IDEsCgkJYWRkZWQ6IDMsCgkJZGVsZXRlZDogNCwKCQltb2RpZmllZDogNQoJfTsKCglmdW5jdGlvbiBtYXJrTW9kaWZpZWQgKCBlICkgewoKCQl2YXIgYmFzZVBhdGggPSB0aGlzLnBhdGg7IC8vaXRlbXMKCQl2YXIgb3JpZ2luYWxQYXRoID0gZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOyAvL2l0ZW1zLjEuZmlyc3ROYW1lCgkJdmFyIGRpZmZQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0ciggYmFzZVBhdGgubGVuZ3RoICsgMSApOyAvLzEuZmlyc3ROYW1lCgkJdmFyIGRvdEluZGV4ID0gZGlmZlBhdGguaW5kZXhPZiggIi4iICk7CgkJdmFyIGVudGl0eVBhdGggPSBiYXNlUGF0aCArICIuIiArIGRpZmZQYXRoLnN1YnN0ciggMCwgZG90SW5kZXggKTsgLy9pdGVtcy4xCgkJdmFyIHN0YXRlUGF0aCA9IGVudGl0eVBhdGggKyAiLl9fc3RhdGUiOyAvL2l0ZW1zLjEuX19zdGF0ZQoKCQlpZiAob3JpZ2luYWxQYXRoICE9PSBzdGF0ZVBhdGggJiYKCQkgICAgaG0uZ2V0KCBzdGF0ZVBhdGggKSA9PSBlbnRpdHlTdGF0ZS51bmNoYW5nZWQpIHsKCQkJLy91c2Ugc2V0IG1ldGhvZCBpcyBkZWxpYmVyYXRlLCBiZWNhdXNlIHdlIHdhbnQKCQkJLy90byByYWlzZSBldmVudAoJCQlobS5zZXQoIHN0YXRlUGF0aCwgZW50aXR5U3RhdGUubW9kaWZpZWQgKTsKCQl9Cgl9CgoJaG0ub25BZGRPclVwZGF0ZU5vZGUoIGZ1bmN0aW9uKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgkJaWYgKHZhbHVlIGluc3RhbmNlb2YgaG0uRW50aXR5KSB7CgoJCQlpZiAodmFsdWUuX19zdGF0ZSA9PT0gZW50aXR5U3RhdGUuZGV0YWNoZWQpIHsKCQkJCXZhbHVlLl9fc3RhdGUgPSBlbnRpdHlTdGF0ZS5hZGRlZDsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBobSggY29udGV4dCApLmdldCggIl9fZW50aXR5Q29udGFpbmVyIiApICkpIHsKCQkJCWhtLnN1YiggY29udGV4dCwgY29udGV4dCwgImFmdGVyVXBkYXRlLioiLCBtYXJrTW9kaWZpZWQgKTsKCQkJCWhtKCBjb250ZXh0ICkuc2V0KCAiX19lbnRpdHlDb250YWluZXIiLCB0cnVlICk7CgkJCX0KCQl9Cgl9ICk7CgoJZnVuY3Rpb24gY2FsbFN0YXRpY0FqYXhNZXRob2QgKCBub2RlLCBtZXRob2ROYW1lICkgewoJCXZhciBlbnRpdHkgPSBub2RlLmdldCgpOwoKCQlyZXR1cm4gZW50aXR5LmNvbnN0cnVjdG9yW21ldGhvZE5hbWVdKCBlbnRpdHkgKS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCgkJCW5vZGUuc2V0KAoKCQkJCSJfX3N0YXRlIiwKCgkJCQltZXRob2ROYW1lID09ICJkZXN0cm95IiA/CgkJCQkJZW50aXR5U3RhdGUuZGV0YWNoZWQgOgoJCQkJCWVudGl0eVN0YXRlLnVuY2hhbmdlZAoJCQkpOwoKCQkJbm9kZS50cmlnZ2VyKCAiYWZ0ZXJTeW5jLiIgKyBtZXRob2ROYW1lICk7CgkJfSApOwoJfQoKCS8vdGhlIHJlYXNvbiB0aGF0IHdlIGRvbid0IGltcGxlbWVudCBhamF4IGluIHRoZSBpbnN0YW5jZSBtZXRob2QgaXMgdGhhdCwgd2Ugd2FudCB0bwoJLy9zdXBwb3J0IHRoZSBjYWxsIGZyb20gcmVwb3NpdG9yeSBub2RlLCBzdWNoIG5vZGUuc2V0KCJjcmVhdGUiKSwgbm9kZS5zZXQoInVwZGF0ZSIpLi4KCS8vd2Ugd2FudCB0byBkZWxlZ2F0ZSB0aGlzIGNhbGwgdGhlIHN0YXRpYyBtZXRob2QKCWhtLkVudGl0eSA9IGhtLkNsYXNzLmV4dGVuZCgKCQkvL2luc3RhbmNlIG1ldGhvZCwgd2hpY2ggaXMgaW52b2tlZCBieSBub2RlLmdldCBtZXRob2QKCQkvL29yIGl0IGNhbiBiZSBpbnZva2VkIHRoZSBvYmplY3QgZGlyZWN0bHkKCQl7CgkJCS8vdGhpcyBzdGF0ZSBpcyBtZWFuaW5nZnVsIG9ubHkgd2hlbiBpdCBlbnRpdHkgaXMgaW5zaWRlIG9mIHJlcG9zaXRvcnkKCQkJX19zdGF0ZTogZW50aXR5U3RhdGUuZGV0YWNoZWQsCgoJCQljcmVhdGU6IGZ1bmN0aW9uIF9fICgpIHsKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgImNyZWF0ZSIgKTsKCQkJCQl9CgkJCQkJdGhyb3cgImVudGl0eSBpcyBub3QgYSBuZXcgaXRlbSI7CgoJCQkJfSBlbHNlIHsKCQkJCQkvLyBkb24ndCB1c2UgRW50aXR5LmNyZWF0ZSh0aGlzKSwgYmVjYXVzZQoJCQkJCS8vIHRoaXMuY29uc3RydWN0b3IgaXMgbm90IG5lY2Vzc2FyeSBFbnRpdHkKCQkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5jcmVhdGUoIHRoaXMgKTsKCgkJCQl9CgkJCX0sCgoJCQlmZXRjaDogZnVuY3Rpb24gX18gKCkgewoJCQkJcmV0dXJuIHRoaXMgaW5zdGFuY2VvZiBobSA/IGNhbGxTdGF0aWNBamF4TWV0aG9kKCB0aGlzLCAiZmV0Y2giICkgOgoJCQkJCXRoaXMuY29uc3RydWN0b3IuZmV0Y2goIHRoaXMgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24gX18gKCkgewoKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLm1vZGlmaWVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgInVwZGF0ZSIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnVwZGF0ZSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoJCQkJCXZhciBub2RlID0gdGhpczsKCQkJCQlyZXR1cm4gY2FsbFN0YXRpY0FqYXhNZXRob2QoIHRoaXMsICJkZXN0cm95IiApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlub2RlLmRlbCgpOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZGVzdHJveSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJc2F2ZTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLmdldCggIl9fc3RhdGUiICk7CgkJCQkJaWYgKHN0YXRlID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJjcmVhdGUiICk7CgoJCQkJCX0gZWxzZSBpZiAoc3RhdGUgPT0gZW50aXR5U3RhdGUubW9kaWZpZWQpIHsKCgkJCQkJCXJldHVybiB0aGlzLmdldCggInVwZGF0ZSIgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhyb3cgIm5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJfQoKCQl9LAoKCQkvL3N0YXRpYyBtZXRob2QsIHdoaWNoIGtub3dzIG5vdGhpbmcgYWJvdXQgcmVwb3NpdG9yeQoJCXsKCQkJc3RhdGU6IGVudGl0eVN0YXRlLAoKCQkJY3JlYXRlOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlyZXR1cm4gdGhpcy5hamF4KCAiY3JlYXRlIiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24oIGluc3RhbmNlICkgewoJCQkJcmV0dXJuIHRoaXMuYWpheCggInVwZGF0ZSIsIGluc3RhbmNlICk7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCBpbnN0YW5jZSApIHsKCQkJCXJldHVybiB0aGlzLmFqYXgoICJkZXN0cm95IiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCWZldGNoOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlpZiAoaW5zdGFuY2UpIHsKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giLCBpbnN0YW5jZSApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoJCQkJCS8vdGhlIHBpcGUgbWV0aG9kIGlzIHVzZWQgdG8gY29udmVydCBhbiBhcnJheSBvZgoJCQkJCS8vIGdlbmVyaWMgb2JqZWN0IGludG8gYW4gYXJyYXkgb2Ygb2JqZWN0IG9mIHRoZSBzYW1lICJDbGFzcyIKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giICkucGlwZSggZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQkJCXJldHVybiAkKCBDb25zdHJ1Y3Rvci5saXN0KCBkYXRhICkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdGhpcy5fX3N0YXRlID0gZW50aXR5U3RhdGUudW5jaGFuZ2VkOwoJCQkJCQl9ICkuZ2V0KCk7CgkJCQkJfSApOwoKCQkJCX0KCQkJfSwKCgkJCWdldFVybDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIGJhc2VVcmwgPSB0aGlzLnVybCB8fCBpbnN0YW5jZS51cmwsCgkJCQkJaWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5pZDsKCgkJCQlyZXR1cm4gaWQgPyBiYXNlVXJsICsgKGJhc2VVcmwuY2hhckF0KCBiYXNlVXJsLmxlbmd0aCAtIDEgKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KCBpZCApIDoKCQkJCQliYXNlVXJsOwoJCQl9LAoKCQkJYWpheDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIG1ldGhvZCA9IG1ldGhvZE1hcFttZXRob2ROYW1lXTsKCgkJCQl2YXIgYWpheE9wdGlvbnMgPSB7CgkJCQkJdHlwZTogbWV0aG9kLAoJCQkJCWRhdGFUeXBlOiAnanNvbicsCgkJCQkJdXJsOiB0aGlzLmdldFVybCggbWV0aG9kTmFtZSwgaW5zdGFuY2UgKSwKCQkJCQljb250ZW50VHlwZTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6ICJhcHBsaWNhdGlvbi9qc29uIiwKCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJZGF0YTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6IEpTT04uc3RyaW5naWZ5KCBpbnN0YW5jZSApCgkJCQl9OwoKCQkJCXJldHVybiAkLmFqYXgoIGFqYXhPcHRpb25zICkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCWluc3RhbmNlICYmIGV4dGVuZCggaW5zdGFuY2UsIHJlc3BvbnNlICk7CgkJCQl9ICk7CgkJCX0KCQl9ICk7CgoJZXh0ZW5kKCBobUZuLCB7CgoJCS8vbm9kZSBmdW5jdGlvbiB3aGljaCBicmlkZ2V0IHRoZSBobSBtZXRob2QgdG8gdGhlIHN0YXRpYyBtZXRob2Qgb2YgbW9kZWwKCQkvL3N1YlBhdGggaXMgb3B0aW9uYWwKCQkvL21ldGhvZCBpcyByZXF1aXJlZCBjcmVhdGUvcmVhZC91cGRhdGUvZGVsCgkJLy9lLmcgbm9kZS5zeW5jKCJjcmVhdGUiKTsKCQlzYXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAic2F2ZSIgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAiZGVzdHJveSIgKTsKCQl9LAoKCQlmZXRjaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldCggImZldGNoIiApOwoJCX0KCX0gKTsKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+CgoKCWRlZmF1bHRPcHRpb25zLmVycm9ycyA9IHsKCQlkZWZhdWx0RXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCB2YWx1ZSIKCX07CgoJdmFyIGFmdGVyVXBkYXRlQW5kQ2hlY2tWYWxpZGl0eSA9ICJhZnRlclVwZGF0ZSogY2hlY2tWYWxpZGl0eSIsCgkJaW52YWxpZFBhdGhzID0gc2hhZG93Um9vdC5pbnZhbGlkUGF0aHMgPSBbXSwKCQlpbnZhbGlkUGF0aHNNb2RlbCA9IGhtKCAiKmludmFsaWRQYXRocyIgKSwKCQlyRW1wdHkgPSAvXlxzKiQvLAoJCXJFbWFpbCA9IC9eKCgoW2Etel18XGR8WyEjXCQlJidcKlwrXC1cLz1cP1xeX2B7XHx9fl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKyhcLihbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKSopfCgoXHgyMikoKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPygoW1x4MDEtXHgwOFx4MGJceDBjXHgwZS1ceDFmXHg3Zl18XHgyMXxbXHgyMy1ceDViXXxbXHg1ZC1ceDdlXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KFxcKFtceDAxLVx4MDlceDBiXHgwY1x4MGQtXHg3Zl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkpKigoKFx4MjB8XHgwOSkqKFx4MGRceDBhKSk/KFx4MjB8XHgwOSkrKT8oXHgyMikpKUAoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/JC9pLAoJCXJVcmwgPSAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pLAoJCXJEYXRlSVNPID0gL15cZHs0fVtcL1wtXVxkezEsMn1bXC9cLV1cZHsxLDJ9JC8sCgkJck51bWJlciA9IC9eLT8oPzpcZCt8XGR7MSwzfSg/OixcZHszfSkrKSg/OlwuXGQrKT8kLywKCQlyRGlnaXQgPSAvXlxkKyQvLAoJCXJJbnZhbGlkRGF0ZSA9IC9JbnZhbGlkfE5hTi8sCgkJclJlZ0V4ID0gL14oXC8oXFxbXlx4MDAtXHgxZl18XFsoXFxbXlx4MDAtXHgxZl18W15ceDAwLVx4MWZcXFwvXSkqXF18W15ceDAwLVx4MWZcXFwvXFtdKStcL1tnaW1dKikoLCguKikpKiQvLAoJCXJGaXJzdFRva2VuID0gLyhbXixdKykoLCguKikpPy8sCgkJckZpcnN0VHdvVG9rZW4gPSAvKFx3KyksKFx3KykoLCguKikpPy87CgoJLyoJdGhpcyBtZXRob2QgaXMgdG8gY3JlYXRlIGEgc3Vic2NyaXB0aW9uIGdyb3VwIGFuZAoJIHdvcmtmbG93IHR5cGUgdXNpbmcgdGhlIG5hbWUgb2YgdmFsaWRhdG9yCgkgYW5kIGFsc28gYWRkIGEgY2xhc3MgcnVsZSB1c2luZyB0aGUgbmFtZSBvZiB2YWxpZGF0b3IKCSBzbyBtYWtlIHN1cmUgdGhlIG5hbWUgb2YgdmFsaWRhdG9yIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgdmFsaWRhdG9yCgoJIGEgdmFsaWRhdG9yIGlzIG9iamVjdCBsaWtlCgkgewoJIG5hbWU6ICJ2YWxpZGF0b3JOYW1lIiwKCSBlcnJvcjogImVycm9yIG1lc3NhZ2UiCgkgaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICk7IC8vIG9wdGlvbnMgbGV0IHVzZXIgdG8gaGVscCB0aGUgaXNWYWxpZCB0byB3b3JrIGJldHRlcgoJIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpOyAvL2FsbG93IHVzZXIgY29udmVydCBzdHJpbmcgdmFsdWUgb2YgbW9kZWxFdmVudC5vcHRpb25zIHRvIHRoZSBvcHRpb25zIHBhc3NlZCBpbiBpc1ZhbGlkIGZ1bmN0aW9uCgkgYnVpbGRFcnJvcjogZnVuY3Rpb24oZGVmYXVsdE1lc3NhZ2UsIG9wdGlvbnMgKQoJIH0KCSAqLwoJaG0udmFsaWRhdG9yID0gZnVuY3Rpb24oIHZhbGlkYXRvciApIHsKCgkJaWYgKGlzQXJyYXkoIHZhbGlkYXRvciApKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgkJCQlobS52YWxpZGF0b3IoIHZhbGlkYXRvcltpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHZhbGlkYXRvck5hbWUgPSB2YWxpZGF0b3IubmFtZTsKCgkJaWYgKGhtLndvcmtmbG93KCB2YWxpZGF0b3JOYW1lICkpIHsKCQkJdGhyb3cgInZhbGlkYXRvciBuYW1lICciICsgdmFsaWRhdG9yTmFtZSArICInIGNvbGxpZGUgd2l0aCBuYW1lIGluIGhtLndvcmtmbG93VHlwZXMiOwoJCX0KCgkJLy9hZGQgZGVmYXVsdCBlcnJvciBpZiBhcHBsaWNhYmxlCgkJLy91c2VyIGNhbiBsb2NhbGl6ZSBlcnJvcnMgbWVzc2FnZQoJCWlmICh2YWxpZGF0b3IuZXJyb3IpIHsKCQkJZGVmYXVsdE9wdGlvbnMuZXJyb3JzW3ZhbGlkYXRvck5hbWVdID0gdmFsaWRhdG9yLmVycm9yOwoJCX0KCgkJaWYgKHZhbGlkYXRvci5pc1ZhbGlkIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCXZhbGlkYXRvci5pc1ZhbGlkID0gYnVpbGRSZWdleEZuKCB2YWxpZGF0b3IuaXNWYWxpZCApOwoJCX0KCgkJdmFyIHdvcmtmbG93VHlwZU5hbWUgPSAidl8iICsgdmFsaWRhdG9yTmFtZTsKCQlobS53b3JrZmxvdyggd29ya2Zsb3dUeXBlTmFtZSwgYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSApOwoKCQkvL2RhdGEtc3ViPSJyZXF1aXJlZDpwYXRoIiBvciBkYXRhLXN1Yj0icmVxdWlyZWQ6cGF0aHxvcHRpb25zIgoJCWJpbmRpbmdzKCB2YWxpZGF0b3JOYW1lLCAiIWFmdGVyVXBkYXRlIGNoZWNrVmFsaWRpdHk6LnwqIiArIHdvcmtmbG93VHlwZU5hbWUgKTsKCgl9OwoKCWhtLndvcmtmbG93KCB7CgkJY2hlY2tWYWxpZGl0eTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICghaG0uY2hlY2tWYWxpZGl0eSggdGhpcy5wYXRoICkpIHsKCQkJCS8vYmVjYXVzZSBpdCBpcyB0aGUgZmlyc3QgaGFuZGxlciwgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gd2lsbAoJCQkJLy9zdG9wIHByb2Nlc3MgYWxsIG90aGVyIGhhbmRsZXIKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoKCQkvLyB1c2UgYnkgZ3JvdXAKCQkvLyB3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCQl3YXJuOiBmdW5jdGlvbiggZSApIHsKCQkJLy9lLnB1Ymxpc2hlciBwb2ludHMgdG8gIm1vZGVsKmVycm9ycyIKCQkJaWYgKGUucHVibGlzaGVyLmlzRW1wdHkoKSkgewoKCQkJCXRoaXMKCQkJCQkucmVtb3ZlQ2xhc3MoICJlcnJvciIgKQoJCQkJCS5uZXh0KCAic3Bhbi5lcnJvciIgKQoJCQkJCS5yZW1vdmUoKTsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcwoJCQkJCS5hZGRDbGFzcyggImVycm9yIiApCgkJCQkJLm5leHQoICJzcGFuLmVycm9yIiApCgkJCQkJLnJlbW92ZSgpCgkJCQkJLmVuZCgpCgkJCQkJLmFmdGVyKCAiPHNwYW4gY2xhc3M9J2Vycm9yJz4iICsgZS5wdWJsaXNoZXIuZ2V0KCkgKyAiPC9zcGFuPiIgKTsKCQkJfQoJCX0sCgoJCWhpZ2hsaWdodEVycm9yOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpc1tlLnB1Ymxpc2hlci5pc0VtcHR5KCkgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0oICJlcnJvciIgKTsKCgkJfSwKCgkJcmVuZGVyRXJyb3JTdW1tYXJ5OiBobS50ZW1wbGF0ZS5uZXdUZW1wbGF0ZUhhbmRsZXIoCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJcmV0dXJuIFtlLnB1Ymxpc2hlci5nZXRFcnJvcnMoKV07CgkJCX0KCQkpCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJaWYgKCFvcHRpb25zKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWxpZGF0b3IgcGF0aCI7CgkJCX0KCQkJaWYgKCFvcHRpb25zLnN0YXJ0c1dpdGgoICIjIiApKSB7CgkJCQlvcHRpb25zID0gIiMiICsgb3B0aW9uczsKCQkJfQoJCQlobSggcGF0aCApLnZhbGlkYXRvciggb3B0aW9ucyApOwoJCX0sCgoJCS8vYWRkIGEgY2xpY2sgaGFuZGxlciB0byBlbGVtZW50IHRvIGNoZWNrVmFsaWRpdHkKCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJLy9wcmVwZW5kIHRvIHRvIHN1YnNjcmlwdGlvbnMgYXJyYXkKCQkJLy9zbyB0aGF0IGl0IGlzIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zLCBhbmQgaXQgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNoZWNrVmFsaWRpdHkiICk7CgkJfSwKCgkJcmVzZXRWYWxpZGl0eTogIiRjbGljazoufCpmYWtlR2V0IHJlc2V0VmFsaWRpdHkiLAoKCQl3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCgkJImhpZ2hsaWdodEVycm9yIjogIiFhZnRlcio6KmVycm9yc3wqaGlnaGxpZ2h0RXJyb3IiLAoKCQl3YXJuU3VtbWFyeTogIiFhZnRlclVwZGF0ZSogdmFsaWRpdHlDaGVja2VkOi58KnJlbmRlckVycm9yU3VtbWFyeTshdmFsaWRpdHlSZXNldDoufGVtcHR5IgoKCX0gKTsKCgliaW5kaW5ncyggImZvcm0iLCBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgInJlc2V0IiwgIipmYWtlR2V0IHJlc2V0VmFsaWRpdHkiICk7Cgl9LCB0cnVlICk7CgoJZnVuY3Rpb24gaXNQYXRoVmFsaWQoIHBhdGggKSB7CgoJCWlmIChwYXRoID09PSAiIikgewoJCQlyZXR1cm4gIWludmFsaWRQYXRocy5sZW5ndGg7CgkJfQoKCQl2YXIgcHJlZml4ID0gcGF0aCArICIuIjsKCgkJZm9yICh2YXIgaSA9IDAsIGludmFsaWRQYXRoLCBsZW5ndGggPSBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJaW52YWxpZFBhdGggPSBpbnZhbGlkUGF0aHNbaV07CgkJCWlmIChpbnZhbGlkUGF0aCA9PSBwYXRoIHx8IGludmFsaWRQYXRoLnN0YXJ0c1dpdGgoIHByZWZpeCApKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8kKCJ4Iikuc3Vic2NyaWJlKCJwZXJzb24iLCAiY2hlY2tWYWxpZGl0eWQiLCBmdW5jdGlvbiAoZSkgewoJLy8gYWxlcnQoZS5wcm9wb3NlZCk7CgkvL30KCWhtLnN1YnNjcmlwdGlvbi5zcGVjaWFsLnZhbGlkaXR5Q2hhbmdlZCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApIHsKCQkJdmFyIGlzVmFsaWRQYXRoID0gcHVibGlzaGVyICsgIippc1ZhbGlkIjsKCgkJCWlmIChpc1VuZGVmaW5lZCggaG0uZ2V0KCBpc1ZhbGlkUGF0aCApICkpIHsKCQkJCWhtLnN1YiggcHVibGlzaGVyLCAiKmludmFsaWRQYXRocyIsICIhYWZ0ZXIqLiBhZnRlciouMSIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBpc1ZhbGlkID0gaXNQYXRoVmFsaWQoIHB1Ymxpc2hlciApOwoJCQkJCWlmIChobS5nZXQoIGlzVmFsaWRQYXRoICkgIT09IGlzVmFsaWQpIHsKCQkJCQkJaG0udHJpZ2dlciggcHVibGlzaGVyLCBwdWJsaXNoZXIsICJ2YWxpZGl0eUNoYW5nZWQiLCBpc1ZhbGlkLCAhaXNWYWxpZCApOwoJCQkJCQlobS5zZXQoIGlzVmFsaWRQYXRoLCBpc1ZhbGlkICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfQoJfTsKCglleHRlbmQoIGhtRm4sIHsKCgkJLyoKCQkgKiAxLiB0aGUgb2JqZWN0cyBpbiBwYXRoICIqaW52YWxpZFBhdGhzIiwgaXQgaG9sZHMgYWxsIHRoZSBwYXRoIG9mIG1vZGVsIHdoaWNoIGlzIGluIGVycm9yCgkJICogMi4gdGhlIG9iamVjdCBpbiBwYXRoICJtb2RlbCplcnJvcnMiLCBpdCBob2xkcyBhbGwgZXJyb3IgbWVzc2FnZSB0aGF0IGlzCgkJICogKi8KCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApOyAvLyB0aGlzLmNkKCBzdWJQYXRoICkucGF0aDsKCgkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggZnVsbFBhdGgsIGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdHJpZ2dlciggcGF0aCwgcGF0aCwgImNoZWNrVmFsaWRpdHkiLCByb290Tm9kZS5nZXQoIHBhdGggKSApOwoJCQl9ICk7CgoJCQkvL2FmdGVyIGNoZWNrVmFsaWRpdHkgZmlyZWQsIHdlIGNhbiBjaGVjayB0aGUgaW52YWxpZCBwYXRocyBjb3VudCBmb3IgdGhlIG1vZGVsLAoJCQl2YXIgaXNWYWxpZCA9IGlzUGF0aFZhbGlkKCBmdWxsUGF0aCApOwoJCQkvLwoJCQlobS50cmlnZ2VyKCBmdWxsUGF0aCwgZnVsbFBhdGgsICJ2YWxpZGl0eUNoZWNrZWQiLCBpc1ZhbGlkICk7CgoJCQlyZXR1cm4gaXNWYWxpZDsKCQl9LAoKCQkvL2htKCJ4IikuY2hlY2sodmFsaWRhdG9yTmFtZSwgZXJyb3IpCgkJLy9leGFtcGxlCgkJLy9obSgieCIpLmNoZWNrKCJudW1iZXIiLCAibXkgZXJyb3IgbWVzc2FnZSIpCgkJLy8KCQkvL2htKCJ4IikuY2hlY2soZm5Jc1ZhbGlkLCBlcnJvcikKCQkvL2V4YW1wbGUKCQkvL2htKCJ4IikuY2hlY2soZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gZmFsc2U7IH0sICJteSBlcnJvciBtZXNzYWdlIik7CgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggdmFsaWRhdG9yLCBvcHRpb25zICkgewoJCQl2YXIgc3ViUGF0aCwKCQkJCWksCgkJCQljdXJyZW50VmFsaWRhdG9yOwoKCQkJaWYgKGlzT2JqZWN0KCB2YWxpZGF0b3IgKSkgewoKCQkJCWZvciAoc3ViUGF0aCBpbiB2YWxpZGF0b3IpIHsKCgkJCQkJdGhpcy5jZCggc3ViUGF0aCApLnZhbGlkYXRvciggdmFsaWRhdG9yW3N1YlBhdGhdICk7CgoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCB2YWxpZGF0b3IgKSB8fCAoaXNTdHJpbmcoIHZhbGlkYXRvciApICYmIHZhbGlkYXRvci5zdGFydHNXaXRoKCAiIyIgKSkpIHsKCgkJCQkJaWYgKGlzU3RyaW5nKCB2YWxpZGF0b3IgKSkgewoJCQkJCQl2YWxpZGF0b3IgPSB0aGlzLnJhdyggdmFsaWRhdG9yLnN1YnN0ciggMSApICk7CgkJCQkJfQoKCQkJCQlobS5oYW5kbGUoIHRoaXMucGF0aCwgYWZ0ZXJVcGRhdGVBbmRDaGVja1ZhbGlkaXR5LCBmdW5jdGlvbiggZSApIHsKCQkJCQkJdmFyIHB1Ymxpc2hlciA9IGUucHVibGlzaGVyLAoJCQkJCQkJcHJldmlvdXNFcnJvciA9IHZhbGlkYXRvci5wcmV2aW91c0Vycm9yOwoKCQkJCQkJLy9kb24ndCBjaGVjayB3aGVuIGl0IGlzIGVtcHR5CgkJCQkJCWlmICghaXNFbXB0eVN0cmluZyggZS5wcm9wb3NlZCApKSB7CgoJCQkJCQkJdmFyIGVycm9yTWVzc2FnZSA9IHZhbGlkYXRvciggcHVibGlzaGVyLmdldCgpICk7CgoJCQkJCQkJaWYgKGVycm9yTWVzc2FnZSA9PT0gZmFsc2UpIHsKCQkJCQkJCQllcnJvck1lc3NhZ2UgPSBkZWZhdWx0T3B0aW9ucy5lcnJvcnMuZGVmYXVsdEVycm9yOwoJCQkJCQkJfQoKCQkJCQkJCWlmIChpc1N0cmluZyggZXJyb3JNZXNzYWdlICkpIHsKCQkJCQkJCQkvLyB0aGUgIiE9IiBpcyBkZWxpYmVyYXRlLCBkb24ndCBjaGFuZ2UgdG8gIiE9PSIKCQkJCQkJCQlpZiAoZXJyb3JNZXNzYWdlICE9IHByZXZpb3VzRXJyb3IpIHsKCgkJCQkJCQkJCXB1Ymxpc2hlci5hZGRFcnJvciggZXJyb3JNZXNzYWdlICk7CgoJCQkJCQkJCQlpZiAoIXByZXZpb3VzRXJyb3IpIHsKCQkJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQl2YWxpZGF0b3IucHJldmlvdXNFcnJvciA9IGVycm9yTWVzc2FnZTsKCQkJCQkJCQl9CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIHByZXZpb3VzRXJyb3IgKTsKCQkJCQkJCQkJdmFsaWRhdG9yLnByZXZpb3VzRXJyb3IgPSAiIjsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCXZhbGlkYXRvci5wcmV2aW91c0Vycm9yID0gIiI7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCX0gZWxzZSBpZiAoaXNTdHJpbmcoIHZhbGlkYXRvciApKSB7CgoJCQkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBhZnRlclVwZGF0ZUFuZENoZWNrVmFsaWRpdHksICIqdl8iICsgdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIGlmIChpc0FycmF5KCB2YWxpZGF0b3IgKSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgoJCQkJCQljdXJyZW50VmFsaWRhdG9yID0gdmFsaWRhdG9yW2ldOwoKCQkJCQkJaWYgKGlzQXJyYXkoIGN1cnJlbnRWYWxpZGF0b3IgKSkgewoJCQkJCQkJdGhpcy52YWxpZGF0b3IoIGN1cnJlbnRWYWxpZGF0b3JbMF0sIGN1cnJlbnRWYWxpZGF0b3JbMV0gKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnZhbGlkYXRvciggY3VycmVudFZhbGlkYXRvciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXNldFZhbGlkaXR5OiBmdW5jdGlvbigpIHsKCQkJcmVzZXRWYWxpZGl0eSggdGhpcy5wYXRoICk7CgoJCQlpZiAoIWlzUHJpbWl0aXZlKCB0aGlzLmdldCgpICkpIHsKCQkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggdGhpcy5wYXRoLCByZXNldFZhbGlkaXR5ICk7CgkJCX0KCQkJaG0udHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJ2YWxpZGl0eVJlc2V0IiApOwoJCX0sCgoJCWFkZEVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgkJCXRoaXMuY3JlYXRlSWZVbmRlZmluZWQoICIqZXJyb3JzIiwgW10gKQoJCQkJLmNkKCAiKmVycm9ycyIgKQoJCQkJLnB1c2hVbmlxdWUoIGVycm9yICk7CgoJCQlpbnZhbGlkUGF0aHNNb2RlbC5wdXNoVW5pcXVlKCB0aGlzLnBhdGggKTsKCQkJcmV0dXJuIHRoaXM7CgoJCX0sCgoJCXJlbW92ZUVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgoJCQl2YXIgZXJyb3JzID0gdGhpcy5jcmVhdGVJZlVuZGVmaW5lZCggIiplcnJvcnMiLCBbXSApLmNkKCAiKmVycm9ycyIgKTsKCQkJZXJyb3JzLnJlbW92ZUl0ZW0oIGVycm9yICk7CgkJCWlmIChlcnJvcnMuaXNFbXB0eSgpKSB7CgkJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCB0aGlzLnBhdGggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRFcnJvcnM6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQlwYXRoID0gdGhpcy5wYXRoLAoJCQkJaW52YWxpZFBhdGgsCgkJCQlydG4gPSBbXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJCWludmFsaWRQYXRoID0gaW52YWxpZFBhdGhzW2ldOwoJCQkJaWYgKGludmFsaWRQYXRoID09IHBhdGggfHwgaW52YWxpZFBhdGguc3RhcnRzV2l0aCggcGF0aCApKSB7CgkJCQkJcnRuID0gcnRuLmNvbmNhdCggaG0uZ2V0KCBpbnZhbGlkUGF0aCArICIqZXJyb3JzIiApICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWhtLmNoZWNrVmFsaWRpdHkgPSBmdW5jdGlvbiggcGF0aCApIHsKCQlyZXR1cm4gcm9vdE5vZGUuY2hlY2tWYWxpZGl0eSggcGF0aCApOwoJfTsKCgkvL3doZW4gcGF0aCBpcyBkZWxldGVkLCByZW1vdmUgaXQgZnJvbSBpbnZhbGlkUGF0aHNNb2RlbAoJaG0ub25EZWxldGVOb2RlKCBmdW5jdGlvbiggcGF0aCApIHsKCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7Cgl9ICk7CgoJZnVuY3Rpb24gYnVpbGRSZWdleEZuKCBleCwgcmV2ZXJzZSApIHsKCQlyZXR1cm4gcmV2ZXJzZSA/IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuICFleC50ZXN0KCB2YWx1ZSApOwoJCX0gOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiBleC50ZXN0KCB2YWx1ZSApOwoJCX07Cgl9CgoJZnVuY3Rpb24gZGVmYXVsdEVycm9yQnVpbGRlciggZm9ybWF0LCBvcHRpb25zICkgewoJCXJldHVybiBvcHRpb25zLmVycm9yIHx8IGZvcm1hdC5zdXBwbGFudCggb3B0aW9ucyApOwoJfQoKCWhtLnZhbGlkYXRvci5kZWZhdWx0RXJyb3JCdWlsZGVyID0gZGVmYXVsdEVycm9yQnVpbGRlcjsKCWhtLnZhbGlkYXRvci5idWlsZFJlZ2V4Rm4gPSBidWlsZFJlZ2V4Rm47CgoJaG0udmFsaWRhdG9yKCBbCgkJewoJCQluYW1lOiAicmVxdWlyZWQiLAoJCQllcnJvcjogIlRoaXMgZmllbGQgaXMgcmVxdWlyZWQuIiwKCQkJLy93aGVuIGl0IGlzIGNoZWNrZWQgaXQgaXMgYWx3YXlzIHRydWUKCQkJaXNWYWxpZDogcmV0dXJuVHJ1ZQoJCX0sCgkJewoJCQluYW1lOiAiZW1haWwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MuIiwKCQkJaXNWYWxpZDogckVtYWlsCgkJfSwKCQl7CgkJCW5hbWU6ICJ1cmwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIFVSTC4iLAoJCQlpc1ZhbGlkOiByVXJsCgkJfSwKCQl7CgkJCW5hbWU6ICJkYXRlIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBkYXRlLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCXJldHVybiAhckludmFsaWREYXRlLnRlc3QoIG5ldyBEYXRlKCB2YWx1ZSApLnRvU3RyaW5nKCkgKTsKCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZGF0ZUlTTyIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgZGF0ZSAoSVNPKS4iLAoJCQlpc1ZhbGlkOiByRGF0ZUlTTwoJCX0sCgkJewoJCQluYW1lOiAibnVtYmVyIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBudW1iZXIuIiwKCQkJaXNWYWxpZDogck51bWJlcgoJCX0sCgkJewoJCQluYW1lOiAiZGlnaXRzIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgb25seSBkaWdpdHMuIiwKCQkJaXNWYWxpZDogckRpZ2l0CgoJCX0sCgkJewoJCQluYW1lOiAiY3JlZGl0Y2FyZCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgY3JlZGl0IGNhcmQgbnVtYmVyLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCWlmICgvW14wLTlcLV0rLy50ZXN0KCB2YWx1ZSApKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBuQ2hlY2sgPSAwLAoJCQkJCW5EaWdpdCA9IDAsCgkJCQkJYkV2ZW4gPSBmYWxzZSwKCQkJCQljRGlnaXQ7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCAvXEQvZywgIiIgKTsKCgkJCQlmb3IgKHZhciBuID0gdmFsdWUubGVuZ3RoIC0gMTsgbiA+PSAwOyBuLS0pIHsKCQkJCQljRGlnaXQgPSB2YWx1ZS5jaGFyQXQoIG4gKTsKCQkJCQluRGlnaXQgPSBwYXJzZUludCggY0RpZ2l0LCAxMCApOwoJCQkJCWlmIChiRXZlbikgewoJCQkJCQlpZiAoKG5EaWdpdCAqPSAyKSA+IDkpIHsKCQkJCQkJCW5EaWdpdCAtPSA5OwoJCQkJCQl9CgkJCQkJfQoJCQkJCW5DaGVjayArPSBuRGlnaXQ7CgkJCQkJYkV2ZW4gPSAhYkV2ZW47CgkJCQl9CgoJCQkJcmV0dXJuIChuQ2hlY2sgJSAxMCkgPT09IDA7CgkJCX0KCgkJfSwKCQl7CgkJCW5hbWU6ICJtaW5sZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhdCBsZWFzdCB7bWlubGVuZ3RofSBjaGFyYWN0ZXJzLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUubGVuZ3RoID49IG9wdGlvbnMubWlubGVuZ3RoOwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW5sZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWlubGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXhsZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBubyBtb3JlIHRoYW4ge21heGxlbmd0aH0gY2hhcmFjdGVycy4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlLmxlbmd0aCA8PSBvcHRpb25zLm1heGxlbmd0aDsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltYXhsZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWF4bGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgkJCWJ1aWxkRXJyb3I6IGRlZmF1bHRFcnJvckJ1aWxkZXIKCQl9LAoJCXsKCQkJbmFtZTogInJhbmdlbGVuZ3RoIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBiZXR3ZWVuIHttaW5sZW5ndGh9IGFuZCB7bWF4bGVuZ3RofSBjaGFyYWN0ZXJzIGxvbmcuIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5sZW5ndGggJiYKCQkJCSAgICAgICB2YWx1ZS5sZW5ndGggPD0gb3B0aW9ucy5tYXhsZW5ndGg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWlubGVuZ3RoOiArbWF0Y2hbMV0sCgkJCQkJCW1heGxlbmd0aDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZWxlbmd0aCB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgoJCX0sCgkJewoJCQluYW1lOiAibWluIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8ge21pbn0uIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZSA+PSBvcHRpb25zLm1pbjsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW46ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWluIHZhbGlkYXRvciI7CgkJCQl9CgoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB7bWF4fS4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlIDw9IG9wdGlvbnMubWF4OwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSB7CgkJCQkJCW1heDogK21hdGNoWzFdLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciBtYXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfSwKCQkJYnVpbGRFcnJvcjogZGVmYXVsdEVycm9yQnVpbGRlcgoJCX0sCgkJewoJCQluYW1lOiAicmFuZ2UiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4ge21pbn0gYW5kIHttYXh9LiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUgPj0gb3B0aW9ucy5taW4gJiYgdmFsdWUgPD0gb3B0aW9ucy5tYXg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWluOiArbWF0Y2hbMV0sCgkJCQkJCW1heDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJlcXVhbCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIHRoZSBzYW1lIHZhbHVlIGFnYWluLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCQkJCXJldHVybiByb290Tm9kZS5nZXQoIG9wdGlvbnMuY29tcGFyZVBhdGggKSA9PT0gdmFsdWU7CgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgoJCQkJCXZhciBjb21wYXJlUGF0aCA9IHB1Ymxpc2hlci5jZCggbWF0Y2hbMV0gKS5wYXRoOwoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJY29tcGFyZVBhdGg6IGNvbXBhcmVQYXRoLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoKCQkJCQlwdWJsaXNoZXIuc3ViKCBjb21wYXJlUGF0aCwgImFmdGVyVXBkYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWlmICghdGhpcy5pc0VtcHR5KCkpIHsKCQkJCQkJCXRyaWdnZXIoCgkJCQkJCQkJdGhpcy5wYXRoLAoJCQkJCQkJCXRoaXMucGF0aCwKCQkJCQkJCQkiY2hlY2tWYWxpZGl0eSIsCgkJCQkJCQkJdGhpcy5nZXQoKSAvL3Byb3Bvc2VkIHZhbHVlCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgZXF1YWwgdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAicmVnZXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIG1hdGNoIHdpdGggcmVxdWlyZWQgcGF0dGVybi4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgkJCQlyZXR1cm4gb3B0aW9ucy5yZWdleC50ZXN0KCB2YWx1ZSApOwoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJSZWdFeC5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlyZWdleDogZXZhbCggbWF0Y2hbMV0gKSwKCQkJCQkJZXJyb3I6IG1hdGNoWzVdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgcmVnZXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZml4ZWRWYWx1ZSIsCgkJCWVycm9yOiAnUGxlYXNlIGVudGVyIHZhbHVlICJ7Zml4ZWRWYWx1ZX0iJywKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoJCQkJcmV0dXJuIHZhbHVlID09IG9wdGlvbnMuZml4ZWRWYWx1ZTsKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgkJCQkJbWF0Y2ggPSAvXihcdyspKCwoLiopKSokLy5leGVjKCBvcHRpb25zICk7CgkJCQkJaWYgKG1hdGNoKSB7CgkJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJCWZpeGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSggbWF0Y2hbMV0gKSwKCQkJCQkJCWVycm9yOiBtYXRjaFszXQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9wdGlvbnMgKSkgewoKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSBvcHRpb25zOwoKCQkJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBvcHRpb25zICkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlmaXhlZFZhbHVlOiBvcHRpb25zCgkJCQkJfTsKCgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIG9wdGlvbnMgaW4gZml4ZWRWYWx1ZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfQoJXSApOwoKCWZ1bmN0aW9uIHJlc2V0VmFsaWRpdHkoIHBhdGggKSB7CgkJdmFyIGVycm9yc01vZGVsID0gaG0oIHBhdGggKyAiKmVycm9ycyIgKTsKCQlpZiAoIWVycm9yc01vZGVsLmlzRW1wdHkoKSkgewoJCQllcnJvcnNNb2RlbC5jbGVhcigpOwoJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7CgkJfQoJfQoKCXZhciBpc1JlcXVpcmVkID0gaG0ud29ya2Zsb3coICJ2X3JlcXVpcmVkIiApLmdldDsKCglmdW5jdGlvbiBpc01vZGVsUmVxdWlyZWQoIHBhdGggKSB7CgkJdmFyIHN1YnNjcmlwdGlvbkJ5TW9kZWwgPSBobSggcGF0aCApLnN1YnNUb01lKCk7Ly8gc3Vic2NyaXB0aW9ucy5nZXRCeVB1Ymxpc2hlciggcGF0aCApOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9uQnlNb2RlbC5sZW5ndGg7IGkrKykgewoJCQl2YXIgc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uQnlNb2RlbFtpXTsKCQkJaWYgKHN1YnNjcmlwdGlvbi5oYW5kbGVyLmdldCA9PT0gaXNSZXF1aXJlZCkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkRXJyb3JNZXNzYWdlKCB2YWxpZGF0b3IsIG9wdGlvbnMgKSB7CgoJCS8vbmFtZWQgdmFsaWRhdG9yIG5vcm1hbGx5IGhhcyBhIGRlZmF1bHRFcnJvcgoJCXZhciBkZWZhdWx0RXJyb3IgPSB2YWxpZGF0b3IubmFtZSAmJiBkZWZhdWx0T3B0aW9ucy5lcnJvcnNbdmFsaWRhdG9yLm5hbWVdOwoKCQkvL2lmIHZhbGlkYXRvciBoYXMgYnVpbGRFcnJvciBmdW5jdGlvbiwgdGhpcyB0YWtlIHRoZSBoaWdoZXN0IHByaW9yaXR5CgkJaWYgKHZhbGlkYXRvci5idWlsZEVycm9yKSB7CgoJCQkvL3JldHVybiB1c2VyRXJyb3IgfHwgZm9ybWF0LmFwcGx5KCBudWxsLCBbZGVmYXVsdEVycm9yXS5jb25jYXQoIG9wdGlvbnMubWlubGVuZ3RoICkgKTsKCQkJcmV0dXJuIHZhbGlkYXRvci5idWlsZEVycm9yKCBkZWZhdWx0RXJyb3IsIG9wdGlvbnMgKTsKCgkJCS8vaWYgZGVmYXVsdEVycm9yIGlzIGZvcm1hdCBzdHJpbmcsCgkJfSBlbHNlIHsKCgkJCS8vdXNlckVycm9yIGlzIG5vcm1hbGx5IHBhc3NlZCBpbiBvcHRpb25zIG9mIGVhY2ggaW5zdGFuY2UKCQkJdmFyIHVzZXJFcnJvciA9IGlzT2JqZWN0KCBvcHRpb25zICkgPyBvcHRpb25zLmVycm9yIDogb3B0aW9uczsKCgkJCWlmIChkZWZhdWx0RXJyb3IgJiYgZGVmYXVsdEVycm9yLmNvbnRhaW5zKCAiezB9IiApKSB7CgoJCQkJcmV0dXJuIGRlZmF1bHRFcnJvci5mb3JtYXQuYXBwbHkoIGRlZmF1bHRFcnJvciwgdXNlckVycm9yLnNwbGl0KCAiLCIgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gdXNlckVycm9yIHx8IGRlZmF1bHRFcnJvciB8fCB2YWxpZGF0b3IuZXJyb3I7CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSB7CgoJCXJldHVybiB7CgoJCQlpbml0aWFsaXplOiB2YWxpZGF0b3IuaW5pdGlhbGl6ZSwKCgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy9pZiBpdCB2aW9sYXRlIHJlcXVpcmVkIHJ1bGUsIGRvbid0IGRvIGZ1cnRoZXIgdmFsaWRhdGlvbiwKCQkJCS8vYXMgd2UgZXhwZWN0IHRoZSByZXF1aXJlZCBydWxlIHdpbGwgY2FwdHVyZSBpdCBmaXJzdC4KCQkJCXZhciBpc1ZhbGlkLAoJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUsCgkJCQkJcHVibGlzaGVyID0gZS5wdWJsaXNoZXIsCgkJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJCXByb3Bvc2VkID0gZS5wcm9wb3NlZCwKCQkJCQllcnJvck1lc3NhZ2UgPSBidWlsZEVycm9yTWVzc2FnZSggdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJLy9pZiBtb2RlbCBpcyBlbXB0eSwgb25seSBjaGVjayB0aGUgInJlcXVpcmUiIHZhbGlkYXRvcgoJCQkJLy9JZiBpdCBpcyByZXF1aXJlZCwgdGhlbiBpdCBpcyBpbnZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJLy9pZiBpdCBpcyBub3QgcmVxdWlyZWQsIGl0IGlzIHZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJaWYgKGlzRW1wdHlTdHJpbmcoIHByb3Bvc2VkICkpIHsKCgkJCQkJaWYgKGlzTW9kZWxSZXF1aXJlZCggcHVibGlzaGVyLnBhdGggKSkgewoJCQkJCQlpc1ZhbGlkID0gZmFsc2U7CgkJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlzVmFsaWQgPSB0cnVlOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlpc1ZhbGlkID0gdmFsaWRhdG9yLmlzVmFsaWQoIHByb3Bvc2VkLCBvcHRpb25zICk7CgkJCQl9CgoJCQkJaWYgKCFpc1ZhbGlkKSB7CgoJCQkJCS8vYWRkIGVycm9yIHdoZW4gdGhlIGN1cnJlbnQgcnVsZSBpcyB0aGUgInJlcXVpcmVkIHJ1bGUiCgkJCQkJLy9vciB3aGVuICJyZXF1aXJlZCIgcnVsZSBpcyBub3QgdmlvbGF0ZWQKCQkJCQlpZiAoIXZpb2xhdGVSZXF1aXJlZFJ1bGUgfHwgdmFsaWRhdG9yLm5hbWUgPT09ICJyZXF1aXJlZCIpIHsKCQkJCQkJcHVibGlzaGVyLmFkZEVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIGVycm9yTWVzc2FnZSApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcHVibGlzaGVyLnJlbW92ZUVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCX0KCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gdHJhdmVyc2VNb2RlbE5lZWRWYWxpZGF0aW9uKCBwYXRoLCBjYWxsYmFjayApIHsKCgkJLy90aGUgZm9sbG93aW5nIGNvZGUgdHJ5IHRvIHRyaWdnZXIgdGhlICJjaGVja1ZhbGlkaXR5IiBldmVudCwgc28gdGhhdCB0aGUgdmFsaWRhdG9yIHdpbGwKCQkvLyBiZSBjYWxsZWQgdG8gY2hlY2sgY3VycmVudCB2YWx1ZSBvZiB0aGUgbW9kZWwKCQkvL3lvdSBjYW4gbm90IGNhbGwgYWZ0ZXJVcGRhdGUsIGJlY2F1c2UgdGhlcmUgbWlnaHQgdHJpZ2dlciBvdGhlciBub24tdmFsaWRhdG9yIGhhbmRsZXIKCQkvL3RoYXQgYXJlIGF0dGFjaGVkIHRvIGFmdGVyVXBkYXRlCgkJdmFyIGFsbFN1YnNjcmlwdGlvbnMgPSBobS5zdWJzY3JpcHRpb24uZ2V0QWxsKCk7CgkJdmFyIGNoZWNrVmFsaWRpdHlkUGF0aHMgPSB7fTsKCgkJZm9yICh2YXIgaSA9IGFsbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMSwgc3Vic2NyaXB0aW9uLCBwdWJsaXNoZXJQYXRoOyBpID49IDA7IGktLSkgewoKCQkJc3Vic2NyaXB0aW9uID0gYWxsU3Vic2NyaXB0aW9uc1tpXTsKCQkJcHVibGlzaGVyUGF0aCA9IHN1YnNjcmlwdGlvbi5wdWJsaXNoZXI7CgoJCQl2YXIgaXNWYWxpZGF0aW9uUmVxdWlyZWQgPQoJCQkJaXNTdHJpbmcoIHB1Ymxpc2hlclBhdGggKSAmJiAhY2hlY2tWYWxpZGl0eWRQYXRoc1twdWJsaXNoZXJQYXRoXSAmJgoJCQkJcHVibGlzaGVyUGF0aC5zdGFydHNXaXRoKCBwYXRoICkgJiYKCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLmNvbnRhaW5zKCAiY2hlY2tWYWxpZGl0eSIgKTsKCgkJCWlmIChpc1ZhbGlkYXRpb25SZXF1aXJlZCkgewoKCQkJCWNoZWNrVmFsaWRpdHlkUGF0aHNbcHVibGlzaGVyUGF0aF0gPSB0cnVlOwoJCQkJY2FsbGJhY2soIHB1Ymxpc2hlclBhdGggKTsKCgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gaXNFbXB0eVN0cmluZyggdmFsdWUgKSB7CgkJcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgckVtcHR5LnRlc3QoIHZhbHVlICk7Cgl9CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL3RoZSBjb252ZW50aW9uIGhlcmUgaXMgdGhhdCAsCgkvLyB1c2Ugcm93VmlldyBmb3IgdGhlIHJvdyBpbiB2aWV3CgkvL3VzZSBpdGVtIGZvciB0aGUgaXRlbSBpbiBtb2RlbCBhcnJheQoKCWhtLndvcmtmbG93KCB7CgoJCS8vLS0tLS0tLS0tLXdvcmtmbG93IHR5cGUgd2hpY2ggbW9kaWZ5IHJvdyBpbiBsaXN0IHZpZXctLS0tLS0tLS0tLQoKCQkvLyFhZnRlckNyZWF0ZS4xOmFycmF5fCphZGRSb3dWaWV3OwoJCWFkZFJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCgkJCS8vdGhlIHJlYXNvbiB0byB1c2UgZ2V0T3JpZ2luYWwgaXMgdGhhdAoJCQkvL3RoZSBzdWJzY3JpcHRpb24gaXMgdGhlIGl0ZW1zIGFycmF5CgkJCS8vYnV0IGhlcmUgd2Ugd2FudCB0byB0aGUgZWxlbQoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCByb3dWaWV3LCBlICkgewoKCQkJCXZhciByb3dDb250YWluZXIgPSB0aGlzLAoJCQkJCXJvd3MgPSByb3dDb250YWluZXIuY2hpbGRyZW4oKTsKCgkJCQlpZiAocm93cy5sZW5ndGggPT09IDApIHsKCgkJCQkJcm93Q29udGFpbmVyLmFwcGVuZCggcm93VmlldyApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGluc2VydCBtYXkgbm90IGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheQoJCQkJCS8vYXQgY2FuIGJlIGluc2VydCBpbiB0aGUgbWlkZGxlLCBzbwoJCQkJCS8vd2UgY2FuIG5vdCBzaW1wbHkgZG8gc3Vic2NyaWJlci5hcHBlbmQoKQoJCQkJCS8vd2UgbmVlZCB0byBhcHBlbmQgdGhlIHJvdyB2aWV3IGF0IHRoZSBpbmRleAoJCQkJCXZhciBpbmRleCA9ICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpOwoKCQkJCQkvL3JvdyB6ZXJvIGlzIHNwZWNpYWwsIG5lZWQgdG8gdXNlIGJlZm9yZSBtZXRob2QKCQkJCQlpZiAoaW5kZXggPT09IDApIHsKCgkJCQkJCXJvd3MuZXEoIDAgKS5iZWZvcmUoIHJvd1ZpZXcgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyb3dzLmVxKCBpbmRleCAtIDEgKS5hZnRlciggcm93VmlldyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCSksCgoJCS8vIWFmdGVyVXBkYXRlLjE6YXJyYXl8KnVwZGF0ZVJvd1ZpZXcKCQl1cGRhdGVSb3dWaWV3OiBuZXdUZW1wbGF0ZUhhbmRsZXIoCgoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkJCXRoaXMuY2hpbGRyZW4oKS5lcSggK2Uub3JpZ2luYWxQdWJsaXNoZXIucGF0aEluZGV4KCkgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyFhZnRlckRlbC4xOmFycmF5fCpyZW1vdmVSb3dWaWV3OwoJCXJlbW92ZVJvd1ZpZXc6IGZ1bmN0aW9uKCBlICkgewoJCQl0aGlzLmNoaWxkcmVuKCkuZXEoICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpICkucmVtb3ZlKCk7CgkJfQoKCgl9ICk7CgoJLy9hdXRvUXVlcnkgbWVhbnMgdXNlciBkb24ndCBuZWVkIHRvIHRyaWdnZXIgc2VhcmNoIGJ1dHRvbgoJLy9xdWVyeSByZXN1bHQgd2lsbCBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbgoJLy9xdWVyeSBjaGFuZ2UsIGJ5IGRlZmF1bHQgaXQgaXMgZmFsc2UKCS8vd2hpY2ggbWVhbnMgdXNlciBoYXMgcmVmcmVzaFF1ZXJ5IG1hbnVhbGx5CglobUZuLmVuYWJsZVF1ZXJ5ID0gZnVuY3Rpb24oIGF1dG9RdWVyeSApIHsKCgkJaWYgKHRoaXMuZ2V0KCAiKnF1ZXJ5IiApKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHF1ZXJ5YWJsZSwKCQkJcXVlcnksCgkJCXNvcnQsCgkJCXBhZ2VyLAoJCQlmaWx0ZXJGbiwKCQkJZmlsdGVyLAoJCQlpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCXF1ZXJ5Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnkiICksCgkJCXF1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnlSZXN1bHQiICksCgkJCWhhc1F1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqaGFzUXVlcnlSZXN1bHQiICksCgkJCXBhZ2VyTm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInBhZ2VyIiApLAoJCQlmaWx0ZXJOb2RlID0gcXVlcnlOb2RlLmNkKCAiZmlsdGVyIiApLAoJCQlmaWx0ZXJFbmFibGVkTm9kZSA9IGZpbHRlck5vZGUuY2QoICJlbmFibGVkIiApLAoJCQlzb3J0Tm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInNvcnQiICk7CgoJCWF1dG9RdWVyeSA9ICEhYXV0b1F1ZXJ5OwoKCQlpZiAoYXV0b1F1ZXJ5KSB7CgkJCS8vaXRlbXMqcXVlcnlSZXN1bHQgLS0tcmVmZXJlbmNpbmctLT4gaXRlbXMqcXVlcnkKCQkJcXVlcnlSZXN1bHROb2RlLndhdGNoKCBxdWVyeU5vZGUucGF0aCApOwoJCX0KCgkJLy9pdGVtcypxdWVyeVJlc3VsdCAtLT4gaXRlbXMKCQlxdWVyeVJlc3VsdE5vZGUud2F0Y2goIHRoaXMucGF0aCApOwoKCQl0aGlzLmV4dGVuZCgKCQkJIioiLAoJCQlxdWVyeWFibGUgPSB7CgoJCQkJLy9pZiBpdCBpcyB0cnVlLCByZWZyZXNoUXVlcnkgaXMgYnlwYXNzZWQKCQkJCWF1dG9RdWVyeTogYXV0b1F1ZXJ5LAoKCQkJCWhhc1F1ZXJ5UmVzdWx0OiBmYWxzZSwKCgkJCQkvL3RoZSBvYmplY3QgaG9sZGluZyB0aGUgZGF0YSBhYm91dCBwYWdpbmcsIHNvcnRpbmcsIGFuZCBmaWx0ZXJpbmcKCQkJCXF1ZXJ5OiBxdWVyeSA9IHsKCQkJCQlwYWdlcjogcGFnZXIgPSB7CgkJCQkJCWVuYWJsZWQ6IGZhbHNlLAoJCQkJCQlpbmRleDogMCwgLy9udGggcGFnZQoJCQkJCQljb3VudDogMSwKCQkJCQkJc2l6ZTogMAoJCQkJCX0sCgkJCQkJc29ydDogc29ydCA9IHsKCQkJCQkJYnk6IG51bGwsIC8vY3VycmVudGx5IHdlIG9ubHkgc3VwcG9ydCBzb3J0IGJ5IG9uZSBjb2x1bW4gc29ydAoJCQkJCQlhc2M6IG51bGwKCQkJCQl9LAoJCQkJCWZpbHRlcjogZmlsdGVyID0gewoJCQkJCQlieTogIiIsCgkJCQkJCXZhbHVlOiAiIiwKCQkJCQkJb3BzOiAiIiwKCQkJCQkJZW5hYmxlZDogZmFsc2UKCQkJCQl9LAoJCQkJCS8vaXMgcXVlcnkgZW5hYmxlZAoJCQkJCWVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJwYWdlci5lbmFibGVkIiApIHx8IHRoaXMuZ2V0KCAic29ydC5ieSIgKSB8fCB0aGlzLmdldCggImZpbHRlci5lbmFibGVkIiApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcXVlcnlSZXN1bHQ6IGZ1bmN0aW9uKCBkaXNhYmxlUGFnaW5nICkgewoKCQkJCQkvLyJ0aGlzIiByZWZlcnMgdG8gdGhlIHF1ZXJ5YWJsZSBub2RlIGJ1dCBub3QgdGhlIHF1ZXJ5YWJsZSBvYmplY3QKCQkJCQl2YXIgJGl0ZW1zID0gJCggaXRlbXMgKSwKCgkJCQkJLy9ydW4gZmlsdGVyCgkJCQkJCXJ0biA9IGZpbHRlckZuID8gJGl0ZW1zLmZpbHRlciggZmlsdGVyRm4gKS5nZXQoKSA6ICRpdGVtcy5nZXQoKTsKCgkJCQkJaGFzUXVlcnlSZXN1bHROb2RlLnVwZGF0ZSggcnRuLmxlbmd0aCA+IDAgKTsKCgkJCQkJLy9ydW4gc29ydAoJCQkJCWlmIChzb3J0LmJ5KSB7CgoJCQkJCQlydG4uc29ydE9iamVjdCggc29ydC5ieSwgc29ydC5hc2MgKTsKCQkJCQl9CgoJCQkJCS8vcnVuIHBhZ2luZwoJCQkJCWlmICghZGlzYWJsZVBhZ2luZyAmJiBwYWdlci5lbmFibGVkKSB7CgkJCQkJCXZhciBjb3VudCA9IE1hdGguY2VpbCggcnRuLmxlbmd0aCAvIHBhZ2VyLnNpemUgKSB8fCAxOwoJCQkJCQlpZiAoY291bnQgIT0gcGFnZXIuY291bnQpIHsKCQkJCQkJCXBhZ2VyLmNvdW50ID0gY291bnQ7CgkJCQkJCQlpZiAocGFnZXIuaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJCQlwYWdlci5pbmRleCA9IDA7CgkJCQkJCQl9CgkJCQkJCQkvLwoJCQkJCQkJcXVlcnlOb2RlLmNoYW5nZSggInBhZ2VyIiApOwoJCQkJCQl9CgkJCQkJCXJ0biA9IHJ0bi5zbGljZSggcGFnZXIuaW5kZXggKiBwYWdlci5zaXplLCAocGFnZXIuaW5kZXggKyAxKSAqIHBhZ2VyLnNpemUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBydG47CgkJCQl9LAoKCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHZpYSBxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCkKCQkJCS8vb3IgaXQgY2FuIGJlIGNhbGxlZCB2aWEgbm9kZSBsaWtlIGl0ZW1zKnJlZnJlc2hRdWVyeQoJCQkJLy8KCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHJlZ2FyZGxlc3Mgd2hldGhlciBhdXRvUXVlcnkgaXMgZW5hYmxlZCwKCQkJCS8vIGJlY2F1c2UgaW50ZXJuYWxseSBpdCBjaGVjayB0aGUgZmxhZyB0byBkZXRlcm1pbmUgaWYKCQkJCS8vIGl0IGlzIG5lY2Vzc2FyeSB0byB0cmlnZ2VyIHRoZSBjaGFuZ2UgZXZlbnQKCQkJCXJlZnJlc2hRdWVyeTogZnVuY3Rpb24oKSB7CgkJCQkJLy9pZiBhdXRvUXVlcnkgaXMgdHJ1ZSwgdGhlbiBkb24ndCBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGFnYWluCgkJCQkJaWYgKCFxdWVyeWFibGUuYXV0b1F1ZXJ5KSB7CgkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJcXVlcnlSZXN1bHROb2RlLnRyaWdnZXIoICJhZnRlclVwZGF0ZSIgKTsKCQkJCQkJfSwgMCApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFnaW5nOiBmdW5jdGlvbiggZSApIHsKCgkJCQkJdmFyIGluZGV4ID0gZS5ldmVudERhdGE7CgoJCQkJCWlmIChyRGlnaXQudGVzdCggaW5kZXggKSkgewoKCQkJCQkJaW5kZXggPSAraW5kZXg7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoaW5kZXggPT0gIm5leHQiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5pbmRleCArIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJwcmV2aW91cyIpIHsKCgkJCQkJCQlpbmRleCA9IHBhZ2VyLmluZGV4IC0gMTsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImZpcnN0IikgewoKCQkJCQkJCWluZGV4ID0gMDsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImxhc3QiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5jb3VudCAtIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJkaXNhYmxlZCIpIHsKCQkJCQkJCWluZGV4ID0gMDsKCQkJCQkJCXF1ZXJ5YWJsZS5yZXNldFBhZ2luZygpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mIGluZGV4ICE9PSAibnVtYmVyIiB8fCBpbmRleCA8IDAgfHwgaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJaW5kZXggPSAwOwoJCQkJCX0KCgkJCQkJcGFnZXJOb2RlLnVwZGF0ZSggImluZGV4IiwgaW5kZXggKTsKCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQl9LAoKCQkJCXJlc2V0U29ydDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCXNvcnROb2RlLnNldCggImJ5IiwgbnVsbCApCgkJCQkJCS5zZXQoICJhc2MiLCBudWxsICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNldFNlYXJjaDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCWZpbHRlck5vZGUudXBkYXRlKCAiYnkiLCAiIiApCgkJCQkJCS51cGRhdGUoICJ2YWx1ZSIsICIiICkKCQkJCQkJLnVwZGF0ZSggIm9wcyIsICIiICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoKCQkJCX0sCgoJCQkJcmVzZXRQYWdpbmc6IGZ1bmN0aW9uKCB0cmlnZ2VyQnlNYXN0ZXJSZXNldCApIHsKCQkJCQlwYWdlck5vZGUudXBkYXRlKCAiZW5hYmxlZCIsIGZhbHNlICkKCQkJCQkJLnVwZGF0ZSggInNpemUiLCAwICkKCQkJCQkJLnVwZGF0ZSggImNvdW50IiwgMSApCgkJCQkJCS51cGRhdGUoICJpbmRleCIsIDAgKTsKCgkJCQkJaWYgKHRyaWdnZXJCeU1hc3RlclJlc2V0ICE9PSB0cnVlKSB7CgkJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCQl9CgoJCQkJfSwKCgkJCQlyZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKCQkJCQlxdWVyeWFibGUucmVzZXRTb3J0KCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0U2VhcmNoKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0UGFnaW5nKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlZnJlc2hRdWVyeSgpOwoJCQkJfQoJCQl9CgkJKTsKCgkJZnVuY3Rpb24gYnVpbGRGaWx0ZXJGbiggZSApIHsKCQkJdmFyIG9wcyA9IGZpbHRlci5vcHMsCgkJCQlieSA9IGZpbHRlci5ieSwKCQkJCXZhbHVlID0gZmlsdGVyLnZhbHVlLAoJCQkJcmVnZXg7CgoJCQlpZiAodmFsdWUpIHsKCgkJCQlpZiAoIW9wcykgewoJCQkJCS8vYnkgZGVmYXVsdCBpdCBzIGNvbnRhaW5zCgkJCQkJcmVnZXggPSBSZWdFeHAoIHZhbHVlLCAiaSIgKTsKCgkJCQl9IGVsc2UgaWYgKG9wcyA9PSAiZXF1YWxzIikgewoKCQkJCQlyZWdleCA9IFJlZ0V4cCggIl4iICsgdmFsdWUgKyAiJCIsICJpIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRocm93ICJvcGVyYXRvciBkb2VzIG5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJCWZpbHRlckZuID0gKGJ5KSA/CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZWdleC50ZXN0KCB0aGlzW2J5XSApOwoJCQkJCX0gOgoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoaXNPYmplY3QoIHRoaXMgKSkgewoJCQkJCQkJZm9yICh2YXIga2V5IGluIHRoaXMpIHsKCQkJCQkJCQlpZiAocmVnZXgudGVzdCggdGhpc1trZXldICkpIHsKCQkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoIHRoaXMgKTsKCQkJCQkJfQoJCQkJCX07CgoJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCB0cnVlICk7CgkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoZmlsdGVyRm4pIHsKCQkJCQlmaWx0ZXJGbiA9IG51bGw7CgkJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCBmYWxzZSApOwoJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCX0KCQkJfQoJCX0KCgkJZmlsdGVyTm9kZS5jZCggImJ5IiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCWZpbHRlck5vZGUuY2QoICJ2YWx1ZSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGJ1aWxkRmlsdGVyRm4gKTsKCQlmaWx0ZXJOb2RlLmNkKCAib3BzIiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCXJldHVybiB0aGlzOwoJfTsKCgliaW5kaW5ncyggewoKCQkvL2xpc3RWaWV3OmFycmF5UGF0aHxyb3dUZW1wbGF0ZUlkCgkJLy8KCQlsaXN0VmlldzogLy8KCgkJLy9zdWJzY3JpcHRpb24gZnJvbSB2aWV3CgkJCSJ0bXBsT25DaGFuZ2U6LjsiICsKCQkJCS8vcmVuZGVyIG5ld2x5IGFwcGVuZGVkIGRhdGEgaXRlbSBieSBhcHBlbmRpbmcgaXQgdG8gZW5kIG9mIHRoZSB2aWV3CgkJCSIhYWZ0ZXJDcmVhdGUuMToufCphZGRSb3dWaWV3OyIgKwoJCQkJLy9yZW5kZXIgdGhlIHVwZGF0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJVcGRhdGUuMToufCp1cGRhdGVSb3dWaWV3OyIgKwoJCQkJLy9kZWxldGUgdGhlIGRlbGV0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJEZWwuMToufCpyZW1vdmVSb3dWaWV3IiwKCgkJZW5hYmxlUXVlcnk6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlobSggcGF0aCApLmVuYWJsZVF1ZXJ5KCAhIW9wdGlvbnMgKTsKCQl9LAoKCQkvL3JlbmRlciB0aGUgd2hvbGUgbGlzdCBvZiBpdGVtcwoJCS8vcXVlcnlWaWV3Oml0ZW1zCgkJcXVlcnlWaWV3OiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeVJlc3VsdCIsCgoJCS8vc29ydDppdGVtc3xmaXJzdE5hbWUKCQlzb3J0UXVlcnk6ICIkY2xpY2s6KnF1ZXJ5LnNvcnQuYnl8KnNldFRvOyIgKwoJCSAgICAgICAgICAgICAgICAgIiRjbGljazoqcXVlcnkuc29ydC5hc2N8KnRvZ2dsZTsiICsKCQkgICAgICAgICAgICAgICAgICIkY2xpY2s6KnJlZnJlc2hRdWVyeSIsCgoJCS8vcmVzZXRTb3J0Oml0ZW1zCgkJcmVzZXRTb3J0OiAiJGNsaWNrOipyZXNldFNvcnQ7IiArCgkJICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuc29ydC5ieSIsCgoJCS8vc2VhcmNoOml0ZW1zCgkJc2VhcmNoOiAiJGNsaWNrOipyZWZyZXNoUXVlcnk7IiArCgkJICAgICAgICAgICAgICAiZW5hYmxlOipxdWVyeS5maWx0ZXIuZW5hYmxlZCIsCgoJCXJlc2V0U2VhcmNoOiAiJGNsaWNrOipyZXNldFNlYXJjaDsiICsKCQkgICAgICAgICAgICAgICAgICAgInNob3c6KnF1ZXJ5LmZpbHRlci5lbmFibGVkIiwKCgkJcmVzZXRRdWVyeTogIiRjbGljazoqcmVzZXRRdWVyeTsiICsKCQkgICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuZW5hYmxlZCIsCgoJCXNlYXJjaEJveDogIm5zOipxdWVyeS5maWx0ZXIudmFsdWU7IiArCgkJICAgICAgICAgICAidmFsOi58ZW50ZXI7IiArCgkJICAgICAgICAgICAiJGVzYzoufCpudWxsIiwKCgkJLy9wYWdlcjppdGVtc3wjcGFnZXJUZW1wbGF0ZQoJCXBhZ2VyOiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeS5wYWdlcjsiICsgLy9yZW5kZXIgcGFnZXIgdXNpbmcgdGhlIGRhdGEgdW5kZXIgaXRlbXMqcXVlcnkucGFnZXIKCQkgICAgICAgInNob3c6Kmhhc1F1ZXJ5UmVzdWx0fF87IiArCgkJICAgICAgICIkcGFnaW5nOipwYWdpbmc7IiArCgkJICAgICAgICJwcmV2ZW50RGVmYXVsdDouIiwKCgkJc2V0UGFnZTogInRydWU6KnF1ZXJ5LnBhZ2VyLmVuYWJsZWQ7IiArCgkJICAgICAgICAgICAgICAgImVuYWJsZToqcXVlcnkucGFnZXIuc2l6ZTsiICsKCQkgICAgICAgICAgICAgICAiJGNsaWNrOipyZWZyZXNoUXVlcnkiLAoKCQkvL3BhdGggaXMgaWdub3JlLCBkb2VzIG5vdCBjcmVhdGUgYW55IHN1YnNjcmlwdGlvbgoJCXBhZ2U6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBwYWdlSW5kZXggKSB7CgkJCWlmICghcGFnZUluZGV4KSB7CgkJCQl0aHJvdyAicGFnZUluZGV4IGlzIG1pc3NpbmciOwoJCQl9CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgInBhZ2luZyIsIHBhZ2VJbmRleCApOwoJCX0sCgoJCXNob3dGb3VuZDogInNob3c6Kmhhc1F1ZXJ5UmVzdWx0IiwKCgkJaGlkZUZvdW5kOiAiaGlkZToqaGFzUXVlcnlSZXN1bHQiCgl9ICk7CgoKCi8vCi8qCiA8QGRlcGVuZHM+CiBzdWJzY3JpcHRpb24uanMsCiBtb2RlbC5qcwogPC9AZGVwZW5kcz4KICovCgoKCS8vY3JlYXRlIGEgdGFibGUgd2l0aCBzb21lIHNlZWRzCglmdW5jdGlvbiBjcmVhdGVUYWJsZSggc2VlZHMgKSB7CgkJaWYgKGlzVW5kZWZpbmVkKCBzZWVkcyApKSB7CgkJCXNlZWRzID0gW107CgkJfSBlbHNlIGlmICghaXNBcnJheSggc2VlZHMgKSkgewoJCQlzZWVkcyA9IFtzZWVkc107CgkJfQoKCQlpZiAoc2VlZHMudGFibGUgJiYgc2VlZHMuZ3VpZCkgewoJCQlyZXR1cm4gc2VlZHM7CgkJfQoKCQlzZWVkcy50YWJsZSA9IHt9OwoJCXNlZWRzLmd1aWQgPSAwOwoJCXJldHVybiBzZWVkczsKCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVVcGRhdGVEZXNjZW5kYW50KCBlICkgewoKCQl2YXIgdGFibGUsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlpZiAoZS5sZXZlbCA9PT0gMSkgewoJCQl0YWJsZSA9IHB1Ymxpc2hlci5nZXQoKS50YWJsZTsKCgkJCS8vdGhlIGV2ZW50IGlzIGNhdXNlZCBieSB1cGRhdGluZyB0byB0aGUgYW4gaXRlbSBpZiB0aGUgYXJyYXkKCQkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCQlpZiAodGFibGVba2V5XSA9PSBlLnJlbW92ZWQpIHsKCQkJCQl0aGlzLnNldCgga2V5LCBlLnByb3Bvc2VkICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIGlmIChlLmxldmVsID49IDIpIHsKCgkJCXZhciBvcmlnaW5hbFBhdGggPSBlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgsCgkJCQlwYXRoID0gcHVibGlzaGVyLnBhdGgsCgkJCQlyZW1haW5pbmcgPSBvcmlnaW5hbFBhdGguc3Vic3RyKCBwYXRoLmxlbmd0aCArIDEgKSwKCQkJCWluZGV4ID0gcmVtYWluaW5nLnN1YnN0ciggMCwgcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQlpZiAoJC5pc051bWVyaWMoIGluZGV4ICkpIHsKCgoJCQkJLy9lLmcgY29udGFjdHMuMS5maXJzdE5hbWUgaXMgdXBkYXRlZAoJCQkJLy9pbmRleCA9PSAxCgkJCQkvL2l0ZW1LZXkgPSBjMQoKCQkJCXZhciBpdGVtS2V5ID0gcHVibGlzaGVyLmtleUF0KCBpbmRleCApLAoJCQkJCWZ1bGxQYXRoT2ZLZXlJdGVtID0gInRhYmxlLiIgKyBpdGVtS2V5ICsgcmVtYWluaW5nLnN1YnN0ciggcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQkJLy9zdWJQYXRoID09IHRhYmxlLmMxLmZpcnN0TmFtZQoJCQkJcHVibGlzaGVyLnRyaWdnZXIoIGZ1bGxQYXRoT2ZLZXlJdGVtLCAiYWZ0ZXJVcGRhdGUiLCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCggZSApIHsKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuZ2V0KCkuZ3VpZCsrLCBlLnByb3Bvc2VkICk7Cgl9CgoJZnVuY3Rpb24gaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQoIGUgKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5nZXQoKSwKCQkJcmVtb3ZlZCA9IGUucmVtb3ZlZDsKCgkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCWlmICh0YWJsZVtrZXldID09PSByZW1vdmVkKSB7CgkJCQl0aGlzLmRlbCgga2V5ICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVUYWJsZU5vZGVEZWxldGVDaGlsZCggZSApIHsKCQl0aGlzLnJlbW92ZUl0ZW0oIGUucmVtb3ZlZCApOwoJfQoKCWZ1bmN0aW9uIGhhbmRsZVRhYmxlTm9kZVVwZGF0ZUNoaWxkKCBlICkgewoJCXRoaXMucmVwbGFjZUl0ZW0oIGUucmVtb3ZlZCwgZS5wcm9wb3NlZCApOwoJfQoKCS8vCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CglobS5vbkFkZE9yVXBkYXRlTm9kZSggZnVuY3Rpb24oIGNvbnRleHQsIGluZGV4LCBhcnJheSApIHsKCgkJaWYgKCFpc0FycmF5KCBhcnJheSApKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0YWJsZSA9IGNyZWF0ZVRhYmxlKCBhcnJheSApLnRhYmxlOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCXRhYmxlW2FycmF5Lmd1aWQrK10gPSBhcnJheVtpXTsKCQl9CgoJCXZhciBhcnJheU5vZGUgPSBobSggY29udGV4dCApLmNkKCBpbmRleCApLAoJCQl0YWJsZU5vZGUgPSBhcnJheU5vZGUuY2QoICJ0YWJsZSIgKTsKCgkJLy93aGVuIGl0ZW0gaXMgaW5zZXJ0ZWQgaW4gYXJyYXksIGluc2VydCB0aGUgaXRlbSBpbiB0YWJsZQoJCXRhYmxlTm9kZS5zdWIoIGFycmF5Tm9kZSwgImFmdGVyQ3JlYXRlLjEiLCBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCApOwoKCQkvL3doZW4gaXRlbSBpcyB1cGRhdGVkIGluIGl0ZW1zTm9kZSwgdXBkYXRlIHRoZSBpdGVtIGluIHRhYmxlCgkJdGFibGVOb2RlLnN1YiggYXJyYXlOb2RlLCAiYWZ0ZXJVcGRhdGUuKiIsIGhhbmRsZUFycmF5Tm9kZVVwZGF0ZURlc2NlbmRhbnQgKTsKCgkJLy93aGVuIGl0ZW0gZGVsZXRlZCBpbiBhcnJheSwgZGVsZXRlIHRoZSBpdGVtIGluIGhhc2ggdGFibGUKCQl0YWJsZU5vZGUuc3ViKCBhcnJheU5vZGUsICJhZnRlckRlbC4xIiwgaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQgKTsKCgkJLy93aGVuIGl0ZW0gaXMgZGVsZXRlZCBpbiB0YWJsZSwgZGVsZXRlIHRoZSBpdGVtIGluIGFycmF5CgkJYXJyYXlOb2RlLnN1YiggdGFibGVOb2RlLCAiYWZ0ZXJEZWwuMSIsIGhhbmRsZVRhYmxlTm9kZURlbGV0ZUNoaWxkICk7CgoJCS8vd2hlbiBpdGVtIGlzIHVwZGF0ZWQgaW4gdGFibGUsIHVwZGF0ZSB0aGUgaXRlbSBpbiBhcnJheQoJCWFycmF5Tm9kZS5zdWIoIHRhYmxlTm9kZSwgImFmdGVyVXBkYXRlLjEiLCBoYW5kbGVUYWJsZU5vZGVVcGRhdGVDaGlsZCApOwoKCX0gKTsKCglobUZuLml0ZW1LZXkgPSBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIga2V5LAoJCQl0YWJsZSwKCQkJYXJyYXkgPSB0aGlzLnJhdygpOwoKCQlpZiAoaXNGdW5jdGlvbiggYXJyYXkgKSkgewoJCQlhcnJheSA9IHRoaXMubWFpbigpLmdldCgpOwoJCX0KCQl0YWJsZSA9IGFycmF5LnRhYmxlOwoKCQlpZiAodGFibGUpIHsKCQkJZm9yIChrZXkgaW4gdGFibGUpIHsKCQkJCWlmIChpdGVtID09PSB0YWJsZVtrZXldKSB7CgkJCQkJcmV0dXJuIGtleTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJaG1Gbi5rZXlBdCA9IGZ1bmN0aW9uKCBpbmRleCApIHsKCQlyZXR1cm4gdGhpcy5pdGVtS2V5KCB0aGlzLmdldCggaW5kZXggKSApOwoJfTsKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2F1Z21lbnQgalF1ZXJ5IEV2ZW50IHR5cGUKCS8vd2hlbiB5b3UgYXR0YWNoIGEgd29ya2Zsb3cgdG8gcGFyZW50IGVsZW1lbnQgdG8gaGFuZGxlIHRoZSBldmVudCBmcm9tIGNoaWxkcmVuCgkvL3dlIHdhbnQgdG8ga25vdyB0aGUgY2hpbGRyZW4gZWxlbWVudCdzIHJvdyBpbmRleCBvZiBhbGwgdGhlIHJvd3MKCSQuRXZlbnQucHJvdG90eXBlLnNlbGVjdGVkUm93SW5kZXggPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdWJsaXNoZXIuY2hpbGRyZW4oKS5maWx0ZXIoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGFyZW50cygpICkuaW5kZXgoKTsKCX07CgoJZnVuY3Rpb24gRWRpdE9iamVjdCggaW5kZXggKSB7CgkJdGhpcy5zZWxlY3RlZEluZGV4ID0gaW5kZXg7Cgl9CgoJRWRpdE9iamVjdC5wcm90b3R5cGUgPSB7CgkJaXRlbTogbnVsbCwKCQkvL2xvZ2ljYWxseSBtb2RlIGRlcGVuZHMgb24gIml0ZW0iIGFuZCAiaW5kZXgiCgkJLy9idXQgaGVyZSB3ZSBkaXNhYmxlIHRoZXNlIGRlcGVuZGVuY2llcywgYmVjYXVzZSB3ZSB3YW50IHRvCgkJLy9tYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudHMKCQkvL2lmIGl0IHJlYWxseSBkZXBlbmRzIHRoZW0sIHRoZSBldmVudHMgd2lsbCBiZSBoYXJkIHRvIGNvbnRyb2xsZWQKCQltb2RlOiBmdW5jdGlvbiBfXygpIHsKCQkJdmFyIGVkaXQgPSB0aGlzLmdldCgpLAoJCQkJaXRlbSA9IGVkaXQuaXRlbSwKCQkJCXNlbGVjdGVkSW5kZXggPSBlZGl0LnNlbGVjdGVkSW5kZXg7CgoJCQlyZXR1cm4gaXRlbSA9PT0gbnVsbCA/ICJyZWFkIiA6CgkJCQlpc1VuZGVmaW5lZCggc2VsZWN0ZWRJbmRleCApID8gInVwZGF0ZSIgOgoJCQkJCShzZWxlY3RlZEluZGV4ID09IC0xKSA/ICJuZXciIDoKCQkJCQkJInVwZGF0ZSI7CgoJCX0KCX07CgoJLy90aGUgZm9sbG93IG1ldGhvZHMgYXJlIGRlc2lnbmVkIHRvIGJlIHVzZWQgd2l0aCBhcnJheSBtb2RlbAoJLy8gdGhleSBhcmUgdXNlZCB0byBtYW5pcHVsYXRlIHRoZSBzaGFkb3cgZWRpdCBvYmplY3Qgb2YgYXJyYXkgbW9kZWwKCWV4dGVuZCggaG1GbiwgewoKCQkvL2luaXRTaGFkb3dFZGl0IGlzIHJlcXVpcmVkIGZvciBhcnJheSBtb2RlbCBvciBmb3IgYXJyYXkgcXVlcnkgZnVuY3Rpb25zCgkJLy9pdCBpcyBub3QgbmVjZXNzYXJ5IGZvciBtb2RlbCBvZiBvdGhlciB0eXBlCgkJaW5pdFNoYWRvd0VkaXQ6IGZ1bmN0aW9uKCBpdGVtVGVtcGxhdGUgKSB7CgkJCS8vaXQgaXMgYSBjb252ZW50aW9uIHRoYXQsIGlmIHRoZSBwYXRoIG9mIGxpc3QgZGF0YSBpcyBpdGVtcwoJCQkvL3dlIHRha2UgaXRlbXNfaXRlbVRlbXBsYXRlIGFzIHRlbXBsYXRlIGZyb20gbmV3IGl0ZW0gZm9yIHRoZSBsaXN0IGRhdGEKCgkJCXZhciBtb2RlbCA9IHRoaXM7CgoJCQlpZiAobW9kZWwuZ2V0KCAiKmVkaXQiICkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgaXRlbXNQYXRoID0gbW9kZWwucGF0aCwKCQkJCXJDaGlsZFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXipdK1xcKiQiICksCgkJCQlyRGVlcFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXFx3Ll0rXFwqZWRpdFxcLml0ZW0iICk7CgoJCQlpZiAoaXNVbmRlZmluZWQoIGl0ZW1UZW1wbGF0ZSApKSB7CgoJCQkJaWYgKG1vZGVsLmlzU2hhZG93KCkgJiYgIWlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkvL2lmIHRoZSBhcnJheSBvYmplY3QgaXRlbXMgaXMgYWxyZWFkeSBpbiBzaGFkb3cKCQkJCQkvL3RoZSBpdGVtVGVtcGxhdGUgaXMgYWxyZWFkeSBkZWZpbmVkIGluIG1haW4gaXRlbXMnIGl0ZW1UZW1wbGF0ZQoJCQkJCS8vZm9yIGV4YW1wbGUKCQkJCQkvL3RoZSBpdGVtc1BhdGggaXMgImRvYy5lbnRyaWVzKmVkaXQuaXRlbS5wZXJzb25hbC5zaWduYXR1cmVzIgoJCQkJCS8vdGhlIGl0ZW1UZW1wbGF0ZSBpcyBkZWZpbmVkIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0ucGVyc29uYWwuc2lnbmF0dXJlcy4wIgoJCQkJCS8vdGhlIGZvbGxvd2luZyBpcyB0cnkgdG8gZ2V0IHRoZSBpdGVtVGVtcGxhdGUKCQkJCQkvLwoJCQkJCS8vdGhlIG1haW5Nb2RlbCBpcyBkb2MuZW50cmllcwoJCQkJCXZhciBtYWluTW9kZWwgPSBtb2RlbC5tYWluKCk7CgoJCQkJCS8vdGhlIGVkaXRpbmdNb2RlbFBhdGggb2YgbWFpbk1vZGVsIGlzIGRvYy5lbnRyaWVzKmVkaXQuaXRlbQoJCQkJCXZhciBlZGl0aW5nTW9kZWxQYXRoID0gbWFpbk1vZGVsLmxvZ2ljYWxQYXRoKCkgKyAiKmVkaXQuaXRlbSI7CgoJCQkJCS8vdGhlIHBvc2l0aW9uIG9mIGxhc3QgIi4iIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0uIgoJCQkJCXZhciBzdGFydEluZGV4ID0gZWRpdGluZ01vZGVsUGF0aC5sZW5ndGggKyAxOwoKCQkJCQkvL3RoZSBwb3J0aW9uIG9mICJwZXJzb25hbC5zaWduYXR1cmVzIiBpbiAiZG9jLmVudHJpZXMqZWRpdC5pdGVtLnBlcnNvbmFsLnNpZ25hdHVyZXMiCgkJCQkJdmFyIHN1YlBhdGggPSB0b0xvZ2ljYWxQYXRoKCBpdGVtc1BhdGggKS5zdWJzdHIoIHN0YXJ0SW5kZXggKTsKCgkJCQkJLy9nZXQgImRvYy5lbnRyaWVzKmVkaXQuaXRlbVRlbXBsYXRlLnBlcnNvbmFsLnNpZ25hdHVyZXMuMCIKCQkJCQlpdGVtVGVtcGxhdGUgPSBjbG9uZSggbWFpbk1vZGVsLmdldCggIiplZGl0Lml0ZW1UZW1wbGF0ZS4iICsgc3ViUGF0aCArICIuMCIgKSwgdHJ1ZSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGNvbnZlbnRpb24gaXMgdGhhdCBpZiB3ZSBoYXZlIG1vZGVsIGF0IHBhdGggImNvbnRhY3RzIiwKCQkJCQkvL3RoZSB0ZW1wbGF0ZSBpdGVtIGlzIGV4cGVjdGVkIGF0ICJjb250YWN0c19pdGVtVGVtcGxhdGUiCgkJCQkJaWYgKGlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkJaXRlbVRlbXBsYXRlID0gcm9vdE5vZGUucmF3KCBtb2RlbC5tYWluKCkucGF0aCArICJfaXRlbVRlbXBsYXRlIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWl0ZW1UZW1wbGF0ZSA9IHJvb3ROb2RlLnJhdyggaXRlbXNQYXRoICsgIl9pdGVtVGVtcGxhdGUiICk7CgkJCQkJfQoKCQkJCQkvL2lmIGNvbnZlbnRpb24gaXMgbm90IGZvbGxvd2VkLCB1c2UgdGhlIGV4aXN0aW5nIGFzIHRlbXBsYXRlCgkJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtVGVtcGxhdGUgKSkgewoJCQkJCQlpdGVtVGVtcGxhdGUgPSBjbGVhck9iaiggY2xvbmUoIG1vZGVsLmdldCgpWzBdLCB0cnVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXZhciBlZGl0T2JqZWN0ID0gbmV3IEVkaXRPYmplY3QoIC0xICk7CgkJCWVkaXRPYmplY3QuaXRlbVRlbXBsYXRlID0gaXRlbVRlbXBsYXRlOwoJCQllZGl0T2JqZWN0Lml0ZW0gPSBudWxsOwoKCQkJbW9kZWwuc2V0KCAiKmVkaXQiLCBlZGl0T2JqZWN0ICk7CgoJCQkvL3dlIHdhbnQgdG8gdHJpZ2dlciBiZWdpbkluUm93VXBkYXRlL2NhbmNlbEluUm93VXBkYXRlIGFmdGVyIHNlbGVjdGVkSW5kZXggaGFzIGNoYW5nZWQKCQkJLy9iZWNhdXNlIHRoZSBoYW5kbGVycyBkZXBlbmRzIG9uIHRoZSBhdmFpbGFiaWxpdHkgb2Ygc2VsZWN0ZWRJbmRleAoJCQltb2RlbC5jZCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICkuaGFuZGxlKCAiYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbmV3SW5kZXggPSBlLnByb3Bvc2VkLAoJCQkJCW9sZEluZGV4ID0gZS5yZW1vdmVkOwoKCQkJCWlmIChuZXdJbmRleCA+PSAwKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJiZWdpbkluUm93VXBkYXRlIiwgbmV3SW5kZXggKTsKCgkJCQl9IGVsc2UgaWYgKG5ld0luZGV4ID09IC0xKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJjYW5jZWxJblJvd1VwZGF0ZSIsIG9sZEluZGV4ICk7CgkJCQl9CgkJCX0gKTsKCgkJCW1vZGVsLmNkKCAiKmVkaXQuaXRlbSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGtleSwgbG9naWNhbFBhdGgsIGVkaXRPYmplY3Q7CgoJCQkJZm9yIChrZXkgaW4gc2hhZG93Um9vdCkgewoKCQkJCQlsb2dpY2FsUGF0aCA9IHV0aWwudG9Mb2dpY2FsUGF0aCggIl9faG0uIiArIGtleSApOwoKCQkJCQlpZiAockRlZXBTaGFkb3dJdGVtLnRlc3QoIGxvZ2ljYWxQYXRoICkpIHsKCgkJCQkJCWRlbGV0ZSBzaGFkb3dSb290W2tleV07CgoJCQkJCX0gZWxzZSBpZiAockNoaWxkU2hhZG93SXRlbS50ZXN0KCBsb2dpY2FsUGF0aCApKSB7CgoJCQkJCQllZGl0T2JqZWN0ID0gc2hhZG93Um9vdFtrZXldLmVkaXQ7CgoJCQkJCQlpZiAoZWRpdE9iamVjdCkgewoJCQkJCQkJZWRpdE9iamVjdC5pdGVtID0gbnVsbDsKCQkJCQkJCWVkaXRPYmplY3Quc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vY3JlYXRlIGEgbmV3IGl0ZW0gaW4gc2hhZG93IGVkaXQgb2JqZWN0IGZvciBpdGVtcyBtb2RlbAoJCS8vbm90IG5lY2Vzc2FyeSBmb3IgbW9kZWwgb2YgcHJpbWl0aXZlIHR5cGUgYW5kIG9iamVjdHMKCQluZXdTaGFkb3dJdGVtOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPT0gInJlYWQiKSB7CgkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgZWRpdFNoYWRvd01vZGVsID0gdGhpcy5jZCggIiplZGl0IiApLAoJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCWl0ZW0gPSAoaXNGdW5jdGlvbiggaXRlbVRlbXBsYXRlICkpID8KCQkJCQlpdGVtVGVtcGxhdGUoKSA6CgkJCQkJY2xvbmUoIGl0ZW1UZW1wbGF0ZSwgdHJ1ZSApOwoKCQkJZWRpdFNoYWRvd01vZGVsLnVwZGF0ZSggIml0ZW0iLCBpdGVtICk7CgkJCWVkaXRTaGFkb3dNb2RlbC5jaGFuZ2UoICJtb2RlIiApOwoJCX0sCgoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggaXRlbSwgaXRlbUluZGV4ICkgewoKCQkJdmFyIGl0ZW1WYWx1ZSA9IHRoaXMucmF3KCk7CgkJCWlmIChpc1ByaW1pdGl2ZSggaXRlbVZhbHVlICkgfHwgaXNPYmplY3QoIGl0ZW1WYWx1ZSApKSB7CgoJCQkJdmFyIGVkaXQgPSB0aGlzLmdldCggIiplZGl0IiApOwoJCQkJaWYgKGlzVW5kZWZpbmVkKCBlZGl0ICkpIHsKCQkJCQllZGl0ID0gbmV3IEVkaXRPYmplY3QoKTsKCQkJCQl0aGlzLnNldCggIiplZGl0IiwgZWRpdCApOwoJCQkJfQoKCQkJCWlmIChlZGl0Lml0ZW0gIT09IG51bGwpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgY2xvbmUoIGl0ZW1WYWx1ZSwgdHJ1ZSApICk7CgkJCQl0aGlzLmNoYW5nZSggIiplZGl0Lm1vZGUiICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLmdldCggIiplZGl0Lm1vZGUiICkgIT09ICJyZWFkIikgewoJCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCQl9CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtSW5kZXggKSkgewoJCQkJCWl0ZW1JbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdGhpcy5nZXQoKVtpdGVtSW5kZXhdOwoJCQkJfQoKCQkJCXZhciBlZGl0U2hhZG93TW9kZWwgPSB0aGlzLmNkKCAiKmVkaXQiICksCgkJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCQljb3B5ID0gKGlzRnVuY3Rpb24oIGl0ZW1UZW1wbGF0ZSApKSA/CgkJCQkJCWl0ZW1UZW1wbGF0ZSggaXRlbSApIDoKCQkJCQkJY2xvbmUoIGl0ZW0sIHRydWUgKTsKCgkJCQllZGl0U2hhZG93TW9kZWwudXBkYXRlKCAiaXRlbSIsIGNvcHkgKQoJCQkJCS51cGRhdGUoICJzZWxlY3RlZEluZGV4IiwgaXRlbUluZGV4ICk7CgoJCQkJZWRpdFNoYWRvd01vZGVsLmNoYW5nZSggIm1vZGUiICk7CgkJCX0KCgkJfSwKCgkJcmVzZXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggc2F2ZSApIHsKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5yZXNldFNoYWRvd0l0ZW0oKTsKCQkJfQoKCQkJdmFyIGl0ZW1zID0gdGhpcy5yYXcoKTsKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgbnVsbCApOwoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgZWRpdCA9IHRoaXMuY2QoICIqZWRpdCIgKTsKCQkJCWlmICghaXNVbmRlZmluZWQoIGVkaXQuZ2V0KCkgKSkgewoKCQkJCQllZGl0LnVwZGF0ZSggIml0ZW0iLCBudWxsICk7CgoJCQkJCWlmIChzYXZlKSB7CgkJCQkJCS8vaWYgaXQgdHJpZ2dlcmVkIGJ5IHNhdmVTaGFkb3dJdGVtCgkJCQkJCS8vdXBkYXRlIHNlbGVjdGVkSW5kZXggZGlyZWN0bHkgdG8gYXZvaWQgZXZlbnRzCgkJCQkJCWVkaXQuZ2V0KCkuc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWVkaXQudXBkYXRlKCAic2VsZWN0ZWRJbmRleCIsIC0xICk7CgkJCQkJfQoKCQkJCQllZGl0LmNoYW5nZSggIm1vZGUiICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJc2F2ZVNoYWRvd0l0ZW06IGZ1bmN0aW9uKCkgewoKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5zYXZlU2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgaXRlbXMgPSB0aGlzLnJhdygpOwoKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoIHRoaXMuZ2V0KCAiKmVkaXQuaXRlbSIgKSApCgkJCQkJLnNldCggIiplZGl0Lml0ZW0iLCBudWxsICk7CgoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgY3VycmVudEVkaXRNb2RlID0gdGhpcy5nZXQoICIqZWRpdC5tb2RlIiApLAoJCQkJCXBlbmRpbmdJdGVtID0gdGhpcy5nZXQoICIqZWRpdC5pdGVtIiApOwoKCQkJCWlmIChjdXJyZW50RWRpdE1vZGUgPT0gInJlYWQiKSB7CgoJCQkJCXRocm93ICJpbnZhbGlkIG9wZXJhdGlvbnMiOwoKCQkJCX0gZWxzZSBpZiAoY3VycmVudEVkaXRNb2RlID09ICJuZXciKSB7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJdGhpcy5tYWluKCkucHVzaCggcGVuZGluZ0l0ZW0gKTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5wdXNoKCBwZW5kaW5nSXRlbSApOwoJCQkJCX0KCgkJCQkJdGhpcy5yZXNldFNoYWRvd0l0ZW0oKTsKCgkJCQl9IGVsc2UgLyppZiAoY3VycmVudEVkaXRNb2RlID09ICJ1cGRhdGUiKSovIHsKCgkJCQkJdmFyIHNlbGVjdGVkSW5kZXggPSB0aGlzLmdldCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICk7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoJCQkJCQl0aGlzLm1haW4oKS5yZXBsYWNlSXRlbSgKCQkJCQkJCWl0ZW1zW3NlbGVjdGVkSW5kZXhdLAoJCQkJCQkJcGVuZGluZ0l0ZW0KCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlcGxhY2VJdGVtKAoJCQkJCQkJaXRlbXNbc2VsZWN0ZWRJbmRleF0sCgkJCQkJCQlwZW5kaW5nSXRlbQoJCQkJCQkpOwoJCQkJCX0KCQkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSggdHJ1ZSApOwoJCQkJfQoKCQkJfQoJCX0KCX0gKTsKCglobS53b3JrZmxvdyggewoKCQkvLy0tLS0tLXdvcmtmbG93cyB0aGF0IG1vZGlmeSBtb2RlbC0tLS0tLQoKCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdHwqZWRpdFNoYWRvd0l0ZW0KCQluZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgoJCS8vJGNsaWNrOml0ZW18KmVkaXRTaGFkb3dJdGVtCgkJLy8kZWRpdFJvdzppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRlZGl0Um93Oml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKGUudHlwZSA9PSAiZWRpdFJvdyIpIHsKCQkJCS8vdGhpcyB0cmlnZ2VyIGJ5IGVkaXQgYnV0dG9uCgkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCBudWxsLCBlLnNlbGVjdGVkUm93SW5kZXgoKSApOwoJCQl9IGVsc2UgewoJCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCQl0aGlzLm1haW4oKS5lZGl0U2hhZG93SXRlbSggdGhpcy5nZXQoKSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCk7CgkJCQl9CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyIkZGVsZXRlOml0ZW1zfCpyZW1vdmVJdGVtOyIKCQkvLyIkZGVsZXRlOml0ZW1zKnF1ZXJ5UmVzdWx0fCpyZW1vdmVJdGVtOyIKCQlyZW1vdmVJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPSAicmVhZCIpIHsKCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCX0KCQkJdmFyIGluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXZhciBpdGVtcyA9IHRoaXMucmF3KCk7CgkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkvL3RoaXMgaXMgY2FzZSB3aGVuIGl0ZW1zIGlzIG1vZGVsKnF1ZXJ5UmVzdWx0CgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgkJCQl0aGlzLm1haW4oKS5yZW1vdmVJdGVtKCBpdGVtc1tpbmRleF0gKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQXQoIGluZGV4ICk7CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZVVwSXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBzZWxlY3RlZEluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXRoaXMubW92ZSggc2VsZWN0ZWRJbmRleCwgc2VsZWN0ZWRJbmRleCAtIDEgKTsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZURvd25JdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkSW5kZXggPSBlLnNlbGVjdGVkUm93SW5kZXgoKTsKCQkJdGhpcy5tb3ZlKCBzZWxlY3RlZEluZGV4LCBzZWxlY3RlZEluZGV4ICsgMSApOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vLS0tLS0td29ya2Zsb3dzIHRoYXQgbW9kaWZ5IHZpZXdzLS0tLS0tCgoJCS8vIWFmdGVyVXBkYXRlOml0ZW1zKmVkaXQubW9kZXwqcmVuZGVyTmV3VmlldzsKCQkvLyFhZnRlclVwZGF0ZTppdGVtcypxdWVyeVJlc3VsdCplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7CgkJcmVuZGVyTmV3VmlldzogbmV3VGVtcGxhdGVIYW5kbGVyKAoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSAibmV3IikgewoJCQkJCXJldHVybiBlLnB1Ymxpc2hlci5tYWluKCkuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJCX0KCQkJfQoJCQkvKnNldCBhY3Rpdml0eSBpcyBieSBkZWZhdWx0IGh0bWwqLwoKCQkpLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCXJlbmRlclVwZGF0ZVJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCQkJLy9nZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlyZXR1cm4gZS5wdWJsaXNoZXIuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJfSwKCQkJLy9zZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy9lLnByb3Bvc2VkIGlzIHRoZSBpbmRleCBvZiB0aGUgZWRpdCBpdGVtCgkJCQl0aGlzLmNoaWxkcmVuKCkuZXEoIGUucHJvcG9zZWQgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCWRlc3Ryb3lVcGRhdGVSb3dWaWV3OiBmdW5jdGlvbiggZSApIHsKCQkJZS5wdWJsaXNoZXIuY2hhbmdlKCBlLnByb3Bvc2VkICk7CgkJfSwKCgkJLy8kY2xpY2s6aXRlbXMqZWRpdC5pdGVtfCpzYXZlU2hhZG93SXRlbTsKCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdCplZGl0Lml0ZW18KnNhdmVTaGFkb3dJdGVtOwoJCXNhdmVTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpcy5zYXZlU2hhZG93SXRlbSgpOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vJGNsaWNrOml0ZW1zKmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCXJlc2V0U2hhZG93SXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSApOwoKCWJpbmRpbmdzKCB7CgoKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zfHJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0fHJvd1RlbXBsYXRlSWQKCQlzaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkgICAgICAgICAgICAiZGVsZXRlUm93Oi47IiArCgkJICAgICAgICAgICAgIiRlZGl0Um93Oi58KmVkaXRTaGFkb3dJdGVtIiwKCgkJLy8gc2hhZG93RWRpdEluUm93Oml0ZW1zfHVwZGF0ZVJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0SW5Sb3c6aXRlbXMqcXVlcnlSZXN1bHR8dXBkYXRlUm93VGVtcGxhdGVJZAoJCXNoYWRvd0VkaXRJblJvdzogInNoYWRvd0VkaXQ6LjsiICsKCQkgICAgICAgICAgICAgICAgICIhYmVnaW5JblJvd1VwZGF0ZToufCpyZW5kZXJVcGRhdGVSb3dWaWV3OyIgKwoJCSAgICAgICAgICAgICAgICAgIiFjYW5jZWxJblJvd1VwZGF0ZToufCpkZXN0cm95VXBkYXRlUm93VmlldyIsCgoJCWRlbGV0ZVJvdzogIiRkZWxldGVSb3c6LnwqY29uZmlybXxfRG8geW91IHdhbnQgdG8gZGVsZXRlIHRoaXMgaXRlbT87IiArCgkJICAgICAgICAgICAiJGRlbGV0ZVJvdzoufCpyZW1vdmVJdGVtOyIsCgkJLy9tb3ZhYmxlUm93Oml0ZW1zCgkJbW92YWJsZVJvdzogIiRtb3ZlVXA6LnwqbW92ZVVwSXRlbTsiICsKCQkgICAgICAgICAgICAiJG1vdmVEb3duOi58Km1vdmVEb3duSXRlbTsiLAoKCQkvL25ld0l0ZW1WaWV3Oml0ZW1zCgkJLy9uZXdJdGVtVmlldzppdGVtcypxdWVyeVJlc3VsdAoJCW5ld0l0ZW1WaWV3OiAiIWFmdGVyVXBkYXRlOiplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7IiArCgkJICAgICAgICAgICAgICJzaG93T25OZXc6LiIsCgoJCS8vc2hvd09uTmV3Oml0ZW1zCgkJLy9zaG93T25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQlzaG93T25OZXc6ICJzaG93OiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vaGlkZU9uTmV3Oml0ZW1zCgkJLy9oaWRlT25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQloaWRlT25OZXc6ICJoaWRlOiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vZWRpdEl0ZW1WaWV3Oml0ZW1zCgkJLy9lZGl0SXRlbVZpZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQllZGl0SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6KmVkaXQuaXRlbTsiICsKCQkgICAgICAgICAgICAgICJzaG93T25FZGl0Oi4iLAoKCQlkaXNwbGF5SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6LjtoaWRlT25FZGl0Oi4iLAoKCQkvL3Nob3dPbkVkaXQ6aXRlbXMKCQkvL3Nob3dPbkVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQKCQkvL3Nob3dPbkVkaXQ6ICJoaWRlOiplZGl0Lm1vZGV8X3JlYWQiLAoJCXNob3dPbkVkaXQ6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCArICIqZWRpdC5tb2RlIiwgImluaXQgYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBtb2RlID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQl0aGlzWyhpc1VuZGVmaW5lZCggbW9kZSApIHx8IG1vZGUgPT0gInJlYWQiKSA/ICJoaWRlIiA6ICJzaG93Il0oKTsKCQkJfSApOwoJCX0sCgoJCS8vaGlkZU9uRWRpdDppdGVtcwoJCS8vaGlkZU9uRWRpdDppdGVtcypxdWVyeVJlc3VsdAoJCS8vaGlkZU9uRWRpdDogInNob3c6KmVkaXQubW9kZXxfcmVhZCIsCgkJaGlkZU9uRWRpdDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJCWNvbnRleHQuYXBwZW5kU3ViKCBlbGVtLCBwYXRoICsgIiplZGl0Lm1vZGUiLCAiaW5pdCBhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIG1vZGUgPSBlLnB1Ymxpc2hlci5nZXQoKTsKCQkJCXRoaXNbKGlzVW5kZWZpbmVkKCBtb2RlICkgfHwgbW9kZSA9PSAicmVhZCIpID8gInNob3ciIDogImhpZGUiXSgpOwoJCQl9ICk7CgkJfSwKCgkJLy9uZXdJdGVtOml0ZW1zCgkJLy9uZXdJdGVtOml0ZW1zKnF1ZXJ5UmVzdWx0CgkJbmV3SXRlbTogIiRjbGljazoufCpuZXdTaGFkb3dJdGVtOyIgKwoJCSAgICAgICAgICJoaWRlT25OZXc6LiIsCgoJCS8vZWRpdEJ1dHRvbjppdGVtCgkJLy90aGlzIGlzIG9ubHkgdXNlZCBub24tYXJyYXkgaXRlbSBlZGl0CgkJZWRpdE9iamVjdDogIiRjbGljazoufCplZGl0U2hhZG93SXRlbTtoaWRlT25FZGl0Oi4iLAoKCQkvL3NhdmVFZGl0Oml0ZW1zKmVkaXQuaXRlbQoJCS8vc2F2ZUVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQqZWRpdC5pdGVtCgkJc2F2ZUVkaXQ6ICIkY2xpY2s6Lnwqc2F2ZVNoYWRvd0l0ZW0iLAoKCQkvL2NhbmNlbEVkaXQ6aXRlbXMqZWRpdC5pdGVtCgkJLy9jYW5jZWxFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbQoJCWNhbmNlbEVkaXQ6ICIkY2xpY2s6LnwqcmVzZXRTaGFkb3dJdGVtIgoKCX0gKTsKCglobS5uZXdKcUV2ZW50KCB7CgoJCWVkaXRSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJlZGl0Um93IiApOwoJCX1dLAoKCQlkZWxldGVSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJkZWxldGVSb3ciICk7CgoJCX1dLAoKCQltb3ZlVXA6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJtb3ZlVXAiICk7CgkJfV0sCgoJCW1vdmVEb3duOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiAkKCBlLnRhcmdldCApLmhhc0NsYXNzKCAibW92ZURvd24iICk7CgkJfV0KCX0gKTsKCi8vCgoKICAgIGRlZmF1bHRPcHRpb25zLmhhc2hQcmVmaXggPSAiISI7CiAgICBkZWZhdWx0T3B0aW9ucy5yb3V0ZVByZWZpeCA9ICIvIjsKCiAgICB2YXIgbGlzdE9mUm91dGVTZWdtZW50cyA9IFtdLAoKICAgICAgICBkZWZhdWx0Um91dGVTZWdtZW50cywKCiAgICAgICAgaW5pdGlhbFJvdXRlTWF0Y2hlZEJ5UGF0dGVybnMsCgogICAgICAgIHJQbHVzID0gL1wrL2csCgogICAgICAgIHJMZWZ0U3F1YXJlQnJhY2tldCA9IC9cWy8sCgogICAgICAgIHJSaWdodFNxdWFyZUJyYWNrZXQgPSAvXF0kLywKCiAgICAgICAgclJpZ2h0U3F1YXJlQnJhY2tldEVuZCA9IC9cXSQvLAoKICAgICAgICByU2VnbWVudFN0cmluZyA9IC9eKFteP10qKShcPy4qKT8kLywKCiAgICAgICAgclF1ZXJ5U3RyaW5nID0gL15bXj9dKlw/KC4qKSQvLAoKICAgICAgICByU3RhcnRIYXNoLAogICAgLy90aGUgcGF0aCBvZiBtb2RlbCB3aGljaCBpcyB0cmFja2VkIGluIHF1ZXJ5IHN0cmluZwogICAgICAgIHBhcmFtUGF0aHMgPSBbXTsKCiAgICAvL2NvbnZlcnQgYSBwYXJhbSBzdHJpbmcgaW50byBhbiBvYmplY3QKICAgIGZ1bmN0aW9uIGRlcGFyYW0ocGFyYW1TdHJpbmcsIGNvZXJjZSkgewoKICAgICAgICB2YXIgb2JqID0ge30sCiAgICAgICAgICAgIGNvZXJjZV90eXBlcyA9IHsgJ3RydWUnOiB0cnVlLCAnZmFsc2UnOiB0cnVlLCAnbnVsbCc6IG51bGwgfTsKCiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGFsbCBuYW1lPXZhbHVlIHBhaXJzLgogICAgICAgICQuZWFjaChwYXJhbVN0cmluZy5yZXBsYWNlKHJQbHVzLCAnICcpLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhcmFtID0gdmFsdWUuc3BsaXQoJz0nKSwKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVswXSksCiAgICAgICAgICAgICAgICB2YWwsCiAgICAgICAgICAgICAgICBjdXIgPSBvYmosCiAgICAgICAgICAgICAgICBpID0gMCwKCiAgICAgICAgICAgIC8vIElmIGtleSBpcyBtb3JlIGNvbXBsZXggdGhhbiAnZm9vJywgbGlrZSAnYVtdJyBvciAnYVtiXVtjXScsIHNwbGl0IGl0CiAgICAgICAgICAgIC8vIGludG8gaXRzIGNvbXBvbmVudCBwYXJ0cy4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXkuc3BsaXQoJ11bJyksCiAgICAgICAgICAgICAgICBrZXlzX2xhc3QgPSBrZXlzLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAvLyBJZiB0aGUgZmlyc3Qga2V5cyBwYXJ0IGNvbnRhaW5zIFsgYW5kIHRoZSBsYXN0IGVuZHMgd2l0aCBdLCB0aGVuIFtdCiAgICAgICAgICAgIC8vIGFyZSBjb3JyZWN0bHkgYmFsYW5jZWQuCiAgICAgICAgICAgIGlmIChyTGVmdFNxdWFyZUJyYWNrZXQudGVzdChrZXlzWzBdKSAmJiByUmlnaHRTcXVhcmVCcmFja2V0LnRlc3Qoa2V5c1sga2V5c19sYXN0IF0pKSB7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSB0cmFpbGluZyBdIGZyb20gdGhlIGxhc3Qga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAga2V5c1sga2V5c19sYXN0IF0gPSBrZXlzWyBrZXlzX2xhc3QgXS5yZXBsYWNlKHJSaWdodFNxdWFyZUJyYWNrZXRFbmQsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBTcGxpdCBmaXJzdCBrZXlzIHBhcnQgaW50byB0d28gcGFydHMgb24gdGhlIFsgYW5kIGFkZCB0aGVtIGJhY2sgb250bwogICAgICAgICAgICAgICAgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUga2V5cyBhcnJheS4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNoaWZ0KCkuc3BsaXQoJ1snKS5jb25jYXQoa2V5cyk7CgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0ga2V5cy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFzaWMgJ2Zvbycgc3R5bGUga2V5LgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBhIG5hbWU9dmFsdWUgcGFpciwgb3IganVzdCBhIG5hbWU/CiAgICAgICAgICAgIGlmIChwYXJhbS5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgICAgIHZhbCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVsxXSk7CgogICAgICAgICAgICAgICAgLy8gQ29lcmNlIHZhbHVlcy4KICAgICAgICAgICAgICAgIGlmIChjb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWwgJiYgIWlzTmFOKHZhbCkgPyArdmFsICAgICAgICAgICAgICAvLyBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWwgPT09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkICAgICAgICAgLy8gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29lcmNlX3R5cGVzW3ZhbF0gIT09IHVuZGVmaW5lZCA/IGNvZXJjZV90eXBlc1t2YWxdIC8vIHRydWUsIGZhbHNlLCBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChrZXlzX2xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb21wbGV4IGtleSwgYnVpbGQgZGVlcCBvYmplY3Qgc3RydWN0dXJlIGJhc2VkIG9uIGEgZmV3IHJ1bGVzOgogICAgICAgICAgICAgICAgICAgIC8vICogVGhlICdjdXInIHBvaW50ZXIgc3RhcnRzIGF0IHRoZSBvYmplY3QgdG9wLWxldmVsLgogICAgICAgICAgICAgICAgICAgIC8vICogW10gPSBhcnJheSBwdXNoIChuIGlzIHNldCB0byBhcnJheSBsZW5ndGgpLCBbbl0gPSBhcnJheSBpZiBuIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gICBudW1lcmljLCBvdGhlcndpc2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgIC8vICogSWYgYXQgdGhlIGxhc3Qga2V5cyBwYXJ0LCBzZXQgdGhlIHZhbHVlLgogICAgICAgICAgICAgICAgICAgIC8vICogRm9yIGVhY2gga2V5cyBwYXJ0LCBpZiB0aGUgY3VycmVudCBsZXZlbCBpcyB1bmRlZmluZWQgY3JlYXRlIGFuCiAgICAgICAgICAgICAgICAgICAgLy8gICBvYmplY3Qgb3IgYXJyYXkgYmFzZWQgb24gdGhlIHR5cGUgb2YgdGhlIG5leHQga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAgICAgIC8vICogTW92ZSB0aGUgJ2N1cicgcG9pbnRlciB0byB0aGUgbmV4dCBsZXZlbC4KICAgICAgICAgICAgICAgICAgICAvLyAqIFJpbnNlICYgcmVwZWF0LgogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDw9IGtleXNfbGFzdDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGtleXNbaV0gPT09ICcnID8gY3VyLmxlbmd0aCA6IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1cltrZXldID0gaSA8IGtleXNfbGFzdCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJba2V5XSB8fCAoIGtleXNbaSArIDFdICYmIGlzTmFOKGtleXNbaSArIDFdKSA/IHt9IDogW10gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGtleSwgZXZlbiBzaW1wbGVyIHJ1bGVzLCBzaW5jZSBvbmx5IHNjYWxhcnMgYW5kIHNoYWxsb3cKICAgICAgICAgICAgICAgICAgICAvLyBhcnJheXMgYXJlIGFsbG93ZWQuCgogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYWxyZWFkeSBhbiBhcnJheSwgc28gcHVzaCBvbiB0aGUgbmV4dCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9ialtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsIGlzbid0IGFuIGFycmF5LCBidXQgc2luY2UgYSBzZWNvbmQgdmFsdWUgaGFzIGJlZW4gc3BlY2lmaWVkLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHZhbCBpbnRvIGFuIGFycmF5LgogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFsgb2JqW2tleV0sIHZhbCBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAvLyBObyB2YWx1ZSB3YXMgZGVmaW5lZCwgc28gc2V0IHNvbWV0aGluZyBtZWFuaW5nZnVsLgogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBjb2VyY2UgPyB1bmRlZmluZWQgOiAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAgclN0YXJ0SGFzaCA9IHJTdGFydEhhc2ggfHwgbmV3IFJlZ0V4cCgiXiMiICsgZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4KTsKICAgICAgICByZXR1cm4gbG9jYXRpb24uaGFzaC5yZXBsYWNlKHJTdGFydEhhc2gsICIiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50UGF0aCgpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByU2VnbWVudFN0cmluZy5leGVjKGhhc2gpOwogICAgICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRRdWVyeVN0cmluZygpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByUXVlcnlTdHJpbmcuZXhlYyhoYXNoKTsKICAgICAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICB9CgogICAgLy9nZXQgc3RhdGUgZnJvbSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVF1ZXJ5U3RyaW5nKCkgewogICAgICAgIHJldHVybiBkZXBhcmFtKGdldFF1ZXJ5U3RyaW5nKCkpOwogICAgfQoKICAgIC8vaGFuZGxlciBmb3IgbW9kZWwgY2hhbmdlCiAgICAvL3RoaXMgbW9kZWwgaXMgdHJhY2tlZCBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAvL3doZW4gbW9kZWwgY2hhbmdlIHdlIHdhbnQgdG8gdXBkYXRlIHRoZSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIHVwZGF0ZVF1ZXJ5U3RyaW5nT25Nb2RlbENoYW5nZShlKSB7CgogICAgICAgIHZhciBxdWVyaWVkUGF0aCA9IHRvTG9naWNhbFBhdGgoZS5wdWJsaXNoZXIucGF0aCksCiAgICAgICAgICAgIG1vZGVsID0ge307CgogICAgICAgIG1vZGVsW3F1ZXJpZWRQYXRoXSA9IHJvb3ROb2RlLmdldChxdWVyaWVkUGF0aCk7CgogICAgICAgIC8vYnVpbGQgdGhlIGhhc2ggc3RyaW5nCiAgICAgICAgLy8xLmNhbGwgZ2V0U3RhZ2VGcm9tUXVlcnlTdHJpbmcKICAgICAgICAvLzIubWVyZ2UgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyB3aXRoIHRoZSBzdGF0ZQogICAgICAgIC8vMy5jb252ZXJ0IHRoZSBtZXJnZWQgb2JqZWN0IGludG8gcXVlcnkgc3RyaW5nCiAgICAgICAgLy80LiByZXBsYWNlIGhhc2gncyBxdWVyeSBzdHJpbmcgd2l0aCB0aGUgbmV3IHF1ZXJ5IHN0cmluZwogICAgICAgIHZhciBxdWVyeVN0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICAgICAgdmFyIGV4aXN0aW5nU3RhdGUgPSBkZXBhcmFtKHF1ZXJ5U3RyaW5nKTsKICAgICAgICB2YXIgbmV3U3RhdGUgPSAkLmV4dGVuZCh7fSwgZXhpc3RpbmdTdGF0ZSwgbW9kZWwpOwogICAgICAgIHZhciBuZXdIYXNoID0gZ2V0Q3VycmVudFBhdGgoKSArICI/IiArICQucGFyYW0obmV3U3RhdGUpOwoKICAgICAgICBsb2NhdGlvbi5oYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgbmV3SGFzaDsKCiAgICB9CgogICAgLy93aGVuIG1vZGVsIGNoYW5nZSB0cnkgdG8gdXBkYXRlIHRoZSByb3V0ZSBieQogICAgLy9lbnVtZXJhdGluZyB0aGUgdGhlIGxpc3Qgb2Ygc2VnbWVudCBwYXR0ZXJucyBhcnJheQogICAgLy9pZiBvbmUgc2VnbWVudCBwYXR0ZXJucyBhcnJheSBtYXRjaCB0aGUgY3VycmVudCByb3V0ZSwgdGhlbgogICAgLy9lbnVtZXJhdGUgdGhlIHNlZ21lbnQgcGF0dGVybnMgYXJyYXkgdG8gZmluZCBvdXQgaWYKICAgIC8vYSBwYXR0ZXJuJ3MgbW9kZWwgcGF0aCBpcyBlcXVhbCB0byB0aGUgcGF0aCBvZiB0aGUgY2hhbmdlZCBtb2RlbAogICAgLy90aGVuIHVwZGF0ZSB0aGUgcGF0aCB3aXRoIHRoZSB1cGRhdGVkIG1vZGVsJ3MgdmFsdWUKICAgIGZ1bmN0aW9uIHVwZGF0ZVBhdGhPbk1vZGVsQ2hhbmdlKGUpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzLAogICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICBxdWVyeVN0cmluZywKICAgICAgICAgICAgbW9kZWxQYXRoT2ZQdWJsaXNoZXIgPSBlLnB1Ymxpc2hlci5wYXRoLAogICAgICAgICAgICByb3V0ZVNlZ21lbnRzID0gZS5oYW5kbGVyLm9wdGlvbnMsCiAgICAgICAgICAgIHBhdGggPSBnZXRDdXJyZW50UGF0aCgpOwoKICAgICAgICBpZiAoaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKSkgewoKICAgICAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKCiAgICAgICAgICAgICAgICByb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnRzW2pdOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudC5zdWJzdHIoMSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9PSBtb2RlbFBhdGhPZlB1Ymxpc2hlcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aFNlZ21lbnRzW2pdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aE9mUHVibGlzaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0aCA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gZ2V0UXVlcnlTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyggcXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBkZWZhdWx0T3B0aW9ucy5oYXNoUHJlZml4ICsgZGVmYXVsdE9wdGlvbnMucm91dGVQcmVmaXggKyAocXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1BhdGhNYXRjaGVkQnlSb3V0ZVNlZ21lbnRzKHBhdGgsIHJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzOwoKICAgICAgICBpZiAoIXBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBpZiAocGF0aFNlZ21lbnRzLmxlbmd0aCAhPT0gcm91dGVTZWdtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNYXRjaGVkID0gdHJ1ZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICAvL2lmIHJvdXRlU2VnbWVudCBpcyBtb2RlbCBwYXRoCiAgICAgICAgICAgIC8vZG9uJ3QgbmVlZCB0byBtYXRjaAogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQgIT0gcGF0aFNlZ21lbnRzW2ldKSB7CiAgICAgICAgICAgICAgICBpc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNNYXRjaGVkOwogICAgfQoKICAgIC8vY2hlY2sgaWYgY3VycmVudCBzZWdtZW50IHN0cmluZyBpcyBtYXRjaGVkIHdpdGggc2VnbWVudCBwYXR0ZXJucywgYW5kIHJldHVybiBtYXRjaGVkIHN0YXR1cwogICAgLy9pZiBtYXRjaGVkIGFsc28gdXBkYXRlIHRoZSBtb2RlbCB2YWx1ZSB3aXRoIHRoZSBzZWdtZW50IHZhbHVlCiAgICAvL2lmIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCBpbiByZWdpc3RyYXRpb24gcHJvY2VzcywgYWxzbyByZWdpc3RyYXRpb24gaGFuZGxlciB0byBzdWJzY3JpYmUKICAgIC8vdGhlIGNoYW5nZSBvZiBtb2RlbCwgd2hlbiBtb2RlbCBjaGFuZ2UgdXBkYXRlIHRoZSBzZWdtZW50IHN0cmluZwogICAgZnVuY3Rpb24gcHJvY2Vzc1BhdGhXaXRoUm91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzLCBpc1JlZ2lzdHJhdGlvbikgewoKICAgICAgICB2YXIgcm91dGVTZWdtZW50LAogICAgICAgICAgICBwYXRoU2VnbWVudHMsCiAgICAgICAgICAgIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LAogICAgICAgICAgICBpc1BhdGhNYXRjaGVkID0gaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKTsKCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgbW9kZWxQYXRoSW5Sb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnQuc3Vic3RyKDEpOwoKICAgICAgICAgICAgICAgIGlmIChpc1BhdGhNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCBwYXRoU2VnbWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc1JlZ2lzdHJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGhtLnN1YihudWxsLyogbnVsbCBzdWJzY3JpYmVyKi8sIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVQYXRoT25Nb2RlbENoYW5nZSwgcm91dGVTZWdtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1BhdGhNYXRjaGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgdmFyIGlzRW1wdHlRdWVyeSA9ICQuaXNFbXB0eU9iamVjdChzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgICAgIGlmICghc2VnbWVudFN0cmluZyAmJiBpc0VtcHR5UXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRIYXNoID0gbG9jYXRpb24uaGFzaCwKICAgICAgICAgICAgdXJsUGF0aCA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZShjdXJyZW50SGFzaCwgIiIpLAogICAgICAgICAgICBuZXdIYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgc2VnbWVudFN0cmluZyArIChpc0VtcHR5UXVlcnkgPyAiIiA6ICI/IiArICQucGFyYW0oc3RhdGVJblF1ZXJ5U3RyaW5nKSksCiAgICAgICAgICAgIG5ld1VybCA9IHVybFBhdGggKyAiIyIgKyBuZXdIYXNoOwoKICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHsKICAgICAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgbnVsbCwgbmV3VXJsKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IG5ld1VybDsKCiAgICAgICAgfQogICAgfQoKICAgIC8vcmVnaXN0ZXIgdGhlIG1vZGVsIHBhdGggd2hpY2ggd2lsbCBiZSB0cmFja2VkIHRocm91Z2ggdGhlIHF1ZXJ5IHN0cmluZwogICAgLy9yb3V0ZVBhcmFtcyBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIG1vZGVsIGluaXRpYWxpemF0aW9uCiAgICAvL2J1dCBiZWZvcmUgc3Vic2NyaXB0aW9uIHJlZ2lzdHJhdGlvbiwKICAgIC8vIHNvIHRoYXQgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyBjYW4gYmUgcmVzdG9yZWQKICAgIGhtLnJvdXRlUGFyYW1zID0gZnVuY3Rpb24gKC8qIHBhdGgxLCBwYXRoMiwgLi4gKi8pIHsKCiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG1vZGVsUGF0aCwKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgdGhlIG1vZGVsIGlmIG1vZGVsIHBhdGggaXMgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIG1vZGVsUGF0aCA9IGFyZ3NbaV07CgogICAgICAgICAgICAvL2lmIG1vZGVsUGF0aCBpcyBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgICAgIC8vdXBkYXRlIHRoZSBtb2RlbCB3aXRoIHRoZSB2YWx1ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICAgICAgaWYgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgICAgICAgICByb290Tm9kZS5zZXQobW9kZWxQYXRoLCBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdXBkYXRlIHF1ZXJ5IHN0cmluZyB3aGVuIG1vZGVsIGNoYW5nZQogICAgICAgICAgICBobS5zdWIobnVsbCwgbW9kZWxQYXRoLCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVRdWVyeVN0cmluZ09uTW9kZWxDaGFuZ2UpOwogICAgICAgICAgICBwYXJhbVBhdGhzLnB1c2goYXJnc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgaG1Gbi5yb3V0ZVBhcmFtcyA9IGZ1bmN0aW9uIChzdWJQYXRoKSB7CgogICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgogICAgICAgIGhtLnJvdXRlUGFyYW1zLmFwcGx5KAoKICAgICAgICAgICAgaG0sCgogICAgICAgICAgICAkLm1hcChzdWJQYXRoID8gYXJndW1lbnRzIDogWyIiXSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzdWJQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLmdldFBhdGgoc3ViUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICApOwoKICAgICAgICByZXR1cm4gbW9kZWw7CgogICAgfTsKCiAgICAvL3JlZ2lzdGVyIHRoZSBzZWdtZW50IHBhdHRlcm5zIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBtYXRjaCBhIHBhdGgKICAgIC8vYSBwYXRoIGlzIGNvbnNpc3RzIG9mIG11bHRpcGxlIHNlZ21lbnQKICAgIC8vIEEgcGF0aCBsaWtlICIvcHVibGljL2NvbmZpZy9wZXJzb25hbCIsIGNvbnNpc3Qgb2Ygc2VnbWVudHMgWyJwdWJsaWMiLCAiY29uZmlnIiwgInBlcnNvbmFsIl0KICAgIC8vdGhpcyBtZXRob2QgdHJ5IHRvIHVzZSBhIG1hdGNoZXIgdG8gdGVzdCBlYWNoIHNlZ21lbnRzCiAgICAvL2htLnJvdXRlKHNlZ21lbnRNYXRjaGVyMSwgc2VnbWVudE1hdGNoZXIyLCAuLi4pCiAgICAvL2VhY2ggc2VnbWVudCBtYXRjaGVyIGlzIGxpa2UgW3BhdGgsIG1hdGNoZXJdCiAgICAvL3NvIGl0IGlzIGxpa2UKICAgIC8vaG0ucm91dGUoW3BhdGgxLCBtYXRjaGVyMV0sIFtwYXRoMiwgbWF0Y2hlcjJdLCAuLi4pOwogICAgLy9leGFtcGxlIG9mIHNlZ21lbnQgcGF0dGVybiBhcmUgYXMgZm9sbG93aW5nCiAgICAvL3N0cmluZyBlZzogICJwdWJsaWMiLCB3aGljaCBpcyBhIGZpeGVkIHZhbHVlLCB3aGljaCBkb2VzIG5vdCBtYXBwZWQgdG8gYSBtb2RlbAogICAgLy90aGUgZm9sbG93aW5nIG1hcHBlZCB0byBhIG1vZGVsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCBudWxsXSBvciBbICJtb2RlbFBhdGgiXSwgY29uc3RyYWludCBpcyBudWxsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCAiZml4ZWRWYWx1ZSIgXSwgY29uc3RyYWludCBpcyAiZml4ZWRWYWx1ZSIKICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIC9yZWdleC8gXSwgY29uc3RyYWludCBpcyByZWd1bGFyIGV4cHJlc3Npb24KICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIGZ1bmN0aW9uIChzZWdtZW50KSB7IHJldHVybiBib29sZWFuOyB9IF0sIGNvbnN0cmFpbnQgaXMgYSBmdW5jdGlvbgogICAgaG0ucm91dGVQYXRoID0gZnVuY3Rpb24gKHJvdXRlLCBpc0RlZmF1bHQpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudHMgPSByb3V0ZS5zcGxpdCgiLyIpOwoKICAgICAgICBsaXN0T2ZSb3V0ZVNlZ21lbnRzLnB1c2gocm91dGVTZWdtZW50cyk7CgogICAgICAgIGlmIChpc0RlZmF1bHQpIHsKICAgICAgICAgICAgZGVmYXVsdFJvdXRlU2VnbWVudHMgPSByb3V0ZVNlZ21lbnRzOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFBhdGgoKTsKCiAgICAgICAgaWYgKHByb2Nlc3NQYXRoV2l0aFJvdXRlU2VnbWVudHMoY3VycmVudFBhdGgsIHJvdXRlU2VnbWVudHMsIHRydWUpKSB7CiAgICAgICAgICAgIGluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIGhtLnVwZGF0ZVJvdXRlID0gZnVuY3Rpb24gLyp1cGRhdGVNb2RlbFdoZW5IYXNoQ2hhbmdlZCovKCkgewoKCiAgICAgICAgLy91cGRhdGUgbW9kZWwgd2hlbiBzZWdtZW50IHN0cmluZyBjaGFuZ2UKICAgICAgICB2YXIgaSwgbW9kZWxQYXRoLAogICAgICAgICAgICBzZWdtZW50U3RyaW5nID0gZ2V0Q3VycmVudFBhdGgoKSwKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgaWYgKHNlZ21lbnRTdHJpbmcpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RPZlJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzUGF0aFdpdGhSb3V0ZVNlZ21lbnRzKHNlZ21lbnRTdHJpbmcsIGxpc3RPZlJvdXRlU2VnbWVudHNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy9zaG9ydGN1dCB3aGVuIHRoZSBmaXJzdCBzZWdtZW50IHBhdHRlcm5zIG1hdGNoCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vaWYgc2VnbWVudFN0cmluZyBpcyBlbXB0eSBhbmQgaXQgaGFzIGRlZmF1bHRTZWdtZW50UGF0dGVybgogICAgICAgICAgICAvL3RyeSB0byBidWlsZCBhIHNlZ21lbnQgc3RyaW5nIGZyb20gdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJucwogICAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVmYXVsdFJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VnbWVudFBhdHRlcm4gPSBkZWZhdWx0Um91dGVTZWdtZW50c1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VnbWVudFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChzZWdtZW50UGF0dGVybik7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSByb290Tm9kZS5nZXQoc2VnbWVudFBhdHRlcm5bMF0pICsgIiI7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChtb2RlbFZhbHVlIHx8IHNlZ21lbnRQYXR0ZXJuLmRlZmF1bHRWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlZ21lbnRTdHJpbmcgPSBzZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIHF1ZXJ5IHN0cmluZyBjaGFuZ2UKICAgICAgICBmb3IgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgaWYgKHBhcmFtUGF0aHMuY29udGFpbnMobW9kZWxQYXRoKSkgewogICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aCwgc3RhdGVJblF1ZXJ5U3RyaW5nW21vZGVsUGF0aF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBzdGF0ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFyYW1QYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtb2RlbFBhdGggPSBwYXJhbVBhdGhzW2ldOwogICAgICAgICAgICBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSA9IHJvb3ROb2RlLmdldChtb2RlbFBhdGgpOwogICAgICAgIH0KICAgICAgICAvLwogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgfTsKCiAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIGhhc2ggY2hhbmdlCiAgICAkKHdpbmRvdykuYmluZCgiaGFzaGNoYW5nZSIsIGhtLnVwZGF0ZVJvdXRlKTsKCiAgICAkKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy90cnkgdG8gYnVpbGQgdGhlIGluaXRpYWwgaGFzaCBmcm9tIHRoZSBtb2RlbAoKICAgICAgICB2YXIgaSwgcm91dGUgPSAiIjsKCiAgICAgICAgLy9pZiB0aGVyZSBpcyBkZWZhdWx0IHNlZ21lbnQgcGF0dGVybiBhbmQgdGhlIGluaXRpYWwgc2VnbWVudCBzdHJpbmcKICAgICAgICAvL2lzIG5vdCBtYXRjaGVkIGJ5IGFueSBwYXR0ZXJucywgdGhlbiB1c2UgdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJuCiAgICAgICAgLy90byBidWlsZCB0aGUgc2VnbWVudCBzdHJpbmcKICAgICAgICBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMgJiYgIWluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zKSB7CgogICAgICAgICAgICB2YXIgcGF0aFNlZ21lbnRzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWZhdWx0Um91dGVTZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHJvdXRlU2VnbWVudCA9IGRlZmF1bHRSb3V0ZVNlZ21lbnRzW2ldOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHBhdGhTZWdtZW50cy5wdXNoKHJvb3ROb2RlLmdldChyb3V0ZVNlZ21lbnQuc3Vic3RyKDEpKSArICIiKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBwYXRoU2VnbWVudHMucHVzaChyb3V0ZVNlZ21lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByb3V0ZSA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICByb3V0ZSA9IGdldEN1cnJlbnRQYXRoKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgc3RhdGUgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtUGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG1vZGVsUGF0aCA9IHBhcmFtUGF0aHNbaV07CiAgICAgICAgICAgIHN0YXRlSW5RdWVyeVN0cmluZ1ttb2RlbFBhdGhdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShyb3V0ZSwgc3RhdGVJblF1ZXJ5U3RyaW5nKTsKICAgIH0pOwoKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+Ci8vCgoKCglkZWZhdWx0T3B0aW9ucy5zZWxlY3RlZENsYXNzID0gInNlbGVjdGVkIjsKCWRlZmF1bHRPcHRpb25zLnRhYlZpZXdBdHRyID0gInRhYi12aWV3IjsKCWRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyID0gInRhYi1saW5rIjsKCWRlZmF1bHRPcHRpb25zLnRhYkNvbnRhaW5lck5hbWVBdHRyID0gInRhYi1jb250YWluZXItbmFtZSI7CgoJaG0ud29ya2Zsb3coIHsKCgkJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkJc2VsZWN0VGFiOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHRhYklkID0gdGhpcy5hdHRyKCBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciApIHx8IHRoaXMuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKSwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBlLmhhbmRsZXIub3B0aW9uczsKCgkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSB0YWJJZCkgewoJCQkJdGhpcy5hZGRDbGFzcyggc2VsZWN0ZWRDbGFzcyApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5yZW1vdmVDbGFzcyggc2VsZWN0ZWRDbGFzcyApOwoJCQl9CgkJfSwKCgkJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkJc2VsZWN0VGFiSW5Db250YWluZXI6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgc2VsZWN0ZWRUYWJJZCA9IGUucHVibGlzaGVyLmdldCgpLAoJCQkJdGFiVmlld0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciwKCQkJCXRhYkxpbmtBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIsCgkJCQlvcHRpb25zID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCQl0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yID0gb3B0aW9ucy5zZWxlY3RvciwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBvcHRpb25zLnNlbGVjdGVkQ2xhc3M7CgoJCQl0aGlzLmZpbmQoIHRhYkxpbmtBbmRUYWJWaWV3U2VsZWN0b3IgKS5hbmRTZWxmKCkuZWFjaCggZnVuY3Rpb24oIGluZGV4LCBlbGVtICkgewoJCQkJdmFyICRlbGVtID0gJCggZWxlbSApLAoJCQkJCXRhYklkID0gJGVsZW0uYXR0ciggdGFiVmlld0F0dHIgKSB8fCAkZWxlbS5hdHRyKCB0YWJMaW5rQXR0ciApOwoKCQkJCWlmICh0YWJJZCA9PSBzZWxlY3RlZFRhYklkKSB7CgkJCQkJJGVsZW0uYWRkQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJCX0gZWxzZSB7CgkJCQkJJGVsZW0ucmVtb3ZlQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCglmdW5jdGlvbiBoYW5kbGVUYWJMaW5rQ2xpY2soIGUgKSB7CgkJLy90aGlzIGlzIHRoZSBzdWJzY3JpYmVyLCB3aGljaCBpcyB0aGUgbW9kZWwKCQkvL2UuaGFuZGxlci5vcHRpb25zIGlzIHRoZSB0YWIgaWQKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuYXR0ciggZS5oYW5kbGVyLm9wdGlvbnMgKSApOwoJCWUucHJldmVudERlZmF1bHQoKTsKCQllLnN0b3BQcm9wYWdhdGlvbigpOwoKCX0KCgkvL2EgdGFiIGNhbiBiZSB0YWJWaWV3IG9yIHRhYkxpbmsKCS8vZm9yIHRhYkxpbmsgdXNlIDxsaSB0YWItbGluaz0ibmV3cyIgdGFiPSJjYXRlZ29yeSI+TmV3czwvbGk+CgkvL2lmIHlvdXIgc2VsZWN0ZWQgY2xhc3MgaXMgbm90ICJzZWxlY3RlZCIgYnV0ICJhY3RpdmUiIHVzZQoJLy8gPGxpIHRhYi1saW5rPSJuZXdzIiB0YWI9ImNhdGVnb3J5fGFjdGl2ZSI+TmV3czwvbGk+CgkvLwoJLy9mb3IgdGFiVmlldyB1c2UgPGRpdiB0YWItdmlldz0ibmV3cyIgdGFiPSJjYXRlZ29yeSI+Y29udGVudHM8L2Rpdj4KCS8vb3IgPGRpdiB0YWItdmlldz0ibmV3cyIgdGFiPSJjYXRlZ29yeXxhY3RpdmUiPmNvbnRlbnRzPC9kaXY+CgliaW5kaW5ncyggewoKCQl0YWI6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBzZWxlY3RlZENsYXNzICkgewoKCQkJc2VsZWN0ZWRDbGFzcyA9IHNlbGVjdGVkQ2xhc3MgfHwgZGVmYXVsdE9wdGlvbnMuc2VsZWN0ZWRDbGFzczsKCgkJCWJpbmRpbmcuYXBwZW5kU3ViKCBlbGVtLCBwYXRoLCAiaW5pdCBhZnRlclVwZGF0ZSIsICIqc2VsZWN0VGFiIiwgc2VsZWN0ZWRDbGFzcyApOwoKCQkJaWYgKCQoIGVsZW0gKS5hdHRyKCBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciApKSB7CgkJCQliaW5kaW5nLmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgImNsaWNrIiwgaGFuZGxlVGFiTGlua0NsaWNrLCBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciApOwoJCQl9CgoJCX0sCgoJCS8vYSB0YWJDb250YWluZXIgY2FuIGhvbGQgdGFiTGluayBvciB0YWJWaWV3CgkJLy9pdCBjYW4gYmUKCQkvLwoJCS8vPHVsIHRhYi1jb250YWluZXI9ImNhdGVnb3J5Ij4KCQkvLwk8bGkgdGFiLWxpbms9Im5ld3MiPk5ld3M8L2xpPgoJCS8vCTxsaSB0YWItbGluaz0ib3BpbmlvbiI+T3BpbmlvbjwvbGk+CgkJLy8JPGxpIHRhYi1saW5rPSJzcG9ydHMiPlNwb3J0czwvbGk+CgkJLy88L3VsPgoJCS8vCgkJLy88ZGl2IGNsYXNzPSJ0YWJzIiB0YWItY29udGFpbmVyPSJjYXRlZ29yeSI+CgkJLy8JPGRpdiB0YWItdmlldz0ibmV3cyI+Y29udGVudDwvZGl2PgoJCS8vCTxkaXYgdGFiLXZpZXc9Im9waW5pb24iPmNvbnRlbnQ8L2Rpdj4KCQkvLzwvZGl2PgoJCS8vb3B0aW9ucyB1c2FnZQoJCS8vdGFiLWNvbnRhaW5lcj0iY2F0ZWdvcnl8Y29udGFpbmVyTmFtZSxzZWxlY3RlZENsYXNzIgoJCS8vaWYgeW91IGhhdmUgdGFiIGNvbnRhaW5lciBuZXN0ZWQgd2l0aGluIGFub3RoZXIgdGFiIGNvbnRhaW5lcgoJCS8veW91IGNhbiB1c2UgY29udGFpbmVyIG5hbWUgdG8gc3BlY2lmeSB3aGljaCBjb250YWluZXIgaXQgaXMgaW4KCQl0YWJDb250YWluZXI6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgkJCW9wdGlvbnMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKTsKCgkJCXZhciB0YWJWaWV3QXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYlZpZXdBdHRyLAoJCQkJdGFiTGlua0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciwKCQkJCXRhYkNvbnRhaW5lck5hbWVBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiQ29udGFpbmVyTmFtZUF0dHIsCgkJCQljb250YWluZXJOYW1lID0gb3B0aW9uc1swXSwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBvcHRpb25zWzFdLAoKCQkJCXRhYkNvbnRhaW5lclNlbGVjdG9yID0gY29udGFpbmVyTmFtZSA/CgkJCQkJIlsiICsgdGFiQ29udGFpbmVyTmFtZUF0dHIgKyAiPSciICsgY29udGFpbmVyTmFtZSArICInXSIgLy93aXRoIGV4cGxpY2l0IHRhYiBjb250YWluZXIgbmFtZQoJCQkJCTogIiIsIC8vbm8gdGFiIGNvbnRhaW5lciBuYW1lCgoJCQkJdGFiTGlua1NlbGVjdG9yID0gIlsiICsgdGFiTGlua0F0dHIgKyAiXSIgKyB0YWJDb250YWluZXJTZWxlY3RvciwKCgkJCQl0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yID0gdGFiTGlua1NlbGVjdG9yICsgIixbIiArIHRhYlZpZXdBdHRyICsgIl0iICsgdGFiQ29udGFpbmVyU2VsZWN0b3I7CgoJCQkvL3VwZGF0ZSB0aGUgdGFiIG1vZGVsIHdpdGggdGhlIHRhYkxpbmsgd2hlbiBjbGljawoJCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgImNsaWNrIiwgaGFuZGxlVGFiTGlua0NsaWNrLCB0YWJMaW5rQXR0ciwgdGFiTGlua1NlbGVjdG9yIC8qZGVsZWdhdGVTZWxlY3RvciovICk7CgoJCQkvLwoJCQkvL2hpZ2hsaWdodCB0aGUgdGFiIHdoZW4gdGhlIG1vZGVsIGNoYW5nZQoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCwgImluaXQxMDAgYWZ0ZXJVcGRhdGUiLCAiKnNlbGVjdFRhYkluQ29udGFpbmVyIiwgewoJCQkJc2VsZWN0b3I6IHRhYkxpbmtBbmRUYWJWaWV3U2VsZWN0b3IsCgkJCQlzZWxlY3RlZENsYXNzOiBzZWxlY3RlZENsYXNzIHx8IGRlZmF1bHRPcHRpb25zLnNlbGVjdGVkQ2xhc3MKCQkJfSApOwoJCX0KCX0gKTsKCi8vZGF0YS1zdWI9IkBhcHA6YXBwTmFtZSxvcHRpb25zIgoKCgl2YXIgckRvdCA9IC9cLi9nLAoJCWFwcFN0b3JlID0ge30sCgkvL3VzZWQgdG8gbWF0Y2ggImFwcE5hbWUsb3B0aW9ucyIKCQlyQXBwT3B0aW9ucyA9IC9eKFteLF0rKSgsKC4rKSk/JC8sCgkJckxvYWRBcHBPcHRpb25zID0gL14oW14sXSspKCwoW14sXSspKT8oLCguKykpPyQvOwoKCS8veW91IGFwcCBzaG91bGQgaW1wbGVtZW50IGxvYWQoZWxlbSwgb3B0aW9ucykgYW5kIHVubG9hZChlbGVtKSBtZXRob2QKCglobS5BcHAgPSBobS5DbGFzcy5leHRlbmQoCgoJCS8vaW5zdGFuY2UgbWVtYmVycwoJCXsKCQkJLy9leGlzdHMgc2ltcGx5IGZvciBlbnN1cmUgYXBwIG11c3QgaGF2ZSBhIG5hbWUKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIGFwcCApIHsKCgkJCQlpZiAoIWFwcC5uYW1lKSB7CgkJCQkJdGhyb3cgIkFuIGFwcCBtdXN0IGhhdmUgYSBuYW1lLiI7CgkJCQl9CgkJCQl0aGlzLmNhbGxCYXNlKCAiaW5pdGlhbGl6ZSIsIGFwcCApOwoKCQkJfSwKCgkJCS8vaXQgYWRkIGFkZGl0aW9uYWwgbG9naWMgYmVzaWRlIHRoZSBvcmlnaW5hbCBsb2FkIG1ldGhvZAoJCQkvL3N1Y2ggYXMgaW5zdGFuY2UgY291bnRpbmcsIGluc3RhbmNlIGFzc29jaWF0aW9uIHdpdGggdGhlIGNvbnRhaW5lcgoJCQkvL3ByZXBhcmUgdG8gdW5sb2FkIGZyb20gdGhlIGNvbnRhaW5lcgoJCQlsb2FkOiBmdW5jdGlvbiggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7CgkJCQlpZiAoISR2aWV3Q29udGFpbmVyIHx8ICF0aGlzLmxvYWRhYmxlKCkpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl2YXIgYXBwID0gdGhpcywKCQkJCQlidWlsZE1vZGVsUmVzdWx0LAoJCQkJCWFwcE5hbWUgPSBhcHAubmFtZSwKCQkJCQlhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJLy9lbnN1cmUgdGhhdCBhbiBhcHBsaWNhdGlvbiBjYW4gYmUgbG9hZGVkIGludG8gYSBjb250YWluZXIgb25seSBvbmNlCgkJCQlpZiAoYXBwSW5zdGFuY2UpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKGFwcC5sb2FkTW9kZWwpIHsKCQkJCQlidWlsZE1vZGVsUmVzdWx0ID0gYXBwLmxvYWRNb2RlbCggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoKCQkJCX0KCgkJCQl2YXIgY29udGludWF0aW9uID0gZnVuY3Rpb24oKSB7CgoJCQkJCWFwcC5sb2FkVmlldyggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIgKTsKCQkJCQlpbnN0YW5jZU1hbmFnZXIuYWRkKCAkdmlld0NvbnRhaW5lclswXSwgaG1Nb2RlbENvbnRhaW5lci5wYXRoLCBhcHBOYW1lLCBhcHAgKTsKCQkJCQkkdmlld0NvbnRhaW5lci5iaW5kKCAiZXhpdEFwcC4iICsgYXBwTmFtZSwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWFwcC51bmxvYWQoICQoIHRoaXMgKSApOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0gKTsKCgkJCQkJYXBwLmluc3RhbmNlQ291bnQrKzsKCQkJCQlhcHAudWlkKys7CgkJCQl9OwoKCQkJCWlmIChpc1Byb21pc2UoIGJ1aWxkTW9kZWxSZXN1bHQgKSkgewoKCQkJCQlidWlsZE1vZGVsUmVzdWx0LmRvbmUoIGNvbnRpbnVhdGlvbiApOwoKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWF0aW9uKCk7CgoJCQkJfQoKCQkJfSwKCgkJCXVubG9hZDogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyICkgewoKCQkJCXZhciBhcHBOYW1lID0gdGhpcy5uYW1lOwoJCQkJdmFyIGFwcEluc3RhbmNlID0gaW5zdGFuY2VNYW5hZ2VyLmdldCggJHZpZXdDb250YWluZXJbMF0sIGFwcE5hbWUgKTsKCgkJCQl0aGlzLnVubG9hZFZpZXcoICR2aWV3Q29udGFpbmVyICk7CgoJCQkJdGhpcy51bmxvYWRNb2RlbCggYXBwSW5zdGFuY2UubW9kZWxOb2RlICk7CgoJCQkJaW5zdGFuY2VNYW5hZ2VyLnJlbW92ZSggJHZpZXdDb250YWluZXJbMF0sIGFwcE5hbWUgKTsKCgkJCQkkdmlld0NvbnRhaW5lci51bmJpbmQoICJleGl0QXBwLiIgKyBhcHBOYW1lICk7CgoJCQkJdGhpcy5pbnN0YW5jZUNvdW50LS07CgkJCX0sCgoJCQkvL2Z1bmN0aW9uKCBtb2RlbENvbnRhaW5lciwgb3B0aW9ucyApIHt9CgkJCWdldEluaXRpYWxEYXRhOiBudWxsLAoKCQkJLy9kZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGxvYWRNb2RlbCBpcyB0byBjYWxsCgkJCS8vYXBwLmdldEluaXRpYWxEYXRhKCkgYW5kIHB1dCB0aGUgcmVzdWx0IGludG8gbW9kZWwKCQkJLy8KCQkJLy9Zb3UgY2FuIHNldCBsb2FkTW9kZWwgdG8gbnVsbCB0byBzcGVjaWZ5IHRoYXQKCQkJLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBidWlsZCBtb2RlbAoJCQlsb2FkTW9kZWw6IGZ1bmN0aW9uKCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoJCQkJdmFyIGFwcCA9IHRoaXM7CgkJCQlpZiAoIWFwcC5nZXRJbml0aWFsRGF0YSkgewoJCQkJCXRocm93ICJhcHAuZ2V0SW5pdGlhbERhdGEgaXMgbm90IGltcGxlbWVudGVkIjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGFwcC5nZXRJbml0aWFsRGF0YSggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoKCQkJCWlmIChpc1Byb21pc2UoIGRhdGEgKSkgewoJCQkJCXJldHVybiBkYXRhLmRvbmUoIGZ1bmN0aW9uKCBkYXRhICkgewoJCQkJCQlhcHAuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkuc2V0KCBkYXRhICk7CgkJCQkJfSApOwoJCQkJfSBlbHNlIHsKCQkJCQlhcHAuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkuc2V0KCBkYXRhICk7CgkJCQl9CgoJCQl9LAoKCQkJdW5sb2FkTW9kZWw6IGZ1bmN0aW9uKCBtb2RlbE5hbWVzcGFjZSApIHsKCQkJCWlmICh0aGlzLmxvYWRNb2RlbCkgewoJCQkJCWhtLmRlbCggbW9kZWxOYW1lc3BhY2UgKTsKCQkJCX0KCQkJfSwKCgkJCS8vdGhlIGRlZmF1bHQgbG9hZFZpZXcgd2lsbCBjcmVhdGUgYSBjb250YWluZXIKCQkJLy88ZGl2IGFwcG5hbWU9Inh4eCIgbnM9Inh4eCI+PC9kaXY+CgkJCWxvYWRWaWV3OiBmdW5jdGlvbiggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIgKSB7CgoJCQkJdmFyIG5hbWVzcGFjZSA9IHRoaXMuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkucGF0aCwKCQkJCQl2aWV3V3JhcHBlciA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQkJCQkuYXR0ciggImFwcG5hbWUiLCB0aGlzLm5hbWUgKQoJCQkJCQkuYXR0ciggIm5zIiwgbmFtZXNwYWNlICk7CgoJCQkJdmlld1dyYXBwZXIuaG1EYXRhKCAibnMiLCBuYW1lc3BhY2UgKTsKCgkJCQl2aWV3V3JhcHBlci5hcHBlbmRUbyggJHZpZXdDb250YWluZXIgKS50bXBsKAoJCQkJCXRoaXMuZ2V0VGVtcGxhdGVPcHRpb25zKCksCgkJCQkJbmFtZXNwYWNlICk7CgoJCQl9LAoKCQkJdW5sb2FkVmlldzogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyICkgewoJCQkJJHZpZXdDb250YWluZXIuZmluZCggIj4gW2FwcG5hbWU9JyIgKyB0aGlzLm5hbWUgKyAiJ10iICkucmVtb3ZlKCk7CgkJCX0sCgoJCQkvL3RlbXBsYXRlT3B0aW9ucyBpcyBhYm91dCB0ZW1wbGF0ZSBpZAoJCQkvL2J5IGRlZmF1bHQgeW91IGNhbiBnZXQgdGVtcGxhdGVPcHRpb25zIHByb3BlcnR5IG9yCgkJCS8vdGhlIGFwcGxpY2F0aW9uIG5hbWUgYXMgdGVtcGxhdGVPcHRpb25zCgkJCWdldFRlbXBsYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy50ZW1wbGF0ZU9wdGlvbnMgfHwgdGhpcy5uYW1lOwoKCQkJfSwKCgkJCWdldE1vZGVsTm9kZTogZnVuY3Rpb24oIGhtTW9kZWxDb250YWluZXIgKSB7CgkJCQl2YXIgc3ViUGF0aCA9IHRoaXMuc3ViUGF0aCB8fCB0aGlzLm5hbWUucmVwbGFjZSggckRvdCwgIl8iICk7CgkJCQkvL2lmIHdlIGhhdmUgbW9yZSB0aGFuIG9uZSBpbnN0YW5jZSwgdGhlIHN1YlBhdGggbmVlZCB0byBiZQoJCQkJLy9iZSBzdWZmaXggd2l0aCBhbiB1aWQgdG8gbWFrZSB0aGlzIG5hbWVzcGFjZSB1bmlxdWUKCQkJCWlmICh0aGlzLnVpZCkgewoJCQkJCXN1YlBhdGggPSBzdWJQYXRoICsgdGhpcy51aWQ7CgkJCQl9CgkJCQlyZXR1cm4gaG1Nb2RlbENvbnRhaW5lci5jZCggc3ViUGF0aCApOwoKCQkJfSwKCgkJCWluc3RhbmNlQ291bnQ6IDAsCgoJCQl1aWQ6IDAsCgoJCQkvL2lmIHdlIHdhbnQgdG8gdXNlIHNpbmdsZXRvbiB1c2UgdGhlIGZvbGxvd2luZwoJCQkvLwkJbG9hZGFibGU6IGZ1bmN0aW9uKCkgewoJCQkvLwkJCXJldHVybiAhdGhpcy5pbnN0YW5jZUNvdW50OwoJCQkvLwkJfSwKCQkJbG9hZGFibGU6IHJldHVyblRydWUsCgoJCQl0ZW1wbGF0ZU9wdGlvbnM6IG51bGwsCgoJCQkvL3BhdGggdGhhdCB3cmFwIHRoaXMgbW9kZWwsCgkJCS8vYnV0IHRoaXMgc2hvdWxkIG5vdCBiZSB1c2VkIGJ5IGNvbnN1bWVyCgkJCXN1YlBhdGg6IG51bGwKCgoJCX0sCgoJCS8vc3RhdGljIG1lbWJlcnMKCQl7CgoJCQkvL2htLkFwcC5hZGQoewoJCQkvLyAgbmFtZTogImdtYWlsIiwgLy95b3UgbXVzdCBoYXZlIGEgbmFtZQoJCQkvLyAgbG9hZDogZnVuY3Rpb24gKHZpZXdDb250YWluZXIsIG1vZGVsQ29udGFpbmVyLCBvcHRpb25zKSB7fSwKCQkJLy8gIHVuYXBwOiBmdW5jdGlvbiAodmlld0NvbnRhaW5lciwgbW9kZWxDb250YWluZXIpIHt9LCAvL29wdGlvbmFsCgkJCS8vICAvL29wdGlvbmFsLCBieSBkZWZhdWx0IGl0IGlzIG5vdCBsb2FkYWJsZSBpZiBpdCBoYXMgYmVlbiBsb2FkZWQgb25jZQoJCQkvLyAgLy9pZiBpdCBpcyBsb2FkYWJsZTogdHJ1ZSAsIGl0IG1lYW5zIGl0IGlzIGFsd2F5cyBsb2FkYWJsZQoJCQkvLyAgbG9hZGFibGU6IGZ1bmN0aW9uICgpIHt9LAoJCQkvLyB9KTsKCQkJYWRkOiBmdW5jdGlvbiggYXBwICkgewoJCQkJaWYgKCEoYXBwIGluc3RhbmNlb2YgdGhpcykpIHsKCQkJCQlhcHAgPSB0aGlzKCBhcHAgKTsKCQkJCX0KCQkJCWFwcFN0b3JlW2FwcC5uYW1lXSA9IGFwcDsKCQkJfSwKCgkJCXJlbW92ZTogZnVuY3Rpb24oIGFwcE5hbWUgKSB7CgkJCQlpZiAoYXBwU3RvcmVbYXBwTmFtZV0gJiYgIWFwcFN0b3JlW2FwcE5hbWVdLmluc3RhbmNlQ291bnQpIHsKCQkJCQlkZWxldGUgYXBwU3RvcmVbYXBwTmFtZV07CgkJCQl9CgkJCX0sCgoJCQlnZXQ6IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJcmV0dXJuIGFwcFN0b3JlW2FwcE5hbWVdOwoJCQl9LAoKCQkJLy9mZXRjaCB0aGUgZGVmaW5pdGlvbiBvZiB0aGUgYXBwbGljYXRpb24KCQkJbG9hZERlZmluaXRpb246IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggYXBwTmFtZSArICIuYXBwIiApOwoJCQl9LAoKCQkJLy9zdXBwb3J0IHRoZSBmb2xsb3dpbmcgZmVhdHVyZQoJCQkvL2J5IGRlZmF1bHQgY29udGFpbmVyIGlzIGJvZHksIGlmIGNvbnRhaW5lciBpcyBtaXNzaW5nCgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSk7CgkJCS8vCgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSwgdmlld0NvbnRhaW5lcik7IC8vdmlld0NvbnRhaW5lciBpcyBqUXVlcnkKCQkJLy9obS5BcHAubG9hZEFwcChhcHBOYW1lLCBtb2RlbENvbnRhaW5lcik7IC8vbW9kZWxDb250YWluZXIgaXMgc3RyaW5nCgkJCS8vCgkJCS8vY29udGFpbmVyIGlzIGpRdWVyeSBvYmplY3QsIG9yIERPTSBlbGVtZW50CgkJCS8vYXBwTmFtZSBpcyBzdHJpbmcsCgkJCS8vb3B0aW9ucyBpcyBvcHRpb25hbAoJCQlsb2FkQXBwOiBmdW5jdGlvbiggYXBwTmFtZSwgJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7CgoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoKCQkJCQkkdmlld0NvbnRhaW5lciA9ICQoIGRvY3VtZW50LmJvZHkgKTsKCQkJCQlobU1vZGVsQ29udGFpbmVyID0gcm9vdE5vZGU7CgoJCQkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCgkJCQkJaG1Nb2RlbENvbnRhaW5lciA9IHJvb3ROb2RlOwoKCQkJCX0KCgkJCQl2YXIgYXBwID0gYXBwU3RvcmVbYXBwTmFtZV07CgoJCQkJaWYgKGFwcCkgewoKCQkJCQlhcHAubG9hZCggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQl0aGlzLmxvYWREZWZpbml0aW9uKCBhcHBOYW1lICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJCWFwcFN0b3JlW2FwcE5hbWVdLmxvYWQoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICk7CgkJCQkJfSApOwoJCQkJfQoJCQl9LAoKCQkJLy9jb250YWluZXIgYnkgZGVmYXVsdCBpcyBkb2N1bWVudC5ib2R5CgkJCS8vaG0uQXBwLnVubG9hZEFwcChhcHBOYW1lKQoJCQkvL2htLkFwcC51bmxvYWRBcHAoY29udGFpbmVyLCBhcHBOYW1lKTsKCQkJdW5sb2FkQXBwOiBmdW5jdGlvbiggYXBwTmFtZSwgJHZpZXdDb250YWluZXIgKSB7CgkJCQlpZiAoaXNVbmRlZmluZWQoIGFwcE5hbWUgKSkgewoJCQkJCWFwcE5hbWUgPSAkdmlld0NvbnRhaW5lcjsKCQkJCQkkdmlld0NvbnRhaW5lciA9ICQoICJib2R5IiApOwoJCQkJfQoKCQkJCXZhciBhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyLCBhcHBOYW1lICk7CgkJCQlpZiAoYXBwSW5zdGFuY2UpIHsKCQkJCQlhcHBJbnN0YW5jZS5hcHAudW5sb2FkKCAkdmlld0NvbnRhaW5lciApOwoJCQkJfQoJCQl9CgoJCX0gKTsKCgl2YXIgaW5zdGFuY2VNYW5hZ2VyID0gewoKCQlnZXQ6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgYXBwTmFtZSApIHsKCQkJcmV0dXJuIHRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXTsKCQl9LAoKCQlhZGQ6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgbW9kZWxDb250YWluZXJQYXRoLCBhcHBOYW1lLCBhcHAgKSB7CgkJCXRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXSA9IHsKCQkJCWFwcDogYXBwLAoJCQkJbW9kZWxOb2RlOiBhcHAuZ2V0TW9kZWxOb2RlKCBobSggbW9kZWxDb250YWluZXJQYXRoICkgKSwKCQkJCW1vZGVsQ29udGFpbmVyOiBtb2RlbENvbnRhaW5lclBhdGgKCQkJfTsKCQl9LAoKCQlyZW1vdmU6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgYXBwTmFtZSApIHsKCQkJZGVsZXRlIHRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXTsKCQl9LAoKCQlhcHBEYXRhOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIHJlYWRPbmx5ICkgewoJCQl2YXIgYXBwRGF0YSA9ICQoIHZpZXdDb250YWluZXJFbGVtICkuaG1EYXRhKCAiYXBwIiApOwoJCQlpZiAoIXJlYWRPbmx5ICYmICFhcHBEYXRhKSB7CgkJCQlhcHBEYXRhID0geyB9OwoJCQkJJCggdmlld0NvbnRhaW5lckVsZW0gKS5obURhdGEoICJhcHAiLCBhcHBEYXRhICk7CgkJCX0KCQkJcmV0dXJuIGFwcERhdGE7CgkJfQoJfTsKCgliaW5kaW5ncyggewoJCS8vYXBwPSIvfGdtYWlsLG9wdGlvbnMiCgkJLy9kYXRhLXN1Yj0iYXBwOi98Z21haWwsb3B0aW9ucyIKCQlhcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG1hdGNoID0gckFwcE9wdGlvbnMuZXhlYyggJC50cmltKCBvcHRpb25zICkgKSwKCQkJCWFwcE5hbWUgPSBtYXRjaFsxXSwKCQkJCWFwcE9wdGlvbnMgPSBtYXRjaFszXTsKCgkJCWhtLkFwcC5sb2FkQXBwKCBhcHBOYW1lLCAkKCBlbGVtICksIGhtKCBwYXRoICksIGFwcE9wdGlvbnMgKTsKCQl9LAoKCQkvL2V4aXQtYXBwPSJffGdtYWlsIgoJCS8vdW5sb2FkIGFwcCBmcm9tIHBhcmVudCBjb250YWluZXIKCQkvL2RhdGEtc3ViPSJleGl0QXBwOl98Z21haWwiCgkJZXhpdEFwcDogZnVuY3Rpb24oIGVsZW0sIHBhcnNlQ29udGV4dCwgYmluZGluZywgb3B0aW9ucyApIHsKCQkJJCggZWxlbSApLm1hcEV2ZW50KCAiY2xpY2siLCAiZXhpdEFwcC4iICsgb3B0aW9ucyApOwoJCX0sCgoJCS8vbG9hZCBhbiBhcHAgd2hlbiBjbGljawoJCS8vbG9hZC1hcHA9Ii98Z21haWwsI2NvbnRhaW5lcklkLG9wdGlvbnMiCgkJLy9kYXRhLXN1Yj0ibG9hZEFwcDovfGdtYWlsLCNjb250YWluZXJJZCxvcHRpb25zIgoJCWxvYWRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG9wdGlvblBhcnRzID0gckxvYWRBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gb3B0aW9uUGFydHNbMV0sCgkJCQkkdmlld0NvbnRhaW5lciA9ICQoIG9wdGlvblBhcnRzWzNdICksCgkJCQlvdGhlck9wdGlvbnMgPSBvcHRpb25QYXJ0c1s1XTsKCgkJCSQoIGVsZW0gKS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQlobS5BcHAubG9hZEFwcCggYXBwTmFtZSwgJHZpZXdDb250YWluZXIsIGhtKCBwYXRoICksIG90aGVyT3B0aW9ucyApOwoJCQl9ICk7CgkJfSwKCgkJLy91bmxvYWRBcHAKCQkvL3VubG9hZCBhbiBhcHAgd2hlbiBjbGljawoJCS8vdW5sb2FkLWFwcD0iOl98Z21haWwsI2NvbnRhaW5lciIKCQkvL2RhdGEtc3ViPSJ1bmxvYWRBcHA6X3xnbWFpbCwjY29udGFpbmVyIgoJCXVubG9hZEFwcDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQl2YXIgb3B0aW9uUGFydHMgPSByTG9hZEFwcE9wdGlvbnMuZXhlYyggJC50cmltKCBvcHRpb25zICkgKSwKCQkJCWFwcE5hbWUgPSBvcHRpb25QYXJ0c1sxXSwKCQkJCSR2aWV3Q29udGFpbmVyID0gJCggb3B0aW9uUGFydHNbM10gKTsKCgkJCSQoIGVsZW0gKS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQlobS5BcHAudW5sb2FkQXBwKCBhcHBOYW1lLCAkdmlld0NvbnRhaW5lciApOwoJCQl9ICk7CgkJfQoJfSApOwoKCXZhciBfY2xlYW5EYXRhRm9yQXBwID0gJC5jbGVhbkRhdGE7CgoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGFwcERhdGEgPSBpbnN0YW5jZU1hbmFnZXIuYXBwRGF0YSggdGhpcywgdHJ1ZSApOwoJCQlpZiAoYXBwRGF0YSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFwcERhdGEpIHsKCQkJCQl2YXIgYXBwID0gYXBwRGF0YVtrZXldOwoJCQkJCWRlbGV0ZSBhcHBEYXRhW2tleV07CgkJCQkJYXBwLnVubG9hZCggdGhpcywgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSApOwoJCV9jbGVhbkRhdGFGb3JBcHAoIGVsZW1zICk7Cgl9OwoKCV9sb2FkZXIoICJhcHAiLCAianMiLCB7CgkJdXJsOiBmdW5jdGlvbiggbW9kdWxlSWQgKSB7CgkJCS8vaWYgbW9kdWxlIGlkIGlzIGxpa2UgKmhlbGxvLCB0aGVuIGl0IGlzIHdpZGdldAoJCQl2YXIgZmlsZU5hbWUgPSBfbG9hZGVyLmZpbGVOYW1lKCBtb2R1bGVJZCApOwoJCQlyZXR1cm4gZmlsZU5hbWUuc3RhcnRzV2l0aCggImFway4iICkgPwoJCQkJLy9pZiBhcHAgaXMgcGFja2FnZSBpcyBhcGssIHRoZW4gbG9hZCBpdAoJCQkJLy9pbiBhcGsgZm9sZGVyCgkJCQkiYXBrLyIgKyBmaWxlTmFtZS5zdWJzdHIoIDQgKSArICIvbWFpbi5qcyIgOgoKCQkJCS8vb3RoZXJ3aXNlIGxvYWQgaW4gYXBwIGZvbGRlcgoJCQkJImFwcC8iICsgZmlsZU5hbWUgKyAiLmpzIjsKCQl9Cgl9ICk7CgoKCn0pKCBqUXVlcnksIHdpbmRvdyApOwoK",
                "body": "IC8qIQogICogSG0uanMgSmF2YVNjcmlwdCBMaWJyYXJ5IHYxLjAuMAogICogwqkgRnJlZCBZYW5nIC0gaHR0cDovL3NlbWFudGljc3dvcmtzLmNvbQogICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICAqIERhdGU6IFR1ZSBBcHIgMSAxOToxNTo1MCAyMDE0IC0wNzAwCiAgKi8KKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKmpzaGludCBzbWFydHRhYnM6dHJ1ZSwgZXZpbDp0cnVlLCBleHByOnRydWUsIG5ld2NhcDogZmFsc2UsIHZhbGlkdGhpczogdHJ1ZSAqLwoJLyoqCgkgKiBhIHdyYXBwZXIgb3ZlciBhIE5vZGUgY29uc3RydWN0b3IsCgkgKiBbdmFsdWVdIGlzIG9wdGlvbmFsCgkgKi8KCXZhciBobSA9IHdpbmRvdy5obSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcmV0dXJuIG5ldyBOb2RlKCBwYXRoLCB2YWx1ZSApOwoJCX0sCgkJTm9kZSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcGF0aCA9IHBhdGggfHwgIiI7CgkJCXRoaXMucGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBwYXRoLCB0cnVlIC8qIGNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5ICovICk7CgkJCWlmICghaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRoaXMuc2V0KCB2YWx1ZSApOwoJCQl9CgkJfSwKCQlkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCQlsb2NhbFN0b3JhZ2UgPSB3aW5kb3cubG9jYWxTdG9yYWdlLAoJCXNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKCQloaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCgkJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgkJYWxlcnQgPSB3aW5kb3cuYWxlcnQsCgkJY29uZmlybSA9IHdpbmRvdy5jb25maXJtLAoJCWhtRm4sCgkJZXh0ZW5kID0gJC5leHRlbmQsCgkJcmVwb3NpdG9yeSA9IHt9LAoJCWlzQXJyYXkgPSAkLmlzQXJyYXksCgkJaXNGdW5jdGlvbiA9ICQuaXNGdW5jdGlvbiwKCQlwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6IHVuZGVmaW5lZCwgJ2Jvb2xlYW4nOiB1bmRlZmluZWQsICdudW1iZXInOiB1bmRlZmluZWQsICdzdHJpbmcnOiB1bmRlZmluZWQgfSwKCQlzaGFkb3dOYW1lc3BhY2UgPSAiX19obSIsCgkJclNoYWRvd0tleSA9IC9eX19obVwuKFteXC5dKz8pKD86XC58JCkvLAoJLy90cnkgdG8gbWF0Y2ggeHh4IGluIHN0cmluZyB0aGlzLmdldCgieHh4IikKCQlyV2F0Y2hlZFBhdGggPSAvdGhpc1wuKD86Z2V0KVxzKlwoXHMqKFsnIl0pKFtcKlwuXHdcL10rKVwxXHMqXCkvZywKCgkvL2tleSBpcyB3YXRjaGVkUGF0aHMKCS8vdmFsdWUgaXMgYXJyYXkgb2Ygd2F0Y2hpbmdQYXRocwoJCXdhdGNoVGFibGUgPSB7fSwKCQlkZWZhdWx0T3B0aW9ucyA9IHt9LAoJCXJvb3ROb2RlLAoJCXNoYWRvd1Jvb3QgPSByZXBvc2l0b3J5W3NoYWRvd05hbWVzcGFjZV0gPSB7fSwKCQloYXNPd24gPSByZXBvc2l0b3J5Lmhhc093blByb3BlcnR5LAoJCUFycmF5ID0gd2luZG93LkFycmF5LAoJCWFycmF5UHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAoJCXN0cmluZ1Byb3RvdHlwZSA9IFN0cmluZy5wcm90b3R5cGUsCgkJc2xpY2UgPSBhcnJheVByb3RvdHlwZS5zbGljZSwKCQl0cmlnZ2VyLAoJCWJlZm9yZVVwZGF0ZSA9ICJiZWZvcmVVcGRhdGUiLAoJCWFmdGVyVXBkYXRlID0gImFmdGVyVXBkYXRlIiwKCQliZWZvcmVDcmVhdGUgPSAiYmVmb3JlQ3JlYXRlIiwKCQlhZnRlckNyZWF0ZSA9ICJhZnRlckNyZWF0ZSIsCgkJckpTT04gPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCgkJclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dCA9IC9eXC4oXC4qKShbXC5cKl0pLywKCQlyTWFpblBhdGggPSAvXlwuPCguKikvLAoJCXJCZWdpbkRvdE9yU3RhciA9IC9eW1wuXCpdLywKCQlyRG90U3RhciA9IC9bXC5cKl0vLAoJCXJIYXNoT3JEb3QgPSAvIyt8XC4vZywKCQlySGFzaCA9IC8jKy9nLAoJCVJlZ0V4cCA9IHdpbmRvdy5SZWdFeHAsCgkJclBhcmVudEtleSA9IC9eKC4rKVtcLlwqXVx3KyQvLAoJCW1lcmdlUGF0aCwKCQlySW5kZXggPSAvXi4rXC4oXHcrKSR8XHcrLywKCQl1dGlsLAoJCWlzVW5kZWZpbmVkLAoJCWlzUHJpbWl0aXZlLAoJCWlzU3RyaW5nLAoJCWlzT2JqZWN0LAoJCWlzQm9vbGVhbiwKCQlpc051bWVyaWMgPSAkLmlzTnVtZXJpYywKCQlpc1Byb21pc2UsCgkJdG9UeXBlZFZhbHVlLAoJCXRvUGh5c2ljYWxQYXRoLAoJCXRvTG9naWNhbFBhdGgsCgkJY2xlYXJPYmosCgkJJGZuID0gJC5mbiwKCQljbG9uZSwKCQlyU3VwcGxhbnQgPSAvXHsoW15ce1x9XSopXH0vZzsKCgoKCWZ1bmN0aW9uIGF1Z21lbnQoIHByb3RvdHlwZSwgZXh0ZW5zaW9uICkgewoJCWZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKCQkJaWYgKCFwcm90b3R5cGVba2V5XSkgewoJCQkJcHJvdG90eXBlW2tleV0gPSBleHRlbnNpb25ba2V5XTsKCQkJfQoJCX0KCX0KCglhdWdtZW50KCBhcnJheVByb3RvdHlwZSwgewoJCWluZGV4T2Y6IGZ1bmN0aW9uKCBvYmosIHN0YXJ0ICkgewoJCQlmb3IgKHZhciBpID0gKHN0YXJ0IHx8IDApOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewoJCQkJaWYgKHRoaXNbaV0gPT0gb2JqKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIC0xOwoJCX0sCgoJCWNvbnRhaW5zOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuICh0aGlzLmluZGV4T2YoIGl0ZW0gKSAhPT0gLTEpOwoJCX0sCgoJCXJlbW92ZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXZhciBwb3NpdGlvbiA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQlpZiAocG9zaXRpb24gIT0gLTEpIHsKCQkJCXRoaXMuc3BsaWNlKCBwb3NpdGlvbiwgMSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXJlbW92ZUF0OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJCXRoaXMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlwdXNoVW5pcXVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJaWYgKCF0aGlzLmNvbnRhaW5zKCBpdGVtICkpIHsKCQkJCXRoaXMucHVzaCggaXRlbSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCW1lcmdlOiBmdW5jdGlvbiggaXRlbXMgKSB7CgkJCWlmIChpdGVtcyAmJiBpdGVtcy5sZW5ndGgpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLnB1c2hVbmlxdWUoIGl0ZW1zW2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQkvL2l0IGNhbiBiZSBzb3J0T2JqZWN0KCkKCQkvL3NvcnRPYmplY3QoYnkpCgkJc29ydE9iamVjdDogZnVuY3Rpb24oIGJ5LCBhc2MgKSB7CgkJCWlmIChpc1VuZGVmaW5lZCggYXNjICkpIHsKCQkJCWlmIChpc1VuZGVmaW5lZCggYnkgKSkgewoJCQkJCWFzYyA9IHRydWU7CgkJCQkJYnkgPSB1bmRlZmluZWQ7CgkJCQl9IGVsc2UgewoJCQkJCWlmIChpc1N0cmluZyggYnkgKSkgewoJCQkJCQlhc2MgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWFzYyA9IGJ5OwoJCQkJCQlieSA9IHVuZGVmaW5lZDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWlmIChieSkgewoJCQkJdGhpcy5zb3J0KCBmdW5jdGlvbiggYSwgYiApIHsKCQkJCQl2YXIgYXYgPSBhW2J5XTsKCQkJCQl2YXIgYnYgPSBiW2J5XTsKCQkJCQlpZiAoYXYgPT0gYnYpIHsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfQoJCQkJCXJldHVybiAgYXNjID8gKGF2ID4gYnYpID8gMSA6IC0xIDoKCQkJCQkJKGF2ID4gYnYpID8gLTEgOiAxOwoJCQkJfSApOwoJCQl9IGVsc2UgewoJCQkJYXNjID8gdGhpcy5zb3J0KCkgOiB0aGlzLnNvcnQoKS5yZXZlcnNlKCk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJfSApOwoKCWF1Z21lbnQoIHN0cmluZ1Byb3RvdHlwZSwgewoJCXN0YXJ0c1dpdGg6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gdGhpcy5pbmRleE9mKCB0ZXh0ICkgPT09IDA7CgkJfSwKCQljb250YWluczogZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0aGlzLmluZGV4T2YoIHRleHQgKSAhPT0gLTE7CgkJfSwKCQllbmRzV2l0aDogZnVuY3Rpb24oIHN1ZmZpeCApIHsKCQkJcmV0dXJuIHRoaXMuaW5kZXhPZiggc3VmZml4LCB0aGlzLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGggKSAhPT0gLTE7CgkJfSwKCQlzdXBwbGFudDogZnVuY3Rpb24oIG9iaiApIHsKCQkJcmV0dXJuIHRoaXMucmVwbGFjZSggclN1cHBsYW50LAoJCQkJZnVuY3Rpb24oIGEsIGIgKSB7CgkJCQkJdmFyIHIgPSBvYmpbYl07CgkJCQkJcmV0dXJuIHR5cGVvZiByID8gciA6IGE7CgkJCQl9ICk7CgkJfSwKCQlmb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc291cmNlID0gdGhpczsKCQkJJC5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7CgkJCQlzb3VyY2UgPSBzb3VyY2UucmVwbGFjZSggbmV3IFJlZ0V4cCggIlxceyIgKyBpbmRleCArICJcXH0iLCAiZyIgKSwgdmFsdWUgKTsKCQkJfSApOwoJCQlyZXR1cm4gc291cmNlOwoJCX0KCX0gKTsKCglobUZuID0gTm9kZS5wcm90b3R5cGUgPSBobS5mbiA9IGhtLnByb3RvdHlwZSA9IHsKCgkJY29uc3RydWN0b3I6IE5vZGUsCgoJCXRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucGF0aDsKCQl9LAoKCQkvL2dldCgpCgkJLy9nZXQodHJ1ZSkKCQkvLwoJCS8vc3ViUGF0aCBjYW4gYmUgbnVsbCwgdW5kZWZpbmVkLCAiIiwgb3IgImFueSBzdHJpbmciCgkJLy9nZXQoc3ViUGF0aCkKCQkvL2dldChzdWJQYXRoLCBwMSwgcDIpCgkJLy8KCQkvL2RvZXMgbm90IHN1cHBvcnQgdGhlIGZvbGxvd2luZywgYXMgd2lsbCBiZSBpbXBsZW1lbnRlZCBhcyBnZXQoKHN1YlBhdGggPSBwMSksIHAyKQoJCS8vZ2V0KHAxLCBwMikKCQlnZXQ6IGZ1bmN0aW9uKCBzdWJQYXRoIC8qLCBwMSwgcDIsIC4uIGZvciBwYXJhbWV0ZXJzIG9mIG1vZGVsIGZ1bmN0aW9ucyovICkgewoKCQkJdmFyIGN1cnJlbnRWYWx1ZSwgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoLCB0cnVlICk7CgoJCQlpZiAoYWNjZXNzb3IpIHsKCgkJCQlpZiAoaXNGdW5jdGlvbiggYWNjZXNzb3IuaG9zdE9iaiApKSB7CgoJCQkJCXJldHVybiBhY2Nlc3Nvci5ob3N0T2JqLmFwcGx5KCB0aGlzLmNkKCAiLi4iICksIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgoJCQkJfQoJCQkJZWxzZSB7CgoJCQkJCWN1cnJlbnRWYWx1ZSA9ICFhY2Nlc3Nvci5pbmRleCA/CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmogOgoJCQkJCQlhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCQkJaWYgKGlzRnVuY3Rpb24oIGN1cnJlbnRWYWx1ZSApKSB7CgoJCQkJCQkvL2luc2lkZSB0aGUgZnVuY3Rpb24sICJ0aGlzIiByZWZlciB0aGUgcGFyZW50IG1vZGVsIG9mIGFjY2Vzc29yLnBoeXNpY2FsUGF0aAoJCQkJCQlyZXR1cm4gY3VycmVudFZhbHVlLmFwcGx5KCB0aGlzLmNkKCBzdWJQYXRoICkuY2QoICIuLiIgKSwgc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICkgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXJldHVybiBjdXJyZW50VmFsdWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCS8vZWxzZSByZXR1cm4gdW5kZWZpbmVkCgkJfSwKCgkJZ2V0SnNvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggdGhpcy5nZXQuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsKCQl9LAoKCQlyYXc6IGZ1bmN0aW9uKCBzdWJQYXRoLCB2YWx1ZSApIHsKCQkJdmFyIGFjY2Vzc29yOwoJCQlpZiAoaXNGdW5jdGlvbiggc3ViUGF0aCApKSB7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCQkJaWYgKCF2YWx1ZSkgewoJCQkJYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoLCB0cnVlICk7CgkJCQlpZiAoYWNjZXNzb3IpIHsKCQkJCQlyZXR1cm4gIWFjY2Vzc29yLmluZGV4ID8KCQkJCQkJYWNjZXNzb3IuaG9zdE9iaiA6CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJCXRoaXMudXBkYXRlKCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSA6CgkJCQkJdGhpcy5jcmVhdGUoIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApOwoJCQl9CgoJCX0sCgoJCS8vcmV0dXJuIG5vZGUKCQkvL3lvdSBjYW4gdXNlIG5vZGUuc2V0IHRvIGNhbGwgdGhlIGZ1bmN0aW9uIGF0IHRoZSBwYXRoCgkJLy90aGUgZnVuY3Rpb24gY29udGV4dCBpcyBib3VuZCB0byBjdXJyZW50IHByb3h5J3MgcGFyZW50CgkJLy93aGF0IGlzIGRpZmZlcmVudCBmb3IgZ2V0IGZ1bmN0aW9uIGlzIHRoYXQsIHNldCB3aWxsIHJldHVybiBhIHByb3h5CgkJLy9hbmQgZ2V0IHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGZ1bmN0aW9uCgkJc2V0OiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlICkgewoJCQkvL2FsbG93IHNldChwYXRoLCB1bmRlZmluZWQpCgkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCWlmICh0aGlzLnBhdGggPT09ICIiKSB7CgkJCQkJdGhyb3cgInJvb3Qgb2JqZWN0IGNhbiBub3QgY2hhbmdlZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJvb3ROb2RlLnNldCggdGhpcy5wYXRoLCBmb3JjZSwgc3ViUGF0aCApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgoJCQl2YXIgYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgkJCQlyb290Tm9kZS5zZXQoIGZvcmNlLCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCXZhciBjdXJyZW50VmFsdWUgPSBhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCWlmIChpc0Z1bmN0aW9uKCBjdXJyZW50VmFsdWUgKSkgewoKCQkJCS8vaW5zaWRlIHRoZSBmdW5jdGlvbiwgInRoaXMiIHJlZmVyIHRoZSBwYXJlbnQgbW9kZWwgb2YgYWNjZXNzb3IucGh5c2ljYWxQYXRoCgkJCQljdXJyZW50VmFsdWUuYXBwbHkoIHRoaXMuY2QoIHN1YlBhdGggKS5jZCggIi4uIiApLCBzbGljZS5jYWxsKCBhcmdzLCAxICkgKTsKCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJCXRoaXMudXBkYXRlKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICkgOgoJCQkJCXRoaXMuY3JlYXRlKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgoJCQl9CgkJfSwKCgkJYWNjZXNzb3I6IGZ1bmN0aW9uKCBzdWJQYXRoLCByZWFkT25seSAvKmludGVybmFsIHVzZSBvbmx5Ki8gKSB7CgkJCS8vaWYgaXQgaXMgbm90IHJlYWRPbmx5LCBhbmQgYWNjZXNzIG91dCBvZiBib3VuZGFyeSwgaXQgd2lsbCB0aHJvdyBleGNlcHRpb24KCQkJaWYgKHN1YlBhdGggPT09IDApIHsKCQkJCXN1YlBhdGggPSAiMCI7CgkJCX0KCgkJCXZhciBpLAoJCQkJaW5kZXgsCgkJCS8vdGhlIGhvc3RPYmogc3RhcnQgZnJvbSByb290CgkJCQlob3N0T2JqID0gcmVwb3NpdG9yeSwKCQkJLy90aGUgZnVsbFBhdGggY2FuIGJlIGxvZ2ljYWxQYXRoICwgZm9yIGV4YW1wbGUgaG0oInBlcnNvbiIpLmdldFBhdGgoIioiKTsKCQkJLy9pdCBjYW4gYWxzbyBiZSBhIHBoeXNpY2FsUGF0aCBsaWtlIGhtKCJwZXJzb24qIikuZ2V0UGF0aCgpOwoJCQkJZnVsbFBhdGggPSB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSwKCQkJLy9tYWtlIHN1cmUgd2UgYXJlIHdvcmtpbmcgb24gYSBwaHlzaWNhbFBhdGgKCQkJCXBoeXNpY2FsUGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBmdWxsUGF0aCwgdHJ1ZSAvKmNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5Ki8gKSwKCQkJCXBhcnRzID0gcGh5c2ljYWxQYXRoLnNwbGl0KCAiLiIgKTsKCgkJCWlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHsKCgkJCQlpbmRleCA9IHBoeXNpY2FsUGF0aDsKCgkJCX0gZWxzZSB7CgoJCQkJLy9pbmRleCBpcyB0aGUgbGFzdCBwYXJ0CgkJCQlpbmRleCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdOwoKCQkJCS8vdHJhdmVyc2UgdG8gdGhlIHNlY29uZCBsYXN0IG5vZGUgaW4gdGhlIHBhcnRzIGhpZXJhcmNoeQoJCQkJZm9yIChpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKykgewoJCQkJCWhvc3RPYmogPSBob3N0T2JqW3BhcnRzW2ldXTsKCQkJCQlpZiAoaG9zdE9iaiA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKGlzUHJpbWl0aXZlKCBob3N0T2JqICkpIHsKCQkJCWlmIChyZWFkT25seSkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXRocm93ICJpbnZhbGlkIHVwZGF0ZSBvbiB1bnJlYWNoYWJsZSBub2RlICciICsgdG9Mb2dpY2FsUGF0aCggZnVsbFBhdGggKSArICInIjsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHsKCQkJCXBoeXNpY2FsUGF0aDogcGh5c2ljYWxQYXRoLAoJCQkJaG9zdE9iajogaG9zdE9iaiwKCQkJCWluZGV4OiBpbmRleAoJCQl9OwoJCX0sCgoJCWNyZWF0ZTogZnVuY3Rpb24oIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgLyogYWNjZXNzb3IgaXMgdXNlZCBpbnRlcm5hbGx5ICovICkgewoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCWFjY2Vzc29yID0gdmFsdWU7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gZm9yY2U7CgkJCQlmb3JjZSA9IGZhbHNlOwoJCQl9CgoJCQlhY2Nlc3NvciA9IGFjY2Vzc29yIHx8IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCgkJCXZhciBwaHlzaWNhbFBhdGggPSBhY2Nlc3Nvci5waHlzaWNhbFBhdGg7CgoJCQl2YXIgaG9zdE9iaiA9IGFjY2Vzc29yLmhvc3RPYmosCgkJCQlpbmRleCA9IGFjY2Vzc29yLmluZGV4LAoJCQkJaXNIb3N0T2JqQXJyYXkgPSBpc0FycmF5KCBob3N0T2JqICk7CgoJCQlpZiAoaXNIb3N0T2JqQXJyYXkgJiYgaXNOdW1lcmljKCBpbmRleCApKSB7CgkJCQlpZiAoaW5kZXggPiBob3N0T2JqLmxlbmd0aCkgewoJCQkJCXRocm93ICJ5b3UgY2FuIG5vdCBhZGQgaXRlbSB3aXRoIGhvbGUgaW4gYXJyYXkiOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaWYgKGluZGV4IGluIGhvc3RPYmopIHsKCQkJCQl0aHJvdyAidmFsdWUgYXQgcGF0aDogJyIgKyB0b0xvZ2ljYWxQYXRoKCBhY2Nlc3Nvci5waHlzaWNhbFBhdGggKSArICInIGhhcyBiZWVuIGRlZmluZWQsICIgKwoJCQkJCSAgICAgICJ0cnkgdXNlIHVwZGF0ZSBtZXRob2QgaW5zdGVhZCI7CgkJCQl9CgkJCX0KCgkJCWlmICghZm9yY2UgJiYgdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGJlZm9yZUNyZWF0ZSwgdmFsdWUgKS5oYXNFcnJvcigpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmIChpc0hvc3RPYmpBcnJheSAmJiBpc051bWVyaWMoIGluZGV4ICkpIHsKCQkJCWlmIChpbmRleCA9PSBob3N0T2JqLmxlbmd0aCkgewoJCQkJCWhvc3RPYmpbaW5kZXhdID0gdmFsdWU7CgoJCQkJfSBlbHNlIGlmIChpbmRleCA8IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJLy9pbnNlcnQgYW4gaXRlbSB4IGludG8gYXJyYXkgWyAxLCAyLCAzXSBhdCBwb3NpdGlvbiAyLAoJCQkJCS8vIGFuZCBpdCBiZWNvbWVzIFsxLCB4LCAyLCAzXQoJCQkJCWhvc3RPYmouc3BsaWNlKCBhY2Nlc3Nvci5pbmRleCwgMCwgdmFsdWUgKTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQlob3N0T2JqW2FjY2Vzc29yLmluZGV4XSA9IHZhbHVlOwoJCQl9CgoJCQl0cmF2ZXJzZU1vZGVsKCBwaHlzaWNhbFBhdGgsIHZhbHVlICk7CgkJCXRyaWdnZXIoIHBoeXNpY2FsUGF0aCwgcGh5c2ljYWxQYXRoLCBhZnRlckNyZWF0ZSwgdmFsdWUgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZXh0ZW5kOiBmdW5jdGlvbiggc3ViUGF0aCwgb2JqZWN0ICkgewoJCQl2YXIgbmV3TW9kZWw7CgkJCWlmICghb2JqZWN0KSB7CgkJCQlvYmplY3QgPSBzdWJQYXRoOwoJCQkJbmV3TW9kZWwgPSB0aGlzOwoJCQl9IGVsc2UgewoJCQkJbmV3TW9kZWwgPSB0aGlzLmNkKCBzdWJQYXRoICk7CgkJCX0KCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgewoJCQkJbmV3TW9kZWwuc2V0KCBrZXksIG9iamVjdFtrZXldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLyogYWNjZXNzb3IgaXMgdXNlZCBpbnRlcm5hbGx5ICovCgkJLy91cGRhdGUodmFsdWUpCgkJLy91cGRhdGUoc3ViUGF0aCwgdmFsdWUpCgkJLy9tb3N0IG9mIHRoZSB0aW1lIGZvcmNlIGlzIG5vdCB1c2VkLCBieSBkZWZhdWx0IGlzIGl0IGlzIGZhbHNlCgkJLy9ieSBpbiBjYXNlIHlvdSB3YW50IHRvIGJ5cGFzcyB2YWxpZGF0aW9uIHlvdSBjYW4gZXhwbGljaXRseSBzZXQgdG8gdHJ1ZQoJCXVwZGF0ZTogZnVuY3Rpb24oIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSB7CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQlpZiAodGhpcy5wYXRoID09PSAiIikgewoJCQkJCXRocm93ICJyb290IG9iamVjdCBjYW4gbm90IHVwZGF0ZWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyb290Tm9kZS51cGRhdGUoIHRoaXMucGF0aCwgZm9yY2UgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfQoKCQkJaWYgKCFpc0Jvb2xlYW4oIGZvcmNlICkpIHsKCQkJCWFjY2Vzc29yID0gdmFsdWU7CgkJCQl2YWx1ZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gZm9yY2U7CgkJCQlmb3JjZSA9IGZhbHNlOwoJCQl9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewoJCQkJcm9vdE5vZGUudXBkYXRlKCBmb3JjZSwgdGhpcy5wYXRoLCBzdWJQYXRoICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJYWNjZXNzb3IgPSBhY2Nlc3NvciB8fCB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgoJCQlpZiAoISggYWNjZXNzb3IuaW5kZXggaW4gYWNjZXNzb3IuaG9zdE9iaiApKSB7CgkJCQl0aHJvdyAidmFsdWUgYXQgcGF0aDogJyIgKyB0b0xvZ2ljYWxQYXRoKCBhY2Nlc3Nvci5waHlzaWNhbFBhdGggKSArICInIGhhcyBiZWVuIG5vdCBkZWZpbmVkLCAiICsKCQkJCSAgICAgICJ0cnkgdXNlIGNyZWF0ZSBtZXRob2QgaW5zdGVhZCI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSBhY2Nlc3Nvci5waHlzaWNhbFBhdGg7CgoJCQl2YXIgb3JpZ2luYWxWYWx1ZSA9IGFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoJCQkvL3VzZSAiPT0iIGlzIHB1cnBvc2VmdWwsIHdlIHdhbnQgaXQgdG8gYmUgZmxleGlibGUuCgkJCS8vIElmIG1vZGVsIHZhbHVlIGlzIG51bGwsIGFuZCB0ZXh0Qm94IHZhbHVlIGlzICIiLCBiZWNhdXNlIG51bGwgPT0gIiIsCgkJCS8vIHNvIHRoYXQgIiIgY2FuIG5vdCBiZSBzZXQsIHNhbWUgZm9yICI5IiBhbmQgOQoJCQlpZiAob3JpZ2luYWxWYWx1ZSA9PSB2YWx1ZSkgewoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCWlmICghZm9yY2UgJiYgdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGJlZm9yZVVwZGF0ZSwgdmFsdWUsIG9yaWdpbmFsVmFsdWUgKS5oYXNFcnJvcigpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdID0gdmFsdWU7CgoJCQl0cmF2ZXJzZU1vZGVsKCBwaHlzaWNhbFBhdGgsIHZhbHVlICk7CgoJCQlpZiAoIWZvcmNlKSB7CgkJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYWZ0ZXJVcGRhdGUsIHZhbHVlLCBvcmlnaW5hbFZhbHVlICk7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWRlbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCWlmIChpc1VuZGVmaW5lZCggc3ViUGF0aCApKSB7CgkJCQlpZiAodGhpcy5wYXRoKSB7CgkJCQkJcmV0dXJuIHJvb3ROb2RlLmRlbCggdGhpcy5wYXRoICk7CgkJCQl9CgkJCQl0aHJvdyAicm9vdCBjYW4gbm90IGJlIGRlbGV0ZWQiOwoJCQl9CgoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICksCgkJCQlob3N0T2JqID0gYWNjZXNzb3IuaG9zdE9iaiwKCQkJCXBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aCwKCQkJCXJlbW92ZWRWYWx1ZSA9IGhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdLAoJCQkJaXNIb3N0T2JqZWN0QXJyYXkgPSBpc0FycmF5KCBob3N0T2JqICk7CgoJCQlpZiAodHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJiZWZvcmVEZWwiLCB1bmRlZmluZWQsIHJlbW92ZWRWYWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJkdXJpbmdEZWwiLCB1bmRlZmluZWQsIHJlbW92ZWRWYWx1ZSApOwoKCQkJaWYgKGlzSG9zdE9iamVjdEFycmF5KSB7CgoJCQkJaG9zdE9iai5zcGxpY2UoIGFjY2Vzc29yLmluZGV4LCAxICk7CgoJCQl9IGVsc2UgewoKCQkJCWRlbGV0ZSBob3N0T2JqW2FjY2Vzc29yLmluZGV4XTsKCgkJCX0KCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb25EZWxldGVIYW5kbGVycy5sZW5ndGg7IGkrKykgewoJCQkJb25EZWxldGVIYW5kbGVyc1tpXSggcGh5c2ljYWxQYXRoLCByZW1vdmVkVmFsdWUgKTsKCQkJfQoKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlckRlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICk7CgkJCXJldHVybiByZW1vdmVkVmFsdWU7CgkJfSwKCgkJY3JlYXRlSWZVbmRlZmluZWQ6IGZ1bmN0aW9uKCBzdWJQYXRoLCB2YWx1ZSApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCB2YWx1ZSApKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWx1ZSBhcmd1bWVudCI7CgkJCX0KCQkJdmFyIGFjY2Vzc29yID0gdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoJCQlyZXR1cm4gKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkgPwoJCQkJdGhpcyA6CgkJCQl0aGlzLmNyZWF0ZSggc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJaWYgKGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmopIHsKCQkJCXRoaXMudXBkYXRlKCBzdWJQYXRoLCAhYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF0sIGFjY2Vzc29yICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLy9uYXZpZ2F0aW9uIG1ldGhvZHMKCQlwdXNoU3RhY2s6IGZ1bmN0aW9uKCBuZXdOb2RlICkgewoJCQluZXdOb2RlLnByZXZpb3VzID0gdGhpczsKCQkJcmV0dXJuIG5ld05vZGU7CgkJfSwKCgkJY2Q6IGZ1bmN0aW9uKCByZWxhdGl2ZVBhdGggKSB7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaG0oIHRoaXMuZ2V0UGF0aCggcmVsYXRpdmVQYXRoICkgKSApOwoJCX0sCgoJCXBhcmVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmNkKCAiLi4iICk7CgkJfSwKCgkJc2hhZG93OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuY2QoICIqIiApOwoJCX0sCgoJCXNpYmxpbmc6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQlyZXR1cm4gdGhpcy5jZCggIi4uIiArIHBhdGggKTsKCQl9LAoKCQltYWluOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaG0oIGdldE1haW5QYXRoKCB0aGlzLnBhdGggKSApICk7CgkJfSwKCgkJLy8tLS0tLS0tLS0tLS0tLXBhdGggbWV0aG9kcy0tLS0tLS0tLS0tLS0tLQoJCWdldFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQkvL2pvaW4gdGhlIGNvbnRleHQgYW5kIHN1YlBhdGggdG9nZXRoZXIsIGJ1dCBpdCBpcyBzdGlsbCBhIGxvZ2ljYWwgcGF0aAoJCQlyZXR1cm4gbWVyZ2VQYXRoKCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQl9LAoKCQkvL3RvIGdldCB0aGUgbG9naWNhbFBhdGggb2YgY3VycmVudCBtb2RlbCwgbGVhdmUgc3ViUGF0aCBlbXB0eQoJCWxvZ2ljYWxQYXRoOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJcmV0dXJuIHRvTG9naWNhbFBhdGgoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApICk7CgkJfSwKCgkJLy90byBnZXQgdGhlIHBoeXNpY2FsUGF0aCBvZiBjdXJyZW50IG1vZGVsLCBsZWF2ZSBzdWJQYXRoIGVtcHR5CgkJcGh5c2ljYWxQYXRoOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJcmV0dXJuIHRvUGh5c2ljYWxQYXRoKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSApOwoJCX0sCgoJCXBhdGhDb250ZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGNvbnRleHRPZlBhdGgoIHRoaXMucGF0aCApOwoJCX0sCgoJCXBhdGhJbmRleDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBpbmRleE9mUGF0aCggdGhpcy5wYXRoICk7CgkJfSwKCgkJLy9jYWxsIHRoZSBuYXRpdmUgbWV0aG9kIG9mIHRoZSB3cmFwcGVkIHZhbHVlCgkJaW52b2tlVW53cmFwcGVkOiBmdW5jdGlvbiggbWV0aG9kTmFtZSAvKiwgcDEsIHAyLCAuLi4qLyApIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKCQkJCXRocm93ICJtZXRob2ROYW1lIGlzIG1pc3NpbmciOwoJCQl9CgoJCQl2YXIgY29udGV4dCA9IHRoaXMuZ2V0KCk7CgkJCXJldHVybiBjb250ZXh0W21ldGhvZE5hbWVdLmFwcGx5KCBjb250ZXh0LCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoJCX0sCgoJCS8vcmVnaW9uIGFycmF5IG1ldGhvZHMKCQlpbmRleE9mOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCkuaW5kZXhPZiggaXRlbSApOwoJCX0sCgoJCWNvbnRhaW5zOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJcmV0dXJuICh0aGlzLmluZGV4T2YoIGl0ZW0gKSAhPT0gLTEpOwoJCX0sCgoJCWZpcnN0OiBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBmbiA/IHRoaXMuZmlsdGVyKCBmbiApWzBdIDogdGhpcy5nZXQoICIwIiApOwoJCX0sCgoJCWxhc3Q6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwoJCQlyZXR1cm4gdmFsdWVbdmFsdWUubGVuZ3RoIC0gMV07CgkJfSwKCgkJcHVzaDogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl0aGlzLmNyZWF0ZSggdGhpcy5nZXQoKS5sZW5ndGgsIGFyZ3VtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXB1c2hVbmlxdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gIXRoaXMuY29udGFpbnMoIGl0ZW0gKSA/CgkJCQl0aGlzLnB1c2goIGl0ZW0gKSA6CgkJCQl0aGlzOwoJCX0sCgoJCXBvcDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnJlbW92ZUF0KCB0aGlzLmdldCgpLmxlbmd0aCAtIDEgKTsKCQl9LAoKCQlzaGlmdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmRlbCggMCApOwoJCX0sCgoJCXVuc2hpZnQ6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGUoIDAsIGl0ZW0gKTsKCQl9LAoKCQlpbnNlcnRBdDogZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGUoIGluZGV4LCBpdGVtICk7CgkJfSwKCgkJdXBkYXRlQXQ6IGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsKCQkJcmV0dXJuIHRoaXMudXBkYXRlKCBpbmRleCwgaXRlbSApOwoJCX0sCgoJCXJlbW92ZUF0OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJCXJldHVybiB0aGlzLmRlbCggaW5kZXggKTsKCQl9LAoKCQltb3ZlOiBmdW5jdGlvbiggZnJvbUluZGV4LCB0b0luZGV4ICkgewoJCQl2YXIgY291bnQgPSB0aGlzLmNvdW50KCk7CgoJCQlpZiAoZnJvbUluZGV4ICE9PSB0b0luZGV4ICYmCgkJCSAgICBmcm9tSW5kZXggPj0gMCAmJiBmcm9tSW5kZXggPCBjb3VudCAmJgoJCQkgICAgdG9JbmRleCA+PSAwICYmIHRvSW5kZXggPCBjb3VudCkgewoKCQkJCXZhciBpdGVtID0gdGhpcy5kZWwoIGZyb21JbmRleCApOwoJCQkJdGhpcy5pbnNlcnRBdCggdG9JbmRleCwgaXRlbSApOwoJCQkJdHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJtb3ZlIiwgdG9JbmRleCwgZnJvbUluZGV4ICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVwbGFjZUl0ZW06IGZ1bmN0aW9uKCBvbGRJdGVtLCBuZXdJdGVtICkgewoJCQlpZiAob2xkSXRlbSA9PSBuZXdJdGVtKSB7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJdmFyIGluZGV4ID0gdGhpcy5pbmRleE9mKCBvbGRJdGVtICk7CgoJCQlpZiAoaW5kZXggIT0gLTEpIHsKCQkJCXJldHVybiB0aGlzLnVwZGF0ZUF0KCBpbmRleCwgbmV3SXRlbSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXJlbW92ZUl0ZW06IGZ1bmN0aW9uKCBpdGVtICkgewoJCQl2YXIgaW5kZXggPSB0aGlzLmluZGV4T2YoIGl0ZW0gKTsKCQkJcmV0dXJuIGluZGV4ICE9PSAtMSA/IHRoaXMucmVtb3ZlQXQoIGluZGV4ICkgOiB0aGlzOwoJCX0sCgoJCXJlbW92ZUl0ZW1zOiBmdW5jdGlvbiggaXRlbXMgKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKCQkJCXRoaXMucmVtb3ZlSXRlbSggaXRlbXNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljbGVhcjogZnVuY3Rpb24oKSB7CgkJCXZhciBpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCQlvbGRJdGVtcyA9IGl0ZW1zLnNwbGljZSggMCwgaXRlbXMubGVuZ3RoICk7CgoJCQl0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgImFmdGVyQ3JlYXRlIiwgaXRlbXMsIG9sZEl0ZW1zICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWNvdW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCkubGVuZ3RoOwoJCX0sCgoJCS8vZm4gaXMgbGlrZSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHsgcmV0dXJuIGl0ZW0gPT0gMTsgfTsKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuICQoIHRoaXMuZ2V0KCkgKS5maWx0ZXIoIGZuICkuZ2V0KCk7CgkJfSwKCgkJLy9mbjogZnVuY3Rpb24gKGluZGV4LCBpdGVtLCBpdGVtcykge30KCQllYWNoOiBmdW5jdGlvbiggZGlyZWN0QWNjZXNzLCBmbiApIHsKCQkJaWYgKCFpc0Jvb2xlYW4oIGRpcmVjdEFjY2VzcyApKSB7CgkJCQlmbiA9IGRpcmVjdEFjY2VzczsKCQkJCWRpcmVjdEFjY2VzcyA9IGZhbHNlOwoJCQl9CgoJCQl2YXIgaGFzQ2hhbmdlLCBpLCBzdGF0dXMsIGl0ZW1zLCBpdGVtTW9kZWw7CgoJCQlpZiAoZGlyZWN0QWNjZXNzKSB7CgoJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoKCQkJCWZvciAoaSA9IGl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJLy90aGlzIGluIHRoZSBmbiByZWZlciB0byB0aGUgcGFyZW50IGFycmF5CgkJCQkJc3RhdHVzID0gZm4uY2FsbCggaXRlbXNbaV0sIGksIGl0ZW1zW2ldLCBpdGVtcyApOwoJCQkJCWlmIChzdGF0dXMgPT09IHRydWUpIHsKCQkJCQkJaGFzQ2hhbmdlID0gdHJ1ZTsKCQkJCQl9IGVsc2UgaWYgKHN0YXR1cyA9PT0gZmFsc2UpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCWlmIChoYXNDaGFuZ2UpIHsKCQkJCQl0aGlzLmNoYW5nZSgpOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoaSA9IHRoaXMuY291bnQoKSAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJLy90aGlzIGluIHRoZSBmbiwgcmVmZXIgdG8gdGhlIHBhcmVudCBtb2RlbAoJCQkJCWl0ZW1Nb2RlbCA9IHRoaXMuY2QoIGkgKTsKCQkJCQlpZiAoZm4uY2FsbCggaXRlbU1vZGVsLCBpLCBpdGVtTW9kZWwsIHRoaXMgKSA9PT0gZmFsc2UpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCW1hcDogZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gJC5tYXAoIHRoaXMuZ2V0KCksIGZuICk7CgkJfSwKCgkJc29ydDogZnVuY3Rpb24oIGJ5LCBhc2MgKSB7CgkJCXJldHVybiB0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgImFmdGVyVXBkYXRlIiwgdGhpcy5nZXQoKS5zb3J0T2JqZWN0KCBieSwgYXNjICkgKTsKCQl9LAoJCS8vI2VuZHJlZ2lvbgoKCQkvLy0tLS0tLS1tb2RlbCB3YXRjaCBtZXRob2QgLS0tLS0tLS0tLS0KCQl3YXRjaDogZnVuY3Rpb24oIC8qdGFyZ2V0UGF0aDEsIHRhcmdldFBhdGgyLCAuLiovICkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJd2F0Y2goIHRoaXMucGF0aCwgYXJndW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJdW53YXRjaDogZnVuY3Rpb24oIC8qdGFyZ2V0UGF0aDEsIHRhcmdldFBhdGgyLCAuLiovICkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJdW53YXRjaCggdGhpcy5wYXRoLCBhcmd1bWVudHNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvL2VuZHJlZ2lvbgoKCQkvLy0tLS0tLS1vdGhlciBtZXRob2RzLS0tLS0tLS0tCgkJaXNFbXB0eTogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXZhciB2YWx1ZSA9IHRoaXMuZ2V0KCBzdWJQYXRoICk7CgkJCXJldHVybiAhdmFsdWUgPyB0cnVlIDoKCQkJCSFpc0FycmF5KCB2YWx1ZSApID8gZmFsc2UgOgoJCQkJCSh2YWx1ZS5sZW5ndGggPT09IDApOwoJCX0sCgoJCWlzU2hhZG93OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucGF0aC5zdGFydHNXaXRoKCBzaGFkb3dOYW1lc3BhY2UgKTsKCQl9LAoKCQl0b0pTT046IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gSlNPTi5zdHJpbmdpZnkoIHRoaXMuZ2V0KCBzdWJQYXRoICkgKTsKCQl9LAoKCQljb21wYXJlOiBmdW5jdGlvbiggZXhwcmVzc2lvbiApIHsKCQkJaWYgKGV4cHJlc3Npb24pIHsKCQkJCWV4cHJlc3Npb24gPSB0b1R5cGVkVmFsdWUoIGV4cHJlc3Npb24gKTsKCQkJCWlmIChpc1N0cmluZyggZXhwcmVzc2lvbiApKSB7CgkJCQkJaWYgKHRoaXMuZ2V0KCkgPT0gZXhwcmVzc2lvbikgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0cnkgewoJCQkJCQkJcmV0dXJuIGV2YWwoICJ0aGlzLmdldCgpIiArIGV4cHJlc3Npb24gKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gdGhpcy5nZXQoKSA9PSBleHByZXNzaW9uOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuaXNFbXB0eSgpOwoJCQl9CgkJfSwKCgkJc2F2ZUxvY2FsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHRoaXMuZ2V0KCBzdWJQYXRoICkgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZ2V0TG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICkgKTsKCQl9LAoKCQlyZXN0b3JlTG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyb290Tm9kZS5zZXQoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCB0aGlzLmdldExvY2FsKCBzdWJQYXRoICkgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJY2xlYXJMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXV0aWwubG9jYWwoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCB1bmRlZmluZWQgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX07CgoJZnVuY3Rpb24gZXhwYW5kVG9IYXNoZXMoICQwICkgewoJCXJldHVybiAkMCA9PT0gIi4iID8gIiMiIDogLy9pZiBpdCBpcyAiLiIgY29udmVydCB0byAiIyIKCQkJbmV3IEFycmF5KCAkMC5sZW5ndGggKyAyICkuam9pbiggIiMiICk7IC8vLy9pZiBpdCBpcyAiIyIgY29udmVydCB0byAiIyMiCgl9CgoJdmFyIG9uQWRkT3JVcGRhdGVIYW5kbGVycyA9IFtmdW5jdGlvbiAvKmluZmVyTm9kZURlcGVuZGVuY2llcyovICggY29udGV4dCwgaW5kZXgsIHZhbHVlICkgewoKCQkvL29ubHkgdHJ5IHRvIHBhcnNlIGZ1bmN0aW9uIGJvZHkKCQkvL2lmIGl0IGlzIGEgcGFyYW1ldGVyLWxlc3MgZnVuY3Rpb24KCQkvL29yIGl0IGhhcyBhIG1hZ2ljIGZ1bmN0aW9uIG5hbWUgIl8iCgkJaWYgKCFpc0Z1bmN0aW9uKCB2YWx1ZSApIHx8ICh2YWx1ZS5uYW1lICYmIHZhbHVlLm5hbWUuc3RhcnRzV2l0aCggIl8iICkpKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBmdW5jdGlvbkJvZHkgPSB2YWx1ZS50b1N0cmluZygpLAoJCQlwYXRoID0gY29udGV4dCA/IGNvbnRleHQgKyAiLiIgKyBpbmRleCA6IGluZGV4LAoJCQl3YXRjaGVkUGF0aHMgPSBleHRyYWN0V2F0Y2hlZFBhdGhzKCBmdW5jdGlvbkJvZHkgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCB3YXRjaGVkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJd2F0Y2goIHBhdGgsIGNvbnRleHQgPyBtZXJnZVBhdGgoIGNvbnRleHQsIHdhdGNoZWRQYXRoc1tpXSApIDogd2F0Y2hlZFBhdGhzW2ldICk7CgkJfQoJfV07CgoJZnVuY3Rpb24gcHJvY2Vzc05ld05vZGUoIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvbkFkZE9yVXBkYXRlSGFuZGxlcnMubGVuZ3RoOyBpKyspIHsKCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CgkJfQoJfQoKCWZ1bmN0aW9uIGdldE1haW5QYXRoKCBzaGFkb3dQYXRoICkgewoJCWlmIChzaGFkb3dQYXRoID09PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJcmV0dXJuICIiOwoJCX0KCQl2YXIgbWF0Y2ggPSByU2hhZG93S2V5LmV4ZWMoIHNoYWRvd1BhdGggKTsKCQlyZXR1cm4gbWF0Y2ggPyBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCggbWF0Y2hbMV0gKSA6IHNoYWRvd1BhdGg7Cgl9CgoJZnVuY3Rpb24gY29udmVydFNoYWRvd0tleVRvTWFpblBhdGgoIGtleSApIHsKCQlyZXR1cm4ga2V5LnJlcGxhY2UoIHJIYXNoLCByZWR1Y2VUb0RvdCApOwoJfQoKCWZ1bmN0aW9uIHJlZHVjZVRvRG90KCBoYXNoZXMgKSB7CgkJcmV0dXJuIGhhc2hlcyA9PSAiIyIgPyAiLiIgOiAvLyBpZiBpcyAjIHJldHVybiAuCgkJCW5ldyBBcnJheSggaGFzaGVzLmxlbmd0aCApLmpvaW4oICIjIiApOyAvLyBpZiBpdCBpcyAjIyByZXR1cm4gIwoJfQoKCS8qIHByb2Nlc3NDdXJyZW50IGlzIHVzZWQgaW50ZXJuYWxseSwgZG9uJ3QgdXNlIGl0ICovCglmdW5jdGlvbiB0cmF2ZXJzZU1vZGVsKCBtb2RlbFBhdGgsIG1vZGVsVmFsdWUsIHByb2Nlc3NDdXJyZW50ICkgewoJCXZhciBjb250ZXh0UGF0aCwKCQkJaW5kZXhQYXRoLAoJCQlpbmRleE9mTGFzdERvdCA9IG1vZGVsUGF0aC5sYXN0SW5kZXhPZiggIi4iICk7CgoJCWlmIChpc1VuZGVmaW5lZCggcHJvY2Vzc0N1cnJlbnQgKSkgewoJCQlwcm9jZXNzQ3VycmVudCA9IHRydWU7CgkJfQoKCQlpZiAocHJvY2Vzc0N1cnJlbnQpIHsKCgkJCWlmIChpbmRleE9mTGFzdERvdCA9PT0gLTEpIHsKCQkJCWNvbnRleHRQYXRoID0gIiI7CgkJCQlpbmRleFBhdGggPSBtb2RlbFBhdGg7CgkJCX0gZWxzZSB7CgkJCQljb250ZXh0UGF0aCA9IG1vZGVsUGF0aC5zdWJzdHJpbmcoIDAsIGluZGV4T2ZMYXN0RG90ICk7CgkJCQlpbmRleFBhdGggPSBtb2RlbFBhdGguc3Vic3RyaW5nKCBpbmRleE9mTGFzdERvdCArIDEgKTsKCQkJfQoKCQkJcHJvY2Vzc05ld05vZGUoIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKTsKCQl9CgoJCWlmICghaXNQcmltaXRpdmUoIG1vZGVsVmFsdWUgKSkgewoKCQkJZm9yIChpbmRleFBhdGggaW4gbW9kZWxWYWx1ZSkgewoKCQkJCS8vZG8gbm90IHJlbW92ZSB0aGUgaGFzT3duUHJvcGVydHkgY2hlY2shIQoJCQkJLy9pZiAoaGFzT3duLmNhbGwoIG1vZGVsVmFsdWUsIGluZGV4ICkpIHsKCQkJCXByb2Nlc3NOZXdOb2RlKCBtb2RlbFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZVtpbmRleFBhdGhdICk7CgkJCQl0cmF2ZXJzZU1vZGVsKCBtb2RlbFBhdGggKyAiLiIgKyBpbmRleFBhdGgsIG1vZGVsVmFsdWVbaW5kZXhQYXRoXSwgZmFsc2UgKTsKCQkJCS8vfQoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHdhdGNoKCB3YXRjaGluZ1BhdGgsIHdhdGNoZWRQYXRoICkgewoJCXdhdGNoZWRQYXRoID0gdG9QaHlzaWNhbFBhdGgoIHdhdGNoZWRQYXRoICk7CgkJdmFyIHJlZmVyZW5jaW5nUGF0aHMgPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQlpZiAoIXJlZmVyZW5jaW5nUGF0aHMpIHsKCQkJd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF0gPSByZWZlcmVuY2luZ1BhdGhzID0gW107CgkJfQoJCXJlZmVyZW5jaW5nUGF0aHMucHVzaFVuaXF1ZSggd2F0Y2hpbmdQYXRoICk7Cgl9CgoJZnVuY3Rpb24gdW53YXRjaCggd2F0Y2hpbmdQYXRoLCB3YXRjaGVkUGF0aCApIHsKCQl3YXRjaGVkUGF0aCA9IHRvUGh5c2ljYWxQYXRoKCB3YXRjaGVkUGF0aCApOwoJCXZhciB3YXRjaGluZ1BhdGhzID0gd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJd2F0Y2hpbmdQYXRocy5yZW1vdmUoIHdhdGNoaW5nUGF0aCApOwoJCWlmICghd2F0Y2hpbmdQYXRocy5sZW5ndGgpIHsKCQkJZGVsZXRlIHdhdGNoVGFibGVbd2F0Y2hlZFBhdGhdOwoJCX0KCX0KCglmdW5jdGlvbiBleHRyYWN0V2F0Y2hlZFBhdGhzKCBmdW5jdGlvbkJvZHkgKSB7CgkJdmFyIG1lbWJlck1hdGNoLAoJCQlydG4gPSBbXTsKCgkJd2hpbGUgKChtZW1iZXJNYXRjaCA9IHJXYXRjaGVkUGF0aC5leGVjKCBmdW5jdGlvbkJvZHkgKSApKSB7CgkJCXJ0bi5wdXNoVW5pcXVlKCBtZW1iZXJNYXRjaFsyXSApOwoJCX0KCQlyZXR1cm4gcnRuOwoJfQoKCWZ1bmN0aW9uIGNvbnRleHRPZlBhdGgoIHBhdGggKSB7CgkJdmFyIG1hdGNoID0gclBhcmVudEtleS5leGVjKCBwYXRoICk7CgkJcmV0dXJuIG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwoJfQoKCWZ1bmN0aW9uIGluZGV4T2ZQYXRoKCBwYXRoICkgewoJCXZhciBtYXRjaCA9IHJJbmRleC5leGVjKCBwYXRoICk7CgkJcmV0dXJuIG1hdGNoWzFdIHx8IG1hdGNoWzBdOwoJfQoKCXZhciBkdW1teSA9IHt9OwoKCXZhciBDbGFzcyA9IGZ1bmN0aW9uIF8oIHNlZWQgKSB7CgkJdmFyIHRlbXA7CgoJCWlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgewoJCQl0ZW1wID0gbmV3IF8oIGR1bW15ICk7CgkJCXJldHVybiBfLmFwcGx5KCB0ZW1wLCBhcmd1bWVudHMgKTsKCQl9CgoJCWlmIChhcmd1bWVudHNbMF0gPT09IGR1bW15KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdGhpcy5pbml0aWFsaXplLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIHN1cGVyUHJvdG90eXBlOwoJZXh0ZW5kKCBDbGFzcy5wcm90b3R5cGUsIHsKCgkJY2FsbFByb3RvOiBmdW5jdGlvbiggbWV0aG9kTmFtZSApIHsKCQkJdmFyIG1ldGhvZCA9IHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlW21ldGhvZE5hbWVdOwoJCQlyZXR1cm4gbWV0aG9kLmFwcGx5KCB0aGlzLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoJCX0sCgoJCS8vaW5zdGFuY2UuY2FsbEJhc2UoIm1ldGhvZDEiLCBwMSwgcDIsLi4uKTsKCQljYWxsQmFzZTogZnVuY3Rpb24oIG1ldGhvZE5hbWUgKSB7CgkJCS8vc3VwZXJQcm90b3R5cGUgaXMgZ2xvYmFsIG9iamVjdCwgd2UgdXNlIHRoaXMKCQkJLy8gYmVjYXVzZSBhc3N1bWUganMgaW4gYnJvd3NlciBpcyBhIHNpbmdsZSB0aHJlYWRlZAoKCQkJLy9zdGFydGluZyBmcm9tICJ0aGlzIiBpbnN0YW5jZQoJCQlzdXBlclByb3RvdHlwZSA9IHN1cGVyUHJvdG90eXBlIHx8IHRoaXM7CgkJCXN1cGVyUHJvdG90eXBlID0gc3VwZXJQcm90b3R5cGUuY29uc3RydWN0b3IuX19zdXBlcl9fOwoKCQkJaWYgKCFzdXBlclByb3RvdHlwZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbWV0aG9kID0gc3VwZXJQcm90b3R5cGVbbWV0aG9kTmFtZV07CgkJCXZhciBydG4gPSBtZXRob2QuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgoJCQkvL3doZW4gaXQgZG9uZSwgc2V0IGl0IGJhY2sgdG8gbnVsbAoJCQlzdXBlclByb3RvdHlwZSA9IG51bGw7CgkJCXJldHVybiBydG47CgkJfSwKCgkJLyogdGhlIHN1YlR5cGUncyBpbml0aWFsaXplIHNob3VsZCBiZSBsaWtlCgkJICoKCQkgaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHNlZWQgKSB7CgkJIC8vZG8gdGhpbmdzCgkJIHRoaXMuY2FsbEJhc2UoICJpbml0aWFsaXplIiwgc2VlZCApOwoJCSB9LAoJCSAqLwoJCS8vdGhlIGRlZmF1bHQgaW5pdGlhbGl6ZSBpcyB0byBleHRlbmQgdGhlIGluc3RhbmNlIHdpdGggc2VlZCBkYXRhCgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHNlZWQgKSB7CgkJCWV4dGVuZCggdGhpcywgc2VlZCApOwoJCX0sCgoJCS8vdGhpcyBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuIEpTT04uc3RyaW5naWZ5KCkgaXMgY2FsbGVkCgkJdG9KU09OOiBmdW5jdGlvbigpIHsKCQkJdmFyIHJ0biA9IGV4dGVuZCggdHJ1ZSwge30sIHRoaXMgKTsKCgkJCWZvciAodmFyIGtleSBpbiBydG4pIHsKCQkJCWlmIChrZXkuc3RhcnRzV2l0aCggIl9fIiApKSB7CgkJCQkJZGVsZXRlIHJ0bltrZXldOwoJCQkJfQoJCQl9CgkJCXJldHVybiBydG47CgkJfQoKCX0gKTsKCglleHRlbmQoIENsYXNzLCB7CgoJCS8vY3JlYXRlIGFuIGFycmF5IG9mIGl0ZW1zIG9mIHRoZSBzYW1lIHR5cGUKCQkvL2lmIFlvdSBoYXZlIGEgc3ViVHlwZSBjYWxsZWQgUGVyc29uCgkJLy95b3UgY2FuIFBlcnNvbi5saXN0KFsgc2VlZDEsIHNlZWQyIF0pOwoJCS8vdG8gY3JlYXRlIGFuIGFycmF5IG9mIHR5cGVkIGl0ZW1zCgkJbGlzdDogZnVuY3Rpb24oIHNlZWRzICkgewoKCQkJdmFyIGksCgkJCQlzZWVkLAoJCQkJcnRuID0gW10sCgkJCQlpdGVtSXNPYmplY3Q7CgoJCQlpZiAoaXNVbmRlZmluZWQoIHNlZWRzICkpIHsKCgkJCQlyZXR1cm4gcnRuOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIWlzQXJyYXkoIHNlZWRzICkpIHsKCgkJCQkJc2VlZHMgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMgKTsKCgkJCQl9CgoJCQkJaXRlbUlzT2JqZWN0ID0gc2VlZHMuaXRlbUlzT2JqZWN0OwoKCQkJCWZvciAoaSA9IDA7IGkgPCBzZWVkcy5sZW5ndGg7IGkrKykgewoJCQkJCXNlZWQgPSBzZWVkc1tpXTsKCgkJCQkJcnRuLnB1c2goCgkJCQkJCWl0ZW1Jc09iamVjdCB8fCAhaXNBcnJheSggc2VlZCApID8KCQkJCQkJCXNlZWRzIGluc3RhbmNlb2YgdGhpcyA/IHRoaXMgOiBuZXcgdGhpcyggc2VlZCApIDoKCQkJCQkJCXRoaXMuYXBwbHkoIG51bGwsIHNlZWQgKQoJCQkJCSk7CgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8vdG8gY3JlYXRlIGEgbmV3IFR5cGUgY2FsbAoKCQlleHRlbmQ6IGZ1bmN0aW9uKCBpbnN0YW5jZU1lbWJlcnMsIHN0YXRpY01lbWJlcnMgKSB7CgkJCXZhciBDaGlsZCwKCQkJCVBhcmVudCA9IHRoaXM7CgoJCQkvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CgkJCS8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCQkJLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJCQlpZiAoaW5zdGFuY2VNZW1iZXJzICYmIGluc3RhbmNlTWVtYmVycy5oYXNPd25Qcm9wZXJ0eSggImNvbnN0cnVjdG9yIiApKSB7CgkJCQlDaGlsZCA9IGluc3RhbmNlTWVtYmVycy5jb25zdHJ1Y3RvcjsKCQkJfSBlbHNlIHsKCQkJCUNoaWxkID0gZnVuY3Rpb24gXygpIHsKCQkJCQl2YXIgdGVtcDsKCgkJCQkJaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSB7CgkJCQkJCXRlbXAgPSBuZXcgXyggZHVtbXkgKTsKCQkJCQkJcmV0dXJuIF8uYXBwbHkoIHRlbXAsIGFyZ3VtZW50cyApOwoJCQkJCX0KCgkJCQkJaWYgKGFyZ3VtZW50c1swXSA9PT0gZHVtbXkpIHsKCQkJCQkJcmV0dXJuIHRoaXM7CgkJCQkJfQoJCQkJCS8vdGhpcyBpcyBzaW1pbGFyIGxpa2UgOiBiYXNlKGFyZ3VtZW50cykKCQkJCQlQYXJlbnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfTsKCQkJfQoKCQkJLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkJCWV4dGVuZCggQ2hpbGQsIFBhcmVudCwgc3RhdGljTWVtYmVycyApOwoKCQkJLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKCQkJLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCQkJdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gQ2hpbGQ7IH07CgkJCVN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBQYXJlbnQucHJvdG90eXBlOwoJCQlDaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlKCk7CgoJCQkvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCQkJLy8gaWYgc3VwcGxpZWQuCgkJCWlmIChpbnN0YW5jZU1lbWJlcnMpIHsKCQkJCWV4dGVuZCggQ2hpbGQucHJvdG90eXBlLCBpbnN0YW5jZU1lbWJlcnMgKTsKCQkJfQoKCQkJLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJCQkvLyBsYXRlci4KCQkJQ2hpbGQuX19zdXBlcl9fID0gUGFyZW50LnByb3RvdHlwZTsKCgkJCXJldHVybiBDaGlsZDsKCQl9CgoJfSApOwoKCS8vaGVscGVycwoJZXh0ZW5kKCBobSwgewoKCQlDbGFzczogQ2xhc3MsCgoJCXV0aWw6IHV0aWwgPSB7CgoJCQkvL3VzZXIgZG8gbm90IG5lZWQgdG8gdXNlIGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5IHBhcmFtZXRlcgoJCQkvL2l0IGlzIGZvciBpbnRlcm5hbCB1c2UKCQkJLy9pdCBpcyBvbmx5IHVzZWQgaW4gdHdvIHBsYWNlcy4gSXQgaXMsIHdoZW4gYSBtb2RlbCBpcyBjcmVhdGVkCgkJCS8vIGFuZCB3aGVuIGFjY2Vzc29yIGlzIGJ1aWxkLAoJCQkvLyBldmVuIGluIHRoZXNlIHR3byBjYXNlIHdoZW4gdGhlIHBhcmFtZXRlciBpcyB0cnVlLAoJCQkvLyBzaGFkb3cgaXMgbm90IG5lY2Vzc2FyeSBjcmVhdGVkCgkJCS8vIGl0IGlzIG9ubHkgY3JlYXRlZCB3aGVuCgkJCS8vIHRoZSB0aGUgcGh5c2ljYWwgcGF0aCBpcyBwb2ludGluZyB0byBhIHNoYWRvdwoJCQkvLyBhbmQgdGhlIG1haW4gbW9kZWwgaGFzIGJlZW4gY3JlYXRlZAoJCQkvLyBhbmQgdGhlIHNoYWRvdydzIHBhcmVudCBpcyBhbiBvYmplY3QKCQkJdG9QaHlzaWNhbFBhdGg6IHRvUGh5c2ljYWxQYXRoID0gZnVuY3Rpb24oIGxvZ2ljYWxQYXRoLCBjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAvKiBpbnRlcm5hbCB1c2UqLyApIHsKCgkJCQl2YXIgbWF0Y2gsIHJ0biA9ICIiLCBsZWZ0Q29udGV4dCA9ICIiLCBtYWluVmFsdWUsIHNoYWRvd0tleSwgbWFpblBhdGg7CgoJCQkJd2hpbGUgKChtYXRjaCA9IHJEb3RTdGFyLmV4ZWMoIGxvZ2ljYWxQYXRoICkpKSB7CgkJCQkJLy9yZXNldCBsb2dpY2FsIFBhdGggdG8gdGhlIHJlbWFpbmluZyBvZiB0aGUgc2VhcmNoIHRleHQKCQkJCQlsb2dpY2FsUGF0aCA9IFJlZ0V4cC5yaWdodENvbnRleHQ7CgkJCQkJbGVmdENvbnRleHQgPSBSZWdFeHAubGVmdENvbnRleHQ7CgoJCQkJCWlmIChtYXRjaFswXSA9PSAiLiIpIHsKCgkJCQkJCWlmIChydG4pIHsKCQkJCQkJCS8vbWFpblBhdGggPSBydG4gKyAiLiIgKyBsZWZ0Q29udGV4dAoJCQkJCQkJaWYgKHJ0biA9PSBzaGFkb3dOYW1lc3BhY2UgJiYgY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYgIXNoYWRvd1Jvb3RbbGVmdENvbnRleHRdKSB7CgkJCQkJCQkJbWFpblBhdGggPSBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCggbGVmdENvbnRleHQgKTsKCQkJCQkJCQlpZiAoIWlzVW5kZWZpbmVkKCByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoJCQkJCQkJCQlzaGFkb3dSb290W2xlZnRDb250ZXh0XSA9IHt9OwoJCQkJCQkJCX0KCQkJCQkJCQkvLyFpc1VuZGVmaW5lZCggcm9vdE5vZGUuZ2V0KCBtYWluUGF0aCApICkKCQkJCQkJCQkvKglpZiAoY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYKCQkJCQkJCQkgIXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSAmJgoJCQkJCQkJCSBydG4gIT0gc2hhZG93TmFtZXNwYWNlICYmCgkJCQkJCQkJICFpc1VuZGVmaW5lZCggbWFpblZhbHVlID0gcm9vdE5vZGUuZ2V0KCBtYWluUGF0aCApICkpIHsKCQkJCQkJCQkgKi8KCQkJCQkJCX0KCQkJCQkJCXJ0biA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0OwoJCQkJCQkJLy9zaGFkb3dSb290W3NoYWRvd0tleV0KCQkJCQkJCS8vaWYgKHJ0biA9PSkKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJ0biA9IGxlZnRDb250ZXh0OwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvL2lmIG1hdGNoIGlzICIqIiwgdGhlbiBpdCBpcyBzaGFkb3cKCQkJCQkJLy9pZiBydG4gaXMgbm90IGVtcHR5IHNvIGZhcgoJCQkJCQlpZiAocnRuKSB7CgkJCQkJCQkvL3NoYWRvd0tleSB3aWxsIGJlCgkJCQkJCQkvL2NvbnZlcnRNYWluUGF0aFRvU2hhZG93S2V5CgkJCQkJCQlzaGFkb3dLZXkgPSAoIHJ0biA/IHJ0bi5yZXBsYWNlKCBySGFzaE9yRG90LCBleHBhbmRUb0hhc2hlcyApIDogcnRuKSArICIjIiArIGxlZnRDb250ZXh0OwoJCQkJCQkJbWFpblBhdGggPSBydG4gKyAiLiIgKyBsZWZ0Q29udGV4dDsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWlmIChsZWZ0Q29udGV4dCkgewoJCQkJCQkJCXNoYWRvd0tleSA9IGxlZnRDb250ZXh0OwoJCQkJCQkJCW1haW5QYXRoID0gbGVmdENvbnRleHQ7CgoJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJc2hhZG93S2V5ID0gIiI7CgkJCQkJCQkJbWFpblBhdGggPSAiIjsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJcnRuID0gc2hhZG93TmFtZXNwYWNlICsgKHNoYWRvd0tleSA/ICIuIiArIHNoYWRvd0tleSA6ICIiKTsKCgkJCQkJCS8vb25seSB3aGVuIG1haW4gbW9kZWwgZXhpc3RzICwgYW5kIGhvc3Qgb2YgdGhlIG9iamVjdCBleGlzdHMKCQkJCQkJLy90aGVuIGNyZWF0ZSBzaGFkb3cKCQkJCQkJaWYgKGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5ICYmICFzaGFkb3dSb290W3NoYWRvd0tleV0gJiYKCQkJCQkJICAgIHJ0biAhPSBzaGFkb3dOYW1lc3BhY2UgJiYgIWlzVW5kZWZpbmVkKCBtYWluVmFsdWUgPSByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoKCQkJCQkJCXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSA9IHt9OwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiAhbG9naWNhbFBhdGggPyBydG4gOgoJCQkJCXJ0biA/IHJ0biArICIuIiArIGxvZ2ljYWxQYXRoIDoKCQkJCQkJbG9naWNhbFBhdGg7CgkJCX0sCgkJCXRvTG9naWNhbFBhdGg6IHRvTG9naWNhbFBhdGggPSBmdW5jdGlvbiggcGh5c2ljYWxQYXRoICkgewoKCQkJCXZhciBpbmRleCwgbG9naWNhbFBhdGgsIG1haW5QYXRoLCBtYXRjaDsKCgkJCQlpZiAocGh5c2ljYWxQYXRoID09PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJCQlyZXR1cm4gIioiOwoJCQkJfQoKCQkJCW1hdGNoID0gclNoYWRvd0tleS5leGVjKCBwaHlzaWNhbFBhdGggKTsKCQkJCWlmIChtYXRjaCkgewoJCQkJCS8vIGlmIHBoeXNpY2FsIHBhdGggaXMgbGlrZSBfX2htLmtleS54CgkJCQkJLy8gY29udmVydCB0aGUga2V5IHBhdGggaW50byBtYWluUGF0aAoJCQkJCWluZGV4ID0gUmVnRXhwLnJpZ2h0Q29udGV4dDsKCQkJCQltYWluUGF0aCA9IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBtYXRjaFsxXSApOwoJCQkJCWxvZ2ljYWxQYXRoID0gbWFpblBhdGggKyAiKiIgKyBpbmRleDsKCQkJCQlyZXR1cm4gdG9Mb2dpY2FsUGF0aCggbG9naWNhbFBhdGggKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlyZXR1cm4gcGh5c2ljYWxQYXRoOwoJCQkJfQoKCQkJfSwKCgkJCS8qam9pbiB0aGUgY29udGV4dCBhbmQgc3ViUGF0aCB0b2dldGhlciwgaWYgcGF0aCBpcyBub3QgbmVjZXNzYXJ5IHRoZSBzYW1lIGFzIGxvZ2ljYWwgcGF0aAoJCQkgKmNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggYnkgZGVmYXVsdCBpcyB0cnVlLCBzbyB0aGF0IGlmIHlvdSBzcGVjaWZ5IHN1YlBhdGggYXMgImIiCgkJCSAqIGFuZCAgY29udGV4dCBpcyAiYSIsIGl0IHdpbGwgYmUgbWVyZ2VkIHRvICJhLmIiIC4gSWYgZXhwbGljaXRseSBzcGVjaWZ5CgkJCSAqIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggdG8gZmFsc2UsIHRoZXkgd2lsbCBub3QgYmUgbWVyZ2VkLCBzbyB0aGUgImIiIHdpbGwgYmUKCQkJICogcmV0dXJuZWQgYXMgbWVyZ2UgcGF0aCovCgkJCW1lcmdlUGF0aDogbWVyZ2VQYXRoID0gZnVuY3Rpb24oIGNvbnRleHRQYXRoLCBzdWJQYXRoLCBjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoCgkJCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qdXNlZCBpbnRlcm5hbGx5Ki8gKSB7CgkJCQlpZiAoc3ViUGF0aCA9PSAiXyIpIHsKCgkJCQkJcmV0dXJuICJfIjsKCgkJCQl9IGVsc2UgaWYgKGNvbnRleHRQYXRoID09ICJfIikgewoKCQkJCQlpZiAoc3ViUGF0aCAmJiBzdWJQYXRoLnN0YXJ0c1dpdGgoICIvIiApKSB7CgoJCQkJCQljb250ZXh0UGF0aCA9ICIiOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJcmV0dXJuICJfIjsKCQkJCQl9CgkJCQl9CgoJCQkJY29udGV4dFBhdGggPSB0b1BoeXNpY2FsUGF0aCggY29udGV4dFBhdGggKTsKCgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAoIWlzVW5kZWZpbmVkKCBzdWJQYXRoICkgJiYgc3ViUGF0aCAhPT0gbnVsbCkgewoJCQkJCXN1YlBhdGggPSBzdWJQYXRoICsgIiI7CgkJCQkJaWYgKHN1YlBhdGguc3RhcnRzV2l0aCggIi8iICkpIHsKCQkJCQkJcmV0dXJuIHN1YlBhdGguc3Vic3RyKCAxICk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGlzVW5kZWZpbmVkKCBjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoICkpIHsKCQkJCQljb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoID0gdHJ1ZTsKCQkJCX0KCgkJCQlpZiAoY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCAmJiBzdWJQYXRoICYmIGNvbnRleHRQYXRoICYmICFyQmVnaW5Eb3RPclN0YXIudGVzdCggc3ViUGF0aCApKSB7CgkJCQkJc3ViUGF0aCA9ICIuIiArIHN1YlBhdGg7CgkJCQl9CgoJCQkJaWYgKCFzdWJQYXRoIHx8IHN1YlBhdGggPT0gIi4iKSB7CgoJCQkJCXJldHVybiBjb250ZXh0UGF0aDsKCgkJCQl9IGVsc2UgaWYgKCFyQmVnaW5Eb3RPclN0YXIudGVzdCggc3ViUGF0aCApKSB7CgoJCQkJCXJldHVybiBzdWJQYXRoOwoKCQkJCX0gZWxzZSBpZiAoKG1hdGNoID0gclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dC5leGVjKCBzdWJQYXRoICkpKSB7CgkJCQkJLy9pZiBzdWJQYXRoIGlzIGxpa2UgLi54eXogb3IgLip4eXoKCQkJCQl2YXIgc3RlcHNUb0dvVXAgPSAxICsgKG1hdGNoWzFdID8gbWF0Y2hbMV0ubGVuZ3RoIDogMCksCgkJCQkJCXJlbWFpbmluZyA9IFJlZ0V4cC5yaWdodENvbnRleHQsCgkJCQkJCW1lcmdlZENvbnRleHQgPSBjb250ZXh0UGF0aDsKCgkJCQkJd2hpbGUgKHN0ZXBzVG9Hb1VwKSB7CgkJCQkJCW1lcmdlZENvbnRleHQgPSBjb250ZXh0T2ZQYXRoKCBtZXJnZWRDb250ZXh0ICk7CgkJCQkJCXN0ZXBzVG9Hb1VwLS07CgkJCQkJfQoKCQkJCQkvL3VzZSBydWxlJ3MgY29udGV4dCBhcyBjb250ZXh0CgkJCQkJLy8uLiBvciAuKgoJCQkJCS8vJDIgaXMgZWl0aGVyICIuIiBvciAiKiIKCQkJCQlyZXR1cm4gcmVtYWluaW5nID8KCQkJCQkJKG1lcmdlZENvbnRleHQgPyBtZXJnZWRDb250ZXh0ICsgbWF0Y2hbMl0gKyByZW1haW5pbmcgOiByZW1haW5pbmcpIDoKCQkJCQkJKG1hdGNoWzJdID09PSAiKiIgPyBtZXJnZWRDb250ZXh0ICsgIioiIDogbWVyZ2VkQ29udGV4dCk7CgoJCQkJCS8vaWYgc3ViUGF0aCBpcyBsaWtlIC5hYiBvciAqYWIKCQkJCX0gZWxzZSBpZiAoKG1hdGNoID0gck1haW5QYXRoLmV4ZWMoIHN1YlBhdGggKSkpIHsKCgkJCQkJcmV0dXJuIG1lcmdlUGF0aCggZ2V0TWFpblBhdGgoIGNvbnRleHRQYXRoICksIG1hdGNoWzFdICk7CgoJCQkJfQoJCQkJcmV0dXJuIGNvbnRleHRQYXRoICsgc3ViUGF0aDsKCQkJfSwKCgkJCWlzVW5kZWZpbmVkOiBpc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKCBvYmogKSB7CgkJCQlyZXR1cm4gKG9iaiA9PT0gdW5kZWZpbmVkKTsKCQkJfSwKCQkJaXNQcmltaXRpdmU6IGlzUHJpbWl0aXZlID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCXJldHVybiAob2JqID09PSBudWxsICkgfHwgKHR5cGVvZihvYmopIGluIHByaW1pdGl2ZVR5cGVzKTsKCQkJfSwKCQkJaXNTdHJpbmc6IGlzU3RyaW5nID0gZnVuY3Rpb24oIHZhbCApIHsKCQkJCXJldHVybiB0eXBlb2YgdmFsID09PSAic3RyaW5nIjsKCQkJfSwKCQkJaXNPYmplY3Q6IGlzT2JqZWN0ID0gZnVuY3Rpb24oIHZhbCApIHsKCQkJCXJldHVybiAkLnR5cGUoIHZhbCApID09PSAib2JqZWN0IjsKCQkJfSwKCQkJaXNCb29sZWFuOiBpc0Jvb2xlYW4gPSBmdW5jdGlvbiggb2JqZWN0ICkgewoJCQkJcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJib29sZWFuIjsKCQkJfSwKCQkJdG9UeXBlZFZhbHVlOiB0b1R5cGVkVmFsdWUgPSBmdW5jdGlvbiggc3RyaW5nVmFsdWUgKSB7CgkJCQlpZiAoaXNTdHJpbmcoIHN0cmluZ1ZhbHVlICkpIHsKCQkJCQlzdHJpbmdWYWx1ZSA9ICQudHJpbSggc3RyaW5nVmFsdWUgKTsKCQkJCQl0cnkgewoJCQkJCQlzdHJpbmdWYWx1ZSA9IHN0cmluZ1ZhbHVlID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQkJCXN0cmluZ1ZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCQkJCXN0cmluZ1ZhbHVlID09PSAibnVsbCIgPyBudWxsIDoKCQkJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJ1bmRlZmluZWQiID8gdW5kZWZpbmVkIDoKCQkJCQkJCQkJCWlzTnVtZXJpYyggc3RyaW5nVmFsdWUgKSA/IHBhcnNlRmxvYXQoIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCS8vRGF0ZS5wYXJzZSggc3RyaW5nVmFsdWUgKSA/IG5ldyBEYXRlKCBzdHJpbmdWYWx1ZSApIDoKCQkJCQkJCQkJCQlySlNPTi50ZXN0KCBzdHJpbmdWYWx1ZSApID8gJC5wYXJzZUpTT04oIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCQlzdHJpbmdWYWx1ZTsKCQkJCQl9IGNhdGNoIChlKSB7fQoJCQkJfQoJCQkJcmV0dXJuIHN0cmluZ1ZhbHVlOwoJCQl9LAoJCQlpc1Byb21pc2U6IGlzUHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJCQlyZXR1cm4gISEob2JqZWN0ICYmIG9iamVjdC5wcm9taXNlICYmIG9iamVjdC5kb25lICYmIG9iamVjdC5mYWlsKTsKCQkJfSwKCQkJY2xlYXJPYmo6IGNsZWFyT2JqID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCWlmIChpc1ByaW1pdGl2ZSggb2JqICkpIHsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJCWZvciAodmFyIGtleSBpbiBvYmopIHsKCQkJCQlpZiAoaGFzT3duLmNhbGwoIG9iaiwga2V5ICkpIHsKCQkJCQkJb2JqW2tleV0gPSBjbGVhck9iaiggb2JqW2tleV0gKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gb2JqOwoJCQl9LAoJCQljbG9uZTogY2xvbmUgPSBmdW5jdGlvbiggb3JpZ2luYWwsIGRlZXBDbG9uZSApIHsKCQkJCXJldHVybiBpc1ByaW1pdGl2ZSggb3JpZ2luYWwgKSA/IG9yaWdpbmFsIDoKCQkJCQlpc0FycmF5KCBvcmlnaW5hbCApID8gb3JpZ2luYWwuc2xpY2UoIDAgKSA6CgkJCQkJCWlzRnVuY3Rpb24oIG9yaWdpbmFsICkgPyBvcmlnaW5hbCA6CgkJCQkJCQlleHRlbmQoICEhZGVlcENsb25lLCB7fSwgb3JpZ2luYWwgKTsKCQkJfSwKCgkJCWxvY2FsOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCQlyZXR1cm4gSlNPTi5wYXJzZSggbG9jYWxTdG9yYWdlLmdldEl0ZW0oIGtleSApICk7CgkJCQl9IGVsc2UgewoJCQkJCWlmIChpc1VuZGVmaW5lZCggdmFsdWUgKSkgewoJCQkJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgga2V5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIGtleSwgSlNPTi5zdHJpbmdpZnkoIHZhbHVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl0b1N0cmluZzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJcmV0dXJuICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogIiIgKyB2YWx1ZTsKCQkJfSwKCgoJCQllbmNvZGVIdG1sOiBmdW5jdGlvbiggc3RyICkgewoJCQkJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7CgkJCQlkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBzdHIgKSApOwoJCQkJcmV0dXJuIGRpdi5pbm5lckhUTUw7CgkJCX0KCgkJfSwKCgkJLy90aGlzIGlzIHVzZWQgdG8gcHJvY2VzcyB0aGUgbmV3IG5vZGUgYWRkZWQgdG8gcmVwb3NpdG9yeQoJCW9uQWRkT3JVcGRhdGVOb2RlOiBmdW5jdGlvbiggZm4gKSB7CgkJCWlmIChmbikgewoJCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzLnB1c2goIGZuICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvbkFkZE9yVXBkYXRlSGFuZGxlcnM7CgkJCX0KCQl9LAoKCQlvbkRlbGV0ZU5vZGU6IGZ1bmN0aW9uKCBmbiApIHsKCQkJaWYgKGZuKSB7CgkJCQlvbkRlbGV0ZUhhbmRsZXJzLnB1c2goIGZuICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvbkRlbGV0ZUhhbmRsZXJzOwoJCQl9CgkJfSwKCgkJLy91c2UgdGhpcyBmb3IgY29uZmlndXJlIG9wdGlvbnMKCQlvcHRpb25zOiBkZWZhdWx0T3B0aW9ucwoJfSApOwoKCXZhciBvbkRlbGV0ZUhhbmRsZXJzID0gWwoJCWZ1bmN0aW9uIC8qcmVtb3ZlTW9kZWxMaW5rc0FuZFNoYWRvd3MqLyAoIHBoeXNpY2FsUGF0aCwgcmVtb3ZlZFZhbHVlICkgewoKCQkJdmFyIHdhdGNoZWRQYXRoLAoJCQkJbWFpblBhdGgsCgkJCQlwaHlzaWNhbFBhdGhPZlNoYWRvdywKCQkJCWxvZ2ljYWxTaGFkb3dQYXRoLAoJCQkJbG9naWNhbFBhdGggPSB0b0xvZ2ljYWxQYXRoKCBwaHlzaWNhbFBhdGggKTsKCgkJCS8vcmVtb3ZlIG1vZGVsTGlua3Mgd2hvc2UgcHVibGlzaGVyUGF0aCA9PSBwaHlzaWNhbFBhdGgKCQkJZm9yICh3YXRjaGVkUGF0aCBpbiB3YXRjaFRhYmxlKSB7CgkJCQl1bndhdGNoKCBwaHlzaWNhbFBhdGgsIHdhdGNoZWRQYXRoICk7CgkJCX0KCgkJCS8vcmVtb3ZlIG1vZGVsTGlua3Mgd2hvc2Ugc3Vic2NyaWJlciA9PSBwaHlzaWNhbFBhdGgKCQkJZm9yICh3YXRjaGVkUGF0aCBpbiB3YXRjaFRhYmxlKSB7CgkJCQlpZiAod2F0Y2hlZFBhdGguc3RhcnRzV2l0aCggcGh5c2ljYWxQYXRoICkpIHsKCQkJCQlkZWxldGUgd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJCQl9CgkJCX0KCgkJCS8vZGVsZXRlIHNoYWRvdyBvYmplY3RzLAoJCQkvLyB3aGljaCBhcmUgdW5kZXIgdGhlIGRpcmVjdCBzaGFkb3cgb2YgbWFpbiBwYXRoCgkJCWZvciAobWFpblBhdGggaW4gc2hhZG93Um9vdCkgewoKCQkJCXBoeXNpY2FsUGF0aE9mU2hhZG93ID0gc2hhZG93TmFtZXNwYWNlICsgIi4iICsgbWFpblBhdGg7CgkJCQlsb2dpY2FsU2hhZG93UGF0aCA9IHRvTG9naWNhbFBhdGgoIHBoeXNpY2FsUGF0aE9mU2hhZG93ICk7CgoJCQkJaWYgKGxvZ2ljYWxTaGFkb3dQYXRoID09IGxvZ2ljYWxQYXRoIHx8CgkJCQkgICAgbG9naWNhbFNoYWRvd1BhdGguc3RhcnRzV2l0aCggbG9naWNhbFBhdGggKyAiKiIgKSB8fAoJCQkJICAgIGxvZ2ljYWxTaGFkb3dQYXRoLnN0YXJ0c1dpdGgoIGxvZ2ljYWxQYXRoICsgIi4iICkpIHsKCQkJCQlyb290Tm9kZS5kZWwoIHBoeXNpY2FsUGF0aE9mU2hhZG93ICk7CgkJCQl9CgkJCX0KCQl9CgldOwoKCSQoICJnZXQsc2V0LGRlbCxleHRlbmQiLnNwbGl0KCAiLCIgKSApLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7CgkJaG1bdmFsdWVdID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiByb290Tm9kZVt2YWx1ZV0uYXBwbHkoIHJvb3ROb2RlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCX07Cgl9ICk7CgoJcm9vdE5vZGUgPSBobSgpOwoKCSRmbi5obURhdGEgPSBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgoJCXZhciBkYXRhID0gdGhpcy5kYXRhKCAiaG1EYXRhIiApOwoKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoKCQkJcmV0dXJuIGRhdGE7CgoJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoKCQkJcmV0dXJuIGRhdGEgJiYgZGF0YVtuYW1lXTsKCgkJfSBlbHNlIHsKCQkJLy9hcmd1bWVudHMubGVuZ3RoID09IDIKCQkJaWYgKGlzVW5kZWZpbmVkKCBkYXRhICkpIHsKCQkJCXRoaXMuZGF0YSggImhtRGF0YSIsIGRhdGEgPSB7fSApOwoJCQl9CgkJCWRhdGFbbmFtZV0gPSB2YWx1ZTsKCQl9Cgl9OwoKCS8qCXBhdGhzV2F0Y2hpbmc6IGZ1bmN0aW9uKCkgewoJIHZhciBrZXksIGxpbmtzLCBydG4gPSBbXSwgcGF0aCA9IHRoaXMucGF0aDsKCSBmb3IgKGtleSBpbiBtb2RlbExpbmtzKSB7CgkgbGlua3MgPSBtb2RlbExpbmtzW2tleV07CgkgaWYgKGxpbmtzLmNvbnRhaW5zKCBwYXRoICkpIHsKCSBydG4ucHVzaCgga2V5ICk7CgkgfQoJIH0KCSByZXR1cm4gcnRuOwoJIH0sCgoJICwqLwoKCgovLzxAZGVwZW5kcz5tb2RlbC5qczwvQGRlcGVuZHM+CgoKCgl2YXIgd29ya2Zsb3dTdG9yZSwKCQlyU3BhY2VzID0gL1sgXSsvLAoJCXJFbmRXaXRoU3RhckRvdCA9IC9cKlwuJC8sCgkJckRvdE9yU3RhciA9IC9cLnxcKi9nLAoJLy9yT3JpZ2luYWxFdmVudCA9IC9eKC4rPykoXC5cZCspPyQvLAoJCXN1YnNjcmlwdGlvbk1hbmFnZXIsCgkJdmlld0lkID0gMCwKCQlySW5pdCA9IC9pbml0KFxkKikvLAoJCXdvcmtmbG93LAoJLy90aGUgaGFuZGxlciBzdHJpbmcgc2hvdWxkIGJlIGxpa2UKCS8vICJnZXQgc2V0IGNvbnZlcnQgZmluYWxpemUgaW5pdGlhbGl6ZSIKCQlhY3Rpdml0eVR5cGVzID0gImdldCxzZXQsY29udmVydCxmaW5hbGl6ZSxpbml0aWFsaXplIi5zcGxpdCggIiwiICk7CgoJZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIHJldHVyblRydWUoKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJZnVuY3Rpb24gRXZlbnQoIHB1Ymxpc2hlciwgb3JpZ2luYWxQdWJsaXNoZXIsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKSB7CgkJdGhpcy5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICk7CgkJdGhpcy5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBvcmlnaW5hbFB1Ymxpc2hlciApOwoJCXRoaXMudHlwZSA9IGV2ZW50VHlwZTsKCQl0aGlzLm9yaWdpbmFsVHlwZSA9IGV2ZW50VHlwZTsKCQl0aGlzLnByb3Bvc2VkID0gcHJvcG9zZWQ7CgkJdGhpcy5yZW1vdmVkID0gcmVtb3ZlZDsKCX0KCglFdmVudC5wcm90b3R5cGUgPSB7CgkJY29uc3RydWN0b3I6IEV2ZW50LAoKCQkvKglpc09yaWdpbmFsOiBmdW5jdGlvbigpIHsKCQkgcmV0dXJuIHRoaXMucHVibGlzaGVyLnBhdGggPT0gdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOwoJCSB9LAoKCQkgaXNCdWJibGVVcDogZnVuY3Rpb24oKSB7CgkJIHJldHVybiAodGhpcy5wdWJsaXNoZXIucGF0aCAhPSB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgpICYmCgkJICh0aGlzLnB1Ymxpc2hlci5wYXRoLnN0YXJ0c1dpdGgoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGF0aCApKTsKCQkgfSwqLwoJCWlzRGVwZW5kZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICghdGhpcy5wdWJsaXNoZXIucGF0aC5zdGFydHNXaXRoKCB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggKSk7CgkJfSwKCgkJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJfSwKCgkJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCQl0aGlzLmlzQ2FzY2FkZVN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCX0sCgoJCXN0b3BDYXNjYWRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pc0Nhc2NhZGVTdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQllcnJvcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaGFzRXJyb3IgPSByZXR1cm5UcnVlOwoJCX0sCgoJCWFib3J0OiBhYm9ydCwKCQlpc0Nhc2NhZGVTdG9wcGVkOiByZXR1cm5GYWxzZSwKCQlpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCgkJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJCWlzQWJvcnRlZDogcmV0dXJuRmFsc2UsCgkJaGFzRXJyb3I6IHJldHVybkZhbHNlLAoJCWxldmVsOiAwCgl9OwoKCS8vIHJhaXNlIG1vZGVsIGV2ZW50LAoJdHJpZ2dlciA9IGZ1bmN0aW9uKCBwYXRoLCBvcmlnaW5hbFBhdGgsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKSB7CgoJCXZhciBlID0gbmV3IEV2ZW50KCBwYXRoLCBvcmlnaW5hbFBhdGgsIGV2ZW50VHlwZSwgcHJvcG9zZWQsIHJlbW92ZWQgKTsKCgkJLy9ldmVudCBjYW4gYmUgY2hhbmdlZCBpbnNpZGUgdGhlIGZ1bmN0aW9uCgkJY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKTsKCgkJaWYgKCFlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgJiYgZS5wdWJsaXNoZXIucGF0aCkgewoKCQkJaWYgKGUuaXNEZXBlbmRlbnQoKSkgewoJCQkJLy9pZiBpcyBkZXBlbmRlbnQgZXZlbnQsIHRoZSBvcmlnaW5hbCBldmVudCBoYXMgYmVlbgoJCQkJLy8gYnViYmxlZCB1cCBpbiBpdHMgZGlyZWN0IGhpZXJhcmNoeQoJCQkJLy93ZSBuZWVkIHRvIGNoYW5nZSB0aGUgaGllcmFyY2h5IGJ5IHNldHRpbmcgdGhlIHRhcmdldAoJCQkJZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoID0gZS5wdWJsaXNoZXIucGF0aDsKCQkJfQoKCQkJLy9jb250aW51ZSB0byB0aGUgc2FtZSBpbnN0YW5jZSBvZiBldmVudCBvYmplY3QKCQkJZG8gewoKCQkJCWUucHVibGlzaGVyLnBhdGggPSBlLnB1Ymxpc2hlci5wYXRoQ29udGV4dCgpOwoJCQkJZS5sZXZlbCsrOwoJCQkJZS50eXBlID0gZS5vcmlnaW5hbFR5cGUgKyAiLiIgKyBlLmxldmVsOwoJCQkJY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKTsKCgkJCX0gd2hpbGUgKCFlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgJiYgZS5wdWJsaXNoZXIucGF0aCk7CgkJfQoKCQkvL3Jlc3RvcmUgcHJldmlvdXMgdmFsdWVzCgkJZS50eXBlID0gZXZlbnRUeXBlOwoJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCA9IG9yaWdpbmFsUGF0aDsKCQllLnB1Ymxpc2hlci5wYXRoID0gcGF0aDsKCQlyZXR1cm4gZTsKCX07CgoKCXN1YnNjcmlwdGlvbk1hbmFnZXIgPSAoZnVuY3Rpb24oKSB7CgoJCXZhciBzdWJzY3JpcHRpb25TdG9yZSA9IFsgXTsKCgkJLy90YXJnZXQgaXMgZWl0aGVyIHB1Ymxpc2hlciBvciBzdWJzY3JpYmVyCgkJZnVuY3Rpb24gY2FuUmVtb3ZlU3Vic2NyaXB0aW9uRGF0YSggdGFyZ2V0LCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJCWlmICh0YXJnZXQgPT09IHB1Ymxpc2hlciB8fCB0YXJnZXQgPT09IHN1YnNjcmliZXIpIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9IGVsc2UgewoJCQkJLy9pZiB0YXJnZXQgaXMgbW9kZWwgcGF0aAoJCQkJaWYgKGlzU3RyaW5nKCB0YXJnZXQgKSkgewoJCQkJCXJldHVybiAoIGlzU3RyaW5nKCBwdWJsaXNoZXIgKSAmJiBwdWJsaXNoZXIuc3RhcnRzV2l0aCggdGFyZ2V0ICsgIi4iICkpIHx8CgkJCQkJICAgICAgICggaXNTdHJpbmcoIHN1YnNjcmliZXIgKSAmJiBzdWJzY3JpYmVyLnN0YXJ0c1dpdGgoIHRhcmdldCArICIuIiApKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gZ2V0U3Vic2NyaXB0aW9uc0J5KCB0YXJnZXQsIG1hdGNoICkgewoJCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgkJCQl0YXJnZXQgPSB0b1BoeXNpY2FsUGF0aCggdGFyZ2V0ICk7CgkJCX0KCgkJCXZhciBydG4gPSBbXTsKCQkJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGkgPCBzdWJzY3JpcHRpb25TdG9yZS5sZW5ndGg7IGkrKykgewoJCQkJaXRlbSA9IHN1YnNjcmlwdGlvblN0b3JlW2ldOwoJCQkJaWYgKG1hdGNoKCBpdGVtLCB0YXJnZXQgKSkgewoJCQkJCXJ0bi5wdXNoKCBpdGVtICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJCXJldHVybiB7CgoJCQkvL3N1YnNjcmlwdGlvbnMgd2hvc2UgcHVibGlzaGVyIGlzIHRoZSBwYXJhbWV0ZXIKCQkJLy9wdWJsaXNoZXIgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5UHVibGlzaGVyOiBmdW5jdGlvbiggcHVibGlzaGVyICkgewoJCQkJcmV0dXJuIGdldFN1YnNjcmlwdGlvbnNCeSggcHVibGlzaGVyLCBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnB1Ymxpc2hlciA9PSB0YXJnZXQ7CgkJCQl9ICk7CgkJCX0sCgoJCQkvL3N1YnNjcmlwdGlvbnMgd2hvc2Ugc3Vic2NyaWJlciBpcyB0aGUgcGFyYW1ldGVyCgkJCS8vc3Vic2NyaWJlciBjYW4gYmUgYSBtb2RlbCBwYXRoIG9yIGRvbSBlbGVtZW50LCBvciBvYmplY3QKCQkJZ2V0QnlTdWJzY3JpYmVyOiBmdW5jdGlvbiggc3Vic2NyaWJlciApIHsKCQkJCXJldHVybiBnZXRTdWJzY3JpcHRpb25zQnkoIHN1YnNjcmliZXIsIGZ1bmN0aW9uKCBpdGVtLCB0YXJnZXQgKSB7CgkJCQkJcmV0dXJuIGl0ZW0uc3Vic2NyaWJlciA9PSB0YXJnZXQ7CgkJCQl9ICk7CgkJCX0sCgoJCQkvL29iamVjdCBjYW4gYmUgYSBtb2RlbCBwYXRoIG9yIGRvbSBlbGVtZW50LCBvciBvYmplY3QKCQkJZ2V0Qnk6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIgKSB7CgkJCQlyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIGZ1bmN0aW9uIG1hdGNoKCBpdGVtLCB0YXJnZXQgKSB7CgkJCQkJcmV0dXJuIGl0ZW0uc3Vic2NyaWJlciA9PSB0YXJnZXQgfHwgaXRlbS5wdWJsaXNoZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0QWxsOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzdWJzY3JpcHRpb25TdG9yZTsKCQkJfSwKCgkJCWFkZDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApIHsKCQkJCWlmIChpc1N0cmluZyggcHVibGlzaGVyICkpIHsKCgkJCQkJdmFyIGV2ZW50cyA9IGV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKTsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgc3BlY2lhbCA9IHRoaXMuc3BlY2lhbFtldmVudHNbaV1dOwoJCQkJCQlzcGVjaWFsICYmIHNwZWNpYWwuc2V0dXAgJiYgc3BlY2lhbC5zZXR1cCggc3Vic2NyaWJlciwgcHVibGlzaGVyICk7CgkJCQkJfQoJCQkJfQoKCQkJCXN1YnNjcmlwdGlvblN0b3JlLnB1c2goIHsKCQkJCQlwdWJsaXNoZXI6IHB1Ymxpc2hlciwKCQkJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyLAoJCQkJCWV2ZW50VHlwZXM6IGV2ZW50VHlwZXMsCgkJCQkJaGFuZGxlcjogaGFuZGxlcgoJCQkJfSApOwoJCQl9LAoKCQkJcmVtb3ZlQnk6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIgKSB7CgoJCQkJdmFyIGksCgkJCQkJaiwKCQkJCQlzcGVjaWFsLAoJCQkJCXN1YnNjcmlwdGlvbiwKCQkJCQloYW5kbGVyLAoJCQkJCXN1YnNjcmlwdGlvbnNSZW1vdmVkID0gW107CgoJCQkJZm9yIChpID0gc3Vic2NyaXB0aW9uU3RvcmUubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQlzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25TdG9yZVtpXTsKCQkJCQloYW5kbGVyID0gc3Vic2NyaXB0aW9uLmhhbmRsZXI7CgoJCQkJCWlmIChjYW5SZW1vdmVTdWJzY3JpcHRpb25EYXRhKCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIsIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICkpIHsKCgkJCQkJCS8vaWYgcHVibGlzaGVyIGlzIGFuIHZpZXcgb2JqZWN0LCBuZWVkIHRvIHVuYmluZCBvciB1bmRlbGVnYXRlCgkJCQkJCS8vdGhlIGpRdWVyeSBldmVudCBoYW5kbGVyCgkJCQkJCWlmICghaXNTdHJpbmcoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSkgewoJCQkJCQkJaWYgKGhhbmRsZXIuZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCQkJCSQoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKS51bmRlbGVnYXRlKCBoYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IsIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCSQoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKS51bmJpbmQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJc3Vic2NyaXB0aW9uc1JlbW92ZWQucHVzaCggc3Vic2NyaXB0aW9uU3RvcmUuc3BsaWNlKCBpLCAxIClbMF0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJZm9yIChpID0gc3Vic2NyaXB0aW9uc1JlbW92ZWQubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQlzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zUmVtb3ZlZFtpXTsKCQkJCQlpZiAoaXNTdHJpbmcoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSkgewoJCQkJCQl2YXIgZXZlbnRzID0gc3Vic2NyaXB0aW9uLmV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKTsKCQkJCQkJZm9yIChqID0gMDsgaiA8IGV2ZW50cy5sZW5ndGg7IGorKykgewoJCQkJCQkJc3BlY2lhbCA9IHRoaXMuc3BlY2lhbFtldmVudHNbal1dOwoJCQkJCQkJc3BlY2lhbCAmJiBzcGVjaWFsLnRlYXJkb3duICYmIHNwZWNpYWwudGVhcmRvd24oIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyLCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlzcGVjaWFsOiB7CgkJCQkvKnZhbGlkaXR5Q2hhbmdlZDogewoJCQkJIHNldHVwOiBmdW5jdGlvbiAocHVibGlzaGVyLCBzdWJzY3JpYmVyKSB7fSwKCQkJCSB0ZWFyZG93bjogZnVuY3Rpb24gKHB1Ymxpc2hlciwgc3Vic2NyaWJlcikge30KCQkJCSB9CgkJCQkgKi8KCQkJfQoKCQl9OwoJfSkoKTsKCglmdW5jdGlvbiBnZXRNZW1iZXIoIGUgKSB7CgoJCXZhciBoYW5kbGVyID0gZS5oYW5kbGVyLAoJCQlwcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLmdldE5hbWUsCgkJLy9nZXRTdWJQcm9wZXJ0eSBpcyB1c2VkIGZvciBwcm9wZXJ0aWVzIGxpa2UgY3NzLCBhdHRyLCBwcm9wCgkJCXN1YlByb3BlcnR5TmFtZSA9IGhhbmRsZXIuZ2V0UGFyYXMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlyZXR1cm4gc3ViUHJvcGVydHlOYW1lID8gcHVibGlzaGVyW3Byb3BlcnR5TmFtZV0oIHN1YlByb3BlcnR5TmFtZSApIDoKCQkJaXNGdW5jdGlvbiggcHVibGlzaGVyW3Byb3BlcnR5TmFtZV0gKSA/IHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdKCkgOgoJCQkJcHVibGlzaGVyW3Byb3BlcnR5TmFtZV07Cgl9CgoJZnVuY3Rpb24gc2V0TWVtYmVyKCB2YWx1ZSwgZSApIHsKCQl2YXIgaGFuZGxlciA9IGUuaGFuZGxlciwKCQkJcHJvcGVydHlOYW1lID0gaGFuZGxlci5zZXROYW1lLAoJCS8vc2V0U3ViUHJvcGVydHkgaXMgdXNlZCBmb3IgcHJvcGVydGllcyBsaWtlIGNzcywgYXR0ciwgcHJvcAoJCQlzdWJQcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLnNldFBhcmFzLAoJCQlzdWJzY3JpYmVyID0gdGhpczsKCgkJc3ViUHJvcGVydHlOYW1lID8gc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdKCBzdWJQcm9wZXJ0eU5hbWUsIHZhbHVlICkgOgoJCQlpc0Z1bmN0aW9uKCBzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0gKSA/IHN1YnNjcmliZXJbcHJvcGVydHlOYW1lXSggdmFsdWUgKSA6CgkJCQlzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKCX0KCglleHRlbmQoIGhtLCB7CgoJCS8vRXZlbnQ6IEV2ZW50LAoKCQl0cmlnZ2VyOiB0cmlnZ2VyLAoKCQlzdWJzY3JpcHRpb246IHN1YnNjcmlwdGlvbk1hbmFnZXIsCgoJCS8vaGFuZGxlciBjYW4gYmUgYSBmdW5jdGlvbiAoZSkge30KCQkvLyBhIHN0cmluZyBsaWtlICJnZXQgc2V0IGNvbnZlcnQgaW50IgoJCS8vb3IgIipnZXQgKnNldCAqY29udmVydCAqaW50IgoJCS8vb3IgaXQgY2FuIGJlICIqY29tbW9uSGFuZGxlciIKCQkvL29yIGl0IGNhbiBiZSB7IGdldDp4eCwgc2V0Onh4LCBjb252ZXJ0Onh4LCBpbml0aWFsaXplOiB4eH0KCQkvL2l0IGNhbiBiZSBhIGphdmFzY3JpcHQgb2JqZWN0LCBkb20gZWxlbWVudCwgYnV0IGl0IGNhbiBub3QgYmUgYSBqUXVlcnkgb2JqZWN0CgkJLy9zdWJzY3JpYmVyIGNhbiBiZSBudWxsLCAiXyIsICJudWxsIiwgdW5kZWZpbmVkIHRvIHJlcHJlc2VudCBhIGNhc2Ugd2hlcmUgdGhlcmUgaXMgbm90IHN1YnNjcmliZXIKCQkvL2lmIHN1YnNjcmliZXIgaXMgIiIsIGl0IG1lYW5zIHRoZSB0aGUgcm9vdCBtb2RlbCwgdGhlIHJlcG9zaXRvcnkgb2JqZWN0CgkJc3ViOiBmdW5jdGlvbiggc3Vic2NyaWJlciwgcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoKCQkJaWYgKHN1YnNjcmliZXIgaW5zdGFuY2VvZiBobSkgewoJCQkJc3Vic2NyaWJlciA9IHN1YnNjcmliZXIucGF0aDsKCQkJfQoKCQkJaWYgKHB1Ymxpc2hlciBpbnN0YW5jZW9mIGhtKSB7CgkJCQlwdWJsaXNoZXIgPSBwdWJsaXNoZXIucGF0aDsKCQkJfQoKCQkJaWYgKGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgJiYgc3Vic2NyaWJlci5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJc3Vic2NyaWJlciA9ICQoIHN1YnNjcmliZXIuc3Vic3RyKCAxICkgKTsKCQkJfQoKCQkJaWYgKHN1YnNjcmliZXIgJiYgc3Vic2NyaWJlci5qcXVlcnkpIHsKCQkJCS8vc3Vic2NyaWJlciBpcyBsaWtlICQoKQoJCQkJLy9uZWVkIHRvIGNvbnZlcnQgalF1ZXJ5IG9iamVjdCBpbnRvIGRvbSBvciByYXcgZWxlbWVudAoJCQkJaWYgKCFzdWJzY3JpYmVyLmxlbmd0aCAmJiAhc3Vic2NyaWJlci5zZWxlY3RvcikgewoJCQkJCXN1YnNjcmliZXIgPSBudWxsOwoJCQkJfSBlbHNlIHsKCQkJCQlzdWJzY3JpYmVyLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbWVudCApIHsKCQkJCQkJLy91bndyYXAgalF1ZXJ5IGVsZW1lbnQKCQkJCQkJaG0uc3ViKCBlbGVtZW50LCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKTsKCQkJCQl9ICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQlpZiAoaXNTdHJpbmcoIHB1Ymxpc2hlciApICYmIHB1Ymxpc2hlci5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJcHVibGlzaGVyID0gJCggcHVibGlzaGVyLnN1YnN0ciggMSApICk7CgkJCX0KCgkJCWlmIChwdWJsaXNoZXIgJiYgcHVibGlzaGVyLmpxdWVyeSkgewoJCQkJcHVibGlzaGVyLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbWVudCApIHsKCQkJCQlobS5zdWIoIHN1YnNjcmliZXIsIGVsZW1lbnQsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKTsKCQkJCX0gKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCFwdWJsaXNoZXIgJiYgcHVibGlzaGVyICE9PSAiIikgewoJCQkJdGhyb3cgInB1Ymxpc2hlciBjYW4gbm90IGJlIG51bGwiOwoJCQl9CgoJCQlpZiAoIWV2ZW50VHlwZXMpIHsKCQkJCXRocm93ICJldmVudFR5cGVzIGNhbiBub3QgYmUgbnVsbCI7CgkJCX0KCgkJCS8vYWxsb3cgc3Vic2NyaWJlciAiIiwgYmVjYXVzZSB0aGlzIGlzIHRoZSBwYXRoIG9mIHJvb3QgbW9kZWwKCQkJaWYgKHN1YnNjcmliZXIgPT09ICJfIiB8fCBzdWJzY3JpYmVyID09ICJudWxsIiB8fCBzdWJzY3JpYmVyID09PSBudWxsKSB7CgkJCQlzdWJzY3JpYmVyID0gdW5kZWZpbmVkOwoJCQl9CgoJCQlpZiAod29ya2Zsb3dPcHRpb25zID09PSAiXyIpIHsKCQkJCXdvcmtmbG93T3B0aW9ucyA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJdmFyIGlzUHVibGlzaGVyTW9kZWwgPSBpc1N0cmluZyggcHVibGlzaGVyICksCgkJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCQl2aWV3SWRNYW5hZ2VyLm1hcmsoIHB1Ymxpc2hlciApOwoJCQl2aWV3SWRNYW5hZ2VyLm1hcmsoIHN1YnNjcmliZXIgKTsKCgkJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgYSBtb2RlbAoJCQkJcHVibGlzaGVyID0gdG9QaHlzaWNhbFBhdGgoIHB1Ymxpc2hlciApOwoJCQl9CgoJCQlpZiAoaXNTdWJzY3JpYmVyTW9kZWwpIHsKCQkJCS8vc3Vic2NyaWJlciBpcyBhIG1vZGVsCgkJCQlzdWJzY3JpYmVyID0gdG9QaHlzaWNhbFBhdGgoIHN1YnNjcmliZXIgKTsKCgkJCX0KCgkJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgoJCQkJc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyLCBldmVudFR5cGVzLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zICk7CgoJCQl9IGVsc2UgewoKCQkJCXN1YnNjcmliZVZpZXdFdmVudCggcHVibGlzaGVyLCBldmVudFR5cGVzLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCX0KCQl9LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCAvKiBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlU2VsZWN0b3IgKi8gKSB7CgkJCXJldHVybiB0aGlzLnN1Yi5hcHBseSggdGhpcywgW251bGxdLmNvbmNhdCggc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX0sCgoJCS8vYSB3b3JrZmxvd1Byb3RvdHlwZSBjYW4gYmUgYSBzdHJpbmcgbGlrZSAiZ2V0IHNldCBjb252ZXJ0IGluaXRpYWxpemUgZmluYWxpemUiCgkJLy8gb3IgaXQgY2FuIGJlIGFuIG9iamVjdAoJCS8qCgkJIHsKCQkgZ2V0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBzZXQ6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGNvbnZlcnQ6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGluaXRpYWxpemU6ICJ4eCIgb3IgZnVuY3Rpb24gKCkge30sCgkJIGZpbmFsaXplOiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9CgkJIH0KCQkgKi8KCQl3b3JrZmxvdzogd29ya2Zsb3cgPSBmdW5jdGlvbiggbmFtZSwgd29ya2Zsb3dQcm90b3R5cGUgKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQl3b3JrZmxvd1N0b3JlW2tleV0gPSBidWlsZFdvcmtmbG93KCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBuYW1lICkpIHsKCQkJCXJldHVybiB3b3JrZmxvd1N0b3JlOwoJCQl9CgoJCQlpZiAoaXNVbmRlZmluZWQoIHdvcmtmbG93UHJvdG90eXBlICkpIHsKCQkJCXJldHVybiB3b3JrZmxvd1N0b3JlW25hbWVdOwoJCQl9CgoJCQl3b3JrZmxvd1N0b3JlW25hbWVdID0gYnVpbGRXb3JrZmxvdyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCQkJcmV0dXJuIHdvcmtmbG93U3RvcmVbbmFtZV07CgoJCX0sCgkJLy9jb21tb24gZ2V0dGVyIGFuZCBzZXR0ZXIgYXJlIHNwZWNpYWwgYWN0aXZpdHkgaW4gdGhleSB3YXkgdGhleSBhcmUgdXNlZAoJCS8vb3RoZXIgYWN0aXZpdGllcyB1c2UgdGhlIGtleSBkaXJlY3RseSB0byByZWZlcmVuY2UgdGhlIGFjdGl2aXRpZXMKCQkvLyBidXQgZ2V0dGVycyBhbmQgc2V0dGVycyBuZWVkIHRvIHVzZSAiKmtleSIgdG8gcmVmZXJlbmNlIGdldHRlcnMgYW5kIHNldHRlcnMKCQkvLyBpZiB5b3VyIGdldHRlci9zZXR0ZXIga2V5IGRvZXMgbm90IGJlZ2luIHdpdGggIioiLCB0aGVuIGl0IHdpbGwgdXNlIHRoZSBkZWZhdWx0R2V0CgkJLy9vciBkZWZhdWx0U2V0LCBhbmQgdGhleSBrZXkgd2lsbCBiZWNvbWUgdGhlIGdldFByb3BlcnR5LCBhbmQgb3B0aW9uYWxseSwKCQkvLyB1c2Ugb3B0aW9ucyB0byBwYXNzIHRoZSBnZXRQcm9wIHZhbHVlLCB0aGUgZGVmYXVsdEdldC9kZWZhdWx0U2V0CgkJLy8gYXJlIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5IGxpa2Ugb3RoZXIgY29tbW9uIGdldHRlcnMgb3Igc2V0dGVycwoJCWFjdGl2aXR5OiB7CgoJCQkvL2luaXRpYWxpemUoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgd29ya2Zsb3dPcHRpb25zICk7CgkJCS8vaW5zaWRlIGluaXRpYWxpemUgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgd2luZG93CgkJCWluaXRpYWxpemU6IHt9LAoKCQkJLy92YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJCS8vaW5zaWRlIHRoZSBnZXR0ZXIgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQkvL2dldChlKQoJCQlnZXQ6IHsKCQkJCWdldE1lbWJlcjogZ2V0TWVtYmVyLAoKCQkJCS8vdGhlIG9yaWdpbmFsIGdldCBpcyAiZ2V0IiBjdXJyZW50CgkJCQkvL2JlY2F1c2Ugb2YgZXZlbnQgYnViYmxpbmcsIHRoZSBkZWZhdWx0IGdldCBtZXRob2QgZm9yIG1vZGVsCgkJCQkvL3dpbGwgbm90IHJldHVybiB0aGUgdmFsdWUgeW91IHdhbnQsIHNvIG5lZWQgdG8gZ2V0T3JpZ2luYWwKCQkJCWdldE9yaWdpbmFsOiBmdW5jdGlvbiggZSApIHsKCQkJCQlyZXR1cm4gZS5vcmlnaW5hbFB1Ymxpc2hlci5nZXQoKTsKCQkJCX0sCgoJCQkJLy9pZiB3ZSB3YW50IHRvIGNhbGwgYSBtZW1iZXIgImZvbyIgb2YgcHVibGlzaGVyIG1vZGVsCgkJCQkvL2J1dCB3ZSBkb24ndCB3YW50IHRvIGRvIGFueXRoaW5nIHRvIHRoZSBzdWJzY3JpYmVyLCB3ZSBtYXkgd2FudCB0byB1c2UgZXhwcmVzc2lvbgoJCQkJLy8iKmZha2VHZXQgZm9vIgoKCQkJCS8vJGNsaWNrOml0ZW1zfCplZGl0U2hhZG93SXRlbQoJCQkJLy8kY2xpY2s6aXRlbXMqcXVlcnlSZXN1bHR8KmVkaXRTaGFkb3dJdGVtCgkJCQkvL3dvcmtmbG93KGhhbmRsZXIpIC0tPm5ld1NoYWRvd0l0ZW06ICIqZmFrZUdldCBuZXdTaGFkb3dJdGVtIiwKCQkJCWZha2VHZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBkdW1teTsKCQkJCX0KCQkJfSwKCgkJCS8vaGFuZGxlci5zZXQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJLy9pbnNpZGUgc2V0dGVyIGZ1bmN0aW9uICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQkvL3NldCh2YWx1ZSwgZSkKCQkJc2V0OiB7CgkJCQlzZXRNZW1iZXI6IHNldE1lbWJlciwKCgkJCQkvL2JlY2F1c2UgaG0uanMgd2FudCB0byBzdXBwb3J0IHNpbXBsaWZpZWQgYWN0aXZpdHkgZXhwcmVzc2lvbgoJCQkJLy9ydWxlIDEKCQkJCS8vICJ2YWwiLCB3aGVuIHB1Ymxpc2hlciBpcyB2aWV3LCBzdWJzY3JpYmVyIGlzIG1vZGVsLCB3aGljaCBtZWFucyAidmFsIiB2aWV3LAoJCQkJLy8ic2V0IiBtb2RlbAoJCQkJLy9ydWxlIDIKCQkJCS8vb3IgImh0bWwiLCB3aGVuIHB1Ymxpc2hlciBpcyBtb2RlbCwgc3Vic2NyaWJlciBpcyB2aWV3LCB3aGljaCBtZWFucyAiZ2V0IiBtb2RlbAoJCQkJLy8iaHRtbCIgdmlldy4KCgkJCQkvL3NvIGlmIHB1Ymxpc2hlciBpcyBtb2RlbCwgc3Vic2NyaWJlciBpcyB2aWV3LiBXZSBqdXN0IHdhbnQgdG8gY2FsbCBhIG1ldGhvZCAiZ2V0IgoJCQkJLy9vbiBtb2RlbCB3aGljaCBtb2RpZnkgbW9kZWwsIGJ1dCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgYW55IG1ldGhvZCBvbiB2aWV3LgoJCQkJLy93ZSBhcmUgaW4gZGlsZW1tYSBiZWNhdXNlIG9mIHJ1bGUgMiwgd2UgZG9uJ3QgaGF2ZSBhIGRlZmF1bHQgbWV0aG9kIGZvciBhIHZpZXcuCgkJCQkvL2EgY2FzZSBpbiB1c2UgaXMgdGhhdAoJCQkJLy9zaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkJCWZha2VTZXQ6ICQubm9vcAoKCQkJfSwKCgkJCS8vaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCS8vaW5zaWRlIGNvbnZlcnRlciBmdW5jdGlvbiAndGhpcycgcmVmZXIgdG8gc3Vic2NyaWJlcgoJCQljb252ZXJ0OiB7CgoJCQkJdG9TdHJpbmc6IHV0aWwudG9TdHJpbmcsCgoJCQkJdG9UeXBlZFZhbHVlOiB1dGlsLnRvVHlwZWRWYWx1ZSwKCgkJCQl0b051bWJlcjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJldHVybiArdmFsdWU7CgkJCQl9LAoKCQkJCXRvRGF0ZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXJldHVybiBuZXcgRGF0ZSggdmFsdWUgKTsKCQkJCX0KCQkJfSwKCgkJCS8vaGFuZGxlci5maW5hbGl6ZS5jYWxsKCBzdWJzY3JpYmVyLCB2YWx1ZSwgZSApOwoJCQkvL2luc2lkZSB0aGUgYWZ0ZXJTZXQgZnVuY3Rpb24sICd0aGlzJyByZWZlciB0byB0aGUgc3Vic2NyaWJlcgoJCQlmaW5hbGl6ZTogewoJCQkJLy8JCQkJc2F2ZUxvY2FsOiBmdW5jdGlvbiggdmFsdWUsIGUgKSB7CgkJCQkvLwkJCQkJdXRpbC5sb2NhbCggZS5wdWJsaXNoZXIucGF0aCwgdmFsdWUgKTsKCQkJCS8vCQkJCX0KCQkJfQoJCX0KCX0gKTsKCgl3b3JrZmxvd1N0b3JlID0gewoKCQljaGFuZ2U6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCXJvb3ROb2RlLmNoYW5nZSggZS5oYW5kbGVyLm9wdGlvbnMgKTsKCQkJfQoJCX0sCgkJc2F2ZUxvY2FsOiB7CgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgcGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlobSggcGF0aCApLnNhdmVMb2NhbCgpOwoJCQkJfSwgMSApOwoJCQl9CgkJfQoJfTsKCgl2YXIgdmlld0lkTWFuYWdlciA9IHsKCgkJZ2V0SWQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIgKTsKCQl9LAoKCQl1bk1hcms6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiwgdW5kZWZpbmVkICk7CgkJfSwKCgkJbWFyazogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmIChpc09iamVjdCggZWxlbSApICYmICEkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiApKSB7CgkJCQkkKCBlbGVtICkuaG1EYXRhKCAidmlld0lkIiwgKyt2aWV3SWQgKTsKCQkJfQoJCX0KCX07CgoJLy8gLS0tLS0tLS0gcHJpdmF0ZSAtLS0tLS0tLS0tLS0tIC8vCgkvL3RoZSByZWFzb24gdGhhdCB3ZSB3YW50IHRvIGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMgaXMgdGhhdAoJLy93aGVuIHVuYmluZCBvciB1bmRlbGVnYXRlIHRoZSB2aWV3RXZlbnRUeXBlcywgd2Ugd2FudCB0byB0aGUgdmlld0V2ZW50VHlwZXMKCS8vYXMgdW5pcXVlIGFzIHBvc3NpYmxlLCBjaGVjayB0aGUgdW5zdWJzY3JpYmUgbWV0aG9kCgkvLwoJLy9pbnB1dDogZ2V0VW5pcXVlVmlld0V2ZW50VHlwZXMoImNsaWNrIGRibENsaWNrIiwgdmlld1dpdGhWaWV3SWQzLCAiY3VzdG9tZXIiKQoJLy9vdXRwdXQ6ICJjbGljay5fX2htLjMuY3VzdG9tZXIgZGJsQ2xpY2suX19obS4zLmN1c3RvbWVyIgoJLy9pbnB1dDogZ2V0VW5pcXVlVmlld0V2ZW50VHlwZXMoImNsaWNrIGRibENsaWNrIiwgdmlld1dpdGhWaWV3SWQzLCB2aWV3V2l0aFZpZXdJZDQpCgkvL291dHB1dDogImNsaWNrLl9faG0uMy40IGRibENsaWNrLl9faG0uMy40IgoJLy9pdCB0cnkgdG8gYXBwZW5kIGFuIGV2ZW50IG5hbWUgd2l0aCBhbmQgIi5fX2htLnZpZXdJZC5zdWJzY3JpYmVySWQiCglmdW5jdGlvbiBidWlsZFVuaXF1ZVZpZXdFdmVudFR5cGVzKCBvcmlnaW5hbEV2ZW50VHlwZXMsIHB1Ymxpc2hlclZpZXcsIHN1YnNjcmliZXIgKSB7CgoJCXZhciBwdWJsaXNoZXJWaWV3SWQgPSB2aWV3SWRNYW5hZ2VyLmdldElkKCBwdWJsaXNoZXJWaWV3ICk7CgoJCS8qCWlmIG9yaWdpbmFsIHZpZXdFdmVudHMgaXMgImNsaWNrIGRibENsaWNrIiwKCQkgYW5kIGl0IGJpbmQgdG8gcGF0aCAiZmlyc3ROYW1lIiwgaXQgd2lsbCBjb252ZXJ0IHRvCgkJIGNsaWNrLl9faG0uZmlyc3ROYW1lIGRibENsaWNrLl9faG0uZmlyc3ROYW1lLCB0aGUgcmVhc29uIGlzIHRoYXQKCQkgd2hlbiBwYXRoIGlzIGRlbGV0ZWQsIHRoZSBtZXRob2QgdW5iaW5kKG9iamVjdCkgbmVlZCB0byB1bmJpbmQKCQkgZXZlbnQgYnkgYSBuYW1lc3BhY2UsIGlmIGZpcnN0TmFtZSBpcyBkZWxldGVkLCB3ZSBjYW4gdW5iaW5kICIuX19obS5maXJzdE5hbWUiKi8KCQlyZXR1cm4gJC5tYXAoCgkJCW9yaWdpbmFsRXZlbnRUeXBlcy5zcGxpdCggclNwYWNlcyApLAoJCQlmdW5jdGlvbiggb3JpZ2luYWxFdmVudE5hbWUgKSB7CgkJCQlyZXR1cm4gaXNTdHJpbmcoIHN1YnNjcmliZXIgKSA/CgkJCQkJb3JpZ2luYWxFdmVudE5hbWUgKyAiLiIgKyBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBwdWJsaXNoZXJWaWV3SWQgKyAiLiIgKyBzdWJzY3JpYmVyIDoKCQkJCQlvcmlnaW5hbEV2ZW50TmFtZSArICIuIiArIHNoYWRvd05hbWVzcGFjZSArICIuIiArIHB1Ymxpc2hlclZpZXdJZCArICIuIiArIHZpZXdJZE1hbmFnZXIuZ2V0SWQoIHN1YnNjcmliZXIgKTsKCQkJfQoJCSkuam9pbiggIiAiICk7Cgl9CgoJLy9pZiBvYmplY3QgaXMgZG9tIGVsZW1lbnQgb3IgalF1ZXJ5IHNlbGVjdG9yIHRoZW4gd3JhcCBpbnRvIGpRdWVyeQoJLy9pZiBvYmplY3QgaXMgbW9kZWwgcGF0aCwgd3JhcCBpdCBpbnRvIG1vZGVsCgkvL2lmIGl0IGlzIHB1cmUgb2JqZWN0LCByZXR1cm4gYXMgaXQgaXMKCS8vaWYgaXQgaXMgXywgcmV0dXJuIG51bGwKCWZ1bmN0aW9uIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSB7CgkJaWYgKGlzU3RyaW5nKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSkgewoJCQlyZXR1cm4gaG0oIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApOwoKCQl9IGVsc2UgaWYgKGlzT2JqZWN0KCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSAmJiAhcHVibGlzaGVyT3JTdWJzY3JpYmVyLm5vZGVUeXBlKSB7CgkJCS8vbm90IGEgRE9NIGVsZW1lbnQKCQkJcmV0dXJuIHB1Ymxpc2hlck9yU3Vic2NyaWJlcjsKCgkJfSBlbHNlIGlmICghaXNVbmRlZmluZWQoIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApKSB7CgoJCQlyZXR1cm4gJCggcHVibGlzaGVyT3JTdWJzY3JpYmVyICk7CgkJfQoJfQoKCWZ1bmN0aW9uIHJlcGxhY2VEb3RPclN0YXIoIG1hdGNoICkgewoJCS8vaWYgbWF0Y2ggaXMgIi4iLCBub3JtYWxpemUgaXQgdG8gIlxcLiIKCQkvL2lmIG1hdGNoIGlzICIqIiwgbm9ybWFsaXplIGl0IHRvICIuKiIKCQlyZXR1cm4gbWF0Y2ggPT0gIi4iID8gIlxcLiIgOiAiLioiOwoJfQoKCS8vaWYgb25lIG9mIHRoZSBzdWJzY3JpYmVkIGV2ZW50cyBpcyBtYXRjaGVkIHdpdGggdHJpZ2dlcmluZyBldmVudAoJLy9yZXR1cm4gdGhhdCBzdWJzY3JpYmVkIGV2ZW50CglmdW5jdGlvbiBnZXRNYXRjaGVkU3Vic2NyaWJlZEV2ZW50KCBzdWJzY3JpYmVkRXZlbnRzLCB0cmlnZ2VyaW5nRXZlbnQgKSB7CgoJCXZhciBtYXRjaCwKCQkJc291cmNlLAoJCQlyTWF0Y2hXaXRoVHJpZ2dlcmluZ0V2ZW50LAoJCQlldmVudFN1YnNjcmliZWQsCgkJCWlzRW5kV2l0aFN0YXJEb3QsCgkJCWk7CgoJCWlmIChzdWJzY3JpYmVkRXZlbnRzID09PSAiKiIpIHsKCQkJcmV0dXJuICIqIjsKCQl9CgoJCXN1YnNjcmliZWRFdmVudHMgPSBzdWJzY3JpYmVkRXZlbnRzLnNwbGl0KCByU3BhY2VzICk7CgoJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpYmVkRXZlbnRzLmxlbmd0aDsgaSsrKSB7CgoJCQlldmVudFN1YnNjcmliZWQgPSBzdWJzY3JpYmVkRXZlbnRzW2ldOwoKCQkJaXNFbmRXaXRoU3RhckRvdCA9IHJFbmRXaXRoU3RhckRvdC50ZXN0KCBldmVudFN1YnNjcmliZWQgKTsKCgkJCXNvdXJjZSA9IGlzRW5kV2l0aFN0YXJEb3QgPwoJCQkJLy9pZiBldmVudFN1YnNjcmliZWQgaXMgbGlrZSAiKi4iIG9yICJiZWZvcmUqLiI7CgkJCQlldmVudFN1YnNjcmliZWQucmVwbGFjZSggckVuZFdpdGhTdGFyRG90LCAiIiApIDoKCQkJCWV2ZW50U3Vic2NyaWJlZDsKCgkJCXNvdXJjZSA9IHNvdXJjZS5yZXBsYWNlKCByRG90T3JTdGFyLCByZXBsYWNlRG90T3JTdGFyICk7CgoJCQlzb3VyY2UgPSBpc0VuZFdpdGhTdGFyRG90ID8gIl4iICsgc291cmNlIDogIl4iICsgc291cmNlICsgIiQiOwoKCQkJck1hdGNoV2l0aFRyaWdnZXJpbmdFdmVudCA9IG5ldyBSZWdFeHAoIHNvdXJjZSwgImkiICk7CgoJCQltYXRjaCA9IHJNYXRjaFdpdGhUcmlnZ2VyaW5nRXZlbnQudGVzdCggdHJpZ2dlcmluZ0V2ZW50ICk7CgoJCQlpZiAobWF0Y2gpIHsKCQkJCWlmIChpc0VuZFdpdGhTdGFyRG90KSB7CgkJCQkJLy9pbiBvdGhlciBicm93c2VyLCBpbiB0aGUgZm9sbG93aW5nIGlzIGVub3VnaAoJCQkJCS8vdmFyIHJlbWFpbmluZyA9IFJlZ0V4cC5yaWdodENvbnRleHQ7CgkJCQkJLy8KCQkJCQkvL2hvd2V2ZXIgaW4gSUUgaGFzIGEgYnVnIHRoYXQsIGlmIHJUZW1wIGlzIC9eLywgUmVnRXhwLnJpZ2h0Q29udGV4dCByZXR1cm4gIiIKCQkJCQkvL3doaWxlIG90aGVyIGJyb3dzZXIgUmVnRXhwLnJpZ2h0Q29udGV4dCByZXR1cm4gdGhlIHJlbWFpbmluZwoJCQkJCS8vc2VlIGh0dHA6Ly9qc2Jpbi5jb20vaWtha3V3LzIvZWRpdAoJCQkJCXZhciByZW1haW5pbmcgPSBzb3VyY2UgPT0gIl4iID8gdHJpZ2dlcmluZ0V2ZW50IDogUmVnRXhwLnJpZ2h0Q29udGV4dDsKCgkJCQkJLy9pZiByZW1haW5pbmcgaXMgZW1wdHkgb3IgcmVtYWluaW5nIGRvZXMgbm90IGNvbnRhaW5zICIuIgoJCQkJCWlmICghcmVtYWluaW5nIHx8ICFyZW1haW5pbmcuY29udGFpbnMoICIuIiApKSB7CgkJCQkJCXJldHVybiBzdWJzY3JpYmVkRXZlbnRzW2ldOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHN1YnNjcmliZWRFdmVudHNbaV07CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy9jaGVjayBpZiBzdWJzY3JpcHRpb24gbWF0Y2hlZCB3aXRoIHRoZSB0cmlnZ2VyaW5nIGV2ZW50LAoJLy8gYW5kIGludm9rZSBpdHMgd29ya2Zsb3csIGFuZCBhbHNvIGNhc2NhZGUgdGhlIGV2ZW50cyB0bwoJLy9ob3Jpem9udGFsbHksIGUgaXMgbXV0YWJsZQoJZnVuY3Rpb24gY2FsbGJhY2tNb2RlbFN1YnNjcmlwdGlvbkhhbmRsZXIoIGUgKSB7CgoJCXZhciBzdWJzY3JpcHRpb24sCgkJCXdhdGNoaW5nUGF0aHMsCgkJCWNhc2NhZGVFdmVudCwKCQkJaSwKCQkJaiwKCQkJc3Vic2NyaXB0aW9uc0J5UHVibGlzaGVyID0gZS5wdWJsaXNoZXIuc3Vic1RvTWUoKTsKCgkJZm9yIChpID0gMDsgaSA8IHN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlci5sZW5ndGg7IGkrKykgewoKCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc0J5UHVibGlzaGVyW2ldOwoKCQkJZS5tYXRjaGVkVHlwZSA9IGdldE1hdGNoZWRTdWJzY3JpYmVkRXZlbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLCBlLnR5cGUgKTsKCgkJCWlmIChlLm1hdGNoZWRUeXBlKSB7CgkJCQlleGVjdXRlSGFuZGxlciggdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICksIHN1YnNjcmlwdGlvbi5oYW5kbGVyLCBlICk7CgkJCX0KCgkJCWlmIChlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJaWYgKCFlLmlzQ2FzY2FkZVN0b3BwZWQoKSkgewoKCQkJd2F0Y2hpbmdQYXRocyA9IHdhdGNoVGFibGVbZS5wdWJsaXNoZXIucGF0aF07CgoJCQlpZiAod2F0Y2hpbmdQYXRocykgewoJCQkJZm9yIChqID0gMDsgaiA8IHdhdGNoaW5nUGF0aHMubGVuZ3RoOyBqKyspIHsKCgkJCQkJY2FzY2FkZUV2ZW50ID0gdHJpZ2dlcigKCQkJCQkJd2F0Y2hpbmdQYXRoc1tqXSwKCQkJCQkJZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoLAoJCQkJCQllLnR5cGUKCQkJCQkpOwoKCQkJCQlpZiAoY2FzY2FkZUV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgfHwgY2FzY2FkZUV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGNhc2NhZGVFdmVudC5oYXNFcnJvcigpKSB7CgkJCQkJCWUuZXJyb3IoKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoKCWZ1bmN0aW9uIGV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCB0cmlnZ2VyRGF0YSApIHsKCgoJCXZhciB2YWx1ZSwKCQkJY2xvbmVkRXZlbnRBcmc7CgoJCWUuaGFuZGxlciA9IGhhbmRsZXI7CgkJZS5zdWJzY3JpYmVyID0gc3Vic2NyaWJlcjsKCgkJaWYgKCFpc1VuZGVmaW5lZCggdHJpZ2dlckRhdGEgKSkgewoJCQkvL2luIHRoZSBnZXQgbWV0aG9kICJ0aGlzIiByZWZlciB0byB0aGUgaGFuZGxlcgoJCQl2YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJfSBlbHNlIHsKCQkJLy9pbiB0aGUgZ2V0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJdmFsdWUgPSBoYW5kbGVyLmdldC5jYWxsKCBzdWJzY3JpYmVyLCBlICk7CgkJfQoKCQlpZiAoZS5pc0Fib3J0ZWQoKSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoaXNQcm9taXNlKCB2YWx1ZSApKSB7CgkJCWNsb25lZEV2ZW50QXJnID0gZXh0ZW5kKCB0cnVlLCB7fSwgZSApOwoJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkJLy9pbiB0aGUgY29udmVydCBtZXRob2QgInRoaXMiIHJlZmVyIHRvIHRoZSBoYW5kbGVyCgkJCQkJdmFsdWUgPSBoYW5kbGVyLmNvbnZlcnQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJCX0KCgkJCQlpZiAoaGFuZGxlci5zZXQgfHwgaGFuZGxlci5maW5hbGl6ZSkgewoJCQkJCS8vbWFrZSBzdXJlIGl0IGlzIGEgcmVhbCBwcm9taXNlIG9iamVjdAoJCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQkJdmFsdWUuZG9uZSggZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCQkJc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBjbG9uZWRFdmVudEFyZyApOwoJCQkJCQl9ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0gKTsKCQl9IGVsc2UgewoJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkvL2luIHRoZSBjb252ZXJ0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJCXZhbHVlID0gaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCX0KCgkJCWlmIChoYW5kbGVyLnNldCB8fCBoYW5kbGVyLmZpbmFsaXplKSB7CgkJCQkvL21ha2Ugc3VyZSBpdCBpcyBhIHJlYWwgcHJvbWlzZSBvYmplY3QKCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQljbG9uZWRFdmVudEFyZyA9IGV4dGVuZCggdHJ1ZSwge30sIGUgKTsKCQkJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJCXNldEFuZEZpbmFsaXplKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCB2YWx1ZSwgY2xvbmVkRXZlbnRBcmcgKTsKCQkJCQl9ICk7CgoJCQkJfSBlbHNlIHsKCQkJCQlzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBlICkgewoJCWlmICh2YWx1ZSA9PT0gZHVtbXkpIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoJCWhhbmRsZXIuc2V0ICYmIGhhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJaGFuZGxlci5maW5hbGl6ZSAmJiBoYW5kbGVyLmZpbmFsaXplLmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7Cgl9CgoJZnVuY3Rpb24gc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyUGF0aCwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCgkJdmFyIG1hdGNoLAoJCQlkZWxheU1pbmlTZWNvbmQsCgkJCWluaXRFdmVudCwKCQkJZXZlbnRzOwoKCQlldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCAiICIgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJbWF0Y2ggPSBySW5pdC5leGVjKCBldmVudHNbaV0gKTsKCQkJaWYgKG1hdGNoKSB7CgkJCQlpbml0RXZlbnQgPSBldmVudHNbaV07CgkJCQlkZWxheU1pbmlTZWNvbmQgPSArbWF0Y2hbMV07CgkJCQlldmVudHMuc3BsaWNlKCBpLCAxICk7CgkJCQlldmVudFR5cGVzID0gZXZlbnRzLmpvaW4oICIgIiApOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWhhbmRsZXIgPSBidWlsZEhhbmRsZXIoIGhhbmRsZXIsIHB1Ymxpc2hlclBhdGgsIHN1YnNjcmliZXIsIG9wdGlvbnMgKTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJc3Vic2NyaXB0aW9uTWFuYWdlci5hZGQoIHN1YnNjcmliZXIsIHB1Ymxpc2hlclBhdGgsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKTsKCQl9CgoJCWlmIChpbml0RXZlbnQpIHsKCQkJdmFyIGluaXQgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBlID0gbmV3IEV2ZW50KCBwdWJsaXNoZXJQYXRoLCBwdWJsaXNoZXJQYXRoLCBpbml0RXZlbnQgKTsKCQkJCWV4ZWN1dGVIYW5kbGVyKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggc3Vic2NyaWJlciApLCBoYW5kbGVyLCBlICk7CgkJCX07CgoJCQlpZiAoZGVsYXlNaW5pU2Vjb25kKSB7CgkJCQlzZXRUaW1lb3V0KCBpbml0LCBkZWxheU1pbmlTZWNvbmQgKTsKCQkJfSBlbHNlIHsKCQkJCWluaXQoKTsKCQkJfQoJCX0KCX0KCgkvL3N1YnNjcmliZSBqUXVlcnkgZXZlbnQKCWZ1bmN0aW9uIHN1YnNjcmliZVZpZXdFdmVudCggdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJLy9nZXQvc2V0L2NvbnZlcnQvW2luaXRdL1tvcHRpb25zXQoJCXZhciBuZWVkSW5pdCwKCQkJZXZlbnRTZWVkRGF0YSwKCQkJdGVtcDsKCgkJdGVtcCA9IGV2ZW50VHlwZXMuc3BsaXQoICIgIiApOwoKCQlpZiAodGVtcC5jb250YWlucyggImluaXQiICkpIHsKCQkJbmVlZEluaXQgPSB0cnVlOwoJCQlldmVudFR5cGVzID0gdGVtcC5yZW1vdmUoICJpbml0IiApLmpvaW4oICIgIiApOwoJCX0KCgkJaGFuZGxlciA9IGJ1aWxkSGFuZGxlciggaGFuZGxlciwgdmlld1B1Ymxpc2hlciwgc3Vic2NyaWJlciwgb3B0aW9ucyApOwoKCQlldmVudFNlZWREYXRhID0gewoJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyCgkJfTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJZXZlbnRUeXBlcyA9IGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMoIGV2ZW50VHlwZXMsIHZpZXdQdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCWlmIChkZWxlZ2F0ZVNlbGVjdG9yKSB7CgkJCQloYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IgPSBkZWxlZ2F0ZVNlbGVjdG9yOwoJCQkJJCggdmlld1B1Ymxpc2hlciApLmRlbGVnYXRlKCBkZWxlZ2F0ZVNlbGVjdG9yLCBldmVudFR5cGVzLCBldmVudFNlZWREYXRhLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCX0gZWxzZSB7CgkJCQkkKCB2aWV3UHVibGlzaGVyICkuYmluZCggZXZlbnRUeXBlcywgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQl9CgoJCQkvL3dlIGhhdmUgcGFzc2VkIGhhbmRsZXIsIHN1YnNjcmliZXIsIG9wdGlvbnMgYXMgalF1ZXJ5IGV2ZW50U2VlZERhdGEsCgkJCS8vd2Ugc3RpbGwgbmVlZCB0byBhZGQgdGhlbSB0byBzdWJzY3JpcHRpb25zIHNvIHRoYXQKCQkJLy90aGUgdmlldyBldmVudCBoYW5kbGVyIGNhbiBiZSB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQlzdWJzY3JpcHRpb25NYW5hZ2VyLmFkZCggc3Vic2NyaWJlciwgdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApOwoKCQkJaWYgKG5lZWRJbml0KSB7CgkJCQlpZiAoZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCSQoIHZpZXdQdWJsaXNoZXIgKS5maW5kKCBkZWxlZ2F0ZVNlbGVjdG9yICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCB2aWV3UHVibGlzaGVyICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSBpZiAobmVlZEluaXQpIHsKCgkJCSQoIHZpZXdQdWJsaXNoZXIgKS5vbmUoICJpbml0IiwgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCSQoIHZpZXdQdWJsaXNoZXIgKS50cmlnZ2VyKCAiaW5pdCIgKTsKCgkJfQoJfQoKCWZ1bmN0aW9uIGFib3J0KCkgewoJCXRoaXMuaXNBYm9ydGVkID0gcmV0dXJuVHJ1ZTsKCX0KCgkvL3RoZSBnZW5lcmFsIGpRdWVyeSBldmVudCBoYW5kbGVyCglmdW5jdGlvbiB2aWV3SGFuZGxlckdhdGV3YXkoIGUgKSB7CgkJZS5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggZS5jdXJyZW50VGFyZ2V0ICk7CgkJZS5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBlLnRhcmdldCApOwoJCWUuaXNBYm9ydGVkID0gcmV0dXJuRmFsc2U7CgkJZS5hYm9ydCA9IGFib3J0OwoJCXZhciBzdWJzY3JpYmVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIGUuZGF0YS5zdWJzY3JpYmVyICk7CgoJCXZhciBoYW5kbGVyID0gZS5kYXRhLmhhbmRsZXI7CgkJZGVsZXRlIGUuZGF0YTsKCgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CgkJCWV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQl9IGVsc2UgewoJCQlleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSApOwoJCX0KCX0KCglmdW5jdGlvbiBidWlsZEhhbmRsZXIoIHdvcmtmbG93UHJvdG90eXBlLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQl2YXIgaGFuZGxlcjsKCgkJd29ya2Zsb3dQcm90b3R5cGUgPSB3b3JrZmxvd1Byb3RvdHlwZSB8fCAiIjsKCgkJaWYgKGlzU3RyaW5nKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gYnVpbGRIYW5kbGVyRnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaW5pdGlhbGl6ZU9wdGlvbnMgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZSwKCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJfSwKCQkJCXdvcmtmbG93UHJvdG90eXBlCgkJCSk7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIHdvcmtmbG93UHJvdG90eXBlICkgJiYgd29ya2Zsb3dQcm90b3R5cGUuZ2V0KSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQl9LCB3b3JrZmxvd1Byb3RvdHlwZSApOwoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICk7CgoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCQljb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCAic2V0IiwgaGFuZGxlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICk7CgkJLy8KCQljb252ZXJ0U3RyaW5nQWN0aXZpdHlUb0Z1bmN0aW9uKCAiY29udmVydCIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvLyBleGFtcGxlIG9mIHdvcmtmbG93U3RyaW5nCgkvLyB6ZXJvIHRva2VuLCB0aGUgc3Vic2NyaWJlciBtdXN0IGJlIGZ1bmN0aW9uIGluIHJlcG9zaXRvcnkKCS8vCgkvLyBzaW5nbGUgdG9rZW4gbGlrZSAiKndvcmtmbG93IiwgInZhbCIsICJodG1sIiwgIiNwYXRoIiwKCS8vICJ2YWwiIHdpbGwgZXhwYW5kIHRvICJ2YWwgc2V0IiBvciAiZ2V0IHZhbCIgZGVwZW5kaW5nIHRoZSB0eXBlIG9mIHB1Ymxpc2hlcgoJLy8KCS8vIG11bHRpcGxlIHRva2VucywgYWxsIHRva2VuIGNhbiBzdGFydHMgd2l0aCAiKiIsICIjIiwKCS8vIGJ1dCBvbmx5ICJnZXQiIGFuZCAic2V0IiB0b2tlbiBjYW4gc3RhcnQgbm9ybWFsIGNoYXJhY3RlcnMsCgkvLyBzdWNoIGFzICJ2YWwiLCAiaHRtbCIKCWZ1bmN0aW9uIGJ1aWxkSGFuZGxlckZyb21TdHJpbmcoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQkvL2dldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplCgkJdmFyIGhhbmRsZXIsCgkJCWVtYmVkZGVkSGFuZGxlciwKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPT0gMSkgewoKCQkJaWYgKHdvcmtmbG93U3RyaW5nLnN0YXJ0c1dpdGgoICIqIiApKSB7CgoJCQkJaGFuZGxlciA9IHdvcmtmbG93U3RvcmVbd29ya2Zsb3dTdHJpbmcuc3Vic3RyKCAxICldOwoJCQkJaWYgKCFoYW5kbGVyKSB7CgkJCQkJdGhyb3cgImNvbW1vbiB3b3JrZmxvdyAiICsgd29ya2Zsb3dTdHJpbmcgKyAiIGRvZXMgbm90IGV4aXN0IjsKCQkJCX0KCgkJCQloYW5kbGVyID0gZXh0ZW5kKCB7fSwgaGFuZGxlciApOwoKCQkJfSBlbHNlIGlmICh3b3JrZmxvd1N0cmluZy5zdGFydHNXaXRoKCAiIyIgKSkgewoKCQkJCWVtYmVkZGVkSGFuZGxlciA9IGdldEVtYmVkZGVkQWN0aXZpdHkoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggZW1iZWRkZWRIYW5kbGVyICkpIHsKCQkJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJCWdldDogZW1iZWRkZWRIYW5kbGVyLAoJCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJCX0sIGVtYmVkZGVkSGFuZGxlciApOwoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggZW1iZWRkZWRIYW5kbGVyICkgJiYgZW1iZWRkZWRIYW5kbGVyLmdldCkgewoJCQkJCWhhbmRsZXIgPSBleHRlbmQoIHsKCQkJCQkJb3B0aW9uczogaW5pdGlhbGl6ZU9wdGlvbnMKCQkJCQl9LCBlbWJlZGRlZEhhbmRsZXIgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCgkJCQloYW5kbGVyID0gaW5mZXJIYW5kbGVyRnJvbVB1Ymxpc2hlclN1YnNjcmliZXJXaXRoU2luZ2xlQWN0aXZpdHkoCgkJCQkJcHVibGlzaGVyLAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJd29ya2Zsb3dTdHJpbmcgKTsKCgkJCX0gZWxzZSB7CgkJCQkvL2VpdGhlciBtb2RlbCBpcyBlbXB0eSBvciB2aWV3IGlzIGVtcHR5LAoJCQkJLy8gYW5kIHRoZSB3b3JrZmxvdyBzdHJpbmcgaXMgYSBzaW5nbGUKCQkJCS8va2V5LCBhbmQgdGhlIGtleSBpcyBub3Qgd29ya2Zsb3cgdHlwZQoJCQkJdGhyb3cgImludmFsaWQgaGFuZGxlciI7CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy90aGlzIGlzIHRoZSBjYXNlCgkJCS8vYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxCgoJCQloYW5kbGVyID0geyB9OwoKCQkJLy9hY3Rpdml0eVR5cGVzIGlzIFtnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZV0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhY3Rpdml0eVR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJCQlhY3Rpdml0eU5hbWUgPSBhY3Rpdml0eU5hbWVzW2ldOyAvL2FjdGl2aXR5TmFtZSBpcyB0aGUgdG9rZW4gaW4gd29ya2Zsb3cgc3RyaW5nCgkJCQlhY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGVzW2ldOyAvL2FjdGl2aXR5VHlwZSBpcyBvbmUgb2YgZ2V0LHNldCxjb252ZXJ0LGZpbmFsaXplLGluaXRpYWxpemUKCgkJCQlpZiAoYWN0aXZpdHlOYW1lICYmIChhY3Rpdml0eU5hbWUgIT09ICJfIiAmJiBhY3Rpdml0eU5hbWUgIT0gIm51bGwiKSkgewoJCQkJCWhhbmRsZXJbYWN0aXZpdHlUeXBlXSA9IGFjdGl2aXR5TmFtZTsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvL2dldCBlbWJlZGRlZCBoYW5kbGVyIGhlbHBlciBieSBwYXRoCgkvL3RoZSBwYXRoIHNob3VsZCBiZSBhIHBhdGggcHJlZml4IHdpdGggIiMiCgkvL3RoYXQgcGF0aCBjYW4gYmUgYWJzb2x1dGUgcGF0aCBsaWtlICIjL2EuYiIKCS8vb3IgaXQgY2FuIGJlIHJlbGF0aXZlIHBhdGggcmVsYXRpdmUgdG8gc3Vic2NyaWJlciBtb2RlbCBvciBwdWJsaXNoZXIgbW9kZWwKCWZ1bmN0aW9uIGdldEVtYmVkZGVkQWN0aXZpdHkoIGFjdGl2aXR5TmFtZVByZWZpeFdpdGhTaGFycENoYXJhY3RlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoKCQl2YXIgbW9kZWxQYXRoID0gYWN0aXZpdHlOYW1lUHJlZml4V2l0aFNoYXJwQ2hhcmFjdGVyLnN1YnN0ciggMSApOwoKCQltb2RlbFBhdGggPSBpc1N0cmluZyggc3Vic2NyaWJlciApID8gbWVyZ2VQYXRoKCBzdWJzY3JpYmVyLCBtb2RlbFBhdGggKSA6CgkJCWlzU3RyaW5nKCBwdWJsaXNoZXIgKSA/IG1lcmdlUGF0aCggcHVibGlzaGVyLCBtb2RlbFBhdGggKSA6CgkJCQltb2RlbFBhdGg7CgoJCXJldHVybiByb290Tm9kZS5yYXcoIG1vZGVsUGF0aCApOwoJfQoKCWZ1bmN0aW9uIGluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93T3B0aW9ucyApIHsKCgkJdmFyIGluaXRpYWxpemUgPSBoYW5kbGVyLmluaXRpYWxpemU7CgoJCWlmIChpc1N0cmluZyggaW5pdGlhbGl6ZSApKSB7CgkJCWlmIChpbml0aWFsaXplLnN0YXJ0c1dpdGgoICIqIiApKSB7CgkJCQlpbml0aWFsaXplID0gaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZVtpbml0aWFsaXplLnN1YnN0cmluZyggMSApXTsKCQkJCWlmICghaW5pdGlhbGl6ZSkgewoJCQkJCXRocm93ICJpbml0aWFsaXplIGFjdGl2aXR5IGRvZXMgbm90IGV4aXN0ISI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl2YXIgcGF0aCA9IGluaXRpYWxpemU7CgkJCQlpZiAoIXJvb3ROb2RlLnJhdyggcGF0aCApKSB7CgkJCQkJdGhyb3cgImluaXRpYWxpemUgYWN0aXZpdHkgZG9lcyBub3QgZXhpc3QgYXQgcGF0aCAiICsgcGF0aDsKCQkJCX0KCQkJCWluaXRpYWxpemUgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJCXJvb3ROb2RlLnNldCggcGF0aCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoaW5pdGlhbGl6ZSkgewoJCQlpbml0aWFsaXplKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICksIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpYmVyICksIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCB3b3JrZmxvd09wdGlvbnMgKSkgewoJCQloYW5kbGVyLm9wdGlvbnMgPSB3b3JrZmxvd09wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGluZmVySGFuZGxlckZyb21QdWJsaXNoZXJTdWJzY3JpYmVyV2l0aFNpbmdsZUFjdGl2aXR5KCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGFjdGl2aXR5TmFtZSApIHsKCQkvL25vdyB3b3JrZmxvd1N0cmluZyBkb2VzIG5vdCBzdGFydHNXaXRoICosIGl0IGlzIG5vdCBhIHdvcmtmbG93IHR5cGUKCQkvL2luZmVyIGhhbmRsZXIgZnJvbSBwdWJsaXNoZXIgYW5kIHN1YnNjcmliZXIKCQkvLwoJCXZhciBoYW5kbGVyLAoJCQlpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCS8vaWYgcHVibGlzaGVyIGlzIG1vZGVsLCB0aGVuIHRoZSBsb2dpYyBpcwoJCQkvL3dpbGwgZ2V0IG1vZGVsJ3MgdmFsdWUgdXNpbmcgZGVmYXVsdCBnZXQgYWN0aXZpdHksCgkJCS8vYW5kIHVwZGF0ZSB0aGUgdmlldyB1c2luZyB3b3JrZmxvdyBvciAgZGVmYXVsdCAic2V0IiBhY3Rpdml0eQoJCQkvLwoJCQloYW5kbGVyID0gewoKCQkJCWdldDogImdldCIsCgoJCQkJLy9pZiB3b3JrZmxvd1N0cmluZyBpcyBub3QgZW1wdHksIGl0IGlzIHRoZSBzZXQgbWV0aG9kLCBmb3IgZXhhbXBsZQoJCQkJLy8kKCIjbGFibGUiKS5zdWIoaG0oIm1lc3NhZ2UiKSwgInRleHQiKTsKCQkJCS8vCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5LAoJCQkJLy8gdGhlbiBpdCBzaG91bGQgYmUgdGhlIGNhc2Ugd2hlbiBtb2RlbCBzdWJzY3JpYmUgbW9kZWwKCQkJCS8vY29weSB2YWx1ZSBvZiBvbmUgbm9kZSB0byBhbiBvdGhlciBub2RlCgkJCQkvL2htKCJtZXNzYWdlIikuc3ViKGhtKCJuYW1lIiksICJhZnRlclVwZGF0ZSIpOwoJCQkJc2V0OiBhY3Rpdml0eU5hbWUgfHwgInNldCIKCgoJCQl9OwoKCQl9IGVsc2UgaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgoJCQkvLyBtb2RlbCBzdWJzY3JpYmUgdmlldyBldmVudAoKCQkJaWYgKGFjdGl2aXR5TmFtZSkgewoJCQkJLy9obSgibmFtZSIpLnN1YigkKCIjdGV4dEJveCIsICJjaGFuZ2UiKTsKCQkJCWhhbmRsZXIgPSB7CgkJCQkJZ2V0OiBhY3Rpdml0eU5hbWUsCgkJCQkJc2V0OiAic2V0IgoJCQkJfTsKCQkJfSBlbHNlIHsKCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5CgkJCQkvL3doZW4gbW9kZWwgc3Vic2NyaWJlIHZpZXcgd2l0aG91dCBoYW5kbGVyCgkJCQkvL3RoZSBtb2RlbCBpcyB0aGUgaGFuZGxlciBieSBpdHNlbGYKCQkJCS8vZS5nCgkJCQkvL2htKCJmdW5jdGlvbk5vZGUiKS5zdWJzY3JpYmUoJCgiYnV0dG9uIiksICJjbGljayIpOwoJCQkJdmFyIHRlbXAgPSByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKTsKCQkJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wICkpIHsKCgkJCQkJaGFuZGxlciA9IHsKCQkJCQkJZ2V0OiByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKQoJCQkJCX07CgoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggdGVtcCApICYmIHRlbXAuZ2V0KSB7CgoJCQkJCWhhbmRsZXIgPSB0ZW1wOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy92aWV3IHN1YnNjcmliZSB2aWV3J3MgZXZlbnQKCQkJLy90aGlzIGlzIHJhcmVseSB0aGUgY2FzZSwgYnV0IGl0IGlzIHN0aWxsIHN1cHBvcnRlZAoJCQkvL2ZvciBleGFtcGxlLCBhIGxhYmVsIHN1YnNjcmliZSB0aGUgY2hhbmdlIG9mIGFub3RoZXIgbGFiZWwKCQkJLy8kKCIjbGFibGUyIikuc3ViKCIjbGFibGUxIiwgInRleHQiKTsKCQkJaGFuZGxlciA9IHsKCQkJCWdldDogYWN0aXZpdHlOYW1lLAoJCQkJc2V0OiBhY3Rpdml0eU5hbWUKCQkJfTsKCQl9CgoJCXJldHVybiBoYW5kbGVyOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQl2YXIgd29ya2Zsb3c7CgoJCWlmIChpc1N0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJd29ya2Zsb3cgPSBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApIHx8IChpc09iamVjdCggd29ya2Zsb3dQcm90b3R5cGUgKSAmJiB3b3JrZmxvd1Byb3RvdHlwZS5nZXQpKSB7CgoJCQl3b3JrZmxvdyA9IHdvcmtmbG93UHJvdG90eXBlOwoJCQlpZiAoaXNGdW5jdGlvbiggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJCXdvcmtmbG93ID0gZXh0ZW5kKAoJCQkJCXsKCQkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZQoJCQkJCX0sCgkJCQkJd29ya2Zsb3cgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJpbml0aWFsaXplIiwgd29ya2Zsb3cgKTsKCQkvLwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJzZXQiLCB3b3JrZmxvdyApOwoJCS8vCgkJY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggImNvbnZlcnQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIHdvcmtmbG93ICk7CgoJCXJldHVybiB3b3JrZmxvdzsKCX0KCglmdW5jdGlvbiBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dTdHJpbmcgKSB7CgoJCXZhciB3b3JrZmxvdywKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxKSB7CgoJCQl3b3JrZmxvdyA9IHsgfTsKCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYWN0aXZpdHlUeXBlcy5sZW5ndGg7IGkrKykgewoJCQkJYWN0aXZpdHlOYW1lID0gYWN0aXZpdHlOYW1lc1tpXTsKCQkJCWFjdGl2aXR5VHlwZSA9IGFjdGl2aXR5VHlwZXNbaV07CgoJCQkJaWYgKGFjdGl2aXR5TmFtZSAmJiAoYWN0aXZpdHlOYW1lICE9PSAiXyIgJiYgYWN0aXZpdHlOYW1lICE9ICJudWxsIikpIHsKCQkJCQl3b3JrZmxvd1thY3Rpdml0eVR5cGVdID0gYWN0aXZpdHlOYW1lOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdGhyb3cgImludmFsaWQgd29ya2Zsb3cgdHlwZSI7CgkJfQoKCQlyZXR1cm4gd29ya2Zsb3c7Cgl9CgoJZnVuY3Rpb24gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApIHsKCQlyZXR1cm4gaG0uYWN0aXZpdHlbYWN0aXZpdHlUeXBlXTsKCX0KCgkvLyBwdWJsaXNoZXIsIHN1YnNjcmliZXIgaXMgb3B0aW9uYWwKCS8vYWNjZXNzb3IgZWl0aGVyICJnZXQiIG9yICJzZXQiCglmdW5jdGlvbiBjb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCBhY2Nlc3NvclR5cGUsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApIHsKCgkJLy9ieSBkZWZhdWx0IHdvcmtmbG93LmdldCA9PSAiZ2V0Iiwgd29ya2Zsb3cuc2V0ID0gInNldCIKCQl2YXIgYWNjZXNzb3JLZXkgPSBoYW5kbGVyW2FjY2Vzc29yVHlwZV07CgoJCWlmIChhY2Nlc3NvcktleSAmJiBpc1N0cmluZyggYWNjZXNzb3JLZXkgKSkgewoKCQkJdmFyIGFjY2Vzc29ycyA9IGdldEFjdGl2aXR5U2V0KCBhY2Nlc3NvclR5cGUgKTsKCgkJCWlmIChhY2Nlc3NvcktleS5zdGFydHNXaXRoKCAiKiIgKSkgewoKCQkJCWFjY2Vzc29yS2V5ID0gYWNjZXNzb3JLZXkuc3Vic3RyKCAxICk7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvcnNbYWNjZXNzb3JLZXldOwoKCQkJCWlmICghaGFuZGxlclthY2Nlc3NvclR5cGVdKSB7CgkJCQkJdGhyb3cgYWNjZXNzb3JLZXkgKyAiIGRvZXMgbm90IGV4aXN0cyAiICsgYWNjZXNzb3JUeXBlICsgIiBBY3Rpdml0eSI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKGFjY2Vzc29yS2V5LnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY2Nlc3NvclR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWNjZXNzb3JLZXksIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIga2V5cyA9IGFjY2Vzc29yS2V5LnNwbGl0KCAiKiIgKTsKCgkJCQkvL3VzZSBkZWZhdWx0R2V0IG9yIGRlZmF1bHRTZXQgYW5kIHBhcnNlU3VicywgaWYgYWNjZXNzb3JLZXkgZG9lcyBub3QgYmVnaW4gd2l0aCAiKiIKCQkJCS8vIGhhbmRsZXIuc2V0UHJvcGVydHkgPSBhY2Nlc3NvcktleSBvcgoJCQkJLy8gaGFuZGxlci5nZXRQcm9wZXJ0eSA9IGFjY2Vzc29yS2V5CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvclR5cGUgPT0gImdldCIgPyBnZXRNZW1iZXIgOiBzZXRNZW1iZXI7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZSArICJOYW1lIl0gPSBrZXlzWzBdOwoKCQkJCWlmIChrZXlzWzFdKSB7CgkJCQkJLy9hY2Nlc3NvcktleSA9ICJjc3MqY29sb3IiCgkJCQkJaGFuZGxlclthY2Nlc3NvclR5cGUgKyAiUGFyYXMiXSA9IGtleXNbMV07CgkJCQl9CgoJCQkJaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCQkJCQl2YXIgcHVibGlzaGVyT3JTdWJzY3JpYmVyID0gYWNjZXNzb3JUeXBlID09ICJnZXQiID8gcHVibGlzaGVyIDogc3Vic2NyaWJlcjsKCQkJCQllbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBrZXlzWzBdLCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBlbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBhY3Rpdml0eU5hbWUsIHRhcmdldCApIHsKCQl2YXIgbWlzc2luZ01lbWJlcjsKCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgoJCQlpZiAoIWhtRm5bYWN0aXZpdHlOYW1lXSkgewoKCQkJCW1pc3NpbmdNZW1iZXIgPSB0cnVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWlmICh0YXJnZXQubm9kZVR5cGUpIHsKCQkJCWlmICghJGZuW2FjdGl2aXR5TmFtZV0pIHsKCQkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmICghKGFjdGl2aXR5TmFtZSBpbiB0YXJnZXQpKSB7CgkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJfQoJCX0KCgkJaWYgKG1pc3NpbmdNZW1iZXIpIHsKCQkJdGhyb3cgKGFjY2Vzc29yVHlwZSA9PSAiZ2V0IiA/ICJwdWJsaXNoZXIiIDogInN1YnNjcmliZXIiKSArCgkJCSAgICAgICIgZG9lcyBub3QgaGF2ZSBhIG1lbWJlciAiICsgYWN0aXZpdHlOYW1lOwoJCX0KCX0KCgkvL2FjdGl2aXR5VHlwZSBpcyBsaWtlIGluaXRpYWxpemUsIGNvbnZlcnQsIGZpbmFsaXplCgkvL2FjdGl2aXR5VHlwZSBmb3IgImdldCIsICJzZXQiIGlzIHRha2VuIGNhcmUgYnkgY29udmVydFN0cmluZ0FjY2Vzc29yVG9GdW5jdGlvbgoJZnVuY3Rpb24gY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggYWN0aXZpdHlUeXBlLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJLy9iZWNhdXNlIGl0IGlzIG9wdGlvbmFsLCB3ZSBuZWVkIG1ha2Ugc3VyZSBoYW5kbGVyIHdhbnQgdG8gaGF2ZSB0aGlzIG1ldGhvZAoJCXZhciBhY3Rpdml0eU5hbWUgPSBoYW5kbGVyW2FjdGl2aXR5VHlwZV07CgkJaWYgKGlzU3RyaW5nKCBhY3Rpdml0eU5hbWUgKSkgewoKCQkJaWYgKGFjdGl2aXR5TmFtZS5zdGFydHNXaXRoKCAiKiIgKSkgewoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApW2FjdGl2aXR5TmFtZS5zdWJzdHIoIDEgKV07CgkJCQlpZiAoIWhhbmRsZXJbYWN0aXZpdHlUeXBlXSkgewoJCQkJCXRocm93ICBhY3Rpdml0eU5hbWUgKyAiQWN0aXZpdHkgZG9lcyBub3QgZXhpc3RzIjsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoYWN0aXZpdHlOYW1lLnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWN0aXZpdHlOYW1lLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCX0gZWxzZSB7CgkJCQl0aHJvdyAnYWN0aXZpdHkgb3RoZXIgdGhhbiAiZ2V0IiBhbmQgInNldCIgIG11c3QgYmVnaW4gd2l0aCAiKiIgb3IgIiMiICc7CgoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHVuc3Vic2NyaWJlKCB0YXJnZXQgKSB7CgkJaWYgKGlzT2JqZWN0KCB0YXJnZXQgKSkgewoJCQlpZiAoIXZpZXdJZE1hbmFnZXIuZ2V0SWQoIHRhcmdldCApKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmlld0lkTWFuYWdlci51bk1hcmsoIHRhcmdldCApOwoJCX0KCQlzdWJzY3JpcHRpb25NYW5hZ2VyLnJlbW92ZUJ5KCB0YXJnZXQgKTsKCX0KCglobS5vbkRlbGV0ZU5vZGUoIHVuc3Vic2NyaWJlICk7CgoJLy9zdWJzY3JpcHRpb24gc2hvcnRjdXQgbWV0aG9kIGZvciBtb2RlbAoJZXh0ZW5kKCBobUZuLCB7CgoJCXRyaWdnZXI6IGZ1bmN0aW9uKCBzdWJQYXRoLCBldmVudE5hbWUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQl0aHJvdyAibWlzc2luZyBhcmd1bWVudHMiOwoJCQl9CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzKSB7CgkJCQlyZW1vdmVkID0gcHJvcG9zZWQ7CgkJCQlwcm9wb3NlZCA9IGV2ZW50TmFtZTsKCQkJCWV2ZW50TmFtZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSB0aGlzLnBoeXNpY2FsUGF0aCggc3ViUGF0aCApOwoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgZXZlbnROYW1lLCBwcm9wb3NlZCwgcmVtb3ZlZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl2YXIgcGh5c2ljYWxQYXRoID0gdGhpcy5waHlzaWNhbFBhdGgoIHN1YlBhdGggKSwKCQkJCXZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlclVwZGF0ZSIsIHZhbHVlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWI6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCQkJaG0uc3ViKCB0aGlzLnBhdGgsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlobS5zdWIoIG51bGwsIHRoaXMsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YkJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoJCQlobS5zdWIoIHN1YnNjcmliZXIsIHRoaXMucGF0aCwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YnNUb01lOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5UHVibGlzaGVyKCB0aGlzLnBhdGggKTsKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3Vic0Zyb21NZTogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeVN1YnNjcmliZXIoIHRoaXMucGF0aCApOwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzLnBhdGggKTsKCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8qCgkJIG1hcCBhbiBtb2RlbCBldmVudCB0byBhIG5ldyBtb2RlbCBldmVudCBiYXNlZCBvbiBhIGNvbmRpdGlvbiwgbGlrZSB0aGUgZm9sbG93aW5nCgoJCSBobSgiaW52ZW50b3J5IikubWFwRXZlbnQoCgkJICJhZnRlclVwZGF0ZSIsCgkJICJpbnZlbnRvcnlMb3ciLAoJCSBmdW5jdGlvbiAodmFsdWUpIHsKCQkgcmV0dXJuIHZhbHVlIDw9IDEwMDsKCQkgfQoJCSApOwoKCQkgY29uZGl0aW9uIGlzIG9wdGlvbmFsLCBpZiBpdCBpcyBtaXNzaW5nLCB0aGUgdGFyZ2V0IGV2ZW50IHdpbGwgYWx3YXlzIGJlIHRyaWdnZXJlZAoJCSB3aGVuIHRoZSBzb3VyY2UgZXZlbnQgaXMgdHJpZ2dlcmVkCgkJICovCgkJbWFwRXZlbnQ6IGZ1bmN0aW9uKCBzb3VyY2VFdmVudCwgdGFyZ2V0RXZlbnQsIGNvbmRpdGlvbiApIHsKCQkJY29uZGl0aW9uID0gY29uZGl0aW9uIHx8IHJldHVyblRydWU7CgkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIHRhcmdldEV2ZW50LCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJCX0KCQkJfSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljYWNoZWFibGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlobS5oYW5kbGUoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCAiaW5pdCBhZnRlcioiLCAiKnNhdmVMb2NhbCIgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX0gKTsKCgkvL3N1YnNjcmlwdGlvbiBzaG9ydGN1dCBtZXRob2QgZm9yIGpRdWVyeSBvYmplY3QKCWV4dGVuZCggJGZuLCB7CgoJCXN1YjogZnVuY3Rpb24oIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJaWYgKHRoaXMubGVuZ3RoKSB7CgkJCQlobS5zdWIoIHRoaXMsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlpZiAodGhpcy5sZW5ndGgpIHsKCQkJCWhtLnN1YiggbnVsbCwgdGhpcywgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWJCeTogZnVuY3Rpb24oIHN1YnNjcmliZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCWlmICh0aGlzLmxlbmd0aCkgewoJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCB0aGlzLCBldmVudHMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJc3Vic1RvTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlQdWJsaXNoZXIoIHRoaXNbMF0gKTsKCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCXN1YnNGcm9tTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlTdWJzY3JpYmVyKCB0aGlzWzBdICk7CgoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzWzBdICk7CgoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlyZW5kZXJWaWV3OiBmdW5jdGlvbiggcGF0aCwgd29ya2Zsb3csIG9wdGlvbnMgKSB7CgkJCWhtLnN1YiggdGhpcywgcGF0aCwgImluaXQiLCB3b3JrZmxvdywgb3B0aW9ucyApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKgoJCSBtYXAgYSB2aWV3IGV2ZW50IHRvIGEgbmV3IHZpZXcgZXZlbnQgYmFzZWQgb24gYSBjb25kaXRpb24sIGNvbmRpdGlvbiBpcyBvcHRpb25hbCwKCQkgaWYgaXQgaXMgbWlzc2luZywgdGhlIHRhcmdldCBldmVudCB3aWxsIGFsd2F5cyBiZSB0cmlnZ2VyZWQgd2hlbiB0aGUgc291cmNlCgkJIGV2ZW50IGlzIHRyaWdnZXJlZAoKCQkgdXNhZ2UKCQkgJCgiYnV0dG9uIikubWFwRXZlbnQoImNsaWNrIiwgInVwZGF0ZSIpOwoJCSAqLwoJCW1hcEV2ZW50OiBmdW5jdGlvbiggc291cmNlRXZlbnQsIHRhcmdldEV2ZW50LCBjb25kaXRpb24sIGV2ZW50RGF0YSApIHsKCQkJaWYgKGNvbmRpdGlvbikgewoJCQkJaWYgKCFpc0Z1bmN0aW9uKCBjb25kaXRpb24gKSkgewoJCQkJCWV2ZW50RGF0YSA9IGNvbmRpdGlvbjsKCQkJCQljb25kaXRpb24gPSByZXR1cm5UcnVlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY29uZGl0aW9uID0gcmV0dXJuVHJ1ZTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuaGFuZGxlKCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUudHlwZSA9IHRhcmdldEV2ZW50OwoJCQkJCWUuZXZlbnREYXRhID0gZXZlbnREYXRhOwoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIGUgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCgkvLyBjcmVhdGUgYSBzcGVjaWFsIGpRdWVyeSBldmVudCAoeSkgYmFzZWQgb24gYW4gZXhpc3RpbmcgalF1ZXJ5IGV2ZW50ICh4KQoJLy8gd2hlbiBldmVudCB4IGlzIHJhaXNlZCwgYW5kIGNvbmRpdGlvbiByZXR1cm5zIHRydWUsIGV2ZW50IHkgd2lsbCBiZSByYWlzZWQKCS8vCgkvLyB5b3UgY2FuIHN1YnNjcmliZSBldmVudCB5LCBqdXN0IGxpa2UgYW55IG90aGVyIGpRdWVyeSBldmVudCB1c2luZwoJLy8kKCJidXR0b24iKS5iaW5kKCJ5IiwgZm4pOwoJLy8KCS8vdW5saWtlICQoKS5tYXBFdmVudCgiY2xpY2siLCAieSIpLCB0aGlzIG1ldGhvZCBjcmVhdGUgYSBuZXcgZXZlbnQgdHlwZSBmb3IgYWxsCgkvL2pRdWVyeSBvYmplY3QKCWhtLm5ld0pxRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQsIGJhc2VFdmVudCwgY29uZGl0aW9uICkgewoJCWlmIChpc09iamVjdCggZXZlbnQgKSkgewoJCQlmb3IgKHZhciBrZXkgaW4gZXZlbnQpIHsKCQkJCWhtLm5ld0pxRXZlbnQoIGtleSwgZXZlbnRba2V5XVswXSwgZXZlbnRba2V5XVsxXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoY29uZGl0aW9uID09PSB0cnVlIHx8IGNvbmRpdGlvbi5jYWxsKCB0aGlzLCBlICkpIHsKCQkJCSQoIGUudGFyZ2V0ICkudHJpZ2dlciggZXh0ZW5kKCB7fSwgZSwgewoJCQkJCXR5cGU6IGV2ZW50LAoJCQkJCWN1cnJlbnRUYXJnZXQ6IGUudGFyZ2V0CgkJCQl9ICkgKTsKCQkJfQoJCX07CgoJCWlmICgkLmV2ZW50LnNwZWNpYWxbZXZlbnRdKSB7CgkJCXRocm93ICJldmVudCAnIiArIGV2ZW50ICsgIicgaGFzIGJlZW4gZGVmaW5lZCI7CgkJfQoKCQkkLmV2ZW50LnNwZWNpYWxbZXZlbnRdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggYmFzZUV2ZW50LCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIGJhc2VFdmVudCwgaGFuZGxlciApOwoJCQl9CgkJfTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIF9jbGVhbkRhdGFGb3JVbnN1YnNjcmliZSA9ICQuY2xlYW5EYXRhOwoJLy93aGVuIGFuIGRvbSBlbGVtZW50IGlzIHJlbW92ZSB1bnN1YnNjcmliZSBpdCBmaXJzdAoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdW5zdWJzY3JpYmUoIHRoaXMgKTsKCQl9ICk7CgkJX2NsZWFuRGF0YUZvclVuc3Vic2NyaWJlKCBlbGVtcyApOwoJfTsKCgl1dGlsLmdldFVuaXF1ZVZpZXdFdmVudFR5cGVzID0gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlczsKCXV0aWwuX3ZpZXdIYW5kbGVyR2F0ZXdheSA9IHZpZXdIYW5kbGVyR2F0ZXdheTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qczwvQGRlcGVuZHM+CgoKCXZhciByU3Vic2NyaXB0aW9uUHJvcGVydHkgPSAvKFshJF0/KShbXHcgXCtcLVwqXC5dKz8pOihbXHdcV10rPylccyooPzpbO11ccyp8JCkvZywKCQlyQmluZGluZ1RleHQgPSAvXihbXnxdKykoXHwoLiopKT8kLywKCQlyU3Vic2NyaXB0aW9uVmFsdWVTZXBhcmF0b3IgPSAvXHMqXHxccyovZzsKCglkZWZhdWx0T3B0aW9ucy5zdWJzQXR0ciA9ICJkYXRhLXN1YiI7CglkZWZhdWx0T3B0aW9ucy5hdXRvUGFyc2UgPSB0cnVlOwoKCWZ1bmN0aW9uIG1lcmdlT3B0aW9ucyggcGFyZW50T3B0aW9ucywgbG9jYWxPcHRpb25zICkgewoJCWlmIChsb2NhbE9wdGlvbnMgIT09ICJfIikgewoJCQlyZXR1cm4gIChsb2NhbE9wdGlvbnMgJiYgbG9jYWxPcHRpb25zLnN0YXJ0c1dpdGgoICJfIiApKSA/CgkJCQlsb2NhbE9wdGlvbnMuc3Vic3RyKCAxICkgOgoJCQkJcGFyZW50T3B0aW9ucyB8fCBsb2NhbE9wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGdldEluaGVyaXRlZE5hbWVzcGFjZSggZWxlbSApIHsKCgkJdmFyICRwYXJlbnQgPSAkKCBlbGVtICk7CgoJCXdoaWxlICgoJHBhcmVudCA9ICRwYXJlbnQucGFyZW50KCkpICYmICRwYXJlbnQubGVuZ3RoKSB7CgoJCQl2YXIgbnMgPSAkcGFyZW50LmhtRGF0YSggIm5zIiApOwoKCQkJaWYgKCFpc1VuZGVmaW5lZCggbnMgKSkgewoJCQkJcmV0dXJuIG5zOwoJCQl9CgkJfQoJCXJldHVybiAiIjsKCX0KCgl2YXIgcmVVbmRlcnNjb3JlID0gL18vZzsKCXZhciByZUF0dHJEYXNoID0gLy0oXHcpL2c7Cgl2YXIgckRhdGFBdHRyUHJlZml4ID0gL15kYXRhLS87CgoJdmFyIHJlcGxhY2VBdHRyRGFzaFdpdGhDYXBpdGFsQ2hhcmFjdGVyID0gZnVuY3Rpb24oIG1hdGNoLCAkMSApIHsKCQlyZXR1cm4gJDEudG9VcHBlckNhc2UoKTsKCX07CgoJLy9jb252ZXJ0IGFkZC1jbGFzcyB0byBhZGRDbGFzcwoJLy9jb252ZXJ0ICRlbnRlcl9ibHVyIHRvICRlbnRlciBibHVyCglmdW5jdGlvbiBub3JtYWxpemVBdHRyaWJ1dGVOYW1lKCBhdHRyaWJ1dGVOYW1lICkgewoJCWF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoIHJEYXRhQXR0clByZWZpeCwgIiIgKTsKCgkJLy9pZiBzdWJzY3JpcHRpb24gaW52b2x2ZSB3aXRoIG1vcmUgdGhhbiBvbmUgZXZlbnRzLCB5b3UgY2FuCgkJLy9jb25jYXRlbmF0ZSB0aGVtIHdpdGggIl8iLCBoZXJlIHdlIG5lZWQgdG8gcmV2ZXJ0IHRoZW0gYmFjawoJCS8vc3VjaCBhcyAiJGNsaWNrX21vdXNlb3ZlciIgbmVlZCB0byBiZSBjaGFuZ2VkIHRvICIkY2xpY2sgbW91c2VvdmVyIgoJCWlmIChhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIhIiApIHx8IGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiQiICkpIHsKCgkJCWF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoIHJlVW5kZXJzY29yZSwgIiAiICk7CgoJCX0KCQlyZXR1cm4gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByZUF0dHJEYXNoLCByZXBsYWNlQXR0ckRhc2hXaXRoQ2FwaXRhbENoYXJhY3RlciApOwoJfQoKCWZ1bmN0aW9uIGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICkgewoJCWlmIChlbGVtLm5vZGVUeXBlICE9PSAxKSB7CgkJCXJldHVybjsKCQl9CgkJdmFyIGksCgkJCWF0dHIsCgkJCWF0dHJpYnV0ZU5hbWUsCgkJCWF0dHJpYnV0ZXMgPSBlbGVtLmF0dHJpYnV0ZXMsCgkJCXN1YnNjcmlwdGlvblRleHQgPSBhdHRyaWJ1dGVzW2RlZmF1bHRPcHRpb25zLnN1YnNBdHRyXSAmJiBhdHRyaWJ1dGVzW2RlZmF1bHRPcHRpb25zLnN1YnNBdHRyXS5ub2RlVmFsdWUgfHwgIiI7CgoJCWZvciAoaSA9IDA7IGkgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAoYXR0ci5uYW1lICE9PSBkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cikgewoJCQkJYXR0cmlidXRlTmFtZSA9IG5vcm1hbGl6ZUF0dHJpYnV0ZU5hbWUoIGF0dHIubmFtZSApOwoJCQkJLy9pZiBhdHRyaWJ1dGVOYW1lIGlzIHJlY29nbml6ZWQgYnkgdGhlIEhtLmpzLAoJCQkJLy8gc3VjaCBhcyBucz0ieHh4IiwgYmluZGluZ05hbWU9Inh4eCIsICFldmVudD0ieHh4IiAsICRldmVudD0ieHh4IgoJCQkJLy9leHRyYWN0IHRoZW0gYW5kIGFwcGVuZCB0byB0aGUgc3Vic2NyaXB0aW9uIHRleHQKCQkJCWlmIChhdHRyaWJ1dGVOYW1lID09ICJucyIgfHwgX2JpbmRpbmdzW2F0dHJpYnV0ZU5hbWVdKSB7CgkJCQkJLy9pZiB0aGUgYXR0cmlidXRlIGRvZXMgbm90IGhhdmUgYSB2YWx1ZSBsaWtlIDxkaXYgZGVidWc+CgkJCQkJLy9pdCBpcyB0aGUgc2FtZSBhcyA8ZGl2IGRlYnVnPSIvIj4KCQkJCQlzdWJzY3JpcHRpb25UZXh0ID0gc3Vic2NyaXB0aW9uVGV4dCArICI7IiArIGF0dHJpYnV0ZU5hbWUgKyAiOiIgKyAoYXR0ci5ub2RlVmFsdWUgfHwgIi8iKTsKCgkJCQl9IGVsc2UgaWYgKGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiEiICkgfHwgYXR0cmlidXRlTmFtZS5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJCXZhciBub2RlVmFsdWVzID0gYXR0ci5ub2RlVmFsdWUuc3BsaXQoICI7IiApOwoJCQkJCWZvciAodmFyIGogPSAwOyBqIDwgbm9kZVZhbHVlcy5sZW5ndGg7IGorKykgewoJCQkJCQl2YXIgbm9kZVZhbHVlID0gbm9kZVZhbHVlc1tqXTsKCQkJCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHN1YnNjcmlwdGlvblRleHQgKyAiOyIgKyBhdHRyaWJ1dGVOYW1lICsgIjoiICsgbm9kZVZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJdmFyIHRhZ0JpbmRpbmdOYW1lID0gInRhZ18iICsgZWxlbS50YWdOYW1lOwoJCWlmIChfYmluZGluZ3NbdGFnQmluZGluZ05hbWVdKSB7CgkJCXN1YnNjcmlwdGlvblRleHQgPSBzdWJzY3JpcHRpb25UZXh0ICsgIjsiICsgdGFnQmluZGluZ05hbWUgKyAiOi4iOwoJCX0KCQlyZXR1cm4gc3Vic2NyaXB0aW9uVGV4dC5yZXBsYWNlKCAvXjsvLCAiIiApOwoJfQoKCS8vc3VwcG9ydAoJLy9uZXcgQmluZGluZygpCgkvL25ldyBCaW5kaW5nKHN1YnNjcmlwdGlvblRleHQsIHBhcmVudEJpbmRpbmcpCgkvL25ldyBCaW5kaW5nKCIkY2xpY2t8KmFsZXJ0O3ZhbDpwYXRoIiwgcGFyZW50QmluZGluZyk7CglmdW5jdGlvbiBCaW5kaW5nKCBzdWJzY3JpcHRpb25UZXh0LCBwYXJlbnRCaW5kaW5nLCBiaW5kaW5nTnMsIGJpbmRpbmdPcHRpb25zICkgewoKCQl2YXIgbnNQcm9wZXJ0eSwgbWF0Y2gsIGVtcHR5QmluZGluZzsKCgkJLy9oYW5kbGUgdGhlIGNhc2U6IG5ldyBCaW5kaW5nKCkKCQlpZiAoIXN1YnNjcmlwdGlvblRleHQpIHsKCQkJLy8KCQkJLy9zaGFyZWQgcHJvcGVydHkKCQkJdGhpcy5zdWJzY3JpcHRpb25zID0gW107CgkJCXJldHVybjsKCQl9CgoJCS8vaGFuZGxlIHRoZSBjYXNlIDogbmV3IEJpbmRpbmcgKGVsZW0pOwoJCWlmIChzdWJzY3JpcHRpb25UZXh0Lm5vZGVUeXBlKSB7CgkJCXZhciBlbGVtID0gc3Vic2NyaXB0aW9uVGV4dDsKCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHBhcmVudEJpbmRpbmcgfHwgZXh0cmFjdFN1YnNjcmlwdGlvblRleHQoIGVsZW0gKTsKCQkJaWYgKHN1YnNjcmlwdGlvblRleHQpIHsKCQkJCWVtcHR5QmluZGluZyA9IG5ldyBCaW5kaW5nKCk7CgkJCQllbXB0eUJpbmRpbmcuZWxlbSA9IGVsZW07CgkJCQllbXB0eUJpbmRpbmcubnMgPSBnZXRJbmhlcml0ZWROYW1lc3BhY2UoIGVsZW0gKTsKCQkJCXJldHVybiBuZXcgQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgZW1wdHlCaW5kaW5nICk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCFwYXJlbnRCaW5kaW5nKSB7CgkJCWVtcHR5QmluZGluZyA9IG5ldyBCaW5kaW5nKCk7CgkJCS8vZmFrZSBhbiBlbGVtCgkJCWVtcHR5QmluZGluZy5lbGVtID0ge307CgkJCXJldHVybiBuZXcgQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgZW1wdHlCaW5kaW5nICk7CgkJfQoKCQkvL2hhbmRsZSB0aGUgY2FzZTogbmV3IEJpbmRpbmcoc3Vic2NyaXB0aW9uVGV4dCwgcGFyZW50QmluZGluZyk7CgkJLy8KCQkvL3ByaXZhdGUgZGF0YQoJCXRoaXMuc3ViID0gW107CgkJdGhpcy5wdWIgPSBbXTsKCQl0aGlzLmJpbmRpbmdzID0gW107CgoJCXdoaWxlICgobWF0Y2ggPSByU3Vic2NyaXB0aW9uUHJvcGVydHkuZXhlYyggc3Vic2NyaXB0aW9uVGV4dCApKSkgewoKCQkJdmFyIHByZWZpeCA9IG1hdGNoWzFdLAoJCQkJcHJvcCA9ICQudHJpbSggbWF0Y2hbMl0gKSwKCQkJCXZhbHVlID0gJC50cmltKCBtYXRjaFszXSApOwoKCQkJaWYgKHByZWZpeCkgewoKCQkJCXRoaXNbcHJlZml4ID09ICIkIiA/ICJwdWIiIDogInN1YiJdLnB1c2goIHsgZXZlbnRUeXBlczogcHJvcCwgdmFsdWU6IHZhbHVlIH0gKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKHByb3AgPT0gIm5zIikgewoJCQkJCW5zUHJvcGVydHkgPSB2YWx1ZTsKCgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuYmluZGluZ3MucHVzaCggeyBiaW5kaW5nTmFtZTogcHJvcCwgdmFsdWU6IHZhbHVlfSApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLm5zID0gbWVyZ2VQYXRoKCBtZXJnZVBhdGgoIHBhcmVudEJpbmRpbmcubnMsIGJpbmRpbmdOcyApLCBuc1Byb3BlcnR5ICk7CgkJLy9zaGFyZWQgZGF0YQoJCXRoaXMudGV4dCA9IHN1YnNjcmlwdGlvblRleHQ7CgkJdGhpcy5lbGVtID0gcGFyZW50QmluZGluZy5lbGVtOwoJCS8vdGhpcyBpcyBhIHNpbmdsZXRvbgoJCS8vdGhpcy5zdWJzY3JpcHRpb25zID0gcGFyZW50QmluZGluZy5zdWJzY3JpcHRpb25zOwoKCQlpZiAocGFyZW50QmluZGluZy5jb250ZXh0KSB7CgoJCQl0aGlzLmNvbnRleHQgPSBwYXJlbnRCaW5kaW5nLmNvbnRleHQ7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmNvbnRleHQgPSB0aGlzOwoJCQl0aGlzLmR5bmFtaWNCaW5kaW5ncyA9IFtdOwoJCQl0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTsKCQkJJCggdGhpcy5lbGVtICkuaG1EYXRhKCAibnMiLCB0aGlzLm5zICk7CgkJfQoKCQl0aGlzLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoIHBhcmVudEJpbmRpbmcub3B0aW9ucywgYmluZGluZ09wdGlvbnMgKTsKCgkJdGhpcy5faW1wb3J0QmluZGluZ3MoKTsKCQl0aGlzLl9pbXBvcnRTdWJzY3JpcHRpb25zKCAic3ViIiApOwoJCXRoaXMuX2ltcG9ydFN1YnNjcmlwdGlvbnMoICJwdWIiICk7CgoJfQoKCUJpbmRpbmcucHJvdG90eXBlID0gewoKCQlfaW1wb3J0QmluZGluZ3M6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQliaW5kaW5nTmFtZSwKCQkJCXdlbGxrbm93bkJpbmRpbmcsCgkJCQliaW5kaW5nLAoJCQkJc3ViVGV4dFBhcnRzLAoJCQkJYmluZGluZ05zLAoJCQkJYmluZGluZ09wdGlvbnMsCgkJCQliaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CgoJCQlmb3IgKGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKCgkJCQliaW5kaW5nID0gYmluZGluZ3NbaV07CgkJCQliaW5kaW5nTmFtZSA9IGJpbmRpbmcuYmluZGluZ05hbWU7CgoJCQkJLy9pZiB2YWx1ZSBpcyAicGF0aHxvcHRpb24xfG9wdGlvbjIiCgkJCQkvLwoJCQkJc3ViVGV4dFBhcnRzID0gckJpbmRpbmdUZXh0LmV4ZWMoIGJpbmRpbmcudmFsdWUgKTsKCQkJCWJpbmRpbmdOcyA9IHN1YlRleHRQYXJ0c1sxXTsgLy8gInBhdGgiCgkJCQliaW5kaW5nT3B0aW9ucyA9IHN1YlRleHRQYXJ0c1szXTsgLy8ib3B0aW9uMXxvcHRpb24yIgoKCQkJCXdlbGxrbm93bkJpbmRpbmcgPSBfYmluZGluZ3NbYmluZGluZ05hbWVdOwoKCQkJCWlmIChpc0Z1bmN0aW9uKCB3ZWxsa25vd25CaW5kaW5nICkpIHsKCgkJCQkJdmFyIHRlbXAgPSBbCgkJCQkJCXdlbGxrbm93bkJpbmRpbmcsCgkJCQkJCXRoaXMuZWxlbSwKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBiaW5kaW5nTnMgKSwKCQkJCQkJdGhpcywKCQkJCQkJbWVyZ2VPcHRpb25zKCB0aGlzLm9wdGlvbnMsIGJpbmRpbmdPcHRpb25zICkKCQkJCQldOwoKCQkJCQlpZiAoYmluZGluZ05hbWUgPT0gInJ1bkZpcnN0IikgewoKCQkJCQkJdGhpcy5jb250ZXh0LnJ1bkZpcnN0ID0gdGVtcDsKCgkJCQkJfSBlbHNlIGlmIChiaW5kaW5nTmFtZSA9PSAicnVuTGFzdCIpIHsKCgkJCQkJCXRoaXMuY29udGV4dC5ydW5MYXN0ID0gdGVtcDsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXRoaXMuY29udGV4dC5keW5hbWljQmluZGluZ3MucHVzaCggdGVtcCApOwoJCQkJCX0KCgkJCQl9IGVsc2UgaWYgKGlzU3RyaW5nKCB3ZWxsa25vd25CaW5kaW5nICkpIHsKCgkJCQkJLy9yZWN1cnNpdmVseSBpbXBvcnQgcmVmZXJlbmNlZEJpbmRpbmcKCQkJCQluZXcgQmluZGluZyggd2VsbGtub3duQmluZGluZywgdGhpcywgYmluZGluZ05zLCBiaW5kaW5nT3B0aW9ucyApOwoKCQkJCX0KCQkJfQoJCX0sCgoJCS8vc3Vic2NyaXB0aW9uVHlwZSBpcyBlaXRoZXIgInB1YiIgb3IgInN1YiIKCQlfaW1wb3J0U3Vic2NyaXB0aW9uczogZnVuY3Rpb24oIHN1YnNjcmlwdGlvblR5cGUgKSB7CgoJCQl2YXIgaSwKCQkJCXN1YnNjcmlwdGlvbkVudHJ5LAoJCQkJc3Vic2NyaXB0aW9uUGFydHMsCgkJCQlwdWJsaXNoZXIsCgkJCQlldmVudFR5cGVzLAoJCQkJc3Vic2NyaWJlciwKCQkJCXN1YnNjcmlwdGlvbkVudHJpZXMgPSB0aGlzW3N1YnNjcmlwdGlvblR5cGVdOwoKCQkJZm9yIChpID0gMDsgaSA8IHN1YnNjcmlwdGlvbkVudHJpZXMubGVuZ3RoOyBpKyspIHsKCgkJCQlzdWJzY3JpcHRpb25FbnRyeSA9IHN1YnNjcmlwdGlvbkVudHJpZXNbaV07CgkJCQlldmVudFR5cGVzID0gc3Vic2NyaXB0aW9uRW50cnkuZXZlbnRUeXBlczsKCgkJCQlzdWJzY3JpcHRpb25QYXJ0cyA9IHN1YnNjcmlwdGlvbkVudHJ5LnZhbHVlLnNwbGl0KCByU3Vic2NyaXB0aW9uVmFsdWVTZXBhcmF0b3IgKTsKCgkJCQlpZiAoc3Vic2NyaXB0aW9uVHlwZSA9PSAic3ViIikgewoKCQkJCQkvL3BhdGh8aGFuZGxlcnxvcHRpb25zfGRlbGVnYXRlCgkJCQkJcHVibGlzaGVyID0gc3Vic2NyaXB0aW9uUGFydHNbMF07CgoJCQkJCXB1Ymxpc2hlciA9IHB1Ymxpc2hlci5zdGFydHNXaXRoKCAiJCIgKSA/CgkJCQkJCXB1Ymxpc2hlciA6IC8vcHVibGlzaGVyIGlzIGEgdmlldwoJCQkJCQltZXJnZVBhdGgoIHRoaXMubnMsIHB1Ymxpc2hlciApOwoKCQkJCQlzdWJzY3JpYmVyID0gdGhpcy5lbGVtOwoKCQkJCX0gZWxzZSB7CgkJCQkJLy9wYXRofGhhbmRsZXJ8b3B0aW9uc3xkZWxlZ2F0ZQoJCQkJCXB1Ymxpc2hlciA9IHRoaXMuZWxlbTsKCgkJCQkJc3Vic2NyaWJlciA9IHN1YnNjcmlwdGlvblBhcnRzWzBdOwoJCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpYmVyLnN0YXJ0c1dpdGgoICIkIiApID8KCQkJCQkJc3Vic2NyaWJlciA6IC8vc3Vic2NyaWJlciBpcyBhIHZpZXcKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBzdWJzY3JpYmVyICk7CgkJCQl9CgoJCQkJdGhpcy5hcHBlbmRTdWIoCgkJCQkJc3Vic2NyaWJlciwKCQkJCQlwdWJsaXNoZXIsCgkJCQkJZXZlbnRUeXBlcywKCQkJCQlzdWJzY3JpcHRpb25QYXJ0c1sxXSwgLy9oYW5kbGVyCgkJCQkJdG9UeXBlZFZhbHVlKCBtZXJnZU9wdGlvbnMoIHRoaXMub3B0aW9ucywgc3Vic2NyaXB0aW9uUGFydHNbMl0gKSApLCAvL29wdGlvbnMKCQkJCQlzdWJzY3JpcHRpb25QYXJ0c1szXSAvL2RlbGVnYXRlCgkJCQkpOwoJCQl9CgoJCX0sCgoJCWFwcGVuZFN1YjogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCXRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zLnB1c2goIHsKCQkJCXB1Ymxpc2hlcjogcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlczogZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXI6IHN1YnNjcmliZXIsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJb3B0aW9uczogb3B0aW9ucywKCQkJCWRlbGVnYXRlOiBkZWxlZ2F0ZQoJCQl9ICk7CgkJfSwKCgkJcHJlcGVuZFN1YjogZnVuY3Rpb24gcHJlcGVuZFN1Yiggc3Vic2NyaWJlciwgcHVibGlzaGVyLCBldmVudFR5cGVzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJdGhpcy5jb250ZXh0LnN1YnNjcmlwdGlvbnMudW5zaGlmdCggewoJCQkJcHVibGlzaGVyOiBwdWJsaXNoZXIsCgkJCQlldmVudFR5cGVzOiBldmVudFR5cGVzLAoJCQkJc3Vic2NyaWJlcjogc3Vic2NyaWJlciwKCQkJCWhhbmRsZXI6IGhhbmRsZXIsCgkJCQlvcHRpb25zOiBvcHRpb25zLAoJCQkJZGVsZWdhdGU6IGRlbGVnYXRlCgkJCX0gKTsKCQl9LAoKCQljbGVhclN1YnM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmNvbnRleHQuc3Vic2NyaXB0aW9ucy5zcGxpY2UoIDAsIHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGggKTsKCQl9Cgl9OwoKCWZ1bmN0aW9uIHBhcnNlU3VicyggZWxlbSApIHsKCgkJdmFyIHN1YnNjcmlwdGlvblRleHQsCgkJCWNvbnRleHQsCgkJCXN1YnNjcmlwdGlvbnMsCgkJCWksCgkJCXN1YnNjcmlwdGlvbiwKCQkJJGVsZW0gPSAkKCBlbGVtICk7CgoJCWlmICghJGVsZW0uaG1EYXRhKCAicGFyc2VkIiApICYmIChzdWJzY3JpcHRpb25UZXh0ID0gZXh0cmFjdFN1YnNjcmlwdGlvblRleHQoIGVsZW0gKSkpIHsKCgkJCWNvbnRleHQgPSBuZXcgQmluZGluZyggZWxlbSwgc3Vic2NyaXB0aW9uVGV4dCApOwoJCQlzdWJzY3JpcHRpb25zID0gY29udGV4dC5zdWJzY3JpcHRpb25zOwoKCQkJdmFyIHJ1bkZpcnN0ID0gY29udGV4dC5ydW5GaXJzdDsKCQkJaWYgKHJ1bkZpcnN0KSB7CgkJCQlydW5GaXJzdFswXSggcnVuRmlyc3RbMV0sIHJ1bkZpcnN0WzJdLCBydW5GaXJzdFszXSwgcnVuRmlyc3RbNF0gKTsKCQkJfQoKCQkJdmFyIGR5bmFtaWNCaW5kaW5ncyA9IGNvbnRleHQuZHluYW1pY0JpbmRpbmdzOwoJCQlmb3IgKGkgPSAwOyBpIDwgZHluYW1pY0JpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgZHluYW1pY0JpbmRpbmcgPSBkeW5hbWljQmluZGluZ3NbaV07CgkJCQlkeW5hbWljQmluZGluZ1swXSggZHluYW1pY0JpbmRpbmdbMV0sIGR5bmFtaWNCaW5kaW5nWzJdLCBkeW5hbWljQmluZGluZ1szXSwgZHluYW1pY0JpbmRpbmdbNF0gKTsKCQkJfQoKCQkJdmFyIHJ1bkxhc3QgPSBjb250ZXh0LnJ1bkxhc3Q7CgkJCWlmIChydW5MYXN0KSB7CgkJCQlydW5MYXN0WzBdKCBydW5MYXN0WzFdLCBydW5MYXN0WzJdLCBydW5MYXN0WzNdLCBydW5MYXN0WzRdICk7CgkJCX0KCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7CgoJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc1tpXTsKCQkJCWhtLnN1YigKCQkJCQlzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwKCQkJCQlzdWJzY3JpcHRpb24ucHVibGlzaGVyLAoJCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLAoJCQkJCXN1YnNjcmlwdGlvbi5oYW5kbGVyLAoJCQkJCXN1YnNjcmlwdGlvbi5vcHRpb25zLAoJCQkJCXN1YnNjcmlwdGlvbi5kZWxlZ2F0ZQoJCQkJKTsKCQkJfQoKCgkJCS8vCgkJCSRlbGVtLmhtRGF0YSggInBhcnNlZCIsIHRydWUgKTsKCQl9CgoJCSRlbGVtLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX0KCgkvL2RlbGF5IGF1dG8gcGFyc2UgdG8gd2F5IGZvciBzb21lIGRlcGVuZGVuY2llcyB0byByZXNvbHZlIGFzeW5jaHJvbm91c2x5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkKCBmdW5jdGlvbigpIHsKCQkJaWYgKGRlZmF1bHRPcHRpb25zLmF1dG9QYXJzZSkgewoJCQkJcGFyc2VTdWJzKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCQkJfQoJCX0gKTsKCX0sIDEgKTsKCgkkZm4ucGFyc2VTdWJzID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX07CgoJdmFyIGxvZ01vZGVsID0gaG0oICIqbG9nIiwgW10gKTsKCgl2YXIgX2JpbmRpbmdzID0ge307CgoJZnVuY3Rpb24gYmluZGluZ3MoIG5hbWUsIGRlZmluaXRpb24sIGlzVGFnICkgewoJCWlmICghbmFtZSkgewoJCQlyZXR1cm4gX2JpbmRpbmdzOwoJCX0KCgkJaWYgKCFkZWZpbml0aW9uKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQliaW5kaW5ncygga2V5LCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBfYmluZGluZ3NbbmFtZV07CgkJCX0KCQl9CgoJCWlmIChpc0FycmF5KCBkZWZpbml0aW9uICkpIHsKCQkJZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uY29uY2F0KCAiOyIgKTsKCQl9CgoJCV9iaW5kaW5nc1tpc1RhZyA/ICJ0YWdfIiArIG5hbWUudG9VcHBlckNhc2UoKSA6IG5hbWVdID0gZGVmaW5pdGlvbjsKCQlyZXR1cm4gdGhpczsKCX0KCglleHRlbmQoIGhtLCB7CgoJCWJpbmRpbmc6IGJpbmRpbmdzLAoKCgkJbG9nOiBmdW5jdGlvbiggbWVzc2FnZSwgY29sb3IgKSB7CgkJCW1lc3NhZ2UgPSBtZXNzYWdlICsgIiI7CgkJCW1lc3NhZ2UgPSBjb2xvciA/ICI8ZGl2IHN0eWxlPSdjb2xvcjoiICsgY29sb3IgKyAiJz4iICsgbWVzc2FnZSArICI8L2Rpdj4gIiA6IG1lc3NhZ2U7CgkJCWxvZ01vZGVsLnB1c2goIG1lc3NhZ2UgKTsKCQl9LAoKCQljbGVhcmxvZzogZnVuY3Rpb24oKSB7CgkJCWxvZ01vZGVsLmNsZWFyKCk7CgkJfQoJfSApOwoKCWZ1bmN0aW9uIGFkaG9jQmluZGluZyggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQlyb290Tm9kZS5nZXQoIHBhdGgsIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKTsKCX0KCgliaW5kaW5ncyggInJ1bkZpcnN0IiwgYWRob2NCaW5kaW5nICk7CgliaW5kaW5ncyggInJ1bkxhc3QiLCBhZGhvY0JpbmRpbmcgKTsKCgoJLy9zdGFydCBvZiBsb2FkZXIgY29yZS5qcwoJdmFyIHVybFN0b3JlID0ge30sCgkJcHJvbWlzZVN0b3JlID0ge30sCgkJZGVwZW5kZW5jeVN0b3JlID0ge30sCgkJbG9hZGVyRGVmaW5pdGlvblN0b3JlID0ge30sCgkJbG9hZGVyU3RvcmUgPSB7fSwKCQlkdW1teUxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQlyQ29tbWEgPSAvLC8sCgkJclNwYWNlID0gL1xzKy9nLAoJCXJRdWVyeSA9IC9cPy8sCgkJckZpbGVFeHQgPSAvXC4oXHcrKSQvLAoJCXJGaWxlTmFtZSA9IC8oLispXC5cdyskLywKCQlmaWxlRXh0ZW5zaW9uLAoJCWZpbGVOYW1lLAoJCWNvbW1vbkxvYWRlck1ldGhvZHMsCgkJY29tbW9uTG9hZEZpbHRlcnMsCgkJZGVwZW5kLAoJLy9tYXRjaCAiaHR0cDovL2RvbWFpbi5jb20iICwgIi9qa2oiCgkJckFic29sdXRlVXJsID0gL15odHRwW3NdPzpcL1wvfF5cLy8sCgkJclVybFBhcnRzID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKSk/KT8vLAoJCWFqYXhMb2NQYXJ0cyA9IHJVcmxQYXJ0cy5leGVjKCBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkgKSB8fCBbXSwKCQloYXNoVmFsdWUgPSAiIiwKCQloYXNoS2V5ID0gInYiLAoJCXJWZXJzaW9uSGFzaCwKCQlsb2FkQ2FsbGJhY2tzID0gW10sCgkJZmFpbENhbGxiYWNrcyA9IFtdLAoJCXVubG9hZENhbGxiYWNrcyA9IFtdLAoKCQlsb2FkZXJGaW5kZXJzLAoJCWZpbGVFeHRUb0xvYWRlck1hcHBlciA9IHt9LAoJCWJhc2VVcmwgPSAiIiwKCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZyBvdmVybG9hZGluZwoJLy9obS5sb2FkZXIoImFwcCIpOyAvL3JldHJpZXZlIGxvYWRlcgoJLy9obS5sb2FkZXIoImFwcCIsIGRlZmluaXRpb24pOyAvL2NyZWF0ZSBhIGxvYWRlciBmcm9tIHNjcmF0Y2gKCS8vaG0ubG9hZGVyKCJhcHAiLCAianMiLCBkZWZpbml0aW9uKTsgLy9jcmVhdGUgYSBsb2FkZXIgYnkgZXh0ZW5kaW5nIGEgbmV3IGxvYWRlcgoJCV9sb2FkZXIgPSBobS5sb2FkZXIgPSBmdW5jdGlvbiggbG9hZGVyTmFtZSwgYmFzZUxvYWRlck5hbWUsIGxvYWRlckRlZmluaXRpb24gKSB7CgoKCQkJLy9yZXRyaWV2ZSB0aGUgbG9hZGVyIGJ5IG5hbWUKCQkJaWYgKGlzVW5kZWZpbmVkKCBiYXNlTG9hZGVyTmFtZSApKSB7CgoJCQkJcmV0dXJuIGxvYWRlck5hbWUgPyBsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA6IGxvYWRlclN0b3JlOwoKCQkJfQoKCQkJLy9jcmVhdGUgYSBuZXcgbG9hZGVyCgkJCWlmICghaXNTdHJpbmcoIGJhc2VMb2FkZXJOYW1lICkpIHsKCQkJCWxvYWRlckRlZmluaXRpb24gPSBiYXNlTG9hZGVyTmFtZTsKCQkJCWJhc2VMb2FkZXJOYW1lID0gbnVsbDsKCQkJfQoKCQkJbG9hZGVyRGVmaW5pdGlvbiA9IGxvYWRlckRlZmluaXRpb25TdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKAoJCQkJdHJ1ZSwKCQkJCXt9LAoJCQkJbG9hZGVyRGVmaW5pdGlvblN0b3JlW2Jhc2VMb2FkZXJOYW1lXSwKCQkJCWxvYWRlckRlZmluaXRpb24gKTsKCgkJCXZhciBsb2FkZXIgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGxvYWRlckRlZmluaXRpb24gKTsKCgkJCSQuZWFjaCggImxvYWQsdW5sb2FkLHVybCxkZXBlbmQiLnNwbGl0KCAiLCIgKSwgZnVuY3Rpb24oIGluZGV4LCBtZXRob2ROYW1lICkgewoJCQkJdmFyIGNvbW1vbk1ldGhvZE5hbWUgPSBsb2FkZXJbbWV0aG9kTmFtZV07CgkJCQlpZiAoaXNTdHJpbmcoIGNvbW1vbk1ldGhvZE5hbWUgKSkgewoJCQkJCXZhciBsb2FkZXJNZXRob2QgPSBjb21tb25Mb2FkZXJNZXRob2RzW21ldGhvZE5hbWVdW2NvbW1vbk1ldGhvZE5hbWVdOwoJCQkJCWlmIChsb2FkZXJNZXRob2QpIHsKCQkJCQkJbG9hZGVyW21ldGhvZE5hbWVdID0gbG9hZGVyTWV0aG9kOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoKCQkJaWYgKCQuaXNQbGFpbk9iamVjdCggbG9hZGVyLmxvYWQgKSkgewoJCQkJLy9pdCBpcyBhIHBpcGVsaW5lLCBidXQgbm90IGEgZnVuY3Rpb24KCQkJCWxvYWRlci5sb2FkID0gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkZXIubG9hZCApOwoKCQkJfQoKCQkJaWYgKCEkLmlzRnVuY3Rpb24oIGxvYWRlci5sb2FkICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIGxvYWQgZnVuY3Rpb24gZnJvbSBsb2FkZXIiOwoJCQl9CgoJCQlsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKCB7fSwgbG9hZGVyU3RvcmVbYmFzZUxvYWRlck5hbWVdLCBsb2FkZXIgKTsKCQl9OwoKCWZ1bmN0aW9uIGludm9rZUNhbGxiYWNrcyggY2FsbGJhY2tzICkgewoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKCQkJCWNhbGxiYWNrc1tpXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9OwoJfQoKCXZhciBpbnZva2VGYWlsQ2FsbGJhY2tzID0gaW52b2tlQ2FsbGJhY2tzKCBmYWlsQ2FsbGJhY2tzICksCgkJaW52b2tlTG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggbG9hZENhbGxiYWNrcyApLAoJCWludm9rZVVubG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggdW5sb2FkQ2FsbGJhY2tzICk7CgoJZnVuY3Rpb24gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgoJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoKCQkJaWYgKGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIpIHsKCQkJCXZhciBpID0gMSwKCQkJCQlrZXlzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoKCQkJCS8vY3JlYXRlIGRlcGVuZGVuY3kgaW4gb3JkZXIKCQkJCXdoaWxlIChpIDwga2V5cy5sZW5ndGgpIHsKCQkJCQlkZXBlbmQoIGtleXNbaV0sIGtleXNbaSAtIDFdICk7CgkJCQkJaSsrOwoJCQkJfQoJCQkJYXNzZXRJZHMgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV07CgkJCX0KCgkJCXJldHVybiBsb2FkQXNzZXRzSW5QYXJhbGxlbCggYXNzZXRJZHMgKTsKCgkJfSBlbHNlIGlmIChpc0FycmF5KCBhc3NldElkcyApKSB7CgoJCQkvL2lmIGl0IGlzIGFzc2V0SWRBcnJheSwgbG9hZCBvbmUgYWZ0ZXIgcHJldmlvdXMgaXMgZnVsbHkgbG9hZGVkCgkJCXJldHVybiBsb2FkQXNzZXRzSW5TZXJpYWwoIGFzc2V0SWRzICk7CgoJCX0KCQl0aHJvdyAicmVzb3VyY2UgcGFyYW1ldGVyIHNob3VsZCBiZSBhbiBhcnJheSBvciBzdHJpbmciOwoJfQoKCS8vcmVzb3VyY2VTdHJpbmcgaXMgbGlrZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCWZ1bmN0aW9uIGxvYWRBc3NldHNJblBhcmFsbGVsKCBhc3NldElkU3RyaW5nICkgewoJCXZhciBwcm9taXNlcyA9IFtdLAoJCQlydG5Qcm9taXNlLAoJCQlyZXNvdXJjZUFycmF5ID0gc3BsaXRCeUNvbW1hKCBhc3NldElkU3RyaW5nICk7CgoJCWlmIChyZXNvdXJjZUFycmF5Lmxlbmd0aCA9PT0gMSkgewoJCQlydG5Qcm9taXNlID0gbG9hZFN0YW5kYWxvbmVBc3NldCggcmVzb3VyY2VBcnJheVswXSApOwoJCX0KCQllbHNlIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvdXJjZUFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCQlwcm9taXNlcy5wdXNoKCBsb2FkU3RhbmRhbG9uZUFzc2V0KCByZXNvdXJjZUFycmF5W2ldICkgKTsKCQkJfQoJCQlydG5Qcm9taXNlID0gJC53aGVuLmFwcGx5KCAkLCBwcm9taXNlcyApOwoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICkuZmFpbCggZnVuY3Rpb24oKSB7CgkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkU3RyaW5nICk7CgkJfSApOwoJfQoKCS8vcmVzb3VyY2VzIGNhbiBiZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCS8vaXQgY2FuIGJlIFsiYS5qcyIsICJiLmNzcyIsICJjLnRtcGwiXQoJLy9vciBbImEuanMsYi5jc3MiLCBbImMudG1wbCIsICJkLnRtcGwiXSwgImUuY3NzIl0gYW5kIHNvIG9uCgkvL2l0IHNlcmlhbCBsb2FkIHRoZSB0b3AgbGV2ZWwgcmVzb3VyY2UgdW5pdCwgd2l0aGluIGVhY2ggcmVzb3VyY2UgdW5pdCwgdXNlIHNtYXJ0CgkvL2xvYWRlcgoJZnVuY3Rpb24gbG9hZEFzc2V0c0luU2VyaWFsKCBhc3NldElkQXJyYXkgKSB7CgkJdmFyIHJ0blByb21pc2UsCgkJCWksCgkJCXRvUmVsZWFzZVJlc291cmNlID0gW10sCgkJCWN1cnJlbnRSZXNvdXJjZVN0cmluZ09yQXJyYXksCgkJCXNoYXJlZFN0YXRlID0gewoJCQkJb2s6IHRydWUKCQkJfTsKCgkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRBcnJheS5sZW5ndGg7IGkrKykgewoJCQljdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ID0gYXNzZXRJZEFycmF5W2ldOwoJCQl0b1JlbGVhc2VSZXNvdXJjZS5wdXNoKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICk7CgoJCQlpZiAoaSA9PT0gMCkgewoKCQkJCXJ0blByb21pc2UgPSBsb2FkQXNzZXRzKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICkKCQkJCQkuZmFpbCggbWFrZVJlbGVhc2VGbiggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSwgc2hhcmVkU3RhdGUgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlydG5Qcm9taXNlID0gcnRuUHJvbWlzZS5uZXh0TG9hZCggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSApCgkJCQkJLmZhaWwoIG1ha2VSZWxlYXNlRm4oIHRvUmVsZWFzZVJlc291cmNlLnNsaWNlKCksIHNoYXJlZFN0YXRlICkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICk7Cgl9CgoJZnVuY3Rpb24gbWFrZVJlbGVhc2VGbiggcmVzb3VyY2VTdHJpbmdPckFycmF5LCBzaGFyZWRTdGF0ZSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCWlmIChzaGFyZWRTdGF0ZS5vaykgewoJCQkJX2xvYWRlci51bmxvYWQoIHJlc291cmNlU3RyaW5nT3JBcnJheSApOwoJCQkJc2hhcmVkU3RhdGUub2sgPSBmYWxzZTsKCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldCggYXNzZXRJZCApIHsKCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoJCWlmIChsb2FkZXIpIHsKCgkJCXJldHVybiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICk7CgoJCX0gZWxzZSB7CgoKCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggZmlsZUV4dGVuc2lvbiggYXNzZXRJZCApICsgIi5sb2FkZXIiICkubmV4dExvYWQoIGFzc2V0SWQgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldFdpdGhMb2FkZXIoIGFzc2V0SWQsIGxvYWRlciApIHsKCgoJCXZhciBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQlpZiAoIXByb21pc2UpIHsKCgoJCQlwcm9taXNlID0gbG9hZGVyLmxvYWQoIGFzc2V0SWQgKTsKCgkJCWlmICghbG9hZGVyLm5vUmVmQ291bnQpIHsKCQkJCS8vYWRkIHRoZSBwcm9taXNlIHRvIGNhY2hlLAoJCQkJLy9pbiB0aGUgZnV0dXJlLCBpdCBjYW4gYmUgcmV0cmlldmVkIGJ5IGFjY2Vzc1Byb21pc2UoYXNzZXRJZCkKCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKTsKCQkJfQoJCX0KCgkJLy9wcmVsb2FkIGFzc2V0IHdpbGwgbmV2ZXIgYmUgY291bnRlZCBmb3IgcmVmZXJlbmNlCgkJLy9hcyB3ZSBkb24ndCB3YW50IHRoYXQgdG8gYmUgdW5sb2FkZWQKCQlpZiAocHJvbWlzZS5yZWZDb3VudCAhPT0gInN0YXRpY0xvYWRlZCIpIHsKCQkJcHJvbWlzZS5yZWZDb3VudCA9IHByb21pc2UucmVmQ291bnQgPyBwcm9taXNlLnJlZkNvdW50ICsgMSA6IDE7CgkJfQoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vcmV0cmlldmUgcHJvbWlzZSBieSBhc3NldElkIG9yCgkvL3NldCBwcm9taXNlIGJ5IGFzc2V0SWQKCWZ1bmN0aW9uIGFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKSB7CgkJaWYgKGFzc2V0SWQgPT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gcHJvbWlzZVN0b3JlOwoJCX0gZWxzZSB7CgkJCWlmIChwcm9taXNlID09PSB1bmRlZmluZWQpIHsKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkJCQkJcmV0dXJuIHByb21pc2VTdG9yZVthc3NldElkXTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVsZXRlIHByb21pc2VTdG9yZVthc3NldElkXTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXByb21pc2VTdG9yZVthc3NldElkXSA9IHByb21pc2U7CgkJCQlyZXR1cm4gcHJvbWlzZTsKCQkJfQoJCX0KCX0KCgkvL2FkZCBhIHByb21pc2UubmV4dExvYWQgbWV0aG9kIGR5bmFtaWNhbGx5LCBzbyB0aGF0IGl0IGNhbgoJLy9iZSB1c2VkIGxvYWQgb3RoZXIgYXNzZXQgd2hlbiBjdXJyZW50IHByb21pc2UgZmluaXNoZWQKCS8vdGhlIG5leHRMb2FkIG1ldGhvZCBpcyBhIHNtYXJ0TG9hZCBtZXRob2QsIHVzZSB0aGUgc2FtZSB3YXkgaW4gd2hpY2gKCS8veW91IGNhbGwgbG9hZGVyCglmdW5jdGlvbiBhdWdtZW50UHJvbWlzZSggcHJvbWlzZSApIHsKCQl2YXIgbmV4dERlZmVyID0gJC5EZWZlcnJlZCgpOwoKCQkvL25leHRMb2FkIG1ldGhvZCBsb2FkIGFmdGVyIHRoZSBjdXJyZW50IGN1cnJlbnRQcm9taXNlIGlzIGRvbmUKCQlwcm9taXNlLm5leHRMb2FkID0gZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciBuZXh0TG9hZEFyZ3VtZW50cyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoJCQlwcm9taXNlLnRoZW4oCgkJCQlmdW5jdGlvbigpIHsKCQkJCQlfbG9hZGVyLmxvYWQuYXBwbHkoIG51bGwsIG5leHRMb2FkQXJndW1lbnRzICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQluZXh0RGVmZXIucmVzb2x2ZS5hcHBseSggbmV4dERlZmVyLCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCW5leHREZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCQkJfSApOwoJCQkJfSwKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCW5leHREZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCX0gKTsKCgkJCXJldHVybiBhdWdtZW50UHJvbWlzZSggbmV4dERlZmVyLnByb21pc2UoKSApOwoJCX07CgoJCXByb21pc2UuYW5kTG9hZCA9IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudFByb21pc2UgPSBfbG9hZGVyLmFwcGx5KCBudWxsLCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCAkLndoZW4oIGN1cnJlbnRQcm9taXNlLCBwcm9taXNlICkgKTsKCQl9OwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCglmdW5jdGlvbiBzcGxpdEJ5Q29tbWEoIHRleHQgKSB7CgkJcmV0dXJuIHRleHQucmVwbGFjZSggclNwYWNlLCAiIiApLnNwbGl0KCByQ29tbWEgKTsKCX0KCglmdW5jdGlvbiBpc0Nyb3NzRG9tYWluKCB1cmwgKSB7CgkJdmFyIHBhcnRzID0gclVybFBhcnRzLmV4ZWMoIHVybC50b0xvd2VyQ2FzZSgpICk7CgkJcmV0dXJuICEhKCBwYXJ0cyAmJgoJCSAgICAgICAgICAgKCBwYXJ0c1sgMSBdICE9IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT0gYWpheExvY1BhcnRzWyAyIF0gfHwKCQkgICAgICAgICAgICAgKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSAhPQoJCSAgICAgICAgICAgICAoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgKQoJCQkpOwoJfQoKCWZ1bmN0aW9uIGZ1bGxVcmwoIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgewoKCQlkdW1teUxpbmsuaHJlZiA9IHJBYnNvbHV0ZVVybC50ZXN0KCB1cmxSZWxhdGl2ZVRvQmFzZVVybCApID8gdXJsUmVsYXRpdmVUb0Jhc2VVcmwgOgoJCQliYXNlVXJsICsgdXJsUmVsYXRpdmVUb0Jhc2VVcmw7CgoJCXJldHVybiBpc0Nyb3NzRG9tYWluKCB1cmxSZWxhdGl2ZVRvQmFzZVVybCApID8gZHVtbXlMaW5rLmhyZWYgOiBhZGRIYXNoKCBkdW1teUxpbmsuaHJlZiApOwoJfQoKCWZ1bmN0aW9uIGNvbnZlcnRMb2FkRmlsdGVyc1RvTG9hZE1ldGhvZCggbG9hZEZpbHRlcnMgKSB7CgoJCWZvciAodmFyIGtleSBpbiBsb2FkRmlsdGVycykgewoJCQlhdHRhY2hGaWx0ZXIoIGxvYWRGaWx0ZXJzLCBrZXkgKTsKCQl9CgoJCXZhciBzdGF0aWNMb2FkZWQgPSBsb2FkRmlsdGVycy5zdGF0aWNMb2FkZWQgfHwgY29tbW9uTG9hZEZpbHRlcnMuc3RhdGljTG9hZGVkLnJldHVybkZhbHNlLAoJCQlnZXRTb3VyY2UgPSBsb2FkRmlsdGVycy5nZXRTb3VyY2UgfHwgY29tbW9uTG9hZEZpbHRlcnMuZ2V0U291cmNlLmdldFRleHRCeUFqYXgsCgkJCWNvbXBpbGUgPSBsb2FkRmlsdGVycy5jb21waWxlID09PSB1bmRlZmluZWQgPyBjb21tb25Mb2FkRmlsdGVycy5jb21waWxlLmdsb2JhbEV2YWwgOiBsb2FkRmlsdGVycy5jb21waWxlLAoJCQljcm9zc1NpdGVMb2FkID0gbG9hZEZpbHRlcnMuY3Jvc3NTaXRlTG9hZCB8fCBjb21tb25Mb2FkRmlsdGVycy5jcm9zc1NpdGVMb2FkLmdldFNjcmlwdCwKCQkJYnVpbGREZXBlbmRlbmNpZXMgPSBsb2FkRmlsdGVycy5idWlsZERlcGVuZGVuY2llcyB8fCBjb21tb25Mb2FkRmlsdGVycy5idWlsZERlcGVuZGVuY2llcy5wYXJzZURlcGVuZFRhZywKCQkJYnVpbGRVbmxvYWQgPSBsb2FkRmlsdGVycy5idWlsZFVubG9hZCB8fCBjb21tb25Mb2FkRmlsdGVycy5idWlsZFVubG9hZC5wYXJzZVVubG9hZFRhZzsKCgkJaWYgKCFjb21waWxlICYmICFjcm9zc1NpdGVMb2FkKSB7CgkJCXRocm93ICJsb2FkZXIgbXVzdCBpbXBsZW1lbnQgYXQgbGVhc3Qgb25lIG9mIGNvbXBpbGUsIGNyb3NzU2l0ZUxvYWQiOwoJCX0KCgkJcmV0dXJuIGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJdXJsOwoKCQkJaWYgKHN0YXRpY0xvYWRlZCggYXNzZXRJZCApKSB7CgoJCQkJcHJvbWlzZS5yZWZDb3VudCA9ICJzdGF0aWNMb2FkZWQiOwoJCQkJZGVmZXIucmVzb2x2ZSgpOwoKCQkJfSBlbHNlIHsKCQkJCXVybCA9IF9sb2FkZXIudXJsKCBhc3NldElkICk7CgkJCQlpZiAoIWNvbXBpbGUgfHwgbG9hZEZpbHRlcnMuYnlQYXNzR2V0U291cmNlIHx8IGlzQ3Jvc3NEb21haW4oIHVybCApKSB7CgoJCQkJCWlmICghY3Jvc3NTaXRlTG9hZCkgewoJCQkJCQl0aHJvdyAibG9hZGVyIGRvZXMgbm90IHN1cHBvcnQgY3Jvc3MgZG9tYWluIGxvYWRpbmciOwoJCQkJCX0KCgkJCQkJcmV0dXJuIGNyb3NzU2l0ZUxvYWQoIGFzc2V0SWQgKTsKCgkJCQl9IGVsc2UgewoKCgkJCQkJZ2V0U291cmNlKCBhc3NldElkICkudGhlbigKCQkJCQkJZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgoKCQkJCQkJCWlmIChidWlsZFVubG9hZCkgewoKCgkJCQkJCQkJdmFyIHVubG9hZCA9IGJ1aWxkVW5sb2FkKCBzb3VyY2VDb2RlLCBhc3NldElkICk7CgoJCQkJCQkJCWlmICh1bmxvYWQpIHsKCgkJCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKS51bmxvYWQgPSB1bmxvYWQ7CgkJCQkJCQkJfQoKCQkJCQkJCX0KCgkJCQkJCQlpZiAoYnVpbGREZXBlbmRlbmNpZXMpIHsKCgoJCQkJCQkJCXZhciBlbWJlZGRlZERlcGVuZGVuY2llcyA9IGJ1aWxkRGVwZW5kZW5jaWVzKCBhc3NldElkLCBzb3VyY2VDb2RlICk7CgkJCQkJCQkJaWYgKGVtYmVkZGVkRGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJCWRlcGVuZCggYXNzZXRJZCwgZW1iZWRkZWREZXBlbmRlbmNpZXMgKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgoJCQkJCQkJdmFyIHJ1bmNvbXBpbGUgPSBmdW5jdGlvbigpIHsKCgoJCQkJCQkJCXZhciByZXN1bHQgPSBjb21waWxlICYmIGNvbXBpbGUoIGFzc2V0SWQsIHNvdXJjZUNvZGUgKTsKCQkJCQkJCQkvL2RlbGF5IGRlZmVyLnJlc29sdmUgYSBmb3Igd2hpbGUgdG8gd2FpdCBmb3IgdGhlIGNvbXBpbGUgcmVzdWx0CgkJCQkJCQkJLy90byB0YWtlIGVmZmVjdCwgaWYgY29tcGlsZSBpcyAkLmdsb2JhbEV2YWwKCQkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJaWYgKCFkZWZlci5kb250UmVzb2x2ZSkgewoJCQkJCQkJCQkJZGVmZXIucmVzb2x2ZSggcmVzdWx0ICk7CgkJCQkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJCQkJfQoJCQkJCQkJCX0sIDUgKTsKCQkJCQkJCX07CgoJCQkJCQkJdmFyIGRlcGVuZGVuY2llcyA9IGRlcGVuZCggYXNzZXRJZCApOwoKCQkJCQkJCS8vbG9hZCBkZXBlbmRlbmNpZXMgYmVjYXVzZSBpdCBjb21iaW5lcyBzdGF0aWMgZGVwZW5kZW50TW9kdWxlU3RyaW5nCgkJCQkJCQkvL2FuZCBkeW5hbWljIGRlcGVuZGVudE1vZHVsZVN0cmluZwoJCQkJCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJCQkJCV9sb2FkZXIubG9hZCggZGVwZW5kZW5jaWVzICkudGhlbiggcnVuY29tcGlsZSwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJCWRlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJCQl9ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJ1bmNvbXBpbGUoKTsKCQkJCQkJCX0KCgkJCQkJCX0sCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJZGVmZXIucmVqZWN0KCBhc3NldElkICk7CgkJCQkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCQkJfQoJCQkJCSk7CgkJCQl9CgkJCQlpZiAoIWlzUmVzb2x2ZWQoIGRlZmVyICkpIHsKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHByb21pc2U7CgkJfTsKCX0KCgl2YXIgaXNSZXNvbHZlZCA9ICQuRGVmZXJyZWQoKS5pc1Jlc29sdmVkID8gZnVuY3Rpb24oIHByb21pc2UgKSB7CgkJcmV0dXJuIHByb21pc2UuaXNSZXNvbHZlZCgpOwoJfSA6IGZ1bmN0aW9uKCBwcm9taXNlICkgewoJCXJldHVybiBwcm9taXNlLnN0YXRlKCkgPT0gInJlc29sdmVkIjsKCX07CgoJZnVuY3Rpb24gYWRkSGFzaCggdXJsICkgewoJCXVybCA9IHJlbW92ZUhhc2goIHVybCApOwoJCXJldHVybiBoYXNoVmFsdWUgPwoJCQl1cmwgKyAoIHJRdWVyeS50ZXN0KCB1cmwgKSA/ICImIiA6ICI/IiApICsgaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZSA6CgkJCXVybDsKCX0KCglmdW5jdGlvbiByZW1vdmVIYXNoKCB1cmwgKSB7CgkJaWYgKGhhc2hWYWx1ZSA9PT0gIiIpIHsKCQkJcmV0dXJuIHVybDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHJWZXJzaW9uSGFzaCwgIiIgKTsKCQl9Cgl9CgoJJC5leHRlbmQoIF9sb2FkZXIsIHsKCgkJLy9mb3IgcGFyYWxsZWwgbG9hZGluZwoJCS8vCgkJLy8gbG9hZGVyLmxvYWQoYXNzZXRJZFN0cmluZykKCQkvLyBsb2FkZXIubG9hZChhc3NldElkU3RyaW5nLCB1c2VJbXBsaWNpdERlcGVuZGVuY2llcykKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHksIGFzc2V0SWRTdHJpbmcpCgkJLy8gbG9hZGVyLmxvYWQoaG9sZFJlYWR5LCBhc3NldElkU3RyaW5nLCB1c2VJbXBsaWNpdERlcGVuZGVuY2llcykKCQkvLwoJCS8vZm9yIHNlcmlhbCBsb2FkaW5nIGFuZCBtaXhlZCBzZXJpYWwvcGFyYWxsZWwgbG9hZGluZyBsb2FkZXIKCQkvLwoJCS8vIGxvYWRlci5sb2FkKGFzc2V0SWRBcnJheSkKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHkgYXNzZXRJZEFycmF5KQoJCS8vCgkJbG9hZDogZnVuY3Rpb24oIGhvbGRSZWFkeSwgYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgkJCXZhciBydG5Qcm9taXNlOwoJCQlpZiAoIWlzQm9vbGVhbiggaG9sZFJlYWR5ICkpIHsKCQkJCS8vYnkgZGVmYXVsdCBpdCBpcyBmYWxzZQoJCQkJaW5mZXJEZXBlbmRlbmNpZXNGcm9tSWRPcmRlciA9IGFzc2V0SWRzOwoJCQkJYXNzZXRJZHMgPSBob2xkUmVhZHk7CgkJCQlob2xkUmVhZHkgPSBmYWxzZTsKCQkJfQoJCQlpZiAoIWFzc2V0SWRzKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhvbGRSZWFkeSA9IGhvbGRSZWFkeSAmJiAhJC5pc1JlYWR5OwoKCQkJcnRuUHJvbWlzZSA9IGxvYWRBc3NldHMoIGFzc2V0SWRzLCBpbmZlckRlcGVuZGVuY2llc0Zyb21JZE9yZGVyICk7CgoJCQlpZiAoaG9sZFJlYWR5KSB7CgoJCQkJJC5ob2xkUmVhZHkoIHRydWUgKTsKCgkJCQlydG5Qcm9taXNlLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCSQuaG9sZFJlYWR5KCk7CgkJCQkJLy9zYW1lIGFzIHRoZSBmb2xsb3dpbmcKCQkJCQkvLyQuaG9sZFJlYWR5KCBmYWxzZSApOwoJCQkJCS8vJC5yZWFkeSggdHJ1ZSApOwoJCQkJfSApOwoJCQl9CgoJCQlyZXR1cm4gcnRuUHJvbWlzZS5kb25lKCBpbnZva2VMb2FkQ2FsbGJhY2tzICkuZmFpbCggaW52b2tlRmFpbENhbGxiYWNrcyApOwoJCX0sCgkJLy91bmxvYWQobG9hZENhbGxiYWNrKSBvciB1bmxvYWQodW5sb2FkQ2FsbGJhY2ssIHJlbW92ZT10cnVlKQoJCS8vdW5sb2FkKGFzc2V0SWRTdHJpbmcpCgkJLy91bmxvYWQoYXNzZXRJZEFycmF5KQoJCXVubG9hZDogZnVuY3Rpb24oIGFzc2V0SWRzLCByZW1vdmUgKSB7CgkJCXZhciBpLAoJCQkJYXNzZXRJZCwKCQkJCWRlcGVuZGVuY2llcywKCQkJCXByb21pc2U7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBhc3NldElkcyApKSB7CgkJCQlpZiAocmVtb3ZlKSB7CgkJCQkJdW5sb2FkQ2FsbGJhY2tzLnJlbW92ZSggYXNzZXRJZHMgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdW5sb2FkQ2FsbGJhY2tzLnB1c2goIGFzc2V0SWRzICk7CgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoJCQkJCWFzc2V0SWRzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoJCQkJfQoKCQkJCS8vaWYgdGhlcmUgaXMgb25seSBvbmUgbW9kdWxlCgkJCQlpZiAoYXNzZXRJZHMubGVuZ3RoICE9IDEpIHsKCgkJCQkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkc1tpXSApOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQkvL3VubG9hZCBzZXJ2ZXJhbCBtb2R1bGVzCgkJCQkJYXNzZXRJZCA9IGFzc2V0SWRzWzBdOwoJCQkJCXByb21pc2UgPSBhY2Nlc3NQcm9taXNlKCBhc3NldElkICk7CgoJCQkJCS8vbWFrZSBzdXJlIGl0IHdpbGwgbm90IHRocm93IGV4Y2VwdGlvbiB3aGVuCgkJCQkJLy8gdW5sb2FkaW5nIHNvbWUgbW9kdWxlIHdoaWNoIGlzIG5vdCBpbiBwYWdlCgkJCQkJaWYgKHByb21pc2UgJiYgcHJvbWlzZS5yZWZDb3VudCAhPSAic3RhdGljTG9hZGVkIikgewoKCQkJCQkJaWYgKC0tcHJvbWlzZS5yZWZDb3VudCA9PT0gMCB8fCByZW1vdmUpIHsKCQkJCQkJCXZhciB1bmxvYWQgPSBwcm9taXNlLnVubG9hZCB8fCBmaW5kTG9hZGVyKCBhc3NldElkICkudW5sb2FkOwoKCQkJCQkJCWlmICh1bmxvYWQpIHsKCQkJCQkJCQl1bmxvYWQoIGFzc2V0SWQgKTsKCQkJCQkJCX0KCgkJCQkJCQkvL2RlbGV0ZSB0aGUgcHJvbWlzZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUKCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHVuZGVmaW5lZCApOwoJCQkJCQkJZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci51bmxvYWQoIGRlcGVuZGVuY2llcywgcmVtb3ZlICk7CgkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCB1bmRlZmluZWQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJaW52b2tlVW5sb2FkQ2FsbGJhY2tzKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCgkJLy9yZWdpc3RlciBhIHVybCBmb3IgbW9kdWxlIGtleQoJCS8vb3IgZ2V0IHRoZSB1cmwgb2YgbW9kdWxlIGtleQoJCXVybDogZnVuY3Rpb24oIGFzc2V0SWQsIHVybCApIHsKCQkJaWYgKGlzT2JqZWN0KCBhc3NldElkICkpIHsKCQkJCWZvciAodmFyIGsgaW4gYXNzZXRJZCkgewoJCQkJCV9sb2FkZXIudXJsKCBrLCBhc3NldElkW2tdICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgcmVzb3VyY2UncyB1cmwgaXMgbm90IGluIGNhY2hlCgkJCS8vYW5kIHVzZXIgaXMgdHJ5aW5nIHRvIGdldCBpdAoJCQlpZiAodXJsID09PSB1bmRlZmluZWQpIHsKCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgoJCQkJCWlmICh1cmxTdG9yZVthc3NldElkXSkgewoJCQkJCQlyZXR1cm4gdXJsU3RvcmVbYXNzZXRJZF07CgkJCQkJfQoKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlyZXR1cm4gZnVsbFVybCgKCQkJCQkJbG9hZGVyICYmIGxvYWRlci51cmwgPyBsb2FkZXIudXJsKCBhc3NldElkICkgOgoJCQkJCQkJbG9hZGVyICYmIGxvYWRlci5maWxlRXh0ID8gZmlsZU5hbWUoIGFzc2V0SWQgKSArICIuIiArIGxvYWRlci5maWxlRXh0IDoKCQkJCQkJCQlhc3NldElkCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvL2FsbG93IGFjY2VzcyhrZXksIHVuZGVmaW5lZCkKCQkJCQkvL3RvIGRlbGV0ZSB0aGUga2V5IGZyb20gc3RvcmFnZQoJCQkJCWRlbGV0ZSB1cmxTdG9yZVthc3NldElkXTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQkvL3VzZXIgZXhwbGljaXQgcmVnaXN0ZXIgYW4gdXJsCgkJCQl2YXIgb2xkVXJsID0gX2xvYWRlci51cmwoIGFzc2V0SWQgKTsKCQkJCXZhciBuZXdVcmwgPSBmdWxsVXJsKCB1cmwgKTsKCgkJCQlpZiAob2xkVXJsICE9IG5ld1VybCkgewoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRQcm9taXNlICYmIGlzUmVzb2x2ZWQoIG9sZFByb21pc2UgKSkgewoJCQkJCQlyZWxvYWQoIGFzc2V0SWQsIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXJsU3RvcmVbYXNzZXRJZF0gPSBuZXdVcmw7CgkJCQkJCX0gKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cmxTdG9yZVthc3NldElkXSA9IG5ld1VybDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvLyBtZW1iZXJzIHRvIGNvbmZpZ3VyZSBsb2FkZXIKCgkJLy9hZGQgZGVwZW5kZW5jeSB0byBhIHJlc291cmNlIGtleQoJCS8vb3IgZ2V0IHRoZSBkZXBlbmRlbmN5IG9mIGEgcmVzb3VyY2Uga2V5CgkJLy91c2VyIGNhbiBzZXQgZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgbWFudWFsbHkgLCB3aGljaCBpcyBjYWxsZWQgc3RhdGljCgkJLy9kZXBlbmRlbnRSZXNvdXJjZVN0cmluZwoJCS8vIG9yIGNhbiB1c2UgbG9hZGVyLmRlcGVuZCBtZXRob2QgdG8gcmV0dXJuIGRlcGVuZGVudFJlc291cmNlU3RyaW5nIHdoaWNoIGlzIGNhbGxlZAoJCS8vZHluYW1pYyBkZXBlbmRlbnRSZXNvdXJjZVN0cmluZywKCQkvL29yIHdlIGNhbiBjb21iaW5lIHRoZW0gdG9nZXRoZXIKCQlkZXBlbmQ6IGRlcGVuZCA9IGZ1bmN0aW9uKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKSB7CgoJCQlpZiAoaXNPYmplY3QoIGFzc2V0SWQgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFzc2V0SWQpIHsKCQkJCQlkZXBlbmQoIGtleSwgYXNzZXRJZFtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChkZXBlbmRlbmNpZXMgPT09IHVuZGVmaW5lZCkgewoJCQkJLy9nZXQgZGVwZW5kZW5jaWVzCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQkJdmFyIHN0YXRpY0RlcGVuZGVuY2llcyA9IGRlcGVuZGVuY3lTdG9yZVthc3NldElkXTsKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlpZiAobG9hZGVyICYmIGxvYWRlci5kZXBlbmQpIHsKCQkJCQkJdmFyIGR5bmFtaWNEZXBlbmRlbmNpZXMgPSBsb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCWlmIChkeW5hbWljRGVwZW5kZW5jaWVzICYmIHN0YXRpY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXMgKyAiLCIgKyBzdGF0aWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSBpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gc3RhdGljRGVwZW5kZW5jaWVzOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuIHN0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQkvL2RlbGV0ZSBkZXBlbmRlbmNpZXMKCQkJCQlkZWxldGUgZGVwZW5kZW5jeVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChkZXBlbmRlbmNpZXMgPT09IHRydWUpIHsKCQkJCS8vZm9yIGRlYnVnZ2luZyBwdXJwdXNlIGxvYWRlci5kZXBlbmQoYXNzZXRJZCwgdHJ1ZSkKCQkJCXZhciBhc3NldElkcyA9IGRlcGVuZCggYXNzZXRJZCApOwoJCQkJYXNzZXRJZHMgPSBhc3NldElkcyAmJiBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQlpZiAoYXNzZXRJZHMpIHsKCQkJCQl2YXIgcnRuID0gW107CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhc3NldElkcy5sZW5ndGg7IGkrKykgewoJCQkJCQlpZiAoX2xvYWRlci5maWxlRXh0KCBhc3NldElkc1tpXSApICE9PSAibW9kdWxlIikgewoJCQkJCQkJcnRuLnB1c2hVbmlxdWUoIF9sb2FkZXIudXJsKCBhc3NldElkc1tpXSApICk7CgkJCQkJCX0KCQkJCQkJcnRuLm1lcmdlKCBkZXBlbmQoIGFzc2V0SWRzW2ldLCB0cnVlICkgKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJ0bjsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl2YXIgbmV3U3RhdGljRGVwZW5kZW5jaWVzID0gZ2V0TmV3U3RhdGljRGVwZW5kZW5jaWVzKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCXZhciBvbGRTdGF0aWNEZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmN5U3RvcmVbYXNzZXRJZF07CgoJCQkJaWYgKGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBuZXdTdGF0aWNEZXBlbmRlbmNpZXMsIG9sZFN0YXRpY0RlcGVuZGVuY2llcyApKSB7CgoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRTdGF0aWNEZXBlbmRlbmNpZXMgJiYgb2xkUHJvbWlzZSAmJiBpc1Jlc29sdmVkKCBvbGRQcm9taXNlICkpIHsKCQkJCQkJcmVsb2FkKCBhc3NldElkLCBmdW5jdGlvbigpIHsKCQkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQkJfSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvL3RoZSB1cmwgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgd2luZG93IGxvY2F0aW9uLCBmb3IgZXhhbXBsZSAianMvIgoJCS8vdGhlIHN1ZmZpeCAiLyIgaXMgaW1wb3J0YW50CgkJLy9pdCBpcyB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgcmVhbCByZWxhdGl2ZSB1cmwgb2YgcmVzb3VyY2Uga2V5CgkJYmFzZVVybDogZnVuY3Rpb24oIHVybFJlbGF0aXZlVG9QYWdlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHVybFJlbGF0aXZlVG9QYWdlICkpIHsKCQkJCXJldHVybiBiYXNlVXJsOwoJCQl9CgkJCWJhc2VVcmwgPSB1cmxSZWxhdGl2ZVRvUGFnZS5lbmRzV2l0aCggIi8iICkgPyB1cmxSZWxhdGl2ZVRvUGFnZSA6IHVybFJlbGF0aXZlVG9QYWdlICsgIi8iOwoJCX0sCgoJCS8vbG9hZGVyLmhhc2godHJ1ZSkgLS0+IHNldCBhIHRpbWVzdGFtcCBhcyBoYXNoID92PTIzNDc0ODM3NDgKCQkvL2xvYWRlci5oYXNoKDEseCkgLS0+ID94PTEKCQkvL2xvYWRlci5oYXNoKDEpIC0tPiA/dj0xCgkJaGFzaDogZnVuY3Rpb24oIHZhbHVlLCBrZXkgKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQloYXNoVmFsdWUgPSB2YWx1ZSA9PT0gdHJ1ZSA/ICQubm93KCkgOiB2YWx1ZTsKCQkJCWhhc2hLZXkgPSBrZXkgIT09IHVuZGVmaW5lZCA/IGtleSA6IChoYXNoS2V5IHx8ICJ2Iik7CgkJCQlyVmVyc2lvbkhhc2ggPSBuZXcgUmVnRXhwKCAiWz8mXSIgKyBoYXNoS2V5ICsgIj1bXiZdKiIgKTsKCQkJfQoJCQlyZXR1cm4gaGFzaFZhbHVlID09PSAiIiA/ICIiIDogaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZTsKCQl9LAoKCQkvL3N1cHBvcnQgbWV0aG9kIGxvYWQsIHVubG9hZCwgdXJsLCBkZXBlbmQKCQltZXRob2RzOiBjb21tb25Mb2FkZXJNZXRob2RzID0gewoKCQkJbG9hZDogewoJCQkJY2FjaGVJbWFnZTogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoKCQkJCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCB1cmwgKTsKCQkJCQl9OwoJCQkJCWltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7CgkJCQkJCWRlZmVyLnJlamVjdCggdXJsICk7CgkJCQkJfTsKCQkJCQlpbWcuc3JjID0gdXJsOwoJCQkJCXJldHVybiBwcm9taXNlOwoJCQkJfQoKCQkJfSwKCQkJdW5sb2FkOiB7CgkJCQlyZW1vdmVDc3NMaW5rVGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCQkJfSApLnJlbW92ZSgpOwoJCQkJfQoJCQl9LAoJCQl1cmw6IHsKCQkJCWFzc2V0SWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJCXJldHVybiBhc3NldElkOwoJCQkJfSwKCQkJCS8vdGhpcyB1cmwgZXhwZWN0IG1vZHVsZSBpcyBwdXQgaW50byBpdHMgZm9sZGVyIHVuZGVyIGJhc2VVcmwKCQkJCS8vaWYgdGhlIGxvYWRlciBuYW1lIGlzICJhcHAiLCB3ZSBzaG91bGQgcHV0IHRoZSByZXNvdXJjZSBmaWxlIGludG8KCQkJCS8vYmFzZVVybC9hcHAgZm9sZGVyCgkJCQlmb2xkZXI6IGZ1bmN0aW9uKCBhc3NldElkICkgewoKCQkJCQl2YXIgZmlsZUV4dCA9IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS5maWxlRXh0LAoJCQkJCQlmaWxlTmFtZSA9IGZpbGVFeHQgPyBfbG9hZGVyLmZpbGVOYW1lKCBhc3NldElkICkgKyAiLiIgKyBmaWxlRXh0IDoKCQkJCQkJCWFzc2V0SWQsCgkJCQkJCWxvYWRlck5hbWUgPSBfbG9hZGVyLmZpbGVFeHQoIGFzc2V0SWQgKTsKCgkJCQkJcmV0dXJuIGxvYWRlck5hbWUgKyAiLyIgKyBmaWxlTmFtZTsKCQkJCX0KCQkJfSwKCgkJCWRlcGVuZDogewoJCQkJLy9uYW1lOiBmdW5jdGlvbiAoYXNzZXRJZCkgewoJCQkJLy8gcmV0dXJuIGEgYXNzZXRJZFN0cmluZyBvciBhc3NldElkQXJyYXkKCQkJCS8vIHJldHVybiAiYS5odG1sLCBiLmpzIgoJCQkJLy8gfQoJCQl9CgkJfSwKCgkJbG9hZEZpbHRlcnM6IGNvbW1vbkxvYWRGaWx0ZXJzID0gewoKCQkJc3RhdGljTG9hZGVkOiB7CgkJCQkvL2RlZmF1bHQgc3RhdGljTG9hZGVkIGZpbHRlcgoJCQkJcmV0dXJuRmFsc2U6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgoJCQkJaGFzU2NyaXB0VGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gISEoJCggInNjcmlwdCIgKS5maWx0ZXIoCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuc3JjICkgPT09IHJlbW92ZUhhc2goIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJfSApLmxlbmd0aCk7CgkJCQl9CgoJCQl9LAoKCQkJZ2V0U291cmNlOiB7CgkJCQkvL3RoaXMgaXMgZGVmYXVsdCBnZXRTb3VyY2UgZmlsdGVyCgkJCQlnZXRUZXh0QnlBamF4OiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gJC5hamF4KCB7CgkJCQkJCXVybDogX2xvYWRlci51cmwoIGFzc2V0SWQgKSwKCQkJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJCQkJY2FjaGU6IHRydWUKCQkJCQl9ICk7CgkJCQl9CgkJCX0sCgoJCQljb21waWxlOiB7CgkJCQlnbG9iYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gJC5nbG9iYWxFdmFsKCBzb3VyY2VDb2RlICk7CgkJCQl9LAoJCQkJbG9jYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gZXZhbCggc291cmNlQ29kZSApOwoJCQkJfQoJCQl9LAoKCQkJY3Jvc3NTaXRlTG9hZDogewoJCQkJLy9jYW4gbm90IHVzZSAkLmdldFNjcmlwdCBkaXJlY3RseSwgYXMgbG9hZGVyLnJlc29sdmUKCQkJCWdldFNjcmlwdDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpOwoKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgoJCQkJCSQuZ2V0U2NyaXB0KCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCWRlZmVyLnJlc29sdmUoKTsKCQkJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCQkJfQoJCQkJCQkJfSwgNSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCWRlZmVyLnJlamVjdCgpOwoJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIHByb21pc2U7CgkJCQl9CgoKCQkJfSwKCgkJCWJ1aWxkVW5sb2FkOiB7CgkJCQlwYXJzZVVubG9hZFRhZzogZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgkJCQkJdmFyIHVubG9hZFN0YXRlbWVudHMgPSBydW5sb2FkU3RhdGVtZW50LmV4ZWMoIHNvdXJjZUNvZGUgKTsKCQkJCQlyZXR1cm4gdW5sb2FkU3RhdGVtZW50cyAmJgoJCQkJCSAgICAgICB1bmxvYWRTdGF0ZW1lbnRzWzFdICYmCgkJCQkJICAgICAgIG5ldyBGdW5jdGlvbiggdW5sb2FkU3RhdGVtZW50c1sxXSApOwoJCQkJfQoJCQl9LAoKCQkJYnVpbGREZXBlbmRlbmNpZXM6IHsKCQkJCXBhcnNlRGVwZW5kVGFnOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gckRlcGVuZEhlYWRlci5leGVjKCBzb3VyY2VDb2RlICk7CgkJCQkJcmV0dXJuIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzWzFdICkgfHwgbnVsbDsKCQkJCX0KCQkJfQoJCX0sCgoJCS8vZmluZCB0aGUgbmFtZSBvZiB0aGUgbG9hZGVyIGJhc2VkIG9uIGFzc2V0SWQKCQkvL3RoZSBmaXJzdCBsb2FkZXIgaXMgdXNlIHRoZSBleHRlbnNpb24gYXMgdGhlIGxvYWRlciBuYW1lCgkJLy9ob3dldmVyIHlvdSBjYW4gYWRkIHlvdXIgb3duIGxvYWRlcgoJCWZpbmRlcnM6IGxvYWRlckZpbmRlcnMgPSBbCgkJCS8vZmluZCBsb2FkZXIgYnkgYnkgZmlsZSBleHRlbnNpb25zIGRpcmVjdGx5CgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuIGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJfSwKCQkJLy9maW5kIGxvYWRlciBieSBieSBmaWxlIGV4dGVuc2lvbnMgdXNpbmcgbWFwcGVyCgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGV4dGVuc2lvbiA9IGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJCXZhciBtYXBwZWRUeXBlID0gZmlsZUV4dFRvTG9hZGVyTWFwcGVyW2V4dGVuc2lvbl07CgkJCQlpZiAobWFwcGVkVHlwZSkgewoJCQkJCXJldHVybiBtYXBwZWRUeXBlOwoJCQkJfQoJCQl9CgkJXSwKCgkJLy9pZiB5b3Ugd2FudCB0byBsb2FkIGEgZmlsZSAiKi5qcGciLCB3aGljaCBzaG91bGQgYmUgbG9hZGVkCgkJLy93aXRoICIqLmltZyIgbG9hZGVyIHlvdSBzaG91bGQgc3BlY2lmeSBsb2FkZXIubG9hZGVyLm1hcEZpbGVzKCJpbWciLCAianBnIik7CgkJbWFwRmlsZUV4dFRvTG9hZGVyOiBmdW5jdGlvbiggZmlsZUV4dGVuc2lvbnMsIGxvYWRlck5hbWUgKSB7CgkJCWZpbGVFeHRlbnNpb25zID0gc3BsaXRCeUNvbW1hKCBmaWxlRXh0ZW5zaW9ucyApOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVFeHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7CgkJCQlmaWxlRXh0VG9Mb2FkZXJNYXBwZXJbZmlsZUV4dGVuc2lvbnNbaV1dID0gbG9hZGVyTmFtZTsKCQkJfQoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyB4eXouanMKCQkvL3RoZW4gZmlsZUV4dCBpcyAianMiCgkJZmlsZUV4dDogZmlsZUV4dGVuc2lvbiA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVFeHQuZXhlYyggYXNzZXRJZCApWzFdOwoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyAiYS5iLmMiLCB0aGVuIGZpbGUgbmFtZSBpcyAiYS5iIgoJCWZpbGVOYW1lOiBmaWxlTmFtZSA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVOYW1lLmV4ZWMoIGFzc2V0SWQgKVsxXTsKCQl9LAoKCQkvL2RlZmluZSBhIG1vZHVsZSB3aXRoIGFuIGFzc2V0IGlkCgkJLy9kZXBlbmRlbmNpZXMgaXMgYW4gYXNzZXQgZXhwcmVzc2lvbiwgaXQgaXMgb3B0aW9uYWwKCQkvL2RlZmluZSB0aGUgbW9kdWxlIGluIHRoZSBsb2FkIG1ldGhvZAoJCWRlZmluZTogZnVuY3Rpb24oIGFzc2V0SWQsIGRlcGVuZGVuY2llcywgZGVmaW5lTW9kdWxlLCB1bmxvYWQgKSB7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBkZXBlbmRlbmNpZXMgKSkgewoJCQkJdW5sb2FkID0gZGVmaW5lTW9kdWxlOwoJCQkJZGVmaW5lTW9kdWxlID0gZGVwZW5kZW5jaWVzOwoJCQkJZGVwZW5kZW5jaWVzID0gbnVsbDsKCQkJfQoKCQkJdmFyIGRlZmVyLCBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQkJaWYgKCFwcm9taXNlKSB7CgkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiBsb2FkZXIuZGVmaW5lIGlzIGNhbGwgaW4gYSBzdGF0aWMgbG9hZGVkIGpzCgkJCQlkZWZlciA9ICQuRGVmZXJyZWQoKTsKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCk7CgkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQlhY2Nlc3NQcm9taXNlKCBhc3NldElkLCBwcm9taXNlICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlciA9IHByb21pc2UuZGVmZXI7CgkJCX0KCgkJCS8vdXNlIGRvbnRSZW9zbHZlIGZsYWcgdGVsbGluZyB0aGUgY29uc3VtZXIgZG9uJ3QgcmVzb2x2ZSBpdAoJCQkvL2FzIGl0IHdpbGwgYmUgdGFrZW4gY2FyZSBpbnNpZGUgaW1wb3J0Q29kZSwKCQkJcHJvbWlzZS5kZWZlci5kb250UmVzb2x2ZSA9IHRydWU7CgoJCQl2YXIgcnVuTW9kdWxlQ29kZSA9IGZ1bmN0aW9uKCByZXN1bHQgKSB7CgkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCXByb21pc2UudW5sb2FkID0gdW5sb2FkOwoJCQkJZGVmZXIgJiYgZGVmZXIucmVzb2x2ZSggZGVmaW5lTW9kdWxlKCByZXN1bHQgKSApOwoJCQl9OwoKCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJZGVwZW5kKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCS8vbG9hZCB0aGUgZGVwZW5kZW5jaWVzIGZpcnN0CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVuY2llcyApLmRvbmUoIHJ1bk1vZHVsZUNvZGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJcnVuTW9kdWxlQ29kZSgpOwoJCQl9CgoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9LAoKCQlkb25lOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJbG9hZENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlsb2FkQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlmYWlsOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJZmFpbENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlmYWlsQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlkZWZhdWx0TG9hZGVyOiAianMiCgoJfSApOwoKCWZ1bmN0aW9uIHJlbG9hZCggYXNzZXRJZCwgY2hhbmdlICkgewoKCQl2YXIgb2xkUHJvbWlzZUNhY2hlID0gJC5leHRlbmQoIHRydWUsIHt9LCBwcm9taXNlU3RvcmUgKTsKCQlfbG9hZGVyLnVubG9hZCggYXNzZXRJZCwgdHJ1ZSApOwoJCWNoYW5nZSAmJiBjaGFuZ2UoKTsKCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBhc3NldElkICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWZvciAodmFyIGtleSBpbiBvbGRQcm9taXNlQ2FjaGUpIHsKCQkJCWlmIChwcm9taXNlU3RvcmVba2V5XSAmJiBvbGRQcm9taXNlQ2FjaGVba2V5XSkgewoJCQkJCXByb21pc2VTdG9yZVtrZXldLnJlZkNvdW50ID0gb2xkUHJvbWlzZUNhY2hlW2tleV0ucmVmQ291bnQ7CgkJCQkJcHJvbWlzZVN0b3JlW2tleV0udXJsID0gb2xkUHJvbWlzZUNhY2hlW2tleV0udXJsOwoJCQkJCXByb21pc2VTdG9yZVtrZXldLmFzc2V0SWQgPSBvbGRQcm9taXNlQ2FjaGVba2V5XS5hc3NldElkOwoJCQkJfQoJCQl9CgkJfSApOwoJfQoKCWZ1bmN0aW9uIGdldE5ld1N0YXRpY0RlcGVuZGVuY2llcyggYXNzZXRJZCwgZGVwZW5kZW5jaWVzVG9TZXQgKSB7CgkJdmFyIHJ0biwKCQkJbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApLAoJCQlkeW5hbWljRGVwZW5kZW5jaWVzID0gbG9hZGVyICYmIGxvYWRlci5kZXBlbmQgJiYgbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQlpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQlydG4gPSBbXTsKCQkJZHluYW1pY0RlcGVuZGVuY2llcyA9IHNwbGl0QnlDb21tYSggZHluYW1pY0RlcGVuZGVuY2llcyApOwoJCQlkZXBlbmRlbmNpZXNUb1NldCA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzVG9TZXQgKTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXNUb1NldC5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFkeW5hbWljRGVwZW5kZW5jaWVzLmNvbnRhaW5zKCBkZXBlbmRlbmNpZXNUb1NldFtpXSApKSB7CgkJCQkJcnRuLnB1c2goIGRlcGVuZGVuY2llc1RvU2V0W2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bi5sZW5ndGggPyBydG4uam9pbigpIDogbnVsbDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZGVwZW5kZW5jaWVzVG9TZXQ7CgkJfQoJfQoKCWZ1bmN0aW9uIGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBkZXBlbmRlbmNpZXMxLCBkZXBlbmRlbmNpZXMyICkgewoJCWlmICgoZGVwZW5kZW5jaWVzMSAmJiAhZGVwZW5kZW5jaWVzMikgfHwKCQkgICAgZGVwZW5kZW5jaWVzMiAmJiAhZGVwZW5kZW5jaWVzMSkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgaWYgKCFkZXBlbmRlbmNpZXMxICYmICFkZXBlbmRlbmNpZXMyKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWRlcGVuZGVuY2llczEgPSBzcGxpdEJ5Q29tbWEoIGRlcGVuZGVuY2llczEgKS5zb3J0KCk7CgkJZGVwZW5kZW5jaWVzMiA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzMiApLnNvcnQoKTsKCQlpZiAoZGVwZW5kZW5jaWVzMS5sZW5ndGggIT0gZGVwZW5kZW5jaWVzMi5sZW5ndGgpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llczEubGVuZ3RoOyBpKyspIHsKCQkJaWYgKGRlcGVuZGVuY2llczFbaV0gIT0gZGVwZW5kZW5jaWVzMltpXSkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiBmaW5kTG9hZGVyKCBhc3NldElkICkgewoJCXZhciBsb2FkZXJOYW1lLCBpOwoJCWZvciAoaSA9IGxvYWRlckZpbmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJbG9hZGVyTmFtZSA9IGxvYWRlckZpbmRlcnNbaV0oIGFzc2V0SWQgKTsKCQkJaWYgKGxvYWRlck5hbWUpIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWxvYWRlck5hbWUgPSBsb2FkZXJOYW1lIHx8IF9sb2FkZXIuZGVmYXVsdExvYWRlcjsKCQlyZXR1cm4gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV07Cgl9CgoJZnVuY3Rpb24gYXR0YWNoRmlsdGVyKCBmaWx0ZXJzLCBmaWx0ZXJOYW1lICkgewoJCWlmIChpc1N0cmluZyggZmlsdGVyc1tmaWx0ZXJOYW1lXSApKSB7CgkJCWZpbHRlcnNbZmlsdGVyTmFtZV0gPSBjb21tb25Mb2FkRmlsdGVyc1tmaWx0ZXJOYW1lXVtmaWx0ZXJzW2ZpbHRlck5hbWVdXTsKCQl9Cgl9CgoKCXZhcgoKCS8vaWYgeW8gaGF2ZSBjb2RlIGxpa2UgdGhlIGZvbGxvd2luZyBpbiBqYXZhc2NyaXB0LAoJLy90aGUgcGFydCBkZWxldGUgd2luZG93LmRlcGVuZDIgd2lsbCBiZSBleHRyYWN0ZWQKCS8vIDxAdW5sb2FkPgoJLy9kZWxldGUgd2luZG93LmRlcGVuZDI7CgkvLzwvQHVubG9hZD4KCgkJcnVubG9hZFN0YXRlbWVudCA9IC88QHVubG9hZD4oW1x3XFddKz8pPFwvQHVubG9hZD4vaSwKCgkvL21hdGNoIHN0cmluZyAicmVmMiwgcmVmMSIgaW4KCS8vIDxAZGVwZW5kPgoJLy9yZWYyLCByZWYxCgkvLzxAZGVwZW5kPgoJCXJEZXBlbmRIZWFkZXIgPSAvPEBkZXBlbmQ+KFtcd1xXXSs/KTxcL0BkZXBlbmQ+L2k7CgoJLy9jcmVhdGUgYSBsb2FkIGZ1bmN0aW9uCglmdW5jdGlvbiByZXNvbHZlRGVwZW5kZW5jaWVzKCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkICkgewoJCXJldHVybiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgPSBfbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQkJaWYgKGRlcGVuZGVudFJlc291cmNlU3RyaW5nKSB7CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVudFJlc291cmNlU3RyaW5nICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggYXNzZXRJZCwgYWN0aW9uQWZ0ZXJEZXBlbmRlbmNpZXNSZXNvbHZlZCggYXNzZXRJZCApICk7CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkLCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkKCBhc3NldElkICkgKTsKCQkJfQoJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoJCX07Cgl9CgoJLy9hIHNwZWNpYWwgbW9kdWxlIHdoaWNoIGlzIGEgcGFja2FnZSBvZiBtb2R1bGVzLCBsaWtlIGEgY29udGFpbmVyCglfbG9hZGVyKCAicGFjayIsIHsKCQlsb2FkOiByZXNvbHZlRGVwZW5kZW5jaWVzKCAkLm5vb3AgKSwKCQl1cmw6ICJhc3NldElkIgoJfSApOwoKCS8vanMgYWRhcHRlciB0cnkgdG8gcGFyc2UgdGhlIGNvbnRlbnQgb2YganMgZmlsZQoJX2xvYWRlciggImpzIiwgewoJCWxvYWQ6IHsKCQkJc3RhdGljTG9hZGVkOiAiaGFzU2NyaXB0VGFnIgoJCQkvL3RoZSBmb2xsb3dpbmcgYXJlIGNvbW1lbnRlZCBvdXQsIGJlY2F1c2UgaXQgaXMgZGVmYXVsdCB2YWx1ZSBkZWZpbmVkIGluIGNvbnZlcnRMb2FkRmlsdGVyc1RvTG9hZE1ldGhvZAoJCQkvL2Nyb3NzU2l0ZUxvYWQ6ICJnZXRTY3JpcHQiLAoJCQkvL2dldFNvdXJjZTogImdldFRleHRCeUFqYXgiLAoJCQkvL2NvbXBpbGU6ICJnbG9iYWxFdmFsIiwKCQkJLy9idWlsZERlcGVuZGVuY2llczogInBhcnNlRGVwZW5kVGFnIiwKCQkJLy9idWlsZFVubG9hZDogInBhcnNlVW5sb2FkVGFnIgoJCX0sCgkJLy90aGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGlmIHlvdSBoYXZlIGEgc3ViIGxvYWRlciBpbmhlcml0cyBmcm9tCgkJLy9mcm9tIHRoaXMsIGFuZCB5b3UgZG9uJ3Qgd2FudCB0byBpbmhlcml0ZWQgc3ViIGxvYWRlciB0byBzcGVjaWZ5IHRoaXMgYWdhaW4KCQlmaWxlRXh0OiAianMiCgl9ICk7CgoJX2xvYWRlciggImpzbCIsICJqcyIsIHsKCQlsb2FkOiB7CgkJCWNvbXBpbGU6ICJsb2NhbEV2YWwiCgkJfQoJfSApOwoJLy9sb2FkZXIgaXMgamF2YXNjcmlwdCBmaWxlLCBpdCBkZWZpbmVzIGEgbG9hZGVyCglfbG9hZGVyKCAibG9hZGVyIiwgImpzIiwgewoJCXVybDogImZvbGRlciIKCX0gKTsKCgkvL2NzcyBhZGFwdGVyIHRyaWVzIHRvIHBhcnNlIHRoZSBjb250ZW50IG9mIGNzcyBmaWxlCglfbG9hZGVyKCAiY3NzIiwgewoJCWxvYWQ6IHsKCQkJc3RhdGljTG9hZGVkOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCXJldHVybiAhISgkKCAibGluayIgKS5maWx0ZXIoCgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZW1vdmVIYXNoKCB0aGlzLmhyZWYgKSA9PT0gcmVtb3ZlSGFzaCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApICYmICEkKCB0aGlzICkuYXR0ciggJ2xvYWRlZEJ5bG9hZGVyJyApOwoJCQkJCX0gKS5sZW5ndGgpOwoJCQl9LAoJCQljcm9zc1NpdGVMb2FkOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKTsKCgkJCQkkKCAiPGxpbmsgaHJlZj0nIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKyAiJyAiICsgInJlbD0nc3R5bGVzaGVldCcgdHlwZT0ndGV4dC9jc3MnIGxvYWRlZEJ5bG9hZGVyPScxJyAvPiIgKQoJCQkJCS5sb2FkKCBmdW5jdGlvbigpIHsKCQkJCQkJZGVmZXIucmVzb2x2ZSggYXNzZXRJZCApOwoJCQkJCX0gKQoJCQkJCS5hcHBlbmRUbyggImhlYWQiICk7CgoJCQkJcmV0dXJuIGRlZmVyLnByb21pc2UoKTsKCQkJfSwKCQkJLy9leHBsaWNpdGx5IHNwZWNpZnkgdGhhdCBsb2FkZXIgZG9lcyBub3QgbmVlZCBhIGNvbXBpbGUgZmlsdGVyCgkJCWNvbXBpbGU6IG51bGwKCQl9LAoKCQl1bmxvYWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkkKCAibGluayIgKS5maWx0ZXIoCgkJCQlmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCX0gKS5yZW1vdmUoKTsKCQl9LAoJCWZpbGVFeHQ6ICJjc3MiCgl9ICk7CgoJX2xvYWRlciggImltYWdlIiwgewoJCWxvYWQ6ICJjYWNoZUltYWdlIiwKCQlub1JlZkNvdW50OiB0cnVlCgl9ICk7CgoJLy9tYWtlIGltZyBsaW5rZXIgY2FuIGhhbmRsZSBtb2R1bGUgd2l0aCB0aGVzZSBmaWxlIGV4dGVuc2lvbgoJX2xvYWRlci5tYXBGaWxlRXh0VG9Mb2FkZXIoICJqcGcscG5nLGJtcCxnaWYiLCAiaW1hZ2UiICk7CgkvL2ZyZWQgdGVzdAoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanM8L0BkZXBlbmRzPgoKCgl2YXIgdGVtcGxhdGUsCgkJckJlZ2luV2l0aEFwayA9IC9eYXBrXC4oW14uXSspKFwuPykoLiopJC8sCgkJckJlZ2luV2l0aFN0YXIgPSAvXlwqLywKCQl0ZW1wbGF0ZUVuZ2luZUFkYXB0ZXJzID0ge30sCgkJdG1wbCA9IHsKCQkJaW5pdGlhbGl6ZTogIip0ZW1wbGF0ZU9wdGlvbnMiLAoJCQlnZXQ6ICJnZXQiLCAvL2V4dGVuc2libGUKCQkJY29udmVydDogIip0ZW1wbGF0ZSIsCgkJCXNldDogImh0bWwiLCAvL2V4dGVuc2libGUKCQkJZmluYWxpemU6ICIqcGFyc2VTdWJzIgoJCX07CgoJZnVuY3Rpb24gbmV3VGVtcGxhdGVIYW5kbGVyKCBnZXR0ZXIsIHNldHRlciwgZmluYWxpemVyICkgewoJCXJldHVybiBleHRlbmQoIHt9LCB0bXBsLAoJCQlpc09iamVjdCggZ2V0dGVyICkgPyBnZXR0ZXIgOiB7CgkJCQlnZXQ6IGdldHRlciwKCQkJCXNldDogc2V0dGVyLAoJCQkJZmluYWxpemU6IGZpbmFsaXplcgoJCQl9ICk7Cgl9CgoJLy9vcHRpb25zIGNhbiBiZSA6IHRlbXBsYXRlSWQsd3JhcEl0ZW0sZW5naW5lTmFtZQoJLy8KCS8vb3IgaXQgY2FuIGJlCgkvLyB7CgkvLyAgdGVtcGxhdGVJZDogInh4eCIsCgkvLyAgd3JhcEl0ZW06IHRydWUsCgkvLyAgZW5naW5lTmFtZTogInh4eCIKCS8vfQoJaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZS50ZW1wbGF0ZU9wdGlvbnMgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCWhhbmRsZXIudGVtcGxhdGVJZCA9ICQudHJpbSggb3B0aW9uc1swXSApOwoJCQloYW5kbGVyLndyYXBEYXRhSW5BcnJheSA9ICQudHJpbSggb3B0aW9uc1sxXSApID09ICJ0cnVlIjsKCQkJaGFuZGxlci5lbmdpbmVOYW1lID0gb3B0aW9uc1syXTsKCgkJfSBlbHNlIGlmIChpc09iamVjdCggb3B0aW9ucyApICYmIG9wdGlvbnMudGVtcGxhdGVJZCkgewoKCQkJZXh0ZW5kKCBoYW5kbGVyLCBvcHRpb25zICk7CgoJCX0gZWxzZSB7CgoJCQlpZiAoIShoYW5kbGVyLnRlbXBsYXRlSWQgPSBzdWJzY3JpYmVyLmhtRGF0YSggImVtYmVkZGVkVGVtcGxhdGUiICkpKSB7CgoJCQkJdmFyIHRlbXBsYXRlU291cmNlID0gJC50cmltKCBzdWJzY3JpYmVyLmh0bWwoKSApOwoJCQkJaWYgKHRlbXBsYXRlU291cmNlKSB7CgkJCQkJdGVtcGxhdGVTb3VyY2UgPSB0ZW1wbGF0ZVNvdXJjZS5yZXBsYWNlKCByVW5lc2NhcGVUb2tlbnMsIHVuZXNjYXBlVG9rZW5zICk7CgkJCQkJaGFuZGxlci50ZW1wbGF0ZUlkID0gIl9fIiArICQudXVpZCsrOwoJCQkJCXRlbXBsYXRlLmNvbXBpbGUoIGhhbmRsZXIudGVtcGxhdGVJZCwgdGVtcGxhdGVTb3VyY2UgKTsKCQkJCQlzdWJzY3JpYmVyLmhtRGF0YSggImVtYmVkZGVkVGVtcGxhdGUiLCBoYW5kbGVyLnRlbXBsYXRlSWQgKTsKCQkJCQlzdWJzY3JpYmVyLmVtcHR5KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIHRlbXBsYXRlIjsKCQkJCX0KCQkJfQoJCX0KCX07CgoJdmFyIHJVbmVzY2FwZVRva2VucyA9IC8mbHQ7fCZndDsvZzsKCXZhciB1bmVzY2FwZU1hcCA9IHsKCQkiJmx0OyI6ICI8IiwKCQkiJmd0OyI6ICI+IgoJfTsKCgl2YXIgdW5lc2NhcGVUb2tlbnMgPSBmdW5jdGlvbiggdG9rZW4gKSB7CgkJcmV0dXJuIHVuZXNjYXBlTWFwW3Rva2VuXSB8fCAiIjsKCX07CgoJZnVuY3Rpb24gUmVuZGVyQ29udGV4dCggZSApIHsKCQl0aGlzLm1vZGVsUGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJdGhpcy5lID0gZTsKCX0KCgkvL3Nob3J0Y3V0IHRvIHRoaXMuZS5wdWJsaXNoZXIuZ2V0KHh4eCk7CglSZW5kZXJDb250ZXh0LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcHVibGlzaGVyID0gdGhpcy5lLnB1Ymxpc2hlcjsKCQlyZXR1cm4gcHVibGlzaGVyLmdldC5hcHBseSggcHVibGlzaGVyLCBhcmd1bWVudHMgKTsKCX07CgoJLy90aGlzIGNvbnZlcnRlciBpcyB1c2VkIGluIGhhbmRsZXJzIHdoaWNoIGNhbiB3YW50IHRvIGNvbnZlcnQgZGF0YQoJLy8gdG8gbWFya3VwLCB0aGVzZSBoYW5kbGVyIGluY2x1ZGVzIGZvcmVhY2gsIGFuZCBuZXdUZW1wbGF0ZUhhbmRsZXIKCS8vd2hpY2ggaXMgdGhlIGNvcmUgb2YgYWxsIHRlbXBsYXRlSGFuZGxlcgoJaG0uYWN0aXZpdHkuY29udmVydC50ZW1wbGF0ZSA9IGZ1bmN0aW9uKCBkYXRhLCBlICkgewoKCQkvL2lmIGRhdGFTb3VyY2UgaXMgYW4gYXJyYXksIGl0IGhhcyBpdGVtKHMpCgkJLy9vciBkYXRhU291cmNlIGlzIG5vbi1hcnJheQoJCWlmIChkYXRhICYmCgkJICAgICgKCQkJICAgIChpc0FycmF5KCBkYXRhICkgJiYgZGF0YS5sZW5ndGgpIHx8ICFpc0FycmF5KCBkYXRhICkKCQkJICAgICkKCQkJKSB7CgoJCQkvL2lmIHdyYXBEYXRhSW5BcnJheSBpcyB0cnVlLCB3cmFwIGRhdGEgd2l0aCBbXSwgc28gdGhhdCBpdCBpcyBhbiBpdGVtIG9mIGFuIGFycmF5LCBleHBsaWNpdGx5CgkJCS8vc29tZSB0ZW1wbGF0ZSBlbmdpbmUgY2FuIGF1dG9tYXRpY2FsbHkgd3JhcCB5b3VyIGRhdGEgaWYgaXQgaXMgbm90IGFuIGFycmF5LgoJCQkvL2lmIHlvdSBkYXRhIGlzIGFscmVhZHkgaW4gYXJyYXksIGl0IHRyZWF0IGl0IGFzIGFuIGFycmF5IG9mIGl0ZW1zLgoJCQkvL2hvd2V2ZXIsIGlmIHlvdSB3YW50IHRvIHdhbnQgdG8gdHJlYXQgeW91ciBhcnJheSBhcyBpdGVtLCB5b3UgbmVlZCB0byB3cmFwIGl0IGJ5IHlvdXIKCQkJLy9zZWxmLCB3cmFwRGF0YUluQXJyYXkgaXMgZm9yIHRoaXMgcHVycG9zZQoKCQkJdmFyIHRlbXBsYXRlSWQsIHRlbXBsYXRlRGF0YSwgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgoJCQlpZiAod29ya2Zsb3cudGVtcGxhdGVJZCkgewoJCQkJdGVtcGxhdGVJZCA9IHdvcmtmbG93LnRlbXBsYXRlSWQ7CgkJCQl0ZW1wbGF0ZURhdGEgPSB3b3JrZmxvdy53cmFwRGF0YUluQXJyYXkgPyBbZGF0YV0gOiBkYXRhOwoJCQl9IGVsc2UgewoJCQkJdGVtcGxhdGVJZCA9IGRhdGE7CgkJCQl0ZW1wbGF0ZURhdGEgPSB7fTsKCQkJfQoKCQkJaWYgKCF0ZW1wbGF0ZUlkKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0KCgkJCS8vaGFuZGxlci50ZW1wbGF0ZUlkLCBoYW5kbGVyLndyYXBEYXRhSW5BcnJheSwgaGFuZGxlci5lbmdpbmVOYW1lIGlzCgkJCS8vYnVpbHQgaW4gZHVyaW5nIGluaXRpYWxpemF0aW9uICwgc2VlIGluaXRpYWxpemVycy50ZW1wbGF0ZU9wdGlvbnMKCQkJdmFyIGNvbnRlbnQgPSByZW5kZXJUZW1wbGF0ZSgKCgkJCQl0ZW1wbGF0ZUlkLAoKCQkJCXRlbXBsYXRlRGF0YSwKCgkJCQkvL3RoaXMgY29udGV4dCBjYW4gYmUgdXNlZCB0byBhY2Nlc3MgbW9kZWwgd2l0aGluIHRoZSB0ZW1wbGF0ZQoJCQkJbmV3IFJlbmRlckNvbnRleHQoIGUgKSwKCgkJCQl3b3JrZmxvdy5lbmdpbmVOYW1lICk7CgoJCQlpZiAoaXNQcm9taXNlKCBjb250ZW50ICkpIHsKCQkJCXJldHVybiBjb250ZW50OwoJCQl9CgkJCWlmIChpc1N0cmluZyggY29udGVudCApKSB7CgoJCQkJY29udGVudCA9ICQudHJpbSggY29udGVudCApOwoJCQl9CgoJCQkvL3RvIHdvcmsgYXJvdW5kIGEgYnVnIGluIGpRdWVyeQoJCQkvLyBodHRwOi8vanNmaWRkbGUubmV0L2pnU3JuLzEvCgkJCXJldHVybiAkKCAkKCAiPGRpdiAvPiIgKS5odG1sKCBjb250ZW50IClbMF0uY2hpbGROb2RlcyApOwoJCX0gZWxzZSB7CgkJCXJldHVybiAiIjsKCQl9Cgl9OwoKCS8vd2hlbiB0aGUgdGVtcGxhdGUgaXMgcmVuZGVyLCBuZWVkIHRvIHJlY3Vyc2l2ZWx5IGltcG9ydCBkZWNsYXJhdGl2ZSBzdWJzY3JpcHRpb25zCglobS5hY3Rpdml0eS5maW5hbGl6ZS5wYXJzZVN1YnMgPSBmdW5jdGlvbiggdmFsdWUsIGUgKSB7CgkJJCggdmFsdWUgKS5wYXJzZVN1YnMoKTsKCgl9OwoKCS8vYWRkIHJldXNhYmxlIGV2ZW50IGhhbmRsZXIKCWhtLndvcmtmbG93KCB7CgkJdG1wbDogdG1wbCwKCQlpbmNsdWRlOiBuZXdUZW1wbGF0ZUhhbmRsZXIoICJnZXQiLCAicmVwbGFjZVdpdGgiICkKCX0gKTsKCgliaW5kaW5ncyggewoKCQl0bXBsOiAiIWluaXQ6LnwqdG1wbCIsCgoJCXRtcGxPbkNoYW5nZTogIiFpbml0IGFmdGVyKi46LnwqdG1wbCIsCgoJCXRtcGxPbkNoaWxkQ2hhbmdlOiAiIWluaXQgYWZ0ZXIqLiBhZnRlciouMToufCp0bXBsIiwKCgkJdG1wbE9uQW55Q2hhbmdlOiAiIWluaXQgYWZ0ZXIqOi58KnRtcGwiLAoKCQlpbmNsdWRlOiAiIWluaXQ6LnwqaW5jbHVkZSIKCX0gKTsKCgkvL3RlbXBsYXRlT3B0aW9ucyBpcyB0ZW1wbGF0ZUlkLHdyYXBEYXRhSW5BcnJheSx0ZW1wbGF0ZUVuZ2luZU5hbWUKCS8vJCgiZGl2IikudG1wbCh0ZW1wbGF0ZUlkLCBwYXRoKQoJLy8kKCJkaXYiKS50bXBsKHRlbXBsYXRlSWQsIHBhdGgsIGZuKQoJLy9pZiB0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uIGlzIGEgZnVuY3Rpb24sIHRoZSBmdW5jdGlvbiBpcyB0cmVhdGVkCgkvL2FzIGZpbmFsaXplcgoJJGZuLnRtcGwgPSBmdW5jdGlvbiggdGVtcGxhdGVPcHRpb25zLCBtb2RlbFBhdGgsIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSB7CgoJCW1vZGVsUGF0aCA9IG1vZGVsUGF0aCB8fCAiIjsKCgkJaWYgKGlzRnVuY3Rpb24oIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSkgewoJCQl0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uID0gewoJCQkJZmluYWxpemU6IHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24KCQkJfTsKCQl9CgoJCXJldHVybiB0aGlzLnJlbmRlclZpZXcoCgoJCQltb2RlbFBhdGgsCgoJCQl0ZW1wbGF0ZVdvcmtmbG93RXh0ZW5zaW9uID8KCQkJCWV4dGVuZCgge30sIHRtcGwsIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gKSA6CgkJCQkiKnRtcGwiLAoKCQkJdGVtcGxhdGVPcHRpb25zCgkJKTsKCX07CgoJLy90ZW1wbGF0ZU9wdGlvbnMgaXMgdGVtcGxhdGVJZCx3cmFwRGF0YUluQXJyYXksdGVtcGxhdGVFbmdpbmVOYW1lCgkvLyQoImRpdiIpLmluY2x1ZGUocGF0aCwgdGVtcGxhdGVJZCkKCSRmbi5pbmNsdWRlID0gZnVuY3Rpb24oIHRlbXBsYXRlT3B0aW9ucywgbW9kZWxQYXRoLCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSB7CgoJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSkgewoJCQl0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gPSB7CgkJCQlmaW5hbGl6ZTogdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uCgkJCX07CgkJfQoKCQlyZXR1cm4gdGhpcy5yZW5kZXJWaWV3KAoJCQltb2RlbFBhdGgsCgkJCXRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiA/IGV4dGVuZCgge30sIGhtLndvcmtmbG93KCAicmVwbGFjZSIgKSwgdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uICkgOiAiKnJlcGxhY2UiLAoJCQl0ZW1wbGF0ZU9wdGlvbnMKCQkpOwoJfTsKCglmdW5jdGlvbiBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSApIHsKCQllbmdpbmVOYW1lID0gZW5naW5lTmFtZSB8fCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lOwoJCWlmICghZW5naW5lTmFtZSkgewoJCQl0aHJvdyAiZW5naW5lIG5hbWUgaXMgbm90IHNwZWNpZmllZCBvciBkZWZhdWx0IGVuZ2luZSBuYW1lIGlzIG51bGwiOwoJCX0KCQl2YXIgZW5naW5lQWRhcHRlciA9IHRlbXBsYXRlRW5naW5lQWRhcHRlcnNbZW5naW5lTmFtZV07CgkJaWYgKCFlbmdpbmVBZGFwdGVyKSB7CgkJCXRocm93ICJlbmdpbmUgJyIgKyBlbmdpbmVBZGFwdGVyICsgIicgY2FuIG5vdCBiZSBmb3VuZC4iOwoJCX0KCQlyZXR1cm4gZW5naW5lQWRhcHRlcjsKCgl9CgoJZnVuY3Rpb24gcmVuZGVyVGVtcGxhdGUoIHRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQsIGVuZ2luZU5hbWUgKSB7CgoJCXZhciBlbmdpbmVBZGFwdGVyID0gZ2V0VGVtcGxhdGVFbmdpbmUoIGVuZ2luZU5hbWUsIHRlbXBsYXRlSWQgKTsKCgkJdGVtcGxhdGVJZCA9ICQudHJpbSggdGVtcGxhdGVJZCApOwoKCQkvL3JlbW92ZSB0aGUgc3RhcnRpbmcgIioiIGZyb20gdGhlIHRlbXBsYXRlIGlkIHRvIGJlY29tZSB0aGUgcmVhbFRlbXBsYXRlSWQKCQl2YXIgcmVhbFRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkLnJlcGxhY2UoIHJCZWdpbldpdGhTdGFyLCAiIiApOwoKCQlpZiAoZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkKCByZWFsVGVtcGxhdGVJZCApKSB7CgoJCQlyZXR1cm4gZW5naW5lQWRhcHRlci5yZW5kZXIoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCByZW5kZXJDb250ZXh0ICk7CgoJCX0gZWxzZSBpZiAoZW5naW5lQWRhcHRlci5yZW5kZXJBc3luYykgewoKCQkJcmV0dXJuIGVuZ2luZUFkYXB0ZXIucmVuZGVyQXN5bmMoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCByZW5kZXJDb250ZXh0ICk7CgoJCX0gZWxzZSB7CgoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQljbG9uZUV2ZW50ID0gZXh0ZW5kKCB0cnVlLCB7fSwgcmVuZGVyQ29udGV4dC5lICksCgkJCQlwdWJsaXNoZXIgPSBleHRlbmQoIHRydWUsIHt9LCBjbG9uZUV2ZW50LnB1Ymxpc2hlciApLAoJCQkJY2xvbmVkQ29udGV4dCA9IGV4dGVuZCggdHJ1ZSwge30sIHJlbmRlckNvbnRleHQgKTsKCgkJCWNsb25lRXZlbnQucHVibGlzaGVyID0gcHVibGlzaGVyOwoJCQljbG9uZWRDb250ZXh0LmUgPSBjbG9uZUV2ZW50OwoKCQkJLy90ZW1wbGF0ZS5sb2FkIGlzIGltcGxlbWVudGVkIGluIGV4dGVybmFsLXRlbXBsYXRlLmpzCgkJCXRlbXBsYXRlLmxvYWQoIHRlbXBsYXRlSWQgKS5kb25lKCBmdW5jdGlvbigpIHsKCgkJCQl2YXIgY29udGVudCA9IGVuZ2luZUFkYXB0ZXIucmVuZGVyKCByZWFsVGVtcGxhdGVJZCwgZGF0YSwgY2xvbmVkQ29udGV4dCApLAoJCQkJCXJ0biA9ICQoIGNvbnRlbnQgKTsKCgkJCQlkZWZlci5yZXNvbHZlKCBydG4uc2VsZWN0b3IgfHwgIXJ0bi5sZW5ndGggPyBjb250ZW50IDogcnRuICk7CgoJCQl9ICk7CgoJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoKCQl9Cgl9CgoJaG0udGVtcGxhdGUgPSB0ZW1wbGF0ZSA9IHsKCgkJZGVmYXVsdEVuZ2luZTogIiIsCgoJCS8qCgkJIGhtLnRlbXBsYXRlLm15RW5naW5lID0gewoJCSByZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkge30sCgkJIGNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UgKSB7fSwKCQkgaXNUZW1wbGF0ZUxvYWRlZDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7fQoJCSB9OwoJCSAqLwoJCWVuZ2luZUFkYXB0ZXI6IGZ1bmN0aW9uKCBuYW1lLCBlbmdpbmVBZGFwdGVyICkgewoJCQlpZiAoIW5hbWUpIHsKCQkJCXJldHVybiB0ZW1wbGF0ZUVuZ2luZUFkYXB0ZXJzOwoJCQl9CgkJCWlmICghZW5naW5lQWRhcHRlcikgewoJCQkJcmV0dXJuIHRlbXBsYXRlRW5naW5lQWRhcHRlcnNbbmFtZV07CgkJCX0KCQkJZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkID0gZW5naW5lQWRhcHRlci5pc1RlbXBsYXRlTG9hZGVkIHx8IHJldHVyblRydWU7CgkJCXRlbXBsYXRlRW5naW5lQWRhcHRlcnNbbmFtZV0gPSBlbmdpbmVBZGFwdGVyOwoJCQl0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lID0gbmFtZTsKCQl9LAoKCQkvL2R5bmFtaWNhbGx5IGxvYWQgYSB0ZW1wbGF0ZSBieSB0ZW1wbGF0ZUlkLAoJCS8vaXQgaXMgY2FsbGVkIGJ5IHRlbXBsYXRlLnJlbmRlcgoJCS8vVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gcmVxdWlyZWQgbG9hZGVyLmpzCgkJLy9idXQgeW91IGNhbiBvdmVycmlkZSB0aGlzLCBhbGwgeW91IG5lZWQKCQkvLyBpcyB0byByZXR1cm4gaXMgdGhhdCBhIHByb21pc2UsIHdoZW4gdGhlIHByb21pc2UgaXMKCQkvLyBkb25lLCB0aGUgdGVtcGxhdGUgc2hvdWxkIGJlIHJlYWR5IHRvIHVzZWQKCQlsb2FkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJLy93ZSBuZWVkIHRvIG1vZGlmeSB0aGUgaWQgYnkgYWRkaW5nIGFuIGV4dGVuc2lvbiB0byB0aGUgaWQKCQkJLy8gaG0ubG9hZGVyIHVzZSBleHRlbnNpb24gdG8gZGV0ZXJtaW5lIHdoYXQgbG9hZGVyIGlzIHVzZWQKCQkJLy8gaGFuZGxlIHRoZSBhY3R1YWwgbG9hZGluZyB3b3JrCgkJCXJldHVybiBfbG9hZGVyLmxvYWQoIHRlbXBsYXRlSWQuZW5kc1dpdGgoICIuaHRtbCIgKSA/IHRlbXBsYXRlSWQgOiB0ZW1wbGF0ZUlkICsgIi50ZW1wbGF0ZSIgKTsKCQl9LAoKCQkvL3RoaXMgc2hvdWxkIGJlIGNhbGxlZCBieSBobS50ZW1wbGF0ZS5sb2FkIGFmdGVyIHRoZSBtZXRob2QKCQkvL2dldCB0aGUgc291cmNlIG9mIHRoZSB0ZW1wbGF0ZQoJCWNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UsIGVuZ2luZU5hbWUgKSB7CgkJCXJldHVybiBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSApLmNvbXBpbGUoCgkJCQl0ZW1wbGF0ZUlkLmVuZHNXaXRoKCAiLnRlbXBsYXRlIiApID8gX2xvYWRlci5maWxlTmFtZSggdGVtcGxhdGVJZCApIDogdGVtcGxhdGVJZCwKCQkJCXNvdXJjZSApOwoJCX0sCgoJCS8vYnVpbGQgYSBjdXN0b21pemVkIGhhbmRsZXIgd2hpY2ggaGFuZGxlIHRoZSBjaGFuZ2Ugb2YgbW9kZWwKCQkvL2J5IGRlZmF1bHQKCQkvL2dldEZpbHRlciBpcyAiZ2V0IiB3aGljaCBpcyB0byBnZXQgbW9kZWwgdmFsdWUsCgkJLy8gaXQgY2FuIGJlIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIChlKSB7fQoJCS8vCgkJLy9zZXRGaWx0ZXIgaXMgImh0bWwiIHdoaWNoIGlzIHRvIGNoYW5nZSB0aGUgY29udGVudCBvZiB0aGUgdmlldwoJCS8vaXQgY2FuIGJlIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIChlLCB2YWx1ZSkKCQluZXdUZW1wbGF0ZUhhbmRsZXI6IG5ld1RlbXBsYXRlSGFuZGxlciwKCgkJdGVtcGxhdGVJZFRvVXJsOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCgkJCXZhciBtYXRjaCA9IHJCZWdpbldpdGhBcGsuZXhlYyggdGVtcGxhdGVJZCApOwoKCQkJcmV0dXJuIG1hdGNoID8KCQkJCS8vYXBrLmhlbGxvIC0tPiBhcHBsZXQvaGVsbG8vbWFpbi5odG1sCgkJCQkvL2Fway5oZWxsby5ieWUgLS0+IGFwcGxldC9oZWxsby9ieWUuaHRtbAoJCQkJImFway8iICsgbWF0Y2hbMV0gKyAiLyIgKyAobWF0Y2hbM10gfHwgIm1haW4iICkgKyAiLmh0bWwiIDoKCgkJCQkvL3h4eC5odG1sIC0tPiB4eHguaHRtbAoJCQkJLy94eHgueXl5Lmh0bWwgLS0+IHh4eC55eXkuaHRtbAoJCQkJdGVtcGxhdGVJZC5lbmRzV2l0aCggIi5odG1sIiApID8gdGVtcGxhdGVJZCA6CgoJCQkJCS8veHh4IC0tPiB4eHguaHRtbAoJCQkJCS8veHh4Lnl5eSAtLT4geHh4Lmh0bWwKCQkJCQl0ZW1wbGF0ZUlkLnNwbGl0KCAiLiIgKVswXSArICIuaHRtbCI7CgoJCX0KCgl9OwoKCV9sb2FkZXIoICJ0ZW1wbGF0ZSIsIHsKCgkJbG9hZDogewoJCQljb21waWxlOiBmdW5jdGlvbiggbW9kdWxlSWQsIHNvdXJjZUNvZGUgKSB7CgoJCQkJdmFyICRzY3JpcHRMaXN0ID0gJCggc291cmNlQ29kZSApOwoKCQkJCXZhciBoYXNTY3JpcHRUYWcgPSBmYWxzZTsKCQkJCSRzY3JpcHRMaXN0LmVhY2goIGZ1bmN0aW9uKCkgewoKCQkJCQlpZiAodGhpcy50YWdOYW1lID09ICJTQ1JJUFQiKSB7CgkJCQkJCWhhc1NjcmlwdFRhZyA9IHRydWU7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9ICk7CgoJCQkJaWYgKGhhc1NjcmlwdFRhZykgewoKCQkJCQkkc2NyaXB0TGlzdC5lYWNoKCBmdW5jdGlvbigpIHsKCgkJCQkJCWlmICh0aGlzLnRhZ05hbWUgPT0gIlNDUklQVCIpIHsKCgkJCQkJCQl2YXIgJHNvdXJjZUNvZGVDb250YWluZXIgPSAkKCB0aGlzICk7CgoJCQkJCQkJdGVtcGxhdGUuY29tcGlsZSgKCQkJCQkJCQl0aGlzLmlkLAoJCQkJCQkJCSRzb3VyY2VDb2RlQ29udGFpbmVyLmh0bWwoKSwKCQkJCQkJCQkkc291cmNlQ29kZUNvbnRhaW5lci5hdHRyKCAidHlwZSIgKSB8fCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lICk7CgkJCQkJCX0KCgkJCQkJfSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZW1wbGF0ZS5jb21waWxlKCBtb2R1bGVJZCwgc291cmNlQ29kZSwgdGVtcGxhdGUuZGVmYXVsdEVuZ2luZSApOwoJCQkJfQoKCQkJfSwKCQkJYnVpbGREZXBlbmRlbmNpZXM6ICJwYXJzZURlcGVuZHNUYWciCgkJfSwKCgkJdXJsOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJLy9maXJzdCB0cnVuY2F0ZSB0aGUgIi50ZW1wbGF0ZSIgaW4gdGhlIHRlbXBsYXRlSWQsIGFuZCBnZXQgdGhlIHJlYWwgdGVtcGxhdGVJZAoJCQlyZXR1cm4gdGVtcGxhdGUudGVtcGxhdGVJZFRvVXJsKCBfbG9hZGVyLmZpbGVOYW1lKCB0ZW1wbGF0ZUlkICkgKTsKCQl9Cgl9ICk7CgoJX2xvYWRlciggImh0bWwiLCAidGVtcGxhdGUiLCB7CgkJLy8JCWxvYWQ6IHsKCQkvLwkJCWNvbXBpbGU6IGZ1bmN0aW9uKCBtb2R1bGVJZCwgc291cmNlQ29kZSApIHsKCQkvLwkJCQlyZXR1cm4gdGVtcGxhdGUuY29tcGlsZSggbW9kdWxlSWQsIHNvdXJjZUNvZGUsIHRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgKTsKCQkvLwkJCX0KCQkvLwkJfQoKCQl1cmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQlyZXR1cm4gdGVtcGxhdGVJZDsKCQl9Cgl9ICk7CgoKCWlmICgkLnJlbmRlciAmJiAkLnRlbXBsYXRlcykgewoKCQl2YXIgZW5naW5lOwoKCgkJdGVtcGxhdGUuZW5naW5lQWRhcHRlciggImpzcmVuZGVyIiwgZW5naW5lID0gewoKCQkJcmVuZGVyOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgZGF0YSwgY29udGV4dCApIHsKCQkJCWlmICghJC5yZW5kZXJbdGVtcGxhdGVJZF0pIHsKCQkJCQl0aGlzLmNvbXBpbGUoIHRlbXBsYXRlSWQsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCB0ZW1wbGF0ZUlkICkuaW5uZXJIVE1MICk7CgkJCQl9CgkJCQlyZXR1cm4gJC5yZW5kZXJbdGVtcGxhdGVJZF0oIGRhdGEsIGNvbnRleHQgKTsKCQkJfSwKCgkJCWNvbXBpbGU6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBzb3VyY2UgKSB7CgkJCQkkLnRlbXBsYXRlcyggdGVtcGxhdGVJZCwgewoJCQkJCW1hcmt1cDogc291cmNlLAoJCQkJCWRlYnVnOiBlbmdpbmUudGVtcGxhdGVEZWJ1Z01vZGUsCgkJCQkJYWxsb3dDb2RlOiBlbmdpbmUuYWxsb3dDb2RlSW5UZW1wbGF0ZQoJCQkJfSApOwoJCQl9LAoKCQkJaXNUZW1wbGF0ZUxvYWRlZDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7CgkJCQlyZXR1cm4gISEkLnJlbmRlclt0ZW1wbGF0ZUlkXSB8fCAhIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCB0ZW1wbGF0ZUlkICk7CgkJCX0sCgoJCQkvL3RlbXBsYXRlRGVidWdNb2RlIGlzIGpzUmVuZGVyIHNwZWNpZmljIHNldHRpbmcKCQkJdGVtcGxhdGVEZWJ1Z01vZGU6IGZhbHNlLAoKCQkJLy9hbGxvd0NvZGVJblRlbXBsYXRlIGlzIGpzUmVuZGVyIHNwZWNpZmljIHNldHRpbmcKCQkJYWxsb3dDb2RlSW5UZW1wbGF0ZTogdHJ1ZQoJCX0gKTsKCgkJdmFyIHRhZ3MgPSAkLnZpZXdzLnRhZ3M7CgoJCS8vdGhlIGZvbGxvd2luZyB0YWdzIGEganNyZW5kZXIgc3BlY2lmaWMgaGVscGVyCgkJdGFncyggewoKCQkJLy97e3RzIC99fSBzbyB0aGF0IGl0IGNhbiBlbWl0IGEgdGltZXN0YW1wCgkJCXRzOiBmdW5jdGlvbiB4KCkgewoJCQkJcmV0dXJuIHguZW5hYmxlZCA/CgkJCQkJIjxzcGFuIHN0eWxlPSdjb2xvcjpyZWQnIGRhdGEtc3ViPSdzaG93Oi8qdHMnPnVwZGF0ZWQgb246IiArICgrbmV3IERhdGUoKSArICIiKS5zdWJzdHJpbmcoIDcsIDEwICkgKyAiPC9zcGFuPiIgOgoJCQkJCSIiOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBwdWJsaXNoZXIgPSB0aGlzLmN0eC5lLnB1Ymxpc2hlcjsKCQkJCXJldHVybiBwdWJsaXNoZXIuZ2V0LmFwcGx5KCBwdWJsaXNoZXIsIGFyZ3VtZW50cyApOwoJCQl9LAoKCQkJcHJvcDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5kZXggPSB0aGlzLnRhZ0N0eC52aWV3LmluZGV4OwoKCQkJCWlmIChpc1VuZGVmaW5lZCggaW5kZXggKSkgewoJCQkJCS8vdGhpcyBpcyB0aGUgY2FzZSB3aGVuIHRlbXBsYXRlIGlzIHJlbmRlciB3aXRoCgkJCQkJLy8gYSBzaW5nbGUgZGF0YSBpdGVtIGluc3RlYWQgb2YgYXJyYXkKCQkJCQlpbmRleCA9ICh0aGlzLmN0eC5lLnB1Ymxpc2hlci5jb3VudCgpIC0gMSk7CgkJCQl9CgoJCQkJdmFyIGl0ZW1Ob2RlID0gdGhpcy5jdHguZS5wdWJsaXNoZXIuY2QoIGluZGV4ICk7CgkJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgYXJndW1lbnRzICk7CgkJCX0sCgoJCQkvL3t7Zml4ZWRSb3dJZCAvfX0KCQkJZml4ZWRSb3dJZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIi8iICsgdGhpcy5jdHgubW9kZWxQYXRoICsgIi50YWJsZS4iICsgdGhpcy5jdHguZS5wdWJsaXNoZXIuaXRlbUtleSggdGhpcy50YWdDdHgudmlldy5kYXRhICk7CgkJCX0sCgoJCQkvL3t7cm93SWQgL319CgkJCXJvd0lkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBpbmRleCA9IHRoaXMudGFnQ3R4LnZpZXcuaW5kZXgsCgkJCQkJcGF0aCA9IHRoaXMuY3R4Lm1vZGVsUGF0aDsKCgkJCQlpZiAoaXNVbmRlZmluZWQoIGluZGV4ICkpIHsKCQkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiB0ZW1wbGF0ZSBpcyByZW5kZXIgd2l0aAoJCQkJCS8vIGEgc2luZ2xlIGRhdGEgaXRlbSBpbnN0ZWFkIG9mIGFycmF5CgkJCQkJaW5kZXggPSAodGhpcy5jdHguZS5wdWJsaXNoZXIuY291bnQoKSAtIDEpOwoJCQkJfQoKCQkJCXJldHVybiAiLyIgKyBwYXRoICsgIi4iICsgaW5kZXg7CgkJCX0sCgoJCQkvL3t7bW9kZWxQYXRoIC99fQoJCQkvL2l0IHVzZWZ1bCB3aGVuICBpbiBodHRwOi8vanNiaW4uY29tL2V0YWNvYi82L2VkaXQKCQkJbW9kZWxQYXRoOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAiLyIgKyB0aGlzLmN0eC5tb2RlbFBhdGg7CgkJCX0KCgkJfSApOwoKCQl0YWdzLnRzLnJlbmRlci5lbmFibGVkID0gdHJ1ZTsKCgkJaG0oICIqdHMiLCBmYWxzZSApOwoKCX0KCgoKLy8KCgoJdmFyIEhhbmRsZWJhcnMgPSB3aW5kb3cuSGFuZGxlYmFyczsKCglpZiAoIWlzVW5kZWZpbmVkKCBIYW5kbGViYXJzICkpIHsKCgkJaG0udGVtcGxhdGUuZW5naW5lQWRhcHRlciggImhhbmRsZWJhcnMiLCB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoKCQkJCXJldHVybiBIYW5kbGViYXJzLnBhcnRpYWxzW3RlbXBsYXRlSWRdKCBkYXRhLCB7CgkJCQkJZGF0YToge3JlbmRlckNvbnRleHQ6IGNvbnRleHR9CgkJCQl9ICk7CgkJCX0sCgoJCQljb21waWxlOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgc291cmNlICkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRlbXBsYXRlSWQsIEhhbmRsZWJhcnMuY29tcGlsZSggc291cmNlICkgKTsKCQkJfSwKCgkJCWlzVGVtcGxhdGVMb2FkZWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkJcmV0dXJuICEhSGFuZGxlYmFycy5wYXJ0aWFsc1t0ZW1wbGF0ZUlkXTsKCQkJfQoKCQl9ICk7CgoJCS8ve3ttb2RlbFBhdGh9fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJtb2RlbFBhdGgiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJcmV0dXJuIG9wdGlvbnMuZGF0YS5yZW5kZXJDb250ZXh0Lm1vZGVsUGF0aDsKCQl9ICk7CgoJCS8ve3tyb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggInJvd0lkIiwgZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXJldHVybiAiLyIgKyBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dC5tb2RlbFBhdGggKyAiLiIgKyBvcHRpb25zLmRhdGEuaW5kZXggKyAiOyI7CgkJfSApOwoKCQkvL3t7Zml4ZWRSb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggImZpeGVkUm93SWQiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHJlbmRlckNvbnRleHQgPSBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dDsKCQkJcmV0dXJuICIvIiArIHJlbmRlckNvbnRleHQubW9kZWxQYXRoICsgIi50YWJsZS4iICsgcmVuZGVyQ29udGV4dC5lLnB1Ymxpc2hlci5pdGVtS2V5KCB0aGlzICk7CgkJfSApOwoKCQkvL3t7Z2V0ICIuLnNldFRvIiBuYW1lfX0KCQlIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCAiZ2V0IiwgZnVuY3Rpb24oKSB7CgkJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQkJbGFzdCA9IGFyZ3MubGVuZ3RoIC0gMSwKCQkJLy9hcmdzW2xhc3RdLmRhdGEgaXMgb3B0aW9ucy5kYXRhCgkJCQlyZW5kZXJDb250ZXh0ID0gYXJnc1tsYXN0XS5kYXRhLnJlbmRlckNvbnRleHQ7CgoJCQlyZXR1cm4gcmVuZGVyQ29udGV4dC5nZXQuYXBwbHkoIHJlbmRlckNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3MsIDAsIGxhc3QgKSApOwoJCX0gKTsKCgkJLy97e3twcm9wICJsaW5rIn19fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJwcm9wIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzbGljZSA9IFtdLnNsaWNlLAoJCQkJYXJncyA9IGFyZ3VtZW50cywKCQkJCWxhc3QgPSBhcmdzLmxlbmd0aCAtIDEsCgkJCQlvcHRpb25zID0gYXJnc1tsYXN0XSwKCQkJCWRhdGEgPSBvcHRpb25zLmRhdGEsCgkJCQlyZW5kZXJDb250ZXh0ID0gZGF0YS5yZW5kZXJDb250ZXh0LAoJCQkJaXRlbU5vZGUgPSByZW5kZXJDb250ZXh0LmUucHVibGlzaGVyLmNkKCBkYXRhLmluZGV4ICk7CgoJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgc2xpY2UuY2FsbCggYXJncywgMCwgbGFzdCApICk7CgkJfSApOwoKCQkkKCBmdW5jdGlvbigpIHsKCQkJJCggInNjcmlwdFt0eXBlPWhhbmRsZWJhcnNdIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRoaXMuaWQsIEhhbmRsZWJhcnMuY29tcGlsZSggJCggdGhpcyApWzBdLmlubmVySFRNTCApICk7CgkJCX0gKTsKCQl9ICk7CgoJfQoKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2Rvbid0IGNoYW5nZSBpdCB0byBiZWNhdXNlIHdlIHdhbnQgdG8gY29udHJvbCB0aGUgc2VhcmNoIG9yZGVyCgkvL2NoZWNrIGZpbmRWYWx1ZUFkYXB0ZXIoJGVsZW0sIGFkYXB0ZXJOYW1lKQoJLy97CgkvLyAgIG5hbWUxOiBhZGFwdGVyMSwKCS8vICAgbmFtZTI6IGFkYXB0ZXIyCgkvL30KCXZhciB2YWx1ZUFkYXB0ZXJzID0gWwoJCXsKCQkJLy90aGUgZGVmYXVsdCB2aWV3IGFkYXB0ZXIKCQkJbmFtZTogInRleHRCb3hPckRyb3BEb3duIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJaWYgKG1vZGVsVmFsdWUpIHsKCQkJCQlpZiAoJGVsZW1bMF0udGFnTmFtZSA9PSAiU0VMRUNUIikgewoJCQkJCQkkZWxlbS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKHRoaXMudmFsdWUgPT0gbW9kZWxWYWx1ZSkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGVsZW0uYXR0ciggInZhbHVlIiwgbW9kZWxWYWx1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0udmFsKCk7CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICgkZWxlbS52YWwoKSAhPT0gdmFsdWUpIHsKCQkJCQkkZWxlbS52YWwoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiByZXR1cm5UcnVlCgkJfSwKCQl7CgkJCW5hbWU6ICJjaGVja2JveCIsCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCAkZWxlbSwgbW9kZWxWYWx1ZSApIHsKCQkJCWlmIChtb2RlbFZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCgkJCQlpZiAodmFsdWUgPT0gInRydWUiKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9IGVsc2UgaWYgKHZhbHVlID09ICJmYWxzZSIpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKHZhbHVlICE9PSAib24iKSB7CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gZWxlbS5jaGVja2VkOwoJCQkJfQoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uIHNldENoZWNrYm94KCAkZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJaWYgKGlzQm9vbGVhbiggdmFsdWUgKSkgewoJCQkJCWVsZW0uY2hlY2tlZCA9IHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQllbGVtLmNoZWNrZWQgPSAodmFsdWUgPT0gZWxlbS52YWx1ZSk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICI6Y2hlY2tib3giICk7CgkJCX0KCQl9LAoJCXsKCQkJbmFtZTogInJhZGlvIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoKCQkJCWlmIChtb2RlbFZhbHVlID09ICRlbGVtWzBdLnZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQlpZiAoZS50eXBlID09ICJyZXNldFZhbCIgJiYgIWUucHVibGlzaGVyLmF0dHIoICJjaGVja2VkIiApKSB7CgkJCQkJZS5hYm9ydCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCQkJCWlmICh2YWx1ZSA9PSAidHJ1ZSIpIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgPT0gImZhbHNlIikgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgIT09ICJvbiIpIHsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBlbGVtLmNoZWNrZWQ7CgkJCQl9CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSwgZSApIHsKCQkJCXZhciBlbGVtID0gJGVsZW1bMF07CgkJCQlpZiAoIWVsZW0ubmFtZSkgewoJCQkJCWVsZW0ubmFtZSA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQl9CgkJCQllbGVtLmNoZWNrZWQgPSAoIHV0aWwudG9TdHJpbmcoIHZhbHVlICkgPT0gZWxlbS52YWx1ZSApOwoJCQl9LAoJCQltYXRjaDogZnVuY3Rpb24oICRlbGVtICkgewoJCQkJcmV0dXJuICRlbGVtLmlzKCAiOnJhZGlvIiApOwoJCQl9CgkJfSwKCQl7CgkJCW5hbWU6ICJsaXN0Qm94IiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAobW9kZWxWYWx1ZS5jb250YWlucyggdGhpcy52YWx1ZSApKSB7CgkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQl2YXIgb3B0aW9ucyA9IFtdOwoJCQkJJGVsZW0uY2hpbGRyZW4oICJvcHRpb246c2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJb3B0aW9ucy5wdXNoKCB0aGlzLnZhbHVlICk7CgkJCQl9ICk7CgkJCQlyZXR1cm4gb3B0aW9ucy5sZW5ndGggPyBvcHRpb25zIDogbnVsbDsKCQkJfSwKCQkJc2V0OiBmdW5jdGlvbiggJGVsZW0sIHZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl0aGlzLnNlbGVjdGVkID0gISEodmFsdWUgJiYgdmFsdWUuY29udGFpbnMoIHRoaXMudmFsdWUgKSk7CgkJCQl9ICk7CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICJzZWxlY3RbbXVsdGlwbGVdIiApOwoJCQl9CgkJfQoJXTsKCglmdW5jdGlvbiBmaW5kVmFsdWVBZGFwdGVyKCAkZWxlbSwgYWRhcHRlck5hbWUgKSB7CgkJdmFyIGksIGFkYXB0ZXI7CgoJCWlmIChhZGFwdGVyTmFtZSkgewoJCQlmb3IgKGkgPSB2YWx1ZUFkYXB0ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQlhZGFwdGVyID0gdmFsdWVBZGFwdGVyc1tpXTsKCQkJCWlmIChhZGFwdGVyLm5hbWUgPT0gYWRhcHRlck5hbWUpIHsKCQkJCQlyZXR1cm4gYWRhcHRlcjsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCS8vc2VhcmNoIGZyb20gdGFpbCB0byBoZWFkCgkJCWZvciAoaSA9IHZhbHVlQWRhcHRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCWFkYXB0ZXIgPSB2YWx1ZUFkYXB0ZXJzW2ldOwoJCQkJaWYgKGFkYXB0ZXIubWF0Y2ggJiYgYWRhcHRlci5tYXRjaCggJGVsZW0gKSkgewoJCQkJCXJldHVybiBhZGFwdGVyOwoJCQkJfQoJCQl9CgkJfQoJfQoKCWhtLmFjdGl2aXR5LmdldC5nZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiggZSApIHsKCQkvL2UuaGFuZGxlci5nZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLmdldFZpZXdWYWx1ZSggZS5wdWJsaXNoZXIsIGUgKTsKCX07CgoJaG0uYWN0aXZpdHkuc2V0LnNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkvL2UuaGFuZGxlci5zZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLnNldFZpZXdWYWx1ZSggdGhpcywgdmFsdWUsIGUgKTsKCX07CgoJZnVuY3Rpb24gaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBtb2RlbCwgdmlldywgaGFuZGxlciwgYWRhcHRlck5hbWUsIG1ldGhvZE5hbWUgKSB7CgoJCXZhciBhZGFwdGVyID0gZmluZFZhbHVlQWRhcHRlciggdmlldywgYWRhcHRlck5hbWUgKTsKCgkJaWYgKCFhZGFwdGVyIHx8ICFhZGFwdGVyW21ldGhvZE5hbWVdKSB7CgoJCQl0aHJvdyAiY2FuIG5vdCBmaW5kICIgKyBtZXRob2ROYW1lICsgIiBtZXRob2QgZm9yIHZpZXciOwoJCX0KCgkJLy9jcmVhdGUgaGFuZGxlci5nZXRWaWV3VmFsdWUgb3IgaGFuZGxlci5zZXRWaWV3VmFsdWUKCQloYW5kbGVyW21ldGhvZE5hbWUgKyAiVmlld1ZhbHVlIl0gPSBhZGFwdGVyW21ldGhvZE5hbWVdOwoKCQlpZiAoYWRhcHRlci5jb252ZXJ0KSB7CgkJCWhhbmRsZXIuY29udmVydCA9IGFkYXB0ZXIuY29udmVydDsKCQl9CgoJCS8vd2Ugd2FudCB0byBydW4gdGhlIGluaXRpYWxpemUgbWV0aG9kIG9ubHkgb25jZQoJCWlmICghdmlldy5obURhdGEoICJ2YWx1ZUJvdW5kIiApKSB7CgoJCQlhZGFwdGVyLmluaXRpYWxpemUgJiYgYWRhcHRlci5pbml0aWFsaXplKCB2aWV3LCBtb2RlbC5nZXQoKSApOwoKCQkJLy93aGVuICJyZXNldCIgZXZlbnQgaXMgdHJpZ2dlciB0byBwYXJlbnQgZm9ybSwgdGhlIGNoaWxkcmVuIGRvZXMKCQkJLy9ub3QgdHJpZ2dlciB0aGUgZXZlbnQsIHNvIHRoYXQgd2UgbmVlZCB0byB0cmlnZ2VyICJyZXNldFZhbCIgdG8gdXBkYXRlCgkJCS8vYmFjayB0aGUgb3JpZ2luYWwgdmFsdWUgdG8gbW9kYWwKCQkJdmlldy5wYXJlbnRzKCAiZm9ybSIgKS5iaW5kKCAicmVzZXQiLCBmdW5jdGlvbigpIHsKCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl2aWV3LnRyaWdnZXJIYW5kbGVyKCAicmVzZXRWYWwiICk7CgkJCQl9LCAxMCApOwoJCQl9ICk7CgoJCQl2aWV3LmhtRGF0YSggInZhbHVlQm91bmQiLCB0cnVlICk7CgoJCX0KCX0KCglobS53b3JrZmxvdyggewoKCQkvL3NldCB2aWV3IHZhbHVlIHdpdGggbW9kZWwgdmFsdWUKCQl1cGRhdGVWaWV3VmFsdWU6IHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lICkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIHZpZXcsIHRyeWluZyB0byBnZXRNb2RlbCBzZXRWaWV3CgkJCQlpbml0QWRhcHRlck1ldGhvZEZvclZpZXcoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lLCAic2V0IiApOwoKCQkJfSwKCQkJZ2V0OiAiZ2V0IiwKCQkJc2V0OiAiKnNldFZpZXdWYWx1ZSIKCQl9LAoKCQkvL3NldCBtb2RlbCB2YWx1ZSB3aXRoIHZpZXcgdmFsdWUKCQl1cGRhdGVNb2RlbFZhbHVlOiB7CgoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgYWRhcHRlck5hbWUgKSB7CgkJCQkvL3B1Ymxpc2hlciBpcyB2aWV3LCB0cnlpbmcgdG8gZ2V0VmlldyBzZXRNb2RlbAoJCQkJaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIHdvcmtmbG93LCBhZGFwdGVyTmFtZSwgImdldCIgKTsKCgkJCX0sCgkJCWdldDogIipnZXRWaWV3VmFsdWUiLAoJCQlzZXQ6ICJzZXQiCgkJfQoJfSApOwoKCS8vYWRkIHZhbHVlIGFkYXB0ZXIKCS8vdGhlIGxhc3QgYWRkZWQgdXNpbmcgdGhlIG1ldGhvZCwgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCS8qCgkgLy9hIHZpZXcgYWRhcHRlciBpcyBpcyBsaWtlCgkgewoJIC8vb3B0aW9uYWwgaWYgbWF0Y2ggZnVuY3Rpb24gaXMgcHJlc2VudAoJIG5hbWU6ICJhZGFwdGVyTmFtZSIsCgkgLy8KCSAvL29wdGlvbmFsIGlmIG5hbWUgaXMgcHJlc2VudAoJIG1hdGNoOiBmdW5jdGlvbiAoJGVsZW0pIHsgcmV0dXJuIHRydWU7IH0sCgkgLy8KCSAvL3ByZXBhcmUgJGVsZW1lbnQKCSBpbml0aWFsaXplOiBmdW5jdGlvbiAoJGVsZW0pIHt9CgkgLy8KCSAvL2dldCBhIHZhbHVlIGZyb20gZWxlbWVudAoJIGdldDogZnVuY3Rpb24gKCRlbGVtKSB7fSwKCSAvLwoJIC8vc2V0IGEgdmFsdWUgdG8gJGVsZW1lbnQKCSBzZXQ6IGZ1bmN0aW9uKCAkZWxlbSwgdmFsdWUgKSB7fSwKCSAvLwoJIC8vb3B0aW9uYWwsIGlmIGdldCBmdW5jdGlvbiBhbHJlYWR5IGNvbnZlcnQsIHlvdSBkb24ndCBuZWVkIHRoaXMKCSBjb252ZXJ0OiAiKmNvbW1vbkNvbnZlcnRBY3Rpdml0eU5hbWUiIG9yIGZ1bmN0aW9uICh2YWx1ZSkge30KCgkgfQoJICogKi8KCWhtLnZhbHVlQWRhcHRlciA9IGZ1bmN0aW9uKCBhZGFwdGVyICkgewoJCWlmIChhZGFwdGVyKSB7CgkJCXZhbHVlQWRhcHRlcnMucHVzaCggYWRhcHRlciApOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2YWx1ZUFkYXB0ZXJzOwoJCX0KCX07CgoJLy9keW5hbWljIGdyb3VwCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZwoJLy8KCS8vdmFsOnBhdGgKCS8vdmFsOnBhdGh8a2V5cHJlc3MKCS8vdmFsOnBhdGh8LHVwZGF0ZU1vZGVsCgkvL3ZhbDpwYXRofCx1cGRhdGVWaWV3CgkvL3ZhbDpwYXRofCwsZGF0ZQoJLy92YWw6cGF0aHx1cGRhdGVFdmVudCx1cGRhdGVEaXJlY3Rpb24sYWRhcHRlck5hbWUKCWJpbmRpbmdzKCB7CgkJdmFsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciB1cGRhdGVUYXJnZXQsCgkJCQl1cGRhdGVFdmVudCwKCQkJCWFkYXB0ZXJOYW1lOwoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgoJCQlpZiAoIW9wdGlvbnMpIHsKCQkJCXVwZGF0ZUV2ZW50ID0gImNoYW5nZSI7CgkJCX0gZWxzZSB7CgkJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCQl1cGRhdGVFdmVudCA9IG9wdGlvbnNbMF0gfHwgImNoYW5nZSI7IC8vYnkgZGVmYXVsdCBpdCBpcyAiY2hhbmdlIgoJCQkJdXBkYXRlVGFyZ2V0ID0gb3B0aW9uc1sxXTsgLy91bmRlZmluZWQsIHVwZGF0ZVZpZXcgb3IgdXBkYXRlTW9kZWwKCQkJCWFkYXB0ZXJOYW1lID0gb3B0aW9uc1syXTsKCQkJfQoKCQkJaWYgKCF1cGRhdGVUYXJnZXQgfHwgdXBkYXRlVGFyZ2V0ID09ICJ2aWV3IikgewoJCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MSBhZnRlcioiLCAiKnVwZGF0ZVZpZXdWYWx1ZSIsIGFkYXB0ZXJOYW1lICk7CgkJCX0KCgkJCWlmICghdXBkYXRlVGFyZ2V0IHx8IHVwZGF0ZVRhcmdldCA9PSAibW9kZWwiKSB7CgoJCQkJLy93aGVuIGZvcm0gaXMgcmVzZXQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIGZvcm0gdmFsdWUgaXMgcmVzZXQKCQkJCS8vIHRvIHZhbHVlIHNwZWNpZnkgInZhbHVlIiBhdHRyaWJ1dGUsIGhvd2V2ZXIgdGhlIGNoYW5nZSBldmVudCBkb2VzIG5vdCB0cmlnZ2VyLAoJCQkJLy8KCQkJCS8vc28gd2UgbmVlZCB0byB1c2UgYSBzcGVjaWFsIGV2ZW50ICJyZXNldFZhbCIgd2hpY2ggaXMgdHJpZ2dlcmVkCgkJCQkvLyB3aGVuIHRoZSBwYXJlbnQgZm9ybSBlbGVtZW50IGlzIHRyaWdnZXJlZAoJCQkJLy8gYnkgdXNpbmcgdGhpcyBldmVudCwgd2Ugd2FudCB0byB1cGRhdGUgbW9kZWwgZnJvbSB0aGUgdmlldyB2YWx1ZQoJCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCB1cGRhdGVFdmVudCArICIgcmVzZXRWYWwiLCAiKnVwZGF0ZU1vZGVsVmFsdWUiLCBhZGFwdGVyTmFtZSApOwoKCQkJfQoJCX0KCX0gKTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanMsIHRlbXBsYXRlLmpzPC9AZGVwZW5kcz4KCgoJZGVmYXVsdE9wdGlvbnMuY29uZmlybU1lc3NhZ2UgPSAiQXJlIHlvdSBzdXJlPyI7CgoJZnVuY3Rpb24gYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggZmVhdHVyZXMgKSB7CgkJZm9yICh2YXIgbmFtZSBpbiBmZWF0dXJlcykgewoJCQl2YXIgaXRlbSA9IGZlYXR1cmVzW25hbWVdOwoJCQliaW5kaW5ncyggbmFtZSwgaXRlbVswXSApOwoJCQlobS53b3JrZmxvdyggbmFtZSwgaXRlbVsxXSApOwoJCX0KCX0KCglobS5hY3Rpdml0eS5nZXQuY29tcGFyZVRydXRoeSA9IGZ1bmN0aW9uKCBlICkgewoJCXZhciBleHByZXNzaW9uID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoJCXJldHVybiBpc1VuZGVmaW5lZCggZXhwcmVzc2lvbiApID8KCQkJIXB1Ymxpc2hlci5pc0VtcHR5KCkgOgoJCQlwdWJsaXNoZXIuY29tcGFyZSggZXhwcmVzc2lvbiApOwoJfTsKCglobS5hY3Rpdml0eS5pbml0aWFsaXplLmV4dHJhY3RDbGFzcyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCXZhciBwYXJ0cyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCXdvcmtmbG93LmNsYXNzTmFtZSA9IHBhcnRzWzBdOwoJCXdvcmtmbG93Lm9wdGlvbnMgPSBwYXJ0c1sxXTsKCX07CgoJYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggewoKCQkvLy0tLS0tLS0tY2hhbmdpbmcgdmlldy0tLS0tLS0tLS0KCQlvcHRpb25zOiBbCgkJCSIhaW5pdCBhZnRlcio6Lnwqb3B0aW9ucyIsCgkJCS8vYWRkIG1vZGVsIHdvcmtmbG93cwoJCQkvL3JlbmRlciA8c2VsZWN0PiBvcHRpb25zCgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGgiPgoJCQkvLzxzZWxlY3Qgb3B0aW9ucz0ibW9kZWxQYXRofHByb3BlcnR5TmFtZSI+CgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGh8dGV4dENvbHVtbix2YWxDb2x1bW4iPgoJCQl7CgkJCQkvL3RoaXMgaXMgYWN0dWFsbHkgdGhlIGV4ZWN1dGUgZnVuY3Rpb24sIGluIHRoaXMgd29ya2Zsb3cKCQkJCS8vdGhlcmUgaXMgbm8gc2V0LCB0aGUgY29udGVudCBvZiB0aGUgdmlldyBpcyByZW5kZXIKCQkJCS8vaW4gdGhlIGdldCBmdW5jdGlvbi4KCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG9wdGlvbnMgPSBlLmhhbmRsZXIub3B0aW9ucywKCQkJCQkJc3Vic2NyaWJlciA9IHRoaXMsCgkJCQkJCXZhbHVlID0gc3Vic2NyaWJlci52YWwoKTsKCgkJCQkJc3Vic2NyaWJlci5jaGlsZHJlbiggIm9wdGlvbltsaXN0SXRlbV0iICkKCQkJCQkJLnJlbW92ZSgpLmVuZCgpLmFwcGVuZCgKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgaHRtbCA9ICIiOwoJCQkJCQkJJCggZS5wdWJsaXNoZXIuZ2V0KCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCQlodG1sICs9ICI8b3B0aW9uIGxpc3RJdGVtPScxJyB2YWx1ZT0nIiArIG9wdGlvbnMudmFsdWUoIHRoaXMgKSArICInPiIgKyBvcHRpb25zLm5hbWUoIHRoaXMgKSArICI8L29wdGlvbj4iOwoJCQkJCQkJfSApOwoJCQkJCQkJcmV0dXJuIGh0bWw7CgkJCQkJCX0gKS52YWwoIHZhbHVlICk7CgoJCQkJCWlmIChzdWJzY3JpYmVyLnZhbCgpICE9PSB2YWx1ZSkgewoJCQkJCQkkKCBzdWJzY3JpYmVyLnRyaWdnZXIoICJjaGFuZ2UiICkgKTsKCQkJCQl9CgkJCQl9LAoKCQkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCQkJCWlmIChvcHRpb25zKSB7CgoJCQkJCQl2YXIgcGFydHMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKSwKCQkJCQkJCXRleHRDb2x1bW4gPSBwYXJ0c1swXSwKCQkJCQkJCXZhbHVlQ29sdW1uID0gcGFydHNbMV0gfHwgcGFydHNbMF07CgoJCQkJCQl3b3JrZmxvdy5vcHRpb25zID0gewoJCQkJCQkJbmFtZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCQkJCQkJcmV0dXJuIGl0ZW1bdGV4dENvbHVtbl07CgkJCQkJCQl9LAoJCQkJCQkJdmFsdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQkJCQkJCXJldHVybiBpdGVtW3ZhbHVlQ29sdW1uXTsKCQkJCQkJCX0KCQkJCQkJfTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXdvcmtmbG93Lm9wdGlvbnMgPSB7CgkJCQkJCQluYW1lOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfSwKCQkJCQkJCXZhbHVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCXNob3c6IFsKCgkJCS8vZGF0YS1zdWI9ImBzaG93OnBhdGgiCgkJCSIhaW5pdCBhZnRlcio6Lnwqc2hvdyIsCgoJCQl7CgoJCQkJZ2V0OiAiKmNvbXBhcmVUcnV0aHkiLAoKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1t0cnV0aHkgPyAic2hvdyIgOiAiaGlkZSJdKCk7CgoJCQkJfQoJCQl9CgoJCV0sCgoJCWhpZGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqaGlkZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJLy91c2Ugc3Vic2NyaXB0aW9uIGdyb3VwIGluc3RlYWQKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1sgdHJ1dGh5ID8gImhpZGUiIDogInNob3ciXSgpOwoJCQkJfQoJCQl9CgkJXSwKCgkJZW5hYmxlOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmVuYWJsZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5ICkgewoKCQkJCQl0aGlzLmF0dHIoICJkaXNhYmxlZCIsICF0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWRpc2FibGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqZGlzYWJsZSIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHkgKSB7CgkJCQkJdGhpcy5hdHRyKCAiZGlzYWJsZWQiLCB0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWFkZENsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmFkZENsYXNzIiwKCQkJewoKCQkJCWluaXRpYWxpemU6ICIqZXh0cmFjdENsYXNzIiwKCgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5LCBlICkgewoKCQkJCQl0aGlzW3RydXRoeSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSggZS5oYW5kbGVyLmNsYXNzTmFtZSApOwoJCQkJfQoJCQl9CgkJXSwKCgkJcmVtb3ZlQ2xhc3M6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqcmVtb3ZlQ2xhc3MiLCB7CgoJCQkJaW5pdGlhbGl6ZTogIipleHRyYWN0Q2xhc3MiLAoKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCXRoaXNbdHJ1dGh5ID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKCBlLmhhbmRsZXIuY2xhc3NOYW1lICk7CgoJCQkJfQoJCQl9CgkJXSwKCiAgICAgICAgLy90aGUgY2xhc3MgbmFtZSBjYW4gYmUgcGFzc2VkIGFzIG9wdGlvbnMgcGFyYW1ldGVyCiAgICAgICAgLy9vciB0aGUgY2xhc3MgbmFtZSBpcyB0aGUgdmFsdWUgb2YgdGhlIG1vZGVsCiAgICAgICAgLy8KICAgICAgICAvL3RvZ2dsZS1jbGFzcz0ibW9kZWwiCiAgICAgICAgLy9vcgogICAgICAgIC8vPHAgIWFmdGVyVXBkYXRlPSJpc0hhcHB5fCpmYWtlR2V0IHRvZ2dsZUNsYXNzKmhhcHB5IiA+PC9wPgoJCXRvZ2dsZUNsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KnRvZ2dsZUNsYXNzIiwgewoKCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG1ldGhvZCwKCQkJCQkJcmV2ZXJzZSwKCQkJCQkJdmFsdWUgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCQkJY2xhc3NOYW1lID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQkJCWlmIChjbGFzc05hbWUpIHsKCQkJCQkJaWYgKGNsYXNzTmFtZS5zdGFydHNXaXRoKCAiISIgKSkgewoJCQkJCQkJcmV2ZXJzZSA9IHRydWU7CgkJCQkJCQljbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKCAxICk7CgkJCQkJCX0KCgkJCQkJCW1ldGhvZCA9IHZhbHVlIF4gcmV2ZXJzZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiOwoJCQkJCX0KCgkJCQkJaWYgKGUudHlwZSA9PSAiaW5pdCIpIHsKCgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLmFkZENsYXNzKCB2YWx1ZSApOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLnJlbW92ZUNsYXNzKCBlLnJlbW92ZWQgKS5hZGRDbGFzcyggdmFsdWUgKTsKCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQldLAoKCQkvL2ZvY3VzOippc0VkaXRNb2RlCgkJLy9mb2N1cyBvbiBhIHZpZXcgaWYgbW9kZWwgaXMgbm90IGVtcHR5CgkJZm9jdXM6IFsKCQkJIiFpbml0IGFmdGVyKjoufCpmb2N1cyIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCWlmICh0cnV0aHkpIHsKCQkJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXN1YnNjcmliZXIuZm9jdXMoKS5zZWxlY3QoKTsKCQkJCQkJfSwgMSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCWNvdW50OiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmNvdW50IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHZhbHVlID0gZS5wdWJsaXNoZXIuZ2V0KCksCgkJCQkJY291bnQgPSAoICJsZW5ndGgiIGluIHZhbHVlKSA/IHZhbHVlLmxlbmd0aCA6IHZhbHVlOwoKCQkJCXRoaXMudGV4dCggY291bnQgKTsKCQkJfQoJCV0sCgoJCWR1bXA6IFsKCgkJCSIhaW5pdCAqOi58KmR1bXAiLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIWUudHlwZS5zdGFydHNXaXRoKCAiYmVmb3JlIiApKSB7CgkJCQkJdGhpcy5odG1sKCAiPHNwYW4gc3R5bGU9J2NvbG9yOnJlZCc+IiArIGUucHVibGlzaGVyLnBhdGggKyAiIDogIiArIGUucHVibGlzaGVyLnRvSlNPTigpICsgIjwvc3Bhbj4iICk7CgkJCQl9CgkJCX0KCQldLAoKCQkvL2FsZXJ0OnBhdGggLy90aGlzIHdpbGwgYWxlcnQgdGhlIGRhdGEgaW4gbW9kZWwKCQkvL2FsZXJ0Ol98aGVsbG8gd29ybGQgLy90aGlzIHdpbGwgYWxlcnQgImhlbGxvIHdvcmxkIgoJCWFsZXJ0OiBbCgoJCQkiJGNsaWNrOi58KmFsZXJ0IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJYWxlcnQoIGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8gdGhpcy5nZXQoKSA6IGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCgkJXSwKCgkJbG9nOiBbCgoJCQkiJGNsaWNrOi58KmxvZyIsCgoJCQlmdW5jdGlvbiAoZSkgewoJCQkJaG0ubG9nKCBpc1VuZGVmaW5lZCggZS5oYW5kbGVyLm9wdGlvbnMgKSA/IHRoaXMuZ2V0KCkgOiBlLmhhbmRsZXIub3B0aW9ucyApOwoJCQl9CgkJXSwKCQlwcmV2ZW50RGVmYXVsdDogWwoKCQkJIiRjbGljazpffCpwcmV2ZW50RGVmYXVsdCIsCgoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCV0sCgoJCXN0b3BQcm9wYWdhdGlvbjogWwoKCQkJIiRjbGljazpffCpzdG9wUHJvcGFnYXRpb24iLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJXSwKCgkJLy9jb25maXJtOl8KCQkvL2NvbmZpcm06cGF0aAoJCS8vY29uZmlybTpffHlvdXIgbWVzc2FnZQoJCWNvbmZpcm06IFsKCgkJCS8vcmVwbGFjaW5nICIkY2xpY2s6LnwqY29uZmlybSIsIHdpdGggZHluYW1pYyBiaW5kaW5nLAoJCQkvL3NvIHRoYXQgaXQgY2FuIGJlIGZpeCB0aGUgcHJvYmxlbSBjYXVzZWQgYnkgbWFwRXZlbnQKCQkJLy9hcyBsb25nIGFzIGl0IGlzIHBsYWNlZCBiZWZvcmUgbWFwRXZlbnQgZHluYW1pYyBiaW5kaW5nCgkJCWZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBvcHRpb25zICkgewoJCQkJaG0uc3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNvbmZpcm0iLCBvcHRpb25zICk7CgkJCX0sCgoJCQlmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbWVzc2FnZSA9IGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8KCQkJCQl0aGlzICYmIHRoaXMucGF0aCAmJiB0aGlzLmdldCAmJiB0aGlzLmdldCgpIHx8IGRlZmF1bHRPcHRpb25zLmNvbmZpcm1NZXNzYWdlIDoKCQkJCQllLmhhbmRsZXIub3B0aW9uczsKCgkJCQlpZiAoIWNvbmZpcm0oIG1lc3NhZ2UgKSkgewoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQldLAoKCQkvLy8tLS0tLS1jaGFuZ2luZyBtb2RlbC0tLS0tLS0tLS0tLQoJCXNldFRvOiBbCgkJCSIkY2xpY2s6Lnwqc2V0VG8iLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvd0luc3RhbmNlLCBvcHRpb25zICkgewoJCQkJCXdvcmtmbG93SW5zdGFuY2Uuc2V0VG8gPSB0b1R5cGVkVmFsdWUoIG9wdGlvbnMgKTsKCQkJCX0sCgkJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJCXRoaXMuc2V0KCBlLmhhbmRsZXIuc2V0VG8gKTsKCQkJCX0KCQkJfQoJCV0sCgoJCSIwIjogWwoJCQkiJGNsaWNrOi58KjAiLAoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggMCApOwoJCQl9CgkJXSwKCgkJZW1wdHlTdHJpbmc6IFsKCQkJIiRjbGljazoufCplbXB0eSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCAiIiApOwoJCQl9CgkJXSwKCgkJIm51bGwiOiBbCgkJCSIkY2xpY2s6LnwqbnVsbCIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggbnVsbCApOwoJCQl9CgkJXSwKCgkJInRydWUiOiBbCgoJCQkiJGNsaWNrOi58KnRydWUiLAoKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIHRydWUgKTsKCQkJfQoJCV0sCgoJCSIrKyI6IFsKCQkJIiRjbGljazoufCorKyIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggdGhpcy5nZXQoKSArIDEgKTsKCQkJfQoJCV0sCgoJCSItLSI6IFsKCQkJIiRjbGljazoufCotLSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCB0aGlzLmdldCgpIC0gMSApOwoJCQl9CgkJXSwKCgkJImZhbHNlIjogWwoJCQkiJGNsaWNrOi58KmZhbHNlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIGZhbHNlICk7CgkJCX0KCQldLAoKCQl0b2dnbGU6IFsKCgkJCSIkY2xpY2s6LnwqdG9nZ2xlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJc3Vic2NyaWJlci5zZXQoICFzdWJzY3JpYmVyLmdldCgpICk7CgkJCX0KCQldLAoKCQlzb3J0SXRlbXM6IFsKCQkJIiRjbGljazoufCpzb3J0SXRlbXMiLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgb3B0aW9ucyApIHsKCQkJCQlvcHRpb25zID0gKG9wdGlvbnMgfHwgIiIpICYmIG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkJCXdvcmtmbG93LmJ5ID0gb3B0aW9uc1swXTsKCQkJCQkvL2JlY2F1c2Ugb3B0aW9uc1sxXSBkZWZhdWx0IGlzIHVuZGVmaW5lZAoJCQkJCS8vc28gYXNjIGlzIGJ5IGRlZmF1bHQKCQkJCQl3b3JrZmxvdy5hc2MgPSAhIW9wdGlvbnNbMV07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgkJCQkJdGhpcy5zb3J0KCB3b3JrZmxvdy5ieSwgd29ya2Zsb3cuYXNjICk7CgkJCQkJd29ya2Zsb3cuYXNjID0gIXdvcmtmbG93LmFzYzsKCQkJCX0KCQkJfQoJCV0sCgoJCWNsZWFyOiBbCgoJCQkiJGNsaWNrOi58KmNsZWFyIiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuY2xlYXIoKTsKCQkJfQoJCV0sCgoJCWRlbDogWwoJCQkiJGNsaWNrOi58KmRlbDtjb25maXJtOl98X0RvIHlvdSB3YW50IHRvIGRlbGV0ZSB0aGlzIGl0ZW0/IiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuZGVsKCk7CgkJCX0KCQldCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJY2FwdGlvbjogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQkkKCBlbGVtICkucHJlcGVuZCggIjxvcHRpb24gdmFsdWU9Jyc+IiArIChvcHRpb25zIHx8IGhtLmdldCggcGF0aCApIHx8ICIiKSArICI8L29wdGlvbj4iICk7CgkJfSwKCgkJYXV0b2ZvY3VzOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJfSwgMSApOwoJCX0sCgoJCW1hcEV2ZW50OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkkKCBlbGVtICkubWFwRXZlbnQoIG9wdGlvbnNbMF0sIG9wdGlvbnNbMV0sIG9wdGlvbnNbMl0gKTsKCgkJfSwKCgkJbWFwQ2xpY2s6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgb3B0aW9uc1swXSwgb3B0aW9uc1sxXSApOwoJCX0sCgoJCWxvZ1BhbmVsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCSQoIGVsZW0gKS5jc3MoICJsaXN0LXN0eWxlLXR5cGUiLCAiZGVjaW1hbCIgKS5jc3MoICJmb250LWZhbWlseSIsICJtb25vc3BhY2UsIHNlcmlmIiApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImluaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBhbGxMb2dzID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFsbExvZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLmFwcGVuZCggIjxsaT4iICsgYWxsTG9nc1tpXSArICI8L2xpPiIgKTsKCQkJCX0KCQkJfSApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImFmdGVyQ3JlYXRlLjEiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuYXBwZW5kKCAiPGxpPiIgKyBlLm9yaWdpbmFsUHVibGlzaGVyLnJhdygpICsgIjwvbGk+IiApOwoJCQl9ICk7CgoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgIipsb2ciLCAiYWZ0ZXJDcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuZW1wdHkoKTsKCQkJfSApOwoJCX0sCgoJCWNsZWFybG9nOiAiY2xlYXI6Lypsb2ciLAoKCQkvL2RhdGEtc3ViPSJlbmFibGVMYXRlcjpwYXRoIgoJCWVuYWJsZUxhdGVyOiAiIWFmdGVyKjoufCplbmFibGUiLAoKCQkvL2RhdGEtc3ViPSJkaXNhYmxlTGF0ZXI6cGF0aCIKCQlkaXNhYmxlTGF0ZXI6ICIhYWZ0ZXIqOi58KmRpc2FibGUiLAoKCQkvL2RhdGEtc3ViPSJodG1sOnBhdGgiCgkJaHRtbDogIiFpbml0IGFmdGVyKjoufGdldCBodG1sICp0b1N0cmluZyIsCgoJCS8vZGF0YS1zdWI9InRleHQ6cGF0aCIKCQl0ZXh0OiAiIWluaXQgYWZ0ZXIqOi58Z2V0IHRleHQgKnRvU3RyaW5nIiwKCgkJcmVtb3ZlSWZEZWw6ICIhZHVyaW5nRGVsOi58KmZha2VHZXQgcmVtb3ZlIiwKCgkJZW1wdHlJZkRlbDogIiFkdXJpbmdEZWw6LnwqZmFrZUdldCBlbXB0eSIKCgl9ICk7CgoJaG0ubmV3SnFFdmVudCggewoKCQllbnRlcjogWyJrZXl1cCIsIGZ1bmN0aW9uKCBlICkgewoJCQlyZXR1cm4gKGUua2V5Q29kZSA9PT0gMTMpOwoJCX1dLAoKCQllc2M6IFsia2V5dXAiLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuIChlLmtleUNvZGUgPT09IDI3KTsKCQl9XSwKCgkJY3RybGNsaWNrOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiBlLmN0cmxLZXk7CgkJfV0KCX0gKTsKCgoKLy8KLyoKIDxAZGVwZW5kcz4KIHN1YnNjcmlwdGlvbi5qcywKIG1vZGVsLmpzCiA8L0BkZXBlbmRzPgogKi8KCgoJdmFyIG1ldGhvZE1hcCA9IHsKCQkiY3JlYXRlIjogIlBPU1QiLAoJCSJ1cGRhdGUiOiAiUFVUIiwKCQkiZGVzdHJveSI6ICJERUxFVEUiLAoJCSJmZXRjaCI6ICJHRVQiCgl9OwoKCXZhciBlbnRpdHlTdGF0ZSA9IHsKCQlkZXRhY2hlZDogMCwKCQl1bmNoYW5nZWQ6IDEsCgkJYWRkZWQ6IDMsCgkJZGVsZXRlZDogNCwKCQltb2RpZmllZDogNQoJfTsKCglmdW5jdGlvbiBtYXJrTW9kaWZpZWQgKCBlICkgewoKCQl2YXIgYmFzZVBhdGggPSB0aGlzLnBhdGg7IC8vaXRlbXMKCQl2YXIgb3JpZ2luYWxQYXRoID0gZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOyAvL2l0ZW1zLjEuZmlyc3ROYW1lCgkJdmFyIGRpZmZQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0ciggYmFzZVBhdGgubGVuZ3RoICsgMSApOyAvLzEuZmlyc3ROYW1lCgkJdmFyIGRvdEluZGV4ID0gZGlmZlBhdGguaW5kZXhPZiggIi4iICk7CgkJdmFyIGVudGl0eVBhdGggPSBiYXNlUGF0aCArICIuIiArIGRpZmZQYXRoLnN1YnN0ciggMCwgZG90SW5kZXggKTsgLy9pdGVtcy4xCgkJdmFyIHN0YXRlUGF0aCA9IGVudGl0eVBhdGggKyAiLl9fc3RhdGUiOyAvL2l0ZW1zLjEuX19zdGF0ZQoKCQlpZiAob3JpZ2luYWxQYXRoICE9PSBzdGF0ZVBhdGggJiYKCQkgICAgaG0uZ2V0KCBzdGF0ZVBhdGggKSA9PSBlbnRpdHlTdGF0ZS51bmNoYW5nZWQpIHsKCQkJLy91c2Ugc2V0IG1ldGhvZCBpcyBkZWxpYmVyYXRlLCBiZWNhdXNlIHdlIHdhbnQKCQkJLy90byByYWlzZSBldmVudAoJCQlobS5zZXQoIHN0YXRlUGF0aCwgZW50aXR5U3RhdGUubW9kaWZpZWQgKTsKCQl9Cgl9CgoJaG0ub25BZGRPclVwZGF0ZU5vZGUoIGZ1bmN0aW9uKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgkJaWYgKHZhbHVlIGluc3RhbmNlb2YgaG0uRW50aXR5KSB7CgoJCQlpZiAodmFsdWUuX19zdGF0ZSA9PT0gZW50aXR5U3RhdGUuZGV0YWNoZWQpIHsKCQkJCXZhbHVlLl9fc3RhdGUgPSBlbnRpdHlTdGF0ZS5hZGRlZDsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBobSggY29udGV4dCApLmdldCggIl9fZW50aXR5Q29udGFpbmVyIiApICkpIHsKCQkJCWhtLnN1YiggY29udGV4dCwgY29udGV4dCwgImFmdGVyVXBkYXRlLioiLCBtYXJrTW9kaWZpZWQgKTsKCQkJCWhtKCBjb250ZXh0ICkuc2V0KCAiX19lbnRpdHlDb250YWluZXIiLCB0cnVlICk7CgkJCX0KCQl9Cgl9ICk7CgoJZnVuY3Rpb24gY2FsbFN0YXRpY0FqYXhNZXRob2QgKCBub2RlLCBtZXRob2ROYW1lICkgewoJCXZhciBlbnRpdHkgPSBub2RlLmdldCgpOwoKCQlyZXR1cm4gZW50aXR5LmNvbnN0cnVjdG9yW21ldGhvZE5hbWVdKCBlbnRpdHkgKS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCgkJCW5vZGUuc2V0KAoKCQkJCSJfX3N0YXRlIiwKCgkJCQltZXRob2ROYW1lID09ICJkZXN0cm95IiA/CgkJCQkJZW50aXR5U3RhdGUuZGV0YWNoZWQgOgoJCQkJCWVudGl0eVN0YXRlLnVuY2hhbmdlZAoJCQkpOwoKCQkJbm9kZS50cmlnZ2VyKCAiYWZ0ZXJTeW5jLiIgKyBtZXRob2ROYW1lICk7CgkJfSApOwoJfQoKCS8vdGhlIHJlYXNvbiB0aGF0IHdlIGRvbid0IGltcGxlbWVudCBhamF4IGluIHRoZSBpbnN0YW5jZSBtZXRob2QgaXMgdGhhdCwgd2Ugd2FudCB0bwoJLy9zdXBwb3J0IHRoZSBjYWxsIGZyb20gcmVwb3NpdG9yeSBub2RlLCBzdWNoIG5vZGUuc2V0KCJjcmVhdGUiKSwgbm9kZS5zZXQoInVwZGF0ZSIpLi4KCS8vd2Ugd2FudCB0byBkZWxlZ2F0ZSB0aGlzIGNhbGwgdGhlIHN0YXRpYyBtZXRob2QKCWhtLkVudGl0eSA9IGhtLkNsYXNzLmV4dGVuZCgKCQkvL2luc3RhbmNlIG1ldGhvZCwgd2hpY2ggaXMgaW52b2tlZCBieSBub2RlLmdldCBtZXRob2QKCQkvL29yIGl0IGNhbiBiZSBpbnZva2VkIHRoZSBvYmplY3QgZGlyZWN0bHkKCQl7CgkJCS8vdGhpcyBzdGF0ZSBpcyBtZWFuaW5nZnVsIG9ubHkgd2hlbiBpdCBlbnRpdHkgaXMgaW5zaWRlIG9mIHJlcG9zaXRvcnkKCQkJX19zdGF0ZTogZW50aXR5U3RhdGUuZGV0YWNoZWQsCgoJCQljcmVhdGU6IGZ1bmN0aW9uIF9fICgpIHsKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgImNyZWF0ZSIgKTsKCQkJCQl9CgkJCQkJdGhyb3cgImVudGl0eSBpcyBub3QgYSBuZXcgaXRlbSI7CgoJCQkJfSBlbHNlIHsKCQkJCQkvLyBkb24ndCB1c2UgRW50aXR5LmNyZWF0ZSh0aGlzKSwgYmVjYXVzZQoJCQkJCS8vIHRoaXMuY29uc3RydWN0b3IgaXMgbm90IG5lY2Vzc2FyeSBFbnRpdHkKCQkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5jcmVhdGUoIHRoaXMgKTsKCgkJCQl9CgkJCX0sCgoJCQlmZXRjaDogZnVuY3Rpb24gX18gKCkgewoJCQkJcmV0dXJuIHRoaXMgaW5zdGFuY2VvZiBobSA/IGNhbGxTdGF0aWNBamF4TWV0aG9kKCB0aGlzLCAiZmV0Y2giICkgOgoJCQkJCXRoaXMuY29uc3RydWN0b3IuZmV0Y2goIHRoaXMgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24gX18gKCkgewoKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLm1vZGlmaWVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgInVwZGF0ZSIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnVwZGF0ZSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoJCQkJCXZhciBub2RlID0gdGhpczsKCQkJCQlyZXR1cm4gY2FsbFN0YXRpY0FqYXhNZXRob2QoIHRoaXMsICJkZXN0cm95IiApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlub2RlLmRlbCgpOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZGVzdHJveSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJc2F2ZTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLmdldCggIl9fc3RhdGUiICk7CgkJCQkJaWYgKHN0YXRlID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJjcmVhdGUiICk7CgoJCQkJCX0gZWxzZSBpZiAoc3RhdGUgPT0gZW50aXR5U3RhdGUubW9kaWZpZWQpIHsKCgkJCQkJCXJldHVybiB0aGlzLmdldCggInVwZGF0ZSIgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhyb3cgIm5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJfQoKCQl9LAoKCQkvL3N0YXRpYyBtZXRob2QsIHdoaWNoIGtub3dzIG5vdGhpbmcgYWJvdXQgcmVwb3NpdG9yeQoJCXsKCQkJc3RhdGU6IGVudGl0eVN0YXRlLAoKCQkJY3JlYXRlOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlyZXR1cm4gdGhpcy5hamF4KCAiY3JlYXRlIiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24oIGluc3RhbmNlICkgewoJCQkJcmV0dXJuIHRoaXMuYWpheCggInVwZGF0ZSIsIGluc3RhbmNlICk7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCBpbnN0YW5jZSApIHsKCQkJCXJldHVybiB0aGlzLmFqYXgoICJkZXN0cm95IiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCWZldGNoOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlpZiAoaW5zdGFuY2UpIHsKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giLCBpbnN0YW5jZSApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoJCQkJCS8vdGhlIHBpcGUgbWV0aG9kIGlzIHVzZWQgdG8gY29udmVydCBhbiBhcnJheSBvZgoJCQkJCS8vIGdlbmVyaWMgb2JqZWN0IGludG8gYW4gYXJyYXkgb2Ygb2JqZWN0IG9mIHRoZSBzYW1lICJDbGFzcyIKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giICkucGlwZSggZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQkJCXJldHVybiAkKCBDb25zdHJ1Y3Rvci5saXN0KCBkYXRhICkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdGhpcy5fX3N0YXRlID0gZW50aXR5U3RhdGUudW5jaGFuZ2VkOwoJCQkJCQl9ICkuZ2V0KCk7CgkJCQkJfSApOwoKCQkJCX0KCQkJfSwKCgkJCWdldFVybDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIGJhc2VVcmwgPSB0aGlzLnVybCB8fCBpbnN0YW5jZS51cmwsCgkJCQkJaWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5pZDsKCgkJCQlyZXR1cm4gaWQgPyBiYXNlVXJsICsgKGJhc2VVcmwuY2hhckF0KCBiYXNlVXJsLmxlbmd0aCAtIDEgKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KCBpZCApIDoKCQkJCQliYXNlVXJsOwoJCQl9LAoKCQkJYWpheDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIG1ldGhvZCA9IG1ldGhvZE1hcFttZXRob2ROYW1lXTsKCgkJCQl2YXIgYWpheE9wdGlvbnMgPSB7CgkJCQkJdHlwZTogbWV0aG9kLAoJCQkJCWRhdGFUeXBlOiAnanNvbicsCgkJCQkJdXJsOiB0aGlzLmdldFVybCggbWV0aG9kTmFtZSwgaW5zdGFuY2UgKSwKCQkJCQljb250ZW50VHlwZTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6ICJhcHBsaWNhdGlvbi9qc29uIiwKCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJZGF0YTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6IEpTT04uc3RyaW5naWZ5KCBpbnN0YW5jZSApCgkJCQl9OwoKCQkJCXJldHVybiAkLmFqYXgoIGFqYXhPcHRpb25zICkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCWluc3RhbmNlICYmIGV4dGVuZCggaW5zdGFuY2UsIHJlc3BvbnNlICk7CgkJCQl9ICk7CgkJCX0KCQl9ICk7CgoJZXh0ZW5kKCBobUZuLCB7CgoJCS8vbm9kZSBmdW5jdGlvbiB3aGljaCBicmlkZ2V0IHRoZSBobSBtZXRob2QgdG8gdGhlIHN0YXRpYyBtZXRob2Qgb2YgbW9kZWwKCQkvL3N1YlBhdGggaXMgb3B0aW9uYWwKCQkvL21ldGhvZCBpcyByZXF1aXJlZCBjcmVhdGUvcmVhZC91cGRhdGUvZGVsCgkJLy9lLmcgbm9kZS5zeW5jKCJjcmVhdGUiKTsKCQlzYXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAic2F2ZSIgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAiZGVzdHJveSIgKTsKCQl9LAoKCQlmZXRjaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldCggImZldGNoIiApOwoJCX0KCX0gKTsKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+CgoKCWRlZmF1bHRPcHRpb25zLmVycm9ycyA9IHsKCQlkZWZhdWx0RXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCB2YWx1ZSIKCX07CgoJdmFyIGFmdGVyVXBkYXRlQW5kQ2hlY2tWYWxpZGl0eSA9ICJhZnRlclVwZGF0ZSogY2hlY2tWYWxpZGl0eSIsCgkJaW52YWxpZFBhdGhzID0gc2hhZG93Um9vdC5pbnZhbGlkUGF0aHMgPSBbXSwKCQlpbnZhbGlkUGF0aHNNb2RlbCA9IGhtKCAiKmludmFsaWRQYXRocyIgKSwKCQlyRW1wdHkgPSAvXlxzKiQvLAoJCXJFbWFpbCA9IC9eKCgoW2Etel18XGR8WyEjXCQlJidcKlwrXC1cLz1cP1xeX2B7XHx9fl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKyhcLihbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKSopfCgoXHgyMikoKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPygoW1x4MDEtXHgwOFx4MGJceDBjXHgwZS1ceDFmXHg3Zl18XHgyMXxbXHgyMy1ceDViXXxbXHg1ZC1ceDdlXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KFxcKFtceDAxLVx4MDlceDBiXHgwY1x4MGQtXHg3Zl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkpKigoKFx4MjB8XHgwOSkqKFx4MGRceDBhKSk/KFx4MjB8XHgwOSkrKT8oXHgyMikpKUAoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/JC9pLAoJCXJVcmwgPSAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pLAoJCXJEYXRlSVNPID0gL15cZHs0fVtcL1wtXVxkezEsMn1bXC9cLV1cZHsxLDJ9JC8sCgkJck51bWJlciA9IC9eLT8oPzpcZCt8XGR7MSwzfSg/OixcZHszfSkrKSg/OlwuXGQrKT8kLywKCQlyRGlnaXQgPSAvXlxkKyQvLAoJCXJJbnZhbGlkRGF0ZSA9IC9JbnZhbGlkfE5hTi8sCgkJclJlZ0V4ID0gL14oXC8oXFxbXlx4MDAtXHgxZl18XFsoXFxbXlx4MDAtXHgxZl18W15ceDAwLVx4MWZcXFwvXSkqXF18W15ceDAwLVx4MWZcXFwvXFtdKStcL1tnaW1dKikoLCguKikpKiQvLAoJCXJGaXJzdFRva2VuID0gLyhbXixdKykoLCguKikpPy8sCgkJckZpcnN0VHdvVG9rZW4gPSAvKFx3KyksKFx3KykoLCguKikpPy87CgoJLyoJdGhpcyBtZXRob2QgaXMgdG8gY3JlYXRlIGEgc3Vic2NyaXB0aW9uIGdyb3VwIGFuZAoJIHdvcmtmbG93IHR5cGUgdXNpbmcgdGhlIG5hbWUgb2YgdmFsaWRhdG9yCgkgYW5kIGFsc28gYWRkIGEgY2xhc3MgcnVsZSB1c2luZyB0aGUgbmFtZSBvZiB2YWxpZGF0b3IKCSBzbyBtYWtlIHN1cmUgdGhlIG5hbWUgb2YgdmFsaWRhdG9yIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgdmFsaWRhdG9yCgoJIGEgdmFsaWRhdG9yIGlzIG9iamVjdCBsaWtlCgkgewoJIG5hbWU6ICJ2YWxpZGF0b3JOYW1lIiwKCSBlcnJvcjogImVycm9yIG1lc3NhZ2UiCgkgaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICk7IC8vIG9wdGlvbnMgbGV0IHVzZXIgdG8gaGVscCB0aGUgaXNWYWxpZCB0byB3b3JrIGJldHRlcgoJIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpOyAvL2FsbG93IHVzZXIgY29udmVydCBzdHJpbmcgdmFsdWUgb2YgbW9kZWxFdmVudC5vcHRpb25zIHRvIHRoZSBvcHRpb25zIHBhc3NlZCBpbiBpc1ZhbGlkIGZ1bmN0aW9uCgkgYnVpbGRFcnJvcjogZnVuY3Rpb24oZGVmYXVsdE1lc3NhZ2UsIG9wdGlvbnMgKQoJIH0KCSAqLwoJaG0udmFsaWRhdG9yID0gZnVuY3Rpb24oIHZhbGlkYXRvciApIHsKCgkJaWYgKGlzQXJyYXkoIHZhbGlkYXRvciApKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgkJCQlobS52YWxpZGF0b3IoIHZhbGlkYXRvcltpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHZhbGlkYXRvck5hbWUgPSB2YWxpZGF0b3IubmFtZTsKCgkJaWYgKGhtLndvcmtmbG93KCB2YWxpZGF0b3JOYW1lICkpIHsKCQkJdGhyb3cgInZhbGlkYXRvciBuYW1lICciICsgdmFsaWRhdG9yTmFtZSArICInIGNvbGxpZGUgd2l0aCBuYW1lIGluIGhtLndvcmtmbG93VHlwZXMiOwoJCX0KCgkJLy9hZGQgZGVmYXVsdCBlcnJvciBpZiBhcHBsaWNhYmxlCgkJLy91c2VyIGNhbiBsb2NhbGl6ZSBlcnJvcnMgbWVzc2FnZQoJCWlmICh2YWxpZGF0b3IuZXJyb3IpIHsKCQkJZGVmYXVsdE9wdGlvbnMuZXJyb3JzW3ZhbGlkYXRvck5hbWVdID0gdmFsaWRhdG9yLmVycm9yOwoJCX0KCgkJaWYgKHZhbGlkYXRvci5pc1ZhbGlkIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCXZhbGlkYXRvci5pc1ZhbGlkID0gYnVpbGRSZWdleEZuKCB2YWxpZGF0b3IuaXNWYWxpZCApOwoJCX0KCgkJdmFyIHdvcmtmbG93VHlwZU5hbWUgPSAidl8iICsgdmFsaWRhdG9yTmFtZTsKCQlobS53b3JrZmxvdyggd29ya2Zsb3dUeXBlTmFtZSwgYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSApOwoKCQkvL2RhdGEtc3ViPSJyZXF1aXJlZDpwYXRoIiBvciBkYXRhLXN1Yj0icmVxdWlyZWQ6cGF0aHxvcHRpb25zIgoJCWJpbmRpbmdzKCB2YWxpZGF0b3JOYW1lLCAiIWFmdGVyVXBkYXRlIGNoZWNrVmFsaWRpdHk6LnwqIiArIHdvcmtmbG93VHlwZU5hbWUgKTsKCgl9OwoKCWhtLndvcmtmbG93KCB7CgkJY2hlY2tWYWxpZGl0eTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICghaG0uY2hlY2tWYWxpZGl0eSggdGhpcy5wYXRoICkpIHsKCQkJCS8vYmVjYXVzZSBpdCBpcyB0aGUgZmlyc3QgaGFuZGxlciwgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gd2lsbAoJCQkJLy9zdG9wIHByb2Nlc3MgYWxsIG90aGVyIGhhbmRsZXIKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoKCQkvLyB1c2UgYnkgZ3JvdXAKCQkvLyB3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCQl3YXJuOiBmdW5jdGlvbiggZSApIHsKCQkJLy9lLnB1Ymxpc2hlciBwb2ludHMgdG8gIm1vZGVsKmVycm9ycyIKCQkJaWYgKGUucHVibGlzaGVyLmlzRW1wdHkoKSkgewoKCQkJCXRoaXMKCQkJCQkucmVtb3ZlQ2xhc3MoICJlcnJvciIgKQoJCQkJCS5uZXh0KCAic3Bhbi5lcnJvciIgKQoJCQkJCS5yZW1vdmUoKTsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcwoJCQkJCS5hZGRDbGFzcyggImVycm9yIiApCgkJCQkJLm5leHQoICJzcGFuLmVycm9yIiApCgkJCQkJLnJlbW92ZSgpCgkJCQkJLmVuZCgpCgkJCQkJLmFmdGVyKCAiPHNwYW4gY2xhc3M9J2Vycm9yJz4iICsgZS5wdWJsaXNoZXIuZ2V0KCkgKyAiPC9zcGFuPiIgKTsKCQkJfQoJCX0sCgoJCWhpZ2hsaWdodEVycm9yOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpc1tlLnB1Ymxpc2hlci5pc0VtcHR5KCkgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0oICJlcnJvciIgKTsKCgkJfSwKCgkJcmVuZGVyRXJyb3JTdW1tYXJ5OiBobS50ZW1wbGF0ZS5uZXdUZW1wbGF0ZUhhbmRsZXIoCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJcmV0dXJuIFtlLnB1Ymxpc2hlci5nZXRFcnJvcnMoKV07CgkJCX0KCQkpCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJaWYgKCFvcHRpb25zKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWxpZGF0b3IgcGF0aCI7CgkJCX0KCQkJaWYgKCFvcHRpb25zLnN0YXJ0c1dpdGgoICIjIiApKSB7CgkJCQlvcHRpb25zID0gIiMiICsgb3B0aW9uczsKCQkJfQoJCQlobSggcGF0aCApLnZhbGlkYXRvciggb3B0aW9ucyApOwoJCX0sCgoJCS8vYWRkIGEgY2xpY2sgaGFuZGxlciB0byBlbGVtZW50IHRvIGNoZWNrVmFsaWRpdHkKCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJLy9wcmVwZW5kIHRvIHRvIHN1YnNjcmlwdGlvbnMgYXJyYXkKCQkJLy9zbyB0aGF0IGl0IGlzIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zLCBhbmQgaXQgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNoZWNrVmFsaWRpdHkiICk7CgkJfSwKCgkJcmVzZXRWYWxpZGl0eTogIiRjbGljazoufCpmYWtlR2V0IHJlc2V0VmFsaWRpdHkiLAoKCQl3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCgkJImhpZ2hsaWdodEVycm9yIjogIiFhZnRlcio6KmVycm9yc3wqaGlnaGxpZ2h0RXJyb3IiLAoKCQl3YXJuU3VtbWFyeTogIiFhZnRlclVwZGF0ZSogdmFsaWRpdHlDaGVja2VkOi58KnJlbmRlckVycm9yU3VtbWFyeTshdmFsaWRpdHlSZXNldDoufGVtcHR5IgoKCX0gKTsKCgliaW5kaW5ncyggImZvcm0iLCBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgInJlc2V0IiwgIipmYWtlR2V0IHJlc2V0VmFsaWRpdHkiICk7Cgl9LCB0cnVlICk7CgoJZnVuY3Rpb24gaXNQYXRoVmFsaWQoIHBhdGggKSB7CgoJCWlmIChwYXRoID09PSAiIikgewoJCQlyZXR1cm4gIWludmFsaWRQYXRocy5sZW5ndGg7CgkJfQoKCQl2YXIgcHJlZml4ID0gcGF0aCArICIuIjsKCgkJZm9yICh2YXIgaSA9IDAsIGludmFsaWRQYXRoLCBsZW5ndGggPSBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJaW52YWxpZFBhdGggPSBpbnZhbGlkUGF0aHNbaV07CgkJCWlmIChpbnZhbGlkUGF0aCA9PSBwYXRoIHx8IGludmFsaWRQYXRoLnN0YXJ0c1dpdGgoIHByZWZpeCApKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8kKCJ4Iikuc3Vic2NyaWJlKCJwZXJzb24iLCAiY2hlY2tWYWxpZGl0eWQiLCBmdW5jdGlvbiAoZSkgewoJLy8gYWxlcnQoZS5wcm9wb3NlZCk7CgkvL30KCWhtLnN1YnNjcmlwdGlvbi5zcGVjaWFsLnZhbGlkaXR5Q2hhbmdlZCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApIHsKCQkJdmFyIGlzVmFsaWRQYXRoID0gcHVibGlzaGVyICsgIippc1ZhbGlkIjsKCgkJCWlmIChpc1VuZGVmaW5lZCggaG0uZ2V0KCBpc1ZhbGlkUGF0aCApICkpIHsKCQkJCWhtLnN1YiggcHVibGlzaGVyLCAiKmludmFsaWRQYXRocyIsICIhYWZ0ZXIqLiBhZnRlciouMSIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBpc1ZhbGlkID0gaXNQYXRoVmFsaWQoIHB1Ymxpc2hlciApOwoJCQkJCWlmIChobS5nZXQoIGlzVmFsaWRQYXRoICkgIT09IGlzVmFsaWQpIHsKCQkJCQkJaG0udHJpZ2dlciggcHVibGlzaGVyLCBwdWJsaXNoZXIsICJ2YWxpZGl0eUNoYW5nZWQiLCBpc1ZhbGlkLCAhaXNWYWxpZCApOwoJCQkJCQlobS5zZXQoIGlzVmFsaWRQYXRoLCBpc1ZhbGlkICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfQoJfTsKCglleHRlbmQoIGhtRm4sIHsKCgkJLyoKCQkgKiAxLiB0aGUgb2JqZWN0cyBpbiBwYXRoICIqaW52YWxpZFBhdGhzIiwgaXQgaG9sZHMgYWxsIHRoZSBwYXRoIG9mIG1vZGVsIHdoaWNoIGlzIGluIGVycm9yCgkJICogMi4gdGhlIG9iamVjdCBpbiBwYXRoICJtb2RlbCplcnJvcnMiLCBpdCBob2xkcyBhbGwgZXJyb3IgbWVzc2FnZSB0aGF0IGlzCgkJICogKi8KCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApOyAvLyB0aGlzLmNkKCBzdWJQYXRoICkucGF0aDsKCgkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggZnVsbFBhdGgsIGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdHJpZ2dlciggcGF0aCwgcGF0aCwgImNoZWNrVmFsaWRpdHkiLCByb290Tm9kZS5nZXQoIHBhdGggKSApOwoJCQl9ICk7CgoJCQkvL2FmdGVyIGNoZWNrVmFsaWRpdHkgZmlyZWQsIHdlIGNhbiBjaGVjayB0aGUgaW52YWxpZCBwYXRocyBjb3VudCBmb3IgdGhlIG1vZGVsLAoJCQl2YXIgaXNWYWxpZCA9IGlzUGF0aFZhbGlkKCBmdWxsUGF0aCApOwoJCQkvLwoJCQlobS50cmlnZ2VyKCBmdWxsUGF0aCwgZnVsbFBhdGgsICJ2YWxpZGl0eUNoZWNrZWQiLCBpc1ZhbGlkICk7CgoJCQlyZXR1cm4gaXNWYWxpZDsKCQl9LAoKCQkvL2htKCJ4IikuY2hlY2sodmFsaWRhdG9yTmFtZSwgZXJyb3IpCgkJLy9leGFtcGxlCgkJLy9obSgieCIpLmNoZWNrKCJudW1iZXIiLCAibXkgZXJyb3IgbWVzc2FnZSIpCgkJLy8KCQkvL2htKCJ4IikuY2hlY2soZm5Jc1ZhbGlkLCBlcnJvcikKCQkvL2V4YW1wbGUKCQkvL2htKCJ4IikuY2hlY2soZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gZmFsc2U7IH0sICJteSBlcnJvciBtZXNzYWdlIik7CgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggdmFsaWRhdG9yLCBvcHRpb25zICkgewoJCQl2YXIgc3ViUGF0aCwKCQkJCWksCgkJCQljdXJyZW50VmFsaWRhdG9yOwoKCQkJaWYgKGlzT2JqZWN0KCB2YWxpZGF0b3IgKSkgewoKCQkJCWZvciAoc3ViUGF0aCBpbiB2YWxpZGF0b3IpIHsKCgkJCQkJdGhpcy5jZCggc3ViUGF0aCApLnZhbGlkYXRvciggdmFsaWRhdG9yW3N1YlBhdGhdICk7CgoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCB2YWxpZGF0b3IgKSB8fCAoaXNTdHJpbmcoIHZhbGlkYXRvciApICYmIHZhbGlkYXRvci5zdGFydHNXaXRoKCAiIyIgKSkpIHsKCgkJCQkJaWYgKGlzU3RyaW5nKCB2YWxpZGF0b3IgKSkgewoJCQkJCQl2YWxpZGF0b3IgPSB0aGlzLnJhdyggdmFsaWRhdG9yLnN1YnN0ciggMSApICk7CgkJCQkJfQoKCQkJCQlobS5oYW5kbGUoIHRoaXMucGF0aCwgYWZ0ZXJVcGRhdGVBbmRDaGVja1ZhbGlkaXR5LCBmdW5jdGlvbiggZSApIHsKCQkJCQkJdmFyIHB1Ymxpc2hlciA9IGUucHVibGlzaGVyLAoJCQkJCQkJcHJldmlvdXNFcnJvciA9IHZhbGlkYXRvci5wcmV2aW91c0Vycm9yOwoKCQkJCQkJLy9kb24ndCBjaGVjayB3aGVuIGl0IGlzIGVtcHR5CgkJCQkJCWlmICghaXNFbXB0eVN0cmluZyggZS5wcm9wb3NlZCApKSB7CgoJCQkJCQkJdmFyIGVycm9yTWVzc2FnZSA9IHZhbGlkYXRvciggcHVibGlzaGVyLmdldCgpICk7CgoJCQkJCQkJaWYgKGVycm9yTWVzc2FnZSA9PT0gZmFsc2UpIHsKCQkJCQkJCQllcnJvck1lc3NhZ2UgPSBkZWZhdWx0T3B0aW9ucy5lcnJvcnMuZGVmYXVsdEVycm9yOwoJCQkJCQkJfQoKCQkJCQkJCWlmIChpc1N0cmluZyggZXJyb3JNZXNzYWdlICkpIHsKCQkJCQkJCQkvLyB0aGUgIiE9IiBpcyBkZWxpYmVyYXRlLCBkb24ndCBjaGFuZ2UgdG8gIiE9PSIKCQkJCQkJCQlpZiAoZXJyb3JNZXNzYWdlICE9IHByZXZpb3VzRXJyb3IpIHsKCgkJCQkJCQkJCXB1Ymxpc2hlci5hZGRFcnJvciggZXJyb3JNZXNzYWdlICk7CgoJCQkJCQkJCQlpZiAoIXByZXZpb3VzRXJyb3IpIHsKCQkJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQl2YWxpZGF0b3IucHJldmlvdXNFcnJvciA9IGVycm9yTWVzc2FnZTsKCQkJCQkJCQl9CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIHByZXZpb3VzRXJyb3IgKTsKCQkJCQkJCQkJdmFsaWRhdG9yLnByZXZpb3VzRXJyb3IgPSAiIjsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCXZhbGlkYXRvci5wcmV2aW91c0Vycm9yID0gIiI7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCX0gZWxzZSBpZiAoaXNTdHJpbmcoIHZhbGlkYXRvciApKSB7CgoJCQkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBhZnRlclVwZGF0ZUFuZENoZWNrVmFsaWRpdHksICIqdl8iICsgdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIGlmIChpc0FycmF5KCB2YWxpZGF0b3IgKSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgoJCQkJCQljdXJyZW50VmFsaWRhdG9yID0gdmFsaWRhdG9yW2ldOwoKCQkJCQkJaWYgKGlzQXJyYXkoIGN1cnJlbnRWYWxpZGF0b3IgKSkgewoJCQkJCQkJdGhpcy52YWxpZGF0b3IoIGN1cnJlbnRWYWxpZGF0b3JbMF0sIGN1cnJlbnRWYWxpZGF0b3JbMV0gKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnZhbGlkYXRvciggY3VycmVudFZhbGlkYXRvciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXNldFZhbGlkaXR5OiBmdW5jdGlvbigpIHsKCQkJcmVzZXRWYWxpZGl0eSggdGhpcy5wYXRoICk7CgoJCQlpZiAoIWlzUHJpbWl0aXZlKCB0aGlzLmdldCgpICkpIHsKCQkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggdGhpcy5wYXRoLCByZXNldFZhbGlkaXR5ICk7CgkJCX0KCQkJaG0udHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJ2YWxpZGl0eVJlc2V0IiApOwoJCX0sCgoJCWFkZEVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgkJCXRoaXMuY3JlYXRlSWZVbmRlZmluZWQoICIqZXJyb3JzIiwgW10gKQoJCQkJLmNkKCAiKmVycm9ycyIgKQoJCQkJLnB1c2hVbmlxdWUoIGVycm9yICk7CgoJCQlpbnZhbGlkUGF0aHNNb2RlbC5wdXNoVW5pcXVlKCB0aGlzLnBhdGggKTsKCQkJcmV0dXJuIHRoaXM7CgoJCX0sCgoJCXJlbW92ZUVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgoJCQl2YXIgZXJyb3JzID0gdGhpcy5jcmVhdGVJZlVuZGVmaW5lZCggIiplcnJvcnMiLCBbXSApLmNkKCAiKmVycm9ycyIgKTsKCQkJZXJyb3JzLnJlbW92ZUl0ZW0oIGVycm9yICk7CgkJCWlmIChlcnJvcnMuaXNFbXB0eSgpKSB7CgkJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCB0aGlzLnBhdGggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRFcnJvcnM6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQlwYXRoID0gdGhpcy5wYXRoLAoJCQkJaW52YWxpZFBhdGgsCgkJCQlydG4gPSBbXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJCWludmFsaWRQYXRoID0gaW52YWxpZFBhdGhzW2ldOwoJCQkJaWYgKGludmFsaWRQYXRoID09IHBhdGggfHwgaW52YWxpZFBhdGguc3RhcnRzV2l0aCggcGF0aCApKSB7CgkJCQkJcnRuID0gcnRuLmNvbmNhdCggaG0uZ2V0KCBpbnZhbGlkUGF0aCArICIqZXJyb3JzIiApICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWhtLmNoZWNrVmFsaWRpdHkgPSBmdW5jdGlvbiggcGF0aCApIHsKCQlyZXR1cm4gcm9vdE5vZGUuY2hlY2tWYWxpZGl0eSggcGF0aCApOwoJfTsKCgkvL3doZW4gcGF0aCBpcyBkZWxldGVkLCByZW1vdmUgaXQgZnJvbSBpbnZhbGlkUGF0aHNNb2RlbAoJaG0ub25EZWxldGVOb2RlKCBmdW5jdGlvbiggcGF0aCApIHsKCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7Cgl9ICk7CgoJZnVuY3Rpb24gYnVpbGRSZWdleEZuKCBleCwgcmV2ZXJzZSApIHsKCQlyZXR1cm4gcmV2ZXJzZSA/IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuICFleC50ZXN0KCB2YWx1ZSApOwoJCX0gOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiBleC50ZXN0KCB2YWx1ZSApOwoJCX07Cgl9CgoJZnVuY3Rpb24gZGVmYXVsdEVycm9yQnVpbGRlciggZm9ybWF0LCBvcHRpb25zICkgewoJCXJldHVybiBvcHRpb25zLmVycm9yIHx8IGZvcm1hdC5zdXBwbGFudCggb3B0aW9ucyApOwoJfQoKCWhtLnZhbGlkYXRvci5kZWZhdWx0RXJyb3JCdWlsZGVyID0gZGVmYXVsdEVycm9yQnVpbGRlcjsKCWhtLnZhbGlkYXRvci5idWlsZFJlZ2V4Rm4gPSBidWlsZFJlZ2V4Rm47CgoJaG0udmFsaWRhdG9yKCBbCgkJewoJCQluYW1lOiAicmVxdWlyZWQiLAoJCQllcnJvcjogIlRoaXMgZmllbGQgaXMgcmVxdWlyZWQuIiwKCQkJLy93aGVuIGl0IGlzIGNoZWNrZWQgaXQgaXMgYWx3YXlzIHRydWUKCQkJaXNWYWxpZDogcmV0dXJuVHJ1ZQoJCX0sCgkJewoJCQluYW1lOiAiZW1haWwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MuIiwKCQkJaXNWYWxpZDogckVtYWlsCgkJfSwKCQl7CgkJCW5hbWU6ICJ1cmwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIFVSTC4iLAoJCQlpc1ZhbGlkOiByVXJsCgkJfSwKCQl7CgkJCW5hbWU6ICJkYXRlIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBkYXRlLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCXJldHVybiAhckludmFsaWREYXRlLnRlc3QoIG5ldyBEYXRlKCB2YWx1ZSApLnRvU3RyaW5nKCkgKTsKCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZGF0ZUlTTyIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgZGF0ZSAoSVNPKS4iLAoJCQlpc1ZhbGlkOiByRGF0ZUlTTwoJCX0sCgkJewoJCQluYW1lOiAibnVtYmVyIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBudW1iZXIuIiwKCQkJaXNWYWxpZDogck51bWJlcgoJCX0sCgkJewoJCQluYW1lOiAiZGlnaXRzIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgb25seSBkaWdpdHMuIiwKCQkJaXNWYWxpZDogckRpZ2l0CgoJCX0sCgkJewoJCQluYW1lOiAiY3JlZGl0Y2FyZCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgY3JlZGl0IGNhcmQgbnVtYmVyLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCWlmICgvW14wLTlcLV0rLy50ZXN0KCB2YWx1ZSApKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBuQ2hlY2sgPSAwLAoJCQkJCW5EaWdpdCA9IDAsCgkJCQkJYkV2ZW4gPSBmYWxzZSwKCQkJCQljRGlnaXQ7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCAvXEQvZywgIiIgKTsKCgkJCQlmb3IgKHZhciBuID0gdmFsdWUubGVuZ3RoIC0gMTsgbiA+PSAwOyBuLS0pIHsKCQkJCQljRGlnaXQgPSB2YWx1ZS5jaGFyQXQoIG4gKTsKCQkJCQluRGlnaXQgPSBwYXJzZUludCggY0RpZ2l0LCAxMCApOwoJCQkJCWlmIChiRXZlbikgewoJCQkJCQlpZiAoKG5EaWdpdCAqPSAyKSA+IDkpIHsKCQkJCQkJCW5EaWdpdCAtPSA5OwoJCQkJCQl9CgkJCQkJfQoJCQkJCW5DaGVjayArPSBuRGlnaXQ7CgkJCQkJYkV2ZW4gPSAhYkV2ZW47CgkJCQl9CgoJCQkJcmV0dXJuIChuQ2hlY2sgJSAxMCkgPT09IDA7CgkJCX0KCgkJfSwKCQl7CgkJCW5hbWU6ICJtaW5sZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhdCBsZWFzdCB7bWlubGVuZ3RofSBjaGFyYWN0ZXJzLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUubGVuZ3RoID49IG9wdGlvbnMubWlubGVuZ3RoOwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW5sZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWlubGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXhsZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBubyBtb3JlIHRoYW4ge21heGxlbmd0aH0gY2hhcmFjdGVycy4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlLmxlbmd0aCA8PSBvcHRpb25zLm1heGxlbmd0aDsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltYXhsZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWF4bGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgkJCWJ1aWxkRXJyb3I6IGRlZmF1bHRFcnJvckJ1aWxkZXIKCQl9LAoJCXsKCQkJbmFtZTogInJhbmdlbGVuZ3RoIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBiZXR3ZWVuIHttaW5sZW5ndGh9IGFuZCB7bWF4bGVuZ3RofSBjaGFyYWN0ZXJzIGxvbmcuIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5sZW5ndGggJiYKCQkJCSAgICAgICB2YWx1ZS5sZW5ndGggPD0gb3B0aW9ucy5tYXhsZW5ndGg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWlubGVuZ3RoOiArbWF0Y2hbMV0sCgkJCQkJCW1heGxlbmd0aDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZWxlbmd0aCB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgoJCX0sCgkJewoJCQluYW1lOiAibWluIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8ge21pbn0uIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZSA+PSBvcHRpb25zLm1pbjsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW46ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWluIHZhbGlkYXRvciI7CgkJCQl9CgoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB7bWF4fS4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlIDw9IG9wdGlvbnMubWF4OwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSB7CgkJCQkJCW1heDogK21hdGNoWzFdLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciBtYXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfSwKCQkJYnVpbGRFcnJvcjogZGVmYXVsdEVycm9yQnVpbGRlcgoJCX0sCgkJewoJCQluYW1lOiAicmFuZ2UiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4ge21pbn0gYW5kIHttYXh9LiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUgPj0gb3B0aW9ucy5taW4gJiYgdmFsdWUgPD0gb3B0aW9ucy5tYXg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWluOiArbWF0Y2hbMV0sCgkJCQkJCW1heDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJlcXVhbCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIHRoZSBzYW1lIHZhbHVlIGFnYWluLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCQkJCXJldHVybiByb290Tm9kZS5nZXQoIG9wdGlvbnMuY29tcGFyZVBhdGggKSA9PT0gdmFsdWU7CgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgoJCQkJCXZhciBjb21wYXJlUGF0aCA9IHB1Ymxpc2hlci5jZCggbWF0Y2hbMV0gKS5wYXRoOwoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJY29tcGFyZVBhdGg6IGNvbXBhcmVQYXRoLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoKCQkJCQlwdWJsaXNoZXIuc3ViKCBjb21wYXJlUGF0aCwgImFmdGVyVXBkYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWlmICghdGhpcy5pc0VtcHR5KCkpIHsKCQkJCQkJCXRyaWdnZXIoCgkJCQkJCQkJdGhpcy5wYXRoLAoJCQkJCQkJCXRoaXMucGF0aCwKCQkJCQkJCQkiY2hlY2tWYWxpZGl0eSIsCgkJCQkJCQkJdGhpcy5nZXQoKSAvL3Byb3Bvc2VkIHZhbHVlCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgZXF1YWwgdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAicmVnZXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIG1hdGNoIHdpdGggcmVxdWlyZWQgcGF0dGVybi4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgkJCQlyZXR1cm4gb3B0aW9ucy5yZWdleC50ZXN0KCB2YWx1ZSApOwoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJSZWdFeC5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlyZWdleDogZXZhbCggbWF0Y2hbMV0gKSwKCQkJCQkJZXJyb3I6IG1hdGNoWzVdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgcmVnZXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZml4ZWRWYWx1ZSIsCgkJCWVycm9yOiAnUGxlYXNlIGVudGVyIHZhbHVlICJ7Zml4ZWRWYWx1ZX0iJywKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoJCQkJcmV0dXJuIHZhbHVlID09IG9wdGlvbnMuZml4ZWRWYWx1ZTsKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgkJCQkJbWF0Y2ggPSAvXihcdyspKCwoLiopKSokLy5leGVjKCBvcHRpb25zICk7CgkJCQkJaWYgKG1hdGNoKSB7CgkJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJCWZpeGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSggbWF0Y2hbMV0gKSwKCQkJCQkJCWVycm9yOiBtYXRjaFszXQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9wdGlvbnMgKSkgewoKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSBvcHRpb25zOwoKCQkJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBvcHRpb25zICkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlmaXhlZFZhbHVlOiBvcHRpb25zCgkJCQkJfTsKCgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIG9wdGlvbnMgaW4gZml4ZWRWYWx1ZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfQoJXSApOwoKCWZ1bmN0aW9uIHJlc2V0VmFsaWRpdHkoIHBhdGggKSB7CgkJdmFyIGVycm9yc01vZGVsID0gaG0oIHBhdGggKyAiKmVycm9ycyIgKTsKCQlpZiAoIWVycm9yc01vZGVsLmlzRW1wdHkoKSkgewoJCQllcnJvcnNNb2RlbC5jbGVhcigpOwoJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7CgkJfQoJfQoKCXZhciBpc1JlcXVpcmVkID0gaG0ud29ya2Zsb3coICJ2X3JlcXVpcmVkIiApLmdldDsKCglmdW5jdGlvbiBpc01vZGVsUmVxdWlyZWQoIHBhdGggKSB7CgkJdmFyIHN1YnNjcmlwdGlvbkJ5TW9kZWwgPSBobSggcGF0aCApLnN1YnNUb01lKCk7Ly8gc3Vic2NyaXB0aW9ucy5nZXRCeVB1Ymxpc2hlciggcGF0aCApOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9uQnlNb2RlbC5sZW5ndGg7IGkrKykgewoJCQl2YXIgc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uQnlNb2RlbFtpXTsKCQkJaWYgKHN1YnNjcmlwdGlvbi5oYW5kbGVyLmdldCA9PT0gaXNSZXF1aXJlZCkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkRXJyb3JNZXNzYWdlKCB2YWxpZGF0b3IsIG9wdGlvbnMgKSB7CgoJCS8vbmFtZWQgdmFsaWRhdG9yIG5vcm1hbGx5IGhhcyBhIGRlZmF1bHRFcnJvcgoJCXZhciBkZWZhdWx0RXJyb3IgPSB2YWxpZGF0b3IubmFtZSAmJiBkZWZhdWx0T3B0aW9ucy5lcnJvcnNbdmFsaWRhdG9yLm5hbWVdOwoKCQkvL2lmIHZhbGlkYXRvciBoYXMgYnVpbGRFcnJvciBmdW5jdGlvbiwgdGhpcyB0YWtlIHRoZSBoaWdoZXN0IHByaW9yaXR5CgkJaWYgKHZhbGlkYXRvci5idWlsZEVycm9yKSB7CgoJCQkvL3JldHVybiB1c2VyRXJyb3IgfHwgZm9ybWF0LmFwcGx5KCBudWxsLCBbZGVmYXVsdEVycm9yXS5jb25jYXQoIG9wdGlvbnMubWlubGVuZ3RoICkgKTsKCQkJcmV0dXJuIHZhbGlkYXRvci5idWlsZEVycm9yKCBkZWZhdWx0RXJyb3IsIG9wdGlvbnMgKTsKCgkJCS8vaWYgZGVmYXVsdEVycm9yIGlzIGZvcm1hdCBzdHJpbmcsCgkJfSBlbHNlIHsKCgkJCS8vdXNlckVycm9yIGlzIG5vcm1hbGx5IHBhc3NlZCBpbiBvcHRpb25zIG9mIGVhY2ggaW5zdGFuY2UKCQkJdmFyIHVzZXJFcnJvciA9IGlzT2JqZWN0KCBvcHRpb25zICkgPyBvcHRpb25zLmVycm9yIDogb3B0aW9uczsKCgkJCWlmIChkZWZhdWx0RXJyb3IgJiYgZGVmYXVsdEVycm9yLmNvbnRhaW5zKCAiezB9IiApKSB7CgoJCQkJcmV0dXJuIGRlZmF1bHRFcnJvci5mb3JtYXQuYXBwbHkoIGRlZmF1bHRFcnJvciwgdXNlckVycm9yLnNwbGl0KCAiLCIgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gdXNlckVycm9yIHx8IGRlZmF1bHRFcnJvciB8fCB2YWxpZGF0b3IuZXJyb3I7CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSB7CgoJCXJldHVybiB7CgoJCQlpbml0aWFsaXplOiB2YWxpZGF0b3IuaW5pdGlhbGl6ZSwKCgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy9pZiBpdCB2aW9sYXRlIHJlcXVpcmVkIHJ1bGUsIGRvbid0IGRvIGZ1cnRoZXIgdmFsaWRhdGlvbiwKCQkJCS8vYXMgd2UgZXhwZWN0IHRoZSByZXF1aXJlZCBydWxlIHdpbGwgY2FwdHVyZSBpdCBmaXJzdC4KCQkJCXZhciBpc1ZhbGlkLAoJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUsCgkJCQkJcHVibGlzaGVyID0gZS5wdWJsaXNoZXIsCgkJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJCXByb3Bvc2VkID0gZS5wcm9wb3NlZCwKCQkJCQllcnJvck1lc3NhZ2UgPSBidWlsZEVycm9yTWVzc2FnZSggdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJLy9pZiBtb2RlbCBpcyBlbXB0eSwgb25seSBjaGVjayB0aGUgInJlcXVpcmUiIHZhbGlkYXRvcgoJCQkJLy9JZiBpdCBpcyByZXF1aXJlZCwgdGhlbiBpdCBpcyBpbnZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJLy9pZiBpdCBpcyBub3QgcmVxdWlyZWQsIGl0IGlzIHZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJaWYgKGlzRW1wdHlTdHJpbmcoIHByb3Bvc2VkICkpIHsKCgkJCQkJaWYgKGlzTW9kZWxSZXF1aXJlZCggcHVibGlzaGVyLnBhdGggKSkgewoJCQkJCQlpc1ZhbGlkID0gZmFsc2U7CgkJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlzVmFsaWQgPSB0cnVlOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlpc1ZhbGlkID0gdmFsaWRhdG9yLmlzVmFsaWQoIHByb3Bvc2VkLCBvcHRpb25zICk7CgkJCQl9CgoJCQkJaWYgKCFpc1ZhbGlkKSB7CgoJCQkJCS8vYWRkIGVycm9yIHdoZW4gdGhlIGN1cnJlbnQgcnVsZSBpcyB0aGUgInJlcXVpcmVkIHJ1bGUiCgkJCQkJLy9vciB3aGVuICJyZXF1aXJlZCIgcnVsZSBpcyBub3QgdmlvbGF0ZWQKCQkJCQlpZiAoIXZpb2xhdGVSZXF1aXJlZFJ1bGUgfHwgdmFsaWRhdG9yLm5hbWUgPT09ICJyZXF1aXJlZCIpIHsKCQkJCQkJcHVibGlzaGVyLmFkZEVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIGVycm9yTWVzc2FnZSApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcHVibGlzaGVyLnJlbW92ZUVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCX0KCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gdHJhdmVyc2VNb2RlbE5lZWRWYWxpZGF0aW9uKCBwYXRoLCBjYWxsYmFjayApIHsKCgkJLy90aGUgZm9sbG93aW5nIGNvZGUgdHJ5IHRvIHRyaWdnZXIgdGhlICJjaGVja1ZhbGlkaXR5IiBldmVudCwgc28gdGhhdCB0aGUgdmFsaWRhdG9yIHdpbGwKCQkvLyBiZSBjYWxsZWQgdG8gY2hlY2sgY3VycmVudCB2YWx1ZSBvZiB0aGUgbW9kZWwKCQkvL3lvdSBjYW4gbm90IGNhbGwgYWZ0ZXJVcGRhdGUsIGJlY2F1c2UgdGhlcmUgbWlnaHQgdHJpZ2dlciBvdGhlciBub24tdmFsaWRhdG9yIGhhbmRsZXIKCQkvL3RoYXQgYXJlIGF0dGFjaGVkIHRvIGFmdGVyVXBkYXRlCgkJdmFyIGFsbFN1YnNjcmlwdGlvbnMgPSBobS5zdWJzY3JpcHRpb24uZ2V0QWxsKCk7CgkJdmFyIGNoZWNrVmFsaWRpdHlkUGF0aHMgPSB7fTsKCgkJZm9yICh2YXIgaSA9IGFsbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMSwgc3Vic2NyaXB0aW9uLCBwdWJsaXNoZXJQYXRoOyBpID49IDA7IGktLSkgewoKCQkJc3Vic2NyaXB0aW9uID0gYWxsU3Vic2NyaXB0aW9uc1tpXTsKCQkJcHVibGlzaGVyUGF0aCA9IHN1YnNjcmlwdGlvbi5wdWJsaXNoZXI7CgoJCQl2YXIgaXNWYWxpZGF0aW9uUmVxdWlyZWQgPQoJCQkJaXNTdHJpbmcoIHB1Ymxpc2hlclBhdGggKSAmJiAhY2hlY2tWYWxpZGl0eWRQYXRoc1twdWJsaXNoZXJQYXRoXSAmJgoJCQkJcHVibGlzaGVyUGF0aC5zdGFydHNXaXRoKCBwYXRoICkgJiYKCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLmNvbnRhaW5zKCAiY2hlY2tWYWxpZGl0eSIgKTsKCgkJCWlmIChpc1ZhbGlkYXRpb25SZXF1aXJlZCkgewoKCQkJCWNoZWNrVmFsaWRpdHlkUGF0aHNbcHVibGlzaGVyUGF0aF0gPSB0cnVlOwoJCQkJY2FsbGJhY2soIHB1Ymxpc2hlclBhdGggKTsKCgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gaXNFbXB0eVN0cmluZyggdmFsdWUgKSB7CgkJcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgckVtcHR5LnRlc3QoIHZhbHVlICk7Cgl9CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL3RoZSBjb252ZW50aW9uIGhlcmUgaXMgdGhhdCAsCgkvLyB1c2Ugcm93VmlldyBmb3IgdGhlIHJvdyBpbiB2aWV3CgkvL3VzZSBpdGVtIGZvciB0aGUgaXRlbSBpbiBtb2RlbCBhcnJheQoKCWhtLndvcmtmbG93KCB7CgoJCS8vLS0tLS0tLS0tLXdvcmtmbG93IHR5cGUgd2hpY2ggbW9kaWZ5IHJvdyBpbiBsaXN0IHZpZXctLS0tLS0tLS0tLQoKCQkvLyFhZnRlckNyZWF0ZS4xOmFycmF5fCphZGRSb3dWaWV3OwoJCWFkZFJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCgkJCS8vdGhlIHJlYXNvbiB0byB1c2UgZ2V0T3JpZ2luYWwgaXMgdGhhdAoJCQkvL3RoZSBzdWJzY3JpcHRpb24gaXMgdGhlIGl0ZW1zIGFycmF5CgkJCS8vYnV0IGhlcmUgd2Ugd2FudCB0byB0aGUgZWxlbQoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCByb3dWaWV3LCBlICkgewoKCQkJCXZhciByb3dDb250YWluZXIgPSB0aGlzLAoJCQkJCXJvd3MgPSByb3dDb250YWluZXIuY2hpbGRyZW4oKTsKCgkJCQlpZiAocm93cy5sZW5ndGggPT09IDApIHsKCgkJCQkJcm93Q29udGFpbmVyLmFwcGVuZCggcm93VmlldyApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGluc2VydCBtYXkgbm90IGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheQoJCQkJCS8vYXQgY2FuIGJlIGluc2VydCBpbiB0aGUgbWlkZGxlLCBzbwoJCQkJCS8vd2UgY2FuIG5vdCBzaW1wbHkgZG8gc3Vic2NyaWJlci5hcHBlbmQoKQoJCQkJCS8vd2UgbmVlZCB0byBhcHBlbmQgdGhlIHJvdyB2aWV3IGF0IHRoZSBpbmRleAoJCQkJCXZhciBpbmRleCA9ICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpOwoKCQkJCQkvL3JvdyB6ZXJvIGlzIHNwZWNpYWwsIG5lZWQgdG8gdXNlIGJlZm9yZSBtZXRob2QKCQkJCQlpZiAoaW5kZXggPT09IDApIHsKCgkJCQkJCXJvd3MuZXEoIDAgKS5iZWZvcmUoIHJvd1ZpZXcgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyb3dzLmVxKCBpbmRleCAtIDEgKS5hZnRlciggcm93VmlldyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCSksCgoJCS8vIWFmdGVyVXBkYXRlLjE6YXJyYXl8KnVwZGF0ZVJvd1ZpZXcKCQl1cGRhdGVSb3dWaWV3OiBuZXdUZW1wbGF0ZUhhbmRsZXIoCgoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkJCXRoaXMuY2hpbGRyZW4oKS5lcSggK2Uub3JpZ2luYWxQdWJsaXNoZXIucGF0aEluZGV4KCkgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyFhZnRlckRlbC4xOmFycmF5fCpyZW1vdmVSb3dWaWV3OwoJCXJlbW92ZVJvd1ZpZXc6IGZ1bmN0aW9uKCBlICkgewoJCQl0aGlzLmNoaWxkcmVuKCkuZXEoICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpICkucmVtb3ZlKCk7CgkJfQoKCgl9ICk7CgoJLy9hdXRvUXVlcnkgbWVhbnMgdXNlciBkb24ndCBuZWVkIHRvIHRyaWdnZXIgc2VhcmNoIGJ1dHRvbgoJLy9xdWVyeSByZXN1bHQgd2lsbCBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbgoJLy9xdWVyeSBjaGFuZ2UsIGJ5IGRlZmF1bHQgaXQgaXMgZmFsc2UKCS8vd2hpY2ggbWVhbnMgdXNlciBoYXMgcmVmcmVzaFF1ZXJ5IG1hbnVhbGx5CglobUZuLmVuYWJsZVF1ZXJ5ID0gZnVuY3Rpb24oIGF1dG9RdWVyeSApIHsKCgkJaWYgKHRoaXMuZ2V0KCAiKnF1ZXJ5IiApKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHF1ZXJ5YWJsZSwKCQkJcXVlcnksCgkJCXNvcnQsCgkJCXBhZ2VyLAoJCQlmaWx0ZXJGbiwKCQkJZmlsdGVyLAoJCQlpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCXF1ZXJ5Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnkiICksCgkJCXF1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnlSZXN1bHQiICksCgkJCWhhc1F1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqaGFzUXVlcnlSZXN1bHQiICksCgkJCXBhZ2VyTm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInBhZ2VyIiApLAoJCQlmaWx0ZXJOb2RlID0gcXVlcnlOb2RlLmNkKCAiZmlsdGVyIiApLAoJCQlmaWx0ZXJFbmFibGVkTm9kZSA9IGZpbHRlck5vZGUuY2QoICJlbmFibGVkIiApLAoJCQlzb3J0Tm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInNvcnQiICk7CgoJCWF1dG9RdWVyeSA9ICEhYXV0b1F1ZXJ5OwoKCQlpZiAoYXV0b1F1ZXJ5KSB7CgkJCS8vaXRlbXMqcXVlcnlSZXN1bHQgLS0tcmVmZXJlbmNpbmctLT4gaXRlbXMqcXVlcnkKCQkJcXVlcnlSZXN1bHROb2RlLndhdGNoKCBxdWVyeU5vZGUucGF0aCApOwoJCX0KCgkJLy9pdGVtcypxdWVyeVJlc3VsdCAtLT4gaXRlbXMKCQlxdWVyeVJlc3VsdE5vZGUud2F0Y2goIHRoaXMucGF0aCApOwoKCQl0aGlzLmV4dGVuZCgKCQkJIioiLAoJCQlxdWVyeWFibGUgPSB7CgoJCQkJLy9pZiBpdCBpcyB0cnVlLCByZWZyZXNoUXVlcnkgaXMgYnlwYXNzZWQKCQkJCWF1dG9RdWVyeTogYXV0b1F1ZXJ5LAoKCQkJCWhhc1F1ZXJ5UmVzdWx0OiBmYWxzZSwKCgkJCQkvL3RoZSBvYmplY3QgaG9sZGluZyB0aGUgZGF0YSBhYm91dCBwYWdpbmcsIHNvcnRpbmcsIGFuZCBmaWx0ZXJpbmcKCQkJCXF1ZXJ5OiBxdWVyeSA9IHsKCQkJCQlwYWdlcjogcGFnZXIgPSB7CgkJCQkJCWVuYWJsZWQ6IGZhbHNlLAoJCQkJCQlpbmRleDogMCwgLy9udGggcGFnZQoJCQkJCQljb3VudDogMSwKCQkJCQkJc2l6ZTogMAoJCQkJCX0sCgkJCQkJc29ydDogc29ydCA9IHsKCQkJCQkJYnk6IG51bGwsIC8vY3VycmVudGx5IHdlIG9ubHkgc3VwcG9ydCBzb3J0IGJ5IG9uZSBjb2x1bW4gc29ydAoJCQkJCQlhc2M6IG51bGwKCQkJCQl9LAoJCQkJCWZpbHRlcjogZmlsdGVyID0gewoJCQkJCQlieTogIiIsCgkJCQkJCXZhbHVlOiAiIiwKCQkJCQkJb3BzOiAiIiwKCQkJCQkJZW5hYmxlZDogZmFsc2UKCQkJCQl9LAoJCQkJCS8vaXMgcXVlcnkgZW5hYmxlZAoJCQkJCWVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJwYWdlci5lbmFibGVkIiApIHx8IHRoaXMuZ2V0KCAic29ydC5ieSIgKSB8fCB0aGlzLmdldCggImZpbHRlci5lbmFibGVkIiApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcXVlcnlSZXN1bHQ6IGZ1bmN0aW9uKCBkaXNhYmxlUGFnaW5nICkgewoKCQkJCQkvLyJ0aGlzIiByZWZlcnMgdG8gdGhlIHF1ZXJ5YWJsZSBub2RlIGJ1dCBub3QgdGhlIHF1ZXJ5YWJsZSBvYmplY3QKCQkJCQl2YXIgJGl0ZW1zID0gJCggaXRlbXMgKSwKCgkJCQkJLy9ydW4gZmlsdGVyCgkJCQkJCXJ0biA9IGZpbHRlckZuID8gJGl0ZW1zLmZpbHRlciggZmlsdGVyRm4gKS5nZXQoKSA6ICRpdGVtcy5nZXQoKTsKCgkJCQkJaGFzUXVlcnlSZXN1bHROb2RlLnVwZGF0ZSggcnRuLmxlbmd0aCA+IDAgKTsKCgkJCQkJLy9ydW4gc29ydAoJCQkJCWlmIChzb3J0LmJ5KSB7CgoJCQkJCQlydG4uc29ydE9iamVjdCggc29ydC5ieSwgc29ydC5hc2MgKTsKCQkJCQl9CgoJCQkJCS8vcnVuIHBhZ2luZwoJCQkJCWlmICghZGlzYWJsZVBhZ2luZyAmJiBwYWdlci5lbmFibGVkKSB7CgkJCQkJCXZhciBjb3VudCA9IE1hdGguY2VpbCggcnRuLmxlbmd0aCAvIHBhZ2VyLnNpemUgKSB8fCAxOwoJCQkJCQlpZiAoY291bnQgIT0gcGFnZXIuY291bnQpIHsKCQkJCQkJCXBhZ2VyLmNvdW50ID0gY291bnQ7CgkJCQkJCQlpZiAocGFnZXIuaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJCQlwYWdlci5pbmRleCA9IDA7CgkJCQkJCQl9CgkJCQkJCQkvLwoJCQkJCQkJcXVlcnlOb2RlLmNoYW5nZSggInBhZ2VyIiApOwoJCQkJCQl9CgkJCQkJCXJ0biA9IHJ0bi5zbGljZSggcGFnZXIuaW5kZXggKiBwYWdlci5zaXplLCAocGFnZXIuaW5kZXggKyAxKSAqIHBhZ2VyLnNpemUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBydG47CgkJCQl9LAoKCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHZpYSBxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCkKCQkJCS8vb3IgaXQgY2FuIGJlIGNhbGxlZCB2aWEgbm9kZSBsaWtlIGl0ZW1zKnJlZnJlc2hRdWVyeQoJCQkJLy8KCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHJlZ2FyZGxlc3Mgd2hldGhlciBhdXRvUXVlcnkgaXMgZW5hYmxlZCwKCQkJCS8vIGJlY2F1c2UgaW50ZXJuYWxseSBpdCBjaGVjayB0aGUgZmxhZyB0byBkZXRlcm1pbmUgaWYKCQkJCS8vIGl0IGlzIG5lY2Vzc2FyeSB0byB0cmlnZ2VyIHRoZSBjaGFuZ2UgZXZlbnQKCQkJCXJlZnJlc2hRdWVyeTogZnVuY3Rpb24oKSB7CgkJCQkJLy9pZiBhdXRvUXVlcnkgaXMgdHJ1ZSwgdGhlbiBkb24ndCBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGFnYWluCgkJCQkJaWYgKCFxdWVyeWFibGUuYXV0b1F1ZXJ5KSB7CgkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJcXVlcnlSZXN1bHROb2RlLnRyaWdnZXIoICJhZnRlclVwZGF0ZSIgKTsKCQkJCQkJfSwgMCApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFnaW5nOiBmdW5jdGlvbiggZSApIHsKCgkJCQkJdmFyIGluZGV4ID0gZS5ldmVudERhdGE7CgoJCQkJCWlmIChyRGlnaXQudGVzdCggaW5kZXggKSkgewoKCQkJCQkJaW5kZXggPSAraW5kZXg7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoaW5kZXggPT0gIm5leHQiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5pbmRleCArIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJwcmV2aW91cyIpIHsKCgkJCQkJCQlpbmRleCA9IHBhZ2VyLmluZGV4IC0gMTsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImZpcnN0IikgewoKCQkJCQkJCWluZGV4ID0gMDsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImxhc3QiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5jb3VudCAtIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJkaXNhYmxlZCIpIHsKCQkJCQkJCWluZGV4ID0gMDsKCQkJCQkJCXF1ZXJ5YWJsZS5yZXNldFBhZ2luZygpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mIGluZGV4ICE9PSAibnVtYmVyIiB8fCBpbmRleCA8IDAgfHwgaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJaW5kZXggPSAwOwoJCQkJCX0KCgkJCQkJcGFnZXJOb2RlLnVwZGF0ZSggImluZGV4IiwgaW5kZXggKTsKCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQl9LAoKCQkJCXJlc2V0U29ydDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCXNvcnROb2RlLnNldCggImJ5IiwgbnVsbCApCgkJCQkJCS5zZXQoICJhc2MiLCBudWxsICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNldFNlYXJjaDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCWZpbHRlck5vZGUudXBkYXRlKCAiYnkiLCAiIiApCgkJCQkJCS51cGRhdGUoICJ2YWx1ZSIsICIiICkKCQkJCQkJLnVwZGF0ZSggIm9wcyIsICIiICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoKCQkJCX0sCgoJCQkJcmVzZXRQYWdpbmc6IGZ1bmN0aW9uKCB0cmlnZ2VyQnlNYXN0ZXJSZXNldCApIHsKCQkJCQlwYWdlck5vZGUudXBkYXRlKCAiZW5hYmxlZCIsIGZhbHNlICkKCQkJCQkJLnVwZGF0ZSggInNpemUiLCAwICkKCQkJCQkJLnVwZGF0ZSggImNvdW50IiwgMSApCgkJCQkJCS51cGRhdGUoICJpbmRleCIsIDAgKTsKCgkJCQkJaWYgKHRyaWdnZXJCeU1hc3RlclJlc2V0ICE9PSB0cnVlKSB7CgkJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCQl9CgoJCQkJfSwKCgkJCQlyZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKCQkJCQlxdWVyeWFibGUucmVzZXRTb3J0KCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0U2VhcmNoKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0UGFnaW5nKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlZnJlc2hRdWVyeSgpOwoJCQkJfQoJCQl9CgkJKTsKCgkJZnVuY3Rpb24gYnVpbGRGaWx0ZXJGbiggZSApIHsKCQkJdmFyIG9wcyA9IGZpbHRlci5vcHMsCgkJCQlieSA9IGZpbHRlci5ieSwKCQkJCXZhbHVlID0gZmlsdGVyLnZhbHVlLAoJCQkJcmVnZXg7CgoJCQlpZiAodmFsdWUpIHsKCgkJCQlpZiAoIW9wcykgewoJCQkJCS8vYnkgZGVmYXVsdCBpdCBzIGNvbnRhaW5zCgkJCQkJcmVnZXggPSBSZWdFeHAoIHZhbHVlLCAiaSIgKTsKCgkJCQl9IGVsc2UgaWYgKG9wcyA9PSAiZXF1YWxzIikgewoKCQkJCQlyZWdleCA9IFJlZ0V4cCggIl4iICsgdmFsdWUgKyAiJCIsICJpIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRocm93ICJvcGVyYXRvciBkb2VzIG5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJCWZpbHRlckZuID0gKGJ5KSA/CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZWdleC50ZXN0KCB0aGlzW2J5XSApOwoJCQkJCX0gOgoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoaXNPYmplY3QoIHRoaXMgKSkgewoJCQkJCQkJZm9yICh2YXIga2V5IGluIHRoaXMpIHsKCQkJCQkJCQlpZiAocmVnZXgudGVzdCggdGhpc1trZXldICkpIHsKCQkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoIHRoaXMgKTsKCQkJCQkJfQoJCQkJCX07CgoJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCB0cnVlICk7CgkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoZmlsdGVyRm4pIHsKCQkJCQlmaWx0ZXJGbiA9IG51bGw7CgkJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCBmYWxzZSApOwoJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCX0KCQkJfQoJCX0KCgkJZmlsdGVyTm9kZS5jZCggImJ5IiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCWZpbHRlck5vZGUuY2QoICJ2YWx1ZSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGJ1aWxkRmlsdGVyRm4gKTsKCQlmaWx0ZXJOb2RlLmNkKCAib3BzIiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCXJldHVybiB0aGlzOwoJfTsKCgliaW5kaW5ncyggewoKCQkvL2xpc3RWaWV3OmFycmF5UGF0aHxyb3dUZW1wbGF0ZUlkCgkJLy8KCQlsaXN0VmlldzogLy8KCgkJLy9zdWJzY3JpcHRpb24gZnJvbSB2aWV3CgkJCSJ0bXBsT25DaGFuZ2U6LjsiICsKCQkJCS8vcmVuZGVyIG5ld2x5IGFwcGVuZGVkIGRhdGEgaXRlbSBieSBhcHBlbmRpbmcgaXQgdG8gZW5kIG9mIHRoZSB2aWV3CgkJCSIhYWZ0ZXJDcmVhdGUuMToufCphZGRSb3dWaWV3OyIgKwoJCQkJLy9yZW5kZXIgdGhlIHVwZGF0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJVcGRhdGUuMToufCp1cGRhdGVSb3dWaWV3OyIgKwoJCQkJLy9kZWxldGUgdGhlIGRlbGV0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJEZWwuMToufCpyZW1vdmVSb3dWaWV3IiwKCgkJZW5hYmxlUXVlcnk6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlobSggcGF0aCApLmVuYWJsZVF1ZXJ5KCAhIW9wdGlvbnMgKTsKCQl9LAoKCQkvL3JlbmRlciB0aGUgd2hvbGUgbGlzdCBvZiBpdGVtcwoJCS8vcXVlcnlWaWV3Oml0ZW1zCgkJcXVlcnlWaWV3OiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeVJlc3VsdCIsCgoJCS8vc29ydDppdGVtc3xmaXJzdE5hbWUKCQlzb3J0UXVlcnk6ICIkY2xpY2s6KnF1ZXJ5LnNvcnQuYnl8KnNldFRvOyIgKwoJCSAgICAgICAgICAgICAgICAgIiRjbGljazoqcXVlcnkuc29ydC5hc2N8KnRvZ2dsZTsiICsKCQkgICAgICAgICAgICAgICAgICIkY2xpY2s6KnJlZnJlc2hRdWVyeSIsCgoJCS8vcmVzZXRTb3J0Oml0ZW1zCgkJcmVzZXRTb3J0OiAiJGNsaWNrOipyZXNldFNvcnQ7IiArCgkJICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuc29ydC5ieSIsCgoJCS8vc2VhcmNoOml0ZW1zCgkJc2VhcmNoOiAiJGNsaWNrOipyZWZyZXNoUXVlcnk7IiArCgkJICAgICAgICAgICAgICAiZW5hYmxlOipxdWVyeS5maWx0ZXIuZW5hYmxlZCIsCgoJCXJlc2V0U2VhcmNoOiAiJGNsaWNrOipyZXNldFNlYXJjaDsiICsKCQkgICAgICAgICAgICAgICAgICAgInNob3c6KnF1ZXJ5LmZpbHRlci5lbmFibGVkIiwKCgkJcmVzZXRRdWVyeTogIiRjbGljazoqcmVzZXRRdWVyeTsiICsKCQkgICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuZW5hYmxlZCIsCgoJCXNlYXJjaEJveDogIm5zOipxdWVyeS5maWx0ZXIudmFsdWU7IiArCgkJICAgICAgICAgICAidmFsOi58ZW50ZXI7IiArCgkJICAgICAgICAgICAiJGVzYzoufCpudWxsIiwKCgkJLy9wYWdlcjppdGVtc3wjcGFnZXJUZW1wbGF0ZQoJCXBhZ2VyOiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeS5wYWdlcjsiICsgLy9yZW5kZXIgcGFnZXIgdXNpbmcgdGhlIGRhdGEgdW5kZXIgaXRlbXMqcXVlcnkucGFnZXIKCQkgICAgICAgInNob3c6Kmhhc1F1ZXJ5UmVzdWx0fF87IiArCgkJICAgICAgICIkcGFnaW5nOipwYWdpbmc7IiArCgkJICAgICAgICJwcmV2ZW50RGVmYXVsdDouIiwKCgkJc2V0UGFnZTogInRydWU6KnF1ZXJ5LnBhZ2VyLmVuYWJsZWQ7IiArCgkJICAgICAgICAgICAgICAgImVuYWJsZToqcXVlcnkucGFnZXIuc2l6ZTsiICsKCQkgICAgICAgICAgICAgICAiJGNsaWNrOipyZWZyZXNoUXVlcnkiLAoKCQkvL3BhdGggaXMgaWdub3JlLCBkb2VzIG5vdCBjcmVhdGUgYW55IHN1YnNjcmlwdGlvbgoJCXBhZ2U6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBwYWdlSW5kZXggKSB7CgkJCWlmICghcGFnZUluZGV4KSB7CgkJCQl0aHJvdyAicGFnZUluZGV4IGlzIG1pc3NpbmciOwoJCQl9CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgInBhZ2luZyIsIHBhZ2VJbmRleCApOwoJCX0sCgoJCXNob3dGb3VuZDogInNob3c6Kmhhc1F1ZXJ5UmVzdWx0IiwKCgkJaGlkZUZvdW5kOiAiaGlkZToqaGFzUXVlcnlSZXN1bHQiCgl9ICk7CgoKCi8vCi8qCiA8QGRlcGVuZHM+CiBzdWJzY3JpcHRpb24uanMsCiBtb2RlbC5qcwogPC9AZGVwZW5kcz4KICovCgoKCS8vY3JlYXRlIGEgdGFibGUgd2l0aCBzb21lIHNlZWRzCglmdW5jdGlvbiBjcmVhdGVUYWJsZSggc2VlZHMgKSB7CgkJaWYgKGlzVW5kZWZpbmVkKCBzZWVkcyApKSB7CgkJCXNlZWRzID0gW107CgkJfSBlbHNlIGlmICghaXNBcnJheSggc2VlZHMgKSkgewoJCQlzZWVkcyA9IFtzZWVkc107CgkJfQoKCQlpZiAoc2VlZHMudGFibGUgJiYgc2VlZHMuZ3VpZCkgewoJCQlyZXR1cm4gc2VlZHM7CgkJfQoKCQlzZWVkcy50YWJsZSA9IHt9OwoJCXNlZWRzLmd1aWQgPSAwOwoJCXJldHVybiBzZWVkczsKCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVVcGRhdGVEZXNjZW5kYW50KCBlICkgewoKCQl2YXIgdGFibGUsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlpZiAoZS5sZXZlbCA9PT0gMSkgewoJCQl0YWJsZSA9IHB1Ymxpc2hlci5nZXQoKS50YWJsZTsKCgkJCS8vdGhlIGV2ZW50IGlzIGNhdXNlZCBieSB1cGRhdGluZyB0byB0aGUgYW4gaXRlbSBpZiB0aGUgYXJyYXkKCQkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCQlpZiAodGFibGVba2V5XSA9PSBlLnJlbW92ZWQpIHsKCQkJCQl0aGlzLnNldCgga2V5LCBlLnByb3Bvc2VkICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIGlmIChlLmxldmVsID49IDIpIHsKCgkJCXZhciBvcmlnaW5hbFBhdGggPSBlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgsCgkJCQlwYXRoID0gcHVibGlzaGVyLnBhdGgsCgkJCQlyZW1haW5pbmcgPSBvcmlnaW5hbFBhdGguc3Vic3RyKCBwYXRoLmxlbmd0aCArIDEgKSwKCQkJCWluZGV4ID0gcmVtYWluaW5nLnN1YnN0ciggMCwgcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQlpZiAoJC5pc051bWVyaWMoIGluZGV4ICkpIHsKCgoJCQkJLy9lLmcgY29udGFjdHMuMS5maXJzdE5hbWUgaXMgdXBkYXRlZAoJCQkJLy9pbmRleCA9PSAxCgkJCQkvL2l0ZW1LZXkgPSBjMQoKCQkJCXZhciBpdGVtS2V5ID0gcHVibGlzaGVyLmtleUF0KCBpbmRleCApLAoJCQkJCWZ1bGxQYXRoT2ZLZXlJdGVtID0gInRhYmxlLiIgKyBpdGVtS2V5ICsgcmVtYWluaW5nLnN1YnN0ciggcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQkJLy9zdWJQYXRoID09IHRhYmxlLmMxLmZpcnN0TmFtZQoJCQkJcHVibGlzaGVyLnRyaWdnZXIoIGZ1bGxQYXRoT2ZLZXlJdGVtLCAiYWZ0ZXJVcGRhdGUiLCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCggZSApIHsKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuZ2V0KCkuZ3VpZCsrLCBlLnByb3Bvc2VkICk7Cgl9CgoJZnVuY3Rpb24gaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQoIGUgKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5nZXQoKSwKCQkJcmVtb3ZlZCA9IGUucmVtb3ZlZDsKCgkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCWlmICh0YWJsZVtrZXldID09PSByZW1vdmVkKSB7CgkJCQl0aGlzLmRlbCgga2V5ICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVUYWJsZU5vZGVEZWxldGVDaGlsZCggZSApIHsKCQl0aGlzLnJlbW92ZUl0ZW0oIGUucmVtb3ZlZCApOwoJfQoKCWZ1bmN0aW9uIGhhbmRsZVRhYmxlTm9kZVVwZGF0ZUNoaWxkKCBlICkgewoJCXRoaXMucmVwbGFjZUl0ZW0oIGUucmVtb3ZlZCwgZS5wcm9wb3NlZCApOwoJfQoKCS8vCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CglobS5vbkFkZE9yVXBkYXRlTm9kZSggZnVuY3Rpb24oIGNvbnRleHQsIGluZGV4LCBhcnJheSApIHsKCgkJaWYgKCFpc0FycmF5KCBhcnJheSApKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0YWJsZSA9IGNyZWF0ZVRhYmxlKCBhcnJheSApLnRhYmxlOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCXRhYmxlW2FycmF5Lmd1aWQrK10gPSBhcnJheVtpXTsKCQl9CgoJCXZhciBhcnJheU5vZGUgPSBobSggY29udGV4dCApLmNkKCBpbmRleCApLAoJCQl0YWJsZU5vZGUgPSBhcnJheU5vZGUuY2QoICJ0YWJsZSIgKTsKCgkJLy93aGVuIGl0ZW0gaXMgaW5zZXJ0ZWQgaW4gYXJyYXksIGluc2VydCB0aGUgaXRlbSBpbiB0YWJsZQoJCXRhYmxlTm9kZS5zdWIoIGFycmF5Tm9kZSwgImFmdGVyQ3JlYXRlLjEiLCBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCApOwoKCQkvL3doZW4gaXRlbSBpcyB1cGRhdGVkIGluIGl0ZW1zTm9kZSwgdXBkYXRlIHRoZSBpdGVtIGluIHRhYmxlCgkJdGFibGVOb2RlLnN1YiggYXJyYXlOb2RlLCAiYWZ0ZXJVcGRhdGUuKiIsIGhhbmRsZUFycmF5Tm9kZVVwZGF0ZURlc2NlbmRhbnQgKTsKCgkJLy93aGVuIGl0ZW0gZGVsZXRlZCBpbiBhcnJheSwgZGVsZXRlIHRoZSBpdGVtIGluIGhhc2ggdGFibGUKCQl0YWJsZU5vZGUuc3ViKCBhcnJheU5vZGUsICJhZnRlckRlbC4xIiwgaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQgKTsKCgkJLy93aGVuIGl0ZW0gaXMgZGVsZXRlZCBpbiB0YWJsZSwgZGVsZXRlIHRoZSBpdGVtIGluIGFycmF5CgkJYXJyYXlOb2RlLnN1YiggdGFibGVOb2RlLCAiYWZ0ZXJEZWwuMSIsIGhhbmRsZVRhYmxlTm9kZURlbGV0ZUNoaWxkICk7CgoJCS8vd2hlbiBpdGVtIGlzIHVwZGF0ZWQgaW4gdGFibGUsIHVwZGF0ZSB0aGUgaXRlbSBpbiBhcnJheQoJCWFycmF5Tm9kZS5zdWIoIHRhYmxlTm9kZSwgImFmdGVyVXBkYXRlLjEiLCBoYW5kbGVUYWJsZU5vZGVVcGRhdGVDaGlsZCApOwoKCX0gKTsKCglobUZuLml0ZW1LZXkgPSBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIga2V5LAoJCQl0YWJsZSwKCQkJYXJyYXkgPSB0aGlzLnJhdygpOwoKCQlpZiAoaXNGdW5jdGlvbiggYXJyYXkgKSkgewoJCQlhcnJheSA9IHRoaXMubWFpbigpLmdldCgpOwoJCX0KCQl0YWJsZSA9IGFycmF5LnRhYmxlOwoKCQlpZiAodGFibGUpIHsKCQkJZm9yIChrZXkgaW4gdGFibGUpIHsKCQkJCWlmIChpdGVtID09PSB0YWJsZVtrZXldKSB7CgkJCQkJcmV0dXJuIGtleTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJaG1Gbi5rZXlBdCA9IGZ1bmN0aW9uKCBpbmRleCApIHsKCQlyZXR1cm4gdGhpcy5pdGVtS2V5KCB0aGlzLmdldCggaW5kZXggKSApOwoJfTsKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2F1Z21lbnQgalF1ZXJ5IEV2ZW50IHR5cGUKCS8vd2hlbiB5b3UgYXR0YWNoIGEgd29ya2Zsb3cgdG8gcGFyZW50IGVsZW1lbnQgdG8gaGFuZGxlIHRoZSBldmVudCBmcm9tIGNoaWxkcmVuCgkvL3dlIHdhbnQgdG8ga25vdyB0aGUgY2hpbGRyZW4gZWxlbWVudCdzIHJvdyBpbmRleCBvZiBhbGwgdGhlIHJvd3MKCSQuRXZlbnQucHJvdG90eXBlLnNlbGVjdGVkUm93SW5kZXggPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdWJsaXNoZXIuY2hpbGRyZW4oKS5maWx0ZXIoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGFyZW50cygpICkuaW5kZXgoKTsKCX07CgoJZnVuY3Rpb24gRWRpdE9iamVjdCggaW5kZXggKSB7CgkJdGhpcy5zZWxlY3RlZEluZGV4ID0gaW5kZXg7Cgl9CgoJRWRpdE9iamVjdC5wcm90b3R5cGUgPSB7CgkJaXRlbTogbnVsbCwKCQkvL2xvZ2ljYWxseSBtb2RlIGRlcGVuZHMgb24gIml0ZW0iIGFuZCAiaW5kZXgiCgkJLy9idXQgaGVyZSB3ZSBkaXNhYmxlIHRoZXNlIGRlcGVuZGVuY2llcywgYmVjYXVzZSB3ZSB3YW50IHRvCgkJLy9tYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudHMKCQkvL2lmIGl0IHJlYWxseSBkZXBlbmRzIHRoZW0sIHRoZSBldmVudHMgd2lsbCBiZSBoYXJkIHRvIGNvbnRyb2xsZWQKCQltb2RlOiBmdW5jdGlvbiBfXygpIHsKCQkJdmFyIGVkaXQgPSB0aGlzLmdldCgpLAoJCQkJaXRlbSA9IGVkaXQuaXRlbSwKCQkJCXNlbGVjdGVkSW5kZXggPSBlZGl0LnNlbGVjdGVkSW5kZXg7CgoJCQlyZXR1cm4gaXRlbSA9PT0gbnVsbCA/ICJyZWFkIiA6CgkJCQlpc1VuZGVmaW5lZCggc2VsZWN0ZWRJbmRleCApID8gInVwZGF0ZSIgOgoJCQkJCShzZWxlY3RlZEluZGV4ID09IC0xKSA/ICJuZXciIDoKCQkJCQkJInVwZGF0ZSI7CgoJCX0KCX07CgoJLy90aGUgZm9sbG93IG1ldGhvZHMgYXJlIGRlc2lnbmVkIHRvIGJlIHVzZWQgd2l0aCBhcnJheSBtb2RlbAoJLy8gdGhleSBhcmUgdXNlZCB0byBtYW5pcHVsYXRlIHRoZSBzaGFkb3cgZWRpdCBvYmplY3Qgb2YgYXJyYXkgbW9kZWwKCWV4dGVuZCggaG1GbiwgewoKCQkvL2luaXRTaGFkb3dFZGl0IGlzIHJlcXVpcmVkIGZvciBhcnJheSBtb2RlbCBvciBmb3IgYXJyYXkgcXVlcnkgZnVuY3Rpb25zCgkJLy9pdCBpcyBub3QgbmVjZXNzYXJ5IGZvciBtb2RlbCBvZiBvdGhlciB0eXBlCgkJaW5pdFNoYWRvd0VkaXQ6IGZ1bmN0aW9uKCBpdGVtVGVtcGxhdGUgKSB7CgkJCS8vaXQgaXMgYSBjb252ZW50aW9uIHRoYXQsIGlmIHRoZSBwYXRoIG9mIGxpc3QgZGF0YSBpcyBpdGVtcwoJCQkvL3dlIHRha2UgaXRlbXNfaXRlbVRlbXBsYXRlIGFzIHRlbXBsYXRlIGZyb20gbmV3IGl0ZW0gZm9yIHRoZSBsaXN0IGRhdGEKCgkJCXZhciBtb2RlbCA9IHRoaXM7CgoJCQlpZiAobW9kZWwuZ2V0KCAiKmVkaXQiICkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgaXRlbXNQYXRoID0gbW9kZWwucGF0aCwKCQkJCXJDaGlsZFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXipdK1xcKiQiICksCgkJCQlyRGVlcFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXFx3Ll0rXFwqZWRpdFxcLml0ZW0iICk7CgoJCQlpZiAoaXNVbmRlZmluZWQoIGl0ZW1UZW1wbGF0ZSApKSB7CgoJCQkJaWYgKG1vZGVsLmlzU2hhZG93KCkgJiYgIWlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkvL2lmIHRoZSBhcnJheSBvYmplY3QgaXRlbXMgaXMgYWxyZWFkeSBpbiBzaGFkb3cKCQkJCQkvL3RoZSBpdGVtVGVtcGxhdGUgaXMgYWxyZWFkeSBkZWZpbmVkIGluIG1haW4gaXRlbXMnIGl0ZW1UZW1wbGF0ZQoJCQkJCS8vZm9yIGV4YW1wbGUKCQkJCQkvL3RoZSBpdGVtc1BhdGggaXMgImRvYy5lbnRyaWVzKmVkaXQuaXRlbS5wZXJzb25hbC5zaWduYXR1cmVzIgoJCQkJCS8vdGhlIGl0ZW1UZW1wbGF0ZSBpcyBkZWZpbmVkIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0ucGVyc29uYWwuc2lnbmF0dXJlcy4wIgoJCQkJCS8vdGhlIGZvbGxvd2luZyBpcyB0cnkgdG8gZ2V0IHRoZSBpdGVtVGVtcGxhdGUKCQkJCQkvLwoJCQkJCS8vdGhlIG1haW5Nb2RlbCBpcyBkb2MuZW50cmllcwoJCQkJCXZhciBtYWluTW9kZWwgPSBtb2RlbC5tYWluKCk7CgoJCQkJCS8vdGhlIGVkaXRpbmdNb2RlbFBhdGggb2YgbWFpbk1vZGVsIGlzIGRvYy5lbnRyaWVzKmVkaXQuaXRlbQoJCQkJCXZhciBlZGl0aW5nTW9kZWxQYXRoID0gbWFpbk1vZGVsLmxvZ2ljYWxQYXRoKCkgKyAiKmVkaXQuaXRlbSI7CgoJCQkJCS8vdGhlIHBvc2l0aW9uIG9mIGxhc3QgIi4iIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0uIgoJCQkJCXZhciBzdGFydEluZGV4ID0gZWRpdGluZ01vZGVsUGF0aC5sZW5ndGggKyAxOwoKCQkJCQkvL3RoZSBwb3J0aW9uIG9mICJwZXJzb25hbC5zaWduYXR1cmVzIiBpbiAiZG9jLmVudHJpZXMqZWRpdC5pdGVtLnBlcnNvbmFsLnNpZ25hdHVyZXMiCgkJCQkJdmFyIHN1YlBhdGggPSB0b0xvZ2ljYWxQYXRoKCBpdGVtc1BhdGggKS5zdWJzdHIoIHN0YXJ0SW5kZXggKTsKCgkJCQkJLy9nZXQgImRvYy5lbnRyaWVzKmVkaXQuaXRlbVRlbXBsYXRlLnBlcnNvbmFsLnNpZ25hdHVyZXMuMCIKCQkJCQlpdGVtVGVtcGxhdGUgPSBjbG9uZSggbWFpbk1vZGVsLmdldCggIiplZGl0Lml0ZW1UZW1wbGF0ZS4iICsgc3ViUGF0aCArICIuMCIgKSwgdHJ1ZSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGNvbnZlbnRpb24gaXMgdGhhdCBpZiB3ZSBoYXZlIG1vZGVsIGF0IHBhdGggImNvbnRhY3RzIiwKCQkJCQkvL3RoZSB0ZW1wbGF0ZSBpdGVtIGlzIGV4cGVjdGVkIGF0ICJjb250YWN0c19pdGVtVGVtcGxhdGUiCgkJCQkJaWYgKGlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkJaXRlbVRlbXBsYXRlID0gcm9vdE5vZGUucmF3KCBtb2RlbC5tYWluKCkucGF0aCArICJfaXRlbVRlbXBsYXRlIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWl0ZW1UZW1wbGF0ZSA9IHJvb3ROb2RlLnJhdyggaXRlbXNQYXRoICsgIl9pdGVtVGVtcGxhdGUiICk7CgkJCQkJfQoKCQkJCQkvL2lmIGNvbnZlbnRpb24gaXMgbm90IGZvbGxvd2VkLCB1c2UgdGhlIGV4aXN0aW5nIGFzIHRlbXBsYXRlCgkJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtVGVtcGxhdGUgKSkgewoJCQkJCQlpdGVtVGVtcGxhdGUgPSBjbGVhck9iaiggY2xvbmUoIG1vZGVsLmdldCgpWzBdLCB0cnVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXZhciBlZGl0T2JqZWN0ID0gbmV3IEVkaXRPYmplY3QoIC0xICk7CgkJCWVkaXRPYmplY3QuaXRlbVRlbXBsYXRlID0gaXRlbVRlbXBsYXRlOwoJCQllZGl0T2JqZWN0Lml0ZW0gPSBudWxsOwoKCQkJbW9kZWwuc2V0KCAiKmVkaXQiLCBlZGl0T2JqZWN0ICk7CgoJCQkvL3dlIHdhbnQgdG8gdHJpZ2dlciBiZWdpbkluUm93VXBkYXRlL2NhbmNlbEluUm93VXBkYXRlIGFmdGVyIHNlbGVjdGVkSW5kZXggaGFzIGNoYW5nZWQKCQkJLy9iZWNhdXNlIHRoZSBoYW5kbGVycyBkZXBlbmRzIG9uIHRoZSBhdmFpbGFiaWxpdHkgb2Ygc2VsZWN0ZWRJbmRleAoJCQltb2RlbC5jZCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICkuaGFuZGxlKCAiYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbmV3SW5kZXggPSBlLnByb3Bvc2VkLAoJCQkJCW9sZEluZGV4ID0gZS5yZW1vdmVkOwoKCQkJCWlmIChuZXdJbmRleCA+PSAwKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJiZWdpbkluUm93VXBkYXRlIiwgbmV3SW5kZXggKTsKCgkJCQl9IGVsc2UgaWYgKG5ld0luZGV4ID09IC0xKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJjYW5jZWxJblJvd1VwZGF0ZSIsIG9sZEluZGV4ICk7CgkJCQl9CgkJCX0gKTsKCgkJCW1vZGVsLmNkKCAiKmVkaXQuaXRlbSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGtleSwgbG9naWNhbFBhdGgsIGVkaXRPYmplY3Q7CgoJCQkJZm9yIChrZXkgaW4gc2hhZG93Um9vdCkgewoKCQkJCQlsb2dpY2FsUGF0aCA9IHV0aWwudG9Mb2dpY2FsUGF0aCggIl9faG0uIiArIGtleSApOwoKCQkJCQlpZiAockRlZXBTaGFkb3dJdGVtLnRlc3QoIGxvZ2ljYWxQYXRoICkpIHsKCgkJCQkJCWRlbGV0ZSBzaGFkb3dSb290W2tleV07CgoJCQkJCX0gZWxzZSBpZiAockNoaWxkU2hhZG93SXRlbS50ZXN0KCBsb2dpY2FsUGF0aCApKSB7CgoJCQkJCQllZGl0T2JqZWN0ID0gc2hhZG93Um9vdFtrZXldLmVkaXQ7CgoJCQkJCQlpZiAoZWRpdE9iamVjdCkgewoJCQkJCQkJZWRpdE9iamVjdC5pdGVtID0gbnVsbDsKCQkJCQkJCWVkaXRPYmplY3Quc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vY3JlYXRlIGEgbmV3IGl0ZW0gaW4gc2hhZG93IGVkaXQgb2JqZWN0IGZvciBpdGVtcyBtb2RlbAoJCS8vbm90IG5lY2Vzc2FyeSBmb3IgbW9kZWwgb2YgcHJpbWl0aXZlIHR5cGUgYW5kIG9iamVjdHMKCQluZXdTaGFkb3dJdGVtOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPT0gInJlYWQiKSB7CgkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgZWRpdFNoYWRvd01vZGVsID0gdGhpcy5jZCggIiplZGl0IiApLAoJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCWl0ZW0gPSAoaXNGdW5jdGlvbiggaXRlbVRlbXBsYXRlICkpID8KCQkJCQlpdGVtVGVtcGxhdGUoKSA6CgkJCQkJY2xvbmUoIGl0ZW1UZW1wbGF0ZSwgdHJ1ZSApOwoKCQkJZWRpdFNoYWRvd01vZGVsLnVwZGF0ZSggIml0ZW0iLCBpdGVtICk7CgkJCWVkaXRTaGFkb3dNb2RlbC5jaGFuZ2UoICJtb2RlIiApOwoJCX0sCgoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggaXRlbSwgaXRlbUluZGV4ICkgewoKCQkJdmFyIGl0ZW1WYWx1ZSA9IHRoaXMucmF3KCk7CgkJCWlmIChpc1ByaW1pdGl2ZSggaXRlbVZhbHVlICkgfHwgaXNPYmplY3QoIGl0ZW1WYWx1ZSApKSB7CgoJCQkJdmFyIGVkaXQgPSB0aGlzLmdldCggIiplZGl0IiApOwoJCQkJaWYgKGlzVW5kZWZpbmVkKCBlZGl0ICkpIHsKCQkJCQllZGl0ID0gbmV3IEVkaXRPYmplY3QoKTsKCQkJCQl0aGlzLnNldCggIiplZGl0IiwgZWRpdCApOwoJCQkJfQoKCQkJCWlmIChlZGl0Lml0ZW0gIT09IG51bGwpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgY2xvbmUoIGl0ZW1WYWx1ZSwgdHJ1ZSApICk7CgkJCQl0aGlzLmNoYW5nZSggIiplZGl0Lm1vZGUiICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLmdldCggIiplZGl0Lm1vZGUiICkgIT09ICJyZWFkIikgewoJCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCQl9CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtSW5kZXggKSkgewoJCQkJCWl0ZW1JbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdGhpcy5nZXQoKVtpdGVtSW5kZXhdOwoJCQkJfQoKCQkJCXZhciBlZGl0U2hhZG93TW9kZWwgPSB0aGlzLmNkKCAiKmVkaXQiICksCgkJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCQljb3B5ID0gKGlzRnVuY3Rpb24oIGl0ZW1UZW1wbGF0ZSApKSA/CgkJCQkJCWl0ZW1UZW1wbGF0ZSggaXRlbSApIDoKCQkJCQkJY2xvbmUoIGl0ZW0sIHRydWUgKTsKCgkJCQllZGl0U2hhZG93TW9kZWwudXBkYXRlKCAiaXRlbSIsIGNvcHkgKQoJCQkJCS51cGRhdGUoICJzZWxlY3RlZEluZGV4IiwgaXRlbUluZGV4ICk7CgoJCQkJZWRpdFNoYWRvd01vZGVsLmNoYW5nZSggIm1vZGUiICk7CgkJCX0KCgkJfSwKCgkJcmVzZXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggc2F2ZSApIHsKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5yZXNldFNoYWRvd0l0ZW0oKTsKCQkJfQoKCQkJdmFyIGl0ZW1zID0gdGhpcy5yYXcoKTsKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgbnVsbCApOwoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgZWRpdCA9IHRoaXMuY2QoICIqZWRpdCIgKTsKCQkJCWlmICghaXNVbmRlZmluZWQoIGVkaXQuZ2V0KCkgKSkgewoKCQkJCQllZGl0LnVwZGF0ZSggIml0ZW0iLCBudWxsICk7CgoJCQkJCWlmIChzYXZlKSB7CgkJCQkJCS8vaWYgaXQgdHJpZ2dlcmVkIGJ5IHNhdmVTaGFkb3dJdGVtCgkJCQkJCS8vdXBkYXRlIHNlbGVjdGVkSW5kZXggZGlyZWN0bHkgdG8gYXZvaWQgZXZlbnRzCgkJCQkJCWVkaXQuZ2V0KCkuc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWVkaXQudXBkYXRlKCAic2VsZWN0ZWRJbmRleCIsIC0xICk7CgkJCQkJfQoKCQkJCQllZGl0LmNoYW5nZSggIm1vZGUiICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJc2F2ZVNoYWRvd0l0ZW06IGZ1bmN0aW9uKCkgewoKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5zYXZlU2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgaXRlbXMgPSB0aGlzLnJhdygpOwoKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoIHRoaXMuZ2V0KCAiKmVkaXQuaXRlbSIgKSApCgkJCQkJLnNldCggIiplZGl0Lml0ZW0iLCBudWxsICk7CgoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgY3VycmVudEVkaXRNb2RlID0gdGhpcy5nZXQoICIqZWRpdC5tb2RlIiApLAoJCQkJCXBlbmRpbmdJdGVtID0gdGhpcy5nZXQoICIqZWRpdC5pdGVtIiApOwoKCQkJCWlmIChjdXJyZW50RWRpdE1vZGUgPT0gInJlYWQiKSB7CgoJCQkJCXRocm93ICJpbnZhbGlkIG9wZXJhdGlvbnMiOwoKCQkJCX0gZWxzZSBpZiAoY3VycmVudEVkaXRNb2RlID09ICJuZXciKSB7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJdGhpcy5tYWluKCkucHVzaCggcGVuZGluZ0l0ZW0gKTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5wdXNoKCBwZW5kaW5nSXRlbSApOwoJCQkJCX0KCgkJCQkJdGhpcy5yZXNldFNoYWRvd0l0ZW0oKTsKCgkJCQl9IGVsc2UgLyppZiAoY3VycmVudEVkaXRNb2RlID09ICJ1cGRhdGUiKSovIHsKCgkJCQkJdmFyIHNlbGVjdGVkSW5kZXggPSB0aGlzLmdldCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICk7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoJCQkJCQl0aGlzLm1haW4oKS5yZXBsYWNlSXRlbSgKCQkJCQkJCWl0ZW1zW3NlbGVjdGVkSW5kZXhdLAoJCQkJCQkJcGVuZGluZ0l0ZW0KCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlcGxhY2VJdGVtKAoJCQkJCQkJaXRlbXNbc2VsZWN0ZWRJbmRleF0sCgkJCQkJCQlwZW5kaW5nSXRlbQoJCQkJCQkpOwoJCQkJCX0KCQkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSggdHJ1ZSApOwoJCQkJfQoKCQkJfQoJCX0KCX0gKTsKCglobS53b3JrZmxvdyggewoKCQkvLy0tLS0tLXdvcmtmbG93cyB0aGF0IG1vZGlmeSBtb2RlbC0tLS0tLQoKCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdHwqZWRpdFNoYWRvd0l0ZW0KCQluZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgoJCS8vJGNsaWNrOml0ZW18KmVkaXRTaGFkb3dJdGVtCgkJLy8kZWRpdFJvdzppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRlZGl0Um93Oml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKGUudHlwZSA9PSAiZWRpdFJvdyIpIHsKCQkJCS8vdGhpcyB0cmlnZ2VyIGJ5IGVkaXQgYnV0dG9uCgkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCBudWxsLCBlLnNlbGVjdGVkUm93SW5kZXgoKSApOwoJCQl9IGVsc2UgewoJCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCQl0aGlzLm1haW4oKS5lZGl0U2hhZG93SXRlbSggdGhpcy5nZXQoKSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCk7CgkJCQl9CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyIkZGVsZXRlOml0ZW1zfCpyZW1vdmVJdGVtOyIKCQkvLyIkZGVsZXRlOml0ZW1zKnF1ZXJ5UmVzdWx0fCpyZW1vdmVJdGVtOyIKCQlyZW1vdmVJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPSAicmVhZCIpIHsKCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCX0KCQkJdmFyIGluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXZhciBpdGVtcyA9IHRoaXMucmF3KCk7CgkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkvL3RoaXMgaXMgY2FzZSB3aGVuIGl0ZW1zIGlzIG1vZGVsKnF1ZXJ5UmVzdWx0CgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgkJCQl0aGlzLm1haW4oKS5yZW1vdmVJdGVtKCBpdGVtc1tpbmRleF0gKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQXQoIGluZGV4ICk7CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZVVwSXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBzZWxlY3RlZEluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXRoaXMubW92ZSggc2VsZWN0ZWRJbmRleCwgc2VsZWN0ZWRJbmRleCAtIDEgKTsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZURvd25JdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkSW5kZXggPSBlLnNlbGVjdGVkUm93SW5kZXgoKTsKCQkJdGhpcy5tb3ZlKCBzZWxlY3RlZEluZGV4LCBzZWxlY3RlZEluZGV4ICsgMSApOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vLS0tLS0td29ya2Zsb3dzIHRoYXQgbW9kaWZ5IHZpZXdzLS0tLS0tCgoJCS8vIWFmdGVyVXBkYXRlOml0ZW1zKmVkaXQubW9kZXwqcmVuZGVyTmV3VmlldzsKCQkvLyFhZnRlclVwZGF0ZTppdGVtcypxdWVyeVJlc3VsdCplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7CgkJcmVuZGVyTmV3VmlldzogbmV3VGVtcGxhdGVIYW5kbGVyKAoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSAibmV3IikgewoJCQkJCXJldHVybiBlLnB1Ymxpc2hlci5tYWluKCkuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJCX0KCQkJfQoJCQkvKnNldCBhY3Rpdml0eSBpcyBieSBkZWZhdWx0IGh0bWwqLwoKCQkpLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCXJlbmRlclVwZGF0ZVJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCQkJLy9nZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlyZXR1cm4gZS5wdWJsaXNoZXIuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJfSwKCQkJLy9zZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy9lLnByb3Bvc2VkIGlzIHRoZSBpbmRleCBvZiB0aGUgZWRpdCBpdGVtCgkJCQl0aGlzLmNoaWxkcmVuKCkuZXEoIGUucHJvcG9zZWQgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCWRlc3Ryb3lVcGRhdGVSb3dWaWV3OiBmdW5jdGlvbiggZSApIHsKCQkJZS5wdWJsaXNoZXIuY2hhbmdlKCBlLnByb3Bvc2VkICk7CgkJfSwKCgkJLy8kY2xpY2s6aXRlbXMqZWRpdC5pdGVtfCpzYXZlU2hhZG93SXRlbTsKCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdCplZGl0Lml0ZW18KnNhdmVTaGFkb3dJdGVtOwoJCXNhdmVTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpcy5zYXZlU2hhZG93SXRlbSgpOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vJGNsaWNrOml0ZW1zKmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCXJlc2V0U2hhZG93SXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSApOwoKCWJpbmRpbmdzKCB7CgoKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zfHJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0fHJvd1RlbXBsYXRlSWQKCQlzaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkgICAgICAgICAgICAiZGVsZXRlUm93Oi47IiArCgkJICAgICAgICAgICAgIiRlZGl0Um93Oi58KmVkaXRTaGFkb3dJdGVtIiwKCgkJLy8gc2hhZG93RWRpdEluUm93Oml0ZW1zfHVwZGF0ZVJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0SW5Sb3c6aXRlbXMqcXVlcnlSZXN1bHR8dXBkYXRlUm93VGVtcGxhdGVJZAoJCXNoYWRvd0VkaXRJblJvdzogInNoYWRvd0VkaXQ6LjsiICsKCQkgICAgICAgICAgICAgICAgICIhYmVnaW5JblJvd1VwZGF0ZToufCpyZW5kZXJVcGRhdGVSb3dWaWV3OyIgKwoJCSAgICAgICAgICAgICAgICAgIiFjYW5jZWxJblJvd1VwZGF0ZToufCpkZXN0cm95VXBkYXRlUm93VmlldyIsCgoJCWRlbGV0ZVJvdzogIiRkZWxldGVSb3c6LnwqY29uZmlybXxfRG8geW91IHdhbnQgdG8gZGVsZXRlIHRoaXMgaXRlbT87IiArCgkJICAgICAgICAgICAiJGRlbGV0ZVJvdzoufCpyZW1vdmVJdGVtOyIsCgkJLy9tb3ZhYmxlUm93Oml0ZW1zCgkJbW92YWJsZVJvdzogIiRtb3ZlVXA6LnwqbW92ZVVwSXRlbTsiICsKCQkgICAgICAgICAgICAiJG1vdmVEb3duOi58Km1vdmVEb3duSXRlbTsiLAoKCQkvL25ld0l0ZW1WaWV3Oml0ZW1zCgkJLy9uZXdJdGVtVmlldzppdGVtcypxdWVyeVJlc3VsdAoJCW5ld0l0ZW1WaWV3OiAiIWFmdGVyVXBkYXRlOiplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7IiArCgkJICAgICAgICAgICAgICJzaG93T25OZXc6LiIsCgoJCS8vc2hvd09uTmV3Oml0ZW1zCgkJLy9zaG93T25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQlzaG93T25OZXc6ICJzaG93OiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vaGlkZU9uTmV3Oml0ZW1zCgkJLy9oaWRlT25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQloaWRlT25OZXc6ICJoaWRlOiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vZWRpdEl0ZW1WaWV3Oml0ZW1zCgkJLy9lZGl0SXRlbVZpZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQllZGl0SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6KmVkaXQuaXRlbTsiICsKCQkgICAgICAgICAgICAgICJzaG93T25FZGl0Oi4iLAoKCQlkaXNwbGF5SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6LjtoaWRlT25FZGl0Oi4iLAoKCQkvL3Nob3dPbkVkaXQ6aXRlbXMKCQkvL3Nob3dPbkVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQKCQkvL3Nob3dPbkVkaXQ6ICJoaWRlOiplZGl0Lm1vZGV8X3JlYWQiLAoJCXNob3dPbkVkaXQ6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCArICIqZWRpdC5tb2RlIiwgImluaXQgYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBtb2RlID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQl0aGlzWyhpc1VuZGVmaW5lZCggbW9kZSApIHx8IG1vZGUgPT0gInJlYWQiKSA/ICJoaWRlIiA6ICJzaG93Il0oKTsKCQkJfSApOwoJCX0sCgoJCS8vaGlkZU9uRWRpdDppdGVtcwoJCS8vaGlkZU9uRWRpdDppdGVtcypxdWVyeVJlc3VsdAoJCS8vaGlkZU9uRWRpdDogInNob3c6KmVkaXQubW9kZXxfcmVhZCIsCgkJaGlkZU9uRWRpdDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJCWNvbnRleHQuYXBwZW5kU3ViKCBlbGVtLCBwYXRoICsgIiplZGl0Lm1vZGUiLCAiaW5pdCBhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIG1vZGUgPSBlLnB1Ymxpc2hlci5nZXQoKTsKCQkJCXRoaXNbKGlzVW5kZWZpbmVkKCBtb2RlICkgfHwgbW9kZSA9PSAicmVhZCIpID8gInNob3ciIDogImhpZGUiXSgpOwoJCQl9ICk7CgkJfSwKCgkJLy9uZXdJdGVtOml0ZW1zCgkJLy9uZXdJdGVtOml0ZW1zKnF1ZXJ5UmVzdWx0CgkJbmV3SXRlbTogIiRjbGljazoufCpuZXdTaGFkb3dJdGVtOyIgKwoJCSAgICAgICAgICJoaWRlT25OZXc6LiIsCgoJCS8vZWRpdEJ1dHRvbjppdGVtCgkJLy90aGlzIGlzIG9ubHkgdXNlZCBub24tYXJyYXkgaXRlbSBlZGl0CgkJZWRpdE9iamVjdDogIiRjbGljazoufCplZGl0U2hhZG93SXRlbTtoaWRlT25FZGl0Oi4iLAoKCQkvL3NhdmVFZGl0Oml0ZW1zKmVkaXQuaXRlbQoJCS8vc2F2ZUVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQqZWRpdC5pdGVtCgkJc2F2ZUVkaXQ6ICIkY2xpY2s6Lnwqc2F2ZVNoYWRvd0l0ZW0iLAoKCQkvL2NhbmNlbEVkaXQ6aXRlbXMqZWRpdC5pdGVtCgkJLy9jYW5jZWxFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbQoJCWNhbmNlbEVkaXQ6ICIkY2xpY2s6LnwqcmVzZXRTaGFkb3dJdGVtIgoKCX0gKTsKCglobS5uZXdKcUV2ZW50KCB7CgoJCWVkaXRSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJlZGl0Um93IiApOwoJCX1dLAoKCQlkZWxldGVSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJkZWxldGVSb3ciICk7CgoJCX1dLAoKCQltb3ZlVXA6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJtb3ZlVXAiICk7CgkJfV0sCgoJCW1vdmVEb3duOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiAkKCBlLnRhcmdldCApLmhhc0NsYXNzKCAibW92ZURvd24iICk7CgkJfV0KCX0gKTsKCi8vCgoKICAgIGRlZmF1bHRPcHRpb25zLmhhc2hQcmVmaXggPSAiISI7CiAgICBkZWZhdWx0T3B0aW9ucy5yb3V0ZVByZWZpeCA9ICIvIjsKCiAgICB2YXIgbGlzdE9mUm91dGVTZWdtZW50cyA9IFtdLAoKICAgICAgICBkZWZhdWx0Um91dGVTZWdtZW50cywKCiAgICAgICAgaW5pdGlhbFJvdXRlTWF0Y2hlZEJ5UGF0dGVybnMsCgogICAgICAgIHJQbHVzID0gL1wrL2csCgogICAgICAgIHJMZWZ0U3F1YXJlQnJhY2tldCA9IC9cWy8sCgogICAgICAgIHJSaWdodFNxdWFyZUJyYWNrZXQgPSAvXF0kLywKCiAgICAgICAgclJpZ2h0U3F1YXJlQnJhY2tldEVuZCA9IC9cXSQvLAoKICAgICAgICByU2VnbWVudFN0cmluZyA9IC9eKFteP10qKShcPy4qKT8kLywKCiAgICAgICAgclF1ZXJ5U3RyaW5nID0gL15bXj9dKlw/KC4qKSQvLAoKICAgICAgICByU3RhcnRIYXNoLAogICAgLy90aGUgcGF0aCBvZiBtb2RlbCB3aGljaCBpcyB0cmFja2VkIGluIHF1ZXJ5IHN0cmluZwogICAgICAgIHBhcmFtUGF0aHMgPSBbXTsKCiAgICAvL2NvbnZlcnQgYSBwYXJhbSBzdHJpbmcgaW50byBhbiBvYmplY3QKICAgIGZ1bmN0aW9uIGRlcGFyYW0ocGFyYW1TdHJpbmcsIGNvZXJjZSkgewoKICAgICAgICB2YXIgb2JqID0ge30sCiAgICAgICAgICAgIGNvZXJjZV90eXBlcyA9IHsgJ3RydWUnOiB0cnVlLCAnZmFsc2UnOiB0cnVlLCAnbnVsbCc6IG51bGwgfTsKCiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGFsbCBuYW1lPXZhbHVlIHBhaXJzLgogICAgICAgICQuZWFjaChwYXJhbVN0cmluZy5yZXBsYWNlKHJQbHVzLCAnICcpLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhcmFtID0gdmFsdWUuc3BsaXQoJz0nKSwKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVswXSksCiAgICAgICAgICAgICAgICB2YWwsCiAgICAgICAgICAgICAgICBjdXIgPSBvYmosCiAgICAgICAgICAgICAgICBpID0gMCwKCiAgICAgICAgICAgIC8vIElmIGtleSBpcyBtb3JlIGNvbXBsZXggdGhhbiAnZm9vJywgbGlrZSAnYVtdJyBvciAnYVtiXVtjXScsIHNwbGl0IGl0CiAgICAgICAgICAgIC8vIGludG8gaXRzIGNvbXBvbmVudCBwYXJ0cy4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXkuc3BsaXQoJ11bJyksCiAgICAgICAgICAgICAgICBrZXlzX2xhc3QgPSBrZXlzLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAvLyBJZiB0aGUgZmlyc3Qga2V5cyBwYXJ0IGNvbnRhaW5zIFsgYW5kIHRoZSBsYXN0IGVuZHMgd2l0aCBdLCB0aGVuIFtdCiAgICAgICAgICAgIC8vIGFyZSBjb3JyZWN0bHkgYmFsYW5jZWQuCiAgICAgICAgICAgIGlmIChyTGVmdFNxdWFyZUJyYWNrZXQudGVzdChrZXlzWzBdKSAmJiByUmlnaHRTcXVhcmVCcmFja2V0LnRlc3Qoa2V5c1sga2V5c19sYXN0IF0pKSB7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSB0cmFpbGluZyBdIGZyb20gdGhlIGxhc3Qga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAga2V5c1sga2V5c19sYXN0IF0gPSBrZXlzWyBrZXlzX2xhc3QgXS5yZXBsYWNlKHJSaWdodFNxdWFyZUJyYWNrZXRFbmQsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBTcGxpdCBmaXJzdCBrZXlzIHBhcnQgaW50byB0d28gcGFydHMgb24gdGhlIFsgYW5kIGFkZCB0aGVtIGJhY2sgb250bwogICAgICAgICAgICAgICAgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUga2V5cyBhcnJheS4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNoaWZ0KCkuc3BsaXQoJ1snKS5jb25jYXQoa2V5cyk7CgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0ga2V5cy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFzaWMgJ2Zvbycgc3R5bGUga2V5LgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBhIG5hbWU9dmFsdWUgcGFpciwgb3IganVzdCBhIG5hbWU/CiAgICAgICAgICAgIGlmIChwYXJhbS5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgICAgIHZhbCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVsxXSk7CgogICAgICAgICAgICAgICAgLy8gQ29lcmNlIHZhbHVlcy4KICAgICAgICAgICAgICAgIGlmIChjb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWwgJiYgIWlzTmFOKHZhbCkgPyArdmFsICAgICAgICAgICAgICAvLyBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWwgPT09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkICAgICAgICAgLy8gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29lcmNlX3R5cGVzW3ZhbF0gIT09IHVuZGVmaW5lZCA/IGNvZXJjZV90eXBlc1t2YWxdIC8vIHRydWUsIGZhbHNlLCBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChrZXlzX2xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb21wbGV4IGtleSwgYnVpbGQgZGVlcCBvYmplY3Qgc3RydWN0dXJlIGJhc2VkIG9uIGEgZmV3IHJ1bGVzOgogICAgICAgICAgICAgICAgICAgIC8vICogVGhlICdjdXInIHBvaW50ZXIgc3RhcnRzIGF0IHRoZSBvYmplY3QgdG9wLWxldmVsLgogICAgICAgICAgICAgICAgICAgIC8vICogW10gPSBhcnJheSBwdXNoIChuIGlzIHNldCB0byBhcnJheSBsZW5ndGgpLCBbbl0gPSBhcnJheSBpZiBuIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gICBudW1lcmljLCBvdGhlcndpc2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgIC8vICogSWYgYXQgdGhlIGxhc3Qga2V5cyBwYXJ0LCBzZXQgdGhlIHZhbHVlLgogICAgICAgICAgICAgICAgICAgIC8vICogRm9yIGVhY2gga2V5cyBwYXJ0LCBpZiB0aGUgY3VycmVudCBsZXZlbCBpcyB1bmRlZmluZWQgY3JlYXRlIGFuCiAgICAgICAgICAgICAgICAgICAgLy8gICBvYmplY3Qgb3IgYXJyYXkgYmFzZWQgb24gdGhlIHR5cGUgb2YgdGhlIG5leHQga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAgICAgIC8vICogTW92ZSB0aGUgJ2N1cicgcG9pbnRlciB0byB0aGUgbmV4dCBsZXZlbC4KICAgICAgICAgICAgICAgICAgICAvLyAqIFJpbnNlICYgcmVwZWF0LgogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDw9IGtleXNfbGFzdDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGtleXNbaV0gPT09ICcnID8gY3VyLmxlbmd0aCA6IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1cltrZXldID0gaSA8IGtleXNfbGFzdCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJba2V5XSB8fCAoIGtleXNbaSArIDFdICYmIGlzTmFOKGtleXNbaSArIDFdKSA/IHt9IDogW10gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGtleSwgZXZlbiBzaW1wbGVyIHJ1bGVzLCBzaW5jZSBvbmx5IHNjYWxhcnMgYW5kIHNoYWxsb3cKICAgICAgICAgICAgICAgICAgICAvLyBhcnJheXMgYXJlIGFsbG93ZWQuCgogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYWxyZWFkeSBhbiBhcnJheSwgc28gcHVzaCBvbiB0aGUgbmV4dCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9ialtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsIGlzbid0IGFuIGFycmF5LCBidXQgc2luY2UgYSBzZWNvbmQgdmFsdWUgaGFzIGJlZW4gc3BlY2lmaWVkLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHZhbCBpbnRvIGFuIGFycmF5LgogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFsgb2JqW2tleV0sIHZhbCBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAvLyBObyB2YWx1ZSB3YXMgZGVmaW5lZCwgc28gc2V0IHNvbWV0aGluZyBtZWFuaW5nZnVsLgogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBjb2VyY2UgPyB1bmRlZmluZWQgOiAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAgclN0YXJ0SGFzaCA9IHJTdGFydEhhc2ggfHwgbmV3IFJlZ0V4cCgiXiMiICsgZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4KTsKICAgICAgICByZXR1cm4gbG9jYXRpb24uaGFzaC5yZXBsYWNlKHJTdGFydEhhc2gsICIiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50UGF0aCgpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByU2VnbWVudFN0cmluZy5leGVjKGhhc2gpOwogICAgICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRRdWVyeVN0cmluZygpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByUXVlcnlTdHJpbmcuZXhlYyhoYXNoKTsKICAgICAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICB9CgogICAgLy9nZXQgc3RhdGUgZnJvbSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVF1ZXJ5U3RyaW5nKCkgewogICAgICAgIHJldHVybiBkZXBhcmFtKGdldFF1ZXJ5U3RyaW5nKCkpOwogICAgfQoKICAgIC8vaGFuZGxlciBmb3IgbW9kZWwgY2hhbmdlCiAgICAvL3RoaXMgbW9kZWwgaXMgdHJhY2tlZCBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAvL3doZW4gbW9kZWwgY2hhbmdlIHdlIHdhbnQgdG8gdXBkYXRlIHRoZSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIHVwZGF0ZVF1ZXJ5U3RyaW5nT25Nb2RlbENoYW5nZShlKSB7CgogICAgICAgIHZhciBxdWVyaWVkUGF0aCA9IHRvTG9naWNhbFBhdGgoZS5wdWJsaXNoZXIucGF0aCksCiAgICAgICAgICAgIG1vZGVsID0ge307CgogICAgICAgIG1vZGVsW3F1ZXJpZWRQYXRoXSA9IHJvb3ROb2RlLmdldChxdWVyaWVkUGF0aCk7CgogICAgICAgIC8vYnVpbGQgdGhlIGhhc2ggc3RyaW5nCiAgICAgICAgLy8xLmNhbGwgZ2V0U3RhZ2VGcm9tUXVlcnlTdHJpbmcKICAgICAgICAvLzIubWVyZ2UgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyB3aXRoIHRoZSBzdGF0ZQogICAgICAgIC8vMy5jb252ZXJ0IHRoZSBtZXJnZWQgb2JqZWN0IGludG8gcXVlcnkgc3RyaW5nCiAgICAgICAgLy80LiByZXBsYWNlIGhhc2gncyBxdWVyeSBzdHJpbmcgd2l0aCB0aGUgbmV3IHF1ZXJ5IHN0cmluZwogICAgICAgIHZhciBxdWVyeVN0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICAgICAgdmFyIGV4aXN0aW5nU3RhdGUgPSBkZXBhcmFtKHF1ZXJ5U3RyaW5nKTsKICAgICAgICB2YXIgbmV3U3RhdGUgPSAkLmV4dGVuZCh7fSwgZXhpc3RpbmdTdGF0ZSwgbW9kZWwpOwogICAgICAgIHZhciBuZXdIYXNoID0gZ2V0Q3VycmVudFBhdGgoKSArICI/IiArICQucGFyYW0obmV3U3RhdGUpOwoKICAgICAgICBsb2NhdGlvbi5oYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgbmV3SGFzaDsKCiAgICB9CgogICAgLy93aGVuIG1vZGVsIGNoYW5nZSB0cnkgdG8gdXBkYXRlIHRoZSByb3V0ZSBieQogICAgLy9lbnVtZXJhdGluZyB0aGUgdGhlIGxpc3Qgb2Ygc2VnbWVudCBwYXR0ZXJucyBhcnJheQogICAgLy9pZiBvbmUgc2VnbWVudCBwYXR0ZXJucyBhcnJheSBtYXRjaCB0aGUgY3VycmVudCByb3V0ZSwgdGhlbgogICAgLy9lbnVtZXJhdGUgdGhlIHNlZ21lbnQgcGF0dGVybnMgYXJyYXkgdG8gZmluZCBvdXQgaWYKICAgIC8vYSBwYXR0ZXJuJ3MgbW9kZWwgcGF0aCBpcyBlcXVhbCB0byB0aGUgcGF0aCBvZiB0aGUgY2hhbmdlZCBtb2RlbAogICAgLy90aGVuIHVwZGF0ZSB0aGUgcGF0aCB3aXRoIHRoZSB1cGRhdGVkIG1vZGVsJ3MgdmFsdWUKICAgIGZ1bmN0aW9uIHVwZGF0ZVBhdGhPbk1vZGVsQ2hhbmdlKGUpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzLAogICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICBxdWVyeVN0cmluZywKICAgICAgICAgICAgbW9kZWxQYXRoT2ZQdWJsaXNoZXIgPSBlLnB1Ymxpc2hlci5wYXRoLAogICAgICAgICAgICByb3V0ZVNlZ21lbnRzID0gZS5oYW5kbGVyLm9wdGlvbnMsCiAgICAgICAgICAgIHBhdGggPSBnZXRDdXJyZW50UGF0aCgpOwoKICAgICAgICBpZiAoaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKSkgewoKICAgICAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKCiAgICAgICAgICAgICAgICByb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnRzW2pdOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudC5zdWJzdHIoMSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9PSBtb2RlbFBhdGhPZlB1Ymxpc2hlcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aFNlZ21lbnRzW2pdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aE9mUHVibGlzaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0aCA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gZ2V0UXVlcnlTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyggcXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBkZWZhdWx0T3B0aW9ucy5oYXNoUHJlZml4ICsgZGVmYXVsdE9wdGlvbnMucm91dGVQcmVmaXggKyAocXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1BhdGhNYXRjaGVkQnlSb3V0ZVNlZ21lbnRzKHBhdGgsIHJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzOwoKICAgICAgICBpZiAoIXBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBpZiAocGF0aFNlZ21lbnRzLmxlbmd0aCAhPT0gcm91dGVTZWdtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNYXRjaGVkID0gdHJ1ZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICAvL2lmIHJvdXRlU2VnbWVudCBpcyBtb2RlbCBwYXRoCiAgICAgICAgICAgIC8vZG9uJ3QgbmVlZCB0byBtYXRjaAogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQgIT0gcGF0aFNlZ21lbnRzW2ldKSB7CiAgICAgICAgICAgICAgICBpc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNNYXRjaGVkOwogICAgfQoKICAgIC8vY2hlY2sgaWYgY3VycmVudCBzZWdtZW50IHN0cmluZyBpcyBtYXRjaGVkIHdpdGggc2VnbWVudCBwYXR0ZXJucywgYW5kIHJldHVybiBtYXRjaGVkIHN0YXR1cwogICAgLy9pZiBtYXRjaGVkIGFsc28gdXBkYXRlIHRoZSBtb2RlbCB2YWx1ZSB3aXRoIHRoZSBzZWdtZW50IHZhbHVlCiAgICAvL2lmIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCBpbiByZWdpc3RyYXRpb24gcHJvY2VzcywgYWxzbyByZWdpc3RyYXRpb24gaGFuZGxlciB0byBzdWJzY3JpYmUKICAgIC8vdGhlIGNoYW5nZSBvZiBtb2RlbCwgd2hlbiBtb2RlbCBjaGFuZ2UgdXBkYXRlIHRoZSBzZWdtZW50IHN0cmluZwogICAgZnVuY3Rpb24gcHJvY2Vzc1BhdGhXaXRoUm91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzLCBpc1JlZ2lzdHJhdGlvbikgewoKICAgICAgICB2YXIgcm91dGVTZWdtZW50LAogICAgICAgICAgICBwYXRoU2VnbWVudHMsCiAgICAgICAgICAgIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LAogICAgICAgICAgICBpc1BhdGhNYXRjaGVkID0gaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKTsKCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgbW9kZWxQYXRoSW5Sb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnQuc3Vic3RyKDEpOwoKICAgICAgICAgICAgICAgIGlmIChpc1BhdGhNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCBwYXRoU2VnbWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc1JlZ2lzdHJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGhtLnN1YihudWxsLyogbnVsbCBzdWJzY3JpYmVyKi8sIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVQYXRoT25Nb2RlbENoYW5nZSwgcm91dGVTZWdtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1BhdGhNYXRjaGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgdmFyIGlzRW1wdHlRdWVyeSA9ICQuaXNFbXB0eU9iamVjdChzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgICAgIGlmICghc2VnbWVudFN0cmluZyAmJiBpc0VtcHR5UXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRIYXNoID0gbG9jYXRpb24uaGFzaCwKICAgICAgICAgICAgdXJsUGF0aCA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZShjdXJyZW50SGFzaCwgIiIpLAogICAgICAgICAgICBuZXdIYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgc2VnbWVudFN0cmluZyArIChpc0VtcHR5UXVlcnkgPyAiIiA6ICI/IiArICQucGFyYW0oc3RhdGVJblF1ZXJ5U3RyaW5nKSksCiAgICAgICAgICAgIG5ld1VybCA9IHVybFBhdGggKyAiIyIgKyBuZXdIYXNoOwoKICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHsKICAgICAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgbnVsbCwgbmV3VXJsKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IG5ld1VybDsKCiAgICAgICAgfQogICAgfQoKICAgIC8vcmVnaXN0ZXIgdGhlIG1vZGVsIHBhdGggd2hpY2ggd2lsbCBiZSB0cmFja2VkIHRocm91Z2ggdGhlIHF1ZXJ5IHN0cmluZwogICAgLy9yb3V0ZVBhcmFtcyBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIG1vZGVsIGluaXRpYWxpemF0aW9uCiAgICAvL2J1dCBiZWZvcmUgc3Vic2NyaXB0aW9uIHJlZ2lzdHJhdGlvbiwKICAgIC8vIHNvIHRoYXQgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyBjYW4gYmUgcmVzdG9yZWQKICAgIGhtLnJvdXRlUGFyYW1zID0gZnVuY3Rpb24gKC8qIHBhdGgxLCBwYXRoMiwgLi4gKi8pIHsKCiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG1vZGVsUGF0aCwKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgdGhlIG1vZGVsIGlmIG1vZGVsIHBhdGggaXMgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIG1vZGVsUGF0aCA9IGFyZ3NbaV07CgogICAgICAgICAgICAvL2lmIG1vZGVsUGF0aCBpcyBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgICAgIC8vdXBkYXRlIHRoZSBtb2RlbCB3aXRoIHRoZSB2YWx1ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICAgICAgaWYgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgICAgICAgICByb290Tm9kZS5zZXQobW9kZWxQYXRoLCBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdXBkYXRlIHF1ZXJ5IHN0cmluZyB3aGVuIG1vZGVsIGNoYW5nZQogICAgICAgICAgICBobS5zdWIobnVsbCwgbW9kZWxQYXRoLCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVRdWVyeVN0cmluZ09uTW9kZWxDaGFuZ2UpOwogICAgICAgICAgICBwYXJhbVBhdGhzLnB1c2goYXJnc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgaG1Gbi5yb3V0ZVBhcmFtcyA9IGZ1bmN0aW9uIChzdWJQYXRoKSB7CgogICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgogICAgICAgIGhtLnJvdXRlUGFyYW1zLmFwcGx5KAoKICAgICAgICAgICAgaG0sCgogICAgICAgICAgICAkLm1hcChzdWJQYXRoID8gYXJndW1lbnRzIDogWyIiXSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzdWJQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLmdldFBhdGgoc3ViUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICApOwoKICAgICAgICByZXR1cm4gbW9kZWw7CgogICAgfTsKCiAgICAvL3JlZ2lzdGVyIHRoZSBzZWdtZW50IHBhdHRlcm5zIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBtYXRjaCBhIHBhdGgKICAgIC8vYSBwYXRoIGlzIGNvbnNpc3RzIG9mIG11bHRpcGxlIHNlZ21lbnQKICAgIC8vIEEgcGF0aCBsaWtlICIvcHVibGljL2NvbmZpZy9wZXJzb25hbCIsIGNvbnNpc3Qgb2Ygc2VnbWVudHMgWyJwdWJsaWMiLCAiY29uZmlnIiwgInBlcnNvbmFsIl0KICAgIC8vdGhpcyBtZXRob2QgdHJ5IHRvIHVzZSBhIG1hdGNoZXIgdG8gdGVzdCBlYWNoIHNlZ21lbnRzCiAgICAvL2htLnJvdXRlKHNlZ21lbnRNYXRjaGVyMSwgc2VnbWVudE1hdGNoZXIyLCAuLi4pCiAgICAvL2VhY2ggc2VnbWVudCBtYXRjaGVyIGlzIGxpa2UgW3BhdGgsIG1hdGNoZXJdCiAgICAvL3NvIGl0IGlzIGxpa2UKICAgIC8vaG0ucm91dGUoW3BhdGgxLCBtYXRjaGVyMV0sIFtwYXRoMiwgbWF0Y2hlcjJdLCAuLi4pOwogICAgLy9leGFtcGxlIG9mIHNlZ21lbnQgcGF0dGVybiBhcmUgYXMgZm9sbG93aW5nCiAgICAvL3N0cmluZyBlZzogICJwdWJsaWMiLCB3aGljaCBpcyBhIGZpeGVkIHZhbHVlLCB3aGljaCBkb2VzIG5vdCBtYXBwZWQgdG8gYSBtb2RlbAogICAgLy90aGUgZm9sbG93aW5nIG1hcHBlZCB0byBhIG1vZGVsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCBudWxsXSBvciBbICJtb2RlbFBhdGgiXSwgY29uc3RyYWludCBpcyBudWxsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCAiZml4ZWRWYWx1ZSIgXSwgY29uc3RyYWludCBpcyAiZml4ZWRWYWx1ZSIKICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIC9yZWdleC8gXSwgY29uc3RyYWludCBpcyByZWd1bGFyIGV4cHJlc3Npb24KICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIGZ1bmN0aW9uIChzZWdtZW50KSB7IHJldHVybiBib29sZWFuOyB9IF0sIGNvbnN0cmFpbnQgaXMgYSBmdW5jdGlvbgogICAgaG0ucm91dGVQYXRoID0gZnVuY3Rpb24gKHJvdXRlLCBpc0RlZmF1bHQpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudHMgPSByb3V0ZS5zcGxpdCgiLyIpOwoKICAgICAgICBsaXN0T2ZSb3V0ZVNlZ21lbnRzLnB1c2gocm91dGVTZWdtZW50cyk7CgogICAgICAgIGlmIChpc0RlZmF1bHQpIHsKICAgICAgICAgICAgZGVmYXVsdFJvdXRlU2VnbWVudHMgPSByb3V0ZVNlZ21lbnRzOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFBhdGgoKTsKCiAgICAgICAgaWYgKHByb2Nlc3NQYXRoV2l0aFJvdXRlU2VnbWVudHMoY3VycmVudFBhdGgsIHJvdXRlU2VnbWVudHMsIHRydWUpKSB7CiAgICAgICAgICAgIGluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIGhtLnVwZGF0ZVJvdXRlID0gZnVuY3Rpb24gLyp1cGRhdGVNb2RlbFdoZW5IYXNoQ2hhbmdlZCovKCkgewoKCiAgICAgICAgLy91cGRhdGUgbW9kZWwgd2hlbiBzZWdtZW50IHN0cmluZyBjaGFuZ2UKICAgICAgICB2YXIgaSwgbW9kZWxQYXRoLAogICAgICAgICAgICBzZWdtZW50U3RyaW5nID0gZ2V0Q3VycmVudFBhdGgoKSwKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgaWYgKHNlZ21lbnRTdHJpbmcpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RPZlJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzUGF0aFdpdGhSb3V0ZVNlZ21lbnRzKHNlZ21lbnRTdHJpbmcsIGxpc3RPZlJvdXRlU2VnbWVudHNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy9zaG9ydGN1dCB3aGVuIHRoZSBmaXJzdCBzZWdtZW50IHBhdHRlcm5zIG1hdGNoCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vaWYgc2VnbWVudFN0cmluZyBpcyBlbXB0eSBhbmQgaXQgaGFzIGRlZmF1bHRTZWdtZW50UGF0dGVybgogICAgICAgICAgICAvL3RyeSB0byBidWlsZCBhIHNlZ21lbnQgc3RyaW5nIGZyb20gdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJucwogICAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVmYXVsdFJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VnbWVudFBhdHRlcm4gPSBkZWZhdWx0Um91dGVTZWdtZW50c1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VnbWVudFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChzZWdtZW50UGF0dGVybik7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSByb290Tm9kZS5nZXQoc2VnbWVudFBhdHRlcm5bMF0pICsgIiI7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChtb2RlbFZhbHVlIHx8IHNlZ21lbnRQYXR0ZXJuLmRlZmF1bHRWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlZ21lbnRTdHJpbmcgPSBzZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIHF1ZXJ5IHN0cmluZyBjaGFuZ2UKICAgICAgICBmb3IgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgaWYgKHBhcmFtUGF0aHMuY29udGFpbnMobW9kZWxQYXRoKSkgewogICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aCwgc3RhdGVJblF1ZXJ5U3RyaW5nW21vZGVsUGF0aF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBzdGF0ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFyYW1QYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtb2RlbFBhdGggPSBwYXJhbVBhdGhzW2ldOwogICAgICAgICAgICBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSA9IHJvb3ROb2RlLmdldChtb2RlbFBhdGgpOwogICAgICAgIH0KICAgICAgICAvLwogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgfTsKCiAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIGhhc2ggY2hhbmdlCiAgICAkKHdpbmRvdykuYmluZCgiaGFzaGNoYW5nZSIsIGhtLnVwZGF0ZVJvdXRlKTsKCiAgICAkKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy90cnkgdG8gYnVpbGQgdGhlIGluaXRpYWwgaGFzaCBmcm9tIHRoZSBtb2RlbAoKICAgICAgICB2YXIgaSwgcm91dGUgPSAiIjsKCiAgICAgICAgLy9pZiB0aGVyZSBpcyBkZWZhdWx0IHNlZ21lbnQgcGF0dGVybiBhbmQgdGhlIGluaXRpYWwgc2VnbWVudCBzdHJpbmcKICAgICAgICAvL2lzIG5vdCBtYXRjaGVkIGJ5IGFueSBwYXR0ZXJucywgdGhlbiB1c2UgdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJuCiAgICAgICAgLy90byBidWlsZCB0aGUgc2VnbWVudCBzdHJpbmcKICAgICAgICBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMgJiYgIWluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zKSB7CgogICAgICAgICAgICB2YXIgcGF0aFNlZ21lbnRzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWZhdWx0Um91dGVTZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHJvdXRlU2VnbWVudCA9IGRlZmF1bHRSb3V0ZVNlZ21lbnRzW2ldOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHBhdGhTZWdtZW50cy5wdXNoKHJvb3ROb2RlLmdldChyb3V0ZVNlZ21lbnQuc3Vic3RyKDEpKSArICIiKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBwYXRoU2VnbWVudHMucHVzaChyb3V0ZVNlZ21lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByb3V0ZSA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICByb3V0ZSA9IGdldEN1cnJlbnRQYXRoKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgc3RhdGUgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtUGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG1vZGVsUGF0aCA9IHBhcmFtUGF0aHNbaV07CiAgICAgICAgICAgIHN0YXRlSW5RdWVyeVN0cmluZ1ttb2RlbFBhdGhdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShyb3V0ZSwgc3RhdGVJblF1ZXJ5U3RyaW5nKTsKICAgIH0pOwoKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+Ci8vCgoKCglkZWZhdWx0T3B0aW9ucy5zZWxlY3RlZENsYXNzID0gInNlbGVjdGVkIjsKCWRlZmF1bHRPcHRpb25zLnRhYlZpZXdBdHRyID0gInRhYi12aWV3IjsKCWRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyID0gInRhYi1saW5rIjsKCWRlZmF1bHRPcHRpb25zLnRhYkNvbnRhaW5lck5hbWVBdHRyID0gInRhYi1jb250YWluZXItbmFtZSI7CgoJaG0ud29ya2Zsb3coIHsKCgkJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkJc2VsZWN0VGFiOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHRhYklkID0gdGhpcy5hdHRyKCBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciApIHx8IHRoaXMuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKSwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBlLmhhbmRsZXIub3B0aW9uczsKCgkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSB0YWJJZCkgewoJCQkJdGhpcy5hZGRDbGFzcyggc2VsZWN0ZWRDbGFzcyApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5yZW1vdmVDbGFzcyggc2VsZWN0ZWRDbGFzcyApOwoJCQl9CgkJfSwKCgkJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkJc2VsZWN0VGFiSW5Db250YWluZXI6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgc2VsZWN0ZWRUYWJJZCA9IGUucHVibGlzaGVyLmdldCgpLAoJCQkJdGFiVmlld0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciwKCQkJCXRhYkxpbmtBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIsCgkJCQlvcHRpb25zID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCQl0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yID0gb3B0aW9ucy5zZWxlY3RvciwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBvcHRpb25zLnNlbGVjdGVkQ2xhc3M7CgoJCQl0aGlzLmZpbmQoIHRhYkxpbmtBbmRUYWJWaWV3U2VsZWN0b3IgKS5hbmRTZWxmKCkuZWFjaCggZnVuY3Rpb24oIGluZGV4LCBlbGVtICkgewoJCQkJdmFyICRlbGVtID0gJCggZWxlbSApLAoJCQkJCXRhYklkID0gJGVsZW0uYXR0ciggdGFiVmlld0F0dHIgKSB8fCAkZWxlbS5hdHRyKCB0YWJMaW5rQXR0ciApOwoKCQkJCWlmICh0YWJJZCA9PSBzZWxlY3RlZFRhYklkKSB7CgkJCQkJJGVsZW0uYWRkQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJCX0gZWxzZSB7CgkJCQkJJGVsZW0ucmVtb3ZlQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCglmdW5jdGlvbiBoYW5kbGVUYWJMaW5rQ2xpY2soIGUgKSB7CgkJLy90aGlzIGlzIHRoZSBzdWJzY3JpYmVyLCB3aGljaCBpcyB0aGUgbW9kZWwKCQkvL2UuaGFuZGxlci5vcHRpb25zIGlzIHRoZSB0YWIgaWQKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuYXR0ciggZS5oYW5kbGVyLm9wdGlvbnMgKSApOwoJCWUucHJldmVudERlZmF1bHQoKTsKCQllLnN0b3BQcm9wYWdhdGlvbigpOwoKCX0KCgkvL2EgdGFiIGNhbiBiZSB0YWJWaWV3IG9yIHRhYkxpbmsKCS8vZm9yIHRhYkxpbmsgdXNlIDxsaSB0YWItbGluaz0ibmV3cyIgdGFiPSJjYXRlZ29yeSI+TmV3czwvbGk+CgkvL2lmIHlvdXIgc2VsZWN0ZWQgY2xhc3MgaXMgbm90ICJzZWxlY3RlZCIgYnV0ICJhY3RpdmUiIHVzZQoJLy8gPGxpIHRhYi1saW5rPSJuZXdzIiB0YWI9ImNhdGVnb3J5fGFjdGl2ZSI+TmV3czwvbGk+CgkvLwoJLy9mb3IgdGFiVmlldyB1c2UgPGRpdiB0YWItdmlldz0ibmV3cyIgdGFiPSJjYXRlZ29yeSI+Y29udGVudHM8L2Rpdj4KCS8vb3IgPGRpdiB0YWItdmlldz0ibmV3cyIgdGFiPSJjYXRlZ29yeXxhY3RpdmUiPmNvbnRlbnRzPC9kaXY+CgliaW5kaW5ncyggewoKCQl0YWI6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBzZWxlY3RlZENsYXNzICkgewoKCQkJc2VsZWN0ZWRDbGFzcyA9IHNlbGVjdGVkQ2xhc3MgfHwgZGVmYXVsdE9wdGlvbnMuc2VsZWN0ZWRDbGFzczsKCgkJCWJpbmRpbmcuYXBwZW5kU3ViKCBlbGVtLCBwYXRoLCAiaW5pdCBhZnRlclVwZGF0ZSIsICIqc2VsZWN0VGFiIiwgc2VsZWN0ZWRDbGFzcyApOwoKCQkJaWYgKCQoIGVsZW0gKS5hdHRyKCBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciApKSB7CgkJCQliaW5kaW5nLmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgImNsaWNrIiwgaGFuZGxlVGFiTGlua0NsaWNrLCBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciApOwoJCQl9CgoJCX0sCgoJCS8vYSB0YWJDb250YWluZXIgY2FuIGhvbGQgdGFiTGluayBvciB0YWJWaWV3CgkJLy9pdCBjYW4gYmUKCQkvLwoJCS8vPHVsIHRhYi1jb250YWluZXI9ImNhdGVnb3J5Ij4KCQkvLwk8bGkgdGFiLWxpbms9Im5ld3MiPk5ld3M8L2xpPgoJCS8vCTxsaSB0YWItbGluaz0ib3BpbmlvbiI+T3BpbmlvbjwvbGk+CgkJLy8JPGxpIHRhYi1saW5rPSJzcG9ydHMiPlNwb3J0czwvbGk+CgkJLy88L3VsPgoJCS8vCgkJLy88ZGl2IGNsYXNzPSJ0YWJzIiB0YWItY29udGFpbmVyPSJjYXRlZ29yeSI+CgkJLy8JPGRpdiB0YWItdmlldz0ibmV3cyI+Y29udGVudDwvZGl2PgoJCS8vCTxkaXYgdGFiLXZpZXc9Im9waW5pb24iPmNvbnRlbnQ8L2Rpdj4KCQkvLzwvZGl2PgoJCS8vb3B0aW9ucyB1c2FnZQoJCS8vdGFiLWNvbnRhaW5lcj0iY2F0ZWdvcnl8Y29udGFpbmVyTmFtZSxzZWxlY3RlZENsYXNzIgoJCS8vaWYgeW91IGhhdmUgdGFiIGNvbnRhaW5lciBuZXN0ZWQgd2l0aGluIGFub3RoZXIgdGFiIGNvbnRhaW5lcgoJCS8veW91IGNhbiB1c2UgY29udGFpbmVyIG5hbWUgdG8gc3BlY2lmeSB3aGljaCBjb250YWluZXIgaXQgaXMgaW4KCQl0YWJDb250YWluZXI6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgkJCW9wdGlvbnMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKTsKCgkJCXZhciB0YWJWaWV3QXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYlZpZXdBdHRyLAoJCQkJdGFiTGlua0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciwKCQkJCXRhYkNvbnRhaW5lck5hbWVBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiQ29udGFpbmVyTmFtZUF0dHIsCgkJCQljb250YWluZXJOYW1lID0gb3B0aW9uc1swXSwKCQkJCXNlbGVjdGVkQ2xhc3MgPSBvcHRpb25zWzFdLAoKCQkJCXRhYkNvbnRhaW5lclNlbGVjdG9yID0gY29udGFpbmVyTmFtZSA/CgkJCQkJIlsiICsgdGFiQ29udGFpbmVyTmFtZUF0dHIgKyAiPSciICsgY29udGFpbmVyTmFtZSArICInXSIgLy93aXRoIGV4cGxpY2l0IHRhYiBjb250YWluZXIgbmFtZQoJCQkJCTogIiIsIC8vbm8gdGFiIGNvbnRhaW5lciBuYW1lCgoJCQkJdGFiTGlua1NlbGVjdG9yID0gIlsiICsgdGFiTGlua0F0dHIgKyAiXSIgKyB0YWJDb250YWluZXJTZWxlY3RvciwKCgkJCQl0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yID0gdGFiTGlua1NlbGVjdG9yICsgIixbIiArIHRhYlZpZXdBdHRyICsgIl0iICsgdGFiQ29udGFpbmVyU2VsZWN0b3I7CgoJCQkvL3VwZGF0ZSB0aGUgdGFiIG1vZGVsIHdpdGggdGhlIHRhYkxpbmsgd2hlbiBjbGljawoJCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgImNsaWNrIiwgaGFuZGxlVGFiTGlua0NsaWNrLCB0YWJMaW5rQXR0ciwgdGFiTGlua1NlbGVjdG9yIC8qZGVsZWdhdGVTZWxlY3RvciovICk7CgoJCQkvLwoJCQkvL2hpZ2hsaWdodCB0aGUgdGFiIHdoZW4gdGhlIG1vZGVsIGNoYW5nZQoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCwgImluaXQxMDAgYWZ0ZXJVcGRhdGUiLCAiKnNlbGVjdFRhYkluQ29udGFpbmVyIiwgewoJCQkJc2VsZWN0b3I6IHRhYkxpbmtBbmRUYWJWaWV3U2VsZWN0b3IsCgkJCQlzZWxlY3RlZENsYXNzOiBzZWxlY3RlZENsYXNzIHx8IGRlZmF1bHRPcHRpb25zLnNlbGVjdGVkQ2xhc3MKCQkJfSApOwoJCX0KCX0gKTsKCi8vZGF0YS1zdWI9IkBhcHA6YXBwTmFtZSxvcHRpb25zIgoKCgl2YXIgckRvdCA9IC9cLi9nLAoJCWFwcFN0b3JlID0ge30sCgkvL3VzZWQgdG8gbWF0Y2ggImFwcE5hbWUsb3B0aW9ucyIKCQlyQXBwT3B0aW9ucyA9IC9eKFteLF0rKSgsKC4rKSk/JC8sCgkJckxvYWRBcHBPcHRpb25zID0gL14oW14sXSspKCwoW14sXSspKT8oLCguKykpPyQvOwoKCS8veW91IGFwcCBzaG91bGQgaW1wbGVtZW50IGxvYWQoZWxlbSwgb3B0aW9ucykgYW5kIHVubG9hZChlbGVtKSBtZXRob2QKCglobS5BcHAgPSBobS5DbGFzcy5leHRlbmQoCgoJCS8vaW5zdGFuY2UgbWVtYmVycwoJCXsKCQkJLy9leGlzdHMgc2ltcGx5IGZvciBlbnN1cmUgYXBwIG11c3QgaGF2ZSBhIG5hbWUKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIGFwcCApIHsKCgkJCQlpZiAoIWFwcC5uYW1lKSB7CgkJCQkJdGhyb3cgIkFuIGFwcCBtdXN0IGhhdmUgYSBuYW1lLiI7CgkJCQl9CgkJCQl0aGlzLmNhbGxCYXNlKCAiaW5pdGlhbGl6ZSIsIGFwcCApOwoKCQkJfSwKCgkJCS8vaXQgYWRkIGFkZGl0aW9uYWwgbG9naWMgYmVzaWRlIHRoZSBvcmlnaW5hbCBsb2FkIG1ldGhvZAoJCQkvL3N1Y2ggYXMgaW5zdGFuY2UgY291bnRpbmcsIGluc3RhbmNlIGFzc29jaWF0aW9uIHdpdGggdGhlIGNvbnRhaW5lcgoJCQkvL3ByZXBhcmUgdG8gdW5sb2FkIGZyb20gdGhlIGNvbnRhaW5lcgoJCQlsb2FkOiBmdW5jdGlvbiggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7CgkJCQlpZiAoISR2aWV3Q29udGFpbmVyIHx8ICF0aGlzLmxvYWRhYmxlKCkpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl2YXIgYXBwID0gdGhpcywKCQkJCQlidWlsZE1vZGVsUmVzdWx0LAoJCQkJCWFwcE5hbWUgPSBhcHAubmFtZSwKCQkJCQlhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJLy9lbnN1cmUgdGhhdCBhbiBhcHBsaWNhdGlvbiBjYW4gYmUgbG9hZGVkIGludG8gYSBjb250YWluZXIgb25seSBvbmNlCgkJCQlpZiAoYXBwSW5zdGFuY2UpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKGFwcC5sb2FkTW9kZWwpIHsKCQkJCQlidWlsZE1vZGVsUmVzdWx0ID0gYXBwLmxvYWRNb2RlbCggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoKCQkJCX0KCgkJCQl2YXIgY29udGludWF0aW9uID0gZnVuY3Rpb24oKSB7CgoJCQkJCWFwcC5sb2FkVmlldyggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIgKTsKCQkJCQlpbnN0YW5jZU1hbmFnZXIuYWRkKCAkdmlld0NvbnRhaW5lclswXSwgaG1Nb2RlbENvbnRhaW5lci5wYXRoLCBhcHBOYW1lLCBhcHAgKTsKCQkJCQkkdmlld0NvbnRhaW5lci5iaW5kKCAiZXhpdEFwcC4iICsgYXBwTmFtZSwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWFwcC51bmxvYWQoICQoIHRoaXMgKSApOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0gKTsKCgkJCQkJYXBwLmluc3RhbmNlQ291bnQrKzsKCQkJCQlhcHAudWlkKys7CgkJCQl9OwoKCQkJCWlmIChpc1Byb21pc2UoIGJ1aWxkTW9kZWxSZXN1bHQgKSkgewoKCQkJCQlidWlsZE1vZGVsUmVzdWx0LmRvbmUoIGNvbnRpbnVhdGlvbiApOwoKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWF0aW9uKCk7CgoJCQkJfQoKCQkJfSwKCgkJCXVubG9hZDogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyICkgewoKCQkJCXZhciBhcHBOYW1lID0gdGhpcy5uYW1lOwoJCQkJdmFyIGFwcEluc3RhbmNlID0gaW5zdGFuY2VNYW5hZ2VyLmdldCggJHZpZXdDb250YWluZXJbMF0sIGFwcE5hbWUgKTsKCgkJCQl0aGlzLnVubG9hZFZpZXcoICR2aWV3Q29udGFpbmVyICk7CgoJCQkJdGhpcy51bmxvYWRNb2RlbCggYXBwSW5zdGFuY2UubW9kZWxOb2RlICk7CgoJCQkJaW5zdGFuY2VNYW5hZ2VyLnJlbW92ZSggJHZpZXdDb250YWluZXJbMF0sIGFwcE5hbWUgKTsKCgkJCQkkdmlld0NvbnRhaW5lci51bmJpbmQoICJleGl0QXBwLiIgKyBhcHBOYW1lICk7CgoJCQkJdGhpcy5pbnN0YW5jZUNvdW50LS07CgkJCX0sCgoJCQkvL2Z1bmN0aW9uKCBtb2RlbENvbnRhaW5lciwgb3B0aW9ucyApIHt9CgkJCWdldEluaXRpYWxEYXRhOiBudWxsLAoKCQkJLy9kZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGxvYWRNb2RlbCBpcyB0byBjYWxsCgkJCS8vYXBwLmdldEluaXRpYWxEYXRhKCkgYW5kIHB1dCB0aGUgcmVzdWx0IGludG8gbW9kZWwKCQkJLy8KCQkJLy9Zb3UgY2FuIHNldCBsb2FkTW9kZWwgdG8gbnVsbCB0byBzcGVjaWZ5IHRoYXQKCQkJLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBidWlsZCBtb2RlbAoJCQlsb2FkTW9kZWw6IGZ1bmN0aW9uKCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoJCQkJdmFyIGFwcCA9IHRoaXM7CgkJCQlpZiAoIWFwcC5nZXRJbml0aWFsRGF0YSkgewoJCQkJCXRocm93ICJhcHAuZ2V0SW5pdGlhbERhdGEgaXMgbm90IGltcGxlbWVudGVkIjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGFwcC5nZXRJbml0aWFsRGF0YSggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoKCQkJCWlmIChpc1Byb21pc2UoIGRhdGEgKSkgewoJCQkJCXJldHVybiBkYXRhLmRvbmUoIGZ1bmN0aW9uKCBkYXRhICkgewoJCQkJCQlhcHAuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkuc2V0KCBkYXRhICk7CgkJCQkJfSApOwoJCQkJfSBlbHNlIHsKCQkJCQlhcHAuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkuc2V0KCBkYXRhICk7CgkJCQl9CgoJCQl9LAoKCQkJdW5sb2FkTW9kZWw6IGZ1bmN0aW9uKCBtb2RlbE5hbWVzcGFjZSApIHsKCQkJCWlmICh0aGlzLmxvYWRNb2RlbCkgewoJCQkJCWhtLmRlbCggbW9kZWxOYW1lc3BhY2UgKTsKCQkJCX0KCQkJfSwKCgkJCS8vdGhlIGRlZmF1bHQgbG9hZFZpZXcgd2lsbCBjcmVhdGUgYSBjb250YWluZXIKCQkJLy88ZGl2IGFwcG5hbWU9Inh4eCIgbnM9Inh4eCI+PC9kaXY+CgkJCWxvYWRWaWV3OiBmdW5jdGlvbiggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIgKSB7CgoJCQkJdmFyIG5hbWVzcGFjZSA9IHRoaXMuZ2V0TW9kZWxOb2RlKCBobU1vZGVsQ29udGFpbmVyICkucGF0aCwKCQkJCQl2aWV3V3JhcHBlciA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQkJCQkuYXR0ciggImFwcG5hbWUiLCB0aGlzLm5hbWUgKQoJCQkJCQkuYXR0ciggIm5zIiwgbmFtZXNwYWNlICk7CgoJCQkJdmlld1dyYXBwZXIuaG1EYXRhKCAibnMiLCBuYW1lc3BhY2UgKTsKCgkJCQl2aWV3V3JhcHBlci5hcHBlbmRUbyggJHZpZXdDb250YWluZXIgKS50bXBsKAoJCQkJCXRoaXMuZ2V0VGVtcGxhdGVPcHRpb25zKCksCgkJCQkJbmFtZXNwYWNlICk7CgoJCQl9LAoKCQkJdW5sb2FkVmlldzogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyICkgewoJCQkJJHZpZXdDb250YWluZXIuZmluZCggIj4gW2FwcG5hbWU9JyIgKyB0aGlzLm5hbWUgKyAiJ10iICkucmVtb3ZlKCk7CgkJCX0sCgoJCQkvL3RlbXBsYXRlT3B0aW9ucyBpcyBhYm91dCB0ZW1wbGF0ZSBpZAoJCQkvL2J5IGRlZmF1bHQgeW91IGNhbiBnZXQgdGVtcGxhdGVPcHRpb25zIHByb3BlcnR5IG9yCgkJCS8vdGhlIGFwcGxpY2F0aW9uIG5hbWUgYXMgdGVtcGxhdGVPcHRpb25zCgkJCWdldFRlbXBsYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy50ZW1wbGF0ZU9wdGlvbnMgfHwgdGhpcy5uYW1lOwoKCQkJfSwKCgkJCWdldE1vZGVsTm9kZTogZnVuY3Rpb24oIGhtTW9kZWxDb250YWluZXIgKSB7CgkJCQl2YXIgc3ViUGF0aCA9IHRoaXMuc3ViUGF0aCB8fCB0aGlzLm5hbWUucmVwbGFjZSggckRvdCwgIl8iICk7CgkJCQkvL2lmIHdlIGhhdmUgbW9yZSB0aGFuIG9uZSBpbnN0YW5jZSwgdGhlIHN1YlBhdGggbmVlZCB0byBiZQoJCQkJLy9iZSBzdWZmaXggd2l0aCBhbiB1aWQgdG8gbWFrZSB0aGlzIG5hbWVzcGFjZSB1bmlxdWUKCQkJCWlmICh0aGlzLnVpZCkgewoJCQkJCXN1YlBhdGggPSBzdWJQYXRoICsgdGhpcy51aWQ7CgkJCQl9CgkJCQlyZXR1cm4gaG1Nb2RlbENvbnRhaW5lci5jZCggc3ViUGF0aCApOwoKCQkJfSwKCgkJCWluc3RhbmNlQ291bnQ6IDAsCgoJCQl1aWQ6IDAsCgoJCQkvL2lmIHdlIHdhbnQgdG8gdXNlIHNpbmdsZXRvbiB1c2UgdGhlIGZvbGxvd2luZwoJCQkvLwkJbG9hZGFibGU6IGZ1bmN0aW9uKCkgewoJCQkvLwkJCXJldHVybiAhdGhpcy5pbnN0YW5jZUNvdW50OwoJCQkvLwkJfSwKCQkJbG9hZGFibGU6IHJldHVyblRydWUsCgoJCQl0ZW1wbGF0ZU9wdGlvbnM6IG51bGwsCgoJCQkvL3BhdGggdGhhdCB3cmFwIHRoaXMgbW9kZWwsCgkJCS8vYnV0IHRoaXMgc2hvdWxkIG5vdCBiZSB1c2VkIGJ5IGNvbnN1bWVyCgkJCXN1YlBhdGg6IG51bGwKCgoJCX0sCgoJCS8vc3RhdGljIG1lbWJlcnMKCQl7CgoJCQkvL2htLkFwcC5hZGQoewoJCQkvLyAgbmFtZTogImdtYWlsIiwgLy95b3UgbXVzdCBoYXZlIGEgbmFtZQoJCQkvLyAgbG9hZDogZnVuY3Rpb24gKHZpZXdDb250YWluZXIsIG1vZGVsQ29udGFpbmVyLCBvcHRpb25zKSB7fSwKCQkJLy8gIHVuYXBwOiBmdW5jdGlvbiAodmlld0NvbnRhaW5lciwgbW9kZWxDb250YWluZXIpIHt9LCAvL29wdGlvbmFsCgkJCS8vICAvL29wdGlvbmFsLCBieSBkZWZhdWx0IGl0IGlzIG5vdCBsb2FkYWJsZSBpZiBpdCBoYXMgYmVlbiBsb2FkZWQgb25jZQoJCQkvLyAgLy9pZiBpdCBpcyBsb2FkYWJsZTogdHJ1ZSAsIGl0IG1lYW5zIGl0IGlzIGFsd2F5cyBsb2FkYWJsZQoJCQkvLyAgbG9hZGFibGU6IGZ1bmN0aW9uICgpIHt9LAoJCQkvLyB9KTsKCQkJYWRkOiBmdW5jdGlvbiggYXBwICkgewoJCQkJaWYgKCEoYXBwIGluc3RhbmNlb2YgdGhpcykpIHsKCQkJCQlhcHAgPSB0aGlzKCBhcHAgKTsKCQkJCX0KCQkJCWFwcFN0b3JlW2FwcC5uYW1lXSA9IGFwcDsKCQkJfSwKCgkJCXJlbW92ZTogZnVuY3Rpb24oIGFwcE5hbWUgKSB7CgkJCQlpZiAoYXBwU3RvcmVbYXBwTmFtZV0gJiYgIWFwcFN0b3JlW2FwcE5hbWVdLmluc3RhbmNlQ291bnQpIHsKCQkJCQlkZWxldGUgYXBwU3RvcmVbYXBwTmFtZV07CgkJCQl9CgkJCX0sCgoJCQlnZXQ6IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJcmV0dXJuIGFwcFN0b3JlW2FwcE5hbWVdOwoJCQl9LAoKCQkJLy9mZXRjaCB0aGUgZGVmaW5pdGlvbiBvZiB0aGUgYXBwbGljYXRpb24KCQkJbG9hZERlZmluaXRpb246IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggYXBwTmFtZSArICIuYXBwIiApOwoJCQl9LAoKCQkJLy9zdXBwb3J0IHRoZSBmb2xsb3dpbmcgZmVhdHVyZQoJCQkvL2J5IGRlZmF1bHQgY29udGFpbmVyIGlzIGJvZHksIGlmIGNvbnRhaW5lciBpcyBtaXNzaW5nCgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSk7CgkJCS8vCgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSwgdmlld0NvbnRhaW5lcik7IC8vdmlld0NvbnRhaW5lciBpcyBqUXVlcnkKCQkJLy9obS5BcHAubG9hZEFwcChhcHBOYW1lLCBtb2RlbENvbnRhaW5lcik7IC8vbW9kZWxDb250YWluZXIgaXMgc3RyaW5nCgkJCS8vCgkJCS8vY29udGFpbmVyIGlzIGpRdWVyeSBvYmplY3QsIG9yIERPTSBlbGVtZW50CgkJCS8vYXBwTmFtZSBpcyBzdHJpbmcsCgkJCS8vb3B0aW9ucyBpcyBvcHRpb25hbAoJCQlsb2FkQXBwOiBmdW5jdGlvbiggYXBwTmFtZSwgJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7CgoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoKCQkJCQkkdmlld0NvbnRhaW5lciA9ICQoIGRvY3VtZW50LmJvZHkgKTsKCQkJCQlobU1vZGVsQ29udGFpbmVyID0gcm9vdE5vZGU7CgoJCQkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCgkJCQkJaG1Nb2RlbENvbnRhaW5lciA9IHJvb3ROb2RlOwoKCQkJCX0KCgkJCQl2YXIgYXBwID0gYXBwU3RvcmVbYXBwTmFtZV07CgoJCQkJaWYgKGFwcCkgewoKCQkJCQlhcHAubG9hZCggJHZpZXdDb250YWluZXIsIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQl0aGlzLmxvYWREZWZpbml0aW9uKCBhcHBOYW1lICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJCWFwcFN0b3JlW2FwcE5hbWVdLmxvYWQoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICk7CgkJCQkJfSApOwoJCQkJfQoJCQl9LAoKCQkJLy9jb250YWluZXIgYnkgZGVmYXVsdCBpcyBkb2N1bWVudC5ib2R5CgkJCS8vaG0uQXBwLnVubG9hZEFwcChhcHBOYW1lKQoJCQkvL2htLkFwcC51bmxvYWRBcHAoY29udGFpbmVyLCBhcHBOYW1lKTsKCQkJdW5sb2FkQXBwOiBmdW5jdGlvbiggYXBwTmFtZSwgJHZpZXdDb250YWluZXIgKSB7CgkJCQlpZiAoaXNVbmRlZmluZWQoIGFwcE5hbWUgKSkgewoJCQkJCWFwcE5hbWUgPSAkdmlld0NvbnRhaW5lcjsKCQkJCQkkdmlld0NvbnRhaW5lciA9ICQoICJib2R5IiApOwoJCQkJfQoKCQkJCXZhciBhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyLCBhcHBOYW1lICk7CgkJCQlpZiAoYXBwSW5zdGFuY2UpIHsKCQkJCQlhcHBJbnN0YW5jZS5hcHAudW5sb2FkKCAkdmlld0NvbnRhaW5lciApOwoJCQkJfQoJCQl9CgoJCX0gKTsKCgl2YXIgaW5zdGFuY2VNYW5hZ2VyID0gewoKCQlnZXQ6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgYXBwTmFtZSApIHsKCQkJcmV0dXJuIHRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXTsKCQl9LAoKCQlhZGQ6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgbW9kZWxDb250YWluZXJQYXRoLCBhcHBOYW1lLCBhcHAgKSB7CgkJCXRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXSA9IHsKCQkJCWFwcDogYXBwLAoJCQkJbW9kZWxOb2RlOiBhcHAuZ2V0TW9kZWxOb2RlKCBobSggbW9kZWxDb250YWluZXJQYXRoICkgKSwKCQkJCW1vZGVsQ29udGFpbmVyOiBtb2RlbENvbnRhaW5lclBhdGgKCQkJfTsKCQl9LAoKCQlyZW1vdmU6IGZ1bmN0aW9uKCB2aWV3Q29udGFpbmVyRWxlbSwgYXBwTmFtZSApIHsKCQkJZGVsZXRlIHRoaXMuYXBwRGF0YSggdmlld0NvbnRhaW5lckVsZW0gKVthcHBOYW1lXTsKCQl9LAoKCQlhcHBEYXRhOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIHJlYWRPbmx5ICkgewoJCQl2YXIgYXBwRGF0YSA9ICQoIHZpZXdDb250YWluZXJFbGVtICkuaG1EYXRhKCAiYXBwIiApOwoJCQlpZiAoIXJlYWRPbmx5ICYmICFhcHBEYXRhKSB7CgkJCQlhcHBEYXRhID0geyB9OwoJCQkJJCggdmlld0NvbnRhaW5lckVsZW0gKS5obURhdGEoICJhcHAiLCBhcHBEYXRhICk7CgkJCX0KCQkJcmV0dXJuIGFwcERhdGE7CgkJfQoJfTsKCgliaW5kaW5ncyggewoJCS8vYXBwPSIvfGdtYWlsLG9wdGlvbnMiCgkJLy9kYXRhLXN1Yj0iYXBwOi98Z21haWwsb3B0aW9ucyIKCQlhcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG1hdGNoID0gckFwcE9wdGlvbnMuZXhlYyggJC50cmltKCBvcHRpb25zICkgKSwKCQkJCWFwcE5hbWUgPSBtYXRjaFsxXSwKCQkJCWFwcE9wdGlvbnMgPSBtYXRjaFszXTsKCgkJCWhtLkFwcC5sb2FkQXBwKCBhcHBOYW1lLCAkKCBlbGVtICksIGhtKCBwYXRoICksIGFwcE9wdGlvbnMgKTsKCQl9LAoKCQkvL2V4aXQtYXBwPSJffGdtYWlsIgoJCS8vdW5sb2FkIGFwcCBmcm9tIHBhcmVudCBjb250YWluZXIKCQkvL2RhdGEtc3ViPSJleGl0QXBwOl98Z21haWwiCgkJZXhpdEFwcDogZnVuY3Rpb24oIGVsZW0sIHBhcnNlQ29udGV4dCwgYmluZGluZywgb3B0aW9ucyApIHsKCQkJJCggZWxlbSApLm1hcEV2ZW50KCAiY2xpY2siLCAiZXhpdEFwcC4iICsgb3B0aW9ucyApOwoJCX0sCgoJCS8vbG9hZCBhbiBhcHAgd2hlbiBjbGljawoJCS8vbG9hZC1hcHA9Ii98Z21haWwsI2NvbnRhaW5lcklkLG9wdGlvbnMiCgkJLy9kYXRhLXN1Yj0ibG9hZEFwcDovfGdtYWlsLCNjb250YWluZXJJZCxvcHRpb25zIgoJCWxvYWRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG9wdGlvblBhcnRzID0gckxvYWRBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gb3B0aW9uUGFydHNbMV0sCgkJCQkkdmlld0NvbnRhaW5lciA9ICQoIG9wdGlvblBhcnRzWzNdICksCgkJCQlvdGhlck9wdGlvbnMgPSBvcHRpb25QYXJ0c1s1XTsKCgkJCSQoIGVsZW0gKS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQlobS5BcHAubG9hZEFwcCggYXBwTmFtZSwgJHZpZXdDb250YWluZXIsIGhtKCBwYXRoICksIG90aGVyT3B0aW9ucyApOwoJCQl9ICk7CgkJfSwKCgkJLy91bmxvYWRBcHAKCQkvL3VubG9hZCBhbiBhcHAgd2hlbiBjbGljawoJCS8vdW5sb2FkLWFwcD0iOl98Z21haWwsI2NvbnRhaW5lciIKCQkvL2RhdGEtc3ViPSJ1bmxvYWRBcHA6X3xnbWFpbCwjY29udGFpbmVyIgoJCXVubG9hZEFwcDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQl2YXIgb3B0aW9uUGFydHMgPSByTG9hZEFwcE9wdGlvbnMuZXhlYyggJC50cmltKCBvcHRpb25zICkgKSwKCQkJCWFwcE5hbWUgPSBvcHRpb25QYXJ0c1sxXSwKCQkJCSR2aWV3Q29udGFpbmVyID0gJCggb3B0aW9uUGFydHNbM10gKTsKCgkJCSQoIGVsZW0gKS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQlobS5BcHAudW5sb2FkQXBwKCBhcHBOYW1lLCAkdmlld0NvbnRhaW5lciApOwoJCQl9ICk7CgkJfQoJfSApOwoKCXZhciBfY2xlYW5EYXRhRm9yQXBwID0gJC5jbGVhbkRhdGE7CgoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGFwcERhdGEgPSBpbnN0YW5jZU1hbmFnZXIuYXBwRGF0YSggdGhpcywgdHJ1ZSApOwoJCQlpZiAoYXBwRGF0YSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFwcERhdGEpIHsKCQkJCQl2YXIgYXBwID0gYXBwRGF0YVtrZXldOwoJCQkJCWRlbGV0ZSBhcHBEYXRhW2tleV07CgkJCQkJYXBwLnVubG9hZCggdGhpcywgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSApOwoJCV9jbGVhbkRhdGFGb3JBcHAoIGVsZW1zICk7Cgl9OwoKCV9sb2FkZXIoICJhcHAiLCAianMiLCB7CgkJdXJsOiBmdW5jdGlvbiggbW9kdWxlSWQgKSB7CgkJCS8vaWYgbW9kdWxlIGlkIGlzIGxpa2UgKmhlbGxvLCB0aGVuIGl0IGlzIHdpZGdldAoJCQl2YXIgZmlsZU5hbWUgPSBfbG9hZGVyLmZpbGVOYW1lKCBtb2R1bGVJZCApOwoJCQlyZXR1cm4gZmlsZU5hbWUuc3RhcnRzV2l0aCggImFway4iICkgPwoJCQkJLy9pZiBhcHAgaXMgcGFja2FnZSBpcyBhcGssIHRoZW4gbG9hZCBpdAoJCQkJLy9pbiBhcGsgZm9sZGVyCgkJCQkiYXBrLyIgKyBmaWxlTmFtZS5zdWJzdHIoIDQgKSArICIvbWFpbi5qcyIgOgoKCQkJCS8vb3RoZXJ3aXNlIGxvYWQgaW4gYXBwIGZvbGRlcgoJCQkJImFwcC8iICsgZmlsZU5hbWUgKyAiLmpzIjsKCQl9Cgl9ICk7CgoKCn0pKCBqUXVlcnksIHdpbmRvdyApOwoK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:16:39 GMT",
                    "Content-Length": "232410",
                    "Date": "Fri, 07 Nov 2014 03:16:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}