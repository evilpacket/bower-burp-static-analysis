{
    "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.0.1.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.0.1.js",
                "path": "/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.0.1.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJjb3JpbmNrL2pxdWVyeS1tb2JpbGUtaXNjcm9sbHZpZXcvZGVtby9idWlsZC9qYXZhc2NyaXB0cy9qcXVlcnkubW9iaWxlLTEuMC4xLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjIxMTI1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjQzIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo0MyBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjAuMQoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMS0yMDEyIChjKSBqUXVlcnkgUHJvamVjdAoqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKgogKiBDb3B5cmlnaHQgMjAxMCwgQVVUSE9SUy50eHQgKGh0dHA6Ly9qcXVlcnl1aS5jb20vYWJvdXQpCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vVUkvV2lkZ2V0CiAqLwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8galF1ZXJ5IDEuNCsKaWYgKCAkLmNsZWFuRGF0YSApIHsKCXZhciBfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CgkkLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCX0KCQlfY2xlYW5EYXRhKCBlbGVtcyApOwoJfTsKfSBlbHNlIHsKCXZhciBfcmVtb3ZlID0gJC5mbi5yZW1vdmU7CgkkLmZuLnJlbW92ZSA9IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAha2VlcERhdGEgKSB7CgkJCQlpZiAoICFzZWxlY3RvciB8fCAkLmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkubGVuZ3RoICkgewoJCQkJCSQoICIqIiwgdGhpcyApLmFkZCggWyB0aGlzIF0gKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIF9yZW1vdmUuY2FsbCggJCh0aGlzKSwgc2VsZWN0b3IsIGtlZXBEYXRhICk7CgkJfSk7Cgl9Owp9CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXSwKCQlmdWxsTmFtZTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgl2YXIgYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQovLwkkLmVhY2goIGJhc2VQcm90b3R5cGUsIGZ1bmN0aW9uKCBrZXksIHZhbCApIHsKLy8JCWlmICggJC5pc1BsYWluT2JqZWN0KHZhbCkgKSB7Ci8vCQkJYmFzZVByb3RvdHlwZVsga2V5IF0gPSAkLmV4dGVuZCgge30sIHZhbCApOwovLwkJfQovLwl9KTsKCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZSA9ICQuZXh0ZW5kKCB0cnVlLCBiYXNlUHJvdG90eXBlLCB7CgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRFdmVudFByZWZpeDogJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSwKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lCgl9LCBwcm90b3R5cGUgKTsKCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gKTsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC5leHRlbmQuYXBwbHkoIG51bGwsIFsgdHJ1ZSwgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJLy8gcHJldmVudCBjYWxscyB0byBpbnRlcm5hbCBtZXRob2RzCgkJaWYgKCBpc01ldGhvZENhbGwgJiYgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJfQoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQl0aHJvdyAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIjsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSApIHsKCQkJCQl0aHJvdyAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiOwoJCQkJfQoJCQkJdmFyIG1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIG5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCglpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7Cgl9Cn07CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyAkLndpZGdldC5icmlkZ2Ugc3RvcmVzIHRoZSBwbHVnaW4gaW5zdGFuY2UsIGJ1dCB3ZSBkbyBpdCBhbnl3YXkKCQkvLyBzbyB0aGF0IGl0J3Mgc3RvcmVkIGV2ZW4gYmVmb3JlIHRoZSBfY3JlYXRlIGZ1bmN0aW9uIHJ1bnMKCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXZhciBzZWxmID0gdGhpczsKCQl0aGlzLmVsZW1lbnQuYmluZCggInJlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5kZXN0cm95KCk7CgkJfSk7CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHt9OwoJCWlmICggJC5tZXRhZGF0YSApIHsKCQkJb3B0aW9ucyA9ICQubWV0YWRhdGEuZ2V0KCBlbGVtZW50IClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJCX0KCQlyZXR1cm4gb3B0aW9uczsKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHt9LAoJX2luaXQ6IGZ1bmN0aW9uKCkge30sCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJfQoJCQlvcHRpb25zID0ge307CgkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJJC5lYWNoKCBvcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlICk7CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCVsgdmFsdWUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0oCgkJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkIiArICIgIiArCgkJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7CgkJCWZvciAoIHZhciBpID0gJC5ldmVudC5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQkJcHJvcCA9ICQuZXZlbnQucHJvcHNbIC0taSBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oY2FsbGJhY2spICYmCgkJCWNhbGxiYWNrLmNhbGwoIHRoaXMuZWxlbWVudFswXSwgZXZlbnQsIGRhdGEgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKLyoKKiB3aWRnZXQgZmFjdG9yeSBleHRlbnRpb25zIGZvciBtb2JpbGUKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQodGFyZ2V0KSApLAoJCQlrZWVwTmF0aXZlID0gKHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCSQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsIHRhcmdldCApLm5vdCgga2VlcE5hdGl2ZSApWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBhIHdvcmthcm91bmQgZm9yIHdpbmRvdy5tYXRjaE1lZGlhCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLz4+IHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vPj4gdGVzdHMgZm9yIHNjcmVlbiBtZWRpYSB0eXBlIHdpdGggd2luZG93IHdpZHRoID4gNDgwcHgKCQkkLm1vYmlsZS5tZWRpYSgnQG1lZGlhIHNjcmVlbiBhbmQgKC13ZWJraXQtbWluLWRldmljZS1waXhlbC1yYXRpbzogMiknKSAvLz4+IHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7Ci8qCiogc3VwcG9ydCB0ZXN0cwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5tb2JpbGUuYnJvd3NlciA9IHt9OwokLm1vYmlsZS5icm93c2VyLmllID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCWEgPSBkaXYuYWxsIHx8IFtdOwoKCS8vIGFkZGVkIHt9IHRvIHNpbGVuY2UgY2xvc3VyZSBjb21waWxlciB3YXJuaW5ncy4gcmVnaXN0ZXJpbmcgbXkgZGlzbGlrZSBvZiBhbGwgdGhpbmdzCgkvLyBvdmVybHkgY2xldmVyIGhlcmUgZm9yIGZ1dHVyZSByZWZlcmVuY2UKCXdoaWxlICggZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiIsIGFbIDAgXSApe307CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93LAoJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudCwKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3csCglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYgInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSwKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglzY3JvbGxUb3A6ICggInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwgInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8ICJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0gKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQp2YXIgbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKLyoKKiAibW91c2UiIHBsdWdpbgoqLwoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgajsKCglldmVudCA9ICQuRXZlbnQoZXZlbnQpOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICl7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoIChjdCAmJiBjdC5sZW5ndGgpID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKXsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKXsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZDsKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyh0LnBhZ2VYIC0gc3RhcnRYKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKHQucGFnZVkgLSBzdGFydFkpID4gbW92ZVRocmVzaG9sZCApLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCl7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICl7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwovKiAKKiAiZXZlbnRzIiBwbHVnaW4gLSBIYW5kbGVzIGV2ZW50cwoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCiQuZWFjaCggKCAidG91Y2hzdGFydCB0b3VjaG1vdmUgdG91Y2hlbmQgb3JpZW50YXRpb25jaGFuZ2UgdGhyb3R0bGVkcmVzaXplICIgKwoJCQkJCSJ0YXAgdGFwaG9sZCBzd2lwZSBzd2lwZWxlZnQgc3dpcGVyaWdodCBzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKCgkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKfSk7Cgp2YXIgc3VwcG9ydFRvdWNoID0gJC5zdXBwb3J0LnRvdWNoLAoJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCmZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGU7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoJJC5ldmVudC5oYW5kbGUuY2FsbCggb2JqLCBldmVudCApOwoJZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKfQoKLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0ID0gewoKCWVuYWJsZWQ6IHRydWUsCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQlzY3JvbGxpbmcsCgkJCXRpbWVyOwoKCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJfQoKCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJfQoKCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJfSwgNTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyB0YXBob2xkCiQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCW9yaWdFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCX0KCgkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoZXZlbnQpIHsKCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQlpZiAoIG9yaWdUYXJnZXQgPT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICkKCQkJCS5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiApICk7CgkJCX0sIDc1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAokLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CglzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAxMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCglkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJc3RhcnQgPSB7CgkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJfSwKCQkJCXN0b3A7CgoJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgoJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQlzdG9wID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQl9OwoKCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJfSk7CgkJfSk7Cgl9Cn07CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vICJDb3dib3kiIEJlbiBBbG1hbgoKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGluamVjdHMgYSBsYW5kc2NhcGUgb3JpZW50YXRpb24KCS8vIG1lZGlhIHF1ZXJ5IGludG8gdGhlIGRvY3VtZW50IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4KCS8vIG1ha2VzIGFkanVzdG1lbnRzIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseQoJLy8gZGVjb2RlIHRoZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIFVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgdGhlIHRydWUgb3JpZW50YXRpb24gb2YgdGhlIGRldmljZSBhdCB0aGlzIG1vbWVudC4KCQkvLyBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcCB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkKCQkvLyB1c2UgYSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkgc28gdGhhdCBpZiB0aGUgZGV2aWNlL2Jyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIHBhcnRpY3VsYXIKCQkvLyBtZWRpYSBxdWVyeSwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oJCx3aW5kb3csdW5kZWZpbmVkKXsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbih2YWwpeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwovKgoqICJwYWdlIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7Cgl9LAoKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbShvcHRpb25zLmtlZXBOYXRpdmUpOwoKCQlpZigga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICl7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCIsICIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7Ci8qCiogImNvcmUiIC0gVGhlIGJhc2UgZmlsZSBmb3IgalFtCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fTsKCgkvLyBqUXVlcnkubW9iaWxlIGNvbmZpZ3VyYWJsZSBvcHRpb25zCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJzbGlkZSIsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBTaG93IGxvYWRpbmcgbWVzc2FnZSBkdXJpbmcgQWpheCByZXF1ZXN0cwoJCS8vIGlmIGZhbHNlLCBtZXNzYWdlIHdpbGwgbm90IGFwcGVhciwgYnV0IGxvYWRpbmcgY2xhc3NlcyB3aWxsIHN0aWxsIGJlIHRvZ2dsZWQgb24gaHRtbCBlbAoJCWxvYWRpbmdNZXNzYWdlOiAibG9hZGluZyIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAoJCS8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCQlncmFkZUE6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLmllICYmICQubW9iaWxlLmJyb3dzZXIuaWUgPj0gNzsKCQl9LAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCQkvLyBhcyBwb3NzaWJsZS4KCgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCXZhciBjID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJykKCQkJCS5kYXRhKCJwYWdlIik7CgkJfQoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogY29yZSB1dGlsaXRpZXMgZm9yIGF1dG8gYWpheCBuYXZpZ2F0aW9uLCBiYXNlIHRhZyBtZ210LAoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCQkJJiYgZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiCgkJCQkJJiYgcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYoIHVybEhpc3RvcnkuZ2V0TmV4dCgpICkgewoJCQkJCXVybEhpc3RvcnkuY2xlYXJGb3J3YXJkKCk7CgkJCQl9CgoJCQkJdXJsSGlzdG9yeS5zdGFjay5wdXNoKCB7dXJsIDogdXJsLCB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCB0aXRsZTogdGl0bGUsIHBhZ2VVcmw6IHBhZ2VVcmwsIHJvbGU6IHJvbGUgfSApOwoKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAtIDE7CgkJCX0sCgoJCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJCXVybEhpc3Rvcnkuc3RhY2sgPSB1cmxIaXN0b3J5LnN0YWNrLnNsaWNlKCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSApOwoJCQl9LAoKCQkJZGlyZWN0SGFzaENoYW5nZTogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCQl2YXIgYmFjayAsIGZvcndhcmQsIG5ld0FjdGl2ZUluZGV4LCBwcmV2ID0gdGhpcy5nZXRBY3RpdmUoKTsKCgkJCQkvLyBjaGVjayBpZiB1cmwgaXNwIGluIGhpc3RvcnkgYW5kIGlmIGl0J3MgYWhlYWQgb3IgYmVoaW5kIGN1cnJlbnQgcGFnZQoJCQkJJC5lYWNoKCB1cmxIaXN0b3J5LnN0YWNrLCBmdW5jdGlvbiggaSwgaGlzdG9yeUVudHJ5ICkgewoKCQkJCQkvL2lmIHRoZSB1cmwgaXMgaW4gdGhlIHN0YWNrLCBpdCdzIGEgZm9yd2FyZCBvciBhIGJhY2sKCQkJCQlpZiggb3B0cy5jdXJyZW50VXJsID09PSBoaXN0b3J5RW50cnkudXJsICkgewoJCQkJCQkvL2RlZmluZSBiYWNrIGFuZCBmb3J3YXJkIGJ5IHdoZXRoZXIgdXJsIGlzIG9sZGVyIG9yIG5ld2VyIHRoYW4gY3VycmVudCBwYWdlCgkJCQkJCWJhY2sgPSBpIDwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleDsKCQkJCQkJZm9yd2FyZCA9ICFiYWNrOwoJCQkJCQluZXdBY3RpdmVJbmRleCA9IGk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgPyBuZXdBY3RpdmVJbmRleCA6IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkJaWYoIGJhY2sgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzQmFjayApKCB0cnVlICk7CgkJCQl9IGVsc2UgaWYoIGZvcndhcmQgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzRm9yd2FyZCApKCBmYWxzZSApOwoJCQkJfQoJCQl9LAoKCQkJLy9kaXNhYmxlIGhhc2hjaGFuZ2UgZXZlbnQgbGlzdGVuZXIgaW50ZXJuYWxseSB0byBpZ25vcmUgb25lIGNoYW5nZQoJCQkvL3RvZ2dsZWQgaW50ZXJuYWxseSB3aGVuIGxvY2F0aW9uLmhhc2ggaXMgdXBkYXRlZCB0byBtYXRjaCB0aGUgdXJsIG9mIGEgc3VjY2Vzc2Z1bCBwYWdlIGxvYWQKCQkJaWdub3JlTmV4dEhhc2hDaGFuZ2U6IGZhbHNlCgkJfSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlVXJsKCBsb2NhdGlvbi5ocmVmICksCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBkb2N1bWVudFVybC5ocmVmICkgKSA6IGRvY3VtZW50VXJsLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9ICggZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCi8qCglpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCWZ1bmN0aW9uIHJlRm9jdXMoIHBhZ2UgKSB7CgkJdmFyIHBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0KCQllbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfQoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAnLnVpLXBhZ2UtYWN0aXZlJyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gU2F2ZSB0aGUgbGFzdCBzY3JvbGwgZGlzdGFuY2UgcGVyIHBhZ2UsIGJlZm9yZSBpdCBpcyBoaWRkZW4KCXZhciBzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWUsCgkJZmlyc3RTY3JvbGxFbGVtLCBnZXRTY3JvbGxFbGVtLCBzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglnZXRTY3JvbGxFbGVtID0gZnVuY3Rpb24oKSB7CgkJdmFyIHNjcm9sbEVsZW0gPSAkd2luZG93LCBhY3RpdmVQYWdlLAoJCQl0b3VjaE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQ7CgoJCWlmKCB0b3VjaE92ZXJmbG93ICl7CgkJCWFjdGl2ZVBhZ2UgPSAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlzY3JvbGxFbGVtID0gYWN0aXZlUGFnZS5pcyggIi51aS1uYXRpdmUtZml4ZWQiICkgPyBhY3RpdmVQYWdlLmZpbmQoICIudWktY29udGVudCIgKSA6IGFjdGl2ZVBhZ2U7CgkJfQoKCQlyZXR1cm4gc2Nyb2xsRWxlbTsKCX07CgoJc2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCBzY3JvbGxFbGVtICkgewoJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24gdGhlIGJyb3dzZXIKCQkvLyBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQlpZiggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSBzY3JvbGxFbGVtICYmIHNjcm9sbEVsZW0uc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCwgJCh0aGlzKSApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJIAlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Nyb2xsRWxlbSA9IGdldFNjcm9sbEVsZW0oKTsKCgkgCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCXNjcm9sbEVsZW0udW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCXNjcm9sbEVsZW0uYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCglnZXRTY3JvbGxFbGVtKCkuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE1ha2UgdGhlIGlPUyBjbG9jayBxdWljay1zY3JvbGwgd29yayBhZ2FpbiBpZiB3ZSdyZSB1c2luZyBuYXRpdmUgb3ZlcmZsb3cgc2Nyb2xsaW5nCgkvKgoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICl7CgkJaWYoICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCSQoIHdpbmRvdyApLmJpbmQoICJzY3JvbGxzdG9wIiwgZnVuY3Rpb24oKXsKCQkJCWlmKCAkKCB0aGlzICkuc2Nyb2xsVG9wKCkgPT09IDAgKXsKCQkJCQkkLm1vYmlsZS5hY3RpdmVQYWdlLnNjcm9sbFRvcCggMCApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9CgkqLwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJLy9nZXQgY3VycmVudCBzY3JvbGwgZGlzdGFuY2UKCQl2YXIgYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG91Y2hPdmVyZmxvdyA9ICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICggdG91Y2hPdmVyZmxvdyA/IDAgOiAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApLAoJCQlzY3JlZW5IZWlnaHQgPSBnZXRTY3JlZW5IZWlnaHQoKTsKCgkJLy8gU2Nyb2xsIHRvIHRvcCwgaGlkZSBhZGRyIGJhcgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCgkJaWYoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCWlmKCAhdG91Y2hPdmVyZmxvdyl7CgkJCXRvUGFnZS5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJaWYoIHRvdWNoT3ZlcmZsb3cgJiYgdG9TY3JvbGwgKXsKCgkJCXRvUGFnZS5hZGRDbGFzcyggInVpLW1vYmlsZS1wcmUtdHJhbnNpdGlvbiIgKTsKCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQlyZUZvY3VzKCB0b1BhZ2UgKTsKCgkJCS8vc2V0IHBhZ2UncyBzY3JvbGxUb3AgdG8gcmVtZW1iZXJlZCBkaXN0YW5jZQoJCQlpZiggdG9QYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSApewoJCQkJdG9QYWdlLmZpbmQoICIudWktY29udGVudCIgKS5zY3JvbGxUb3AoIHRvU2Nyb2xsICk7CgkJCX0KCQkJZWxzZXsKCQkJCXRvUGFnZS5zY3JvbGxUb3AoIHRvU2Nyb2xsICk7CgkJCX0KCQl9CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbdHJhbnNpdGlvbiB8fCAibm9uZSJdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy9yZXNldCB0b1BhZ2UgaGVpZ2h0IGJhY2sKCQkJaWYoICF0b3VjaE92ZXJmbG93ICl7CgkJCQl0b1BhZ2UuaGVpZ2h0KCAiIiApOwoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZQoJCQkJcmVGb2N1cyggdG9QYWdlICk7CgkJCX0KCgkJCS8vIEp1bXAgdG8gdG9wIG9yIHByZXYgc2Nyb2xsLCBzb21ldGltZXMgb24gaU9TIHRoZSBwYWdlIGhhcyBub3QgcmVuZGVyZWQgeWV0LgoJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCSQubW9iaWxlLnNpbGVudFNjcm9sbCggdG9TY3JvbGwgKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYoIGZyb21QYWdlICkgewoJCQkJaWYoICF0b3VjaE92ZXJmbG93ICl7CgkJCQkJZnJvbVBhZ2UuaGVpZ2h0KCAiIiApOwoJCQkJfQoKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gZ2V0U2NyZWVuSGVpZ2h0KCl7CgkJdmFyIG9yaWVudGF0aW9uIAk9ICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpLAoJCQlwb3J0CQkJPSBvcmllbnRhdGlvbiA9PT0gInBvcnRyYWl0IiwKCQkJd2luTWluCQkJPSBwb3J0ID8gNDgwIDogMzIwLAoJCQlzY3JlZW5IZWlnaHQJPSBwb3J0ID8gc2NyZWVuLmF2YWlsSGVpZ2h0IDogc2NyZWVuLmF2YWlsV2lkdGgsCgkJCXdpbkhlaWdodAkJPSBNYXRoLm1heCggd2luTWluLCAkKCB3aW5kb3cgKS5oZWlnaHQoKSApLAoJCQlwYWdlTWluCQkJPSBNYXRoLm1pbiggc2NyZWVuSGVpZ2h0LCB3aW5IZWlnaHQgKTsKCgkJcmV0dXJuIHBhZ2VNaW47Cgl9CgoJJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0ID0gZ2V0U2NyZWVuSGVpZ2h0OwoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCS8vIERvbid0IGFwcGx5IHRoaXMgaGVpZ2h0IGluIHRvdWNoIG92ZXJmbG93IGVuYWJsZWQgbW9kZQoJCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApewoJCQlyZXR1cm47CgkJfQoJCSQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmNzcyggIm1pbi1oZWlnaHQiLCBnZXRTY3JlZW5IZWlnaHQoKSApOwoJfQoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCi8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcwkgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggJ3dlYmtpdEFuaW1hdGlvbkVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZGVmYXVsdCBub24tYW5pbWF0aW9uIHRyYW5zaXRpb24gaGFuZGxlcgoJJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyID0gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0b1BhZ2UsICRmcm9tUGFnZSApIHsKCQlpZiAoICRmcm9tUGFnZSApIHsKCQkJJGZyb21QYWdlLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQl9CgkJJHRvUGFnZS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgoJCXJldHVybiAkLkRlZmVycmVkKCkucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvUGFnZSwgJGZyb21QYWdlICkucHJvbWlzZSgpOwoJfTsKCgkvL2RlZmF1bHQgaGFuZGxlciBmb3IgdW5rbm93biB0cmFuc2l0aW9ucwoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyOwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCW5vbmU6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcgoJfTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKGFzUGFyc2VkT2JqZWN0KSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudFVybCApIDogZG9jdW1lbnRVcmwuaHJlZjsKCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRCYXNlICkgOiBkb2N1bWVudEJhc2UuaHJlZjsKCX07CgoJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSAkKHRoaXMpOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiggIXBhZ2UuZGF0YSgicGFnZSIpLm9wdGlvbnMuZG9tQ2FjaGUKCQkJCSYmIHBhZ2UuaXMoIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIpICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfTsKCgkvLyBMb2FkIGEgcGFnZSBpbnRvIHRoZSBET00uCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkvLyBrbm93IHdoZW4gdGhlIHBhZ2UgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkJLy8gVGhlIGRlZmF1bHQgbG9hZFBhZ2Ugb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkKCQkJLy8gdGhlIGNhbGxlci4KCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgoJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBwYWdlIGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJcGFnZSA9IG51bGwsCgoJCQkvLyBJZiB0aGUgcmVsb2FkUGFnZSBvcHRpb24gaXMgdHJ1ZSwgYW5kIHRoZSBwYWdlIGlzIGFscmVhZHkKCQkJLy8gaW4gdGhlIERPTSwgZHVwQ2FjaGVkUGFnZSB3aWxsIGJlIHNldCB0byB0aGUgcGFnZSBlbGVtZW50CgkJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHJlbW92ZWQgYWZ0ZXIgdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZQoJCQkvLyBwYWdlIGlzIGxvYWRlZCBvZmYgdGhlIG5ldHdvcmsuCgkJCWR1cENhY2hlZFBhZ2UgPSBudWxsLAoKCQkJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCgkJCWZpbmRCYXNlV2l0aERlZmF1bHQgPSBmdW5jdGlvbigpewoJCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQkJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQkJfSwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiggIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICl7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIHBhZ2UgdG8gYmUgbG9hZGVkLgoJCXZhciBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggYWJzVXJsICksCgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBwYWdlLiBGb3IgZW1iZWRkZWQgcGFnZXMsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IgcGFnZXMKCQkJLy8gd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUgcmVsYXRpdmUKCQkJLy8gcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBwYWdlcyAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgcGFnZS4KCQkJZGF0YVVybCA9IHBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzVXJsICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICI6anFtRGF0YSh1cmw9JyIgKyBkYXRhVXJsICsgIicpIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApOwoJCX0KCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UKCQkvLyB0byB0aGUgZmlyc3QgcGFnZSBhbmQgcmVmZXJzIHRvIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlLCBlcnJvciBvdXQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UgJiYgcGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICkgewoJCQkJLy8gQ2hlY2sgdG8gbWFrZSBzdXJlIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseQoJCQkJLy8gaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0CgkJCQkvLyBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLCB3ZSBjaGVjayBmb3IgdGhpcwoJCQkJLy8gY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aCBhbiBpZAoJCQkJLy8gZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvcgoJCQkJLy8gY2FzZS4gSWYgdGhlIGZpcnN0LXBhZ2UgaXMgbm90IGluIHRoZSBET00sIHRoZW4gd2UgbGV0CgkJCQkvLyB0aGluZ3MgZmFsbCB0aHJvdWdoIHRvIHRoZSBhamF4IGxvYWRpbmcgY29kZSBiZWxvdyBzbwoJCQkJLy8gdGhhdCBpdCBnZXRzIHJlbG9hZGVkLgoJCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkubGVuZ3RoICkgewoJCQkJCXBhZ2UgPSAkKCAkLm1vYmlsZS5maXJzdFBhZ2UgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggZmlsZVVybCApICApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJfQoKCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJaWYgKCBiYXNlICkgewoJCQliYXNlLnJlc2V0KCk7CgkJfQoKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKXsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkKCQkJCQkJCSYmIFJlZ0V4cC4kMQoJCQkJCQkJJiYgZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApCgkJCQkJCQkmJiBSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBSZWdFeHAuJDEgKTsKCQkJCQl9CgoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYoICFwYWdlLmxlbmd0aCApewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKHRoaXMpLmlzKCdbc3JjXScpID8gJ3NyYycgOiAnYWN0aW9uJywKCQkJCQkJCQl0aGlzVXJsID0gJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAnJyApOwoKCQkJCQkJCWlmKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICI6anFtRGF0YSh1cmw9JyIgKyBkYXRhVXJsICsgIicpIiApOwoJCQkJCX0KCgkJCQkJLy9iaW5kIHBhZ2VIaWRlIHRvIHJlbW92ZVBhZ2UgYWZ0ZXIgaXQncyBoaWRkZW4sIGlmIHRoZSBwYWdlIG9wdGlvbnMgc3BlY2lmeSB0byBkbyBzbwoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYoIHBsZkV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQoICI8ZGl2IGNsYXNzPSd1aS1sb2FkZXIgdWktb3ZlcmxheS1zaGFkb3cgdWktYm9keS1lIHVpLWNvcm5lci1hbGwnPjxoMT4iKyAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSArIjwvaDE+PC9kaXY+IiApCgkJCQkJCQkuY3NzKHsgImRpc3BsYXkiOiAiYmxvY2siLCAib3BhY2l0eSI6IDAuOTYsICJ0b3AiOiAkd2luZG93LnNjcm9sbFRvcCgpICsgMTAwIH0pCgkJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKQoJCQkJCQkJLmRlbGF5KCA4MDAgKQoJCQkJCQkJLmZhZGVPdXQoIDQwMCwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJJCggdGhpcyApLnJlbW92ZSgpOwoJCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT0gInN0cmluZyIgKSB7CgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudCBtYW51YWxseS9keW5hbWljYWxseQoJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCS8vIHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbgoJCS8vIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4KCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJLy8gZm9ybVBhZ2UgYW5kIHRvUGFnZSBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LgoJCS8vIEl0IGlzIHVwIHRvIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbgoJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQlpZiggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAtMTsgfSwKCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAxOyB9CgkJCX0pOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdib2R5JykgewoJCQkJJChkb2N1bWVudC5hY3RpdmVFbGVtZW50KS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaChlKSB7fQoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICkgKyBkaWFsb2dIYXNoS2V5OwoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiB1cmwgKSB7CgkJCS8vZGlzYWJsZSBoYXNoIGxpc3RlbmluZyB0ZW1wb3JhcmlseQoJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdHJ1ZTsKCQkJLy91cGRhdGUgaGFzaCBhbmQgaGlzdG9yeQoJCQlwYXRoLnNldCggdXJsICk7CgkJfQoKCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0IHVzZSBwYWdlVGl0bGUKCQl2YXIgbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICk/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwgdG9QYWdlLmNoaWxkcmVuKCI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIpLmZpbmQoIi51aS10aXRsZSIgKS5nZXRFbmNvZGVkVGV4dCgpOwoJCWlmKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24KCQkJfHwgKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkKCQkJfHwgKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiggIWhpc3RvcnlEaXIgKSB7CgkJCXVybEhpc3RvcnkuYWRkTmV3KCB1cmwsIHNldHRpbmdzLnRyYW5zaXRpb24sIHBhZ2VUaXRsZSwgcGFnZVVybCwgc2V0dGluZ3Mucm9sZSApOwoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS50aXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbigpIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFsbCBkb25lIGNoYW5naW5nIHRoZSBjdXJyZW50IHBhZ2UuCgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCl7CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJJHRoaXMuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCXZhciB0eXBlID0gJHRoaXMuYXR0ciggIm1ldGhvZCIgKSwKCQkJCXRhcmdldCA9ICR0aGlzLmF0dHIoICJ0YXJnZXQiICksCgkJCQl1cmwgPSAkdGhpcy5hdHRyKCAiYWN0aW9uIiApOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKTsKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoJHRoaXMpICk7CgoJCQlpZigoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoZG9jdW1lbnRVcmwsIHVybCkpIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCWRpcmVjdGlvbjoJJHRoaXMuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoJCQlpZiAoIGxpbmsgKSB7CgkJCQlpZiAoIHBhdGgucGFyc2VVcmwoIGxpbmsuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSB7CgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJCggbGluayApLmNsb3Nlc3QoICIudWktYnRuIiApLm5vdCggIi51aS1kaXNhYmxlZCIgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAudWktYnRuIiApLm5vdCggbGluayApLmJsdXIoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgJGxpbmsgPSAkKCBsaW5rICksCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoZG9jdW1lbnRVcmwsIGhyZWYpICk7CgoJCQlpZiggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdmFyIHRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCWRpcmVjdGlvbiA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICksCgkJCQlyZXZlcnNlID0gKCBkaXJlY3Rpb24gJiYgZGlyZWN0aW9uID09PSAicmV2ZXJzZSIgKSB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgJGxpbmsgPSAkKHRoaXMpLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHtyb2xlOiAkbGluay5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiKX0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIGhhc2ggKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKCBoYXNoICksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQkvL2lmIGxpc3RlbmluZyBpcyBkaXNhYmxlZCAoZWl0aGVyIGdsb2JhbGx5IG9yIHRlbXBvcmFyaWx5KSwgb3IgaXQncyBhIGRpYWxvZyBoYXNoCgkJCWlmKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmKCB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA+IDEgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZighJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkpIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoJCQkJCQlpc0JhY2s6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5iYWNrKCk7IH0sCgkJCQkJCWlzRm9yd2FyZDogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsgfQoJCQkJCX0pOwoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UoKQoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCgkJCQkJCS8vIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgaGlzdG9yeSBjaGFuZ2UKCQkJCQkJLy8gZG8gdGhlIGZvbGxvd2luZwoJCQkJCQllaXRoZXI6IGZ1bmN0aW9uKCBpc0JhY2sgKSB7CgkJCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJCQl0byA9IGFjdGl2ZS5wYWdlVXJsOwoKCQkJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQkJCXRyYW5zaXRpb246CSBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQkJCQlyZXZlcnNlOiBpc0JhY2sKCQkJCQkJCX0pOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vaWYgdG8gaXMgZGVmaW5lZCwgbG9hZCBpdAoJCQlpZiAoIHRvICkgewoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlIGVsZW1lbnQgZnJvbQoJCQkJLy8gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZS9hYnNvbHV0ZSBVUkwuIElmICd0bycgaXMKCQkJCS8vIGFuIGlkLCB3ZSBuZWVkIHRvIHJlc29sdmUgaXQgYWdhaW5zdCB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsCgkJCQkvLyBzaW5jZSB0aGUgaGFzaGNoYW5nZSBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsIHBhZ2UvZGlhbG9nLgoJCQkJdG8gPSAoIHR5cGVvZiB0byA9PT0gInN0cmluZyIgJiYgIXBhdGguaXNQYXRoKCB0byApICkgPyAoIHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB0bywgZG9jdW1lbnRCYXNlICkgKSA6IHRvOwoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgkJCQkvL3RoZXJlJ3Mgbm8gaGFzaCwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGRvbQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CgkJfTsKCgkJLy9oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXIKCQkkd2luZG93LmJpbmQoICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oIGUsIHRyaWdnZXJlZCApIHsKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIGxvY2F0aW9uLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgY2FsbGJhY2sKCn0pKCBqUXVlcnkgKTsKLyoKKiBoaXN0b3J5LnB1c2hTdGF0ZSBzdXBwb3J0LCBsYXllcmVkIG9uIHRvcCBvZiBoYXNoY2hhbmdlCiovCgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggbG9jYXRpb24uaHJlZiApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJLy8gRmxhZyBmb3IgdHJhY2tpbmcgaWYgYSBIYXNoY2hhbmdlIG5hdHVyYWxseSBvY2N1cnMgYWZ0ZXIgZWFjaCBwb3BzdGF0ZSArIHJlcGxhY2UKCQloYXNoY2hhbmdlRmlyZWQ6IGZhbHNlLAoKCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB7CgkJCQloYXNoOiBsb2NhdGlvbi5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYoIGRpYWxvZ0luZGV4ID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc2xpY2UoIDAsIGRpYWxvZ0luZGV4ICkgKyAiIyIgKyB1cmwuc2xpY2UoIGRpYWxvZ0luZGV4ICk7CgkJCX0gZWxzZSBpZiggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoJCQkKCQkJdmFyIGhyZWYsIHN0YXRlLAoJCQkJaGFzaCA9IGxvY2F0aW9uLmhhc2gsCgkJCQlpc1BhdGggPSAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApLAoJCQkJcmVzb2x1dGlvblVybCA9IGlzUGF0aCA/IGxvY2F0aW9uLmhyZWYgOiAkLm1vYmlsZS5nZXREb2N1bWVudFVybCgpOwoJCQloYXNoID0gaXNQYXRoID8gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiBoYXNoOwoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgd2luZG93Lmhpc3RvcnkuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLCBob2xkbmV4dGhhc2hjaGFuZ2UgPSBmYWxzZTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gc3RhdGUgaXRzIG5vdCBhIHBvcHN0YXRlIHdlIGNhcmUgYWJvdXQsIGllIGNocm9tZSdzIGluaXRpYWwgcG9wc3RhdGUKCQkJLy8gb3IgZm9yd2FyZCBwb3BzdGF0ZQoJCQlpZiggcG9wcGVkU3RhdGUgKSB7CgkJCQkvLyBkaXNhYmxlIGFueSBoYXNoY2hhbmdlIHRyaWdnZXJlZCBieSB0aGUgYnJvd3NlcgoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIGRlZmVyIG91ciBtYW51YWwgaGFzaGNoYW5nZSB1bnRpbCBhZnRlciB0aGUgYnJvd3NlciBmaXJlZAoJCQkJLy8gdmVyc2lvbiBoYXMgY29tZSBhbmQgZ29uZQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCB0aGUgbWFudWFsIGhhc2ggaGFuZGxpbmcgdGFrZXMgcGxhY2UKCQkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCQkvLyBjaGFuZ2UgdGhlIHBhZ2UgYmFzZWQgb24gdGhlIGhhc2gKCQkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoJCQkJfSwgMTAwKTsKCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsIGxvY2F0aW9uLmhyZWYgKTsKCQkJfQoJCX0KCX0pOwoKCSQoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiAidHJhbnNpdGlvbnMiIHBsdWdpbiAtIFBhZ2UgY2hhbmdlIHRyYW5pc3Rpb25zCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gY3NzM1RyYW5zaXRpb25IYW5kbGVyKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQl2aWV3cG9ydENsYXNzID0gInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lLAoJCWRvbmVGdW5jID0gZnVuY3Rpb24oKSB7CgoJCQkkdG8uYWRkKCAkZnJvbSApLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKTsKCgkJCWlmICggJGZyb20gJiYgJGZyb21bIDAgXSAhPT0gJHRvWyAwIF0gKSB7CgkJCQkkZnJvbS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgkJCX0KCgkJCSR0by5wYXJlbnQoKS5yZW1vdmVDbGFzcyggdmlld3BvcnRDbGFzcyApOwoKCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApOwoJCX07CgoJJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lRnVuYyApOwoKCSR0by5wYXJlbnQoKS5hZGRDbGFzcyggdmlld3BvcnRDbGFzcyApOwoKCWlmICggJGZyb20gKSB7CgkJJGZyb20uYWRkQ2xhc3MoIG5hbWUgKyAiIG91dCIgKyByZXZlcnNlQ2xhc3MgKTsKCX0KCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAiICsgbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgoJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKfQoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHB1YmxpYy4KJC5tb2JpbGUuY3NzM1RyYW5zaXRpb25IYW5kbGVyID0gY3NzM1RyYW5zaXRpb25IYW5kbGVyOwoKLy8gSWYgdGhlIGRlZmF1bHQgdHJhbnNpdGlvbiBoYW5kbGVyIGlzIHRoZSAnbm9uZScgaGFuZGxlciwgcmVwbGFjZSBpdCB3aXRoIG91ciBoYW5kbGVyLgppZiAoICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9PT0gJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyICkgewoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gY3NzM1RyYW5zaXRpb25IYW5kbGVyOwp9Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogImRlZ3JhZGVJbnB1dHMiIHBsdWdpbiAtIGRlZ3JhZGVzIGlucHV0cyB0byBhbm90aGVyIHR5cGUgYWZ0ZXIgY3VzdG9tIGVuaGFuY2VtZW50cyBhcmUgbWFkZS4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoZS50YXJnZXQpICk7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJkaWFsb2ciIHBsdWdpbi4KKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbC5hdHRyKCAicm9sZSIsICJkaWFsb2ciICkKCQkJLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCB1aS1vdmVybGF5LXNoYWRvdyIgKQoJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJLmVuZCgpCgkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0nY29udGVudCcpLDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIgKQoJCQkJLmxhc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkgIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KQoJCS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJCggdGhpcyApLmRpYWxvZygpOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBUaGlzIHBsdWdpbiBoYW5kbGVzIHRoZW1pbmcgYW5kIGxheW91dCBvZiBoZWFkZXJzLCBmb290ZXJzLCBhbmQgY29udGVudCBhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQoJdmFyICRwYWdlID0gJCggdGhpcyApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCQoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgdGhpcyApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoJCQkKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CQoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEiICk7CgkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoJCQkKCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmIAoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkdGhpcy5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsJCQkJCgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkidGFiaW5kZXgiOiAiMCIsCgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkgICAgJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiAiY29sbGFwc2libGUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaWNvblRoZW1lOiAiZCIsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgkJfQoKCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICggby5jb250ZW50VGhlbWUgKSA/ICggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICkgOiAiIik7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvblBvczogImxlZnQiLAoJCQkJCWljb246ICJwbHVzIiwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSkKCQkJLmFkZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkgICAgY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UpCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tbWludXMiLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLXBsdXMiLCBpc0NvbGxhcHNlICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPwoJCQkJCQkJCQkJImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLmNvbGxhcHNpYmxlKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJjb2xsYXBzaWJsZXNldCIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkZWwuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApLAoJCQkJCQl3aWRnZXQgPSBjb2xsYXBzaWJsZS5kYXRhKCAiY29sbGFwc2libGUiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IHdpZGdldC5vcHRpb25zLmNvbnRlbnRUaGVtZTsKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggd2lkZ2V0Lm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoKCQkJCX0pOwoKCQkJLy8gY2xlYW4gdXAgYm9yZGVycwoJCQljb2xsYXBzaWJsZXNJblNldC5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkaW5nICkKCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCS5hZGQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoJCQl9KTsKCgkJCWNvbGxhcHNpYmxlc0luU2V0LmZpcnN0KCkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQoJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCQljb2xsYXBzaWJsZXNJblNldC5sYXN0KCkKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApCgkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCQl9Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5jb2xsYXBzaWJsZXNldCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiZmllbGRjb250YWluIiBwbHVnaW4gLSBzaW1wbGUgY2xhc3MgYWRkaXRpb25zIHRvIG1ha2UgZm9ybSByb3cgc2VwYXJhdG9ycwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiBwbHVnaW4gZm9yIGNyZWF0aW5nIENTUyBncmlkcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSxvcHRpb25zKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHtzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NX0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDNuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNG4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCg1bis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsvKgoqICJuYXZiYXIiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLm5vdCggIi51aS1zdGF0ZS1wZXJzaXN0IiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubmF2YmFyKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJsaXN0dmlldyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzOwoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXcgIiArICggdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyAiIDogIiIgKTsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9yZW1vdmVDb3JuZXJzOiBmdW5jdGlvbiggbGksIHdoaWNoICkgewoJCXZhciB0b3AgPSAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItdHIgdWktY29ybmVyLXRsIiwKCQkJYm90ID0gInVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWJyIHVpLWNvcm5lci1ibCI7CgoJCWxpID0gbGkuYWRkKCBsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciwgLnVpLWxpLWxpbmstYWx0LCAudWktbGktdGh1bWIiICkgKTsKCgkJaWYgKCB3aGljaCA9PT0gInRvcCIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKTsKCQl9IGVsc2UgaWYgKCB3aGljaCA9PT0gImJvdHRvbSIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCBib3QgKTsKCQl9IGVsc2UgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICsgIiAiICsgYm90ICk7CgkJfQoJfSwKCglfcmVmcmVzaENvcm5lcnM6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyICRsaSwKCQkJJHZpc2libGVsaSwKCQkJJHRvcGxpLAoJCQkkYm90dG9tbGk7CgoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQkkbGkgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJsaSIgKTsKCQkJLy8gYXQgY3JlYXRlIHRpbWUgdGhlIGxpIGFyZSBub3QgdmlzaWJsZSB5ZXQgc28gd2UgbmVlZCB0byByZWx5IG9uIC51aS1zY3JlZW4taGlkZGVuCgkJCSR2aXNpYmxlbGkgPSBjcmVhdGU/JGxpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOiRsaS5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCgkJCXRoaXMuX3JlbW92ZUNvcm5lcnMoICRsaSApOwoKCQkJLy8gU2VsZWN0IHRoZSBmaXJzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJHRvcGxpID0gJHZpc2libGVsaS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApOwoKCQkJJHRvcGxpLmFkZCggJHRvcGxpLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCwgLnVpLWxpLWxpbmstYWx0IHNwYW46Zmlyc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdHIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRsIiApOwoKCQkJLy8gU2VsZWN0IHRoZSBsYXN0IHZpc2libGUgbGkgZWxlbWVudAoJCQkkYm90dG9tbGkgPSAkdmlzaWJsZWxpLmxhc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoIi51aS1saS1pY29uIikKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKQoJewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApCgl7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCWNvdW50ZXIgPSAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCB8fCAhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApID8gMCA6IDEsCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWc7CgoJCWlmICggY291bnRlciApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoJCQoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoInRoZW1lIikgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoKCQkJCWlmICggYS5sZW5ndGggKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSgiaWNvbiIpOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8ICJhcnJvdy1yIiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPSBmYWxzZSApICYmICggYS5sZW5ndGggPT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCAidWktbGluay1pbmhlcml0IiApOwoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBsaXN0c3BsaXR0aGVtZSB8fCBsYXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWU7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKGl0ZW0pCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6IGZhbHNlCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQlpY29uOiBsaXN0c3BsaXRpY29uIHx8IGxhc3QuanFtRGF0YSggImljb24iICkgfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGl0ZW0uanFtRGF0YSggInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJ0biB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJaWYgKCBjb3VudGVyICkgewoJCQkJCQljb3VudGVyID0gMTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYm9keS0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvdW50ZXIgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbS5pcyggIi51aS1saS1zdGF0aWM6Zmlyc3QiICkgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKGNvdW50ZXIrKykgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fcmVmcmVzaENvcm5lcnMoIGNyZWF0ZSApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHMgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVscy5sZW5ndGggPyBub2RlRWxzIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArCWRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIpIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCdhOmZpcnN0Jyk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKXsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTDsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsiJykiKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLmxpc3R2aWV3KCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJsaXN0dmlldyIgZmlsdGVyIGV4dGVuc2lvbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlICl7CglyZXR1cm4gdGV4dC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwp9OwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW07CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZihsYXN0dmFsKSAhPT0gMCApIHsKCgkJCQkvLyBSZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgkJCX0KCQkJbGlzdHZpZXcuX3JlZnJlc2hDb3JuZXJzKCk7CgkJfSkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoICQoIHRoaXMgKS5qcW1EYXRhKCAiaW5zZXQiICkgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJub2pzIiBwbHVnaW4gLSBjbGFzcyB0byBtYWtlIGVsZW1lbnRzIGhpZGRlbiB0byBBIGdyYWRlIGJyb3dzZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJbGFiZWwgPSBpbnB1dC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkuZmluZCggImxhYmVsIiApLmZpbHRlciggIltmb3I9JyIgKyBpbnB1dFsgMCBdLmlkICsgIiddIiApLAoJCQlpbnB1dHR5cGUgPSBpbnB1dC5hdHRyKCAidHlwZSIgKSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29uID0gaW5wdXQucGFyZW50cyggIjpqcW1EYXRhKHR5cGU9J2hvcml6b250YWwnKSIgKS5sZW5ndGggPyB1bmRlZmluZWQgOiB1bmNoZWNrZWRTdGF0ZSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZS4uLgoJCWlmKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSB0aGlzLmVsZW1lbnQuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZQoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJaW5wdXQuYWRkKCBsYWJlbCApCgkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0ndWktIiArIGlucHV0dHlwZSArICInPjwvZGl2PiIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCgkdGhpcykucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJJHRoaXMuanFtRGF0YSggImNhY2hlVmFsIiwgJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpewoJCWlmKHRoaXMuaW5wdXR0eXBlID09ICJjaGVja2JveCIpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIisgdGhpcy5lbGVtZW50LmF0dHIoICJuYW1lIiApICsiJ11bdHlwZT0nIisgdGhpcy5pbnB1dHR5cGUgKyInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQkvLyBpbnB1dFswXS5jaGVja2VkIGV4cGFuZG8gZG9lc24ndCBhbHdheXMgcmVwb3J0IHRoZSBwcm9wZXIgdmFsdWUKCQkvLyBmb3IgY2hlY2tlZD0nY2hlY2tlZCcKCQlpZiAoICQoIGlucHV0WyAwIF0gKS5wcm9wKCAiY2hlY2tlZCIgKSApIHsKCgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgoJCX0gZWxzZSB7CgoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9uIiBwbHVnaW4gLSBsaW5rcyB0aGF0IHByb3h5IHRvIG5hdGl2ZSBpbnB1dC9idXR0b25zCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSwgW3R5cGU9J2ltYWdlJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSAkZWwuYnV0dG9uTWFya3VwKCk7CgkgCSAJcmV0dXJuOwogCSAJfQoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93CgkJCX0pCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNu4oCZdCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmKCAkYnV0dG9uUGxhY2Vob2xkZXIgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gJCggIjxpbnB1dD4iLCB7CgkJCQkJCQl0eXBlOiAiaGlkZGVuIiwKCQkJCQkJCW5hbWU6ICRlbC5hdHRyKCAibmFtZSIgKSwKCQkJCQkJCXZhbHVlOiAkZWwuYXR0ciggInZhbHVlIiApCgkJCQkJCX0pLmluc2VydEJlZm9yZSggJGVsICk7CgoJCQkJCQkvLyBCaW5kIHRvIGRvYyB0byByZW1vdmUgYWZ0ZXIgc3VibWl0IGhhbmRsaW5nCgkJCQkJCSQoIGRvY3VtZW50ICkub25lKCJzdWJtaXQiLCBmdW5jdGlvbigpewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIHRoZSB0ZXh0V3JhcHBlciBpcyBzdG9yZWQgYXMgYSBkYXRhIGVsZW1lbnQgb24gdGhlIGJ1dHRvbiBvYmplY3QKCQkvLyB0byBwcmV2ZW50IHJlZmVyZW5jaW5nIGJ5IGl0J3MgaW1wbGVtZW50YXRpb24gZGV0YWlscyAoZWcgJ2NsYXNzJykKCQl0aGlzLmJ1dHRvbi5kYXRhKCAndGV4dFdyYXBwZXInICkudGV4dCggJGVsLnRleHQoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJzbGlkZXIiIHBsdWdpbgoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlzbGlkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyICIgKyBzZWxlY3RDbGFzcyArICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgKwoJCQkJCQkJCQkiIHVpLWJ0bi1jb3JuZXItYWxsJyByb2xlPSdhcHBsaWNhdGlvbic+PC9kaXY+IiApLAoKCQkJaGFuZGxlID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1zbGlkZXItaGFuZGxlJz48L2E+IiApCgkJCQkuYXBwZW5kVG8oIHNsaWRlciApCgkJCQkuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pLAoJCQlvcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgoJCQlzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQljb250cm9sLmZpbmQoICJvcHRpb24iICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQljb3JuZXJzID0gIWkgPyAicmlnaHQiIDoibGVmdCIsCgkJCQkJdGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsYmcgdWktc2xpZGVyLWxhYmVsYmctIiArIHNpZGUgKyB0aGVtZSArICIgdWktYnRuLWNvcm5lci0iICsgY29ybmVycyArICInPjwvZGl2PiIgKQoJCQkJCS5wcmVwZW5kVG8oIHNsaWRlciApOwoKCQkJCSQoICI8c3BhbiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iICsgc2lkZSArIHRoZW1lICsgIiB1aS1idG4tY29ybmVyLSIgKyBjb3JuZXJzICsgIicgcm9sZT0naW1nJz4iICsgJCggdGhpcyApLmdldEVuY29kZWRUZXh0KCkgKyAiPC9zcGFuPiIgKQoJCQkJCS5wcmVwZW5kVG8oIGhhbmRsZSApOwoJCQl9KTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoIXNlbGYubW91c2VNb3ZlZCkgewoJCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLmtleXVwKCBmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1ciggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQkvLyBwcmV2ZW50IHNjcmVlbiBkcmFnIHdoZW4gc2xpZGVyIGFjdGl2YXRlZAoJCSQoIGRvY3VtZW50ICkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCgkJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgoJCQkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQkJfQoKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJdGhpcy5oYW5kbGUKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLmhhbmRsZQoJCQkuYmluZCggImtleWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQlicmVhazsKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJYnJlYWs7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCWJyZWFrOwoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfSkgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgkJCS5rZXl1cCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2godW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJdmFyIGNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsIHBlcmNlbnQsCgkJCWNUeXBlID0gY29udHJvbFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQltaW4gPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGggLSAxLAoJCQlzdGVwID0gKGNUeXBlID09PSAiaW5wdXQiICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDApID8gcGFyc2VGbG9hdChjb250cm9sLmF0dHIoInN0ZXAiKSkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQl2YXIgZGF0YSA9IHZhbCwKCQkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJCXRvbCA9IDg7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0ICsgdGhpcy5zbGlkZXIud2lkdGgoKSArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0ICkgLyB0aGlzLnNsaWRlci53aWR0aCgpICkgKiAxMDAgKTsKCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl0aGlzLmhhbmRsZS5hdHRyKCB7CgkJCQkiYXJpYS12YWx1ZW5vdyI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICksCgkJCQkiYXJpYS12YWx1ZXRleHQiOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSwKCQkJCXRpdGxlOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKQoJCQl9KTsKCgkJLy8gYWRkL3JlbW92ZSBjbGFzc2VzIGZvciBmbGlwIHRvZ2dsZSBzd2l0Y2gKCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJaWYgKCBuZXd2YWwgPT09IDAgKSB7CgkJCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLXNsaWRlci1zd2l0Y2gtYSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1zd2l0Y2gtYiIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1iIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1hIiApOwoJCQl9CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBjVHlwZSA9PT0gImlucHV0IiApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAidGV4dGlucHV0IiBwbHVnaW4gZm9yIHRleHQgaW5wdXRzLCB0ZXh0YXJlYXMKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSkiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQlmb2N1c2VkRWwsIGNsZWFyYnRuOwoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCgkJLy8ic2VhcmNoIiBpbnB1dCB3aWRnZXQKCQlpZiAoIGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9J2NsZWFyIHRleHQnPmNsZWFyIHRleHQ8L2E+IiApCgkJCQkudGFwKGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dC52YWwoICIiICkuZm9jdXMoKTsKCQkJCQlpbnB1dC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUKCQkJCX0pOwoKCQkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCQl9LCAwKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggInVpLWZvY3VzIiApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQkJaW5wdXQuaGVpZ2h0KHNjcm9sbEhlaWdodCArIGV4dHJhTGluZUhlaWdodCk7CgkJCQkJfQoJCQkJfSwKCQkJCWtleXVwVGltZW91dDsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIGtleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgkJCX0KCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoJCSggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlKS5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSA/CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudCApLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKXsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNjcmVlbiA9ICQoICI8ZGl2PiIsIHsiY2xhc3MiOiAidWktc2VsZWN0bWVudS1zY3JlZW4gdWktc2NyZWVuLWhpZGRlbiJ9ICkuYXBwZW5kVG8oIHRoaXNQYWdlICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCksCgoJCQlsaXN0Ym94ID0gICQoIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSB1aS1zZWxlY3RtZW51LWhpZGRlbiB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArICIgIiArICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIH0gKS5pbnNlcnRBZnRlcihzY3JlZW4pLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKSwKCgkJCW1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKSwKCgkJCW1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2NyZWVuOiBzY3JlZW4sCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudHlwZSA9PSAidmNsaWNrIiB8fAoJCQkJCQkJIGV2ZW50LmtleUNvZGUgJiYgKCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApICkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5kZWxlZ2F0ZSggIi51aS1saT5hIiwgImZvY3VzaW4iLCBmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLmF0dHIoICJ0YWJpbmRleCIsICIwIiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAiLnVpLWxpPmEiLCAiZm9jdXNvdXQiLCBmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5CgkJCQkJCWlmICggIXNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpOwoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCSBjYXNlIDEzOgoJCQkJCQkgY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uICJzY3JlZW4iIG92ZXJsYXkKCQkJCXNlbGYuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKXsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLAoJCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCQkvLyByZXR1cm4gYW4gYXJyYXkgb2YgYWxsIHNlbGVjdGVkIGluZGV4J3MKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJfSwKCgkJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAicGFnZSIgKSB7CgkJCQkJLy8gZG9lc24ndCBzb2x2ZSB0aGUgcG9zc2libGUgaXNzdWUgd2l0aCBjYWxsaW5nIGNoYW5nZSBwYWdlCgkJCQkJLy8gd2hlcmUgdGhlIG9iamVjdHMgZG9uJ3QgZGVmaW5lIGRhdGEgdXJscyB3aGljaCBwcmV2ZW50cyBkaWFsb2cga2V5CgkJCQkJLy8gc3RyaXBwaW5nIC0gY2hhbmdlUGFnZSBoYXMgaW5jb21pbmcgcmVmYWN0b3IKCQkJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYuc2NyZWVuLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCQlzZWxmLmxpc3Rib3guYWRkQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKS5yZW1vdmVBdHRyKCAic3R5bGUiICkucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQl9CgoJCQkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQkJCXNlbGYuaXNPcGVuID0gZmFsc2U7CgkJCX0sCgoJCQlvcGVuOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbWVudUhlaWdodCA9IHNlbGYubGlzdC5wYXJlbnQoKS5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGYubGlzdC5wYXJlbnQoKS5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIudWktcGFnZS1hY3RpdmUiICksCgkJCQkJdE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQsCgkJCQkJdFNjcm9sbEVsZW0gPSBhY3RpdmVQYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSA/IGFjdGl2ZVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApIDogYWN0aXZlUGFnZSwKCQkJCQlzY3JvbGxUb3AgPSB0T3ZlcmZsb3cgPyB0U2Nyb2xsRWxlbS5zY3JvbGxUb3AoKSA6ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZm9jdXMoKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQkvLyBzaWxlbnRTY3JvbGwoKSBpcyBjYWxsZWQgd2hlbmV2ZXIgYSBwYWdlIGlzIHNob3duIHRvIHJlc3RvcmUKCQkJCQkJLy8gYW55IHByZXZpb3VzIHNjcm9sbCBwb3NpdGlvbiB0aGUgcGFnZSBtYXkgaGF2ZSBoYWQuIFdlIG5lZWQgdG8KCQkJCQkJLy8gd2FpdCBmb3IgdGhlICJzaWxlbnRzY3JvbGwiIGV2ZW50IGJlZm9yZSBzZXR0aW5nIGZvY3VzIHRvIGF2b2lkCgkJCQkJCS8vIHRoZSBicm93c2VyInMgImZlYXR1cmUiIHdoaWNoIG9mZnNldHMgcmVuZGVyaW5nIHRvIG1ha2Ugc3VyZQoJCQkJCQkvLyB3aGF0ZXZlciBoYXMgZm9jdXMgaXMgaW4gdmlldy4KCQkJCQkJJCggd2luZG93ICkub25lKCAic2lsZW50c2Nyb2xsIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pOwoKCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggc2VsZi5tZW51UGFnZSwgewoJCQkJCQl0cmFuc2l0aW9uOiAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbgoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLnNjcmVlbi5oZWlnaHQoICQoZG9jdW1lbnQpLmhlaWdodCgpICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCgkJCQkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgYnV0dG9uCgkJCQkJdmFyIHJvb210b3AgPSBidG5PZmZzZXQgLSBzY3JvbGxUb3AsCgkJCQkJCXJvb21ib3QgPSBzY3JvbGxUb3AgKyBzY3JlZW5IZWlnaHQgLSBidG5PZmZzZXQsCgkJCQkJCWhhbGZoZWlnaHQgPSBtZW51SGVpZ2h0IC8gMiwKCQkJCQkJbWF4d2lkdGggPSBwYXJzZUZsb2F0KCBzZWxmLmxpc3QucGFyZW50KCkuY3NzKCAibWF4LXdpZHRoIiApICksCgkJCQkJCW5ld3RvcCwgbmV3bGVmdDsKCgkJCQkJaWYgKCByb29tdG9wID4gbWVudUhlaWdodCAvIDIgJiYgcm9vbWJvdCA+IG1lbnVIZWlnaHQgLyAyICkgewoJCQkJCQluZXd0b3AgPSBidG5PZmZzZXQgKyAoIHNlbGYuYnV0dG9uLm91dGVySGVpZ2h0KCkgLyAyICkgLSBoYWxmaGVpZ2h0OwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIDMwcHggdG9sZXJhbmNlIG9mZiB0aGUgZWRnZXMKCQkJCQkJbmV3dG9wID0gcm9vbXRvcCA+IHJvb21ib3QgPyBzY3JvbGxUb3AgKyBzY3JlZW5IZWlnaHQgLSBtZW51SGVpZ2h0IC0gMzAgOiBzY3JvbGxUb3AgKyAzMDsKCQkJCQl9CgoJCQkJCS8vIElmIHRoZSBtZW51d2lkdGggaXMgc21hbGxlciB0aGFuIHRoZSBzY3JlZW4gY2VudGVyIGlzCgkJCQkJaWYgKCBtZW51V2lkdGggPCBtYXh3aWR0aCApIHsKCQkJCQkJbmV3bGVmdCA9ICggc2NyZWVuV2lkdGggLSBtZW51V2lkdGggKSAvIDI7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vb3RoZXJ3aXNlIGluc3VyZSBhID49IDMwcHggb2Zmc2V0IGZyb20gdGhlIGxlZnQKCQkJCQkJbmV3bGVmdCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLmxlZnQgKyBzZWxmLmJ1dHRvbi5vdXRlcldpZHRoKCkgLyAyIC0gbWVudVdpZHRoIC8gMjsKCgkJCQkJCS8vIDMwcHggdG9sZXJhbmNlIG9mZiB0aGUgZWRnZXMKCQkJCQkJaWYgKCBuZXdsZWZ0IDwgMzAgKSB7CgkJCQkJCQluZXdsZWZ0ID0gMzA7CgkJCQkJCX0gZWxzZSBpZiAoIChuZXdsZWZ0ICsgbWVudVdpZHRoKSA+IHNjcmVlbldpZHRoICkgewoJCQkJCQkJbmV3bGVmdCA9IHNjcmVlbldpZHRoIC0gbWVudVdpZHRoIC0gMzA7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXNlbGYubGlzdGJveC5hcHBlbmQoIHNlbGYubGlzdCApCgkJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJCS5jc3MoewoJCQkJCQkJdG9wOiBuZXd0b3AsCgkJCQkJCQlsZWZ0OiBuZXdsZWZ0CgkJCQkJCX0pCgkJCQkJCS5hZGRDbGFzcyggImluIiApOwoKCQkJCQlmb2N1c01lbnVJdGVtKCk7CgoJCQkJCS8vIGR1cGxpY2F0ZSB3aXRoIHZhbHVlIHNldCBpbiBwYWdlIHNob3cgZm9yIGRpYWxvZyBzaXplZCBzZWxlY3RzCgkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJfQoJCQl9LAoKCQkJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQkvLyBQb3B1bGF0ZSBtZW51IHdpdGggb3B0aW9ucyBmcm9tIHNlbGVjdCBlbGVtZW50CgkJCQlzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJJHBhcmVudCA9ICR0aGlzLnBhcmVudCgpLAoJCQkJCQl0ZXh0ID0gJHRoaXMuZ2V0RW5jb2RlZFRleHQoKSwKCQkJCQkJYW5jaG9yID0gIjxhIGhyZWY9JyMnPiIrIHRleHQgKyI8L2E+IiwKCQkJCQkJY2xhc3NlcyA9IFtdLAoJCQkJCQlleHRyYUF0dHJzID0gW107CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCAkcGFyZW50LmlzKCAib3B0Z3JvdXAiICkgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9ICRwYXJlbnQuYXR0ciggImxhYmVsIiApOwoKCQkJCQkJLy8gaGFzIHRoaXMgb3B0Z3JvdXAgYWxyZWFkeSBiZWVuIGJ1aWx0IHlldD8KCQkJCQkJaWYgKCAkLmluQXJyYXkoIG9wdExhYmVsLCBvcHRncm91cHMgKSA9PT0gLTEgKSB7CgkJCQkJCQlsaXMucHVzaCggIjxsaSBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdsaXN0LWRpdmlkZXInPiIrIG9wdExhYmVsICsiPC9saT4iICk7CgkJCQkJCQlvcHRncm91cHMucHVzaCggb3B0TGFiZWwgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gRmluZCBwbGFjZWhvbGRlciB0ZXh0CgkJCQkJLy8gVE9ETzogQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHVzZSBnZXRBdHRyaWJ1dGU/IF5SVwoJCQkJCWlmICggIXRoaXMuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkdGhpcy5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJfQoKCQkJCQkvLyBzdXBwb3J0IGRpc2FibGVkIG9wdGlvbiB0YWdzCgkJCQkJaWYgKCB0aGlzLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJZXh0cmFBdHRycy5wdXNoKCAiYXJpYS1kaXNhYmxlZD0ndHJ1ZSciICk7CgkJCQkJfQoKCQkJCQlsaXMucHVzaCggIjxsaSBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJvcHRpb24taW5kZXg9JyIgKyBpICsgIicgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nIisgZGF0YUljb24gKyInIGNsYXNzPSciKyBjbGFzc2VzLmpvaW4oIiAiKSArICInICIgKyBleHRyYUF0dHJzLmpvaW4oIiAiKSArIj4iKyBhbmNob3IgKyI8L2xpPiIgKTsKCQkJCX0pOwoKCQkJCXNlbGYubGlzdC5odG1sKCBsaXMuam9pbigiICIpICk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaSIgKQoJCQkJCS5hdHRyKHsgInJvbGUiOiAib3B0aW9uIiwgInRhYmluZGV4IjogIi0xIiB9KQoJCQkJCS5maXJzdCgpLmF0dHIoICJ0YWJpbmRleCIsICIwIiApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGNsb3NlIGxpbmsgZm9yIHNpbmdsZSBzZWxlY3RzCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCQkJdGhpcy5oZWFkZXJDbG9zZS5oaWRlKCk7CgkJCQl9CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0KCQl9KTsKCX07CgoJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggInNlbGVjdCIsICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIHRoaXMgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSApewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwovKgoqICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQltZW51UGFnZVRoZW1lOiAiYiIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoOmpxbURhdGEocm9sZT0nc2xpZGVyJykpIgoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKICBfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKICB9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0Jz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkudGV4dCggJCggdGhpcy5zZWxlY3RbIDAgXS5vcHRpb25zLml0ZW0oIHNlbGVjdGVkSW5kZXggKSApLnRleHQoKSApCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IG9wdGlvbnMuaWNvbnBvcywKCQkJCQlpbmxpbmU6IG9wdGlvbnMuaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdwoJCQkJfSk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJdGhpcy5zZWxlY3QuYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9ucyIgcGx1Z2luIC0gZm9yIG1ha2luZyBidXR0b24tbGlrZSBsaW5rcwoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKyApIHsKCQl2YXIgZWwgPSB0aGlzLmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBlbC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZWwuanFtRGF0YSggImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGVsLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJCWlubGluZTogICAgIG9wdGlvbnMuaW5saW5lICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pbmxpbmUgICAgIDogZWwuanFtRGF0YSggImlubGluZSIgKSwKCQkJCXNoYWRvdzogICAgIG9wdGlvbnMuc2hhZG93ICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zaGFkb3cgICAgIDogZWwuanFtRGF0YSggInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZWwuanFtRGF0YSggImNvcm5lcnMiICksCgkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnNoYWRvdyA6IGVsLmpxbURhdGEoICJpY29uc2hhZG93IiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgoJCQkvLyBCdXR0b24gaW5uZXIgbWFya3VwCgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICksCgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKSwKCQkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJLy8gaWYgc28sIHByZXZlbnQgZG91YmxlIGVuaGFuY2VtZW50LCBhbmQgY29udGludWUgd2l0aCByZXN0IG9mIHRoZSBlbGVtZW50cy4KCQlpZiggZS50YWdOYW1lID09PSAiSU5QVVQiICYmIGVsLmpxbURhdGEoJ3JvbGUnKSA9PT0gImJ1dHRvbiIgKSBjb250aW51ZTsKCQkKCQkvLyBpZiB0aGlzIGlzIGEgYnV0dG9uLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiggZS50YWdOYW1lID09PSAiQlVUVE9OIiApIHsKCSAJIAlpZiAoICEkKCBlLnBhcmVudE5vZGUgKS5oYXNDbGFzcyggInVpLWJ0biIgKSApICQoIGUgKS5idXR0b24oKTsKCSAJIAljb250aW51ZTsKIAkgCX0KCgkJaWYgKCBhdHRhY2hFdmVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi11cC0iICsgby50aGVtZTsKCgkJaWYgKCBvLmlubGluZSApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaWYgKCBvLmNvcm5lcnMgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQlpbm5lckNsYXNzICs9ICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCX0KCgkJaWYgKCBvLnNoYWRvdyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1zaGFkb3ciOwoJCX0KCgkJZS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIG8udGhlbWUgKTsKCQllbC5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvbkljb24gKTsKCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICkgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgoJCS8vIFRPRE8gb2J2aW91c2x5IGl0IHdvdWxkIGJlIG5pY2UgdG8gcHVsbCB0aGlzIGVsZW1lbnQgb3V0IGluc3RlYWQgb2YKCQkvLyByZXRyaWV2aW5nIGl0IGZyb20gdGhlIERPTSBhZ2FpbiwgYnV0IHRoaXMgY2hhbmdlIGlzIG11Y2ggbGVzcyBvYnRydXNpdmUKCQkvLyBhbmQgMS4wIGRyYXdzIG5pZ2gKCQkkLmRhdGEoIGUsICd0ZXh0V3JhcHBlcicsICQoIGJ1dHRvblRleHQgKSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCWlubGluZTogZmFsc2UsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoInVpLWJ0biAiKSA+IC0xICYmIGNuYW1lLmluZGV4T2YoInVpLWRpc2FibGVkICIpIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGJ0biA9IGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSwKCQkJCSRidG4sIHRoZW1lOwoKCQkJaWYgKCBidG4gKSB7CgkJCQkkYnRuID0gJCggYnRuICk7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlY2FuY2VsIHZtb3VzZXVwIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9LAoJCSJ2bW91c2VvdmVyIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBidG4gPSBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICksCgkJCQkkYnRuLCB0aGVtZTsKCgkJCWlmICggYnRuICkgewoJCQkJJGJ0biA9ICQoIGJ0biApOwoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyogCiogImNvbnRyb2xncm91cCIgcGx1Z2luIC0gY29ybmVyLXJvdW5kaW5nIGZvciBncm91cHMgb2YgYnV0dG9ucywgY2hlY2tzLCByYWRpb3MsIGV0YwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQkJCWRpcmVjdGlvbjogJGVsLmpxbURhdGEoICJ0eXBlIiApIHx8ICJ2ZXJ0aWNhbCIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwaGVhZGluZyA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT0gImhvcml6b250YWwiID8gWyAidWktY29ybmVyLWxlZnQiLCAidWktY29ybmVyLXJpZ2h0IiBdIDogWyAidWktY29ybmVyLXRvcCIsICJ1aS1jb3JuZXItYm90dG9tIiBdLAoJCQl0eXBlID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLmF0dHIoICJ0eXBlIiApOwoKCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJaWYgKCBncm91cGhlYWRpbmcubGVuZ3RoICkgewoJCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGhlYWRpbmcuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbigwKSApOwoJCQlncm91cGhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCB1aS1jb250cm9sZ3JvdXAtIiArIG8uZGlyZWN0aW9uICk7CgoJCS8vIFRPRE86IFRoaXMgc2hvdWxkIGJlIG1vdmVkIG91dCB0byB0aGUgY2xvc3VyZQoJCS8vIG90aGVyd2lzZSBpdCBpcyByZWRlZmluZWQgZWFjaCB0aW1lIGNvbnRyb2xncm91cCgpIGlzIGNhbGxlZAoJCWZ1bmN0aW9uIGZsaXBDbGFzc2VzKCBlbHMgKSB7CgkJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkJLmVxKCAwICkuYWRkQ2xhc3MoIGZsQ29ybmVyc1sgMCBdICkKCQkJCS5lbmQoKQoJCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJCX0KCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9Cgl9KTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwp9KTsKCn0pKGpRdWVyeSk7LyoKKiAibGlua3MiIHBsdWdpbiAtIHNpbXBsZSBjbGFzcyBhZGRpdGlvbnMgZm9yIGxpbmtzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCQoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcwoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJmaXhIZWFkZXJGb290ZXIiIHBsdWdpbiAtIG9uLWRlbWFuZCBwb3NpdGlvbmluZyBmb3IgaGVhZGVycyxmb290ZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBzbGlkZURvd25DbGFzcyA9ICJ1aS1oZWFkZXItZml4ZWQgdWktZml4ZWQtaW5saW5lIGZhZGUiLAoJc2xpZGVVcENsYXNzID0gInVpLWZvb3Rlci1maXhlZCB1aS1maXhlZC1pbmxpbmUgZmFkZSIsCgoJc2xpZGVEb3duU2VsZWN0b3IgPSAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiwKCXNsaWRlVXBTZWxlY3RvciA9ICIudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiOwoKJC5mbi5maXhIZWFkZXJGb290ZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm4gdGhpczsKCX0KCglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJaWYgKCAkdGhpcy5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJfQoKCQkvLyBTaG91bGQgYmUgc2xpZGVkb3duCgkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkkdGhpcy5maW5kKCBzbGlkZVVwU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVVcENsYXNzICk7Cgl9KTsKfTsKCi8vIHNpbmdsZSBjb250cm9sbGVyIGZvciBhbGwgc2hvd2luZyxoaWRpbmcsdG9nZ2xpbmcKJC5tb2JpbGUuZml4ZWRUb29sYmFycyA9IChmdW5jdGlvbigpIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHN0aWNreUZvb3RlciwgZGVsYXlUaW1lciwKCQljdXJyZW50c3RhdGUgPSAiaW5saW5lIiwKCQlhdXRvSGlkZU1vZGUgPSBmYWxzZSwKCQlzaG93RGVsYXkgPSAxMDAsCgkJaWdub3JlVGFyZ2V0cyA9ICJhLGlucHV0LHRleHRhcmVhLHNlbGVjdCxidXR0b24sbGFiZWwsLnVpLWhlYWRlci1maXhlZCwudWktZm9vdGVyLWZpeGVkIiwKCQl0b29sYmFyU2VsZWN0b3IgPSAiLnVpLWhlYWRlci1maXhlZDpmaXJzdCwgLnVpLWZvb3Rlci1maXhlZDpub3QoLnVpLWZvb3Rlci1kdXBsaWNhdGUpOmxhc3QiLAoJCS8vIGZvciBzdG9yaW5nIHF1aWNrIHJlZmVyZW5jZXMgdG8gZHVwbGljYXRlIGZvb3RlcnMKCQlzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXN0YXRlQmVmb3JlID0gbnVsbCwKCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZSwKCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSB0cnVlOwoKCWZ1bmN0aW9uIHNob3dFdmVudENhbGxiYWNrKCBldmVudCApIHsKCQkvLyBBbiBldmVudCB0aGF0IGFmZmVjdHMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHZpc3VhbCB2aWV3cG9ydCBoYXMKCQkvLyBiZWVuIHRyaWdnZXJlZC4gSWYgdGhlIGhlYWRlciBhbmQvb3IgZm9vdGVyIGZvciB0aGUgY3VycmVudCBwYWdlIGFyZSBpbiBvdmVybGF5CgkJLy8gbW9kZSwgd2Ugd2FudCB0byBoaWRlIHRoZW0sIGFuZCB0aGVuIGZpcmUgb2ZmIGEgdGltZXIgdG8gc2hvdyB0aGVtIGF0IGEgbGF0ZXIKCQkvLyBwb2ludC4gRXZlbnRzIGxpa2UgYSByZXNpemUgY2FuIGJlIHRyaWdnZXJlZCBjb250aW51b3VzbHkgZHVyaW5nIGEgc2Nyb2xsLCBvbgoJCS8vIHNvbWUgcGxhdGZvcm1zLCBzbyB0aGUgdGltZXIgaXMgdXNlZCB0byBkZWxheSB0aGUgYWN0dWFsIHBvc2l0aW9uaW5nIHVudGlsIHRoZQoJCS8vIGZsb29kIG9mIGV2ZW50cyBoYXZlIHN1YnNpZGVkLgoJCS8vCgkJLy8gSWYgd2UgYXJlIGluIGF1dG9IaWRlTW9kZSwgd2UgZG9uJ3QgZG8gYW55dGhpbmcgYmVjYXVzZSB3ZSBrbm93IHRoZSBzY3JvbGwKCQkvLyBjYWxsYmFja3MgZm9yIHRoZSBwbHVnaW4gd2lsbCBmaXJlIG9mZiBhIHNob3cgd2hlbiB0aGUgc2Nyb2xsaW5nIGhhcyBzdG9wcGVkLgoJCWlmICggIWF1dG9IaWRlTW9kZSAmJiBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApIHsKCQkJaWYgKCAhZGVsYXlUaW1lciApIHsKCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSggdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJfQoJfQoKCSQoZnVuY3Rpb24oKSB7CgkJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkJJGRvY3VtZW50CgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoJCQkJCXN0YXRlQmVmb3JlID0gY3VycmVudHN0YXRlOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoKCQkJCQlpZiAoICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoICFzY3JvbGxUcmlnZ2VyZWQgKSB7CgkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMudG9nZ2xlKCBzdGF0ZUJlZm9yZSApOwoJCQkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNpbGVudHNjcm9sbCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoKCQkvLyBUaGUgYmVsb3cgY2hlY2tzIGZpcnN0IGZvciBhICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIHZhbHVlLCBhbmQgaWYgemVybywgYmluZHMgc2Nyb2xsIGV2ZW50cyB0byAkKHdpbmRvdykgaW5zdGVhZC4KCQkvLyBJZiB0aGUgc2Nyb2xsVG9wIHZhbHVlIGlzIGFjdHVhbGx5IHplcm8sIGJvdGggd2lsbCByZXR1cm4gemVybyBhbnl3YXkuCgkJLy8KCQkvLyBXb3JrcyB3aXRoICQoZG9jdW1lbnQpLCBub3QgJCh3aW5kb3cpIDogT3BlcmEgTW9iaWxlIChXaW5NTyBwaG9uZTsga2luZGEgYnJva2VuIGFueXdheSkKCQkvLyBXb3JrcyB3aXRoICQod2luZG93KSwgbm90ICQoZG9jdW1lbnQpIDogSUUgNy84CgkJLy8gV29ya3Mgd2l0aCBlaXRoZXIgJCh3aW5kb3cpIG9yICQoZG9jdW1lbnQpIDogQ2hyb21lLCBGRiAzLjYvNCwgQW5kcm9pZCAxLjYvMi4xLCBpT1MKCQkvLyBOZWVkcyB3b3JrIGVpdGhlciB3YXkgOiBCQjUsIE9wZXJhIE1vYmlsZSAoaU9TKQoKCQkoICggJGRvY3VtZW50LnNjcm9sbFRvcCgpID09PSAwICkgPyAkd2luZG93IDogJGRvY3VtZW50ICkKCQkJLmJpbmQoICJzY3JvbGxzdGFydCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSB0cnVlOwoKCQkJCWlmICggc3RhdGVCZWZvcmUgPT09IG51bGwgKSB7CgkJCQkJc3RhdGVCZWZvcmUgPSBjdXJyZW50c3RhdGU7CgkJCQl9CgoJCQkJLy8gV2Ugb25seSBlbnRlciBhdXRvSGlkZU1vZGUgaWYgdGhlIGhlYWRlcnMvZm9vdGVycyBhcmUgaW4KCQkJCS8vIGFuIG92ZXJsYXkgc3RhdGUgb3IgdGhlIHNob3cgdGltZXIgd2FzIHN0YXJ0ZWQuIElmIHRoZQoJCQkJLy8gc2hvdyB0aW1lciBpcyBzZXQsIGNsZWFyIGl0IHNvIHRoZSBoZWFkZXJzL2Zvb3RlcnMgZG9uJ3QKCQkJCS8vIHNob3cgdXAgdW50aWwgYWZ0ZXIgd2UncmUgZG9uZSBzY3JvbGxpbmcuCgkJCQl2YXIgaXNPdmVybGF5U3RhdGUgPSBzdGF0ZUJlZm9yZSA9PSAib3ZlcmxheSI7CgoJCQkJYXV0b0hpZGVNb2RlID0gaXNPdmVybGF5U3RhdGUgfHwgISFkZWxheVRpbWVyOwoKCQkJCWlmICggYXV0b0hpZGVNb2RlICkgewoJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCQkJaWYgKCBpc092ZXJsYXlTdGF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZTsKCgkJCQlpZiAoIGF1dG9IaWRlTW9kZSApIHsKCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJCQkJYXV0b0hpZGVNb2RlID0gZmFsc2U7CgkJCQl9CgkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCX0pOwoKCQkJJHdpbmRvdy5iaW5kKCAicmVzaXplIHVwZGF0ZWxheW91dCIsIHNob3dFdmVudENhbGxiYWNrICk7Cgl9KTsKCgkvLyAxLiBCZWZvcmUgcGFnZSBpcyBzaG93biwgY2hlY2sgZm9yIGR1cGxpY2F0ZSBmb290ZXIKCS8vIDIuIEFmdGVyIHBhZ2UgaXMgc2hvd24sIGFwcGVuZCBmb290ZXIgdG8gbmV3IHBhZ2UKCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCXZhciBwYWdlID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQlmb290ZXIgPSBwYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKSwKCQkJCWlkID0gZm9vdGVyLmRhdGEoICJpZCIgKSwKCQkJCXByZXZQYWdlID0gdWkucHJldlBhZ2UsCgkJCQlwcmV2Rm9vdGVyID0gcHJldlBhZ2UgJiYgcHJldlBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLAoJCQkJcHJldkZvb3Rlck1hdGNoZXMgPSBwcmV2Rm9vdGVyLmxlbmd0aCAmJiBwcmV2Rm9vdGVyLmpxbURhdGEoICJpZCIgKSA9PT0gaWQ7CgoJCQlpZiAoIGlkICYmIHByZXZGb290ZXJNYXRjaGVzICkgewoJCQkJc3RpY2t5Rm9vdGVyID0gZm9vdGVyOwoJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIucmVtb3ZlQ2xhc3MoICJmYWRlIGluIG91dCIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApICk7CgkJCX0KCQl9KQoJCS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93IiwgZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCBzdGlja3lGb290ZXIgJiYgc3RpY2t5Rm9vdGVyLmxlbmd0aCApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIuYXBwZW5kVG8oICR0aGlzICkuYWRkQ2xhc3MoICJmYWRlIiApICk7CgkJCQkJc3RpY2t5Rm9vdGVyID0gbnVsbDsKCQkJCX0sIDUwMCk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdyggdHJ1ZSwgdGhpcyApOwoJCX0pOwoKCS8vIFdoZW4gYSBjb2xsYXBzaWJsZSBpcyBoaWRkZW4gb3Igc2hvd24gd2UgbmVlZCB0byB0cmlnZ2VyIHRoZSBmaXhlZCB0b29sYmFyIHRvIHJlcG9zaXRpb24gaXRzZWxmICgjMTYzNSkKCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktY29sbGFwc2libGUtY29udGFpbiIsICJjb2xsYXBzZSBleHBhbmQiLCBzaG93RXZlbnRDYWxsYmFjayApOwoKCS8vIGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgaXMgYnJva2VuIGluIGlPUyAzLjIuMSBvbiB0aGUgaVBhZC4gVGhlCgkvLyBjb29yZGluYXRlcyBpbnNpZGUgb2YgdGhlIHJlY3QgaXQgcmV0dXJucyBkb24ndCBoYXZlIHRoZSBwYWdlIHNjcm9sbCBwb3NpdGlvbgoJLy8gZmFjdG9yZWQgb3V0IG9mIGl0IGxpa2UgdGhlIG90aGVyIHBsYXRmb3JtcyBkby4gVG8gZ2V0IGFyb3VuZCB0aGlzLAoJLy8gd2UnbGwganVzdCBjYWxjdWxhdGUgdGhlIHRvcCBvZmZzZXQgdGhlIG9sZCBmYXNoaW9uZWQgd2F5IHVudGlsIGNvcmUgaGFzCgkvLyBhIGNoYW5jZSB0byBmaWd1cmUgb3V0IGhvdyB0byBoYW5kbGUgdGhpcyBzaXR1YXRpb24uCgkvLwoJLy8gVE9ETzogV2UnbGwgbmVlZCB0byBnZXQgcmlkIG9mIGdldE9mZnNldFRvcCgpIG9uY2UgYSBmaXggZ2V0cyBmb2xkZWQgaW50byBjb3JlLgoKCWZ1bmN0aW9uIGdldE9mZnNldFRvcCggZWxlICkgewoJCXZhciB0b3AgPSAwLAoJCQlvcCwgYm9keTsKCgkJaWYgKCBlbGUgKSB7CgkJCWJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlvcCA9IGVsZS5vZmZzZXRQYXJlbnQ7CgkJCXRvcCA9IGVsZS5vZmZzZXRUb3A7CgoJCQl3aGlsZSAoIGVsZSAmJiBlbGUgIT0gYm9keSApIHsKCQkJCXRvcCArPSBlbGUuc2Nyb2xsVG9wIHx8IDA7CgoJCQkJaWYgKCBlbGUgPT0gb3AgKSB7CgkJCQkJdG9wICs9IG9wLm9mZnNldFRvcDsKCQkJCQlvcCA9IGVsZS5vZmZzZXRQYXJlbnQ7CgkJCQl9CgoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9CgkJcmV0dXJuIHRvcDsKCX0KCglmdW5jdGlvbiBzZXRUb3AoIGVsICkgewoJCXZhciBmcm9tVG9wID0gJCh3aW5kb3cpLnNjcm9sbFRvcCgpLAoJCQl0aGlzVG9wID0gZ2V0T2Zmc2V0VG9wKCBlbFsgMCBdICksIC8vIGVsLm9mZnNldCgpLnRvcCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBvbiBpUGFkIGlPUyAzLjIuMSwgY2FsbCBvdXIgd29ya2Fyb3VuZCBpbnN0ZWFkLgoJCQl0aGlzQ1NTdG9wID0gZWwuY3NzKCAidG9wIiApID09ICJhdXRvIiA/IDAgOiBwYXJzZUZsb2F0KGVsLmNzcyggInRvcCIgKSksCgkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJdGhpc0hlaWdodCA9IGVsLm91dGVySGVpZ2h0KCksCgkJCXVzZVJlbGF0aXZlID0gZWwucGFyZW50cyggIi51aS1wYWdlOm5vdCgudWktcGFnZS1mdWxsc2NyZWVuKSIgKS5sZW5ndGgsCgkJCXJlbHZhbDsKCgkJaWYgKCBlbC5pcyggIi51aS1oZWFkZXItZml4ZWQiICkgKSB7CgoJCQlyZWx2YWwgPSBmcm9tVG9wIC0gdGhpc1RvcCArIHRoaXNDU1N0b3A7CgoJCQlpZiAoIHJlbHZhbCA8IHRoaXNUb3AgKSB7CgkJCQlyZWx2YWwgPSAwOwoJCQl9CgoJCQlyZXR1cm4gZWwuY3NzKCAidG9wIiwgdXNlUmVsYXRpdmUgPyByZWx2YWwgOiBmcm9tVG9wICk7CgkJfSBlbHNlIHsKCQkJLy8gcmVsdmFsID0gLTEgKiAodGhpc1RvcCAtIChmcm9tVG9wICsgc2NyZWVuSGVpZ2h0KSArIHRoaXNDU1N0b3AgKyB0aGlzSGVpZ2h0KTsKCQkJLy8gaWYgKCByZWx2YWwgPiB0aGlzVG9wICkgeyByZWx2YWwgPSAwOyB9CgkJCXJlbHZhbCA9IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgLSB0aGlzSGVpZ2h0IC0gKHRoaXNUb3AgLSB0aGlzQ1NTdG9wICk7CgoJCQlyZXR1cm4gZWwuY3NzKCAidG9wIiwgdXNlUmVsYXRpdmUgPyByZWx2YWwgOiBmcm9tVG9wICsgc2NyZWVuSGVpZ2h0IC0gdGhpc0hlaWdodCApOwoJCX0KCX0KCgkvLyBFeHBvc2VkIG1ldGhvZHMKCXJldHVybiB7CgoJCXNob3c6IGZ1bmN0aW9uKCBpbW1lZGlhdGVseSwgcGFnZSApIHsKCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCWN1cnJlbnRzdGF0ZSA9ICJvdmVybGF5IjsKCgkJCXZhciAkYXAgPSBwYWdlID8gJCggcGFnZSApIDoKCQkJCQkoICQubW9iaWxlLmFjdGl2ZVBhZ2UgPyAkLm1vYmlsZS5hY3RpdmVQYWdlIDoKCQkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKSApOwoKCQkJcmV0dXJuICRhcC5jaGlsZHJlbiggdG9vbGJhclNlbGVjdG9yICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCQl2YXIgZWwgPSAkKCB0aGlzICksCgkJCQkJZnJvbVRvcCA9ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLAoJCQkJCS8vIGVsLm9mZnNldCgpLnRvcCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBvbiBpUGFkIGlPUyAzLjIuMSwgY2FsbCBvdXIgd29ya2Fyb3VuZCBpbnN0ZWFkLgoJCQkJCXRoaXNUb3AgPSBnZXRPZmZzZXRUb3AoIGVsWyAwIF0gKSwKCQkJCQlzY3JlZW5IZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQsCgkJCQkJdGhpc0hlaWdodCA9IGVsLm91dGVySGVpZ2h0KCksCgkJCQkJYWxyZWFkeVZpc2libGUgPSAoIGVsLmlzKCAiLnVpLWhlYWRlci1maXhlZCIgKSAmJiBmcm9tVG9wIDw9IHRoaXNUb3AgKyB0aGlzSGVpZ2h0ICkgfHwKCQkJCQkJCQkJCQkJCQkoIGVsLmlzKCAiLnVpLWZvb3Rlci1maXhlZCIgKSAmJiB0aGlzVG9wIDw9IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgKTsKCgkJCQkvLyBBZGQgc3RhdGUgY2xhc3MKCQkJCWVsLmFkZENsYXNzKCAidWktZml4ZWQtb3ZlcmxheSIgKS5yZW1vdmVDbGFzcyggInVpLWZpeGVkLWlubGluZSIgKTsKCgkJCQlpZiAoICFhbHJlYWR5VmlzaWJsZSAmJiAhaW1tZWRpYXRlbHkgKSB7CgkJCQkJZWwuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCWVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSkuYWRkQ2xhc3MoICJpbiIgKTsKCQkJCX0KCQkJCXNldFRvcChlbCk7CgkJCX0pOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBpbW1lZGlhdGVseSApIHsKCgkJCWN1cnJlbnRzdGF0ZSA9ICJpbmxpbmUiOwoKCQkJdmFyICRhcCA9ICQubW9iaWxlLmFjdGl2ZVBhZ2UgPyAkLm1vYmlsZS5hY3RpdmVQYWdlIDoKCQkJCQkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKTsKCgkJCXJldHVybiAkYXAuY2hpbGRyZW4oIHRvb2xiYXJTZWxlY3RvciApLmVhY2goZnVuY3Rpb24oKSB7CgoJCQkJdmFyIGVsID0gJCh0aGlzKSwKCQkJCQl0aGlzQ1NTdG9wID0gZWwuY3NzKCAidG9wIiApLAoJCQkJCWNsYXNzZXM7CgoJCQkJdGhpc0NTU3RvcCA9IHRoaXNDU1N0b3AgPT0gImF1dG8iID8gMCA6CgkJCQkJCQkJCQkJcGFyc2VGbG9hdCh0aGlzQ1NTdG9wKTsKCgkJCQkvLyBBZGQgc3RhdGUgY2xhc3MKCQkJCWVsLmFkZENsYXNzKCAidWktZml4ZWQtaW5saW5lIiApLnJlbW92ZUNsYXNzKCAidWktZml4ZWQtb3ZlcmxheSIgKTsKCgkJCQlpZiAoIHRoaXNDU1N0b3AgPCAwIHx8ICggZWwuaXMoICIudWktaGVhZGVyLWZpeGVkIiApICYmIHRoaXNDU1N0b3AgIT09IDAgKSApIHsKCgkJCQkJaWYgKCBpbW1lZGlhdGVseSApIHsKCQkJCQkJZWwuY3NzKCAidG9wIiwgMCk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCWlmICggZWwuY3NzKCAidG9wIiApICE9PSAiYXV0byIgJiYgcGFyc2VGbG9hdCggZWwuY3NzKCAidG9wIiApICkgIT09IDAgKSB7CgoJCQkJCQkJY2xhc3NlcyA9ICJvdXQgcmV2ZXJzZSI7CgoJCQkJCQkJZWwuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCQkJZWwucmVtb3ZlQ2xhc3MoIGNsYXNzZXMgKS5jc3MoICJ0b3AiLCAwICk7CgkJCQkJCQl9KS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9LAoKCQlzdGFydFNob3dUaW1lcjogZnVuY3Rpb24oKSB7CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLmNsZWFyU2hvd1RpbWVyKCk7CgoJCQl2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJZGVsYXlUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlkZWxheVRpbWVyID0gdW5kZWZpbmVkOwoJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5zaG93LmFwcGx5KCBudWxsLCBhcmdzICk7CgkJCX0sIHNob3dEZWxheSk7CgkJfSwKCgkJY2xlYXJTaG93VGltZXI6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIGRlbGF5VGltZXIgKSB7CgkJCQljbGVhclRpbWVvdXQoIGRlbGF5VGltZXIgKTsKCQkJfQoJCQlkZWxheVRpbWVyID0gdW5kZWZpbmVkOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oIGZyb20gKSB7CgkJCWlmICggZnJvbSApIHsKCQkJCWN1cnJlbnRzdGF0ZSA9IGZyb207CgkJCX0KCQkJcmV0dXJuICggY3VycmVudHN0YXRlID09PSAib3ZlcmxheSIgKSA/ICQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSgpIDoKCQkJCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnNob3coKTsKCQl9LAoKCQlzZXRUb3VjaFRvZ2dsZUVuYWJsZWQ6IGZ1bmN0aW9uKCBlbmFibGVkICkgewoJCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSBlbmFibGVkOwoJCX0KCX07Cn0pKCk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJaWYgKCAkKCAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiLCBldmVudC50YXJnZXQgKS5sZW5ndGggKSB7CgoJCSQoIGV2ZW50LnRhcmdldCApLmVhY2goZnVuY3Rpb24oKSB7CgoJCQlpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoICR0aGlzLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJCX0KCgkJCS8vIFNob3VsZCBiZSBzbGlkZWRvd24KCQkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJCS8vIFNob3VsZCBiZSBzbGlkZXVwCgkJCSR0aGlzLmZpbmQoIHNsaWRlVXBTZWxlY3RvciApLmFkZENsYXNzKCBzbGlkZVVwQ2xhc3MgKTsKCgkJfSkKCgl9Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJmaXhIZWFkZXJGb290ZXIiIG5hdGl2ZSBwbHVnaW4gLSBCZWhhdmlvciBmb3IgImZpeGVkIiBoZWFkZXJzLGZvb3RlcnMsIGFuZCBzY3JvbGxpbmcgaW5uZXIgY29udGVudAoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBFbmFibGUgdG91Y2ggb3ZlcmZsb3cgc2Nyb2xsaW5nIHdoZW4gaXQncyBuYXRpdmVseSBzdXBwb3J0ZWQKJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgPSBmYWxzZTsKCi8vIEVuYWJsZWQgem9vbSB3aGVuIHRvdWNoIG92ZXJmbG93IGlzIGVuYWJsZWQuIENhbiBjYXVzZSB1c2FiaWxpdHkgaXNzdWVzLCB1bmZvcnR1bmF0ZWx5CiQubW9iaWxlLnRvdWNoT3ZlcmZsb3dab29tRW5hYmxlZCA9IGZhbHNlOwoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApewoJCQoJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCXNjcm9sbFN0YXJ0WSA9IDA7CgkJCQoJCWlmKCAkdGFyZ2V0LmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApICl7CgkJCQoJCQkkdGFyZ2V0LmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHBhZ2UgPSAkKCB0aGlzICksCgkJCQkJJGZpeGllcyA9ICRwYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkuZmlsdGVyKCAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiICksCgkJCQkJZnVsbFNjcmVlbiA9ICRwYWdlLmpxbURhdGEoICJmdWxsc2NyZWVuIiApLAoJCQkJCSRzY3JvbGxFbGVtID0gJGZpeGllcy5sZW5ndGggPyAkcGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICkgOiAkcGFnZTsKCQkJCQoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdG91Y2gtb3ZlcmZsb3ciICk7CgkJCQkKCQkJCSRzY3JvbGxFbGVtLmJpbmQoICJzY3JvbGxzdG9wIiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggJHNjcm9sbEVsZW0uc2Nyb2xsVG9wKCkgPiAwICl7CgkJCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJCQl9CgkJCQl9KTsJCgkJCQkKCQkJCWlmKCAkZml4aWVzLmxlbmd0aCApewoJCQkJCQoJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktbmF0aXZlLWZpeGVkIiApOwoJCQkJCQoJCQkJCWlmKCBmdWxsU2NyZWVuICl7CgoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLW5hdGl2ZS1mdWxsc2NyZWVuIiApOwoKCQkJCQkJJGZpeGllcy5hZGRDbGFzcyggImZhZGUgaW4iICk7CgoJCQkJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpewoJCQkJCQkJJGZpeGllcwoJCQkJCQkJCS5yZW1vdmVDbGFzcyggInVpLW5hdGl2ZS1iYXJzLWhpZGRlbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggImluIG91dCIgKQoJCQkJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpewoJCQkJCQkJCQkkKHRoaXMpLm5vdCggIi5pbiIgKS5hZGRDbGFzcyggInVpLW5hdGl2ZS1iYXJzLWhpZGRlbiIgKTsKCQkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJpbml0IiAtIEluaXRpYWxpemUgdGhlIGZyYW1ld29yawoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJCggd2luZG93ICk7CgogCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gYWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gbG9hZGluZyBkaXYgd2hpY2ggYXBwZWFycyBkdXJpbmcgQWpheCByZXF1ZXN0cwoJLy8gd2lsbCBub3QgYXBwZWFyIGlmICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIGlzIGZhbHNlCgl2YXIgJGxvYWRlciA9ICQoICI8ZGl2IGNsYXNzPSd1aS1sb2FkZXIgdWktYm9keS1hIHVpLWNvcm5lci1hbGwnPjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyBzcGluJz48L3NwYW4+PGgxPjwvaDE+PC9kaXY+IiApOwoKCSQuZXh0ZW5kKCQubW9iaWxlLCB7CgkJLy8gdHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQkJJGxvYWRlcgoJCQkJCS5maW5kKCAiaDEiICkKCQkJCQkJLnRleHQoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkKCQkJCQkJLmVuZCgpCgkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkKCQkJCQkvLyBwb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJCQkJLmNzcyh7CgkJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJCX0pOwoJCQl9CgoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgkJfSwKCgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoJCX0sCgoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRkaWFsb2dzLCAkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjaGVjayBmb3IgZGlhbG9ncyBvciBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRkaWFsb2dzID0gJCggIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApOwoKCQkJCS8vIGlmIHRoZXJlIGFyZSBubyBwYWdlcyBidXQgYSBkaWFsb2cgaXMgcHJlc2VudCwgbG9hZCBpdCBhcyBhIHBhZ2UKCQkJCWlmKCAkZGlhbG9ncy5sZW5ndGggKSB7CgkJCQkJLy8gYWx0ZXIgdGhlIGF0dHJpYnV0ZSBzbyBpdCB3aWxsIGJlIHRyZWF0ZWQgYXMgYSBwYWdlIHVucG9uIGVuaGFuY2VtZW50CgkJCQkJLy8gVE9ETyBhbGxvdyBmb3IgdGhlIGxvYWRpbmcgb2YgYSBkaWFsb2cgYXMgdGhlIGZpcnN0IHBhZ2UgKG1hbnkgY29uc2lkZXJhdGlvbnMpCgkJCQkJJGRpYWxvZ3MuZmlyc3QoKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJwYWdlIiApOwoKCQkJCQkvLyByZW1vdmUgdGhlIGZpcnN0IGRpYWxvZyBmcm9tIHRoZSBzZXQgb2YgZGlhbG9ncyBzaW5jZSBpdCdzIG5vdyBhIHBhZ2UKCQkJCQkvLyBhZGQgaXQgdG8gdGhlIGVtcHR5IHNldCBvZiBwYWdlcyB0byBiZSBsb2FkZWQgYnkgdGhlIGluaXRpYWwgY2hhbmdlcGFnZQoJCQkJCSRwYWdlcyA9ICRwYWdlcy5hZGQoICRkaWFsb2dzLmdldCgpLnNoaWZ0KCkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJCX0KCQkJfQoKCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmFkZCggIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSgidXJsIikgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJHBhZ2VzLmZpcnN0KCkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkIG9yIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJaWYgKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgISQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsgdHJhbnNpdGlvbjogIm5vbmUiLCByZXZlcnNlOiB0cnVlLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJCS8vIG90aGVyd2lzZSwgdHJpZ2dlciBhIGhhc2hjaGFuZ2UgdG8gbG9hZCBhIGRlZXBsaW5rCgkJCWVsc2UgewoJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFsgdHJ1ZSBdICk7CgkJCX0KCQl9Cgl9KTsKCQoJLy8gVGhpcyBmdW5jdGlvbiBpbmplY3RzIGEgbWV0YSB2aWV3cG9ydCB0YWcgdG8gcHJldmVudCBzY2FsaW5nLiBPZmYgYnkgZGVmYXVsdCwgb24gYnkgZGVmYXVsdCB3aGVuIHRvdWNoT3ZlcmZsb3cgc2Nyb2xsaW5nIGlzIGVuYWJsZWQKCWZ1bmN0aW9uIGRpc2FibGVab29tKCkgewoJCXZhciBjb250ID0gInVzZXItc2NhbGFibGU9bm8iLAoJCQltZXRhID0gJCggIm1ldGFbbmFtZT0ndmlld3BvcnQnXSIgKTsKCQkJCgkJaWYoIG1ldGEubGVuZ3RoICl7CgkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBtZXRhLmF0dHIoICJjb250ZW50IiApICsgIiwgIiArIGNvbnQgKTsKCQl9CgkJZWxzZXsKCQkJJCggImhlYWQiICkucHJlcGVuZCggIjxtZXRhPiIsIHsgIm5hbWUiOiAidmlld3BvcnQiLCAiY29udGVudCI6IGNvbnQgfSApOwoJCX0KCX0KCQoJLy8gaWYgdG91Y2gtb3ZlcmZsb3cgaXMgZW5hYmxlZCwgZGlzYWJsZSB1c2VyIHNjYWxpbmcsIGFzIGl0IGNyZWF0ZXMgdXNhYmlsaXR5IGlzc3VlcwoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICYmICEkLm1vYmlsZS50b3VjaE92ZXJmbG93Wm9vbUVuYWJsZWQgKXsKCQlkaXNhYmxlWm9vbSgpOwoJfQoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQod2luZG93KS5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7Cg==",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjAuMQoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMS0yMDEyIChjKSBqUXVlcnkgUHJvamVjdAoqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKgogKiBDb3B5cmlnaHQgMjAxMCwgQVVUSE9SUy50eHQgKGh0dHA6Ly9qcXVlcnl1aS5jb20vYWJvdXQpCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vVUkvV2lkZ2V0CiAqLwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8galF1ZXJ5IDEuNCsKaWYgKCAkLmNsZWFuRGF0YSApIHsKCXZhciBfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CgkkLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCX0KCQlfY2xlYW5EYXRhKCBlbGVtcyApOwoJfTsKfSBlbHNlIHsKCXZhciBfcmVtb3ZlID0gJC5mbi5yZW1vdmU7CgkkLmZuLnJlbW92ZSA9IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAha2VlcERhdGEgKSB7CgkJCQlpZiAoICFzZWxlY3RvciB8fCAkLmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkubGVuZ3RoICkgewoJCQkJCSQoICIqIiwgdGhpcyApLmFkZCggWyB0aGlzIF0gKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIF9yZW1vdmUuY2FsbCggJCh0aGlzKSwgc2VsZWN0b3IsIGtlZXBEYXRhICk7CgkJfSk7Cgl9Owp9CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXSwKCQlmdWxsTmFtZTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgl2YXIgYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQovLwkkLmVhY2goIGJhc2VQcm90b3R5cGUsIGZ1bmN0aW9uKCBrZXksIHZhbCApIHsKLy8JCWlmICggJC5pc1BsYWluT2JqZWN0KHZhbCkgKSB7Ci8vCQkJYmFzZVByb3RvdHlwZVsga2V5IF0gPSAkLmV4dGVuZCgge30sIHZhbCApOwovLwkJfQovLwl9KTsKCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZSA9ICQuZXh0ZW5kKCB0cnVlLCBiYXNlUHJvdG90eXBlLCB7CgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRFdmVudFByZWZpeDogJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSwKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lCgl9LCBwcm90b3R5cGUgKTsKCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gKTsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC5leHRlbmQuYXBwbHkoIG51bGwsIFsgdHJ1ZSwgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJLy8gcHJldmVudCBjYWxscyB0byBpbnRlcm5hbCBtZXRob2RzCgkJaWYgKCBpc01ldGhvZENhbGwgJiYgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJfQoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQl0aHJvdyAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIjsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSApIHsKCQkJCQl0aHJvdyAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiOwoJCQkJfQoJCQkJdmFyIG1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIG5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCglpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7Cgl9Cn07CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyAkLndpZGdldC5icmlkZ2Ugc3RvcmVzIHRoZSBwbHVnaW4gaW5zdGFuY2UsIGJ1dCB3ZSBkbyBpdCBhbnl3YXkKCQkvLyBzbyB0aGF0IGl0J3Mgc3RvcmVkIGV2ZW4gYmVmb3JlIHRoZSBfY3JlYXRlIGZ1bmN0aW9uIHJ1bnMKCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXZhciBzZWxmID0gdGhpczsKCQl0aGlzLmVsZW1lbnQuYmluZCggInJlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5kZXN0cm95KCk7CgkJfSk7CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHt9OwoJCWlmICggJC5tZXRhZGF0YSApIHsKCQkJb3B0aW9ucyA9ICQubWV0YWRhdGEuZ2V0KCBlbGVtZW50IClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJCX0KCQlyZXR1cm4gb3B0aW9uczsKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHt9LAoJX2luaXQ6IGZ1bmN0aW9uKCkge30sCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJfQoJCQlvcHRpb25zID0ge307CgkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJJC5lYWNoKCBvcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlICk7CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCVsgdmFsdWUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0oCgkJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkIiArICIgIiArCgkJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7CgkJCWZvciAoIHZhciBpID0gJC5ldmVudC5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQkJcHJvcCA9ICQuZXZlbnQucHJvcHNbIC0taSBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oY2FsbGJhY2spICYmCgkJCWNhbGxiYWNrLmNhbGwoIHRoaXMuZWxlbWVudFswXSwgZXZlbnQsIGRhdGEgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKLyoKKiB3aWRnZXQgZmFjdG9yeSBleHRlbnRpb25zIGZvciBtb2JpbGUKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQodGFyZ2V0KSApLAoJCQlrZWVwTmF0aXZlID0gKHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCSQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsIHRhcmdldCApLm5vdCgga2VlcE5hdGl2ZSApWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBhIHdvcmthcm91bmQgZm9yIHdpbmRvdy5tYXRjaE1lZGlhCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLz4+IHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vPj4gdGVzdHMgZm9yIHNjcmVlbiBtZWRpYSB0eXBlIHdpdGggd2luZG93IHdpZHRoID4gNDgwcHgKCQkkLm1vYmlsZS5tZWRpYSgnQG1lZGlhIHNjcmVlbiBhbmQgKC13ZWJraXQtbWluLWRldmljZS1waXhlbC1yYXRpbzogMiknKSAvLz4+IHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7Ci8qCiogc3VwcG9ydCB0ZXN0cwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5tb2JpbGUuYnJvd3NlciA9IHt9OwokLm1vYmlsZS5icm93c2VyLmllID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCWEgPSBkaXYuYWxsIHx8IFtdOwoKCS8vIGFkZGVkIHt9IHRvIHNpbGVuY2UgY2xvc3VyZSBjb21waWxlciB3YXJuaW5ncy4gcmVnaXN0ZXJpbmcgbXkgZGlzbGlrZSBvZiBhbGwgdGhpbmdzCgkvLyBvdmVybHkgY2xldmVyIGhlcmUgZm9yIGZ1dHVyZSByZWZlcmVuY2UKCXdoaWxlICggZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiIsIGFbIDAgXSApe307CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93LAoJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudCwKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3csCglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYgInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSwKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglzY3JvbGxUb3A6ICggInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwgInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8ICJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0gKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQp2YXIgbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKLyoKKiAibW91c2UiIHBsdWdpbgoqLwoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgajsKCglldmVudCA9ICQuRXZlbnQoZXZlbnQpOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICl7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoIChjdCAmJiBjdC5sZW5ndGgpID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKXsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKXsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZDsKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyh0LnBhZ2VYIC0gc3RhcnRYKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKHQucGFnZVkgLSBzdGFydFkpID4gbW92ZVRocmVzaG9sZCApLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCl7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICl7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwovKiAKKiAiZXZlbnRzIiBwbHVnaW4gLSBIYW5kbGVzIGV2ZW50cwoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCiQuZWFjaCggKCAidG91Y2hzdGFydCB0b3VjaG1vdmUgdG91Y2hlbmQgb3JpZW50YXRpb25jaGFuZ2UgdGhyb3R0bGVkcmVzaXplICIgKwoJCQkJCSJ0YXAgdGFwaG9sZCBzd2lwZSBzd2lwZWxlZnQgc3dpcGVyaWdodCBzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKCgkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKfSk7Cgp2YXIgc3VwcG9ydFRvdWNoID0gJC5zdXBwb3J0LnRvdWNoLAoJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCmZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGU7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoJJC5ldmVudC5oYW5kbGUuY2FsbCggb2JqLCBldmVudCApOwoJZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKfQoKLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0ID0gewoKCWVuYWJsZWQ6IHRydWUsCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQlzY3JvbGxpbmcsCgkJCXRpbWVyOwoKCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJfQoKCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJfQoKCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJfSwgNTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyB0YXBob2xkCiQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCW9yaWdFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCX0KCgkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoZXZlbnQpIHsKCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQlpZiAoIG9yaWdUYXJnZXQgPT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICkKCQkJCS5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiApICk7CgkJCX0sIDc1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAokLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CglzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAxMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCglkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJc3RhcnQgPSB7CgkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJfSwKCQkJCXN0b3A7CgoJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgoJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQlzdG9wID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQl9OwoKCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJfSk7CgkJfSk7Cgl9Cn07CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vICJDb3dib3kiIEJlbiBBbG1hbgoKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGluamVjdHMgYSBsYW5kc2NhcGUgb3JpZW50YXRpb24KCS8vIG1lZGlhIHF1ZXJ5IGludG8gdGhlIGRvY3VtZW50IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4KCS8vIG1ha2VzIGFkanVzdG1lbnRzIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseQoJLy8gZGVjb2RlIHRoZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIFVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgdGhlIHRydWUgb3JpZW50YXRpb24gb2YgdGhlIGRldmljZSBhdCB0aGlzIG1vbWVudC4KCQkvLyBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcCB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkKCQkvLyB1c2UgYSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkgc28gdGhhdCBpZiB0aGUgZGV2aWNlL2Jyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIHBhcnRpY3VsYXIKCQkvLyBtZWRpYSBxdWVyeSwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oJCx3aW5kb3csdW5kZWZpbmVkKXsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbih2YWwpeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwovKgoqICJwYWdlIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7Cgl9LAoKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbShvcHRpb25zLmtlZXBOYXRpdmUpOwoKCQlpZigga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICl7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCIsICIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7Ci8qCiogImNvcmUiIC0gVGhlIGJhc2UgZmlsZSBmb3IgalFtCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fTsKCgkvLyBqUXVlcnkubW9iaWxlIGNvbmZpZ3VyYWJsZSBvcHRpb25zCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJzbGlkZSIsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBTaG93IGxvYWRpbmcgbWVzc2FnZSBkdXJpbmcgQWpheCByZXF1ZXN0cwoJCS8vIGlmIGZhbHNlLCBtZXNzYWdlIHdpbGwgbm90IGFwcGVhciwgYnV0IGxvYWRpbmcgY2xhc3NlcyB3aWxsIHN0aWxsIGJlIHRvZ2dsZWQgb24gaHRtbCBlbAoJCWxvYWRpbmdNZXNzYWdlOiAibG9hZGluZyIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAoJCS8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCQlncmFkZUE6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLmllICYmICQubW9iaWxlLmJyb3dzZXIuaWUgPj0gNzsKCQl9LAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCQkvLyBhcyBwb3NzaWJsZS4KCgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCXZhciBjID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJykKCQkJCS5kYXRhKCJwYWdlIik7CgkJfQoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogY29yZSB1dGlsaXRpZXMgZm9yIGF1dG8gYWpheCBuYXZpZ2F0aW9uLCBiYXNlIHRhZyBtZ210LAoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCQkJJiYgZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiCgkJCQkJJiYgcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYoIHVybEhpc3RvcnkuZ2V0TmV4dCgpICkgewoJCQkJCXVybEhpc3RvcnkuY2xlYXJGb3J3YXJkKCk7CgkJCQl9CgoJCQkJdXJsSGlzdG9yeS5zdGFjay5wdXNoKCB7dXJsIDogdXJsLCB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCB0aXRsZTogdGl0bGUsIHBhZ2VVcmw6IHBhZ2VVcmwsIHJvbGU6IHJvbGUgfSApOwoKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAtIDE7CgkJCX0sCgoJCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJCXVybEhpc3Rvcnkuc3RhY2sgPSB1cmxIaXN0b3J5LnN0YWNrLnNsaWNlKCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSApOwoJCQl9LAoKCQkJZGlyZWN0SGFzaENoYW5nZTogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCQl2YXIgYmFjayAsIGZvcndhcmQsIG5ld0FjdGl2ZUluZGV4LCBwcmV2ID0gdGhpcy5nZXRBY3RpdmUoKTsKCgkJCQkvLyBjaGVjayBpZiB1cmwgaXNwIGluIGhpc3RvcnkgYW5kIGlmIGl0J3MgYWhlYWQgb3IgYmVoaW5kIGN1cnJlbnQgcGFnZQoJCQkJJC5lYWNoKCB1cmxIaXN0b3J5LnN0YWNrLCBmdW5jdGlvbiggaSwgaGlzdG9yeUVudHJ5ICkgewoKCQkJCQkvL2lmIHRoZSB1cmwgaXMgaW4gdGhlIHN0YWNrLCBpdCdzIGEgZm9yd2FyZCBvciBhIGJhY2sKCQkJCQlpZiggb3B0cy5jdXJyZW50VXJsID09PSBoaXN0b3J5RW50cnkudXJsICkgewoJCQkJCQkvL2RlZmluZSBiYWNrIGFuZCBmb3J3YXJkIGJ5IHdoZXRoZXIgdXJsIGlzIG9sZGVyIG9yIG5ld2VyIHRoYW4gY3VycmVudCBwYWdlCgkJCQkJCWJhY2sgPSBpIDwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleDsKCQkJCQkJZm9yd2FyZCA9ICFiYWNrOwoJCQkJCQluZXdBY3RpdmVJbmRleCA9IGk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgPyBuZXdBY3RpdmVJbmRleCA6IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkJaWYoIGJhY2sgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzQmFjayApKCB0cnVlICk7CgkJCQl9IGVsc2UgaWYoIGZvcndhcmQgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzRm9yd2FyZCApKCBmYWxzZSApOwoJCQkJfQoJCQl9LAoKCQkJLy9kaXNhYmxlIGhhc2hjaGFuZ2UgZXZlbnQgbGlzdGVuZXIgaW50ZXJuYWxseSB0byBpZ25vcmUgb25lIGNoYW5nZQoJCQkvL3RvZ2dsZWQgaW50ZXJuYWxseSB3aGVuIGxvY2F0aW9uLmhhc2ggaXMgdXBkYXRlZCB0byBtYXRjaCB0aGUgdXJsIG9mIGEgc3VjY2Vzc2Z1bCBwYWdlIGxvYWQKCQkJaWdub3JlTmV4dEhhc2hDaGFuZ2U6IGZhbHNlCgkJfSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlVXJsKCBsb2NhdGlvbi5ocmVmICksCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBkb2N1bWVudFVybC5ocmVmICkgKSA6IGRvY3VtZW50VXJsLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9ICggZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCi8qCglpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCWZ1bmN0aW9uIHJlRm9jdXMoIHBhZ2UgKSB7CgkJdmFyIHBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0KCQllbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfQoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAnLnVpLXBhZ2UtYWN0aXZlJyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gU2F2ZSB0aGUgbGFzdCBzY3JvbGwgZGlzdGFuY2UgcGVyIHBhZ2UsIGJlZm9yZSBpdCBpcyBoaWRkZW4KCXZhciBzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWUsCgkJZmlyc3RTY3JvbGxFbGVtLCBnZXRTY3JvbGxFbGVtLCBzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglnZXRTY3JvbGxFbGVtID0gZnVuY3Rpb24oKSB7CgkJdmFyIHNjcm9sbEVsZW0gPSAkd2luZG93LCBhY3RpdmVQYWdlLAoJCQl0b3VjaE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQ7CgoJCWlmKCB0b3VjaE92ZXJmbG93ICl7CgkJCWFjdGl2ZVBhZ2UgPSAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlzY3JvbGxFbGVtID0gYWN0aXZlUGFnZS5pcyggIi51aS1uYXRpdmUtZml4ZWQiICkgPyBhY3RpdmVQYWdlLmZpbmQoICIudWktY29udGVudCIgKSA6IGFjdGl2ZVBhZ2U7CgkJfQoKCQlyZXR1cm4gc2Nyb2xsRWxlbTsKCX07CgoJc2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCBzY3JvbGxFbGVtICkgewoJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24gdGhlIGJyb3dzZXIKCQkvLyBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQlpZiggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSBzY3JvbGxFbGVtICYmIHNjcm9sbEVsZW0uc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCwgJCh0aGlzKSApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJIAlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Nyb2xsRWxlbSA9IGdldFNjcm9sbEVsZW0oKTsKCgkgCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCXNjcm9sbEVsZW0udW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCXNjcm9sbEVsZW0uYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCglnZXRTY3JvbGxFbGVtKCkuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE1ha2UgdGhlIGlPUyBjbG9jayBxdWljay1zY3JvbGwgd29yayBhZ2FpbiBpZiB3ZSdyZSB1c2luZyBuYXRpdmUgb3ZlcmZsb3cgc2Nyb2xsaW5nCgkvKgoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICl7CgkJaWYoICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCSQoIHdpbmRvdyApLmJpbmQoICJzY3JvbGxzdG9wIiwgZnVuY3Rpb24oKXsKCQkJCWlmKCAkKCB0aGlzICkuc2Nyb2xsVG9wKCkgPT09IDAgKXsKCQkJCQkkLm1vYmlsZS5hY3RpdmVQYWdlLnNjcm9sbFRvcCggMCApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9CgkqLwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJLy9nZXQgY3VycmVudCBzY3JvbGwgZGlzdGFuY2UKCQl2YXIgYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG91Y2hPdmVyZmxvdyA9ICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICggdG91Y2hPdmVyZmxvdyA/IDAgOiAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApLAoJCQlzY3JlZW5IZWlnaHQgPSBnZXRTY3JlZW5IZWlnaHQoKTsKCgkJLy8gU2Nyb2xsIHRvIHRvcCwgaGlkZSBhZGRyIGJhcgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCgkJaWYoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCWlmKCAhdG91Y2hPdmVyZmxvdyl7CgkJCXRvUGFnZS5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJaWYoIHRvdWNoT3ZlcmZsb3cgJiYgdG9TY3JvbGwgKXsKCgkJCXRvUGFnZS5hZGRDbGFzcyggInVpLW1vYmlsZS1wcmUtdHJhbnNpdGlvbiIgKTsKCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQlyZUZvY3VzKCB0b1BhZ2UgKTsKCgkJCS8vc2V0IHBhZ2UncyBzY3JvbGxUb3AgdG8gcmVtZW1iZXJlZCBkaXN0YW5jZQoJCQlpZiggdG9QYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSApewoJCQkJdG9QYWdlLmZpbmQoICIudWktY29udGVudCIgKS5zY3JvbGxUb3AoIHRvU2Nyb2xsICk7CgkJCX0KCQkJZWxzZXsKCQkJCXRvUGFnZS5zY3JvbGxUb3AoIHRvU2Nyb2xsICk7CgkJCX0KCQl9CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbdHJhbnNpdGlvbiB8fCAibm9uZSJdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy9yZXNldCB0b1BhZ2UgaGVpZ2h0IGJhY2sKCQkJaWYoICF0b3VjaE92ZXJmbG93ICl7CgkJCQl0b1BhZ2UuaGVpZ2h0KCAiIiApOwoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZQoJCQkJcmVGb2N1cyggdG9QYWdlICk7CgkJCX0KCgkJCS8vIEp1bXAgdG8gdG9wIG9yIHByZXYgc2Nyb2xsLCBzb21ldGltZXMgb24gaU9TIHRoZSBwYWdlIGhhcyBub3QgcmVuZGVyZWQgeWV0LgoJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCSQubW9iaWxlLnNpbGVudFNjcm9sbCggdG9TY3JvbGwgKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYoIGZyb21QYWdlICkgewoJCQkJaWYoICF0b3VjaE92ZXJmbG93ICl7CgkJCQkJZnJvbVBhZ2UuaGVpZ2h0KCAiIiApOwoJCQkJfQoKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gZ2V0U2NyZWVuSGVpZ2h0KCl7CgkJdmFyIG9yaWVudGF0aW9uIAk9ICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpLAoJCQlwb3J0CQkJPSBvcmllbnRhdGlvbiA9PT0gInBvcnRyYWl0IiwKCQkJd2luTWluCQkJPSBwb3J0ID8gNDgwIDogMzIwLAoJCQlzY3JlZW5IZWlnaHQJPSBwb3J0ID8gc2NyZWVuLmF2YWlsSGVpZ2h0IDogc2NyZWVuLmF2YWlsV2lkdGgsCgkJCXdpbkhlaWdodAkJPSBNYXRoLm1heCggd2luTWluLCAkKCB3aW5kb3cgKS5oZWlnaHQoKSApLAoJCQlwYWdlTWluCQkJPSBNYXRoLm1pbiggc2NyZWVuSGVpZ2h0LCB3aW5IZWlnaHQgKTsKCgkJcmV0dXJuIHBhZ2VNaW47Cgl9CgoJJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0ID0gZ2V0U2NyZWVuSGVpZ2h0OwoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCS8vIERvbid0IGFwcGx5IHRoaXMgaGVpZ2h0IGluIHRvdWNoIG92ZXJmbG93IGVuYWJsZWQgbW9kZQoJCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApewoJCQlyZXR1cm47CgkJfQoJCSQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmNzcyggIm1pbi1oZWlnaHQiLCBnZXRTY3JlZW5IZWlnaHQoKSApOwoJfQoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCi8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcwkgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggJ3dlYmtpdEFuaW1hdGlvbkVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZGVmYXVsdCBub24tYW5pbWF0aW9uIHRyYW5zaXRpb24gaGFuZGxlcgoJJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyID0gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0b1BhZ2UsICRmcm9tUGFnZSApIHsKCQlpZiAoICRmcm9tUGFnZSApIHsKCQkJJGZyb21QYWdlLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQl9CgkJJHRvUGFnZS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgoJCXJldHVybiAkLkRlZmVycmVkKCkucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvUGFnZSwgJGZyb21QYWdlICkucHJvbWlzZSgpOwoJfTsKCgkvL2RlZmF1bHQgaGFuZGxlciBmb3IgdW5rbm93biB0cmFuc2l0aW9ucwoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyOwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCW5vbmU6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcgoJfTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKGFzUGFyc2VkT2JqZWN0KSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudFVybCApIDogZG9jdW1lbnRVcmwuaHJlZjsKCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRCYXNlICkgOiBkb2N1bWVudEJhc2UuaHJlZjsKCX07CgoJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSAkKHRoaXMpOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiggIXBhZ2UuZGF0YSgicGFnZSIpLm9wdGlvbnMuZG9tQ2FjaGUKCQkJCSYmIHBhZ2UuaXMoIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIpICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfTsKCgkvLyBMb2FkIGEgcGFnZSBpbnRvIHRoZSBET00uCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkvLyBrbm93IHdoZW4gdGhlIHBhZ2UgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkJLy8gVGhlIGRlZmF1bHQgbG9hZFBhZ2Ugb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkKCQkJLy8gdGhlIGNhbGxlci4KCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgoJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBwYWdlIGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJcGFnZSA9IG51bGwsCgoJCQkvLyBJZiB0aGUgcmVsb2FkUGFnZSBvcHRpb24gaXMgdHJ1ZSwgYW5kIHRoZSBwYWdlIGlzIGFscmVhZHkKCQkJLy8gaW4gdGhlIERPTSwgZHVwQ2FjaGVkUGFnZSB3aWxsIGJlIHNldCB0byB0aGUgcGFnZSBlbGVtZW50CgkJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHJlbW92ZWQgYWZ0ZXIgdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZQoJCQkvLyBwYWdlIGlzIGxvYWRlZCBvZmYgdGhlIG5ldHdvcmsuCgkJCWR1cENhY2hlZFBhZ2UgPSBudWxsLAoKCQkJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCgkJCWZpbmRCYXNlV2l0aERlZmF1bHQgPSBmdW5jdGlvbigpewoJCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQkJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQkJfSwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiggIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICl7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIHBhZ2UgdG8gYmUgbG9hZGVkLgoJCXZhciBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggYWJzVXJsICksCgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBwYWdlLiBGb3IgZW1iZWRkZWQgcGFnZXMsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IgcGFnZXMKCQkJLy8gd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUgcmVsYXRpdmUKCQkJLy8gcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBwYWdlcyAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgcGFnZS4KCQkJZGF0YVVybCA9IHBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzVXJsICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICI6anFtRGF0YSh1cmw9JyIgKyBkYXRhVXJsICsgIicpIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApOwoJCX0KCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UKCQkvLyB0byB0aGUgZmlyc3QgcGFnZSBhbmQgcmVmZXJzIHRvIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlLCBlcnJvciBvdXQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UgJiYgcGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICkgewoJCQkJLy8gQ2hlY2sgdG8gbWFrZSBzdXJlIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseQoJCQkJLy8gaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0CgkJCQkvLyBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLCB3ZSBjaGVjayBmb3IgdGhpcwoJCQkJLy8gY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aCBhbiBpZAoJCQkJLy8gZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvcgoJCQkJLy8gY2FzZS4gSWYgdGhlIGZpcnN0LXBhZ2UgaXMgbm90IGluIHRoZSBET00sIHRoZW4gd2UgbGV0CgkJCQkvLyB0aGluZ3MgZmFsbCB0aHJvdWdoIHRvIHRoZSBhamF4IGxvYWRpbmcgY29kZSBiZWxvdyBzbwoJCQkJLy8gdGhhdCBpdCBnZXRzIHJlbG9hZGVkLgoJCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkubGVuZ3RoICkgewoJCQkJCXBhZ2UgPSAkKCAkLm1vYmlsZS5maXJzdFBhZ2UgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggZmlsZVVybCApICApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJfQoKCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJaWYgKCBiYXNlICkgewoJCQliYXNlLnJlc2V0KCk7CgkJfQoKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKXsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkKCQkJCQkJCSYmIFJlZ0V4cC4kMQoJCQkJCQkJJiYgZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApCgkJCQkJCQkmJiBSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBSZWdFeHAuJDEgKTsKCQkJCQl9CgoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYoICFwYWdlLmxlbmd0aCApewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKHRoaXMpLmlzKCdbc3JjXScpID8gJ3NyYycgOiAnYWN0aW9uJywKCQkJCQkJCQl0aGlzVXJsID0gJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAnJyApOwoKCQkJCQkJCWlmKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICI6anFtRGF0YSh1cmw9JyIgKyBkYXRhVXJsICsgIicpIiApOwoJCQkJCX0KCgkJCQkJLy9iaW5kIHBhZ2VIaWRlIHRvIHJlbW92ZVBhZ2UgYWZ0ZXIgaXQncyBoaWRkZW4sIGlmIHRoZSBwYWdlIG9wdGlvbnMgc3BlY2lmeSB0byBkbyBzbwoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYoIHBsZkV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQoICI8ZGl2IGNsYXNzPSd1aS1sb2FkZXIgdWktb3ZlcmxheS1zaGFkb3cgdWktYm9keS1lIHVpLWNvcm5lci1hbGwnPjxoMT4iKyAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSArIjwvaDE+PC9kaXY+IiApCgkJCQkJCQkuY3NzKHsgImRpc3BsYXkiOiAiYmxvY2siLCAib3BhY2l0eSI6IDAuOTYsICJ0b3AiOiAkd2luZG93LnNjcm9sbFRvcCgpICsgMTAwIH0pCgkJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKQoJCQkJCQkJLmRlbGF5KCA4MDAgKQoJCQkJCQkJLmZhZGVPdXQoIDQwMCwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJJCggdGhpcyApLnJlbW92ZSgpOwoJCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT0gInN0cmluZyIgKSB7CgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudCBtYW51YWxseS9keW5hbWljYWxseQoJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCS8vIHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbgoJCS8vIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4KCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJLy8gZm9ybVBhZ2UgYW5kIHRvUGFnZSBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LgoJCS8vIEl0IGlzIHVwIHRvIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbgoJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQlpZiggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAtMTsgfSwKCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAxOyB9CgkJCX0pOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdib2R5JykgewoJCQkJJChkb2N1bWVudC5hY3RpdmVFbGVtZW50KS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaChlKSB7fQoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICkgKyBkaWFsb2dIYXNoS2V5OwoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiB1cmwgKSB7CgkJCS8vZGlzYWJsZSBoYXNoIGxpc3RlbmluZyB0ZW1wb3JhcmlseQoJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdHJ1ZTsKCQkJLy91cGRhdGUgaGFzaCBhbmQgaGlzdG9yeQoJCQlwYXRoLnNldCggdXJsICk7CgkJfQoKCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0IHVzZSBwYWdlVGl0bGUKCQl2YXIgbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICk/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwgdG9QYWdlLmNoaWxkcmVuKCI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIpLmZpbmQoIi51aS10aXRsZSIgKS5nZXRFbmNvZGVkVGV4dCgpOwoJCWlmKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24KCQkJfHwgKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkKCQkJfHwgKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiggIWhpc3RvcnlEaXIgKSB7CgkJCXVybEhpc3RvcnkuYWRkTmV3KCB1cmwsIHNldHRpbmdzLnRyYW5zaXRpb24sIHBhZ2VUaXRsZSwgcGFnZVVybCwgc2V0dGluZ3Mucm9sZSApOwoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS50aXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbigpIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFsbCBkb25lIGNoYW5naW5nIHRoZSBjdXJyZW50IHBhZ2UuCgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCl7CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJJHRoaXMuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCXZhciB0eXBlID0gJHRoaXMuYXR0ciggIm1ldGhvZCIgKSwKCQkJCXRhcmdldCA9ICR0aGlzLmF0dHIoICJ0YXJnZXQiICksCgkJCQl1cmwgPSAkdGhpcy5hdHRyKCAiYWN0aW9uIiApOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKTsKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoJHRoaXMpICk7CgoJCQlpZigoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoZG9jdW1lbnRVcmwsIHVybCkpIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCWRpcmVjdGlvbjoJJHRoaXMuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoJCQlpZiAoIGxpbmsgKSB7CgkJCQlpZiAoIHBhdGgucGFyc2VVcmwoIGxpbmsuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSB7CgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJCggbGluayApLmNsb3Nlc3QoICIudWktYnRuIiApLm5vdCggIi51aS1kaXNhYmxlZCIgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAudWktYnRuIiApLm5vdCggbGluayApLmJsdXIoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgJGxpbmsgPSAkKCBsaW5rICksCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoZG9jdW1lbnRVcmwsIGhyZWYpICk7CgoJCQlpZiggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdmFyIHRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCWRpcmVjdGlvbiA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICksCgkJCQlyZXZlcnNlID0gKCBkaXJlY3Rpb24gJiYgZGlyZWN0aW9uID09PSAicmV2ZXJzZSIgKSB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgJGxpbmsgPSAkKHRoaXMpLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHtyb2xlOiAkbGluay5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiKX0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIGhhc2ggKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKCBoYXNoICksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQkvL2lmIGxpc3RlbmluZyBpcyBkaXNhYmxlZCAoZWl0aGVyIGdsb2JhbGx5IG9yIHRlbXBvcmFyaWx5KSwgb3IgaXQncyBhIGRpYWxvZyBoYXNoCgkJCWlmKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmKCB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA+IDEgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZighJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkpIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoJCQkJCQlpc0JhY2s6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5iYWNrKCk7IH0sCgkJCQkJCWlzRm9yd2FyZDogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsgfQoJCQkJCX0pOwoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UoKQoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCgkJCQkJCS8vIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgaGlzdG9yeSBjaGFuZ2UKCQkJCQkJLy8gZG8gdGhlIGZvbGxvd2luZwoJCQkJCQllaXRoZXI6IGZ1bmN0aW9uKCBpc0JhY2sgKSB7CgkJCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJCQl0byA9IGFjdGl2ZS5wYWdlVXJsOwoKCQkJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQkJCXRyYW5zaXRpb246CSBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQkJCQlyZXZlcnNlOiBpc0JhY2sKCQkJCQkJCX0pOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vaWYgdG8gaXMgZGVmaW5lZCwgbG9hZCBpdAoJCQlpZiAoIHRvICkgewoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlIGVsZW1lbnQgZnJvbQoJCQkJLy8gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZS9hYnNvbHV0ZSBVUkwuIElmICd0bycgaXMKCQkJCS8vIGFuIGlkLCB3ZSBuZWVkIHRvIHJlc29sdmUgaXQgYWdhaW5zdCB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsCgkJCQkvLyBzaW5jZSB0aGUgaGFzaGNoYW5nZSBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsIHBhZ2UvZGlhbG9nLgoJCQkJdG8gPSAoIHR5cGVvZiB0byA9PT0gInN0cmluZyIgJiYgIXBhdGguaXNQYXRoKCB0byApICkgPyAoIHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB0bywgZG9jdW1lbnRCYXNlICkgKSA6IHRvOwoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgkJCQkvL3RoZXJlJ3Mgbm8gaGFzaCwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGRvbQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CgkJfTsKCgkJLy9oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXIKCQkkd2luZG93LmJpbmQoICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oIGUsIHRyaWdnZXJlZCApIHsKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIGxvY2F0aW9uLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgY2FsbGJhY2sKCn0pKCBqUXVlcnkgKTsKLyoKKiBoaXN0b3J5LnB1c2hTdGF0ZSBzdXBwb3J0LCBsYXllcmVkIG9uIHRvcCBvZiBoYXNoY2hhbmdlCiovCgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggbG9jYXRpb24uaHJlZiApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJLy8gRmxhZyBmb3IgdHJhY2tpbmcgaWYgYSBIYXNoY2hhbmdlIG5hdHVyYWxseSBvY2N1cnMgYWZ0ZXIgZWFjaCBwb3BzdGF0ZSArIHJlcGxhY2UKCQloYXNoY2hhbmdlRmlyZWQ6IGZhbHNlLAoKCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB7CgkJCQloYXNoOiBsb2NhdGlvbi5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYoIGRpYWxvZ0luZGV4ID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc2xpY2UoIDAsIGRpYWxvZ0luZGV4ICkgKyAiIyIgKyB1cmwuc2xpY2UoIGRpYWxvZ0luZGV4ICk7CgkJCX0gZWxzZSBpZiggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoJCQkKCQkJdmFyIGhyZWYsIHN0YXRlLAoJCQkJaGFzaCA9IGxvY2F0aW9uLmhhc2gsCgkJCQlpc1BhdGggPSAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApLAoJCQkJcmVzb2x1dGlvblVybCA9IGlzUGF0aCA/IGxvY2F0aW9uLmhyZWYgOiAkLm1vYmlsZS5nZXREb2N1bWVudFVybCgpOwoJCQloYXNoID0gaXNQYXRoID8gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiBoYXNoOwoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgd2luZG93Lmhpc3RvcnkuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLCBob2xkbmV4dGhhc2hjaGFuZ2UgPSBmYWxzZTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gc3RhdGUgaXRzIG5vdCBhIHBvcHN0YXRlIHdlIGNhcmUgYWJvdXQsIGllIGNocm9tZSdzIGluaXRpYWwgcG9wc3RhdGUKCQkJLy8gb3IgZm9yd2FyZCBwb3BzdGF0ZQoJCQlpZiggcG9wcGVkU3RhdGUgKSB7CgkJCQkvLyBkaXNhYmxlIGFueSBoYXNoY2hhbmdlIHRyaWdnZXJlZCBieSB0aGUgYnJvd3NlcgoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIGRlZmVyIG91ciBtYW51YWwgaGFzaGNoYW5nZSB1bnRpbCBhZnRlciB0aGUgYnJvd3NlciBmaXJlZAoJCQkJLy8gdmVyc2lvbiBoYXMgY29tZSBhbmQgZ29uZQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCB0aGUgbWFudWFsIGhhc2ggaGFuZGxpbmcgdGFrZXMgcGxhY2UKCQkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCQkvLyBjaGFuZ2UgdGhlIHBhZ2UgYmFzZWQgb24gdGhlIGhhc2gKCQkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoJCQkJfSwgMTAwKTsKCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsIGxvY2F0aW9uLmhyZWYgKTsKCQkJfQoJCX0KCX0pOwoKCSQoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiAidHJhbnNpdGlvbnMiIHBsdWdpbiAtIFBhZ2UgY2hhbmdlIHRyYW5pc3Rpb25zCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gY3NzM1RyYW5zaXRpb25IYW5kbGVyKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQl2aWV3cG9ydENsYXNzID0gInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lLAoJCWRvbmVGdW5jID0gZnVuY3Rpb24oKSB7CgoJCQkkdG8uYWRkKCAkZnJvbSApLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKTsKCgkJCWlmICggJGZyb20gJiYgJGZyb21bIDAgXSAhPT0gJHRvWyAwIF0gKSB7CgkJCQkkZnJvbS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgkJCX0KCgkJCSR0by5wYXJlbnQoKS5yZW1vdmVDbGFzcyggdmlld3BvcnRDbGFzcyApOwoKCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApOwoJCX07CgoJJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lRnVuYyApOwoKCSR0by5wYXJlbnQoKS5hZGRDbGFzcyggdmlld3BvcnRDbGFzcyApOwoKCWlmICggJGZyb20gKSB7CgkJJGZyb20uYWRkQ2xhc3MoIG5hbWUgKyAiIG91dCIgKyByZXZlcnNlQ2xhc3MgKTsKCX0KCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAiICsgbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgoJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKfQoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHB1YmxpYy4KJC5tb2JpbGUuY3NzM1RyYW5zaXRpb25IYW5kbGVyID0gY3NzM1RyYW5zaXRpb25IYW5kbGVyOwoKLy8gSWYgdGhlIGRlZmF1bHQgdHJhbnNpdGlvbiBoYW5kbGVyIGlzIHRoZSAnbm9uZScgaGFuZGxlciwgcmVwbGFjZSBpdCB3aXRoIG91ciBoYW5kbGVyLgppZiAoICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9PT0gJC5tb2JpbGUubm9uZVRyYW5zaXRpb25IYW5kbGVyICkgewoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gY3NzM1RyYW5zaXRpb25IYW5kbGVyOwp9Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogImRlZ3JhZGVJbnB1dHMiIHBsdWdpbiAtIGRlZ3JhZGVzIGlucHV0cyB0byBhbm90aGVyIHR5cGUgYWZ0ZXIgY3VzdG9tIGVuaGFuY2VtZW50cyBhcmUgbWFkZS4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoZS50YXJnZXQpICk7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJkaWFsb2ciIHBsdWdpbi4KKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbC5hdHRyKCAicm9sZSIsICJkaWFsb2ciICkKCQkJLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCB1aS1vdmVybGF5LXNoYWRvdyIgKQoJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJLmVuZCgpCgkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0nY29udGVudCcpLDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIgKQoJCQkJLmxhc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkgIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KQoJCS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJCggdGhpcyApLmRpYWxvZygpOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBUaGlzIHBsdWdpbiBoYW5kbGVzIHRoZW1pbmcgYW5kIGxheW91dCBvZiBoZWFkZXJzLCBmb290ZXJzLCBhbmQgY29udGVudCBhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQoJdmFyICRwYWdlID0gJCggdGhpcyApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCQoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgdGhpcyApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoJCQkKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CQoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEiICk7CgkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoJCQkKCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmIAoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkdGhpcy5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsJCQkJCgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkidGFiaW5kZXgiOiAiMCIsCgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkgICAgJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiAiY29sbGFwc2libGUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaWNvblRoZW1lOiAiZCIsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgkJfQoKCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICggby5jb250ZW50VGhlbWUgKSA/ICggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICkgOiAiIik7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvblBvczogImxlZnQiLAoJCQkJCWljb246ICJwbHVzIiwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSkKCQkJLmFkZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkgICAgY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UpCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tbWludXMiLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLXBsdXMiLCBpc0NvbGxhcHNlICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPwoJCQkJCQkJCQkJImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLmNvbGxhcHNpYmxlKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJjb2xsYXBzaWJsZXNldCIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkZWwuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApLAoJCQkJCQl3aWRnZXQgPSBjb2xsYXBzaWJsZS5kYXRhKCAiY29sbGFwc2libGUiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IHdpZGdldC5vcHRpb25zLmNvbnRlbnRUaGVtZTsKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggd2lkZ2V0Lm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoKCQkJCX0pOwoKCQkJLy8gY2xlYW4gdXAgYm9yZGVycwoJCQljb2xsYXBzaWJsZXNJblNldC5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkaW5nICkKCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCS5hZGQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoJCQl9KTsKCgkJCWNvbGxhcHNpYmxlc0luU2V0LmZpcnN0KCkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQoJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCQljb2xsYXBzaWJsZXNJblNldC5sYXN0KCkKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApCgkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCQl9Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5jb2xsYXBzaWJsZXNldCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiZmllbGRjb250YWluIiBwbHVnaW4gLSBzaW1wbGUgY2xhc3MgYWRkaXRpb25zIHRvIG1ha2UgZm9ybSByb3cgc2VwYXJhdG9ycwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiBwbHVnaW4gZm9yIGNyZWF0aW5nIENTUyBncmlkcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSxvcHRpb25zKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHtzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NX0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDNuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNG4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCg1bis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsvKgoqICJuYXZiYXIiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLm5vdCggIi51aS1zdGF0ZS1wZXJzaXN0IiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubmF2YmFyKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJsaXN0dmlldyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzOwoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXcgIiArICggdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyAiIDogIiIgKTsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9yZW1vdmVDb3JuZXJzOiBmdW5jdGlvbiggbGksIHdoaWNoICkgewoJCXZhciB0b3AgPSAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItdHIgdWktY29ybmVyLXRsIiwKCQkJYm90ID0gInVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWJyIHVpLWNvcm5lci1ibCI7CgoJCWxpID0gbGkuYWRkKCBsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciwgLnVpLWxpLWxpbmstYWx0LCAudWktbGktdGh1bWIiICkgKTsKCgkJaWYgKCB3aGljaCA9PT0gInRvcCIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKTsKCQl9IGVsc2UgaWYgKCB3aGljaCA9PT0gImJvdHRvbSIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCBib3QgKTsKCQl9IGVsc2UgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICsgIiAiICsgYm90ICk7CgkJfQoJfSwKCglfcmVmcmVzaENvcm5lcnM6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyICRsaSwKCQkJJHZpc2libGVsaSwKCQkJJHRvcGxpLAoJCQkkYm90dG9tbGk7CgoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQkkbGkgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJsaSIgKTsKCQkJLy8gYXQgY3JlYXRlIHRpbWUgdGhlIGxpIGFyZSBub3QgdmlzaWJsZSB5ZXQgc28gd2UgbmVlZCB0byByZWx5IG9uIC51aS1zY3JlZW4taGlkZGVuCgkJCSR2aXNpYmxlbGkgPSBjcmVhdGU/JGxpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOiRsaS5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCgkJCXRoaXMuX3JlbW92ZUNvcm5lcnMoICRsaSApOwoKCQkJLy8gU2VsZWN0IHRoZSBmaXJzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJHRvcGxpID0gJHZpc2libGVsaS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApOwoKCQkJJHRvcGxpLmFkZCggJHRvcGxpLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCwgLnVpLWxpLWxpbmstYWx0IHNwYW46Zmlyc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdHIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRsIiApOwoKCQkJLy8gU2VsZWN0IHRoZSBsYXN0IHZpc2libGUgbGkgZWxlbWVudAoJCQkkYm90dG9tbGkgPSAkdmlzaWJsZWxpLmxhc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoIi51aS1saS1pY29uIikKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKQoJewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApCgl7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCWNvdW50ZXIgPSAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCB8fCAhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApID8gMCA6IDEsCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWc7CgoJCWlmICggY291bnRlciApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoJCQoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoInRoZW1lIikgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoKCQkJCWlmICggYS5sZW5ndGggKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSgiaWNvbiIpOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8ICJhcnJvdy1yIiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPSBmYWxzZSApICYmICggYS5sZW5ndGggPT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCAidWktbGluay1pbmhlcml0IiApOwoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBsaXN0c3BsaXR0aGVtZSB8fCBsYXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWU7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKGl0ZW0pCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6IGZhbHNlCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQlpY29uOiBsaXN0c3BsaXRpY29uIHx8IGxhc3QuanFtRGF0YSggImljb24iICkgfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGl0ZW0uanFtRGF0YSggInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJ0biB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJaWYgKCBjb3VudGVyICkgewoJCQkJCQljb3VudGVyID0gMTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYm9keS0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvdW50ZXIgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbS5pcyggIi51aS1saS1zdGF0aWM6Zmlyc3QiICkgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKGNvdW50ZXIrKykgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fcmVmcmVzaENvcm5lcnMoIGNyZWF0ZSApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHMgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVscy5sZW5ndGggPyBub2RlRWxzIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArCWRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIpIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCdhOmZpcnN0Jyk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKXsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTDsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsiJykiKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLmxpc3R2aWV3KCk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJsaXN0dmlldyIgZmlsdGVyIGV4dGVuc2lvbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlICl7CglyZXR1cm4gdGV4dC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwp9OwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW07CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZihsYXN0dmFsKSAhPT0gMCApIHsKCgkJCQkvLyBSZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgkJCX0KCQkJbGlzdHZpZXcuX3JlZnJlc2hDb3JuZXJzKCk7CgkJfSkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoICQoIHRoaXMgKS5qcW1EYXRhKCAiaW5zZXQiICkgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJub2pzIiBwbHVnaW4gLSBjbGFzcyB0byBtYWtlIGVsZW1lbnRzIGhpZGRlbiB0byBBIGdyYWRlIGJyb3dzZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJbGFiZWwgPSBpbnB1dC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkuZmluZCggImxhYmVsIiApLmZpbHRlciggIltmb3I9JyIgKyBpbnB1dFsgMCBdLmlkICsgIiddIiApLAoJCQlpbnB1dHR5cGUgPSBpbnB1dC5hdHRyKCAidHlwZSIgKSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29uID0gaW5wdXQucGFyZW50cyggIjpqcW1EYXRhKHR5cGU9J2hvcml6b250YWwnKSIgKS5sZW5ndGggPyB1bmRlZmluZWQgOiB1bmNoZWNrZWRTdGF0ZSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZS4uLgoJCWlmKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSB0aGlzLmVsZW1lbnQuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZQoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJaW5wdXQuYWRkKCBsYWJlbCApCgkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0ndWktIiArIGlucHV0dHlwZSArICInPjwvZGl2PiIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCgkdGhpcykucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJJHRoaXMuanFtRGF0YSggImNhY2hlVmFsIiwgJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpewoJCWlmKHRoaXMuaW5wdXR0eXBlID09ICJjaGVja2JveCIpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIisgdGhpcy5lbGVtZW50LmF0dHIoICJuYW1lIiApICsiJ11bdHlwZT0nIisgdGhpcy5pbnB1dHR5cGUgKyInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQkvLyBpbnB1dFswXS5jaGVja2VkIGV4cGFuZG8gZG9lc24ndCBhbHdheXMgcmVwb3J0IHRoZSBwcm9wZXIgdmFsdWUKCQkvLyBmb3IgY2hlY2tlZD0nY2hlY2tlZCcKCQlpZiAoICQoIGlucHV0WyAwIF0gKS5wcm9wKCAiY2hlY2tlZCIgKSApIHsKCgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgoJCX0gZWxzZSB7CgoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9uIiBwbHVnaW4gLSBsaW5rcyB0aGF0IHByb3h5IHRvIG5hdGl2ZSBpbnB1dC9idXR0b25zCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSwgW3R5cGU9J2ltYWdlJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSAkZWwuYnV0dG9uTWFya3VwKCk7CgkgCSAJcmV0dXJuOwogCSAJfQoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93CgkJCX0pCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNu4oCZdCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmKCAkYnV0dG9uUGxhY2Vob2xkZXIgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gJCggIjxpbnB1dD4iLCB7CgkJCQkJCQl0eXBlOiAiaGlkZGVuIiwKCQkJCQkJCW5hbWU6ICRlbC5hdHRyKCAibmFtZSIgKSwKCQkJCQkJCXZhbHVlOiAkZWwuYXR0ciggInZhbHVlIiApCgkJCQkJCX0pLmluc2VydEJlZm9yZSggJGVsICk7CgoJCQkJCQkvLyBCaW5kIHRvIGRvYyB0byByZW1vdmUgYWZ0ZXIgc3VibWl0IGhhbmRsaW5nCgkJCQkJCSQoIGRvY3VtZW50ICkub25lKCJzdWJtaXQiLCBmdW5jdGlvbigpewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIHRoZSB0ZXh0V3JhcHBlciBpcyBzdG9yZWQgYXMgYSBkYXRhIGVsZW1lbnQgb24gdGhlIGJ1dHRvbiBvYmplY3QKCQkvLyB0byBwcmV2ZW50IHJlZmVyZW5jaW5nIGJ5IGl0J3MgaW1wbGVtZW50YXRpb24gZGV0YWlscyAoZWcgJ2NsYXNzJykKCQl0aGlzLmJ1dHRvbi5kYXRhKCAndGV4dFdyYXBwZXInICkudGV4dCggJGVsLnRleHQoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJzbGlkZXIiIHBsdWdpbgoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlzbGlkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyICIgKyBzZWxlY3RDbGFzcyArICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgKwoJCQkJCQkJCQkiIHVpLWJ0bi1jb3JuZXItYWxsJyByb2xlPSdhcHBsaWNhdGlvbic+PC9kaXY+IiApLAoKCQkJaGFuZGxlID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1zbGlkZXItaGFuZGxlJz48L2E+IiApCgkJCQkuYXBwZW5kVG8oIHNsaWRlciApCgkJCQkuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pLAoJCQlvcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgoJCQlzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQljb250cm9sLmZpbmQoICJvcHRpb24iICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQljb3JuZXJzID0gIWkgPyAicmlnaHQiIDoibGVmdCIsCgkJCQkJdGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsYmcgdWktc2xpZGVyLWxhYmVsYmctIiArIHNpZGUgKyB0aGVtZSArICIgdWktYnRuLWNvcm5lci0iICsgY29ybmVycyArICInPjwvZGl2PiIgKQoJCQkJCS5wcmVwZW5kVG8oIHNsaWRlciApOwoKCQkJCSQoICI8c3BhbiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iICsgc2lkZSArIHRoZW1lICsgIiB1aS1idG4tY29ybmVyLSIgKyBjb3JuZXJzICsgIicgcm9sZT0naW1nJz4iICsgJCggdGhpcyApLmdldEVuY29kZWRUZXh0KCkgKyAiPC9zcGFuPiIgKQoJCQkJCS5wcmVwZW5kVG8oIGhhbmRsZSApOwoJCQl9KTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoIXNlbGYubW91c2VNb3ZlZCkgewoJCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLmtleXVwKCBmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1ciggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQkvLyBwcmV2ZW50IHNjcmVlbiBkcmFnIHdoZW4gc2xpZGVyIGFjdGl2YXRlZAoJCSQoIGRvY3VtZW50ICkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCgkJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgoJCQkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQkJfQoKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJdGhpcy5oYW5kbGUKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLmhhbmRsZQoJCQkuYmluZCggImtleWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQlicmVhazsKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJYnJlYWs7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCWJyZWFrOwoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfSkgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgkJCS5rZXl1cCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2godW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJdmFyIGNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsIHBlcmNlbnQsCgkJCWNUeXBlID0gY29udHJvbFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQltaW4gPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGggLSAxLAoJCQlzdGVwID0gKGNUeXBlID09PSAiaW5wdXQiICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDApID8gcGFyc2VGbG9hdChjb250cm9sLmF0dHIoInN0ZXAiKSkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQl2YXIgZGF0YSA9IHZhbCwKCQkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJCXRvbCA9IDg7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0ICsgdGhpcy5zbGlkZXIud2lkdGgoKSArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0ICkgLyB0aGlzLnNsaWRlci53aWR0aCgpICkgKiAxMDAgKTsKCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl0aGlzLmhhbmRsZS5hdHRyKCB7CgkJCQkiYXJpYS12YWx1ZW5vdyI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICksCgkJCQkiYXJpYS12YWx1ZXRleHQiOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSwKCQkJCXRpdGxlOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKQoJCQl9KTsKCgkJLy8gYWRkL3JlbW92ZSBjbGFzc2VzIGZvciBmbGlwIHRvZ2dsZSBzd2l0Y2gKCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJaWYgKCBuZXd2YWwgPT09IDAgKSB7CgkJCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLXNsaWRlci1zd2l0Y2gtYSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1zd2l0Y2gtYiIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1iIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1hIiApOwoJCQl9CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBjVHlwZSA9PT0gImlucHV0IiApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAidGV4dGlucHV0IiBwbHVnaW4gZm9yIHRleHQgaW5wdXRzLCB0ZXh0YXJlYXMKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSkiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQlmb2N1c2VkRWwsIGNsZWFyYnRuOwoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCgkJLy8ic2VhcmNoIiBpbnB1dCB3aWRnZXQKCQlpZiAoIGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9J2NsZWFyIHRleHQnPmNsZWFyIHRleHQ8L2E+IiApCgkJCQkudGFwKGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dC52YWwoICIiICkuZm9jdXMoKTsKCQkJCQlpbnB1dC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUKCQkJCX0pOwoKCQkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCQl9LCAwKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggInVpLWZvY3VzIiApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQkJaW5wdXQuaGVpZ2h0KHNjcm9sbEhlaWdodCArIGV4dHJhTGluZUhlaWdodCk7CgkJCQkJfQoJCQkJfSwKCQkJCWtleXVwVGltZW91dDsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIGtleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgkJCX0KCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoJCSggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlKS5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSA/CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudCApLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKXsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNjcmVlbiA9ICQoICI8ZGl2PiIsIHsiY2xhc3MiOiAidWktc2VsZWN0bWVudS1zY3JlZW4gdWktc2NyZWVuLWhpZGRlbiJ9ICkuYXBwZW5kVG8oIHRoaXNQYWdlICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCksCgoJCQlsaXN0Ym94ID0gICQoIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSB1aS1zZWxlY3RtZW51LWhpZGRlbiB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArICIgIiArICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIH0gKS5pbnNlcnRBZnRlcihzY3JlZW4pLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKSwKCgkJCW1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKSwKCgkJCW1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2NyZWVuOiBzY3JlZW4sCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudHlwZSA9PSAidmNsaWNrIiB8fAoJCQkJCQkJIGV2ZW50LmtleUNvZGUgJiYgKCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApICkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5kZWxlZ2F0ZSggIi51aS1saT5hIiwgImZvY3VzaW4iLCBmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLmF0dHIoICJ0YWJpbmRleCIsICIwIiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAiLnVpLWxpPmEiLCAiZm9jdXNvdXQiLCBmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5CgkJCQkJCWlmICggIXNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpOwoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCSBjYXNlIDEzOgoJCQkJCQkgY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uICJzY3JlZW4iIG92ZXJsYXkKCQkJCXNlbGYuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKXsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLAoJCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCQkvLyByZXR1cm4gYW4gYXJyYXkgb2YgYWxsIHNlbGVjdGVkIGluZGV4J3MKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJfSwKCgkJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAicGFnZSIgKSB7CgkJCQkJLy8gZG9lc24ndCBzb2x2ZSB0aGUgcG9zc2libGUgaXNzdWUgd2l0aCBjYWxsaW5nIGNoYW5nZSBwYWdlCgkJCQkJLy8gd2hlcmUgdGhlIG9iamVjdHMgZG9uJ3QgZGVmaW5lIGRhdGEgdXJscyB3aGljaCBwcmV2ZW50cyBkaWFsb2cga2V5CgkJCQkJLy8gc3RyaXBwaW5nIC0gY2hhbmdlUGFnZSBoYXMgaW5jb21pbmcgcmVmYWN0b3IKCQkJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYuc2NyZWVuLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCQlzZWxmLmxpc3Rib3guYWRkQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKS5yZW1vdmVBdHRyKCAic3R5bGUiICkucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQl9CgoJCQkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQkJCXNlbGYuaXNPcGVuID0gZmFsc2U7CgkJCX0sCgoJCQlvcGVuOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbWVudUhlaWdodCA9IHNlbGYubGlzdC5wYXJlbnQoKS5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGYubGlzdC5wYXJlbnQoKS5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIudWktcGFnZS1hY3RpdmUiICksCgkJCQkJdE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQsCgkJCQkJdFNjcm9sbEVsZW0gPSBhY3RpdmVQYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSA/IGFjdGl2ZVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApIDogYWN0aXZlUGFnZSwKCQkJCQlzY3JvbGxUb3AgPSB0T3ZlcmZsb3cgPyB0U2Nyb2xsRWxlbS5zY3JvbGxUb3AoKSA6ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZm9jdXMoKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQkvLyBzaWxlbnRTY3JvbGwoKSBpcyBjYWxsZWQgd2hlbmV2ZXIgYSBwYWdlIGlzIHNob3duIHRvIHJlc3RvcmUKCQkJCQkJLy8gYW55IHByZXZpb3VzIHNjcm9sbCBwb3NpdGlvbiB0aGUgcGFnZSBtYXkgaGF2ZSBoYWQuIFdlIG5lZWQgdG8KCQkJCQkJLy8gd2FpdCBmb3IgdGhlICJzaWxlbnRzY3JvbGwiIGV2ZW50IGJlZm9yZSBzZXR0aW5nIGZvY3VzIHRvIGF2b2lkCgkJCQkJCS8vIHRoZSBicm93c2VyInMgImZlYXR1cmUiIHdoaWNoIG9mZnNldHMgcmVuZGVyaW5nIHRvIG1ha2Ugc3VyZQoJCQkJCQkvLyB3aGF0ZXZlciBoYXMgZm9jdXMgaXMgaW4gdmlldy4KCQkJCQkJJCggd2luZG93ICkub25lKCAic2lsZW50c2Nyb2xsIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pOwoKCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggc2VsZi5tZW51UGFnZSwgewoJCQkJCQl0cmFuc2l0aW9uOiAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbgoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLnNjcmVlbi5oZWlnaHQoICQoZG9jdW1lbnQpLmhlaWdodCgpICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCgkJCQkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgYnV0dG9uCgkJCQkJdmFyIHJvb210b3AgPSBidG5PZmZzZXQgLSBzY3JvbGxUb3AsCgkJCQkJCXJvb21ib3QgPSBzY3JvbGxUb3AgKyBzY3JlZW5IZWlnaHQgLSBidG5PZmZzZXQsCgkJCQkJCWhhbGZoZWlnaHQgPSBtZW51SGVpZ2h0IC8gMiwKCQkJCQkJbWF4d2lkdGggPSBwYXJzZUZsb2F0KCBzZWxmLmxpc3QucGFyZW50KCkuY3NzKCAibWF4LXdpZHRoIiApICksCgkJCQkJCW5ld3RvcCwgbmV3bGVmdDsKCgkJCQkJaWYgKCByb29tdG9wID4gbWVudUhlaWdodCAvIDIgJiYgcm9vbWJvdCA+IG1lbnVIZWlnaHQgLyAyICkgewoJCQkJCQluZXd0b3AgPSBidG5PZmZzZXQgKyAoIHNlbGYuYnV0dG9uLm91dGVySGVpZ2h0KCkgLyAyICkgLSBoYWxmaGVpZ2h0OwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIDMwcHggdG9sZXJhbmNlIG9mZiB0aGUgZWRnZXMKCQkJCQkJbmV3dG9wID0gcm9vbXRvcCA+IHJvb21ib3QgPyBzY3JvbGxUb3AgKyBzY3JlZW5IZWlnaHQgLSBtZW51SGVpZ2h0IC0gMzAgOiBzY3JvbGxUb3AgKyAzMDsKCQkJCQl9CgoJCQkJCS8vIElmIHRoZSBtZW51d2lkdGggaXMgc21hbGxlciB0aGFuIHRoZSBzY3JlZW4gY2VudGVyIGlzCgkJCQkJaWYgKCBtZW51V2lkdGggPCBtYXh3aWR0aCApIHsKCQkJCQkJbmV3bGVmdCA9ICggc2NyZWVuV2lkdGggLSBtZW51V2lkdGggKSAvIDI7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vb3RoZXJ3aXNlIGluc3VyZSBhID49IDMwcHggb2Zmc2V0IGZyb20gdGhlIGxlZnQKCQkJCQkJbmV3bGVmdCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLmxlZnQgKyBzZWxmLmJ1dHRvbi5vdXRlcldpZHRoKCkgLyAyIC0gbWVudVdpZHRoIC8gMjsKCgkJCQkJCS8vIDMwcHggdG9sZXJhbmNlIG9mZiB0aGUgZWRnZXMKCQkJCQkJaWYgKCBuZXdsZWZ0IDwgMzAgKSB7CgkJCQkJCQluZXdsZWZ0ID0gMzA7CgkJCQkJCX0gZWxzZSBpZiAoIChuZXdsZWZ0ICsgbWVudVdpZHRoKSA+IHNjcmVlbldpZHRoICkgewoJCQkJCQkJbmV3bGVmdCA9IHNjcmVlbldpZHRoIC0gbWVudVdpZHRoIC0gMzA7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXNlbGYubGlzdGJveC5hcHBlbmQoIHNlbGYubGlzdCApCgkJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJCS5jc3MoewoJCQkJCQkJdG9wOiBuZXd0b3AsCgkJCQkJCQlsZWZ0OiBuZXdsZWZ0CgkJCQkJCX0pCgkJCQkJCS5hZGRDbGFzcyggImluIiApOwoKCQkJCQlmb2N1c01lbnVJdGVtKCk7CgoJCQkJCS8vIGR1cGxpY2F0ZSB3aXRoIHZhbHVlIHNldCBpbiBwYWdlIHNob3cgZm9yIGRpYWxvZyBzaXplZCBzZWxlY3RzCgkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJfQoJCQl9LAoKCQkJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQkvLyBQb3B1bGF0ZSBtZW51IHdpdGggb3B0aW9ucyBmcm9tIHNlbGVjdCBlbGVtZW50CgkJCQlzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJJHBhcmVudCA9ICR0aGlzLnBhcmVudCgpLAoJCQkJCQl0ZXh0ID0gJHRoaXMuZ2V0RW5jb2RlZFRleHQoKSwKCQkJCQkJYW5jaG9yID0gIjxhIGhyZWY9JyMnPiIrIHRleHQgKyI8L2E+IiwKCQkJCQkJY2xhc3NlcyA9IFtdLAoJCQkJCQlleHRyYUF0dHJzID0gW107CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCAkcGFyZW50LmlzKCAib3B0Z3JvdXAiICkgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9ICRwYXJlbnQuYXR0ciggImxhYmVsIiApOwoKCQkJCQkJLy8gaGFzIHRoaXMgb3B0Z3JvdXAgYWxyZWFkeSBiZWVuIGJ1aWx0IHlldD8KCQkJCQkJaWYgKCAkLmluQXJyYXkoIG9wdExhYmVsLCBvcHRncm91cHMgKSA9PT0gLTEgKSB7CgkJCQkJCQlsaXMucHVzaCggIjxsaSBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdsaXN0LWRpdmlkZXInPiIrIG9wdExhYmVsICsiPC9saT4iICk7CgkJCQkJCQlvcHRncm91cHMucHVzaCggb3B0TGFiZWwgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gRmluZCBwbGFjZWhvbGRlciB0ZXh0CgkJCQkJLy8gVE9ETzogQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHVzZSBnZXRBdHRyaWJ1dGU/IF5SVwoJCQkJCWlmICggIXRoaXMuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkdGhpcy5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJfQoKCQkJCQkvLyBzdXBwb3J0IGRpc2FibGVkIG9wdGlvbiB0YWdzCgkJCQkJaWYgKCB0aGlzLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJZXh0cmFBdHRycy5wdXNoKCAiYXJpYS1kaXNhYmxlZD0ndHJ1ZSciICk7CgkJCQkJfQoKCQkJCQlsaXMucHVzaCggIjxsaSBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJvcHRpb24taW5kZXg9JyIgKyBpICsgIicgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nIisgZGF0YUljb24gKyInIGNsYXNzPSciKyBjbGFzc2VzLmpvaW4oIiAiKSArICInICIgKyBleHRyYUF0dHJzLmpvaW4oIiAiKSArIj4iKyBhbmNob3IgKyI8L2xpPiIgKTsKCQkJCX0pOwoKCQkJCXNlbGYubGlzdC5odG1sKCBsaXMuam9pbigiICIpICk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaSIgKQoJCQkJCS5hdHRyKHsgInJvbGUiOiAib3B0aW9uIiwgInRhYmluZGV4IjogIi0xIiB9KQoJCQkJCS5maXJzdCgpLmF0dHIoICJ0YWJpbmRleCIsICIwIiApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGNsb3NlIGxpbmsgZm9yIHNpbmdsZSBzZWxlY3RzCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCQkJdGhpcy5oZWFkZXJDbG9zZS5oaWRlKCk7CgkJCQl9CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0KCQl9KTsKCX07CgoJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggInNlbGVjdCIsICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIHRoaXMgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSApewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwovKgoqICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQltZW51UGFnZVRoZW1lOiAiYiIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoOmpxbURhdGEocm9sZT0nc2xpZGVyJykpIgoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKICBfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKICB9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0Jz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkudGV4dCggJCggdGhpcy5zZWxlY3RbIDAgXS5vcHRpb25zLml0ZW0oIHNlbGVjdGVkSW5kZXggKSApLnRleHQoKSApCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IG9wdGlvbnMuaWNvbnBvcywKCQkJCQlpbmxpbmU6IG9wdGlvbnMuaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdwoJCQkJfSk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJdGhpcy5zZWxlY3QuYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9ucyIgcGx1Z2luIC0gZm9yIG1ha2luZyBidXR0b24tbGlrZSBsaW5rcwoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKyApIHsKCQl2YXIgZWwgPSB0aGlzLmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBlbC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZWwuanFtRGF0YSggImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGVsLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJCWlubGluZTogICAgIG9wdGlvbnMuaW5saW5lICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pbmxpbmUgICAgIDogZWwuanFtRGF0YSggImlubGluZSIgKSwKCQkJCXNoYWRvdzogICAgIG9wdGlvbnMuc2hhZG93ICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zaGFkb3cgICAgIDogZWwuanFtRGF0YSggInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZWwuanFtRGF0YSggImNvcm5lcnMiICksCgkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnNoYWRvdyA6IGVsLmpxbURhdGEoICJpY29uc2hhZG93IiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgoJCQkvLyBCdXR0b24gaW5uZXIgbWFya3VwCgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICksCgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKSwKCQkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJLy8gaWYgc28sIHByZXZlbnQgZG91YmxlIGVuaGFuY2VtZW50LCBhbmQgY29udGludWUgd2l0aCByZXN0IG9mIHRoZSBlbGVtZW50cy4KCQlpZiggZS50YWdOYW1lID09PSAiSU5QVVQiICYmIGVsLmpxbURhdGEoJ3JvbGUnKSA9PT0gImJ1dHRvbiIgKSBjb250aW51ZTsKCQkKCQkvLyBpZiB0aGlzIGlzIGEgYnV0dG9uLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiggZS50YWdOYW1lID09PSAiQlVUVE9OIiApIHsKCSAJIAlpZiAoICEkKCBlLnBhcmVudE5vZGUgKS5oYXNDbGFzcyggInVpLWJ0biIgKSApICQoIGUgKS5idXR0b24oKTsKCSAJIAljb250aW51ZTsKIAkgCX0KCgkJaWYgKCBhdHRhY2hFdmVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi11cC0iICsgby50aGVtZTsKCgkJaWYgKCBvLmlubGluZSApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaWYgKCBvLmNvcm5lcnMgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQlpbm5lckNsYXNzICs9ICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCX0KCgkJaWYgKCBvLnNoYWRvdyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1zaGFkb3ciOwoJCX0KCgkJZS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIG8udGhlbWUgKTsKCQllbC5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvbkljb24gKTsKCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICkgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgoJCS8vIFRPRE8gb2J2aW91c2x5IGl0IHdvdWxkIGJlIG5pY2UgdG8gcHVsbCB0aGlzIGVsZW1lbnQgb3V0IGluc3RlYWQgb2YKCQkvLyByZXRyaWV2aW5nIGl0IGZyb20gdGhlIERPTSBhZ2FpbiwgYnV0IHRoaXMgY2hhbmdlIGlzIG11Y2ggbGVzcyBvYnRydXNpdmUKCQkvLyBhbmQgMS4wIGRyYXdzIG5pZ2gKCQkkLmRhdGEoIGUsICd0ZXh0V3JhcHBlcicsICQoIGJ1dHRvblRleHQgKSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCWlubGluZTogZmFsc2UsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoInVpLWJ0biAiKSA+IC0xICYmIGNuYW1lLmluZGV4T2YoInVpLWRpc2FibGVkICIpIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGJ0biA9IGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSwKCQkJCSRidG4sIHRoZW1lOwoKCQkJaWYgKCBidG4gKSB7CgkJCQkkYnRuID0gJCggYnRuICk7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlY2FuY2VsIHZtb3VzZXVwIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9LAoJCSJ2bW91c2VvdmVyIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBidG4gPSBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICksCgkJCQkkYnRuLCB0aGVtZTsKCgkJCWlmICggYnRuICkgewoJCQkJJGJ0biA9ICQoIGJ0biApOwoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyogCiogImNvbnRyb2xncm91cCIgcGx1Z2luIC0gY29ybmVyLXJvdW5kaW5nIGZvciBncm91cHMgb2YgYnV0dG9ucywgY2hlY2tzLCByYWRpb3MsIGV0YwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQkJCWRpcmVjdGlvbjogJGVsLmpxbURhdGEoICJ0eXBlIiApIHx8ICJ2ZXJ0aWNhbCIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwaGVhZGluZyA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT0gImhvcml6b250YWwiID8gWyAidWktY29ybmVyLWxlZnQiLCAidWktY29ybmVyLXJpZ2h0IiBdIDogWyAidWktY29ybmVyLXRvcCIsICJ1aS1jb3JuZXItYm90dG9tIiBdLAoJCQl0eXBlID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLmF0dHIoICJ0eXBlIiApOwoKCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJaWYgKCBncm91cGhlYWRpbmcubGVuZ3RoICkgewoJCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGhlYWRpbmcuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbigwKSApOwoJCQlncm91cGhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCB1aS1jb250cm9sZ3JvdXAtIiArIG8uZGlyZWN0aW9uICk7CgoJCS8vIFRPRE86IFRoaXMgc2hvdWxkIGJlIG1vdmVkIG91dCB0byB0aGUgY2xvc3VyZQoJCS8vIG90aGVyd2lzZSBpdCBpcyByZWRlZmluZWQgZWFjaCB0aW1lIGNvbnRyb2xncm91cCgpIGlzIGNhbGxlZAoJCWZ1bmN0aW9uIGZsaXBDbGFzc2VzKCBlbHMgKSB7CgkJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkJLmVxKCAwICkuYWRkQ2xhc3MoIGZsQ29ybmVyc1sgMCBdICkKCQkJCS5lbmQoKQoJCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJCX0KCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9Cgl9KTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwp9KTsKCn0pKGpRdWVyeSk7LyoKKiAibGlua3MiIHBsdWdpbiAtIHNpbXBsZSBjbGFzcyBhZGRpdGlvbnMgZm9yIGxpbmtzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCQoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcwoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJmaXhIZWFkZXJGb290ZXIiIHBsdWdpbiAtIG9uLWRlbWFuZCBwb3NpdGlvbmluZyBmb3IgaGVhZGVycyxmb290ZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBzbGlkZURvd25DbGFzcyA9ICJ1aS1oZWFkZXItZml4ZWQgdWktZml4ZWQtaW5saW5lIGZhZGUiLAoJc2xpZGVVcENsYXNzID0gInVpLWZvb3Rlci1maXhlZCB1aS1maXhlZC1pbmxpbmUgZmFkZSIsCgoJc2xpZGVEb3duU2VsZWN0b3IgPSAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiwKCXNsaWRlVXBTZWxlY3RvciA9ICIudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiOwoKJC5mbi5maXhIZWFkZXJGb290ZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm4gdGhpczsKCX0KCglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJaWYgKCAkdGhpcy5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJfQoKCQkvLyBTaG91bGQgYmUgc2xpZGVkb3duCgkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkkdGhpcy5maW5kKCBzbGlkZVVwU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVVcENsYXNzICk7Cgl9KTsKfTsKCi8vIHNpbmdsZSBjb250cm9sbGVyIGZvciBhbGwgc2hvd2luZyxoaWRpbmcsdG9nZ2xpbmcKJC5tb2JpbGUuZml4ZWRUb29sYmFycyA9IChmdW5jdGlvbigpIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHN0aWNreUZvb3RlciwgZGVsYXlUaW1lciwKCQljdXJyZW50c3RhdGUgPSAiaW5saW5lIiwKCQlhdXRvSGlkZU1vZGUgPSBmYWxzZSwKCQlzaG93RGVsYXkgPSAxMDAsCgkJaWdub3JlVGFyZ2V0cyA9ICJhLGlucHV0LHRleHRhcmVhLHNlbGVjdCxidXR0b24sbGFiZWwsLnVpLWhlYWRlci1maXhlZCwudWktZm9vdGVyLWZpeGVkIiwKCQl0b29sYmFyU2VsZWN0b3IgPSAiLnVpLWhlYWRlci1maXhlZDpmaXJzdCwgLnVpLWZvb3Rlci1maXhlZDpub3QoLnVpLWZvb3Rlci1kdXBsaWNhdGUpOmxhc3QiLAoJCS8vIGZvciBzdG9yaW5nIHF1aWNrIHJlZmVyZW5jZXMgdG8gZHVwbGljYXRlIGZvb3RlcnMKCQlzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXN0YXRlQmVmb3JlID0gbnVsbCwKCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZSwKCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSB0cnVlOwoKCWZ1bmN0aW9uIHNob3dFdmVudENhbGxiYWNrKCBldmVudCApIHsKCQkvLyBBbiBldmVudCB0aGF0IGFmZmVjdHMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHZpc3VhbCB2aWV3cG9ydCBoYXMKCQkvLyBiZWVuIHRyaWdnZXJlZC4gSWYgdGhlIGhlYWRlciBhbmQvb3IgZm9vdGVyIGZvciB0aGUgY3VycmVudCBwYWdlIGFyZSBpbiBvdmVybGF5CgkJLy8gbW9kZSwgd2Ugd2FudCB0byBoaWRlIHRoZW0sIGFuZCB0aGVuIGZpcmUgb2ZmIGEgdGltZXIgdG8gc2hvdyB0aGVtIGF0IGEgbGF0ZXIKCQkvLyBwb2ludC4gRXZlbnRzIGxpa2UgYSByZXNpemUgY2FuIGJlIHRyaWdnZXJlZCBjb250aW51b3VzbHkgZHVyaW5nIGEgc2Nyb2xsLCBvbgoJCS8vIHNvbWUgcGxhdGZvcm1zLCBzbyB0aGUgdGltZXIgaXMgdXNlZCB0byBkZWxheSB0aGUgYWN0dWFsIHBvc2l0aW9uaW5nIHVudGlsIHRoZQoJCS8vIGZsb29kIG9mIGV2ZW50cyBoYXZlIHN1YnNpZGVkLgoJCS8vCgkJLy8gSWYgd2UgYXJlIGluIGF1dG9IaWRlTW9kZSwgd2UgZG9uJ3QgZG8gYW55dGhpbmcgYmVjYXVzZSB3ZSBrbm93IHRoZSBzY3JvbGwKCQkvLyBjYWxsYmFja3MgZm9yIHRoZSBwbHVnaW4gd2lsbCBmaXJlIG9mZiBhIHNob3cgd2hlbiB0aGUgc2Nyb2xsaW5nIGhhcyBzdG9wcGVkLgoJCWlmICggIWF1dG9IaWRlTW9kZSAmJiBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApIHsKCQkJaWYgKCAhZGVsYXlUaW1lciApIHsKCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSggdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJfQoJfQoKCSQoZnVuY3Rpb24oKSB7CgkJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkJJGRvY3VtZW50CgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoJCQkJCXN0YXRlQmVmb3JlID0gY3VycmVudHN0YXRlOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoKCQkJCQlpZiAoICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoICFzY3JvbGxUcmlnZ2VyZWQgKSB7CgkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMudG9nZ2xlKCBzdGF0ZUJlZm9yZSApOwoJCQkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNpbGVudHNjcm9sbCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoKCQkvLyBUaGUgYmVsb3cgY2hlY2tzIGZpcnN0IGZvciBhICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIHZhbHVlLCBhbmQgaWYgemVybywgYmluZHMgc2Nyb2xsIGV2ZW50cyB0byAkKHdpbmRvdykgaW5zdGVhZC4KCQkvLyBJZiB0aGUgc2Nyb2xsVG9wIHZhbHVlIGlzIGFjdHVhbGx5IHplcm8sIGJvdGggd2lsbCByZXR1cm4gemVybyBhbnl3YXkuCgkJLy8KCQkvLyBXb3JrcyB3aXRoICQoZG9jdW1lbnQpLCBub3QgJCh3aW5kb3cpIDogT3BlcmEgTW9iaWxlIChXaW5NTyBwaG9uZTsga2luZGEgYnJva2VuIGFueXdheSkKCQkvLyBXb3JrcyB3aXRoICQod2luZG93KSwgbm90ICQoZG9jdW1lbnQpIDogSUUgNy84CgkJLy8gV29ya3Mgd2l0aCBlaXRoZXIgJCh3aW5kb3cpIG9yICQoZG9jdW1lbnQpIDogQ2hyb21lLCBGRiAzLjYvNCwgQW5kcm9pZCAxLjYvMi4xLCBpT1MKCQkvLyBOZWVkcyB3b3JrIGVpdGhlciB3YXkgOiBCQjUsIE9wZXJhIE1vYmlsZSAoaU9TKQoKCQkoICggJGRvY3VtZW50LnNjcm9sbFRvcCgpID09PSAwICkgPyAkd2luZG93IDogJGRvY3VtZW50ICkKCQkJLmJpbmQoICJzY3JvbGxzdGFydCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSB0cnVlOwoKCQkJCWlmICggc3RhdGVCZWZvcmUgPT09IG51bGwgKSB7CgkJCQkJc3RhdGVCZWZvcmUgPSBjdXJyZW50c3RhdGU7CgkJCQl9CgoJCQkJLy8gV2Ugb25seSBlbnRlciBhdXRvSGlkZU1vZGUgaWYgdGhlIGhlYWRlcnMvZm9vdGVycyBhcmUgaW4KCQkJCS8vIGFuIG92ZXJsYXkgc3RhdGUgb3IgdGhlIHNob3cgdGltZXIgd2FzIHN0YXJ0ZWQuIElmIHRoZQoJCQkJLy8gc2hvdyB0aW1lciBpcyBzZXQsIGNsZWFyIGl0IHNvIHRoZSBoZWFkZXJzL2Zvb3RlcnMgZG9uJ3QKCQkJCS8vIHNob3cgdXAgdW50aWwgYWZ0ZXIgd2UncmUgZG9uZSBzY3JvbGxpbmcuCgkJCQl2YXIgaXNPdmVybGF5U3RhdGUgPSBzdGF0ZUJlZm9yZSA9PSAib3ZlcmxheSI7CgoJCQkJYXV0b0hpZGVNb2RlID0gaXNPdmVybGF5U3RhdGUgfHwgISFkZWxheVRpbWVyOwoKCQkJCWlmICggYXV0b0hpZGVNb2RlICkgewoJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCQkJaWYgKCBpc092ZXJsYXlTdGF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZTsKCgkJCQlpZiAoIGF1dG9IaWRlTW9kZSApIHsKCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJCQkJYXV0b0hpZGVNb2RlID0gZmFsc2U7CgkJCQl9CgkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCX0pOwoKCQkJJHdpbmRvdy5iaW5kKCAicmVzaXplIHVwZGF0ZWxheW91dCIsIHNob3dFdmVudENhbGxiYWNrICk7Cgl9KTsKCgkvLyAxLiBCZWZvcmUgcGFnZSBpcyBzaG93biwgY2hlY2sgZm9yIGR1cGxpY2F0ZSBmb290ZXIKCS8vIDIuIEFmdGVyIHBhZ2UgaXMgc2hvd24sIGFwcGVuZCBmb290ZXIgdG8gbmV3IHBhZ2UKCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCXZhciBwYWdlID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQlmb290ZXIgPSBwYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKSwKCQkJCWlkID0gZm9vdGVyLmRhdGEoICJpZCIgKSwKCQkJCXByZXZQYWdlID0gdWkucHJldlBhZ2UsCgkJCQlwcmV2Rm9vdGVyID0gcHJldlBhZ2UgJiYgcHJldlBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLAoJCQkJcHJldkZvb3Rlck1hdGNoZXMgPSBwcmV2Rm9vdGVyLmxlbmd0aCAmJiBwcmV2Rm9vdGVyLmpxbURhdGEoICJpZCIgKSA9PT0gaWQ7CgoJCQlpZiAoIGlkICYmIHByZXZGb290ZXJNYXRjaGVzICkgewoJCQkJc3RpY2t5Rm9vdGVyID0gZm9vdGVyOwoJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIucmVtb3ZlQ2xhc3MoICJmYWRlIGluIG91dCIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApICk7CgkJCX0KCQl9KQoJCS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93IiwgZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCBzdGlja3lGb290ZXIgJiYgc3RpY2t5Rm9vdGVyLmxlbmd0aCApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIuYXBwZW5kVG8oICR0aGlzICkuYWRkQ2xhc3MoICJmYWRlIiApICk7CgkJCQkJc3RpY2t5Rm9vdGVyID0gbnVsbDsKCQkJCX0sIDUwMCk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdyggdHJ1ZSwgdGhpcyApOwoJCX0pOwoKCS8vIFdoZW4gYSBjb2xsYXBzaWJsZSBpcyBoaWRkZW4gb3Igc2hvd24gd2UgbmVlZCB0byB0cmlnZ2VyIHRoZSBmaXhlZCB0b29sYmFyIHRvIHJlcG9zaXRpb24gaXRzZWxmICgjMTYzNSkKCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktY29sbGFwc2libGUtY29udGFpbiIsICJjb2xsYXBzZSBleHBhbmQiLCBzaG93RXZlbnRDYWxsYmFjayApOwoKCS8vIGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgaXMgYnJva2VuIGluIGlPUyAzLjIuMSBvbiB0aGUgaVBhZC4gVGhlCgkvLyBjb29yZGluYXRlcyBpbnNpZGUgb2YgdGhlIHJlY3QgaXQgcmV0dXJucyBkb24ndCBoYXZlIHRoZSBwYWdlIHNjcm9sbCBwb3NpdGlvbgoJLy8gZmFjdG9yZWQgb3V0IG9mIGl0IGxpa2UgdGhlIG90aGVyIHBsYXRmb3JtcyBkby4gVG8gZ2V0IGFyb3VuZCB0aGlzLAoJLy8gd2UnbGwganVzdCBjYWxjdWxhdGUgdGhlIHRvcCBvZmZzZXQgdGhlIG9sZCBmYXNoaW9uZWQgd2F5IHVudGlsIGNvcmUgaGFzCgkvLyBhIGNoYW5jZSB0byBmaWd1cmUgb3V0IGhvdyB0byBoYW5kbGUgdGhpcyBzaXR1YXRpb24uCgkvLwoJLy8gVE9ETzogV2UnbGwgbmVlZCB0byBnZXQgcmlkIG9mIGdldE9mZnNldFRvcCgpIG9uY2UgYSBmaXggZ2V0cyBmb2xkZWQgaW50byBjb3JlLgoKCWZ1bmN0aW9uIGdldE9mZnNldFRvcCggZWxlICkgewoJCXZhciB0b3AgPSAwLAoJCQlvcCwgYm9keTsKCgkJaWYgKCBlbGUgKSB7CgkJCWJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlvcCA9IGVsZS5vZmZzZXRQYXJlbnQ7CgkJCXRvcCA9IGVsZS5vZmZzZXRUb3A7CgoJCQl3aGlsZSAoIGVsZSAmJiBlbGUgIT0gYm9keSApIHsKCQkJCXRvcCArPSBlbGUuc2Nyb2xsVG9wIHx8IDA7CgoJCQkJaWYgKCBlbGUgPT0gb3AgKSB7CgkJCQkJdG9wICs9IG9wLm9mZnNldFRvcDsKCQkJCQlvcCA9IGVsZS5vZmZzZXRQYXJlbnQ7CgkJCQl9CgoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9CgkJcmV0dXJuIHRvcDsKCX0KCglmdW5jdGlvbiBzZXRUb3AoIGVsICkgewoJCXZhciBmcm9tVG9wID0gJCh3aW5kb3cpLnNjcm9sbFRvcCgpLAoJCQl0aGlzVG9wID0gZ2V0T2Zmc2V0VG9wKCBlbFsgMCBdICksIC8vIGVsLm9mZnNldCgpLnRvcCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBvbiBpUGFkIGlPUyAzLjIuMSwgY2FsbCBvdXIgd29ya2Fyb3VuZCBpbnN0ZWFkLgoJCQl0aGlzQ1NTdG9wID0gZWwuY3NzKCAidG9wIiApID09ICJhdXRvIiA/IDAgOiBwYXJzZUZsb2F0KGVsLmNzcyggInRvcCIgKSksCgkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJdGhpc0hlaWdodCA9IGVsLm91dGVySGVpZ2h0KCksCgkJCXVzZVJlbGF0aXZlID0gZWwucGFyZW50cyggIi51aS1wYWdlOm5vdCgudWktcGFnZS1mdWxsc2NyZWVuKSIgKS5sZW5ndGgsCgkJCXJlbHZhbDsKCgkJaWYgKCBlbC5pcyggIi51aS1oZWFkZXItZml4ZWQiICkgKSB7CgoJCQlyZWx2YWwgPSBmcm9tVG9wIC0gdGhpc1RvcCArIHRoaXNDU1N0b3A7CgoJCQlpZiAoIHJlbHZhbCA8IHRoaXNUb3AgKSB7CgkJCQlyZWx2YWwgPSAwOwoJCQl9CgoJCQlyZXR1cm4gZWwuY3NzKCAidG9wIiwgdXNlUmVsYXRpdmUgPyByZWx2YWwgOiBmcm9tVG9wICk7CgkJfSBlbHNlIHsKCQkJLy8gcmVsdmFsID0gLTEgKiAodGhpc1RvcCAtIChmcm9tVG9wICsgc2NyZWVuSGVpZ2h0KSArIHRoaXNDU1N0b3AgKyB0aGlzSGVpZ2h0KTsKCQkJLy8gaWYgKCByZWx2YWwgPiB0aGlzVG9wICkgeyByZWx2YWwgPSAwOyB9CgkJCXJlbHZhbCA9IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgLSB0aGlzSGVpZ2h0IC0gKHRoaXNUb3AgLSB0aGlzQ1NTdG9wICk7CgoJCQlyZXR1cm4gZWwuY3NzKCAidG9wIiwgdXNlUmVsYXRpdmUgPyByZWx2YWwgOiBmcm9tVG9wICsgc2NyZWVuSGVpZ2h0IC0gdGhpc0hlaWdodCApOwoJCX0KCX0KCgkvLyBFeHBvc2VkIG1ldGhvZHMKCXJldHVybiB7CgoJCXNob3c6IGZ1bmN0aW9uKCBpbW1lZGlhdGVseSwgcGFnZSApIHsKCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCWN1cnJlbnRzdGF0ZSA9ICJvdmVybGF5IjsKCgkJCXZhciAkYXAgPSBwYWdlID8gJCggcGFnZSApIDoKCQkJCQkoICQubW9iaWxlLmFjdGl2ZVBhZ2UgPyAkLm1vYmlsZS5hY3RpdmVQYWdlIDoKCQkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKSApOwoKCQkJcmV0dXJuICRhcC5jaGlsZHJlbiggdG9vbGJhclNlbGVjdG9yICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCQl2YXIgZWwgPSAkKCB0aGlzICksCgkJCQkJZnJvbVRvcCA9ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLAoJCQkJCS8vIGVsLm9mZnNldCgpLnRvcCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBvbiBpUGFkIGlPUyAzLjIuMSwgY2FsbCBvdXIgd29ya2Fyb3VuZCBpbnN0ZWFkLgoJCQkJCXRoaXNUb3AgPSBnZXRPZmZzZXRUb3AoIGVsWyAwIF0gKSwKCQkJCQlzY3JlZW5IZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQsCgkJCQkJdGhpc0hlaWdodCA9IGVsLm91dGVySGVpZ2h0KCksCgkJCQkJYWxyZWFkeVZpc2libGUgPSAoIGVsLmlzKCAiLnVpLWhlYWRlci1maXhlZCIgKSAmJiBmcm9tVG9wIDw9IHRoaXNUb3AgKyB0aGlzSGVpZ2h0ICkgfHwKCQkJCQkJCQkJCQkJCQkoIGVsLmlzKCAiLnVpLWZvb3Rlci1maXhlZCIgKSAmJiB0aGlzVG9wIDw9IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgKTsKCgkJCQkvLyBBZGQgc3RhdGUgY2xhc3MKCQkJCWVsLmFkZENsYXNzKCAidWktZml4ZWQtb3ZlcmxheSIgKS5yZW1vdmVDbGFzcyggInVpLWZpeGVkLWlubGluZSIgKTsKCgkJCQlpZiAoICFhbHJlYWR5VmlzaWJsZSAmJiAhaW1tZWRpYXRlbHkgKSB7CgkJCQkJZWwuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCWVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSkuYWRkQ2xhc3MoICJpbiIgKTsKCQkJCX0KCQkJCXNldFRvcChlbCk7CgkJCX0pOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBpbW1lZGlhdGVseSApIHsKCgkJCWN1cnJlbnRzdGF0ZSA9ICJpbmxpbmUiOwoKCQkJdmFyICRhcCA9ICQubW9iaWxlLmFjdGl2ZVBhZ2UgPyAkLm1vYmlsZS5hY3RpdmVQYWdlIDoKCQkJCQkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKTsKCgkJCXJldHVybiAkYXAuY2hpbGRyZW4oIHRvb2xiYXJTZWxlY3RvciApLmVhY2goZnVuY3Rpb24oKSB7CgoJCQkJdmFyIGVsID0gJCh0aGlzKSwKCQkJCQl0aGlzQ1NTdG9wID0gZWwuY3NzKCAidG9wIiApLAoJCQkJCWNsYXNzZXM7CgoJCQkJdGhpc0NTU3RvcCA9IHRoaXNDU1N0b3AgPT0gImF1dG8iID8gMCA6CgkJCQkJCQkJCQkJcGFyc2VGbG9hdCh0aGlzQ1NTdG9wKTsKCgkJCQkvLyBBZGQgc3RhdGUgY2xhc3MKCQkJCWVsLmFkZENsYXNzKCAidWktZml4ZWQtaW5saW5lIiApLnJlbW92ZUNsYXNzKCAidWktZml4ZWQtb3ZlcmxheSIgKTsKCgkJCQlpZiAoIHRoaXNDU1N0b3AgPCAwIHx8ICggZWwuaXMoICIudWktaGVhZGVyLWZpeGVkIiApICYmIHRoaXNDU1N0b3AgIT09IDAgKSApIHsKCgkJCQkJaWYgKCBpbW1lZGlhdGVseSApIHsKCQkJCQkJZWwuY3NzKCAidG9wIiwgMCk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCWlmICggZWwuY3NzKCAidG9wIiApICE9PSAiYXV0byIgJiYgcGFyc2VGbG9hdCggZWwuY3NzKCAidG9wIiApICkgIT09IDAgKSB7CgoJCQkJCQkJY2xhc3NlcyA9ICJvdXQgcmV2ZXJzZSI7CgoJCQkJCQkJZWwuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCQkJZWwucmVtb3ZlQ2xhc3MoIGNsYXNzZXMgKS5jc3MoICJ0b3AiLCAwICk7CgkJCQkJCQl9KS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9LAoKCQlzdGFydFNob3dUaW1lcjogZnVuY3Rpb24oKSB7CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLmNsZWFyU2hvd1RpbWVyKCk7CgoJCQl2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJZGVsYXlUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlkZWxheVRpbWVyID0gdW5kZWZpbmVkOwoJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5zaG93LmFwcGx5KCBudWxsLCBhcmdzICk7CgkJCX0sIHNob3dEZWxheSk7CgkJfSwKCgkJY2xlYXJTaG93VGltZXI6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIGRlbGF5VGltZXIgKSB7CgkJCQljbGVhclRpbWVvdXQoIGRlbGF5VGltZXIgKTsKCQkJfQoJCQlkZWxheVRpbWVyID0gdW5kZWZpbmVkOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oIGZyb20gKSB7CgkJCWlmICggZnJvbSApIHsKCQkJCWN1cnJlbnRzdGF0ZSA9IGZyb207CgkJCX0KCQkJcmV0dXJuICggY3VycmVudHN0YXRlID09PSAib3ZlcmxheSIgKSA/ICQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSgpIDoKCQkJCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnNob3coKTsKCQl9LAoKCQlzZXRUb3VjaFRvZ2dsZUVuYWJsZWQ6IGZ1bmN0aW9uKCBlbmFibGVkICkgewoJCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSBlbmFibGVkOwoJCX0KCX07Cn0pKCk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJaWYgKCAkKCAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiLCBldmVudC50YXJnZXQgKS5sZW5ndGggKSB7CgoJCSQoIGV2ZW50LnRhcmdldCApLmVhY2goZnVuY3Rpb24oKSB7CgoJCQlpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoICR0aGlzLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJCX0KCgkJCS8vIFNob3VsZCBiZSBzbGlkZWRvd24KCQkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJCS8vIFNob3VsZCBiZSBzbGlkZXVwCgkJCSR0aGlzLmZpbmQoIHNsaWRlVXBTZWxlY3RvciApLmFkZENsYXNzKCBzbGlkZVVwQ2xhc3MgKTsKCgkJfSkKCgl9Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJmaXhIZWFkZXJGb290ZXIiIG5hdGl2ZSBwbHVnaW4gLSBCZWhhdmlvciBmb3IgImZpeGVkIiBoZWFkZXJzLGZvb3RlcnMsIGFuZCBzY3JvbGxpbmcgaW5uZXIgY29udGVudAoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBFbmFibGUgdG91Y2ggb3ZlcmZsb3cgc2Nyb2xsaW5nIHdoZW4gaXQncyBuYXRpdmVseSBzdXBwb3J0ZWQKJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgPSBmYWxzZTsKCi8vIEVuYWJsZWQgem9vbSB3aGVuIHRvdWNoIG92ZXJmbG93IGlzIGVuYWJsZWQuIENhbiBjYXVzZSB1c2FiaWxpdHkgaXNzdWVzLCB1bmZvcnR1bmF0ZWx5CiQubW9iaWxlLnRvdWNoT3ZlcmZsb3dab29tRW5hYmxlZCA9IGZhbHNlOwoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApewoJCQoJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCXNjcm9sbFN0YXJ0WSA9IDA7CgkJCQoJCWlmKCAkdGFyZ2V0LmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApICl7CgkJCQoJCQkkdGFyZ2V0LmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHBhZ2UgPSAkKCB0aGlzICksCgkJCQkJJGZpeGllcyA9ICRwYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkuZmlsdGVyKCAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiICksCgkJCQkJZnVsbFNjcmVlbiA9ICRwYWdlLmpxbURhdGEoICJmdWxsc2NyZWVuIiApLAoJCQkJCSRzY3JvbGxFbGVtID0gJGZpeGllcy5sZW5ndGggPyAkcGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICkgOiAkcGFnZTsKCQkJCQoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdG91Y2gtb3ZlcmZsb3ciICk7CgkJCQkKCQkJCSRzY3JvbGxFbGVtLmJpbmQoICJzY3JvbGxzdG9wIiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggJHNjcm9sbEVsZW0uc2Nyb2xsVG9wKCkgPiAwICl7CgkJCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJCQl9CgkJCQl9KTsJCgkJCQkKCQkJCWlmKCAkZml4aWVzLmxlbmd0aCApewoJCQkJCQoJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktbmF0aXZlLWZpeGVkIiApOwoJCQkJCQoJCQkJCWlmKCBmdWxsU2NyZWVuICl7CgoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLW5hdGl2ZS1mdWxsc2NyZWVuIiApOwoKCQkJCQkJJGZpeGllcy5hZGRDbGFzcyggImZhZGUgaW4iICk7CgoJCQkJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpewoJCQkJCQkJJGZpeGllcwoJCQkJCQkJCS5yZW1vdmVDbGFzcyggInVpLW5hdGl2ZS1iYXJzLWhpZGRlbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggImluIG91dCIgKQoJCQkJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpewoJCQkJCQkJCQkkKHRoaXMpLm5vdCggIi5pbiIgKS5hZGRDbGFzcyggInVpLW5hdGl2ZS1iYXJzLWhpZGRlbiIgKTsKCQkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJpbml0IiAtIEluaXRpYWxpemUgdGhlIGZyYW1ld29yawoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJCggd2luZG93ICk7CgogCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gYWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gbG9hZGluZyBkaXYgd2hpY2ggYXBwZWFycyBkdXJpbmcgQWpheCByZXF1ZXN0cwoJLy8gd2lsbCBub3QgYXBwZWFyIGlmICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIGlzIGZhbHNlCgl2YXIgJGxvYWRlciA9ICQoICI8ZGl2IGNsYXNzPSd1aS1sb2FkZXIgdWktYm9keS1hIHVpLWNvcm5lci1hbGwnPjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyBzcGluJz48L3NwYW4+PGgxPjwvaDE+PC9kaXY+IiApOwoKCSQuZXh0ZW5kKCQubW9iaWxlLCB7CgkJLy8gdHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQkJJGxvYWRlcgoJCQkJCS5maW5kKCAiaDEiICkKCQkJCQkJLnRleHQoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkKCQkJCQkJLmVuZCgpCgkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkKCQkJCQkvLyBwb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJCQkJLmNzcyh7CgkJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJCX0pOwoJCQl9CgoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgkJfSwKCgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoJCX0sCgoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRkaWFsb2dzLCAkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjaGVjayBmb3IgZGlhbG9ncyBvciBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRkaWFsb2dzID0gJCggIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApOwoKCQkJCS8vIGlmIHRoZXJlIGFyZSBubyBwYWdlcyBidXQgYSBkaWFsb2cgaXMgcHJlc2VudCwgbG9hZCBpdCBhcyBhIHBhZ2UKCQkJCWlmKCAkZGlhbG9ncy5sZW5ndGggKSB7CgkJCQkJLy8gYWx0ZXIgdGhlIGF0dHJpYnV0ZSBzbyBpdCB3aWxsIGJlIHRyZWF0ZWQgYXMgYSBwYWdlIHVucG9uIGVuaGFuY2VtZW50CgkJCQkJLy8gVE9ETyBhbGxvdyBmb3IgdGhlIGxvYWRpbmcgb2YgYSBkaWFsb2cgYXMgdGhlIGZpcnN0IHBhZ2UgKG1hbnkgY29uc2lkZXJhdGlvbnMpCgkJCQkJJGRpYWxvZ3MuZmlyc3QoKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJwYWdlIiApOwoKCQkJCQkvLyByZW1vdmUgdGhlIGZpcnN0IGRpYWxvZyBmcm9tIHRoZSBzZXQgb2YgZGlhbG9ncyBzaW5jZSBpdCdzIG5vdyBhIHBhZ2UKCQkJCQkvLyBhZGQgaXQgdG8gdGhlIGVtcHR5IHNldCBvZiBwYWdlcyB0byBiZSBsb2FkZWQgYnkgdGhlIGluaXRpYWwgY2hhbmdlcGFnZQoJCQkJCSRwYWdlcyA9ICRwYWdlcy5hZGQoICRkaWFsb2dzLmdldCgpLnNoaWZ0KCkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJCX0KCQkJfQoKCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmFkZCggIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSgidXJsIikgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJHBhZ2VzLmZpcnN0KCkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkIG9yIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJaWYgKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgISQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsgdHJhbnNpdGlvbjogIm5vbmUiLCByZXZlcnNlOiB0cnVlLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJCS8vIG90aGVyd2lzZSwgdHJpZ2dlciBhIGhhc2hjaGFuZ2UgdG8gbG9hZCBhIGRlZXBsaW5rCgkJCWVsc2UgewoJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFsgdHJ1ZSBdICk7CgkJCX0KCQl9Cgl9KTsKCQoJLy8gVGhpcyBmdW5jdGlvbiBpbmplY3RzIGEgbWV0YSB2aWV3cG9ydCB0YWcgdG8gcHJldmVudCBzY2FsaW5nLiBPZmYgYnkgZGVmYXVsdCwgb24gYnkgZGVmYXVsdCB3aGVuIHRvdWNoT3ZlcmZsb3cgc2Nyb2xsaW5nIGlzIGVuYWJsZWQKCWZ1bmN0aW9uIGRpc2FibGVab29tKCkgewoJCXZhciBjb250ID0gInVzZXItc2NhbGFibGU9bm8iLAoJCQltZXRhID0gJCggIm1ldGFbbmFtZT0ndmlld3BvcnQnXSIgKTsKCQkJCgkJaWYoIG1ldGEubGVuZ3RoICl7CgkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBtZXRhLmF0dHIoICJjb250ZW50IiApICsgIiwgIiArIGNvbnQgKTsKCQl9CgkJZWxzZXsKCQkJJCggImhlYWQiICkucHJlcGVuZCggIjxtZXRhPiIsIHsgIm5hbWUiOiAidmlld3BvcnQiLCAiY29udGVudCI6IGNvbnQgfSApOwoJCX0KCX0KCQoJLy8gaWYgdG91Y2gtb3ZlcmZsb3cgaXMgZW5hYmxlZCwgZGlzYWJsZSB1c2VyIHNjYWxpbmcsIGFzIGl0IGNyZWF0ZXMgdXNhYmlsaXR5IGlzc3VlcwoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICYmICEkLm1vYmlsZS50b3VjaE92ZXJmbG93Wm9vbUVuYWJsZWQgKXsKCQlkaXNhYmxlWm9vbSgpOwoJfQoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQod2luZG93KS5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Length": "221125",
                    "Date": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}