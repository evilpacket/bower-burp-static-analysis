{
    "url": "http://localhost:9999/bridgeit/bridgeit.js/src/bridgeit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "HTML5 storage manipulation (DOM-based)",
    "issueType": 5246720,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based HTML5 storage manipulation occurs when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and stores this data in the HTML5 storage of the web browser (either localStorage or sessionStorage). An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause the user's browser to store attacker-controllable data.<br><br>This behavior does not in itself constitute a security vulnerability. However, if the application later reads the data back from storage and processes it in an unsafe way, then an attacker may be able to leverage the storage mechanism to deliver other DOM-based attacks, such as cross-site scripting and JavaScript injection.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>You should also review the ways in which the wider application uses data that is retrieved from HTML5 storage. If the data is never handled in an unsafe manner, then this behavior may not constitute any kind of vulnerability.<br><br>The most effective way to avoid DOM-based HTML5 storage manipulation is not to place in HTML5 storage any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored.",
    "issueDetail": "The application may be vulnerable to DOM-based HTML5 storage manipulation. Data is read from <b>document.location</b> and written to <b>localStorage.setItem()</b> via the following statements:<ul><li>lastPage = \"\" + document.location;</li><li>lastPage = lastPage.substring(0,       lastPage.length - locHash.length)</li><li>localStorage.setItem(LAST_PAGE_KEY, lastPage);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/bridgeit/bridgeit.js/src/bridgeit.js",
                "path": "/bridgeit/bridgeit.js/src/bridgeit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9icmlkZ2VpdC9icmlkZ2VpdC5qcy9zcmMvYnJpZGdlaXQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTIzMDENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTQ6MDc6MzQgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE0OjA3OjI5IEdNVA0KDQovKiBCcmlkZ2VJdCBNb2JpbGUgMS4wLjUKICoKICogQ29weXJpZ2h0IDIwMDQtMjAxMyBJQ0Vzb2Z0IFRlY2hub2xvZ2llcyBDYW5hZGEgQ29ycC4KICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUKICogTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsCiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuCiAqICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIKICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZQogKiBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KaWYgKCF3aW5kb3dbJ2ljZSddKSB7Cgl3aW5kb3cuaWNlID0ge307Cn0KaWYgKCF3aW5kb3dbJ2JyaWRnZWl0J10pIHsKCXdpbmRvdy5icmlkZ2VpdCA9IHt9OwoJd2luZG93LmJyaWRnZUl0ID0gd2luZG93LmJyaWRnZWl0OyAvL2FsaWFzIGJyaWRnZWl0IGFuZCBicmlkZ2VJdAp9CmlmICghd2luZG93LmNvbnNvbGUpIHsKCWNvbnNvbGUgPSB7fTsKCWlmIChpY2UubG9nSW5Db250YWluZXIpIHsKCQljb25zb2xlLmxvZyA9IGljZS5sb2dJbkNvbnRhaW5lcjsKCX0gZWxzZSB7CgkJY29uc29sZS5sb2cgPSBmdW5jdGlvbigpIHsKCQl9OwoJCWNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpIHsKCQl9OwoJfQp9Ci8qKgogKiBUaGUgQnJpZGdlSXQgSmF2YVNjcmlwdCBBUEkuIE5hdGl2ZSBNb2JpbGUgaW50ZWdyYXRpb24gZm9yIHlvdXIgd2ViIGFwcC4KICoKICogQnJpZGdlSXQgcHJvdmlkZXMgYSB2YXJpZXR5IG9mIGRldmljZSBjb21tYW5kcyB0aGF0IGFsbG93IGFjY2VzcyB0bwogKiBkZXZpY2UgZmVhdHVyZXMgZnJvbSBKYXZhU2NyaXB0LCBhbGwgd2hpbGUgcnVubmluZyBpbiB0aGUgc3RvY2sgYnJvd3NlcgogKiBzdWNoIGFzIFNhZmFyaSBvciBDaHJvbWUuIFRoaXMgaXMgbWFkZSBwb3NzaWJsZSBieSB0aGUgQnJpZGdlSXQgdXRpbHR5IGFwcAogKiB0aGF0IHJ1bnMgYWxvbmdzaWRlIHRoZSBicm93c2VyIGFuZCBpcyBhdmFpbGFibGUgZm9yIGVhY2ggb2YgdGhlIHN1cHBvcnRlZAogKiBwbGF0Zm9ybXMgKGN1cnJlbnRseSBBbmRyb2lkLCBpT1MsIGFuZCBXaW5kb3dzIFBob25lIDgpLgogKgogKiBGb3IgZXhhbXBsZSwgYnJpZGdlaXQuY2FtZXJhKCdteUNhbWVyYScsICdteUNhbGxiYWNrJykgd2lsbCBhbGxvdyB0aGUgdXNlcgogKiB0byB0YWtlIGEgcGhvdG8gaWRlbnRpZmllZCBieSAnbXlDYW1lcmEnIGFuZCB0aGlzIHdpbGwgYmUgcmV0dXJuZWQgdmlhIGFuCiAqIGV2ZW50IHRvIHRoZSBmdW5jdGlvbiBuYW1lZCBteUNhbGxiYWNrLiAgRm9yIHRoZSBiZXN0IGNvbXBhdGliaWxpdHkgdGhlCiAqIGNhbGxiYWNrIGlzIHBhc3NlZCBieSBuYW1lIHNpbmNlIHRoZSBicm93c2VyIHBhZ2UgbWF5IGJlIHJlZnJlc2hlZCB3aGVuCiAqIHRoZSBjYWxsYmFjayByZXR1cm5zLiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBwYXNzZWQgYW4gZXZlbnQgd2hlcmU6CiAqCiAqIGV2ZW50LnJlc3BvbnNlOiBIVFRQIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpZiB0aGUgY29tbWFuZCBtYWtlcyBhbiBIVFRQIFBPU1QKICogZXZlbnQucHJldmlldzogZGF0YS11cmkgY29udGFpbmluZyBhbnkgcHJldmlldyBpbWFnZSByZXN1bHRpbmcgZnJvbSB0aGUgY29tbWFuZAogKiBldmVudC5uYW1lOiBpZCBzcGVjaWZpZWQgaW4gdGhlIGNvbW1hbmQgY2FsbAogKiBldmVudC52YWx1ZTogcmV0dXJuIHZhbHVlIGZyb20gdGhlIGNvbW1hbmQKICoKICogTW9zdCBkZXZpY2UgY29tbWFuZHMgYWNjZXB0IGFuIG9wdGlvbnMgcGFyYW1ldGVyIG9iamVjdC4gIE9wdGlvbnMgc3VwcG9ydGVkCiAqIGJ5IGEgdmFyaWV0eSBvZiBjb21tYW5kcyBhcmU6IG9wdGlvbnMucG9zdFVSTCAodGhlIFVSTCB1c2VkIHRvIHVwbG9hZAogKiB0aGUgcmVzdWx0IG9mIHRoZSBjb21tYW5kKSwgYW5kIGV4dHJhIHBhcmFtZXRlcnMKICogc3BlY2lmaWMgdG8gdGhlIGNvbW1hbmQgbWF5IGJlIGFkZGVkIHRvIHRoZSBvcHRpb25zIGFyZ3VtZW50LgogKgogKiBAY2xhc3MgYnJpZGdlaXQKICovCihmdW5jdGlvbihiKSB7CgoJLyogKioqKioqKioqKioqKioqKioqKioqKiogUFJJVkFURSAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCglmdW5jdGlvbiBzZXJpYWxpemVGb3JtKGZvcm1JZCwgdHlwZWQpIHsKCQl2YXIgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZvcm1JZCk7CgkJdmFyIGVscyA9IGZvcm0uZWxlbWVudHM7CgkJdmFyIGxlbiA9IGVscy5sZW5ndGg7CgkJdmFyIHFTdHJpbmcgPSBbXTsKCQl2YXIgYWRkRmllbGQgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewoJCQl2YXIgdG1wU3RyID0gIiI7CgkJCWlmIChxU3RyaW5nLmxlbmd0aCA+IDApIHsKCQkJCXRtcFN0ciA9ICImIjsKCQkJfQoJCQl0bXBTdHIgKz0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQkJcVN0cmluZy5wdXNoKHRtcFN0cik7CgkJfTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCXZhciBlbCA9IGVsc1tpXTsKCQkJaWYgKCFlbC5kaXNhYmxlZCkgewoJCQkJdmFyIHByZWZpeCA9ICIiOwoJCQkJaWYgKHR5cGVkKSB7CgkJCQkJdmFyIHZ0eXBlID0gZWwuZ2V0QXR0cmlidXRlKCJkYXRhLXR5cGUiKTsKCQkJCQlpZiAodnR5cGUpIHsKCQkJCQkJcHJlZml4ID0gdnR5cGUgKyAiLSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcHJlZml4ID0gZWwudHlwZSArICItIjsKCQkJCQl9CgkJCQl9CgkJCQlzd2l0Y2ggKGVsLnR5cGUpIHsKCQkJCQljYXNlICdzdWJtaXQnOgoJCQkJCWNhc2UgJ2J1dHRvbic6CgkJCQkJY2FzZSAnZmllbGRzZXQnOgoJCQkJCQlicmVhazsKCQkJCQljYXNlICd0ZXh0JzoKCQkJCQljYXNlICdwYXNzd29yZCc6CgkJCQkJY2FzZSAnaGlkZGVuJzoKCQkJCQljYXNlICd0ZXh0YXJlYSc6CgkJCQkJCWFkZEZpZWxkKHByZWZpeCArIGVsLm5hbWUsIGVsLnZhbHVlKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnc2VsZWN0LW9uZSc6CgkJCQkJCWlmIChlbC5zZWxlY3RlZEluZGV4ID49IDApIHsKCQkJCQkJCWFkZEZpZWxkKHByZWZpeCArIGVsLm5hbWUsIGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0udmFsdWUpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3NlbGVjdC1tdWx0aXBsZSc6CgkJCQkJCWZvciAodmFyIGogPSAwOyBqIDwgZWwub3B0aW9ucy5sZW5ndGg7IGorKykgewoJCQkJCQkJaWYgKGVsLm9wdGlvbnNbal0uc2VsZWN0ZWQpIHsKCQkJCQkJCQlhZGRGaWVsZChwcmVmaXggKyBlbC5uYW1lLCBlbC5vcHRpb25zW2pdLnZhbHVlKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICdjaGVja2JveCc6CgkJCQkJY2FzZSAncmFkaW8nOgoJCQkJCQlpZiAoZWwuY2hlY2tlZCkgewoJCQkJCQkJYWRkRmllbGQocHJlZml4ICsgZWwubmFtZSwgZWwudmFsdWUpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWFkZEZpZWxkKHByZWZpeCArIGVsLm5hbWUsIGVsLnZhbHVlKTsKCQkJCX0KCQkJfQoJCX0KCQkvLyBjb25jYXRlbmF0ZSB0aGUgYXJyYXkKCQlyZXR1cm4gcVN0cmluZy5qb2luKCIiKTsKCX0KCglpZiAod2luZG93LmpRdWVyeSAmJiBqUXVlcnkubW9iaWxlKSAgewoJCS8vanF1ZXJ5IG1vYmlsZSBpbnNpc3RzIG9uIHBhcnNpbmcgQnJpZGdlSXQgaGFzaGNoYW5nZSBkYXRhCgkJYnJpZGdlaXQudXNlQmFzZTY0ID0gdHJ1ZTs7Cgl9CglmdW5jdGlvbiBnZXREZXZpY2VDb21tYW5kKCkgIHsKCQl2YXIgY29tbWFuZERhdGEgPSBudWxsOwoJCXZhciBsb2NIYXNoID0gIiIgKyB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQl2YXIgaGFzaE1hcmsgPSBpc0RldmljZUNvbW1hbmRIYXNoKGxvY0hhc2gpOwoJCWlmIChoYXNoTWFyaykgIHsKCQkJY29tbWFuZERhdGEgPSBsb2NIYXNoLnN1YnN0cmluZyhoYXNoTWFyay5sZW5ndGggKyAxKTsKCQkJdmFyIGR1cEluZGV4ID0gY29tbWFuZERhdGEuaW5kZXhPZihoYXNoTWFyayk7CgkJCWlmIChkdXBJbmRleCA+IDApICB7CgkJCQljb21tYW5kRGF0YSA9IGNvbW1hbmREYXRhLnN1YnN0cmluZygwLCBkdXBJbmRleCk7CgkJCQljb25zb2xlLmVycm9yKCJ0cmltbWVkIGNvcnJ1cHQgIiArIGxvY0hhc2ggKyAiIHRvICIKCQkJCQkJKyBjb21tYW5kRGF0YSk7CgkJCX0KCQl9CgkJcmV0dXJuIGNvbW1hbmREYXRhOwoJfQoKCWZ1bmN0aW9uIGlzRGV2aWNlQ29tbWFuZEhhc2goZnVsbEhhc2gpICB7CgkJdmFyIHN4a2V5ID0gIiNpY2Vtb2JpbGVzeCI7CgkJaWYgKHN4a2V5ID09PSBmdWxsSGFzaC5zdWJzdHJpbmcoMCwgc3hrZXkubGVuZ3RoKSkgIHsKCQkJcmV0dXJuIHN4a2V5OwoJCX0KCQl2YXIgYnJrZXkgPSAiI2JyaWRnZWl0IjsKCQlpZiAoYnJrZXkgPT09IGZ1bGxIYXNoLnN1YnN0cmluZygwLCBicmtleS5sZW5ndGgpKSAgewoJCQlyZXR1cm4gYnJrZXk7CgkJfQoJCXJldHVybiBudWxsOwoJfQoKCXZhciByZXNlcnZlZFBhcmFtcyA9IFsncG9zdFVSTCcsICdlbGVtZW50JywgJ2Zvcm0nLCAnZGV2aWNlQ29tbWFuZENhbGxiYWNrJywgJ2Nvb2tpZXMnXTsKCglmdW5jdGlvbiBkZXZpY2VDb21tYW5kRXhlYyhjb21tYW5kLCBpZCwgb3B0aW9ucykgIHsKCQl2YXIgcGF5bG9hZCA9IG9wdGlvbnM7CgkJaWYgKCFwYXlsb2FkKSAgewoJCQlwYXlsb2FkID0geyB9OwoJCX0KCQl2YXIgd2luZG93TG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CgoJCXBheWxvYWQuX3ZlcnNpb24gPSBicmlkZ2VpdC52ZXJzaW9uOwoKCQlpZiAocGF5bG9hZC5wb3N0VVJMKSAgewoJCQl2YXIgcG9zdFVSTCA9IGdldEFic29sdXRlVVJMKHBheWxvYWQucG9zdFVSTCk7CgkJCXBheWxvYWQuX3Bvc3RVUkwgPSBwb3N0VVJMOwoJCQlkZWxldGUgcGF5bG9hZC5wb3N0VVJMOwoJCX0KCQlpZiAocGF5bG9hZC51YikgIHsKCQkJcGF5bG9hZC5fdXJsQmFzZSA9IHBheWxvYWQudWI7CgkJCWRlbGV0ZSBwYXlsb2FkLnViOwoJCX0gZWxzZSB7CgkJCXZhciBiYXJVUkwgPSB3aW5kb3dMb2NhdGlvbi50b1N0cmluZygpOwoJCQl2YXIgYmFzZVVSTCA9CgkJCQkJYmFyVVJMLnN1YnN0cmluZygwLCBiYXJVUkwubGFzdEluZGV4T2YoIi8iKSkgKyAiLyI7CgkJCXBheWxvYWQuX3VybEJhc2UgPSBiYXNlVVJMOwoJCX0KCgkJcGF5bG9hZC5fY29tbWFuZCA9IGNvbW1hbmQ7CgkJcGF5bG9hZC5faWQgPSBpZDsKCQlwYXlsb2FkLl9zZXEgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoKCQlpZiAocGF5bG9hZC5fY2FsbGJhY2spICB7CgkJCWlmICgic3RyaW5nIiAhPSB0eXBlb2YocGF5bG9hZC5fY2FsbGJhY2spKSAgewoJCQkJaWYgKGJyaWRnZWl0LmFsbG93QW5vbnltb3VzQ2FsbGJhY2tzKSAgewoJCQkJCXBheWxvYWQuX2NhbGxiYWNrID0gIiFhbm9uIjsKCQkJCX0gZWxzZSAgewoJCQkJCWNvbnNvbGUuZXJyb3IoCgkJCQkJCSJCcmlkZ2VJdCBjYWxsYmFja3MgbXVzdCBiZSBuYW1lZCBpbiB3aW5kb3cgc2NvcGUiKTsKCQkJCQlkZWxldGUgcGF5bG9hZC5fY2FsbGJhY2s7CgkJCQl9CgkJCX0KCQl9CgoJCXZhciByZXR1cm5VUkwgPSAiIiArIHdpbmRvd0xvY2F0aW9uOwoJCXZhciBsYXN0SGFzaCA9IHJldHVyblVSTC5sYXN0SW5kZXhPZigiIyIpOwoJCXZhciB0aGVIYXNoID0gIiI7CgkJdmFyIHRoZVVSTCA9IHJldHVyblVSTDsKCQlpZiAobGFzdEhhc2ggPiAwKSAgewoJCQl0aGVIYXNoID0gcmV0dXJuVVJMLnN1YnN0cmluZyhsYXN0SGFzaCk7CgkJCXRoZVVSTCA9IHJldHVyblVSTC5zdWJzdHJpbmcoMCwgbGFzdEhhc2gpOwoJCX0KCQlyZXR1cm5VUkwgPSB0aGVVUkwgKyAiI2JyaWRnZWl0IjsKCgkJcGF5bG9hZC5fcmV0dXJuVVJMID0gcmV0dXJuVVJMOwoJCXBheWxvYWQuX3Jlc3RvcmVIYXNoID0gdGhlSGFzaDsKCgkJcGF5bG9hZC5fc3BsYXNoSW1hZ2VVUkwgPSBicmlkZ2VpdC5zcGxhc2hJbWFnZVVSTDsKCQlwYXlsb2FkLl9zcGxhc2hJbWFnZSA9IGJyaWRnZWl0LnNwbGFzaEltYWdlOwoKCQl2YXIgZW5jb2RlZENvbW1hbmQgPSBidG9hKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKQoJCQkucmVwbGFjZSgvPS9nLCJ+IikKCQkJLnJlcGxhY2UoL1wvL2csIi4iKTsKCgkJdmFyIGNvbW1hbmRCYXNlID0gImJyaWRnZWl0OiI7CgkJaWYgKGIuaXNBbmRyb2lkKCkpICB7CgkJCWNvbW1hbmRCYXNlID0gImh0dHA6Ly9icmlkZ2VpdC5tb2JpL2FuZHJvaWQvaW5zdGFsbC9pbmRleC5odG1sIyIKCQl9CgoJCXZhciBjb21tYW5kVVJMID0gY29tbWFuZEJhc2UgKyBlbmNvZGVkQ29tbWFuZDsKCQljb25zb2xlLmxvZygiY29tbWFuZFVSTCAiICsgY29tbWFuZFVSTCk7CgoJCXdpbmRvdy5sb2NhdGlvbiA9IGNvbW1hbmRVUkw7CgoJfQoKCWZ1bmN0aW9uIGRldmljZUNvbW1hbmRVUkxFeGVjKGNvbW1hbmQsIGlkLCBvcHRpb25zKSAgewoJCWNvbnNvbGUubG9nKCJkZXZpY2VDb21tYW5kRXhlYygnIiArIGNvbW1hbmQgKyAiJywgJyIgKyBpZCArICIsICIgKyBKU09OLnN0cmluZ2lmeShvcHRpb25zKSk7CgkJdmFyIGFtcGNoYXIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDM4KTsKCQl2YXIgdXBsb2FkVVJMOwoJCXZhciBzZXNzaW9uaWQ7CgkJdmFyIHBhcmFtczsKCQl2YXIgZWxlbWVudDsKCQl2YXIgZm9ybUlEOwoJCXZhciBjYWxsYmFjazsKCgkJaWYgKG9wdGlvbnMpICB7CgkJCWlmIChvcHRpb25zLnBvc3RVUkwpICB7CgkJCXZhciBwb3N0VVJMID0gZ2V0QWJzb2x1dGVVUkwob3B0aW9ucy5wb3N0VVJMKTsKCQkJCXVwbG9hZFVSTCA9IHBvc3RVUkw7CgkJCX0KCQkJcGFyYW1zID0gcGFja09iamVjdChvcHRpb25zLCByZXNlcnZlZFBhcmFtcyk7CgkJCWlmIChvcHRpb25zLmRldmljZUNvbW1hbmRDYWxsYmFjaykgIHsKCQkJCWNhbGxiYWNrID0gb3B0aW9ucy5kZXZpY2VDb21tYW5kQ2FsbGJhY2s7CgkJCQlpZiAoInN0cmluZyIgIT0gdHlwZW9mKGNhbGxiYWNrKSkgIHsKCQkJCQlpZiAoYnJpZGdlaXQuYWxsb3dBbm9ueW1vdXNDYWxsYmFja3MpICB7CgkJCQkJCWNhbGxiYWNrID0gIiFhbm9uIjsKCQkJCQl9IGVsc2UgIHsKCQkJCQkJY29uc29sZS5lcnJvcigKCQkJCQkJCSJCcmlkZ2VJdCBjYWxsYmFja3MgbXVzdCBiZSBuYW1lZCBpbiB3aW5kb3cgc2NvcGUiKTsKCQkJCQkJY2FsbGJhY2sgPSBudWxsOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpZiAob3B0aW9ucy5lbGVtZW50KSAgewoJCQkJZWxlbWVudCA9IG9wdGlvbnMuZWxlbWVudDsKCQkJfQoJCQlpZiAob3B0aW9ucy5mb3JtKSAgewoJCQkJZm9ybUlEID0gb3B0aW9ucy5mb3JtLmdldEF0dHJpYnV0ZSgiaWQiKTsKCQkJfQoJCQlpZiAob3B0aW9ucy5jb29raWVzKSAgewoJCQkJc2Vzc2lvbmlkID0gb3B0aW9ucy5jb29raWVzWydKU0VTU0lPTklEJ107CgkJCX0KCQl9CgoJCWlmICghdXBsb2FkVVJMKSAgewoJCQl1cGxvYWRVUkwgPSBnZXRVcGxvYWRVUkwoZWxlbWVudCk7CgkJfQoKCQl2YXIgd2luZG93TG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CgkJdmFyIGJhclVSTCA9IHdpbmRvd0xvY2F0aW9uLnRvU3RyaW5nKCk7CgkJdmFyIGJhc2VVUkwgPSBiYXJVUkwuc3Vic3RyaW5nKDAsCgkJCQliYXJVUkwubGFzdEluZGV4T2YoIi8iKSkgKyAiLyI7CgoJCXZhciByZXR1cm5VUkwgPSAiIiArIHdpbmRvdy5sb2NhdGlvbjsKCQl2YXIgbGFzdEhhc2ggPSByZXR1cm5VUkwubGFzdEluZGV4T2YoIiMiKTsKCQl2YXIgdGhlSGFzaCA9ICIiOwoJCXZhciB0aGVVUkwgPSByZXR1cm5VUkw7CgkJaWYgKGxhc3RIYXNoID4gMCkgIHsKCQkJdGhlSGFzaCA9IHJldHVyblVSTC5zdWJzdHJpbmcobGFzdEhhc2gpOwoJCQl0aGVVUkwgPSByZXR1cm5VUkwuc3Vic3RyaW5nKDAsIGxhc3RIYXNoKTsKCQl9CgkJcmV0dXJuVVJMID0gdGhlVVJMICsgIiNpY2Vtb2JpbGVzeCI7CgoJCXZhciBoYXNoU3ViQ2xhdXNlID0gIiI7CgkJaWYgKCEhdGhlSGFzaCkgIHsKCQkJaGFzaFN1YkNsYXVzZSA9ICImaD0iICsgZXNjYXBlKHRoZUhhc2gpOwoJCX0KCgkJdmFyIGNhbGxiYWNrQ2xhdXNlID0gIiI7CgkJaWYgKCEhY2FsbGJhY2spICB7CgkJCWNhbGxiYWNrQ2xhdXNlID0gIiZjPSIgKyBlc2NhcGUoY2FsbGJhY2spOwoJCX0KCgkJc2VxQ2xhdXNlID0gIiZzZXE9IiArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgoJCXZhciBoYXNoQ2xhdXNlID0gIiI7CgkJaWYgKCEhaGFzaFN1YkNsYXVzZSB8fCAhIWNhbGxiYWNrQ2xhdXNlKSAgewoJCQloYXNoQ2xhdXNlID0gIiZoPSIgKyBlc2NhcGUoaGFzaFN1YkNsYXVzZSkgKyBlc2NhcGUoY2FsbGJhY2tDbGF1c2UpCgkJCQkJKyBlc2NhcGUoc2VxQ2xhdXNlKTsKCQl9CgoJCWRldmljZU9wdGlvbnMgPSBudWxsOwoJCWlmIChicmlkZ2VpdC51c2VCYXNlNjQpICB7CgkJCS8vanF1ZXJ5IG1vYmlsZSBpbnNpc3RzIG9uIHBhcnNpbmcgQnJpZGdlSXQgaGFzaGNoYW5nZSBkYXRhCgkJCWRldmljZU9wdGlvbnMgPSAiZW5jPWJhc2U2NCI7CgkJfQoJCXZhciBvcHRpb25zQ2xhdXNlID0gIiI7CgkJaWYgKCEhZGV2aWNlT3B0aW9ucykgIHsKCQkJb3B0aW9uc0NsYXVzZSA9ICImbz0iICsgZXNjYXBlKGRldmljZU9wdGlvbnMpOwoJCX0KCgkJaWYgKHBhcmFtcyAmJiAoIiIgIT0gcGFyYW1zKSkgewoJCQlwYXJhbXMgPSAiJnViPSIgKyBlc2NhcGUoYmFzZVVSTCkgKyBhbXBjaGFyICsgcGFyYW1zOwoJCX0KCQljb25zb2xlLmxvZygncGFyYW1zID0gJyArIHBhcmFtcyk7CgoJCXZhciBzZXNzaW9uaWRDbGF1c2UgPSAiIjsKCQlpZiAoc2Vzc2lvbmlkICYmICgiIiAhPSBzZXNzaW9uaWQpKSB7CgkJCXNlc3Npb25pZENsYXVzZSA9ICImSlNFU1NJT05JRD0iICsgZXNjYXBlKHNlc3Npb25pZCk7CgkJCS8vYWxzbyBuZWVkIFBIUFNFU1NJRCBhbmQgQVNQU0VTU0lPTklECgkJfQoJCXZhciBzZXJpYWxpemVkRm9ybUNsYXVzZSA9ICIiOwoJCWlmIChmb3JtSUQgJiYgKCIiICE9IGZvcm1JRCkpICB7CgkJCXNlcmlhbGl6ZWRGb3JtQ2xhdXNlID0gIiZwPSIgKwoJCQkJCWVzY2FwZShzZXJpYWxpemVGb3JtKGZvcm1JRCwgZmFsc2UpKTsKCQl9CgkJdmFyIHVwbG9hZFVSTENsYXVzZSA9ICIiOwoJCWlmICh1cGxvYWRVUkwgJiYgKCIiICE9IHVwbG9hZFVSTCkpICB7CgkJCXVwbG9hZFVSTENsYXVzZSA9ICImdT0iICsgZXNjYXBlKHVwbG9hZFVSTCk7CgkJfQoJCXZhciBzeFVSTCA9ICJjPSIgKyBlc2NhcGUoY29tbWFuZCArCgkJCQkiP2lkPSIgKyBpZCArIGFtcGNoYXIgKyAocGFyYW1zID8gcGFyYW1zIDogJycpKSArCgkJCQl1cGxvYWRVUkxDbGF1c2UgKwoJCQkJIiZyPSIgKyBlc2NhcGUocmV0dXJuVVJMKSArCgkJCQlzZXNzaW9uaWRDbGF1c2UgKwoJCQkJb3B0aW9uc0NsYXVzZSArCgkJCQloYXNoQ2xhdXNlICsKCQkJCXNlcmlhbGl6ZWRGb3JtQ2xhdXNlOwoJCWlmIChiLmlzV2luZG93c1Bob25lOCgpKSAgewoJCQlzeFVSTCA9IGVzY2FwZShzeFVSTCk7CgkJfQoJCXZhciBzeEJhc2UgPSAiaWNlbW9iaWxlOiI7CgkJaWYgKGIuaXNBbmRyb2lkKCkpICB7CgkJCXN4QmFzZSA9ICJodHRwOi8vYnJpZGdlaXQubW9iaS9hbmRyb2lkL2luc3RhbGwvaW5kZXguaHRtbCMiCgkJfQoJCXN4VVJMID0gc3hCYXNlICsgc3hVUkw7CgkJY29uc29sZS5sb2coJ3N4VVJMPScgKyBzeFVSTCk7CgoJCXdpbmRvdy5sb2NhdGlvbiA9IHN4VVJMOwoJfQoJZnVuY3Rpb24gZ2V0U3BsYXNoQ2xhdXNlKCkgIHsKCQl2YXIgc3BsYXNoQ2xhdXNlID0gIiI7CgkJaWYgKG51bGwgIT0gYnJpZGdlaXQuc3BsYXNoSW1hZ2VVUkwpICB7CgkJCXZhciBzcGxhc2hJbWFnZSA9ICJpPSIgKyBlc2NhcGUoYnJpZGdlaXQuc3BsYXNoSW1hZ2VVUkwpOwoJCQlzcGxhc2hDbGF1c2UgPSAiJnM9IiArIGVzY2FwZShzcGxhc2hJbWFnZSk7CgkJfQoJCXJldHVybiBzcGxhc2hDbGF1c2U7Cgl9Cgl2YXIgYXV0b0RldGVjdFVwbG9hZFVSTCA9IGZhbHNlOwoJZnVuY3Rpb24gZ2V0VXBsb2FkVVJMKGVsZW1lbnQpICB7CgkJaWYgKCFhdXRvRGV0ZWN0VXBsb2FkVVJMKSAgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJdmFyIHVwbG9hZFVSTDsKCgkJdmFyIHdpbmRvd0xvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJCXZhciBiYXJVUkwgPSB3aW5kb3dMb2NhdGlvbi50b1N0cmluZygpOwoJCXZhciBiYXNlVVJMID0gYmFyVVJMLnN1YnN0cmluZygwLAoJCQkJYmFyVVJMLmxhc3RJbmRleE9mKCIvIikpICsgIi8iOwoKCQlpZiAoIWVsZW1lbnQpICB7CgkJCXVwbG9hZFVSTCA9IGJhc2VVUkw7CgkJfSBlbHNlIHsKCQkJdmFyIGZvcm0gPSBmb3JtT2YoZWxlbWVudCk7CgkJCWZvcm1JRCA9IGZvcm0uZ2V0QXR0cmlidXRlKCdpZCcpOwoJCQl2YXIgZm9ybUFjdGlvbiA9IGZvcm0uZ2V0QXR0cmlidXRlKCJhY3Rpb24iKTsKCgkJCWlmICghdXBsb2FkVVJMKSB7CgkJCQl1cGxvYWRVUkwgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1wb3N0dXJsIik7CgkJCX0KCQkJaWYgKCF1cGxvYWRVUkwpIHsKCQkJCWlmICgwID09PSBmb3JtQWN0aW9uLmluZGV4T2YoIi8iKSkgewoJCQkJCXVwbG9hZFVSTCA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyBmb3JtQWN0aW9uOwoJCQkJfSBlbHNlIGlmICgoMCA9PT0gZm9ybUFjdGlvbi5pbmRleE9mKCJodHRwOi8vIikpIHx8CgkJCQkJCSgwID09PSBmb3JtQWN0aW9uLmluZGV4T2YoImh0dHBzOi8vIikpKSB7CgkJCQkJdXBsb2FkVVJMID0gZm9ybUFjdGlvbjsKCQkJCX0gZWxzZSB7CgkJCQkJdXBsb2FkVVJMID0gYmFzZVVSTCArIGZvcm1BY3Rpb247CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHVwbG9hZFVSTDsKCX0KCXZhciBjaGVja1RpbWVvdXQ7CglmdW5jdGlvbiBkZXZpY2VDb21tYW5kKGNvbW1hbmQsIGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlpZiggIWIuaXNTdXBwb3J0ZWRQbGF0Zm9ybShjb21tYW5kKSApewoJCQliLm5vdFN1cHBvcnRlZChpZCwgY29tbWFuZCk7CgkJCXJldHVybjsKCQl9CgkJaWYgKGIuaXNJT1MoKSkgIHsKCQkJY2hlY2tUaW1lb3V0ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSAgewoJCQkJYnJpZGdlaXQubGF1bmNoRmFpbGVkKGlkKTsKCQkJfSwgMzAwMCk7CgkJfQoJCWlmICghb3B0aW9ucykgIHsKCQkJb3B0aW9ucyA9IHt9OwoJCX0KCQljb25zb2xlLmxvZyhjb21tYW5kICsgIiAiICsgaWQpOwoJCWJyaWRnZWl0LmRldmljZUNvbW1hbmRDYWxsYmFjayA9IGNhbGxiYWNrOwoJCWlmIChicmlkZ2VpdC51c2VKU09ONjQpICB7CgkJCW9wdGlvbnMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJCWRldmljZUNvbW1hbmRFeGVjKGNvbW1hbmQsIGlkLCBvcHRpb25zKTsKCQl9IGVsc2UgewoJCQlvcHRpb25zLmRldmljZUNvbW1hbmRDYWxsYmFjayA9IGNhbGxiYWNrOwoJCQlkZXZpY2VDb21tYW5kVVJMRXhlYyhjb21tYW5kLCBpZCwgb3B0aW9ucyk7CgkJfQoJfQoJZnVuY3Rpb24gc2V0SW5wdXQodGFyZ2V0LCBuYW1lLCB2YWx1ZSwgdnR5cGUpICB7CgkJY29uc29sZS5sb2coJ3NldElucHV0KHRhcmdldD0nICsgdGFyZ2V0ICsgJywgbmFtZT0nICsgbmFtZSArICcsIHZhbHVlPScgKyB2YWx1ZSArICcsIHZ0eXBlPScgKyB2dHlwZSk7CgkJdmFyIGhpZGRlbklEID0gbmFtZSArICItaGlkIjsKCQl2YXIgZXhpc3RpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoaWRkZW5JRCk7CgkJaWYgKGV4aXN0aW5nKSAgewoJCQlleGlzdGluZy5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdmFsdWUpOwoJCQlyZXR1cm47CgkJfQoJCXZhciB0YXJnZXRFbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQpOwoJCWlmICghdGFyZ2V0RWxtKSAgewoJCQlyZXR1cm47CgkJfQoJCXZhciBoaWRkZW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoKCQloaWRkZW4uc2V0QXR0cmlidXRlKCJ0eXBlIiwgImhpZGRlbiIpOwoJCWhpZGRlbi5zZXRBdHRyaWJ1dGUoImlkIiwgaGlkZGVuSUQpOwoJCWhpZGRlbi5zZXRBdHRyaWJ1dGUoIm5hbWUiLCBuYW1lKTsKCQloaWRkZW4uc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIHZhbHVlKTsKCQlpZiAodnR5cGUpICB7CgkJCWhpZGRlbi5zZXRBdHRyaWJ1dGUoImRhdGEtdHlwZSIsIHZ0eXBlKTsKCQl9CgkJdGFyZ2V0RWxtLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGhpZGRlbiwgdGFyZ2V0RWxtKTsKCX0KCWZ1bmN0aW9uIGZvcm1PZihlbGVtZW50KSB7CgkJdmFyIHBhcmVudCA9IGVsZW1lbnQ7CgkJd2hpbGUgKG51bGwgIT0gcGFyZW50KSB7CgkJCWlmICgiZm9ybSIgPT0gcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKCQkJCXJldHVybiBwYXJlbnQ7CgkJCX0KCQkJcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7CgkJfQoJfQoKCWZ1bmN0aW9uIHBhY2tPYmplY3QocGFyYW1zLCBleGNsdWRlKSAgewoJCXZhciBwYWNrZWQgPSAiIjsKCQl2YXIgc2VwID0gIiI7CgkJZm9yICh2YXIga2V5IGluIHBhcmFtcykgIHsKCQkJaWYgKGV4Y2x1ZGUuaW5kZXhPZihrZXkpIDwgMCkgIHsKCQkJCXBhY2tlZCArPSBzZXAgKyBlc2NhcGUoa2V5KSArICI9IiArIGVzY2FwZShwYXJhbXNba2V5XSk7CgkJCQlzZXAgPSAiJiI7CgkJCX0KCQl9CgkJcmV0dXJuIHBhY2tlZDsKCX0KCWZ1bmN0aW9uIHVucGFja0RldmljZVJlc3BvbnNlKGRhdGEpICB7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCXZhciB1bjY0ID0gYnJpZGdlaXQudXNlSlNPTjY0IHx8CgkJCQkoYnJpZGdlaXQudXNlQmFzZTY0ICYmIChkYXRhLmluZGV4T2YoIiEiKSA8IDApKTsKCQlpZiAodW42NCkgIHsKCQkJZGF0YSA9IGRhdGEucmVwbGFjZSgvfi9nLCI9Iik7CgkJCWRhdGEgPSBkYXRhLnJlcGxhY2UoL1wuL2csIi8iKTsKCQkJZGF0YSA9IGF0b2IoZGF0YSk7CgkJfQoJCWlmIChicmlkZ2VpdC51c2VKU09ONjQpICB7CgkJCS8vY2xvbmUgdGhlc2UgZm9yIG5vdwoJCQlkYXRhID0gSlNPTi5wYXJzZShkYXRhKQoJCQlkYXRhLm5hbWUgPSBkYXRhLmlkOwoJCQlkYXRhLnAgPSBkYXRhLnByZXZpZXc7CgkJCWRhdGEuYyA9IGRhdGEuY2xvdWQ7CgkJCWRhdGEuaCA9IGRhdGEuZWNobzsKCQkJZGF0YS52ID0gZGF0YS52ZXJzaW9uOwoJCQlyZXR1cm4gZGF0YTsKCQl9IGVsc2UgewoJCQlkYXRhID0gZGVjb2RlVVJJQ29tcG9uZW50KGRhdGEpOwoJCX0KCQl2YXIgcGFyYW1zID0gZGF0YS5zcGxpdCgiJiIpOwoJCXZhciBsZW4gPSBwYXJhbXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJdmFyIHNwbGl0SW5kZXggPSBwYXJhbXNbaV0uaW5kZXhPZigiPSIpOwoJCQl2YXIgcGFyYW1OYW1lID0gdW5lc2NhcGUocGFyYW1zW2ldLnN1YnN0cmluZygwLCBzcGxpdEluZGV4KSk7CgkJCXZhciBwYXJhbVZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KAoJCQkJCXBhcmFtc1tpXS5zdWJzdHJpbmcoc3BsaXRJbmRleCArIDEpICk7CgkJCWlmICgiISIgPT09IHBhcmFtTmFtZS5zdWJzdHJpbmcoMCwxKSkgIHsKCQkJCS8vQnJpZGdlSXQgcGFyYW1ldGVycyBhcmUgc2V0IGRpcmVjdGx5CgkJCQlyZXN1bHRbcGFyYW1OYW1lLnN1YnN0cmluZygxKV0gPSBwYXJhbVZhbHVlOwoJCQl9IGVsc2UgIHsKCQkJCS8vb25seSBvbmUgdXNlciB2YWx1ZSBpcyBzdXBwb3J0ZWQKCQkJCWNvbnNvbGUubG9nKCJkZXZpY2VSZXNwb25zZSB2YWx1ZSAiICsKCQkJCQkJcGFyYW1OYW1lICsgIiAiICsgcGFyYW1WYWx1ZSk7CgkJCQlyZXN1bHQubmFtZSA9IHBhcmFtTmFtZTsKCQkJCXJlc3VsdC52YWx1ZSA9IHBhcmFtVmFsdWU7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0KCWZ1bmN0aW9uIHVybDJPYmplY3QoZW5jb2RlZCkgIHsKCQl2YXIgcGFydHMgPSBlbmNvZGVkLnNwbGl0KCImIik7CgkJdmFyIHJlY29yZCA9IHt9OwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCEhcGFydHNbaV0pICB7CgkJCQl2YXIgcGFpciA9IHBhcnRzW2ldLnNwbGl0KCI9Iik7CgkJCQlyZWNvcmRbdW5lc2NhcGUocGFpclswXSldID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhaXJbMV0pOwoJCQl9CgkJfQoJCXJldHVybiByZWNvcmQ7Cgl9CglmdW5jdGlvbiBnZXROYW1lZE9iamVjdChuYW1lKSAgewoJCWlmICghbmFtZSkgIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCXZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoIi4iKTsKCQl2YXIgdGhlT2JqZWN0ID0gd2luZG93OwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKCQkJdGhlT2JqZWN0ID0gdGhlT2JqZWN0W3BhcnRzW2ldXTsKCQkJaWYgKCF0aGVPYmplY3QpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cgPT0gdGhlT2JqZWN0KSAgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJcmV0dXJuIHRoZU9iamVjdDsKCX0KCWZ1bmN0aW9uIGFkZE9uTG9hZExpc3RlbmVyKGZ1bmMpICB7CgkJdmFyIG9sZG9ubG9hZCA9IHdpbmRvdy5vbmxvYWQ7CgkJd2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCQl0cnkgewoJCQkJaWYgKG9sZG9ubG9hZCkgIHsKCQkJCQlvbGRvbmxvYWQoKTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgIHsKCQkJCWNvbnNvbGUuZXJyb3IoZSk7CgkJCX0KCQkJZnVuYygpOwoJCX0KCX0KCXZhciBpc0RhdGFQZW5kaW5nID0gZmFsc2U7Cgl2YXIgaXNMb2FkZWQgPSBmYWxzZTsKCXZhciBwZW5kaW5nRGF0YSA9IG51bGw7CglmdW5jdGlvbiBsb2FkQ29tcGxldGUoKSAgewoJCWlzTG9hZGVkID0gdHJ1ZTsKCX0KCWZ1bmN0aW9uIGNoZWNrRXhlY0RldmljZVJlc3BvbnNlKCkgIHsKCQl2YXIgZGF0YSA9IGdldERldmljZUNvbW1hbmQoKTsKCQlpZiAobnVsbCA9PSBkYXRhKSAgewoJCQlkYXRhID0gcGVuZGluZ0RhdGE7CgkJCS8vcmVjb3JkIFVSTC9oYXNoIGNoYW5nZXMgdGhhdCBhcmUgbm90IGRldmljZSBjb21tYW5kcwoJCQlzdG9yZUxhc3RQYWdlKCk7CgkJfQoJCXZhciBkZXZpY2VQYXJhbXM7CgkJaWYgKG51bGwgIT0gZGF0YSkgIHsKCQkJcGVuZGluZ0RhdGEgPSBkYXRhOwoJCQlpc0RhdGFQZW5kaW5nID0gdHJ1ZTsKCQkJaWYgKCFpc0xvYWRlZCkgIHsKCQkJCWNvbnNvbGUubG9nKCJjaGVja0V4ZWNEZXZpY2VSZXNwb25zZSB3YWl0aW5nIGZvciBvbmxvYWQiKTsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgbmFtZTsKCQkJdmFyIHZhbHVlOwoJCQl2YXIgbmVlZFJlZnJlc2ggPSB0cnVlOwoJCQlpZiAoIiIgIT0gZGF0YSkgIHsKCQkJCWRldmljZVBhcmFtcyA9IHVucGFja0RldmljZVJlc3BvbnNlKGRhdGEpOwoJCQkJaWYgKGRldmljZVBhcmFtcy5uYW1lKSAgewoJCQkJCW5hbWUgPSBkZXZpY2VQYXJhbXMubmFtZTsKCQkJCQl2YWx1ZSA9IGRldmljZVBhcmFtcy52YWx1ZTsKCQkJCQlzZXRJbnB1dChuYW1lLCBuYW1lLCB2YWx1ZSk7CgkJCQkJbmVlZFJlZnJlc2ggPSBmYWxzZTsKCQkJCX0KCQkJfQoJCQlpZiAobmVlZFJlZnJlc2gpICB7CgkJCQljb25zb2xlLmxvZygnbmVlZHMgcmVmcmVzaCcpOwoJCQkJaWYgKHdpbmRvdy5pY2UuYWpheFJlZnJlc2gpICB7CgkJCQkJaWNlLmFqYXhSZWZyZXNoKCk7CgkJCQl9CgkJCX0KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKXsKCQkJCWlmICghaXNEYXRhUGVuZGluZykgIHsKCQkJCQljb25zb2xlLmxvZygiY2hlY2tFeGVjRGV2aWNlUmVzcG9uc2UgaXMgZG9uZSwgZXhpdGluZyIpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXZhciBzeEV2ZW50ID0gewoJCQkJCW5hbWUgOiBuYW1lLAoJCQkJCXZhbHVlIDogdmFsdWUKCQkJCX07CgkJCQl2YXIgY2FsbGJhY2sgPSBicmlkZ2VpdC5kZXZpY2VDb21tYW5kQ2FsbGJhY2s7CgkJCQl2YXIgbmFtZWRDYWxsQmFjayA9IGdldE5hbWVkT2JqZWN0KGNhbGxiYWNrKTsKCQkJCWlmIChuYW1lZENhbGxCYWNrKSAgewoJCQkJCWNhbGxiYWNrID0gbmFtZWRDYWxsQmFjazsKCQkJCX0KCQkJCWNvbnNvbGUubG9nKCdzeEV2ZW50OiAnICsgSlNPTi5zdHJpbmdpZnkoc3hFdmVudCkgKyAiICIgKwoJCQkJCQlKU09OLnN0cmluZ2lmeShkZXZpY2VQYXJhbXMpKTsKCQkJCXZhciByZXN0b3JlSGFzaCA9ICIiOwoJCQkJaWYgKGRldmljZVBhcmFtcykgIHsKCQkJCQlpZiAoZGV2aWNlUGFyYW1zLnIpICB7CgkJCQkJCXN4RXZlbnQucmVzcG9uc2UgPSBkZXZpY2VQYXJhbXMucjsKCQkJCQl9CgkJCQkJaWYgKGRldmljZVBhcmFtcy52KSAgewoJCQkJCQlzeEV2ZW50LnZlcnNpb24gPSBkZXZpY2VQYXJhbXMudjsKCQkJCQkJc2V0TGFzdEFwcFZlcnNpb24oZGV2aWNlUGFyYW1zLnYpOwoJCQkJCX0KCQkJCQlpZiAoZGV2aWNlUGFyYW1zLnApICB7CgkJCQkJCXN4RXZlbnQucHJldmlldyA9IGRldmljZVBhcmFtcy5wOwoJCQkJCX0KCQkJCQlpZiAoZGV2aWNlUGFyYW1zLmMpICB7CgkJCQkJCXNldENsb3VkUHVzaElkKGRldmljZVBhcmFtcy5jKTsKCQkJCQkJaWYgKGljZS5wdXNoKSAgewoJCQkJCQkJaWNlLnB1c2gucGFya0luYWN0aXZlUHVzaElkcygKCQkJCQkJCQkJZGV2aWNlUGFyYW1zLmMgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoZGV2aWNlUGFyYW1zLmgpICB7CgkJCQkJCXZhciBlY2hvZWQgPSB1cmwyT2JqZWN0KHVuZXNjYXBlKGRldmljZVBhcmFtcy5oKSk7CgkJCQkJCWlmIChlY2hvZWQuaCkgIHsKCQkJCQkJCXJlc3RvcmVIYXNoID0gZWNob2VkLmg7CgkJCQkJCX0KCQkJCQkJaWYgKGVjaG9lZC5jKSAgewoJCQkJCQkJdmFyIG5hbWVkQ2FsbEJhY2sgPSBnZXROYW1lZE9iamVjdChlY2hvZWQuYyk7CgkJCQkJCQlpZiAobmFtZWRDYWxsQmFjaykgIHsKCQkJCQkJCQljYWxsYmFjayA9IG5hbWVkQ2FsbEJhY2s7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQl2YXIgbG9jID0gd2luZG93LmxvY2F0aW9uOwoJCQkJaXNEYXRhUGVuZGluZyA9IGZhbHNlOwoJCQkJcGVuZGluZ0RhdGEgPSBudWxsOwoKCQkJCWlmKCAhaGFzSW5zdGFsbGVkVG9rZW4oKSApewoJCQkJCXNldEluc3RhbGxlZFRva2VuKCk7CgkJCQl9CgoJCQkJaWYgKGNhbGxiYWNrKSAgewoJCQkJCXRyeSB7CgkJCQkJCWNhbGxiYWNrKHN4RXZlbnQpOwoJCQkJCX0gY2F0Y2ggKGUpICB7CgkJCQkJCXZhciBtc2cgPSAiQnJpZGdlSXQgRGV2aWNlIGZ1bmN0aW9uIGNhbGxiYWNrICciICsgY2FsbGJhY2sgKyAiJyBmYWlsZWQsIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYWxsYmFjayBmdW5jdGlvbiBpcyBpbiBnbG9iYWwgc2NvcGUuIjsKCQkJCQkJY29uc29sZS5lcnJvcihtc2cpOwoJCQkJCQljb25zb2xlLmVycm9yKGUuc3RhY2spOwoJCQkJCQlhbGVydChtc2cpOwoJCQkJCX0KCQkJCQlicmlkZ2VpdC5kZXZpY2VDb21tYW5kQ2FsbGJhY2sgPSBudWxsOwoJCQkJfSBlbHNlewoJCQkJCWNvbnNvbGUubG9nKCdubyBkZXZpY2VDb21tYW5kQ2FsbGJhY2sgcmVnaXN0ZXJlZCA6KCcpOwoJCQkJfQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCXZhciByZXN0b3JlTG9jYXRpb24gPQoJCQkJCQlsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoICsgcmVzdG9yZUhhc2g7CgkJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIiIsIGRvY3VtZW50LnRpdGxlLAoJCQkJCQlyZXN0b3JlTG9jYXRpb24pOwoJCQkJCWNvbnNvbGUubG9nKCdicmlkZ2VpdCBoaXN0b3J5IHJlcGxhY2VTdGF0ZTogJyArCgkJCQkJCXJlc3RvcmVMb2NhdGlvbik7CgkJCQl9LCAxMDApOwoJCQl9LCAxKTsKCQl9Cgl9Cgl2YXIgQ0xPVURfUFVTSF9LRVkgPSAiaWNlLm5vdGlmeUJhY2siOwoJZnVuY3Rpb24gc2V0Q2xvdWRQdXNoSWQoaWQpICB7CgkJLy9yZWx5IG9uIGxvY2FsIHN0b3JhZ2Ugc2luY2UgY2xvdWQgcHVzaCBpcyBvbiBtb2Rlcm4gcGxhdGZvcm1zCgkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oQ0xPVURfUFVTSF9LRVksIGlkKTsKCQl9Cgl9CglmdW5jdGlvbiBnZXRDbG91ZFB1c2hJZCgpICB7CgkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKENMT1VEX1BVU0hfS0VZKTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9CgoJZnVuY3Rpb24gc2V0dXBDbG91ZFB1c2goKSAgewoJCXZhciBjbG91ZFB1c2hJZCA9IGdldENsb3VkUHVzaElkKCk7CgkJaWYgKCEhY2xvdWRQdXNoSWQpICB7CgkJCWlmIChpY2UucHVzaCkgIHsKCQkJCWNvbnNvbGUubG9nKCJDbG91ZCBQdXNoIHJlZ2lzdGVyZWQ6ICIgKyBjbG91ZFB1c2hJZCk7CgkJCQlpY2UucHVzaC5wYXJrSW5hY3RpdmVQdXNoSWRzKGNsb3VkUHVzaElkKTsKCQkJfQoJCX0KCX0KCS8vbW92ZSBwYXVzZSBhbmQgcmVzdW1lIHRvIElDRXB1c2ggd2hlbiByZWFkeQoJZnVuY3Rpb24gcGF1c2VQdXNoKCkgIHsKCSAgIGlmICh3aW5kb3cuaWNlICYmIGljZS5wdXNoKSAgewoJCSAgIGljZS5wdXNoLmNvbm5lY3Rpb24ucGF1c2VDb25uZWN0aW9uKCk7CgkgICB9Cgl9CglmdW5jdGlvbiByZXN1bWVQdXNoKCkgIHsKCSAgIGlmICh3aW5kb3cuaWNlICYmIGljZS5wdXNoKSAgewoJCSAgIGljZS5wdXNoLmNvbm5lY3Rpb24ucmVzdW1lQ29ubmVjdGlvbigpOwoJCQlyZXN1bWVQdXNoR3JvdXBzKCk7CgkgICB9Cgl9CglmdW5jdGlvbiByZXN1bWVQdXNoR3JvdXBzKCkgIHsKCQlmb3IgKHZhciBwdXNoSUQgaW4gcHVzaExpc3RlbmVycykgewoJCQl2YXIgcHVzaExpc3RlbmVyID0gcHVzaExpc3RlbmVyc1twdXNoSURdOwoJCQljb25zb2xlLmxvZygicmVqb2luaW5nIHB1c2ggZ3JvdXAgd2l0aCBvbGQgcHVzaGlkICIgKwoJCQkJCXB1c2hMaXN0ZW5lci5ncm91cCArICIgIiArIHB1c2hJRCApOwoJCQlpY2UucHVzaC5hZGRHcm91cE1lbWJlcihwdXNoTGlzdGVuZXIuZ3JvdXAsIHB1c2hJRCk7CgkJfQoJfQoKCXZhciBMQVNUX1BBR0VfS0VZID0gImJyaWRnZWl0Lmxhc3RwYWdlIjsKCWZ1bmN0aW9uIHN0b3JlTGFzdFBhZ2UobGFzdFBhZ2UpICB7CgkJaWYgKCFsYXN0UGFnZSkgIHsKCQkJdmFyIHN4a2V5ID0gIiNpY2Vtb2JpbGVzeCI7CgkJCXZhciBzeGxlbiA9IHN4a2V5Lmxlbmd0aDsKCQkJdmFyIGxvY0hhc2ggPSAiIiArIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwoJCQlsYXN0UGFnZSA9ICIiICsgZG9jdW1lbnQubG9jYXRpb247CgkJCWlmIChzeGtleSA9PT0gbG9jSGFzaC5zdWJzdHJpbmcoMCwgc3hsZW4pKSAgewoJCQkJbGFzdFBhZ2UgPSBsYXN0UGFnZS5zdWJzdHJpbmcoMCwKCQkJCQkJbGFzdFBhZ2UubGVuZ3RoIC0gbG9jSGFzaC5sZW5ndGgpCgkJCX0KCQl9CgkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oTEFTVF9QQUdFX0tFWSwgbGFzdFBhZ2UpOwoJCQljb25zb2xlLmxvZygiYnJpZGdlaXQgc3RvcmVMYXN0UGFnZSAiICsgbGFzdFBhZ2UpOwoJCX0KCX0KCS8qIFBhZ2UgZXZlbnQgaGFuZGxpbmcgKi8KCWlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewoKCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicGFnZWhpZGUiLCBmdW5jdGlvbiAoKSB7CgkJCS8vaGlkaW5nIHRoZSBwYWdlIGVpdGhlciBpbmRpY2F0ZXMgdXNlciBkb2VzIG5vdCByZXF1aXJlCgkJCS8vQnJpZGdlSXQgb3IgdGhlIHVybCBzY2hlbWUgaW52b2NhdGlvbiBoYXMgc3VjY2VlZGVkCgkJCWNsZWFyVGltZW91dChjaGVja1RpbWVvdXQpOwoJCQlpZiAoaWNlLnB1c2ggJiYgaWNlLnB1c2guY29ubmVjdGlvbikgewoJCQkJcGF1c2VQdXNoKCk7CgkJCX0KCQl9LCBmYWxzZSk7CgoJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwYWdlc2hvdyIsIGZ1bmN0aW9uICgpIHsKCQkJaWYgKGljZS5wdXNoICYmIGljZS5wdXNoLmNvbm5lY3Rpb24pIHsKCQkJCXJlc3VtZVB1c2goKTsKCQkJfQoJCX0sIGZhbHNlKTsKCgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CgkJCWNvbnNvbGUubG9nKCdlbnRlcmVkIGhhc2hjaGFuZ2UgbGlzdGVuZXIgaGFzaD0nICsgd2luZG93LmxvY2F0aW9uLmhhc2gpOwoJCQljaGVja0V4ZWNEZXZpY2VSZXNwb25zZSgpOwoJCX0sIGZhbHNlKTsKCgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmdW5jdGlvbiAoKSB7CgkJCXN0b3JlTGFzdFBhZ2UoKTsKCQl9LCBmYWxzZSk7CgoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CgkJCWlmIChkb2N1bWVudC53ZWJraXRIaWRkZW4pICB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoY2hlY2tUaW1lb3V0KTsKCQkJCXBhdXNlUHVzaCgpOwoJCQl9IGVsc2UgewoJCQkJcmVzdW1lUHVzaCgpOwoJCQl9CgkJfSk7CgoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CgkJCWlmIChkb2N1bWVudC5oaWRkZW4pICB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoY2hlY2tUaW1lb3V0KTsKCQkJCXBhdXNlUHVzaCgpOwoJCQl9IGVsc2UgewoJCQkJcmVzdW1lUHVzaCgpOwoJCQl9CgkJfSk7CgoJfTsKCglmdW5jdGlvbiBqc29uUE9TVCh1cmksIHBheWxvYWQpIHsKCQl2YXIgcHJvbSA9IG5ldyBQcm9taXooKTsKCQl2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CgkJeGhyLm9wZW4oJ1BPU1QnLCB1cmksIHRydWUpOwoJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9VVRGLTgiKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCWlmICg0ID09IHhoci5yZWFkeVN0YXRlKSAgewoJCQkJaWYgKDIwMCA9PSB4aHIuc3RhdHVzKSAgewoJCQkJCXByb20ucmVzb2x2ZShKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpKTsKCQkJCX0gZWxzZSB7CgkJCQkJcHJvbS5yZWplY3Qoe21lc3NhZ2U6eGhyLnN0YXR1c1RleHQsIHN0YXR1czogeGhyLnN0YXR1c30pOwoJCQkgICB9CgkJCX0KCQl9OwoJCXhoci5zZW5kKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKTsKCQlyZXR1cm4gcHJvbTsKCX0KCglmdW5jdGlvbiBodHRwR0VUKHVyaSwgcXVlcnkpIHsKCQl2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CgkJdmFyIHF1ZXJ5U3RyID0gIiI7CgkJaWYgKCEhcXVlcnkpICB7CgkJCXF1ZXJ5U3RyID0gIj8iICsgcXVlcnk7CgkJfQoJCXhoci5vcGVuKCdHRVQnLCB1cmkgKyBxdWVyeVN0ciwgZmFsc2UpOwoJCXhoci5zZW5kKHF1ZXJ5KTsKCQlpZiAoeGhyLnN0YXR1cyA9PSAyMDApIHsKCQkJcmV0dXJuIHhoci5yZXNwb25zZVRleHQ7CgkJfSBlbHNlIHsKCQkJdGhyb3cgeGhyLnN0YXR1c1RleHQgKyAnWycgKyB4aHIuc3RhdHVzICsgJ10nOwoJCX0KCX0KCglmdW5jdGlvbiBlbmRzV2l0aChzLCBwYXR0ZXJuKSB7CgkJcmV0dXJuIHMubGFzdEluZGV4T2YocGF0dGVybikgPT0gcy5sZW5ndGggLSBwYXR0ZXJuLmxlbmd0aDsKCX0KCgl2YXIgYWJzb2x1dGVHb0JyaWRnZUl0VVJMID0gbnVsbDsKCglmdW5jdGlvbiBmZXRjaEdvQnJpZGdlSXQodXJsKSB7CgkJdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJaWYgKDQgPT0geGhyLnJlYWR5U3RhdGUpICB7CgkJCQlpZiAoMjAwID09IHhoci5zdGF0dXMpICB7CgkJCQkJaWYgKCFhYnNvbHV0ZUdvQnJpZGdlSXRVUkwpICB7CgkJCQkJCWFic29sdXRlR29CcmlkZ2VJdFVSTCA9IGdldEFic29sdXRlVVJMKHVybCk7CgkJCQkJCWNvbnNvbGUubG9nKCJDbG91ZCBQdXNoIHJldHVybiB2aWEgZ29CcmlkZ2VJdDogIiArCgkJCQkJCQkJYWJzb2x1dGVHb0JyaWRnZUl0VVJMKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9OwoJCXhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwoJCXhoci5zZW5kKCk7Cgl9CgoJZnVuY3Rpb24gZmluZEdvQnJpZGdlSXQoKSB7CgkJaWYgKCEhYnJpZGdlaXQuZ29CcmlkZ2VJdFVSTCkgIHsKCQkJLy9wYWdlIHNldHRpbmcgb3ZlcnJpZGVzIGRldGVjdGlvbgoJCQlhYnNvbHV0ZUdvQnJpZGdlSXRVUkwgPSBnZXRBYnNvbHV0ZVVSTChicmlkZ2VpdC5nb0JyaWRnZUl0VVJMKTsKCQkJcmV0dXJuOwoJCX0KCQkvL2hvc3Qtd2lkZSBwYWdlCgkJZmV0Y2hHb0JyaWRnZUl0KCcvZ29CcmlkZ2VJdC5odG1sJyk7CgkJLy9hcHBsaWNhdGlvbi1zcGVjaWZpYyBwYWdlCgkJZmV0Y2hHb0JyaWRnZUl0KCdnb0JyaWRnZUl0Lmh0bWwnKTsKCX0KCglmdW5jdGlvbiBnZXRBYnNvbHV0ZVVSTCh1cmwpICB7CgkJdmFyIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwoJCWltZy5zcmMgPSB1cmw7CgkJdXJsID0gaW1nLnNyYzsKCQlyZXR1cm4gdXJsOwoJfQoKCXZhciBwdXNoUHJvbWlzZSA9IG5ldyBQcm9taXooKTsKCglmdW5jdGlvbiBsb2FkUHVzaFNlcnZpY2UodXJpLCBhcGlrZXksIG9wdGlvbnMpIHsKCQl2YXIgYmFzZVVSSSA9IHVyaSArIChlbmRzV2l0aCh1cmksICcvJykgPyAnJyA6ICcvJyk7CgkJaWYgKGljZSAmJiBpY2UucHVzaCkgewoJCQljb25zb2xlLmxvZygnUHVzaCBzZXJ2aWNlIGFscmVhZHkgbG9hZGVkIGFuZCBjb25maWd1cmVkJyk7CgkJfSBlbHNlIHsKCQkJdmFyIGNvZGVVUkkgPSBiYXNlVVJJICsgJ2NvZGUuaWNlcHVzaCc7CgkJCXZhciBjb2RlID0gaHR0cEdFVChjb2RlVVJJKTsKCQkJZXZhbChjb2RlKTsKCgkJCWZpbmRHb0JyaWRnZUl0KCk7CgkJfQoJCWljZS5wdXNoLmNvbmZpZ3VyYXRpb24uY29udGV4dFBhdGggPSBiYXNlVVJJOwoJCWljZS5wdXNoLmNvbmZpZ3VyYXRpb24uYXBpa2V5ID0gYXBpa2V5OwoJCWlmIChvcHRpb25zKSAgewoJCQlpY2UucHVzaC5jb25maWd1cmF0aW9uLmFjY291bnQgPSBvcHRpb25zLmFjY291bnQ7CgkJCWljZS5wdXNoLmNvbmZpZ3VyYXRpb24ucmVhbG0gPSBvcHRpb25zLnJlYWxtOwoJCQlpZiAob3B0aW9ucy5hdXRoKSAgewoJCQkJaWNlLnB1c2guY29uZmlndXJhdGlvbi5hY2Nlc3NfdG9rZW4gPQoJCQkJCQlvcHRpb25zLmF1dGguYWNjZXNzX3Rva2VuOwoJCQl9CgkJfQoJCWljZS5wdXNoLmNvbm5lY3Rpb24uc3RhcnRDb25uZWN0aW9uKCk7CgoJCXNldHVwQ2xvdWRQdXNoKCk7CgkJcHVzaFByb21pc2UucmVzb2x2ZSgpOwoJfQoKCXZhciBwdXNoTGlzdGVuZXJzID0ge307CgoJZnVuY3Rpb24gYWRkUHVzaExpc3RlbmVySW1wbChncm91cCwgY2FsbGJhY2spIHsKCQlpZiAoaWNlICYmIGljZS5wdXNoICYmIGljZS5wdXNoLmNvbmZpZ3VyYXRpb24uY29udGV4dFBhdGgpIHsKCQkJaWNlLnB1c2guY29ubmVjdGlvbi5yZXN1bWVDb25uZWN0aW9uKCk7CgoJCQl2YXIgcHVzaElkID0gaWNlLnB1c2guY3JlYXRlUHVzaElkKCk7CgkJCXB1c2hMaXN0ZW5lcnNbcHVzaElkXSA9IHtncm91cDogZ3JvdXAsIGNhbGxiYWNrOiBjYWxsYmFja307CgkJCWljZS5wdXNoLmFkZEdyb3VwTWVtYmVyKGdyb3VwLCBwdXNoSWQpOwoJCQlpZiAoInN0cmluZyIgIT0gdHlwZW9mKGNhbGxiYWNrKSkgIHsKCQkJCWNvbnNvbGUuZXJyb3IoCgkJCQkJIkJyaWRnZUl0IENsb3VkIFB1c2ggY2FsbGJhY2tzIG11c3QgYmUgbmFtZWQgaW4gd2luZG93IHNjb3BlIik7CgkJCX0gZWxzZSB7CgkJCQl2YXIgY2FsbGJhY2tOYW1lID0gY2FsbGJhY2s7CgkJCQljYWxsYmFjayA9IGdldE5hbWVkT2JqZWN0KGNhbGxiYWNrKTsKCQkJCWlmICghIWNhbGxiYWNrKSAgewoJCQkJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCQkJCXZhciBjYWxsYmFja3MgPSBsb2NhbFN0b3JhZ2UKCQkJCQkJCQkuZ2V0SXRlbShDTE9VRF9DQUxMQkFDS1NfS0VZKTsKCQkJCQkJaWYgKCFjYWxsYmFja3MpICB7CgkJCQkJCQljYWxsYmFja3MgPSAiICI7CgkJCQkJCX0KCQkJCQkJaWYgKGNhbGxiYWNrcy5pbmRleE9mKCIgIiArIGNhbGxiYWNrTmFtZSArICIgIikgPCAwKSAgewoJCQkJCQkJY2FsbGJhY2tzICs9IGNhbGxiYWNrTmFtZSArICIgIjsKCQkJCQkJfQoJCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbShDTE9VRF9DQUxMQkFDS1NfS0VZLCBjYWxsYmFja3MpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpY2UucHVzaC5yZWdpc3RlcihbIHB1c2hJZCBdLCBjYWxsYmFjayk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5lcnJvcignUHVzaCBzZXJ2aWNlIGlzIG5vdCBhY3RpdmUnKTsKCQl9Cgl9OwoKCXZhciBCUklER0VJVF9JTlNUQUxMRURfS0VZID0gImJyaWRnZWl0Lmluc3RhbGxlZCI7Cgl2YXIgQlJJREdFSVRfSU5TVEFMTEVEX0xPR19LRVkgPSAiYnJpZGdlaXQuaW5zdGFsbGVkTG9nZ2VkIjsKCglmdW5jdGlvbiBoYXNJbnN0YWxsZWRUb2tlbigpewoJCXZhciByZXN1bHQgPSBmYWxzZTsKCQlpZiggd2luZG93LmxvY2FsU3RvcmFnZSl7CgkJCXZhciBpbnN0YWxsVGltZXN0YW1wID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQlJJREdFSVRfSU5TVEFMTEVEX0tFWSk7CgkJCWlmKCBpbnN0YWxsVGltZXN0YW1wICl7CgkJCQlpZiggIXdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKEJSSURHRUlUX0lOU1RBTExFRF9MT0dfS0VZKSApewoJCQkJCWNvbnNvbGUubG9nKCdicmlkZ2VpdCBpbnN0YWxsZWQgJwoJCQkJCQkrIG5ldyBEYXRlKCBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShCUklER0VJVF9JTlNUQUxMRURfS0VZKSkpLnRvR01UU3RyaW5nKCkpOwoJCQkJCXdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKEJSSURHRUlUX0lOU1RBTExFRF9MT0dfS0VZLCAndHJ1ZScpOwoJCQkJfQoJCQkJcmVzdWx0ID0gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfQoKCWZ1bmN0aW9uIHNldEluc3RhbGxlZFRva2VuKCl7CgkJaWYoIHdpbmRvdy5sb2NhbFN0b3JhZ2UgKXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oQlJJREdFSVRfSU5TVEFMTEVEX0tFWSwgJycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7CgkJfQoJfQoKCXZhciBMQVNUVkVSU0lPTl9LRVkgPSAiYnJpZGdlaXQubGFzdGFwcHZlcnNpb24iOwoKCWZ1bmN0aW9uIHNldExhc3RBcHBWZXJzaW9uKHZlcnNpb24pICB7CgkJaWYgKHdpbmRvdy5sb2NhbFN0b3JhZ2UpICB7CgkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKExBU1RWRVJTSU9OX0tFWSwgdmVyc2lvbik7CgkJfQoJfQoKCWZ1bmN0aW9uIGFkZE9wdGlvbnMoYmFzZSwgb3B0aW9ucykgIHsKCQlmb3IgKHZhciBwcm9wIGluIG9wdGlvbnMpICB7CgkJCWJhc2VbcHJvcF0gPSBvcHRpb25zW3Byb3BdOwoJCX0KCQlyZXR1cm4gYmFzZTsKCX0KCglmdW5jdGlvbiBvdmVybGF5T3B0aW9ucyhkZWZhdWx0cywgb3B0aW9ucykgIHsKCQl2YXIgbWVyZ2VkID0ge307CgoJCWFkZE9wdGlvbnMobWVyZ2VkLCBkZWZhdWx0cyk7CgkJYWRkT3B0aW9ucyhtZXJnZWQsIG9wdGlvbnMpOwoKCQlyZXR1cm4gbWVyZ2VkOwoJfQoKCXZhciBhbm9uQXV0aCA9IG5ldyBQcm9taXooKTsKCWFub25BdXRoLnJlc29sdmUoKTsKCgl2YXIgYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMgPSB7CgkJYWNjb3VudDogImljZXNvZnRfdGVjaG5vbG9naWVzX2luYyIsCgkJcmVhbG06ICJkZW1vLmJyaWRnZWl0Lm1vYmkiLAoJCXNlcnZpY2VCYXNlOiAiaHR0cDovL2FwaS5icmlkZ2VpdC5tb2JpLyIsCgkJYXV0aDogYW5vbkF1dGgKCX07CgoJLy9SZWFsIFByb21pc2Ugc3VwcG9ydCBzdGFsbGVkIGJ5IElFCglmdW5jdGlvbiBQcm9taXooKSAgewoJCXZhciB0aGVQcm9taXogPSB0aGlzOwoJCXZhciBzdWNjZXNzZXMgPSBbXTsKCQl2YXIgZmFpbHMgPSBbXTsKCQl0aGlzLnRoZW4gPSBmdW5jdGlvbihzdWNjZXNzLCBmYWlsKSAgewoJCQlpZiAoc3VjY2VzcykgIHsKCQkJCXN1Y2Nlc3Nlcy5wdXNoKHN1Y2Nlc3MpOwoJCQl9CgkJCWlmIChmYWlsKSAgewoJCQkJZmFpbHMucHVzaChmYWlsKTsKCQkJfQoJCX0KCQlmdW5jdGlvbiBjYWxsYWxsKGZ1bmNzLCBhcmdzKSAgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGZ1bmNzLmxlbmd0aDsgaSsrKSB7CgkJCQlmdW5jc1tpXS5hcHBseSh0aGVQcm9taXosIGFyZ3MpOwoJCQl9CgkJfQoJCXRoaXMucmVzb2x2ZSA9IGZ1bmN0aW9uKCkgIHsKCQkJY2FsbGFsbChzdWNjZXNzZXMsIGFyZ3VtZW50cyk7CgkJCXRoZVByb21pei50aGVuID0gZnVuY3Rpb24oc3VjY2VzcywgZmFpbCkgIHsKCQkJCXN1Y2Nlc3MuYXBwbHkodGhlUHJvbWl6LCBhcmd1bWVudHMpOwoJCQl9CgkJfQoJCXRoaXMucmVqZWN0ID0gZnVuY3Rpb24oKSAgewoJCQljYWxsYWxsKGZhaWxzLCBhcmd1bWVudHMpOwoJCQl0aGVQcm9taXoudGhlbiA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGZhaWwpICB7CgkJCQlmYWlsLmFwcGx5KHRoZVByb21peiwgYXJndW1lbnRzKTsKCQkJfQoJCX0KCX0KCgoJLyogKioqKioqKioqKioqKioqKioqKioqKiogUFVCTElDICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoJLyoqCgkgKiBUaGUgdmVyc2lvbiBvZiBicmlkZ2VpdC5qcwoJICogQHByb3BlcnR5IHtTdHJpbmd9CgkgKi8KCWIudmVyc2lvbiA9ICIxLjAuNCI7CgoJLyoqCgkgKiBUaGUgbGFzdCBkZXRlY3RlZCB2ZXJzaW9uIG9mIHRqZSBCcmlkZ2VJdCBBcHAKCSAqIEBhbGlhcyBwbHVnaW4ubGFzdEFwcFZlcnNpb24KCSAqLwoJYi5sYXN0QXBwVmVyc2lvbiA9IGZ1bmN0aW9uKCkgIHsKCQlpZiAobG9jYWxTdG9yYWdlKSAgewoJCQlyZXR1cm4obG9jYWxTdG9yYWdlLmdldEl0ZW0oTEFTVFZFUlNJT05fS0VZKSk7CgkJfQoJCXJldHVybiBudWxsOwoJfTsKCgkvKioKCSAqIEFwcGxpY2F0aW9uIHByb3ZpZGVkIGNhbGxiYWNrIHRvIGRldGVjdCBCcmlkZ2VJdCBsYXVuY2ggZmFpbHVyZS4KCSAqIFRoaXMgY2FuIGJlIG92ZXJyaWRkZW4gd2l0aCBhbiBpbXBsZW1lbnRhdGlvbiB0aGF0IHByb21wdHMgdGhlCgkgKiB1c2VyIHRvIGRvd25sb2FkIEJyaWRnZUl0IGFuZCBwb3RlbnRpYWxseSBmYWxsYmFjayB3aXRoIGEgZGlmZmVyZW50CgkgKiBicm93c2VyIGNvbnRyb2wgc3VjaCBhcyBpbnB1dCBmaWxlLiAgVGhlIGRpc3BsYXllZCBkaWFsb2cgaXMgcmV0dXJuZWQKCSAqIHRvIGFsbG93IGJhc2ljIGN1c3RvbWl6YXRpb24uCgkgKgoJICogQGFsaWFzIHBsdWdpbi5sYXVuY2hGYWlsZWQKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgcGFzc2VkIHRvIHRoZSBjb21tYW5kIHRoYXQgZmFpbGVkCgkgKiBAdGVtcGxhdGUKCSAqLwoJYi5sYXVuY2hGYWlsZWQgPSBmdW5jdGlvbihpZCkgIHsKCQljb25zb2xlLmxvZygiQnJpZGdlSXQgbm90IGF2YWlsYWJsZSBmb3IgIiArIGlkKTsKCgkJdmFyIHBvcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCXBvcERpdi5zZXRBdHRyaWJ1dGUoCgkJCSJzdHlsZSIsCgkJCSJoZWlnaHQ6YXV0bzsiICsKCQkJIm1pbi1oZWlnaHQ6MTAwcHg7IiArCgkJCSJwb3NpdGlvbjpmaXhlZDsiICsKCQkJImJvcmRlcjo1cHggc29saWQgIzkxOTNBMDsiICsKCQkJImJvcmRlci1yYWRpdXM6OHB4OyIgKwoJCQkicGFkZGluZzoxMHB4OyIgKwoJCQkidGV4dC1hbGlnbjpjZW50ZXI7IiArCgkJCSJib3gtc2l6aW5nOmJvcmRlci1ib3g7IiArCgkJCSJ0b3A6IDUwcHg7IiArCgkJCSJiYWNrZ3JvdW5kLWNvbG9yOiNGOEY4Rjg7IiArCgkJCSJ0cmFuc2l0aW9uOm9wYWNpdHkgNXMgZWFzZS1pbi1vdXQ7IiArCgkJCSJ6LWluZGV4Ojk5OTsiICsKCQkJIm9wYWNpdHk6MC45NTsiKTsKCQlwb3BEaXYuaW5uZXJIVE1MID0KCQkJJzxhIHN0eWxlPSJmbG9hdDpyaWdodDsiICcrCgkJCSdvbmNsaWNrPSJkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucGFyZW50Tm9kZSkiPicrCgkJCScmdGltZXM7PC9hPicgKwoJCQknPHA+VGhlIEJyaWRnZUl0IEFwcCBpcyBtaXNzaW5nIC4uLiB3b3VsZCB5b3UgbGlrZSB0byBkb3dubG9hZCAnICsKCQkJJ2l0PzwvcD4nICsKCQkJJzxhIGhyZWY9IicgKyBicmlkZ2VpdC5hcHBTdG9yZVVSTCgpICsgJyInKwoJCQknIG9uY2xpY2s9ImRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wYXJlbnROb2RlKSIgJyArCgkJCSd0YXJnZXQ9Il9ibGFuayI+RG93bmxvYWQgdGhlIHV0aWxpdHkgYXBwIG5vdzwvYT4nOwoJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wRGl2KTsKCgkJdmFyIGNlbnRlckRpdiA9IGZ1bmN0aW9uKCl7CgkJCWlmKCB3aW5kb3cuaW5uZXJXaWR0aCApewoJCQkJdmFyIGxlZnRQb3MgPSAod2luZG93LmlubmVyV2lkdGggLSBwb3BEaXYub2Zmc2V0V2lkdGgpIC8yOwoJCQkJcG9wRGl2LnN0eWxlLmxlZnQgPSAnJytsZWZ0UG9zICsgJ3B4JzsKCQkJfQoJCX0KCQljZW50ZXJEaXYoKTsKCQlpZiggd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgKXsKCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgY2VudGVyRGl2LCBmYWxzZSk7CgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBjZW50ZXJEaXYsIGZhbHNlKTsKCQl9CgoJCXJldHVybiBwb3BEaXY7CgoJfTsKCgkvKioKCSAqIEFwcGxpY2F0aW9uIHByb3ZpZGVkIGNhbGxiYWNrIHRvIGRldGVjdCBub24tc3VwcG9ydGVkIGNsaWVudHMuCgkgKiBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIHdpdGggYW4gaW1wbGVtZW50YXRpb24gdGhhdCBpbmZvcm1zIHRoZQoJICogdXNlciB0aGUgdXNlciB0aGF0IG5hdGl2ZSBtb2JpbGUgZnVuY3Rpb25hbGl0eSBpcyBvbmx5IGF2YWlsYWJsZQoJICogb24gc3VwcG9ydGVkIHBsYXRmb3JtcyBvciBwb3RlbnRpYWxseSBmYWxsYmFjayB3aXRoIGEgZGlmZmVyZW50CgkgKiBicm93c2VyIGNvbnRyb2wgc3VjaCBhcyBpbnB1dCBmaWxlLCB3aGljaCB3b3VsZCBiZSBhdmFpbGFibGUgb24KCSAqIGFsbCBicm93c2Vycy4KCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgcGFzc2VkIHRvIHRoZSBjb21tYW5kIHRoYXQgZmFpbGVkCgkgKiBAcGFyYW0ge1N0cmluZ30gY29tbWFuZCBUaGUgQnJpZGdlSXQgYXBpIGNvbW1hbmQgdGhhdCB3YXMgbGF1bmNoZWQKCSAqIEBhbGlhcyBwbHVnaW4ubm90U3VwcG9ydGVkCgkgKiBAdGVtcGxhdGUKCSAqLwoJYi5ub3RTdXBwb3J0ZWQgPSBmdW5jdGlvbihpZCwgY29tbWFuZCkgIHsKCQlhbGVydCgnU29ycnksIHRoZSBjb21tYW5kICcgKyBjb21tYW5kICsgJyBmb3IgQnJpZGdlSXQgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIHBsYXRmb3JtJyk7Cgl9OwoKCgkvKioKCSAqIExhdW5jaCB0aGUgZGV2aWNlIFFSIENvZGUgc2Nhbm5lci4KCSAqCgkgKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgc2NhbiBpcyBjYXB0dXJlZC4KCSAqIFRoZSByZXR1cm4gdmFsdWUgd2lsbCBiZSBzZXQgdG8gdGhlIHRleHQgcmVzdWx0aW5nIGZyb20gdGhlIHNjYW4uCgkgKgoJICogVGhlIFFSIENvZGUgc2Nhbm5lciBkb2VzIG5vdCBjdXJyZW50bHkgYWNjZXB0IGFkZGl0aW9uYWwgcGFyYW1ldGVycywKCSAqIGJ1dCB0aGVzZSBtYXkgdXNlZCBpbiB0aGUgZnV0dXJlLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uc2NhbgoJICogQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgcmV0dXJuIHZhbHVlCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBZGRpdGlvbmFsIGNvbW1hbmQgb3B0aW9ucwoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMucG9zdFVSTCBTZXJ2ZXItc2lkZSBVUkwgYWNjZXB0aW5nIFBPU1Qgb2YgY29tbWFuZCByZXN1bHQgKG9wdGlvbmFsKQoJICoKCSAqLwoJYi5zY2FuID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCWRldmljZUNvbW1hbmQoInNjYW4iLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCgkvKioKCSAqIERldGVjdCBuZWFyYnkgaUJlYWNvbnMuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gYW4gaUJlYWNvbiBpcyBkZXRlY3RlZC4KCSAqIFRoZSByZXR1cm4gdmFsdWUgd2lsbCBiZSBzZXQgdG8gdGhlIHJhbmdlLCBtYWpvciwgYW5kIG1pbm9yIHZhbHVlcwoJICogaWYgYXZhaWxhYmxlLgoJICoKCSAqIFRoaXMgaXMgY3VycmVudGx5IGEgcHJlLWFscGhhIGZlYXR1cmUgYW5kIGlzIGJlaW5nIGRldmVsb3BlZCBpbml0aWFsbHkKCSAqIG9uIGlPUy4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLmJlYWNvbnMKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnBvc3RVUkwgU2VydmVyLXNpZGUgVVJMIGFjY2VwdGluZyBQT1NUIG9mIGNvbW1hbmQgcmVzdWx0IChvcHRpb25hbCkKCSAqCgkgKi8KCWIuYmVhY29ucyA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJiZWFjb25zIiwgaWQsIGNhbGxiYWNrLCBvcHRpb25zKTsKCX07CgoJLyoqCgkgKiBMYXVuY2ggdGhlIG5hdGl2ZSBjYW1lcmEuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIHBob3RvIGlzIGNhcHR1cmVkLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uY2FtZXJhCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5wb3N0VVJMIFNlcnZlci1zaWRlIFVSTCBhY2NlcHRpbmcgUE9TVCBvZiBjb21tYW5kIHJlc3VsdCAob3B0aW9uYWwpCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5tYXh3aWR0aCBUaGUgbWF4aXVtIHdpZHRoIGZvciB0aGUgaW1hZ2UgaW4gcGl4ZWxzCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5tYXhoZWlnaHQgVGhlIG1heGl1bSBoZWlnaHQgZm9yIHRoZSBpbWFnZSBpbiBwaXhlbHMKCSAqCgkgKi8KCWIuY2FtZXJhID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCWRldmljZUNvbW1hbmQoImNhbWVyYSIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoJLyoqCgkgKiBMYXVuY2ggdGhlIG5hdGl2ZSB2aWRlbyByZWNvcmRlci4KCSAqCgkgKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgdmlkZW8gaGFzIGJlZW4gY2FwdHVyZWQuCgkgKgoJICogQGFsaWFzIHBsdWdpbi5jYW1jb3JkZXIKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqCgkgKi8KCWIuY2FtY29yZGVyID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCWRldmljZUNvbW1hbmQoImNhbWNvcmRlciIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCS8qKgoJICogTGF1bmNoIHRoZSBuYXRpdmUgYXVkaW8gcmVjb3JkZXIuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGF1ZGlvIGlzIGNhcHR1cmVkLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4ubWljcm9waG9uZQoJICogQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgcmV0dXJuIHZhbHVlCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBZGRpdGlvbmFsIGNvbW1hbmQgb3B0aW9ucwoJICoKCSAqLwoJYi5taWNyb3Bob25lID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCWRldmljZUNvbW1hbmQoIm1pY3JvcGhvbmUiLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCgkvKioKCSAqIExhdW5jaCB0aGUgbmF0aXZlIGNvbnRhY3QgbGlzdC4KCSAqCgkgKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgY29udGFjdCBpcyByZXRyaWV2ZWQuCgkgKgoJICogQGFsaWFzIHBsdWdpbi5mZXRjaENvbnRhY3QKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmZpZWxkcyBUaGUgY29udGFjdCBmaWVsZHMgdG8gcmV0cmlldmUsIGRlZmF1bHQgPSAibmFtZSxlbWFpbCxwaG9uZSIKCSAqCgkgKi8KCWIuZmV0Y2hDb250YWN0ID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCXZhciBvcHMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICghb3BzLmZpZWxkcykgIHsKCQkJb3BzLmZpZWxkcyA9ICJuYW1lLGVtYWlsLHBob25lIjsKCQl9CgkJZGV2aWNlQ29tbWFuZCgiZmV0Y2hDb250YWN0cyIsIGlkLCBjYWxsYmFjaywgb3BzKTsKCX07CgoJLyoqCgkgKiBTZW5kIGFuIFNNUyBtZXNzYWdlLgoJICoKCSAqIFRoZSBzbXMgZnVuY3Rpb24gd2lsbCBzZW5kIGFuIFNNUyBtZXNzYWdlIHRvIGEgbnVtYmVyIG9uIHN1cHBvcnRlZAoJICogcGxhdGZvcm1zLiBPbiBpT1MgZGV2aWNlcywgYSBuYXRpdmUgU01TIGNhbGwgaXMgbWFkZSB0aHJvdWdoIHRoZQoJICogQnJpZGdlSXQgdXRpbGl0eSBhcHAuIE9uIG90aGVyIHBsYXRmb3JtcyBhbiBTTVMgVVJMIHByb3RvY29sIGlzIHVzZWQgaW4gYQoJICogRE9NIGFuY2hvciBlbGVtZW50LCB3aGljaCB0aGUgYnJvd3NlciBtYXkgdXNlIHRvIGxhdW5jaCB0aGUgZGV2aWNlCgkgKiBTTVMgZnVuY3Rpb25hbGl0eSwgaWYgYXZhaWxhYmxlLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uc21zCgkgKiBAcGFyYW0ge1N0cmluZ30gbnVtYmVyIFRoZSBwaG9uZSBudW1iZXIgdG8gc2VuZCB0aGUgbWVzc2FnZSB0bwoJICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UKCSAqCgkgKi8KCWIuc21zID0gZnVuY3Rpb24obnVtYmVyLCBtZXNzYWdlKSAgewoJCWlmKCAhYi5pc1N1cHBvcnRlZFBsYXRmb3JtKCdzbXMnKSApewoJCQliLm5vdFN1cHBvcnRlZChudWxsLCAnc21zJyk7CgkJCXJldHVybjsKCQl9CgkJaWYoIG51bWJlciA9PSAndW5kZWZpbmVkJyB8fCBudW1iZXIgPT0gJycpCgkJCXJldHVybjsKCQlpZiggYi5pc0lPUygpIHx8IGIuaXNBbmRyb2lkKCkgKXsKCQkJZGV2aWNlQ29tbWFuZCgnc21zJywgJ19zbXMnLCBudWxsLCB7bjogbnVtYmVyLCBib2R5OiBtZXNzYWdlfSk7CgkJfQoJCWVsc2V7CgkJCXZhciBzbXNCdG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CgkJCXZhciBjbGVhbk51bWJlciA9IG51bWJlci5yZXBsYWNlKC9bXHMtXC5cK10vZywnJyk7CgkJCXNtc0J0bi5ocmVmID0gJ3NtczorJyArIGNsZWFuTnVtYmVyICsgJz9ib2R5PScgKyBlbmNvZGVVUkkobWVzc2FnZSk7CgkJCXNtc0J0bi5zdHlsZSA9ICdkaXNwbGF5Om5vbmUnOwoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNtc0J0bik7CgkJCXNtc0J0bi5jbGljaygpOwoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHNtc0J0bik7CgkJIH0KCX07CgoJLyoqCgkgKiBMYXVuY2ggYW4gQXVnbWVudGVkIFJlYWxpdHkgdmlldy4KCSAqCgkgKiBUaGUgQXVnbWVudGVkIFJlYWxpdHkgdmlldyBkaXNwbGF5cyBhIHNldCBvZiBnZW9ncmFwaGljIGljb25zIG9uCgkgKiBhIHZpZGVvIG92ZXJsYXkuIFRoZSBpY29ucyBhcmUgcG9zaXRpb25lZCBhY2NvcmRpbmcgdG8gdGhlCgkgKiBvcmllbnRhdGlvbiBvZiB0aGUgZGV2aWNlIHNvIHRoYXQgdGhleSBhcHBlYXIgaW4gYSBsaW5lLW9mLXNpZ2h0CgkgKiB3aXRoIHRoZWlyIHBoeXNpY2FsIGdlb2dyYXBoaWMgcG9zaXRpb24uICBUaGUgdXNlciBjYW4gc2VsZWN0IGFuCgkgKiBpY29uIGFuZCB0aGlzIGlzIHJlbGF5ZWQgYmFjayB0byB0aGUgYXBwbGljYXRpb24uCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGF1Z21lbnRlZCByZWFsaXR5CgkgKiB2aWV3IGV4aXRzIHdpdGggdGhlIHVzZXIgc2VsZWN0aW9uIHByb3ZpZGVkIGluIHRoZSByZXR1cm4gdmFsdWUuCgkgKiBUaGUgY29tbWFuZCBpcyBpbnZva2VkIHdpdGggYSBsb2NhdGlvbnMgcGFyYW1ldGVyIGNvbnRhaW5pbmcgYW4KCSAqIGFycmF5IG9mIG5hbWVkIGxvY2F0aW9ucywgZWFjaCB3aXRoIGEgY29tbWEtc2VwYXJhdGVkIGxhdGl0dWRlLAoJICogbG9uZ2l0dWRlLCBhbHRpdHVkZSwgZGlyZWN0aW9uLCBhbmQgaWNvbiBVUkwKCSAqCgkgKiBAYWxpYXMgcGx1Z2luLmF1Z21lbnRlZFJlYWxpdHkKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmxvY2F0aW9ucyBUaGUgYXVnbWVudGVkIHJlYWxpdHkgbG9jYXRpb25zIHRvIGRpc3BsYXkKCgkgKgoJICovCgliLmF1Z21lbnRlZFJlYWxpdHkgPSBmdW5jdGlvbihpZCwgY2FsbGJhY2ssIG9wdGlvbnMpICB7CgkJLy9jb3B5IGxvY2F0aW9ucyBkaXJlY3RseSBpbnRvIG9wdGlvbnMuIFRoZSBKYXZhU2NyaXB0IEFQSQoJCS8vd2lsbCBub3QgY2hhbmdlLCBidXQgdGhlIGZ1dHVyZSBkZXZpY2VDb21tYW5kIHdpbGwgYWNjZXB0CgkJLy90aGUgbG9jYXRpb25zIGFzIGEgc3VicGFyYW1ldGVyIHRvIGF2b2lkIHRoaXMgY29weWluZwoJCWlmICghYnJpZGdlaXQudXNlSlNPTjY0ICYmIG9wdGlvbnMgJiYgb3B0aW9ucy5sb2NhdGlvbnMpICB7CgkJCWZvciAodmFyIGtleSBpbiBvcHRpb25zLmxvY2F0aW9ucykgIHsKCQkJCWlmIChyZXNlcnZlZFBhcmFtcy5pbmRleE9mKGtleSkgPCAwKSAgewoJCQkJCW9wdGlvbnNba2V5XSA9IG9wdGlvbnMubG9jYXRpb25zW2tleV07CgkJCQl9CgkJCX0KCQkJZGVsZXRlIG9wdGlvbnMubG9jYXRpb25zOwoJCX0KCgkJZGV2aWNlQ29tbWFuZCgiYXVnIiwgaWQsIGNhbGxiYWNrLCBvcHRpb25zKTsKCX07CgoJLyoqCgkgKiBBY3RpdmF0ZSBsb2NhdGlvbiB0cmFja2luZy4KCSAqCgkgKiBMb2NhdGlvbiB0cmFja2luZyB3aWxsIHJ1biBpbiB0aGUKCSAqIGJhY2tncm91bmQgYWNjb3JkaW5nIHRvIHRoZSBzcGVjaWZpZWQgc3RyYXRlZ3kgYW5kIGR1cmF0aW9uLCBhbmQgd2lsbCBQT1NUCgkgKiBhIGdlb0pTT04gcmVjb3JkIHRvIHRoZSBzcGVjaWZpZWQgcG9zdFVSTC4KCSAqCgkgKiBUaHJlZSBzdHJhdGVnaWVzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOiAiY29udGludW91cyIgd2hlcmUgdGhlIGxvY2F0aW9uCgkgKiBvZiB0aGUgZGV2aWNlIHdpbGwgYmUgdXBsb2FkZWQgYXMgZnJlcXVlbnRseSBhcyBpdCBjaGFuZ2VzIChpbnRlbmRlZCBmb3IKCSAqIHRlc3Rpbmcgb25seSBkdWUgdG8gaGlnaCBwb3dlciBjb25zdW1wdGlvbiksICJzaWduaWZpY2FudCIgd2hlcmUgdGhlCgkgKiBsb2NhdGlvbiBpcyB1cGxvYWRlZCB3aGVuIGl0IGNoYW5nZXMgc2lnbmlmaWNhbnRseSwgYW5kICJzdG9wIiB0byBjZWFzZQoJICogbG9jYXRpb24gdHJhY2tpbmcuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgbG9jYXRpb24gdHJhY2tpbmcgaXMgYWN0aXZhdGVkLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnBvc3RVUkwgVGhlIFVSTCBhY2NlcHRpbmcgdGhlIGdlb0pTT04gUE9TVAoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuc3RyYXRlZ3kgVGhlIHN0cmF0ZWd5LCAiY29udGludW91cyIsICJzaWduaWZpY2FudCIgb3IgInN0b3AiCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5kdXJhdGlvbiBUaGUgZHVyYXRpb24gaW4gaG91cnMKCSAqIEBhbGlhcyBwbHVnaW4uZ2VvVHJhY2sKCSAqCgkgKi8KCWIuZ2VvVHJhY2sgPSBmdW5jdGlvbihpZCwgY2FsbGJhY2ssIG9wdGlvbnMpICB7CgkJZGV2aWNlQ29tbWFuZCgiZ2Vvc3B5IiwgaWQsIGNhbGxiYWNrLCBvcHRpb25zKTsKCX07CgoJLyoqCgkgKiBSZWdpc3RlciBCcmlkZ2VJdCBpbnRlZ3JhdGlvbiBhbmQgY29uZmlndXJlIENsb3VkIFB1c2guCgkgKgoJICogVGhpcyBjYWxsIGlzIG5lY2Vzc2FyeSB0byBvYnRhaW4gdGhlIENsb3VkIFB1c2ggSUQgb2YgdGhlCgkgKiBkZXZpY2Ugc28gdGhhdCBub3RpZmljYXRpb25zIGNhbiBiZSBkZWxpdmVyZWQgd2hlbiB0aGUKCSAqIHVzZXIgaXMgbm90IGN1cnJlbnRseSB2aWV3aW5nIHlvdXIgYXBwbGljYXRpb24gaW4gdGhlIGJyb3dzZXIuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gQ2xvdWQgUHVzaCByZWdpc3RyYXRpb24KCSAqIGNvbXBsZXRlcy4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLnJlZ2lzdGVyCgkgKiBAaW5oZXJpdGRvYyAjc2NhbgoJICoKCSAqLwoJYi5yZWdpc3RlciA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJyZWdpc3RlciIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCS8qKgoJICogVmVyaWZ5IHRoYXQgQnJpZGdlSXQgQ2xvdWQgUHVzaCBpcyByZWdpc3RlcmVkLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uaXNSZWdpc3RlcmVkCgkgKgoJICovCgliLmlzUmVnaXN0ZXJlZCA9IGZ1bmN0aW9uKCkgIHsKCQlyZXR1cm4gISEoZ2V0Q2xvdWRQdXNoSWQoKSk7Cgl9OwoKCS8qKgoJICogVGV4dC10by1zcGVlY2gKCSAqCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgcmV0dXJuIHZhbHVlCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBZGRpdGlvbmFsIGNvbW1hbmQgb3B0aW9ucwoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMudGV4dCBUaGUgdGV4dCB0byBiZSBzcG9rZW4KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gb3B0aW9ucy5yZXNwb25kIERldGVybWluZXMgaWYgdm9pY2UgcmVzcG9uc2UgaXMgcmVxdWlyZWQuIGRlZmF1bHQ9ZmFsc2UKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnZvaWNlIFR5cGUgb2Ygdm9pY2UgdG8gYmUgdXNlZAoJICogQHBhcmFtIHtOdW1iZXJ9IG9wdGlvbnMucmF0ZSBUaGUgcmF0ZSBvZiBzcGVha2luZy4gPiAwIGRlZmF1bHQ9MS4wCgkgKiBAcGFyYW0ge051bWJlcn0gb3B0aW9ucy5waXRjaCBUaGUgIHBpdGNoIG9mIHZvaWNlLiA+IDAgZGVmYXVsdD0xLjIKCSAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLnZvbHVtZSBUaGUgIDAuMCA8IHZvbHVtZSA8PTEuMCBkZWZhdWx0PWRldmljZSBzZXR0aW5nCgkgKiBAYWxpYXMgcGx1Z2luLnNwZWVjaAoJICoKCSAqLwoJYi5zcGVlY2ggPSBmdW5jdGlvbihpZCwgY2FsbGJhY2ssIG9wdGlvbnMpewoJCWRldmljZUNvbW1hbmQoInNwZWVjaCIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCgoJLyoqCgkgKiBVdGlsaXR5IG1ldGhvZCB0byB1bnBhY2sgdXJsLWVuY29kZWQgcGFyYW1ldGVycyBpbnRvIGFuIG9iamVjdC4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLnVybDJPYmplY3QKCSAqIEBwYXJhbSB7U3RyaW5nfSBlbmNvZGVkIFRoZSBlbmNvZGVkIFVSTCBzdHJpbmcgdG8gdW5wYWNrCgkgKi8KCWIudXJsMk9iamVjdCA9IGZ1bmN0aW9uKGVuY29kZWQpICB7CgkJcmV0dXJuIHVybDJPYmplY3QoZW5jb2RlZCk7Cgl9OwoKCS8qKgoJICogU2V0IGFsbG93QW5vbnltb3VzQ2FsbGJhY2tzIHRvIHRydWUgdG8gdGFrZSBhZHZhbnRhZ2Ugb2YgcGVyc2lzdGVudAoJICogY2FsbGJhY2sgZnVuY3Rpb25zIGN1cnJlbnRseSBzdXBwb3J0ZWQgb24gaU9TLgoJICogQHByb3BlcnR5IHtCb29sZWFufSBbYWxsb3dBbm9ueW1vdXNDYWxsYmFja3M9ZmFsc2VdCgkgKi8KCWIuYWxsb3dBbm9ueW1vdXNDYWxsYmFja3MgPSBmYWxzZTsKCgkvKioKCSAqIFNldCB1c2VKU09ONjQgdG8gdHJ1ZSB0byB0YWtlIGFkdmFudGFnZSBvZiBCYXNlNjQgSlNPTgoJICogZGF0YSBpbnRlcmNoYW5nZSBiZXR3ZWVuIHRoZSBicm93c2VyIGFuZCBCcmlkZ2VJdCBBcHAuCgkgKiBUaGlzIHByb3BlcnR5IG1heSBiZSByZW1vdmVkIGFuZCBiZWNvbWUgdGhlIGRlZmF1bHQgd2l0aAoJICogbGVnYWN5IGFwcGxpY2F0aW9ucyByZXF1aXJlZCB0byBpbXBvcnQgYW4gb2xkZXIgY29weSBvZiBicmlkZ2VpdC5qcy4KCSAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW3VzZUpTT042ND1mYWxzZV0KCSAqLwoJYi51c2VKU09ONjQgPSBmYWxzZTsKCgkvKioKCSAqIFNldCB1c2VCYXNlNjQgdG8gdHJ1ZSB0byB0YWtlIGFkdmFudGFnZSBvZiBCYXNlNjQKCSAqIGVuY29kaW5nIGluIHRoZSByZXR1cm4gVVJMIGZyb20gdGhlIEJyaWRnZUl0IEFwcC4KCSAqIFRoaXMgcHJvcGVydHkgbWF5IGJlIHJlbW92ZWQgd2l0aAoJICogbGVnYWN5IGFwcGxpY2F0aW9ucyByZXF1aXJlZCB0byBpbXBvcnQgYW4gb2xkZXIgY29weSBvZiBicmlkZ2VpdC5qcy4KCSAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW3VzZUJhc2U2ND10cnVlXQoJICovCgliLnVzZUJhc2U2NCA9IHRydWU7CgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIGlPUwoJICogQGFsaWFzIHBsdWdpbi5pc0lPUwoJICovCgliLmlzSU9TID0gZnVuY3Rpb24oKXsKCQl2YXIgaSA9IDAsCgkJCWlPUyA9IGZhbHNlLAoJCQlpRGV2aWNlID0gWydpUGFkJywgJ2lQaG9uZScsICdpUG9kJ107CgoJCWZvciAoIDsgaSA8IGlEZXZpY2UubGVuZ3RoIDsgaSsrICkgewoJCQlpZiggbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKGlEZXZpY2VbaV0pID4gLTEgKXsKCQkJCWlPUyA9IHRydWU7IGJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiBpT1M7Cgl9OwoKCS8qKgoJICogSXMgdGhlIGN1cnJlbnQgY2xpZW50IGFuIGlQaG9uZQoJICogQGFsaWFzIHBsdWdpbi5pc0lQaG9uZQoJICovCgliLmlzSVBob25lID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdpUGhvbmUnKSA+IC0xOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgaU9TIDYKCSAqIEBhbGlhcyBwbHVnaW4uaXNJT1M2CgkgKi8KCWIuaXNJT1M2ID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gLyhpUGFkfGlQaG9uZXxpUG9kKS4qT1MgNl8vLnRlc3QoIG5hdmlnYXRvci51c2VyQWdlbnQgKTsKCX07CgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIGlPUyA3CgkgKiBAYWxpYXMgcGx1Z2luLmlzSU9TNwoJICovCgliLmlzSU9TNyA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIC8oaVBhZHxpUGhvbmV8aVBvZCkuKk9TIDdfLy50ZXN0KCBuYXZpZ2F0b3IudXNlckFnZW50ICk7Cgl9OwoKCS8qKgoJICogSXMgdGhlIGN1cnJlbnQgYnJvd3NlciBpT1MgNwoJICogQGFsaWFzIHBsdWdpbi5pc0lPUzgKCSAqLwoJYi5pc0lPUzggPSBmdW5jdGlvbigpewoJCXJldHVybiAvKGlQYWR8aVBob25lfGlQb2QpLipPUyA4Xy8udGVzdCggbmF2aWdhdG9yLnVzZXJBZ2VudCApOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgQW5kcm9pZAoJICogQGFsaWFzIHBsdWdpbi5pc0FuZHJvaWQKCSAqLwoJYi5pc0FuZHJvaWQgPSBmdW5jdGlvbigpewoJCXJldHVybiBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkKCQkJLmluZGV4T2YoImFuZHJvaWQiKSA+IC0xOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgQW5kcm9pZAoJICogQGFsaWFzIHBsdWdpbi5pc0FuZHJvaWRGcm95bwoJICovCgliLmlzQW5kcm9pZEZyb3lvID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJBbmRyb2lkIDIuMiIpID4gLTE7Cgl9OwoKCS8qKgoJICogSXMgdGhlIGN1cnJlbnQgYnJvd3NlciBBbmRyb2lkCgkgKiBAYWxpYXMgcGx1Z2luLmlzQW5kcm9pZEdpbmdlckJyZWFkT3JHcmVhdGVyCgkgKi8KCWIuaXNBbmRyb2lkR2luZ2VyQnJlYWRPckdyZWF0ZXIgPSBmdW5jdGlvbigpewoJCXJldHVybiBiLmlzQW5kcm9pZCgpICYmICFiLmlzQW5kcm9pZEZyb3lvKCk7Cgl9OwoKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgV2luZG93cyBQaG9uZSA4CgkgKiBAYWxpYXMgcGx1Z2luLmlzV2luZG93c1Bob25lOAoJICovCgliLmlzV2luZG93c1Bob25lOCA9IGZ1bmN0aW9uKCl7CgkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCQlyZXR1cm4gdWEuaW5kZXhPZignSUVNb2JpbGUnKSA+IC0xCgkJCXx8ICggdWEuaW5kZXhPZignTVNJRSAxMCcpID4gLTEKCQkJCSYmIHR5cGVvZiB3aW5kb3cub3JpZW50YXRpb24gIT09ICd1bmRlZmluZWQnKTsKCX07CgoJdmFyIGFuZHJvaWQgPSBiLmlzQW5kcm9pZCgpLAoJCXN1cHBvcnRlZEFuZHJvaWQgPSBiLmlzQW5kcm9pZEdpbmdlckJyZWFkT3JHcmVhdGVyKCksCgkJaU9TID0gYi5pc0lPUygpLAoJCWlPUzYgPSBiLmlzSU9TNigpLAoJCWlPUzcgPSBiLmlzSU9TNygpLAoJCWlPUzggPSBiLmlzSU9TOCgpLAoJCXdwOCA9IGIuaXNXaW5kb3dzUGhvbmU4KCksCgkJaVBob25lID0gYi5pc0lQaG9uZSgpLAoJCXN1cHBvcnRNYXRyaXg7CgoJYi5jb21tYW5kcyA9IFsgJ2NhbWVyYScsICdjYW1jb3JkZXInLCdtaWNyb3Bob25lJywnZmV0Y2hDb250YWN0cycsJ2F1ZycsICdwdXNoJywnc2NhbicsJ2dlb3NweScsJ3NtcycsICAnYmVhY29ucycsICdzcGVlY2gnXTsKCXN1cHBvcnRNYXRyaXggPSB7CgkJJ2lQaG9uZSc6ewoJCQknNic6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgZmFsc2UsIHRydWUsICAgIHRydWUsICAgZmFsc2UsICAgICBmYWxzZV0sCgkJCSc3JzogICBbdHJ1ZSwgICAgIHRydWUsICAgICAgIHRydWUsICAgICAgICB0cnVlLCAgICAgICAgICAgdHJ1ZSwgIHRydWUsICB0cnVlLCAgdHJ1ZSwgICAgdHJ1ZSwgICB0cnVlLCAgICAgIHRydWVdLAoJCQknOCc6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgdHJ1ZSwgIHRydWUsICAgIHRydWUsICAgdHJ1ZSwgICAgICB0cnVlXQoJCX0sCgkJJ2lQYWQtaVBvZCc6ewoJCQknNic6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgZmFsc2UsIHRydWUsICAgIGZhbHNlLCAgZmFsc2UsICAgICBmYWxzZV0sCgkJCSc3JzogICBbdHJ1ZSwgICAgIHRydWUsICAgICAgIHRydWUsICAgICAgICB0cnVlLCAgICAgICAgICAgdHJ1ZSwgIHRydWUsICB0cnVlLCAgdHJ1ZSwgICAgZmFsc2UsICB0cnVlLCAgICAgIHRydWVdLAoJCQknOCc6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgdHJ1ZSwgIHRydWUsICAgIGZhbHNlLCAgdHJ1ZSwgICAgICB0cnVlXQoJCX0sCgkJJ3dwOCc6ICAgICBbdHJ1ZSwgICAgIHRydWUsICAgICAgIHRydWUsICAgICAgICB0cnVlLCAgICAgICAgICAgZmFsc2UsIHRydWUsICB0cnVlLCAgZmFsc2UsICAgdHJ1ZSwgICBmYWxzZSwgICAgIGZhbHNlXSwKCQknYW5kcm9pZCc6IFt0cnVlLCAgICAgdHJ1ZSwgICAgICAgdHJ1ZSwgICAgICAgIHRydWUsICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgIHRydWUsICB0cnVlLCAgICB0cnVlLCAgIGZhbHNlLCAgICAgdHJ1ZV0KCX0KCgkvKioKCSAqIFNldCB0byB0cnVlIHRvIGhhdmUgQXVnbWVudGVkIFJlYWxpdHkgKGluIGV4cGVyaW1lbnRhbCBzdGF0dXMpIGJlIHVzZWQgb24gQW5kcm9pZCAoZGVmYXVsdCBmYWxzZSkKCSAqIEBwcm9wZXJ0eSBvdmVycmlkZUF1Z21lbnRlZFJlYWxpdHlBbHBoYUxldmVsCgkgKi8KCWIub3ZlcnJpZGVBdWdtZW50ZWRSZWFsaXR5QWxwaGFMZXZlbCA9IGZhbHNlOwoKCS8qKgoJICogQ2hlY2sgaWYgdGhlIGN1cnJlbnQgYnJvd3NlciBpcyBzdXBwb3J0ZWQgYnkgdGhlIEJyaWRnZUl0IE5hdGl2ZSBNb2JpbGUgYXBwLgoJICoKCSAqIEN1cnJlbnRseSBpT1MsIEFuZHJvaWQsIGFuZCBzb21lIGZlYXR1cmVzIG9uIFdpbmRvd3MgUGhvbmUgOCBhcmUgc3VwcG9ydGVkLgoJICogQHBhcmFtIHtTdHJpbmd9IGNvbW1hbmQgVGhlIEJyaWRnZUl0IEFQSSBjb21tYW5kIHRoYXQgbWF5IG9yIG1heSBub3QgYmUgc3VwcG9ydGVkCgkgKiBAYWxpYXMgcGx1Z2luLmlzU3VwcG9ydGVkUGxhdGZvcm0KCSAqLwoJYi5pc1N1cHBvcnRlZFBsYXRmb3JtID0gZnVuY3Rpb24oY29tbWFuZCl7CgkJaWYoICdyZWdpc3RlcicgPT0gY29tbWFuZCApewoJCQlyZXR1cm4gdHJ1ZTsgLy9kbyBub3QgY2hlY2sgcGxhdGZvcm0gZm9yIGNsb3VkIHB1c2ggcmVnaXN0cmF0aW9uCgkJfQoJCXZhciBzdXBwb3J0ZWQgPSBmYWxzZTsKCQlpZiggYW5kcm9pZCApewoJCQlpZiggc3VwcG9ydGVkQW5kcm9pZCApewoJCQkJaWYoICdhdWcnID09IGNvbW1hbmQgKXsKCQkJCQlzdXBwb3J0ZWQgPSBiLm92ZXJyaWRlQXVnbWVudGVkUmVhbGl0eUFscGhhTGV2ZWw7CgkJCQl9CgkJCQllbHNlewoJCQkJCXN1cHBvcnRlZCA9IHRydWU7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSBpZiggd3A4ICl7CgkJCXJldHVybiBzdXBwb3J0TWF0cml4Wyd3cDgnXVtiLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCldOwoJCX0KCQllbHNlIGlmKCBpT1MgKXsKCQkJLy9pZiBhIGZ1dHVyZSBpT1MgdmVyc2lvbiByZXF1aXJlcyBzcGVjaWZpYyBjaGVja2luZywgYWRkaXRpb25hbAoJCQkvL2Nhc2VzIHdpbGwgYmUgYWRkZWQKCQkJaWYoIGlQaG9uZSApewoJCQkJaWYoIGlPUzYgKXsKCQkJCQlyZXR1cm4gc3VwcG9ydE1hdHJpeFsnaVBob25lJ11bJzYnXVtiLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCldOwoJCQkJfQoJCQkJZWxzZSAvKiBpZiggaU9TNyApICovIHsKCQkJCQlyZXR1cm4gc3VwcG9ydE1hdHJpeFsnaVBob25lJ11bJzcnXVtiLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCldOwoJCQkJfQoJCQl9CgkJCWVsc2UgewoJCQkJaWYoIGlPUzYgKXsKCQkJCQlyZXR1cm4gc3VwcG9ydE1hdHJpeFsnaVBhZC1pUG9kJ11bJzYnXVtiLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCldOwoJCQkJfQoJCQkJZWxzZSAvKiBpZiggaU9TNyApICovIHsKCQkJCQlyZXR1cm4gc3VwcG9ydE1hdHJpeFsnaVBhZC1pUG9kJ11bJzcnXVtiLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCldOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJicmlkZ2VJdCBzdXBwb3J0ZWQgcGxhdGZvcm0gZm9yICciICsgY29tbWFuZCArICInIGNvbW1hbmQ6ICIgKyBzdXBwb3J0ZWQpOwoJCXJldHVybiBzdXBwb3J0ZWQ7Cgl9OwoKCS8qKgoJICogUmV0dXJucyB0aGUgYXBwIHN0b3JlIFVSTCB0byBCcmlkZ2VJdCBmb3IgdGhlIGFwcHJvcGlyYXRlIHBsYXRmb3JtCgkgKiBAYWxpYXMgcGx1Z2luLmFwcFN0b3JlVVJMCgkgKi8KCWIuYXBwU3RvcmVVUkwgPSBmdW5jdGlvbigpewoJCWlmKCBiLmlzQW5kcm9pZCgpICkgewoJCQlyZXR1cm4gJ2h0dHBzOi8vcGxheS5nb29nbGUuY29tL3N0b3JlL2FwcHMvZGV0YWlscz9pZD1tb2JpLmJyaWRnZWl0JzsKCQl9CgkJZWxzZSBpZiggYi5pc0lPUygpICkgewoJCQlyZXR1cm4gJ2h0dHBzOi8vaXR1bmVzLmFwcGxlLmNvbS9hcHAvYnJpZGdlaXQvaWQ3Mjc3MzY0MTQnOwoJCX0KCQllbHNlIGlmKCBiLmlzV2luZG93c1Bob25lOCgpICkgewoJCQlyZXR1cm4gJ2h0dHA6Ly93aW5kb3dzcGhvbmUuY29tL3M/YXBwSWQ9YjlhMWIyOWYtMmIzMC00ZTVkLTliZjEtZjc1ZTc3M2Q3NGUxJzsKCQl9CgoJfTsKCgl2YXIgamd1aWQ7CgoJLyoqCgkgKiBSZXR1cm5zIGEgcGVyc2lzdGVudCBpZCB0aGF0IGFsbG93cyBhbiBhcHBsaWNhdGlvbiB0byBwZXJzaXN0ZW50bHkgbWFpbnRhaW4gaW5mb3JtYXRpb24gZm9yCgkgKiBhbiBpbmRpdmlkdWFsIHVzZXIgd2l0aG91dCByZXF1aXJpbmcgYSBzZXJ2ZXItc2lkZSBzZXNzaW9uLgoJICogQGFsaWFzIHBsdWdpbi5nZXRJZAoJICovCgliLmdldElkID0gZnVuY3Rpb24oKSAgewoJCXZhciBKR1VJRF9LRVkgPSAiYnJpZGdlaXQuamd1aWQiOwoJCWlmICghamd1aWQpICB7CgkJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCQlqZ3VpZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEpHVUlEX0tFWSk7CgkJCX0KCQkJaWYgKCFqZ3VpZCkgIHsKCQkJCWpndWlkID0gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLAoJCQkJCWZ1bmN0aW9uKGMpIHsKCQkJCQkJdmFyIHIgPSBNYXRoLnJhbmRvbSgpKjE2fDAsIHYgPSBjID09ICd4JyA/IHIgOiAociYweDN8MHg4KTsKCQkJCQkJcmV0dXJuIHYudG9TdHJpbmcoMTYpOwoJCQkJCX0pOwoJCQkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbShKR1VJRF9LRVksIGpndWlkKTsKCQkJCX0KCQkJfQoKCQl9CgkJcmV0dXJuIGpndWlkOwoJfQoJLyoqCgkgKiBTZXQgZ29CcmlkZ2VJdFVSTCB0byB0aGUgVVJMIG9mIHlvdXIgZ29CcmlkZ2VJdC5odG1sIGZpbGUKCSAqIHRvIGFsbG93IHtAbGluayBicmlkZ2VpdCNwdXNoIENsb3VkIFB1c2h9IHRvIGdvIGJhY2sgdG8gdGhlIG1vc3QgcmVjZW50IHBhZ2UKCSAqIFRoZSBkZWZhdWx0cyBvZiB0aGUgaG9zdCByb290IGFuZCB0aGUgY3VycmVudCByZWxhdGl2ZQoJICogZGlyZWN0b3J5IFVSTCBkbyBub3QgbmVlZCB0byBiZSBzcGVjaWZpZWQuIEZvciBhbiBleGFtcGxlLCBzZWUKCSAqIGh0dHA6Ly9icmlkZ2VpdC5tb2JpL2RlbW8vZ29CcmlkZ2VJdC5odG1sCgkgKgoJICogQHByb3BlcnR5IHtTdHJpbmd9IFtnb0JyaWRnZUl0VVJMXQoJICovCgliLmdvQnJpZGdlSXRVUkwgPSBudWxsOwoKCXZhciBDTE9VRF9DQUxMQkFDS1NfS0VZID0gImJyaWRnZWl0LmNsb3VkY2FsbGJhY2tzIjsKCgkvKioKCSAqIFB1YmxpYyBjYWxsYmFjayB1c2VkIGJ5IENsb3VkIFB1c2ggaW1wbGVtZW50YXRpb24KCSAqIHRvIHJlbGF5IHB1c2ggZXZlbnQgdG8gYSBuZXdseSBvcGVuZWQgYnJvd3NlciB3aW5kb3cuCgkgKiBUaGlzIEFQSSBpcyBub3QgZm9yIGFwcGxpY2F0aW9uIHVzZS4KCSAqIEBhbGlhcyBwbHVnaW4uaGFuZGxlQ2xvdWRQdXNoCgkgKiBAcHJpdmF0ZQoJICovCgliLmhhbmRsZUNsb3VkUHVzaCA9IGZ1bmN0aW9uICgpICB7CgkJdmFyIGNhbGxiYWNrcyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKENMT1VEX0NBTExCQUNLU19LRVkpOwoJCXZhciBwYXJ0cyA9IGNhbGxiYWNrcy5zcGxpdCgiICIpOwoJCXZhciBjYWxsYmFjazsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CgkJCWNhbGxiYWNrID0gZ2V0TmFtZWRPYmplY3QocGFydHNbaV0pOwoJCQlpZiAoY2FsbGJhY2spIHsKCQkJCWNhbGxiYWNrKCk7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJICogQnJpZGdlSXQgU2VydmljZXMgbG9naW4uCgkgKiBAYWxpYXMgbG9naW4KCSAqIEBwYXJhbSB1c2VybmFtZSBVc2VyIG5hbWUKCSAqIEBwYXJhbSBwYXNzd29yZCBVc2VyIHBhc3N3b3JkCgkgKiBAcGFyYW0gb3B0aW9ucyBBZGRpdGlvbmFsIG9wdGlvbnMKCSAqLwoJYi5sb2dpbiA9IGZ1bmN0aW9uKHVzZXJuYW1lLCBwYXNzd29yZCwgb3B0aW9ucykgewoJCXZhciBhdXRoID0gbmV3IFByb21peigpOwoKCQlvcHRpb25zID0gb3ZlcmxheU9wdGlvbnMoYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMsIG9wdGlvbnMpOwoJCS8vbmVlZCB0byBhbHNvIGFsbG93IHNwZWNpZmllZCBhdXRoIFVSTCBpbiBvcHRpb25zCgkJdmFyIHVyaSA9IGJyaWRnZWl0U2VydmljZURlZmF1bHRzLnNlcnZpY2VCYXNlICsgIi9hdXRoLyI7CgkJdmFyIGxvZ2luVVJJID0gdXJpICsgb3B0aW9ucy5hY2NvdW50ICsgIi9yZWFsbXMvIiArIG9wdGlvbnMucmVhbG0gKyAiL3Rva2VuIjsKCQl2YXIgbG9naW5SZXF1ZXN0ID0gewoJCQl1c2VybmFtZTogdXNlcm5hbWUsCgkJCXBhc3N3b3JkOiBwYXNzd29yZAoJCX0KCQlqc29uUE9TVChsb2dpblVSSSwgbG9naW5SZXF1ZXN0KS50aGVuKAoJCQlmdW5jdGlvbihqc29uUmVzdWx0KSB7CgkJCQlhZGRPcHRpb25zKGF1dGgsIGpzb25SZXN1bHQpOwoJCQkJYXV0aC5yZXNvbHZlKGF1dGgpOwoJCQl9LAoJCQlmdW5jdGlvbihlcnIpIHsKCQkJCWF1dGgucmVqZWN0KGVycik7CgkJCX0KCQkpOwoKCQkvL3NhdmUgZGVmYXVsdCBhdXRob3JpemF0aW9uIGlmIGRlZmF1bHQgcmVhbG0KCQlpZiAob3B0aW9ucy5hY2NvdW50ID09IGJyaWRnZWl0U2VydmljZURlZmF1bHRzLmFjY291bnQgJiYgb3B0aW9ucy5yZWFsbSA9PT0gYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMucmVhbG0pICB7CgkJCWJyaWRnZWl0U2VydmljZURlZmF1bHRzLmF1dGggPSBhdXRoOwoJCX0KCQlyZXR1cm4gYXV0aDsKCX0KCgkvKioKCSAqIFNldCB1cCBCcmlkZ2VJdCBTZXJ2aWNlcy4KCSAqIEBhbGlhcyB1c2VTZXJ2aWNlcwoJICogQHBhcmFtIHBhcmFtIG9iamVjdCB3aXRoIG5hbWVkIHBhcmFtZXRlcnMKCSAqLwoJYi51c2VTZXJ2aWNlcyA9IGZ1bmN0aW9uKHBhcmFtKSB7CgkJaWYgKCJvYmplY3QiID09PSB0eXBlb2YgYXJndW1lbnRzWzBdKSAgewoJCQlicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cyA9CgkJCQkJb3ZlcmxheU9wdGlvbnMoYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMsIHBhcmFtKTsKCQl9Cgl9CgoJLyoqCgkgKiBDb25maWd1cmUgUHVzaCBzZXJ2aWNlIGFuZCBjb25uZWN0IHRvIGl0LgoJICogQGFsaWFzIHBsdWdpbi51c2VQdXNoU2VydmljZQoJICogQHBhcmFtIHVyaSB0aGUgbG9jYXRpb24gb2YgdGhlIHNlcnZpY2UKCSAqIEBwYXJhbSBhcGlrZXkKCSAqLwoJYi51c2VQdXNoU2VydmljZSA9IGZ1bmN0aW9uKHVyaSwgYXBpa2V5LCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG92ZXJsYXlPcHRpb25zKGJyaWRnZWl0U2VydmljZURlZmF1bHRzLCBvcHRpb25zKTsKCgkJaWYgKDAgPT0gYXJndW1lbnRzLmxlbmd0aCkgIHsKCQkJdXJpID0gYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMuc2VydmljZUJhc2UgKyAiL3B1c2giOwoJCX0gZWxzZSBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBhcmd1bWVudHNbMF0pICB7CgkJCWlmICghIWFyZ3VtZW50c1swXS5hY2NvdW50KSAgewoJCQkJYWNjb3VudCA9IGFyZ3VtZW50c1swXS5hY2NvdW50OwoJCQl9CgkJCWlmICghIWFyZ3VtZW50c1swXS5yZWFsbSkgIHsKCQkJCXJlYWxtID0gYXJndW1lbnRzWzBdLnJlYWxtOwoJCQl9CgkJCWlmICghIWFyZ3VtZW50c1swXS5zZXJ2aWNlQmFzZSkgIHsKCQkJCXVyaSA9IGFyZ3VtZW50c1swXS5zZXJ2aWNlQmFzZSArICIvcHVzaCI7CgkJCX0KCQkJaWYgKCEhYXJndW1lbnRzWzBdLmF1dGgpICB7CgkJCQlhdXRoID0gYXJndW1lbnRzWzBdLmF1dGg7CgkJCX0KCQl9IGVsc2UgewoJCQkvL2xlZ2FjeSB1cmksYXBpa2V5CgkJfQoKCQlicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cy5hdXRoLnRoZW4oZnVuY3Rpb24oKSB7CgkJCWxvYWRQdXNoU2VydmljZSh1cmksIGFwaWtleSwgb3B0aW9ucyk7CgkJfSk7Cgl9OwoKCS8qKgoJICogQWRkIGxpc3RuZXIgZm9yIG5vdGlmaWNhdGlvbnMgYmVsb25naW5nIHRvIHRoZSBzcGVjaWZpZWQgZ3JvdXAuCgkgKiBDYWxsYmFja3MgbXVzdCBiZSBwYXNzZWQgYnkgbmFtZSB0byByZWNlaXZlIGNsb3VkIHB1c2ggbm90aWZpY2F0aW9ucywKCSAqIHJlZ2FyZGxlc3Mgb2YgYnJpZGdlaXQuYWxsb3dBbm9ueW1vdXNDYWxsYmFja3Mgc2V0dGluZwoJICogQHBhcmFtIGdyb3VwCgkgKiBAcGFyYW0gY2FsbGJhY2sKCSAqIEBhbGlhcyBwbHVnaW4uYWRkUHVzaExpc3RlbmVyCgkgKi8KCWIuYWRkUHVzaExpc3RlbmVyID0gZnVuY3Rpb24oZ3JvdXAsIGNhbGxiYWNrKSB7CgkJcHVzaFByb21pc2UudGhlbihmdW5jdGlvbigpIHsKCQkJYWRkUHVzaExpc3RlbmVySW1wbChncm91cCwgY2FsbGJhY2spOwoJCX0pOwoJfTsKCgkvKioKCSAqIEF1Z21lbnQgYSBVUkwgc28gdGhhdCBjYWxsYmFja3Mgd2lsbCBiZSBpbnZva2VkIHVwb24gQ2xvdWQgUHVzaAoJICogcmV0dXJuLgoJICogSWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnQsIHRoZSBjdXJyZW50IFVSTCBpcyB1c2VkLgoJICogQHBhcmFtIHVybAoJICogQGFsaWFzIHBsdWdpbi5jbG91ZFB1c2hSZXR1cm5VUkwKCSAqLwoJYi5jbG91ZFB1c2hSZXR1cm5VUkwgPSBmdW5jdGlvbih1cmwpIHsKCQlpZiAoIXVybCkgIHsKCQkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJCXVybCA9IGxvY2FsU3RvcmFnZVtMQVNUX1BBR0VfS0VZXTsKCQkJfQoJCX0KCQlpZiAoIXVybCkgIHsKCQkJdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJfQoJCXZhciBzZXEgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoJCXZhciB1cmxFeHRyYSA9CgkJCWJ0b2EoIiFoPSIgKyBlc2NhcGUoImM9YnJpZGdlaXQuaGFuZGxlQ2xvdWRQdXNoJnNlcT0iICsgc2VxKSk7CgkJdXJsRXh0cmEgPSB1cmxFeHRyYS5yZXBsYWNlKC89L2csIn4iKTsKCQl1cmxFeHRyYSA9IHVybEV4dHJhLnJlcGxhY2UoL1wvL2csIi4iKTsKCQl2YXIgcmV0dXJuVVJMID0gdXJsICsgIiNpY2Vtb2JpbGVzeF8iICsgdXJsRXh0cmE7CgkJcmV0dXJuIHJldHVyblVSTDsKCX07CgoJLyoqCgkgKiBQdXNoIG5vdGlmaWNhdGlvbiB0byB0aGUgZ3JvdXAuCgkgKgoJICogVGhpcyB3aWxsIHJlc3VsdCBpbiBhbiBBamF4IFB1c2ggKGFuZCBhc3NvY2lhdGVkIGNhbGxiYWNrKQoJICogdG8gYW55IHdlYiBwYWdlcyB0aGF0IGhhdmUgYWRkZWQgYSBwdXNoIGxpc3RlbmVyIHRvIHRoZQoJICogc3BlY2lmaWVkIGdyb3VwLiAgSWYgQ2xvdWQgUHVzaCBvcHRpb25zIGFyZSBwcm92aWRlZAoJICogKG9wdGlvbnMuc3ViamVjdCBhbmQgb3B0aW9ucy5kZXRhaWwpIGEgQ2xvdWQgUHVzaCB3aWxsCgkgKiBiZSBkaXNwYXRjaGVkIGFzIGEgaG9tZSBzY3JlZW4gbm90aWZpY2F0aW9uIHRvIGFueSBkZXZpY2VzCgkgKiB1bmFibGUgdG8gcmVjaWV2ZSB0aGUgQWpheCBQdXNoIHZpYSB0aGUgd2ViIHBhZ2UuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IGdyb3VwTmFtZSBUaGUgQWpheCBQdXNoIGdyb3VwIG5hbWUgdG8gcHVzaCB0bwoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0aGF0IGEgbm90aWZpY2F0aW9uIGNhbiBjYXJyeQoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuc3ViamVjdCBUaGUgc3ViamVjdCBoZWFkaW5nIGZvciB0aGUgbm90aWZpY2F0aW9uCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5tZXNzYWdlIFRoZSBtZXNzYWdlIHRleHQgdG8gYmUgc2VudCBpbiB0aGUgbm90aWZpY2F0aW9uIGJvZHkKCSAqIEBhbGlhcyBwbHVnaW4ucHVzaAoJICovCgliLnB1c2ggPSBmdW5jdGlvbihncm91cE5hbWUsIG9wdGlvbnMpIHsKCQlpZiAoIWFic29sdXRlR29CcmlkZ2VJdFVSTCkgIHsKCQkJaWYgKCEhYnJpZGdlaXQuZ29CcmlkZ2VJdFVSTCkgIHsKCQkJCWFic29sdXRlR29CcmlkZ2VJdFVSTCA9IGdldEFic29sdXRlVVJMKGJyaWRnZWl0LmdvQnJpZGdlSXRVUkwpOwoJCQl9CgkJfQoJCWlmICghIWFic29sdXRlR29CcmlkZ2VJdFVSTCkgIHsKCQkJaWYgKG9wdGlvbnMgJiYgIW9wdGlvbnMudXJsKSAgewoJCQkJb3B0aW9ucy51cmwgPSBhYnNvbHV0ZUdvQnJpZGdlSXRVUkw7CgkJCX0KCQl9CgkJaWYgKGljZSAmJiBpY2UucHVzaCAmJiBpY2UucHVzaC5jb25maWd1cmF0aW9uLmNvbnRleHRQYXRoKSB7CgkJCWNvbnNvbGUubG9nKCJicmlkZ2VpdC5wdXNoICIgKyBKU09OLnN0cmluZ2lmeShvcHRpb25zKSk7CgkJCWlmIChvcHRpb25zICYmIG9wdGlvbnMuZGVsYXkpICB7CgkJCQlpY2UucHVzaC5ub3RpZnkoZ3JvdXBOYW1lLCBvcHRpb25zLCBvcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCWljZS5wdXNoLm5vdGlmeShncm91cE5hbWUsIG9wdGlvbnMpOwoJCQl9CgkJfSBlbHNlIHsKCQkJY29uc29sZS5lcnJvcignUHVzaCBzZXJ2aWNlIGlzIG5vdCBhY3RpdmUnKTsKCQl9Cgl9OwoKCS8qKgoJICogUHVzaCBub3RpZmljYXRpb24gdG8gb25lIG9yIG1vcmUgZ3JvdXBzIHJlc3VsdGluZyBmcm9tIGEKCSAqIHF1ZXJ5IHRvIHRoZSBEb2MgU2VydmljZS4gIFRoZSBxdWVyeSBpcyB0byBiZSBpbiBNb25nb0RCCgkgKiBmb3JtYXQuCgkgKgoJICogVGhpcyB3aWxsIHJlc3VsdCBpbiBhbiBBamF4IFB1c2ggKGFuZCBhc3NvY2lhdGVkIGNhbGxiYWNrKQoJICogdG8gYW55IHdlYiBwYWdlcyB0aGF0IGhhdmUgYWRkZWQgYSBwdXNoIGxpc3RlbmVyIHRvIGEgZ3JvdXAKCSAqIHRoYXQgcmVzdWx0ZWQgZnJvbSB0aGUgcXVlcnkgc2VudCB0byB0aGUgRG9jIFNlcnZpY2UuICBJZgoJICogQ2xvdWQgUHVzaCBvcHRpb25zIGFyZSBwcm92aWRlZCAob3B0aW9ucy5zdWJqZWN0IGFuZAoJICogb3B0aW9ucy5kZXRhaWwpIGEgQ2xvdWQgUHVzaCB3aWxsIGJlIGRpc3BhdGNoZWQgYXMgYSBob21lCgkgKiBzY3JlZW4gbm90aWZpY2F0aW9uIHRvIGFueSBkZXZpY2VzIHVuYWJsZSB0byByZWNlaXZlIHRoZQoJICogQWpheCBQdXNoIHZpYSB0aGUgd2ViIHBhZ2UuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IGRvY1NlcnZpY2VRdWVyeSBUaGUgcXVlcnkgdG8gYmUgc2VudCB0byB0aGUgRG9jIFNlcnZpY2UuCgkgKiBAcGFyYW0ge1N0cmluZ30gZG9jU2VydmljZUZpZWxkcyBUaGUgZmllbGRzIHRvIGJlIHNlbnQgdG8gdGhlIERvYyBTZXJ2aWNlLgoJICogQHBhcmFtIHtTdHJpbmd9IGRvY1NlcnZpY2VPcHRpb25zIFRoZSBvcHRpb25zIHRvIGJlIHNlbnQgdG8gdGhlIERvYyBTZXJ2aWNlLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0aGF0IGEgbm90aWZpY2F0aW9uIGNhbiBjYXJyeQoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuc3ViamVjdCBUaGUgc3ViamVjdCBoZWFkaW5nIGZvciB0aGUgbm90aWZpY2F0aW9uCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5tZXNzYWdlIFRoZSBtZXNzYWdlIHRleHQgdG8gYmUgc2VudCBpbiB0aGUgbm90aWZpY2F0aW9uIGJvZHkKCSAqIEBhbGlhcyBwbHVnaW4ucHVzaFF1ZXJ5CgkgKi8KIAliLnB1c2hRdWVyeSA9IGZ1bmN0aW9uKGRvY1NlcnZpY2VRdWVyeSwgZG9jU2VydmljZUZpZWxkcywgZG9jU2VydmljZU9wdGlvbnMsIG9wdGlvbnMpIHsKCQlpZiAoIWFic29sdXRlR29CcmlkZ2VJdFVSTCkgIHsKCQkJaWYgKCEhYnJpZGdlaXQuZ29CcmlkZ2VJdFVSTCkgIHsKCQkJCWFic29sdXRlR29CcmlkZ2VJdFVSTCA9IGdldEFic29sdXRlVVJMKGJyaWRnZWl0LmdvQnJpZGdlSXRVUkwpOwoJCQl9CgkJfQoJCWlmICghIWFic29sdXRlR29CcmlkZ2VJdFVSTCkgIHsKCQkJaWYgKG9wdGlvbnMgJiYgIW9wdGlvbnMudXJsKSAgewoJCQkJb3B0aW9ucy51cmwgPSBhYnNvbHV0ZUdvQnJpZGdlSXRVUkw7CgkJCX0KCQl9CgkJaWYgKGljZSAmJiBpY2UucHVzaCAmJiBpY2UucHVzaC5jb25maWd1cmF0aW9uLmNvbnRleHRQYXRoKSB7CgkJCWlmIChvcHRpb25zKSB7CgkJCQljb25zb2xlLmxvZygiYnJpZGdlaXQucHVzaCAiICsgSlNPTi5zdHJpbmdpZnkob3B0aW9ucykpOwoJCQl9CgkJCWljZS5wdXNoLm5vdGlmeVF1ZXJ5KGRvY1NlcnZpY2VRdWVyeSwgZG9jU2VydmljZUZpZWxkcywgZG9jU2VydmljZU9wdGlvbnMsIG9wdGlvbnMpOwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUuZXJyb3IoJ1B1c2ggc2VydmljZSBpcyBub3QgYWN0aXZlJyk7CgkJfQoJfTsKCgkvL2FuZHJvaWQgZnVuY3Rpb25zIGFzIGZ1bGwgcGFnZSBsb2FkCglhZGRPbkxvYWRMaXN0ZW5lcihsb2FkQ29tcGxldGUpOwoJYWRkT25Mb2FkTGlzdGVuZXIoY2hlY2tFeGVjRGV2aWNlUmVzcG9uc2UpOwogICAgbG9hZENvbXBsZXRlKCk7CgljaGVja0V4ZWNEZXZpY2VSZXNwb25zZSgpOwp9KShicmlkZ2VpdCk7Cg==",
                "body": "LyogQnJpZGdlSXQgTW9iaWxlIDEuMC41CiAqCiAqIENvcHlyaWdodCAyMDA0LTIwMTMgSUNFc29mdCBUZWNobm9sb2dpZXMgQ2FuYWRhIENvcnAuCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlCiAqIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAogKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbgogKiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyCiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UKICogZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCmlmICghd2luZG93WydpY2UnXSkgewoJd2luZG93LmljZSA9IHt9Owp9CmlmICghd2luZG93WydicmlkZ2VpdCddKSB7Cgl3aW5kb3cuYnJpZGdlaXQgPSB7fTsKCXdpbmRvdy5icmlkZ2VJdCA9IHdpbmRvdy5icmlkZ2VpdDsgLy9hbGlhcyBicmlkZ2VpdCBhbmQgYnJpZGdlSXQKfQppZiAoIXdpbmRvdy5jb25zb2xlKSB7Cgljb25zb2xlID0ge307CglpZiAoaWNlLmxvZ0luQ29udGFpbmVyKSB7CgkJY29uc29sZS5sb2cgPSBpY2UubG9nSW5Db250YWluZXI7Cgl9IGVsc2UgewoJCWNvbnNvbGUubG9nID0gZnVuY3Rpb24oKSB7CgkJfTsKCQljb25zb2xlLmVycm9yID0gZnVuY3Rpb24oKSB7CgkJfTsKCX0KfQovKioKICogVGhlIEJyaWRnZUl0IEphdmFTY3JpcHQgQVBJLiBOYXRpdmUgTW9iaWxlIGludGVncmF0aW9uIGZvciB5b3VyIHdlYiBhcHAuCiAqCiAqIEJyaWRnZUl0IHByb3ZpZGVzIGEgdmFyaWV0eSBvZiBkZXZpY2UgY29tbWFuZHMgdGhhdCBhbGxvdyBhY2Nlc3MgdG8KICogZGV2aWNlIGZlYXR1cmVzIGZyb20gSmF2YVNjcmlwdCwgYWxsIHdoaWxlIHJ1bm5pbmcgaW4gdGhlIHN0b2NrIGJyb3dzZXIKICogc3VjaCBhcyBTYWZhcmkgb3IgQ2hyb21lLiBUaGlzIGlzIG1hZGUgcG9zc2libGUgYnkgdGhlIEJyaWRnZUl0IHV0aWx0eSBhcHAKICogdGhhdCBydW5zIGFsb25nc2lkZSB0aGUgYnJvd3NlciBhbmQgaXMgYXZhaWxhYmxlIGZvciBlYWNoIG9mIHRoZSBzdXBwb3J0ZWQKICogcGxhdGZvcm1zIChjdXJyZW50bHkgQW5kcm9pZCwgaU9TLCBhbmQgV2luZG93cyBQaG9uZSA4KS4KICoKICogRm9yIGV4YW1wbGUsIGJyaWRnZWl0LmNhbWVyYSgnbXlDYW1lcmEnLCAnbXlDYWxsYmFjaycpIHdpbGwgYWxsb3cgdGhlIHVzZXIKICogdG8gdGFrZSBhIHBob3RvIGlkZW50aWZpZWQgYnkgJ215Q2FtZXJhJyBhbmQgdGhpcyB3aWxsIGJlIHJldHVybmVkIHZpYSBhbgogKiBldmVudCB0byB0aGUgZnVuY3Rpb24gbmFtZWQgbXlDYWxsYmFjay4gIEZvciB0aGUgYmVzdCBjb21wYXRpYmlsaXR5IHRoZQogKiBjYWxsYmFjayBpcyBwYXNzZWQgYnkgbmFtZSBzaW5jZSB0aGUgYnJvd3NlciBwYWdlIG1heSBiZSByZWZyZXNoZWQgd2hlbgogKiB0aGUgY2FsbGJhY2sgcmV0dXJucy4gVGhlIGNhbGxiYWNrIHdpbGwgYmUgcGFzc2VkIGFuIGV2ZW50IHdoZXJlOgogKgogKiBldmVudC5yZXNwb25zZTogSFRUUCByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgaWYgdGhlIGNvbW1hbmQgbWFrZXMgYW4gSFRUUCBQT1NUCiAqIGV2ZW50LnByZXZpZXc6IGRhdGEtdXJpIGNvbnRhaW5pbmcgYW55IHByZXZpZXcgaW1hZ2UgcmVzdWx0aW5nIGZyb20gdGhlIGNvbW1hbmQKICogZXZlbnQubmFtZTogaWQgc3BlY2lmaWVkIGluIHRoZSBjb21tYW5kIGNhbGwKICogZXZlbnQudmFsdWU6IHJldHVybiB2YWx1ZSBmcm9tIHRoZSBjb21tYW5kCiAqCiAqIE1vc3QgZGV2aWNlIGNvbW1hbmRzIGFjY2VwdCBhbiBvcHRpb25zIHBhcmFtZXRlciBvYmplY3QuICBPcHRpb25zIHN1cHBvcnRlZAogKiBieSBhIHZhcmlldHkgb2YgY29tbWFuZHMgYXJlOiBvcHRpb25zLnBvc3RVUkwgKHRoZSBVUkwgdXNlZCB0byB1cGxvYWQKICogdGhlIHJlc3VsdCBvZiB0aGUgY29tbWFuZCksIGFuZCBleHRyYSBwYXJhbWV0ZXJzCiAqIHNwZWNpZmljIHRvIHRoZSBjb21tYW5kIG1heSBiZSBhZGRlZCB0byB0aGUgb3B0aW9ucyBhcmd1bWVudC4KICoKICogQGNsYXNzIGJyaWRnZWl0CiAqLwooZnVuY3Rpb24oYikgewoKCS8qICoqKioqKioqKioqKioqKioqKioqKioqIFBSSVZBVEUgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoJZnVuY3Rpb24gc2VyaWFsaXplRm9ybShmb3JtSWQsIHR5cGVkKSB7CgkJdmFyIGZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmb3JtSWQpOwoJCXZhciBlbHMgPSBmb3JtLmVsZW1lbnRzOwoJCXZhciBsZW4gPSBlbHMubGVuZ3RoOwoJCXZhciBxU3RyaW5nID0gW107CgkJdmFyIGFkZEZpZWxkID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKCQkJdmFyIHRtcFN0ciA9ICIiOwoJCQlpZiAocVN0cmluZy5sZW5ndGggPiAwKSB7CgkJCQl0bXBTdHIgPSAiJiI7CgkJCX0KCQkJdG1wU3RyICs9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCXFTdHJpbmcucHVzaCh0bXBTdHIpOwoJCX07CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQl2YXIgZWwgPSBlbHNbaV07CgkJCWlmICghZWwuZGlzYWJsZWQpIHsKCQkJCXZhciBwcmVmaXggPSAiIjsKCQkJCWlmICh0eXBlZCkgewoJCQkJCXZhciB2dHlwZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS10eXBlIik7CgkJCQkJaWYgKHZ0eXBlKSB7CgkJCQkJCXByZWZpeCA9IHZ0eXBlICsgIi0iOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXByZWZpeCA9IGVsLnR5cGUgKyAiLSI7CgkJCQkJfQoJCQkJfQoJCQkJc3dpdGNoIChlbC50eXBlKSB7CgkJCQkJY2FzZSAnc3VibWl0JzoKCQkJCQljYXNlICdidXR0b24nOgoJCQkJCWNhc2UgJ2ZpZWxkc2V0JzoKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAndGV4dCc6CgkJCQkJY2FzZSAncGFzc3dvcmQnOgoJCQkJCWNhc2UgJ2hpZGRlbic6CgkJCQkJY2FzZSAndGV4dGFyZWEnOgoJCQkJCQlhZGRGaWVsZChwcmVmaXggKyBlbC5uYW1lLCBlbC52YWx1ZSk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3NlbGVjdC1vbmUnOgoJCQkJCQlpZiAoZWwuc2VsZWN0ZWRJbmRleCA+PSAwKSB7CgkJCQkJCQlhZGRGaWVsZChwcmVmaXggKyBlbC5uYW1lLCBlbC5vcHRpb25zW2VsLnNlbGVjdGVkSW5kZXhdLnZhbHVlKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICdzZWxlY3QtbXVsdGlwbGUnOgoJCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IGVsLm9wdGlvbnMubGVuZ3RoOyBqKyspIHsKCQkJCQkJCWlmIChlbC5vcHRpb25zW2pdLnNlbGVjdGVkKSB7CgkJCQkJCQkJYWRkRmllbGQocHJlZml4ICsgZWwubmFtZSwgZWwub3B0aW9uc1tqXS52YWx1ZSk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnY2hlY2tib3gnOgoJCQkJCWNhc2UgJ3JhZGlvJzoKCQkJCQkJaWYgKGVsLmNoZWNrZWQpIHsKCQkJCQkJCWFkZEZpZWxkKHByZWZpeCArIGVsLm5hbWUsIGVsLnZhbHVlKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQlkZWZhdWx0OgoJCQkJCQlhZGRGaWVsZChwcmVmaXggKyBlbC5uYW1lLCBlbC52YWx1ZSk7CgkJCQl9CgkJCX0KCQl9CgkJLy8gY29uY2F0ZW5hdGUgdGhlIGFycmF5CgkJcmV0dXJuIHFTdHJpbmcuam9pbigiIik7Cgl9CgoJaWYgKHdpbmRvdy5qUXVlcnkgJiYgalF1ZXJ5Lm1vYmlsZSkgIHsKCQkvL2pxdWVyeSBtb2JpbGUgaW5zaXN0cyBvbiBwYXJzaW5nIEJyaWRnZUl0IGhhc2hjaGFuZ2UgZGF0YQoJCWJyaWRnZWl0LnVzZUJhc2U2NCA9IHRydWU7OwoJfQoJZnVuY3Rpb24gZ2V0RGV2aWNlQ29tbWFuZCgpICB7CgkJdmFyIGNvbW1hbmREYXRhID0gbnVsbDsKCQl2YXIgbG9jSGFzaCA9ICIiICsgd2luZG93LmxvY2F0aW9uLmhhc2g7CgkJdmFyIGhhc2hNYXJrID0gaXNEZXZpY2VDb21tYW5kSGFzaChsb2NIYXNoKTsKCQlpZiAoaGFzaE1hcmspICB7CgkJCWNvbW1hbmREYXRhID0gbG9jSGFzaC5zdWJzdHJpbmcoaGFzaE1hcmsubGVuZ3RoICsgMSk7CgkJCXZhciBkdXBJbmRleCA9IGNvbW1hbmREYXRhLmluZGV4T2YoaGFzaE1hcmspOwoJCQlpZiAoZHVwSW5kZXggPiAwKSAgewoJCQkJY29tbWFuZERhdGEgPSBjb21tYW5kRGF0YS5zdWJzdHJpbmcoMCwgZHVwSW5kZXgpOwoJCQkJY29uc29sZS5lcnJvcigidHJpbW1lZCBjb3JydXB0ICIgKyBsb2NIYXNoICsgIiB0byAiCgkJCQkJCSsgY29tbWFuZERhdGEpOwoJCQl9CgkJfQoJCXJldHVybiBjb21tYW5kRGF0YTsKCX0KCglmdW5jdGlvbiBpc0RldmljZUNvbW1hbmRIYXNoKGZ1bGxIYXNoKSAgewoJCXZhciBzeGtleSA9ICIjaWNlbW9iaWxlc3giOwoJCWlmIChzeGtleSA9PT0gZnVsbEhhc2guc3Vic3RyaW5nKDAsIHN4a2V5Lmxlbmd0aCkpICB7CgkJCXJldHVybiBzeGtleTsKCQl9CgkJdmFyIGJya2V5ID0gIiNicmlkZ2VpdCI7CgkJaWYgKGJya2V5ID09PSBmdWxsSGFzaC5zdWJzdHJpbmcoMCwgYnJrZXkubGVuZ3RoKSkgIHsKCQkJcmV0dXJuIGJya2V5OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCgl2YXIgcmVzZXJ2ZWRQYXJhbXMgPSBbJ3Bvc3RVUkwnLCAnZWxlbWVudCcsICdmb3JtJywgJ2RldmljZUNvbW1hbmRDYWxsYmFjaycsICdjb29raWVzJ107CgoJZnVuY3Rpb24gZGV2aWNlQ29tbWFuZEV4ZWMoY29tbWFuZCwgaWQsIG9wdGlvbnMpICB7CgkJdmFyIHBheWxvYWQgPSBvcHRpb25zOwoJCWlmICghcGF5bG9hZCkgIHsKCQkJcGF5bG9hZCA9IHsgfTsKCQl9CgkJdmFyIHdpbmRvd0xvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoKCQlwYXlsb2FkLl92ZXJzaW9uID0gYnJpZGdlaXQudmVyc2lvbjsKCgkJaWYgKHBheWxvYWQucG9zdFVSTCkgIHsKCQkJdmFyIHBvc3RVUkwgPSBnZXRBYnNvbHV0ZVVSTChwYXlsb2FkLnBvc3RVUkwpOwoJCQlwYXlsb2FkLl9wb3N0VVJMID0gcG9zdFVSTDsKCQkJZGVsZXRlIHBheWxvYWQucG9zdFVSTDsKCQl9CgkJaWYgKHBheWxvYWQudWIpICB7CgkJCXBheWxvYWQuX3VybEJhc2UgPSBwYXlsb2FkLnViOwoJCQlkZWxldGUgcGF5bG9hZC51YjsKCQl9IGVsc2UgewoJCQl2YXIgYmFyVVJMID0gd2luZG93TG9jYXRpb24udG9TdHJpbmcoKTsKCQkJdmFyIGJhc2VVUkwgPQoJCQkJCWJhclVSTC5zdWJzdHJpbmcoMCwgYmFyVVJMLmxhc3RJbmRleE9mKCIvIikpICsgIi8iOwoJCQlwYXlsb2FkLl91cmxCYXNlID0gYmFzZVVSTDsKCQl9CgoJCXBheWxvYWQuX2NvbW1hbmQgPSBjb21tYW5kOwoJCXBheWxvYWQuX2lkID0gaWQ7CgkJcGF5bG9hZC5fc2VxID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgkJaWYgKHBheWxvYWQuX2NhbGxiYWNrKSAgewoJCQlpZiAoInN0cmluZyIgIT0gdHlwZW9mKHBheWxvYWQuX2NhbGxiYWNrKSkgIHsKCQkJCWlmIChicmlkZ2VpdC5hbGxvd0Fub255bW91c0NhbGxiYWNrcykgIHsKCQkJCQlwYXlsb2FkLl9jYWxsYmFjayA9ICIhYW5vbiI7CgkJCQl9IGVsc2UgIHsKCQkJCQljb25zb2xlLmVycm9yKAoJCQkJCQkiQnJpZGdlSXQgY2FsbGJhY2tzIG11c3QgYmUgbmFtZWQgaW4gd2luZG93IHNjb3BlIik7CgkJCQkJZGVsZXRlIHBheWxvYWQuX2NhbGxiYWNrOwoJCQkJfQoJCQl9CgkJfQoKCQl2YXIgcmV0dXJuVVJMID0gIiIgKyB3aW5kb3dMb2NhdGlvbjsKCQl2YXIgbGFzdEhhc2ggPSByZXR1cm5VUkwubGFzdEluZGV4T2YoIiMiKTsKCQl2YXIgdGhlSGFzaCA9ICIiOwoJCXZhciB0aGVVUkwgPSByZXR1cm5VUkw7CgkJaWYgKGxhc3RIYXNoID4gMCkgIHsKCQkJdGhlSGFzaCA9IHJldHVyblVSTC5zdWJzdHJpbmcobGFzdEhhc2gpOwoJCQl0aGVVUkwgPSByZXR1cm5VUkwuc3Vic3RyaW5nKDAsIGxhc3RIYXNoKTsKCQl9CgkJcmV0dXJuVVJMID0gdGhlVVJMICsgIiNicmlkZ2VpdCI7CgoJCXBheWxvYWQuX3JldHVyblVSTCA9IHJldHVyblVSTDsKCQlwYXlsb2FkLl9yZXN0b3JlSGFzaCA9IHRoZUhhc2g7CgoJCXBheWxvYWQuX3NwbGFzaEltYWdlVVJMID0gYnJpZGdlaXQuc3BsYXNoSW1hZ2VVUkw7CgkJcGF5bG9hZC5fc3BsYXNoSW1hZ2UgPSBicmlkZ2VpdC5zcGxhc2hJbWFnZTsKCgkJdmFyIGVuY29kZWRDb21tYW5kID0gYnRvYShKU09OLnN0cmluZ2lmeShwYXlsb2FkKSkKCQkJLnJlcGxhY2UoLz0vZywifiIpCgkJCS5yZXBsYWNlKC9cLy9nLCIuIik7CgoJCXZhciBjb21tYW5kQmFzZSA9ICJicmlkZ2VpdDoiOwoJCWlmIChiLmlzQW5kcm9pZCgpKSAgewoJCQljb21tYW5kQmFzZSA9ICJodHRwOi8vYnJpZGdlaXQubW9iaS9hbmRyb2lkL2luc3RhbGwvaW5kZXguaHRtbCMiCgkJfQoKCQl2YXIgY29tbWFuZFVSTCA9IGNvbW1hbmRCYXNlICsgZW5jb2RlZENvbW1hbmQ7CgkJY29uc29sZS5sb2coImNvbW1hbmRVUkwgIiArIGNvbW1hbmRVUkwpOwoKCQl3aW5kb3cubG9jYXRpb24gPSBjb21tYW5kVVJMOwoKCX0KCglmdW5jdGlvbiBkZXZpY2VDb21tYW5kVVJMRXhlYyhjb21tYW5kLCBpZCwgb3B0aW9ucykgIHsKCQljb25zb2xlLmxvZygiZGV2aWNlQ29tbWFuZEV4ZWMoJyIgKyBjb21tYW5kICsgIicsICciICsgaWQgKyAiLCAiICsgSlNPTi5zdHJpbmdpZnkob3B0aW9ucykpOwoJCXZhciBhbXBjaGFyID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzOCk7CgkJdmFyIHVwbG9hZFVSTDsKCQl2YXIgc2Vzc2lvbmlkOwoJCXZhciBwYXJhbXM7CgkJdmFyIGVsZW1lbnQ7CgkJdmFyIGZvcm1JRDsKCQl2YXIgY2FsbGJhY2s7CgoJCWlmIChvcHRpb25zKSAgewoJCQlpZiAob3B0aW9ucy5wb3N0VVJMKSAgewoJCQl2YXIgcG9zdFVSTCA9IGdldEFic29sdXRlVVJMKG9wdGlvbnMucG9zdFVSTCk7CgkJCQl1cGxvYWRVUkwgPSBwb3N0VVJMOwoJCQl9CgkJCXBhcmFtcyA9IHBhY2tPYmplY3Qob3B0aW9ucywgcmVzZXJ2ZWRQYXJhbXMpOwoJCQlpZiAob3B0aW9ucy5kZXZpY2VDb21tYW5kQ2FsbGJhY2spICB7CgkJCQljYWxsYmFjayA9IG9wdGlvbnMuZGV2aWNlQ29tbWFuZENhbGxiYWNrOwoJCQkJaWYgKCJzdHJpbmciICE9IHR5cGVvZihjYWxsYmFjaykpICB7CgkJCQkJaWYgKGJyaWRnZWl0LmFsbG93QW5vbnltb3VzQ2FsbGJhY2tzKSAgewoJCQkJCQljYWxsYmFjayA9ICIhYW5vbiI7CgkJCQkJfSBlbHNlICB7CgkJCQkJCWNvbnNvbGUuZXJyb3IoCgkJCQkJCQkiQnJpZGdlSXQgY2FsbGJhY2tzIG11c3QgYmUgbmFtZWQgaW4gd2luZG93IHNjb3BlIik7CgkJCQkJCWNhbGxiYWNrID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWYgKG9wdGlvbnMuZWxlbWVudCkgIHsKCQkJCWVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnQ7CgkJCX0KCQkJaWYgKG9wdGlvbnMuZm9ybSkgIHsKCQkJCWZvcm1JRCA9IG9wdGlvbnMuZm9ybS5nZXRBdHRyaWJ1dGUoImlkIik7CgkJCX0KCQkJaWYgKG9wdGlvbnMuY29va2llcykgIHsKCQkJCXNlc3Npb25pZCA9IG9wdGlvbnMuY29va2llc1snSlNFU1NJT05JRCddOwoJCQl9CgkJfQoKCQlpZiAoIXVwbG9hZFVSTCkgIHsKCQkJdXBsb2FkVVJMID0gZ2V0VXBsb2FkVVJMKGVsZW1lbnQpOwoJCX0KCgkJdmFyIHdpbmRvd0xvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJCXZhciBiYXJVUkwgPSB3aW5kb3dMb2NhdGlvbi50b1N0cmluZygpOwoJCXZhciBiYXNlVVJMID0gYmFyVVJMLnN1YnN0cmluZygwLAoJCQkJYmFyVVJMLmxhc3RJbmRleE9mKCIvIikpICsgIi8iOwoKCQl2YXIgcmV0dXJuVVJMID0gIiIgKyB3aW5kb3cubG9jYXRpb247CgkJdmFyIGxhc3RIYXNoID0gcmV0dXJuVVJMLmxhc3RJbmRleE9mKCIjIik7CgkJdmFyIHRoZUhhc2ggPSAiIjsKCQl2YXIgdGhlVVJMID0gcmV0dXJuVVJMOwoJCWlmIChsYXN0SGFzaCA+IDApICB7CgkJCXRoZUhhc2ggPSByZXR1cm5VUkwuc3Vic3RyaW5nKGxhc3RIYXNoKTsKCQkJdGhlVVJMID0gcmV0dXJuVVJMLnN1YnN0cmluZygwLCBsYXN0SGFzaCk7CgkJfQoJCXJldHVyblVSTCA9IHRoZVVSTCArICIjaWNlbW9iaWxlc3giOwoKCQl2YXIgaGFzaFN1YkNsYXVzZSA9ICIiOwoJCWlmICghIXRoZUhhc2gpICB7CgkJCWhhc2hTdWJDbGF1c2UgPSAiJmg9IiArIGVzY2FwZSh0aGVIYXNoKTsKCQl9CgoJCXZhciBjYWxsYmFja0NsYXVzZSA9ICIiOwoJCWlmICghIWNhbGxiYWNrKSAgewoJCQljYWxsYmFja0NsYXVzZSA9ICImYz0iICsgZXNjYXBlKGNhbGxiYWNrKTsKCQl9CgoJCXNlcUNsYXVzZSA9ICImc2VxPSIgKyAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoKCQl2YXIgaGFzaENsYXVzZSA9ICIiOwoJCWlmICghIWhhc2hTdWJDbGF1c2UgfHwgISFjYWxsYmFja0NsYXVzZSkgIHsKCQkJaGFzaENsYXVzZSA9ICImaD0iICsgZXNjYXBlKGhhc2hTdWJDbGF1c2UpICsgZXNjYXBlKGNhbGxiYWNrQ2xhdXNlKQoJCQkJCSsgZXNjYXBlKHNlcUNsYXVzZSk7CgkJfQoKCQlkZXZpY2VPcHRpb25zID0gbnVsbDsKCQlpZiAoYnJpZGdlaXQudXNlQmFzZTY0KSAgewoJCQkvL2pxdWVyeSBtb2JpbGUgaW5zaXN0cyBvbiBwYXJzaW5nIEJyaWRnZUl0IGhhc2hjaGFuZ2UgZGF0YQoJCQlkZXZpY2VPcHRpb25zID0gImVuYz1iYXNlNjQiOwoJCX0KCQl2YXIgb3B0aW9uc0NsYXVzZSA9ICIiOwoJCWlmICghIWRldmljZU9wdGlvbnMpICB7CgkJCW9wdGlvbnNDbGF1c2UgPSAiJm89IiArIGVzY2FwZShkZXZpY2VPcHRpb25zKTsKCQl9CgoJCWlmIChwYXJhbXMgJiYgKCIiICE9IHBhcmFtcykpIHsKCQkJcGFyYW1zID0gIiZ1Yj0iICsgZXNjYXBlKGJhc2VVUkwpICsgYW1wY2hhciArIHBhcmFtczsKCQl9CgkJY29uc29sZS5sb2coJ3BhcmFtcyA9ICcgKyBwYXJhbXMpOwoKCQl2YXIgc2Vzc2lvbmlkQ2xhdXNlID0gIiI7CgkJaWYgKHNlc3Npb25pZCAmJiAoIiIgIT0gc2Vzc2lvbmlkKSkgewoJCQlzZXNzaW9uaWRDbGF1c2UgPSAiJkpTRVNTSU9OSUQ9IiArIGVzY2FwZShzZXNzaW9uaWQpOwoJCQkvL2Fsc28gbmVlZCBQSFBTRVNTSUQgYW5kIEFTUFNFU1NJT05JRAoJCX0KCQl2YXIgc2VyaWFsaXplZEZvcm1DbGF1c2UgPSAiIjsKCQlpZiAoZm9ybUlEICYmICgiIiAhPSBmb3JtSUQpKSAgewoJCQlzZXJpYWxpemVkRm9ybUNsYXVzZSA9ICImcD0iICsKCQkJCQllc2NhcGUoc2VyaWFsaXplRm9ybShmb3JtSUQsIGZhbHNlKSk7CgkJfQoJCXZhciB1cGxvYWRVUkxDbGF1c2UgPSAiIjsKCQlpZiAodXBsb2FkVVJMICYmICgiIiAhPSB1cGxvYWRVUkwpKSAgewoJCQl1cGxvYWRVUkxDbGF1c2UgPSAiJnU9IiArIGVzY2FwZSh1cGxvYWRVUkwpOwoJCX0KCQl2YXIgc3hVUkwgPSAiYz0iICsgZXNjYXBlKGNvbW1hbmQgKwoJCQkJIj9pZD0iICsgaWQgKyBhbXBjaGFyICsgKHBhcmFtcyA/IHBhcmFtcyA6ICcnKSkgKwoJCQkJdXBsb2FkVVJMQ2xhdXNlICsKCQkJCSImcj0iICsgZXNjYXBlKHJldHVyblVSTCkgKwoJCQkJc2Vzc2lvbmlkQ2xhdXNlICsKCQkJCW9wdGlvbnNDbGF1c2UgKwoJCQkJaGFzaENsYXVzZSArCgkJCQlzZXJpYWxpemVkRm9ybUNsYXVzZTsKCQlpZiAoYi5pc1dpbmRvd3NQaG9uZTgoKSkgIHsKCQkJc3hVUkwgPSBlc2NhcGUoc3hVUkwpOwoJCX0KCQl2YXIgc3hCYXNlID0gImljZW1vYmlsZToiOwoJCWlmIChiLmlzQW5kcm9pZCgpKSAgewoJCQlzeEJhc2UgPSAiaHR0cDovL2JyaWRnZWl0Lm1vYmkvYW5kcm9pZC9pbnN0YWxsL2luZGV4Lmh0bWwjIgoJCX0KCQlzeFVSTCA9IHN4QmFzZSArIHN4VVJMOwoJCWNvbnNvbGUubG9nKCdzeFVSTD0nICsgc3hVUkwpOwoKCQl3aW5kb3cubG9jYXRpb24gPSBzeFVSTDsKCX0KCWZ1bmN0aW9uIGdldFNwbGFzaENsYXVzZSgpICB7CgkJdmFyIHNwbGFzaENsYXVzZSA9ICIiOwoJCWlmIChudWxsICE9IGJyaWRnZWl0LnNwbGFzaEltYWdlVVJMKSAgewoJCQl2YXIgc3BsYXNoSW1hZ2UgPSAiaT0iICsgZXNjYXBlKGJyaWRnZWl0LnNwbGFzaEltYWdlVVJMKTsKCQkJc3BsYXNoQ2xhdXNlID0gIiZzPSIgKyBlc2NhcGUoc3BsYXNoSW1hZ2UpOwoJCX0KCQlyZXR1cm4gc3BsYXNoQ2xhdXNlOwoJfQoJdmFyIGF1dG9EZXRlY3RVcGxvYWRVUkwgPSBmYWxzZTsKCWZ1bmN0aW9uIGdldFVwbG9hZFVSTChlbGVtZW50KSAgewoJCWlmICghYXV0b0RldGVjdFVwbG9hZFVSTCkgIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCXZhciB1cGxvYWRVUkw7CgoJCXZhciB3aW5kb3dMb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCQl2YXIgYmFyVVJMID0gd2luZG93TG9jYXRpb24udG9TdHJpbmcoKTsKCQl2YXIgYmFzZVVSTCA9IGJhclVSTC5zdWJzdHJpbmcoMCwKCQkJCWJhclVSTC5sYXN0SW5kZXhPZigiLyIpKSArICIvIjsKCgkJaWYgKCFlbGVtZW50KSAgewoJCQl1cGxvYWRVUkwgPSBiYXNlVVJMOwoJCX0gZWxzZSB7CgkJCXZhciBmb3JtID0gZm9ybU9mKGVsZW1lbnQpOwoJCQlmb3JtSUQgPSBmb3JtLmdldEF0dHJpYnV0ZSgnaWQnKTsKCQkJdmFyIGZvcm1BY3Rpb24gPSBmb3JtLmdldEF0dHJpYnV0ZSgiYWN0aW9uIik7CgoJCQlpZiAoIXVwbG9hZFVSTCkgewoJCQkJdXBsb2FkVVJMID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtcG9zdHVybCIpOwoJCQl9CgkJCWlmICghdXBsb2FkVVJMKSB7CgkJCQlpZiAoMCA9PT0gZm9ybUFjdGlvbi5pbmRleE9mKCIvIikpIHsKCQkJCQl1cGxvYWRVUkwgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgZm9ybUFjdGlvbjsKCQkJCX0gZWxzZSBpZiAoKDAgPT09IGZvcm1BY3Rpb24uaW5kZXhPZigiaHR0cDovLyIpKSB8fAoJCQkJCQkoMCA9PT0gZm9ybUFjdGlvbi5pbmRleE9mKCJodHRwczovLyIpKSkgewoJCQkJCXVwbG9hZFVSTCA9IGZvcm1BY3Rpb247CgkJCQl9IGVsc2UgewoJCQkJCXVwbG9hZFVSTCA9IGJhc2VVUkwgKyBmb3JtQWN0aW9uOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiB1cGxvYWRVUkw7Cgl9Cgl2YXIgY2hlY2tUaW1lb3V0OwoJZnVuY3Rpb24gZGV2aWNlQ29tbWFuZChjb21tYW5kLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpICB7CgkJaWYoICFiLmlzU3VwcG9ydGVkUGxhdGZvcm0oY29tbWFuZCkgKXsKCQkJYi5ub3RTdXBwb3J0ZWQoaWQsIGNvbW1hbmQpOwoJCQlyZXR1cm47CgkJfQoJCWlmIChiLmlzSU9TKCkpICB7CgkJCWNoZWNrVGltZW91dCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgIHsKCQkJCWJyaWRnZWl0LmxhdW5jaEZhaWxlZChpZCk7CgkJCX0sIDMwMDApOwoJCX0KCQlpZiAoIW9wdGlvbnMpICB7CgkJCW9wdGlvbnMgPSB7fTsKCQl9CgkJY29uc29sZS5sb2coY29tbWFuZCArICIgIiArIGlkKTsKCQlicmlkZ2VpdC5kZXZpY2VDb21tYW5kQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQlpZiAoYnJpZGdlaXQudXNlSlNPTjY0KSAgewoJCQlvcHRpb25zLl9jYWxsYmFjayA9IGNhbGxiYWNrOwoJCQlkZXZpY2VDb21tYW5kRXhlYyhjb21tYW5kLCBpZCwgb3B0aW9ucyk7CgkJfSBlbHNlIHsKCQkJb3B0aW9ucy5kZXZpY2VDb21tYW5kQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJZGV2aWNlQ29tbWFuZFVSTEV4ZWMoY29tbWFuZCwgaWQsIG9wdGlvbnMpOwoJCX0KCX0KCWZ1bmN0aW9uIHNldElucHV0KHRhcmdldCwgbmFtZSwgdmFsdWUsIHZ0eXBlKSAgewoJCWNvbnNvbGUubG9nKCdzZXRJbnB1dCh0YXJnZXQ9JyArIHRhcmdldCArICcsIG5hbWU9JyArIG5hbWUgKyAnLCB2YWx1ZT0nICsgdmFsdWUgKyAnLCB2dHlwZT0nICsgdnR5cGUpOwoJCXZhciBoaWRkZW5JRCA9IG5hbWUgKyAiLWhpZCI7CgkJdmFyIGV4aXN0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGlkZGVuSUQpOwoJCWlmIChleGlzdGluZykgIHsKCQkJZXhpc3Rpbmcuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIHZhbHVlKTsKCQkJcmV0dXJuOwoJCX0KCQl2YXIgdGFyZ2V0RWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0KTsKCQlpZiAoIXRhcmdldEVsbSkgIHsKCQkJcmV0dXJuOwoJCX0KCQl2YXIgaGlkZGVuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCgkJaGlkZGVuLnNldEF0dHJpYnV0ZSgidHlwZSIsICJoaWRkZW4iKTsKCQloaWRkZW4uc2V0QXR0cmlidXRlKCJpZCIsIGhpZGRlbklEKTsKCQloaWRkZW4uc2V0QXR0cmlidXRlKCJuYW1lIiwgbmFtZSk7CgkJaGlkZGVuLnNldEF0dHJpYnV0ZSgidmFsdWUiLCB2YWx1ZSk7CgkJaWYgKHZ0eXBlKSAgewoJCQloaWRkZW4uc2V0QXR0cmlidXRlKCJkYXRhLXR5cGUiLCB2dHlwZSk7CgkJfQoJCXRhcmdldEVsbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShoaWRkZW4sIHRhcmdldEVsbSk7Cgl9CglmdW5jdGlvbiBmb3JtT2YoZWxlbWVudCkgewoJCXZhciBwYXJlbnQgPSBlbGVtZW50OwoJCXdoaWxlIChudWxsICE9IHBhcmVudCkgewoJCQlpZiAoImZvcm0iID09IHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CgkJCQlyZXR1cm4gcGFyZW50OwoJCQl9CgkJCXBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlOwoJCX0KCX0KCglmdW5jdGlvbiBwYWNrT2JqZWN0KHBhcmFtcywgZXhjbHVkZSkgIHsKCQl2YXIgcGFja2VkID0gIiI7CgkJdmFyIHNlcCA9ICIiOwoJCWZvciAodmFyIGtleSBpbiBwYXJhbXMpICB7CgkJCWlmIChleGNsdWRlLmluZGV4T2Yoa2V5KSA8IDApICB7CgkJCQlwYWNrZWQgKz0gc2VwICsgZXNjYXBlKGtleSkgKyAiPSIgKyBlc2NhcGUocGFyYW1zW2tleV0pOwoJCQkJc2VwID0gIiYiOwoJCQl9CgkJfQoJCXJldHVybiBwYWNrZWQ7Cgl9CglmdW5jdGlvbiB1bnBhY2tEZXZpY2VSZXNwb25zZShkYXRhKSAgewoJCXZhciByZXN1bHQgPSB7fTsKCQl2YXIgdW42NCA9IGJyaWRnZWl0LnVzZUpTT042NCB8fAoJCQkJKGJyaWRnZWl0LnVzZUJhc2U2NCAmJiAoZGF0YS5pbmRleE9mKCIhIikgPCAwKSk7CgkJaWYgKHVuNjQpICB7CgkJCWRhdGEgPSBkYXRhLnJlcGxhY2UoL34vZywiPSIpOwoJCQlkYXRhID0gZGF0YS5yZXBsYWNlKC9cLi9nLCIvIik7CgkJCWRhdGEgPSBhdG9iKGRhdGEpOwoJCX0KCQlpZiAoYnJpZGdlaXQudXNlSlNPTjY0KSAgewoJCQkvL2Nsb25lIHRoZXNlIGZvciBub3cKCQkJZGF0YSA9IEpTT04ucGFyc2UoZGF0YSkKCQkJZGF0YS5uYW1lID0gZGF0YS5pZDsKCQkJZGF0YS5wID0gZGF0YS5wcmV2aWV3OwoJCQlkYXRhLmMgPSBkYXRhLmNsb3VkOwoJCQlkYXRhLmggPSBkYXRhLmVjaG87CgkJCWRhdGEudiA9IGRhdGEudmVyc2lvbjsKCQkJcmV0dXJuIGRhdGE7CgkJfSBlbHNlIHsKCQkJZGF0YSA9IGRlY29kZVVSSUNvbXBvbmVudChkYXRhKTsKCQl9CgkJdmFyIHBhcmFtcyA9IGRhdGEuc3BsaXQoIiYiKTsKCQl2YXIgbGVuID0gcGFyYW1zLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCXZhciBzcGxpdEluZGV4ID0gcGFyYW1zW2ldLmluZGV4T2YoIj0iKTsKCQkJdmFyIHBhcmFtTmFtZSA9IHVuZXNjYXBlKHBhcmFtc1tpXS5zdWJzdHJpbmcoMCwgc3BsaXRJbmRleCkpOwoJCQl2YXIgcGFyYW1WYWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCgKCQkJCQlwYXJhbXNbaV0uc3Vic3RyaW5nKHNwbGl0SW5kZXggKyAxKSApOwoJCQlpZiAoIiEiID09PSBwYXJhbU5hbWUuc3Vic3RyaW5nKDAsMSkpICB7CgkJCQkvL0JyaWRnZUl0IHBhcmFtZXRlcnMgYXJlIHNldCBkaXJlY3RseQoJCQkJcmVzdWx0W3BhcmFtTmFtZS5zdWJzdHJpbmcoMSldID0gcGFyYW1WYWx1ZTsKCQkJfSBlbHNlICB7CgkJCQkvL29ubHkgb25lIHVzZXIgdmFsdWUgaXMgc3VwcG9ydGVkCgkJCQljb25zb2xlLmxvZygiZGV2aWNlUmVzcG9uc2UgdmFsdWUgIiArCgkJCQkJCXBhcmFtTmFtZSArICIgIiArIHBhcmFtVmFsdWUpOwoJCQkJcmVzdWx0Lm5hbWUgPSBwYXJhbU5hbWU7CgkJCQlyZXN1bHQudmFsdWUgPSBwYXJhbVZhbHVlOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9CglmdW5jdGlvbiB1cmwyT2JqZWN0KGVuY29kZWQpICB7CgkJdmFyIHBhcnRzID0gZW5jb2RlZC5zcGxpdCgiJiIpOwoJCXZhciByZWNvcmQgPSB7fTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghIXBhcnRzW2ldKSAgewoJCQkJdmFyIHBhaXIgPSBwYXJ0c1tpXS5zcGxpdCgiPSIpOwoJCQkJcmVjb3JkW3VuZXNjYXBlKHBhaXJbMF0pXSA9IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVjb3JkOwoJfQoJZnVuY3Rpb24gZ2V0TmFtZWRPYmplY3QobmFtZSkgIHsKCQlpZiAoIW5hbWUpICB7CgkJCXJldHVybiBudWxsOwoJCX0KCQl2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCIuIik7CgkJdmFyIHRoZU9iamVjdCA9IHdpbmRvdzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CgkJCXRoZU9iamVjdCA9IHRoZU9iamVjdFtwYXJ0c1tpXV07CgkJCWlmICghdGhlT2JqZWN0KSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCQlpZiAod2luZG93ID09IHRoZU9iamVjdCkgIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCXJldHVybiB0aGVPYmplY3Q7Cgl9CglmdW5jdGlvbiBhZGRPbkxvYWRMaXN0ZW5lcihmdW5jKSAgewoJCXZhciBvbGRvbmxvYWQgPSB3aW5kb3cub25sb2FkOwoJCXdpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQkJdHJ5IHsKCQkJCWlmIChvbGRvbmxvYWQpICB7CgkJCQkJb2xkb25sb2FkKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGUpICB7CgkJCQljb25zb2xlLmVycm9yKGUpOwoJCQl9CgkJCWZ1bmMoKTsKCQl9Cgl9Cgl2YXIgaXNEYXRhUGVuZGluZyA9IGZhbHNlOwoJdmFyIGlzTG9hZGVkID0gZmFsc2U7Cgl2YXIgcGVuZGluZ0RhdGEgPSBudWxsOwoJZnVuY3Rpb24gbG9hZENvbXBsZXRlKCkgIHsKCQlpc0xvYWRlZCA9IHRydWU7Cgl9CglmdW5jdGlvbiBjaGVja0V4ZWNEZXZpY2VSZXNwb25zZSgpICB7CgkJdmFyIGRhdGEgPSBnZXREZXZpY2VDb21tYW5kKCk7CgkJaWYgKG51bGwgPT0gZGF0YSkgIHsKCQkJZGF0YSA9IHBlbmRpbmdEYXRhOwoJCQkvL3JlY29yZCBVUkwvaGFzaCBjaGFuZ2VzIHRoYXQgYXJlIG5vdCBkZXZpY2UgY29tbWFuZHMKCQkJc3RvcmVMYXN0UGFnZSgpOwoJCX0KCQl2YXIgZGV2aWNlUGFyYW1zOwoJCWlmIChudWxsICE9IGRhdGEpICB7CgkJCXBlbmRpbmdEYXRhID0gZGF0YTsKCQkJaXNEYXRhUGVuZGluZyA9IHRydWU7CgkJCWlmICghaXNMb2FkZWQpICB7CgkJCQljb25zb2xlLmxvZygiY2hlY2tFeGVjRGV2aWNlUmVzcG9uc2Ugd2FpdGluZyBmb3Igb25sb2FkIik7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmFyIG5hbWU7CgkJCXZhciB2YWx1ZTsKCQkJdmFyIG5lZWRSZWZyZXNoID0gdHJ1ZTsKCQkJaWYgKCIiICE9IGRhdGEpICB7CgkJCQlkZXZpY2VQYXJhbXMgPSB1bnBhY2tEZXZpY2VSZXNwb25zZShkYXRhKTsKCQkJCWlmIChkZXZpY2VQYXJhbXMubmFtZSkgIHsKCQkJCQluYW1lID0gZGV2aWNlUGFyYW1zLm5hbWU7CgkJCQkJdmFsdWUgPSBkZXZpY2VQYXJhbXMudmFsdWU7CgkJCQkJc2V0SW5wdXQobmFtZSwgbmFtZSwgdmFsdWUpOwoJCQkJCW5lZWRSZWZyZXNoID0gZmFsc2U7CgkJCQl9CgkJCX0KCQkJaWYgKG5lZWRSZWZyZXNoKSAgewoJCQkJY29uc29sZS5sb2coJ25lZWRzIHJlZnJlc2gnKTsKCQkJCWlmICh3aW5kb3cuaWNlLmFqYXhSZWZyZXNoKSAgewoJCQkJCWljZS5hamF4UmVmcmVzaCgpOwoJCQkJfQoJCQl9CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CgkJCQlpZiAoIWlzRGF0YVBlbmRpbmcpICB7CgkJCQkJY29uc29sZS5sb2coImNoZWNrRXhlY0RldmljZVJlc3BvbnNlIGlzIGRvbmUsIGV4aXRpbmciKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl2YXIgc3hFdmVudCA9IHsKCQkJCQluYW1lIDogbmFtZSwKCQkJCQl2YWx1ZSA6IHZhbHVlCgkJCQl9OwoJCQkJdmFyIGNhbGxiYWNrID0gYnJpZGdlaXQuZGV2aWNlQ29tbWFuZENhbGxiYWNrOwoJCQkJdmFyIG5hbWVkQ2FsbEJhY2sgPSBnZXROYW1lZE9iamVjdChjYWxsYmFjayk7CgkJCQlpZiAobmFtZWRDYWxsQmFjaykgIHsKCQkJCQljYWxsYmFjayA9IG5hbWVkQ2FsbEJhY2s7CgkJCQl9CgkJCQljb25zb2xlLmxvZygnc3hFdmVudDogJyArIEpTT04uc3RyaW5naWZ5KHN4RXZlbnQpICsgIiAiICsKCQkJCQkJSlNPTi5zdHJpbmdpZnkoZGV2aWNlUGFyYW1zKSk7CgkJCQl2YXIgcmVzdG9yZUhhc2ggPSAiIjsKCQkJCWlmIChkZXZpY2VQYXJhbXMpICB7CgkJCQkJaWYgKGRldmljZVBhcmFtcy5yKSAgewoJCQkJCQlzeEV2ZW50LnJlc3BvbnNlID0gZGV2aWNlUGFyYW1zLnI7CgkJCQkJfQoJCQkJCWlmIChkZXZpY2VQYXJhbXMudikgIHsKCQkJCQkJc3hFdmVudC52ZXJzaW9uID0gZGV2aWNlUGFyYW1zLnY7CgkJCQkJCXNldExhc3RBcHBWZXJzaW9uKGRldmljZVBhcmFtcy52KTsKCQkJCQl9CgkJCQkJaWYgKGRldmljZVBhcmFtcy5wKSAgewoJCQkJCQlzeEV2ZW50LnByZXZpZXcgPSBkZXZpY2VQYXJhbXMucDsKCQkJCQl9CgkJCQkJaWYgKGRldmljZVBhcmFtcy5jKSAgewoJCQkJCQlzZXRDbG91ZFB1c2hJZChkZXZpY2VQYXJhbXMuYyk7CgkJCQkJCWlmIChpY2UucHVzaCkgIHsKCQkJCQkJCWljZS5wdXNoLnBhcmtJbmFjdGl2ZVB1c2hJZHMoCgkJCQkJCQkJCWRldmljZVBhcmFtcy5jICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKGRldmljZVBhcmFtcy5oKSAgewoJCQkJCQl2YXIgZWNob2VkID0gdXJsMk9iamVjdCh1bmVzY2FwZShkZXZpY2VQYXJhbXMuaCkpOwoJCQkJCQlpZiAoZWNob2VkLmgpICB7CgkJCQkJCQlyZXN0b3JlSGFzaCA9IGVjaG9lZC5oOwoJCQkJCQl9CgkJCQkJCWlmIChlY2hvZWQuYykgIHsKCQkJCQkJCXZhciBuYW1lZENhbGxCYWNrID0gZ2V0TmFtZWRPYmplY3QoZWNob2VkLmMpOwoJCQkJCQkJaWYgKG5hbWVkQ2FsbEJhY2spICB7CgkJCQkJCQkJY2FsbGJhY2sgPSBuYW1lZENhbGxCYWNrOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJdmFyIGxvYyA9IHdpbmRvdy5sb2NhdGlvbjsKCQkJCWlzRGF0YVBlbmRpbmcgPSBmYWxzZTsKCQkJCXBlbmRpbmdEYXRhID0gbnVsbDsKCgkJCQlpZiggIWhhc0luc3RhbGxlZFRva2VuKCkgKXsKCQkJCQlzZXRJbnN0YWxsZWRUb2tlbigpOwoJCQkJfQoKCQkJCWlmIChjYWxsYmFjaykgIHsKCQkJCQl0cnkgewoJCQkJCQljYWxsYmFjayhzeEV2ZW50KTsKCQkJCQl9IGNhdGNoIChlKSAgewoJCQkJCQl2YXIgbXNnID0gIkJyaWRnZUl0IERldmljZSBmdW5jdGlvbiBjYWxsYmFjayAnIiArIGNhbGxiYWNrICsgIicgZmFpbGVkLCBtYWtlIHN1cmUgdGhhdCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gaXMgaW4gZ2xvYmFsIHNjb3BlLiI7CgkJCQkJCWNvbnNvbGUuZXJyb3IobXNnKTsKCQkJCQkJY29uc29sZS5lcnJvcihlLnN0YWNrKTsKCQkJCQkJYWxlcnQobXNnKTsKCQkJCQl9CgkJCQkJYnJpZGdlaXQuZGV2aWNlQ29tbWFuZENhbGxiYWNrID0gbnVsbDsKCQkJCX0gZWxzZXsKCQkJCQljb25zb2xlLmxvZygnbm8gZGV2aWNlQ29tbWFuZENhbGxiYWNrIHJlZ2lzdGVyZWQgOignKTsKCQkJCX0KCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCQl2YXIgcmVzdG9yZUxvY2F0aW9uID0KCQkJCQkJbG9jLnBhdGhuYW1lICsgbG9jLnNlYXJjaCArIHJlc3RvcmVIYXNoOwoJCQkJCWhpc3RvcnkucmVwbGFjZVN0YXRlKCIiLCBkb2N1bWVudC50aXRsZSwKCQkJCQkJcmVzdG9yZUxvY2F0aW9uKTsKCQkJCQljb25zb2xlLmxvZygnYnJpZGdlaXQgaGlzdG9yeSByZXBsYWNlU3RhdGU6ICcgKwoJCQkJCQlyZXN0b3JlTG9jYXRpb24pOwoJCQkJfSwgMTAwKTsKCQkJfSwgMSk7CgkJfQoJfQoJdmFyIENMT1VEX1BVU0hfS0VZID0gImljZS5ub3RpZnlCYWNrIjsKCWZ1bmN0aW9uIHNldENsb3VkUHVzaElkKGlkKSAgewoJCS8vcmVseSBvbiBsb2NhbCBzdG9yYWdlIHNpbmNlIGNsb3VkIHB1c2ggaXMgb24gbW9kZXJuIHBsYXRmb3JtcwoJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKENMT1VEX1BVU0hfS0VZLCBpZCk7CgkJfQoJfQoJZnVuY3Rpb24gZ2V0Q2xvdWRQdXNoSWQoKSAgewoJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCXJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShDTE9VRF9QVVNIX0tFWSk7CgkJfQoJCXJldHVybiBudWxsOwoJfQoKCWZ1bmN0aW9uIHNldHVwQ2xvdWRQdXNoKCkgIHsKCQl2YXIgY2xvdWRQdXNoSWQgPSBnZXRDbG91ZFB1c2hJZCgpOwoJCWlmICghIWNsb3VkUHVzaElkKSAgewoJCQlpZiAoaWNlLnB1c2gpICB7CgkJCQljb25zb2xlLmxvZygiQ2xvdWQgUHVzaCByZWdpc3RlcmVkOiAiICsgY2xvdWRQdXNoSWQpOwoJCQkJaWNlLnB1c2gucGFya0luYWN0aXZlUHVzaElkcyhjbG91ZFB1c2hJZCk7CgkJCX0KCQl9Cgl9CgkvL21vdmUgcGF1c2UgYW5kIHJlc3VtZSB0byBJQ0VwdXNoIHdoZW4gcmVhZHkKCWZ1bmN0aW9uIHBhdXNlUHVzaCgpICB7CgkgICBpZiAod2luZG93LmljZSAmJiBpY2UucHVzaCkgIHsKCQkgICBpY2UucHVzaC5jb25uZWN0aW9uLnBhdXNlQ29ubmVjdGlvbigpOwoJICAgfQoJfQoJZnVuY3Rpb24gcmVzdW1lUHVzaCgpICB7CgkgICBpZiAod2luZG93LmljZSAmJiBpY2UucHVzaCkgIHsKCQkgICBpY2UucHVzaC5jb25uZWN0aW9uLnJlc3VtZUNvbm5lY3Rpb24oKTsKCQkJcmVzdW1lUHVzaEdyb3VwcygpOwoJICAgfQoJfQoJZnVuY3Rpb24gcmVzdW1lUHVzaEdyb3VwcygpICB7CgkJZm9yICh2YXIgcHVzaElEIGluIHB1c2hMaXN0ZW5lcnMpIHsKCQkJdmFyIHB1c2hMaXN0ZW5lciA9IHB1c2hMaXN0ZW5lcnNbcHVzaElEXTsKCQkJY29uc29sZS5sb2coInJlam9pbmluZyBwdXNoIGdyb3VwIHdpdGggb2xkIHB1c2hpZCAiICsKCQkJCQlwdXNoTGlzdGVuZXIuZ3JvdXAgKyAiICIgKyBwdXNoSUQgKTsKCQkJaWNlLnB1c2guYWRkR3JvdXBNZW1iZXIocHVzaExpc3RlbmVyLmdyb3VwLCBwdXNoSUQpOwoJCX0KCX0KCgl2YXIgTEFTVF9QQUdFX0tFWSA9ICJicmlkZ2VpdC5sYXN0cGFnZSI7CglmdW5jdGlvbiBzdG9yZUxhc3RQYWdlKGxhc3RQYWdlKSAgewoJCWlmICghbGFzdFBhZ2UpICB7CgkJCXZhciBzeGtleSA9ICIjaWNlbW9iaWxlc3giOwoJCQl2YXIgc3hsZW4gPSBzeGtleS5sZW5ndGg7CgkJCXZhciBsb2NIYXNoID0gIiIgKyB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQkJbGFzdFBhZ2UgPSAiIiArIGRvY3VtZW50LmxvY2F0aW9uOwoJCQlpZiAoc3hrZXkgPT09IGxvY0hhc2guc3Vic3RyaW5nKDAsIHN4bGVuKSkgIHsKCQkJCWxhc3RQYWdlID0gbGFzdFBhZ2Uuc3Vic3RyaW5nKDAsCgkJCQkJCWxhc3RQYWdlLmxlbmd0aCAtIGxvY0hhc2gubGVuZ3RoKQoJCQl9CgkJfQoJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKExBU1RfUEFHRV9LRVksIGxhc3RQYWdlKTsKCQkJY29uc29sZS5sb2coImJyaWRnZWl0IHN0b3JlTGFzdFBhZ2UgIiArIGxhc3RQYWdlKTsKCQl9Cgl9CgkvKiBQYWdlIGV2ZW50IGhhbmRsaW5nICovCglpZiAod2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKCgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBhZ2VoaWRlIiwgZnVuY3Rpb24gKCkgewoJCQkvL2hpZGluZyB0aGUgcGFnZSBlaXRoZXIgaW5kaWNhdGVzIHVzZXIgZG9lcyBub3QgcmVxdWlyZQoJCQkvL0JyaWRnZUl0IG9yIHRoZSB1cmwgc2NoZW1lIGludm9jYXRpb24gaGFzIHN1Y2NlZWRlZAoJCQljbGVhclRpbWVvdXQoY2hlY2tUaW1lb3V0KTsKCQkJaWYgKGljZS5wdXNoICYmIGljZS5wdXNoLmNvbm5lY3Rpb24pIHsKCQkJCXBhdXNlUHVzaCgpOwoJCQl9CgkJfSwgZmFsc2UpOwoKCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicGFnZXNob3ciLCBmdW5jdGlvbiAoKSB7CgkJCWlmIChpY2UucHVzaCAmJiBpY2UucHVzaC5jb25uZWN0aW9uKSB7CgkJCQlyZXN1bWVQdXNoKCk7CgkJCX0KCQl9LCBmYWxzZSk7CgoJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJoYXNoY2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJCQljb25zb2xlLmxvZygnZW50ZXJlZCBoYXNoY2hhbmdlIGxpc3RlbmVyIGhhc2g9JyArIHdpbmRvdy5sb2NhdGlvbi5oYXNoKTsKCQkJY2hlY2tFeGVjRGV2aWNlUmVzcG9uc2UoKTsKCQl9LCBmYWxzZSk7CgoJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgZnVuY3Rpb24gKCkgewoJCQlzdG9yZUxhc3RQYWdlKCk7CgkJfSwgZmFsc2UpOwoKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJCQlpZiAoZG9jdW1lbnQud2Via2l0SGlkZGVuKSAgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNoZWNrVGltZW91dCk7CgkJCQlwYXVzZVB1c2goKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VtZVB1c2goKTsKCQkJfQoJCX0pOwoKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJCQlpZiAoZG9jdW1lbnQuaGlkZGVuKSAgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNoZWNrVGltZW91dCk7CgkJCQlwYXVzZVB1c2goKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VtZVB1c2goKTsKCQkJfQoJCX0pOwoKCX07CgoJZnVuY3Rpb24ganNvblBPU1QodXJpLCBwYXlsb2FkKSB7CgkJdmFyIHByb20gPSBuZXcgUHJvbWl6KCk7CgkJdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJCXhoci5vcGVuKCdQT1NUJywgdXJpLCB0cnVlKTsKCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigKCQkJCSJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04Iik7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoNCA9PSB4aHIucmVhZHlTdGF0ZSkgIHsKCQkJCWlmICgyMDAgPT0geGhyLnN0YXR1cykgIHsKCQkJCQlwcm9tLnJlc29sdmUoSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KSk7CgkJCQl9IGVsc2UgewoJCQkJCXByb20ucmVqZWN0KHttZXNzYWdlOnhoci5zdGF0dXNUZXh0LCBzdGF0dXM6IHhoci5zdGF0dXN9KTsKCQkJICAgfQoJCQl9CgkJfTsKCQl4aHIuc2VuZChKU09OLnN0cmluZ2lmeShwYXlsb2FkKSk7CgkJcmV0dXJuIHByb207Cgl9CgoJZnVuY3Rpb24gaHR0cEdFVCh1cmksIHF1ZXJ5KSB7CgkJdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJCXZhciBxdWVyeVN0ciA9ICIiOwoJCWlmICghIXF1ZXJ5KSAgewoJCQlxdWVyeVN0ciA9ICI/IiArIHF1ZXJ5OwoJCX0KCQl4aHIub3BlbignR0VUJywgdXJpICsgcXVlcnlTdHIsIGZhbHNlKTsKCQl4aHIuc2VuZChxdWVyeSk7CgkJaWYgKHhoci5zdGF0dXMgPT0gMjAwKSB7CgkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0OwoJCX0gZWxzZSB7CgkJCXRocm93IHhoci5zdGF0dXNUZXh0ICsgJ1snICsgeGhyLnN0YXR1cyArICddJzsKCQl9Cgl9CgoJZnVuY3Rpb24gZW5kc1dpdGgocywgcGF0dGVybikgewoJCXJldHVybiBzLmxhc3RJbmRleE9mKHBhdHRlcm4pID09IHMubGVuZ3RoIC0gcGF0dGVybi5sZW5ndGg7Cgl9CgoJdmFyIGFic29sdXRlR29CcmlkZ2VJdFVSTCA9IG51bGw7CgoJZnVuY3Rpb24gZmV0Y2hHb0JyaWRnZUl0KHVybCkgewoJCXZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCWlmICg0ID09IHhoci5yZWFkeVN0YXRlKSAgewoJCQkJaWYgKDIwMCA9PSB4aHIuc3RhdHVzKSAgewoJCQkJCWlmICghYWJzb2x1dGVHb0JyaWRnZUl0VVJMKSAgewoJCQkJCQlhYnNvbHV0ZUdvQnJpZGdlSXRVUkwgPSBnZXRBYnNvbHV0ZVVSTCh1cmwpOwoJCQkJCQljb25zb2xlLmxvZygiQ2xvdWQgUHVzaCByZXR1cm4gdmlhIGdvQnJpZGdlSXQ6ICIgKwoJCQkJCQkJCWFic29sdXRlR29CcmlkZ2VJdFVSTCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfTsKCQl4aHIub3BlbignR0VUJywgdXJsLCB0cnVlKTsKCQl4aHIuc2VuZCgpOwoJfQoKCWZ1bmN0aW9uIGZpbmRHb0JyaWRnZUl0KCkgewoJCWlmICghIWJyaWRnZWl0LmdvQnJpZGdlSXRVUkwpICB7CgkJCS8vcGFnZSBzZXR0aW5nIG92ZXJyaWRlcyBkZXRlY3Rpb24KCQkJYWJzb2x1dGVHb0JyaWRnZUl0VVJMID0gZ2V0QWJzb2x1dGVVUkwoYnJpZGdlaXQuZ29CcmlkZ2VJdFVSTCk7CgkJCXJldHVybjsKCQl9CgkJLy9ob3N0LXdpZGUgcGFnZQoJCWZldGNoR29CcmlkZ2VJdCgnL2dvQnJpZGdlSXQuaHRtbCcpOwoJCS8vYXBwbGljYXRpb24tc3BlY2lmaWMgcGFnZQoJCWZldGNoR29CcmlkZ2VJdCgnZ29CcmlkZ2VJdC5odG1sJyk7Cgl9CgoJZnVuY3Rpb24gZ2V0QWJzb2x1dGVVUkwodXJsKSAgewoJCXZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKCQlpbWcuc3JjID0gdXJsOwoJCXVybCA9IGltZy5zcmM7CgkJcmV0dXJuIHVybDsKCX0KCgl2YXIgcHVzaFByb21pc2UgPSBuZXcgUHJvbWl6KCk7CgoJZnVuY3Rpb24gbG9hZFB1c2hTZXJ2aWNlKHVyaSwgYXBpa2V5LCBvcHRpb25zKSB7CgkJdmFyIGJhc2VVUkkgPSB1cmkgKyAoZW5kc1dpdGgodXJpLCAnLycpID8gJycgOiAnLycpOwoJCWlmIChpY2UgJiYgaWNlLnB1c2gpIHsKCQkJY29uc29sZS5sb2coJ1B1c2ggc2VydmljZSBhbHJlYWR5IGxvYWRlZCBhbmQgY29uZmlndXJlZCcpOwoJCX0gZWxzZSB7CgkJCXZhciBjb2RlVVJJID0gYmFzZVVSSSArICdjb2RlLmljZXB1c2gnOwoJCQl2YXIgY29kZSA9IGh0dHBHRVQoY29kZVVSSSk7CgkJCWV2YWwoY29kZSk7CgoJCQlmaW5kR29CcmlkZ2VJdCgpOwoJCX0KCQlpY2UucHVzaC5jb25maWd1cmF0aW9uLmNvbnRleHRQYXRoID0gYmFzZVVSSTsKCQlpY2UucHVzaC5jb25maWd1cmF0aW9uLmFwaWtleSA9IGFwaWtleTsKCQlpZiAob3B0aW9ucykgIHsKCQkJaWNlLnB1c2guY29uZmlndXJhdGlvbi5hY2NvdW50ID0gb3B0aW9ucy5hY2NvdW50OwoJCQlpY2UucHVzaC5jb25maWd1cmF0aW9uLnJlYWxtID0gb3B0aW9ucy5yZWFsbTsKCQkJaWYgKG9wdGlvbnMuYXV0aCkgIHsKCQkJCWljZS5wdXNoLmNvbmZpZ3VyYXRpb24uYWNjZXNzX3Rva2VuID0KCQkJCQkJb3B0aW9ucy5hdXRoLmFjY2Vzc190b2tlbjsKCQkJfQoJCX0KCQlpY2UucHVzaC5jb25uZWN0aW9uLnN0YXJ0Q29ubmVjdGlvbigpOwoKCQlzZXR1cENsb3VkUHVzaCgpOwoJCXB1c2hQcm9taXNlLnJlc29sdmUoKTsKCX0KCgl2YXIgcHVzaExpc3RlbmVycyA9IHt9OwoKCWZ1bmN0aW9uIGFkZFB1c2hMaXN0ZW5lckltcGwoZ3JvdXAsIGNhbGxiYWNrKSB7CgkJaWYgKGljZSAmJiBpY2UucHVzaCAmJiBpY2UucHVzaC5jb25maWd1cmF0aW9uLmNvbnRleHRQYXRoKSB7CgkJCWljZS5wdXNoLmNvbm5lY3Rpb24ucmVzdW1lQ29ubmVjdGlvbigpOwoKCQkJdmFyIHB1c2hJZCA9IGljZS5wdXNoLmNyZWF0ZVB1c2hJZCgpOwoJCQlwdXNoTGlzdGVuZXJzW3B1c2hJZF0gPSB7Z3JvdXA6IGdyb3VwLCBjYWxsYmFjazogY2FsbGJhY2t9OwoJCQlpY2UucHVzaC5hZGRHcm91cE1lbWJlcihncm91cCwgcHVzaElkKTsKCQkJaWYgKCJzdHJpbmciICE9IHR5cGVvZihjYWxsYmFjaykpICB7CgkJCQljb25zb2xlLmVycm9yKAoJCQkJCSJCcmlkZ2VJdCBDbG91ZCBQdXNoIGNhbGxiYWNrcyBtdXN0IGJlIG5hbWVkIGluIHdpbmRvdyBzY29wZSIpOwoJCQl9IGVsc2UgewoJCQkJdmFyIGNhbGxiYWNrTmFtZSA9IGNhbGxiYWNrOwoJCQkJY2FsbGJhY2sgPSBnZXROYW1lZE9iamVjdChjYWxsYmFjayk7CgkJCQlpZiAoISFjYWxsYmFjaykgIHsKCQkJCQlpZiAobG9jYWxTdG9yYWdlKSAgewoJCQkJCQl2YXIgY2FsbGJhY2tzID0gbG9jYWxTdG9yYWdlCgkJCQkJCQkJLmdldEl0ZW0oQ0xPVURfQ0FMTEJBQ0tTX0tFWSk7CgkJCQkJCWlmICghY2FsbGJhY2tzKSAgewoJCQkJCQkJY2FsbGJhY2tzID0gIiAiOwoJCQkJCQl9CgkJCQkJCWlmIChjYWxsYmFja3MuaW5kZXhPZigiICIgKyBjYWxsYmFja05hbWUgKyAiICIpIDwgMCkgIHsKCQkJCQkJCWNhbGxiYWNrcyArPSBjYWxsYmFja05hbWUgKyAiICI7CgkJCQkJCX0KCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oQ0xPVURfQ0FMTEJBQ0tTX0tFWSwgY2FsbGJhY2tzKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWNlLnB1c2gucmVnaXN0ZXIoWyBwdXNoSWQgXSwgY2FsbGJhY2spOwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUuZXJyb3IoJ1B1c2ggc2VydmljZSBpcyBub3QgYWN0aXZlJyk7CgkJfQoJfTsKCgl2YXIgQlJJREdFSVRfSU5TVEFMTEVEX0tFWSA9ICJicmlkZ2VpdC5pbnN0YWxsZWQiOwoJdmFyIEJSSURHRUlUX0lOU1RBTExFRF9MT0dfS0VZID0gImJyaWRnZWl0Lmluc3RhbGxlZExvZ2dlZCI7CgoJZnVuY3Rpb24gaGFzSW5zdGFsbGVkVG9rZW4oKXsKCQl2YXIgcmVzdWx0ID0gZmFsc2U7CgkJaWYoIHdpbmRvdy5sb2NhbFN0b3JhZ2UpewoJCQl2YXIgaW5zdGFsbFRpbWVzdGFtcCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEJSSURHRUlUX0lOU1RBTExFRF9LRVkpOwoJCQlpZiggaW5zdGFsbFRpbWVzdGFtcCApewoJCQkJaWYoICF3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShCUklER0VJVF9JTlNUQUxMRURfTE9HX0tFWSkgKXsKCQkJCQljb25zb2xlLmxvZygnYnJpZGdlaXQgaW5zdGFsbGVkICcKCQkJCQkJKyBuZXcgRGF0ZSggcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oQlJJREdFSVRfSU5TVEFMTEVEX0tFWSkpKS50b0dNVFN0cmluZygpKTsKCQkJCQl3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShCUklER0VJVF9JTlNUQUxMRURfTE9HX0tFWSwgJ3RydWUnKTsKCQkJCX0KCQkJCXJlc3VsdCA9IHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0KCglmdW5jdGlvbiBzZXRJbnN0YWxsZWRUb2tlbigpewoJCWlmKCB3aW5kb3cubG9jYWxTdG9yYWdlICl7CgkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKEJSSURHRUlUX0lOU1RBTExFRF9LRVksICcnICsgbmV3IERhdGUoKS5nZXRUaW1lKCkpOwoJCX0KCX0KCgl2YXIgTEFTVFZFUlNJT05fS0VZID0gImJyaWRnZWl0Lmxhc3RhcHB2ZXJzaW9uIjsKCglmdW5jdGlvbiBzZXRMYXN0QXBwVmVyc2lvbih2ZXJzaW9uKSAgewoJCWlmICh3aW5kb3cubG9jYWxTdG9yYWdlKSAgewoJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbShMQVNUVkVSU0lPTl9LRVksIHZlcnNpb24pOwoJCX0KCX0KCglmdW5jdGlvbiBhZGRPcHRpb25zKGJhc2UsIG9wdGlvbnMpICB7CgkJZm9yICh2YXIgcHJvcCBpbiBvcHRpb25zKSAgewoJCQliYXNlW3Byb3BdID0gb3B0aW9uc1twcm9wXTsKCQl9CgkJcmV0dXJuIGJhc2U7Cgl9CgoJZnVuY3Rpb24gb3ZlcmxheU9wdGlvbnMoZGVmYXVsdHMsIG9wdGlvbnMpICB7CgkJdmFyIG1lcmdlZCA9IHt9OwoKCQlhZGRPcHRpb25zKG1lcmdlZCwgZGVmYXVsdHMpOwoJCWFkZE9wdGlvbnMobWVyZ2VkLCBvcHRpb25zKTsKCgkJcmV0dXJuIG1lcmdlZDsKCX0KCgl2YXIgYW5vbkF1dGggPSBuZXcgUHJvbWl6KCk7Cglhbm9uQXV0aC5yZXNvbHZlKCk7CgoJdmFyIGJyaWRnZWl0U2VydmljZURlZmF1bHRzID0gewoJCWFjY291bnQ6ICJpY2Vzb2Z0X3RlY2hub2xvZ2llc19pbmMiLAoJCXJlYWxtOiAiZGVtby5icmlkZ2VpdC5tb2JpIiwKCQlzZXJ2aWNlQmFzZTogImh0dHA6Ly9hcGkuYnJpZGdlaXQubW9iaS8iLAoJCWF1dGg6IGFub25BdXRoCgl9OwoKCS8vUmVhbCBQcm9taXNlIHN1cHBvcnQgc3RhbGxlZCBieSBJRQoJZnVuY3Rpb24gUHJvbWl6KCkgIHsKCQl2YXIgdGhlUHJvbWl6ID0gdGhpczsKCQl2YXIgc3VjY2Vzc2VzID0gW107CgkJdmFyIGZhaWxzID0gW107CgkJdGhpcy50aGVuID0gZnVuY3Rpb24oc3VjY2VzcywgZmFpbCkgIHsKCQkJaWYgKHN1Y2Nlc3MpICB7CgkJCQlzdWNjZXNzZXMucHVzaChzdWNjZXNzKTsKCQkJfQoJCQlpZiAoZmFpbCkgIHsKCQkJCWZhaWxzLnB1c2goZmFpbCk7CgkJCX0KCQl9CgkJZnVuY3Rpb24gY2FsbGFsbChmdW5jcywgYXJncykgIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBmdW5jcy5sZW5ndGg7IGkrKykgewoJCQkJZnVuY3NbaV0uYXBwbHkodGhlUHJvbWl6LCBhcmdzKTsKCQkJfQoJCX0KCQl0aGlzLnJlc29sdmUgPSBmdW5jdGlvbigpICB7CgkJCWNhbGxhbGwoc3VjY2Vzc2VzLCBhcmd1bWVudHMpOwoJCQl0aGVQcm9taXoudGhlbiA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGZhaWwpICB7CgkJCQlzdWNjZXNzLmFwcGx5KHRoZVByb21peiwgYXJndW1lbnRzKTsKCQkJfQoJCX0KCQl0aGlzLnJlamVjdCA9IGZ1bmN0aW9uKCkgIHsKCQkJY2FsbGFsbChmYWlscywgYXJndW1lbnRzKTsKCQkJdGhlUHJvbWl6LnRoZW4gPSBmdW5jdGlvbihzdWNjZXNzLCBmYWlsKSAgewoJCQkJZmFpbC5hcHBseSh0aGVQcm9taXosIGFyZ3VtZW50cyk7CgkJCX0KCQl9Cgl9CgoKCS8qICoqKioqKioqKioqKioqKioqKioqKioqIFBVQkxJQyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCS8qKgoJICogVGhlIHZlcnNpb24gb2YgYnJpZGdlaXQuanMKCSAqIEBwcm9wZXJ0eSB7U3RyaW5nfQoJICovCgliLnZlcnNpb24gPSAiMS4wLjQiOwoKCS8qKgoJICogVGhlIGxhc3QgZGV0ZWN0ZWQgdmVyc2lvbiBvZiB0amUgQnJpZGdlSXQgQXBwCgkgKiBAYWxpYXMgcGx1Z2luLmxhc3RBcHBWZXJzaW9uCgkgKi8KCWIubGFzdEFwcFZlcnNpb24gPSBmdW5jdGlvbigpICB7CgkJaWYgKGxvY2FsU3RvcmFnZSkgIHsKCQkJcmV0dXJuKGxvY2FsU3RvcmFnZS5nZXRJdGVtKExBU1RWRVJTSU9OX0tFWSkpOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX07CgoJLyoqCgkgKiBBcHBsaWNhdGlvbiBwcm92aWRlZCBjYWxsYmFjayB0byBkZXRlY3QgQnJpZGdlSXQgbGF1bmNoIGZhaWx1cmUuCgkgKiBUaGlzIGNhbiBiZSBvdmVycmlkZGVuIHdpdGggYW4gaW1wbGVtZW50YXRpb24gdGhhdCBwcm9tcHRzIHRoZQoJICogdXNlciB0byBkb3dubG9hZCBCcmlkZ2VJdCBhbmQgcG90ZW50aWFsbHkgZmFsbGJhY2sgd2l0aCBhIGRpZmZlcmVudAoJICogYnJvd3NlciBjb250cm9sIHN1Y2ggYXMgaW5wdXQgZmlsZS4gIFRoZSBkaXNwbGF5ZWQgZGlhbG9nIGlzIHJldHVybmVkCgkgKiB0byBhbGxvdyBiYXNpYyBjdXN0b21pemF0aW9uLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4ubGF1bmNoRmFpbGVkCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIHBhc3NlZCB0byB0aGUgY29tbWFuZCB0aGF0IGZhaWxlZAoJICogQHRlbXBsYXRlCgkgKi8KCWIubGF1bmNoRmFpbGVkID0gZnVuY3Rpb24oaWQpICB7CgkJY29uc29sZS5sb2coIkJyaWRnZUl0IG5vdCBhdmFpbGFibGUgZm9yICIgKyBpZCk7CgoJCXZhciBwb3BEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQlwb3BEaXYuc2V0QXR0cmlidXRlKAoJCQkic3R5bGUiLAoJCQkiaGVpZ2h0OmF1dG87IiArCgkJCSJtaW4taGVpZ2h0OjEwMHB4OyIgKwoJCQkicG9zaXRpb246Zml4ZWQ7IiArCgkJCSJib3JkZXI6NXB4IHNvbGlkICM5MTkzQTA7IiArCgkJCSJib3JkZXItcmFkaXVzOjhweDsiICsKCQkJInBhZGRpbmc6MTBweDsiICsKCQkJInRleHQtYWxpZ246Y2VudGVyOyIgKwoJCQkiYm94LXNpemluZzpib3JkZXItYm94OyIgKwoJCQkidG9wOiA1MHB4OyIgKwoJCQkiYmFja2dyb3VuZC1jb2xvcjojRjhGOEY4OyIgKwoJCQkidHJhbnNpdGlvbjpvcGFjaXR5IDVzIGVhc2UtaW4tb3V0OyIgKwoJCQkiei1pbmRleDo5OTk7IiArCgkJCSJvcGFjaXR5OjAuOTU7Iik7CgkJcG9wRGl2LmlubmVySFRNTCA9CgkJCSc8YSBzdHlsZT0iZmxvYXQ6cmlnaHQ7IiAnKwoJCQknb25jbGljaz0iZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBhcmVudE5vZGUpIj4nKwoJCQknJnRpbWVzOzwvYT4nICsKCQkJJzxwPlRoZSBCcmlkZ2VJdCBBcHAgaXMgbWlzc2luZyAuLi4gd291bGQgeW91IGxpa2UgdG8gZG93bmxvYWQgJyArCgkJCSdpdD88L3A+JyArCgkJCSc8YSBocmVmPSInICsgYnJpZGdlaXQuYXBwU3RvcmVVUkwoKSArICciJysKCQkJJyBvbmNsaWNrPSJkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucGFyZW50Tm9kZSkiICcgKwoJCQkndGFyZ2V0PSJfYmxhbmsiPkRvd25sb2FkIHRoZSB1dGlsaXR5IGFwcCBub3c8L2E+JzsKCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHBvcERpdik7CgoJCXZhciBjZW50ZXJEaXYgPSBmdW5jdGlvbigpewoJCQlpZiggd2luZG93LmlubmVyV2lkdGggKXsKCQkJCXZhciBsZWZ0UG9zID0gKHdpbmRvdy5pbm5lcldpZHRoIC0gcG9wRGl2Lm9mZnNldFdpZHRoKSAvMjsKCQkJCXBvcERpdi5zdHlsZS5sZWZ0ID0gJycrbGVmdFBvcyArICdweCc7CgkJCX0KCQl9CgkJY2VudGVyRGl2KCk7CgkJaWYoIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyICl7CgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIGNlbnRlckRpdiwgZmFsc2UpOwoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgY2VudGVyRGl2LCBmYWxzZSk7CgkJfQoKCQlyZXR1cm4gcG9wRGl2OwoKCX07CgoJLyoqCgkgKiBBcHBsaWNhdGlvbiBwcm92aWRlZCBjYWxsYmFjayB0byBkZXRlY3Qgbm9uLXN1cHBvcnRlZCBjbGllbnRzLgoJICogVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiB3aXRoIGFuIGltcGxlbWVudGF0aW9uIHRoYXQgaW5mb3JtcyB0aGUKCSAqIHVzZXIgdGhlIHVzZXIgdGhhdCBuYXRpdmUgbW9iaWxlIGZ1bmN0aW9uYWxpdHkgaXMgb25seSBhdmFpbGFibGUKCSAqIG9uIHN1cHBvcnRlZCBwbGF0Zm9ybXMgb3IgcG90ZW50aWFsbHkgZmFsbGJhY2sgd2l0aCBhIGRpZmZlcmVudAoJICogYnJvd3NlciBjb250cm9sIHN1Y2ggYXMgaW5wdXQgZmlsZSwgd2hpY2ggd291bGQgYmUgYXZhaWxhYmxlIG9uCgkgKiBhbGwgYnJvd3NlcnMuCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIHBhc3NlZCB0byB0aGUgY29tbWFuZCB0aGF0IGZhaWxlZAoJICogQHBhcmFtIHtTdHJpbmd9IGNvbW1hbmQgVGhlIEJyaWRnZUl0IGFwaSBjb21tYW5kIHRoYXQgd2FzIGxhdW5jaGVkCgkgKiBAYWxpYXMgcGx1Z2luLm5vdFN1cHBvcnRlZAoJICogQHRlbXBsYXRlCgkgKi8KCWIubm90U3VwcG9ydGVkID0gZnVuY3Rpb24oaWQsIGNvbW1hbmQpICB7CgkJYWxlcnQoJ1NvcnJ5LCB0aGUgY29tbWFuZCAnICsgY29tbWFuZCArICcgZm9yIEJyaWRnZUl0IGlzIG5vdCBzdXBwb3J0ZWQgb24gdGhpcyBwbGF0Zm9ybScpOwoJfTsKCgoJLyoqCgkgKiBMYXVuY2ggdGhlIGRldmljZSBRUiBDb2RlIHNjYW5uZXIuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIHNjYW4gaXMgY2FwdHVyZWQuCgkgKiBUaGUgcmV0dXJuIHZhbHVlIHdpbGwgYmUgc2V0IHRvIHRoZSB0ZXh0IHJlc3VsdGluZyBmcm9tIHRoZSBzY2FuLgoJICoKCSAqIFRoZSBRUiBDb2RlIHNjYW5uZXIgZG9lcyBub3QgY3VycmVudGx5IGFjY2VwdCBhZGRpdGlvbmFsIHBhcmFtZXRlcnMsCgkgKiBidXQgdGhlc2UgbWF5IHVzZWQgaW4gdGhlIGZ1dHVyZS4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLnNjYW4KCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnBvc3RVUkwgU2VydmVyLXNpZGUgVVJMIGFjY2VwdGluZyBQT1NUIG9mIGNvbW1hbmQgcmVzdWx0IChvcHRpb25hbCkKCSAqCgkgKi8KCWIuc2NhbiA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJzY2FuIiwgaWQsIGNhbGxiYWNrLCBvcHRpb25zKTsKCX07CgoJLyoqCgkgKiBEZXRlY3QgbmVhcmJ5IGlCZWFjb25zLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuIGFuIGlCZWFjb24gaXMgZGV0ZWN0ZWQuCgkgKiBUaGUgcmV0dXJuIHZhbHVlIHdpbGwgYmUgc2V0IHRvIHRoZSByYW5nZSwgbWFqb3IsIGFuZCBtaW5vciB2YWx1ZXMKCSAqIGlmIGF2YWlsYWJsZS4KCSAqCgkgKiBUaGlzIGlzIGN1cnJlbnRseSBhIHByZS1hbHBoYSBmZWF0dXJlIGFuZCBpcyBiZWluZyBkZXZlbG9wZWQgaW5pdGlhbGx5CgkgKiBvbiBpT1MuCgkgKgoJICogQGFsaWFzIHBsdWdpbi5iZWFjb25zCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5wb3N0VVJMIFNlcnZlci1zaWRlIFVSTCBhY2NlcHRpbmcgUE9TVCBvZiBjb21tYW5kIHJlc3VsdCAob3B0aW9uYWwpCgkgKgoJICovCgliLmJlYWNvbnMgPSBmdW5jdGlvbihpZCwgY2FsbGJhY2ssIG9wdGlvbnMpICB7CgkJZGV2aWNlQ29tbWFuZCgiYmVhY29ucyIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCS8qKgoJICogTGF1bmNoIHRoZSBuYXRpdmUgY2FtZXJhLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBwaG90byBpcyBjYXB0dXJlZC4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLmNhbWVyYQoJICogQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgcmV0dXJuIHZhbHVlCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBZGRpdGlvbmFsIGNvbW1hbmQgb3B0aW9ucwoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMucG9zdFVSTCBTZXJ2ZXItc2lkZSBVUkwgYWNjZXB0aW5nIFBPU1Qgb2YgY29tbWFuZCByZXN1bHQgKG9wdGlvbmFsKQoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMubWF4d2lkdGggVGhlIG1heGl1bSB3aWR0aCBmb3IgdGhlIGltYWdlIGluIHBpeGVscwoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMubWF4aGVpZ2h0IFRoZSBtYXhpdW0gaGVpZ2h0IGZvciB0aGUgaW1hZ2UgaW4gcGl4ZWxzCgkgKgoJICovCgliLmNhbWVyYSA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJjYW1lcmEiLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCS8qKgoJICogTGF1bmNoIHRoZSBuYXRpdmUgdmlkZW8gcmVjb3JkZXIuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIHZpZGVvIGhhcyBiZWVuIGNhcHR1cmVkLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uY2FtY29yZGVyCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKgoJICovCgliLmNhbWNvcmRlciA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJjYW1jb3JkZXIiLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCgkvKioKCSAqIExhdW5jaCB0aGUgbmF0aXZlIGF1ZGlvIHJlY29yZGVyLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhdWRpbyBpcyBjYXB0dXJlZC4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLm1pY3JvcGhvbmUKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqCgkgKi8KCWIubWljcm9waG9uZSA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQlkZXZpY2VDb21tYW5kKCJtaWNyb3Bob25lIiwgaWQsIGNhbGxiYWNrLCBvcHRpb25zKTsKCX07CgoJLyoqCgkgKiBMYXVuY2ggdGhlIG5hdGl2ZSBjb250YWN0IGxpc3QuCgkgKgoJICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGNvbnRhY3QgaXMgcmV0cmlldmVkLgoJICoKCSAqIEBhbGlhcyBwbHVnaW4uZmV0Y2hDb250YWN0CgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5maWVsZHMgVGhlIGNvbnRhY3QgZmllbGRzIHRvIHJldHJpZXZlLCBkZWZhdWx0ID0gIm5hbWUsZW1haWwscGhvbmUiCgkgKgoJICovCgliLmZldGNoQ29udGFjdCA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaywgb3B0aW9ucykgIHsKCQl2YXIgb3BzID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIW9wcy5maWVsZHMpICB7CgkJCW9wcy5maWVsZHMgPSAibmFtZSxlbWFpbCxwaG9uZSI7CgkJfQoJCWRldmljZUNvbW1hbmQoImZldGNoQ29udGFjdHMiLCBpZCwgY2FsbGJhY2ssIG9wcyk7Cgl9OwoKCS8qKgoJICogU2VuZCBhbiBTTVMgbWVzc2FnZS4KCSAqCgkgKiBUaGUgc21zIGZ1bmN0aW9uIHdpbGwgc2VuZCBhbiBTTVMgbWVzc2FnZSB0byBhIG51bWJlciBvbiBzdXBwb3J0ZWQKCSAqIHBsYXRmb3Jtcy4gT24gaU9TIGRldmljZXMsIGEgbmF0aXZlIFNNUyBjYWxsIGlzIG1hZGUgdGhyb3VnaCB0aGUKCSAqIEJyaWRnZUl0IHV0aWxpdHkgYXBwLiBPbiBvdGhlciBwbGF0Zm9ybXMgYW4gU01TIFVSTCBwcm90b2NvbCBpcyB1c2VkIGluIGEKCSAqIERPTSBhbmNob3IgZWxlbWVudCwgd2hpY2ggdGhlIGJyb3dzZXIgbWF5IHVzZSB0byBsYXVuY2ggdGhlIGRldmljZQoJICogU01TIGZ1bmN0aW9uYWxpdHksIGlmIGF2YWlsYWJsZS4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLnNtcwoJICogQHBhcmFtIHtTdHJpbmd9IG51bWJlciBUaGUgcGhvbmUgbnVtYmVyIHRvIHNlbmQgdGhlIG1lc3NhZ2UgdG8KCSAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIFRoZSBtZXNzYWdlCgkgKgoJICovCgliLnNtcyA9IGZ1bmN0aW9uKG51bWJlciwgbWVzc2FnZSkgIHsKCQlpZiggIWIuaXNTdXBwb3J0ZWRQbGF0Zm9ybSgnc21zJykgKXsKCQkJYi5ub3RTdXBwb3J0ZWQobnVsbCwgJ3NtcycpOwoJCQlyZXR1cm47CgkJfQoJCWlmKCBudW1iZXIgPT0gJ3VuZGVmaW5lZCcgfHwgbnVtYmVyID09ICcnKQoJCQlyZXR1cm47CgkJaWYoIGIuaXNJT1MoKSB8fCBiLmlzQW5kcm9pZCgpICl7CgkJCWRldmljZUNvbW1hbmQoJ3NtcycsICdfc21zJywgbnVsbCwge246IG51bWJlciwgYm9keTogbWVzc2FnZX0pOwoJCX0KCQllbHNlewoJCQl2YXIgc21zQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwoJCQl2YXIgY2xlYW5OdW1iZXIgPSBudW1iZXIucmVwbGFjZSgvW1xzLVwuXCtdL2csJycpOwoJCQlzbXNCdG4uaHJlZiA9ICdzbXM6KycgKyBjbGVhbk51bWJlciArICc/Ym9keT0nICsgZW5jb2RlVVJJKG1lc3NhZ2UpOwoJCQlzbXNCdG4uc3R5bGUgPSAnZGlzcGxheTpub25lJzsKCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzbXNCdG4pOwoJCQlzbXNCdG4uY2xpY2soKTsKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzbXNCdG4pOwoJCSB9Cgl9OwoKCS8qKgoJICogTGF1bmNoIGFuIEF1Z21lbnRlZCBSZWFsaXR5IHZpZXcuCgkgKgoJICogVGhlIEF1Z21lbnRlZCBSZWFsaXR5IHZpZXcgZGlzcGxheXMgYSBzZXQgb2YgZ2VvZ3JhcGhpYyBpY29ucyBvbgoJICogYSB2aWRlbyBvdmVybGF5LiBUaGUgaWNvbnMgYXJlIHBvc2l0aW9uZWQgYWNjb3JkaW5nIHRvIHRoZQoJICogb3JpZW50YXRpb24gb2YgdGhlIGRldmljZSBzbyB0aGF0IHRoZXkgYXBwZWFyIGluIGEgbGluZS1vZi1zaWdodAoJICogd2l0aCB0aGVpciBwaHlzaWNhbCBnZW9ncmFwaGljIHBvc2l0aW9uLiAgVGhlIHVzZXIgY2FuIHNlbGVjdCBhbgoJICogaWNvbiBhbmQgdGhpcyBpcyByZWxheWVkIGJhY2sgdG8gdGhlIGFwcGxpY2F0aW9uLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhdWdtZW50ZWQgcmVhbGl0eQoJICogdmlldyBleGl0cyB3aXRoIHRoZSB1c2VyIHNlbGVjdGlvbiBwcm92aWRlZCBpbiB0aGUgcmV0dXJuIHZhbHVlLgoJICogVGhlIGNvbW1hbmQgaXMgaW52b2tlZCB3aXRoIGEgbG9jYXRpb25zIHBhcmFtZXRlciBjb250YWluaW5nIGFuCgkgKiBhcnJheSBvZiBuYW1lZCBsb2NhdGlvbnMsIGVhY2ggd2l0aCBhIGNvbW1hLXNlcGFyYXRlZCBsYXRpdHVkZSwKCSAqIGxvbmdpdHVkZSwgYWx0aXR1ZGUsIGRpcmVjdGlvbiwgYW5kIGljb24gVVJMCgkgKgoJICogQGFsaWFzIHBsdWdpbi5hdWdtZW50ZWRSZWFsaXR5CgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5sb2NhdGlvbnMgVGhlIGF1Z21lbnRlZCByZWFsaXR5IGxvY2F0aW9ucyB0byBkaXNwbGF5CgoJICoKCSAqLwoJYi5hdWdtZW50ZWRSZWFsaXR5ID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCS8vY29weSBsb2NhdGlvbnMgZGlyZWN0bHkgaW50byBvcHRpb25zLiBUaGUgSmF2YVNjcmlwdCBBUEkKCQkvL3dpbGwgbm90IGNoYW5nZSwgYnV0IHRoZSBmdXR1cmUgZGV2aWNlQ29tbWFuZCB3aWxsIGFjY2VwdAoJCS8vdGhlIGxvY2F0aW9ucyBhcyBhIHN1YnBhcmFtZXRlciB0byBhdm9pZCB0aGlzIGNvcHlpbmcKCQlpZiAoIWJyaWRnZWl0LnVzZUpTT042NCAmJiBvcHRpb25zICYmIG9wdGlvbnMubG9jYXRpb25zKSAgewoJCQlmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5sb2NhdGlvbnMpICB7CgkJCQlpZiAocmVzZXJ2ZWRQYXJhbXMuaW5kZXhPZihrZXkpIDwgMCkgIHsKCQkJCQlvcHRpb25zW2tleV0gPSBvcHRpb25zLmxvY2F0aW9uc1trZXldOwoJCQkJfQoJCQl9CgkJCWRlbGV0ZSBvcHRpb25zLmxvY2F0aW9uczsKCQl9CgoJCWRldmljZUNvbW1hbmQoImF1ZyIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCS8qKgoJICogQWN0aXZhdGUgbG9jYXRpb24gdHJhY2tpbmcuCgkgKgoJICogTG9jYXRpb24gdHJhY2tpbmcgd2lsbCBydW4gaW4gdGhlCgkgKiBiYWNrZ3JvdW5kIGFjY29yZGluZyB0byB0aGUgc3BlY2lmaWVkIHN0cmF0ZWd5IGFuZCBkdXJhdGlvbiwgYW5kIHdpbGwgUE9TVAoJICogYSBnZW9KU09OIHJlY29yZCB0byB0aGUgc3BlY2lmaWVkIHBvc3RVUkwuCgkgKgoJICogVGhyZWUgc3RyYXRlZ2llcyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDogImNvbnRpbnVvdXMiIHdoZXJlIHRoZSBsb2NhdGlvbgoJICogb2YgdGhlIGRldmljZSB3aWxsIGJlIHVwbG9hZGVkIGFzIGZyZXF1ZW50bHkgYXMgaXQgY2hhbmdlcyAoaW50ZW5kZWQgZm9yCgkgKiB0ZXN0aW5nIG9ubHkgZHVlIHRvIGhpZ2ggcG93ZXIgY29uc3VtcHRpb24pLCAic2lnbmlmaWNhbnQiIHdoZXJlIHRoZQoJICogbG9jYXRpb24gaXMgdXBsb2FkZWQgd2hlbiBpdCBjaGFuZ2VzIHNpZ25pZmljYW50bHksIGFuZCAic3RvcCIgdG8gY2Vhc2UKCSAqIGxvY2F0aW9uIHRyYWNraW5nLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBvbmNlIGxvY2F0aW9uIHRyYWNraW5nIGlzIGFjdGl2YXRlZC4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSByZXR1cm4gdmFsdWUKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFkZGl0aW9uYWwgY29tbWFuZCBvcHRpb25zCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5wb3N0VVJMIFRoZSBVUkwgYWNjZXB0aW5nIHRoZSBnZW9KU09OIFBPU1QKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnN0cmF0ZWd5IFRoZSBzdHJhdGVneSwgImNvbnRpbnVvdXMiLCAic2lnbmlmaWNhbnQiIG9yICJzdG9wIgoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuZHVyYXRpb24gVGhlIGR1cmF0aW9uIGluIGhvdXJzCgkgKiBAYWxpYXMgcGx1Z2luLmdlb1RyYWNrCgkgKgoJICovCgliLmdlb1RyYWNrID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKSAgewoJCWRldmljZUNvbW1hbmQoImdlb3NweSIsIGlkLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9OwoKCS8qKgoJICogUmVnaXN0ZXIgQnJpZGdlSXQgaW50ZWdyYXRpb24gYW5kIGNvbmZpZ3VyZSBDbG91ZCBQdXNoLgoJICoKCSAqIFRoaXMgY2FsbCBpcyBuZWNlc3NhcnkgdG8gb2J0YWluIHRoZSBDbG91ZCBQdXNoIElEIG9mIHRoZQoJICogZGV2aWNlIHNvIHRoYXQgbm90aWZpY2F0aW9ucyBjYW4gYmUgZGVsaXZlcmVkIHdoZW4gdGhlCgkgKiB1c2VyIGlzIG5vdCBjdXJyZW50bHkgdmlld2luZyB5b3VyIGFwcGxpY2F0aW9uIGluIHRoZSBicm93c2VyLgoJICoKCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuIENsb3VkIFB1c2ggcmVnaXN0cmF0aW9uCgkgKiBjb21wbGV0ZXMuCgkgKgoJICogQGFsaWFzIHBsdWdpbi5yZWdpc3RlcgoJICogQGluaGVyaXRkb2MgI3NjYW4KCSAqCgkgKi8KCWIucmVnaXN0ZXIgPSBmdW5jdGlvbihpZCwgY2FsbGJhY2ssIG9wdGlvbnMpICB7CgkJZGV2aWNlQ29tbWFuZCgicmVnaXN0ZXIiLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCgkvKioKCSAqIFZlcmlmeSB0aGF0IEJyaWRnZUl0IENsb3VkIFB1c2ggaXMgcmVnaXN0ZXJlZC4KCSAqCgkgKiBAYWxpYXMgcGx1Z2luLmlzUmVnaXN0ZXJlZAoJICoKCSAqLwoJYi5pc1JlZ2lzdGVyZWQgPSBmdW5jdGlvbigpICB7CgkJcmV0dXJuICEhKGdldENsb3VkUHVzaElkKCkpOwoJfTsKCgkvKioKCSAqIFRleHQtdG8tc3BlZWNoCgkgKgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIHJldHVybiB2YWx1ZQoJICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWRkaXRpb25hbCBjb21tYW5kIG9wdGlvbnMKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnRleHQgVGhlIHRleHQgdG8gYmUgc3Bva2VuCgkgKiBAcGFyYW0ge0Jvb2xlYW59IG9wdGlvbnMucmVzcG9uZCBEZXRlcm1pbmVzIGlmIHZvaWNlIHJlc3BvbnNlIGlzIHJlcXVpcmVkLiBkZWZhdWx0PWZhbHNlCgkgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy52b2ljZSBUeXBlIG9mIHZvaWNlIHRvIGJlIHVzZWQKCSAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLnJhdGUgVGhlIHJhdGUgb2Ygc3BlYWtpbmcuID4gMCBkZWZhdWx0PTEuMAoJICogQHBhcmFtIHtOdW1iZXJ9IG9wdGlvbnMucGl0Y2ggVGhlICBwaXRjaCBvZiB2b2ljZS4gPiAwIGRlZmF1bHQ9MS4yCgkgKiBAcGFyYW0ge051bWJlcn0gb3B0aW9ucy52b2x1bWUgVGhlICAwLjAgPCB2b2x1bWUgPD0xLjAgZGVmYXVsdD1kZXZpY2Ugc2V0dGluZwoJICogQGFsaWFzIHBsdWdpbi5zcGVlY2gKCSAqCgkgKi8KCWIuc3BlZWNoID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrLCBvcHRpb25zKXsKCQlkZXZpY2VDb21tYW5kKCJzcGVlY2giLCBpZCwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfTsKCgoKCS8qKgoJICogVXRpbGl0eSBtZXRob2QgdG8gdW5wYWNrIHVybC1lbmNvZGVkIHBhcmFtZXRlcnMgaW50byBhbiBvYmplY3QuCgkgKgoJICogQGFsaWFzIHBsdWdpbi51cmwyT2JqZWN0CgkgKiBAcGFyYW0ge1N0cmluZ30gZW5jb2RlZCBUaGUgZW5jb2RlZCBVUkwgc3RyaW5nIHRvIHVucGFjawoJICovCgliLnVybDJPYmplY3QgPSBmdW5jdGlvbihlbmNvZGVkKSAgewoJCXJldHVybiB1cmwyT2JqZWN0KGVuY29kZWQpOwoJfTsKCgkvKioKCSAqIFNldCBhbGxvd0Fub255bW91c0NhbGxiYWNrcyB0byB0cnVlIHRvIHRha2UgYWR2YW50YWdlIG9mIHBlcnNpc3RlbnQKCSAqIGNhbGxiYWNrIGZ1bmN0aW9ucyBjdXJyZW50bHkgc3VwcG9ydGVkIG9uIGlPUy4KCSAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW2FsbG93QW5vbnltb3VzQ2FsbGJhY2tzPWZhbHNlXQoJICovCgliLmFsbG93QW5vbnltb3VzQ2FsbGJhY2tzID0gZmFsc2U7CgoJLyoqCgkgKiBTZXQgdXNlSlNPTjY0IHRvIHRydWUgdG8gdGFrZSBhZHZhbnRhZ2Ugb2YgQmFzZTY0IEpTT04KCSAqIGRhdGEgaW50ZXJjaGFuZ2UgYmV0d2VlbiB0aGUgYnJvd3NlciBhbmQgQnJpZGdlSXQgQXBwLgoJICogVGhpcyBwcm9wZXJ0eSBtYXkgYmUgcmVtb3ZlZCBhbmQgYmVjb21lIHRoZSBkZWZhdWx0IHdpdGgKCSAqIGxlZ2FjeSBhcHBsaWNhdGlvbnMgcmVxdWlyZWQgdG8gaW1wb3J0IGFuIG9sZGVyIGNvcHkgb2YgYnJpZGdlaXQuanMuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IFt1c2VKU09ONjQ9ZmFsc2VdCgkgKi8KCWIudXNlSlNPTjY0ID0gZmFsc2U7CgoJLyoqCgkgKiBTZXQgdXNlQmFzZTY0IHRvIHRydWUgdG8gdGFrZSBhZHZhbnRhZ2Ugb2YgQmFzZTY0CgkgKiBlbmNvZGluZyBpbiB0aGUgcmV0dXJuIFVSTCBmcm9tIHRoZSBCcmlkZ2VJdCBBcHAuCgkgKiBUaGlzIHByb3BlcnR5IG1heSBiZSByZW1vdmVkIHdpdGgKCSAqIGxlZ2FjeSBhcHBsaWNhdGlvbnMgcmVxdWlyZWQgdG8gaW1wb3J0IGFuIG9sZGVyIGNvcHkgb2YgYnJpZGdlaXQuanMuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IFt1c2VCYXNlNjQ9dHJ1ZV0KCSAqLwoJYi51c2VCYXNlNjQgPSB0cnVlOwoKCS8qKgoJICogSXMgdGhlIGN1cnJlbnQgYnJvd3NlciBpT1MKCSAqIEBhbGlhcyBwbHVnaW4uaXNJT1MKCSAqLwoJYi5pc0lPUyA9IGZ1bmN0aW9uKCl7CgkJdmFyIGkgPSAwLAoJCQlpT1MgPSBmYWxzZSwKCQkJaURldmljZSA9IFsnaVBhZCcsICdpUGhvbmUnLCAnaVBvZCddOwoKCQlmb3IgKCA7IGkgPCBpRGV2aWNlLmxlbmd0aCA7IGkrKyApIHsKCQkJaWYoIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZihpRGV2aWNlW2ldKSA+IC0xICl7CgkJCQlpT1MgPSB0cnVlOyBicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gaU9TOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGNsaWVudCBhbiBpUGhvbmUKCSAqIEBhbGlhcyBwbHVnaW4uaXNJUGhvbmUKCSAqLwoJYi5pc0lQaG9uZSA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignaVBob25lJykgPiAtMTsKCX07CgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIGlPUyA2CgkgKiBAYWxpYXMgcGx1Z2luLmlzSU9TNgoJICovCgliLmlzSU9TNiA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIC8oaVBhZHxpUGhvbmV8aVBvZCkuKk9TIDZfLy50ZXN0KCBuYXZpZ2F0b3IudXNlckFnZW50ICk7Cgl9OwoKCS8qKgoJICogSXMgdGhlIGN1cnJlbnQgYnJvd3NlciBpT1MgNwoJICogQGFsaWFzIHBsdWdpbi5pc0lPUzcKCSAqLwoJYi5pc0lPUzcgPSBmdW5jdGlvbigpewoJCXJldHVybiAvKGlQYWR8aVBob25lfGlQb2QpLipPUyA3Xy8udGVzdCggbmF2aWdhdG9yLnVzZXJBZ2VudCApOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgaU9TIDcKCSAqIEBhbGlhcyBwbHVnaW4uaXNJT1M4CgkgKi8KCWIuaXNJT1M4ID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gLyhpUGFkfGlQaG9uZXxpUG9kKS4qT1MgOF8vLnRlc3QoIG5hdmlnYXRvci51c2VyQWdlbnQgKTsKCX07CgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIEFuZHJvaWQKCSAqIEBhbGlhcyBwbHVnaW4uaXNBbmRyb2lkCgkgKi8KCWIuaXNBbmRyb2lkID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpCgkJCS5pbmRleE9mKCJhbmRyb2lkIikgPiAtMTsKCX07CgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIEFuZHJvaWQKCSAqIEBhbGlhcyBwbHVnaW4uaXNBbmRyb2lkRnJveW8KCSAqLwoJYi5pc0FuZHJvaWRGcm95byA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQW5kcm9pZCAyLjIiKSA+IC0xOwoJfTsKCgkvKioKCSAqIElzIHRoZSBjdXJyZW50IGJyb3dzZXIgQW5kcm9pZAoJICogQGFsaWFzIHBsdWdpbi5pc0FuZHJvaWRHaW5nZXJCcmVhZE9yR3JlYXRlcgoJICovCgliLmlzQW5kcm9pZEdpbmdlckJyZWFkT3JHcmVhdGVyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gYi5pc0FuZHJvaWQoKSAmJiAhYi5pc0FuZHJvaWRGcm95bygpOwoJfTsKCgoJLyoqCgkgKiBJcyB0aGUgY3VycmVudCBicm93c2VyIFdpbmRvd3MgUGhvbmUgOAoJICogQGFsaWFzIHBsdWdpbi5pc1dpbmRvd3NQaG9uZTgKCSAqLwoJYi5pc1dpbmRvd3NQaG9uZTggPSBmdW5jdGlvbigpewoJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CgkJcmV0dXJuIHVhLmluZGV4T2YoJ0lFTW9iaWxlJykgPiAtMQoJCQl8fCAoIHVhLmluZGV4T2YoJ01TSUUgMTAnKSA+IC0xCgkJCQkmJiB0eXBlb2Ygd2luZG93Lm9yaWVudGF0aW9uICE9PSAndW5kZWZpbmVkJyk7Cgl9OwoKCXZhciBhbmRyb2lkID0gYi5pc0FuZHJvaWQoKSwKCQlzdXBwb3J0ZWRBbmRyb2lkID0gYi5pc0FuZHJvaWRHaW5nZXJCcmVhZE9yR3JlYXRlcigpLAoJCWlPUyA9IGIuaXNJT1MoKSwKCQlpT1M2ID0gYi5pc0lPUzYoKSwKCQlpT1M3ID0gYi5pc0lPUzcoKSwKCQlpT1M4ID0gYi5pc0lPUzgoKSwKCQl3cDggPSBiLmlzV2luZG93c1Bob25lOCgpLAoJCWlQaG9uZSA9IGIuaXNJUGhvbmUoKSwKCQlzdXBwb3J0TWF0cml4OwoKCWIuY29tbWFuZHMgPSBbICdjYW1lcmEnLCAnY2FtY29yZGVyJywnbWljcm9waG9uZScsJ2ZldGNoQ29udGFjdHMnLCdhdWcnLCAncHVzaCcsJ3NjYW4nLCdnZW9zcHknLCdzbXMnLCAgJ2JlYWNvbnMnLCAnc3BlZWNoJ107CglzdXBwb3J0TWF0cml4ID0gewoJCSdpUGhvbmUnOnsKCQkJJzYnOiAgIFt0cnVlLCAgICAgdHJ1ZSwgICAgICAgdHJ1ZSwgICAgICAgIHRydWUsICAgICAgICAgICB0cnVlLCAgdHJ1ZSwgIGZhbHNlLCB0cnVlLCAgICB0cnVlLCAgIGZhbHNlLCAgICAgZmFsc2VdLAoJCQknNyc6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgdHJ1ZSwgIHRydWUsICAgIHRydWUsICAgdHJ1ZSwgICAgICB0cnVlXSwKCQkJJzgnOiAgIFt0cnVlLCAgICAgdHJ1ZSwgICAgICAgdHJ1ZSwgICAgICAgIHRydWUsICAgICAgICAgICB0cnVlLCAgdHJ1ZSwgIHRydWUsICB0cnVlLCAgICB0cnVlLCAgIHRydWUsICAgICAgdHJ1ZV0KCQl9LAoJCSdpUGFkLWlQb2QnOnsKCQkJJzYnOiAgIFt0cnVlLCAgICAgdHJ1ZSwgICAgICAgdHJ1ZSwgICAgICAgIHRydWUsICAgICAgICAgICB0cnVlLCAgdHJ1ZSwgIGZhbHNlLCB0cnVlLCAgICBmYWxzZSwgIGZhbHNlLCAgICAgZmFsc2VdLAoJCQknNyc6ICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIHRydWUsICB0cnVlLCAgdHJ1ZSwgIHRydWUsICAgIGZhbHNlLCAgdHJ1ZSwgICAgICB0cnVlXSwKCQkJJzgnOiAgIFt0cnVlLCAgICAgdHJ1ZSwgICAgICAgdHJ1ZSwgICAgICAgIHRydWUsICAgICAgICAgICB0cnVlLCAgdHJ1ZSwgIHRydWUsICB0cnVlLCAgICBmYWxzZSwgIHRydWUsICAgICAgdHJ1ZV0KCQl9LAoJCSd3cDgnOiAgICAgW3RydWUsICAgICB0cnVlLCAgICAgICB0cnVlLCAgICAgICAgdHJ1ZSwgICAgICAgICAgIGZhbHNlLCB0cnVlLCAgdHJ1ZSwgIGZhbHNlLCAgIHRydWUsICAgZmFsc2UsICAgICBmYWxzZV0sCgkJJ2FuZHJvaWQnOiBbdHJ1ZSwgICAgIHRydWUsICAgICAgIHRydWUsICAgICAgICB0cnVlLCAgICAgICAgICAgZmFsc2UsIHRydWUsICB0cnVlLCAgdHJ1ZSwgICAgdHJ1ZSwgICBmYWxzZSwgICAgIHRydWVdCgl9CgoJLyoqCgkgKiBTZXQgdG8gdHJ1ZSB0byBoYXZlIEF1Z21lbnRlZCBSZWFsaXR5IChpbiBleHBlcmltZW50YWwgc3RhdHVzKSBiZSB1c2VkIG9uIEFuZHJvaWQgKGRlZmF1bHQgZmFsc2UpCgkgKiBAcHJvcGVydHkgb3ZlcnJpZGVBdWdtZW50ZWRSZWFsaXR5QWxwaGFMZXZlbAoJICovCgliLm92ZXJyaWRlQXVnbWVudGVkUmVhbGl0eUFscGhhTGV2ZWwgPSBmYWxzZTsKCgkvKioKCSAqIENoZWNrIGlmIHRoZSBjdXJyZW50IGJyb3dzZXIgaXMgc3VwcG9ydGVkIGJ5IHRoZSBCcmlkZ2VJdCBOYXRpdmUgTW9iaWxlIGFwcC4KCSAqCgkgKiBDdXJyZW50bHkgaU9TLCBBbmRyb2lkLCBhbmQgc29tZSBmZWF0dXJlcyBvbiBXaW5kb3dzIFBob25lIDggYXJlIHN1cHBvcnRlZC4KCSAqIEBwYXJhbSB7U3RyaW5nfSBjb21tYW5kIFRoZSBCcmlkZ2VJdCBBUEkgY29tbWFuZCB0aGF0IG1heSBvciBtYXkgbm90IGJlIHN1cHBvcnRlZAoJICogQGFsaWFzIHBsdWdpbi5pc1N1cHBvcnRlZFBsYXRmb3JtCgkgKi8KCWIuaXNTdXBwb3J0ZWRQbGF0Zm9ybSA9IGZ1bmN0aW9uKGNvbW1hbmQpewoJCWlmKCAncmVnaXN0ZXInID09IGNvbW1hbmQgKXsKCQkJcmV0dXJuIHRydWU7IC8vZG8gbm90IGNoZWNrIHBsYXRmb3JtIGZvciBjbG91ZCBwdXNoIHJlZ2lzdHJhdGlvbgoJCX0KCQl2YXIgc3VwcG9ydGVkID0gZmFsc2U7CgkJaWYoIGFuZHJvaWQgKXsKCQkJaWYoIHN1cHBvcnRlZEFuZHJvaWQgKXsKCQkJCWlmKCAnYXVnJyA9PSBjb21tYW5kICl7CgkJCQkJc3VwcG9ydGVkID0gYi5vdmVycmlkZUF1Z21lbnRlZFJlYWxpdHlBbHBoYUxldmVsOwoJCQkJfQoJCQkJZWxzZXsKCQkJCQlzdXBwb3J0ZWQgPSB0cnVlOwoJCQkJfQoJCQl9CgkJfQoJCWVsc2UgaWYoIHdwOCApewoJCQlyZXR1cm4gc3VwcG9ydE1hdHJpeFsnd3A4J11bYi5jb21tYW5kcy5pbmRleE9mKGNvbW1hbmQpXTsKCQl9CgkJZWxzZSBpZiggaU9TICl7CgkJCS8vaWYgYSBmdXR1cmUgaU9TIHZlcnNpb24gcmVxdWlyZXMgc3BlY2lmaWMgY2hlY2tpbmcsIGFkZGl0aW9uYWwKCQkJLy9jYXNlcyB3aWxsIGJlIGFkZGVkCgkJCWlmKCBpUGhvbmUgKXsKCQkJCWlmKCBpT1M2ICl7CgkJCQkJcmV0dXJuIHN1cHBvcnRNYXRyaXhbJ2lQaG9uZSddWyc2J11bYi5jb21tYW5kcy5pbmRleE9mKGNvbW1hbmQpXTsKCQkJCX0KCQkJCWVsc2UgLyogaWYoIGlPUzcgKSAqLyB7CgkJCQkJcmV0dXJuIHN1cHBvcnRNYXRyaXhbJ2lQaG9uZSddWyc3J11bYi5jb21tYW5kcy5pbmRleE9mKGNvbW1hbmQpXTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCWlmKCBpT1M2ICl7CgkJCQkJcmV0dXJuIHN1cHBvcnRNYXRyaXhbJ2lQYWQtaVBvZCddWyc2J11bYi5jb21tYW5kcy5pbmRleE9mKGNvbW1hbmQpXTsKCQkJCX0KCQkJCWVsc2UgLyogaWYoIGlPUzcgKSAqLyB7CgkJCQkJcmV0dXJuIHN1cHBvcnRNYXRyaXhbJ2lQYWQtaVBvZCddWyc3J11bYi5jb21tYW5kcy5pbmRleE9mKGNvbW1hbmQpXTsKCQkJCX0KCQkJfQoJCX0KCQljb25zb2xlLmxvZygiYnJpZGdlSXQgc3VwcG9ydGVkIHBsYXRmb3JtIGZvciAnIiArIGNvbW1hbmQgKyAiJyBjb21tYW5kOiAiICsgc3VwcG9ydGVkKTsKCQlyZXR1cm4gc3VwcG9ydGVkOwoJfTsKCgkvKioKCSAqIFJldHVybnMgdGhlIGFwcCBzdG9yZSBVUkwgdG8gQnJpZGdlSXQgZm9yIHRoZSBhcHByb3BpcmF0ZSBwbGF0Zm9ybQoJICogQGFsaWFzIHBsdWdpbi5hcHBTdG9yZVVSTAoJICovCgliLmFwcFN0b3JlVVJMID0gZnVuY3Rpb24oKXsKCQlpZiggYi5pc0FuZHJvaWQoKSApIHsKCQkJcmV0dXJuICdodHRwczovL3BsYXkuZ29vZ2xlLmNvbS9zdG9yZS9hcHBzL2RldGFpbHM/aWQ9bW9iaS5icmlkZ2VpdCc7CgkJfQoJCWVsc2UgaWYoIGIuaXNJT1MoKSApIHsKCQkJcmV0dXJuICdodHRwczovL2l0dW5lcy5hcHBsZS5jb20vYXBwL2JyaWRnZWl0L2lkNzI3NzM2NDE0JzsKCQl9CgkJZWxzZSBpZiggYi5pc1dpbmRvd3NQaG9uZTgoKSApIHsKCQkJcmV0dXJuICdodHRwOi8vd2luZG93c3Bob25lLmNvbS9zP2FwcElkPWI5YTFiMjlmLTJiMzAtNGU1ZC05YmYxLWY3NWU3NzNkNzRlMSc7CgkJfQoKCX07CgoJdmFyIGpndWlkOwoKCS8qKgoJICogUmV0dXJucyBhIHBlcnNpc3RlbnQgaWQgdGhhdCBhbGxvd3MgYW4gYXBwbGljYXRpb24gdG8gcGVyc2lzdGVudGx5IG1haW50YWluIGluZm9ybWF0aW9uIGZvcgoJICogYW4gaW5kaXZpZHVhbCB1c2VyIHdpdGhvdXQgcmVxdWlyaW5nIGEgc2VydmVyLXNpZGUgc2Vzc2lvbi4KCSAqIEBhbGlhcyBwbHVnaW4uZ2V0SWQKCSAqLwoJYi5nZXRJZCA9IGZ1bmN0aW9uKCkgIHsKCQl2YXIgSkdVSURfS0VZID0gImJyaWRnZWl0LmpndWlkIjsKCQlpZiAoIWpndWlkKSAgewoJCQlpZiAobG9jYWxTdG9yYWdlKSAgewoJCQkJamd1aWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShKR1VJRF9LRVkpOwoJCQl9CgkJCWlmICghamd1aWQpICB7CgkJCQlqZ3VpZCA9ICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywKCQkJCQlmdW5jdGlvbihjKSB7CgkJCQkJCXZhciByID0gTWF0aC5yYW5kb20oKSoxNnwwLCB2ID0gYyA9PSAneCcgPyByIDogKHImMHgzfDB4OCk7CgkJCQkJCXJldHVybiB2LnRvU3RyaW5nKDE2KTsKCQkJCQl9KTsKCQkJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oSkdVSURfS0VZLCBqZ3VpZCk7CgkJCQl9CgkJCX0KCgkJfQoJCXJldHVybiBqZ3VpZDsKCX0KCS8qKgoJICogU2V0IGdvQnJpZGdlSXRVUkwgdG8gdGhlIFVSTCBvZiB5b3VyIGdvQnJpZGdlSXQuaHRtbCBmaWxlCgkgKiB0byBhbGxvdyB7QGxpbmsgYnJpZGdlaXQjcHVzaCBDbG91ZCBQdXNofSB0byBnbyBiYWNrIHRvIHRoZSBtb3N0IHJlY2VudCBwYWdlCgkgKiBUaGUgZGVmYXVsdHMgb2YgdGhlIGhvc3Qgcm9vdCBhbmQgdGhlIGN1cnJlbnQgcmVsYXRpdmUKCSAqIGRpcmVjdG9yeSBVUkwgZG8gbm90IG5lZWQgdG8gYmUgc3BlY2lmaWVkLiBGb3IgYW4gZXhhbXBsZSwgc2VlCgkgKiBodHRwOi8vYnJpZGdlaXQubW9iaS9kZW1vL2dvQnJpZGdlSXQuaHRtbAoJICoKCSAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbZ29CcmlkZ2VJdFVSTF0KCSAqLwoJYi5nb0JyaWRnZUl0VVJMID0gbnVsbDsKCgl2YXIgQ0xPVURfQ0FMTEJBQ0tTX0tFWSA9ICJicmlkZ2VpdC5jbG91ZGNhbGxiYWNrcyI7CgoJLyoqCgkgKiBQdWJsaWMgY2FsbGJhY2sgdXNlZCBieSBDbG91ZCBQdXNoIGltcGxlbWVudGF0aW9uCgkgKiB0byByZWxheSBwdXNoIGV2ZW50IHRvIGEgbmV3bHkgb3BlbmVkIGJyb3dzZXIgd2luZG93LgoJICogVGhpcyBBUEkgaXMgbm90IGZvciBhcHBsaWNhdGlvbiB1c2UuCgkgKiBAYWxpYXMgcGx1Z2luLmhhbmRsZUNsb3VkUHVzaAoJICogQHByaXZhdGUKCSAqLwoJYi5oYW5kbGVDbG91ZFB1c2ggPSBmdW5jdGlvbiAoKSAgewoJCXZhciBjYWxsYmFja3MgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShDTE9VRF9DQUxMQkFDS1NfS0VZKTsKCQl2YXIgcGFydHMgPSBjYWxsYmFja3Muc3BsaXQoIiAiKTsKCQl2YXIgY2FsbGJhY2s7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewoJCQljYWxsYmFjayA9IGdldE5hbWVkT2JqZWN0KHBhcnRzW2ldKTsKCQkJaWYgKGNhbGxiYWNrKSB7CgkJCQljYWxsYmFjaygpOwoJCQl9CgkJfQoJfTsKCgkvKioKCSAqIEJyaWRnZUl0IFNlcnZpY2VzIGxvZ2luLgoJICogQGFsaWFzIGxvZ2luCgkgKiBAcGFyYW0gdXNlcm5hbWUgVXNlciBuYW1lCgkgKiBAcGFyYW0gcGFzc3dvcmQgVXNlciBwYXNzd29yZAoJICogQHBhcmFtIG9wdGlvbnMgQWRkaXRpb25hbCBvcHRpb25zCgkgKi8KCWIubG9naW4gPSBmdW5jdGlvbih1c2VybmFtZSwgcGFzc3dvcmQsIG9wdGlvbnMpIHsKCQl2YXIgYXV0aCA9IG5ldyBQcm9taXooKTsKCgkJb3B0aW9ucyA9IG92ZXJsYXlPcHRpb25zKGJyaWRnZWl0U2VydmljZURlZmF1bHRzLCBvcHRpb25zKTsKCQkvL25lZWQgdG8gYWxzbyBhbGxvdyBzcGVjaWZpZWQgYXV0aCBVUkwgaW4gb3B0aW9ucwoJCXZhciB1cmkgPSBicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cy5zZXJ2aWNlQmFzZSArICIvYXV0aC8iOwoJCXZhciBsb2dpblVSSSA9IHVyaSArIG9wdGlvbnMuYWNjb3VudCArICIvcmVhbG1zLyIgKyBvcHRpb25zLnJlYWxtICsgIi90b2tlbiI7CgkJdmFyIGxvZ2luUmVxdWVzdCA9IHsKCQkJdXNlcm5hbWU6IHVzZXJuYW1lLAoJCQlwYXNzd29yZDogcGFzc3dvcmQKCQl9CgkJanNvblBPU1QobG9naW5VUkksIGxvZ2luUmVxdWVzdCkudGhlbigKCQkJZnVuY3Rpb24oanNvblJlc3VsdCkgewoJCQkJYWRkT3B0aW9ucyhhdXRoLCBqc29uUmVzdWx0KTsKCQkJCWF1dGgucmVzb2x2ZShhdXRoKTsKCQkJfSwKCQkJZnVuY3Rpb24oZXJyKSB7CgkJCQlhdXRoLnJlamVjdChlcnIpOwoJCQl9CgkJKTsKCgkJLy9zYXZlIGRlZmF1bHQgYXV0aG9yaXphdGlvbiBpZiBkZWZhdWx0IHJlYWxtCgkJaWYgKG9wdGlvbnMuYWNjb3VudCA9PSBicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cy5hY2NvdW50ICYmIG9wdGlvbnMucmVhbG0gPT09IGJyaWRnZWl0U2VydmljZURlZmF1bHRzLnJlYWxtKSAgewoJCQlicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cy5hdXRoID0gYXV0aDsKCQl9CgkJcmV0dXJuIGF1dGg7Cgl9CgoJLyoqCgkgKiBTZXQgdXAgQnJpZGdlSXQgU2VydmljZXMuCgkgKiBAYWxpYXMgdXNlU2VydmljZXMKCSAqIEBwYXJhbSBwYXJhbSBvYmplY3Qgd2l0aCBuYW1lZCBwYXJhbWV0ZXJzCgkgKi8KCWIudXNlU2VydmljZXMgPSBmdW5jdGlvbihwYXJhbSkgewoJCWlmICgib2JqZWN0IiA9PT0gdHlwZW9mIGFyZ3VtZW50c1swXSkgIHsKCQkJYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMgPQoJCQkJCW92ZXJsYXlPcHRpb25zKGJyaWRnZWl0U2VydmljZURlZmF1bHRzLCBwYXJhbSk7CgkJfQoJfQoKCS8qKgoJICogQ29uZmlndXJlIFB1c2ggc2VydmljZSBhbmQgY29ubmVjdCB0byBpdC4KCSAqIEBhbGlhcyBwbHVnaW4udXNlUHVzaFNlcnZpY2UKCSAqIEBwYXJhbSB1cmkgdGhlIGxvY2F0aW9uIG9mIHRoZSBzZXJ2aWNlCgkgKiBAcGFyYW0gYXBpa2V5CgkgKi8KCWIudXNlUHVzaFNlcnZpY2UgPSBmdW5jdGlvbih1cmksIGFwaWtleSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvdmVybGF5T3B0aW9ucyhicmlkZ2VpdFNlcnZpY2VEZWZhdWx0cywgb3B0aW9ucyk7CgoJCWlmICgwID09IGFyZ3VtZW50cy5sZW5ndGgpICB7CgkJCXVyaSA9IGJyaWRnZWl0U2VydmljZURlZmF1bHRzLnNlcnZpY2VCYXNlICsgIi9wdXNoIjsKCQl9IGVsc2UgaWYgKCJvYmplY3QiID09PSB0eXBlb2YgYXJndW1lbnRzWzBdKSAgewoJCQlpZiAoISFhcmd1bWVudHNbMF0uYWNjb3VudCkgIHsKCQkJCWFjY291bnQgPSBhcmd1bWVudHNbMF0uYWNjb3VudDsKCQkJfQoJCQlpZiAoISFhcmd1bWVudHNbMF0ucmVhbG0pICB7CgkJCQlyZWFsbSA9IGFyZ3VtZW50c1swXS5yZWFsbTsKCQkJfQoJCQlpZiAoISFhcmd1bWVudHNbMF0uc2VydmljZUJhc2UpICB7CgkJCQl1cmkgPSBhcmd1bWVudHNbMF0uc2VydmljZUJhc2UgKyAiL3B1c2giOwoJCQl9CgkJCWlmICghIWFyZ3VtZW50c1swXS5hdXRoKSAgewoJCQkJYXV0aCA9IGFyZ3VtZW50c1swXS5hdXRoOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy9sZWdhY3kgdXJpLGFwaWtleQoJCX0KCgkJYnJpZGdlaXRTZXJ2aWNlRGVmYXVsdHMuYXV0aC50aGVuKGZ1bmN0aW9uKCkgewoJCQlsb2FkUHVzaFNlcnZpY2UodXJpLCBhcGlrZXksIG9wdGlvbnMpOwoJCX0pOwoJfTsKCgkvKioKCSAqIEFkZCBsaXN0bmVyIGZvciBub3RpZmljYXRpb25zIGJlbG9uZ2luZyB0byB0aGUgc3BlY2lmaWVkIGdyb3VwLgoJICogQ2FsbGJhY2tzIG11c3QgYmUgcGFzc2VkIGJ5IG5hbWUgdG8gcmVjZWl2ZSBjbG91ZCBwdXNoIG5vdGlmaWNhdGlvbnMsCgkgKiByZWdhcmRsZXNzIG9mIGJyaWRnZWl0LmFsbG93QW5vbnltb3VzQ2FsbGJhY2tzIHNldHRpbmcKCSAqIEBwYXJhbSBncm91cAoJICogQHBhcmFtIGNhbGxiYWNrCgkgKiBAYWxpYXMgcGx1Z2luLmFkZFB1c2hMaXN0ZW5lcgoJICovCgliLmFkZFB1c2hMaXN0ZW5lciA9IGZ1bmN0aW9uKGdyb3VwLCBjYWxsYmFjaykgewoJCXB1c2hQcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7CgkJCWFkZFB1c2hMaXN0ZW5lckltcGwoZ3JvdXAsIGNhbGxiYWNrKTsKCQl9KTsKCX07CgoJLyoqCgkgKiBBdWdtZW50IGEgVVJMIHNvIHRoYXQgY2FsbGJhY2tzIHdpbGwgYmUgaW52b2tlZCB1cG9uIENsb3VkIFB1c2gKCSAqIHJldHVybi4KCSAqIElmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50LCB0aGUgY3VycmVudCBVUkwgaXMgdXNlZC4KCSAqIEBwYXJhbSB1cmwKCSAqIEBhbGlhcyBwbHVnaW4uY2xvdWRQdXNoUmV0dXJuVVJMCgkgKi8KCWIuY2xvdWRQdXNoUmV0dXJuVVJMID0gZnVuY3Rpb24odXJsKSB7CgkJaWYgKCF1cmwpICB7CgkJCWlmIChsb2NhbFN0b3JhZ2UpICB7CgkJCQl1cmwgPSBsb2NhbFN0b3JhZ2VbTEFTVF9QQUdFX0tFWV07CgkJCX0KCQl9CgkJaWYgKCF1cmwpICB7CgkJCXVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwoJCX0KCQl2YXIgc2VxID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCQl2YXIgdXJsRXh0cmEgPQoJCQlidG9hKCIhaD0iICsgZXNjYXBlKCJjPWJyaWRnZWl0LmhhbmRsZUNsb3VkUHVzaCZzZXE9IiArIHNlcSkpOwoJCXVybEV4dHJhID0gdXJsRXh0cmEucmVwbGFjZSgvPS9nLCJ+Iik7CgkJdXJsRXh0cmEgPSB1cmxFeHRyYS5yZXBsYWNlKC9cLy9nLCIuIik7CgkJdmFyIHJldHVyblVSTCA9IHVybCArICIjaWNlbW9iaWxlc3hfIiArIHVybEV4dHJhOwoJCXJldHVybiByZXR1cm5VUkw7Cgl9OwoKCS8qKgoJICogUHVzaCBub3RpZmljYXRpb24gdG8gdGhlIGdyb3VwLgoJICoKCSAqIFRoaXMgd2lsbCByZXN1bHQgaW4gYW4gQWpheCBQdXNoIChhbmQgYXNzb2NpYXRlZCBjYWxsYmFjaykKCSAqIHRvIGFueSB3ZWIgcGFnZXMgdGhhdCBoYXZlIGFkZGVkIGEgcHVzaCBsaXN0ZW5lciB0byB0aGUKCSAqIHNwZWNpZmllZCBncm91cC4gIElmIENsb3VkIFB1c2ggb3B0aW9ucyBhcmUgcHJvdmlkZWQKCSAqIChvcHRpb25zLnN1YmplY3QgYW5kIG9wdGlvbnMuZGV0YWlsKSBhIENsb3VkIFB1c2ggd2lsbAoJICogYmUgZGlzcGF0Y2hlZCBhcyBhIGhvbWUgc2NyZWVuIG5vdGlmaWNhdGlvbiB0byBhbnkgZGV2aWNlcwoJICogdW5hYmxlIHRvIHJlY2lldmUgdGhlIEFqYXggUHVzaCB2aWEgdGhlIHdlYiBwYWdlLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBncm91cE5hbWUgVGhlIEFqYXggUHVzaCBncm91cCBuYW1lIHRvIHB1c2ggdG8KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdGhhdCBhIG5vdGlmaWNhdGlvbiBjYW4gY2FycnkKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnN1YmplY3QgVGhlIHN1YmplY3QgaGVhZGluZyBmb3IgdGhlIG5vdGlmaWNhdGlvbgoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMubWVzc2FnZSBUaGUgbWVzc2FnZSB0ZXh0IHRvIGJlIHNlbnQgaW4gdGhlIG5vdGlmaWNhdGlvbiBib2R5CgkgKiBAYWxpYXMgcGx1Z2luLnB1c2gKCSAqLwoJYi5wdXNoID0gZnVuY3Rpb24oZ3JvdXBOYW1lLCBvcHRpb25zKSB7CgkJaWYgKCFhYnNvbHV0ZUdvQnJpZGdlSXRVUkwpICB7CgkJCWlmICghIWJyaWRnZWl0LmdvQnJpZGdlSXRVUkwpICB7CgkJCQlhYnNvbHV0ZUdvQnJpZGdlSXRVUkwgPSBnZXRBYnNvbHV0ZVVSTChicmlkZ2VpdC5nb0JyaWRnZUl0VVJMKTsKCQkJfQoJCX0KCQlpZiAoISFhYnNvbHV0ZUdvQnJpZGdlSXRVUkwpICB7CgkJCWlmIChvcHRpb25zICYmICFvcHRpb25zLnVybCkgIHsKCQkJCW9wdGlvbnMudXJsID0gYWJzb2x1dGVHb0JyaWRnZUl0VVJMOwoJCQl9CgkJfQoJCWlmIChpY2UgJiYgaWNlLnB1c2ggJiYgaWNlLnB1c2guY29uZmlndXJhdGlvbi5jb250ZXh0UGF0aCkgewoJCQljb25zb2xlLmxvZygiYnJpZGdlaXQucHVzaCAiICsgSlNPTi5zdHJpbmdpZnkob3B0aW9ucykpOwoJCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRlbGF5KSAgewoJCQkJaWNlLnB1c2gubm90aWZ5KGdyb3VwTmFtZSwgb3B0aW9ucywgb3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQlpY2UucHVzaC5ub3RpZnkoZ3JvdXBOYW1lLCBvcHRpb25zKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWNvbnNvbGUuZXJyb3IoJ1B1c2ggc2VydmljZSBpcyBub3QgYWN0aXZlJyk7CgkJfQoJfTsKCgkvKioKCSAqIFB1c2ggbm90aWZpY2F0aW9uIHRvIG9uZSBvciBtb3JlIGdyb3VwcyByZXN1bHRpbmcgZnJvbSBhCgkgKiBxdWVyeSB0byB0aGUgRG9jIFNlcnZpY2UuICBUaGUgcXVlcnkgaXMgdG8gYmUgaW4gTW9uZ29EQgoJICogZm9ybWF0LgoJICoKCSAqIFRoaXMgd2lsbCByZXN1bHQgaW4gYW4gQWpheCBQdXNoIChhbmQgYXNzb2NpYXRlZCBjYWxsYmFjaykKCSAqIHRvIGFueSB3ZWIgcGFnZXMgdGhhdCBoYXZlIGFkZGVkIGEgcHVzaCBsaXN0ZW5lciB0byBhIGdyb3VwCgkgKiB0aGF0IHJlc3VsdGVkIGZyb20gdGhlIHF1ZXJ5IHNlbnQgdG8gdGhlIERvYyBTZXJ2aWNlLiAgSWYKCSAqIENsb3VkIFB1c2ggb3B0aW9ucyBhcmUgcHJvdmlkZWQgKG9wdGlvbnMuc3ViamVjdCBhbmQKCSAqIG9wdGlvbnMuZGV0YWlsKSBhIENsb3VkIFB1c2ggd2lsbCBiZSBkaXNwYXRjaGVkIGFzIGEgaG9tZQoJICogc2NyZWVuIG5vdGlmaWNhdGlvbiB0byBhbnkgZGV2aWNlcyB1bmFibGUgdG8gcmVjZWl2ZSB0aGUKCSAqIEFqYXggUHVzaCB2aWEgdGhlIHdlYiBwYWdlLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBkb2NTZXJ2aWNlUXVlcnkgVGhlIHF1ZXJ5IHRvIGJlIHNlbnQgdG8gdGhlIERvYyBTZXJ2aWNlLgoJICogQHBhcmFtIHtTdHJpbmd9IGRvY1NlcnZpY2VGaWVsZHMgVGhlIGZpZWxkcyB0byBiZSBzZW50IHRvIHRoZSBEb2MgU2VydmljZS4KCSAqIEBwYXJhbSB7U3RyaW5nfSBkb2NTZXJ2aWNlT3B0aW9ucyBUaGUgb3B0aW9ucyB0byBiZSBzZW50IHRvIHRoZSBEb2MgU2VydmljZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdGhhdCBhIG5vdGlmaWNhdGlvbiBjYW4gY2FycnkKCSAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLnN1YmplY3QgVGhlIHN1YmplY3QgaGVhZGluZyBmb3IgdGhlIG5vdGlmaWNhdGlvbgoJICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMubWVzc2FnZSBUaGUgbWVzc2FnZSB0ZXh0IHRvIGJlIHNlbnQgaW4gdGhlIG5vdGlmaWNhdGlvbiBib2R5CgkgKiBAYWxpYXMgcGx1Z2luLnB1c2hRdWVyeQoJICovCiAJYi5wdXNoUXVlcnkgPSBmdW5jdGlvbihkb2NTZXJ2aWNlUXVlcnksIGRvY1NlcnZpY2VGaWVsZHMsIGRvY1NlcnZpY2VPcHRpb25zLCBvcHRpb25zKSB7CgkJaWYgKCFhYnNvbHV0ZUdvQnJpZGdlSXRVUkwpICB7CgkJCWlmICghIWJyaWRnZWl0LmdvQnJpZGdlSXRVUkwpICB7CgkJCQlhYnNvbHV0ZUdvQnJpZGdlSXRVUkwgPSBnZXRBYnNvbHV0ZVVSTChicmlkZ2VpdC5nb0JyaWRnZUl0VVJMKTsKCQkJfQoJCX0KCQlpZiAoISFhYnNvbHV0ZUdvQnJpZGdlSXRVUkwpICB7CgkJCWlmIChvcHRpb25zICYmICFvcHRpb25zLnVybCkgIHsKCQkJCW9wdGlvbnMudXJsID0gYWJzb2x1dGVHb0JyaWRnZUl0VVJMOwoJCQl9CgkJfQoJCWlmIChpY2UgJiYgaWNlLnB1c2ggJiYgaWNlLnB1c2guY29uZmlndXJhdGlvbi5jb250ZXh0UGF0aCkgewoJCQlpZiAob3B0aW9ucykgewoJCQkJY29uc29sZS5sb2coImJyaWRnZWl0LnB1c2ggIiArIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMpKTsKCQkJfQoJCQlpY2UucHVzaC5ub3RpZnlRdWVyeShkb2NTZXJ2aWNlUXVlcnksIGRvY1NlcnZpY2VGaWVsZHMsIGRvY1NlcnZpY2VPcHRpb25zLCBvcHRpb25zKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmVycm9yKCdQdXNoIHNlcnZpY2UgaXMgbm90IGFjdGl2ZScpOwoJCX0KCX07CgoJLy9hbmRyb2lkIGZ1bmN0aW9ucyBhcyBmdWxsIHBhZ2UgbG9hZAoJYWRkT25Mb2FkTGlzdGVuZXIobG9hZENvbXBsZXRlKTsKCWFkZE9uTG9hZExpc3RlbmVyKGNoZWNrRXhlY0RldmljZVJlc3BvbnNlKTsKICAgIGxvYWRDb21wbGV0ZSgpOwoJY2hlY2tFeGVjRGV2aWNlUmVzcG9uc2UoKTsKfSkoYnJpZGdlaXQpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 14:07:29 GMT",
                    "Content-Length": "52301",
                    "Date": "Thu, 06 Nov 2014 14:07:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}