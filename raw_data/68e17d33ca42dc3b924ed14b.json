{
    "url": "http://localhost:9999/ngryman/page.js/index.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statement:<ul><li>location.replace(location.href.split('#')[0] + '#' + this.canonicalPath);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ngryman/page.js/index.js",
                "path": "/ngryman/page.js/index.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uZ3J5bWFuL3BhZ2UuanMvaW5kZXguanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTE0NTENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6MzU6NTAgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjM1OjUwIEdNVA0KDQohKGZ1bmN0aW9uKCkgewoKICAvKioKICAgKiBQZXJmb3JtIGluaXRpYWwgZGlzcGF0Y2guCiAgICovCgogIHZhciBkaXNwYXRjaCA9IHRydWU7CgogIC8qKgogICAqIEJhc2UgcGF0aC4KICAgKi8KCiAgdmFyIGJhc2UgPSAnJzsKCiAgLyoqCiAgICogUnVubmluZyBmbGFnLgogICAqLwoKICB2YXIgcnVubmluZzsKCiAgLyoqCiAgICogUG9wIHN0YXRlIHJlYWR5IGZsYWcuCiAgICovCgogIHZhciByZWFkeSA9IGZhbHNlOwoKICAvKioKICAgKiBJbml0aWFsIHVybC4KICAgKi8KCiAgdmFyIGluaXRpYWxVcmwgPSBsb2NhdGlvbi5ocmVmOwoKICAvKioKICAgKiBMb2NrIGZsYWcuCiAgICovCgogIHZhciBsb2NrID0gZmFsc2U7CgogIC8qKgogICAqIGhpc3RvcnkgYXBpIGZsYWcuCiAgICovCiAgdmFyIGhpc3RvcnlBcGkgPSAoaGlzdG9yeS5wdXNoU3RhdGUgJiYgJ2ZpbGU6JyAhPSBsb2NhdGlvbi5wcm90b2NvbCk7CgogIC8qKgogICAqIFJlZ2lzdGVyIGBwYXRoYCB3aXRoIGNhbGxiYWNrIGBmbigpYCwKICAgKiBvciByb3V0ZSBgcGF0aGAsIG9yIGBwYWdlLnN0YXJ0KClgLgogICAqCiAgICogICBwYWdlKGZuKTsKICAgKiAgIHBhZ2UoJyonLCBmbik7CiAgICogICBwYWdlKCcvdXNlci86aWQnLCBsb2FkLCB1c2VyKTsKICAgKiAgIHBhZ2UoJy91c2VyLycgKyB1c2VyLmlkLCB7IHNvbWU6ICd0aGluZycgfSk7CiAgICogICBwYWdlKCcvdXNlci8nICsgdXNlci5pZCk7CiAgICogICBwYWdlKCk7CiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gcGF0aAogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuLi4uCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgZnVuY3Rpb24gcGFnZShwYXRoLCBmbikgewogICAgLy8gPGNhbGxiYWNrPgogICAgaWYgKCdmdW5jdGlvbicgPT0gdHlwZW9mIHBhdGgpIHsKICAgICAgcmV0dXJuIHBhZ2UoJyonLCBwYXRoKTsKICAgIH0KCiAgICAvLyByb3V0ZSA8cGF0aD4gdG8gPGNhbGxiYWNrIC4uLj4KICAgIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiBmbikgewogICAgICB2YXIgcm91dGUgPSBuZXcgUm91dGUocGF0aCk7CiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcGFnZS5jYWxsYmFja3MucHVzaChyb3V0ZS5taWRkbGV3YXJlKGFyZ3VtZW50c1tpXSkpOwogICAgICB9CiAgICAvLyBzaG93IDxwYXRoPiB3aXRoIFtzdGF0ZV0KICAgIH0gZWxzZSBpZiAoJ3N0cmluZycgPT0gdHlwZW9mIHBhdGgpIHsKICAgICAgcGFnZS5zaG93KHBhdGgsIGZuKTsKICAgIC8vIHN0YXJ0IFtvcHRpb25zXQogICAgfSBlbHNlIHsKICAgICAgcGFnZS5zdGFydChwYXRoKTsKICAgIH0KICB9CgogIC8qKgogICAqIENhbGxiYWNrIGZ1bmN0aW9ucy4KICAgKi8KCiAgcGFnZS5jYWxsYmFja3MgPSBbXTsKCiAgLyoqCiAgICogR2V0IG9yIHNldCBiYXNlcGF0aCB0byBgcGF0aGAuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2UuYmFzZSA9IGZ1bmN0aW9uKHBhdGgpIHsKICAgIGlmICgwID09IGFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBiYXNlOwogICAgYmFzZSA9IHBhdGg7CiAgfTsKCiAgLyoqCiAgICogQmluZCB3aXRoIHRoZSBnaXZlbiBgb3B0aW9uc2AuCiAgICoKICAgKiBPcHRpb25zOgogICAqCiAgICogICAgLSBgY2xpY2tgIGJpbmQgdG8gY2xpY2sgZXZlbnRzIFt0cnVlXQogICAqICAgIC0gYHBvcHN0YXRlYCBiaW5kIHRvIHBvcHN0YXRlIFt0cnVlXQogICAqICAgIC0gYGRpc3BhdGNoYCBwZXJmb3JtIGluaXRpYWwgZGlzcGF0Y2ggW3RydWVdCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2Uuc3RhcnQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIGlmIChydW5uaW5nKSByZXR1cm47CiAgICBydW5uaW5nID0gdHJ1ZTsKICAgIGlmIChmYWxzZSA9PT0gb3B0aW9ucy5kaXNwYXRjaCkgZGlzcGF0Y2ggPSBmYWxzZTsKICAgIGlmIChmYWxzZSAhPT0gb3B0aW9ucy5wb3BzdGF0ZSkgewogICAgICBpZiAoaGlzdG9yeUFwaSkgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIG9ucG9wc3RhdGUsIGZhbHNlKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIG9uaGFzaGNoYW5nZSwgZmFsc2UpOwogICAgICB9CiAgICB9CiAgICBpZiAoZmFsc2UgIT09IG9wdGlvbnMuY2xpY2spIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG9uY2xpY2ssIGZhbHNlKTsKICAgIGlmICghZGlzcGF0Y2gpIHJldHVybjsKICAgIHBhZ2UucmVwbGFjZShsb2NhdGlvbi5oYXNoID8gbG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpIDogbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2gKICAgICAgLCBudWxsCiAgICAgICwgdHJ1ZQogICAgICAsIGRpc3BhdGNoKTsKICB9OwoKICAvKioKICAgKiBVbmJpbmQgY2xpY2sgYW5kIHBvcHN0YXRlIGV2ZW50IGhhbmRsZXJzLgogICAqCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgcGFnZS5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICBydW5uaW5nID0gZmFsc2U7CiAgICByZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIG9uY2xpY2ssIGZhbHNlKTsKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgb25wb3BzdGF0ZSwgZmFsc2UpOwogIH07CgogIC8qKgogICAqIFNob3cgYHBhdGhgIHdpdGggb3B0aW9uYWwgYHN0YXRlYCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlzcGF0Y2gKICAgKiBAcmV0dXJuIHtDb250ZXh0fQogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2Uuc2hvdyA9IGZ1bmN0aW9uKHBhdGgsIHN0YXRlLCBkaXNwYXRjaCkgewogICAgdmFyIGN0eCA9IG5ldyBDb250ZXh0KHBhdGgsIHN0YXRlKTsKICAgIGlmIChmYWxzZSAhPT0gZGlzcGF0Y2gpIHBhZ2UuZGlzcGF0Y2goY3R4KTsKICAgIGlmICghY3R4LnVuaGFuZGxlZCkgY3R4LnB1c2hTdGF0ZSgpOwogICAgcmV0dXJuIGN0eDsKICB9OwoKICAvKioKICAgKiBSZXBsYWNlIGBwYXRoYCB3aXRoIG9wdGlvbmFsIGBzdGF0ZWAgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgKiBAcmV0dXJuIHtDb250ZXh0fQogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2UucmVwbGFjZSA9IGZ1bmN0aW9uKHBhdGgsIHN0YXRlLCBpbml0LCBkaXNwYXRjaCkgewogICAgdmFyIGN0eCA9IG5ldyBDb250ZXh0KHBhdGgsIHN0YXRlKTsKICAgIGN0eC5pbml0ID0gaW5pdDsKICAgIGlmIChudWxsID09IGRpc3BhdGNoKSBkaXNwYXRjaCA9IHRydWU7CiAgICBpZiAoZGlzcGF0Y2gpIHBhZ2UuZGlzcGF0Y2goY3R4KTsKICAgIGN0eC5zYXZlKCk7CiAgICByZXR1cm4gY3R4OwogIH07CgogIC8qKgogICAqIERpc3BhdGNoIHRoZSBnaXZlbiBgY3R4YC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBjdHgKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgcGFnZS5kaXNwYXRjaCA9IGZ1bmN0aW9uKGN0eCkgewogICAgdmFyIGkgPSAwOwoKICAgIGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgIHZhciBmbiA9IHBhZ2UuY2FsbGJhY2tzW2krK107CiAgICAgIGlmICghZm4pIHJldHVybiB1bmhhbmRsZWQoY3R4KTsKICAgICAgZm4oY3R4LCBuZXh0KTsKICAgIH0KCiAgICBuZXh0KCk7CiAgfTsKCiAgLyoqCiAgICogVW5oYW5kbGVkIGBjdHhgLiBXaGVuIGl0J3Mgbm90IHRoZSBpbml0aWFsCiAgICogcG9wc3RhdGUgdGhlbiByZWRpcmVjdC4gSWYgeW91IHdpc2ggdG8gaGFuZGxlCiAgICogNDA0cyBvbiB5b3VyIG93biB1c2UgYHBhZ2UoJyonLCBjYWxsYmFjaylgLgogICAqCiAgICogQHBhcmFtIHtDb250ZXh0fSBjdHgKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgZnVuY3Rpb24gdW5oYW5kbGVkKGN0eCkgewogICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPT0gY3R4LmNhbm9uaWNhbFBhdGgpIHJldHVybjsKICAgIHBhZ2Uuc3RvcCgpOwogICAgY3R4LnVuaGFuZGxlZCA9IHRydWU7CiAgICB3aW5kb3cubG9jYXRpb24gPSBjdHguY2Fub25pY2FsUGF0aDsKICB9CgogIC8qKgogICAqIEluaXRpYWxpemUgYSBuZXcgInJlcXVlc3QiIGBDb250ZXh0YAogICAqIHdpdGggdGhlIGdpdmVuIGBwYXRoYCBhbmQgb3B0aW9uYWwgaW5pdGlhbCBgc3RhdGVgLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBmdW5jdGlvbiBDb250ZXh0KHBhdGgsIHN0YXRlKSB7CiAgICBpZiAoJy8nID09IHBhdGhbMF0gJiYgMCAhPSBwYXRoLmluZGV4T2YoYmFzZSkpIHBhdGggPSBiYXNlICsgcGF0aDsKICAgIC8vIGZpeGVzIGFuZHJvaWQgMy4wIHdoaWNoIGRvZXMgbm90IHByZXBlbmQgYSBzbGFzaAogICAgcGF0aCA9ICcvJyAhPSBwYXRoWzBdID8gJy8nICsgcGF0aCA6IHBhdGg7CiAgICAvLyBpZiBmaWxlIGlzIHRoZSBwcm90b2NvbCwgcmV3cml0ZSB1cmwKICAgIGlmICgnZmlsZTonID09IGxvY2F0aW9uLnByb3RvY29sKSB7CiAgICAgIC8vIHJvb3QKICAgICAgaWYgKHBhdGggPT0gbG9jYXRpb24ucGF0aG5hbWUpIHsKICAgICAgICBwYXRoID0gJy8nOwogICAgICB9CiAgICAgIC8vIG90aGVyIHBhdGhzIGhhdmUgdGhlIGRyaXZlIHByZXBlbmRlZCwgZW5zdXJlIHdlIGdldCBvbmx5IHRoZSBsYXN0IHBhcnQKICAgICAgZWxzZSB7CiAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKHBhdGgubGFzdEluZGV4T2YoJy8nKSk7CiAgICAgIH0KICAgIH0KICAgIHZhciBpID0gcGF0aC5pbmRleE9mKCc/Jyk7CiAgICB0aGlzLmNhbm9uaWNhbFBhdGggPSBwYXRoOwogICAgdGhpcy5wYXRoID0gcGF0aC5yZXBsYWNlKGJhc2UsICcnKSB8fCAnLyc7CiAgICB0aGlzLnRpdGxlID0gZG9jdW1lbnQudGl0bGU7CiAgICB0aGlzLnN0YXRlID0gc3RhdGUgfHwge307CiAgICB0aGlzLnN0YXRlLnBhdGggPSBwYXRoOwogICAgdGhpcy5xdWVyeXN0cmluZyA9IH5pID8gcGF0aC5zbGljZShpICsgMSkgOiAnJzsKICAgIHRoaXMucGF0aG5hbWUgPSB+aSA/IHBhdGguc2xpY2UoMCwgaSkgOiBwYXRoOwogICAgdGhpcy5wYXJhbXMgPSBbXTsKICB9CgogIC8qKgogICAqIEV4cG9zZSBgQ29udGV4dGAuCiAgICovCgogIHBhZ2UuQ29udGV4dCA9IENvbnRleHQ7CgogIC8qKgogICAqIFB1c2ggc3RhdGUuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgQ29udGV4dC5wcm90b3R5cGUucHVzaFN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoaGlzdG9yeUFwaSkgewogICAgICBoaXN0b3J5LnB1c2hTdGF0ZSh0aGlzLnN0YXRlLCB0aGlzLnRpdGxlLCB0aGlzLmNhbm9uaWNhbFBhdGgpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGxvY2sgPSB0cnVlOwogICAgICAvLyBzdG9yZXMgc3RhdGUgaW4gc2Vzc2lvbiBzdG9yYWdlIHdpdGggdGhlIHVybCBhcyBrZXkKICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmNhbm9uaWNhbFBhdGgsIEpTT04uc3RyaW5naWZ5KHRoaXMuc3RhdGUpKTsKICAgICAgLy8gdXNlcyBoYXNoIGFzIGEgZmFsbGJhY2sKICAgICAgbG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmLnNwbGl0KCcjJylbMF0gKyAnIycgKyB0aGlzLmNhbm9uaWNhbFBhdGg7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2F2ZSB0aGUgY29udGV4dCBzdGF0ZS4KICAgKgogICAqIEBhcGkgcHVibGljCiAgICovCgogIENvbnRleHQucHJvdG90eXBlLnNhdmUgPSBmdW5jdGlvbigpIHsKICAgIGlmIChoaXN0b3J5QXBpKSB7CiAgICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKHRoaXMuc3RhdGUsIHRoaXMudGl0bGUsIHRoaXMuY2Fub25pY2FsUGF0aCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgLy8gc3RvcmVzIHN0YXRlIGluIHNlc3Npb24gc3RvcmFnZSB3aXRoIHRoZSB1cmwgYXMga2V5CiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0odGhpcy5jYW5vbmljYWxQYXRoLCBKU09OLnN0cmluZ2lmeSh0aGlzLnN0YXRlKSk7CiAgICAgIC8vIHVzZXMgaGFzaCBhcyBhIGZhbGxiYWNrCiAgICAgIGxvY2F0aW9uLnJlcGxhY2UobG9jYXRpb24uaHJlZi5zcGxpdCgnIycpWzBdICsgJyMnICsgdGhpcy5jYW5vbmljYWxQYXRoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBJbml0aWFsaXplIGBSb3V0ZWAgd2l0aCB0aGUgZ2l2ZW4gSFRUUCBgcGF0aGAsCiAgICogYW5kIGFuIGFycmF5IG9mIGBjYWxsYmFja3NgIGFuZCBgb3B0aW9uc2AuCiAgICoKICAgKiBPcHRpb25zOgogICAqCiAgICogICAtIGBzZW5zaXRpdmVgICAgIGVuYWJsZSBjYXNlLXNlbnNpdGl2ZSByb3V0ZXMKICAgKiAgIC0gYHN0cmljdGAgICAgICAgZW5hYmxlIHN0cmljdCBtYXRjaGluZyBmb3IgdHJhaWxpbmcgc2xhc2hlcwogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgZnVuY3Rpb24gUm91dGUocGF0aCwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgdGhpcy5tZXRob2QgPSAnR0VUJzsKICAgIHRoaXMucmVnZXhwID0gcGF0aHRvUmVnZXhwKHBhdGgKICAgICAgLCB0aGlzLmtleXMgPSBbXQogICAgICAsIG9wdGlvbnMuc2Vuc2l0aXZlCiAgICAgICwgb3B0aW9ucy5zdHJpY3QpOwogIH0KCiAgLyoqCiAgICogRXhwb3NlIGBSb3V0ZWAuCiAgICovCgogIHBhZ2UuUm91dGUgPSBSb3V0ZTsKCiAgLyoqCiAgICogUmV0dXJuIHJvdXRlIG1pZGRsZXdhcmUgd2l0aAogICAqIHRoZSBnaXZlbiBjYWxsYmFjayBgZm4oKWAuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbgogICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAqIEBhcGkgcHVibGljCiAgICovCgogIFJvdXRlLnByb3RvdHlwZS5taWRkbGV3YXJlID0gZnVuY3Rpb24oZm4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBmdW5jdGlvbihjdHgsIG5leHQpIHsKICAgICAgaWYgKHNlbGYubWF0Y2goY3R4LnBhdGgsIGN0eC5wYXJhbXMpKSByZXR1cm4gZm4oY3R4LCBuZXh0KTsKICAgICAgbmV4dCgpOwogICAgfQogIH07CgogIC8qKgogICAqIENoZWNrIGlmIHRoaXMgcm91dGUgbWF0Y2hlcyBgcGF0aGAsIGlmIHNvCiAgICogcG9wdWxhdGUgYHBhcmFtc2AuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBwYXJhbSB7QXJyYXl9IHBhcmFtcwogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIFJvdXRlLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uKHBhdGgsIHBhcmFtcykgewogICAgdmFyIGtleXMgPSB0aGlzLmtleXMKICAgICAgLCBxc0luZGV4ID0gcGF0aC5pbmRleE9mKCc/JykKICAgICAgLCBwYXRobmFtZSA9IH5xc0luZGV4ID8gcGF0aC5zbGljZSgwLCBxc0luZGV4KSA6IHBhdGgKICAgICAgLCBtID0gdGhpcy5yZWdleHAuZXhlYyhwYXRobmFtZSk7CgogICAgaWYgKCFtKSByZXR1cm4gZmFsc2U7CgogICAgZm9yICh2YXIgaSA9IDEsIGxlbiA9IG0ubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIGtleSA9IGtleXNbaSAtIDFdOwoKICAgICAgdmFyIHZhbCA9ICdzdHJpbmcnID09IHR5cGVvZiBtW2ldCiAgICAgICAgPyBkZWNvZGVVUklDb21wb25lbnQobVtpXSkKICAgICAgICA6IG1baV07CgogICAgICBpZiAoa2V5KSB7CiAgICAgICAgcGFyYW1zW2tleS5uYW1lXSA9IHVuZGVmaW5lZCAhPT0gcGFyYW1zW2tleS5uYW1lXQogICAgICAgICAgPyBwYXJhbXNba2V5Lm5hbWVdCiAgICAgICAgICA6IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJhbXMucHVzaCh2YWwpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLyoqCiAgICogTm9ybWFsaXplIHRoZSBnaXZlbiBwYXRoIHN0cmluZywKICAgKiByZXR1cm5pbmcgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICoKICAgKiBBbiBlbXB0eSBhcnJheSBzaG91bGQgYmUgcGFzc2VkLAogICAqIHdoaWNoIHdpbGwgY29udGFpbiB0aGUgcGxhY2Vob2xkZXIKICAgKiBrZXkgbmFtZXMuIEZvciBleGFtcGxlICIvdXNlci86aWQiIHdpbGwKICAgKiB0aGVuIGNvbnRhaW4gWyJpZCJdLgogICAqCiAgICogQHBhcmFtICB7U3RyaW5nfFJlZ0V4cHxBcnJheX0gcGF0aAogICAqIEBwYXJhbSAge0FycmF5fSBrZXlzCiAgICogQHBhcmFtICB7Qm9vbGVhbn0gc2Vuc2l0aXZlCiAgICogQHBhcmFtICB7Qm9vbGVhbn0gc3RyaWN0CiAgICogQHJldHVybiB7UmVnRXhwfQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBmdW5jdGlvbiBwYXRodG9SZWdleHAocGF0aCwga2V5cywgc2Vuc2l0aXZlLCBzdHJpY3QpIHsKICAgIGlmIChwYXRoIGluc3RhbmNlb2YgUmVnRXhwKSByZXR1cm4gcGF0aDsKICAgIGlmIChwYXRoIGluc3RhbmNlb2YgQXJyYXkpIHBhdGggPSAnKCcgKyBwYXRoLmpvaW4oJ3wnKSArICcpJzsKICAgIHBhdGggPSBwYXRoCiAgICAgIC5jb25jYXQoc3RyaWN0ID8gJycgOiAnLz8nKQogICAgICAucmVwbGFjZSgvXC9cKC9nLCAnKD86LycpCiAgICAgIC5yZXBsYWNlKC8oXC8pPyhcLik/OihcdyspKD86KFwoLio/XCkpKT8oXD8pPy9nLCBmdW5jdGlvbihfLCBzbGFzaCwgZm9ybWF0LCBrZXksIGNhcHR1cmUsIG9wdGlvbmFsKSB7CiAgICAgICAga2V5cy5wdXNoKHsgbmFtZToga2V5LCBvcHRpb25hbDogISFvcHRpb25hbCB9KTsKICAgICAgICBzbGFzaCA9IHNsYXNoIHx8ICcnOwogICAgICAgIHJldHVybiAnJwogICAgICAgICAgKyAob3B0aW9uYWwgPyAnJyA6IHNsYXNoKQogICAgICAgICAgKyAnKD86JwogICAgICAgICAgKyAob3B0aW9uYWwgPyBzbGFzaCA6ICcnKQogICAgICAgICAgKyAoZm9ybWF0IHx8ICcnKSArIChjYXB0dXJlIHx8IChmb3JtYXQgJiYgJyhbXi8uXSs/KScgfHwgJyhbXi9dKz8pJykpICsgJyknCiAgICAgICAgICArIChvcHRpb25hbCB8fCAnJyk7CiAgICAgIH0pCiAgICAgIC5yZXBsYWNlKC8oW1wvLl0pL2csICdcXCQxJykKICAgICAgLnJlcGxhY2UoL1wqL2csICcoLiopJyk7CiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyBwYXRoICsgJyQnLCBzZW5zaXRpdmUgPyAnJyA6ICdpJyk7CiAgfTsKCiAgLyoqCiAgICogSGFuZGxlICJwb3B1bGF0ZSIgZXZlbnRzLgogICAqLwoKICBmdW5jdGlvbiBvbnBvcHN0YXRlKGUpIHsKICAgIC8vIG9uIGNocm9tZSwgYW4gaW5pdGlhbCBwb3BzdGF0ZSBldmVudCBpcyByYWlzZWQKICAgIGlmICghcmVhZHkgJiYgbG9jYXRpb24uaHJlZiA9PSBpbml0aWFsVXJsKSB7CiAgICAgIHJlYWR5ID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChlLnN0YXRlKSB7CiAgICAgIHZhciBwYXRoID0gZS5zdGF0ZS5wYXRoOwogICAgICBwYWdlLnJlcGxhY2UocGF0aCwgZS5zdGF0ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvbmhhc2hjaGFuZ2UoKSB7CiAgICAvLyB3aGVuIGluaXRpYWwgdXJsIGlzIC8sIGl0IGdldHMgcmVkaXJlY3RlZCB0byAvIy8KICAgIC8vIHRoaXMgYXZvaWQgYSBkb3VibGUgbWF0Y2ggdG8gdGhlIC8gcGFnZQogICAgaWYgKCFyZWFkeSAmJiBsb2NhdGlvbi5ocmVmID09IGluaXRpYWxVcmwgKyAnIy8nKSB7CiAgICAgIHJlYWR5ID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGVuc3VyZSB0aGF0IHB1c2ggc3RhdGUgZG9lcyBub3QgdHJpZ2dlciB0aGlzCiAgICAvLyB0aGlzIGF2b2lkIGEgZG91YmxlIG1hdGNoIHRvIHRoZSBwYWdlCiAgICBpZiAobG9jaykgewogICAgICBsb2NrID0gZmFsc2U7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgc3RhdGUgPSBKU09OLnBhcnNlKHNlc3Npb25TdG9yYWdlLmdldEl0ZW0obG9jYXRpb24uaHJlZi5zcGxpdCgnIycpWzFdKSk7CiAgICBpZiAoc3RhdGUpIHsKICAgICAgdmFyIHBhdGggPSBzdGF0ZS5wYXRoOwogICAgICBwYWdlLnJlcGxhY2UocGF0aCwgc3RhdGUpOwogICAgfQogIH0KCiAgLyoqCiAgICogSGFuZGxlICJjbGljayIgZXZlbnRzLgogICAqLwoKICBmdW5jdGlvbiBvbmNsaWNrKGUpIHsKICAgIGlmICgxICE9IHdoaWNoKGUpKSByZXR1cm47CiAgICBpZiAoZS5tZXRhS2V5IHx8IGUuY3RybEtleSB8fCBlLnNoaWZ0S2V5KSByZXR1cm47CiAgICBpZiAoZS5kZWZhdWx0UHJldmVudGVkKSByZXR1cm47CgogICAgLy8gZW5zdXJlIGxpbmsKICAgIHZhciBlbCA9IGUudGFyZ2V0OwogICAgd2hpbGUgKGVsICYmICdBJyAhPSBlbC5ub2RlTmFtZSkgZWwgPSBlbC5wYXJlbnROb2RlOwogICAgaWYgKCFlbCB8fCAnQScgIT0gZWwubm9kZU5hbWUpIHJldHVybjsKCiAgICAvLyBlbnN1cmUgbm9uLWhhc2gKICAgIHZhciBocmVmID0gZWwuaHJlZjsKICAgIHZhciBwYXRoID0gZWwucGF0aG5hbWUgKyBlbC5zZWFyY2g7CiAgICBpZiAoZWwuaGFzaCB8fCAnIycgPT0gZWwuZ2V0QXR0cmlidXRlKCdocmVmJykpIHJldHVybjsKCiAgICAvLyBjaGVjayB0YXJnZXQKICAgIGlmIChlbC50YXJnZXQpIHJldHVybjsKCiAgICAvLyB4LW9yaWdpbgogICAgaWYgKCFzYW1lT3JpZ2luKGhyZWYpKSByZXR1cm47CgogICAgLy8gc2FtZSBwYWdlCiAgICB2YXIgb3JpZyA9IHBhdGg7CiAgICBwYXRoID0gcGF0aC5yZXBsYWNlKGJhc2UsICcnKTsKICAgIGlmIChiYXNlICYmIG9yaWcgPT0gcGF0aCkgcmV0dXJuOwoKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHBhZ2Uuc2hvdyhvcmlnKTsKICB9CgogIC8qKgogICAqIEV2ZW50IGJ1dHRvbi4KICAgKi8KCiAgZnVuY3Rpb24gd2hpY2goZSkgewogICAgZSA9IGUgfHwgd2luZG93LmV2ZW50OwogICAgcmV0dXJuIG51bGwgPT0gZS53aGljaAogICAgICA/IGUuYnV0dG9uCiAgICAgIDogZS53aGljaDsKICB9CgogIC8qKgogICAqIENoZWNrIGlmIGBocmVmYCBpcyB0aGUgc2FtZSBvcmlnaW4uCiAgICovCgogIGZ1bmN0aW9uIHNhbWVPcmlnaW4oaHJlZikgewogICAgdmFyIG9yaWdpbiA9IGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3RuYW1lOwogICAgaWYgKGxvY2F0aW9uLnBvcnQpIG9yaWdpbiArPSAnOicgKyBsb2NhdGlvbi5wb3J0OwogICAgcmV0dXJuIDAgPT0gaHJlZi5pbmRleE9mKG9yaWdpbik7CiAgfQoKICAvKioKICAgKiBFeHBvc2UgYHBhZ2VgLgogICAqLwoKICBpZiAoJ3VuZGVmaW5lZCcgPT0gdHlwZW9mIG1vZHVsZSkgewogICAgd2luZG93LnBhZ2UgPSBwYWdlOwogIH0gZWxzZSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHBhZ2U7CiAgfQoKfSkoKTs=",
                "body": "IShmdW5jdGlvbigpIHsKCiAgLyoqCiAgICogUGVyZm9ybSBpbml0aWFsIGRpc3BhdGNoLgogICAqLwoKICB2YXIgZGlzcGF0Y2ggPSB0cnVlOwoKICAvKioKICAgKiBCYXNlIHBhdGguCiAgICovCgogIHZhciBiYXNlID0gJyc7CgogIC8qKgogICAqIFJ1bm5pbmcgZmxhZy4KICAgKi8KCiAgdmFyIHJ1bm5pbmc7CgogIC8qKgogICAqIFBvcCBzdGF0ZSByZWFkeSBmbGFnLgogICAqLwoKICB2YXIgcmVhZHkgPSBmYWxzZTsKCiAgLyoqCiAgICogSW5pdGlhbCB1cmwuCiAgICovCgogIHZhciBpbml0aWFsVXJsID0gbG9jYXRpb24uaHJlZjsKCiAgLyoqCiAgICogTG9jayBmbGFnLgogICAqLwoKICB2YXIgbG9jayA9IGZhbHNlOwoKICAvKioKICAgKiBoaXN0b3J5IGFwaSBmbGFnLgogICAqLwogIHZhciBoaXN0b3J5QXBpID0gKGhpc3RvcnkucHVzaFN0YXRlICYmICdmaWxlOicgIT0gbG9jYXRpb24ucHJvdG9jb2wpOwoKICAvKioKICAgKiBSZWdpc3RlciBgcGF0aGAgd2l0aCBjYWxsYmFjayBgZm4oKWAsCiAgICogb3Igcm91dGUgYHBhdGhgLCBvciBgcGFnZS5zdGFydCgpYC4KICAgKgogICAqICAgcGFnZShmbik7CiAgICogICBwYWdlKCcqJywgZm4pOwogICAqICAgcGFnZSgnL3VzZXIvOmlkJywgbG9hZCwgdXNlcik7CiAgICogICBwYWdlKCcvdXNlci8nICsgdXNlci5pZCwgeyBzb21lOiAndGhpbmcnIH0pOwogICAqICAgcGFnZSgnL3VzZXIvJyArIHVzZXIuaWQpOwogICAqICAgcGFnZSgpOwogICAqCiAgICogQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IHBhdGgKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbi4uLgogICAqIEBhcGkgcHVibGljCiAgICovCgogIGZ1bmN0aW9uIHBhZ2UocGF0aCwgZm4pIHsKICAgIC8vIDxjYWxsYmFjaz4KICAgIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiBwYXRoKSB7CiAgICAgIHJldHVybiBwYWdlKCcqJywgcGF0aCk7CiAgICB9CgogICAgLy8gcm91dGUgPHBhdGg+IHRvIDxjYWxsYmFjayAuLi4+CiAgICBpZiAoJ2Z1bmN0aW9uJyA9PSB0eXBlb2YgZm4pIHsKICAgICAgdmFyIHJvdXRlID0gbmV3IFJvdXRlKHBhdGgpOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7ICsraSkgewogICAgICAgIHBhZ2UuY2FsbGJhY2tzLnB1c2gocm91dGUubWlkZGxld2FyZShhcmd1bWVudHNbaV0pKTsKICAgICAgfQogICAgLy8gc2hvdyA8cGF0aD4gd2l0aCBbc3RhdGVdCiAgICB9IGVsc2UgaWYgKCdzdHJpbmcnID09IHR5cGVvZiBwYXRoKSB7CiAgICAgIHBhZ2Uuc2hvdyhwYXRoLCBmbik7CiAgICAvLyBzdGFydCBbb3B0aW9uc10KICAgIH0gZWxzZSB7CiAgICAgIHBhZ2Uuc3RhcnQocGF0aCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBDYWxsYmFjayBmdW5jdGlvbnMuCiAgICovCgogIHBhZ2UuY2FsbGJhY2tzID0gW107CgogIC8qKgogICAqIEdldCBvciBzZXQgYmFzZXBhdGggdG8gYHBhdGhgLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLmJhc2UgPSBmdW5jdGlvbihwYXRoKSB7CiAgICBpZiAoMCA9PSBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gYmFzZTsKICAgIGJhc2UgPSBwYXRoOwogIH07CgogIC8qKgogICAqIEJpbmQgd2l0aCB0aGUgZ2l2ZW4gYG9wdGlvbnNgLgogICAqCiAgICogT3B0aW9uczoKICAgKgogICAqICAgIC0gYGNsaWNrYCBiaW5kIHRvIGNsaWNrIGV2ZW50cyBbdHJ1ZV0KICAgKiAgICAtIGBwb3BzdGF0ZWAgYmluZCB0byBwb3BzdGF0ZSBbdHJ1ZV0KICAgKiAgICAtIGBkaXNwYXRjaGAgcGVyZm9ybSBpbml0aWFsIGRpc3BhdGNoIFt0cnVlXQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnN0YXJ0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAocnVubmluZykgcmV0dXJuOwogICAgcnVubmluZyA9IHRydWU7CiAgICBpZiAoZmFsc2UgPT09IG9wdGlvbnMuZGlzcGF0Y2gpIGRpc3BhdGNoID0gZmFsc2U7CiAgICBpZiAoZmFsc2UgIT09IG9wdGlvbnMucG9wc3RhdGUpIHsKICAgICAgaWYgKGhpc3RvcnlBcGkpIHsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBvbnBvcHN0YXRlLCBmYWxzZSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCBvbmhhc2hjaGFuZ2UsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgaWYgKGZhbHNlICE9PSBvcHRpb25zLmNsaWNrKSB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbmNsaWNrLCBmYWxzZSk7CiAgICBpZiAoIWRpc3BhdGNoKSByZXR1cm47CiAgICBwYWdlLnJlcGxhY2UobG9jYXRpb24uaGFzaCA/IGxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKSA6IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoCiAgICAgICwgbnVsbAogICAgICAsIHRydWUKICAgICAgLCBkaXNwYXRjaCk7CiAgfTsKCiAgLyoqCiAgICogVW5iaW5kIGNsaWNrIGFuZCBwb3BzdGF0ZSBldmVudCBoYW5kbGVycy4KICAgKgogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2Uuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgcnVubmluZyA9IGZhbHNlOwogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbmNsaWNrLCBmYWxzZSk7CiAgICByZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIG9ucG9wc3RhdGUsIGZhbHNlKTsKICB9OwoKICAvKioKICAgKiBTaG93IGBwYXRoYCB3aXRoIG9wdGlvbmFsIGBzdGF0ZWAgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRpc3BhdGNoCiAgICogQHJldHVybiB7Q29udGV4dH0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnNob3cgPSBmdW5jdGlvbihwYXRoLCBzdGF0ZSwgZGlzcGF0Y2gpIHsKICAgIHZhciBjdHggPSBuZXcgQ29udGV4dChwYXRoLCBzdGF0ZSk7CiAgICBpZiAoZmFsc2UgIT09IGRpc3BhdGNoKSBwYWdlLmRpc3BhdGNoKGN0eCk7CiAgICBpZiAoIWN0eC51bmhhbmRsZWQpIGN0eC5wdXNoU3RhdGUoKTsKICAgIHJldHVybiBjdHg7CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZSBgcGF0aGAgd2l0aCBvcHRpb25hbCBgc3RhdGVgIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICogQHJldHVybiB7Q29udGV4dH0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnJlcGxhY2UgPSBmdW5jdGlvbihwYXRoLCBzdGF0ZSwgaW5pdCwgZGlzcGF0Y2gpIHsKICAgIHZhciBjdHggPSBuZXcgQ29udGV4dChwYXRoLCBzdGF0ZSk7CiAgICBjdHguaW5pdCA9IGluaXQ7CiAgICBpZiAobnVsbCA9PSBkaXNwYXRjaCkgZGlzcGF0Y2ggPSB0cnVlOwogICAgaWYgKGRpc3BhdGNoKSBwYWdlLmRpc3BhdGNoKGN0eCk7CiAgICBjdHguc2F2ZSgpOwogICAgcmV0dXJuIGN0eDsKICB9OwoKICAvKioKICAgKiBEaXNwYXRjaCB0aGUgZ2l2ZW4gYGN0eGAuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gY3R4CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIHBhZ2UuZGlzcGF0Y2ggPSBmdW5jdGlvbihjdHgpIHsKICAgIHZhciBpID0gMDsKCiAgICBmdW5jdGlvbiBuZXh0KCkgewogICAgICB2YXIgZm4gPSBwYWdlLmNhbGxiYWNrc1tpKytdOwogICAgICBpZiAoIWZuKSByZXR1cm4gdW5oYW5kbGVkKGN0eCk7CiAgICAgIGZuKGN0eCwgbmV4dCk7CiAgICB9CgogICAgbmV4dCgpOwogIH07CgogIC8qKgogICAqIFVuaGFuZGxlZCBgY3R4YC4gV2hlbiBpdCdzIG5vdCB0aGUgaW5pdGlhbAogICAqIHBvcHN0YXRlIHRoZW4gcmVkaXJlY3QuIElmIHlvdSB3aXNoIHRvIGhhbmRsZQogICAqIDQwNHMgb24geW91ciBvd24gdXNlIGBwYWdlKCcqJywgY2FsbGJhY2spYC4KICAgKgogICAqIEBwYXJhbSB7Q29udGV4dH0gY3R4CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIHVuaGFuZGxlZChjdHgpIHsKICAgIGlmICh3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyB3aW5kb3cubG9jYXRpb24uc2VhcmNoID09IGN0eC5jYW5vbmljYWxQYXRoKSByZXR1cm47CiAgICBwYWdlLnN0b3AoKTsKICAgIGN0eC51bmhhbmRsZWQgPSB0cnVlOwogICAgd2luZG93LmxvY2F0aW9uID0gY3R4LmNhbm9uaWNhbFBhdGg7CiAgfQoKICAvKioKICAgKiBJbml0aWFsaXplIGEgbmV3ICJyZXF1ZXN0IiBgQ29udGV4dGAKICAgKiB3aXRoIHRoZSBnaXZlbiBgcGF0aGAgYW5kIG9wdGlvbmFsIGluaXRpYWwgYHN0YXRlYC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgZnVuY3Rpb24gQ29udGV4dChwYXRoLCBzdGF0ZSkgewogICAgaWYgKCcvJyA9PSBwYXRoWzBdICYmIDAgIT0gcGF0aC5pbmRleE9mKGJhc2UpKSBwYXRoID0gYmFzZSArIHBhdGg7CiAgICAvLyBmaXhlcyBhbmRyb2lkIDMuMCB3aGljaCBkb2VzIG5vdCBwcmVwZW5kIGEgc2xhc2gKICAgIHBhdGggPSAnLycgIT0gcGF0aFswXSA/ICcvJyArIHBhdGggOiBwYXRoOwogICAgLy8gaWYgZmlsZSBpcyB0aGUgcHJvdG9jb2wsIHJld3JpdGUgdXJsCiAgICBpZiAoJ2ZpbGU6JyA9PSBsb2NhdGlvbi5wcm90b2NvbCkgewogICAgICAvLyByb290CiAgICAgIGlmIChwYXRoID09IGxvY2F0aW9uLnBhdGhuYW1lKSB7CiAgICAgICAgcGF0aCA9ICcvJzsKICAgICAgfQogICAgICAvLyBvdGhlciBwYXRocyBoYXZlIHRoZSBkcml2ZSBwcmVwZW5kZWQsIGVuc3VyZSB3ZSBnZXQgb25seSB0aGUgbGFzdCBwYXJ0CiAgICAgIGVsc2UgewogICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihwYXRoLmxhc3RJbmRleE9mKCcvJykpOwogICAgICB9CiAgICB9CiAgICB2YXIgaSA9IHBhdGguaW5kZXhPZignPycpOwogICAgdGhpcy5jYW5vbmljYWxQYXRoID0gcGF0aDsKICAgIHRoaXMucGF0aCA9IHBhdGgucmVwbGFjZShiYXNlLCAnJykgfHwgJy8nOwogICAgdGhpcy50aXRsZSA9IGRvY3VtZW50LnRpdGxlOwogICAgdGhpcy5zdGF0ZSA9IHN0YXRlIHx8IHt9OwogICAgdGhpcy5zdGF0ZS5wYXRoID0gcGF0aDsKICAgIHRoaXMucXVlcnlzdHJpbmcgPSB+aSA/IHBhdGguc2xpY2UoaSArIDEpIDogJyc7CiAgICB0aGlzLnBhdGhuYW1lID0gfmkgPyBwYXRoLnNsaWNlKDAsIGkpIDogcGF0aDsKICAgIHRoaXMucGFyYW1zID0gW107CiAgfQoKICAvKioKICAgKiBFeHBvc2UgYENvbnRleHRgLgogICAqLwoKICBwYWdlLkNvbnRleHQgPSBDb250ZXh0OwoKICAvKioKICAgKiBQdXNoIHN0YXRlLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIENvbnRleHQucHJvdG90eXBlLnB1c2hTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGhpc3RvcnlBcGkpIHsKICAgICAgaGlzdG9yeS5wdXNoU3RhdGUodGhpcy5zdGF0ZSwgdGhpcy50aXRsZSwgdGhpcy5jYW5vbmljYWxQYXRoKTsKICAgIH0KICAgIGVsc2UgewogICAgICBsb2NrID0gdHJ1ZTsKICAgICAgLy8gc3RvcmVzIHN0YXRlIGluIHNlc3Npb24gc3RvcmFnZSB3aXRoIHRoZSB1cmwgYXMga2V5CiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0odGhpcy5jYW5vbmljYWxQYXRoLCBKU09OLnN0cmluZ2lmeSh0aGlzLnN0YXRlKSk7CiAgICAgIC8vIHVzZXMgaGFzaCBhcyBhIGZhbGxiYWNrCiAgICAgIGxvY2F0aW9uID0gbG9jYXRpb24uaHJlZi5zcGxpdCgnIycpWzBdICsgJyMnICsgdGhpcy5jYW5vbmljYWxQYXRoOwogICAgfQogIH07CgogIC8qKgogICAqIFNhdmUgdGhlIGNvbnRleHQgc3RhdGUuCiAgICoKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBDb250ZXh0LnByb3RvdHlwZS5zYXZlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoaGlzdG9yeUFwaSkgewogICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSh0aGlzLnN0YXRlLCB0aGlzLnRpdGxlLCB0aGlzLmNhbm9uaWNhbFBhdGgpOwogICAgfQogICAgZWxzZSB7CiAgICAgIC8vIHN0b3JlcyBzdGF0ZSBpbiBzZXNzaW9uIHN0b3JhZ2Ugd2l0aCB0aGUgdXJsIGFzIGtleQogICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMuY2Fub25pY2FsUGF0aCwgSlNPTi5zdHJpbmdpZnkodGhpcy5zdGF0ZSkpOwogICAgICAvLyB1c2VzIGhhc2ggYXMgYSBmYWxsYmFjawogICAgICBsb2NhdGlvbi5yZXBsYWNlKGxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVswXSArICcjJyArIHRoaXMuY2Fub25pY2FsUGF0aCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogSW5pdGlhbGl6ZSBgUm91dGVgIHdpdGggdGhlIGdpdmVuIEhUVFAgYHBhdGhgLAogICAqIGFuZCBhbiBhcnJheSBvZiBgY2FsbGJhY2tzYCBhbmQgYG9wdGlvbnNgLgogICAqCiAgICogT3B0aW9uczoKICAgKgogICAqICAgLSBgc2Vuc2l0aXZlYCAgICBlbmFibGUgY2FzZS1zZW5zaXRpdmUgcm91dGVzCiAgICogICAtIGBzdHJpY3RgICAgICAgIGVuYWJsZSBzdHJpY3QgbWF0Y2hpbmcgZm9yIHRyYWlsaW5nIHNsYXNoZXMKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIFJvdXRlKHBhdGgsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5wYXRoID0gcGF0aDsKICAgIHRoaXMubWV0aG9kID0gJ0dFVCc7CiAgICB0aGlzLnJlZ2V4cCA9IHBhdGh0b1JlZ2V4cChwYXRoCiAgICAgICwgdGhpcy5rZXlzID0gW10KICAgICAgLCBvcHRpb25zLnNlbnNpdGl2ZQogICAgICAsIG9wdGlvbnMuc3RyaWN0KTsKICB9CgogIC8qKgogICAqIEV4cG9zZSBgUm91dGVgLgogICAqLwoKICBwYWdlLlJvdXRlID0gUm91dGU7CgogIC8qKgogICAqIFJldHVybiByb3V0ZSBtaWRkbGV3YXJlIHdpdGgKICAgKiB0aGUgZ2l2ZW4gY2FsbGJhY2sgYGZuKClgLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBSb3V0ZS5wcm90b3R5cGUubWlkZGxld2FyZSA9IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24oY3R4LCBuZXh0KSB7CiAgICAgIGlmIChzZWxmLm1hdGNoKGN0eC5wYXRoLCBjdHgucGFyYW1zKSkgcmV0dXJuIGZuKGN0eCwgbmV4dCk7CiAgICAgIG5leHQoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBDaGVjayBpZiB0aGlzIHJvdXRlIG1hdGNoZXMgYHBhdGhgLCBpZiBzbwogICAqIHBvcHVsYXRlIGBwYXJhbXNgLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge0FycmF5fSBwYXJhbXMKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBSb3V0ZS5wcm90b3R5cGUubWF0Y2ggPSBmdW5jdGlvbihwYXRoLCBwYXJhbXMpIHsKICAgIHZhciBrZXlzID0gdGhpcy5rZXlzCiAgICAgICwgcXNJbmRleCA9IHBhdGguaW5kZXhPZignPycpCiAgICAgICwgcGF0aG5hbWUgPSB+cXNJbmRleCA/IHBhdGguc2xpY2UoMCwgcXNJbmRleCkgOiBwYXRoCiAgICAgICwgbSA9IHRoaXMucmVnZXhwLmV4ZWMocGF0aG5hbWUpOwoKICAgIGlmICghbSkgcmV0dXJuIGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBtLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2kgLSAxXTsKCiAgICAgIHZhciB2YWwgPSAnc3RyaW5nJyA9PSB0eXBlb2YgbVtpXQogICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG1baV0pCiAgICAgICAgOiBtW2ldOwoKICAgICAgaWYgKGtleSkgewogICAgICAgIHBhcmFtc1trZXkubmFtZV0gPSB1bmRlZmluZWQgIT09IHBhcmFtc1trZXkubmFtZV0KICAgICAgICAgID8gcGFyYW1zW2tleS5uYW1lXQogICAgICAgICAgOiB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyYW1zLnB1c2godmFsKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8qKgogICAqIE5vcm1hbGl6ZSB0aGUgZ2l2ZW4gcGF0aCBzdHJpbmcsCiAgICogcmV0dXJuaW5nIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQW4gZW1wdHkgYXJyYXkgc2hvdWxkIGJlIHBhc3NlZCwKICAgKiB3aGljaCB3aWxsIGNvbnRhaW4gdGhlIHBsYWNlaG9sZGVyCiAgICoga2V5IG5hbWVzLiBGb3IgZXhhbXBsZSAiL3VzZXIvOmlkIiB3aWxsCiAgICogdGhlbiBjb250YWluIFsiaWQiXS4KICAgKgogICAqIEBwYXJhbSAge1N0cmluZ3xSZWdFeHB8QXJyYXl9IHBhdGgKICAgKiBAcGFyYW0gIHtBcnJheX0ga2V5cwogICAqIEBwYXJhbSAge0Jvb2xlYW59IHNlbnNpdGl2ZQogICAqIEBwYXJhbSAge0Jvb2xlYW59IHN0cmljdAogICAqIEByZXR1cm4ge1JlZ0V4cH0KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgZnVuY3Rpb24gcGF0aHRvUmVnZXhwKHBhdGgsIGtleXMsIHNlbnNpdGl2ZSwgc3RyaWN0KSB7CiAgICBpZiAocGF0aCBpbnN0YW5jZW9mIFJlZ0V4cCkgcmV0dXJuIHBhdGg7CiAgICBpZiAocGF0aCBpbnN0YW5jZW9mIEFycmF5KSBwYXRoID0gJygnICsgcGF0aC5qb2luKCd8JykgKyAnKSc7CiAgICBwYXRoID0gcGF0aAogICAgICAuY29uY2F0KHN0cmljdCA/ICcnIDogJy8/JykKICAgICAgLnJlcGxhY2UoL1wvXCgvZywgJyg/Oi8nKQogICAgICAucmVwbGFjZSgvKFwvKT8oXC4pPzooXHcrKSg/OihcKC4qP1wpKSk/KFw/KT8vZywgZnVuY3Rpb24oXywgc2xhc2gsIGZvcm1hdCwga2V5LCBjYXB0dXJlLCBvcHRpb25hbCkgewogICAgICAgIGtleXMucHVzaCh7IG5hbWU6IGtleSwgb3B0aW9uYWw6ICEhb3B0aW9uYWwgfSk7CiAgICAgICAgc2xhc2ggPSBzbGFzaCB8fCAnJzsKICAgICAgICByZXR1cm4gJycKICAgICAgICAgICsgKG9wdGlvbmFsID8gJycgOiBzbGFzaCkKICAgICAgICAgICsgJyg/OicKICAgICAgICAgICsgKG9wdGlvbmFsID8gc2xhc2ggOiAnJykKICAgICAgICAgICsgKGZvcm1hdCB8fCAnJykgKyAoY2FwdHVyZSB8fCAoZm9ybWF0ICYmICcoW14vLl0rPyknIHx8ICcoW14vXSs/KScpKSArICcpJwogICAgICAgICAgKyAob3B0aW9uYWwgfHwgJycpOwogICAgICB9KQogICAgICAucmVwbGFjZSgvKFtcLy5dKS9nLCAnXFwkMScpCiAgICAgIC5yZXBsYWNlKC9cKi9nLCAnKC4qKScpOwogICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcGF0aCArICckJywgc2Vuc2l0aXZlID8gJycgOiAnaScpOwogIH07CgogIC8qKgogICAqIEhhbmRsZSAicG9wdWxhdGUiIGV2ZW50cy4KICAgKi8KCiAgZnVuY3Rpb24gb25wb3BzdGF0ZShlKSB7CiAgICAvLyBvbiBjaHJvbWUsIGFuIGluaXRpYWwgcG9wc3RhdGUgZXZlbnQgaXMgcmFpc2VkCiAgICBpZiAoIXJlYWR5ICYmIGxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbFVybCkgewogICAgICByZWFkeSA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZS5zdGF0ZSkgewogICAgICB2YXIgcGF0aCA9IGUuc3RhdGUucGF0aDsKICAgICAgcGFnZS5yZXBsYWNlKHBhdGgsIGUuc3RhdGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25oYXNoY2hhbmdlKCkgewogICAgLy8gd2hlbiBpbml0aWFsIHVybCBpcyAvLCBpdCBnZXRzIHJlZGlyZWN0ZWQgdG8gLyMvCiAgICAvLyB0aGlzIGF2b2lkIGEgZG91YmxlIG1hdGNoIHRvIHRoZSAvIHBhZ2UKICAgIGlmICghcmVhZHkgJiYgbG9jYXRpb24uaHJlZiA9PSBpbml0aWFsVXJsICsgJyMvJykgewogICAgICByZWFkeSA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBlbnN1cmUgdGhhdCBwdXNoIHN0YXRlIGRvZXMgbm90IHRyaWdnZXIgdGhpcwogICAgLy8gdGhpcyBhdm9pZCBhIGRvdWJsZSBtYXRjaCB0byB0aGUgcGFnZQogICAgaWYgKGxvY2spIHsKICAgICAgbG9jayA9IGZhbHNlOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHN0YXRlID0gSlNPTi5wYXJzZShzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVsxXSkpOwogICAgaWYgKHN0YXRlKSB7CiAgICAgIHZhciBwYXRoID0gc3RhdGUucGF0aDsKICAgICAgcGFnZS5yZXBsYWNlKHBhdGgsIHN0YXRlKTsKICAgIH0KICB9CgogIC8qKgogICAqIEhhbmRsZSAiY2xpY2siIGV2ZW50cy4KICAgKi8KCiAgZnVuY3Rpb24gb25jbGljayhlKSB7CiAgICBpZiAoMSAhPSB3aGljaChlKSkgcmV0dXJuOwogICAgaWYgKGUubWV0YUtleSB8fCBlLmN0cmxLZXkgfHwgZS5zaGlmdEtleSkgcmV0dXJuOwogICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZCkgcmV0dXJuOwoKICAgIC8vIGVuc3VyZSBsaW5rCiAgICB2YXIgZWwgPSBlLnRhcmdldDsKICAgIHdoaWxlIChlbCAmJiAnQScgIT0gZWwubm9kZU5hbWUpIGVsID0gZWwucGFyZW50Tm9kZTsKICAgIGlmICghZWwgfHwgJ0EnICE9IGVsLm5vZGVOYW1lKSByZXR1cm47CgogICAgLy8gZW5zdXJlIG5vbi1oYXNoCiAgICB2YXIgaHJlZiA9IGVsLmhyZWY7CiAgICB2YXIgcGF0aCA9IGVsLnBhdGhuYW1lICsgZWwuc2VhcmNoOwogICAgaWYgKGVsLmhhc2ggfHwgJyMnID09IGVsLmdldEF0dHJpYnV0ZSgnaHJlZicpKSByZXR1cm47CgogICAgLy8gY2hlY2sgdGFyZ2V0CiAgICBpZiAoZWwudGFyZ2V0KSByZXR1cm47CgogICAgLy8geC1vcmlnaW4KICAgIGlmICghc2FtZU9yaWdpbihocmVmKSkgcmV0dXJuOwoKICAgIC8vIHNhbWUgcGFnZQogICAgdmFyIG9yaWcgPSBwYXRoOwogICAgcGF0aCA9IHBhdGgucmVwbGFjZShiYXNlLCAnJyk7CiAgICBpZiAoYmFzZSAmJiBvcmlnID09IHBhdGgpIHJldHVybjsKCiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBwYWdlLnNob3cob3JpZyk7CiAgfQoKICAvKioKICAgKiBFdmVudCBidXR0b24uCiAgICovCgogIGZ1bmN0aW9uIHdoaWNoKGUpIHsKICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDsKICAgIHJldHVybiBudWxsID09IGUud2hpY2gKICAgICAgPyBlLmJ1dHRvbgogICAgICA6IGUud2hpY2g7CiAgfQoKICAvKioKICAgKiBDaGVjayBpZiBgaHJlZmAgaXMgdGhlIHNhbWUgb3JpZ2luLgogICAqLwoKICBmdW5jdGlvbiBzYW1lT3JpZ2luKGhyZWYpIHsKICAgIHZhciBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0bmFtZTsKICAgIGlmIChsb2NhdGlvbi5wb3J0KSBvcmlnaW4gKz0gJzonICsgbG9jYXRpb24ucG9ydDsKICAgIHJldHVybiAwID09IGhyZWYuaW5kZXhPZihvcmlnaW4pOwogIH0KCiAgLyoqCiAgICogRXhwb3NlIGBwYWdlYC4KICAgKi8KCiAgaWYgKCd1bmRlZmluZWQnID09IHR5cGVvZiBtb2R1bGUpIHsKICAgIHdpbmRvdy5wYWdlID0gcGFnZTsKICB9IGVsc2UgewogICAgbW9kdWxlLmV4cG9ydHMgPSBwYWdlOwogIH0KCn0pKCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:35:50 GMT",
                    "Content-Length": "11451",
                    "Date": "Fri, 07 Nov 2014 21:35:50 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}