{
    "url": "http://localhost:9999/edina/pcapi.js/js/pcapi.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location</b> and written to <b>$()</b> via the following statement:<ul><li>var loginUrl = this.getCloudProviderUrl() + '/auth/'+this.getProvider()+\"?callback=\"+$(location).attr('href');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/edina/pcapi.js/js/pcapi.js",
                "path": "/edina/pcapi.js/js/pcapi.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9lZGluYS9wY2FwaS5qcy9qcy9wY2FwaS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjc3MjgNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6NDQ6MjQgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjQ0OjI0IEdNVA0KDQovKgpDb3B5cmlnaHQgKGMpIDIwMTQsIEVESU5BLgpBbGwgcmlnaHRzIHJlc2VydmVkLgoKUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwKYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgoKMS4gUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLCB0aGlzCiAgIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgoyLiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMKICAgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlIGRvY3VtZW50YXRpb24gYW5kL29yCiAgIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uCjMuIEFsbCBhZHZlcnRpc2luZyBtYXRlcmlhbHMgbWVudGlvbmluZyBmZWF0dXJlcyBvciB1c2Ugb2YgdGhpcyBzb2Z0d2FyZSBtdXN0CiAgIGRpc3BsYXkgdGhlIGZvbGxvd2luZyBhY2tub3dsZWRnZW1lbnQ6IFRoaXMgcHJvZHVjdCBpbmNsdWRlcyBzb2Z0d2FyZQogICBkZXZlbG9wZWQgYnkgdGhlIEVESU5BLgo0LiBOZWl0aGVyIHRoZSBuYW1lIG9mIHRoZSBFRElOQSBub3IgdGhlIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8KICAgZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3IKICAgd3JpdHRlbiBwZXJtaXNzaW9uLgoKVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBFRElOQSAnJ0FTIElTJycgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQKV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YKTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQKU0hBTEwgRURJTkEgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLApPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRgpTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MKSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsClNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlQgKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZCk9VVCBPRiBUSEUgVVNFIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSApEQU1BR0UuCiovCgoidXNlIHN0cmljdCI7Cgp2YXIgcGNhcGkgPSAoZnVuY3Rpb24oKXsKCiAgICAvKioKICAgICAqIFVuc2V0IHVzZXIgbG9naW4gaWQuCiAgICAgKi8KICAgIHZhciBjbGVhckNsb3VkTG9naW4gPSBmdW5jdGlvbigpewogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdjbG91ZC11c2VyJywgSlNPTi5zdHJpbmdpZnkoeydpZCc6IHVuZGVmaW5lZH0pKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBMb2dpbiB0byBjbG91ZCBwcm92aWRlci4KICAgICAqIEBwYXJhbiBwcm92aWRlciBUaGUgcHJvdmlkZXIgdHlwZS4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBGdW5jdGlvbiBjYWxsZWQgYWZ0ZXIgbG9naW4gYXR0ZW1wdC4KICAgICAqIEBwYXJhbSBjYnJvd3NlciBGdW5jdGlvbiB0byBhbGxvdyBjYWxsZXIgcmVxdWlyZXMgYWNjZXNzIHRvIGNoaWxkYnJvd3Nlci4KICAgICAqLwogICAgdmFyIGRvTG9naW4gPSBmdW5jdGlvbihwcm92aWRlciwgY2FsbGJhY2ssIGNicm93c2VyKXsKICAgICAgICB2YXIgbG9naW5VcmwgPSBfdGhpcy5nZXRDbG91ZFByb3ZpZGVyVXJsKCkgKyAnL2F1dGgvJyArIHByb3ZpZGVyOwogICAgICAgIGlmIChwcm92aWRlciA9PT0gJ2xvY2FsJykgewogICAgICAgICAgICBkb0xvZ2luTG9jYWwoY2FsbGJhY2ssIGNicm93c2VyLCBsb2dpblVybCk7CiAgICAgICAgfQogICAgICAgIGVsc2V7CiAgICAgICAgICAgIGRvTG9naW5Ecm9wQm94KGNhbGxiYWNrLCBjYnJvd3NlciwgbG9naW5VcmwpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBMb2dpbiB0byBhIGxvY2FsIGNsb3VkIHByb3ZpZGVyLgogICAgICogQHBhcmFtIGNhbGxiYWNrIEZ1bmN0aW9uIGNhbGxlZCBhZnRlciBsb2dpbiBhdHRlbXB0LgogICAgICogQHBhcmFtIGxvZ2luVXJsCiAgICAgKi8KICAgIHZhciBkb0xvZ2luTG9jYWwgPSBmdW5jdGlvbihjYWxsYmFjaywgY2Jyb3dzZXIsIGxvZ2luVXJsKXsKICAgICAgICB2YXIgcG9sbFRpbWVyLAogICAgICAgICAgICBwb2xsVGltZXJDb3VudCA9IDAsCiAgICAgICAgICAgIHBvbGxJbnRlcnZhbCA9IDMwMDAsCiAgICAgICAgICAgIHBvbGxGb3JNYXggPSA1ICogNjAgKiAxMDAwOyAvL21pbgogICAgICAgIHZhciBwb2xsVXJsID0gbG9naW5Vcmw7CiAgICAgICAgY29uc29sZS5kZWJ1ZygnTG9naW4gd2l0aDogJyArIHBvbGxVcmwpOwogICAgICAgIHZhciBjYiA9IHdpbmRvdy5vcGVuKHBvbGxVcmwsICdfYmxhbmsnLCAnbG9jYXRpb249bm8nKTsKCgogICAgICAgIC8vIGNsb3NlIGNoaWxkIGJyb3dzZXIKICAgICAgICB2YXIgY2xvc2VDYiA9IGZ1bmN0aW9uKHVzZXJJZCl7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbFRpbWVyKTsKICAgICAgICAgICAgY2FsbGJhY2sodXNlcklkKTsKICAgICAgICB9OwoKICAgICAgICBjb25zb2xlLmRlYnVnKCdQb2xsOiAnICsgcG9sbFVybCk7CiAgICAgICAgcG9sbFRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHVybDogcG9sbFVybCwKICAgICAgICAgICAgICAgIHRpbWVvdXQ6IDMwMDAsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihwb2xsRGF0YSl7CiAgICAgICAgICAgICAgICAgICAgcG9sbFRpbWVyQ291bnQgKz0gcG9sbEludGVydmFsOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgaHRtbCByZXNwb25zZXMgKGxpa2UgdGhlIHJlZGlyZWN0aW9uIGZyb20gU2hpYmJvbGV0aCkKICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YocG9sbERhdGEpID09PSAnb2JqZWN0Jyl7CiAgICAgICAgICAgICAgICAgICAgICBpZihwb2xsRGF0YS5zdGF0ZSA9PT0gMSB8fCBwb2xsVGltZXJDb3VudCA+IHBvbGxGb3JNYXgpewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbG91ZFVzZXJJZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwb2xsRGF0YS5zdGF0ZSA9PT0gMSApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG91ZFVzZXJJZCA9IHBvbGxEYXRhLnVzZXJpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2V0Q2xvdWRMb2dpbihjbG91ZFVzZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGNiLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VDYihjbG91ZFVzZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSBwb2xsaW5nIGFwaTogIiArIGVycm9yLnN0YXR1c1RleHQpOwogICAgICAgICAgICAgICAgICAgIGNsb3NlQ2IoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sIHBvbGxJbnRlcnZhbCk7CgogICAgICAgIGlmKGNicm93c2VyKXsKICAgICAgICAgICAgLy8gY2FsbGVyIG1heSB3YW50IGFjY2VzcyB0byBjaGlsZCBicm93c2VyIHJlZmVyZW5jZQogICAgICAgICAgICBjYnJvd3NlcihjYik7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIExvZ2luIHRvIGRyb3Bib3guCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgRnVuY3Rpb24gY2FsbGVkIGFmdGVyIGxvZ2luIGF0dGVtcHQuCiAgICAgKiBAcGFyYW0gY2Jyb3dzZXIgRnVuY3Rpb24gdG8gYWxsb3cgY2FsbGVyIHJlcXVpcmVzIGFjY2VzcyB0byBjaGlsZGJyb3dzZXIuCiAgICAgKiBAcGFyYW0gbG9naW5VcmwKICAgICAqLwogICAgdmFyIGRvTG9naW5Ecm9wQm94ID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNicm93c2VyLCBsb2dpblVybCl7CiAgICAgICAgdmFyIHBvbGxUaW1lciwgcG9sbFRpbWVyQ291bnQgPSAwLCBwb2xsSW50ZXJ2YWwgPSAzMDAwLCBwb2xsRm9yTWF4ID0gNSAqIDYwICogMTAwMDsgLy9taW4KCiAgICAgICAgdmFyIHVzZXJJZCA9IGdldENsb3VkTG9naW5JZCgpOwogICAgICAgIGlmKHVzZXJJZCAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiZ290IGEgdXNlciBpZDogIiArIHVzZXJJZCk7CiAgICAgICAgICAgIGxvZ2luVXJsICs9ICcvJyArIHVzZXJJZDsKICAgICAgICB9CgogICAgICAgIC8vIGNsZWFyIHVzZXIgaWQKICAgICAgICBjbGVhckNsb3VkTG9naW4oKTsKICAgICAgICBjb25zb2xlLmRlYnVnKCdMb2dpbiB3aXRoOiAnICsgbG9naW5VcmwgKyAnP2FzeW5jPXRydWUnKTsKCiAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgdXJsOiBsb2dpblVybCArICc/YXN5bmM9dHJ1ZScsCiAgICAgICAgICAgIHRpbWVvdXQ6IDMwMDAsCiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJSZWRpcmVjdCB0bzogIiArIGRhdGEudXJsKTsKICAgICAgICAgICAgICAgIHZhciBjbG91ZFVzZXJJZCA9IGRhdGEudXNlcmlkOwoKICAgICAgICAgICAgICAgIC8vIGNsb3NlIGNoaWxkIGJyb3dzZXIKICAgICAgICAgICAgICAgIHZhciBjbG9zZUNiID0gZnVuY3Rpb24odXNlcklkKXsKICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHBvbGxUaW1lcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodXNlcklkKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gb3BlbiBkcm9wYm94IGxvZ2luIGluIGNoaWxkIGJyb3dzZXIKICAgICAgICAgICAgICAgIHZhciBjYiA9IHdpbmRvdy5vcGVuKGRhdGEudXJsLCAnX2JsYW5rJywgJ2xvY2F0aW9uPW5vJyk7CiAgICAgICAgICAgICAgICAvL2NiLmFkZEV2ZW50TGlzdGVuZXIoJ2V4aXQnLCBjbG9zZUNiKTsKCiAgICAgICAgICAgICAgICB2YXIgcG9sbFVybCA9IGxvZ2luVXJsICsgJy8nICsgY2xvdWRVc2VySWQgKyAnP2FzeW5jPXRydWUnOwogICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnUG9sbDogJyArIHBvbGxVcmwpOwogICAgICAgICAgICAgICAgcG9sbFRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHBvbGxVcmwsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBvbGxEYXRhKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvbGxUaW1lckNvdW50ICs9IHBvbGxJbnRlcnZhbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwb2xsRGF0YS5zdGF0ZSA9PT0gMSB8fCBwb2xsVGltZXJDb3VudCA+IHBvbGxGb3JNYXgpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBvbGxEYXRhLnN0YXRlID09PSAxICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNldENsb3VkTG9naW4oY2xvdWRVc2VySWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYi5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQ2IoY2xvdWRVc2VySWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oZXJyb3IpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSBwb2xsaW5nIGFwaTogIiArIGVycm9yLnN0YXR1c1RleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VDYih7InN0YXR1cyI6IC0xLCAibXNnIjogIlByb2JsZW0gcG9sbGluZyBhcGkifSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgcG9sbEludGVydmFsKTsKCiAgICAgICAgICAgICAgICBpZihjYnJvd3Nlcil7CiAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGVyIG1heSB3YW50IGFjY2VzcyB0byBjaGlsZCBicm93c2VyIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgIGNicm93c2VyKGNiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCB0ZXh0U3RhdHVzKXsKICAgICAgICAgICAgICAgIHZhciBtc2c7CiAgICAgICAgICAgICAgICBpZih0ZXh0U3RhdHVzID09PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICAgIHRleHRTdGF0dXMgPSAnIFVuc3BlY2lmaWVkIEVycm9yLic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKHRleHRTdGF0dXMgPT09ICJ0aW1lb3V0IikgewogICAgICAgICAgICAgICAgICAgIG1zZyA9ICJVbmFibGUgdG8gbG9naW4sIHBsZWFzZSBlbmFibGUgZGF0YSBjb25uZWN0aW9uLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgIG1zZyA9ICJQcm9ibGVtIHdpdGggbG9naW46ICIgKyB0ZXh0U3RhdHVzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHsic3RhdHVzIjogLTEsICJtc2ciOiBtc2d9KTsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEdldCB0aGUgY2xvdWQgbG9naW4gZnJvbSBsb2NhbCBzdG9yYWdlLgogICAgICovCiAgICB2YXIgZ2V0Q2xvdWRMb2dpbiA9IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGxvZ2luID0gbnVsbDsKICAgICAgICB2YXIgdXNlciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjbG91ZC11c2VyJyk7CiAgICAgICAgaWYodXNlcil7CiAgICAgICAgICAgIGxvZ2luID0gSlNPTi5wYXJzZSh1c2VyKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb2dpbjsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNsb3VkIGxvZ2luIGlkIGZyb20gbG9jYWwgc3RvcmFnZS4KICAgICAqLwogICAgdmFyIGdldENsb3VkTG9naW5JZCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGlkOwogICAgICAgIHZhciBsb2dpbiA9IGdldENsb3VkTG9naW4oKTsKICAgICAgICBpZih0eXBlb2YobG9naW4pID09PSAnb2JqZWN0Jyl7CiAgICAgICAgICAgIGlkID0gbG9naW4uaWQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaWQ7CiAgICB9OwoKICAgIC8qKgogICAgICogZnVuY3Rpb24gZm9yIGZpbmRpbmcgdGggZXh0ZW5zaW9uIG9mIGEgc3RyaW5nCiAgICAgKiBAcGFyYW0gc3RyaW5nCiAgICAgKiBAc3VmZml4CiAgICAgKiBAcmV0dXJucyB0cnVlL2ZhbHNlIGlmIHN1ZmZpeCBhZ2dyZWVzIHdpdGggc3RyaW5nIGV4dGVuc2lvbgogICAgICovCiAgICB2YXIgZW5kc1dpdGggPSBmdW5jdGlvbihzdHIsIHN1ZmZpeCkgewogICAgICAgIHJldHVybiBzdHIuaW5kZXhPZihzdWZmaXgsIHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7CiAgICB9OwoKICAgIHZhciBfdGhpcyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogSW5pdGlhbGl6ZSBwY2FwaSBvYmplY3QKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy51cmwgdXJsIG9mIHRoZSBQQ0FQSQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnZlcnNpb24gdmVyc2lvbiBudW1iZXIgb2YgUENBUEkKICAgICAgICAgKi8KICAgICAgICBpbml0OiBmdW5jdGlvbihvcHRpb25zKXsKICAgICAgICAgICAgdGhpcy5iYXNlVXJsID0gb3B0aW9ucy51cmw7CiAgICAgICAgICAgIHRoaXMudmVyc2lvbiA9IG9wdGlvbnMudmVyc2lvbjsKICAgICAgICAgICAgdGhpcy5jbG91ZFByb3ZpZGVyVXJsID0gb3B0aW9ucy51cmwgKyAiLyIgKyBvcHRpb25zLnZlcnNpb24gKyAiL3BjYXBpIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgYnVpbGRpbmcgdGhlIG1haW4gdXJscwogICAgICAgICAqIDxkb21haW4+Lzx2ZXJzaW9uPi9wY2FwaS88cmVjb3Jkcy9lZGl0b3JzPi88cHJvdmlkZXI+Lzx1c2VyaWQ+Ly4uLgogICAgICAgICAqIEBwYXJhbSByZW1vdGVEaXIgdGhlIHJlbW90ZSBkaXIgd2hpY2ggaXMgZWl0aGVyIHJlY29yZHMgb3IgZWRpdG9ycwogICAgICAgICAqIEBpdGVtIHRoZSBmb2xkZXIvZmlsZSBpbnNpZGUgdGhlIHJlY29yZHMvZWRpdG9ycyBmb2xkZXIKICAgICAgICAgKiBAcmV0dXJucyB1cmwKICAgICAgICAgKi8KICAgICAgICBidWlsZFVybCA6IGZ1bmN0aW9uKHJlbW90ZURpciwgaXRlbSl7CiAgICAgICAgICAgIHZhciB1c2VySWQgPSBnZXRDbG91ZExvZ2luSWQoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRVc2VyVXJsKHVzZXJJZCwgcmVtb3RlRGlyLCBpdGVtKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUT0RPCiAgICAgICAgICovCiAgICAgICAgYnVpbGRVc2VyVXJsOiBmdW5jdGlvbih1c2VySWQsIGNhdGVnb3J5LCBwYXRoKXsKICAgICAgICAgICAgcGF0aCA9IHBhdGggfHwgJyc7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDbG91ZFByb3ZpZGVyVXJsKCkgKyAnLycgKyBjYXRlZ29yeSArICcvJyArCiAgICAgICAgICAgICAgICAgICB0aGlzLmdldFByb3ZpZGVyKCkgKyAnLycgKyB1c2VySWQgKyAnLycgKyBwYXRoOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBidWlsZGluZyB0aGUgbWFpbiB1cmxzCiAgICAgICAgICogPGRvbWFpbj4vPHZlcnNpb24+L3BjYXBpL2ZzLzxwcm92aWRlcj4vPHVzZXJpZD4vPGZvbGRlcj4vCiAgICAgICAgICogQHBhcmFtIHJlbW90ZURpciB0aGUgcmVtb3RlIGRpcgogICAgICAgICAqIEBpdGVtIHRoZSBmb2xkZXIvZmlsZSBpbnNpZGUgdGhlIHJlbW90ZURpciBmb2xkZXIKICAgICAgICAgKiBAcmV0dXJucyB1cmwKICAgICAgICAgKi8KICAgICAgICBidWlsZEZTVXJsIDogZnVuY3Rpb24ocmVtb3RlRGlyLCBpdGVtKXsKICAgICAgICAgICAgdmFyIHVzZXJJZCA9IGdldENsb3VkTG9naW5JZCgpOwogICAgICAgICAgICBpZiAodXNlcklkID09PSAibG9jYWwiKSB7CiAgICAgICAgICAgICAgICB1c2VySWQgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgdXNlcklkID0gIi8iK3VzZXJJZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDbG91ZFByb3ZpZGVyVXJsKCkgKyAnL2ZzLycgKwogICAgICAgICAgICAgICAgdGhpcy5nZXRQcm92aWRlcigpICsgdXNlcklkICsnLycrcmVtb3RlRGlyKycvJytpdGVtOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrIGlmIHRoZSB1c2VyIGlzIGxvZ2dlZCBpbgogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBjaGVja2luZyB0aGUgbG9naW4gc3RhdHVzCiAgICAgICAgICovCiAgICAgICAgY2hlY2tMb2dpbjogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAgICAgICBpZighdGhpcy51c2VySWQpewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coImNoZWNrIGlmIHVzZXIgaXMgbG9nZ2VkIGluIik7CiAgICAgICAgICAgICAgICB2YXIgdXNlciA9IGdldENsb3VkTG9naW4oKTsKICAgICAgICAgICAgICAgIGlmKHVzZXIgIT09IG51bGwgJiYgdXNlci5pZCl7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpICsgJy9hdXRoLycrdGhpcy5nZXRQcm92aWRlcigpOwogICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmlkICE9PSAibG9jYWwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybCArPSAnLycrdXNlci5pZDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIkNoZWNrIHVzZXIgd2l0aDogIiArIHVybCk7CiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6ICQucHJveHkoZnVuY3Rpb24oZGF0YSl7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5zdGF0ZSA9PT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDbG91ZExvZ2luKHVzZXIuaWQsIHVzZXIuY3Vyc29yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIk5vIHVzZXIgc2Vzc2lvbiBzYXZlZCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9nb3V0Q2xvdWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgY2FsbGJhY2sodGhpcy51c2VySWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVsZXRlIGEgcmVjb3JkfGVkaXRvciBvbiB0aGUgY2xvdWQKICAgICAgICAgKiBAcGFyYW0gcmVtb3RlRGlyIHJlbW90ZSBkaXJlY3RvcnkgW3JlY29yZHN8ZWRpdG9yc10KICAgICAgICAgKiBAcGFyYW0gaXRlbSwgY291bGQgYmUgZWl0aGVyIGVkaXRvciBvciByZWNvcmQKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgZGVsZXRlSXRlbTogZnVuY3Rpb24ocmVtb3RlRGlyLCBpdGVtLCBjYWxsYmFjayl7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVXJsKHJlbW90ZURpciwgIiIpOwoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiRGVsZXRlIGl0ZW0gZnJvbSAiK3JlbW90ZURpcisiIHdpdGggIiArIHVybCk7CiAgICAgICAgICAgIGlmKHJlbW90ZURpciA9PT0gInJlY29yZHMiKXsKICAgICAgICAgICAgICAgIHVybCA9IHVybCtpdGVtLm5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZihyZW1vdGVEaXIgPT09ICJlZGl0b3JzIil7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwraXRlbSsiLmVkdHIiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIkRFTEVURSIsCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeHBvcnQgYSByZWNvcmQgb24gdGhlIAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5IFtyZWNvcmRzfGVkaXRvcnNdCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuaXRlbSwgY291bGQgYmUgZWl0aGVyIGVkaXRvciBvciByZWNvcmQKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgZXhwb3J0SXRlbTogZnVuY3Rpb24ob3B0aW9ucywgY2FsbGJhY2spewoKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVcmwoImV4cG9ydCIsIG9wdGlvbnMuaXRlbS5uYW1lKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIlBVVCBpdGVtIHRvICIrb3B0aW9ucy5yZW1vdGVEaXIrIiB3aXRoICIgKyB1cmwpOwoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJQT1NUIiwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgYXNzZXRzIHVybHMKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBnZXRBc3NldHM6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgdGhpcy5nZXRJdGVtcygicmVjb3JkcyIsICJhc3NldHMvaW1hZ2VzIiwgeyJmcm10IjogInVybCJ9LCBmdW5jdGlvbihzdWNjZXNzLCBkYXRhKXsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN1Y2Nlc3MsIGRhdGEpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcmV0dXJuIFRoZSBVUkwgdG8gdGhlIGNsb3VkIHByb3ZpZGVyLgogICAgICAgICAqLwogICAgICAgIGdldENsb3VkUHJvdmlkZXJVcmw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jbG91ZFByb3ZpZGVyVXJsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZldGNoIGFsbCB0aGUgaXRlbXMgb24gdGhlIGNsb3VkCiAgICAgICAgICogQHBhcmFtIHJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5CiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBpdGVtcwogICAgICAgICAqLwogICAgICAgIGdldEZTSXRlbXM6IGZ1bmN0aW9uKHJlbW90ZURpciwgY2FsbGJhY2spewogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZEZTVXJsKHJlbW90ZURpciwgIiIpOwoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiR2V0IGl0ZW1zIG9mICIrcmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGZXRjaCBhbiBpdGVtIG9uIHRoZSBjbG91ZAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5CiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuaXRlbSB0aGUgZmlsZQogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBmZXRjaGluZyB0aGUgaXRlbXMKICAgICAgICAgKi8KICAgICAgICBnZXRGU0l0ZW06IGZ1bmN0aW9uKG9wdGlvbnMsIGNhbGxiYWNrKXsKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRGU1VybChvcHRpb25zLnJlbW90ZURpciwgb3B0aW9ucy5pdGVtKTsKICAgICAgICAgICAgaWYob3B0aW9ucy51c2VySWQpewogICAgICAgICAgICAgICAgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwob3B0aW9ucy51c2VySWQsIG9wdGlvbnMucmVtb3RlRGlyLCBvcHRpb25zLml0ZW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJHZXQgaXRlbSAiK29wdGlvbnMuaXRlbSsiIG9mICIrb3B0aW9ucy5yZW1vdGVEaXIrIiB3aXRoICIgKyB1cmwpOwoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5lcnJvciA9PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCBzdGF0dXMsIGVycm9yKXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQcm9ibGVtIHdpdGggIiArIHVybCArICIgOiBzdGF0dXM9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgKyAiIDogIiArIGVycm9yKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZldGNoIGFsbCB0aGUgcmVjb3Jkc3xlZGl0b3JzIG9uIHRoZSBjbG91ZAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5IFtyZWNvcmRzfGVkaXRvcnNdCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuaXRlbSBnZXQgYSBmaWxlIGZyb20gUENBUEkKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5kYXRhVHlwZSBvZiB0aGUgaXRlbSAoanNvbiwgaHRtbCwgdHh0KQogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBmZXRjaGluZyB0aGUgaXRlbXMKICAgICAgICAgKi8KICAgICAgICBnZXRJdGVtOiBmdW5jdGlvbihvcHRpb25zLCBjYWxsYmFjayl7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVXJsKG9wdGlvbnMucmVtb3RlRGlyLCBvcHRpb25zLml0ZW0pOwoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiR2V0IGl0ZW0gIitvcHRpb25zLml0ZW0rIiBvZiAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsICsgIiBhbmQgZGF0YVR5cGUgIiArIG9wdGlvbnMuZGF0YVR5cGUpOwoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6IG9wdGlvbnMuZGF0YVR5cGUsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGZXRjaCBhbGwgdGhlIHJlY29yZHN8ZWRpdG9ycyBvbiB0aGUgY2xvdWQKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5yZW1vdGVEaXIgcmVtb3RlIGRpcmVjdG9yeSBbcmVjb3Jkc3xlZGl0b3JzXQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLmV4dHJhcyBwYXRoIGZvciB1cmwKICAgICAgICAgKiBAcGFtYW0gb3B0aW9ucy5maWx0ZXJzIGZpbHRlciBmb3IgcmVjb3JkcwogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBmZXRjaGluZyB0aGUgaXRlbXMKICAgICAgICAgKi8KICAgICAgICBnZXRJdGVtczogZnVuY3Rpb24ob3B0aW9ucywgY2FsbGJhY2spewogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVybChvcHRpb25zLnJlbW90ZURpciwgb3B0aW9ucy5leHRyYXMpOwoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiR2V0IGl0ZW1zIG9mICIrb3B0aW9ucy5yZW1vdGVEaXIrIiB3aXRoICIgKyB1cmwpOwogICAgICAgICAgICAvL2lmIGl0J3MgdW5kZWZpbmVkIG1ha2UgaXQgZW1wdHkgb2JqZWN0IGluIG9yZGVyIG5vdCB0byBicmVhayBpdAogICAgICAgICAgICBpZihvcHRpb25zLmZpbHRlcnMgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICBvcHRpb25zLmZpbHRlcnMgPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cob3B0aW9ucy5maWx0ZXJzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgZGF0YTogb3B0aW9ucy5maWx0ZXJzLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5lcnJvciA9PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCBzdGF0dXMsIGVycm9yKXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQcm9ibGVtIHdpdGggIiArIHVybCArICIgOiBzdGF0dXM9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgKyAiIDogIiArIGVycm9yKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBwYXJhbWV0ZXJzIG9mIHRoZSB1cmwuIEl0J3MgbmVlZGVkCiAgICAgICAgICogZm9yIHRoZSBzeW5jaHJvbm91cyBsb2dpbi4KICAgICAgICAgKiBAcmV0dXJucyBvYmplY3Qgd2l0aCBrZXksIHZhbHVlcyBvZiB0aGUgdXJsIHBhcmFtZXRlcnMKICAgICAgICAgKi8KICAgICAgICBnZXRQYXJhbWV0ZXJzOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIHZhciBxdWVyeVN0cmluZyA9IHt9OwogICAgICAgICAgICB2YXIgcGFyYW1zID0gcXVlcnkuc3BsaXQoIiYiKTsKICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8cGFyYW1zLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIHZhciBwYWlyID0gcGFyYW1zW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dID0gcGFpclsxXTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBzZWNvbmQgZW50cnkgd2l0aCB0aGlzIG5hbWUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIHZhciBhcnIgPSBbIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dLCBwYWlyWzFdIF07CiAgICAgICAgICAgICAgICAgICAgcXVlcnlTdHJpbmdbcGFpclswXV0gPSBhcnI7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhpcmQgb3IgbGF0ZXIgZW50cnkgd2l0aCB0aGlzIG5hbWUKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcXVlcnlTdHJpbmdbcGFpclswXV0ucHVzaChwYWlyWzFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcXVlcnlTdHJpbmc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0IGFsbCBwcm92aWRlcnMgUENBUEkgc3VwcG9ydHMKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIHByb3ZpZGVycwogICAgICAgICAqLwogICAgICAgIGdldFByb3ZpZGVyczogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5nZXRDbG91ZFByb3ZpZGVyVXJsKCkrIi9hdXRoL3Byb3ZpZGVycyI7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UKICAgICAgICAgICAgfSkuZG9uZShmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQcm9ibGVtIHdpdGggIiArIHVybCArICIgOiBzdGF0dXM9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgKyAiIDogIiArIGVycm9yKTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHByb3ZpZGVyIHRoYXQgdGhlIHVzZXIgaGFzIHNlbGVjdGVkIGZvciBQQ0FQSQogICAgICAgICAqIEByZXR1cm5zIHRoZSBwcm92aWRlciBmcm9tCiAgICAgICAgICovCiAgICAgICAgZ2V0UHJvdmlkZXI6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY2xvdWQtcHJvdmlkZXInKSB8fCAnbG9jYWwnOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEByZXR1cm4gVGhlIGNsb3VkIGxvZ2luIHVzZXIuCiAgICAgICAgICogICBpZCAtIGNsb3VkIHVzZXIgaWQKICAgICAgICAgKiAgIGN1cnNvciAtIGN1cnNvciBvZiBsYXN0IHN5bmMuCiAgICAgICAgICovCiAgICAgICAgZ2V0VXNlcjogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudXNlcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgdXNlcmlkCiAgICAgICAgICogQHJldHVybnMgdGhlIHVzZXJJZCBmb3IgUENBUEkKICAgICAgICAgKi8KICAgICAgICBnZXRVc2VySWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBpZCA9IGdldENsb3VkTG9naW5JZCgpOwogICAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9naW4gdG8gY2xvdWQgcHJvdmlkZXIgYXN5bmNocm9ub3VzbHkKICAgICAgICAgKi8KICAgICAgICBsb2dpbkFzeW5jQ2xvdWQ6IGZ1bmN0aW9uKHByb3ZpZGVyLCBjYiwgY2Jyb3dzZXIpewogICAgICAgICAgICBkb0xvZ2luKHByb3ZpZGVyLCBjYiwgY2Jyb3dzZXIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBsb2dpbmcgaW4gUENBUEkgc3luY2hyb25vdXNseQogICAgICAgICAqLwogICAgICAgIGxvZ2luQ2xvdWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKCEoInVpZCIgaW4gdGhpcy5nZXRQYXJhbWV0ZXJzKCkpKXsKICAgICAgICAgICAgICAgIHZhciBsb2dpblVybCA9IHRoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpICsgJy9hdXRoLycrdGhpcy5nZXRQcm92aWRlcigpKyI/Y2FsbGJhY2s9IiskKGxvY2F0aW9uKS5hdHRyKCdocmVmJyk7CiAgICAgICAgICAgICAgICAkLmdldEpTT04obG9naW5VcmwsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAkKGxvY2F0aW9uKS5hdHRyKCdocmVmJyxkYXRhLnVybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvZ291dCBmcm9tIGNsb3VkIHByb3ZpZGVyLgogICAgICAgICAqLwogICAgICAgIGxvZ291dENsb3VkOiBmdW5jdGlvbigpewogICAgICAgICAgICBjbGVhckNsb3VkTG9naW4oKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBQb3N0IGEgcmVjb3JkfGVkaXRvciBvbiB0aGUgY2xvdWQKICAgICAgICAgKiBAcGFyYW0gcmVtb3RlRGlyIHJlbW90ZSBkaXJlY3RvcnkgW3JlY29yZHN8ZWRpdG9yc10KICAgICAgICAgKiBAcGFyYW0gaXRlbSwgY291bGQgYmUgZWl0aGVyIGVkaXRvciBvciByZWNvcmQKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgc2F2ZUl0ZW06IGZ1bmN0aW9uKHVzZXJJZCwgcmVtb3RlRGlyLCBpdGVtLCBjYWxsYmFjayl7CgogICAgICAgICAgICB2YXIgdXJsLCBkYXRhOwogICAgICAgICAgICBpZihyZW1vdGVEaXIgPT09ICJyZWNvcmRzIil7CiAgICAgICAgICAgICAgICBkYXRhID0gSlNPTi5zdHJpbmdpZnkoaXRlbSwgdW5kZWZpbmVkLCAyKTsKICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKHVzZXJJZCwgcmVtb3RlRGlyLCBpdGVtLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYocmVtb3RlRGlyID09PSAiZWRpdG9ycyIpewogICAgICAgICAgICAgICAgZGF0YSA9IGl0ZW0uZWRpdG9yLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwodXNlcklkLCByZW1vdGVEaXIsIGl0ZW0ubmFtZSsiLmVkdHIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiUG9zdCBpdGVtIHRvICIrcmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiUE9TVCIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzKXsKICAgICAgICAgICAgICAgICAgICBpZihyZXMuZXJyb3IgPT09IDApewogICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgcmVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcocmVzLm1zZyk7CiAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZSBjbG91ZCB1c2VyIGlkIGluIGxvY2FsIHN0b3JhZ2UuCiAgICAgICAgICovCiAgICAgICAgc2V0Q2xvdWRMb2dpbjogZnVuY3Rpb24odXNlcklkLCBjdXJzb3IpewogICAgICAgICAgICB0aGlzLnVzZXIgPSB7CiAgICAgICAgICAgICAgICAnaWQnOiB1c2VySWQsCiAgICAgICAgICAgICAgICAnY3Vyc29yJzogY3Vyc29yCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY2xvdWQtdXNlcicsIEpTT04uc3RyaW5naWZ5KHRoaXMudXNlcikpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldCB0aGUgY2xvdWQgcHJvdmlkZXIgVVJMLgogICAgICAgICAqIEBwYXJhbSByb290IFRoZSBTZXJ2ZXIgVVJMIHJvb3QuCiAgICAgICAgICovCiAgICAgICAgc2V0Q2xvdWRQcm92aWRlclVybDogZnVuY3Rpb24odXJsKXsKICAgICAgICAgICAgdGhpcy5jbG91ZFByb3ZpZGVyVXJsID0gdXJsICsgIi8iICsgdGhpcy52ZXJzaW9uICsgIi9wY2FwaSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIHNldHRpbmcgdGhlIHByb3ZpZGVyIG9mIFBDQVBJIGluIHRoZSBsb2NhbFN0b3JhZ2UKICAgICAgICAgKiBAcGFyYW0gcHJvdmlkZXIKICAgICAgICAgKi8KICAgICAgICBzZXRQcm92aWRlcjogZnVuY3Rpb24ocHJvdmlkZXIpewogICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY2xvdWQtcHJvdmlkZXInLCBwcm92aWRlcik7CiAgICAgICAgICAgIC8vdGhpcy5wcm92aWRlciA9IHByb3ZpZGVyOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBzZXR0aW5nIHVwIHRoZSB1c2VySWQgd2hpY2ggY29tZXMgZnJvbSBQQ0FQSQogICAgICAgICAqIEBwYXJhbSB1c2VySWQKICAgICAgICAgKi8KICAgICAgICBzZXRVc2VySWQ6IGZ1bmN0aW9uKHVzZXJJZCl7CiAgICAgICAgICAgIHRoaXMudXNlcklkID0gdXNlcklkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFVwZGF0ZSBhIHJlY29yZHxlZGl0b3Igb24gdGhlIGNsb3VkCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMucmVtb3RlRGlyIHJlbW90ZSBkaXJlY3RvcnkgW3JlY29yZHN8ZWRpdG9yc10KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5pdGVtLCBjb3VsZCBiZSBlaXRoZXIgZWRpdG9yIG9yIHJlY29yZAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLmZpbGUgZm9yIHJlY29yZHMgd2UgbmVlZCB0byBrbm93IHdoaWNoIHNwZWNpZmljIGZpbGUgdG8gdXBkYXRlCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBpdGVtcwogICAgICAgICAqLwogICAgICAgIHVwZGF0ZUl0ZW06IGZ1bmN0aW9uKG9wdGlvbnMsIGNhbGxiYWNrKXsKCiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVXJsKG9wdGlvbnMucmVtb3RlRGlyLCAiIik7CgogICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJQVVQgaXRlbSB0byAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgIGlmKG9wdGlvbnMucmVtb3RlRGlyID09PSAicmVjb3JkcyIpewogICAgICAgICAgICAgICAgZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuaXRlbSwgdW5kZWZpbmVkLCAyKTsKICAgICAgICAgICAgICAgIHVybCA9IHVybCArIG9wdGlvbnMuaXRlbS5uYW1lKyIvIiArIG9wdGlvbnMuZmlsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmKG9wdGlvbnMucmVtb3RlRGlyID09PSAiZWRpdG9ycyIpewogICAgICAgICAgICAgICAgZGF0YSA9IG9wdGlvbnMuaXRlbS5lZGl0b3Iuam9pbigiIik7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwgKyBvcHRpb25zLml0ZW0ubmFtZSsiLmVkdHIiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIlBVVCIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmVycm9yID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIHVwbG9hZGluZyBhIGZpbGUKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5yZW1vdGVEaXIKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5maWxlbmFtZQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLmZpbGUKICAgICAgICAgKi8KICAgICAgICB1cGxvYWRGaWxlOiBmdW5jdGlvbihvcHRpb25zLCBjYWxsYmFjayl7CgogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZEZTVXJsKG9wdGlvbnMucmVtb3RlRGlyLCBvcHRpb25zLmZpbGVuYW1lKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIlVwbG9hZCBpdGVtICIrb3B0aW9ucy5maWxlLm5hbWUrIiB0byAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiUE9TVCIsCiAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBvcHRpb25zLmZpbGUudHlwZSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhOiBvcHRpb25zLmZpbGUsCiAgICAgICAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0galF1ZXJ5LnBhcnNlSlNPTihkYXRhKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgb2JqLmVycm9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gX3RoaXM7Cn0pKCk7Cg==",
                "body": "LyoKQ29weXJpZ2h0IChjKSAyMDE0LCBFRElOQS4KQWxsIHJpZ2h0cyByZXNlcnZlZC4KClJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dCBtb2RpZmljYXRpb24sCmFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKCjEuIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpcwogICBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KMi4gUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLCB0aGlzCiAgIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uIGFuZC9vcgogICBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgozLiBBbGwgYWR2ZXJ0aXNpbmcgbWF0ZXJpYWxzIG1lbnRpb25pbmcgZmVhdHVyZXMgb3IgdXNlIG9mIHRoaXMgc29mdHdhcmUgbXVzdAogICBkaXNwbGF5IHRoZSBmb2xsb3dpbmcgYWNrbm93bGVkZ2VtZW50OiBUaGlzIHByb2R1Y3QgaW5jbHVkZXMgc29mdHdhcmUKICAgZGV2ZWxvcGVkIGJ5IHRoZSBFRElOQS4KNC4gTmVpdGhlciB0aGUgbmFtZSBvZiB0aGUgRURJTkEgbm9yIHRoZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvCiAgIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cyBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yCiAgIHdyaXR0ZW4gcGVybWlzc2lvbi4KClRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgRURJTkEgJydBUyBJUycnIEFORCBBTlkgRVhQUkVTUyBPUiBJTVBMSUVECldBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRCBXQVJSQU5USUVTIE9GCk1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UClNIQUxMIEVESU5BIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwKT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YKU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCklOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULApTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWQpPVVQgT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0gKREFNQUdFLgoqLwoKInVzZSBzdHJpY3QiOwoKdmFyIHBjYXBpID0gKGZ1bmN0aW9uKCl7CgogICAgLyoqCiAgICAgKiBVbnNldCB1c2VyIGxvZ2luIGlkLgogICAgICovCiAgICB2YXIgY2xlYXJDbG91ZExvZ2luID0gZnVuY3Rpb24oKXsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY2xvdWQtdXNlcicsIEpTT04uc3RyaW5naWZ5KHsnaWQnOiB1bmRlZmluZWR9KSk7CiAgICB9OwoKICAgIC8qKgogICAgICogTG9naW4gdG8gY2xvdWQgcHJvdmlkZXIuCiAgICAgKiBAcGFyYW4gcHJvdmlkZXIgVGhlIHByb3ZpZGVyIHR5cGUuCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgRnVuY3Rpb24gY2FsbGVkIGFmdGVyIGxvZ2luIGF0dGVtcHQuCiAgICAgKiBAcGFyYW0gY2Jyb3dzZXIgRnVuY3Rpb24gdG8gYWxsb3cgY2FsbGVyIHJlcXVpcmVzIGFjY2VzcyB0byBjaGlsZGJyb3dzZXIuCiAgICAgKi8KICAgIHZhciBkb0xvZ2luID0gZnVuY3Rpb24ocHJvdmlkZXIsIGNhbGxiYWNrLCBjYnJvd3Nlcil7CiAgICAgICAgdmFyIGxvZ2luVXJsID0gX3RoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpICsgJy9hdXRoLycgKyBwcm92aWRlcjsKICAgICAgICBpZiAocHJvdmlkZXIgPT09ICdsb2NhbCcpIHsKICAgICAgICAgICAgZG9Mb2dpbkxvY2FsKGNhbGxiYWNrLCBjYnJvd3NlciwgbG9naW5VcmwpOwogICAgICAgIH0KICAgICAgICBlbHNlewogICAgICAgICAgICBkb0xvZ2luRHJvcEJveChjYWxsYmFjaywgY2Jyb3dzZXIsIGxvZ2luVXJsKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogTG9naW4gdG8gYSBsb2NhbCBjbG91ZCBwcm92aWRlci4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBGdW5jdGlvbiBjYWxsZWQgYWZ0ZXIgbG9naW4gYXR0ZW1wdC4KICAgICAqIEBwYXJhbSBsb2dpblVybAogICAgICovCiAgICB2YXIgZG9Mb2dpbkxvY2FsID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNicm93c2VyLCBsb2dpblVybCl7CiAgICAgICAgdmFyIHBvbGxUaW1lciwKICAgICAgICAgICAgcG9sbFRpbWVyQ291bnQgPSAwLAogICAgICAgICAgICBwb2xsSW50ZXJ2YWwgPSAzMDAwLAogICAgICAgICAgICBwb2xsRm9yTWF4ID0gNSAqIDYwICogMTAwMDsgLy9taW4KICAgICAgICB2YXIgcG9sbFVybCA9IGxvZ2luVXJsOwogICAgICAgIGNvbnNvbGUuZGVidWcoJ0xvZ2luIHdpdGg6ICcgKyBwb2xsVXJsKTsKICAgICAgICB2YXIgY2IgPSB3aW5kb3cub3Blbihwb2xsVXJsLCAnX2JsYW5rJywgJ2xvY2F0aW9uPW5vJyk7CgoKICAgICAgICAvLyBjbG9zZSBjaGlsZCBicm93c2VyCiAgICAgICAgdmFyIGNsb3NlQ2IgPSBmdW5jdGlvbih1c2VySWQpewogICAgICAgICAgICBjbGVhckludGVydmFsKHBvbGxUaW1lcik7CiAgICAgICAgICAgIGNhbGxiYWNrKHVzZXJJZCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc29sZS5kZWJ1ZygnUG9sbDogJyArIHBvbGxVcmwpOwogICAgICAgIHBvbGxUaW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB1cmw6IHBvbGxVcmwsCiAgICAgICAgICAgICAgICB0aW1lb3V0OiAzMDAwLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocG9sbERhdGEpewogICAgICAgICAgICAgICAgICAgIHBvbGxUaW1lckNvdW50ICs9IHBvbGxJbnRlcnZhbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIGh0bWwgcmVzcG9uc2VzIChsaWtlIHRoZSByZWRpcmVjdGlvbiBmcm9tIFNoaWJib2xldGgpCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHBvbGxEYXRhKSA9PT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgICAgICAgaWYocG9sbERhdGEuc3RhdGUgPT09IDEgfHwgcG9sbFRpbWVyQ291bnQgPiBwb2xsRm9yTWF4KXsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2xvdWRVc2VySWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocG9sbERhdGEuc3RhdGUgPT09IDEgKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvdWRVc2VySWQgPSBwb2xsRGF0YS51c2VyaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNldENsb3VkTG9naW4oY2xvdWRVc2VySWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBjYi5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQ2IoY2xvdWRVc2VySWQpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gcG9sbGluZyBhcGk6ICIgKyBlcnJvci5zdGF0dXNUZXh0KTsKICAgICAgICAgICAgICAgICAgICBjbG9zZUNiKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9KTsKICAgICAgICB9LCBwb2xsSW50ZXJ2YWwpOwoKICAgICAgICBpZihjYnJvd3Nlcil7CiAgICAgICAgICAgIC8vIGNhbGxlciBtYXkgd2FudCBhY2Nlc3MgdG8gY2hpbGQgYnJvd3NlciByZWZlcmVuY2UKICAgICAgICAgICAgY2Jyb3dzZXIoY2IpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBMb2dpbiB0byBkcm9wYm94LgogICAgICogQHBhcmFtIGNhbGxiYWNrIEZ1bmN0aW9uIGNhbGxlZCBhZnRlciBsb2dpbiBhdHRlbXB0LgogICAgICogQHBhcmFtIGNicm93c2VyIEZ1bmN0aW9uIHRvIGFsbG93IGNhbGxlciByZXF1aXJlcyBhY2Nlc3MgdG8gY2hpbGRicm93c2VyLgogICAgICogQHBhcmFtIGxvZ2luVXJsCiAgICAgKi8KICAgIHZhciBkb0xvZ2luRHJvcEJveCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYnJvd3NlciwgbG9naW5VcmwpewogICAgICAgIHZhciBwb2xsVGltZXIsIHBvbGxUaW1lckNvdW50ID0gMCwgcG9sbEludGVydmFsID0gMzAwMCwgcG9sbEZvck1heCA9IDUgKiA2MCAqIDEwMDA7IC8vbWluCgogICAgICAgIHZhciB1c2VySWQgPSBnZXRDbG91ZExvZ2luSWQoKTsKICAgICAgICBpZih1c2VySWQgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoImdvdCBhIHVzZXIgaWQ6ICIgKyB1c2VySWQpOwogICAgICAgICAgICBsb2dpblVybCArPSAnLycgKyB1c2VySWQ7CiAgICAgICAgfQoKICAgICAgICAvLyBjbGVhciB1c2VyIGlkCiAgICAgICAgY2xlYXJDbG91ZExvZ2luKCk7CiAgICAgICAgY29uc29sZS5kZWJ1ZygnTG9naW4gd2l0aDogJyArIGxvZ2luVXJsICsgJz9hc3luYz10cnVlJyk7CgogICAgICAgICQuYWpheCh7CiAgICAgICAgICAgIHVybDogbG9naW5VcmwgKyAnP2FzeW5jPXRydWUnLAogICAgICAgICAgICB0aW1lb3V0OiAzMDAwLAogICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiUmVkaXJlY3QgdG86ICIgKyBkYXRhLnVybCk7CiAgICAgICAgICAgICAgICB2YXIgY2xvdWRVc2VySWQgPSBkYXRhLnVzZXJpZDsKCiAgICAgICAgICAgICAgICAvLyBjbG9zZSBjaGlsZCBicm93c2VyCiAgICAgICAgICAgICAgICB2YXIgY2xvc2VDYiA9IGZ1bmN0aW9uKHVzZXJJZCl7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChwb2xsVGltZXIpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVzZXJJZCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIG9wZW4gZHJvcGJveCBsb2dpbiBpbiBjaGlsZCBicm93c2VyCiAgICAgICAgICAgICAgICB2YXIgY2IgPSB3aW5kb3cub3BlbihkYXRhLnVybCwgJ19ibGFuaycsICdsb2NhdGlvbj1ubycpOwogICAgICAgICAgICAgICAgLy9jYi5hZGRFdmVudExpc3RlbmVyKCdleGl0JywgY2xvc2VDYik7CgogICAgICAgICAgICAgICAgdmFyIHBvbGxVcmwgPSBsb2dpblVybCArICcvJyArIGNsb3VkVXNlcklkICsgJz9hc3luYz10cnVlJzsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoJ1BvbGw6ICcgKyBwb2xsVXJsKTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBwb2xsVXJsLAogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihwb2xsRGF0YSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2xsVGltZXJDb3VudCArPSBwb2xsSW50ZXJ2YWw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocG9sbERhdGEuc3RhdGUgPT09IDEgfHwgcG9sbFRpbWVyQ291bnQgPiBwb2xsRm9yTWF4KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwb2xsRGF0YS5zdGF0ZSA9PT0gMSApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZXRDbG91ZExvZ2luKGNsb3VkVXNlcklkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9zZUNiKGNsb3VkVXNlcklkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGVycm9yKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gcG9sbGluZyBhcGk6ICIgKyBlcnJvci5zdGF0dXNUZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQ2IoeyJzdGF0dXMiOiAtMSwgIm1zZyI6ICJQcm9ibGVtIHBvbGxpbmcgYXBpIn0pOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIHBvbGxJbnRlcnZhbCk7CgogICAgICAgICAgICAgICAgaWYoY2Jyb3dzZXIpewogICAgICAgICAgICAgICAgICAgIC8vIGNhbGxlciBtYXkgd2FudCBhY2Nlc3MgdG8gY2hpbGQgYnJvd3NlciByZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICBjYnJvd3NlcihjYik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgdGV4dFN0YXR1cyl7CiAgICAgICAgICAgICAgICB2YXIgbXNnOwogICAgICAgICAgICAgICAgaWYodGV4dFN0YXR1cyA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgICB0ZXh0U3RhdHVzID0gJyBVbnNwZWNpZmllZCBFcnJvci4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZih0ZXh0U3RhdHVzID09PSAidGltZW91dCIpIHsKICAgICAgICAgICAgICAgICAgICBtc2cgPSAiVW5hYmxlIHRvIGxvZ2luLCBwbGVhc2UgZW5hYmxlIGRhdGEgY29ubmVjdGlvbi4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICBtc2cgPSAiUHJvYmxlbSB3aXRoIGxvZ2luOiAiICsgdGV4dFN0YXR1czsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjayh7InN0YXR1cyI6IC0xLCAibXNnIjogbXNnfSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNsb3VkIGxvZ2luIGZyb20gbG9jYWwgc3RvcmFnZS4KICAgICAqLwogICAgdmFyIGdldENsb3VkTG9naW4gPSBmdW5jdGlvbigpewogICAgICAgIHZhciBsb2dpbiA9IG51bGw7CiAgICAgICAgdmFyIHVzZXIgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY2xvdWQtdXNlcicpOwogICAgICAgIGlmKHVzZXIpewogICAgICAgICAgICBsb2dpbiA9IEpTT04ucGFyc2UodXNlcik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbG9naW47CiAgICB9OwoKICAgIC8qKgogICAgICogR2V0IHRoZSBjbG91ZCBsb2dpbiBpZCBmcm9tIGxvY2FsIHN0b3JhZ2UuCiAgICAgKi8KICAgIHZhciBnZXRDbG91ZExvZ2luSWQgPSBmdW5jdGlvbigpewogICAgICAgIHZhciBpZDsKICAgICAgICB2YXIgbG9naW4gPSBnZXRDbG91ZExvZ2luKCk7CiAgICAgICAgaWYodHlwZW9mKGxvZ2luKSA9PT0gJ29iamVjdCcpewogICAgICAgICAgICBpZCA9IGxvZ2luLmlkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGlkOwogICAgfTsKCiAgICAvKioKICAgICAqIGZ1bmN0aW9uIGZvciBmaW5kaW5nIHRoIGV4dGVuc2lvbiBvZiBhIHN0cmluZwogICAgICogQHBhcmFtIHN0cmluZwogICAgICogQHN1ZmZpeAogICAgICogQHJldHVybnMgdHJ1ZS9mYWxzZSBpZiBzdWZmaXggYWdncmVlcyB3aXRoIHN0cmluZyBleHRlbnNpb24KICAgICAqLwogICAgdmFyIGVuZHNXaXRoID0gZnVuY3Rpb24oc3RyLCBzdWZmaXgpIHsKICAgICAgICByZXR1cm4gc3RyLmluZGV4T2Yoc3VmZml4LCBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogICAgfTsKCiAgICB2YXIgX3RoaXMgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEluaXRpYWxpemUgcGNhcGkgb2JqZWN0CiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMudXJsIHVybCBvZiB0aGUgUENBUEkKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy52ZXJzaW9uIHZlcnNpb24gbnVtYmVyIG9mIFBDQVBJCiAgICAgICAgICovCiAgICAgICAgaW5pdDogZnVuY3Rpb24ob3B0aW9ucyl7CiAgICAgICAgICAgIHRoaXMuYmFzZVVybCA9IG9wdGlvbnMudXJsOwogICAgICAgICAgICB0aGlzLnZlcnNpb24gPSBvcHRpb25zLnZlcnNpb247CiAgICAgICAgICAgIHRoaXMuY2xvdWRQcm92aWRlclVybCA9IG9wdGlvbnMudXJsICsgIi8iICsgb3B0aW9ucy52ZXJzaW9uICsgIi9wY2FwaSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIGJ1aWxkaW5nIHRoZSBtYWluIHVybHMKICAgICAgICAgKiA8ZG9tYWluPi88dmVyc2lvbj4vcGNhcGkvPHJlY29yZHMvZWRpdG9ycz4vPHByb3ZpZGVyPi88dXNlcmlkPi8uLi4KICAgICAgICAgKiBAcGFyYW0gcmVtb3RlRGlyIHRoZSByZW1vdGUgZGlyIHdoaWNoIGlzIGVpdGhlciByZWNvcmRzIG9yIGVkaXRvcnMKICAgICAgICAgKiBAaXRlbSB0aGUgZm9sZGVyL2ZpbGUgaW5zaWRlIHRoZSByZWNvcmRzL2VkaXRvcnMgZm9sZGVyCiAgICAgICAgICogQHJldHVybnMgdXJsCiAgICAgICAgICovCiAgICAgICAgYnVpbGRVcmwgOiBmdW5jdGlvbihyZW1vdGVEaXIsIGl0ZW0pewogICAgICAgICAgICB2YXIgdXNlcklkID0gZ2V0Q2xvdWRMb2dpbklkKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmJ1aWxkVXNlclVybCh1c2VySWQsIHJlbW90ZURpciwgaXRlbSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVE9ETwogICAgICAgICAqLwogICAgICAgIGJ1aWxkVXNlclVybDogZnVuY3Rpb24odXNlcklkLCBjYXRlZ29yeSwgcGF0aCl7CiAgICAgICAgICAgIHBhdGggPSBwYXRoIHx8ICcnOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpICsgJy8nICsgY2F0ZWdvcnkgKyAnLycgKwogICAgICAgICAgICAgICAgICAgdGhpcy5nZXRQcm92aWRlcigpICsgJy8nICsgdXNlcklkICsgJy8nICsgcGF0aDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgYnVpbGRpbmcgdGhlIG1haW4gdXJscwogICAgICAgICAqIDxkb21haW4+Lzx2ZXJzaW9uPi9wY2FwaS9mcy88cHJvdmlkZXI+Lzx1c2VyaWQ+Lzxmb2xkZXI+LwogICAgICAgICAqIEBwYXJhbSByZW1vdGVEaXIgdGhlIHJlbW90ZSBkaXIKICAgICAgICAgKiBAaXRlbSB0aGUgZm9sZGVyL2ZpbGUgaW5zaWRlIHRoZSByZW1vdGVEaXIgZm9sZGVyCiAgICAgICAgICogQHJldHVybnMgdXJsCiAgICAgICAgICovCiAgICAgICAgYnVpbGRGU1VybCA6IGZ1bmN0aW9uKHJlbW90ZURpciwgaXRlbSl7CiAgICAgICAgICAgIHZhciB1c2VySWQgPSBnZXRDbG91ZExvZ2luSWQoKTsKICAgICAgICAgICAgaWYgKHVzZXJJZCA9PT0gImxvY2FsIikgewogICAgICAgICAgICAgICAgdXNlcklkID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgIHVzZXJJZCA9ICIvIit1c2VySWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpICsgJy9mcy8nICsKICAgICAgICAgICAgICAgIHRoaXMuZ2V0UHJvdmlkZXIoKSArIHVzZXJJZCArJy8nK3JlbW90ZURpcisnLycraXRlbTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDaGVjayBpZiB0aGUgdXNlciBpcyBsb2dnZWQgaW4KICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgY2hlY2tpbmcgdGhlIGxvZ2luIHN0YXR1cwogICAgICAgICAqLwogICAgICAgIGNoZWNrTG9naW46IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgaWYoIXRoaXMudXNlcklkKXsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJjaGVjayBpZiB1c2VyIGlzIGxvZ2dlZCBpbiIpOwogICAgICAgICAgICAgICAgdmFyIHVzZXIgPSBnZXRDbG91ZExvZ2luKCk7CiAgICAgICAgICAgICAgICBpZih1c2VyICE9PSBudWxsICYmIHVzZXIuaWQpewogICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmdldENsb3VkUHJvdmlkZXJVcmwoKSArICcvYXV0aC8nK3RoaXMuZ2V0UHJvdmlkZXIoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5pZCAhPT0gImxvY2FsIikgewogICAgICAgICAgICAgICAgICAgICAgICB1cmwgKz0gJy8nK3VzZXIuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJDaGVjayB1c2VyIHdpdGg6ICIgKyB1cmwpOwogICAgICAgICAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJywKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiAkLnByb3h5KGZ1bmN0aW9uKGRhdGEpewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuc3RhdGUgPT09IDEpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2xvdWRMb2dpbih1c2VyLmlkLCB1c2VyLmN1cnNvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UsIGVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJObyB1c2VyIHNlc3Npb24gc2F2ZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ291dENsb3VkKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRoaXMudXNlcklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERlbGV0ZSBhIHJlY29yZHxlZGl0b3Igb24gdGhlIGNsb3VkCiAgICAgICAgICogQHBhcmFtIHJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5IFtyZWNvcmRzfGVkaXRvcnNdCiAgICAgICAgICogQHBhcmFtIGl0ZW0sIGNvdWxkIGJlIGVpdGhlciBlZGl0b3Igb3IgcmVjb3JkCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBpdGVtcwogICAgICAgICAqLwogICAgICAgIGRlbGV0ZUl0ZW06IGZ1bmN0aW9uKHJlbW90ZURpciwgaXRlbSwgY2FsbGJhY2spewogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVybChyZW1vdGVEaXIsICIiKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIkRlbGV0ZSBpdGVtIGZyb20gIityZW1vdGVEaXIrIiB3aXRoICIgKyB1cmwpOwogICAgICAgICAgICBpZihyZW1vdGVEaXIgPT09ICJyZWNvcmRzIil7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwraXRlbS5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYocmVtb3RlRGlyID09PSAiZWRpdG9ycyIpewogICAgICAgICAgICAgICAgdXJsID0gdXJsK2l0ZW0rIi5lZHRyIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJERUxFVEUiLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmVycm9yID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhwb3J0IGEgcmVjb3JkIG9uIHRoZSAKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5yZW1vdGVEaXIgcmVtb3RlIGRpcmVjdG9yeSBbcmVjb3Jkc3xlZGl0b3JzXQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLml0ZW0sIGNvdWxkIGJlIGVpdGhlciBlZGl0b3Igb3IgcmVjb3JkCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBpdGVtcwogICAgICAgICAqLwogICAgICAgIGV4cG9ydEl0ZW06IGZ1bmN0aW9uKG9wdGlvbnMsIGNhbGxiYWNrKXsKCiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVXJsKCJleHBvcnQiLCBvcHRpb25zLml0ZW0ubmFtZSk7CgogICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJQVVQgaXRlbSB0byAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiUE9TVCIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmVycm9yID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIGFzc2V0cyB1cmxzCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0QXNzZXRzOiBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgICAgICAgIHRoaXMuZ2V0SXRlbXMoInJlY29yZHMiLCAiYXNzZXRzL2ltYWdlcyIsIHsiZnJtdCI6ICJ1cmwifSwgZnVuY3Rpb24oc3VjY2VzcywgZGF0YSl7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhzdWNjZXNzLCBkYXRhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHJldHVybiBUaGUgVVJMIHRvIHRoZSBjbG91ZCBwcm92aWRlci4KICAgICAgICAgKi8KICAgICAgICBnZXRDbG91ZFByb3ZpZGVyVXJsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvdWRQcm92aWRlclVybDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGZXRjaCBhbGwgdGhlIGl0ZW1zIG9uIHRoZSBjbG91ZAogICAgICAgICAqIEBwYXJhbSByZW1vdGVEaXIgcmVtb3RlIGRpcmVjdG9yeQogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBmZXRjaGluZyB0aGUgaXRlbXMKICAgICAgICAgKi8KICAgICAgICBnZXRGU0l0ZW1zOiBmdW5jdGlvbihyZW1vdGVEaXIsIGNhbGxiYWNrKXsKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRGU1VybChyZW1vdGVEaXIsICIiKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIkdldCBpdGVtcyBvZiAiK3JlbW90ZURpcisiIHdpdGggIiArIHVybCk7CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmVycm9yID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmV0Y2ggYW4gaXRlbSBvbiB0aGUgY2xvdWQKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5yZW1vdGVEaXIgcmVtb3RlIGRpcmVjdG9yeQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLml0ZW0gdGhlIGZpbGUKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgZ2V0RlNJdGVtOiBmdW5jdGlvbihvcHRpb25zLCBjYWxsYmFjayl7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkRlNVcmwob3B0aW9ucy5yZW1vdGVEaXIsIG9wdGlvbnMuaXRlbSk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMudXNlcklkKXsKICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKG9wdGlvbnMudXNlcklkLCBvcHRpb25zLnJlbW90ZURpciwgb3B0aW9ucy5pdGVtKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiR2V0IGl0ZW0gIitvcHRpb25zLml0ZW0rIiBvZiAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGZXRjaCBhbGwgdGhlIHJlY29yZHN8ZWRpdG9ycyBvbiB0aGUgY2xvdWQKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5yZW1vdGVEaXIgcmVtb3RlIGRpcmVjdG9yeSBbcmVjb3Jkc3xlZGl0b3JzXQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLml0ZW0gZ2V0IGEgZmlsZSBmcm9tIFBDQVBJCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuZGF0YVR5cGUgb2YgdGhlIGl0ZW0gKGpzb24sIGh0bWwsIHR4dCkKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgZ2V0SXRlbTogZnVuY3Rpb24ob3B0aW9ucywgY2FsbGJhY2spewogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVybChvcHRpb25zLnJlbW90ZURpciwgb3B0aW9ucy5pdGVtKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIkdldCBpdGVtICIrb3B0aW9ucy5pdGVtKyIgb2YgIitvcHRpb25zLnJlbW90ZURpcisiIHdpdGggIiArIHVybCArICIgYW5kIGRhdGFUeXBlICIgKyBvcHRpb25zLmRhdGFUeXBlKTsKCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBvcHRpb25zLmRhdGFUeXBlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmVycm9yID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmV0Y2ggYWxsIHRoZSByZWNvcmRzfGVkaXRvcnMgb24gdGhlIGNsb3VkCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMucmVtb3RlRGlyIHJlbW90ZSBkaXJlY3RvcnkgW3JlY29yZHN8ZWRpdG9yc10KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5leHRyYXMgcGF0aCBmb3IgdXJsCiAgICAgICAgICogQHBhbWFtIG9wdGlvbnMuZmlsdGVycyBmaWx0ZXIgZm9yIHJlY29yZHMKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgZmV0Y2hpbmcgdGhlIGl0ZW1zCiAgICAgICAgICovCiAgICAgICAgZ2V0SXRlbXM6IGZ1bmN0aW9uKG9wdGlvbnMsIGNhbGxiYWNrKXsKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVcmwob3B0aW9ucy5yZW1vdGVEaXIsIG9wdGlvbnMuZXh0cmFzKTsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIkdldCBpdGVtcyBvZiAiK29wdGlvbnMucmVtb3RlRGlyKyIgd2l0aCAiICsgdXJsKTsKICAgICAgICAgICAgLy9pZiBpdCdzIHVuZGVmaW5lZCBtYWtlIGl0IGVtcHR5IG9iamVjdCBpbiBvcmRlciBub3QgdG8gYnJlYWsgaXQKICAgICAgICAgICAgaWYob3B0aW9ucy5maWx0ZXJzID09PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgb3B0aW9ucy5maWx0ZXJzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG9wdGlvbnMuZmlsdGVycyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIGRhdGE6IG9wdGlvbnMuZmlsdGVycywKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIGlmKGRhdGEuZXJyb3IgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUiwgc3RhdHVzLCBlcnJvcil7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgcGFyYW1ldGVycyBvZiB0aGUgdXJsLiBJdCdzIG5lZWRlZAogICAgICAgICAqIGZvciB0aGUgc3luY2hyb25vdXMgbG9naW4uCiAgICAgICAgICogQHJldHVybnMgb2JqZWN0IHdpdGgga2V5LCB2YWx1ZXMgb2YgdGhlIHVybCBwYXJhbWV0ZXJzCiAgICAgICAgICovCiAgICAgICAgZ2V0UGFyYW1ldGVyczogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIHZhciBxdWVyeSA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpOwogICAgICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSB7fTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHF1ZXJ5LnNwbGl0KCImIik7CiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IHBhcmFtc1tpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBxdWVyeVN0cmluZ1twYWlyWzBdXSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICBxdWVyeVN0cmluZ1twYWlyWzBdXSA9IHBhaXJbMV07CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgc2Vjb25kIGVudHJ5IHdpdGggdGhpcyBuYW1lCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBxdWVyeVN0cmluZ1twYWlyWzBdXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJyID0gWyBxdWVyeVN0cmluZ1twYWlyWzBdXSwgcGFpclsxXSBdOwogICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dID0gYXJyOwogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXJkIG9yIGxhdGVyIGVudHJ5IHdpdGggdGhpcyBuYW1lCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW3BhaXJbMF1dLnB1c2gocGFpclsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5U3RyaW5nOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldCBhbGwgcHJvdmlkZXJzIFBDQVBJIHN1cHBvcnRzCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBwcm92aWRlcnMKICAgICAgICAgKi8KICAgICAgICBnZXRQcm92aWRlcnM6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuZ2V0Q2xvdWRQcm92aWRlclVybCgpKyIvYXV0aC9wcm92aWRlcnMiOwogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlCiAgICAgICAgICAgIH0pLmRvbmUoZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlLCBkYXRhKTsKICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiUHJvYmxlbSB3aXRoICIgKyB1cmwgKyAiIDogc3RhdHVzPSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzICsgIiA6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBwcm92aWRlciB0aGF0IHRoZSB1c2VyIGhhcyBzZWxlY3RlZCBmb3IgUENBUEkKICAgICAgICAgKiBAcmV0dXJucyB0aGUgcHJvdmlkZXIgZnJvbQogICAgICAgICAqLwogICAgICAgIGdldFByb3ZpZGVyOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2Nsb3VkLXByb3ZpZGVyJykgfHwgJ2xvY2FsJzsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcmV0dXJuIFRoZSBjbG91ZCBsb2dpbiB1c2VyLgogICAgICAgICAqICAgaWQgLSBjbG91ZCB1c2VyIGlkCiAgICAgICAgICogICBjdXJzb3IgLSBjdXJzb3Igb2YgbGFzdCBzeW5jLgogICAgICAgICAqLwogICAgICAgIGdldFVzZXI6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnVzZXI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHVzZXJpZAogICAgICAgICAqIEByZXR1cm5zIHRoZSB1c2VySWQgZm9yIFBDQVBJCiAgICAgICAgICovCiAgICAgICAgZ2V0VXNlcklkOiBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgaWQgPSBnZXRDbG91ZExvZ2luSWQoKTsKICAgICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvZ2luIHRvIGNsb3VkIHByb3ZpZGVyIGFzeW5jaHJvbm91c2x5CiAgICAgICAgICovCiAgICAgICAgbG9naW5Bc3luY0Nsb3VkOiBmdW5jdGlvbihwcm92aWRlciwgY2IsIGNicm93c2VyKXsKICAgICAgICAgICAgZG9Mb2dpbihwcm92aWRlciwgY2IsIGNicm93c2VyKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3IgbG9naW5nIGluIFBDQVBJIHN5bmNocm9ub3VzbHkKICAgICAgICAgKi8KICAgICAgICBsb2dpbkNsb3VkOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZighKCJ1aWQiIGluIHRoaXMuZ2V0UGFyYW1ldGVycygpKSl7CiAgICAgICAgICAgICAgICB2YXIgbG9naW5VcmwgPSB0aGlzLmdldENsb3VkUHJvdmlkZXJVcmwoKSArICcvYXV0aC8nK3RoaXMuZ2V0UHJvdmlkZXIoKSsiP2NhbGxiYWNrPSIrJChsb2NhdGlvbikuYXR0cignaHJlZicpOwogICAgICAgICAgICAgICAgJC5nZXRKU09OKGxvZ2luVXJsLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgJChsb2NhdGlvbikuYXR0cignaHJlZicsZGF0YS51cmwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBMb2dvdXQgZnJvbSBjbG91ZCBwcm92aWRlci4KICAgICAgICAgKi8KICAgICAgICBsb2dvdXRDbG91ZDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgY2xlYXJDbG91ZExvZ2luKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUG9zdCBhIHJlY29yZHxlZGl0b3Igb24gdGhlIGNsb3VkCiAgICAgICAgICogQHBhcmFtIHJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5IFtyZWNvcmRzfGVkaXRvcnNdCiAgICAgICAgICogQHBhcmFtIGl0ZW0sIGNvdWxkIGJlIGVpdGhlciBlZGl0b3Igb3IgcmVjb3JkCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGZldGNoaW5nIHRoZSBpdGVtcwogICAgICAgICAqLwogICAgICAgIHNhdmVJdGVtOiBmdW5jdGlvbih1c2VySWQsIHJlbW90ZURpciwgaXRlbSwgY2FsbGJhY2spewoKICAgICAgICAgICAgdmFyIHVybCwgZGF0YTsKICAgICAgICAgICAgaWYocmVtb3RlRGlyID09PSAicmVjb3JkcyIpewogICAgICAgICAgICAgICAgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGl0ZW0sIHVuZGVmaW5lZCwgMik7CiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCh1c2VySWQsIHJlbW90ZURpciwgaXRlbS5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmKHJlbW90ZURpciA9PT0gImVkaXRvcnMiKXsKICAgICAgICAgICAgICAgIGRhdGEgPSBpdGVtLmVkaXRvci5qb2luKCIiKTsKICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKHVzZXJJZCwgcmVtb3RlRGlyLCBpdGVtLm5hbWUrIi5lZHRyIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIlBvc3QgaXRlbSB0byAiK3JlbW90ZURpcisiIHdpdGggIiArIHVybCk7CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIlBPU1QiLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzLmVycm9yID09PSAwKXsKICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIHJlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKHJlcy5tc2cpOwogICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oanFYSFIsIHN0YXR1cywgZXJyb3IpewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlByb2JsZW0gd2l0aCAiICsgdXJsICsgIiA6IHN0YXR1cz0iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyArICIgOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU3RvcmUgY2xvdWQgdXNlciBpZCBpbiBsb2NhbCBzdG9yYWdlLgogICAgICAgICAqLwogICAgICAgIHNldENsb3VkTG9naW46IGZ1bmN0aW9uKHVzZXJJZCwgY3Vyc29yKXsKICAgICAgICAgICAgdGhpcy51c2VyID0gewogICAgICAgICAgICAgICAgJ2lkJzogdXNlcklkLAogICAgICAgICAgICAgICAgJ2N1cnNvcic6IGN1cnNvcgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2Nsb3VkLXVzZXInLCBKU09OLnN0cmluZ2lmeSh0aGlzLnVzZXIpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTZXQgdGhlIGNsb3VkIHByb3ZpZGVyIFVSTC4KICAgICAgICAgKiBAcGFyYW0gcm9vdCBUaGUgU2VydmVyIFVSTCByb290LgogICAgICAgICAqLwogICAgICAgIHNldENsb3VkUHJvdmlkZXJVcmw6IGZ1bmN0aW9uKHVybCl7CiAgICAgICAgICAgIHRoaXMuY2xvdWRQcm92aWRlclVybCA9IHVybCArICIvIiArIHRoaXMudmVyc2lvbiArICIvcGNhcGkiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciBzZXR0aW5nIHRoZSBwcm92aWRlciBvZiBQQ0FQSSBpbiB0aGUgbG9jYWxTdG9yYWdlCiAgICAgICAgICogQHBhcmFtIHByb3ZpZGVyCiAgICAgICAgICovCiAgICAgICAgc2V0UHJvdmlkZXI6IGZ1bmN0aW9uKHByb3ZpZGVyKXsKICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2Nsb3VkLXByb3ZpZGVyJywgcHJvdmlkZXIpOwogICAgICAgICAgICAvL3RoaXMucHJvdmlkZXIgPSBwcm92aWRlcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiBmb3Igc2V0dGluZyB1cCB0aGUgdXNlcklkIHdoaWNoIGNvbWVzIGZyb20gUENBUEkKICAgICAgICAgKiBAcGFyYW0gdXNlcklkCiAgICAgICAgICovCiAgICAgICAgc2V0VXNlcklkOiBmdW5jdGlvbih1c2VySWQpewogICAgICAgICAgICB0aGlzLnVzZXJJZCA9IHVzZXJJZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBVcGRhdGUgYSByZWNvcmR8ZWRpdG9yIG9uIHRoZSBjbG91ZAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnJlbW90ZURpciByZW1vdGUgZGlyZWN0b3J5IFtyZWNvcmRzfGVkaXRvcnNdCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuaXRlbSwgY291bGQgYmUgZWl0aGVyIGVkaXRvciBvciByZWNvcmQKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5maWxlIGZvciByZWNvcmRzIHdlIG5lZWQgdG8ga25vdyB3aGljaCBzcGVjaWZpYyBmaWxlIHRvIHVwZGF0ZQogICAgICAgICAqIEBwYXJhbSBjYWxsYmFjayBmdW5jdGlvbiBhZnRlciBmZXRjaGluZyB0aGUgaXRlbXMKICAgICAgICAgKi8KICAgICAgICB1cGRhdGVJdGVtOiBmdW5jdGlvbihvcHRpb25zLCBjYWxsYmFjayl7CgogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVybChvcHRpb25zLnJlbW90ZURpciwgIiIpOwoKICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygiUFVUIGl0ZW0gdG8gIitvcHRpb25zLnJlbW90ZURpcisiIHdpdGggIiArIHVybCk7CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZihvcHRpb25zLnJlbW90ZURpciA9PT0gInJlY29yZHMiKXsKICAgICAgICAgICAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLml0ZW0sIHVuZGVmaW5lZCwgMik7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwgKyBvcHRpb25zLml0ZW0ubmFtZSsiLyIgKyBvcHRpb25zLmZpbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZihvcHRpb25zLnJlbW90ZURpciA9PT0gImVkaXRvcnMiKXsKICAgICAgICAgICAgICAgIGRhdGEgPSBvcHRpb25zLml0ZW0uZWRpdG9yLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgdXJsID0gdXJsICsgb3B0aW9ucy5pdGVtLm5hbWUrIi5lZHRyIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJQVVQiLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5lcnJvciA9PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCBzdGF0dXMsIGVycm9yKXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQcm9ibGVtIHdpdGggIiArIHVybCArICIgOiBzdGF0dXM9IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgKyAiIDogIiArIGVycm9yKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIGZvciB1cGxvYWRpbmcgYSBmaWxlCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMucmVtb3RlRGlyCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuZmlsZW5hbWUKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5maWxlCiAgICAgICAgICovCiAgICAgICAgdXBsb2FkRmlsZTogZnVuY3Rpb24ob3B0aW9ucywgY2FsbGJhY2spewoKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRGU1VybChvcHRpb25zLnJlbW90ZURpciwgb3B0aW9ucy5maWxlbmFtZSk7CgogICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJVcGxvYWQgaXRlbSAiK29wdGlvbnMuZmlsZS5uYW1lKyIgdG8gIitvcHRpb25zLnJlbW90ZURpcisiIHdpdGggIiArIHVybCk7CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIlBPU1QiLAogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZnVuY3Rpb24ocmVxdWVzdCkgewogICAgICAgICAgICAgICAgICAgIHJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgb3B0aW9ucy5maWxlLnR5cGUpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgZGF0YTogb3B0aW9ucy5maWxlLAogICAgICAgICAgICAgICAgcHJvY2Vzc0RhdGE6IGZhbHNlLAogICAgICAgICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIGRhdGEpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IGpRdWVyeS5wYXJzZUpTT04oZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UsIG9iai5lcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIF90aGlzOwp9KSgpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:44:24 GMT",
                    "Content-Length": "27728",
                    "Date": "Fri, 07 Nov 2014 21:44:24 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}