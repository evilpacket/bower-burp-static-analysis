{
    "url": "http://localhost:9999/yui/yui3/src/history/js/history-hash.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var location = Y.getLocation(),             base     = location.href.replace(/#.*$/, '');</li><li>location.replace(base + '#' + (HistoryHash.hashPrefix || '') + hash);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/yui/yui3/src/history/js/history-hash.js",
                "path": "/yui/yui3/src/history/js/history-hash.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC95dWkveXVpMy9zcmMvaGlzdG9yeS9qcy9oaXN0b3J5LWhhc2guanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQ1MTENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDQ6MDc6MjUgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDA0OjA3OjE0IEdNVA0KDQovKioKICogUHJvdmlkZXMgYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQgYmFja2VkIGJ5CiAqIDxjb2RlPndpbmRvdy5sb2NhdGlvbi5oYXNoPC9jb2RlPiwgYXMgd2VsbCBhcyBjb252ZW5pZW5jZSBtZXRob2RzIGZvciB3b3JraW5nCiAqIHdpdGggdGhlIGxvY2F0aW9uIGhhc2ggYW5kIGEgc3ludGhldGljIDxjb2RlPmhhc2hjaGFuZ2U8L2NvZGU+IGV2ZW50IHRoYXQKICogbm9ybWFsaXplcyBkaWZmZXJlbmNlcyBhY3Jvc3MgYnJvd3NlcnMuCiAqCiAqIEBtb2R1bGUgaGlzdG9yeQogKiBAc3VibW9kdWxlIGhpc3RvcnktaGFzaAogKiBAc2luY2UgMy4yLjAKICogQGNsYXNzIEhpc3RvcnlIYXNoCiAqIEBleHRlbmRzIEhpc3RvcnlCYXNlCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIChvcHRpb25hbCkgQ29uZmlndXJhdGlvbiBvYmplY3QuIFNlZSB0aGUgSGlzdG9yeUJhc2UKICogICBkb2N1bWVudGF0aW9uIGZvciBkZXRhaWxzLgogKi8KCnZhciBIaXN0b3J5QmFzZSA9IFkuSGlzdG9yeUJhc2UsCiAgICBMYW5nICAgICAgICA9IFkuTGFuZywKICAgIFlBcnJheSAgICAgID0gWS5BcnJheSwKICAgIFlPYmplY3QgICAgID0gWS5PYmplY3QsCiAgICBHbG9iYWxFbnYgICA9IFlVSS5uYW1lc3BhY2UoJ0Vudi5IaXN0b3J5SGFzaCcpLAoKICAgIFNSQ19IQVNIICAgID0gJ2hhc2gnLAoKICAgIGhhc2hOb3RpZmllcnMsCiAgICBvbGRIYXNoLAogICAgb2xkVXJsLAogICAgd2luICAgICAgICAgICAgID0gWS5jb25maWcud2luLAogICAgdXNlSGlzdG9yeUhUTUw1ID0gWS5jb25maWcudXNlSGlzdG9yeUhUTUw1OwoKZnVuY3Rpb24gSGlzdG9yeUhhc2goKSB7CiAgICBIaXN0b3J5SGFzaC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KClkuZXh0ZW5kKEhpc3RvcnlIYXNoLCBIaXN0b3J5QmFzZSwgewogICAgLy8gLS0gSW5pdGlhbGl6YXRpb24gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgX2luaXQ6IGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICB2YXIgYm9va21hcmtlZFN0YXRlID0gSGlzdG9yeUhhc2gucGFyc2VIYXNoKCk7CgogICAgICAgIC8vIElmIGFuIGluaXRpYWxTdGF0ZSB3YXMgcHJvdmlkZWQsIG1lcmdlIHRoZSBib29rbWFya2VkIHN0YXRlIGludG8gaXQKICAgICAgICAvLyAodGhlIGJvb2ttYXJrZWQgc3RhdGUgd2lucykuCiAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwoKICAgICAgICB0aGlzLl9pbml0aWFsU3RhdGUgPSBjb25maWcuaW5pdGlhbFN0YXRlID8KICAgICAgICAgICAgICAgIFkubWVyZ2UoY29uZmlnLmluaXRpYWxTdGF0ZSwgYm9va21hcmtlZFN0YXRlKSA6IGJvb2ttYXJrZWRTdGF0ZTsKCiAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSBzeW50aGV0aWMgaGFzaGNoYW5nZSBldmVudCAoZGVmaW5lZCBiZWxvdykgdG8gaGFuZGxlCiAgICAgICAgLy8gY2hhbmdlcy4KICAgICAgICBZLmFmdGVyKCdoYXNoY2hhbmdlJywgWS5iaW5kKHRoaXMuX2FmdGVySGFzaENoYW5nZSwgdGhpcyksIHdpbik7CgogICAgICAgIEhpc3RvcnlIYXNoLnN1cGVyY2xhc3MuX2luaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gLS0gUHJvdGVjdGVkIE1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgX2NoYW5nZTogZnVuY3Rpb24gKHNyYywgc3RhdGUsIG9wdGlvbnMpIHsKICAgICAgICAvLyBTdHJpbmdpZnkgYWxsIHZhbHVlcyB0byBlbnN1cmUgdGhhdCBjb21wYXJpc29ucyBkb24ndCBmYWlsIGFmdGVyCiAgICAgICAgLy8gdGhleSdyZSBjb2VyY2VkIHRvIHN0cmluZ3MgaW4gdGhlIGxvY2F0aW9uIGhhc2guCiAgICAgICAgWU9iamVjdC5lYWNoKHN0YXRlLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBpZiAoTGFuZy5pc1ZhbHVlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgc3RhdGVba2V5XSA9IHZhbHVlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIEhpc3RvcnlIYXNoLnN1cGVyY2xhc3MuX2NoYW5nZS5jYWxsKHRoaXMsIHNyYywgc3RhdGUsIG9wdGlvbnMpOwogICAgfSwKCiAgICBfc3RvcmVTdGF0ZTogZnVuY3Rpb24gKHNyYywgbmV3U3RhdGUpIHsKICAgICAgICB2YXIgZGVjb2RlICA9IEhpc3RvcnlIYXNoLmRlY29kZSwKICAgICAgICAgICAgbmV3SGFzaCA9IEhpc3RvcnlIYXNoLmNyZWF0ZUhhc2gobmV3U3RhdGUpOwoKICAgICAgICBIaXN0b3J5SGFzaC5zdXBlcmNsYXNzLl9zdG9yZVN0YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgbG9jYXRpb24gaGFzaCB3aXRoIHRoZSBjaGFuZ2VzLCBidXQgb25seSBpZiB0aGUgbmV3IGhhc2gKICAgICAgICAvLyBhY3R1YWxseSBkaWZmZXJzIGZyb20gdGhlIGN1cnJlbnQgaGFzaCAodGhpcyBhdm9pZHMgY3JlYXRpbmcgbXVsdGlwbGUKICAgICAgICAvLyBoaXN0b3J5IGVudHJpZXMgZm9yIGEgc2luZ2xlIHN0YXRlKS4KICAgICAgICAvLwogICAgICAgIC8vIFdlIGFsd2F5cyBjb21wYXJlIGRlY29kZWQgaGFzaGVzLCBzaW5jZSBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIGhhc2gKICAgICAgICAvLyBjb3VsZCBiZSBzZXQgaW5jb3JyZWN0bHkgdG8gYSBub24tZW5jb2RlZCB2YWx1ZSBvdXRzaWRlIG9mCiAgICAgICAgLy8gSGlzdG9yeUhhc2guCiAgICAgICAgaWYgKHNyYyAhPT0gU1JDX0hBU0ggJiYgZGVjb2RlKEhpc3RvcnlIYXNoLmdldEhhc2goKSkgIT09IGRlY29kZShuZXdIYXNoKSkgewogICAgICAgICAgICBIaXN0b3J5SGFzaFtzcmMgPT09IEhpc3RvcnlCYXNlLlNSQ19SRVBMQUNFID8gJ3JlcGxhY2VIYXNoJyA6ICdzZXRIYXNoJ10obmV3SGFzaCk7CiAgICAgICAgfQogICAgfSwKCiAgICAvLyAtLSBQcm90ZWN0ZWQgRXZlbnQgSGFuZGxlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICAgKiBIYW5kbGVyIGZvciBoYXNoY2hhbmdlIGV2ZW50cy4KICAgICAqCiAgICAgKiBAbWV0aG9kIF9hZnRlckhhc2hDaGFuZ2UKICAgICAqIEBwYXJhbSB7RXZlbnR9IGUKICAgICAqIEBwcm90ZWN0ZWQKICAgICAqLwogICAgX2FmdGVySGFzaENoYW5nZTogZnVuY3Rpb24gKGUpIHsKICAgICAgICB0aGlzLl9yZXNvbHZlQ2hhbmdlcyhTUkNfSEFTSCwgSGlzdG9yeUhhc2gucGFyc2VIYXNoKGUubmV3SGFzaCksIHt9KTsKICAgIH0KfSwgewogICAgLy8gLS0gUHVibGljIFN0YXRpYyBQcm9wZXJ0aWVzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgTkFNRTogJ2hpc3RvcnlIYXNoJywKCiAgICAvKioKICAgICAqIENvbnN0YW50IHVzZWQgdG8gaWRlbnRpZnkgc3RhdGUgY2hhbmdlcyBvcmlnaW5hdGluZyBmcm9tCiAgICAgKiA8Y29kZT5oYXNoY2hhbmdlPC9jb2RlPiBldmVudHMuCiAgICAgKgogICAgICogQHByb3BlcnR5IFNSQ19IQVNICiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqIEBzdGF0aWMKICAgICAqIEBmaW5hbAogICAgICovCiAgICBTUkNfSEFTSDogU1JDX0hBU0gsCgogICAgLyoqCiAgICAgKiA8cD4KICAgICAqIFByZWZpeCB0byBwcmVwZW5kIHdoZW4gc2V0dGluZyB0aGUgaGFzaCBmcmFnbWVudC4gRm9yIGV4YW1wbGUsIGlmIHRoZQogICAgICogcHJlZml4IGlzIDxjb2RlPiE8L2NvZGU+IGFuZCB0aGUgaGFzaCBmcmFnbWVudCBpcyBzZXQgdG8KICAgICAqIDxjb2RlPiNmb289YmFyJmJhej1xdXV4PC9jb2RlPiwgdGhlIGZpbmFsIGhhc2ggZnJhZ21lbnQgaW4gdGhlIFVSTCB3aWxsCiAgICAgKiBiZWNvbWUgPGNvZGU+IyFmb289YmFyJmJhej1xdXV4PC9jb2RlPi4gVGhpcyBjYW4gYmUgdXNlZCB0byBoZWxwIG1ha2UgYW4KICAgICAqIEFqYXggYXBwbGljYXRpb24gY3Jhd2xhYmxlIGluIGFjY29yZGFuY2Ugd2l0aCBHb29nbGUncyBndWlkZWxpbmVzIGF0CiAgICAgKiA8YSBocmVmPSJodHRwOi8vY29kZS5nb29nbGUuY29tL3dlYi9hamF4Y3Jhd2xpbmcvIj5odHRwOi8vY29kZS5nb29nbGUuY29tL3dlYi9hamF4Y3Jhd2xpbmcvPC9hPi4KICAgICAqIDwvcD4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIE5vdGUgdGhhdCB0aGlzIHByZWZpeCBhcHBsaWVzIHRvIGFsbCBIaXN0b3J5SGFzaCBpbnN0YW5jZXMuIEl0J3Mgbm90CiAgICAgKiBwb3NzaWJsZSBmb3IgaW5kaXZpZHVhbCBpbnN0YW5jZXMgdG8gdXNlIHRoZWlyIG93biBwcmVmaXhlcyBzaW5jZSB0aGV5CiAgICAgKiBhbGwgb3BlcmF0ZSBvbiB0aGUgc2FtZSBVUkwuCiAgICAgKiA8L3A+CiAgICAgKgogICAgICogQHByb3BlcnR5IGhhc2hQcmVmaXgKICAgICAqIEB0eXBlIFN0cmluZwogICAgICogQGRlZmF1bHQgJycKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgaGFzaFByZWZpeDogJycsCgogICAgLy8gLS0gUHJvdGVjdGVkIFN0YXRpYyBQcm9wZXJ0aWVzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gcGFyc2UgbG9jYXRpb24gaGFzaC9xdWVyeSBzdHJpbmdzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBfUkVHRVhfSEFTSAogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKiBAc3RhdGljCiAgICAgKiBAZmluYWwKICAgICAqLwogICAgX1JFR0VYX0hBU0g6IC8oW15cPyMmPV0rKT0/KFteJj1dKikvZywKCiAgICAvLyAtLSBQdWJsaWMgU3RhdGljIE1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbG9jYXRpb24gaGFzaCBzdHJpbmcgZnJvbSB0aGUgc3BlY2lmaWVkIG9iamVjdCBvZiBrZXkvdmFsdWUKICAgICAqIHBhaXJzLgogICAgICoKICAgICAqIEBtZXRob2QgY3JlYXRlSGFzaAogICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhcmFtZXRlciBwYWlycwogICAgICogQHJldHVybiB7U3RyaW5nfSBsb2NhdGlvbiBoYXNoIHN0cmluZwogICAgICogQHN0YXRpYwogICAgICovCiAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgICAgdmFyIGVuY29kZSA9IEhpc3RvcnlIYXNoLmVuY29kZSwKICAgICAgICAgICAgaGFzaCAgID0gW107CgogICAgICAgIFlPYmplY3QuZWFjaChwYXJhbXMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmIChMYW5nLmlzVmFsdWUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBoYXNoLnB1c2goZW5jb2RlKGtleSkgKyAnPScgKyBlbmNvZGUodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gaGFzaC5qb2luKCcmJyk7CiAgICB9LAoKICAgIC8qKgogICAgICogV3JhcHBlciBhcm91bmQgPGNvZGU+ZGVjb2RlVVJJQ29tcG9uZW50KCk8L2NvZGU+IHRoYXQgYWxzbyBjb252ZXJ0cyArCiAgICAgKiBjaGFycyBpbnRvIHNwYWNlcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIGRlY29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBzdHJpbmcgdG8gZGVjb2RlCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IGRlY29kZWQgc3RyaW5nCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGRlY29kZTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyaW5nLnJlcGxhY2UoL1wrL2csICcgJykpOwogICAgfSwKCiAgICAvKioKICAgICAqIFdyYXBwZXIgYXJvdW5kIDxjb2RlPmVuY29kZVVSSUNvbXBvbmVudCgpPC9jb2RlPiB0aGF0IGNvbnZlcnRzIHNwYWNlcyB0bwogICAgICogKyBjaGFycy4KICAgICAqCiAgICAgKiBAbWV0aG9kIGVuY29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBzdHJpbmcgdG8gZW5jb2RlCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IGVuY29kZWQgc3RyaW5nCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGVuY29kZTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKS5yZXBsYWNlKC8lMjAvZywgJysnKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSByYXcgKG5vdCBkZWNvZGVkKSBjdXJyZW50IGxvY2F0aW9uIGhhc2gsIG1pbnVzIHRoZSBwcmVjZWRpbmcgJyMnCiAgICAgKiBjaGFyYWN0ZXIgYW5kIHRoZSBoYXNoUHJlZml4IChpZiBvbmUgaXMgc2V0KS4KICAgICAqCiAgICAgKiBAbWV0aG9kIGdldEhhc2gKICAgICAqIEByZXR1cm4ge1N0cmluZ30gY3VycmVudCBsb2NhdGlvbiBoYXNoCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGdldEhhc2g6IChZLlVBLmdlY2tvID8gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEdlY2tvJ3Mgd2luZG93LmxvY2F0aW9uLmhhc2ggcmV0dXJucyBhIGRlY29kZWQgc3RyaW5nIGFuZCB3ZSB3YW50IGFsbAogICAgICAgIC8vIGVuY29kaW5nIHVudG91Y2hlZCwgc28gd2UgbmVlZCB0byBnZXQgdGhlIGhhc2ggdmFsdWUgZnJvbQogICAgICAgIC8vIHdpbmRvdy5sb2NhdGlvbi5ocmVmIGluc3RlYWQuIFdlIGhhdmUgdG8gdXNlIFVBIHNuaWZmaW5nIHJhdGhlciB0aGFuCiAgICAgICAgLy8gZmVhdHVyZSBkZXRlY3Rpb24sIHNpbmNlIHRoZSBvbmx5IHdheSB0byBkZXRlY3QgdGhpcyB3b3VsZCBiZSB0bwogICAgICAgIC8vIGFjdHVhbGx5IGNoYW5nZSB0aGUgaGFzaC4KICAgICAgICB2YXIgbG9jYXRpb24gPSBZLmdldExvY2F0aW9uKCksCiAgICAgICAgICAgIG1hdGNoZXMgID0gLyMoLiopJC8uZXhlYyhsb2NhdGlvbi5ocmVmKSwKICAgICAgICAgICAgaGFzaCAgICAgPSBtYXRjaGVzICYmIG1hdGNoZXNbMV0gfHwgJycsCiAgICAgICAgICAgIHByZWZpeCAgID0gSGlzdG9yeUhhc2guaGFzaFByZWZpeDsKCiAgICAgICAgcmV0dXJuIHByZWZpeCAmJiBoYXNoLmluZGV4T2YocHJlZml4KSA9PT0gMCA/CiAgICAgICAgICAgICAgICAgICAgaGFzaC5yZXBsYWNlKHByZWZpeCwgJycpIDogaGFzaDsKICAgIH0gOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gWS5nZXRMb2NhdGlvbigpLAogICAgICAgICAgICBoYXNoICAgICA9IGxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpLAogICAgICAgICAgICBwcmVmaXggICA9IEhpc3RvcnlIYXNoLmhhc2hQcmVmaXg7CgogICAgICAgIC8vIFNsaWdodCBjb2RlIGR1cGxpY2F0aW9uIGhlcmUsIGJ1dCBleGVjdXRpb24gc3BlZWQgaXMgb2YgdGhlIGVzc2VuY2UKICAgICAgICAvLyBzaW5jZSBnZXRIYXNoKCkgaXMgY2FsbGVkIGV2ZXJ5IDUwbXMgdG8gcG9sbCBmb3IgY2hhbmdlcyBpbiBicm93c2VycwogICAgICAgIC8vIHRoYXQgZG9uJ3Qgc3VwcG9ydCBuYXRpdmUgb25oYXNoY2hhbmdlLiBBbiBhZGRpdGlvbmFsIGZ1bmN0aW9uIGNhbGwKICAgICAgICAvLyB3b3VsZCBhZGQgdW5uZWNlc3Nhcnkgb3ZlcmhlYWQuCiAgICAgICAgcmV0dXJuIHByZWZpeCAmJiBoYXNoLmluZGV4T2YocHJlZml4KSA9PT0gMCA/CiAgICAgICAgICAgICAgICAgICAgaGFzaC5yZXBsYWNlKHByZWZpeCwgJycpIDogaGFzaDsKICAgIH0pLAoKICAgIC8qKgogICAgICogR2V0cyB0aGUgY3VycmVudCBib29rbWFya2FibGUgVVJMLgogICAgICoKICAgICAqIEBtZXRob2QgZ2V0VXJsCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IGN1cnJlbnQgYm9va21hcmthYmxlIFVSTAogICAgICogQHN0YXRpYwogICAgICovCiAgICBnZXRVcmw6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbG9jYXRpb24uaHJlZjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBQYXJzZXMgYSBsb2NhdGlvbiBoYXNoIHN0cmluZyBpbnRvIGFuIG9iamVjdCBvZiBrZXkvdmFsdWUgcGFyYW1ldGVyCiAgICAgKiBwYWlycy4gSWYgPGk+aGFzaDwvaT4gaXMgbm90IHNwZWNpZmllZCwgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaCB3aWxsCiAgICAgKiBiZSB1c2VkLgogICAgICoKICAgICAqIEBtZXRob2QgcGFyc2VIYXNoCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaGFzaCAob3B0aW9uYWwpIGxvY2F0aW9uIGhhc2ggc3RyaW5nCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IG9iamVjdCBvZiBwYXJzZWQga2V5L3ZhbHVlIHBhcmFtZXRlciBwYWlycwogICAgICogQHN0YXRpYwogICAgICovCiAgICBwYXJzZUhhc2g6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgdmFyIGRlY29kZSA9IEhpc3RvcnlIYXNoLmRlY29kZSwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgbGVuLAogICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgbWF0Y2hlcywKICAgICAgICAgICAgcGFyYW0sCiAgICAgICAgICAgIHBhcmFtcyA9IHt9LAogICAgICAgICAgICBwcmVmaXggPSBIaXN0b3J5SGFzaC5oYXNoUHJlZml4LAogICAgICAgICAgICBwcmVmaXhJbmRleDsKCiAgICAgICAgaGFzaCA9IExhbmcuaXNWYWx1ZShoYXNoKSA/IGhhc2ggOiBIaXN0b3J5SGFzaC5nZXRIYXNoKCk7CgogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4SW5kZXggPSBoYXNoLmluZGV4T2YocHJlZml4KTsKCiAgICAgICAgICAgIGlmIChwcmVmaXhJbmRleCA9PT0gMCB8fCAocHJlZml4SW5kZXggPT09IDEgJiYgaGFzaC5jaGFyQXQoMCkgPT09ICcjJykpIHsKICAgICAgICAgICAgICAgIGhhc2ggPSBoYXNoLnJlcGxhY2UocHJlZml4LCAnJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1hdGNoZXMgPSBoYXNoLm1hdGNoKEhpc3RvcnlIYXNoLl9SRUdFWF9IQVNIKSB8fCBbXTsKCiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gbWF0Y2hlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgICBtYXRjaCA9IG1hdGNoZXNbaV07CgogICAgICAgICAgICBwYXJhbSA9IG1hdGNoLnNwbGl0KCc9Jyk7CgogICAgICAgICAgICBpZiAocGFyYW0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgcGFyYW1zW2RlY29kZShwYXJhbVswXSldID0gZGVjb2RlKHBhcmFtWzFdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcmFtc1tkZWNvZGUobWF0Y2gpXSA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvKioKICAgICAqIFJlcGxhY2VzIHRoZSBicm93c2VyJ3MgY3VycmVudCBsb2NhdGlvbiBoYXNoIHdpdGggdGhlIHNwZWNpZmllZCBoYXNoCiAgICAgKiBhbmQgcmVtb3ZlcyBhbGwgZm9yd2FyZCBuYXZpZ2F0aW9uIHN0YXRlcywgd2l0aG91dCBjcmVhdGluZyBhIG5ldyBicm93c2VyCiAgICAgKiBoaXN0b3J5IGVudHJ5LiBBdXRvbWF0aWNhbGx5IHByZXBlbmRzIHRoZSA8Y29kZT5oYXNoUHJlZml4PC9jb2RlPiBpZiBvbmUKICAgICAqIGlzIHNldC4KICAgICAqCiAgICAgKiBAbWV0aG9kIHJlcGxhY2VIYXNoCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaGFzaCBuZXcgbG9jYXRpb24gaGFzaAogICAgICogQHN0YXRpYwogICAgICovCiAgICByZXBsYWNlSGFzaDogZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICB2YXIgbG9jYXRpb24gPSBZLmdldExvY2F0aW9uKCksCiAgICAgICAgICAgIGJhc2UgICAgID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8jLiokLywgJycpOwoKICAgICAgICBpZiAoaGFzaC5jaGFyQXQoMCkgPT09ICcjJykgewogICAgICAgICAgICBoYXNoID0gaGFzaC5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQoKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGJhc2UgKyAnIycgKyAoSGlzdG9yeUhhc2guaGFzaFByZWZpeCB8fCAnJykgKyBoYXNoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBicm93c2VyJ3MgbG9jYXRpb24gaGFzaCB0byB0aGUgc3BlY2lmaWVkIHN0cmluZy4gQXV0b21hdGljYWxseQogICAgICogcHJlcGVuZHMgdGhlIDxjb2RlPmhhc2hQcmVmaXg8L2NvZGU+IGlmIG9uZSBpcyBzZXQuCiAgICAgKgogICAgICogQG1ldGhvZCBzZXRIYXNoCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaGFzaCBuZXcgbG9jYXRpb24gaGFzaAogICAgICogQHN0YXRpYwogICAgICovCiAgICBzZXRIYXNoOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgIHZhciBsb2NhdGlvbiA9IFkuZ2V0TG9jYXRpb24oKTsKCiAgICAgICAgaWYgKGhhc2guY2hhckF0KDApID09PSAnIycpIHsKICAgICAgICAgICAgaGFzaCA9IGhhc2guc3Vic3RyaW5nKDEpOwogICAgICAgIH0KCiAgICAgICAgbG9jYXRpb24uaGFzaCA9IChIaXN0b3J5SGFzaC5oYXNoUHJlZml4IHx8ICcnKSArIGhhc2g7CiAgICB9Cn0pOwoKLy8gLS0gU3ludGhldGljIGhhc2hjaGFuZ2UgRXZlbnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIFRPRE86IFlVSURvYyBjdXJyZW50bHkgZG9lc24ndCBwcm92aWRlIGEgZ29vZCB3YXkgdG8gZG9jdW1lbnQgc3ludGhldGljIERPTQovLyBldmVudHMuIEZvciBub3csIHdlJ3JlIGp1c3QgZG9jdW1lbnRpbmcgdGhlIGhhc2hjaGFuZ2UgZXZlbnQgb24gdGhlIFlVSQovLyBvYmplY3QsIHdoaWNoIGlzIGFib3V0IHRoZSBiZXN0IHdlIGNhbiBkbyB1bnRpbCBlbmhhbmNlbWVudHMgYXJlIG1hZGUgdG8KLy8gWVVJRG9jLgoKLyoqClN5bnRoZXRpYyA8Y29kZT53aW5kb3cub25oYXNoY2hhbmdlPC9jb2RlPiBldmVudCB0aGF0IG5vcm1hbGl6ZXMgZGlmZmVyZW5jZXMKYWNyb3NzIGJyb3dzZXJzIGFuZCBwcm92aWRlcyBzdXBwb3J0IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQKPGNvZGU+b25oYXNoY2hhbmdlPC9jb2RlPi4KClRoaXMgZXZlbnQgaXMgcHJvdmlkZWQgYnkgdGhlIDxjb2RlPmhpc3RvcnktaGFzaDwvY29kZT4gbW9kdWxlLgoKQGV4YW1wbGUKCiAgICBZVUkoKS51c2UoJ2hpc3RvcnktaGFzaCcsIGZ1bmN0aW9uIChZKSB7CiAgICAgIFkub24oJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbiAoZSkgewogICAgICAgIC8vIEhhbmRsZSBoYXNoY2hhbmdlIGV2ZW50cyBvbiB0aGUgY3VycmVudCB3aW5kb3cuCiAgICAgIH0sIFkuY29uZmlnLndpbik7CiAgICB9KTsKCkBldmVudCBoYXNoY2hhbmdlCkBwYXJhbSB7RXZlbnRGYWNhZGV9IGUgRXZlbnQgZmFjYWRlIHdpdGggdGhlIGZvbGxvd2luZyBhZGRpdGlvbmFsCiAgcHJvcGVydGllczoKCjxkbD4KICA8ZHQ+b2xkSGFzaDwvZHQ+CiAgPGRkPgogICAgUHJldmlvdXMgaGFzaCBmcmFnbWVudCB2YWx1ZSBiZWZvcmUgdGhlIGNoYW5nZS4KICA8L2RkPgoKICA8ZHQ+b2xkVXJsPC9kdD4KICA8ZGQ+CiAgICBQcmV2aW91cyBVUkwgKGluY2x1ZGluZyB0aGUgaGFzaCBmcmFnbWVudCkgYmVmb3JlIHRoZSBjaGFuZ2UuCiAgPC9kZD4KCiAgPGR0Pm5ld0hhc2g8L2R0PgogIDxkZD4KICAgIE5ldyBoYXNoIGZyYWdtZW50IHZhbHVlIGFmdGVyIHRoZSBjaGFuZ2UuCiAgPC9kZD4KCiAgPGR0Pm5ld1VybDwvZHQ+CiAgPGRkPgogICAgTmV3IFVSTCAoaW5jbHVkaW5nIHRoZSBoYXNoIGZyYWdtZW50KSBhZnRlciB0aGUgY2hhbmdlLgogIDwvZGQ+CjwvZGw+CkBmb3IgWVVJCkBzaW5jZSAzLjIuMAoqKi8KCmhhc2hOb3RpZmllcnMgPSBHbG9iYWxFbnYuX25vdGlmaWVyczsKCmlmICghaGFzaE5vdGlmaWVycykgewogICAgaGFzaE5vdGlmaWVycyA9IEdsb2JhbEVudi5fbm90aWZpZXJzID0gW107Cn0KClkuRXZlbnQuZGVmaW5lKCdoYXNoY2hhbmdlJywgewogICAgb246IGZ1bmN0aW9uIChub2RlLCBzdWJzY3JpYmVyLCBub3RpZmllcikgewogICAgICAgIC8vIElnbm9yZSB0aGlzIHN1YnNjcmlwdGlvbiBpZiB0aGUgbm9kZSBpcyBhbnl0aGluZyBvdGhlciB0aGFuIHRoZQogICAgICAgIC8vIHdpbmRvdyBvciBkb2N1bWVudCBib2R5LCBzaW5jZSB0aG9zZSBhcmUgdGhlIG9ubHkgZWxlbWVudHMgdGhhdAogICAgICAgIC8vIHNob3VsZCBzdXBwb3J0IHRoZSBoYXNoY2hhbmdlIGV2ZW50LiBOb3RlIHRoYXQgdGhlIGJvZHkgY291bGQgYWxzbyBiZQogICAgICAgIC8vIGEgZnJhbWVzZXQsIGJ1dCB0aGF0J3Mgb2theSBzaW5jZSBmcmFtZXNldHMgc3VwcG9ydCBoYXNoY2hhbmdlIHRvby4KICAgICAgICBpZiAobm9kZS5jb21wYXJlVG8od2luKSB8fCBub2RlLmNvbXBhcmVUbyhZLmNvbmZpZy5kb2MuYm9keSkpIHsKICAgICAgICAgICAgaGFzaE5vdGlmaWVycy5wdXNoKG5vdGlmaWVyKTsKICAgICAgICB9CiAgICB9LAoKICAgIGRldGFjaDogZnVuY3Rpb24gKG5vZGUsIHN1YnNjcmliZXIsIG5vdGlmaWVyKSB7CiAgICAgICAgdmFyIGluZGV4ID0gWUFycmF5LmluZGV4T2YoaGFzaE5vdGlmaWVycywgbm90aWZpZXIpOwoKICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgIGhhc2hOb3RpZmllcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICB9Cn0pOwoKb2xkSGFzaCA9IEhpc3RvcnlIYXNoLmdldEhhc2goKTsKb2xkVXJsICA9IEhpc3RvcnlIYXNoLmdldFVybCgpOwoKaWYgKEhpc3RvcnlCYXNlLm5hdGl2ZUhhc2hDaGFuZ2UpIHsKICAgIC8vIFdyYXAgdGhlIGJyb3dzZXIncyBuYXRpdmUgaGFzaGNoYW5nZSBldmVudCBpZiB0aGVyZSdzIG5vdCBhbHJlYWR5IGEKICAgIC8vIGdsb2JhbCBsaXN0ZW5lci4KICAgIGlmICghR2xvYmFsRW52Ll9oYXNoSGFuZGxlKSB7CiAgICAgICAgR2xvYmFsRW52Ll9oYXNoSGFuZGxlID0gWS5FdmVudC5hdHRhY2goJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICB2YXIgbmV3SGFzaCA9IEhpc3RvcnlIYXNoLmdldEhhc2goKSwKICAgICAgICAgICAgICAgIG5ld1VybCAgPSBIaXN0b3J5SGFzaC5nZXRVcmwoKTsKCiAgICAgICAgICAgIC8vIEl0ZXJhdGUgb3ZlciBhIGNvcHkgb2YgdGhlIGhhc2hOb3RpZmllcnMgYXJyYXkgc2luY2UgYSBzdWJzY3JpYmVyCiAgICAgICAgICAgIC8vIGNvdWxkIGRldGFjaCBkdXJpbmcgaXRlcmF0aW9uIGFuZCBjYXVzZSB0aGUgYXJyYXkgdG8gYmUgcmUtaW5kZXhlZC4KICAgICAgICAgICAgWUFycmF5LmVhY2goaGFzaE5vdGlmaWVycy5jb25jYXQoKSwgZnVuY3Rpb24gKG5vdGlmaWVyKSB7CiAgICAgICAgICAgICAgICBub3RpZmllci5maXJlKHsKICAgICAgICAgICAgICAgICAgICBfZXZlbnQgOiBlLAogICAgICAgICAgICAgICAgICAgIG9sZEhhc2g6IG9sZEhhc2gsCiAgICAgICAgICAgICAgICAgICAgb2xkVXJsIDogb2xkVXJsLAogICAgICAgICAgICAgICAgICAgIG5ld0hhc2g6IG5ld0hhc2gsCiAgICAgICAgICAgICAgICAgICAgbmV3VXJsIDogbmV3VXJsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBvbGRIYXNoID0gbmV3SGFzaDsKICAgICAgICAgICAgb2xkVXJsICA9IG5ld1VybDsKICAgICAgICB9LCB3aW4pOwogICAgfQp9IGVsc2UgewogICAgLy8gQmVnaW4gcG9sbGluZyBmb3IgbG9jYXRpb24gaGFzaCBjaGFuZ2VzIGlmIHRoZXJlJ3Mgbm90IGFscmVhZHkgYSBnbG9iYWwKICAgIC8vIHBvbGwgcnVubmluZy4KICAgIGlmICghR2xvYmFsRW52Ll9oYXNoUG9sbCkgewogICAgICAgIEdsb2JhbEVudi5faGFzaFBvbGwgPSBZLmxhdGVyKDUwLCBudWxsLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBuZXdIYXNoID0gSGlzdG9yeUhhc2guZ2V0SGFzaCgpLAogICAgICAgICAgICAgICAgZmFjYWRlLCBuZXdVcmw7CgogICAgICAgICAgICBpZiAob2xkSGFzaCAhPT0gbmV3SGFzaCkgewogICAgICAgICAgICAgICAgbmV3VXJsID0gSGlzdG9yeUhhc2guZ2V0VXJsKCk7CgogICAgICAgICAgICAgICAgZmFjYWRlID0gewogICAgICAgICAgICAgICAgICAgIG9sZEhhc2g6IG9sZEhhc2gsCiAgICAgICAgICAgICAgICAgICAgb2xkVXJsIDogb2xkVXJsLAogICAgICAgICAgICAgICAgICAgIG5ld0hhc2g6IG5ld0hhc2gsCiAgICAgICAgICAgICAgICAgICAgbmV3VXJsIDogbmV3VXJsCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG9sZEhhc2ggPSBuZXdIYXNoOwogICAgICAgICAgICAgICAgb2xkVXJsICA9IG5ld1VybDsKCiAgICAgICAgICAgICAgICBZQXJyYXkuZWFjaChoYXNoTm90aWZpZXJzLmNvbmNhdCgpLCBmdW5jdGlvbiAobm90aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICBub3RpZmllci5maXJlKGZhY2FkZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sIG51bGwsIHRydWUpOwogICAgfQp9CgpZLkhpc3RvcnlIYXNoID0gSGlzdG9yeUhhc2g7CgovLyBIaXN0b3J5SGFzaCB3aWxsIG5ldmVyIHdpbiBvdmVyIEhpc3RvcnlIVE1MNSB1bmxlc3MgdXNlSGlzdG9yeUhUTUw1IGlzIGZhbHNlLgppZiAodXNlSGlzdG9yeUhUTUw1ID09PSBmYWxzZSB8fCAoIVkuSGlzdG9yeSAmJiB1c2VIaXN0b3J5SFRNTDUgIT09IHRydWUgJiYKICAgICAgICAoIUhpc3RvcnlCYXNlLmh0bWw1IHx8ICFZLkhpc3RvcnlIVE1MNSkpKSB7CiAgICBZLkhpc3RvcnkgPSBIaXN0b3J5SGFzaDsKfQo=",
                "body": "LyoqCiAqIFByb3ZpZGVzIGJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50IGJhY2tlZCBieQogKiA8Y29kZT53aW5kb3cubG9jYXRpb24uaGFzaDwvY29kZT4sIGFzIHdlbGwgYXMgY29udmVuaWVuY2UgbWV0aG9kcyBmb3Igd29ya2luZwogKiB3aXRoIHRoZSBsb2NhdGlvbiBoYXNoIGFuZCBhIHN5bnRoZXRpYyA8Y29kZT5oYXNoY2hhbmdlPC9jb2RlPiBldmVudCB0aGF0CiAqIG5vcm1hbGl6ZXMgZGlmZmVyZW5jZXMgYWNyb3NzIGJyb3dzZXJzLgogKgogKiBAbW9kdWxlIGhpc3RvcnkKICogQHN1Ym1vZHVsZSBoaXN0b3J5LWhhc2gKICogQHNpbmNlIDMuMi4wCiAqIEBjbGFzcyBIaXN0b3J5SGFzaAogKiBAZXh0ZW5kcyBIaXN0b3J5QmFzZQogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyAob3B0aW9uYWwpIENvbmZpZ3VyYXRpb24gb2JqZWN0LiBTZWUgdGhlIEhpc3RvcnlCYXNlCiAqICAgZG9jdW1lbnRhdGlvbiBmb3IgZGV0YWlscy4KICovCgp2YXIgSGlzdG9yeUJhc2UgPSBZLkhpc3RvcnlCYXNlLAogICAgTGFuZyAgICAgICAgPSBZLkxhbmcsCiAgICBZQXJyYXkgICAgICA9IFkuQXJyYXksCiAgICBZT2JqZWN0ICAgICA9IFkuT2JqZWN0LAogICAgR2xvYmFsRW52ICAgPSBZVUkubmFtZXNwYWNlKCdFbnYuSGlzdG9yeUhhc2gnKSwKCiAgICBTUkNfSEFTSCAgICA9ICdoYXNoJywKCiAgICBoYXNoTm90aWZpZXJzLAogICAgb2xkSGFzaCwKICAgIG9sZFVybCwKICAgIHdpbiAgICAgICAgICAgICA9IFkuY29uZmlnLndpbiwKICAgIHVzZUhpc3RvcnlIVE1MNSA9IFkuY29uZmlnLnVzZUhpc3RvcnlIVE1MNTsKCmZ1bmN0aW9uIEhpc3RvcnlIYXNoKCkgewogICAgSGlzdG9yeUhhc2guc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CgpZLmV4dGVuZChIaXN0b3J5SGFzaCwgSGlzdG9yeUJhc2UsIHsKICAgIC8vIC0tIEluaXRpYWxpemF0aW9uIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIF9pbml0OiBmdW5jdGlvbiAoY29uZmlnKSB7CiAgICAgICAgdmFyIGJvb2ttYXJrZWRTdGF0ZSA9IEhpc3RvcnlIYXNoLnBhcnNlSGFzaCgpOwoKICAgICAgICAvLyBJZiBhbiBpbml0aWFsU3RhdGUgd2FzIHByb3ZpZGVkLCBtZXJnZSB0aGUgYm9va21hcmtlZCBzdGF0ZSBpbnRvIGl0CiAgICAgICAgLy8gKHRoZSBib29rbWFya2VkIHN0YXRlIHdpbnMpLgogICAgICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTsKCiAgICAgICAgdGhpcy5faW5pdGlhbFN0YXRlID0gY29uZmlnLmluaXRpYWxTdGF0ZSA/CiAgICAgICAgICAgICAgICBZLm1lcmdlKGNvbmZpZy5pbml0aWFsU3RhdGUsIGJvb2ttYXJrZWRTdGF0ZSkgOiBib29rbWFya2VkU3RhdGU7CgogICAgICAgIC8vIFN1YnNjcmliZSB0byB0aGUgc3ludGhldGljIGhhc2hjaGFuZ2UgZXZlbnQgKGRlZmluZWQgYmVsb3cpIHRvIGhhbmRsZQogICAgICAgIC8vIGNoYW5nZXMuCiAgICAgICAgWS5hZnRlcignaGFzaGNoYW5nZScsIFkuYmluZCh0aGlzLl9hZnRlckhhc2hDaGFuZ2UsIHRoaXMpLCB3aW4pOwoKICAgICAgICBIaXN0b3J5SGFzaC5zdXBlcmNsYXNzLl9pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIC0tIFByb3RlY3RlZCBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIF9jaGFuZ2U6IGZ1bmN0aW9uIChzcmMsIHN0YXRlLCBvcHRpb25zKSB7CiAgICAgICAgLy8gU3RyaW5naWZ5IGFsbCB2YWx1ZXMgdG8gZW5zdXJlIHRoYXQgY29tcGFyaXNvbnMgZG9uJ3QgZmFpbCBhZnRlcgogICAgICAgIC8vIHRoZXkncmUgY29lcmNlZCB0byBzdHJpbmdzIGluIHRoZSBsb2NhdGlvbiBoYXNoLgogICAgICAgIFlPYmplY3QuZWFjaChzdGF0ZSwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgaWYgKExhbmcuaXNWYWx1ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0YXRlW2tleV0gPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBIaXN0b3J5SGFzaC5zdXBlcmNsYXNzLl9jaGFuZ2UuY2FsbCh0aGlzLCBzcmMsIHN0YXRlLCBvcHRpb25zKTsKICAgIH0sCgogICAgX3N0b3JlU3RhdGU6IGZ1bmN0aW9uIChzcmMsIG5ld1N0YXRlKSB7CiAgICAgICAgdmFyIGRlY29kZSAgPSBIaXN0b3J5SGFzaC5kZWNvZGUsCiAgICAgICAgICAgIG5ld0hhc2ggPSBIaXN0b3J5SGFzaC5jcmVhdGVIYXNoKG5ld1N0YXRlKTsKCiAgICAgICAgSGlzdG9yeUhhc2guc3VwZXJjbGFzcy5fc3RvcmVTdGF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAvLyBVcGRhdGUgdGhlIGxvY2F0aW9uIGhhc2ggd2l0aCB0aGUgY2hhbmdlcywgYnV0IG9ubHkgaWYgdGhlIG5ldyBoYXNoCiAgICAgICAgLy8gYWN0dWFsbHkgZGlmZmVycyBmcm9tIHRoZSBjdXJyZW50IGhhc2ggKHRoaXMgYXZvaWRzIGNyZWF0aW5nIG11bHRpcGxlCiAgICAgICAgLy8gaGlzdG9yeSBlbnRyaWVzIGZvciBhIHNpbmdsZSBzdGF0ZSkuCiAgICAgICAgLy8KICAgICAgICAvLyBXZSBhbHdheXMgY29tcGFyZSBkZWNvZGVkIGhhc2hlcywgc2luY2UgaXQncyBwb3NzaWJsZSB0aGF0IHRoZSBoYXNoCiAgICAgICAgLy8gY291bGQgYmUgc2V0IGluY29ycmVjdGx5IHRvIGEgbm9uLWVuY29kZWQgdmFsdWUgb3V0c2lkZSBvZgogICAgICAgIC8vIEhpc3RvcnlIYXNoLgogICAgICAgIGlmIChzcmMgIT09IFNSQ19IQVNIICYmIGRlY29kZShIaXN0b3J5SGFzaC5nZXRIYXNoKCkpICE9PSBkZWNvZGUobmV3SGFzaCkpIHsKICAgICAgICAgICAgSGlzdG9yeUhhc2hbc3JjID09PSBIaXN0b3J5QmFzZS5TUkNfUkVQTEFDRSA/ICdyZXBsYWNlSGFzaCcgOiAnc2V0SGFzaCddKG5ld0hhc2gpOwogICAgICAgIH0KICAgIH0sCgogICAgLy8gLS0gUHJvdGVjdGVkIEV2ZW50IEhhbmRsZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogSGFuZGxlciBmb3IgaGFzaGNoYW5nZSBldmVudHMuCiAgICAgKgogICAgICogQG1ldGhvZCBfYWZ0ZXJIYXNoQ2hhbmdlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKi8KICAgIF9hZnRlckhhc2hDaGFuZ2U6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdGhpcy5fcmVzb2x2ZUNoYW5nZXMoU1JDX0hBU0gsIEhpc3RvcnlIYXNoLnBhcnNlSGFzaChlLm5ld0hhc2gpLCB7fSk7CiAgICB9Cn0sIHsKICAgIC8vIC0tIFB1YmxpYyBTdGF0aWMgUHJvcGVydGllcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIE5BTUU6ICdoaXN0b3J5SGFzaCcsCgogICAgLyoqCiAgICAgKiBDb25zdGFudCB1c2VkIHRvIGlkZW50aWZ5IHN0YXRlIGNoYW5nZXMgb3JpZ2luYXRpbmcgZnJvbQogICAgICogPGNvZGU+aGFzaGNoYW5nZTwvY29kZT4gZXZlbnRzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBTUkNfSEFTSAogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKiBAc3RhdGljCiAgICAgKiBAZmluYWwKICAgICAqLwogICAgU1JDX0hBU0g6IFNSQ19IQVNILAoKICAgIC8qKgogICAgICogPHA+CiAgICAgKiBQcmVmaXggdG8gcHJlcGVuZCB3aGVuIHNldHRpbmcgdGhlIGhhc2ggZnJhZ21lbnQuIEZvciBleGFtcGxlLCBpZiB0aGUKICAgICAqIHByZWZpeCBpcyA8Y29kZT4hPC9jb2RlPiBhbmQgdGhlIGhhc2ggZnJhZ21lbnQgaXMgc2V0IHRvCiAgICAgKiA8Y29kZT4jZm9vPWJhciZiYXo9cXV1eDwvY29kZT4sIHRoZSBmaW5hbCBoYXNoIGZyYWdtZW50IGluIHRoZSBVUkwgd2lsbAogICAgICogYmVjb21lIDxjb2RlPiMhZm9vPWJhciZiYXo9cXV1eDwvY29kZT4uIFRoaXMgY2FuIGJlIHVzZWQgdG8gaGVscCBtYWtlIGFuCiAgICAgKiBBamF4IGFwcGxpY2F0aW9uIGNyYXdsYWJsZSBpbiBhY2NvcmRhbmNlIHdpdGggR29vZ2xlJ3MgZ3VpZGVsaW5lcyBhdAogICAgICogPGEgaHJlZj0iaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS93ZWIvYWpheGNyYXdsaW5nLyI+aHR0cDovL2NvZGUuZ29vZ2xlLmNvbS93ZWIvYWpheGNyYXdsaW5nLzwvYT4uCiAgICAgKiA8L3A+CiAgICAgKgogICAgICogPHA+CiAgICAgKiBOb3RlIHRoYXQgdGhpcyBwcmVmaXggYXBwbGllcyB0byBhbGwgSGlzdG9yeUhhc2ggaW5zdGFuY2VzLiBJdCdzIG5vdAogICAgICogcG9zc2libGUgZm9yIGluZGl2aWR1YWwgaW5zdGFuY2VzIHRvIHVzZSB0aGVpciBvd24gcHJlZml4ZXMgc2luY2UgdGhleQogICAgICogYWxsIG9wZXJhdGUgb24gdGhlIHNhbWUgVVJMLgogICAgICogPC9wPgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBoYXNoUHJlZml4CiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqIEBkZWZhdWx0ICcnCiAgICAgKiBAc3RhdGljCiAgICAgKi8KICAgIGhhc2hQcmVmaXg6ICcnLAoKICAgIC8vIC0tIFByb3RlY3RlZCBTdGF0aWMgUHJvcGVydGllcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvKioKICAgICAqIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHBhcnNlIGxvY2F0aW9uIGhhc2gvcXVlcnkgc3RyaW5ncy4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgX1JFR0VYX0hBU0gKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICogQHByb3RlY3RlZAogICAgICogQHN0YXRpYwogICAgICogQGZpbmFsCiAgICAgKi8KICAgIF9SRUdFWF9IQVNIOiAvKFteXD8jJj1dKyk9PyhbXiY9XSopL2csCgogICAgLy8gLS0gUHVibGljIFN0YXRpYyBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGxvY2F0aW9uIGhhc2ggc3RyaW5nIGZyb20gdGhlIHNwZWNpZmllZCBvYmplY3Qgb2Yga2V5L3ZhbHVlCiAgICAgKiBwYWlycy4KICAgICAqCiAgICAgKiBAbWV0aG9kIGNyZWF0ZUhhc2gKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgb2JqZWN0IG9mIGtleS92YWx1ZSBwYXJhbWV0ZXIgcGFpcnMKICAgICAqIEByZXR1cm4ge1N0cmluZ30gbG9jYXRpb24gaGFzaCBzdHJpbmcKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gKHBhcmFtcykgewogICAgICAgIHZhciBlbmNvZGUgPSBIaXN0b3J5SGFzaC5lbmNvZGUsCiAgICAgICAgICAgIGhhc2ggICA9IFtdOwoKICAgICAgICBZT2JqZWN0LmVhY2gocGFyYW1zLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBpZiAoTGFuZy5pc1ZhbHVlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaGFzaC5wdXNoKGVuY29kZShrZXkpICsgJz0nICsgZW5jb2RlKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGhhc2guam9pbignJicpOwogICAgfSwKCiAgICAvKioKICAgICAqIFdyYXBwZXIgYXJvdW5kIDxjb2RlPmRlY29kZVVSSUNvbXBvbmVudCgpPC9jb2RlPiB0aGF0IGFsc28gY29udmVydHMgKwogICAgICogY2hhcnMgaW50byBzcGFjZXMuCiAgICAgKgogICAgICogQG1ldGhvZCBkZWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgc3RyaW5nIHRvIGRlY29kZQogICAgICogQHJldHVybiB7U3RyaW5nfSBkZWNvZGVkIHN0cmluZwogICAgICogQHN0YXRpYwogICAgICovCiAgICBkZWNvZGU6IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0cmluZy5yZXBsYWNlKC9cKy9nLCAnICcpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBXcmFwcGVyIGFyb3VuZCA8Y29kZT5lbmNvZGVVUklDb21wb25lbnQoKTwvY29kZT4gdGhhdCBjb252ZXJ0cyBzcGFjZXMgdG8KICAgICAqICsgY2hhcnMuCiAgICAgKgogICAgICogQG1ldGhvZCBlbmNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgc3RyaW5nIHRvIGVuY29kZQogICAgICogQHJldHVybiB7U3RyaW5nfSBlbmNvZGVkIHN0cmluZwogICAgICogQHN0YXRpYwogICAgICovCiAgICBlbmNvZGU6IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvJTIwL2csICcrJyk7CiAgICB9LAoKICAgIC8qKgogICAgICogR2V0cyB0aGUgcmF3IChub3QgZGVjb2RlZCkgY3VycmVudCBsb2NhdGlvbiBoYXNoLCBtaW51cyB0aGUgcHJlY2VkaW5nICcjJwogICAgICogY2hhcmFjdGVyIGFuZCB0aGUgaGFzaFByZWZpeCAoaWYgb25lIGlzIHNldCkuCiAgICAgKgogICAgICogQG1ldGhvZCBnZXRIYXNoCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IGN1cnJlbnQgbG9jYXRpb24gaGFzaAogICAgICogQHN0YXRpYwogICAgICovCiAgICBnZXRIYXNoOiAoWS5VQS5nZWNrbyA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBHZWNrbydzIHdpbmRvdy5sb2NhdGlvbi5oYXNoIHJldHVybnMgYSBkZWNvZGVkIHN0cmluZyBhbmQgd2Ugd2FudCBhbGwKICAgICAgICAvLyBlbmNvZGluZyB1bnRvdWNoZWQsIHNvIHdlIG5lZWQgdG8gZ2V0IHRoZSBoYXNoIHZhbHVlIGZyb20KICAgICAgICAvLyB3aW5kb3cubG9jYXRpb24uaHJlZiBpbnN0ZWFkLiBXZSBoYXZlIHRvIHVzZSBVQSBzbmlmZmluZyByYXRoZXIgdGhhbgogICAgICAgIC8vIGZlYXR1cmUgZGV0ZWN0aW9uLCBzaW5jZSB0aGUgb25seSB3YXkgdG8gZGV0ZWN0IHRoaXMgd291bGQgYmUgdG8KICAgICAgICAvLyBhY3R1YWxseSBjaGFuZ2UgdGhlIGhhc2guCiAgICAgICAgdmFyIGxvY2F0aW9uID0gWS5nZXRMb2NhdGlvbigpLAogICAgICAgICAgICBtYXRjaGVzICA9IC8jKC4qKSQvLmV4ZWMobG9jYXRpb24uaHJlZiksCiAgICAgICAgICAgIGhhc2ggICAgID0gbWF0Y2hlcyAmJiBtYXRjaGVzWzFdIHx8ICcnLAogICAgICAgICAgICBwcmVmaXggICA9IEhpc3RvcnlIYXNoLmhhc2hQcmVmaXg7CgogICAgICAgIHJldHVybiBwcmVmaXggJiYgaGFzaC5pbmRleE9mKHByZWZpeCkgPT09IDAgPwogICAgICAgICAgICAgICAgICAgIGhhc2gucmVwbGFjZShwcmVmaXgsICcnKSA6IGhhc2g7CiAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBsb2NhdGlvbiA9IFkuZ2V0TG9jYXRpb24oKSwKICAgICAgICAgICAgaGFzaCAgICAgPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSwKICAgICAgICAgICAgcHJlZml4ICAgPSBIaXN0b3J5SGFzaC5oYXNoUHJlZml4OwoKICAgICAgICAvLyBTbGlnaHQgY29kZSBkdXBsaWNhdGlvbiBoZXJlLCBidXQgZXhlY3V0aW9uIHNwZWVkIGlzIG9mIHRoZSBlc3NlbmNlCiAgICAgICAgLy8gc2luY2UgZ2V0SGFzaCgpIGlzIGNhbGxlZCBldmVyeSA1MG1zIHRvIHBvbGwgZm9yIGNoYW5nZXMgaW4gYnJvd3NlcnMKICAgICAgICAvLyB0aGF0IGRvbid0IHN1cHBvcnQgbmF0aXZlIG9uaGFzaGNoYW5nZS4gQW4gYWRkaXRpb25hbCBmdW5jdGlvbiBjYWxsCiAgICAgICAgLy8gd291bGQgYWRkIHVubmVjZXNzYXJ5IG92ZXJoZWFkLgogICAgICAgIHJldHVybiBwcmVmaXggJiYgaGFzaC5pbmRleE9mKHByZWZpeCkgPT09IDAgPwogICAgICAgICAgICAgICAgICAgIGhhc2gucmVwbGFjZShwcmVmaXgsICcnKSA6IGhhc2g7CiAgICB9KSwKCiAgICAvKioKICAgICAqIEdldHMgdGhlIGN1cnJlbnQgYm9va21hcmthYmxlIFVSTC4KICAgICAqCiAgICAgKiBAbWV0aG9kIGdldFVybAogICAgICogQHJldHVybiB7U3RyaW5nfSBjdXJyZW50IGJvb2ttYXJrYWJsZSBVUkwKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgZ2V0VXJsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhyZWY7CiAgICB9LAoKICAgIC8qKgogICAgICogUGFyc2VzIGEgbG9jYXRpb24gaGFzaCBzdHJpbmcgaW50byBhbiBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhcmFtZXRlcgogICAgICogcGFpcnMuIElmIDxpPmhhc2g8L2k+IGlzIG5vdCBzcGVjaWZpZWQsIHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2ggd2lsbAogICAgICogYmUgdXNlZC4KICAgICAqCiAgICAgKiBAbWV0aG9kIHBhcnNlSGFzaAogICAgICogQHBhcmFtIHtTdHJpbmd9IGhhc2ggKG9wdGlvbmFsKSBsb2NhdGlvbiBoYXNoIHN0cmluZwogICAgICogQHJldHVybiB7T2JqZWN0fSBvYmplY3Qgb2YgcGFyc2VkIGtleS92YWx1ZSBwYXJhbWV0ZXIgcGFpcnMKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgcGFyc2VIYXNoOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgIHZhciBkZWNvZGUgPSBIaXN0b3J5SGFzaC5kZWNvZGUsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGxlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIG1hdGNoZXMsCiAgICAgICAgICAgIHBhcmFtLAogICAgICAgICAgICBwYXJhbXMgPSB7fSwKICAgICAgICAgICAgcHJlZml4ID0gSGlzdG9yeUhhc2guaGFzaFByZWZpeCwKICAgICAgICAgICAgcHJlZml4SW5kZXg7CgogICAgICAgIGhhc2ggPSBMYW5nLmlzVmFsdWUoaGFzaCkgPyBoYXNoIDogSGlzdG9yeUhhc2guZ2V0SGFzaCgpOwoKICAgICAgICBpZiAocHJlZml4KSB7CiAgICAgICAgICAgIHByZWZpeEluZGV4ID0gaGFzaC5pbmRleE9mKHByZWZpeCk7CgogICAgICAgICAgICBpZiAocHJlZml4SW5kZXggPT09IDAgfHwgKHByZWZpeEluZGV4ID09PSAxICYmIGhhc2guY2hhckF0KDApID09PSAnIycpKSB7CiAgICAgICAgICAgICAgICBoYXNoID0gaGFzaC5yZXBsYWNlKHByZWZpeCwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtYXRjaGVzID0gaGFzaC5tYXRjaChIaXN0b3J5SGFzaC5fUkVHRVhfSEFTSCkgfHwgW107CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IG1hdGNoZXMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaGVzW2ldOwoKICAgICAgICAgICAgcGFyYW0gPSBtYXRjaC5zcGxpdCgnPScpOwoKICAgICAgICAgICAgaWYgKHBhcmFtLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHBhcmFtc1tkZWNvZGUocGFyYW1bMF0pXSA9IGRlY29kZShwYXJhbVsxXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJhbXNbZGVjb2RlKG1hdGNoKV0gPSAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXBsYWNlcyB0aGUgYnJvd3NlcidzIGN1cnJlbnQgbG9jYXRpb24gaGFzaCB3aXRoIHRoZSBzcGVjaWZpZWQgaGFzaAogICAgICogYW5kIHJlbW92ZXMgYWxsIGZvcndhcmQgbmF2aWdhdGlvbiBzdGF0ZXMsIHdpdGhvdXQgY3JlYXRpbmcgYSBuZXcgYnJvd3NlcgogICAgICogaGlzdG9yeSBlbnRyeS4gQXV0b21hdGljYWxseSBwcmVwZW5kcyB0aGUgPGNvZGU+aGFzaFByZWZpeDwvY29kZT4gaWYgb25lCiAgICAgKiBpcyBzZXQuCiAgICAgKgogICAgICogQG1ldGhvZCByZXBsYWNlSGFzaAogICAgICogQHBhcmFtIHtTdHJpbmd9IGhhc2ggbmV3IGxvY2F0aW9uIGhhc2gKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgcmVwbGFjZUhhc2g6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gWS5nZXRMb2NhdGlvbigpLAogICAgICAgICAgICBiYXNlICAgICA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvIy4qJC8sICcnKTsKCiAgICAgICAgaWYgKGhhc2guY2hhckF0KDApID09PSAnIycpIHsKICAgICAgICAgICAgaGFzaCA9IGhhc2guc3Vic3RyaW5nKDEpOwogICAgICAgIH0KCiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShiYXNlICsgJyMnICsgKEhpc3RvcnlIYXNoLmhhc2hQcmVmaXggfHwgJycpICsgaGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2V0cyB0aGUgYnJvd3NlcidzIGxvY2F0aW9uIGhhc2ggdG8gdGhlIHNwZWNpZmllZCBzdHJpbmcuIEF1dG9tYXRpY2FsbHkKICAgICAqIHByZXBlbmRzIHRoZSA8Y29kZT5oYXNoUHJlZml4PC9jb2RlPiBpZiBvbmUgaXMgc2V0LgogICAgICoKICAgICAqIEBtZXRob2Qgc2V0SGFzaAogICAgICogQHBhcmFtIHtTdHJpbmd9IGhhc2ggbmV3IGxvY2F0aW9uIGhhc2gKICAgICAqIEBzdGF0aWMKICAgICAqLwogICAgc2V0SGFzaDogZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICB2YXIgbG9jYXRpb24gPSBZLmdldExvY2F0aW9uKCk7CgogICAgICAgIGlmIChoYXNoLmNoYXJBdCgwKSA9PT0gJyMnKSB7CiAgICAgICAgICAgIGhhc2ggPSBoYXNoLnN1YnN0cmluZygxKTsKICAgICAgICB9CgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAoSGlzdG9yeUhhc2guaGFzaFByZWZpeCB8fCAnJykgKyBoYXNoOwogICAgfQp9KTsKCi8vIC0tIFN5bnRoZXRpYyBoYXNoY2hhbmdlIEV2ZW50IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgovLyBUT0RPOiBZVUlEb2MgY3VycmVudGx5IGRvZXNuJ3QgcHJvdmlkZSBhIGdvb2Qgd2F5IHRvIGRvY3VtZW50IHN5bnRoZXRpYyBET00KLy8gZXZlbnRzLiBGb3Igbm93LCB3ZSdyZSBqdXN0IGRvY3VtZW50aW5nIHRoZSBoYXNoY2hhbmdlIGV2ZW50IG9uIHRoZSBZVUkKLy8gb2JqZWN0LCB3aGljaCBpcyBhYm91dCB0aGUgYmVzdCB3ZSBjYW4gZG8gdW50aWwgZW5oYW5jZW1lbnRzIGFyZSBtYWRlIHRvCi8vIFlVSURvYy4KCi8qKgpTeW50aGV0aWMgPGNvZGU+d2luZG93Lm9uaGFzaGNoYW5nZTwvY29kZT4gZXZlbnQgdGhhdCBub3JtYWxpemVzIGRpZmZlcmVuY2VzCmFjcm9zcyBicm93c2VycyBhbmQgcHJvdmlkZXMgc3VwcG9ydCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0Cjxjb2RlPm9uaGFzaGNoYW5nZTwvY29kZT4uCgpUaGlzIGV2ZW50IGlzIHByb3ZpZGVkIGJ5IHRoZSA8Y29kZT5oaXN0b3J5LWhhc2g8L2NvZGU+IG1vZHVsZS4KCkBleGFtcGxlCgogICAgWVVJKCkudXNlKCdoaXN0b3J5LWhhc2gnLCBmdW5jdGlvbiAoWSkgewogICAgICBZLm9uKCdoYXNoY2hhbmdlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAvLyBIYW5kbGUgaGFzaGNoYW5nZSBldmVudHMgb24gdGhlIGN1cnJlbnQgd2luZG93LgogICAgICB9LCBZLmNvbmZpZy53aW4pOwogICAgfSk7CgpAZXZlbnQgaGFzaGNoYW5nZQpAcGFyYW0ge0V2ZW50RmFjYWRlfSBlIEV2ZW50IGZhY2FkZSB3aXRoIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbAogIHByb3BlcnRpZXM6Cgo8ZGw+CiAgPGR0Pm9sZEhhc2g8L2R0PgogIDxkZD4KICAgIFByZXZpb3VzIGhhc2ggZnJhZ21lbnQgdmFsdWUgYmVmb3JlIHRoZSBjaGFuZ2UuCiAgPC9kZD4KCiAgPGR0Pm9sZFVybDwvZHQ+CiAgPGRkPgogICAgUHJldmlvdXMgVVJMIChpbmNsdWRpbmcgdGhlIGhhc2ggZnJhZ21lbnQpIGJlZm9yZSB0aGUgY2hhbmdlLgogIDwvZGQ+CgogIDxkdD5uZXdIYXNoPC9kdD4KICA8ZGQ+CiAgICBOZXcgaGFzaCBmcmFnbWVudCB2YWx1ZSBhZnRlciB0aGUgY2hhbmdlLgogIDwvZGQ+CgogIDxkdD5uZXdVcmw8L2R0PgogIDxkZD4KICAgIE5ldyBVUkwgKGluY2x1ZGluZyB0aGUgaGFzaCBmcmFnbWVudCkgYWZ0ZXIgdGhlIGNoYW5nZS4KICA8L2RkPgo8L2RsPgpAZm9yIFlVSQpAc2luY2UgMy4yLjAKKiovCgpoYXNoTm90aWZpZXJzID0gR2xvYmFsRW52Ll9ub3RpZmllcnM7CgppZiAoIWhhc2hOb3RpZmllcnMpIHsKICAgIGhhc2hOb3RpZmllcnMgPSBHbG9iYWxFbnYuX25vdGlmaWVycyA9IFtdOwp9CgpZLkV2ZW50LmRlZmluZSgnaGFzaGNoYW5nZScsIHsKICAgIG9uOiBmdW5jdGlvbiAobm9kZSwgc3Vic2NyaWJlciwgbm90aWZpZXIpIHsKICAgICAgICAvLyBJZ25vcmUgdGhpcyBzdWJzY3JpcHRpb24gaWYgdGhlIG5vZGUgaXMgYW55dGhpbmcgb3RoZXIgdGhhbiB0aGUKICAgICAgICAvLyB3aW5kb3cgb3IgZG9jdW1lbnQgYm9keSwgc2luY2UgdGhvc2UgYXJlIHRoZSBvbmx5IGVsZW1lbnRzIHRoYXQKICAgICAgICAvLyBzaG91bGQgc3VwcG9ydCB0aGUgaGFzaGNoYW5nZSBldmVudC4gTm90ZSB0aGF0IHRoZSBib2R5IGNvdWxkIGFsc28gYmUKICAgICAgICAvLyBhIGZyYW1lc2V0LCBidXQgdGhhdCdzIG9rYXkgc2luY2UgZnJhbWVzZXRzIHN1cHBvcnQgaGFzaGNoYW5nZSB0b28uCiAgICAgICAgaWYgKG5vZGUuY29tcGFyZVRvKHdpbikgfHwgbm9kZS5jb21wYXJlVG8oWS5jb25maWcuZG9jLmJvZHkpKSB7CiAgICAgICAgICAgIGhhc2hOb3RpZmllcnMucHVzaChub3RpZmllcik7CiAgICAgICAgfQogICAgfSwKCiAgICBkZXRhY2g6IGZ1bmN0aW9uIChub2RlLCBzdWJzY3JpYmVyLCBub3RpZmllcikgewogICAgICAgIHZhciBpbmRleCA9IFlBcnJheS5pbmRleE9mKGhhc2hOb3RpZmllcnMsIG5vdGlmaWVyKTsKCiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICBoYXNoTm90aWZpZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgfQp9KTsKCm9sZEhhc2ggPSBIaXN0b3J5SGFzaC5nZXRIYXNoKCk7Cm9sZFVybCAgPSBIaXN0b3J5SGFzaC5nZXRVcmwoKTsKCmlmIChIaXN0b3J5QmFzZS5uYXRpdmVIYXNoQ2hhbmdlKSB7CiAgICAvLyBXcmFwIHRoZSBicm93c2VyJ3MgbmF0aXZlIGhhc2hjaGFuZ2UgZXZlbnQgaWYgdGhlcmUncyBub3QgYWxyZWFkeSBhCiAgICAvLyBnbG9iYWwgbGlzdGVuZXIuCiAgICBpZiAoIUdsb2JhbEVudi5faGFzaEhhbmRsZSkgewogICAgICAgIEdsb2JhbEVudi5faGFzaEhhbmRsZSA9IFkuRXZlbnQuYXR0YWNoKCdoYXNoY2hhbmdlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgdmFyIG5ld0hhc2ggPSBIaXN0b3J5SGFzaC5nZXRIYXNoKCksCiAgICAgICAgICAgICAgICBuZXdVcmwgID0gSGlzdG9yeUhhc2guZ2V0VXJsKCk7CgogICAgICAgICAgICAvLyBJdGVyYXRlIG92ZXIgYSBjb3B5IG9mIHRoZSBoYXNoTm90aWZpZXJzIGFycmF5IHNpbmNlIGEgc3Vic2NyaWJlcgogICAgICAgICAgICAvLyBjb3VsZCBkZXRhY2ggZHVyaW5nIGl0ZXJhdGlvbiBhbmQgY2F1c2UgdGhlIGFycmF5IHRvIGJlIHJlLWluZGV4ZWQuCiAgICAgICAgICAgIFlBcnJheS5lYWNoKGhhc2hOb3RpZmllcnMuY29uY2F0KCksIGZ1bmN0aW9uIChub3RpZmllcikgewogICAgICAgICAgICAgICAgbm90aWZpZXIuZmlyZSh7CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50IDogZSwKICAgICAgICAgICAgICAgICAgICBvbGRIYXNoOiBvbGRIYXNoLAogICAgICAgICAgICAgICAgICAgIG9sZFVybCA6IG9sZFVybCwKICAgICAgICAgICAgICAgICAgICBuZXdIYXNoOiBuZXdIYXNoLAogICAgICAgICAgICAgICAgICAgIG5ld1VybCA6IG5ld1VybAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgb2xkSGFzaCA9IG5ld0hhc2g7CiAgICAgICAgICAgIG9sZFVybCAgPSBuZXdVcmw7CiAgICAgICAgfSwgd2luKTsKICAgIH0KfSBlbHNlIHsKICAgIC8vIEJlZ2luIHBvbGxpbmcgZm9yIGxvY2F0aW9uIGhhc2ggY2hhbmdlcyBpZiB0aGVyZSdzIG5vdCBhbHJlYWR5IGEgZ2xvYmFsCiAgICAvLyBwb2xsIHJ1bm5pbmcuCiAgICBpZiAoIUdsb2JhbEVudi5faGFzaFBvbGwpIHsKICAgICAgICBHbG9iYWxFbnYuX2hhc2hQb2xsID0gWS5sYXRlcig1MCwgbnVsbCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbmV3SGFzaCA9IEhpc3RvcnlIYXNoLmdldEhhc2goKSwKICAgICAgICAgICAgICAgIGZhY2FkZSwgbmV3VXJsOwoKICAgICAgICAgICAgaWYgKG9sZEhhc2ggIT09IG5ld0hhc2gpIHsKICAgICAgICAgICAgICAgIG5ld1VybCA9IEhpc3RvcnlIYXNoLmdldFVybCgpOwoKICAgICAgICAgICAgICAgIGZhY2FkZSA9IHsKICAgICAgICAgICAgICAgICAgICBvbGRIYXNoOiBvbGRIYXNoLAogICAgICAgICAgICAgICAgICAgIG9sZFVybCA6IG9sZFVybCwKICAgICAgICAgICAgICAgICAgICBuZXdIYXNoOiBuZXdIYXNoLAogICAgICAgICAgICAgICAgICAgIG5ld1VybCA6IG5ld1VybAogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBvbGRIYXNoID0gbmV3SGFzaDsKICAgICAgICAgICAgICAgIG9sZFVybCAgPSBuZXdVcmw7CgogICAgICAgICAgICAgICAgWUFycmF5LmVhY2goaGFzaE5vdGlmaWVycy5jb25jYXQoKSwgZnVuY3Rpb24gKG5vdGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgbm90aWZpZXIuZmlyZShmYWNhZGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCBudWxsLCB0cnVlKTsKICAgIH0KfQoKWS5IaXN0b3J5SGFzaCA9IEhpc3RvcnlIYXNoOwoKLy8gSGlzdG9yeUhhc2ggd2lsbCBuZXZlciB3aW4gb3ZlciBIaXN0b3J5SFRNTDUgdW5sZXNzIHVzZUhpc3RvcnlIVE1MNSBpcyBmYWxzZS4KaWYgKHVzZUhpc3RvcnlIVE1MNSA9PT0gZmFsc2UgfHwgKCFZLkhpc3RvcnkgJiYgdXNlSGlzdG9yeUhUTUw1ICE9PSB0cnVlICYmCiAgICAgICAgKCFIaXN0b3J5QmFzZS5odG1sNSB8fCAhWS5IaXN0b3J5SFRNTDUpKSkgewogICAgWS5IaXN0b3J5ID0gSGlzdG9yeUhhc2g7Cn0K",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 04:07:14 GMT",
                    "Content-Length": "14511",
                    "Date": "Sun, 09 Nov 2014 04:07:25 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}