{
    "url": "http://localhost:9999/yurychika/ECG/Flex/history/history.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.search</b> and written to <b>the 'name' property of a DOM element</b> via the following statements:<ul><li>var qs = window.location.search.substring(1);</li><li>var qs_arr = qs.split(\"&amp;\");</li><li>var tmp = qs_arr[i].split(\"=\");</li><li>elem.name = tmp[0];</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/yurychika/ECG/Flex/history/history.js",
                "path": "/yurychika/ECG/Flex/history/history.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC95dXJ5Y2hpa2EvRUNHL0ZsZXgvaGlzdG9yeS9oaXN0b3J5LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjQ2NTANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMjI6MjM6MzcgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDIyOjIzOjM2IEdNVA0KDQpCcm93c2VySGlzdG9yeVV0aWxzID0gewogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uKGVsbSwgZXZUeXBlLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgIGlmIChlbG0uYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICBlbG0uYWRkRXZlbnRMaXN0ZW5lcihldlR5cGUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVsbS5hdHRhY2hFdmVudCkgewogICAgICAgICAgICB2YXIgciA9IGVsbS5hdHRhY2hFdmVudCgnb24nICsgZXZUeXBlLCBmbik7CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZWxtWydvbicgKyBldlR5cGVdID0gZm47CiAgICAgICAgfQogICAgfQp9CgpCcm93c2VySGlzdG9yeSA9IChmdW5jdGlvbigpIHsKICAgIC8vIHR5cGUgb2YgYnJvd3NlcgogICAgdmFyIGJyb3dzZXIgPSB7CiAgICAgICAgaWU6IGZhbHNlLCAKICAgICAgICBpZTg6IGZhbHNlLCAKICAgICAgICBmaXJlZm94OiBmYWxzZSwgCiAgICAgICAgc2FmYXJpOiBmYWxzZSwgCiAgICAgICAgb3BlcmE6IGZhbHNlLCAKICAgICAgICB2ZXJzaW9uOiAtMQogICAgfTsKCiAgICAvLyBEZWZhdWx0IGFwcCBzdGF0ZSBVUkwgdG8gdXNlIHdoZW4gbm8gZnJhZ21lbnQgSUQgcHJlc2VudAogICAgdmFyIGRlZmF1bHRIYXNoID0gJyc7CgogICAgLy8gTGFzdC1rbm93biBhcHAgc3RhdGUgVVJMCiAgICB2YXIgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwoKICAgIC8vIEluaXRpYWwgVVJMICh1c2VkIG9ubHkgYnkgSUUpCiAgICB2YXIgaW5pdGlhbEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwoKICAgIC8vIEluaXRpYWwgVVJMICh1c2VkIG9ubHkgYnkgSUUpCiAgICB2YXIgaW5pdGlhbEhhc2ggPSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoOwoKICAgIC8vIEhpc3RvcnkgZnJhbWUgc291cmNlIFVSTCBwcmVmaXggKHVzZWQgb25seSBieSBJRSkKICAgIHZhciBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggPSAnaGlzdG9yeS9oaXN0b3J5RnJhbWUuaHRtbD8nOwoKICAgIC8vIEhpc3RvcnkgbWFpbnRlbmFuY2UgKHVzZWQgb25seSBieSBTYWZhcmkpCiAgICB2YXIgY3VycmVudEhpc3RvcnlMZW5ndGggPSAtMTsKICAgIAogICAgLy8gRmxhZyB0byBkZW5vdGUgdGhlIGV4aXN0ZW5jZSBvZiBvbmhhc2hjaGFuZ2UKICAgIHZhciBicm93c2VySGFzSGFzaENoYW5nZSA9IGZhbHNlOwoKICAgIHZhciBoaXN0b3J5SGFzaCA9IFtdOwoKICAgIHZhciBpbml0aWFsU3RhdGUgPSBjcmVhdGVTdGF0ZShpbml0aWFsSHJlZiwgaW5pdGlhbEhyZWYgKyAnIycgKyBpbml0aWFsSGFzaCwgaW5pdGlhbEhhc2gpOwoKICAgIHZhciBiYWNrU3RhY2sgPSBbXTsKICAgIHZhciBmb3J3YXJkU3RhY2sgPSBbXTsKCiAgICB2YXIgY3VycmVudE9iamVjdElkID0gbnVsbDsKCiAgICAvL1VzZXJBZ2VudCBkZXRlY3Rpb24KICAgIHZhciB1c2VyYWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CgogICAgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCJvcGVyYSIpICE9IC0xKSB7CiAgICAgICAgYnJvd3Nlci5vcGVyYSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCJtc2llIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLmllID0gdHJ1ZTsKICAgICAgICBicm93c2VyLnZlcnNpb24gPSBwYXJzZUZsb2F0KHVzZXJhZ2VudC5zdWJzdHJpbmcodXNlcmFnZW50LmluZGV4T2YoJ21zaWUnKSArIDQpKTsKICAgICAgICBpZiAoYnJvd3Nlci52ZXJzaW9uID09IDgpCiAgICAgICAgewogICAgICAgICAgICBicm93c2VyLmllID0gZmFsc2U7CiAgICAgICAgICAgIGJyb3dzZXIuaWU4ID0gdHJ1ZTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCJzYWZhcmkiKSAhPSAtMSkgewogICAgICAgIGJyb3dzZXIuc2FmYXJpID0gdHJ1ZTsKICAgICAgICBicm93c2VyLnZlcnNpb24gPSBwYXJzZUZsb2F0KHVzZXJhZ2VudC5zdWJzdHJpbmcodXNlcmFnZW50LmluZGV4T2YoJ3NhZmFyaScpICsgNykpOwogICAgfSBlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZigiZ2Vja28iKSAhPSAtMSkgewogICAgICAgIGJyb3dzZXIuZmlyZWZveCA9IHRydWU7CiAgICB9CgogICAgaWYgKGJyb3dzZXIuaWUgPT0gdHJ1ZSAmJiBicm93c2VyLnZlcnNpb24gPT0gNykgewogICAgICAgIHdpbmRvd1siX2llX2ZpcnN0bG9hZCJdID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gaGFzaENoYW5nZUhhbmRsZXIoKQogICAgewogICAgICAgIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICB2YXIgZmxleEFwcFVybCA9IGdldEhhc2goKTsKICAgICAgICAvL0FEUjogdG8gZml4IG11bHRpcGxlCiAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdldFBsYXllcigpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEFjY2Vzc29yIGZ1bmN0aW9ucyBmb3Igb2J0YWluaW5nIHNwZWNpZmljIGVsZW1lbnRzIG9mIHRoZSBwYWdlLgogICAgZnVuY3Rpb24gZ2V0SGlzdG9yeUZyYW1lKCkKICAgIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2llX2hpc3RvcnlGcmFtZScpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEZvcm1FbGVtZW50KCkKICAgIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhZmFyaV9mb3JtRGl2Jyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UmVtZW1iZXJFbGVtZW50KCkKICAgIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNhZmFyaV9yZW1lbWJlcl9maWVsZCIpOwogICAgfQoKICAgIC8vIEdldCB0aGUgRmxhc2ggcGxheWVyIG9iamVjdCBmb3IgcGVyZm9ybWluZyBFeHRlcm5hbEludGVyZmFjZSBjYWxsYmFja3MuCiAgICAvLyBVcGRhdGVkIGZvciBjaGFuZ2VzIHRvIFNXRk9iamVjdDIuCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXIoaWQpIHsKICAgICAgICB2YXIgaTsKCgkJaWYgKGlkICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSkgewoJCQl2YXIgciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJaWYgKHR5cGVvZiByLlNldFZhcmlhYmxlICE9ICJ1bmRlZmluZWQiKSB7CgkJCQlyZXR1cm4gcjsKCQkJfQoJCQllbHNlIHsKCQkJCXZhciBvID0gci5nZXRFbGVtZW50c0J5VGFnTmFtZSgib2JqZWN0Iik7CgkJCQl2YXIgZSA9IHIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImVtYmVkIik7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb1tpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlW2ldOwogICAgICAgICAgICAgICAgfQoJCQl9CgkJfQoJCWVsc2UgewoJCQl2YXIgbyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvYmplY3QiKTsKCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZW1iZWQiKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZVtpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9baV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoJCX0KCQlyZXR1cm4gdW5kZWZpbmVkOwoJfQogICAgCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXJzKCkgewogICAgICAgIHZhciBpOwogICAgICAgIHZhciBwbGF5ZXJzID0gW107CiAgICAgICAgaWYgKHBsYXllcnMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgdmFyIHRtcCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRtcC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0bXBbaV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICBwbGF5ZXJzLnB1c2godG1wW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocGxheWVycy5sZW5ndGggPT0gMCB8fCBwbGF5ZXJzWzBdLm9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0bXAgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZW1iZWQnKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRtcC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0bXBbaV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICBwbGF5ZXJzLnB1c2godG1wW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGxheWVyczsKICAgIH0KCglmdW5jdGlvbiBnZXRJZnJhbWVIYXNoKCkgewoJCXZhciBkb2MgPSBnZXRIaXN0b3J5RnJhbWUoKS5jb250ZW50V2luZG93LmRvY3VtZW50OwoJCXZhciBoYXNoID0gU3RyaW5nKGRvYy5sb2NhdGlvbi5zZWFyY2gpOwoJCWlmIChoYXNoLmxlbmd0aCA9PSAxICYmIGhhc2guY2hhckF0KDApID09ICI/IikgewoJCQloYXNoID0gIiI7CgkJfQoJCWVsc2UgaWYgKGhhc2gubGVuZ3RoID49IDIgJiYgaGFzaC5jaGFyQXQoMCkgPT0gIj8iKSB7CgkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZygxKTsKCQl9CgkJcmV0dXJuIGhhc2g7Cgl9CgogICAgLyogR2V0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2ggZXhjbHVkaW5nIHRoZSAnIycgc3ltYm9sLiAqLwogICAgZnVuY3Rpb24gZ2V0SGFzaCgpIHsKICAgICAgIC8vIEl0IHdvdWxkIGJlIG5pY2UgaWYgd2UgY291bGQgdXNlIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggaGVyZSwKICAgICAgIC8vIGJ1dCBpdCdzIGZhdWx0eSBzb21ldGltZXMuCiAgICAgICB2YXIgaWR4ID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJyk7CiAgICAgICByZXR1cm4gKGlkeCA+PSAwKSA/IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3Vic3RyKGlkeCsxKSA6ICcnOwogICAgfQoKICAgIC8qIEdldCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoIGV4Y2x1ZGluZyB0aGUgJyMnIHN5bWJvbC4gKi8KICAgIGZ1bmN0aW9uIHNldEhhc2goaGFzaCkgewogICAgICAgLy8gSXQgd291bGQgYmUgbmljZSBpZiB3ZSBjb3VsZCB1c2UgZG9jdW1lbnQubG9jYXRpb24uaGFzaCBoZXJlLAogICAgICAgLy8gYnV0IGl0J3MgZmF1bHR5IHNvbWV0aW1lcy4KICAgICAgIGlmIChoYXNoID09ICcnKSBoYXNoID0gJyMnCiAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVTdGF0ZShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpIHsKICAgICAgICByZXR1cm4geyAnYmFzZVVybCc6IGJhc2VVcmwsICduZXdVcmwnOiBuZXdVcmwsICdmbGV4QXBwVXJsJzogZmxleEFwcFVybCwgJ3RpdGxlJzogbnVsbCB9OwogICAgfQoKICAgIC8qIEFkZCBhIGhpc3RvcnkgZW50cnkgdG8gdGhlIGJyb3dzZXIuCiAgICAgKiAgIGJhc2VVcmw6IHRoZSBwb3J0aW9uIG9mIHRoZSBsb2NhdGlvbiBwcmlvciB0byB0aGUgJyMnCiAgICAgKiAgIG5ld1VybDogdGhlIGVudGlyZSBuZXcgVVJMLCBpbmNsdWRpbmcgJyMnIGFuZCBmb2xsb3dpbmcgZnJhZ21lbnQKICAgICAqICAgZmxleEFwcFVybDogdGhlIHBvcnRpb24gb2YgdGhlIGxvY2F0aW9uIGZvbGxvd2luZyB0aGUgJyMnIG9ubHkKICAgICAqLwogICAgZnVuY3Rpb24gYWRkSGlzdG9yeUVudHJ5KGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCkgewoKICAgICAgICAvL2RlbGV0ZSBhbGwgdGhlIGhpc3RvcnkgZW50cmllcwogICAgICAgIGZvcndhcmRTdGFjayA9IFtdOwoKICAgICAgICBpZiAoYnJvd3Nlci5pZSkgewogICAgICAgICAgICAvL0NoZWNrIHRvIHNlZSBpZiB3ZSBhcmUgYmVpbmcgYXNrZWQgdG8gZG8gYSBuYXZpZ2F0ZSBmb3IgdGhlIGZpcnN0CiAgICAgICAgICAgIC8vaGlzdG9yeSBlbnRyeSwgYW5kIGlmIHNvIGlnbm9yZSwgYmVjYXVzZSBpdCdzIGNvbWluZyBmcm9tIHRoZSBjcmVhdGlvbgogICAgICAgICAgICAvL29mIHRoZSBoaXN0b3J5IGlmcmFtZQogICAgICAgICAgICBpZiAoZmxleEFwcFVybCA9PSBkZWZhdWx0SGFzaCAmJiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID09IGluaXRpYWxIcmVmICYmIHdpbmRvd1snX2llX2ZpcnN0bG9hZCddKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IGluaXRpYWxIcmVmOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoIWZsZXhBcHBVcmwgfHwgZmxleEFwcFVybCA9PSBkZWZhdWx0SGFzaCkgJiYgd2luZG93WydfaWVfZmlyc3Rsb2FkJ10pIHsKICAgICAgICAgICAgICAgIG5ld1VybCA9IGJhc2VVcmwgKyAnIycgKyBkZWZhdWx0SGFzaDsKICAgICAgICAgICAgICAgIGZsZXhBcHBVcmwgPSBkZWZhdWx0SGFzaDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGZvciBJRSwgdGVsbCB0aGUgaGlzdG9yeSBmcmFtZSB0byBnbyBzb21ld2hlcmUgd2l0aG91dCBhICcjJwogICAgICAgICAgICAgICAgLy8gaW4gb3JkZXIgdG8gZ2V0IHRoaXMgZW50cnkgaW50byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgICAgICAgICAgICAgZ2V0SGlzdG9yeUZyYW1lKCkuc3JjID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ICsgZmxleEFwcFVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRIYXNoKGZsZXhBcHBVcmwpOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAvL0FEUgogICAgICAgICAgICBpZiAoYmFja1N0YWNrLmxlbmd0aCA9PSAwICYmIGluaXRpYWxTdGF0ZS5mbGV4QXBwVXJsID09IGZsZXhBcHBVcmwpIHsKICAgICAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0gZWxzZSBpZihiYWNrU3RhY2subGVuZ3RoID4gMCAmJiBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdLmZsZXhBcHBVcmwgPT0gZmxleEFwcFVybCkgewogICAgICAgICAgICAgICAgYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXSA9IGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChicm93c2VyLnNhZmFyaSAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgICAgIC8vIGZvciBTYWZhcmksIHN1Ym1pdCBhIGZvcm0gd2hvc2UgYWN0aW9uIHBvaW50cyB0byB0aGUgZGVzaXJlZCBVUkwKICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPD0gNDE5LjMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlsZSA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIGZpbGUgPSBmaWxlLnN1YnN0cmluZyhmaWxlLmxhc3RJbmRleE9mKCIvIikrMSk7CiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9ybUVsZW1lbnQoKS5pbm5lckhUTUwgPSAnPGZvcm0gbmFtZT0iaGlzdG9yeUZvcm0iIGFjdGlvbj0iJytmaWxlKycjJyArIGZsZXhBcHBVcmwgKyAnIiBtZXRob2Q9IkdFVCI+PC9mb3JtPic7CiAgICAgICAgICAgICAgICAgICAgLy9nZXQgdGhlIGN1cnJlbnQgZWxlbWVudHMgYW5kIGFkZCB0aGVtIHRvIHRoZSBmb3JtCiAgICAgICAgICAgICAgICAgICAgdmFyIHFzID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHFzX2FyciA9IHFzLnNwbGl0KCImIik7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxc19hcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IHFzX2FycltpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0udHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLm5hbWUgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0udmFsdWUgPSB0bXBbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmZvcm1zLmhpc3RvcnlGb3JtLmFwcGVuZENoaWxkKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5mb3Jtcy5oaXN0b3J5Rm9ybS5zdWJtaXQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG9wLmxvY2F0aW9uLmhhc2ggPSBmbGV4QXBwVXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gV2UgYWxzbyBoYXZlIHRvIG1haW50YWluIHRoZSBoaXN0b3J5IGJ5IGhhbmQgZm9yIFNhZmFyaQogICAgICAgICAgICAgICAgaGlzdG9yeUhhc2hbaGlzdG9yeS5sZW5ndGhdID0gZmxleEFwcFVybDsKICAgICAgICAgICAgICAgIF9zdG9yZVN0YXRlcygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHRlbGwgdGhlIGJyb3dzZXIgdG8gZ28gdGhlcmUKICAgICAgICAgICAgICAgIHNldEhhc2goZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmFja1N0YWNrLnB1c2goY3JlYXRlU3RhdGUoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKSk7CiAgICB9CgogICAgZnVuY3Rpb24gX3N0b3JlU3RhdGVzKCkgewogICAgICAgIGlmIChicm93c2VyLnNhZmFyaSkgewogICAgICAgICAgICBnZXRSZW1lbWJlckVsZW1lbnQoKS52YWx1ZSA9IGhpc3RvcnlIYXNoLmpvaW4oIiwiKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQmFja0J1dHRvbigpIHsKICAgICAgICAvL1RoZSAiY3VycmVudCIgcGFnZSBpcyBhbHdheXMgYXQgdGhlIHRvcCBvZiB0aGUgaGlzdG9yeSBzdGFjay4KICAgICAgICB2YXIgY3VycmVudCA9IGJhY2tTdGFjay5wb3AoKTsKICAgICAgICBpZiAoIWN1cnJlbnQpIHsgcmV0dXJuOyB9CiAgICAgICAgdmFyIGxhc3QgPSBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICghbGFzdCAmJiBiYWNrU3RhY2subGVuZ3RoID09IDApewogICAgICAgICAgICBsYXN0ID0gaW5pdGlhbFN0YXRlOwogICAgICAgIH0KICAgICAgICBmb3J3YXJkU3RhY2sucHVzaChjdXJyZW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVGb3J3YXJkQnV0dG9uKCkgewogICAgICAgIC8vc3VtbWFyeTogcHJpdmF0ZSBtZXRob2QuIERvIG5vdCBjYWxsIHRoaXMgZGlyZWN0bHkuCgogICAgICAgIHZhciBsYXN0ID0gZm9yd2FyZFN0YWNrLnBvcCgpOwogICAgICAgIGlmICghbGFzdCkgeyByZXR1cm47IH0KICAgICAgICBiYWNrU3RhY2sucHVzaChsYXN0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVBcmJpdHJhcnlVcmwoKSB7CiAgICAgICAgLy9kZWxldGUgYWxsIHRoZSBoaXN0b3J5IGVudHJpZXMKICAgICAgICBmb3J3YXJkU3RhY2sgPSBbXTsKICAgIH0KCiAgICAvKiBDYWxsZWQgcGVyaW9kaWNhbGx5IHRvIHBvbGwgdG8gc2VlIGlmIHdlIG5lZWQgdG8gZGV0ZWN0IG5hdmlnYXRpb24gdGhhdCBoYXMgb2NjdXJyZWQgKi8KICAgIGZ1bmN0aW9uIGNoZWNrRm9yVXJsQ2hhbmdlKCkgewoKICAgICAgICBpZiAoYnJvd3Nlci5pZSkgewogICAgICAgICAgICBpZiAoY3VycmVudEhyZWYgIT0gZG9jdW1lbnQubG9jYXRpb24uaHJlZiAmJiBjdXJyZW50SHJlZiArICcjJyAhPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSB7CiAgICAgICAgICAgICAgICAvL1RoaXMgb2NjdXJzIHdoZW4gdGhlIHVzZXIgaGFzIG5hdmlnYXRlZCB0byBhIHNwZWNpZmljIFVSTAogICAgICAgICAgICAgICAgLy93aXRoaW4gdGhlIGFwcCwgYW5kIGRpZG4ndCB1c2UgYnJvd3NlciBiYWNrL2ZvcndhcmQKICAgICAgICAgICAgICAgIC8vSUUgc2VlbXMgdG8gaGF2ZSBhIGJ1ZyB3aGVyZSBpdCBzdG9wcyB1cGRhdGluZyB0aGUgVVJMIGl0CiAgICAgICAgICAgICAgICAvL3Nob3dzIHRoZSBlbmQtdXNlciBhdCB0aGlzIHBvaW50LCBidXQgcHJvZ3JhbWF0aWNhbGx5IGl0CiAgICAgICAgICAgICAgICAvL2FwcGVhcnMgdG8gYmUgY29ycmVjdC4gIERvIGEgZnVsbCBhcHAgcmVsb2FkIHRvIGdldCBhcm91bmQKICAgICAgICAgICAgICAgIC8vdGhpcyBpc3N1ZS4KICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPCA3KSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKCQkJCQlpZiAoZ2V0SGFzaCgpICE9IGdldElmcmFtZUhhc2goKSkgewoJCQkJCQkvLyB0aGlzLmlmcmFtZS5zcmMgPSB0aGlzLmJsYW5rVVJMICsgaGFzaDsKCQkJCQkJdmFyIHNvdXJjZVRvU2V0ID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ICsgZ2V0SGFzaCgpOwoJCQkJCQlnZXRIaXN0b3J5RnJhbWUoKS5zcmMgPSBzb3VyY2VUb1NldDsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwoJCQkJCX0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpICYmICFicm93c2VySGFzSGFzaENoYW5nZSkgewogICAgICAgICAgICAvLyBGb3IgU2FmYXJpLCB3ZSBoYXZlIHRvIGNoZWNrIHRvIHNlZSBpZiBoaXN0b3J5Lmxlbmd0aCBjaGFuZ2VkLgogICAgICAgICAgICBpZiAoY3VycmVudEhpc3RvcnlMZW5ndGggPj0gMCAmJiBoaXN0b3J5Lmxlbmd0aCAhPSBjdXJyZW50SGlzdG9yeUxlbmd0aCkgewogICAgICAgICAgICAgICAgLy9hbGVydCgiZGlkIGNoYW5nZTogIiArIGhpc3RvcnkubGVuZ3RoICsgIiwgIiArIGhpc3RvcnlIYXNoLmxlbmd0aCArICJ8IiArIGhpc3RvcnlIYXNoW2hpc3RvcnkubGVuZ3RoXSArICJ8PiIgKyBoaXN0b3J5SGFzaC5qb2luKCJ8IikpOwogICAgICAgICAgICAgICAgdmFyIGZsZXhBcHBVcmwgPSBnZXRIYXNoKCk7CiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci52ZXJzaW9uIDwgNTI4LjE2IC8qIEFueXRoaW5nIGVhcmxpZXIgdGhhbiBTYWZhcmkgNC4wICovKQogICAgICAgICAgICAgICAgeyAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBkaWQgY2hhbmdlIGFuZCB3ZSdyZSBydW5uaW5nIFNhZmFyaSAzLnggb3IgZWFybGllciwgCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiB3ZSBoYXZlIHRvIGxvb2sgdGhlIG9sZCBzdGF0ZSB1cCBpbiBvdXIgaGFuZC1tYWludGFpbmVkIAogICAgICAgICAgICAgICAgICAgIC8vIGFycmF5IHNpbmNlIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggd29uJ3QgaGF2ZSBjaGFuZ2VkLCAKICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGNhbGwgYmFjayBpbnRvIEJyb3dzZXJNYW5hZ2VyLgogICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmbGV4QXBwVXJsID0gaGlzdG9yeUhhc2hbY3VycmVudEhpc3RvcnlMZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vQURSOiB0byBmaXggbXVsdGlwbGUKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsW2ldLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBnZXRQbGF5ZXIoKS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3N0b3JlU3RhdGVzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGJyb3dzZXIuZmlyZWZveCAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRIcmVmICE9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIHsKICAgICAgICAgICAgICAgIHZhciBic2wgPSBiYWNrU3RhY2subGVuZ3RoOwoKICAgICAgICAgICAgICAgIHZhciB1cmxBY3Rpb25zID0gewogICAgICAgICAgICAgICAgICAgIGJhY2s6IGZhbHNlLCAKICAgICAgICAgICAgICAgICAgICBmb3J3YXJkOiBmYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmYWxzZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICgod2luZG93LmxvY2F0aW9uLmhhc2ggPT0gaW5pdGlhbEhhc2ggfHwgd2luZG93LmxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbEhyZWYpICYmIChic2wgPT0gMSkpIHsKICAgICAgICAgICAgICAgICAgICB1cmxBY3Rpb25zLmJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBjb3VsZCB0aGlzIGV2ZXIgYmUgYSBmb3J3YXJkIGJ1dHRvbj8KICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCBjbGVhciBpdCBiZWNhdXNlIHdlIHN0aWxsIG5lZWQgdG8gY2hlY2sgZm9yIGZvcndhcmRzLiBVZ2cuCiAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXJJbnRlcnZhbCh0aGlzLmxvY2F0aW9uVGltZXIpOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZUJhY2tCdXR0b24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gZmlyc3QgY2hlY2sgdG8gc2VlIGlmIHdlIGNvdWxkIGhhdmUgZ29uZSBmb3J3YXJkLiBXZSBhbHdheXMgaGFsdCBvbgogICAgICAgICAgICAgICAgLy8gYSBuby1oYXNoIGl0ZW0uCiAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZFN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZFN0YWNrW2ZvcndhcmRTdGFjay5sZW5ndGgtMV0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5mb3J3YXJkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9yd2FyZEJ1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBvaywgdGhhdCBkaWRuJ3Qgd29yaywgdHJ5IHNvbWVwbGFjZSBiYWNrIGluIHRoZSBoaXN0b3J5IHN0YWNrCiAgICAgICAgICAgICAgICBpZiAoKGJzbCA+PSAyKSAmJiAoYmFja1N0YWNrW2JzbCAtIDJdKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChiYWNrU3RhY2tbYnNsIC0gMl0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5iYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQmFja0J1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCF1cmxBY3Rpb25zLmJhY2sgJiYgIXVybEFjdGlvbnMuZm9yd2FyZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmb3VuZEluU3RhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICBiYWNrOiAtMSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcndhcmQ6IC0xCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJhY2tTdGFjay5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFja1N0YWNrW2ldLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpICYmIGkgIT0gKGJzbCAtIDIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmJpdHJhcnlVcmwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRJblN0YWNrcy5iYWNrID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZvcndhcmRTdGFjay5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZFN0YWNrW2ldLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpICYmIGkgIT0gKGJzbCAtIDIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmJpdHJhcnlVcmwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRJblN0YWNrcy5mb3J3YXJkID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYW5kbGVBcmJpdHJhcnlVcmwoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBGaXJlZm94IGNoYW5nZWQ7IGRvIGEgY2FsbGJhY2sgaW50byBCcm93c2VyTWFuYWdlciB0byB0ZWxsIGl0LgogICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgICAgICAgdmFyIGZsZXhBcHBVcmwgPSBnZXRIYXNoKCk7CiAgICAgICAgICAgICAgICAvL0FEUjogdG8gZml4IG11bHRpcGxlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlICE9ICJ1bmRlZmluZWQiICYmIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlID09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBwbFtpXS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZ2V0UGxheWVyKCkuYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB2YXIgX2luaXRpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgYnJvd3Nlckhhc0hhc2hDaGFuZ2UgPSAoIm9uaGFzaGNoYW5nZSIgaW4gZG9jdW1lbnQuYm9keSk7CiAgICAgICAgCiAgICAgICAgaWYgKGJyb3dzZXIuaWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2NyaXB0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHM7IHMgPSBzY3JpcHRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChzLnNyYy5pbmRleE9mKCJoaXN0b3J5LmpzIikgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpZnJhbWVfbG9jYXRpb24gPSAobmV3IFN0cmluZyhzLnNyYykpLnJlcGxhY2UoImhpc3RvcnkuanMiLCAiaGlzdG9yeUZyYW1lLmh0bWwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggPSBpZnJhbWVfbG9jYXRpb24gKyAiPyI7CiAgICAgICAgICAgIHZhciBzcmMgPSBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXg7CgogICAgICAgICAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaWZyYW1lIik7CiAgICAgICAgICAgIGlmcmFtZS5pZCA9ICdpZV9oaXN0b3J5RnJhbWUnOwogICAgICAgICAgICBpZnJhbWUubmFtZSA9ICdpZV9oaXN0b3J5RnJhbWUnOwogICAgICAgICAgICBpZnJhbWUuc3JjID0gJ2phdmFzY3JpcHQ6ZmFsc2U7JzsgCgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChicm93c2VyLnNhZmFyaSAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcmVtZW1iZXJEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgcmVtZW1iZXJEaXYuaWQgPSAnc2FmYXJpX3JlbWVtYmVyRGl2JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChyZW1lbWJlckRpdik7CiAgICAgICAgICAgIHJlbWVtYmVyRGl2LmlubmVySFRNTCA9ICc8aW5wdXQgdHlwZT0idGV4dCIgaWQ9InNhZmFyaV9yZW1lbWJlcl9maWVsZCIgc3R5bGU9IndpZHRoOiA1MDBweDsiPic7CgogICAgICAgICAgICB2YXIgZm9ybURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBmb3JtRGl2LmlkID0gJ3NhZmFyaV9mb3JtRGl2JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb3JtRGl2KTsKCiAgICAgICAgICAgIHZhciByZWxvYWRlcl9jb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHJlbG9hZGVyX2NvbnRlbnQuaWQgPSAnc2FmYXJpcmVsb2FkZXInOwogICAgICAgICAgICB2YXIgc2NyaXB0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHM7IHMgPSBzY3JpcHRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChzLnNyYy5pbmRleE9mKCJoaXN0b3J5LmpzIikgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIGh0bWwgPSAobmV3IFN0cmluZyhzLnNyYykpLnJlcGxhY2UoIi5qcyIsICIuaHRtbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbG9hZGVyX2NvbnRlbnQuaW5uZXJIVE1MID0gJzxpZnJhbWUgaWQ9InNhZmFyaXJlbG9hZGVyLWlmcmFtZSIgc3JjPSJhYm91dDpibGFuayIgZnJhbWVib3JkZXI9Im5vIiBzY3JvbGxpbmc9Im5vIj48L2lmcmFtZT4nOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHJlbG9hZGVyX2NvbnRlbnQpOwogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgcmVsb2FkZXJfY29udGVudC5zdHlsZS5sZWZ0ID0gcmVsb2FkZXJfY29udGVudC5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGlmcmFtZSA9IHJlbG9hZGVyX2NvbnRlbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpWzBdOwoKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzYWZhcmlfcmVtZW1iZXJfZmllbGQiKS52YWx1ZSAhPSAiIiApIHsKICAgICAgICAgICAgICAgIGhpc3RvcnlIYXNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNhZmFyaV9yZW1lbWJlcl9maWVsZCIpLnZhbHVlLnNwbGl0KCIsIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChicm93c2VySGFzSGFzaENoYW5nZSkgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5ib2R5Lm9uaGFzaGNoYW5nZSA9IGhhc2hDaGFuZ2VIYW5kbGVyOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgaGlzdG9yeUhhc2g6IGhpc3RvcnlIYXNoLCAKICAgICAgICBiYWNrU3RhY2s6IGZ1bmN0aW9uKCkgeyByZXR1cm4gYmFja1N0YWNrOyB9LCAKICAgICAgICBmb3J3YXJkU3RhY2s6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZm9yd2FyZFN0YWNrIH0sIAogICAgICAgIGdldFBsYXllcjogZ2V0UGxheWVyLCAKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihzcmMpIHsKICAgICAgICAgICAgX2luaXRpYWxpemUoc3JjKTsKICAgICAgICB9LCAKICAgICAgICBzZXRVUkw6IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgIH0sIAogICAgICAgIGdldFVSTDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgIH0sIAogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LnRpdGxlOwogICAgICAgIH0sIAogICAgICAgIHNldFRpdGxlOiBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXS50aXRsZSA9IHRpdGxlOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICAvL2lmIG9uIHNhZmFyaSwgc2V0IHRoZSB0aXRsZSB0byBiZSB0aGUgZW1wdHkgc3RyaW5nLiAKICAgICAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpKSB7CiAgICAgICAgICAgICAgICBpZiAodGl0bGUgPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSB3aW5kb3cubG9jYXRpb24uaHJlZi50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIHRpdGxlID0gdG1wLnN1YnN0cmluZygodG1wLmxhc3RJbmRleE9mKCIvIikrMSksIHRtcC5sYXN0SW5kZXhPZigiIyIpKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICAgICAgICB9LCAKICAgICAgICBzZXREZWZhdWx0VVJMOiBmdW5jdGlvbihkZWYpCiAgICAgICAgewogICAgICAgICAgICBkZWZhdWx0SGFzaCA9IGRlZjsKICAgICAgICAgICAgZGVmID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAvL3RyYWlsaW5nID8gaXMgaW1wb3J0YW50IGVsc2UgYW4gZXh0cmEgZnJhbWUgZ2V0cyBhZGRlZCB0byB0aGUgaGlzdG9yeQogICAgICAgICAgICAvL3doZW4gbmF2aWdhdGluZyBiYWNrIHRvIHRoZSBmaXJzdCBwYWdlLiAgQWx0ZXJuYXRpdmVseSBjb3VsZCBjaGVjawogICAgICAgICAgICAvL2luIGhpc3RvcnkgZnJhbWUgbmF2aWdhdGlvbiB0byBjb21wYXJlICMgYW5kID8uCiAgICAgICAgICAgIGlmIChicm93c2VyLmllKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3dbJ19pZV9maXJzdGxvYWQnXSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgc291cmNlVG9TZXQgPSBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggKyBkZWY7CiAgICAgICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGdldEhpc3RvcnlGcmFtZSgpLnNyYyA9IHNvdXJjZVRvU2V0OwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCIjIiArIGRlZik7CiAgICAgICAgICAgICAgICAgICAgc2V0SW50ZXJ2YWwoY2hlY2tGb3JVcmxDaGFuZ2UsIDUwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnVuYygpOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMoKTsgfSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChicm93c2VyLnNhZmFyaSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChoaXN0b3J5SGFzaC5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGhpc3RvcnlIYXNoW2N1cnJlbnRIaXN0b3J5TGVuZ3RoXSA9IGRlZjsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bG9jID0gIiMiICsgZGVmOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKG5ld2xvYyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vYWxlcnQoaGlzdG9yeUhhc2hbaGlzdG9yeUhhc2gubGVuZ3RoLTFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrRm9yVXJsQ2hhbmdlLCA1MCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYnJvd3Nlci5maXJlZm94IHx8IGJyb3dzZXIub3BlcmEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciByZWcgPSBuZXcgUmVnRXhwKCIjIiArIGRlZiArICIkIik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKCkubWF0Y2gocmVnKSkgewogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bG9jID0iIyIgKyBkZWY7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UobmV3bG9jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrRm9yVXJsQ2hhbmdlLCA1MCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwgCgogICAgICAgIC8qIFNldCB0aGUgY3VycmVudCBicm93c2VyIFVSTDsgY2FsbGVkIGZyb20gaW5zaWRlIEJyb3dzZXJNYW5hZ2VyIHRvIHByb3BhZ2F0ZQogICAgICAgICAqIHRoZSBhcHBsaWNhdGlvbiBzdGF0ZSBvdXQgdG8gdGhlIGNvbnRhaW5lci4KICAgICAgICAgKi8KICAgICAgICBzZXRCcm93c2VyVVJMOiBmdW5jdGlvbihmbGV4QXBwVXJsLCBvYmplY3RJZCkgewogICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiB0eXBlb2Ygb2JqZWN0SWQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRPYmplY3RJZCA9IG9iamVjdElkOwogICAgICAgICAgICB9CiAgICAgICAgICAgLy9mcm9tSWZyYW1lID0gZnJvbUlmcmFtZSB8fCBmYWxzZTsKICAgICAgICAgICAvL2Zyb21GbGV4ID0gZnJvbUZsZXggfHwgZmFsc2U7CiAgICAgICAgICAgLy9hbGVydCgic2V0QnJvd3NlclVSTDogIiArIGZsZXhBcHBVcmwpOwogICAgICAgICAgIC8vZmxleEFwcFVybCA9IChmbGV4QXBwVXJsID09ICIiKSA/IGRlZmF1bHRIYXNoIDogZmxleEFwcFVybCA7CgogICAgICAgICAgIHZhciBwb3MgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLmluZGV4T2YoJyMnKTsKICAgICAgICAgICB2YXIgYmFzZVVybCA9IHBvcyAhPSAtMSA/IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsIHBvcykgOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgIHZhciBuZXdVcmwgPSBiYXNlVXJsICsgJyMnICsgZmxleEFwcFVybDsKCiAgICAgICAgICAgaWYgKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgIT0gbmV3VXJsICYmIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgKyAnIycgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gbmV3VXJsOwogICAgICAgICAgICAgICBhZGRIaXN0b3J5RW50cnkoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICB9CiAgICAgICAgfSwgCgogICAgICAgIGJyb3dzZXJVUkxDaGFuZ2U6IGZ1bmN0aW9uKGZsZXhBcHBVcmwpIHsKICAgICAgICAgICAgdmFyIG9iamVjdElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgY3VycmVudE9iamVjdElkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIG9iamVjdElkID0gY3VycmVudE9iamVjdElkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlICE9ICJ1bmRlZmluZWQiICYmIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlID09IHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwbFtpXS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdldFBsYXllcihvYmplY3RJZCkuYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN1cnJlbnRPYmplY3RJZCA9IG51bGw7CiAgICAgICAgfSwKICAgICAgICBnZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgICB9LAogICAgICAgIGdldFBsYXRmb3JtOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybTsKICAgICAgICB9CgogICAgfQoKfSkoKTsKCi8vIEluaXRpYWxpemF0aW9uCgovLyBBdXRvbWF0ZWQgdW5pdCB0ZXN0aW5nIGFuZCBvdGhlciBkaWFnbm9zdGljcwoKZnVuY3Rpb24gc2V0VVJMKHVybCkKewogICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKfQoKZnVuY3Rpb24gYmFja0J1dHRvbigpCnsKICAgIGhpc3RvcnkuYmFjaygpOwp9CgpmdW5jdGlvbiBmb3J3YXJkQnV0dG9uKCkKewogICAgaGlzdG9yeS5mb3J3YXJkKCk7Cn0KCmZ1bmN0aW9uIGdvRm9yd2FyZE9yQmFja0luSGlzdG9yeShzdGVwKQp7CiAgICBoaXN0b3J5LmdvKHN0ZXApOwp9CgovL0Jyb3dzZXJIaXN0b3J5VXRpbHMuYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgeyBCcm93c2VySGlzdG9yeS5pbml0aWFsaXplKCk7IH0pOwooZnVuY3Rpb24oaSkgewogICAgdmFyIHUgPW5hdmlnYXRvci51c2VyQWdlbnQ7dmFyIGU9LypAY2Nfb24hQCovZmFsc2U7IAogICAgdmFyIHN0ID0gc2V0VGltZW91dDsKICAgIGlmKC93ZWJraXQvaS50ZXN0KHUpKXsKICAgICAgICBzdChmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgZHI9ZG9jdW1lbnQucmVhZHlTdGF0ZTsKICAgICAgICAgICAgaWYoZHI9PSJsb2FkZWQifHxkcj09ImNvbXBsZXRlIil7aSgpfQogICAgICAgICAgICBlbHNle3N0KGFyZ3VtZW50cy5jYWxsZWUsMTApO319LDEwKTsKICAgIH0gZWxzZSBpZigoL21vemlsbGEvaS50ZXN0KHUpJiYhLyhjb21wYXRpKS8udGVzdCh1KSkgfHwgKC9vcGVyYS9pLnRlc3QodSkpKXsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIixpLGZhbHNlKTsKICAgIH0gZWxzZSBpZihlKXsKICAgIChmdW5jdGlvbigpewogICAgICAgIHZhciB0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RvYzpyZHknKTsKICAgICAgICB0cnl7dC5kb1Njcm9sbCgnbGVmdCcpOwogICAgICAgICAgICBpKCk7dD1udWxsOwogICAgICAgIH1jYXRjaChlKXtzdChhcmd1bWVudHMuY2FsbGVlLDApO319KSgpOwogICAgfSBlbHNlewogICAgICAgIHdpbmRvdy5vbmxvYWQ9aTsKICAgIH0KfSkoIGZ1bmN0aW9uKCkge0Jyb3dzZXJIaXN0b3J5LmluaXRpYWxpemUoKTt9ICk7Cg==",
                "body": "QnJvd3Nlckhpc3RvcnlVdGlscyA9IHsKICAgIGFkZEV2ZW50OiBmdW5jdGlvbihlbG0sIGV2VHlwZSwgZm4sIHVzZUNhcHR1cmUpIHsKICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICBpZiAoZWxtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgZWxtLmFkZEV2ZW50TGlzdGVuZXIoZXZUeXBlLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbG0uYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHIgPSBlbG0uYXR0YWNoRXZlbnQoJ29uJyArIGV2VHlwZSwgZm4pOwogICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGVsbVsnb24nICsgZXZUeXBlXSA9IGZuOwogICAgICAgIH0KICAgIH0KfQoKQnJvd3Nlckhpc3RvcnkgPSAoZnVuY3Rpb24oKSB7CiAgICAvLyB0eXBlIG9mIGJyb3dzZXIKICAgIHZhciBicm93c2VyID0gewogICAgICAgIGllOiBmYWxzZSwgCiAgICAgICAgaWU4OiBmYWxzZSwgCiAgICAgICAgZmlyZWZveDogZmFsc2UsIAogICAgICAgIHNhZmFyaTogZmFsc2UsIAogICAgICAgIG9wZXJhOiBmYWxzZSwgCiAgICAgICAgdmVyc2lvbjogLTEKICAgIH07CgogICAgLy8gRGVmYXVsdCBhcHAgc3RhdGUgVVJMIHRvIHVzZSB3aGVuIG5vIGZyYWdtZW50IElEIHByZXNlbnQKICAgIHZhciBkZWZhdWx0SGFzaCA9ICcnOwoKICAgIC8vIExhc3Qta25vd24gYXBwIHN0YXRlIFVSTAogICAgdmFyIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKCiAgICAvLyBJbml0aWFsIFVSTCAodXNlZCBvbmx5IGJ5IElFKQogICAgdmFyIGluaXRpYWxIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKCiAgICAvLyBJbml0aWFsIFVSTCAodXNlZCBvbmx5IGJ5IElFKQogICAgdmFyIGluaXRpYWxIYXNoID0gZG9jdW1lbnQubG9jYXRpb24uaGFzaDsKCiAgICAvLyBIaXN0b3J5IGZyYW1lIHNvdXJjZSBVUkwgcHJlZml4ICh1c2VkIG9ubHkgYnkgSUUpCiAgICB2YXIgaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ID0gJ2hpc3RvcnkvaGlzdG9yeUZyYW1lLmh0bWw/JzsKCiAgICAvLyBIaXN0b3J5IG1haW50ZW5hbmNlICh1c2VkIG9ubHkgYnkgU2FmYXJpKQogICAgdmFyIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gLTE7CiAgICAKICAgIC8vIEZsYWcgdG8gZGVub3RlIHRoZSBleGlzdGVuY2Ugb2Ygb25oYXNoY2hhbmdlCiAgICB2YXIgYnJvd3Nlckhhc0hhc2hDaGFuZ2UgPSBmYWxzZTsKCiAgICB2YXIgaGlzdG9yeUhhc2ggPSBbXTsKCiAgICB2YXIgaW5pdGlhbFN0YXRlID0gY3JlYXRlU3RhdGUoaW5pdGlhbEhyZWYsIGluaXRpYWxIcmVmICsgJyMnICsgaW5pdGlhbEhhc2gsIGluaXRpYWxIYXNoKTsKCiAgICB2YXIgYmFja1N0YWNrID0gW107CiAgICB2YXIgZm9yd2FyZFN0YWNrID0gW107CgogICAgdmFyIGN1cnJlbnRPYmplY3RJZCA9IG51bGw7CgogICAgLy9Vc2VyQWdlbnQgZGV0ZWN0aW9uCiAgICB2YXIgdXNlcmFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwoKICAgIGlmICh1c2VyYWdlbnQuaW5kZXhPZigib3BlcmEiKSAhPSAtMSkgewogICAgICAgIGJyb3dzZXIub3BlcmEgPSB0cnVlOwogICAgfSBlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZigibXNpZSIpICE9IC0xKSB7CiAgICAgICAgYnJvd3Nlci5pZSA9IHRydWU7CiAgICAgICAgYnJvd3Nlci52ZXJzaW9uID0gcGFyc2VGbG9hdCh1c2VyYWdlbnQuc3Vic3RyaW5nKHVzZXJhZ2VudC5pbmRleE9mKCdtc2llJykgKyA0KSk7CiAgICAgICAgaWYgKGJyb3dzZXIudmVyc2lvbiA9PSA4KQogICAgICAgIHsKICAgICAgICAgICAgYnJvd3Nlci5pZSA9IGZhbHNlOwogICAgICAgICAgICBicm93c2VyLmllOCA9IHRydWU7CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZigic2FmYXJpIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLnNhZmFyaSA9IHRydWU7CiAgICAgICAgYnJvd3Nlci52ZXJzaW9uID0gcGFyc2VGbG9hdCh1c2VyYWdlbnQuc3Vic3RyaW5nKHVzZXJhZ2VudC5pbmRleE9mKCdzYWZhcmknKSArIDcpKTsKICAgIH0gZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoImdlY2tvIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLmZpcmVmb3ggPSB0cnVlOwogICAgfQoKICAgIGlmIChicm93c2VyLmllID09IHRydWUgJiYgYnJvd3Nlci52ZXJzaW9uID09IDcpIHsKICAgICAgICB3aW5kb3dbIl9pZV9maXJzdGxvYWQiXSA9IGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhc2hDaGFuZ2VIYW5kbGVyKCkKICAgIHsKICAgICAgICBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgdmFyIGZsZXhBcHBVcmwgPSBnZXRIYXNoKCk7CiAgICAgICAgLy9BRFI6IHRvIGZpeCBtdWx0aXBsZQogICAgICAgIGlmICh0eXBlb2YgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgPT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHBsW2ldLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRQbGF5ZXIoKS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBBY2Nlc3NvciBmdW5jdGlvbnMgZm9yIG9idGFpbmluZyBzcGVjaWZpYyBlbGVtZW50cyBvZiB0aGUgcGFnZS4KICAgIGZ1bmN0aW9uIGdldEhpc3RvcnlGcmFtZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpZV9oaXN0b3J5RnJhbWUnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGb3JtRWxlbWVudCgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYWZhcmlfZm9ybURpdicpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJlbWVtYmVyRWxlbWVudCgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzYWZhcmlfcmVtZW1iZXJfZmllbGQiKTsKICAgIH0KCiAgICAvLyBHZXQgdGhlIEZsYXNoIHBsYXllciBvYmplY3QgZm9yIHBlcmZvcm1pbmcgRXh0ZXJuYWxJbnRlcmZhY2UgY2FsbGJhY2tzLgogICAgLy8gVXBkYXRlZCBmb3IgY2hhbmdlcyB0byBTV0ZPYmplY3QyLgogICAgZnVuY3Rpb24gZ2V0UGxheWVyKGlkKSB7CiAgICAgICAgdmFyIGk7CgoJCWlmIChpZCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpIHsKCQkJdmFyIHIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CgkJCWlmICh0eXBlb2Ygci5TZXRWYXJpYWJsZSAhPSAidW5kZWZpbmVkIikgewoJCQkJcmV0dXJuIHI7CgkJCX0KCQkJZWxzZSB7CgkJCQl2YXIgbyA9IHIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9iamVjdCIpOwoJCQkJdmFyIGUgPSByLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJlbWJlZCIpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9baV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9baV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZVtpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVtpXTsKICAgICAgICAgICAgICAgIH0KCQkJfQoJCX0KCQllbHNlIHsKCQkJdmFyIG8gPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgib2JqZWN0Iik7CgkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImVtYmVkIik7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVbaV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9baV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCQl9CgkJcmV0dXJuIHVuZGVmaW5lZDsKCX0KICAgIAogICAgZnVuY3Rpb24gZ2V0UGxheWVycygpIHsKICAgICAgICB2YXIgaTsKICAgICAgICB2YXIgcGxheWVycyA9IFtdOwogICAgICAgIGlmIChwbGF5ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0bXAgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0bXAubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdG1wW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgcGxheWVycy5wdXNoKHRtcFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBsYXllcnMubGVuZ3RoID09IDAgfHwgcGxheWVyc1swXS5vYmplY3QgPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdG1wID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2VtYmVkJyk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0bXAubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdG1wW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgcGxheWVycy5wdXNoKHRtcFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBsYXllcnM7CiAgICB9CgoJZnVuY3Rpb24gZ2V0SWZyYW1lSGFzaCgpIHsKCQl2YXIgZG9jID0gZ2V0SGlzdG9yeUZyYW1lKCkuY29udGVudFdpbmRvdy5kb2N1bWVudDsKCQl2YXIgaGFzaCA9IFN0cmluZyhkb2MubG9jYXRpb24uc2VhcmNoKTsKCQlpZiAoaGFzaC5sZW5ndGggPT0gMSAmJiBoYXNoLmNoYXJBdCgwKSA9PSAiPyIpIHsKCQkJaGFzaCA9ICIiOwoJCX0KCQllbHNlIGlmIChoYXNoLmxlbmd0aCA+PSAyICYmIGhhc2guY2hhckF0KDApID09ICI/IikgewoJCQloYXNoID0gaGFzaC5zdWJzdHJpbmcoMSk7CgkJfQoJCXJldHVybiBoYXNoOwoJfQoKICAgIC8qIEdldCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoIGV4Y2x1ZGluZyB0aGUgJyMnIHN5bWJvbC4gKi8KICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAvLyBJdCB3b3VsZCBiZSBuaWNlIGlmIHdlIGNvdWxkIHVzZSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoIGhlcmUsCiAgICAgICAvLyBidXQgaXQncyBmYXVsdHkgc29tZXRpbWVzLgogICAgICAgdmFyIGlkeCA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuaW5kZXhPZignIycpOwogICAgICAgcmV0dXJuIChpZHggPj0gMCkgPyBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnN1YnN0cihpZHgrMSkgOiAnJzsKICAgIH0KCiAgICAvKiBHZXQgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaCBleGNsdWRpbmcgdGhlICcjJyBzeW1ib2wuICovCiAgICBmdW5jdGlvbiBzZXRIYXNoKGhhc2gpIHsKICAgICAgIC8vIEl0IHdvdWxkIGJlIG5pY2UgaWYgd2UgY291bGQgdXNlIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggaGVyZSwKICAgICAgIC8vIGJ1dCBpdCdzIGZhdWx0eSBzb21ldGltZXMuCiAgICAgICBpZiAoaGFzaCA9PSAnJykgaGFzaCA9ICcjJwogICAgICAgZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlU3RhdGUoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKSB7CiAgICAgICAgcmV0dXJuIHsgJ2Jhc2VVcmwnOiBiYXNlVXJsLCAnbmV3VXJsJzogbmV3VXJsLCAnZmxleEFwcFVybCc6IGZsZXhBcHBVcmwsICd0aXRsZSc6IG51bGwgfTsKICAgIH0KCiAgICAvKiBBZGQgYSBoaXN0b3J5IGVudHJ5IHRvIHRoZSBicm93c2VyLgogICAgICogICBiYXNlVXJsOiB0aGUgcG9ydGlvbiBvZiB0aGUgbG9jYXRpb24gcHJpb3IgdG8gdGhlICcjJwogICAgICogICBuZXdVcmw6IHRoZSBlbnRpcmUgbmV3IFVSTCwgaW5jbHVkaW5nICcjJyBhbmQgZm9sbG93aW5nIGZyYWdtZW50CiAgICAgKiAgIGZsZXhBcHBVcmw6IHRoZSBwb3J0aW9uIG9mIHRoZSBsb2NhdGlvbiBmb2xsb3dpbmcgdGhlICcjJyBvbmx5CiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkZEhpc3RvcnlFbnRyeShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpIHsKCiAgICAgICAgLy9kZWxldGUgYWxsIHRoZSBoaXN0b3J5IGVudHJpZXMKICAgICAgICBmb3J3YXJkU3RhY2sgPSBbXTsKCiAgICAgICAgaWYgKGJyb3dzZXIuaWUpIHsKICAgICAgICAgICAgLy9DaGVjayB0byBzZWUgaWYgd2UgYXJlIGJlaW5nIGFza2VkIHRvIGRvIGEgbmF2aWdhdGUgZm9yIHRoZSBmaXJzdAogICAgICAgICAgICAvL2hpc3RvcnkgZW50cnksIGFuZCBpZiBzbyBpZ25vcmUsIGJlY2F1c2UgaXQncyBjb21pbmcgZnJvbSB0aGUgY3JlYXRpb24KICAgICAgICAgICAgLy9vZiB0aGUgaGlzdG9yeSBpZnJhbWUKICAgICAgICAgICAgaWYgKGZsZXhBcHBVcmwgPT0gZGVmYXVsdEhhc2ggJiYgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9PSBpbml0aWFsSHJlZiAmJiB3aW5kb3dbJ19pZV9maXJzdGxvYWQnXSkgewogICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBpbml0aWFsSHJlZjsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKCFmbGV4QXBwVXJsIHx8IGZsZXhBcHBVcmwgPT0gZGVmYXVsdEhhc2gpICYmIHdpbmRvd1snX2llX2ZpcnN0bG9hZCddKSB7CiAgICAgICAgICAgICAgICBuZXdVcmwgPSBiYXNlVXJsICsgJyMnICsgZGVmYXVsdEhhc2g7CiAgICAgICAgICAgICAgICBmbGV4QXBwVXJsID0gZGVmYXVsdEhhc2g7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBmb3IgSUUsIHRlbGwgdGhlIGhpc3RvcnkgZnJhbWUgdG8gZ28gc29tZXdoZXJlIHdpdGhvdXQgYSAnIycKICAgICAgICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGdldCB0aGlzIGVudHJ5IGludG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgICAgICAgICAgICAgIGdldEhpc3RvcnlGcmFtZSgpLnNyYyA9IGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeCArIGZsZXhBcHBVcmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SGFzaChmbGV4QXBwVXJsKTsKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy9BRFIKICAgICAgICAgICAgaWYgKGJhY2tTdGFjay5sZW5ndGggPT0gMCAmJiBpbml0aWFsU3RhdGUuZmxleEFwcFVybCA9PSBmbGV4QXBwVXJsKSB7CiAgICAgICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBjcmVhdGVTdGF0ZShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpOwogICAgICAgICAgICB9IGVsc2UgaWYoYmFja1N0YWNrLmxlbmd0aCA+IDAgJiYgYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXS5mbGV4QXBwVXJsID09IGZsZXhBcHBVcmwpIHsKICAgICAgICAgICAgICAgIGJhY2tTdGFja1tiYWNrU3RhY2subGVuZ3RoIC0gMV0gPSBjcmVhdGVTdGF0ZShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkgJiYgIWJyb3dzZXJIYXNIYXNoQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICAvLyBmb3IgU2FmYXJpLCBzdWJtaXQgYSBmb3JtIHdob3NlIGFjdGlvbiBwb2ludHMgdG8gdGhlIGRlc2lyZWQgVVJMCiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci52ZXJzaW9uIDw9IDQxOS4zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpbGUgPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICBmaWxlID0gZmlsZS5zdWJzdHJpbmcoZmlsZS5sYXN0SW5kZXhPZigiLyIpKzEpOwogICAgICAgICAgICAgICAgICAgIGdldEZvcm1FbGVtZW50KCkuaW5uZXJIVE1MID0gJzxmb3JtIG5hbWU9Imhpc3RvcnlGb3JtIiBhY3Rpb249IicrZmlsZSsnIycgKyBmbGV4QXBwVXJsICsgJyIgbWV0aG9kPSJHRVQiPjwvZm9ybT4nOwogICAgICAgICAgICAgICAgICAgIC8vZ2V0IHRoZSBjdXJyZW50IGVsZW1lbnRzIGFuZCBhZGQgdGhlbSB0byB0aGUgZm9ybQogICAgICAgICAgICAgICAgICAgIHZhciBxcyA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgICAgIHZhciBxc19hcnIgPSBxcy5zcGxpdCgiJiIpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXNfYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSBxc19hcnJbaV0uc3BsaXQoIj0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnR5cGUgPSAiaGlkZGVuIjsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5uYW1lID0gdG1wWzBdOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdG1wWzFdOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5mb3Jtcy5oaXN0b3J5Rm9ybS5hcHBlbmRDaGlsZChlbGVtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZm9ybXMuaGlzdG9yeUZvcm0uc3VibWl0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvcC5sb2NhdGlvbi5oYXNoID0gZmxleEFwcFVybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFdlIGFsc28gaGF2ZSB0byBtYWludGFpbiB0aGUgaGlzdG9yeSBieSBoYW5kIGZvciBTYWZhcmkKICAgICAgICAgICAgICAgIGhpc3RvcnlIYXNoW2hpc3RvcnkubGVuZ3RoXSA9IGZsZXhBcHBVcmw7CiAgICAgICAgICAgICAgICBfc3RvcmVTdGF0ZXMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwganVzdCB0ZWxsIHRoZSBicm93c2VyIHRvIGdvIHRoZXJlCiAgICAgICAgICAgICAgICBzZXRIYXNoKGZsZXhBcHBVcmwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJhY2tTdGFjay5wdXNoKGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIF9zdG9yZVN0YXRlcygpIHsKICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkpIHsKICAgICAgICAgICAgZ2V0UmVtZW1iZXJFbGVtZW50KCkudmFsdWUgPSBoaXN0b3J5SGFzaC5qb2luKCIsIik7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUJhY2tCdXR0b24oKSB7CiAgICAgICAgLy9UaGUgImN1cnJlbnQiIHBhZ2UgaXMgYWx3YXlzIGF0IHRoZSB0b3Agb2YgdGhlIGhpc3Rvcnkgc3RhY2suCiAgICAgICAgdmFyIGN1cnJlbnQgPSBiYWNrU3RhY2sucG9wKCk7CiAgICAgICAgaWYgKCFjdXJyZW50KSB7IHJldHVybjsgfQogICAgICAgIHZhciBsYXN0ID0gYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXTsKICAgICAgICBpZiAoIWxhc3QgJiYgYmFja1N0YWNrLmxlbmd0aCA9PSAwKXsKICAgICAgICAgICAgbGFzdCA9IGluaXRpYWxTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZm9yd2FyZFN0YWNrLnB1c2goY3VycmVudCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlRm9yd2FyZEJ1dHRvbigpIHsKICAgICAgICAvL3N1bW1hcnk6IHByaXZhdGUgbWV0aG9kLiBEbyBub3QgY2FsbCB0aGlzIGRpcmVjdGx5LgoKICAgICAgICB2YXIgbGFzdCA9IGZvcndhcmRTdGFjay5wb3AoKTsKICAgICAgICBpZiAoIWxhc3QpIHsgcmV0dXJuOyB9CiAgICAgICAgYmFja1N0YWNrLnB1c2gobGFzdCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQXJiaXRyYXJ5VXJsKCkgewogICAgICAgIC8vZGVsZXRlIGFsbCB0aGUgaGlzdG9yeSBlbnRyaWVzCiAgICAgICAgZm9yd2FyZFN0YWNrID0gW107CiAgICB9CgogICAgLyogQ2FsbGVkIHBlcmlvZGljYWxseSB0byBwb2xsIHRvIHNlZSBpZiB3ZSBuZWVkIHRvIGRldGVjdCBuYXZpZ2F0aW9uIHRoYXQgaGFzIG9jY3VycmVkICovCiAgICBmdW5jdGlvbiBjaGVja0ZvclVybENoYW5nZSgpIHsKCiAgICAgICAgaWYgKGJyb3dzZXIuaWUpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRIcmVmICE9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgJiYgY3VycmVudEhyZWYgKyAnIycgIT0gZG9jdW1lbnQubG9jYXRpb24uaHJlZikgewogICAgICAgICAgICAgICAgLy9UaGlzIG9jY3VycyB3aGVuIHRoZSB1c2VyIGhhcyBuYXZpZ2F0ZWQgdG8gYSBzcGVjaWZpYyBVUkwKICAgICAgICAgICAgICAgIC8vd2l0aGluIHRoZSBhcHAsIGFuZCBkaWRuJ3QgdXNlIGJyb3dzZXIgYmFjay9mb3J3YXJkCiAgICAgICAgICAgICAgICAvL0lFIHNlZW1zIHRvIGhhdmUgYSBidWcgd2hlcmUgaXQgc3RvcHMgdXBkYXRpbmcgdGhlIFVSTCBpdAogICAgICAgICAgICAgICAgLy9zaG93cyB0aGUgZW5kLXVzZXIgYXQgdGhpcyBwb2ludCwgYnV0IHByb2dyYW1hdGljYWxseSBpdAogICAgICAgICAgICAgICAgLy9hcHBlYXJzIHRvIGJlIGNvcnJlY3QuICBEbyBhIGZ1bGwgYXBwIHJlbG9hZCB0byBnZXQgYXJvdW5kCiAgICAgICAgICAgICAgICAvL3RoaXMgaXNzdWUuCiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci52ZXJzaW9uIDwgNykgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5yZWxvYWQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkJCQkJaWYgKGdldEhhc2goKSAhPSBnZXRJZnJhbWVIYXNoKCkpIHsKCQkJCQkJLy8gdGhpcy5pZnJhbWUuc3JjID0gdGhpcy5ibGFua1VSTCArIGhhc2g7CgkJCQkJCXZhciBzb3VyY2VUb1NldCA9IGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeCArIGdldEhhc2goKTsKCQkJCQkJZ2V0SGlzdG9yeUZyYW1lKCkuc3JjID0gc291cmNlVG9TZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKCQkJCQl9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChicm93c2VyLnNhZmFyaSAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgLy8gRm9yIFNhZmFyaSwgd2UgaGF2ZSB0byBjaGVjayB0byBzZWUgaWYgaGlzdG9yeS5sZW5ndGggY2hhbmdlZC4KICAgICAgICAgICAgaWYgKGN1cnJlbnRIaXN0b3J5TGVuZ3RoID49IDAgJiYgaGlzdG9yeS5sZW5ndGggIT0gY3VycmVudEhpc3RvcnlMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vYWxlcnQoImRpZCBjaGFuZ2U6ICIgKyBoaXN0b3J5Lmxlbmd0aCArICIsICIgKyBoaXN0b3J5SGFzaC5sZW5ndGggKyAifCIgKyBoaXN0b3J5SGFzaFtoaXN0b3J5Lmxlbmd0aF0gKyAifD4iICsgaGlzdG9yeUhhc2guam9pbigifCIpKTsKICAgICAgICAgICAgICAgIHZhciBmbGV4QXBwVXJsID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIudmVyc2lvbiA8IDUyOC4xNiAvKiBBbnl0aGluZyBlYXJsaWVyIHRoYW4gU2FmYXJpIDQuMCAqLykKICAgICAgICAgICAgICAgIHsgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgaXQgZGlkIGNoYW5nZSBhbmQgd2UncmUgcnVubmluZyBTYWZhcmkgMy54IG9yIGVhcmxpZXIsIAogICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gd2UgaGF2ZSB0byBsb29rIHRoZSBvbGQgc3RhdGUgdXAgaW4gb3VyIGhhbmQtbWFpbnRhaW5lZCAKICAgICAgICAgICAgICAgICAgICAvLyBhcnJheSBzaW5jZSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoIHdvbid0IGhhdmUgY2hhbmdlZCwgCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiBjYWxsIGJhY2sgaW50byBCcm93c2VyTWFuYWdlci4KICAgICAgICAgICAgICAgIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gaGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZmxleEFwcFVybCA9IGhpc3RvcnlIYXNoW2N1cnJlbnRIaXN0b3J5TGVuZ3RoXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvL0FEUjogdG8gZml4IG11bHRpcGxlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlICE9ICJ1bmRlZmluZWQiICYmIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlID09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBwbFtpXS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZ2V0UGxheWVyKCkuYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF9zdG9yZVN0YXRlcygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChicm93c2VyLmZpcmVmb3ggJiYgIWJyb3dzZXJIYXNIYXNoQ2hhbmdlKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50SHJlZiAhPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSB7CiAgICAgICAgICAgICAgICB2YXIgYnNsID0gYmFja1N0YWNrLmxlbmd0aDsKCiAgICAgICAgICAgICAgICB2YXIgdXJsQWN0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICBiYWNrOiBmYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgZm9yd2FyZDogZmFsc2UsIAogICAgICAgICAgICAgICAgICAgIHNldDogZmFsc2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoKHdpbmRvdy5sb2NhdGlvbi5oYXNoID09IGluaXRpYWxIYXNoIHx8IHdpbmRvdy5sb2NhdGlvbi5ocmVmID09IGluaXRpYWxIcmVmKSAmJiAoYnNsID09IDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5iYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogY291bGQgdGhpcyBldmVyIGJlIGEgZm9yd2FyZCBidXR0b24/CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgY2xlYXIgaXQgYmVjYXVzZSB3ZSBzdGlsbCBuZWVkIHRvIGNoZWNrIGZvciBmb3J3YXJkcy4gVWdnLgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFySW50ZXJ2YWwodGhpcy5sb2NhdGlvblRpbWVyKTsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVCYWNrQnV0dG9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIGZpcnN0IGNoZWNrIHRvIHNlZSBpZiB3ZSBjb3VsZCBoYXZlIGdvbmUgZm9yd2FyZC4gV2UgYWx3YXlzIGhhbHQgb24KICAgICAgICAgICAgICAgIC8vIGEgbm8taGFzaCBpdGVtLgogICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFja1tmb3J3YXJkU3RhY2subGVuZ3RoLTFdLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybEFjdGlvbnMuZm9yd2FyZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcndhcmRCdXR0b24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gb2ssIHRoYXQgZGlkbid0IHdvcmssIHRyeSBzb21lcGxhY2UgYmFjayBpbiB0aGUgaGlzdG9yeSBzdGFjawogICAgICAgICAgICAgICAgaWYgKChic2wgPj0gMikgJiYgKGJhY2tTdGFja1tic2wgLSAyXSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFja1N0YWNrW2JzbCAtIDJdLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybEFjdGlvbnMuYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUJhY2tCdXR0b24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghdXJsQWN0aW9ucy5iYWNrICYmICF1cmxBY3Rpb25zLmZvcndhcmQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmRJblN0YWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFjazogLTEsIAogICAgICAgICAgICAgICAgICAgICAgICBmb3J3YXJkOiAtMQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiYWNrU3RhY2subGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2tTdGFja1tpXS5mbGV4QXBwVXJsID09IGdldEhhc2goKSAmJiBpICE9IChic2wgLSAyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJiaXRyYXJ5VXJsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSW5TdGFja3MuYmFjayA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmb3J3YXJkU3RhY2subGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFja1tpXS5mbGV4QXBwVXJsID09IGdldEhhc2goKSAmJiBpICE9IChic2wgLSAyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJiaXRyYXJ5VXJsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSW5TdGFja3MuZm9yd2FyZCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlQXJiaXRyYXJ5VXJsKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmlyZWZveCBjaGFuZ2VkOyBkbyBhIGNhbGxiYWNrIGludG8gQnJvd3Nlck1hbmFnZXIgdG8gdGVsbCBpdC4KICAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgICAgIHZhciBmbGV4QXBwVXJsID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAgICAgLy9BRFI6IHRvIGZpeCBtdWx0aXBsZQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsID0gZ2V0UGxheWVycygpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGdldFBsYXllcigpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdmFyIF9pbml0aWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGJyb3dzZXJIYXNIYXNoQ2hhbmdlID0gKCJvbmhhc2hjaGFuZ2UiIGluIGRvY3VtZW50LmJvZHkpOwogICAgICAgIAogICAgICAgIGlmIChicm93c2VyLmllKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzOyBzID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocy5zcmMuaW5kZXhPZigiaGlzdG9yeS5qcyIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWZyYW1lX2xvY2F0aW9uID0gKG5ldyBTdHJpbmcocy5zcmMpKS5yZXBsYWNlKCJoaXN0b3J5LmpzIiwgImhpc3RvcnlGcmFtZS5odG1sIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ID0gaWZyYW1lX2xvY2F0aW9uICsgIj8iOwogICAgICAgICAgICB2YXIgc3JjID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4OwoKICAgICAgICAgICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpOwogICAgICAgICAgICBpZnJhbWUuaWQgPSAnaWVfaGlzdG9yeUZyYW1lJzsKICAgICAgICAgICAgaWZyYW1lLm5hbWUgPSAnaWVfaGlzdG9yeUZyYW1lJzsKICAgICAgICAgICAgaWZyYW1lLnNyYyA9ICdqYXZhc2NyaXB0OmZhbHNlOyc7IAoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkgJiYgIWJyb3dzZXJIYXNIYXNoQ2hhbmdlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHJlbWVtYmVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIHJlbWVtYmVyRGl2LmlkID0gJ3NhZmFyaV9yZW1lbWJlckRpdic7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocmVtZW1iZXJEaXYpOwogICAgICAgICAgICByZW1lbWJlckRpdi5pbm5lckhUTUwgPSAnPGlucHV0IHR5cGU9InRleHQiIGlkPSJzYWZhcmlfcmVtZW1iZXJfZmllbGQiIHN0eWxlPSJ3aWR0aDogNTAwcHg7Ij4nOwoKICAgICAgICAgICAgdmFyIGZvcm1EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZm9ybURpdi5pZCA9ICdzYWZhcmlfZm9ybURpdic7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybURpdik7CgogICAgICAgICAgICB2YXIgcmVsb2FkZXJfY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LmlkID0gJ3NhZmFyaXJlbG9hZGVyJzsKICAgICAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzOyBzID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocy5zcmMuaW5kZXhPZigiaGlzdG9yeS5qcyIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICBodG1sID0gKG5ldyBTdHJpbmcocy5zcmMpKS5yZXBsYWNlKCIuanMiLCAiLmh0bWwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LmlubmVySFRNTCA9ICc8aWZyYW1lIGlkPSJzYWZhcmlyZWxvYWRlci1pZnJhbWUiIHNyYz0iYWJvdXQ6YmxhbmsiIGZyYW1lYm9yZGVyPSJubyIgc2Nyb2xsaW5nPSJubyI+PC9pZnJhbWU+JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChyZWxvYWRlcl9jb250ZW50KTsKICAgICAgICAgICAgcmVsb2FkZXJfY29udGVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHJlbG9hZGVyX2NvbnRlbnQuc3R5bGUubGVmdCA9IHJlbG9hZGVyX2NvbnRlbnQuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBpZnJhbWUgPSByZWxvYWRlcl9jb250ZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXTsKCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2FmYXJpX3JlbWVtYmVyX2ZpZWxkIikudmFsdWUgIT0gIiIgKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5SGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzYWZhcmlfcmVtZW1iZXJfZmllbGQiKS52YWx1ZS5zcGxpdCgiLCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlckhhc0hhc2hDaGFuZ2UpICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5vbmhhc2hjaGFuZ2UgPSBoYXNoQ2hhbmdlSGFuZGxlcjsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGhpc3RvcnlIYXNoOiBoaXN0b3J5SGFzaCwgCiAgICAgICAgYmFja1N0YWNrOiBmdW5jdGlvbigpIHsgcmV0dXJuIGJhY2tTdGFjazsgfSwgCiAgICAgICAgZm9yd2FyZFN0YWNrOiBmdW5jdGlvbigpIHsgcmV0dXJuIGZvcndhcmRTdGFjayB9LCAKICAgICAgICBnZXRQbGF5ZXI6IGdldFBsYXllciwgCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oc3JjKSB7CiAgICAgICAgICAgIF9pbml0aWFsaXplKHNyYyk7CiAgICAgICAgfSwgCiAgICAgICAgc2V0VVJMOiBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICB9LCAKICAgICAgICBnZXRVUkw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICB9LCAKICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC50aXRsZTsKICAgICAgICB9LCAKICAgICAgICBzZXRUaXRsZTogZnVuY3Rpb24odGl0bGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGJhY2tTdGFja1tiYWNrU3RhY2subGVuZ3RoIC0gMV0udGl0bGUgPSB0aXRsZTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7IH0KICAgICAgICAgICAgLy9pZiBvbiBzYWZhcmksIHNldCB0aGUgdGl0bGUgdG8gYmUgdGhlIGVtcHR5IHN0cmluZy4gCiAgICAgICAgICAgIGlmIChicm93c2VyLnNhZmFyaSkgewogICAgICAgICAgICAgICAgaWYgKHRpdGxlID09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gd2luZG93LmxvY2F0aW9uLmhyZWYudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IHRtcC5zdWJzdHJpbmcoKHRtcC5sYXN0SW5kZXhPZigiLyIpKzEpLCB0bXAubGFzdEluZGV4T2YoIiMiKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlID0gIiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gdGl0bGU7CiAgICAgICAgfSwgCiAgICAgICAgc2V0RGVmYXVsdFVSTDogZnVuY3Rpb24oZGVmKQogICAgICAgIHsKICAgICAgICAgICAgZGVmYXVsdEhhc2ggPSBkZWY7CiAgICAgICAgICAgIGRlZiA9IGdldEhhc2goKTsKICAgICAgICAgICAgLy90cmFpbGluZyA/IGlzIGltcG9ydGFudCBlbHNlIGFuIGV4dHJhIGZyYW1lIGdldHMgYWRkZWQgdG8gdGhlIGhpc3RvcnkKICAgICAgICAgICAgLy93aGVuIG5hdmlnYXRpbmcgYmFjayB0byB0aGUgZmlyc3QgcGFnZS4gIEFsdGVybmF0aXZlbHkgY291bGQgY2hlY2sKICAgICAgICAgICAgLy9pbiBoaXN0b3J5IGZyYW1lIG5hdmlnYXRpb24gdG8gY29tcGFyZSAjIGFuZCA/LgogICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2luZG93WydfaWVfZmlyc3Rsb2FkJ10gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHNvdXJjZVRvU2V0ID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ICsgZGVmOwogICAgICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBnZXRIaXN0b3J5RnJhbWUoKS5zcmMgPSBzb3VyY2VUb1NldDsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZSgiIyIgKyBkZWYpOwogICAgICAgICAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrRm9yVXJsQ2hhbmdlLCA1MCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZ1bmMoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jKCk7IH0sIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gaGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoaGlzdG9yeUhhc2gubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgICBoaXN0b3J5SGFzaFtjdXJyZW50SGlzdG9yeUxlbmd0aF0gPSBkZWY7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2xvYyA9ICIjIiArIGRlZjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShuZXdsb2MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvL2FsZXJ0KGhpc3RvcnlIYXNoW2hpc3RvcnlIYXNoLmxlbmd0aC0xXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChjaGVja0ZvclVybENoYW5nZSwgNTApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJyb3dzZXIuZmlyZWZveCB8fCBicm93c2VyLm9wZXJhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cCgiIyIgKyBkZWYgKyAiJCIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpLm1hdGNoKHJlZykpIHsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2xvYyA9IiMiICsgZGVmOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKG5ld2xvYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChjaGVja0ZvclVybENoYW5nZSwgNTApOwogICAgICAgICAgICB9CgogICAgICAgIH0sIAoKICAgICAgICAvKiBTZXQgdGhlIGN1cnJlbnQgYnJvd3NlciBVUkw7IGNhbGxlZCBmcm9tIGluc2lkZSBCcm93c2VyTWFuYWdlciB0byBwcm9wYWdhdGUKICAgICAgICAgKiB0aGUgYXBwbGljYXRpb24gc3RhdGUgb3V0IHRvIHRoZSBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgc2V0QnJvd3NlclVSTDogZnVuY3Rpb24oZmxleEFwcFVybCwgb2JqZWN0SWQpIHsKICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgdHlwZW9mIG9iamVjdElkICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50T2JqZWN0SWQgPSBvYmplY3RJZDsKICAgICAgICAgICAgfQogICAgICAgICAgIC8vZnJvbUlmcmFtZSA9IGZyb21JZnJhbWUgfHwgZmFsc2U7CiAgICAgICAgICAgLy9mcm9tRmxleCA9IGZyb21GbGV4IHx8IGZhbHNlOwogICAgICAgICAgIC8vYWxlcnQoInNldEJyb3dzZXJVUkw6ICIgKyBmbGV4QXBwVXJsKTsKICAgICAgICAgICAvL2ZsZXhBcHBVcmwgPSAoZmxleEFwcFVybCA9PSAiIikgPyBkZWZhdWx0SGFzaCA6IGZsZXhBcHBVcmwgOwoKICAgICAgICAgICB2YXIgcG9zID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJyk7CiAgICAgICAgICAgdmFyIGJhc2VVcmwgPSBwb3MgIT0gLTEgPyBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnN1YnN0cigwLCBwb3MpIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICAgICB2YXIgbmV3VXJsID0gYmFzZVVybCArICcjJyArIGZsZXhBcHBVcmw7CgogICAgICAgICAgIGlmIChkb2N1bWVudC5sb2NhdGlvbi5ocmVmICE9IG5ld1VybCAmJiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmICsgJyMnICE9IG5ld1VybCkgewogICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IG5ld1VybDsKICAgICAgICAgICAgICAgYWRkSGlzdG9yeUVudHJ5KGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gaGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgfQogICAgICAgIH0sIAoKICAgICAgICBicm93c2VyVVJMQ2hhbmdlOiBmdW5jdGlvbihmbGV4QXBwVXJsKSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChicm93c2VyLmllICYmIGN1cnJlbnRPYmplY3RJZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBvYmplY3RJZCA9IGN1cnJlbnRPYmplY3RJZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBnZXRQbGF5ZXIob2JqZWN0SWQpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50T2JqZWN0SWQgPSBudWxsOwogICAgICAgIH0sCiAgICAgICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgfSwKICAgICAgICBnZXRQbGF0Zm9ybTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm07CiAgICAgICAgfQoKICAgIH0KCn0pKCk7CgovLyBJbml0aWFsaXphdGlvbgoKLy8gQXV0b21hdGVkIHVuaXQgdGVzdGluZyBhbmQgb3RoZXIgZGlhZ25vc3RpY3MKCmZ1bmN0aW9uIHNldFVSTCh1cmwpCnsKICAgIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7Cn0KCmZ1bmN0aW9uIGJhY2tCdXR0b24oKQp7CiAgICBoaXN0b3J5LmJhY2soKTsKfQoKZnVuY3Rpb24gZm9yd2FyZEJ1dHRvbigpCnsKICAgIGhpc3RvcnkuZm9yd2FyZCgpOwp9CgpmdW5jdGlvbiBnb0ZvcndhcmRPckJhY2tJbkhpc3Rvcnkoc3RlcCkKewogICAgaGlzdG9yeS5nbyhzdGVwKTsKfQoKLy9Ccm93c2VySGlzdG9yeVV0aWxzLmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsgQnJvd3Nlckhpc3RvcnkuaW5pdGlhbGl6ZSgpOyB9KTsKKGZ1bmN0aW9uKGkpIHsKICAgIHZhciB1ID1uYXZpZ2F0b3IudXNlckFnZW50O3ZhciBlPS8qQGNjX29uIUAqL2ZhbHNlOyAKICAgIHZhciBzdCA9IHNldFRpbWVvdXQ7CiAgICBpZigvd2Via2l0L2kudGVzdCh1KSl7CiAgICAgICAgc3QoZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGRyPWRvY3VtZW50LnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGlmKGRyPT0ibG9hZGVkInx8ZHI9PSJjb21wbGV0ZSIpe2koKX0KICAgICAgICAgICAgZWxzZXtzdChhcmd1bWVudHMuY2FsbGVlLDEwKTt9fSwxMCk7CiAgICB9IGVsc2UgaWYoKC9tb3ppbGxhL2kudGVzdCh1KSYmIS8oY29tcGF0aSkvLnRlc3QodSkpIHx8ICgvb3BlcmEvaS50ZXN0KHUpKSl7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsaSxmYWxzZSk7CiAgICB9IGVsc2UgaWYoZSl7CiAgICAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkb2M6cmR5Jyk7CiAgICAgICAgdHJ5e3QuZG9TY3JvbGwoJ2xlZnQnKTsKICAgICAgICAgICAgaSgpO3Q9bnVsbDsKICAgICAgICB9Y2F0Y2goZSl7c3QoYXJndW1lbnRzLmNhbGxlZSwwKTt9fSkoKTsKICAgIH0gZWxzZXsKICAgICAgICB3aW5kb3cub25sb2FkPWk7CiAgICB9Cn0pKCBmdW5jdGlvbigpIHtCcm93c2VySGlzdG9yeS5pbml0aWFsaXplKCk7fSApOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 22:23:36 GMT",
                    "Content-Length": "24650",
                    "Date": "Thu, 06 Nov 2014 22:23:37 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}