{
    "url": "http://localhost:9999/david-driscoll/thrust/dist/debug/thrust.all.libraries.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>parent.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>this.name = parent.name;</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/david-driscoll/thrust/dist/debug/thrust.all.libraries.js",
                "path": "/david-driscoll/thrust/dist/debug/thrust.all.libraries.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZpZC1kcmlzY29sbC90aHJ1c3QvZGlzdC9kZWJ1Zy90aHJ1c3QuYWxsLmxpYnJhcmllcy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjQ2OTI1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDIwOjA1OjI4IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAyMDowNToyNyBHTVQNCg0KLyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KLyoqCiAqIEBsaWNlbnNlCiAqIExvLURhc2ggMS4wLjAtcmMuMyA8aHR0cDovL2xvZGFzaC5jb20vPgogKiBDb3B5cmlnaHQgMjAxMi0yMDEzIFRoZSBEb2pvIEZvdW5kYXRpb24gPGh0dHA6Ly9kb2pvZm91bmRhdGlvbi5vcmcvPgogKiBCYXNlZCBvbiBVbmRlcnNjb3JlLmpzIDEuNC4zIDxodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8+CiAqIENvcHlyaWdodCAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KICogQXZhaWxhYmxlIHVuZGVyIE1JVCBsaWNlbnNlIDxodHRwOi8vbG9kYXNoLmNvbS9saWNlbnNlPgogKi8KOyhmdW5jdGlvbih3aW5kb3csIHVuZGVmaW5lZCkgewoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGV4cG9ydHNgICovCiAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0czsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBnbG9iYWxgIGFuZCB1c2UgaXQgYXMgYHdpbmRvd2AgKi8KICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwogIGlmIChmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCkgewogICAgd2luZG93ID0gZnJlZUdsb2JhbDsKICB9CgogIC8qKiBVc2VkIGZvciBhcnJheSBhbmQgb2JqZWN0IG1ldGhvZCByZWZlcmVuY2VzICovCiAgdmFyIGFycmF5UmVmID0gW10sCiAgICAgIG9iamVjdFJlZiA9IHt9OwoKICAvKiogVXNlZCB0byBnZW5lcmF0ZSB1bmlxdWUgSURzICovCiAgdmFyIGlkQ291bnRlciA9IDA7CgogIC8qKiBVc2VkIGludGVybmFsbHkgdG8gaW5kaWNhdGUgdmFyaW91cyB0aGluZ3MgKi8KICB2YXIgaW5kaWNhdG9yT2JqZWN0ID0gb2JqZWN0UmVmOwoKICAvKiogVXNlZCBieSBgY2FjaGVkQ29udGFpbnNgIGFzIHRoZSBkZWZhdWx0IHNpemUgd2hlbiBvcHRpbWl6YXRpb25zIGFyZSBlbmFibGVkIGZvciBsYXJnZSBhcnJheXMgKi8KICB2YXIgbGFyZ2VBcnJheVNpemUgPSAzMDsKCiAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgbm9Db25mbGljdGAgKi8KICB2YXIgb2xkRGFzaCA9IHdpbmRvdy5fOwoKICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGVudGl0aWVzICovCiAgdmFyIHJlRXNjYXBlZEh0bWwgPSAvJig/OmFtcHxsdHxndHxxdW90fCN4MjcpOy9nOwoKICAvKiogVXNlZCB0byBtYXRjaCBlbXB0eSBzdHJpbmcgbGl0ZXJhbHMgaW4gY29tcGlsZWQgdGVtcGxhdGUgc291cmNlICovCiAgdmFyIHJlRW1wdHlTdHJpbmdMZWFkaW5nID0gL1xiX19wIFwrPSAnJzsvZywKICAgICAgcmVFbXB0eVN0cmluZ01pZGRsZSA9IC9cYihfX3AgXCs9KSAnJyBcKy9nLAogICAgICByZUVtcHR5U3RyaW5nVHJhaWxpbmcgPSAvKF9fZVwoLio/XCl8XGJfX3RcKSkgXCtcbicnOy9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGlmIGEgbWV0aG9kIGlzIG5hdGl2ZSAqLwogIHZhciByZU5hdGl2ZSA9IFJlZ0V4cCgnXicgKwogICAgKG9iamVjdFJlZi52YWx1ZU9mICsgJycpCiAgICAgIC5yZXBsYWNlKC9bLiorP149IToke30oKXxbXF1cL1xcXS9nLCAnXFwkJicpCiAgICAgIC5yZXBsYWNlKC92YWx1ZU9mfGZvciBbXlxdXSsvZywgJy4rPycpICsgJyQnCiAgKTsKCiAgLyoqCiAgICogVXNlZCB0byBtYXRjaCBFUzYgdGVtcGxhdGUgZGVsaW1pdGVycwogICAqIGh0dHA6Ly9wZW9wbGUubW96aWxsYS5vcmcvfmpvcmVuZG9yZmYvZXM2LWRyYWZ0Lmh0bWwjc2VjLTcuOC42CiAgICovCiAgdmFyIHJlRXNUZW1wbGF0ZSA9IC9cJFx7KCg/Oig/PVxcPylcXD9bXHNcU10pKj8pfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCAiaW50ZXJwb2xhdGUiIHRlbXBsYXRlIGRlbGltaXRlcnMgKi8KICB2YXIgcmVJbnRlcnBvbGF0ZSA9IC88JT0oW1xzXFNdKz8pJT4vZzsKCiAgLyoqIFVzZWQgdG8gZW5zdXJlIGNhcHR1cmluZyBvcmRlciBvZiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlTm9NYXRjaCA9IC8oJF4pLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggSFRNTCBjaGFyYWN0ZXJzICovCiAgdmFyIHJlVW5lc2NhcGVkSHRtbCA9IC9bJjw+IiddL2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHVuZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciByZVVuZXNjYXBlZFN0cmluZyA9IC9bJ1xuXHJcdFx1MjAyOFx1MjAyOVxcXS9nOwoKICAvKiogVXNlZCB0byBmaXggdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZyAqLwogIHZhciBzaGFkb3dlZCA9IFsKICAgICdjb25zdHJ1Y3RvcicsICdoYXNPd25Qcm9wZXJ0eScsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICd0b0xvY2FsZVN0cmluZycsICd0b1N0cmluZycsICd2YWx1ZU9mJwogIF07CgogIC8qKiBVc2VkIHRvIG1ha2UgdGVtcGxhdGUgc291cmNlVVJMcyBlYXNpZXIgdG8gaWRlbnRpZnkgKi8KICB2YXIgdGVtcGxhdGVDb3VudGVyID0gMDsKCiAgLyoqIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzICovCiAgdmFyIGNlaWwgPSBNYXRoLmNlaWwsCiAgICAgIGNvbmNhdCA9IGFycmF5UmVmLmNvbmNhdCwKICAgICAgZmxvb3IgPSBNYXRoLmZsb29yLAogICAgICBnZXRQcm90b3R5cGVPZiA9IHJlTmF0aXZlLnRlc3QoZ2V0UHJvdG90eXBlT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YpICYmIGdldFByb3RvdHlwZU9mLAogICAgICBoYXNPd25Qcm9wZXJ0eSA9IG9iamVjdFJlZi5oYXNPd25Qcm9wZXJ0eSwKICAgICAgcHVzaCA9IGFycmF5UmVmLnB1c2gsCiAgICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gb2JqZWN0UmVmLnByb3BlcnR5SXNFbnVtZXJhYmxlLAogICAgICB0b1N0cmluZyA9IG9iamVjdFJlZi50b1N0cmluZzsKCiAgLyogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgZm9yIG1ldGhvZHMgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIG90aGVyIGBsb2Rhc2hgIG1ldGhvZHMgKi8KICB2YXIgbmF0aXZlQmluZCA9IHJlTmF0aXZlLnRlc3QobmF0aXZlQmluZCA9IHNsaWNlLmJpbmQpICYmIG5hdGl2ZUJpbmQsCiAgICAgIG5hdGl2ZUlzQXJyYXkgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KSAmJiBuYXRpdmVJc0FycmF5LAogICAgICBuYXRpdmVJc0Zpbml0ZSA9IHdpbmRvdy5pc0Zpbml0ZSwKICAgICAgbmF0aXZlSXNOYU4gPSB3aW5kb3cuaXNOYU4sCiAgICAgIG5hdGl2ZUtleXMgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUtleXMgPSBPYmplY3Qua2V5cykgJiYgbmF0aXZlS2V5cywKICAgICAgbmF0aXZlTWF4ID0gTWF0aC5tYXgsCiAgICAgIG5hdGl2ZU1pbiA9IE1hdGgubWluLAogICAgICBuYXRpdmVSYW5kb20gPSBNYXRoLnJhbmRvbTsKCiAgLyoqIGBPYmplY3QjdG9TdHJpbmdgIHJlc3VsdCBzaG9ydGN1dHMgKi8KICB2YXIgYXJnc0NsYXNzID0gJ1tvYmplY3QgQXJndW1lbnRzXScsCiAgICAgIGFycmF5Q2xhc3MgPSAnW29iamVjdCBBcnJheV0nLAogICAgICBib29sQ2xhc3MgPSAnW29iamVjdCBCb29sZWFuXScsCiAgICAgIGRhdGVDbGFzcyA9ICdbb2JqZWN0IERhdGVdJywKICAgICAgZnVuY0NsYXNzID0gJ1tvYmplY3QgRnVuY3Rpb25dJywKICAgICAgbnVtYmVyQ2xhc3MgPSAnW29iamVjdCBOdW1iZXJdJywKICAgICAgb2JqZWN0Q2xhc3MgPSAnW29iamVjdCBPYmplY3RdJywKICAgICAgcmVnZXhwQ2xhc3MgPSAnW29iamVjdCBSZWdFeHBdJywKICAgICAgc3RyaW5nQ2xhc3MgPSAnW29iamVjdCBTdHJpbmddJzsKCiAgLyoqIERldGVjdCB2YXJpb3VzIGVudmlyb25tZW50cyAqLwogIHZhciBpc0llT3BlcmEgPSAhIXdpbmRvdy5hdHRhY2hFdmVudCwKICAgICAgaXNWOCA9IG5hdGl2ZUJpbmQgJiYgIS9cbnx0cnVlLy50ZXN0KG5hdGl2ZUJpbmQgKyBpc0llT3BlcmEpOwoKICAvKiBEZXRlY3QgaWYgYEZ1bmN0aW9uI2JpbmRgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoYWxsIGJ1dCBWOCkgKi8KICB2YXIgaXNCaW5kRmFzdCA9IG5hdGl2ZUJpbmQgJiYgIWlzVjg7CgogIC8qIERldGVjdCBpZiBgT2JqZWN0LmtleXNgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoSUUsIE9wZXJhLCBWOCkgKi8KICB2YXIgaXNLZXlzRmFzdCA9IG5hdGl2ZUtleXMgJiYgKGlzSWVPcGVyYSB8fCBpc1Y4KTsKCiAgLyoqCiAgICogRGV0ZWN0IHRoZSBKU2NyaXB0IFtbRG9udEVudW1dXSBidWc6CiAgICoKICAgKiBJbiBJRSA8IDkgYW4gb2JqZWN0cyBvd24gcHJvcGVydGllcywgc2hhZG93aW5nIG5vbi1lbnVtZXJhYmxlIG9uZXMsIGFyZQogICAqIG1hZGUgbm9uLWVudW1lcmFibGUgYXMgd2VsbC4KICAgKi8KICB2YXIgaGFzRG9udEVudW1CdWc7CgogIC8qKiBEZXRlY3QgaWYgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGFmdGVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIChJRSA8IDkpICovCiAgdmFyIGl0ZXJhdGVzT3duTGFzdDsKCiAgLyoqCiAgICogRGV0ZWN0IGlmIGBBcnJheSNzaGlmdGAgYW5kIGBBcnJheSNzcGxpY2VgIGF1Z21lbnQgYXJyYXktbGlrZSBvYmplY3RzCiAgICogaW5jb3JyZWN0bHk6CiAgICoKICAgKiBGaXJlZm94IDwgMTAsIElFIGNvbXBhdGliaWxpdHkgbW9kZSwgYW5kIElFIDwgOSBoYXZlIGJ1Z2d5IEFycmF5IGBzaGlmdCgpYAogICAqIGFuZCBgc3BsaWNlKClgIGZ1bmN0aW9ucyB0aGF0IGZhaWwgdG8gcmVtb3ZlIHRoZSBsYXN0IGVsZW1lbnQsIGB2YWx1ZVswXWAsCiAgICogb2YgYXJyYXktbGlrZSBvYmplY3RzIGV2ZW4gdGhvdWdoIHRoZSBgbGVuZ3RoYCBwcm9wZXJ0eSBpcyBzZXQgdG8gYDBgLgogICAqIFRoZSBgc2hpZnQoKWAgbWV0aG9kIGlzIGJ1Z2d5IGluIElFIDggY29tcGF0aWJpbGl0eSBtb2RlLCB3aGlsZSBgc3BsaWNlKClgCiAgICogaXMgYnVnZ3kgcmVnYXJkbGVzcyBvZiBtb2RlIGluIElFIDwgOSBhbmQgYnVnZ3kgaW4gY29tcGF0aWJpbGl0eSBtb2RlIGluIElFIDkuCiAgICovCiAgdmFyIGhhc09iamVjdFNwbGljZUJ1ZyA9IChoYXNPYmplY3RTcGxpY2VCdWcgPSB7ICcwJzogMSwgJ2xlbmd0aCc6IDEgfSwKICAgIGFycmF5UmVmLnNwbGljZS5jYWxsKGhhc09iamVjdFNwbGljZUJ1ZywgMCwgMSksIGhhc09iamVjdFNwbGljZUJ1Z1swXSk7CgogIC8qKiBEZXRlY3QgaWYgYW4gYGFyZ3VtZW50c2Agb2JqZWN0J3MgaW5kZXhlcyBhcmUgbm9uLWVudW1lcmFibGUgKElFIDwgOSkgKi8KICB2YXIgbm9uRW51bUFyZ3MgPSB0cnVlOwoKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgcHJvcHMgPSBbXTsKICAgIGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMueCA9IDE7IH0KICAgIGN0b3IucHJvdG90eXBlID0geyAndmFsdWVPZic6IDEsICd5JzogMSB9OwogICAgZm9yICh2YXIgcHJvcCBpbiBuZXcgY3RvcikgeyBwcm9wcy5wdXNoKHByb3ApOyB9CiAgICBmb3IgKHByb3AgaW4gYXJndW1lbnRzKSB7IG5vbkVudW1BcmdzID0gIXByb3A7IH0KCiAgICBoYXNEb250RW51bUJ1ZyA9ICEvdmFsdWVPZi8udGVzdChwcm9wcyk7CiAgICBpdGVyYXRlc093bkxhc3QgPSBwcm9wc1swXSAhPSAneCc7CiAgfSgxKSk7CgogIC8qKiBEZXRlY3QgaWYgYGFyZ3VtZW50c2Agb2JqZWN0cyBhcmUgYE9iamVjdGAgb2JqZWN0cyAoYWxsIGJ1dCBPcGVyYSA8IDEwLjUpICovCiAgdmFyIGFyZ3NBcmVPYmplY3RzID0gYXJndW1lbnRzLmNvbnN0cnVjdG9yID09IE9iamVjdDsKCiAgLyoqIERldGVjdCBpZiBgYXJndW1lbnRzYCBvYmplY3RzIFtbQ2xhc3NdXSBpcyB1bnJlc29sdmFibGUgKEZpcmVmb3ggPCA0LCBJRSA8IDkpICovCiAgdmFyIG5vQXJnc0NsYXNzID0gIWlzQXJndW1lbnRzKGFyZ3VtZW50cyk7CgogIC8qKgogICAqIERldGVjdCBsYWNrIG9mIHN1cHBvcnQgZm9yIGFjY2Vzc2luZyBzdHJpbmcgY2hhcmFjdGVycyBieSBpbmRleDoKICAgKgogICAqIElFIDwgOCBjYW4ndCBhY2Nlc3MgY2hhcmFjdGVycyBieSBpbmRleCBhbmQgSUUgOCBjYW4gb25seSBhY2Nlc3MKICAgKiBjaGFyYWN0ZXJzIGJ5IGluZGV4IG9uIHN0cmluZyBsaXRlcmFscy4KICAgKi8KICB2YXIgbm9DaGFyQnlJbmRleCA9ICgneCdbMF0gKyBPYmplY3QoJ3gnKVswXSkgIT0gJ3h4JzsKCiAgLyoqCiAgICogRGV0ZWN0IGlmIGEgbm9kZSdzIFtbQ2xhc3NdXSBpcyB1bnJlc29sdmFibGUgKElFIDwgOSkKICAgKiBhbmQgdGhhdCB0aGUgSlMgZW5naW5lIHdvbid0IGVycm9yIHdoZW4gYXR0ZW1wdGluZyB0byBjb2VyY2UgYW4gb2JqZWN0IHRvCiAgICogYSBzdHJpbmcgd2l0aG91dCBhIGB0b1N0cmluZ2AgZnVuY3Rpb24uCiAgICovCiAgdHJ5IHsKICAgIHZhciBub05vZGVDbGFzcyA9IHRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09IG9iamVjdENsYXNzICYmICEoeyAndG9TdHJpbmcnOiAwIH0gKyAnJyk7CiAgfSBjYXRjaChlKSB7IH0KCiAgLyoqIFVzZWQgdG8gaWRlbnRpZnkgb2JqZWN0IGNsYXNzaWZpY2F0aW9ucyB0aGF0IGBfLmNsb25lYCBzdXBwb3J0cyAqLwogIHZhciBjbG9uZWFibGVDbGFzc2VzID0ge307CiAgY2xvbmVhYmxlQ2xhc3Nlc1tmdW5jQ2xhc3NdID0gZmFsc2U7CiAgY2xvbmVhYmxlQ2xhc3Nlc1thcmdzQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1thcnJheUNsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tib29sQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tkYXRlQ2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW251bWJlckNsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbb2JqZWN0Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW3JlZ2V4cENsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbc3RyaW5nQ2xhc3NdID0gdHJ1ZTsKCiAgLyoqIFVzZWQgdG8gbG9va3VwIGEgYnVpbHQtaW4gY29uc3RydWN0b3IgYnkgW1tDbGFzc11dICovCiAgdmFyIGN0b3JCeUNsYXNzID0ge307CiAgY3RvckJ5Q2xhc3NbYXJyYXlDbGFzc10gPSBBcnJheTsKICBjdG9yQnlDbGFzc1tib29sQ2xhc3NdID0gQm9vbGVhbjsKICBjdG9yQnlDbGFzc1tkYXRlQ2xhc3NdID0gRGF0ZTsKICBjdG9yQnlDbGFzc1tvYmplY3RDbGFzc10gPSBPYmplY3Q7CiAgY3RvckJ5Q2xhc3NbbnVtYmVyQ2xhc3NdID0gTnVtYmVyOwogIGN0b3JCeUNsYXNzW3JlZ2V4cENsYXNzXSA9IFJlZ0V4cDsKICBjdG9yQnlDbGFzc1tzdHJpbmdDbGFzc10gPSBTdHJpbmc7CgogIC8qKiBVc2VkIHRvIGRldGVybWluZSBpZiB2YWx1ZXMgYXJlIG9mIHRoZSBsYW5ndWFnZSB0eXBlIE9iamVjdCAqLwogIHZhciBvYmplY3RUeXBlcyA9IHsKICAgICdib29sZWFuJzogZmFsc2UsCiAgICAnZnVuY3Rpb24nOiB0cnVlLAogICAgJ29iamVjdCc6IHRydWUsCiAgICAnbnVtYmVyJzogZmFsc2UsCiAgICAnc3RyaW5nJzogZmFsc2UsCiAgICAndW5kZWZpbmVkJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciBzdHJpbmdFc2NhcGVzID0gewogICAgJ1xcJzogJ1xcJywKICAgICInIjogIiciLAogICAgJ1xuJzogJ24nLAogICAgJ1xyJzogJ3InLAogICAgJ1x0JzogJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0LCB0aGF0IHdyYXBzIHRoZSBnaXZlbiBgdmFsdWVgLCB0byBlbmFibGUgbWV0aG9kCiAgICogY2hhaW5pbmcuCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBMby1EYXNoIG1ldGhvZHMsIHdyYXBwZXJzIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGBBcnJheWAgbWV0aG9kczoKICAgKiBgY29uY2F0YCwgYGpvaW5gLCBgcG9wYCwgYHB1c2hgLCBgcmV2ZXJzZWAsIGBzaGlmdGAsIGBzbGljZWAsIGBzb3J0YCwgYHNwbGljZWAsCiAgICogYW5kIGB1bnNoaWZ0YAogICAqCiAgICogVGhlIGNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICogYGFmdGVyYCwgYGFzc2lnbmAsIGBiaW5kYCwgYGJpbmRBbGxgLCBgYmluZEtleWAsIGBjaGFpbmAsIGBjb21wYWN0YCwgYGNvbXBvc2VgLAogICAqIGBjb25jYXRgLCBgY291bnRCeWAsIGBkZWJvdW5jZWAsIGBkZWZhdWx0c2AsIGBkZWZlcmAsIGBkZWxheWAsIGBkaWZmZXJlbmNlYCwKICAgKiBgZmlsdGVyYCwgYGZsYXR0ZW5gLCBgZm9yRWFjaGAsIGBmb3JJbmAsIGBmb3JPd25gLCBgZnVuY3Rpb25zYCwgYGdyb3VwQnlgLAogICAqIGBpbml0aWFsYCwgYGludGVyc2VjdGlvbmAsIGBpbnZlcnRgLCBgaW52b2tlYCwgYGtleXNgLCBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwKICAgKiBgbWVyZ2VgLCBgbWluYCwgYG9iamVjdGAsIGBvbWl0YCwgYG9uY2VgLCBgcGFpcnNgLCBgcGFydGlhbGAsIGBwYXJ0aWFsUmlnaHRgLAogICAqIGBwaWNrYCwgYHBsdWNrYCwgYHB1c2hgLCBgcmFuZ2VgLCBgcmVqZWN0YCwgYHJlc3RgLCBgcmV2ZXJzZWAsIGBzaHVmZmxlYCwKICAgKiBgc2xpY2VgLCBgc29ydGAsIGBzb3J0QnlgLCBgc3BsaWNlYCwgYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwKICAgKiBgdW5pb25gLCBgdW5pcWAsIGB1bnNoaWZ0YCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLCBhbmQgYHppcGAKICAgKgogICAqIFRoZSBub24tY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgKiBgY2xvbmVgLCBgY2xvbmVEZWVwYCwgYGNvbnRhaW5zYCwgYGVzY2FwZWAsIGBldmVyeWAsIGBmaW5kYCwgYGhhc2AsIGBpZGVudGl0eWAsCiAgICogYGluZGV4T2ZgLCBgaXNBcmd1bWVudHNgLCBgaXNBcnJheWAsIGBpc0Jvb2xlYW5gLCBgaXNEYXRlYCwgYGlzRWxlbWVudGAsIGBpc0VtcHR5YCwKICAgKiBgaXNFcXVhbGAsIGBpc0Zpbml0ZWAsIGBpc0Z1bmN0aW9uYCwgYGlzTmFOYCwgYGlzTnVsbGAsIGBpc051bWJlcmAsIGBpc09iamVjdGAsCiAgICogYGlzUGxhaW5PYmplY3RgLCBgaXNSZWdFeHBgLCBgaXNTdHJpbmdgLCBgaXNVbmRlZmluZWRgLCBgam9pbmAsIGBsYXN0SW5kZXhPZmAsCiAgICogYG1peGluYCwgYG5vQ29uZmxpY3RgLCBgcG9wYCwgYHJhbmRvbWAsIGByZWR1Y2VgLCBgcmVkdWNlUmlnaHRgLCBgcmVzdWx0YCwKICAgKiBgc2hpZnRgLCBgc2l6ZWAsIGBzb21lYCwgYHNvcnRlZEluZGV4YCwgYHRlbXBsYXRlYCwgYHVuZXNjYXBlYCwgYW5kIGB1bmlxdWVJZGAKICAgKgogICAqIFRoZSB3cmFwcGVyIGZ1bmN0aW9ucyBgZmlyc3RgIGFuZCBgbGFzdGAgcmV0dXJuIHdyYXBwZWQgdmFsdWVzIHdoZW4gYG5gIGlzCiAgICogcGFzc2VkLCBvdGhlcndpc2UgdGhleSByZXR1cm4gdW53cmFwcGVkIHZhbHVlcy4KICAgKgogICAqIEBuYW1lIF8KICAgKiBAY29uc3RydWN0b3IKICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcCBpbiBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgKi8KICBmdW5jdGlvbiBsb2Rhc2godmFsdWUpIHsKICAgIC8vIGV4aXQgZWFybHkgaWYgYWxyZWFkeSB3cmFwcGVkLCBldmVuIGlmIHdyYXBwZWQgYnkgYSBkaWZmZXJlbnQgYGxvZGFzaGAgY29uc3RydWN0b3IKICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdmFsdWUuX193cmFwcGVkX18pIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgLy8gYWxsb3cgaW52b2tpbmcgYGxvZGFzaGAgd2l0aG91dCB0aGUgYG5ld2Agb3BlcmF0b3IKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBsb2Rhc2gpKSB7CiAgICAgIHJldHVybiBuZXcgbG9kYXNoKHZhbHVlKTsKICAgIH0KICAgIHRoaXMuX193cmFwcGVkX18gPSB2YWx1ZTsKICB9CgogIC8qKgogICAqIEJ5IGRlZmF1bHQsIHRoZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzIHVzZWQgYnkgTG8tRGFzaCBhcmUgc2ltaWxhciB0byB0aG9zZSBpbgogICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAqIGRlbGltaXRlcnMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBPYmplY3QKICAgKi8KICBsb2Rhc2gudGVtcGxhdGVTZXR0aW5ncyA9IHsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICovCiAgICAnZXNjYXBlJzogLzwlLShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgY29kZSB0byBiZSBldmFsdWF0ZWQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBpbmplY3QuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdpbnRlcnBvbGF0ZSc6IHJlSW50ZXJwb2xhdGUsCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgICd2YXJpYWJsZSc6ICcnLAoKICAgIC8qKgogICAgICogVXNlZCB0byBpbXBvcnQgdmFyaWFibGVzIGludG8gdGhlIGNvbXBpbGVkIHRlbXBsYXRlLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICAnaW1wb3J0cyc6IHsKCiAgICAgIC8qKgogICAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MuaW1wb3J0cwogICAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICAgKi8KICAgICAgJ18nOiBsb2Rhc2gKICAgIH0KICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIHRlbXBsYXRlIHVzZWQgdG8gY3JlYXRlIGl0ZXJhdG9yIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dC4KICAgKi8KICB2YXIgaXRlcmF0b3JUZW1wbGF0ZSA9IHRlbXBsYXRlKAogICAgLy8gdGhlIGBpdGVyYWJsZWAgbWF5IGJlIHJlYXNzaWduZWQgYnkgdGhlIGB0b3BgIHNuaXBwZXQKICAgICd2YXIgaW5kZXgsIGl0ZXJhYmxlID0gPCU9IGZpcnN0QXJnICU+LCAnICsKICAgIC8vIGFzc2lnbiB0aGUgYHJlc3VsdGAgdmFyaWFibGUgYW4gaW5pdGlhbCB2YWx1ZQogICAgJ3Jlc3VsdCA9IDwlPSBmaXJzdEFyZyAlPjtcbicgKwogICAgLy8gZXhpdCBlYXJseSBpZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgZmFsc2V5CiAgICAnaWYgKCE8JT0gZmlyc3RBcmcgJT4pIHJldHVybiByZXN1bHQ7XG4nICsKICAgIC8vIGFkZCBjb2RlIGJlZm9yZSB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzCiAgICAnPCU9IHRvcCAlPjtcbicgKwoKICAgIC8vIGFycmF5LWxpa2UgaXRlcmF0aW9uOgogICAgJzwlIGlmIChhcnJheXMpIHsgJT4nICsKICAgICd2YXIgbGVuZ3RoID0gaXRlcmFibGUubGVuZ3RoOyBpbmRleCA9IC0xO1xuJyArCiAgICAiaWYgKDwlPSBhcnJheXMgJT4pIHsiICsKCiAgICAvLyBhZGQgc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4IGlmIG5lZWRlZAogICAgJyAgPCUgaWYgKG5vQ2hhckJ5SW5kZXgpIHsgJT5cbicgKwogICAgJyAgaWYgKGlzU3RyaW5nKGl0ZXJhYmxlKSkge1xuJyArCiAgICAiICAgIGl0ZXJhYmxlID0gaXRlcmFibGUuc3BsaXQoJycpXG4iICsKICAgICcgIH0nICsKICAgICcgIDwlIH0gJT5cbicgKwoKICAgIC8vIGl0ZXJhdGUgb3ZlciB0aGUgYXJyYXktbGlrZSB2YWx1ZQogICAgJyAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICA8JT0gbG9vcCAlPlxuJyArCiAgICAnICB9XG4nICsKICAgICd9XG4nICsKICAgICdlbHNlIHsnICsKCiAgICAvLyBvYmplY3QgaXRlcmF0aW9uOgogICAgLy8gYWRkIHN1cHBvcnQgZm9yIGl0ZXJhdGluZyBvdmVyIGBhcmd1bWVudHNgIG9iamVjdHMgaWYgbmVlZGVkCiAgICAnICA8JSAgfSBlbHNlIGlmIChub25FbnVtQXJncykgeyAlPlxuJyArCiAgICAnICB2YXIgbGVuZ3RoID0gaXRlcmFibGUubGVuZ3RoOyBpbmRleCA9IC0xO1xuJyArCiAgICAnICBpZiAobGVuZ3RoICYmIGlzQXJndW1lbnRzKGl0ZXJhYmxlKSkge1xuJyArCiAgICAnICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7XG4nICsKICAgICIgICAgICBpbmRleCArPSAnJztcbiIgKwogICAgJyAgICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgICAgfVxuJyArCiAgICAnICB9IGVsc2UgeycgKwogICAgJyAgPCUgfSAlPicgKwoKICAgIC8vIEZpcmVmb3ggPCAzLjYsIE9wZXJhID4gOS41MCAtIE9wZXJhIDwgMTEuNjAsIGFuZCBTYWZhcmkgPCA1LjEKICAgIC8vIChpZiB0aGUgcHJvdG90eXBlIG9yIGEgcHJvcGVydHkgb24gdGhlIHByb3RvdHlwZSBoYXMgYmVlbiBzZXQpCiAgICAvLyBpbmNvcnJlY3RseSBzZXRzIGEgZnVuY3Rpb24ncyBgcHJvdG90eXBlYCBwcm9wZXJ0eSBbW0VudW1lcmFibGVdXQogICAgLy8gdmFsdWUgdG8gYHRydWVgLiBCZWNhdXNlIG9mIHRoaXMgTG8tRGFzaCBzdGFuZGFyZGl6ZXMgb24gc2tpcHBpbmcKICAgIC8vIHRoZSB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkgb2YgZnVuY3Rpb25zIHJlZ2FyZGxlc3Mgb2YgaXRzCiAgICAvLyBbW0VudW1lcmFibGVdXSB2YWx1ZS4KICAgICcgIDwlIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT5cbicgKwogICAgIiAgdmFyIHNraXBQcm90byA9IHR5cGVvZiBpdGVyYWJsZSA9PSAnZnVuY3Rpb24nICYmIFxuIiArCiAgICAiICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoaXRlcmFibGUsICdwcm90b3R5cGUnKTtcbiIgKwogICAgJyAgPCUgfSAlPicgKwoKICAgIC8vIGl0ZXJhdGUgb3duIHByb3BlcnRpZXMgdXNpbmcgYE9iamVjdC5rZXlzYCBpZiBpdCdzIGZhc3QKICAgICcgIDwlIGlmIChpc0tleXNGYXN0ICYmIHVzZUhhcykgeyAlPlxuJyArCiAgICAnICB2YXIgb3duSW5kZXggPSAtMSxcbicgKwogICAgJyAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSA/IG5hdGl2ZUtleXMoaXRlcmFibGUpIDogW10sXG4nICsKICAgICcgICAgICBsZW5ndGggPSBvd25Qcm9wcy5sZW5ndGg7XG5cbicgKwogICAgJyAgd2hpbGUgKCsrb3duSW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTtcbicgKwogICAgIiAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnKSB7ICU+aWYgKCEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKSkge1xuICA8JSB9ICU+IiArCiAgICAnICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgICAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPn1cbjwlIH0gJT4nICsKICAgICcgIH0nICsKCiAgICAvLyBlbHNlIHVzaW5nIGEgZm9yLWluIGxvb3AKICAgICcgIDwlIH0gZWxzZSB7ICU+XG4nICsKICAgICcgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHs8JScgKwogICAgJyAgICBpZiAoIWhhc0RvbnRFbnVtQnVnIHx8IHVzZUhhcykgeyAlPlxuICAgIGlmICg8JScgKwogICAgIiAgICAgIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT4hKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJyk8JSB9IiArCiAgICAnICAgICAgaWYgKCFoYXNEb250RW51bUJ1ZyAmJiB1c2VIYXMpIHsgJT4gJiYgPCUgfScgKwogICAgJyAgICAgIGlmICh1c2VIYXMpIHsgJT5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCk8JSB9JyArCiAgICAnICAgICU+KSB7JyArCiAgICAnICAgIDwlIH0gJT5cbicgKwogICAgJyAgICA8JT0gbG9vcCAlPjsnICsKICAgICcgICAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZyB8fCB1c2VIYXMpIHsgJT5cbiAgICB9PCUgfSAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gQmVjYXVzZSBJRSA8IDkgY2FuJ3Qgc2V0IHRoZSBgW1tFbnVtZXJhYmxlXV1gIGF0dHJpYnV0ZSBvZiBhbgogICAgLy8gZXhpc3RpbmcgcHJvcGVydHkgYW5kIHRoZSBgY29uc3RydWN0b3JgIHByb3BlcnR5IG9mIGEgcHJvdG90eXBlCiAgICAvLyBkZWZhdWx0cyB0byBub24tZW51bWVyYWJsZSwgTG8tRGFzaCBza2lwcyB0aGUgYGNvbnN0cnVjdG9yYAogICAgLy8gcHJvcGVydHkgd2hlbiBpdCBpbmZlcnMgaXQncyBpdGVyYXRpbmcgb3ZlciBhIGBwcm90b3R5cGVgIG9iamVjdC4KICAgICcgIDwlIGlmIChoYXNEb250RW51bUJ1ZykgeyAlPlxuXG4nICsKICAgICcgIHZhciBjdG9yID0gaXRlcmFibGUuY29uc3RydWN0b3I7XG4nICsKICAgICcgICAgPCUgZm9yICh2YXIgayA9IDA7IGsgPCA3OyBrKyspIHsgJT5cbicgKwogICAgIiAgaW5kZXggPSAnPCU9IHNoYWRvd2VkW2tdICU+JztcbiIgKwogICAgJyAgaWYgKDwlJyArCiAgICAiICAgICAgaWYgKHNoYWRvd2VkW2tdID09ICdjb25zdHJ1Y3RvcicpIHsiICsKICAgICcgICAgICAgICU+IShjdG9yICYmIGN0b3IucHJvdG90eXBlID09PSBpdGVyYWJsZSkgJiYgPCUnICsKICAgICcgICAgICB9ICU+aGFzT3duUHJvcGVydHkuY2FsbChpdGVyYWJsZSwgaW5kZXgpKSB7XG4nICsKICAgICcgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgfScgKwogICAgJyAgICA8JSB9ICU+JyArCiAgICAnICA8JSB9ICU+JyArCiAgICAnICA8JSBpZiAoYXJyYXlzIHx8IG5vbkVudW1BcmdzKSB7ICU+XG59PCUgfSAlPlxuJyArCgogICAgLy8gYWRkIGNvZGUgdG8gdGhlIGJvdHRvbSBvZiB0aGUgaXRlcmF0aW9uIGZ1bmN0aW9uCiAgICAnPCU9IGJvdHRvbSAlPjtcbicgKwogICAgLy8gZmluYWxseSwgcmV0dXJuIHRoZSBgcmVzdWx0YAogICAgJ3JldHVybiByZXN1bHQnCiAgKTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBhc3NpZ25gIGFuZCBgZGVmYXVsdHNgICovCiAgdmFyIGFzc2lnbkl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdhcmdzJzogJ29iamVjdCwgc291cmNlLCBndWFyZCcsCiAgICAndG9wJzoKICAgICAgJ3ZhciBhcmdzSW5kZXggPSAwLFxuJyArCiAgICAgICIgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmd1bWVudHMubGVuZ3RoO1xuIiArCiAgICAgICd3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7XG4nICsKICAgICAgJyAgaWYgKChpdGVyYWJsZSA9IGFyZ3VtZW50c1thcmdzSW5kZXhdKSkgeycsCiAgICAnbG9vcCc6ICdyZXN1bHRbaW5kZXhdID0gaXRlcmFibGVbaW5kZXhdJywKICAgICdib3R0b20nOiAnICB9XG59JwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIHNoYXJlZCBieSBgZWFjaGAsIGBmb3JJbmAsIGFuZCBgZm9yT3duYCAqLwogIHZhciBlYWNoSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FyZ3MnOiAnY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcnLAogICAgJ3RvcCc6ICJjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZykiLAogICAgJ2FycmF5cyc6ICJ0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInIiwKICAgICdsb29wJzogJ2lmIChjYWxsYmFjayhpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHJldHVybiByZXN1bHQnCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBmb3JJbmAgYW5kIGBmb3JPd25gICovCiAgdmFyIGZvck93bkl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdhcnJheXMnOiBmYWxzZQogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gb3B0aW1pemVkIHRvIHNlYXJjaCBsYXJnZSBhcnJheXMgZm9yIGEgZ2l2ZW4gYHZhbHVlYCwKICAgKiBzdGFydGluZyBhdCBgZnJvbUluZGV4YCwgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtsYXJnZVNpemU9MzBdIFRoZSBsZW5ndGggYXQgd2hpY2ggYW4gYXJyYXkgaXMgY29uc2lkZXJlZCBsYXJnZS4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgZm91bmQsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBjYWNoZWRDb250YWlucyhhcnJheSwgZnJvbUluZGV4LCBsYXJnZVNpemUpIHsKICAgIGZyb21JbmRleCB8fCAoZnJvbUluZGV4ID0gMCk7CgogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBpc0xhcmdlID0gKGxlbmd0aCAtIGZyb21JbmRleCkgPj0gKGxhcmdlU2l6ZSB8fCBsYXJnZUFycmF5U2l6ZSk7CgogICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgdmFyIGNhY2hlID0ge30sCiAgICAgICAgICBpbmRleCA9IGZyb21JbmRleCAtIDE7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIC8vIG1hbnVhbGx5IGNvZXJjZSBgdmFsdWVgIHRvIGEgc3RyaW5nIGJlY2F1c2UgYGhhc093blByb3BlcnR5YCwgaW4gc29tZQogICAgICAgIC8vIG9sZGVyIHZlcnNpb25zIG9mIEZpcmVmb3gsIGNvZXJjZXMgb2JqZWN0cyBpbmNvcnJlY3RseQogICAgICAgIHZhciBrZXkgPSBhcnJheVtpbmRleF0gKyAnJzsKICAgICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KSA/IGNhY2hlW2tleV0gOiAoY2FjaGVba2V5XSA9IFtdKSkucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICB2YXIga2V5ID0gdmFsdWUgKyAnJzsKICAgICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KSAmJiBpbmRleE9mKGNhY2hlW2tleV0sIHZhbHVlKSA+IC0xOwogICAgICB9CiAgICAgIHJldHVybiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSA+IC0xOwogICAgfQogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgXy5tYXhgIGFuZCBgXy5taW5gIGFzIHRoZSBkZWZhdWx0IGBjYWxsYmFja2Agd2hlbiBhIGdpdmVuCiAgICogYGNvbGxlY3Rpb25gIGlzIGEgc3RyaW5nIHZhbHVlLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIGNoYXJhY3RlciB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGNvZGUgdW5pdCBvZiBnaXZlbiBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gY2hhckF0Q2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5jaGFyQ29kZUF0KDApOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgc29ydEJ5YCB0byBjb21wYXJlIHRyYW5zZm9ybWVkIGBjb2xsZWN0aW9uYCB2YWx1ZXMsIHN0YWJsZSBzb3J0aW5nCiAgICogdGhlbSBpbiBhc2NlbmRpbmcgb3JkZXIuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBhIFRoZSBvYmplY3QgdG8gY29tcGFyZSB0byBgYmAuCiAgICogQHBhcmFtIHtPYmplY3R9IGIgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBhYC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIHRoZSBzb3J0IG9yZGVyIGluZGljYXRvciBvZiBgMWAgb3IgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjb21wYXJlQXNjZW5kaW5nKGEsIGIpIHsKICAgIHZhciBhaSA9IGEuaW5kZXgsCiAgICAgICAgYmkgPSBiLmluZGV4OwoKICAgIGEgPSBhLmNyaXRlcmlhOwogICAgYiA9IGIuY3JpdGVyaWE7CgogICAgLy8gZW5zdXJlIGEgc3RhYmxlIHNvcnQgaW4gVjggYW5kIG90aGVyIGVuZ2luZXMKICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTkwCiAgICBpZiAoYSAhPT0gYikgewogICAgICBpZiAoYSA+IGIgfHwgdHlwZW9mIGEgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYSA8IGIgfHwgdHlwZW9mIGIgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhaSA8IGJpID8gLTEgOiAxOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZwogICAqIG9mIGB0aGlzQXJnYCBhbmQgcHJlcGVuZHMgYW55IGBwYXJ0aWFsQXJnc2AgdG8gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlCiAgICogYm91bmQgZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kIG9yIHRoZSBtZXRob2QgbmFtZS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgKiBAcGFyYW0ge0FycmF5fSBwYXJ0aWFsQXJncyBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHBhcmFtIHtPYmplY3R9IFtyaWdodF0gVXNlZCB0byBpbmRpY2F0ZSBwYXJ0aWFsbHkgYXBwbHlpbmcgYXJndW1lbnRzIGZyb20gdGhlIHJpZ2h0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUJvdW5kKGZ1bmMsIHRoaXNBcmcsIHBhcnRpYWxBcmdzLCByaWdodCkgewogICAgdmFyIGlzRnVuYyA9IGlzRnVuY3Rpb24oZnVuYyksCiAgICAgICAgaXNQYXJ0aWFsID0gIXBhcnRpYWxBcmdzLAogICAgICAgIGtleSA9IHRoaXNBcmc7CgogICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgaWYgKGlzUGFydGlhbCkgewogICAgICBwYXJ0aWFsQXJncyA9IHRoaXNBcmc7CiAgICB9CiAgICBpZiAoIWlzRnVuYykgewogICAgICB0aGlzQXJnID0gZnVuYzsKICAgIH0KCiAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgLy8gYEZ1bmN0aW9uI2JpbmRgIHNwZWMKICAgICAgLy8gaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMy40LjUKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICB0aGlzQmluZGluZyA9IGlzUGFydGlhbCA/IHRoaXMgOiB0aGlzQXJnOwoKICAgICAgaWYgKCFpc0Z1bmMpIHsKICAgICAgICBmdW5jID0gdGhpc0FyZ1trZXldOwogICAgICB9CiAgICAgIGlmIChwYXJ0aWFsQXJncy5sZW5ndGgpIHsKICAgICAgICBhcmdzID0gYXJncy5sZW5ndGgKICAgICAgICAgID8gKGFyZ3MgPSBzbGljZShhcmdzKSwgcmlnaHQgPyBhcmdzLmNvbmNhdChwYXJ0aWFsQXJncykgOiBwYXJ0aWFsQXJncy5jb25jYXQoYXJncykpCiAgICAgICAgICA6IHBhcnRpYWxBcmdzOwogICAgICB9CiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgYm91bmQpIHsKICAgICAgICAvLyBlbnN1cmUgYG5ldyBib3VuZGAgaXMgYW4gaW5zdGFuY2Ugb2YgYGJvdW5kYCBhbmQgYGZ1bmNgCiAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBmdW5jLnByb3RvdHlwZTsKICAgICAgICB0aGlzQmluZGluZyA9IG5ldyBub29wOwogICAgICAgIG5vb3AucHJvdG90eXBlID0gbnVsbDsKCiAgICAgICAgLy8gbWltaWMgdGhlIGNvbnN0cnVjdG9yJ3MgYHJldHVybmAgYmVoYXZpb3IKICAgICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxMy4yLjIKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgfQogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICB9CiAgICByZXR1cm4gYm91bmQ7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhbiBpdGVyYXRpb24gY2FsbGJhY2sgYm91bmQgdG8gYW4gb3B0aW9uYWwgYHRoaXNBcmdgLiBJZiBgZnVuY2AgaXMKICAgKiBhIHByb3BlcnR5IG5hbWUsIHRoZSBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgZm9yIGEgZ2l2ZW4gZWxlbWVudC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFtmdW5jPWlkZW50aXR5fHByb3BlcnR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlcgogICAqIGl0ZXJhdGlvbiBvciBwcm9wZXJ0eSBuYW1lIHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcGFyYW0ge09iamVjdH0gW2FjY3VtdWxhdGluZ10gVXNlZCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBjYWxsYmFjayBzaG91bGQKICAgKiAgYWNjZXB0IGFuIGBhY2N1bXVsYXRvcmAgYXJndW1lbnQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGEgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYWNjdW11bGF0aW5nKSB7CiAgICBpZiAoIWZ1bmMpIHsKICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgfQogICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgIGlmICh0eXBlICE9ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2Z1bmNdOwogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHZhciBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gaXNFcXVhbChvYmplY3RbcHJvcHNbbGVuZ3RoXV0sIGZ1bmNbcHJvcHNbbGVuZ3RoXV0pKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgdGhpc0FyZyAhPSAndW5kZWZpbmVkJykgewogICAgICBpZiAoYWNjdW11bGF0aW5nKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBvYmplY3QpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gZnVuYzsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgY29tcGlsZWQgaXRlcmF0aW9uIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zMSwgb3B0aW9uczIsIC4uLl0gVGhlIGNvbXBpbGUgb3B0aW9ucyBvYmplY3QocykuCiAgICogIGFycmF5cyAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBpdGVyYWJsZSBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlLgogICAqICB1c2VIYXMgLSBBIGJvb2xlYW4gdG8gc3BlY2lmeSB1c2luZyBgaGFzT3duUHJvcGVydHlgIGNoZWNrcyBpbiB0aGUgb2JqZWN0IGxvb3AuCiAgICogIGFyZ3MgLSBBIHN0cmluZyBvZiBjb21tYSBzZXBhcmF0ZWQgYXJndW1lbnRzIHRoZSBpdGVyYXRpb24gZnVuY3Rpb24gd2lsbCBhY2NlcHQuCiAgICogIHRvcCAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBiZWZvcmUgdGhlIGl0ZXJhdGlvbiBicmFuY2hlcy4KICAgKiAgbG9vcCAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBpbiB0aGUgb2JqZWN0IGxvb3AuCiAgICogIGJvdHRvbSAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBhZnRlciB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzLgogICAqCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBjb21waWxlZCBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBjcmVhdGVJdGVyYXRvcigpIHsKICAgIHZhciBkYXRhID0gewogICAgICAvLyBzdXBwb3J0IHByb3BlcnRpZXMKICAgICAgJ2hhc0RvbnRFbnVtQnVnJzogaGFzRG9udEVudW1CdWcsCiAgICAgICdpc0tleXNGYXN0JzogaXNLZXlzRmFzdCwKICAgICAgJ25vbkVudW1BcmdzJzogbm9uRW51bUFyZ3MsCiAgICAgICdub0NoYXJCeUluZGV4Jzogbm9DaGFyQnlJbmRleCwKICAgICAgJ3NoYWRvd2VkJzogc2hhZG93ZWQsCgogICAgICAvLyBpdGVyYXRvciBvcHRpb25zCiAgICAgICdhcnJheXMnOiAnaXNBcnJheShpdGVyYWJsZSknLAogICAgICAnYm90dG9tJzogJycsCiAgICAgICdsb29wJzogJycsCiAgICAgICd0b3AnOiAnJywKICAgICAgJ3VzZUhhcyc6IHRydWUKICAgIH07CgogICAgLy8gbWVyZ2Ugb3B0aW9ucyBpbnRvIGEgdGVtcGxhdGUgZGF0YSBvYmplY3QKICAgIGZvciAodmFyIG9iamVjdCwgaW5kZXggPSAwOyBvYmplY3QgPSBhcmd1bWVudHNbaW5kZXhdOyBpbmRleCsrKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBkYXRhW2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgfQogICAgfQogICAgdmFyIGFyZ3MgPSBkYXRhLmFyZ3M7CiAgICBkYXRhLmZpcnN0QXJnID0gL15bXixdKy8uZXhlYyhhcmdzKVswXTsKCiAgICAvLyBjcmVhdGUgdGhlIGZ1bmN0aW9uIGZhY3RvcnkKICAgIHZhciBmYWN0b3J5ID0gRnVuY3Rpb24oCiAgICAgICAgJ2NyZWF0ZUNhbGxiYWNrLCBoYXNPd25Qcm9wZXJ0eSwgaXNBcmd1bWVudHMsIGlzQXJyYXksIGlzU3RyaW5nLCAnICsKICAgICAgICAnb2JqZWN0VHlwZXMsIG5hdGl2ZUtleXMsIHByb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICAgJ3JldHVybiBmdW5jdGlvbignICsgYXJncyArICcpIHtcbicgKyBpdGVyYXRvclRlbXBsYXRlKGRhdGEpICsgJ1xufScKICAgICk7CiAgICAvLyByZXR1cm4gdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICByZXR1cm4gZmFjdG9yeSgKICAgICAgY3JlYXRlQ2FsbGJhY2ssIGhhc093blByb3BlcnR5LCBpc0FyZ3VtZW50cywgaXNBcnJheSwgaXNTdHJpbmcsCiAgICAgIG9iamVjdFR5cGVzLCBuYXRpdmVLZXlzLCBwcm9wZXJ0eUlzRW51bWVyYWJsZQogICAgKTsKICB9CgogIC8qKgogICAqIEEgZnVuY3Rpb24gY29tcGlsZWQgdG8gaXRlcmF0ZSBgYXJndW1lbnRzYCBvYmplY3RzLCBhcnJheXMsIG9iamVjdHMsIGFuZAogICAqIHN0cmluZ3MgY29uc2lzdGVubHkgYWNyb3NzIGVudmlyb25tZW50cywgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoCiAgICogZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgKiB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLiBDYWxsYmFja3MgbWF5IGV4aXQKICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxTdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAqLwogIHZhciBlYWNoID0gY3JlYXRlSXRlcmF0b3IoZWFjaEl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIFVzZWQgYnkgYHRlbXBsYXRlYCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkCiAgICogc3RyaW5nIGxpdGVyYWxzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIGVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVTdHJpbmdDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gJ1xcJyArIHN0cmluZ0VzY2FwZXNbbWF0Y2hdOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgIHJldHVybiBodG1sRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIERPTSBub2RlIGluIElFIDwgOS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIERPTSBub2RlLCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gaXNOb2RlKHZhbHVlKSB7CiAgICAvLyBJRSA8IDkgcHJlc2VudHMgRE9NIG5vZGVzIGFzIGBPYmplY3RgIG9iamVjdHMgZXhjZXB0IHRoZXkgaGF2ZSBgdG9TdHJpbmdgCiAgICAvLyBtZXRob2RzIHRoYXQgYXJlIGB0eXBlb2ZgICJzdHJpbmciIGFuZCBzdGlsbCBjYW4gY29lcmNlIG5vZGVzIHRvIHN0cmluZ3MKICAgIHJldHVybiB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgKHZhbHVlICsgJycpID09ICdzdHJpbmcnOwogIH0KCiAgLyoqCiAgICogQSBuby1vcGVyYXRpb24gZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgfQoKICAvKioKICAgKiBTbGljZXMgdGhlIGBjb2xsZWN0aW9uYCBmcm9tIHRoZSBgc3RhcnRgIGluZGV4IHVwIHRvLCBidXQgbm90IGluY2x1ZGluZywKICAgKiB0aGUgYGVuZGAgaW5kZXguCiAgICoKICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQsIGluc3RlYWQgb2YgYEFycmF5I3NsaWNlYCwgdG8gc3VwcG9ydCBub2RlIGxpc3RzCiAgICogaW4gSUUgPCA5IGFuZCB0byBlbnN1cmUgZGVuc2UgYXJyYXlzIGFyZSByZXR1cm5lZC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNsaWNlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgaW5kZXguCiAgICogQHBhcmFtIHtOdW1iZXJ9IGVuZCBUaGUgZW5kIGluZGV4LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5LgogICAqLwogIGZ1bmN0aW9uIHNsaWNlKGFycmF5LCBzdGFydCwgZW5kKSB7CiAgICBzdGFydCB8fCAoc3RhcnQgPSAwKTsKICAgIGlmICh0eXBlb2YgZW5kID09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuZCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGVuZCAtIHN0YXJ0IHx8IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBhcnJheVtzdGFydCArIGluZGV4XTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB1bmVzY2FwZWAgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gdW5lc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiB1bmVzY2FwZUh0bWxDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gaHRtbFVuZXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYGFyZ3VtZW50c2Agb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpOyB9KSgxLCAyLCAzKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzQXJndW1lbnRzKFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFyZ3NDbGFzczsKICB9CiAgLy8gZmFsbGJhY2sgZm9yIGJyb3dzZXJzIHRoYXQgY2FuJ3QgZGV0ZWN0IGBhcmd1bWVudHNgIG9iamVjdHMgYnkgW1tDbGFzc11dCiAgaWYgKG5vQXJnc0NsYXNzKSB7CiAgICBpc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdjYWxsZWUnKSA6IGZhbHNlOwogICAgfTsKICB9CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYG9iamVjdGAncyBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZwogICAqIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICogaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24KICAgKiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBmdW5jdGlvbiBEb2cobmFtZSkgewogICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgKiB9CiAgICoKICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgKiAgIGFsZXJ0KCdXb29mLCB3b29mIScpOwogICAqIH07CiAgICoKICAgKiBfLmZvckluKG5ldyBEb2coJ0RhZ255JyksIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIGFsZXJ0KGtleSk7CiAgICogfSk7CiAgICogLy8gPT4gYWxlcnRzICduYW1lJyBhbmQgJ2JhcmsnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9ySW4gPSBjcmVhdGVJdGVyYXRvcihlYWNoSXRlcmF0b3JPcHRpb25zLCBmb3JPd25JdGVyYXRvck9wdGlvbnMsIHsKICAgICd1c2VIYXMnOiBmYWxzZQogIH0pOwoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGFuIG9iamVjdCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZyB0aGUgYGNhbGxiYWNrYAogICAqIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseQogICAqIHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZvck93bih7ICcwJzogJ3plcm8nLCAnMSc6ICdvbmUnLCAnbGVuZ3RoJzogMiB9LCBmdW5jdGlvbihudW0sIGtleSkgewogICAqICAgYWxlcnQoa2V5KTsKICAgKiB9KTsKICAgKiAvLyA9PiBhbGVydHMgJzAnLCAnMScsIGFuZCAnbGVuZ3RoJyAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGZvck93biA9IGNyZWF0ZUl0ZXJhdG9yKGVhY2hJdGVyYXRvck9wdGlvbnMsIGZvck93bkl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJyYXkoYXJndW1lbnRzKTsgfSkoKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0FycmF5KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIHZhciBpc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbih2YWx1ZSkgewogICAgLy8gYGluc3RhbmNlb2ZgIG1heSBjYXVzZSBhIG1lbW9yeSBsZWFrIGluIElFIDcgaWYgYHZhbHVlYCBpcyBhIGhvc3Qgb2JqZWN0CiAgICAvLyBodHRwOi8vYWpheGlhbi5jb20vYXJjaGl2ZXMvd29ya2luZy1hcm91bmctdGhlLWluc3RhbmNlb2YtbWVtb3J5LWxlYWsKICAgIHJldHVybiAoYXJnc0FyZU9iamVjdHMgJiYgdmFsdWUgaW5zdGFuY2VvZiBBcnJheSkgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYXJyYXlDbGFzczsKICB9OwoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbXBvc2VkIG9mIHRoZSBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcyBvZiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmtleXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gWydvbmUnLCAndHdvJywgJ3RocmVlJ10gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIHZhciBrZXlzID0gIW5hdGl2ZUtleXMgPyBzaGltS2V5cyA6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgLy8gYXZvaWQgaXRlcmF0aW5nIG92ZXIgdGhlIGBwcm90b3R5cGVgIHByb3BlcnR5CiAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PSAnZnVuY3Rpb24nICYmIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCAncHJvdG90eXBlJykKICAgICAgPyBzaGltS2V5cyhvYmplY3QpCiAgICAgIDogKGlzT2JqZWN0KG9iamVjdCkgPyBuYXRpdmVLZXlzKG9iamVjdCkgOiBbXSk7CiAgfTsKCiAgLyoqCiAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgaXNQbGFpbk9iamVjdGAgdGhhdCBjaGVja3MgaWYgYSBnaXZlbiBgdmFsdWVgCiAgICogaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLCBhc3N1bWluZyBvYmplY3RzIGNyZWF0ZWQKICAgKiBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IgaGF2ZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGFuZCB0aGF0CiAgICogdGhlcmUgYXJlIG5vIGBPYmplY3QucHJvdG90eXBlYCBleHRlbnNpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gc2hpbUlzUGxhaW5PYmplY3QodmFsdWUpIHsKICAgIC8vIGF2b2lkIG5vbi1vYmplY3RzIGFuZCBmYWxzZSBwb3NpdGl2ZXMgZm9yIGBhcmd1bWVudHNgIG9iamVjdHMKICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgIGlmICghKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykgfHwgaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvLyBjaGVjayB0aGF0IHRoZSBjb25zdHJ1Y3RvciBpcyBgT2JqZWN0YCAoaS5lLiBgT2JqZWN0IGluc3RhbmNlb2YgT2JqZWN0YCkKICAgIHZhciBjdG9yID0gdmFsdWUuY29uc3RydWN0b3I7CiAgICBpZiAoKCFpc0Z1bmN0aW9uKGN0b3IpICYmICghbm9Ob2RlQ2xhc3MgfHwgIWlzTm9kZSh2YWx1ZSkpKSB8fCBjdG9yIGluc3RhbmNlb2YgY3RvcikgewogICAgICAvLyBJRSA8IDkgaXRlcmF0ZXMgaW5oZXJpdGVkIHByb3BlcnRpZXMgYmVmb3JlIG93biBwcm9wZXJ0aWVzLiBJZiB0aGUgZmlyc3QKICAgICAgLy8gaXRlcmF0ZWQgcHJvcGVydHkgaXMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnR5IHRoZW4gdGhlcmUgYXJlIG5vIGluaGVyaXRlZAogICAgICAvLyBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgIGlmIChpdGVyYXRlc093bkxhc3QpIHsKICAgICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgICByZXN1bHQgPSAhaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gSW4gbW9zdCBlbnZpcm9ubWVudHMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGJlZm9yZQogICAgICAvLyBpdHMgaW5oZXJpdGVkIHByb3BlcnRpZXMuIElmIHRoZSBsYXN0IGl0ZXJhdGVkIHByb3BlcnR5IGlzIGFuIG9iamVjdCdzCiAgICAgIC8vIG93biBwcm9wZXJ0eSB0aGVuIHRoZXJlIGFyZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQgPT09IGZhbHNlIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgT2JqZWN0LmtleXNgIHRoYXQgcHJvZHVjZXMgYW4gYXJyYXkgb2YgdGhlCiAgICogZ2l2ZW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgKi8KICBmdW5jdGlvbiBzaGltS2V5cyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvck93bihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFVzZWQgdG8gY29udmVydCBjaGFyYWN0ZXJzIHRvIEhUTUwgZW50aXRpZXM6CiAgICoKICAgKiBUaG91Z2ggdGhlIGA+YCBjaGFyYWN0ZXIgaXMgZXNjYXBlZCBmb3Igc3ltbWV0cnksIGNoYXJhY3RlcnMgbGlrZSBgPmAgYW5kIGAvYAogICAqIGRvbid0IHJlcXVpcmUgZXNjYXBpbmcgaW4gSFRNTCBhbmQgaGF2ZSBubyBzcGVjaWFsIG1lYW5pbmcgdW5sZXNzIHRoZXkncmUgcGFydAogICAqIG9mIGEgdGFnIG9yIGFuIHVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZS4KICAgKiBodHRwOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9hbWJpZ3VvdXMtYW1wZXJzYW5kcyAodW5kZXIgInNlbWktcmVsYXRlZCBmdW4gZmFjdCIpCiAgICovCiAgdmFyIGh0bWxFc2NhcGVzID0gewogICAgJyYnOiAnJmFtcDsnLAogICAgJzwnOiAnJmx0OycsCiAgICAnPic6ICcmZ3Q7JywKICAgICciJzogJyZxdW90OycsCiAgICAiJyI6ICcmI3gyNzsnCiAgfTsKCiAgLyoqIFVzZWQgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMgKi8KICB2YXIgaHRtbFVuZXNjYXBlcyA9IGludmVydChodG1sRXNjYXBlcyk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgYGRlc3RpbmF0aW9uYAogICAqIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzIHdpbGwgb3ZlcndyaXRlIHByb3BlcnkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMKICAgKiBzb3VyY2VzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGV4dGVuZAogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBbc291cmNlMSwgc291cmNlMiwgLi4uXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEludGVybmFsbHkgdXNlZCB0byBhbGxvdyB0aGlzIG1ldGhvZCB0byB3b3JrIHdpdGgKICAgKiAgYF8ucmVkdWNlYCB3aXRob3V0IHVzaW5nIGl0cyBjYWxsYmFjaydzIGBrZXkgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5hc3NpZ24oeyAnbmFtZSc6ICdtb2UnIH0sIHsgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgKi8KICB2YXIgYXNzaWduID0gY3JlYXRlSXRlcmF0b3IoYXNzaWduSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGB2YWx1ZWAuIElmIGBkZWVwYCBpcyBgdHJ1ZWAsIG5lc3RlZCBvYmplY3RzIHdpbGwgYWxzbwogICAqIGJlIGNsb25lZCwgb3RoZXJ3aXNlIHRoZXkgd2lsbCBiZSBhc3NpZ25lZCBieSByZWZlcmVuY2UuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRlZXAgQSBmbGFnIHRvIGluZGljYXRlIGEgZGVlcCBjbG9uZS4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBvdGhlcnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcgdGhlaXIgY2FsbGJhY2sgYGluZGV4YCBhcmd1bWVudCBmb3IgYGRlZXBgLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gdHJhY2sgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tCPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gYXNzb2NpYXRlIGNsb25lcyB3aXRoIHRoZWlyCiAgICogIHNvdXJjZSBjb3VudGVycGFydHMuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBjbG9uZWQgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIHZhciBzaGFsbG93ID0gXy5jbG9uZShzdG9vZ2VzKTsKICAgKiBzaGFsbG93WzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIHZhciBkZWVwID0gXy5jbG9uZShzdG9vZ2VzLCB0cnVlKTsKICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gY2xvbmUodmFsdWUsIGRlZXAsIGd1YXJkLCBzdGFja0EsIHN0YWNrQikgewogICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKGd1YXJkKSB7CiAgICAgIGRlZXAgPSBmYWxzZTsKICAgIH0KICAgIC8vIGluc3BlY3QgW1tDbGFzc11dCiAgICB2YXIgaXNPYmogPSBpc09iamVjdCh2YWx1ZSk7CiAgICBpZiAoaXNPYmopIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgICBpZiAoIWNsb25lYWJsZUNsYXNzZXNbY2xhc3NOYW1lXSB8fCAobm9Ob2RlQ2xhc3MgJiYgaXNOb2RlKHZhbHVlKSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSk7CiAgICB9CiAgICAvLyBzaGFsbG93IGNsb25lCiAgICBpZiAoIWlzT2JqIHx8ICFkZWVwKSB7CiAgICAgIHJldHVybiBpc09iagogICAgICAgID8gKGlzQXJyID8gc2xpY2UodmFsdWUpIDogYXNzaWduKHt9LCB2YWx1ZSkpCiAgICAgICAgOiB2YWx1ZTsKICAgIH0KICAgIHZhciBjdG9yID0gY3RvckJ5Q2xhc3NbY2xhc3NOYW1lXTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICByZXR1cm4gbmV3IGN0b3IoK3ZhbHVlKTsKCiAgICAgIGNhc2UgbnVtYmVyQ2xhc3M6CiAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgcmV0dXJuIG5ldyBjdG9yKHZhbHVlKTsKCiAgICAgIGNhc2UgcmVnZXhwQ2xhc3M6CiAgICAgICAgcmV0dXJuIGN0b3IodmFsdWUuc291cmNlLCByZUZsYWdzLmV4ZWModmFsdWUpKTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VzIGFuZCByZXR1cm4gY29ycmVzcG9uZGluZyBjbG9uZQogICAgc3RhY2tBIHx8IChzdGFja0EgPSBbXSk7CiAgICBzdGFja0IgfHwgKHN0YWNrQiA9IFtdKTsKCiAgICB2YXIgbGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBpZiAoc3RhY2tBW2xlbmd0aF0gPT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF07CiAgICAgIH0KICAgIH0KICAgIC8vIGluaXQgY2xvbmVkIG9iamVjdAogICAgdmFyIHJlc3VsdCA9IGlzQXJyID8gY3Rvcih2YWx1ZS5sZW5ndGgpIDoge307CgogICAgLy8gYWRkIHRoZSBzb3VyY2UgdmFsdWUgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzCiAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICBzdGFja0EucHVzaCh2YWx1ZSk7CiAgICBzdGFja0IucHVzaChyZXN1bHQpOwoKICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgIChpc0FyciA/IGZvckVhY2ggOiBmb3JPd24pKHZhbHVlLCBmdW5jdGlvbihvYmpWYWx1ZSwga2V5KSB7CiAgICAgIHJlc3VsdFtrZXldID0gY2xvbmUob2JqVmFsdWUsIGRlZXAsIG51bGwsIHN0YWNrQSwgc3RhY2tCKTsKICAgIH0pOwoKICAgIC8vIGFkZCBhcnJheSBwcm9wZXJ0aWVzIGFzc2lnbmVkIGJ5IGBSZWdFeHAjZXhlY2AKICAgIGlmIChpc0FycikgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2luZGV4JykpIHsKICAgICAgICByZXN1bHQuaW5kZXggPSB2YWx1ZS5pbmRleDsKICAgICAgfQogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2lucHV0JykpIHsKICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZS5pbnB1dDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBkZWVwIGNsb25lIG9mIGB2YWx1ZWAuIEZ1bmN0aW9ucyBhbmQgRE9NIG5vZGVzIGFyZSAqKm5vdCoqIGNsb25lZC4KICAgKiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kIG9iamVjdHMgY3JlYXRlZCBieQogICAqIGNvbnN0cnVjdG9ycyBvdGhlciB0aGFuIGBPYmplY3RgIGFyZSBjbG9uZWQgdG8gcGxhaW4gYE9iamVjdGAgb2JqZWN0cy4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgbG9vc2VseSBiYXNlZCBvbiB0aGUgc3RydWN0dXJlZCBjbG9uZSBhbGdvcml0aG0uCiAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogdmFyIGRlZXAgPSBfLmNsb25lRGVlcChzdG9vZ2VzKTsKICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gY2xvbmVEZWVwKHZhbHVlKSB7CiAgICByZXR1cm4gY2xvbmUodmFsdWUsIHRydWUpOwogIH0KCiAgLyoqCiAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGBkZXN0aW5hdGlvbmAKICAgKiBvYmplY3QgZm9yIGFsbCBgZGVzdGluYXRpb25gIHByb3BlcnRpZXMgdGhhdCByZXNvbHZlIHRvIGBudWxsYC9gdW5kZWZpbmVkYC4KICAgKiBPbmNlIGEgcHJvcGVydHkgaXMgc2V0LCBhZGRpdGlvbmFsIGRlZmF1bHRzIG9mIHRoZSBzYW1lIHByb3BlcnR5IHdpbGwgYmUKICAgKiBpZ25vcmVkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzIGNhbGxiYWNrJ3MgYGtleWAgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGljZUNyZWFtID0geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScgfTsKICAgKiBfLmRlZmF1bHRzKGljZUNyZWFtLCB7ICdmbGF2b3InOiAndmFuaWxsYScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfSk7CiAgICogLy8gPT4geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfQogICAqLwogIHZhciBkZWZhdWx0cyA9IGNyZWF0ZUl0ZXJhdG9yKGFzc2lnbkl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2xvb3AnOiAnaWYgKHJlc3VsdFtpbmRleF0gPT0gbnVsbCkgJyArIGFzc2lnbkl0ZXJhdG9yT3B0aW9ucy5sb29wCiAgfSk7CgogIC8qKgogICAqIENyZWF0ZXMgYSBzb3J0ZWQgYXJyYXkgb2YgYWxsIGVudW1lcmFibGUgcHJvcGVydGllcywgb3duIGFuZCBpbmhlcml0ZWQsCiAgICogb2YgYG9iamVjdGAgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBtZXRob2RzCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5mdW5jdGlvbnMoXyk7CiAgICogLy8gPT4gWydhbGwnLCAnYW55JywgJ2JpbmQnLCAnYmluZEFsbCcsICdjbG9uZScsICdjb21wYWN0JywgJ2NvbXBvc2UnLCAuLi5dCiAgICovCiAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5zb3J0KCk7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgYHByb3BlcnR5YCBleGlzdHMgYW5kIGlzIGEgZGlyZWN0IHByb3BlcnR5LAogICAqIGluc3RlYWQgb2YgYW4gaW5oZXJpdGVkIHByb3BlcnR5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY2hlY2suCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBjaGVjayBmb3IuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaGFzKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIHJldHVybiBvYmplY3QgPyBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpIDogZmFsc2U7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgaW52ZXJ0ZWQga2V5cyBhbmQgdmFsdWVzIG9mIHRoZSBnaXZlbiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGludmVydC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjcmVhdGVkIGludmVydGVkIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogIF8uaW52ZXJ0KHsgJ2ZpcnN0JzogJ01vZScsICdzZWNvbmQnOiAnTGFycnknLCAndGhpcmQnOiAnQ3VybHknIH0pOwogICAqIC8vID0+IHsgJ01vZSc6ICdmaXJzdCcsICdMYXJyeSc6ICdzZWNvbmQnLCAnQ3VybHknOiAndGhpcmQnIH0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIGludmVydChvYmplY3QpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICByZXN1bHRbb2JqZWN0W2tleV1dID0ga2V5OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBib29sZWFuIHZhbHVlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNCb29sZWFuKG51bGwpOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGJvb2xDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZGF0ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBkYXRlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNEYXRlKG5ldyBEYXRlKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBEYXRlIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGRhdGVDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0VsZW1lbnQoZG9jdW1lbnQuYm9keSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRWxlbWVudCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID8gdmFsdWUubm9kZVR5cGUgPT09IDEgOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGVtcHR5LiBBcnJheXMsIHN0cmluZ3MsIG9yIGBhcmd1bWVudHNgIG9iamVjdHMgd2l0aCBhCiAgICogbGVuZ3RoIG9mIGAwYCBhbmQgb2JqZWN0cyB3aXRoIG5vIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGNvbnNpZGVyZWQKICAgKiAiZW1wdHkiLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgZW1wdHksIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0VtcHR5KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNFbXB0eSh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0VtcHR5KCcnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFbXB0eSh2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAoIXZhbHVlKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSksCiAgICAgICAgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOwoKICAgIGlmICgoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MgfHwgY2xhc3NOYW1lID09IHN0cmluZ0NsYXNzIHx8CiAgICAgICAgY2xhc3NOYW1lID09IGFyZ3NDbGFzcyB8fCAobm9BcmdzQ2xhc3MgJiYgaXNBcmd1bWVudHModmFsdWUpKSkgfHwKICAgICAgICAoY2xhc3NOYW1lID09IG9iamVjdENsYXNzICYmIHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgJiYgaXNGdW5jdGlvbih2YWx1ZS5zcGxpY2UpKSkgewogICAgICByZXR1cm4gIWxlbmd0aDsKICAgIH0KICAgIGZvck93bih2YWx1ZSwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAocmVzdWx0ID0gZmFsc2UpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUGVyZm9ybXMgYSBkZWVwIGNvbXBhcmlzb24gYmV0d2VlbiB0d28gdmFsdWVzIHRvIGRldGVybWluZSBpZiB0aGV5IGFyZQogICAqIGVxdWl2YWxlbnQgdG8gZWFjaCBvdGhlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gYSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgKiBAcGFyYW0ge01peGVkfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbS0ge09iamVjdH0gW3N0YWNrQT1bXV0gSW50ZXJuYWxseSB1c2VkIHRyYWNrIHRyYXZlcnNlZCBgYWAgb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0cmFjayB0cmF2ZXJzZWQgYGJgIG9iamVjdHMuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgdmFsdWVzIGFyZSBlcXV2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqIHZhciBjbG9uZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqCiAgICogbW9lID09IGNsb25lOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzRXF1YWwobW9lLCBjbG9uZSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYiwgc3RhY2tBLCBzdGFja0IpIHsKICAgIC8vIGV4aXQgZWFybHkgZm9yIGlkZW50aWNhbCB2YWx1ZXMKICAgIGlmIChhID09PSBiKSB7CiAgICAgIC8vIHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgIHJldHVybiBhICE9PSAwIHx8ICgxIC8gYSA9PSAxIC8gYik7CiAgICB9CiAgICAvLyBleGl0IGVhcmx5IGZvciB1bmxpa2UgYG51bGxgIG9yIGB1bmRlZmluZWRgIHZhbHVlcwogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gY29tcGFyZSBbW0NsYXNzXV0gbmFtZXMKICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpLAogICAgICAgIG90aGVyTmFtZSA9IHRvU3RyaW5nLmNhbGwoYik7CgogICAgaWYgKGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MpIHsKICAgICAgY2xhc3NOYW1lID0gb2JqZWN0Q2xhc3M7CiAgICB9CiAgICBpZiAob3RoZXJOYW1lID09IGFyZ3NDbGFzcykgewogICAgICBvdGhlck5hbWUgPSBvYmplY3RDbGFzczsKICAgIH0KICAgIGlmIChjbGFzc05hbWUgIT0gb3RoZXJOYW1lKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICAvLyBjb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWJlcnMsIGRhdGVzIHRvIG1pbGxpc2Vjb25kcyBhbmQgYm9vbGVhbnMKICAgICAgICAvLyB0byBgMWAgb3IgYDBgLCB0cmVhdGluZyBpbnZhbGlkIGRhdGVzIGNvZXJjZWQgdG8gYE5hTmAgYXMgbm90IGVxdWFsCiAgICAgICAgcmV0dXJuICthID09ICtiOwoKICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAvLyB0cmVhdCBgTmFOYCB2cy4gYE5hTmAgYXMgZXF1YWwKICAgICAgICByZXR1cm4gYSAhPSArYQogICAgICAgICAgPyBiICE9ICtiCiAgICAgICAgICAvLyBidXQgdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICAgIDogKGEgPT0gMCA/ICgxIC8gYSA9PSAxIC8gYikgOiBhID09ICtiKTsKCiAgICAgIGNhc2UgcmVnZXhwQ2xhc3M6CiAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgLy8gY29lcmNlIHJlZ2V4ZXMgdG8gc3RyaW5ncyAoaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMTAuNi40KQogICAgICAgIC8vIHRyZWF0IHN0cmluZyBwcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCBpbnN0YW5jZXMgYXMgZXF1YWwKICAgICAgICByZXR1cm4gYSA9PSBiICsgJyc7CiAgICB9CiAgICB2YXIgaXNBcnIgPSBjbGFzc05hbWUgPT0gYXJyYXlDbGFzczsKICAgIGlmICghaXNBcnIpIHsKICAgICAgLy8gdW53cmFwIGFueSBgbG9kYXNoYCB3cmFwcGVkIHZhbHVlcwogICAgICBpZiAoYS5fX3dyYXBwZWRfXyB8fCBiLl9fd3JhcHBlZF9fKSB7CiAgICAgICAgcmV0dXJuIGlzRXF1YWwoYS5fX3dyYXBwZWRfXyB8fCBhLCBiLl9fd3JhcHBlZF9fIHx8IGIpOwogICAgICB9CiAgICAgIC8vIGV4aXQgZm9yIGZ1bmN0aW9ucyBhbmQgRE9NIG5vZGVzCiAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MgfHwgKG5vTm9kZUNsYXNzICYmIChpc05vZGUoYSkgfHwgaXNOb2RlKGIpKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICB2YXIgY3RvckEgPSAhYXJnc0FyZU9iamVjdHMgJiYgaXNBcmd1bWVudHMoYSkgPyBPYmplY3QgOiBhLmNvbnN0cnVjdG9yLAogICAgICAgICAgY3RvckIgPSAhYXJnc0FyZU9iamVjdHMgJiYgaXNBcmd1bWVudHMoYikgPyBPYmplY3QgOiBiLmNvbnN0cnVjdG9yOwoKICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgaWYgKGN0b3JBICE9IGN0b3JCICYmICEoCiAgICAgICAgICAgIGlzRnVuY3Rpb24oY3RvckEpICYmIGN0b3JBIGluc3RhbmNlb2YgY3RvckEgJiYKICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQgogICAgICAgICAgKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgLy8gYXNzdW1lIGN5Y2xpYyBzdHJ1Y3R1cmVzIGFyZSBlcXVhbAogICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgIC8vIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AgKGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjEyLjMpCiAgICBzdGFja0EgfHwgKHN0YWNrQSA9IFtdKTsKICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gW10pOwoKICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrQltsZW5ndGhdID09IGI7CiAgICAgIH0KICAgIH0KICAgIHZhciByZXN1bHQgPSB0cnVlLAogICAgICAgIHNpemUgPSAwOwoKICAgIC8vIGFkZCBgYWAgYW5kIGBiYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgIHN0YWNrQS5wdXNoKGEpOwogICAgc3RhY2tCLnB1c2goYik7CgogICAgLy8gcmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgaWYgKGlzQXJyKSB7CiAgICAgIC8vIGNvbXBhcmUgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5CiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBkZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gaXNFcXVhbChhW3NpemVdLCBiW3NpemVdLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLy8gZGVlcCBjb21wYXJlIG9iamVjdHMgdXNpbmcgYGZvckluYCwgaW5zdGVhZCBvZiBgZm9yT3duYCwgdG8gYXZvaWQgYE9iamVjdC5rZXlzYAogICAgLy8gd2hpY2gsIGluIHRoaXMgY2FzZSwgaXMgbW9yZSBjb3N0bHkKICAgIGZvckluKGEsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGEpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoYSwga2V5KSkgewogICAgICAgIC8vIGNvdW50IHRoZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICBzaXplKys7CiAgICAgICAgLy8gZGVlcCBjb21wYXJlIGVhY2ggcHJvcGVydHkgdmFsdWUuCiAgICAgICAgcmV0dXJuIChyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkgJiYgaXNFcXVhbCh2YWx1ZSwgYltrZXldLCBzdGFja0EsIHN0YWNrQikpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAocmVzdWx0KSB7CiAgICAgIC8vIGVuc3VyZSBib3RoIG9iamVjdHMgaGF2ZSB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcwogICAgICBmb3JJbihiLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBiKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSkgewogICAgICAgICAgLy8gYHNpemVgIHdpbGwgYmUgYC0xYCBpZiBgYmAgaGFzIG1vcmUgcHJvcGVydGllcyB0aGFuIGBhYAogICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcywgb3IgY2FuIGJlIGNvZXJjZWQgdG8sIGEgZmluaXRlIG51bWJlci4KICAgKgogICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNGaW5pdGVgLCB3aGljaCB3aWxsIHJldHVybiB0cnVlIGZvcgogICAqIGJvb2xlYW5zIGFuZCBlbXB0eSBzdHJpbmdzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMS4yLjUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGZpbml0ZSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRmluaXRlKC0xMDEpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNGaW5pdGUoJzEwJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0Zpbml0ZSh0cnVlKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0Zpbml0ZSgnJyk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gaXNGaW5pdGUodmFsdWUpIHsKICAgIHJldHVybiBuYXRpdmVJc0Zpbml0ZSh2YWx1ZSkgJiYgIW5hdGl2ZUlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Z1bmN0aW9uKF8pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbic7CiAgfQogIC8vIGZhbGxiYWNrIGZvciBvbGRlciB2ZXJzaW9ucyBvZiBDaHJvbWUgYW5kIFNhZmFyaQogIGlmIChpc0Z1bmN0aW9uKC94LykpIHsKICAgIGlzRnVuY3Rpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBGdW5jdGlvbiB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBmdW5jQ2xhc3M7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgdGhlIGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0LgogICAqIChlLmcuIGFycmF5cywgZnVuY3Rpb25zLCBvYmplY3RzLCByZWdleGVzLCBgbmV3IE51bWJlcigwKWAsIGFuZCBgbmV3IFN0cmluZygnJylgKQogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc09iamVjdCh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc09iamVjdChbMSwgMiwgM10pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNPYmplY3QoMSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgLy8gY2hlY2sgaWYgdGhlIHZhbHVlIGlzIHRoZSBFQ01BU2NyaXB0IGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0CiAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3g4CiAgICAvLyBhbmQgYXZvaWQgYSBWOCBidWcKICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIyOTEKICAgIHJldHVybiB2YWx1ZSA/IG9iamVjdFR5cGVzW3R5cGVvZiB2YWx1ZV0gOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGBOYU5gLgogICAqCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc05hTmAsIHdoaWNoIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IKICAgKiBgdW5kZWZpbmVkYCBhbmQgb3RoZXIgdmFsdWVzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMS4yLjQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGBOYU5gLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOYU4oTmFOKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKG5ldyBOdW1iZXIoTmFOKSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc05hTih2YWx1ZSkgewogICAgLy8gYE5hTmAgYXMgYSBwcmltaXRpdmUgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBpcyBub3QgZXF1YWwgdG8gaXRzZWxmCiAgICAvLyAocGVyZm9ybSB0aGUgW1tDbGFzc11dIGNoZWNrIGZpcnN0IHRvIGF2b2lkIGVycm9ycyB3aXRoIHNvbWUgaG9zdCBvYmplY3RzIGluIElFKQogICAgcmV0dXJuIGlzTnVtYmVyKHZhbHVlKSAmJiB2YWx1ZSAhPSArdmFsdWUKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGBudWxsYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdWxsKG51bGwpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOdWxsKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgbnVtYmVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIG51bWJlciwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzTnVtYmVyKDguNCAqIDUpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGB2YWx1ZWAgaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIGZ1bmN0aW9uIFN0b29nZShuYW1lLCBhZ2UpIHsKICAgKiAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICogICB0aGlzLmFnZSA9IGFnZTsKICAgKiB9CiAgICoKICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFN0b29nZSgnbW9lJywgNDApKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNQbGFpbk9iamVjdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzUGxhaW5PYmplY3QgPSAhZ2V0UHJvdG90eXBlT2YgPyBzaGltSXNQbGFpbk9iamVjdCA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoISh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciB2YWx1ZU9mID0gdmFsdWUudmFsdWVPZiwKICAgICAgICBvYmpQcm90byA9IHR5cGVvZiB2YWx1ZU9mID09ICdmdW5jdGlvbicgJiYgKG9ialByb3RvID0gZ2V0UHJvdG90eXBlT2YodmFsdWVPZikpICYmIGdldFByb3RvdHlwZU9mKG9ialByb3RvKTsKCiAgICByZXR1cm4gb2JqUHJvdG8KICAgICAgPyB2YWx1ZSA9PSBvYmpQcm90byB8fCAoZ2V0UHJvdG90eXBlT2YodmFsdWUpID09IG9ialByb3RvICYmICFpc0FyZ3VtZW50cyh2YWx1ZSkpCiAgICAgIDogc2hpbUlzUGxhaW5PYmplY3QodmFsdWUpOwogIH07CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzUmVnRXhwKC9tb2UvKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFJlZ0V4cCB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIHN0cmluZywgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzU3RyaW5nKCdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gc3RyaW5nQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYHVuZGVmaW5lZGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc1VuZGVmaW5lZCh2b2lkIDApOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzsKICB9CgogIC8qKgogICAqIFJlY3Vyc2l2ZWx5IG1lcmdlcyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHRoZSBzb3VyY2Ugb2JqZWN0KHMpLCB0aGF0CiAgICogZG9uJ3QgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYCwgaW50byB0aGUgYGRlc3RpbmF0aW9uYCBvYmplY3QuIFN1YnNlcXVlbnQgc291cmNlcwogICAqIHdpbGwgb3ZlcndyaXRlIHByb3BlcnkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMgc291cmNlcy4gSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uCiAgICogaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIG1lcmdlZCB2YWx1ZXMgb2YgdGhlIGRlc3RpbmF0aW9uCiAgICogYW5kIHNvdXJjZSBvYmplY3QgcHJvcGVydGllcy4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkCiAgICogd2l0aCB0d28gYXJndW1lbnRzOyAob2JqZWN0VmFsdWUsIHNvdXJjZVZhbHVlKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBbc291cmNlMSwgc291cmNlMiwgLi4uXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIGZvciBlYWNoIHByb3BlcnR5IHRvIG1lcmdlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtpbmRpY2F0b3JdIEludGVybmFsbHkgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBgc3RhY2tgCiAgICogIGFyZ3VtZW50IGlzIGFuIGFycmF5IG9mIHRyYXZlcnNlZCBvYmplY3RzIGluc3RlYWQgb2YgYW5vdGhlciBzb3VyY2Ugb2JqZWN0LgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gdHJhY2sgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tCPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gYXNzb2NpYXRlIHZhbHVlcyB3aXRoIHRoZWlyCiAgICogIHNvdXJjZSBjb3VudGVycGFydHMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbmFtZXMgPSB7CiAgICogICAnc3Rvb2dlcyc6IFsKICAgKiAgICAgeyAnbmFtZSc6ICdtb2UnIH0sCiAgICogICAgIHsgJ25hbWUnOiAnbGFycnknIH0KICAgKiAgIF0KICAgKiB9OwogICAqCiAgICogdmFyIGFnZXMgPSB7CiAgICogICAnc3Rvb2dlcyc6IFsKICAgKiAgICAgeyAnYWdlJzogNDAgfSwKICAgKiAgICAgeyAnYWdlJzogNTAgfQogICAqICAgXQogICAqIH07CiAgICoKICAgKiBfLm1lcmdlKG5hbWVzLCBhZ2VzKTsKICAgKiAvLyA9PiB7ICdzdG9vZ2VzJzogW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0gfQogICAqLwogIGZ1bmN0aW9uIG1lcmdlKG9iamVjdCwgc291cmNlLCBpbmRpY2F0b3IpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgIGluZGV4ID0gMCwKICAgICAgICBsZW5ndGggPSAyOwoKICAgIGlmICghb2JqZWN0KSB7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CiAgICBpZiAoaW5kaWNhdG9yID09PSBpbmRpY2F0b3JPYmplY3QpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gYXJnc1szXSwKICAgICAgICAgIHN0YWNrQSA9IGFyZ3NbNF0sCiAgICAgICAgICBzdGFja0IgPSBhcmdzWzVdOwogICAgfQogICAgZWxzZSB7CiAgICAgIHN0YWNrQSA9IFtdOwogICAgICBzdGFja0IgPSBbXTsKICAgICAgaWYgKHR5cGVvZiBpbmRpY2F0b3IgIT0gJ251bWJlcicpIHsKICAgICAgICBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IHR5cGVvZiAoY2FsbGJhY2sgPSBhcmdzW2xlbmd0aCAtIDJdKSA9PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBhcmdzWy0tbGVuZ3RoXSkKICAgICAgICAgIDogKHR5cGVvZiAoY2FsbGJhY2sgPSBhcmdzW2xlbmd0aCAtIDFdKSA9PSAnZnVuY3Rpb24nICYmIGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShhcmdzW2luZGV4XSk7CiAgICAgIChpc0FyciA/IGZvckVhY2ggOiBmb3JPd24pKGFyZ3NbaW5kZXhdLCBmdW5jdGlvbihzb3VyY2UsIGtleSkgewogICAgICAgIHZhciBmb3VuZCwKICAgICAgICAgICAgaXNPYmosCiAgICAgICAgICAgIHZhbHVlID0gb2JqZWN0W2tleV07CgogICAgICAgIGlmIChzb3VyY2UgJiYgKChpc09iaiA9IGlzUGxhaW5PYmplY3Qoc291cmNlKSkgfHwgaXNBcnJheShzb3VyY2UpKSkgewogICAgICAgICAgLy8gYXZvaWQgbWVyZ2luZyBwcmV2aW91c2x5IG1lcmdlZCBjeWNsaWMgc291cmNlcwogICAgICAgICAgdmFyIHN0YWNrTGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdGFja0xlbmd0aC0tKSB7CiAgICAgICAgICAgIGlmICgoZm91bmQgPSBzdGFja0Fbc3RhY2tMZW5ndGhdID09IHNvdXJjZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IHN0YWNrQltzdGFja0xlbmd0aF07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgdmFsdWUgPSBpc09iagogICAgICAgICAgICAgID8gKGlzUGxhaW5PYmplY3QodmFsdWUpID8gdmFsdWUgOiB7fSkKICAgICAgICAgICAgICA6IChpc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW10pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhZGQgYHNvdXJjZWAgYW5kIGFzc29jaWF0ZWQgYHZhbHVlYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgICAgICAgICAgc3RhY2tBLnB1c2goc291cmNlKTsKICAgICAgICAgICAgc3RhY2tCLnB1c2godmFsdWUpOwoKICAgICAgICAgICAgLy8gcmVjdXJzaXZlbHkgbWVyZ2Ugb2JqZWN0cyBhbmQgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSAmJiBtZXJnZSh2YWx1ZSwgc291cmNlLCBpbmRpY2F0b3JPYmplY3QsIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpc0FyciB8fCB0eXBlb2Ygc291cmNlICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICB2YWx1ZSA9IHNvdXJjZTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgZXhjbHVkaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KICAgKiBQcm9wZXJ0eSBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZgogICAqIHByb3BlcnR5IG5hbWVzLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCBwcm9wZXJ0eQogICAqIGluIHRoZSBgb2JqZWN0YCwgb21pdHRpbmcgdGhlIHByb3BlcnRpZXMgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZQogICAqIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8W3Byb3AxLCBwcm9wMiwgLi4uXSBUaGUgcHJvcGVydGllcyB0byBvbWl0CiAgICogIG9yIHRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3Qgd2l0aG91dCB0aGUgb21pdHRlZCBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm9taXQoeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAsICd1c2VyaWQnOiAnbW9lMScgfSwgJ3VzZXJpZCcpOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgKgogICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdfaGludCc6ICdrbnVja2xlaGVhZCcsICdfc2VlZCc6ICc5NmM0ZWInIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApID09ICdfJzsKICAgKiB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAqLwogIGZ1bmN0aW9uIG9taXQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGlzRnVuYyA9IHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIGlmIChpc0Z1bmMpIHsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgcHJvcHMgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICBpZiAoaXNGdW5jCiAgICAgICAgICAgID8gIWNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkKICAgICAgICAgICAgOiBpbmRleE9mKHByb3BzLCBrZXksIDEpIDwgMAogICAgICAgICAgKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHR3byBkaW1lbnNpb25hbCBhcnJheSBvZiB0aGUgZ2l2ZW4gb2JqZWN0J3Mga2V5LXZhbHVlIHBhaXJzLAogICAqIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIG5ldyBhcnJheSBvZiBrZXktdmFsdWUgcGFpcnMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucGFpcnMoeyAnbW9lJzogMzAsICdsYXJyeSc6IDQwLCAnY3VybHknOiA1MCB9KTsKICAgKiAvLyA9PiBbWydtb2UnLCAzMF0sIFsnbGFycnknLCA0MF0sIFsnY3VybHknLCA1MF1dIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBwYWlycyhvYmplY3QpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgIHJlc3VsdFtpbmRleF0gPSBba2V5LCBvYmplY3Rba2V5XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgY29tcG9zZWQgb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mIHByb3BlcnR5CiAgICogbmFtZXMuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHByb3BlcnR5IGluIHRoZQogICAqIGBvYmplY3RgLCBwaWNraW5nIHRoZSBwcm9wZXJ0aWVzIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHNvdXJjZSBvYmplY3QuCiAgICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfFtwcm9wMSwgcHJvcDIsIC4uLl0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAqICBwZXIgaXRlcmF0aW9uIG9yIHByb3BlcnRpZXMgdG8gcGljaywgZWl0aGVyIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFycmF5cy4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIHBpY2tlZCBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnBpY2soeyAnbmFtZSc6ICdtb2UnLCAnX3VzZXJpZCc6ICdtb2UxJyB9LCAnbmFtZScpOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJyB9CiAgICoKICAgKiBfLnBpY2soeyAnbmFtZSc6ICdtb2UnLCAnX3VzZXJpZCc6ICdtb2UxJyB9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICogICByZXR1cm4ga2V5LmNoYXJBdCgwKSAhPSAnXyc7CiAgICogfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnIH0KICAgKi8KICBmdW5jdGlvbiBwaWNrKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgcHJvcHMgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gb2JqZWN0W2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IHZhbHVlcyBvZiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy52YWx1ZXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IG9iamVjdFtwcm9wc1tpbmRleF1dOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzIGZyb20gdGhlIHNwZWNpZmllZCBpbmRleChlcyksIG9yIGtleXMsIG9mIHRoZQogICAqIGBjb2xsZWN0aW9uYC4gSW5kZXhlcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cwogICAqIG9mIGluZGV4ZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7QXJyYXl8TnVtYmVyfFN0cmluZ30gW2luZGV4MSwgaW5kZXgyLCAuLi5dIFRoZSBpbmRleChlcykgb2YKICAgKiAgYGNvbGxlY3Rpb25gIHRvIHJldHJpZXZlLCBlaXRoZXIgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXJyYXlzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyBjb3JyZXNwb25kaW5nIHRvIHRoZQogICAqICBwcm92aWRlZCBpbmRleGVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmF0KFsnYScsICdiJywgJ2MnLCAnZCcsICdlJ10sIFswLCAyLCA0XSk7CiAgICogLy8gPT4gWydhJywgJ2MnLCAnZSddCiAgICoKICAgKiBfLmF0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIDAsIDIpOwogICAqIC8vID0+IFsnbW9lJywgJ2N1cmx5J10KICAgKi8KICBmdW5jdGlvbiBhdChjb2xsZWN0aW9uKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgc2xpY2UoYXJndW1lbnRzLCAxKSksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgaWYgKG5vQ2hhckJ5SW5kZXggJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpIHsKICAgICAgY29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uc3BsaXQoJycpOwogICAgfQogICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gY29sbGVjdGlvbltwcm9wc1tpbmRleF1dOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGB0YXJnZXRgIGVsZW1lbnQgaXMgcHJlc2VudCBpbiBhIGBjb2xsZWN0aW9uYCB1c2luZyBzdHJpY3QKICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaW5jbHVkZQogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gdGFyZ2V0IFRoZSB2YWx1ZSB0byBjaGVjayBmb3IuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHRhcmdldGAgZWxlbWVudCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5jb250YWlucyhbMSwgMiwgM10sIDEsIDIpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmNvbnRhaW5zKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sICdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKCdjdXJseScsICd1cicpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBmYWxzZTsKCiAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgcmVzdWx0ID0gKGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjb2xsZWN0aW9uLmluZGV4T2YodGFyZ2V0LCBmcm9tSW5kZXgpCiAgICAgICAgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KQogICAgICApID4gLTE7CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCsraW5kZXggPj0gZnJvbUluZGV4KSB7CiAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgcmV0dXJuZWQgZnJvbSBydW5uaW5nIGVhY2ggZWxlbWVudCBvZgogICAqIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb2YgZWFjaCBrZXkgaXMKICAgKiB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBrZXkgd2FzIHJldHVybmVkIGJ5IGBjYWxsYmFja2AuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICogVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBjb3VudCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBjb3VudCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jb3VudEJ5KFs0LjMsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IHsgJzQnOiAxLCAnNic6IDIgfQogICAqCiAgICogXy5jb3VudEJ5KFs0LjMsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IHsgJzQnOiAxLCAnNic6IDIgfQogICAqCiAgICogXy5jb3VudEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4geyAnMyc6IDIsICc1JzogMSB9CiAgICovCiAgZnVuY3Rpb24gY291bnRCeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgIGtleSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pICsgJyc7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgYSB0cnV0aHkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbGwKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYWxsIGVsZW1lbnRzIHBhc3MgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAqICBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXZlcnkoW3RydWUsIDEsIG51bGwsICd5ZXMnXSwgQm9vbGVhbik7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBldmVyeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZXN1bHQgPSAhIWNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAhIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyBhbiBhcnJheSBvZiBhbGwgZWxlbWVudHMKICAgKiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgc2VsZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgcGFzc2VkIHRoZSBjYWxsYmFjayBjaGVjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGV2ZW5zID0gXy5maWx0ZXIoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gWzIsIDQsIDZdCiAgICovCiAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogRXhhbWluZXMgZWFjaCBlbGVtZW50IGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgdGhlIGZpcnN0IG9uZSB0aGUgYGNhbGxiYWNrYAogICAqIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBhbiBhY2NlcHRhYmxlCiAgICogZWxlbWVudCwgYW5kIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBkZXRlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGVsZW1lbnQgdGhhdCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAqICBlbHNlIGB1bmRlZmluZWRgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZXZlbiA9IF8uZmluZChbMSwgMiwgMywgNCwgNSwgNl0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KTsKICAgKiAvLyA9PiAyCiAgICovCiAgZnVuY3Rpb24gZmluZChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdDsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGEgYGNvbGxlY3Rpb25gLCBleGVjdXRpbmcgdGhlIGBjYWxsYmFja2AgZm9yIGVhY2ggZWxlbWVudCBpbgogICAqIHRoZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24gZWFybHkKICAgKiBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGVhY2gKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fFN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS5mb3JFYWNoKGFsZXJ0KS5qb2luKCcsJyk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIGFuZCByZXR1cm5zICcxLDIsMycKICAgKgogICAqIF8uZm9yRWFjaCh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9LCBhbGVydCk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIHZhbHVlIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9CiAgICByZXR1cm4gY29sbGVjdGlvbjsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgcmV0dXJuZWQgZnJvbSBydW5uaW5nIGVhY2ggZWxlbWVudCBvZgogICAqIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb2YgZWFjaCBrZXkgaXMgYW4KICAgKiBhcnJheSBvZiBlbGVtZW50cyBwYXNzZWQgdG8gYGNhbGxiYWNrYCB0aGF0IHJldHVybmVkIHRoZSBrZXkuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICogVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBncm91cCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBncm91cCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgKgogICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgKiAvLyA9PiB7ICc0JzogWzQuMl0sICc2JzogWzYuMSwgNi40XSB9CiAgICoKICAgKiBfLmdyb3VwQnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiB7ICczJzogWydvbmUnLCAndHdvJ10sICc1JzogWyd0aHJlZSddIH0KICAgKi8KICBmdW5jdGlvbiBncm91cEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAga2V5ID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbikgKyAnJzsKICAgICAgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiByZXN1bHRba2V5XSA9IFtdKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEludm9rZXMgdGhlIG1ldGhvZCBuYW1lZCBieSBgbWV0aG9kTmFtZWAgb24gZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAsCiAgICogcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICogd2lsbCBiZSBwYXNzZWQgdG8gZWFjaCBpbnZva2VkIG1ldGhvZC4gSWYgYG1ldGhvZE5hbWVgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwKICAgKiBiZSBpbnZva2VkIGZvciwgYW5kIGB0aGlzYCBib3VuZCB0bywgZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gaW52b2tlIG9yCiAgICogIHRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgbWV0aG9kIHdpdGguCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW52b2tlKFtbNSwgMSwgN10sIFszLCAyLCAxXV0sICdzb3J0Jyk7CiAgICogLy8gPT4gW1sxLCA1LCA3XSwgWzEsIDIsIDNdXQogICAqCiAgICogXy5pbnZva2UoWzEyMywgNDU2XSwgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCwgJycpOwogICAqIC8vID0+IFtbJzEnLCAnMicsICczJ10sIFsnNCcsICc1JywgJzYnXV0KICAgKi8KICBmdW5jdGlvbiBpbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpLAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgaXNGdW5jID0gdHlwZW9mIG1ldGhvZE5hbWUgPT0gJ2Z1bmN0aW9uJywKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogdmFsdWVbbWV0aG9kTmFtZV0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdmFsdWVzIGJ5IHJ1bm5pbmcgZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAKICAgKiB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgKiB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBjb2xsZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWFwKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgKiAvLyA9PiBbMywgNiwgOV0KICAgKgogICAqIF8ubWFwKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogMzsgfSk7CiAgICogLy8gPT4gWzMsIDYsIDldIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBtYXAoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmVzdWx0WysraW5kZXhdID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgbWF4aW11bSB2YWx1ZSBvZiBhbiBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwKICAgKiBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHZhbHVlIGluIHRoZSBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZQogICAqIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUgaXMgcmFua2VkLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0bwogICAqIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLm1heChzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfTsKICAgKi8KICBmdW5jdGlvbiBtYXgoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICBpZiAoIWNhbGxiYWNrICYmIGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgaWYgKHZhbHVlID4gcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gIWNhbGxiYWNrICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjaGFyQXRDYWxsYmFjawogICAgICAgIDogY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgaWYgKGN1cnJlbnQgPiBjb21wdXRlZCkgewogICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIG1pbmltdW0gdmFsdWUgb2YgYW4gYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsCiAgICogaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgYGFycmF5YCB0byBnZW5lcmF0ZSB0aGUKICAgKiBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlIGlzIHJhbmtlZC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1pbihbMTAsIDUsIDEwMCwgMiwgMTAwMF0pOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBtaW4oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IEluZmluaXR5LAogICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAodmFsdWUgPCByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSAhY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICBpZiAoY3VycmVudCA8IGNvbXB1dGVkKSB7CiAgICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgcHJvcGVydHkgZnJvbSBhbGwgZWxlbWVudHMgaW4KICAgKiB0aGUgYGNvbGxlY3Rpb25gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIHBsdWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLnBsdWNrKHN0b29nZXMsICduYW1lJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnY3VybHknXQogICAqLwogIGZ1bmN0aW9uIHBsdWNrKGNvbGxlY3Rpb24sIHByb3BlcnR5KSB7CiAgICByZXR1cm4gbWFwKGNvbGxlY3Rpb24sIHByb3BlcnR5ICsgJycpOwogIH0KCiAgLyoqCiAgICogUmVkdWNlcyBhIGBjb2xsZWN0aW9uYCB0byBhIHNpbmdsZSB2YWx1ZS4gVGhlIGluaXRpYWwgc3RhdGUgb2YgdGhlIHJlZHVjdGlvbgogICAqIGlzIGBhY2N1bXVsYXRvcmAgYW5kIGVhY2ggc3VjY2Vzc2l2ZSBzdGVwIG9mIGl0IHNob3VsZCBiZSByZXR1cm5lZCBieSB0aGUKICAgKiBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBmb3VyCiAgICogYXJndW1lbnRzOyBmb3IgYXJyYXlzIHRoZXkgYXJlIChhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FjY3VtdWxhdG9yXSBJbml0aWFsIHZhbHVlIG9mIHRoZSBhY2N1bXVsYXRvci4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24obWVtbywgbnVtKSB7IHJldHVybiBtZW1vICsgbnVtOyB9KTsKICAgKiAvLyA9PiA2CiAgICovCiAgZnVuY3Rpb24gcmVkdWNlKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCBhY2N1bXVsYXRvciwgdGhpc0FyZykgewogICAgdmFyIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIGluZGljYXRvck9iamVjdCk7CgogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIGlmIChub2FjY3VtKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICB9CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IG5vYWNjdW0KICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICA6IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogIH0KCiAgLyoqCiAgICogVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byBgXy5yZWR1Y2VgLCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGEKICAgKiBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGZvbGRyCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGlzdCA9IFtbMCwgMV0sIFsyLCAzXSwgWzQsIDVdXTsKICAgKiB2YXIgZmxhdCA9IF8ucmVkdWNlUmlnaHQobGlzdCwgZnVuY3Rpb24oYSwgYikgeyByZXR1cm4gYS5jb25jYXQoYik7IH0sIFtdKTsKICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgKi8KICBmdW5jdGlvbiByZWR1Y2VSaWdodChjb2xsZWN0aW9uLCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcpIHsKICAgIHZhciBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CgogICAgaWYgKHR5cGVvZiBsZW5ndGggIT0gJ251bWJlcicpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhjb2xsZWN0aW9uKTsKICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgfSBlbHNlIGlmIChub0NoYXJCeUluZGV4ICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pKSB7CiAgICAgIGl0ZXJhYmxlID0gY29sbGVjdGlvbi5zcGxpdCgnJyk7CiAgICB9CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCBpbmRpY2F0b3JPYmplY3QpOwogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgaW5kZXggPSBwcm9wcyA/IHByb3BzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBhY2N1bXVsYXRvciA9IG5vYWNjdW0KICAgICAgICA/IChub2FjY3VtID0gZmFsc2UsIGl0ZXJhYmxlW2luZGV4XSkKICAgICAgICA6IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgIH0pOwogICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogIH0KCiAgLyoqCiAgICogVGhlIG9wcG9zaXRlIG9mIGBfLmZpbHRlcmAsIHRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGVsZW1lbnRzIG9mIGEKICAgKiBgY29sbGVjdGlvbmAgdGhhdCBgY2FsbGJhY2tgIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1dGh5IGZvci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyB0aGF0IGRpZCAqKm5vdCoqIHBhc3MgdGhlCiAgICogIGNhbGxiYWNrIGNoZWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IFsxLCAzLCA1XQogICAqLwogIGZ1bmN0aW9uIHJlamVjdChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICByZXR1cm4gZmlsdGVyKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICByZXR1cm4gIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICB9KTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgYGFycmF5YCB2YWx1ZXMsIHVzaW5nIGEgdmVyc2lvbiBvZiB0aGUKICAgKiBGaXNoZXItWWF0ZXMgc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2h1ZmZsZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICogLy8gPT4gWzQsIDEsIDYsIDMsIDUsIDJdCiAgICovCiAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByYW5kID0gZmxvb3IobmF0aXZlUmFuZG9tKCkgKiAoKytpbmRleCArIDEpKTsKICAgICAgcmVzdWx0W2luZGV4XSA9IHJlc3VsdFtyYW5kXTsKICAgICAgcmVzdWx0W3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBzaXplIG9mIHRoZSBgY29sbGVjdGlvbmAgYnkgcmV0dXJuaW5nIGBjb2xsZWN0aW9uLmxlbmd0aGAgZm9yIGFycmF5cwogICAqIGFuZCBhcnJheS1saWtlIG9iamVjdHMgb3IgdGhlIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGZvciBvYmplY3RzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBgY29sbGVjdGlvbi5sZW5ndGhgIG9yIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNpemUoWzEsIDJdKTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiBfLnNpemUoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gMwogICAqCiAgICogXy5zaXplKCdjdXJseScpOwogICAqIC8vID0+IDUKICAgKi8KICBmdW5jdGlvbiBzaXplKGNvbGxlY3Rpb24pIHsKICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgcmV0dXJuIHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiBrZXlzKGNvbGxlY3Rpb24pLmxlbmd0aDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIGEgdHJ1dGh5IHZhbHVlIGZvciAqKmFueSoqIGVsZW1lbnQgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBwYXNzaW5nIHZhbHVlLCBhbmQKICAgKiBkb2VzIG5vdCBpdGVyYXRlIG92ZXIgdGhlIGVudGlyZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgYW55CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFueSBlbGVtZW50IHBhc3NlcyB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gc29tZShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdDsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmICgocmVzdWx0ID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gIShyZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5LCBzdGFibGUgc29ydGVkIGluIGFzY2VuZGluZyBvcmRlciBieSB0aGUgcmVzdWx0cyBvZgogICAqIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIHNvcnQgYnkgKGUuZy4gJ2xlbmd0aCcpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8cHJvcGVydHkgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uCiAgICogIG9yIHByb3BlcnR5IG5hbWUgdG8gc29ydCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHNvcnRlZCBlbGVtZW50cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguc2luKG51bSk7IH0pOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuc2luKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWydsYXJyeScsICdicmVuZGFuJywgJ21vZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnYnJlbmRhbiddCiAgICovCiAgZnVuY3Rpb24gc29ydEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICByZXN1bHRbKytpbmRleF0gPSB7CiAgICAgICAgJ2NyaXRlcmlhJzogY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbiksCiAgICAgICAgJ2luZGV4JzogaW5kZXgsCiAgICAgICAgJ3ZhbHVlJzogdmFsdWUKICAgICAgfTsKICAgIH0pOwoKICAgIGxlbmd0aCA9IHJlc3VsdC5sZW5ndGg7CiAgICByZXN1bHQuc29ydChjb21wYXJlQXNjZW5kaW5nKTsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICByZXN1bHRbbGVuZ3RoXSA9IHJlc3VsdFtsZW5ndGhdLnZhbHVlOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gY29udmVydC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgKiAvLyA9PiBbMiwgMywgNF0KICAgKi8KICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgIGlmIChjb2xsZWN0aW9uICYmIHR5cGVvZiBjb2xsZWN0aW9uLmxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICByZXR1cm4gbm9DaGFyQnlJbmRleCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKQogICAgICAgID8gY29sbGVjdGlvbi5zcGxpdCgnJykKICAgICAgICA6IHNsaWNlKGNvbGxlY3Rpb24pOwogICAgfQogICAgcmV0dXJuIHZhbHVlcyhjb2xsZWN0aW9uKTsKICB9CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggZWxlbWVudCBpbiBhIGBjb2xsZWN0aW9uYCwgcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFsbCBlbGVtZW50cwogICAqIHRoYXQgY29udGFpbiB0aGUgZ2l2ZW4gYHByb3BlcnRpZXNgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBmaWx0ZXIgYnkuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgY29udGFpbiB0aGUgZ2l2ZW4gYHByb3BlcnRpZXNgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogXy53aGVyZShzdG9vZ2VzLCB7ICdhZ2UnOiA0MCB9KTsKICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfV0KICAgKi8KICBmdW5jdGlvbiB3aGVyZShjb2xsZWN0aW9uLCBwcm9wZXJ0aWVzKSB7CiAgICByZXR1cm4gZmlsdGVyKGNvbGxlY3Rpb24sIHByb3BlcnRpZXMpOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgd2l0aCBhbGwgZmFsc2V5IHZhbHVlcyBvZiBgYXJyYXlgIHJlbW92ZWQuIFRoZSB2YWx1ZXMKICAgKiBgZmFsc2VgLCBgbnVsbGAsIGAwYCwgYCIiYCwgYHVuZGVmaW5lZGAgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmaWx0ZXJlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jb21wYWN0KFswLCAxLCBmYWxzZSwgMiwgJycsIDNdKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAodmFsdWUpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGBhcnJheWAgZWxlbWVudHMgbm90IHByZXNlbnQgaW4gdGhlIG90aGVyIGFycmF5cwogICAqIHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgYGFycmF5YCBlbGVtZW50cyBub3QgcHJlc2VudCBpbiB0aGUKICAgKiAgb3RoZXIgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmRpZmZlcmVuY2UoWzEsIDIsIDMsIDQsIDVdLCBbNSwgMiwgMTBdKTsKICAgKiAvLyA9PiBbMSwgMywgNF0KICAgKi8KICBmdW5jdGlvbiBkaWZmZXJlbmNlKGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgZmxhdHRlbmVkID0gY29uY2F0LmFwcGx5KGFycmF5UmVmLCBhcmd1bWVudHMpLAogICAgICAgIGNvbnRhaW5zID0gY2FjaGVkQ29udGFpbnMoZmxhdHRlbmVkLCBsZW5ndGgpLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKCFjb250YWlucyh2YWx1ZSkpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBmaXJzdCBlbGVtZW50IG9mIHRoZSBgYXJyYXlgLiBJZiBhIG51bWJlciBgbmAgaXMgcGFzc2VkLCB0aGUgZmlyc3QKICAgKiBgbmAgZWxlbWVudHMgb2YgdGhlIGBhcnJheWAgYXJlIHJldHVybmVkLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLAogICAqIHRoZSBmaXJzdCBlbGVtZW50cyB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IgYXJlIHJldHVybmVkLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGhlYWQsIHRha2UKICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7RnVuY3Rpb258TnVtYmVyfSBbY2FsbGJhY2t8bl0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiAxCiAgICoKICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzEsIDJdCiAgICoKICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtIDwgMzsKICAgKiB9KTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKi8KICBmdW5jdGlvbiBmaXJzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChhcnJheSkgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IGNhbGxiYWNrOwogICAgICAgIGlmIChuID09IG51bGwgfHwgdGhpc0FyZykgewogICAgICAgICAgcmV0dXJuIGFycmF5WzBdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIDAsIG5hdGl2ZU1pbihuYXRpdmVNYXgoMCwgbiksIGxlbmd0aCkpOwogICAgfQogIH0KCiAgLyoqCiAgICogRmxhdHRlbnMgYSBuZXN0ZWQgYXJyYXkgKHRoZSBuZXN0aW5nIGNhbiBiZSB0byBhbnkgZGVwdGgpLiBJZiBgc2hhbGxvd2AgaXMKICAgKiB0cnV0aHksIGBhcnJheWAgd2lsbCBvbmx5IGJlIGZsYXR0ZW5lZCBhIHNpbmdsZSBsZXZlbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IHNoYWxsb3cgQSBmbGFnIHRvIGluZGljYXRlIG9ubHkgZmxhdHRlbmluZyBhIHNpbmdsZSBsZXZlbC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0pOwogICAqIC8vID0+IFsxLCAyLCAzLCA0XTsKICAgKgogICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSwgdHJ1ZSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIFtbNF1dXTsKICAgKi8KICBmdW5jdGlvbiBmbGF0dGVuKGFycmF5LCBzaGFsbG93KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgLy8gcmVjdXJzaXZlbHkgZmxhdHRlbiBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdCwgc2hhbGxvdyA/IHZhbHVlIDogZmxhdHRlbih2YWx1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcKICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5CiAgICogc29ydGVkLCBwYXNzaW5nIGB0cnVlYCBmb3IgYGZyb21JbmRleGAgd2lsbCBydW4gYSBmYXN0ZXIgYmluYXJ5IHNlYXJjaC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7Qm9vbGVhbnxOdW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tIG9yIGB0cnVlYCB0bwogICAqICBwZXJmb3JtIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBgYXJyYXlgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDEKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIsIDMpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMSwgMiwgMiwgMywgM10sIDIsIHRydWUpOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT0gJ251bWJlcicpIHsKICAgICAgaW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4IHx8IDApIC0gMTsKICAgIH0gZWxzZSBpZiAoZnJvbUluZGV4KSB7CiAgICAgIGluZGV4ID0gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlKTsKICAgICAgcmV0dXJuIGFycmF5W2luZGV4XSA9PT0gdmFsdWUgPyBpbmRleCA6IC0xOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIEdldHMgYWxsIGJ1dCB0aGUgbGFzdCBlbGVtZW50IG9mIGBhcnJheWAuIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZQogICAqIGxhc3QgYG5gIGVsZW1lbnRzIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbgogICAqIGlzIHBhc3NlZCwgdGhlIGxhc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yIGFyZSBleGNsdWRlZAogICAqIGZyb20gdGhlIHJlc3VsdC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGVsZW1lbnQgb3IKICAgKiAgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKgogICAqIF8uaW5pdGlhbChbMSwgMiwgM10sIDIpOwogICAqIC8vID0+IFsxXQogICAqCiAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtID4gMTsKICAgKiB9KTsKICAgKiAvLyA9PiBbMV0KICAgKi8KICBmdW5jdGlvbiBpbml0aWFsKGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICB2YXIgbiA9IDAsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB3aGlsZSAoaW5kZXgtLSAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICBuKys7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBjYWxsYmFjayB8fCBuOwogICAgfQogICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pLCBsZW5ndGgpKTsKICB9CgogIC8qKgogICAqIENvbXB1dGVzIHRoZSBpbnRlcnNlY3Rpb24gb2YgYWxsIHRoZSBwYXNzZWQtaW4gYXJyYXlzIHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAqIGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHVuaXF1ZSBlbGVtZW50cyB0aGF0IGFyZSBwcmVzZW50CiAgICogIGluICoqYWxsKiogb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbnRlcnNlY3Rpb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICogLy8gPT4gWzEsIDJdCiAgICovCiAgZnVuY3Rpb24gaW50ZXJzZWN0aW9uKGFycmF5KSB7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgY2FjaGUgPSB7ICcwJzoge30gfSwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBpc0xhcmdlID0gbGVuZ3RoID49IDEwMCwKICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICBzZWVuID0gcmVzdWx0OwoKICAgIG91dGVyOgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSB2YWx1ZSArICcnOwogICAgICAgIHZhciBpbml0ZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlWzBdLCBrZXkpCiAgICAgICAgICA/ICEoc2VlbiA9IGNhY2hlWzBdW2tleV0pCiAgICAgICAgICA6IChzZWVuID0gY2FjaGVbMF1ba2V5XSA9IFtdKTsKICAgICAgfQogICAgICBpZiAoaW5pdGVkIHx8IGluZGV4T2Yoc2VlbiwgdmFsdWUpIDwgMCkgewogICAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgICB2YXIgYXJnc0luZGV4ID0gYXJnc0xlbmd0aDsKICAgICAgICB3aGlsZSAoLS1hcmdzSW5kZXgpIHsKICAgICAgICAgIGlmICghKGNhY2hlW2FyZ3NJbmRleF0gfHwgKGNhY2hlW2FyZ3NJbmRleF0gPSBjYWNoZWRDb250YWlucyhhcmdzW2FyZ3NJbmRleF0sIDAsIDEwMCkpKSh2YWx1ZSkpIHsKICAgICAgICAgICAgY29udGludWUgb3V0ZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGxhc3QgZWxlbWVudCBvZiB0aGUgYGFycmF5YC4gSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlIGxhc3QKICAgKiBgbmAgZWxlbWVudHMgb2YgdGhlIGBhcnJheWAgYXJlIHJldHVybmVkLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLAogICAqIHRoZSBsYXN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvciBhcmUgcmV0dXJuZWQuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7RnVuY3Rpb258TnVtYmVyfSBbY2FsbGJhY2t8bl0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBsYXN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gMwogICAqCiAgICogXy5sYXN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzIsIDNdCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPiAxOwogICAqIH0pOwogICAqIC8vID0+IFsyLCAzXQogICAqLwogIGZ1bmN0aW9uIGxhc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXlbbGVuZ3RoIC0gMV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgbmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pKTsKICAgIH0KICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBsYXN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCB1c2luZyBzdHJpY3QKICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD1hcnJheS5sZW5ndGgtMV0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiA0CiAgICoKICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gMQogICAqLwogIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGluZGV4ICsgZnJvbUluZGV4KSA6IG5hdGl2ZU1pbihmcm9tSW5kZXgsIGluZGV4IC0gMSkpICsgMTsKICAgIH0KICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBmcm9tIGFycmF5cyBvZiBga2V5c2AgYW5kIGB2YWx1ZXNgLiBQYXNzIGVpdGhlcgogICAqIGEgc2luZ2xlIHR3byBkaW1lbnNpb25hbCBhcnJheSwgaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLCBvcgogICAqIHR3byBhcnJheXMsIG9uZSBvZiBga2V5c2AgYW5kIG9uZSBvZiBjb3JyZXNwb25kaW5nIGB2YWx1ZXNgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGFycmF5IG9mIGtleXMuCiAgICogQHBhcmFtIHtBcnJheX0gW3ZhbHVlcz1bXV0gVGhlIGFycmF5IG9mIHZhbHVlcy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4ga2V5cyBhbmQKICAgKiAgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ub2JqZWN0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIFszMCwgNDAsIDUwXSk7CiAgICogLy8gPT4geyAnbW9lJzogMzAsICdsYXJyeSc6IDQwLCAnY3VybHknOiA1MCB9CiAgICovCiAgZnVuY3Rpb24gb2JqZWN0KGtleXMsIHZhbHVlcykgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0ga2V5cyA/IGtleXMubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIga2V5ID0ga2V5c1tpbmRleF07CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2tleVswXV0gPSBrZXlbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG51bWJlcnMgKHBvc2l0aXZlIGFuZC9vciBuZWdhdGl2ZSkgcHJvZ3Jlc3NpbmcgZnJvbQogICAqIGBzdGFydGAgdXAgdG8gYnV0IG5vdCBpbmNsdWRpbmcgYGVuZGAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtzdGVwPTFdIFRoZSB2YWx1ZSB0byBpbmNyZW1lbnQgb3IgZGVzY3JlbWVudCBieS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgcmFuZ2UgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucmFuZ2UoMTApOwogICAqIC8vID0+IFswLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5XQogICAqCiAgICogXy5yYW5nZSgxLCAxMSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwXQogICAqCiAgICogXy5yYW5nZSgwLCAzMCwgNSk7CiAgICogLy8gPT4gWzAsIDUsIDEwLCAxNSwgMjAsIDI1XQogICAqCiAgICogXy5yYW5nZSgwLCAtMTAsIC0xKTsKICAgKiAvLyA9PiBbMCwgLTEsIC0yLCAtMywgLTQsIC01LCAtNiwgLTcsIC04LCAtOV0KICAgKgogICAqIF8ucmFuZ2UoMCk7CiAgICogLy8gPT4gW10KICAgKi8KICBmdW5jdGlvbiByYW5nZShzdGFydCwgZW5kLCBzdGVwKSB7CiAgICBzdGFydCA9ICtzdGFydCB8fCAwOwogICAgc3RlcCA9ICtzdGVwIHx8IDE7CgogICAgaWYgKGVuZCA9PSBudWxsKSB7CiAgICAgIGVuZCA9IHN0YXJ0OwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICAvLyB1c2UgYEFycmF5KGxlbmd0aClgIHNvIFY4IHdpbGwgYXZvaWQgdGhlIHNsb3dlciAiZGljdGlvbmFyeSIgbW9kZQogICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBuYXRpdmVNYXgoMCwgY2VpbCgoZW5kIC0gc3RhcnQpIC8gc3RlcCkpLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5pbml0aWFsYCwgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCB2YWx1ZSBvZiBgYXJyYXlgLgogICAqIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZSBmaXJzdCBgbmAgdmFsdWVzIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuCiAgICogSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uIGlzIHBhc3NlZCwgdGhlIGZpcnN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMKICAgKiB0cnV0aHkgZm9yIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAqIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZHJvcCwgdGFpbAogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGVsZW1lbnQgb3IKICAgKiAgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJlc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBbMiwgM10KICAgKgogICAqIF8ucmVzdChbMSwgMiwgM10sIDIpOwogICAqIC8vID0+IFszXQogICAqCiAgICogXy5yZXN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtIDwgMzsKICAgKiB9KTsKICAgKiAvLyA9PiBbM10KICAgKi8KICBmdW5jdGlvbiByZXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGggJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgbisrOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBuID0gKGNhbGxiYWNrID09IG51bGwgfHwgdGhpc0FyZykgPyAxIDogbmF0aXZlTWF4KDAsIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBzbGljZShhcnJheSwgbik7CiAgfQoKICAvKioKICAgKiBVc2VzIGEgYmluYXJ5IHNlYXJjaCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIHRoZSBgdmFsdWVgCiAgICogc2hvdWxkIGJlIGluc2VydGVkIGludG8gYGFycmF5YCBpbiBvcmRlciB0byBtYWludGFpbiB0aGUgc29ydCBvcmRlciBvZiB0aGUKICAgKiBzb3J0ZWQgYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGB2YWx1ZWAgYW5kCiAgICogZWFjaCBlbGVtZW50IGluIGBhcnJheWAgdG8gY29tcHV0ZSB0aGVpciBzb3J0IHJhbmtpbmcuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLiBUaGUgYGNhbGxiYWNrYAogICAqIGFyZ3VtZW50IG1heSBhbHNvIGJlIHRoZSBuYW1lIG9mIGEgcHJvcGVydHkgdG8gb3JkZXIgYnkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eXxwcm9wZXJ0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAqICBwZXIgaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWUgdG8gb3JkZXIgYnkuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSB2YWx1ZSBzaG91bGQgYmUgaW5zZXJ0ZWQKICAgKiAgaW50byBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsyMCwgMzAsIDUwXSwgNDApOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc29ydGVkSW5kZXgoW3sgJ3gnOiAyMCB9LCB7ICd4JzogMzAgfSwgeyAneCc6IDUwIH1dLCB7ICd4JzogNDAgfSwgJ3gnKTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiB2YXIgZGljdCA9IHsKICAgKiAgICd3b3JkVG9OdW1iZXInOiB7ICd0d2VudHknOiAyMCwgJ3RoaXJ0eSc6IDMwLCAnZm91cnR5JzogNDAsICdmaWZ0eSc6IDUwIH0KICAgKiB9OwogICAqCiAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgKiAgIHJldHVybiBkaWN0LndvcmRUb051bWJlclt3b3JkXTsKICAgKiB9KTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAqICAgcmV0dXJuIHRoaXMud29yZFRvTnVtYmVyW3dvcmRdOwogICAqIH0sIGRpY3QpOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgbG93ID0gMCwKICAgICAgICBoaWdoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiBsb3c7CgogICAgLy8gZXhwbGljaXRseSByZWZlcmVuY2UgYGlkZW50aXR5YCBmb3IgYmV0dGVyIGlubGluaW5nIGluIEZpcmVmb3gKICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPyBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZykgOiBpZGVudGl0eTsKICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUpOwoKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSAobG93ICsgaGlnaCkgPj4+IDE7CiAgICAgIGNhbGxiYWNrKGFycmF5W21pZF0pIDwgdmFsdWUKICAgICAgICA/IGxvdyA9IG1pZCArIDEKICAgICAgICA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH0KCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHVuaW9uIG9mIHRoZSBwYXNzZWQtaW4gYXJyYXlzIHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IKICAgKiBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCB0aGF0IGFyZQogICAqICBwcmVzZW50IGluIG9uZSBvciBtb3JlIG9mIHRoZSBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDEwMSwgMTBdCiAgICovCiAgZnVuY3Rpb24gdW5pb24oKSB7CiAgICByZXR1cm4gdW5pcShjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cykpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGBhcnJheWAgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5IHNvcnRlZCwgcGFzc2luZyBgdHJ1ZWAKICAgKiBmb3IgYGlzU29ydGVkYCB3aWxsIHJ1biBhIGZhc3RlciBhbGdvcml0aG0uIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBlYWNoCiAgICogZWxlbWVudCBvZiBgYXJyYXlgIGlzIHBhc3NlZCB0aHJvdWdoIGEgY2FsbGJhY2tgIGJlZm9yZSB1bmlxdWVuZXNzIGlzIGNvbXB1dGVkLgogICAqIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHVuaXF1ZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgdGhlIGBhcnJheWAgaXMgYWxyZWFkeSBzb3J0ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEsIDMsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMSwgMiwgMiwgM10sIHRydWUpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLjUsIDMsIDIuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMiwgMS41LCAzLCAyLjVdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gdW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW10sCiAgICAgICAgc2VlbiA9IHJlc3VsdDsKCiAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICBjYWxsYmFjayA9IGlzU29ydGVkOwogICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgfQogICAgLy8gaW5pdCB2YWx1ZSBjYWNoZSBmb3IgbGFyZ2UgYXJyYXlzCiAgICB2YXIgaXNMYXJnZSA9ICFpc1NvcnRlZCAmJiBsZW5ndGggPj0gNzU7CiAgICBpZiAoaXNMYXJnZSkgewogICAgICB2YXIgY2FjaGUgPSB7fTsKICAgIH0KICAgIGlmIChjYWxsYmFjaykgewogICAgICBzZWVuID0gW107CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdLAogICAgICAgICAgY29tcHV0ZWQgPSBjYWxsYmFjayA/IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgYXJyYXkpIDogdmFsdWU7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSBjb21wdXRlZCArICcnOwogICAgICAgIHZhciBpbml0ZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/ICEoc2VlbiA9IGNhY2hlW2tleV0pCiAgICAgICAgICA6IChzZWVuID0gY2FjaGVba2V5XSA9IFtdKTsKICAgICAgfQogICAgICBpZiAoaXNTb3J0ZWQKICAgICAgICAgICAgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSBjb21wdXRlZAogICAgICAgICAgICA6IGluaXRlZCB8fCBpbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDAKICAgICAgICAgICkgewogICAgICAgIGlmIChjYWxsYmFjayB8fCBpc0xhcmdlKSB7CiAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IHdpdGggYWxsIG9jY3VycmVuY2VzIG9mIHRoZSBwYXNzZWQgdmFsdWVzIHJlbW92ZWQgdXNpbmcKICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gW3ZhbHVlMSwgdmFsdWUyLCAuLi5dIFZhbHVlcyB0byByZW1vdmUuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZpbHRlcmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLndpdGhvdXQoWzEsIDIsIDEsIDAsIDMsIDEsIDRdLCAwLCAxKTsKICAgKiAvLyA9PiBbMiwgMywgNF0KICAgKi8KICBmdW5jdGlvbiB3aXRob3V0KGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgY29udGFpbnMgPSBjYWNoZWRDb250YWlucyhhcmd1bWVudHMsIDEpLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKCFjb250YWlucyh2YWx1ZSkpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHcm91cHMgdGhlIGVsZW1lbnRzIG9mIGVhY2ggYXJyYXkgYXQgdGhlaXIgY29ycmVzcG9uZGluZyBpbmRleGVzLiBVc2VmdWwgZm9yCiAgICogc2VwYXJhdGUgZGF0YSBzb3VyY2VzIHRoYXQgYXJlIGNvb3JkaW5hdGVkIHRocm91Z2ggbWF0Y2hpbmcgYXJyYXkgaW5kZXhlcy4KICAgKiBGb3IgYSBtYXRyaXggb2YgbmVzdGVkIGFycmF5cywgYF8uemlwLmFwcGx5KC4uLilgIGNhbiB0cmFuc3Bvc2UgdGhlIG1hdHJpeAogICAqIGluIGEgc2ltaWxhciBmYXNoaW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy56aXAoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgWzMwLCA0MCwgNTBdLCBbdHJ1ZSwgZmFsc2UsIGZhbHNlXSk7CiAgICogLy8gPT4gW1snbW9lJywgMzAsIHRydWVdLCBbJ2xhcnJ5JywgNDAsIGZhbHNlXSwgWydjdXJseScsIDUwLCBmYWxzZV1dCiAgICovCiAgZnVuY3Rpb24gemlwKGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IG1heChwbHVjayhhcmd1bWVudHMsICdsZW5ndGgnKSkgOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHBsdWNrKGFyZ3VtZW50cywgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIGV4ZWN1dGluZyBgZnVuY2Agb25seSBhZnRlciBpdCBpcwogICAqIGNhbGxlZCBgbmAgdGltZXMuIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlCiAgICogY3JlYXRlZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge051bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBmdW5jdGlvbiBtdXN0IGJlIGNhbGxlZCBiZWZvcmUKICAgKiBpdCBpcyBleGVjdXRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgcmVuZGVyTm90ZXMgPSBfLmFmdGVyKG5vdGVzLmxlbmd0aCwgcmVuZGVyKTsKICAgKiBfLmZvckVhY2gobm90ZXMsIGZ1bmN0aW9uKG5vdGUpIHsKICAgKiAgIG5vdGUuYXN5bmNTYXZlKHsgJ3N1Y2Nlc3MnOiByZW5kZXJOb3RlcyB9KTsKICAgKiB9KTsKICAgKiAvLyBgcmVuZGVyTm90ZXNgIGlzIHJ1biBvbmNlLCBhZnRlciBhbGwgbm90ZXMgaGF2ZSBzYXZlZAogICAqLwogIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgIGlmIChuIDwgMSkgewogICAgICByZXR1cm4gZnVuYygpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS1uIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggdGhlIGB0aGlzYAogICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICogcGFzc2VkIHRvIHRoZSBib3VuZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgdGhpcy5uYW1lOwogICAqIH07CiAgICoKICAgKiBmdW5jID0gXy5iaW5kKGZ1bmMsIHsgJ25hbWUnOiAnbW9lJyB9LCAnaGknKTsKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpIG1vZScKICAgKi8KICBmdW5jdGlvbiBiaW5kKGZ1bmMsIHRoaXNBcmcpIHsKICAgIC8vIHVzZSBgRnVuY3Rpb24jYmluZGAgaWYgaXQgZXhpc3RzIGFuZCBpcyBmYXN0CiAgICAvLyAoaW4gVjggYEZ1bmN0aW9uI2JpbmRgIGlzIHNsb3dlciBleGNlcHQgd2hlbiBwYXJ0aWFsbHkgYXBwbGllZCkKICAgIHJldHVybiBpc0JpbmRGYXN0IHx8IChuYXRpdmVCaW5kICYmIGFyZ3VtZW50cy5sZW5ndGggPiAyKQogICAgICA/IG5hdGl2ZUJpbmQuY2FsbC5hcHBseShuYXRpdmVCaW5kLCBhcmd1bWVudHMpCiAgICAgIDogY3JlYXRlQm91bmQoZnVuYywgdGhpc0FyZywgc2xpY2UoYXJndW1lbnRzLCAyKSk7CiAgfQoKICAvKioKICAgKiBCaW5kcyBtZXRob2RzIG9uIGBvYmplY3RgIHRvIGBvYmplY3RgLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcgbWV0aG9kLgogICAqIE1ldGhvZCBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZiBtZXRob2QKICAgKiBuYW1lcy4gSWYgbm8gbWV0aG9kIG5hbWVzIGFyZSBwcm92aWRlZCwgYWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgCiAgICogd2lsbCBiZSBib3VuZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYmluZCBhbmQgYXNzaWduIHRoZSBib3VuZCBtZXRob2RzIHRvLgogICAqIEBwYXJhbSB7U3RyaW5nfSBbbWV0aG9kTmFtZTEsIG1ldGhvZE5hbWUyLCAuLi5dIE1ldGhvZCBuYW1lcyBvbiB0aGUgb2JqZWN0IHRvIGJpbmQuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGJ1dHRvblZpZXcgPSB7CiAgICogICdsYWJlbCc6ICdsb2Rhc2gnLAogICAqICAnb25DbGljayc6IGZ1bmN0aW9uKCkgeyBhbGVydCgnY2xpY2tlZDogJyArIHRoaXMubGFiZWwpOyB9CiAgICogfTsKICAgKgogICAqIF8uYmluZEFsbChidXR0b25WaWV3KTsKICAgKiBqUXVlcnkoJyNsb2Rhc2hfYnV0dG9uJykub24oJ2NsaWNrJywgYnV0dG9uVmlldy5vbkNsaWNrKTsKICAgKiAvLyA9PiBXaGVuIHRoZSBidXR0b24gaXMgY2xpY2tlZCwgYHRoaXMubGFiZWxgIHdpbGwgaGF2ZSB0aGUgY29ycmVjdCB2YWx1ZQogICAqLwogIGZ1bmN0aW9uIGJpbmRBbGwob2JqZWN0KSB7CiAgICB2YXIgZnVuY3MgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgaW5kZXggPSBmdW5jcy5sZW5ndGggPiAxID8gMCA6IChmdW5jcyA9IGZ1bmN0aW9ucyhvYmplY3QpLCAtMSksCiAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBmdW5jc1tpbmRleF07CiAgICAgIG9iamVjdFtrZXldID0gYmluZChvYmplY3Rba2V5XSwgb2JqZWN0KTsKICAgIH0KICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgdGhlIG1ldGhvZCBhdCBgb2JqZWN0W2tleV1gCiAgICogYW5kIHByZXBlbmRzIGFueSBhZGRpdGlvbmFsIGBiaW5kS2V5YCBhcmd1bWVudHMgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSBib3VuZAogICAqIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZCBkaWZmZXJzIGZyb20gYF8uYmluZGAgYnkgYWxsb3dpbmcgYm91bmQgZnVuY3Rpb25zIHRvCiAgICogcmVmZXJlbmNlIG1ldGhvZHMgdGhhdCB3aWxsIGJlIHJlZGVmaW5lZCBvciBkb24ndCB5ZXQgZXhpc3QuCiAgICogU2VlIGh0dHA6Ly9taWNoYXV4LmNhL2FydGljbGVzL2xhenktZnVuY3Rpb24tZGVmaW5pdGlvbi1wYXR0ZXJuLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGUgbWV0aG9kIGJlbG9uZ3MgdG8uCiAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBtZXRob2QuCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2JqZWN0ID0gewogICAqICAgJ25hbWUnOiAnbW9lJywKICAgKiAgICdncmVldCc6IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICAgIHJldHVybiBncmVldGluZyArICcgJyArIHRoaXMubmFtZTsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpIG1vZScKICAgKgogICAqIG9iamVjdC5ncmVldCA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnLCAnICsgdGhpcy5uYW1lICsgJyEnOwogICAqIH07CiAgICoKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpLCBtb2UhJwogICAqLwogIGZ1bmN0aW9uIGJpbmRLZXkob2JqZWN0LCBrZXkpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChvYmplY3QsIGtleSwgc2xpY2UoYXJndW1lbnRzLCAyKSk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHBhc3NlZCBmdW5jdGlvbnMsCiAgICogd2hlcmUgZWFjaCBmdW5jdGlvbiBjb25zdW1lcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAqIEVhY2ggZnVuY3Rpb24gaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNvbXBvc2VkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtmdW5jMSwgZnVuYzIsIC4uLl0gRnVuY3Rpb25zIHRvIGNvbXBvc2UuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29tcG9zZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBncmVldCA9IGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuICdoaTogJyArIG5hbWU7IH07CiAgICogdmFyIGV4Y2xhaW0gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsgcmV0dXJuIHN0YXRlbWVudCArICchJzsgfTsKICAgKiB2YXIgd2VsY29tZSA9IF8uY29tcG9zZShleGNsYWltLCBncmVldCk7CiAgICogd2VsY29tZSgnbW9lJyk7CiAgICogLy8gPT4gJ2hpOiBtb2UhJwogICAqLwogIGZ1bmN0aW9uIGNvbXBvc2UoKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgYXJncyA9IFtmdW5jc1tsZW5ndGhdLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgYGZ1bmNgIHVudGlsIGFmdGVyCiAgICogYHdhaXRgIG1pbGxpc2Vjb25kcyBoYXZlIGVsYXBzZWQgc2luY2UgdGhlIGxhc3QgdGltZSBpdCB3YXMgaW52b2tlZC4gUGFzcwogICAqIGB0cnVlYCBmb3IgYGltbWVkaWF0ZWAgdG8gY2F1c2UgZGVib3VuY2UgdG8gaW52b2tlIGBmdW5jYCBvbiB0aGUgbGVhZGluZywKICAgKiBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZywgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8KICAgKiB0aGUgZGVib3VuY2VkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVib3VuY2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkuCiAgICogQHBhcmFtIHtCb29sZWFufSBpbW1lZGlhdGUgQSBmbGFnIHRvIGluZGljYXRlIGV4ZWN1dGlvbiBpcyBvbiB0aGUgbGVhZGluZwogICAqICBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGRlYm91bmNlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGxhenlMYXlvdXQgPSBfLmRlYm91bmNlKGNhbGN1bGF0ZUxheW91dCwgMzAwKTsKICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgbGF6eUxheW91dCk7CiAgICovCiAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgYXJncywKICAgICAgICByZXN1bHQsCiAgICAgICAgdGhpc0FyZywKICAgICAgICB0aW1lb3V0SWQ7CgogICAgZnVuY3Rpb24gZGVsYXllZCgpIHsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgaWYgKCFpbW1lZGlhdGUpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpc0ltbWVkaWF0ZSA9IGltbWVkaWF0ZSAmJiAhdGltZW91dElkOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aGlzQXJnID0gdGhpczsKCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGRlbGF5ZWQsIHdhaXQpOwoKICAgICAgaWYgKGlzSW1tZWRpYXRlKSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZnVuY2AgZnVuY3Rpb24gYWZ0ZXIgYHdhaXRgIG1pbGxpc2Vjb25kcy4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgKiB3aWxsIGJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAqIEBwYXJhbSB7TnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIGRlbGF5IGV4ZWN1dGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGBzZXRUaW1lb3V0YCB0aW1lb3V0IGlkLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbG9nID0gXy5iaW5kKGNvbnNvbGUubG9nLCBjb25zb2xlKTsKICAgKiBfLmRlbGF5KGxvZywgMTAwMCwgJ2xvZ2dlZCBsYXRlcicpOwogICAqIC8vID0+ICdsb2dnZWQgbGF0ZXInIChBcHBlYXJzIGFmdGVyIG9uZSBzZWNvbmQuKQogICAqLwogIGZ1bmN0aW9uIGRlbGF5KGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIHdhaXQpOwogIH0KCiAgLyoqCiAgICogRGVmZXJzIGV4ZWN1dGluZyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIHVudGlsIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzIGNsZWFyZWQuCiAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBwYXNzZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWZlci4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGBzZXRUaW1lb3V0YCB0aW1lb3V0IGlkLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmRlZmVyKGZ1bmN0aW9uKCkgeyBhbGVydCgnZGVmZXJyZWQnKTsgfSk7CiAgICogLy8gcmV0dXJucyBmcm9tIHRoZSBmdW5jdGlvbiBiZWZvcmUgYGFsZXJ0YCBpcyBjYWxsZWQKICAgKi8KICBmdW5jdGlvbiBkZWZlcihmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnVuYy5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOyB9LCAxKTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICogcGFzc2VkLCBpdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBjYWNoZSBrZXkgZm9yIHN0b3JpbmcgdGhlIHJlc3VsdAogICAqIGJhc2VkIG9uIHRoZSBhcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4gQnkgZGVmYXVsdCwgdGhlIGZpcnN0CiAgICogYXJndW1lbnQgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBjYWNoZSBrZXkuIFRoZSBgZnVuY2AKICAgKiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtyZXNvbHZlcl0gQSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIGNhY2hlIGtleS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtZW1vaXppbmcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBmaWJvbmFjY2kgPSBfLm1lbW9pemUoZnVuY3Rpb24obikgewogICAqICAgcmV0dXJuIG4gPCAyID8gbiA6IGZpYm9uYWNjaShuIC0gMSkgKyBmaWJvbmFjY2kobiAtIDIpOwogICAqIH0pOwogICAqLwogIGZ1bmN0aW9uIG1lbW9pemUoZnVuYywgcmVzb2x2ZXIpIHsKICAgIHZhciBjYWNoZSA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gKHJlc29sdmVyID8gcmVzb2x2ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGFyZ3VtZW50c1swXSkgKyAnJzsKICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGtleSkKICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICA6IChjYWNoZVtrZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIGV4ZWN1dGUgYGZ1bmNgIG9uY2UuIFJlcGVhdCBjYWxscyB0bwogICAqIHRoZSBmdW5jdGlvbiB3aWxsIHJldHVybiB0aGUgdmFsdWUgb2YgdGhlIGZpcnN0IGNhbGwuIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQKICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICogaW5pdGlhbGl6ZSgpOwogICAqIGluaXRpYWxpemUoKTsKICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICovCiAgZnVuY3Rpb24gb25jZShmdW5jKSB7CiAgICB2YXIgcmFuLAogICAgICAgIHJlc3VsdDsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgKiBgcGFydGlhbGAgYXJndW1lbnRzIHByZXBlbmRlZCB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4gVGhpcwogICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgLCBleGNlcHQgaXQgZG9lcyAqKm5vdCoqIGFsdGVyIHRoZSBgdGhpc2AgYmluZGluZy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJzogJyArIG5hbWU7IH07CiAgICogdmFyIGhpID0gXy5wYXJ0aWFsKGdyZWV0LCAnaGknKTsKICAgKiBoaSgnbW9lJyk7CiAgICogLy8gPT4gJ2hpOiBtb2UnCiAgICovCiAgZnVuY3Rpb24gcGFydGlhbChmdW5jKSB7CiAgICByZXR1cm4gY3JlYXRlQm91bmQoZnVuYywgc2xpY2UoYXJndW1lbnRzLCAxKSk7CiAgfQoKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLnBhcnRpYWxgLCBleGNlcHQgdGhhdCBgcGFydGlhbGAgYXJndW1lbnRzIGFyZQogICAqIGFwcGVuZGVkIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1peGluKHsKICAgKiAgICdkZWZhdWx0c0RlZXAnOiBfLnBhcnRpYWxSaWdodChfLm1lcmdlLCBfLmRlZmF1bHRzKQogICAqIH0pOwogICAqCiAgICogdmFyIG9wdGlvbnMgPSB7CiAgICogICAndmFyaWFibGUnOiAnZGF0YScsCiAgICogICAnaW1wb3J0cyc6IHsgJ2pxJzogJCB9CiAgICogfTsKICAgKgogICAqIF8uZGVmYXVsdHNEZWVwKG9wdGlvbnMsIF8udGVtcGxhdGVTZXR0aW5ncyk7CiAgICoKICAgKiBvcHRpb25zLnZhcmlhYmxlCiAgICogLy8gPT4gJ2RhdGEnCiAgICoKICAgKiBvcHRpb25zLmltcG9ydHMKICAgKiAvLyA9PiB7ICdfJzogXywgJ2pxJzogJCB9CiAgICovCiAgZnVuY3Rpb24gcGFydGlhbFJpZ2h0KGZ1bmMpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChmdW5jLCBzbGljZShhcmd1bWVudHMsIDEpLCBudWxsLCBpbmRpY2F0b3JPYmplY3QpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gZXhlY3V0ZWQsIHdpbGwgb25seSBjYWxsIHRoZSBgZnVuY2AKICAgKiBmdW5jdGlvbiBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IGB3YWl0YCBtaWxsaXNlY29uZHMuIElmIHRoZSB0aHJvdHRsZWQKICAgKiBmdW5jdGlvbiBpcyBpbnZva2VkIG1vcmUgdGhhbiBvbmNlIGR1cmluZyB0aGUgYHdhaXRgIHRpbWVvdXQsIGBmdW5jYCB3aWxsCiAgICogYWxzbyBiZSBjYWxsZWQgb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlCiAgICogdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdGhyb3R0bGUgZXhlY3V0aW9ucyB0by4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB0aHJvdHRsZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciB0aHJvdHRsZWQgPSBfLnRocm90dGxlKHVwZGF0ZVBvc2l0aW9uLCAxMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdzY3JvbGwnLCB0aHJvdHRsZWQpOwogICAqLwogIGZ1bmN0aW9uIHRocm90dGxlKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZCwKICAgICAgICBsYXN0Q2FsbGVkID0gMDsKCiAgICBmdW5jdGlvbiB0cmFpbGluZ0NhbGwoKSB7CiAgICAgIGxhc3RDYWxsZWQgPSBuZXcgRGF0ZTsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlLAogICAgICAgICAgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBsYXN0Q2FsbGVkKTsKCiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRoaXNBcmcgPSB0aGlzOwoKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICBsYXN0Q2FsbGVkID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIXRpbWVvdXRJZCkgewogICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQodHJhaWxpbmdDYWxsLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcGFzc2VzIGB2YWx1ZWAgdG8gdGhlIGB3cmFwcGVyYCBmdW5jdGlvbiBhcyBpdHMKICAgKiBmaXJzdCBhcmd1bWVudC4gQWRkaXRpb25hbCBhcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiBhcmUgYXBwZW5kZWQKICAgKiB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIGB3cmFwcGVyYCBmdW5jdGlvbi4gVGhlIGB3cmFwcGVyYCBpcyBleGVjdXRlZCB3aXRoCiAgICogdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IHdyYXBwZXIgVGhlIHdyYXBwZXIgZnVuY3Rpb24uCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBoZWxsbyA9IGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuICdoZWxsbyAnICsgbmFtZTsgfTsKICAgKiBoZWxsbyA9IF8ud3JhcChoZWxsbywgZnVuY3Rpb24oZnVuYykgewogICAqICAgcmV0dXJuICdiZWZvcmUsICcgKyBmdW5jKCdtb2UnKSArICcsIGFmdGVyJzsKICAgKiB9KTsKICAgKiBoZWxsbygpOwogICAqIC8vID0+ICdiZWZvcmUsIGhlbGxvIG1vZSwgYWZ0ZXInCiAgICovCiAgZnVuY3Rpb24gd3JhcCh2YWx1ZSwgd3JhcHBlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IFt2YWx1ZV07CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBjaGFyYWN0ZXJzIGAmYCwgYDxgLCBgPmAsIGAiYCwgYW5kIGAnYCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAqIGNvcnJlc3BvbmRpbmcgSFRNTCBlbnRpdGllcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgc3RyaW5nLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmVzY2FwZSgnTW9lLCBMYXJyeSAmIEN1cmx5Jyk7CiAgICogLy8gPT4gJ01vZSwgTGFycnkgJmFtcDsgQ3VybHknCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiAoc3RyaW5nICsgJycpLnJlcGxhY2UocmVVbmVzY2FwZWRIdG1sLCBlc2NhcGVIdG1sQ2hhcik7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byBpdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBBbnkgdmFsdWUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScgfTsKICAgKiBtb2UgPT09IF8uaWRlbnRpdHkobW9lKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEFkZHMgZnVuY3Rpb25zIHByb3BlcnRpZXMgb2YgYG9iamVjdGAgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uIGFuZCBjaGFpbmFibGUKICAgKiB3cmFwcGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5taXhpbih7CiAgICogICAnY2FwaXRhbGl6ZSc6IGZ1bmN0aW9uKHN0cmluZykgewogICAqICAgICByZXR1cm4gc3RyaW5nLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICogICB9CiAgICogfSk7CiAgICoKICAgKiBfLmNhcGl0YWxpemUoJ2xhcnJ5Jyk7CiAgICogLy8gPT4gJ0xhcnJ5JwogICAqCiAgICogXygnY3VybHknKS5jYXBpdGFsaXplKCk7CiAgICogLy8gPT4gJ0N1cmx5JwogICAqLwogIGZ1bmN0aW9uIG1peGluKG9iamVjdCkgewogICAgZm9yRWFjaChmdW5jdGlvbnMob2JqZWN0KSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGxvZGFzaFttZXRob2ROYW1lXSA9IG9iamVjdFttZXRob2ROYW1lXTsKCiAgICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl9fd3JhcHBlZF9fXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIG5ldyBsb2Rhc2goZnVuYy5hcHBseShsb2Rhc2gsIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUmV2ZXJ0cyB0aGUgJ18nIHZhcmlhYmxlIHRvIGl0cyBwcmV2aW91cyB2YWx1ZSBhbmQgcmV0dXJucyBhIHJlZmVyZW5jZSB0bwogICAqIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbG9kYXNoID0gXy5ub0NvbmZsaWN0KCk7CiAgICovCiAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgIHdpbmRvdy5fID0gb2xkRGFzaDsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYSByYW5kb20gbnVtYmVyIGJldHdlZW4gYG1pbmAgYW5kIGBtYXhgIChpbmNsdXNpdmUpLiBJZiBvbmx5IG9uZQogICAqIGFyZ3VtZW50IGlzIHBhc3NlZCwgYSBudW1iZXIgYmV0d2VlbiBgMGAgYW5kIHRoZSBnaXZlbiBudW1iZXIgd2lsbCBiZSByZXR1cm5lZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge051bWJlcn0gW21pbj0wXSBUaGUgbWluaW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgKiBAcGFyYW0ge051bWJlcn0gW21heD0xXSBUaGUgbWF4aW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGEgcmFuZG9tIG51bWJlci4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5yYW5kb20oMCwgNSk7CiAgICogLy8gPT4gYSBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICoKICAgKiBfLnJhbmRvbSg1KTsKICAgKiAvLyA9PiBhbHNvIGEgbnVtYmVyIGJldHdlZW4gMCBhbmQgNQogICAqLwogIGZ1bmN0aW9uIHJhbmRvbShtaW4sIG1heCkgewogICAgaWYgKG1pbiA9PSBudWxsICYmIG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IDE7CiAgICB9CiAgICBtaW4gPSArbWluIHx8IDA7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIGZsb29yKG5hdGl2ZVJhbmRvbSgpICogKCgrbWF4IHx8IDApIC0gbWluICsgMSkpOwogIH0KCiAgLyoqCiAgICogUmVzb2x2ZXMgdGhlIHZhbHVlIG9mIGBwcm9wZXJ0eWAgb24gYG9iamVjdGAuIElmIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiwKICAgKiBpdCB3aWxsIGJlIGludm9rZWQgYW5kIGl0cyByZXN1bHQgcmV0dXJuZWQsIGVsc2UgdGhlIHByb3BlcnR5IHZhbHVlIGlzCiAgICogcmV0dXJuZWQuIElmIGBvYmplY3RgIGlzIGZhbHNleSwgdGhlbiBgbnVsbGAgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgdGhlIHZhbHVlIG9mLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgcmVzb2x2ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvYmplY3QgPSB7CiAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgKiAgICdzdHVmZic6IGZ1bmN0aW9uKCkgewogICAqICAgICByZXR1cm4gJ25vbnNlbnNlJzsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICogLy8gPT4gJ2NydW1wZXRzJwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgKiAvLyA9PiAnbm9uc2Vuc2UnCiAgICovCiAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKICAgIC8vIGJhc2VkIG9uIEJhY2tib25lJ3MgcHJpdmF0ZSBgZ2V0VmFsdWVgIGZ1bmN0aW9uCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZG9jdW1lbnRjbG91ZC9iYWNrYm9uZS9ibG9iLzAuOS4yL2JhY2tib25lLmpzI0wxNDE5LTE0MjQKICAgIHZhciB2YWx1ZSA9IG9iamVjdCA/IG9iamVjdFtwcm9wZXJ0eV0gOiBudWxsOwogICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7CiAgfQoKICAvKioKICAgKiBBIG1pY3JvLXRlbXBsYXRpbmcgbWV0aG9kIHRoYXQgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzCiAgICogd2hpdGVzcGFjZSwgYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgICoKICAgKiBOb3RlOiBJbiB0aGUgZGV2ZWxvcG1lbnQgYnVpbGQgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAqIGRlYnVnZ2luZy4gU2VlIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgKgogICAqIE5vdGU6IExvLURhc2ggbWF5IGJlIHVzZWQgaW4gQ2hyb21lIGV4dGVuc2lvbnMgYnkgZWl0aGVyIGNyZWF0aW5nIGEgYGxvZGFzaCBjc3BgCiAgICogYnVpbGQgYW5kIGF2b2lkaW5nIGBfLnRlbXBsYXRlYCB1c2UsIG9yIGxvYWRpbmcgTG8tRGFzaCBpbiBhIHNhbmRib3hlZCBwYWdlLgogICAqIFNlZSBodHRwOi8vZGV2ZWxvcGVyLmNocm9tZS5jb20vdHJ1bmsvZXh0ZW5zaW9ucy9zYW5kYm94aW5nRXZhbC5odG1sCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHRlbXBsYXRlIHRleHQuCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICogIGVzY2FwZSAtIFRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIgcmVnZXhwLgogICAqICBldmFsdWF0ZSAtIFRoZSAiZXZhbHVhdGUiIGRlbGltaXRlciByZWdleHAuCiAgICogIGludGVycG9sYXRlIC0gVGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyIHJlZ2V4cC4KICAgKiAgc291cmNlVVJMIC0gVGhlIHNvdXJjZVVSTCBvZiB0aGUgdGVtcGxhdGUncyBjb21waWxlZCBzb3VyY2UuCiAgICogIHZhcmlhYmxlIC0gVGhlIGRhdGEgb2JqZWN0IHZhcmlhYmxlIG5hbWUuCiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb258U3RyaW5nfSBSZXR1cm5zIGEgY29tcGlsZWQgZnVuY3Rpb24gd2hlbiBubyBgZGF0YWAgb2JqZWN0CiAgICogIGlzIGdpdmVuLCBlbHNlIGl0IHJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAvLyB1c2luZyBhIGNvbXBpbGVkIHRlbXBsYXRlCiAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nKTsKICAgKiBjb21waWxlZCh7ICduYW1lJzogJ21vZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIG1vZScKICAgKgogICAqIHZhciBsaXN0ID0gJzwlIF8uZm9yRWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCU9IG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICogXy50ZW1wbGF0ZShsaXN0LCB7ICdwZW9wbGUnOiBbJ21vZScsICdsYXJyeScsICdjdXJseSddIH0pOwogICAqIC8vID0+ICc8bGk+bW9lPC9saT48bGk+bGFycnk8L2xpPjxsaT5jdXJseTwvbGk+JwogICAqCiAgICogLy8gdXNpbmcgdGhlICJlc2NhcGUiIGRlbGltaXRlciB0byBlc2NhcGUgSFRNTCBpbiBkYXRhIHByb3BlcnR5IHZhbHVlcwogICAqIF8udGVtcGxhdGUoJzxiPjwlLSB2YWx1ZSAlPjwvYj4nLCB7ICd2YWx1ZSc6ICc8c2NyaXB0PicgfSk7CiAgICogLy8gPT4gJzxiPiZsdDtzY3JpcHQmZ3Q7PC9iPicKICAgKgogICAqIC8vIHVzaW5nIHRoZSBFUzYgZGVsaW1pdGVyIGFzIGFuIGFsdGVybmF0aXZlIHRvIHRoZSBkZWZhdWx0ICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyCiAgICogXy50ZW1wbGF0ZSgnaGVsbG8gJHsgbmFtZSB9JywgeyAnbmFtZSc6ICdjdXJseScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIGN1cmx5JwogICAqCiAgICogLy8gdXNpbmcgdGhlIGludGVybmFsIGBwcmludGAgZnVuY3Rpb24gaW4gImV2YWx1YXRlIiBkZWxpbWl0ZXJzCiAgICogXy50ZW1wbGF0ZSgnPCUgcHJpbnQoImhlbGxvICIgKyBlcGl0aGV0KTsgJT4hJywgeyAnZXBpdGhldCc6ICdzdG9vZ2UnIH0pOwogICAqIC8vID0+ICdoZWxsbyBzdG9vZ2UhJwogICAqCiAgICogLy8gdXNpbmcgY3VzdG9tIHRlbXBsYXRlIGRlbGltaXRlcnMKICAgKiBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICogICAnaW50ZXJwb2xhdGUnOiAve3soW1xzXFNdKz8pfX0vZwogICAqIH07CiAgICoKICAgKiBfLnRlbXBsYXRlKCdoZWxsbyB7eyBuYW1lIH19IScsIHsgJ25hbWUnOiAnbXVzdGFjaGUnIH0pOwogICAqIC8vID0+ICdoZWxsbyBtdXN0YWNoZSEnCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZVVSTGAgb3B0aW9uIHRvIHNwZWNpZnkgYSBjdXN0b20gc291cmNlVVJMIGZvciB0aGUgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gbmFtZSAlPicsIG51bGwsIHsgJ3NvdXJjZVVSTCc6ICcvYmFzaWMvZ3JlZXRpbmcuanN0JyB9KTsKICAgKiBjb21waWxlZChkYXRhKTsKICAgKiAvLyA9PiBmaW5kIHRoZSBzb3VyY2Ugb2YgImdyZWV0aW5nLmpzdCIgdW5kZXIgdGhlIFNvdXJjZXMgdGFiIG9yIFJlc291cmNlcyBwYW5lbCBvZiB0aGUgd2ViIGluc3BlY3RvcgogICAqCiAgICogLy8gdXNpbmcgdGhlIGB2YXJpYWJsZWAgb3B0aW9uIHRvIGVuc3VyZSBhIHdpdGgtc3RhdGVtZW50IGlzbid0IHVzZWQgaW4gdGhlIGNvbXBpbGVkIHRlbXBsYXRlCiAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IGRhdGEubmFtZSAlPiEnLCBudWxsLCB7ICd2YXJpYWJsZSc6ICdkYXRhJyB9KTsKICAgKiBjb21waWxlZC5zb3VyY2U7CiAgICogLy8gPT4gZnVuY3Rpb24oZGF0YSkgewogICAqICAgdmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlOwogICAqICAgX19wICs9ICdoZWxsbyAnICsgKChfX3QgPSAoIGRhdGEubmFtZSApKSA9PSBudWxsID8gJycgOiBfX3QpICsgJyEnOwogICAqICAgcmV0dXJuIF9fcDsKICAgKiB9CiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZWAgcHJvcGVydHkgdG8gaW5saW5lIGNvbXBpbGVkIHRlbXBsYXRlcyBmb3IgbWVhbmluZ2Z1bAogICAqIC8vIGxpbmUgbnVtYmVycyBpbiBlcnJvciBtZXNzYWdlcyBhbmQgYSBzdGFjayB0cmFjZQogICAqIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGN3ZCwgJ2pzdC5qcycpLCAnXAogICAqICAgdmFyIEpTVCA9IHtcCiAgICogICAgICJtYWluIjogJyArIF8udGVtcGxhdGUobWFpblRleHQpLnNvdXJjZSArICdcCiAgICogICB9O1wKICAgKiAnKTsKICAgKi8KICBmdW5jdGlvbiB0ZW1wbGF0ZSh0ZXh0LCBkYXRhLCBvcHRpb25zKSB7CiAgICAvLyBiYXNlZCBvbiBKb2huIFJlc2lnJ3MgYHRtcGxgIGltcGxlbWVudGF0aW9uCiAgICAvLyBodHRwOi8vZWpvaG4ub3JnL2Jsb2cvamF2YXNjcmlwdC1taWNyby10ZW1wbGF0aW5nLwogICAgLy8gYW5kIExhdXJhIERva3Rvcm92YSdzIGRvVC5qcwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL29sYWRvL2RvVAogICAgdmFyIHNldHRpbmdzID0gbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3M7CiAgICB0ZXh0IHx8ICh0ZXh0ID0gJycpOwoKICAgIC8vIGF2b2lkIG1pc3NpbmcgZGVwZW5kZW5jaWVzIHdoZW4gYGl0ZXJhdG9yVGVtcGxhdGVgIGlzIG5vdCBkZWZpbmVkCiAgICBvcHRpb25zID0gaXRlcmF0b3JUZW1wbGF0ZSA/IGRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXR0aW5ncykgOiBzZXR0aW5nczsKCiAgICB2YXIgaW1wb3J0cyA9IGl0ZXJhdG9yVGVtcGxhdGUgJiYgZGVmYXVsdHMoe30sIG9wdGlvbnMuaW1wb3J0cywgc2V0dGluZ3MuaW1wb3J0cyksCiAgICAgICAgaW1wb3J0c0tleXMgPSBpdGVyYXRvclRlbXBsYXRlID8ga2V5cyhpbXBvcnRzKSA6IFsnXyddLAogICAgICAgIGltcG9ydHNWYWx1ZXMgPSBpdGVyYXRvclRlbXBsYXRlID8gdmFsdWVzKGltcG9ydHMpIDogW2xvZGFzaF07CgogICAgdmFyIGlzRXZhbHVhdGluZywKICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgaW50ZXJwb2xhdGUgPSBvcHRpb25zLmludGVycG9sYXRlIHx8IHJlTm9NYXRjaCwKICAgICAgICBzb3VyY2UgPSAiX19wICs9ICciOwoKICAgIC8vIGNvbXBpbGUgcmVnZXhwIHRvIG1hdGNoIGVhY2ggZGVsaW1pdGVyCiAgICB2YXIgcmVEZWxpbWl0ZXJzID0gUmVnRXhwKAogICAgICAob3B0aW9ucy5lc2NhcGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICBpbnRlcnBvbGF0ZS5zb3VyY2UgKyAnfCcgKwogICAgICAoaW50ZXJwb2xhdGUgPT09IHJlSW50ZXJwb2xhdGUgPyByZUVzVGVtcGxhdGUgOiByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgIChvcHRpb25zLmV2YWx1YXRlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wkJwogICAgLCAnZycpOwoKICAgIHRleHQucmVwbGFjZShyZURlbGltaXRlcnMsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGVWYWx1ZSwgaW50ZXJwb2xhdGVWYWx1ZSwgZXNUZW1wbGF0ZVZhbHVlLCBldmFsdWF0ZVZhbHVlLCBvZmZzZXQpIHsKICAgICAgaW50ZXJwb2xhdGVWYWx1ZSB8fCAoaW50ZXJwb2xhdGVWYWx1ZSA9IGVzVGVtcGxhdGVWYWx1ZSk7CgogICAgICAvLyBlc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbm5vdCBiZSBpbmNsdWRlZCBpbiBzdHJpbmcgbGl0ZXJhbHMKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShyZVVuZXNjYXBlZFN0cmluZywgZXNjYXBlU3RyaW5nQ2hhcik7CgogICAgICAvLyByZXBsYWNlIGRlbGltaXRlcnMgd2l0aCBzbmlwcGV0cwogICAgICBpZiAoZXNjYXBlVmFsdWUpIHsKICAgICAgICBzb3VyY2UgKz0gIicgK1xuX19lKCIgKyBlc2NhcGVWYWx1ZSArICIpICtcbiciOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZVZhbHVlKSB7CiAgICAgICAgaXNFdmFsdWF0aW5nID0gdHJ1ZTsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGVWYWx1ZSArICI7XG5fX3AgKz0gJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlVmFsdWUpIHsKICAgICAgICBzb3VyY2UgKz0gIicgK1xuKChfX3QgPSAoIiArIGludGVycG9sYXRlVmFsdWUgKyAiKSkgPT0gbnVsbCA/ICcnIDogX190KSArXG4nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKCiAgICAgIC8vIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgcHJvZHVjdHMgcmVxdWlyZXMgcmV0dXJuaW5nIHRoZSBgbWF0Y2hgCiAgICAgIC8vIHN0cmluZyBpbiBvcmRlciB0byBwcm9kdWNlIHRoZSBjb3JyZWN0IGBvZmZzZXRgIHZhbHVlCiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwoKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gaWYgYHZhcmlhYmxlYCBpcyBub3Qgc3BlY2lmaWVkIGFuZCB0aGUgdGVtcGxhdGUgY29udGFpbnMgImV2YWx1YXRlIgogICAgLy8gZGVsaW1pdGVycywgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkIGNvZGUgdG8gYWRkIHRoZQogICAgLy8gZGF0YSBvYmplY3QgdG8gdGhlIHRvcCBvZiB0aGUgc2NvcGUgY2hhaW4KICAgIHZhciB2YXJpYWJsZSA9IG9wdGlvbnMudmFyaWFibGUsCiAgICAgICAgaGFzVmFyaWFibGUgPSB2YXJpYWJsZTsKCiAgICBpZiAoIWhhc1ZhcmlhYmxlKSB7CiAgICAgIHZhcmlhYmxlID0gJ29iaic7CiAgICAgIHNvdXJjZSA9ICd3aXRoICgnICsgdmFyaWFibGUgKyAnKSB7XG4nICsgc291cmNlICsgJ1xufVxuJzsKICAgIH0KICAgIC8vIGNsZWFudXAgY29kZSBieSBzdHJpcHBpbmcgZW1wdHkgc3RyaW5ncwogICAgc291cmNlID0gKGlzRXZhbHVhdGluZyA/IHNvdXJjZS5yZXBsYWNlKHJlRW1wdHlTdHJpbmdMZWFkaW5nLCAnJykgOiBzb3VyY2UpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdNaWRkbGUsICckMScpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdUcmFpbGluZywgJyQxOycpOwoKICAgIC8vIGZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkKICAgIHNvdXJjZSA9ICdmdW5jdGlvbignICsgdmFyaWFibGUgKyAnKSB7XG4nICsKICAgICAgKGhhc1ZhcmlhYmxlID8gJycgOiB2YXJpYWJsZSArICcgfHwgKCcgKyB2YXJpYWJsZSArICcgPSB7fSk7XG4nKSArCiAgICAgICJ2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGUiICsKICAgICAgKGlzRXZhbHVhdGluZwogICAgICAgID8gJywgX19qID0gQXJyYXkucHJvdG90eXBlLmpvaW47XG4nICsKICAgICAgICAgICJmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgJycpIH1cbiIKICAgICAgICA6IChoYXNWYXJpYWJsZSA/ICcnIDogJywgX19kID0gJyArIHZhcmlhYmxlICsgJy4nICsgdmFyaWFibGUgKyAnIHx8ICcgKyB2YXJpYWJsZSkgKyAnO1xuJwogICAgICApICsKICAgICAgc291cmNlICsKICAgICAgJ3JldHVybiBfX3Bcbn0nOwoKICAgIC8vIFVzZSBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZyBhbmQgd3JhcCBpbiBhIG11bHRpLWxpbmUgY29tbWVudCB0bwogICAgLy8gYXZvaWQgaXNzdWVzIHdpdGggTmFyd2hhbCwgSUUgY29uZGl0aW9uYWwgY29tcGlsYXRpb24sIGFuZCB0aGUgSlMgZW5naW5lCiAgICAvLyBlbWJlZGRlZCBpbiBBZG9iZSBwcm9kdWN0cy4KICAgIC8vIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgIHZhciBzb3VyY2VVUkwgPSAnXG4vKlxuLy9AIHNvdXJjZVVSTD0nICsgKG9wdGlvbnMuc291cmNlVVJMIHx8ICcvbG9kYXNoL3RlbXBsYXRlL3NvdXJjZVsnICsgKHRlbXBsYXRlQ291bnRlcisrKSArICddJykgKyAnXG4qLyc7CgogICAgdHJ5IHsKICAgICAgdmFyIHJlc3VsdCA9IEZ1bmN0aW9uKGltcG9ydHNLZXlzLCAncmV0dXJuICcgKyBzb3VyY2UgKyBzb3VyY2VVUkwpLmFwcGx5KHVuZGVmaW5lZCwgaW1wb3J0c1ZhbHVlcyk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CiAgICBpZiAoZGF0YSkgewogICAgICByZXR1cm4gcmVzdWx0KGRhdGEpOwogICAgfQogICAgLy8gcHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24ncyBzb3VyY2UgdmlhIGl0cyBgdG9TdHJpbmdgIG1ldGhvZCwgaW4KICAgIC8vIHN1cHBvcnRlZCBlbnZpcm9ubWVudHMsIG9yIHRoZSBgc291cmNlYCBwcm9wZXJ0eSBhcyBhIGNvbnZlbmllbmNlIGZvcgogICAgLy8gaW5saW5pbmcgY29tcGlsZWQgdGVtcGxhdGVzIGR1cmluZyB0aGUgYnVpbGQgcHJvY2VzcwogICAgcmVzdWx0LnNvdXJjZSA9IHNvdXJjZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGVjdXRlcyB0aGUgYGNhbGxiYWNrYCBmdW5jdGlvbiBgbmAgdGltZXMsIHJldHVybmluZyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cwogICAqIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAqIHdpdGggb25lIGFyZ3VtZW50OyAoaW5kZXgpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2suCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGRpY2VSb2xscyA9IF8udGltZXMoMywgXy5wYXJ0aWFsKF8ucmFuZG9tLCAxLCA2KSk7CiAgICogLy8gPT4gWzMsIDYsIDRdCiAgICoKICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgbWFnZS5jYXN0U3BlbGwobik7IH0pOwogICAqIC8vID0+IGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMsIHBhc3NpbmcgYG5gIG9mIGAwYCwgYDFgLCBhbmQgYDJgIHJlc3BlY3RpdmVseQogICAqCiAgICogXy50aW1lcygzLCBmdW5jdGlvbihuKSB7IHRoaXMuY2FzdChuKTsgfSwgbWFnZSk7CiAgICogLy8gPT4gYWxzbyBjYWxscyBgbWFnZS5jYXN0U3BlbGwobilgIHRocmVlIHRpbWVzCiAgICovCiAgZnVuY3Rpb24gdGltZXMobiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIG4gPSArbiB8fCAwOwogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobik7CgogICAgd2hpbGUgKCsraW5kZXggPCBuKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjay5jYWxsKHRoaXNBcmcsIGluZGV4KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZXNjYXBlYCwgdGhpcyBtZXRob2QgY29udmVydHMgdGhlIEhUTUwgZW50aXRpZXMKICAgKiBgJmFtcDtgLCBgJmx0O2AsIGAmZ3Q7YCwgYCZxdW90O2AsIGFuZCBgJiN4Mjc7YCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAqIGNvcnJlc3BvbmRpbmcgY2hhcmFjdGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gdW5lc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIHN0cmluZy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmVzY2FwZSgnTW9lLCBMYXJyeSAmYW1wOyBDdXJseScpOwogICAqIC8vID0+ICdNb2UsIExhcnJ5ICYgQ3VybHknCiAgICovCiAgZnVuY3Rpb24gdW5lc2NhcGUoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IChzdHJpbmcgKyAnJykucmVwbGFjZShyZUVzY2FwZWRIdG1sLCB1bmVzY2FwZUh0bWxDaGFyKTsKICB9CgogIC8qKgogICAqIEdlbmVyYXRlcyBhIHVuaXF1ZSBJRC4gSWYgYHByZWZpeGAgaXMgcGFzc2VkLCB0aGUgSUQgd2lsbCBiZSBhcHBlbmRlZCB0byBpdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0gVGhlIHZhbHVlIHRvIHByZWZpeCB0aGUgSUQgd2l0aC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmlxdWUgSUQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pcXVlSWQoJ2NvbnRhY3RfJyk7CiAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAqCiAgICogXy51bmlxdWVJZCgpOwogICAqIC8vID0+ICcxMDUnCiAgICovCiAgZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICAgIHJldHVybiAocHJlZml4ID09IG51bGwgPyAnJyA6IHByZWZpeCArICcnKSArIGlkOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIEludm9rZXMgYGludGVyY2VwdG9yYCB3aXRoIHRoZSBgdmFsdWVgIGFzIHRoZSBmaXJzdCBhcmd1bWVudCwgYW5kIHRoZW4KICAgKiByZXR1cm5zIGB2YWx1ZWAuIFRoZSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sCiAgICogaW4gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgaW50ZXJjZXB0b3JgLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGludGVyY2VwdG9yIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDMsIDRdKQogICAqICAuZmlsdGVyKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KQogICAqICAudGFwKGFsZXJ0KQogICAqICAubWFwKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogbnVtOyB9KQogICAqICAudmFsdWUoKTsKICAgKiAvLyA9PiAvLyBbMiwgNF0gKGFsZXJ0ZWQpCiAgICogLy8gPT4gWzQsIDE2XQogICAqLwogIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKHZhbHVlKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgKgogICAqIEBuYW1lIHRvU3RyaW5nCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVzdWx0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudG9TdHJpbmcoKTsKICAgKiAvLyA9PiAnMSwyLDMnCiAgICovCiAgZnVuY3Rpb24gd3JhcHBlclRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX193cmFwcGVkX18gKyAnJzsKICB9CgogIC8qKgogICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqCiAgICogQG5hbWUgdmFsdWVPZgogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHZhbHVlCiAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudmFsdWVPZigpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIHdyYXBwZXJWYWx1ZU9mKCkgewogICAgcmV0dXJuIHRoaXMuX193cmFwcGVkX187CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gYWRkIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB3cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgbG9kYXNoLmFzc2lnbiA9IGFzc2lnbjsKICBsb2Rhc2guYXQgPSBhdDsKICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgbG9kYXNoLmJpbmRBbGwgPSBiaW5kQWxsOwogIGxvZGFzaC5iaW5kS2V5ID0gYmluZEtleTsKICBsb2Rhc2guY29tcGFjdCA9IGNvbXBhY3Q7CiAgbG9kYXNoLmNvbXBvc2UgPSBjb21wb3NlOwogIGxvZGFzaC5jb3VudEJ5ID0gY291bnRCeTsKICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICBsb2Rhc2guZGVmYXVsdHMgPSBkZWZhdWx0czsKICBsb2Rhc2guZGVmZXIgPSBkZWZlcjsKICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICBsb2Rhc2guZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2U7CiAgbG9kYXNoLmZpbHRlciA9IGZpbHRlcjsKICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgbG9kYXNoLmZvckVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5mb3JJbiA9IGZvckluOwogIGxvZGFzaC5mb3JPd24gPSBmb3JPd247CiAgbG9kYXNoLmZ1bmN0aW9ucyA9IGZ1bmN0aW9uczsKICBsb2Rhc2guZ3JvdXBCeSA9IGdyb3VwQnk7CiAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogIGxvZGFzaC5pbnRlcnNlY3Rpb24gPSBpbnRlcnNlY3Rpb247CiAgbG9kYXNoLmludmVydCA9IGludmVydDsKICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogIGxvZGFzaC5rZXlzID0ga2V5czsKICBsb2Rhc2gubWFwID0gbWFwOwogIGxvZGFzaC5tYXggPSBtYXg7CiAgbG9kYXNoLm1lbW9pemUgPSBtZW1vaXplOwogIGxvZGFzaC5tZXJnZSA9IG1lcmdlOwogIGxvZGFzaC5taW4gPSBtaW47CiAgbG9kYXNoLm9iamVjdCA9IG9iamVjdDsKICBsb2Rhc2gub21pdCA9IG9taXQ7CiAgbG9kYXNoLm9uY2UgPSBvbmNlOwogIGxvZGFzaC5wYWlycyA9IHBhaXJzOwogIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICBsb2Rhc2gucGFydGlhbFJpZ2h0ID0gcGFydGlhbFJpZ2h0OwogIGxvZGFzaC5waWNrID0gcGljazsKICBsb2Rhc2gucGx1Y2sgPSBwbHVjazsKICBsb2Rhc2gucmFuZ2UgPSByYW5nZTsKICBsb2Rhc2gucmVqZWN0ID0gcmVqZWN0OwogIGxvZGFzaC5yZXN0ID0gcmVzdDsKICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgbG9kYXNoLnNvcnRCeSA9IHNvcnRCeTsKICBsb2Rhc2gudGFwID0gdGFwOwogIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogIGxvZGFzaC50aW1lcyA9IHRpbWVzOwogIGxvZGFzaC50b0FycmF5ID0gdG9BcnJheTsKICBsb2Rhc2gudW5pb24gPSB1bmlvbjsKICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgbG9kYXNoLnZhbHVlcyA9IHZhbHVlczsKICBsb2Rhc2gud2hlcmUgPSB3aGVyZTsKICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgbG9kYXNoLndyYXAgPSB3cmFwOwogIGxvZGFzaC56aXAgPSB6aXA7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLmNvbGxlY3QgPSBtYXA7CiAgbG9kYXNoLmRyb3AgPSByZXN0OwogIGxvZGFzaC5lYWNoID0gZm9yRWFjaDsKICBsb2Rhc2guZXh0ZW5kID0gYXNzaWduOwogIGxvZGFzaC5tZXRob2RzID0gZnVuY3Rpb25zOwogIGxvZGFzaC5zZWxlY3QgPSBmaWx0ZXI7CiAgbG9kYXNoLnRhaWwgPSByZXN0OwogIGxvZGFzaC51bmlxdWUgPSB1bmlxOwoKICAvLyBhZGQgZnVuY3Rpb25zIHRvIGBsb2Rhc2gucHJvdG90eXBlYAogIG1peGluKGxvZGFzaCk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogIGxvZGFzaC5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgbG9kYXNoLmNvbnRhaW5zID0gY29udGFpbnM7CiAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICBsb2Rhc2guZXZlcnkgPSBldmVyeTsKICBsb2Rhc2guZmluZCA9IGZpbmQ7CiAgbG9kYXNoLmhhcyA9IGhhczsKICBsb2Rhc2guaWRlbnRpdHkgPSBpZGVudGl0eTsKICBsb2Rhc2guaW5kZXhPZiA9IGluZGV4T2Y7CiAgbG9kYXNoLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgbG9kYXNoLmlzQXJyYXkgPSBpc0FycmF5OwogIGxvZGFzaC5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgbG9kYXNoLmlzRGF0ZSA9IGlzRGF0ZTsKICBsb2Rhc2guaXNFbGVtZW50ID0gaXNFbGVtZW50OwogIGxvZGFzaC5pc0VtcHR5ID0gaXNFbXB0eTsKICBsb2Rhc2guaXNFcXVhbCA9IGlzRXF1YWw7CiAgbG9kYXNoLmlzRmluaXRlID0gaXNGaW5pdGU7CiAgbG9kYXNoLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIGxvZGFzaC5pc05hTiA9IGlzTmFOOwogIGxvZGFzaC5pc051bGwgPSBpc051bGw7CiAgbG9kYXNoLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgbG9kYXNoLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgbG9kYXNoLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0OwogIGxvZGFzaC5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogIGxvZGFzaC5pc1N0cmluZyA9IGlzU3RyaW5nOwogIGxvZGFzaC5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIGxvZGFzaC5sYXN0SW5kZXhPZiA9IGxhc3RJbmRleE9mOwogIGxvZGFzaC5taXhpbiA9IG1peGluOwogIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICBsb2Rhc2gucmFuZG9tID0gcmFuZG9tOwogIGxvZGFzaC5yZWR1Y2UgPSByZWR1Y2U7CiAgbG9kYXNoLnJlZHVjZVJpZ2h0ID0gcmVkdWNlUmlnaHQ7CiAgbG9kYXNoLnJlc3VsdCA9IHJlc3VsdDsKICBsb2Rhc2guc2l6ZSA9IHNpemU7CiAgbG9kYXNoLnNvbWUgPSBzb21lOwogIGxvZGFzaC5zb3J0ZWRJbmRleCA9IHNvcnRlZEluZGV4OwogIGxvZGFzaC50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogIGxvZGFzaC51bmVzY2FwZSA9IHVuZXNjYXBlOwogIGxvZGFzaC51bmlxdWVJZCA9IHVuaXF1ZUlkOwoKICAvLyBhZGQgYWxpYXNlcwogIGxvZGFzaC5hbGwgPSBldmVyeTsKICBsb2Rhc2guYW55ID0gc29tZTsKICBsb2Rhc2guZGV0ZWN0ID0gZmluZDsKICBsb2Rhc2guZm9sZGwgPSByZWR1Y2U7CiAgbG9kYXNoLmZvbGRyID0gcmVkdWNlUmlnaHQ7CiAgbG9kYXNoLmluY2x1ZGUgPSBjb250YWluczsKICBsb2Rhc2guaW5qZWN0ID0gcmVkdWNlOwoKICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX193cmFwcGVkX19dOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseShsb2Rhc2gsIGFyZ3MpOwogICAgICB9OwogICAgfQogIH0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gYWRkIGZ1bmN0aW9ucyBjYXBhYmxlIG9mIHJldHVybmluZyB3cmFwcGVkIGFuZCB1bndyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICBsb2Rhc2guZmlyc3QgPSBmaXJzdDsKICBsb2Rhc2gubGFzdCA9IGxhc3Q7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLnRha2UgPSBmaXJzdDsKICBsb2Rhc2guaGVhZCA9IGZpcnN0OwoKICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXT0gZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYyh0aGlzLl9fd3JhcHBlZF9fLCBjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrID09IG51bGwgfHwgKHRoaXNBcmcgJiYgdHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicpCiAgICAgICAgICA/IHJlc3VsdAogICAgICAgICAgOiBuZXcgbG9kYXNoKHJlc3VsdCk7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBTdHJpbmcKICAgKi8KICBsb2Rhc2guVkVSU0lPTiA9ICcxLjAuMC1yYy4zJzsKCiAgLy8gYWRkICJDaGFpbmluZyIgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyCiAgbG9kYXNoLnByb3RvdHlwZS50b1N0cmluZyA9IHdyYXBwZXJUb1N0cmluZzsKICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlID0gd3JhcHBlclZhbHVlT2Y7CiAgbG9kYXNoLnByb3RvdHlwZS52YWx1ZU9mID0gd3JhcHBlclZhbHVlT2Y7CgogIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzCiAgZWFjaChbJ2pvaW4nLCAncG9wJywgJ3NoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CiAgICB9OwogIH0pOwoKICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdGhlIHdyYXBwZWQgdmFsdWUKICBlYWNoKFsncHVzaCcsICdyZXZlcnNlJywgJ3NvcnQnLCAndW5zaGlmdCddLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIG5ldyB3cmFwcGVkIHZhbHVlcwogIGVhY2goWydjb25jYXQnLCAnc2xpY2UnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgbG9kYXNoKGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKSk7CiAgICB9OwogIH0pOwoKICAvLyBhdm9pZCBhcnJheS1saWtlIG9iamVjdCBidWdzIHdpdGggYEFycmF5I3NoaWZ0YCBhbmQgYEFycmF5I3NwbGljZWAKICAvLyBpbiBGaXJlZm94IDwgMTAgYW5kIElFIDwgOQogIGlmIChoYXNPYmplY3RTcGxpY2VCdWcpIHsKICAgIGVhY2goWydwb3AnLCAnc2hpZnQnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXSwKICAgICAgICAgIGlzU3BsaWNlID0gbWV0aG9kTmFtZSA9PSAnc3BsaWNlJzsKCiAgICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9fd3JhcHBlZF9fLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHZhbHVlLCBhcmd1bWVudHMpOwoKICAgICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBkZWxldGUgdmFsdWVbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1NwbGljZSA/IG5ldyBsb2Rhc2gocmVzdWx0KSA6IHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgLy8gYWRkIHBzZXVkbyBwcml2YXRlIHByb3BlcnR5IHRvIGJlIHVzZWQgYW5kIHJlbW92ZWQgZHVyaW5nIHRoZSBidWlsZCBwcm9jZXNzCiAgbG9kYXNoLl9lYWNoID0gZWFjaDsKICBsb2Rhc2guX2l0ZXJhdG9yVGVtcGxhdGUgPSBpdGVyYXRvclRlbXBsYXRlOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gZXhwb3NlIExvLURhc2gKICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIHdhcyBpbmplY3RlZCBieSBhIHRoaXJkLXBhcnR5IHNjcmlwdCBhbmQgbm90IGludGVuZGVkIHRvIGJlCiAgICAvLyBsb2FkZWQgYXMgYSBtb2R1bGUuIFRoZSBnbG9iYWwgYXNzaWdubWVudCBjYW4gYmUgcmV2ZXJ0ZWQgaW4gdGhlIExvLURhc2gKICAgIC8vIG1vZHVsZSB2aWEgaXRzIGBub0NvbmZsaWN0KClgIG1ldGhvZC4KICAgIHdpbmRvdy5fID0gbG9kYXNoOwoKICAgIC8vIGRlZmluZSBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlIHNvLCB0aHJvdWdoIHBhdGggbWFwcGluZywgaXQgY2FuIGJlCiAgICAvLyByZWZlcmVuY2VkIGFzIHRoZSAidW5kZXJzY29yZSIgbW9kdWxlCiAgICBkZWZpbmUoJ2xvZGFzaCcsW10sZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBsb2Rhc2g7CiAgICB9KTsKICB9CiAgLy8gY2hlY2sgZm9yIGBleHBvcnRzYCBhZnRlciBgZGVmaW5lYCBpbiBjYXNlIGEgYnVpbGQgb3B0aW1pemVyIGFkZHMgYW4gYGV4cG9ydHNgIG9iamVjdAogIGVsc2UgaWYgKGZyZWVFeHBvcnRzKSB7CiAgICAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgaWYgKHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmIG1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKSB7CiAgICAgIChtb2R1bGUuZXhwb3J0cyA9IGxvZGFzaCkuXyA9IGxvZGFzaDsKICAgIH0KICAgIC8vIGluIE5hcndoYWwgb3IgUmluZ29KUyB2MC43LjAtCiAgICBlbHNlIHsKICAgICAgZnJlZUV4cG9ydHMuXyA9IGxvZGFzaDsKICAgIH0KICB9CiAgZWxzZSB7CiAgICAvLyBpbiBhIGJyb3dzZXIgb3IgUmhpbm8KICAgIHdpbmRvdy5fID0gbG9kYXNoOwogIH0KfSh0aGlzKSk7CgovLyAgVW5kZXJzY29yZS5zdHJpbmcKLy8gIChjKSAyMDEwIEVzYS1NYXR0aSBTdXVyb25lbiA8ZXNhLW1hdHRpIGFldCBzdXVyb25lbiBkb3Qgb3JnPgovLyAgVW5kZXJzY29yZS5zdHJpbmcgaXMgZnJlZWx5IGRpc3RyaWJ1dGFibGUgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBNSVQgbGljZW5zZS4KLy8gIERvY3VtZW50YXRpb246IGh0dHBzOi8vZ2l0aHViLmNvbS9lcGVsaS91bmRlcnNjb3JlLnN0cmluZwovLyAgU29tZSBjb2RlIGlzIGJvcnJvd2VkIGZyb20gTW9vVG9vbHMgYW5kIEFsZXhhbmRydSBNYXJhc3RlYW51LgovLyAgVmVyc2lvbiAnMi4zLjEnCgohZnVuY3Rpb24ocm9vdCwgU3RyaW5nKXsKICAKCiAgLy8gRGVmaW5pbmcgaGVscGVyIGZ1bmN0aW9ucy4KCiAgdmFyIG5hdGl2ZVRyaW0gPSBTdHJpbmcucHJvdG90eXBlLnRyaW07CiAgdmFyIG5hdGl2ZVRyaW1SaWdodCA9IFN0cmluZy5wcm90b3R5cGUudHJpbVJpZ2h0OwogIHZhciBuYXRpdmVUcmltTGVmdCA9IFN0cmluZy5wcm90b3R5cGUudHJpbUxlZnQ7CgogIHZhciBwYXJzZU51bWJlciA9IGZ1bmN0aW9uKHNvdXJjZSkgeyByZXR1cm4gc291cmNlICogMSB8fCAwOyB9OwoKICB2YXIgc3RyUmVwZWF0ID0gZnVuY3Rpb24oc3RyLCBxdHkpewogICAgaWYgKHF0eSA8IDEpIHJldHVybiAnJzsKICAgIHZhciByZXN1bHQgPSAnJzsKICAgIHdoaWxlIChxdHkgPiAwKSB7CiAgICAgIGlmIChxdHkgJiAxKSByZXN1bHQgKz0gc3RyOwogICAgICBxdHkgPj49IDEsIHN0ciArPSBzdHI7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIHZhciBzbGljZSA9IFtdLnNsaWNlOwoKICB2YXIgZGVmYXVsdFRvV2hpdGVTcGFjZSA9IGZ1bmN0aW9uKGNoYXJhY3RlcnMpIHsKICAgIGlmIChjaGFyYWN0ZXJzID09IG51bGwpCiAgICAgIHJldHVybiAnXFxzJzsKICAgIGVsc2UgaWYgKGNoYXJhY3RlcnMuc291cmNlKQogICAgICByZXR1cm4gY2hhcmFjdGVycy5zb3VyY2U7CiAgICBlbHNlCiAgICAgIHJldHVybiAnWycgKyBfcy5lc2NhcGVSZWdFeHAoY2hhcmFjdGVycykgKyAnXSc7CiAgfTsKCiAgdmFyIGVzY2FwZUNoYXJzID0gewogICAgbHQ6ICc8JywKICAgIGd0OiAnPicsCiAgICBxdW90OiAnIicsCiAgICBhbXA6ICcmJywKICAgIGFwb3M6ICInIgogIH07CgogIHZhciByZXZlcnNlZEVzY2FwZUNoYXJzID0ge307CiAgZm9yKHZhciBrZXkgaW4gZXNjYXBlQ2hhcnMpIHJldmVyc2VkRXNjYXBlQ2hhcnNbZXNjYXBlQ2hhcnNba2V5XV0gPSBrZXk7CiAgcmV2ZXJzZWRFc2NhcGVDaGFyc1siJyJdID0gJyMzOSc7CgogIC8vIHNwcmludGYoKSBmb3IgSmF2YVNjcmlwdCAwLjctYmV0YTEKICAvLyBodHRwOi8vd3d3LmRpdmVpbnRvamF2YXNjcmlwdC5jb20vcHJvamVjdHMvamF2YXNjcmlwdC1zcHJpbnRmCiAgLy8KICAvLyBDb3B5cmlnaHQgKGMpIEFsZXhhbmRydSBNYXJhc3RlYW51IDxhbGV4YWhvbGljIFthdCkgZ21haWwgKGRvdF0gY29tPgogIC8vIEFsbCByaWdodHMgcmVzZXJ2ZWQuCgogIHZhciBzcHJpbnRmID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7CiAgICB9CgogICAgdmFyIHN0cl9yZXBlYXQgPSBzdHJSZXBlYXQ7CgogICAgdmFyIHN0cl9mb3JtYXQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFzdHJfZm9ybWF0LmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKICAgICAgICBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzdHJfZm9ybWF0LnBhcnNlKGFyZ3VtZW50c1swXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0cl9mb3JtYXQuZm9ybWF0LmNhbGwobnVsbCwgc3RyX2Zvcm1hdC5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKICAgICAgdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewogICAgICAgIG5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIGlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgICBtYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKICAgICAgICAgIGlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yXTsKICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3ByaW50ZignW18uc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQogICAgICAgICAgICBhcmcgPSBhcmd2W2N1cnNvcisrXTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3ByaW50ZignW18uc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKG1hdGNoWzhdKSB7CiAgICAgICAgICAgIGNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICd1JzogYXJnID0gTWF0aC5hYnMoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKICAgICAgICAgIHBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKICAgICAgICAgIHBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKICAgICAgICAgIHBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwogICAgICAgICAgb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmNhY2hlID0ge307CgogICAgc3RyX2Zvcm1hdC5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewogICAgICB2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwogICAgICB3aGlsZSAoX2ZtdCkgewogICAgICAgIGlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKCclJyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDE7CiAgICAgICAgICAgIHZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CiAgICAgICAgICAgIGlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKICAgICAgICAgICAgICB3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewogICAgICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tfLnNwcmludGZdIGh1aD8nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJnX25hbWVzID09PSAzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgIH0KICAgICAgICBfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgfQogICAgICByZXR1cm4gcGFyc2VfdHJlZTsKICAgIH07CgogICAgcmV0dXJuIHN0cl9mb3JtYXQ7CiAgfSkoKTsKCgoKICAvLyBEZWZpbmluZyB1bmRlcnNjb3JlLnN0cmluZwoKICB2YXIgX3MgPSB7CgogICAgVkVSU0lPTjogJzIuMy4xJywKCiAgICBpc0JsYW5rOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHN0ciA9ICcnOwogICAgICByZXR1cm4gKC9eXHMqJC8pLnRlc3Qoc3RyKTsKICAgIH0sCgogICAgc3RyaXBUYWdzOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLzxcLz9bXj5dKz4vZywgJycpOwogICAgfSwKCiAgICBjYXBpdGFsaXplIDogZnVuY3Rpb24oc3RyKXsKICAgICAgc3RyID0gc3RyID09IG51bGwgPyAnJyA6IFN0cmluZyhzdHIpOwogICAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogICAgfSwKCiAgICBjaG9wOiBmdW5jdGlvbihzdHIsIHN0ZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiBbXTsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHN0ZXAgPSB+fnN0ZXA7CiAgICAgIHJldHVybiBzdGVwID4gMCA/IHN0ci5tYXRjaChuZXcgUmVnRXhwKCcuezEsJyArIHN0ZXAgKyAnfScsICdnJykpIDogW3N0cl07CiAgICB9LAoKICAgIGNsZWFuOiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3Muc3RyaXAoc3RyKS5yZXBsYWNlKC9ccysvZywgJyAnKTsKICAgIH0sCgogICAgY291bnQ6IGZ1bmN0aW9uKHN0ciwgc3Vic3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsIHx8IHN1YnN0ciA9PSBudWxsKSByZXR1cm4gMDsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOwogICAgICBzdWJzdHIgPSBTdHJpbmcoc3Vic3RyKTsKCiAgICAgIHZhciBjb3VudCA9IDAsCiAgICAgICAgcG9zID0gMCwKICAgICAgICBsZW5ndGggPSBzdWJzdHIubGVuZ3RoOwoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBwb3MgPSBzdHIuaW5kZXhPZihzdWJzdHIsIHBvcyk7CiAgICAgICAgaWYgKHBvcyA9PT0gLTEpIGJyZWFrOwogICAgICAgIGNvdW50Kys7CiAgICAgICAgcG9zICs9IGxlbmd0aDsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvdW50OwogICAgfSwKCiAgICBjaGFyczogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuc3BsaXQoJycpOwogICAgfSwKCiAgICBzd2FwQ2FzZTogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvXFMvZywgZnVuY3Rpb24oYyl7CiAgICAgICAgcmV0dXJuIGMgPT09IGMudG9VcHBlckNhc2UoKSA/IGMudG9Mb3dlckNhc2UoKSA6IGMudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIGVzY2FwZUhUTUw6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoL1smPD4iJ10vZywgZnVuY3Rpb24obSl7IHJldHVybiAnJicgKyByZXZlcnNlZEVzY2FwZUNoYXJzW21dICsgJzsnOyB9KTsKICAgIH0sCgogICAgdW5lc2NhcGVIVE1MOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC9cJihbXjtdKyk7L2csIGZ1bmN0aW9uKGVudGl0eSwgZW50aXR5Q29kZSl7CiAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICBpZiAoZW50aXR5Q29kZSBpbiBlc2NhcGVDaGFycykgewogICAgICAgICAgcmV0dXJuIGVzY2FwZUNoYXJzW2VudGl0eUNvZGVdOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBlbnRpdHlDb2RlLm1hdGNoKC9eI3goW1xkYS1mQS1GXSspJC8pKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChtYXRjaFsxXSwgMTYpKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoID0gZW50aXR5Q29kZS5tYXRjaCgvXiMoXGQrKSQvKSkgewogICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUofn5tYXRjaFsxXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBlbnRpdHk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgZXNjYXBlUmVnRXhwOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLyhbLiorP149IToke30oKXxbXF1cL1xcXSkvZywgJ1xcJDEnKTsKICAgIH0sCgogICAgc3BsaWNlOiBmdW5jdGlvbihzdHIsIGksIGhvd21hbnksIHN1YnN0cil7CiAgICAgIHZhciBhcnIgPSBfcy5jaGFycyhzdHIpOwogICAgICBhcnIuc3BsaWNlKH5+aSwgfn5ob3dtYW55LCBzdWJzdHIpOwogICAgICByZXR1cm4gYXJyLmpvaW4oJycpOwogICAgfSwKCiAgICBpbnNlcnQ6IGZ1bmN0aW9uKHN0ciwgaSwgc3Vic3RyKXsKICAgICAgcmV0dXJuIF9zLnNwbGljZShzdHIsIGksIDAsIHN1YnN0cik7CiAgICB9LAoKICAgIGluY2x1ZGU6IGZ1bmN0aW9uKHN0ciwgbmVlZGxlKXsKICAgICAgaWYgKG5lZWRsZSA9PT0gJycpIHJldHVybiB0cnVlOwogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLmluZGV4T2YobmVlZGxlKSAhPT0gLTE7CiAgICB9LAoKICAgIGpvaW46IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICBzZXBhcmF0b3IgPSBhcmdzLnNoaWZ0KCk7CgogICAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHNlcGFyYXRvciA9ICcnOwoKICAgICAgcmV0dXJuIGFyZ3Muam9pbihzZXBhcmF0b3IpOwogICAgfSwKCiAgICBsaW5lczogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuc3BsaXQoIlxuIik7CiAgICB9LAoKICAgIHJldmVyc2U6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5jaGFycyhzdHIpLnJldmVyc2UoKS5qb2luKCcnKTsKICAgIH0sCgogICAgc3RhcnRzV2l0aDogZnVuY3Rpb24oc3RyLCBzdGFydHMpewogICAgICBpZiAoc3RhcnRzID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCB8fCBzdGFydHMgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgc3RhcnRzID0gU3RyaW5nKHN0YXJ0cyk7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID49IHN0YXJ0cy5sZW5ndGggJiYgc3RyLnNsaWNlKDAsIHN0YXJ0cy5sZW5ndGgpID09PSBzdGFydHM7CiAgICB9LAoKICAgIGVuZHNXaXRoOiBmdW5jdGlvbihzdHIsIGVuZHMpewogICAgICBpZiAoZW5kcyA9PT0gJycpIHJldHVybiB0cnVlOwogICAgICBpZiAoc3RyID09IG51bGwgfHwgZW5kcyA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBlbmRzID0gU3RyaW5nKGVuZHMpOwogICAgICByZXR1cm4gc3RyLmxlbmd0aCA+PSBlbmRzLmxlbmd0aCAmJiBzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIGVuZHMubGVuZ3RoKSA9PT0gZW5kczsKICAgIH0sCgogICAgc3VjYzogZnVuY3Rpb24oc3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOwogICAgICByZXR1cm4gc3RyLnNsaWNlKDAsIC0xKSArIFN0cmluZy5mcm9tQ2hhckNvZGUoc3RyLmNoYXJDb2RlQXQoc3RyLmxlbmd0aC0xKSArIDEpOwogICAgfSwKCiAgICB0aXRsZWl6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8oPzpefFxzKVxTL2csIGZ1bmN0aW9uKGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOyB9KTsKICAgIH0sCgogICAgY2FtZWxpemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvWy1fXHNdKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOyB9KTsKICAgIH0sCgogICAgdW5kZXJzY29yZWQ6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKykvZywgJyQxXyQyJykucmVwbGFjZSgvWy1cc10rL2csICdfJykudG9Mb3dlckNhc2UoKTsKICAgIH0sCgogICAgZGFzaGVyaXplOiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3MudHJpbShzdHIpLnJlcGxhY2UoLyhbQS1aXSkvZywgJy0kMScpLnJlcGxhY2UoL1stX1xzXSsvZywgJy0nKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICBjbGFzc2lmeTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRpdGxlaXplKFN0cmluZyhzdHIpLnJlcGxhY2UoL1tcV19dL2csICcgJykpLnJlcGxhY2UoL1xzL2csICcnKTsKICAgIH0sCgogICAgaHVtYW5pemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5jYXBpdGFsaXplKF9zLnVuZGVyc2NvcmVkKHN0cikucmVwbGFjZSgvX2lkJC8sJycpLnJlcGxhY2UoL18vZywgJyAnKSk7CiAgICB9LAoKICAgIHRyaW06IGZ1bmN0aW9uKHN0ciwgY2hhcmFjdGVycyl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBpZiAoIWNoYXJhY3RlcnMgJiYgbmF0aXZlVHJpbSkgcmV0dXJuIG5hdGl2ZVRyaW0uY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cCgnXF4nICsgY2hhcmFjdGVycyArICcrfCcgKyBjaGFyYWN0ZXJzICsgJyskJywgJ2cnKSwgJycpOwogICAgfSwKCiAgICBsdHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltTGVmdCkgcmV0dXJuIG5hdGl2ZVRyaW1MZWZ0LmNhbGwoc3RyKTsKICAgICAgY2hhcmFjdGVycyA9IGRlZmF1bHRUb1doaXRlU3BhY2UoY2hhcmFjdGVycyk7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKG5ldyBSZWdFeHAoJ14nICsgY2hhcmFjdGVycyArICcrJyksICcnKTsKICAgIH0sCgogICAgcnRyaW06IGZ1bmN0aW9uKHN0ciwgY2hhcmFjdGVycyl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBpZiAoIWNoYXJhY3RlcnMgJiYgbmF0aXZlVHJpbVJpZ2h0KSByZXR1cm4gbmF0aXZlVHJpbVJpZ2h0LmNhbGwoc3RyKTsKICAgICAgY2hhcmFjdGVycyA9IGRlZmF1bHRUb1doaXRlU3BhY2UoY2hhcmFjdGVycyk7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKG5ldyBSZWdFeHAoY2hhcmFjdGVycyArICcrJCcpLCAnJyk7CiAgICB9LAoKICAgIHRydW5jYXRlOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgdHJ1bmNhdGVTdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHRydW5jYXRlU3RyID0gdHJ1bmNhdGVTdHIgfHwgJy4uLic7CiAgICAgIGxlbmd0aCA9IH5+bGVuZ3RoOwogICAgICByZXR1cm4gc3RyLmxlbmd0aCA+IGxlbmd0aCA/IHN0ci5zbGljZSgwLCBsZW5ndGgpICsgdHJ1bmNhdGVTdHIgOiBzdHI7CiAgICB9LAoKICAgIC8qKgogICAgICogX3MucHJ1bmU6IGEgbW9yZSBlbGVnYW50IHZlcnNpb24gb2YgdHJ1bmNhdGUKICAgICAqIHBydW5lIGV4dHJhIGNoYXJzLCBuZXZlciBsZWF2aW5nIGEgaGFsZi1jaG9wcGVkIHdvcmQuCiAgICAgKiBAYXV0aG9yIGdpdGh1Yi5jb20vcnd6CiAgICAgKi8KICAgIHBydW5lOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcHJ1bmVTdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBsZW5ndGggPSB+fmxlbmd0aDsKICAgICAgcHJ1bmVTdHIgPSBwcnVuZVN0ciAhPSBudWxsID8gU3RyaW5nKHBydW5lU3RyKSA6ICcuLi4nOwoKICAgICAgaWYgKHN0ci5sZW5ndGggPD0gbGVuZ3RoKSByZXR1cm4gc3RyOwoKICAgICAgdmFyIHRtcGwgPSBmdW5jdGlvbihjKXsgcmV0dXJuIGMudG9VcHBlckNhc2UoKSAhPT0gYy50b0xvd2VyQ2FzZSgpID8gJ0EnIDogJyAnOyB9LAogICAgICAgIHRlbXBsYXRlID0gc3RyLnNsaWNlKDAsIGxlbmd0aCsxKS5yZXBsYWNlKC8uKD89XFcqXHcqJCkvZywgdG1wbCk7IC8vICdIZWxsbywgd29ybGQnIC0+ICdIZWxsQUEgQUFBQUEnCgogICAgICBpZiAodGVtcGxhdGUuc2xpY2UodGVtcGxhdGUubGVuZ3RoLTIpLm1hdGNoKC9cd1x3LykpCiAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZS5yZXBsYWNlKC9ccypcUyskLywgJycpOwogICAgICBlbHNlCiAgICAgICAgdGVtcGxhdGUgPSBfcy5ydHJpbSh0ZW1wbGF0ZS5zbGljZSgwLCB0ZW1wbGF0ZS5sZW5ndGgtMSkpOwoKICAgICAgcmV0dXJuICh0ZW1wbGF0ZStwcnVuZVN0cikubGVuZ3RoID4gc3RyLmxlbmd0aCA/IHN0ciA6IHN0ci5zbGljZSgwLCB0ZW1wbGF0ZS5sZW5ndGgpK3BydW5lU3RyOwogICAgfSwKCiAgICB3b3JkczogZnVuY3Rpb24oc3RyLCBkZWxpbWl0ZXIpIHsKICAgICAgaWYgKF9zLmlzQmxhbmsoc3RyKSkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gX3MudHJpbShzdHIsIGRlbGltaXRlcikuc3BsaXQoZGVsaW1pdGVyIHx8IC9ccysvKTsKICAgIH0sCgogICAgcGFkOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcGFkU3RyLCB0eXBlKSB7CiAgICAgIHN0ciA9IHN0ciA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyKTsKICAgICAgbGVuZ3RoID0gfn5sZW5ndGg7CgogICAgICB2YXIgcGFkbGVuICA9IDA7CgogICAgICBpZiAoIXBhZFN0cikKICAgICAgICBwYWRTdHIgPSAnICc7CiAgICAgIGVsc2UgaWYgKHBhZFN0ci5sZW5ndGggPiAxKQogICAgICAgIHBhZFN0ciA9IHBhZFN0ci5jaGFyQXQoMCk7CgogICAgICBzd2l0Y2godHlwZSkgewogICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyICsgc3RyUmVwZWF0KHBhZFN0ciwgcGFkbGVuKTsKICAgICAgICBjYXNlICdib3RoJzoKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyUmVwZWF0KHBhZFN0ciwgTWF0aC5jZWlsKHBhZGxlbi8yKSkgKyBzdHIKICAgICAgICAgICAgICAgICAgKyBzdHJSZXBlYXQocGFkU3RyLCBNYXRoLmZsb29yKHBhZGxlbi8yKSk7CiAgICAgICAgZGVmYXVsdDogLy8gJ2xlZnQnCiAgICAgICAgICBwYWRsZW4gPSBsZW5ndGggLSBzdHIubGVuZ3RoOwogICAgICAgICAgcmV0dXJuIHN0clJlcGVhdChwYWRTdHIsIHBhZGxlbikgKyBzdHI7CiAgICAgICAgfQogICAgfSwKCiAgICBscGFkOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcGFkU3RyKSB7CiAgICAgIHJldHVybiBfcy5wYWQoc3RyLCBsZW5ndGgsIHBhZFN0cik7CiAgICB9LAoKICAgIHJwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyLCAncmlnaHQnKTsKICAgIH0sCgogICAgbHJwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyLCAnYm90aCcpOwogICAgfSwKCiAgICBzcHJpbnRmOiBzcHJpbnRmLAoKICAgIHZzcHJpbnRmOiBmdW5jdGlvbihmbXQsIGFyZ3YpewogICAgICBhcmd2LnVuc2hpZnQoZm10KTsKICAgICAgcmV0dXJuIHNwcmludGYuYXBwbHkobnVsbCwgYXJndik7CiAgICB9LAoKICAgIHRvTnVtYmVyOiBmdW5jdGlvbihzdHIsIGRlY2ltYWxzKSB7CiAgICAgIGlmICghc3RyKSByZXR1cm4gMDsKICAgICAgc3RyID0gX3MudHJpbShzdHIpOwogICAgICBpZiAoIXN0ci5tYXRjaCgvXi0/XGQrKD86XC5cZCspPyQvKSkgcmV0dXJuIE5hTjsKICAgICAgcmV0dXJuIHBhcnNlTnVtYmVyKHBhcnNlTnVtYmVyKHN0cikudG9GaXhlZCh+fmRlY2ltYWxzKSk7CiAgICB9LAoKICAgIG51bWJlckZvcm1hdCA6IGZ1bmN0aW9uKG51bWJlciwgZGVjLCBkc2VwLCB0c2VwKSB7CiAgICAgIGlmIChpc05hTihudW1iZXIpIHx8IG51bWJlciA9PSBudWxsKSByZXR1cm4gJyc7CgogICAgICBudW1iZXIgPSBudW1iZXIudG9GaXhlZCh+fmRlYyk7CiAgICAgIHRzZXAgPSB0eXBlb2YgdHNlcCA9PSAnc3RyaW5nJyA/IHRzZXAgOiAnLCc7CgogICAgICB2YXIgcGFydHMgPSBudW1iZXIuc3BsaXQoJy4nKSwgZm51bXMgPSBwYXJ0c1swXSwKICAgICAgICBkZWNpbWFscyA9IHBhcnRzWzFdID8gKGRzZXAgfHwgJy4nKSArIHBhcnRzWzFdIDogJyc7CgogICAgICByZXR1cm4gZm51bXMucmVwbGFjZSgvKFxkKSg/PSg/OlxkezN9KSskKS9nLCAnJDEnICsgdHNlcCkgKyBkZWNpbWFsczsKICAgIH0sCgogICAgc3RyUmlnaHQ6IGZ1bmN0aW9uKHN0ciwgc2VwKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzZXAgPSBzZXAgIT0gbnVsbCA/IFN0cmluZyhzZXApIDogc2VwOwogICAgICB2YXIgcG9zID0gIXNlcCA/IC0xIDogc3RyLmluZGV4T2Yoc2VwKTsKICAgICAgcmV0dXJuIH5wb3MgPyBzdHIuc2xpY2UocG9zK3NlcC5sZW5ndGgsIHN0ci5sZW5ndGgpIDogc3RyOwogICAgfSwKCiAgICBzdHJSaWdodEJhY2s6IGZ1bmN0aW9uKHN0ciwgc2VwKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzZXAgPSBzZXAgIT0gbnVsbCA/IFN0cmluZyhzZXApIDogc2VwOwogICAgICB2YXIgcG9zID0gIXNlcCA/IC0xIDogc3RyLmxhc3RJbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKHBvcytzZXAubGVuZ3RoLCBzdHIubGVuZ3RoKSA6IHN0cjsKICAgIH0sCgogICAgc3RyTGVmdDogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIuaW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZSgwLCBwb3MpIDogc3RyOwogICAgfSwKCiAgICBzdHJMZWZ0QmFjazogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyICs9ICcnOyBzZXAgPSBzZXAgIT0gbnVsbCA/ICcnK3NlcCA6IHNlcDsKICAgICAgdmFyIHBvcyA9IHN0ci5sYXN0SW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZSgwLCBwb3MpIDogc3RyOwogICAgfSwKCiAgICB0b1NlbnRlbmNlOiBmdW5jdGlvbihhcnJheSwgc2VwYXJhdG9yLCBsYXN0U2VwYXJhdG9yLCBzZXJpYWwpIHsKICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICcsICcKICAgICAgbGFzdFNlcGFyYXRvciA9IGxhc3RTZXBhcmF0b3IgfHwgJyBhbmQgJwogICAgICB2YXIgYSA9IGFycmF5LnNsaWNlKCksIGxhc3RNZW1iZXIgPSBhLnBvcCgpOwoKICAgICAgaWYgKGFycmF5Lmxlbmd0aCA+IDIgJiYgc2VyaWFsKSBsYXN0U2VwYXJhdG9yID0gX3MucnRyaW0oc2VwYXJhdG9yKSArIGxhc3RTZXBhcmF0b3I7CgogICAgICByZXR1cm4gYS5sZW5ndGggPyBhLmpvaW4oc2VwYXJhdG9yKSArIGxhc3RTZXBhcmF0b3IgKyBsYXN0TWVtYmVyIDogbGFzdE1lbWJlcjsKICAgIH0sCgogICAgdG9TZW50ZW5jZVNlcmlhbDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzWzNdID0gdHJ1ZTsKICAgICAgcmV0dXJuIF9zLnRvU2VudGVuY2UuYXBwbHkoX3MsIGFyZ3MpOwogICAgfSwKCiAgICBzbHVnaWZ5OiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CgogICAgICB2YXIgZnJvbSAgPSAixIXDoMOhw6TDosOjw6XDpsSHxJnDqMOpw6vDqsOsw63Dr8OuxYLFhMOyw7PDtsO0w7XDuMO5w7rDvMO7w7HDp8W8xboiLAogICAgICAgICAgdG8gICAgPSAiYWFhYWFhYWFjZWVlZWVpaWlpbG5vb29vb291dXV1bmN6eiIsCiAgICAgICAgICByZWdleCA9IG5ldyBSZWdFeHAoZGVmYXVsdFRvV2hpdGVTcGFjZShmcm9tKSwgJ2cnKTsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShyZWdleCwgZnVuY3Rpb24oYyl7CiAgICAgICAgdmFyIGluZGV4ID0gZnJvbS5pbmRleE9mKGMpOwogICAgICAgIHJldHVybiB0by5jaGFyQXQoaW5kZXgpIHx8ICctJzsKICAgICAgfSk7CgogICAgICByZXR1cm4gX3MuZGFzaGVyaXplKHN0ci5yZXBsYWNlKC9bXlx3XHMtXS9nLCAnJykpOwogICAgfSwKCiAgICBzdXJyb3VuZDogZnVuY3Rpb24oc3RyLCB3cmFwcGVyKSB7CiAgICAgIHJldHVybiBbd3JhcHBlciwgc3RyLCB3cmFwcGVyXS5qb2luKCcnKTsKICAgIH0sCgogICAgcXVvdGU6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gX3Muc3Vycm91bmQoc3RyLCAnIicpOwogICAgfSwKCiAgICBleHBvcnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzKSB7CiAgICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KHByb3ApIHx8IHByb3AubWF0Y2goL14oPzppbmNsdWRlfGNvbnRhaW5zfHJldmVyc2UpJC8pKSBjb250aW51ZTsKICAgICAgICByZXN1bHRbcHJvcF0gPSB0aGlzW3Byb3BdOwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICByZXBlYXQ6IGZ1bmN0aW9uKHN0ciwgcXR5LCBzZXBhcmF0b3IpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHF0eSA9IH5+cXR5OwoKICAgICAgLy8gdXNpbmcgZmFzdGVyIGltcGxlbWVudGF0aW9uIGlmIHNlcGFyYXRvciBpcyBub3QgbmVlZGVkOwogICAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHJldHVybiBzdHJSZXBlYXQoU3RyaW5nKHN0ciksIHF0eSk7CgogICAgICAvLyB0aGlzIG9uZSBpcyBhYm91dCAzMDB4IHNsb3dlciBpbiBHb29nbGUgQ2hyb21lCiAgICAgIGZvciAodmFyIHJlcGVhdCA9IFtdOyBxdHkgPiAwOyByZXBlYXRbLS1xdHldID0gc3RyKSB7fQogICAgICByZXR1cm4gcmVwZWF0LmpvaW4oc2VwYXJhdG9yKTsKICAgIH0sCgogICAgbGV2ZW5zaHRlaW46IGZ1bmN0aW9uKHN0cjEsIHN0cjIpIHsKICAgICAgaWYgKHN0cjEgPT0gbnVsbCAmJiBzdHIyID09IG51bGwpIHJldHVybiAwOwogICAgICBpZiAoc3RyMSA9PSBudWxsKSByZXR1cm4gU3RyaW5nKHN0cjIpLmxlbmd0aDsKICAgICAgaWYgKHN0cjIgPT0gbnVsbCkgcmV0dXJuIFN0cmluZyhzdHIxKS5sZW5ndGg7CgogICAgICBzdHIxID0gU3RyaW5nKHN0cjEpOyBzdHIyID0gU3RyaW5nKHN0cjIpOwoKICAgICAgdmFyIGN1cnJlbnQgPSBbXSwgcHJldiwgdmFsdWU7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBzdHIyLmxlbmd0aDsgaSsrKQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDw9IHN0cjEubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChpICYmIGopCiAgICAgICAgICAgIGlmIChzdHIxLmNoYXJBdChqIC0gMSkgPT09IHN0cjIuY2hhckF0KGkgLSAxKSkKICAgICAgICAgICAgICB2YWx1ZSA9IHByZXY7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGgubWluKGN1cnJlbnRbal0sIGN1cnJlbnRbaiAtIDFdLCBwcmV2KSArIDE7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHZhbHVlID0gaSArIGo7CgogICAgICAgICAgcHJldiA9IGN1cnJlbnRbal07CiAgICAgICAgICBjdXJyZW50W2pdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgcmV0dXJuIGN1cnJlbnQucG9wKCk7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcwoKICBfcy5zdHJpcCAgICA9IF9zLnRyaW07CiAgX3MubHN0cmlwICAgPSBfcy5sdHJpbTsKICBfcy5yc3RyaXAgICA9IF9zLnJ0cmltOwogIF9zLmNlbnRlciAgID0gX3MubHJwYWQ7CiAgX3Mucmp1c3QgICAgPSBfcy5scGFkOwogIF9zLmxqdXN0ICAgID0gX3MucnBhZDsKICBfcy5jb250YWlucyA9IF9zLmluY2x1ZGU7CiAgX3MucSAgICAgICAgPSBfcy5xdW90ZTsKCiAgLy8gRXhwb3J0aW5nCgogIC8vIENvbW1vbkpTIG1vZHVsZSBpcyBkZWZpbmVkCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKQogICAgICBtb2R1bGUuZXhwb3J0cyA9IF9zOwoKICAgIGV4cG9ydHMuX3MgPSBfczsKICB9CgogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgbW9kdWxlIHdpdGggQU1ELgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpCiAgICBkZWZpbmUoJ3VuZGVyc2NvcmUuc3RyaW5nJywgW10sIGZ1bmN0aW9uKCl7IHJldHVybiBfczsgfSk7CgoKICAvLyBJbnRlZ3JhdGUgd2l0aCBVbmRlcnNjb3JlLmpzIGlmIGRlZmluZWQKICAvLyBvciBjcmVhdGUgb3VyIG93biB1bmRlcnNjb3JlIG9iamVjdC4KICByb290Ll8gPSByb290Ll8gfHwge307CiAgcm9vdC5fLnN0cmluZyA9IHJvb3QuXy5zdHIgPSBfczsKfSh0aGlzLCBTdHJpbmcpOwoKLy8gICAgIG5vZGUtdXVpZC91dWlkLmpzCi8vCi8vICAgICBDb3B5cmlnaHQgKGMpIDIwMTAgUm9iZXJ0IEtpZWZmZXIKLy8gICAgIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyAgICAgRG9jdW1lbnRhdGlvbiBhbmQgZGV0YWlscyBhdCBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZAooZnVuY3Rpb24oKSB7CiAgdmFyIF9nbG9iYWwgPSB0aGlzOwoKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLCBidXQKICAvLyBNYXRoLnJhbmRvbSgpIGRvZXMgbm90IGd1YXJhbnRlZSAiY3J5cHRvZ3JhcGhpYyBxdWFsaXR5Ii4gIFNvIHdlIGZlYXR1cmUKICAvLyBkZXRlY3QgZm9yIG1vcmUgcm9idXN0IEFQSXMsIG5vcm1hbGl6aW5nIGVhY2ggbWV0aG9kIHRvIHJldHVybiAxMjgtYml0cwogIC8vICgxNiBieXRlcykgb2YgcmFuZG9tIGRhdGEuCiAgdmFyIG1hdGhSTkcsIG5vZGVSTkcsIHdoYXR3Z1JORzsKCiAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCBSTkcuICBBbGwgcGxhdGZvcm1zLCB2ZXJ5IGZhc3QsIHVua25vd24gcXVhbGl0eQogIHZhciBfcm5kQnl0ZXMgPSBuZXcgQXJyYXkoMTYpOwogIG1hdGhSTkcgPSBmdW5jdGlvbigpIHsKICAgIHZhciByLCBiID0gX3JuZEJ5dGVzLCBpID0gMDsKCiAgICBmb3IgKHZhciBpID0gMCwgcjsgaSA8IDE2OyBpKyspIHsKICAgICAgaWYgKChpICYgMHgwMykgPT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgYltpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgIH0KCiAgICByZXR1cm4gYjsKICB9CgogIC8vIFdIQVRXRyBjcnlwdG8tYmFzZWQgUk5HIC0gaHR0cDovL3dpa2kud2hhdHdnLm9yZy93aWtpL0NyeXB0bwogIC8vIFdlYktpdCBvbmx5IChjdXJyZW50bHkpLCBtb2RlcmF0ZWx5IGZhc3QsIGhpZ2ggcXVhbGl0eQogIGlmIChfZ2xvYmFsLmNyeXB0byAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICB2YXIgX3JuZHMgPSBuZXcgVWludDMyQXJyYXkoNCk7CiAgICB3aGF0d2dSTkcgPSBmdW5jdGlvbigpIHsKICAgICAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhfcm5kcyk7CgogICAgICBmb3IgKHZhciBjID0gMCA7IGMgPCAxNjsgYysrKSB7CiAgICAgICAgX3JuZEJ5dGVzW2NdID0gX3JuZHNbYyA+PiAyXSA+Pj4gKChjICYgMHgwMykgKiA4KSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIF9ybmRCeXRlczsKICAgIH0KICB9CgogIC8vIE5vZGUuanMgY3J5cHRvLWJhc2VkIFJORyAtIGh0dHA6Ly9ub2RlanMub3JnL2RvY3MvdjAuNi4yL2FwaS9jcnlwdG8uaHRtbAogIC8vIE5vZGUuanMgb25seSwgbW9kZXJhdGVseSBmYXN0LCBoaWdoIHF1YWxpdHkKICB0cnkgewogICAgdmFyIF9yYiA9IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzOwogICAgbm9kZVJORyA9IF9yYiAmJiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF9yYigxNik7CiAgICB9OwogIH0gY2F0Y2ggKGUpIHt9CgogIC8vIFNlbGVjdCBSTkcgd2l0aCBiZXN0IHF1YWxpdHkKICB2YXIgX3JuZyA9IG5vZGVSTkcgfHwgd2hhdHdnUk5HIHx8IG1hdGhSTkc7CgogIC8vIEJ1ZmZlciBjbGFzcyB0byB1c2UKICB2YXIgQnVmZmVyQ2xhc3MgPSB0eXBlb2YoQnVmZmVyKSA9PSAnZnVuY3Rpb24nID8gQnVmZmVyIDogQXJyYXk7CgogIC8vIE1hcHMgZm9yIG51bWJlciA8LT4gaGV4IHN0cmluZyBjb252ZXJzaW9uCiAgdmFyIF9ieXRlVG9IZXggPSBbXTsKICB2YXIgX2hleFRvQnl0ZSA9IHt9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyBpKyspIHsKICAgIF9ieXRlVG9IZXhbaV0gPSAoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpOwogICAgX2hleFRvQnl0ZVtfYnl0ZVRvSGV4W2ldXSA9IGk7CiAgfQoKICAvLyAqKmBwYXJzZSgpYCAtIFBhcnNlIGEgVVVJRCBpbnRvIGl0J3MgY29tcG9uZW50IGJ5dGVzKioKICBmdW5jdGlvbiBwYXJzZShzLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSAoYnVmICYmIG9mZnNldCkgfHwgMCwgaWkgPSAwOwoKICAgIGJ1ZiA9IGJ1ZiB8fCBbXTsKICAgIHMudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bMC05YS1mXXsyfS9nLCBmdW5jdGlvbihieXRlKSB7CiAgICAgIGlmIChpaSA8IDE2KSB7IC8vIERvbid0IG92ZXJmbG93IQogICAgICAgIGJ1ZltpICsgaWkrK10gPSBfaGV4VG9CeXRlW2J5dGVdOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBaZXJvIG91dCByZW1haW5pbmcgYnl0ZXMgaWYgc3RyaW5nIHdhcyBzaG9ydAogICAgd2hpbGUgKGlpIDwgMTYpIHsKICAgICAgYnVmW2kgKyBpaSsrXSA9IDA7CiAgICB9CgogICAgcmV0dXJuIGJ1ZjsKICB9CgogIC8vICoqYHVucGFyc2UoKWAgLSBDb252ZXJ0IFVVSUQgYnl0ZSBhcnJheSAoYWxhIHBhcnNlKCkpIGludG8gYSBzdHJpbmcqKgogIGZ1bmN0aW9uIHVucGFyc2UoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDAsIGJ0aCA9IF9ieXRlVG9IZXg7CiAgICByZXR1cm4gIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV07CiAgfQoKICAvLyAqKmB2MSgpYCAtIEdlbmVyYXRlIHRpbWUtYmFzZWQgVVVJRCoqCiAgLy8KICAvLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwogIC8vIGFuZCBodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvdXVpZC5odG1sCgogIC8vIHJhbmRvbSAjJ3Mgd2UgbmVlZCB0byBpbml0IG5vZGUgYW5kIGNsb2Nrc2VxCiAgdmFyIF9zZWVkQnl0ZXMgPSBfcm5nKCk7CgogIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogIHZhciBfbm9kZUlkID0gWwogICAgX3NlZWRCeXRlc1swXSB8IDB4MDEsCiAgICBfc2VlZEJ5dGVzWzFdLCBfc2VlZEJ5dGVzWzJdLCBfc2VlZEJ5dGVzWzNdLCBfc2VlZEJ5dGVzWzRdLCBfc2VlZEJ5dGVzWzVdCiAgXTsKCiAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICB2YXIgX2Nsb2Nrc2VxID0gKF9zZWVkQnl0ZXNbNl0gPDwgOCB8IF9zZWVkQnl0ZXNbN10pICYgMHgzZmZmOwoKICAvLyBQcmV2aW91cyB1dWlkIGNyZWF0aW9uIHRpbWUKICB2YXIgX2xhc3RNU2VjcyA9IDAsIF9sYXN0TlNlY3MgPSAwOwoKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgdmFyIGIgPSBidWYgfHwgW107CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIGNsb2Nrc2VxID0gb3B0aW9ucy5jbG9ja3NlcSAhPSBudWxsID8gb3B0aW9ucy5jbG9ja3NlcSA6IF9jbG9ja3NlcTsKCiAgICAvLyBVVUlEIHRpbWVzdGFtcHMgYXJlIDEwMCBuYW5vLXNlY29uZCB1bml0cyBzaW5jZSB0aGUgR3JlZ29yaWFuIGVwb2NoLAogICAgLy8gKDE1ODItMTAtMTUgMDA6MDApLiAgSlNOdW1iZXJzIGFyZW4ndCBwcmVjaXNlIGVub3VnaCBmb3IgdGhpcywgc28KICAgIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogICAgLy8gKDEwMC1uYW5vc2Vjb25kcyBvZmZzZXQgZnJvbSBtc2Vjcykgc2luY2UgdW5peCBlcG9jaCwgMTk3MC0wMS0wMSAwMDowMC4KICAgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT0gbnVsbCA/IG9wdGlvbnMubXNlY3MgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCiAgICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawogICAgdmFyIG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPSBudWxsID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOwoKICAgIC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKICAgIHZhciBkdCA9IChtc2VjcyAtIF9sYXN0TVNlY3MpICsgKG5zZWNzIC0gX2xhc3ROU2VjcykvMTAwMDA7CgogICAgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgogICAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgICB9CgogICAgLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKICAgIC8vIHRpbWUgaW50ZXJ2YWwKICAgIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PSBudWxsKSB7CiAgICAgIG5zZWNzID0gMDsKICAgIH0KCiAgICAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCiAgICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dWlkLnYxKCk6IENhblwndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMnKTsKICAgIH0KCiAgICBfbGFzdE1TZWNzID0gbXNlY3M7CiAgICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsKCiAgICAvLyBQZXIgNC4xLjQgLSBDb252ZXJ0IGZyb20gdW5peCBlcG9jaCB0byBHcmVnb3JpYW4gZXBvY2gKICAgIG1zZWNzICs9IDEyMjE5MjkyODAwMDAwOwoKICAgIC8vIGB0aW1lX2xvd2AKICAgIHZhciB0bCA9ICgobXNlY3MgJiAweGZmZmZmZmYpICogMTAwMDAgKyBuc2VjcykgJSAweDEwMDAwMDAwMDsKICAgIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdGwgJiAweGZmOwoKICAgIC8vIGB0aW1lX21pZGAKICAgIHZhciB0bWggPSAobXNlY3MgLyAweDEwMDAwMDAwMCAqIDEwMDAwKSAmIDB4ZmZmZmZmZjsKICAgIGJbaSsrXSA9IHRtaCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bWggJiAweGZmOwoKICAgIC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCiAgICBiW2krK10gPSB0bWggPj4+IDI0ICYgMHhmIHwgMHgxMDsgLy8gaW5jbHVkZSB2ZXJzaW9uCiAgICBiW2krK10gPSB0bWggPj4+IDE2ICYgMHhmZjsKCiAgICAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKICAgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsKCiAgICAvLyBgY2xvY2tfc2VxX2xvd2AKICAgIGJbaSsrXSA9IGNsb2Nrc2VxICYgMHhmZjsKCiAgICAvLyBgbm9kZWAKICAgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CiAgICBmb3IgKHZhciBuID0gMDsgbiA8IDY7IG4rKykgewogICAgICBiW2kgKyBuXSA9IG5vZGVbbl07CiAgICB9CgogICAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6IHVucGFyc2UoYik7CiAgfQoKICAvLyAqKmB2NCgpYCAtIEdlbmVyYXRlIHJhbmRvbSBVVUlEKioKCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICAvLyBEZXByZWNhdGVkIC0gJ2Zvcm1hdCcgYXJndW1lbnQsIGFzIHN1cHBvcnRlZCBpbiB2MS4yCiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT0gJ2JpbmFyeScgPyBuZXcgQnVmZmVyQ2xhc3MoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBfcm5nKSgpOwoKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyBpaSsrKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBidWYgfHwgdW5wYXJzZShybmRzKTsKICB9CgogIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnYxID0gdjE7CiAgdXVpZC52NCA9IHY0OwogIHV1aWQucGFyc2UgPSBwYXJzZTsKICB1dWlkLnVucGFyc2UgPSB1bnBhcnNlOwogIHV1aWQuQnVmZmVyQ2xhc3MgPSBCdWZmZXJDbGFzczsKCiAgLy8gRXhwb3J0IFJORyBvcHRpb25zCiAgdXVpZC5tYXRoUk5HID0gbWF0aFJORzsKICB1dWlkLm5vZGVSTkcgPSBub2RlUk5HOwogIHV1aWQud2hhdHdnUk5HID0gd2hhdHdnUk5HOwoKICBpZiAodHlwZW9mKG1vZHVsZSkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgIC8vIFBsYXkgbmljZSB3aXRoIG5vZGUuanMKICAgIG1vZHVsZS5leHBvcnRzID0gdXVpZDsKICB9IGVsc2UgewogICAgLy8gUGxheSBuaWNlIHdpdGggYnJvd3NlcnMKICAgIHZhciBfcHJldmlvdXNSb290ID0gX2dsb2JhbC51dWlkOwoKICAgIC8vICoqYG5vQ29uZmxpY3QoKWAgLSAoYnJvd3NlciBvbmx5KSB0byByZXNldCBnbG9iYWwgJ3V1aWQnIHZhcioqCiAgICB1dWlkLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgX2dsb2JhbC51dWlkID0gX3ByZXZpb3VzUm9vdDsKICAgICAgcmV0dXJuIHV1aWQ7CiAgICB9CiAgICBfZ2xvYmFsLnV1aWQgPSB1dWlkOwogIH0KfSgpKTsKCmRlZmluZSgidXVpZCIsIGZ1bmN0aW9uKCl7fSk7CgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogQSBsaWdodHdlaWdodCBDb21tb25KUyBQcm9taXNlcy9BIGFuZCB3aGVuKCkgaW1wbGVtZW50YXRpb24KICogd2hlbiBpcyBwYXJ0IG9mIHRoZSBjdWpvLmpzIGZhbWlseSBvZiBsaWJyYXJpZXMgKGh0dHA6Ly9jdWpvanMuY29tLykKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIGF0OgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKgogKiBAdmVyc2lvbiAxLjcuMQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsgCmRlZmluZSgnd2hlbi93aGVuJyxbXSxmdW5jdGlvbiAoKSB7Cgl2YXIgcmVkdWNlQXJyYXksIHNsaWNlLCB1bmRlZjsKCgkvLwoJLy8gUHVibGljIEFQSQoJLy8KCgl3aGVuLmRlZmVyICAgICA9IGRlZmVyOyAgICAgLy8gQ3JlYXRlIGEgZGVmZXJyZWQKCXdoZW4ucmVzb2x2ZSAgID0gcmVzb2x2ZTsgICAvLyBDcmVhdGUgYSByZXNvbHZlZCBwcm9taXNlCgl3aGVuLnJlamVjdCAgICA9IHJlamVjdDsgICAgLy8gQ3JlYXRlIGEgcmVqZWN0ZWQgcHJvbWlzZQoKCXdoZW4uam9pbiAgICAgID0gam9pbjsgICAgICAvLyBKb2luIDIgb3IgbW9yZSBwcm9taXNlcwoKCXdoZW4uYWxsICAgICAgID0gYWxsOyAgICAgICAvLyBSZXNvbHZlIGEgbGlzdCBvZiBwcm9taXNlcwoJd2hlbi5tYXAgICAgICAgPSBtYXA7ICAgICAgIC8vIEFycmF5Lm1hcCgpIGZvciBwcm9taXNlcwoJd2hlbi5yZWR1Y2UgICAgPSByZWR1Y2U7ICAgIC8vIEFycmF5LnJlZHVjZSgpIGZvciBwcm9taXNlcwoKCXdoZW4uYW55ICAgICAgID0gYW55OyAgICAgICAvLyBPbmUtd2lubmVyIHJhY2UKCXdoZW4uc29tZSAgICAgID0gc29tZTsgICAgICAvLyBNdWx0aS13aW5uZXIgcmFjZQoKCXdoZW4uY2hhaW4gICAgID0gY2hhaW47ICAgICAvLyBNYWtlIGEgcHJvbWlzZSB0cmlnZ2VyIGFub3RoZXIgcmVzb2x2ZXIKCgl3aGVuLmlzUHJvbWlzZSA9IGlzUHJvbWlzZTsgLy8gRGV0ZXJtaW5lIGlmIGEgdGhpbmcgaXMgYSBwcm9taXNlCgoJLyoqCgkgKiBSZWdpc3RlciBhbiBvYnNlcnZlciBmb3IgYSBwcm9taXNlIG9yIGltbWVkaWF0ZSB2YWx1ZS4KCSAqCgkgKiBAcGFyYW0geyp9IHByb21pc2VPclZhbHVlCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9taXNlT3JWYWx1ZSBpcwoJICogICBzdWNjZXNzZnVsbHkgZnVsZmlsbGVkLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYW4gaW1tZWRpYXRlIHZhbHVlLCBjYWxsYmFjawoJICogICB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkuCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb21pc2VPclZhbHVlIGlzCgkgKiAgIHJlamVjdGVkLgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9ncmVzcyB1cGRhdGVzCgkgKiAgIGFyZSBpc3N1ZWQgZm9yIHByb21pc2VPclZhbHVlLgoJICogQHJldHVybnMge1Byb21pc2V9IGEgbmV3IHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgY29tcGxldGUgd2l0aCB0aGUgcmV0dXJuCgkgKiAgIHZhbHVlIG9mIGNhbGxiYWNrIG9yIGVycmJhY2sgb3IgdGhlIGNvbXBsZXRpb24gdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUgaWYKCSAqICAgY2FsbGJhY2sgYW5kL29yIGVycmJhY2sgaXMgbm90IHN1cHBsaWVkLgoJICovCglmdW5jdGlvbiB3aGVuKHByb21pc2VPclZhbHVlLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCS8vIEdldCBhIHRydXN0ZWQgcHJvbWlzZSBmb3IgdGhlIGlucHV0IHByb21pc2VPclZhbHVlLCBhbmQgdGhlbgoJCS8vIHJlZ2lzdGVyIHByb21pc2UgaGFuZGxlcnMKCQlyZXR1cm4gcmVzb2x2ZShwcm9taXNlT3JWYWx1ZSkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBSZXR1cm5zIHByb21pc2VPclZhbHVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9LCBhIG5ldyBQcm9taXNlIGlmCgkgKiBwcm9taXNlT3JWYWx1ZSBpcyBhIGZvcmVpZ24gcHJvbWlzZSwgb3IgYSBuZXcsIGFscmVhZHktZnVsZmlsbGVkIHtAbGluayBQcm9taXNlfQoJICogd2hvc2UgdmFsdWUgaXMgcHJvbWlzZU9yVmFsdWUgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYW4gaW1tZWRpYXRlIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUKCSAqIEByZXR1cm5zIEd1YXJhbnRlZWQgdG8gcmV0dXJuIGEgdHJ1c3RlZCBQcm9taXNlLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYSB3aGVuLmpzIHtAbGluayBQcm9taXNlfQoJICogICByZXR1cm5zIHByb21pc2VPclZhbHVlLCBvdGhlcndpc2UsIHJldHVybnMgYSBuZXcsIGFscmVhZHktcmVzb2x2ZWQsIHdoZW4uanMge0BsaW5rIFByb21pc2V9CgkgKiAgIHdob3NlIHJlc29sdXRpb24gdmFsdWUgaXM6CgkgKiAgICogdGhlIHJlc29sdXRpb24gdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUgaWYgaXQncyBhIGZvcmVpZ24gcHJvbWlzZSwgb3IKCSAqICAgKiBwcm9taXNlT3JWYWx1ZSBpZiBpdCdzIGEgdmFsdWUKCSAqLwoJZnVuY3Rpb24gcmVzb2x2ZShwcm9taXNlT3JWYWx1ZSkgewoJCXZhciBwcm9taXNlLCBkZWZlcnJlZDsKCgkJaWYocHJvbWlzZU9yVmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSB7CgkJCS8vIEl0J3MgYSB3aGVuLmpzIHByb21pc2UsIHNvIHdlIHRydXN0IGl0CgkJCXByb21pc2UgPSBwcm9taXNlT3JWYWx1ZTsKCgkJfSBlbHNlIHsKCQkJLy8gSXQncyBub3QgYSB3aGVuLmpzIHByb21pc2UuIFNlZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlIG9yIGEgdmFsdWUuCgkJCWlmKGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkpIHsKCQkJCS8vIEl0J3MgYSB0aGVuYWJsZSwgYnV0IHdlIGRvbid0IGtub3cgd2hlcmUgaXQgY2FtZSBmcm9tLCBzbyBkb24ndCB0cnVzdAoJCQkJLy8gaXRzIGltcGxlbWVudGF0aW9uIGVudGlyZWx5LiAgSW50cm9kdWNlIGEgdHJ1c3RlZCBtaWRkbGVtYW4gd2hlbi5qcyBwcm9taXNlCgkJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQkJLy8gSU1QT1JUQU5UOiBUaGlzIGlzIHRoZSBvbmx5IHBsYWNlIHdoZW4uanMgc2hvdWxkIGV2ZXIgY2FsbCAudGhlbigpIG9uIGFuCgkJCQkvLyB1bnRydXN0ZWQgcHJvbWlzZS4gRG9uJ3QgZXhwb3NlIHRoZSByZXR1cm4gdmFsdWUgdG8gdGhlIHVudHJ1c3RlZCBwcm9taXNlCgkJCQlwcm9taXNlT3JWYWx1ZS50aGVuKAoJCQkJCWZ1bmN0aW9uKHZhbHVlKSAgeyBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlKTsgfSwKCQkJCQlmdW5jdGlvbihyZWFzb24pIHsgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7IH0sCgkJCQkJZnVuY3Rpb24odXBkYXRlKSB7IGRlZmVycmVkLnByb2dyZXNzKHVwZGF0ZSk7IH0KCQkJCSk7CgoJCQkJcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CgoJCQl9IGVsc2UgewoJCQkJLy8gSXQncyBhIHZhbHVlLCBub3QgYSBwcm9taXNlLiAgQ3JlYXRlIGEgcmVzb2x2ZWQgcHJvbWlzZSBmb3IgaXQuCgkJCQlwcm9taXNlID0gZnVsZmlsbGVkKHByb21pc2VPclZhbHVlKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLyoqCgkgKiBSZXR1cm5zIGEgcmVqZWN0ZWQgcHJvbWlzZSBmb3IgdGhlIHN1cHBsaWVkIHByb21pc2VPclZhbHVlLiAgVGhlIHJldHVybmVkCgkgKiBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aDoKCSAqIC0gcHJvbWlzZU9yVmFsdWUsIGlmIGl0IGlzIGEgdmFsdWUsIG9yCgkgKiAtIGlmIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZQoJICogICAtIHByb21pc2VPclZhbHVlJ3MgdmFsdWUgYWZ0ZXIgaXQgaXMgZnVsZmlsbGVkCgkgKiAgIC0gcHJvbWlzZU9yVmFsdWUncyByZWFzb24gYWZ0ZXIgaXQgaXMgcmVqZWN0ZWQKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUgdGhlIHJlamVjdGVkIHZhbHVlIG9mIHRoZSByZXR1cm5lZCB7QGxpbmsgUHJvbWlzZX0KCSAqIEByZXR1cm4ge1Byb21pc2V9IHJlamVjdGVkIHtAbGluayBQcm9taXNlfQoJICovCglmdW5jdGlvbiByZWplY3QocHJvbWlzZU9yVmFsdWUpIHsKCQlyZXR1cm4gd2hlbihwcm9taXNlT3JWYWx1ZSwgcmVqZWN0ZWQpOwoJfQoKCS8qKgoJICogVHJ1c3RlZCBQcm9taXNlIGNvbnN0cnVjdG9yLiAgQSBQcm9taXNlIGNyZWF0ZWQgZnJvbSB0aGlzIGNvbnN0cnVjdG9yIGlzCgkgKiBhIHRydXN0ZWQgd2hlbi5qcyBwcm9taXNlLiAgQW55IG90aGVyIGR1Y2stdHlwZWQgcHJvbWlzZSBpcyBjb25zaWRlcmVkCgkgKiB1bnRydXN0ZWQuCgkgKiBAY29uc3RydWN0b3IKCSAqIEBuYW1lIFByb21pc2UKCSAqLwoJZnVuY3Rpb24gUHJvbWlzZSh0aGVuKSB7CgkJdGhpcy50aGVuID0gdGhlbjsKCX0KCglQcm9taXNlLnByb3RvdHlwZSA9IHsKCQkvKioKCQkgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBhIHByb21pc2UgaXMKCQkgKiBmdWxmaWxsZWQgb3IgcmVqZWN0ZWQuICBPcHRpb25hbGx5IGFsc28gcmVnaXN0ZXIgYSBwcm9ncmVzcyBoYW5kbGVyLgoJCSAqIFNob3J0Y3V0IGZvciAudGhlbihvbkZ1bGZpbGxlZE9yUmVqZWN0ZWQsIG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25Qcm9ncmVzcykKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkT3JSZWplY3RlZF0KCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdCgkJICogQHJldHVybiB7UHJvbWlzZX0KCQkgKi8KCQlhbHdheXM6IGZ1bmN0aW9uKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQlyZXR1cm4gdGhpcy50aGVuKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKTsKCQl9LAoKCQkvKioKCQkgKiBSZWdpc3RlciBhIHJlamVjdGlvbiBoYW5kbGVyLiAgU2hvcnRjdXQgZm9yIC50aGVuKHVuZGVmaW5lZCwgb25SZWplY3RlZCkKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gb25SZWplY3RlZAoJCSAqIEByZXR1cm4ge1Byb21pc2V9CgkJICovCgkJb3RoZXJ3aXNlOiBmdW5jdGlvbihvblJlamVjdGVkKSB7CgkJCXJldHVybiB0aGlzLnRoZW4odW5kZWYsIG9uUmVqZWN0ZWQpOwoJCX0sCgoJCS8qKgoJCSAqIFNob3J0Y3V0IGZvciAudGhlbihmdW5jdGlvbigpIHsgcmV0dXJuIHZhbHVlOyB9KQoJCSAqIEBwYXJhbSAgeyp9IHZhbHVlCgkJICogQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQ6CgkJICogIC0gaXMgZnVsZmlsbGVkIGlmIHZhbHVlIGlzIG5vdCBhIHByb21pc2UsIG9yCgkJICogIC0gaWYgdmFsdWUgaXMgYSBwcm9taXNlLCB3aWxsIGZ1bGZpbGwgd2l0aCBpdHMgdmFsdWUsIG9yIHJlamVjdAoJCSAqICAgIHdpdGggaXRzIHJlYXNvbi4KCQkgKi8KCQl5aWVsZDogZnVuY3Rpb24odmFsdWUpIHsKCQkJcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbigpIHsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfSk7CgkJfSwKCgkJLyoqCgkJICogQXNzdW1lcyB0aGF0IHRoaXMgcHJvbWlzZSB3aWxsIGZ1bGZpbGwgd2l0aCBhbiBhcnJheSwgYW5kIGFycmFuZ2VzCgkJICogZm9yIHRoZSBvbkZ1bGZpbGxlZCB0byBiZSBjYWxsZWQgd2l0aCB0aGUgYXJyYXkgYXMgaXRzIGFyZ3VtZW50IGxpc3QKCQkgKiBpLmUuIG9uRnVsZmlsbGVkLnNwcmVhZCh1bmRlZmluZWQsIGFycmF5KS4KCQkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBvbkZ1bGZpbGxlZCBmdW5jdGlvbiB0byByZWNlaXZlIHNwcmVhZCBhcmd1bWVudHMKCQkgKiBAcmV0dXJuIHtQcm9taXNlfQoJCSAqLwoJCXNwcmVhZDogZnVuY3Rpb24ob25GdWxmaWxsZWQpIHsKCQkJcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbihhcnJheSkgewoJCQkJLy8gYXJyYXkgbWF5IGNvbnRhaW4gcHJvbWlzZXMsIHNvIHJlc29sdmUgaXRzIGNvbnRlbnRzLgoJCQkJcmV0dXJuIGFsbChhcnJheSwgZnVuY3Rpb24oYXJyYXkpIHsKCQkJCQlyZXR1cm4gb25GdWxmaWxsZWQuYXBwbHkodW5kZWYsIGFycmF5KTsKCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGFuIGFscmVhZHktcmVzb2x2ZWQgcHJvbWlzZSBmb3IgdGhlIHN1cHBsaWVkIHZhbHVlCgkgKiBAcHJpdmF0ZQoJICoKCSAqIEBwYXJhbSB7Kn0gdmFsdWUKCSAqIEByZXR1cm4ge1Byb21pc2V9IGZ1bGZpbGxlZCBwcm9taXNlCgkgKi8KCWZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewoJCXZhciBwID0gbmV3IFByb21pc2UoZnVuY3Rpb24ob25GdWxmaWxsZWQpIHsKCQkJLy8gVE9ETzogUHJvbWlzZXMvQSsgY2hlY2sgdHlwZW9mIG9uRnVsZmlsbGVkCgkJCXRyeSB7CgkJCQlyZXR1cm4gcmVzb2x2ZShvbkZ1bGZpbGxlZCA/IG9uRnVsZmlsbGVkKHZhbHVlKSA6IHZhbHVlKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlyZXR1cm4gcmVqZWN0ZWQoZSk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHA7Cgl9CgoJLyoqCgkgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZWplY3RlZCB7QGxpbmsgUHJvbWlzZX0gd2l0aCB0aGUgc3VwcGxpZWQKCSAqIHJlamVjdGlvbiByZWFzb24uCgkgKiBAcHJpdmF0ZQoJICoKCSAqIEBwYXJhbSB7Kn0gcmVhc29uCgkgKiBAcmV0dXJuIHtQcm9taXNlfSByZWplY3RlZCBwcm9taXNlCgkgKi8KCWZ1bmN0aW9uIHJlamVjdGVkKHJlYXNvbikgewoJCXZhciBwID0gbmV3IFByb21pc2UoZnVuY3Rpb24oXywgb25SZWplY3RlZCkgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25SZWplY3RlZAoJCQl0cnkgewoJCQkJcmV0dXJuIG9uUmVqZWN0ZWQgPyByZXNvbHZlKG9uUmVqZWN0ZWQocmVhc29uKSkgOiByZWplY3RlZChyZWFzb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJldHVybiByZWplY3RlZChlKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gcDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYSBuZXcsIERlZmVycmVkIHdpdGggZnVsbHkgaXNvbGF0ZWQgcmVzb2x2ZXIgYW5kIHByb21pc2UgcGFydHMsCgkgKiBlaXRoZXIgb3IgYm90aCBvZiB3aGljaCBtYXkgYmUgZ2l2ZW4gb3V0IHNhZmVseSB0byBjb25zdW1lcnMuCgkgKiBUaGUgRGVmZXJyZWQgaXRzZWxmIGhhcyB0aGUgZnVsbCBBUEk6IHJlc29sdmUsIHJlamVjdCwgcHJvZ3Jlc3MsIGFuZAoJICogdGhlbi4gVGhlIHJlc29sdmVyIGhhcyByZXNvbHZlLCByZWplY3QsIGFuZCBwcm9ncmVzcy4gIFRoZSBwcm9taXNlCgkgKiBvbmx5IGhhcyB0aGVuLgoJICoKCSAqIEByZXR1cm4ge0RlZmVycmVkfQoJICovCglmdW5jdGlvbiBkZWZlcigpIHsKCQl2YXIgZGVmZXJyZWQsIHByb21pc2UsIGhhbmRsZXJzLCBwcm9ncmVzc0hhbmRsZXJzLAoJCQlfdGhlbiwgX3Byb2dyZXNzLCBfcmVzb2x2ZTsKCgkJLyoqCgkJICogVGhlIHByb21pc2UgZm9yIHRoZSBuZXcgZGVmZXJyZWQKCQkgKiBAdHlwZSB7UHJvbWlzZX0KCQkgKi8KCQlwcm9taXNlID0gbmV3IFByb21pc2UodGhlbik7CgoJCS8qKgoJCSAqIFRoZSBmdWxsIERlZmVycmVkIG9iamVjdCwgd2l0aCB7QGxpbmsgUHJvbWlzZX0gYW5kIHtAbGluayBSZXNvbHZlcn0gcGFydHMKCQkgKiBAY2xhc3MgRGVmZXJyZWQKCQkgKiBAbmFtZSBEZWZlcnJlZAoJCSAqLwoJCWRlZmVycmVkID0gewoJCQl0aGVuOiAgICAgdGhlbiwgLy8gREVQUkVDQVRFRDogdXNlIGRlZmVycmVkLnByb21pc2UudGhlbgoJCQlyZXNvbHZlOiAgcHJvbWlzZVJlc29sdmUsCgkJCXJlamVjdDogICBwcm9taXNlUmVqZWN0LAoJCQkvLyBUT0RPOiBDb25zaWRlciByZW5hbWluZyBwcm9ncmVzcygpIHRvIG5vdGlmeSgpCgkJCXByb2dyZXNzOiBwcm9taXNlUHJvZ3Jlc3MsCgoJCQlwcm9taXNlOiAgcHJvbWlzZSwKCgkJCXJlc29sdmVyOiB7CgkJCQlyZXNvbHZlOiAgcHJvbWlzZVJlc29sdmUsCgkJCQlyZWplY3Q6ICAgcHJvbWlzZVJlamVjdCwKCQkJCXByb2dyZXNzOiBwcm9taXNlUHJvZ3Jlc3MKCQkJfQoJCX07CgoJCWhhbmRsZXJzID0gW107CgkJcHJvZ3Jlc3NIYW5kbGVycyA9IFtdOwoKCQkvKioKCQkgKiBQcmUtcmVzb2x1dGlvbiB0aGVuKCkgdGhhdCBhZGRzIHRoZSBzdXBwbGllZCBjYWxsYmFjaywgZXJyYmFjaywgYW5kIHByb2diYWNrCgkJICogZnVuY3Rpb25zIHRvIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVycwoJCSAqIEBwcml2YXRlCgkJICoKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSByZXNvbHV0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkJICovCgkJX3RoZW4gPSBmdW5jdGlvbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MKCQkJdmFyIGRlZmVycmVkLCBwcm9ncmVzc0hhbmRsZXI7CgoJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQlwcm9ncmVzc0hhbmRsZXIgPSB0eXBlb2Ygb25Qcm9ncmVzcyA9PT0gJ2Z1bmN0aW9uJwoJCQkJPyBmdW5jdGlvbih1cGRhdGUpIHsKCQkJCQl0cnkgewoJCQkJCQkvLyBBbGxvdyBwcm9ncmVzcyBoYW5kbGVyIHRvIHRyYW5zZm9ybSBwcm9ncmVzcyBldmVudAoJCQkJCQlkZWZlcnJlZC5wcm9ncmVzcyhvblByb2dyZXNzKHVwZGF0ZSkpOwoJCQkJCX0gY2F0Y2goZSkgewoJCQkJCQkvLyBVc2UgY2F1Z2h0IHZhbHVlIGFzIHByb2dyZXNzCgkJCQkJCWRlZmVycmVkLnByb2dyZXNzKGUpOwoJCQkJCX0KCQkJCX0KCQkJCTogZnVuY3Rpb24odXBkYXRlKSB7IGRlZmVycmVkLnByb2dyZXNzKHVwZGF0ZSk7IH07CgoJCQloYW5kbGVycy5wdXNoKGZ1bmN0aW9uKHByb21pc2UpIHsKCQkJCXByb21pc2UudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkKCQkJCQkudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QsIHByb2dyZXNzSGFuZGxlcik7CgkJCX0pOwoKCQkJcHJvZ3Jlc3NIYW5kbGVycy5wdXNoKHByb2dyZXNzSGFuZGxlcik7CgoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKCQl9OwoKCQkvKioKCQkgKiBJc3N1ZSBhIHByb2dyZXNzIGV2ZW50LCBub3RpZnlpbmcgYWxsIHByb2dyZXNzIGxpc3RlbmVycwoJCSAqIEBwcml2YXRlCgkJICogQHBhcmFtIHsqfSB1cGRhdGUgcHJvZ3Jlc3MgZXZlbnQgcGF5bG9hZCB0byBwYXNzIHRvIGFsbCBsaXN0ZW5lcnMKCQkgKi8KCQlfcHJvZ3Jlc3MgPSBmdW5jdGlvbih1cGRhdGUpIHsKCQkJcHJvY2Vzc1F1ZXVlKHByb2dyZXNzSGFuZGxlcnMsIHVwZGF0ZSk7CgkJCXJldHVybiB1cGRhdGU7CgkJfTsKCgkJLyoqCgkJICogVHJhbnNpdGlvbiBmcm9tIHByZS1yZXNvbHV0aW9uIHN0YXRlIHRvIHBvc3QtcmVzb2x1dGlvbiBzdGF0ZSwgbm90aWZ5aW5nCgkJICogYWxsIGxpc3RlbmVycyBvZiB0aGUgcmVzb2x1dGlvbiBvciByZWplY3Rpb24KCQkgKiBAcHJpdmF0ZQoJCSAqIEBwYXJhbSB7Kn0gdmFsdWUgdGhlIHZhbHVlIG9mIHRoaXMgZGVmZXJyZWQKCQkgKi8KCQlfcmVzb2x2ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXZhbHVlID0gcmVzb2x2ZSh2YWx1ZSk7CgoJCQkvLyBSZXBsYWNlIF90aGVuIHdpdGggb25lIHRoYXQgZGlyZWN0bHkgbm90aWZpZXMgd2l0aCB0aGUgcmVzdWx0LgoJCQlfdGhlbiA9IHZhbHVlLnRoZW47CgkJCS8vIFJlcGxhY2UgX3Jlc29sdmUgc28gdGhhdCB0aGlzIERlZmVycmVkIGNhbiBvbmx5IGJlIHJlc29sdmVkIG9uY2UKCQkJX3Jlc29sdmUgPSByZXNvbHZlOwoJCQkvLyBNYWtlIF9wcm9ncmVzcyBhIG5vb3AsIHRvIGRpc2FsbG93IHByb2dyZXNzIGZvciB0aGUgcmVzb2x2ZWQgcHJvbWlzZS4KCQkJX3Byb2dyZXNzID0gbm9vcDsKCgkJCS8vIE5vdGlmeSBoYW5kbGVycwoJCQlwcm9jZXNzUXVldWUoaGFuZGxlcnMsIHZhbHVlKTsKCgkJCS8vIEZyZWUgcHJvZ3Jlc3NIYW5kbGVycyBhcnJheSBzaW5jZSB3ZSdsbCBuZXZlciBpc3N1ZSBwcm9ncmVzcyBldmVudHMKCQkJcHJvZ3Jlc3NIYW5kbGVycyA9IGhhbmRsZXJzID0gdW5kZWY7CgoJCQlyZXR1cm4gdmFsdWU7CgkJfTsKCgkJcmV0dXJuIGRlZmVycmVkOwoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF90aGVuIHRvIGJlIHJlcGxhY2VkIHNhZmVseQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCQkgKiBAcmV0dXJuIHtQcm9taXNlfSBuZXcgcHJvbWlzZQoJCSAqLwoJCWZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCQkJLy8gVE9ETzogUHJvbWlzZXMvQSsgY2hlY2sgdHlwZW9mIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzCgkJCXJldHVybiBfdGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9yZXNvbHZlIHRvIGJlIHJlcGxhY2VkCgkJICovCgkJZnVuY3Rpb24gcHJvbWlzZVJlc29sdmUodmFsKSB7CgkJCXJldHVybiBfcmVzb2x2ZSh2YWwpOwoJCX0KCgkJLyoqCgkJICogV3JhcHBlciB0byBhbGxvdyBfcmVqZWN0IHRvIGJlIHJlcGxhY2VkCgkJICovCgkJZnVuY3Rpb24gcHJvbWlzZVJlamVjdChlcnIpIHsKCQkJcmV0dXJuIF9yZXNvbHZlKHJlamVjdGVkKGVycikpOwoJCX0KCgkJLyoqCgkJICogV3JhcHBlciB0byBhbGxvdyBfcHJvZ3Jlc3MgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUHJvZ3Jlc3ModXBkYXRlKSB7CgkJCXJldHVybiBfcHJvZ3Jlc3ModXBkYXRlKTsKCQl9Cgl9CgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZSBvciBub3QuICBVc2VzIHRoZSBmZWF0dXJlCgkgKiB0ZXN0IGZyb20gaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMvQSB0byBkZXRlcm1pbmUgaWYKCSAqIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZS4KCSAqCgkgKiBAcGFyYW0geyp9IHByb21pc2VPclZhbHVlIGFueXRoaW5nCgkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHtAbGluayBQcm9taXNlfQoJICovCglmdW5jdGlvbiBpc1Byb21pc2UocHJvbWlzZU9yVmFsdWUpIHsKCQlyZXR1cm4gcHJvbWlzZU9yVmFsdWUgJiYgdHlwZW9mIHByb21pc2VPclZhbHVlLnRoZW4gPT09ICdmdW5jdGlvbic7Cgl9CgoJLyoqCgkgKiBJbml0aWF0ZXMgYSBjb21wZXRpdGl2ZSByYWNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4KCSAqIGhvd01hbnkgb2YgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMgaGF2ZSByZXNvbHZlZCwgb3Igd2lsbCByZWplY3Qgd2hlbgoJICogaXQgYmVjb21lcyBpbXBvc3NpYmxlIGZvciBob3dNYW55IHRvIHJlc29sdmUsIGZvciBleGFtcGxlLCB3aGVuCgkgKiAocHJvbWlzZXNPclZhbHVlcy5sZW5ndGggLSBob3dNYW55KSArIDEgaW5wdXQgcHJvbWlzZXMgcmVqZWN0LgoJICoKCSAqIEBwYXJhbSB7QXJyYXl9IHByb21pc2VzT3JWYWx1ZXMgYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CgkgKiAgICAgIG9mIHByb21pc2VzIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSBob3dNYW55IHtudW1iZXJ9IG51bWJlciBvZiBwcm9taXNlc09yVmFsdWVzIHRvIHJlc29sdmUKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhbiBhcnJheSBvZiBob3dNYW55IHZhbHVlcyB0aGF0CgkgKiByZXNvbHZlZCBmaXJzdCwgb3Igd2lsbCByZWplY3Qgd2l0aCBhbiBhcnJheSBvZiAocHJvbWlzZXNPclZhbHVlcy5sZW5ndGggLSBob3dNYW55KSArIDEKCSAqIHJlamVjdGlvbiByZWFzb25zLgoJICovCglmdW5jdGlvbiBzb21lKHByb21pc2VzT3JWYWx1ZXMsIGhvd01hbnksIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgoJCWNoZWNrQ2FsbGJhY2tzKDIsIGFyZ3VtZW50cyk7CgoJCXJldHVybiB3aGVuKHByb21pc2VzT3JWYWx1ZXMsIGZ1bmN0aW9uKHByb21pc2VzT3JWYWx1ZXMpIHsKCgkJCXZhciB0b1Jlc29sdmUsIHRvUmVqZWN0LCB2YWx1ZXMsIHJlYXNvbnMsIGRlZmVycmVkLCBmdWxmaWxsT25lLCByZWplY3RPbmUsIHByb2dyZXNzLCBsZW4sIGk7CgoJCQlsZW4gPSBwcm9taXNlc09yVmFsdWVzLmxlbmd0aCA+Pj4gMDsKCgkJCXRvUmVzb2x2ZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKGhvd01hbnksIGxlbikpOwoJCQl2YWx1ZXMgPSBbXTsKCgkJCXRvUmVqZWN0ID0gKGxlbiAtIHRvUmVzb2x2ZSkgKyAxOwoJCQlyZWFzb25zID0gW107CgoJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQkvLyBObyBpdGVtcyBpbiB0aGUgaW5wdXQsIHJlc29sdmUgaW1tZWRpYXRlbHkKCQkJaWYgKCF0b1Jlc29sdmUpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUodmFsdWVzKTsKCgkJCX0gZWxzZSB7CgkJCQlwcm9ncmVzcyA9IGRlZmVycmVkLnByb2dyZXNzOwoKCQkJCXJlamVjdE9uZSA9IGZ1bmN0aW9uKHJlYXNvbikgewoJCQkJCXJlYXNvbnMucHVzaChyZWFzb24pOwoJCQkJCWlmKCEtLXRvUmVqZWN0KSB7CgkJCQkJCWZ1bGZpbGxPbmUgPSByZWplY3RPbmUgPSBub29wOwoJCQkJCQlkZWZlcnJlZC5yZWplY3QocmVhc29ucyk7CgkJCQkJfQoJCQkJfTsKCgkJCQlmdWxmaWxsT25lID0gZnVuY3Rpb24odmFsKSB7CgkJCQkJLy8gVGhpcyBvcmRlcnMgdGhlIHZhbHVlcyBiYXNlZCBvbiBwcm9taXNlIHJlc29sdXRpb24gb3JkZXIKCQkJCQkvLyBBbm90aGVyIHN0cmF0ZWd5IHdvdWxkIGJlIHRvIHVzZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24gb2YKCQkJCQkvLyB0aGUgY29ycmVzcG9uZGluZyBwcm9taXNlLgoJCQkJCXZhbHVlcy5wdXNoKHZhbCk7CgoJCQkJCWlmICghLS10b1Jlc29sdmUpIHsKCQkJCQkJZnVsZmlsbE9uZSA9IHJlamVjdE9uZSA9IG5vb3A7CgkJCQkJCWRlZmVycmVkLnJlc29sdmUodmFsdWVzKTsKCQkJCQl9CgkJCQl9OwoKCQkJCWZvcihpID0gMDsgaSA8IGxlbjsgKytpKSB7CgkJCQkJaWYoaSBpbiBwcm9taXNlc09yVmFsdWVzKSB7CgkJCQkJCXdoZW4ocHJvbWlzZXNPclZhbHVlc1tpXSwgZnVsZmlsbGVyLCByZWplY3RlciwgcHJvZ3Jlc3MpOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRlZmVycmVkLnRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpOwoKCQkJZnVuY3Rpb24gcmVqZWN0ZXIocmVhc29uKSB7CgkJCQlyZWplY3RPbmUocmVhc29uKTsKCQkJfQoKCQkJZnVuY3Rpb24gZnVsZmlsbGVyKHZhbCkgewoJCQkJZnVsZmlsbE9uZSh2YWwpOwoJCQl9CgoJCX0pOwoJfQoKCS8qKgoJICogSW5pdGlhdGVzIGEgY29tcGV0aXRpdmUgcmFjZSwgcmV0dXJuaW5nIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB3aGVuCgkgKiBhbnkgb25lIG9mIHRoZSBzdXBwbGllZCBwcm9taXNlc09yVmFsdWVzIGhhcyByZXNvbHZlZCBvciB3aWxsIHJlamVjdCB3aGVuCgkgKiAqYWxsKiBwcm9taXNlc09yVmFsdWVzIGhhdmUgcmVqZWN0ZWQuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlc09yVmFsdWVzIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB0byB0aGUgdmFsdWUgdGhhdCByZXNvbHZlZCBmaXJzdCwgb3IKCSAqIHdpbGwgcmVqZWN0IHdpdGggYW4gYXJyYXkgb2YgYWxsIHJlamVjdGVkIGlucHV0cy4KCSAqLwoJZnVuY3Rpb24gYW55KHByb21pc2VzT3JWYWx1ZXMsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgoJCWZ1bmN0aW9uIHVud3JhcFNpbmdsZVJlc3VsdCh2YWwpIHsKCQkJcmV0dXJuIG9uRnVsZmlsbGVkID8gb25GdWxmaWxsZWQodmFsWzBdKSA6IHZhbFswXTsKCQl9CgoJCXJldHVybiBzb21lKHByb21pc2VzT3JWYWx1ZXMsIDEsIHVud3JhcFNpbmdsZVJlc3VsdCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBSZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9ubHkgb25jZSBhbGwgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMKCSAqIGhhdmUgcmVzb2x2ZWQuIFRoZSByZXNvbHV0aW9uIHZhbHVlIG9mIHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgYW4gYXJyYXkKCSAqIGNvbnRhaW5pbmcgdGhlIHJlc29sdXRpb24gdmFsdWVzIG9mIGVhY2ggb2YgdGhlIHByb21pc2VzT3JWYWx1ZXMuCgkgKiBAbWVtYmVyT2Ygd2hlbgoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZXNPclZhbHVlcyBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSByZXNvbHV0aW9uIGhhbmRsZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10gcHJvZ3Jlc3MgaGFuZGxlcgoJICogQHJldHVybnMge1Byb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGFsbChwcm9taXNlc09yVmFsdWVzLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCWNoZWNrQ2FsbGJhY2tzKDEsIGFyZ3VtZW50cyk7CgkJcmV0dXJuIG1hcChwcm9taXNlc09yVmFsdWVzLCBpZGVudGl0eSkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBKb2lucyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHJldHVybmVkIHByb21pc2UuCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGZ1bGZpbGwgd2hlbiAqYWxsKiB0aGUgaW5wdXQgcHJvbWlzZXMKCSAqIGhhdmUgZnVsZmlsbGVkLCBvciB3aWxsIHJlamVjdCB3aGVuICphbnkgb25lKiBvZiB0aGUgaW5wdXQgcHJvbWlzZXMgcmVqZWN0cy4KCSAqLwoJZnVuY3Rpb24gam9pbigvKiAuLi5wcm9taXNlcyAqLykgewoJCXJldHVybiBtYXAoYXJndW1lbnRzLCBpZGVudGl0eSk7Cgl9CgoJLyoqCgkgKiBUcmFkaXRpb25hbCBtYXAgZnVuY3Rpb24sIHNpbWlsYXIgdG8gYEFycmF5LnByb3RvdHlwZS5tYXAoKWAsIGJ1dCBhbGxvd3MKCSAqIGlucHV0IHRvIGNvbnRhaW4ge0BsaW5rIFByb21pc2V9cyBhbmQvb3IgdmFsdWVzLCBhbmQgbWFwRnVuYyBtYXkgcmV0dXJuCgkgKiBlaXRoZXIgYSB2YWx1ZSBvciBhIHtAbGluayBQcm9taXNlfQoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZSBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzCgkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBtYXBGdW5jIG1hcHBpbmcgZnVuY3Rpb24gbWFwRnVuYyh2YWx1ZSkgd2hpY2ggbWF5IHJldHVybgoJICogICAgICBlaXRoZXIgYSB7QGxpbmsgUHJvbWlzZX0gb3IgdmFsdWUKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBhIHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhbiBhcnJheSBjb250YWluaW5nCgkgKiAgICAgIHRoZSBtYXBwZWQgb3V0cHV0IHZhbHVlcy4KCSAqLwoJZnVuY3Rpb24gbWFwKHByb21pc2UsIG1hcEZ1bmMpIHsKCQlyZXR1cm4gd2hlbihwcm9taXNlLCBmdW5jdGlvbihhcnJheSkgewoJCQl2YXIgcmVzdWx0cywgbGVuLCB0b1Jlc29sdmUsIHJlc29sdmUsIGksIGQ7CgoJCQkvLyBTaW5jZSB3ZSBrbm93IHRoZSByZXN1bHRpbmcgbGVuZ3RoLCB3ZSBjYW4gcHJlYWxsb2NhdGUgdGhlIHJlc3VsdHMKCQkJLy8gYXJyYXkgdG8gYXZvaWQgYXJyYXkgZXhwYW5zaW9ucy4KCQkJdG9SZXNvbHZlID0gbGVuID0gYXJyYXkubGVuZ3RoID4+PiAwOwoJCQlyZXN1bHRzID0gW107CgkJCWQgPSBkZWZlcigpOwoKCQkJaWYoIXRvUmVzb2x2ZSkgewoJCQkJZC5yZXNvbHZlKHJlc3VsdHMpOwoJCQl9IGVsc2UgewoKCQkJCXJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlT25lKGl0ZW0sIGkpIHsKCQkJCQl3aGVuKGl0ZW0sIG1hcEZ1bmMpLnRoZW4oZnVuY3Rpb24obWFwcGVkKSB7CgkJCQkJCXJlc3VsdHNbaV0gPSBtYXBwZWQ7CgoJCQkJCQlpZighLS10b1Jlc29sdmUpIHsKCQkJCQkJCWQucmVzb2x2ZShyZXN1bHRzKTsKCQkJCQkJfQoJCQkJCX0sIGQucmVqZWN0KTsKCQkJCX07CgoJCQkJLy8gU2luY2UgbWFwRnVuYyBtYXkgYmUgYXN5bmMsIGdldCBhbGwgaW52b2NhdGlvbnMgb2YgaXQgaW50byBmbGlnaHQKCQkJCWZvcihpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCQkJaWYoaSBpbiBhcnJheSkgewoJCQkJCQlyZXNvbHZlKGFycmF5W2ldLCBpKTsKCQkJCQl9IGVsc2UgewoJCQkJCQktLXRvUmVzb2x2ZTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gZC5wcm9taXNlOwoKCQl9KTsKCX0KCgkvKioKCSAqIFRyYWRpdGlvbmFsIHJlZHVjZSBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLnJlZHVjZSgpYCwgYnV0CgkgKiBpbnB1dCBtYXkgY29udGFpbiBwcm9taXNlcyBhbmQvb3IgdmFsdWVzLCBhbmQgcmVkdWNlRnVuYwoJICogbWF5IHJldHVybiBlaXRoZXIgYSB2YWx1ZSBvciBhIHByb21pc2UsICphbmQqIGluaXRpYWxWYWx1ZSBtYXkKCSAqIGJlIGEgcHJvbWlzZSBmb3IgdGhlIHN0YXJ0aW5nIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZSBhcnJheSBvciBwcm9taXNlIGZvciBhbiBhcnJheSBvZiBhbnl0aGluZywKCSAqICAgICAgbWF5IGNvbnRhaW4gYSBtaXggb2YgcHJvbWlzZXMgYW5kIHZhbHVlcy4KCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlZHVjZUZ1bmMgcmVkdWNlIGZ1bmN0aW9uIHJlZHVjZShjdXJyZW50VmFsdWUsIG5leHRWYWx1ZSwgaW5kZXgsIHRvdGFsKSwKCSAqICAgICAgd2hlcmUgdG90YWwgaXMgdGhlIHRvdGFsIG51bWJlciBvZiBpdGVtcyBiZWluZyByZWR1Y2VkLCBhbmQgd2lsbCBiZSB0aGUgc2FtZQoJICogICAgICBpbiBlYWNoIGNhbGwgdG8gcmVkdWNlRnVuYy4KCSAqIEByZXR1cm5zIHtQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byB0aGUgZmluYWwgcmVkdWNlZCB2YWx1ZQoJICovCglmdW5jdGlvbiByZWR1Y2UocHJvbWlzZSwgcmVkdWNlRnVuYyAvKiwgaW5pdGlhbFZhbHVlICovKSB7CgkJdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgoJCXJldHVybiB3aGVuKHByb21pc2UsIGZ1bmN0aW9uKGFycmF5KSB7CgkJCXZhciB0b3RhbDsKCgkJCXRvdGFsID0gYXJyYXkubGVuZ3RoOwoKCQkJLy8gV3JhcCB0aGUgc3VwcGxpZWQgcmVkdWNlRnVuYyB3aXRoIG9uZSB0aGF0IGhhbmRsZXMgcHJvbWlzZXMgYW5kIHRoZW4KCQkJLy8gZGVsZWdhdGVzIHRvIHRoZSBzdXBwbGllZC4KCQkJYXJnc1swXSA9IGZ1bmN0aW9uIChjdXJyZW50LCB2YWwsIGkpIHsKCQkJCXJldHVybiB3aGVuKGN1cnJlbnQsIGZ1bmN0aW9uIChjKSB7CgkJCQkJcmV0dXJuIHdoZW4odmFsLCBmdW5jdGlvbiAodmFsdWUpIHsKCQkJCQkJcmV0dXJuIHJlZHVjZUZ1bmMoYywgdmFsdWUsIGksIHRvdGFsKTsKCQkJCQl9KTsKCQkJCX0pOwoJCQl9OwoKCQkJcmV0dXJuIHJlZHVjZUFycmF5LmFwcGx5KGFycmF5LCBhcmdzKTsKCQl9KTsKCX0KCgkvKioKCSAqIEVuc3VyZSB0aGF0IHJlc29sdXRpb24gb2YgcHJvbWlzZU9yVmFsdWUgd2lsbCB0cmlnZ2VyIHJlc29sdmVyIHdpdGggdGhlCgkgKiB2YWx1ZSBvciByZWFzb24gb2YgcHJvbWlzZU9yVmFsdWUsIG9yIGluc3RlYWQgd2l0aCByZXNvbHZlVmFsdWUgaWYgaXQgaXMgcHJvdmlkZWQuCgkgKgoJICogQHBhcmFtIHByb21pc2VPclZhbHVlCgkgKiBAcGFyYW0ge09iamVjdH0gcmVzb2x2ZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlc29sdmVyLnJlc29sdmUKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlc29sdmVyLnJlamVjdAoJICogQHBhcmFtIHsqfSBbcmVzb2x2ZVZhbHVlXQoJICogQHJldHVybnMge1Byb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGNoYWluKHByb21pc2VPclZhbHVlLCByZXNvbHZlciwgcmVzb2x2ZVZhbHVlKSB7CgkJdmFyIHVzZVJlc29sdmVWYWx1ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwoKCQlyZXR1cm4gd2hlbihwcm9taXNlT3JWYWx1ZSwKCQkJZnVuY3Rpb24odmFsKSB7CgkJCQl2YWwgPSB1c2VSZXNvbHZlVmFsdWUgPyByZXNvbHZlVmFsdWUgOiB2YWw7CgkJCQlyZXNvbHZlci5yZXNvbHZlKHZhbCk7CgkJCQlyZXR1cm4gdmFsOwoJCQl9LAoJCQlmdW5jdGlvbihyZWFzb24pIHsKCQkJCXJlc29sdmVyLnJlamVjdChyZWFzb24pOwoJCQkJcmV0dXJuIHJlamVjdGVkKHJlYXNvbik7CgkJCX0sCgkJCXJlc29sdmVyLnByb2dyZXNzCgkJKTsKCX0KCgkvLwoJLy8gVXRpbGl0eSBmdW5jdGlvbnMKCS8vCgoJLyoqCgkgKiBBcHBseSBhbGwgZnVuY3Rpb25zIGluIHF1ZXVlIHRvIHZhbHVlCgkgKiBAcGFyYW0ge0FycmF5fSBxdWV1ZSBhcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZQoJICogQHBhcmFtIHsqfSB2YWx1ZSBhcmd1bWVudCBwYXNzZWQgdG8gZWFjaCBmdW5jdGlvbgoJICovCglmdW5jdGlvbiBwcm9jZXNzUXVldWUocXVldWUsIHZhbHVlKSB7CgkJdmFyIGhhbmRsZXIsIGkgPSAwOwoKCQl3aGlsZSAoaGFuZGxlciA9IHF1ZXVlW2krK10pIHsKCQkJaGFuZGxlcih2YWx1ZSk7CgkJfQoJfQoKCS8qKgoJICogSGVscGVyIHRoYXQgY2hlY2tzIGFycmF5T2ZDYWxsYmFja3MgdG8gZW5zdXJlIHRoYXQgZWFjaCBlbGVtZW50IGlzIGVpdGhlcgoJICogYSBmdW5jdGlvbiwgb3IgbnVsbCBvciB1bmRlZmluZWQuCgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IGluZGV4IGF0IHdoaWNoIHRvIHN0YXJ0IGNoZWNraW5nIGl0ZW1zIGluIGFycmF5T2ZDYWxsYmFja3MKCSAqIEBwYXJhbSB7QXJyYXl9IGFycmF5T2ZDYWxsYmFja3MgYXJyYXkgdG8gY2hlY2sKCSAqIEB0aHJvd3Mge0Vycm9yfSBpZiBhbnkgZWxlbWVudCBvZiBhcnJheU9mQ2FsbGJhY2tzIGlzIHNvbWV0aGluZyBvdGhlciB0aGFuCgkgKiBhIGZ1bmN0aW9ucywgbnVsbCwgb3IgdW5kZWZpbmVkLgoJICovCglmdW5jdGlvbiBjaGVja0NhbGxiYWNrcyhzdGFydCwgYXJyYXlPZkNhbGxiYWNrcykgewoJCS8vIFRPRE86IFByb21pc2VzL0ErIHVwZGF0ZSB0eXBlIGNoZWNraW5nIGFuZCBkb2NzCgkJdmFyIGFyZywgaSA9IGFycmF5T2ZDYWxsYmFja3MubGVuZ3RoOwoKCQl3aGlsZShpID4gc3RhcnQpIHsKCQkJYXJnID0gYXJyYXlPZkNhbGxiYWNrc1stLWldOwoKCQkJaWYgKGFyZyAhPSBudWxsICYmIHR5cGVvZiBhcmcgIT0gJ2Z1bmN0aW9uJykgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdhcmcgJytpKycgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgkJCX0KCQl9Cgl9CgoJLyoqCgkgKiBOby1PcCBmdW5jdGlvbiB1c2VkIGluIG1ldGhvZCByZXBsYWNlbWVudAoJICogQHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gbm9vcCgpIHt9CgoJc2xpY2UgPSBbXS5zbGljZTsKCgkvLyBFUzUgcmVkdWNlIGltcGxlbWVudGF0aW9uIGlmIG5hdGl2ZSBub3QgYXZhaWxhYmxlCgkvLyBTZWU6IGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjQuNC4yMSBhcyB0aGVyZSBhcmUgbWFueQoJLy8gc3BlY2lmaWNzIGFuZCBlZGdlIGNhc2VzLgoJcmVkdWNlQXJyYXkgPSBbXS5yZWR1Y2UgfHwKCQlmdW5jdGlvbihyZWR1Y2VGdW5jIC8qLCBpbml0aWFsVmFsdWUgKi8pIHsKCQkJLypqc2hpbnQgbWF4Y29tcGxleGl0eTogNyovCgoJCQkvLyBFUzUgZGljdGF0ZXMgdGhhdCByZWR1Y2UubGVuZ3RoID09PSAxCgoJCQkvLyBUaGlzIGltcGxlbWVudGF0aW9uIGRldmlhdGVzIGZyb20gRVM1IHNwZWMgaW4gdGhlIGZvbGxvd2luZyB3YXlzOgoJCQkvLyAxLiBJdCBkb2VzIG5vdCBjaGVjayBpZiByZWR1Y2VGdW5jIGlzIGEgQ2FsbGFibGUKCgkJCXZhciBhcnIsIGFyZ3MsIHJlZHVjZWQsIGxlbiwgaTsKCgkJCWkgPSAwOwoJCQkvLyBUaGlzIGdlbmVyYXRlcyBhIGpzaGludCB3YXJuaW5nLCBkZXNwaXRlIGJlaW5nIHZhbGlkCgkJCS8vICJNaXNzaW5nICduZXcnIHByZWZpeCB3aGVuIGludm9raW5nIGEgY29uc3RydWN0b3IuIgoJCQkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pzaGludC9qc2hpbnQvaXNzdWVzLzM5MgoJCQlhcnIgPSBPYmplY3QodGhpcyk7CgkJCWxlbiA9IGFyci5sZW5ndGggPj4+IDA7CgkJCWFyZ3MgPSBhcmd1bWVudHM7CgoJCQkvLyBJZiBubyBpbml0aWFsVmFsdWUsIHVzZSBmaXJzdCBpdGVtIG9mIGFycmF5ICh3ZSBrbm93IGxlbmd0aCAhPT0gMCBoZXJlKQoJCQkvLyBhbmQgYWRqdXN0IGkgdG8gc3RhcnQgYXQgc2Vjb25kIGl0ZW0KCQkJaWYoYXJncy5sZW5ndGggPD0gMSkgewoJCQkJLy8gU2tpcCB0byB0aGUgZmlyc3QgcmVhbCBlbGVtZW50IGluIHRoZSBhcnJheQoJCQkJZm9yKDs7KSB7CgkJCQkJaWYoaSBpbiBhcnIpIHsKCQkJCQkJcmVkdWNlZCA9IGFycltpKytdOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCS8vIElmIHdlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgYXJyYXkgd2l0aG91dCBmaW5kaW5nIGFueSByZWFsCgkJCQkJLy8gZWxlbWVudHMsIGl0J3MgYSBUeXBlRXJyb3IKCQkJCQlpZigrK2kgPj0gbGVuKSB7CgkJCQkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBJZiBpbml0aWFsVmFsdWUgcHJvdmlkZWQsIHVzZSBpdAoJCQkJcmVkdWNlZCA9IGFyZ3NbMV07CgkJCX0KCgkJCS8vIERvIHRoZSBhY3R1YWwgcmVkdWNlCgkJCWZvcig7aSA8IGxlbjsgKytpKSB7CgkJCQkvLyBTa2lwIGhvbGVzCgkJCQlpZihpIGluIGFycikgewoJCQkJCXJlZHVjZWQgPSByZWR1Y2VGdW5jKHJlZHVjZWQsIGFycltpXSwgaSwgYXJyKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHJlZHVjZWQ7CgkJfTsKCglmdW5jdGlvbiBpZGVudGl0eSh4KSB7CgkJcmV0dXJuIHg7Cgl9CgoJcmV0dXJuIHdoZW47Cn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZAoJPyBkZWZpbmUKCTogZnVuY3Rpb24gKGZhY3RvcnkpIHsgdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCkpCgkJOiAodGhpcy53aGVuICAgICAgPSBmYWN0b3J5KCkpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgpkZWZpbmUoJ3doZW4nLCBbJ3doZW4vd2hlbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogYXBwbHkuanMKICogSGVscGVyIGZvciB1c2luZyBhcmd1bWVudHMtYmFzZWQgYW5kIHZhcmlhZGljIGNhbGxiYWNrcyB3aXRoIGFueQogKiB7QGxpbmsgUHJvbWlzZX0gdGhhdCByZXNvbHZlcyB0byBhbiBhcnJheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9hcHBseScsW10sZnVuY3Rpb24oKSB7CgogICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBpbmRpdmlkdWFsCiAgICAgKiBhcmd1bWVudHMgKGl0IGNhbiBiZSB2YXJpYWRpYywgdG9vKSwgYW5kIHJldHVybnMgYSBuZXcgZnVuY3Rpb24gdGhhdAogICAgICogdGFrZXMgYSBzaW5nbGUgYXJyYXkgYXMgaXRzIG9ubHkgcGFyYW06CiAgICAgKgogICAgICogZnVuY3Rpb24gYXJnQmFzZWQoYSwgYiwgYykgewogICAgICogICByZXR1cm4gYSArIGIgKyBjOwogICAgICogfQogICAgICoKICAgICAqIGFyZ0Jhc2VkKDEsIDIsIDMpOyAvLyA2CiAgICAgKgogICAgICogLy8gQ3JlYXRlIGFuIGFycmF5LWJhc2VkIHZlcnNpb24gb2YgYXJnQmFzZWQKICAgICAqIHZhciBhcnJheUJhc2VkID0gYXBwbHkoYXJnQmFzZWQpOwogICAgICogdmFyIGlucHV0cyA9IFsxLCAyLCAzXTsKICAgICAqCiAgICAgKiBhcnJheUJhc2VkKGlucHV0cyk7IC8vIDYKICAgICAqCiAgICAgKiBXaXRoIHByb21pc2VzOgogICAgICoKICAgICAqIHZhciBkID0gd2hlbi5kZWZlcigpOwogICAgICogZC5wcm9taXNlLnRoZW4oYXJyYXlCYXNlZCk7CiAgICAgKgogICAgICogZC5yZXNvbHZlKFsxLCAyLCAzXSk7IC8vIGFycmF5QmFzZWQgY2FsbGVkIHdpdGggYXJncyAxLCAyLCAzIC0+IDYKICAgICAqCiAgICAgKiBAcGFyYW0gZiB7RnVuY3Rpb259IGFyZ3VtZW50cy1iYXNlZCBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gYSBuZXcgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGFuIGFycmF5CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbihmKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGFycmF5IHtBcnJheX0gbXVzdCBiZSBhbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gdXNlIHRvIGFwcGx5IHRoZSBvcmlnaW5hbCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMgdGhlIHJlc3VsdCBvZiBhcHBseWluZyBmIHdpdGggdGhlIGFyZ3VtZW50cyBpbiBhcnJheS4KICAgICAgICAgKi8KICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICAgICAgLy8gSXQgYmV0dGVyIGJlIGFuIGFycmF5CiAgICAgICAgICAgIGlmKHRvU3RyaW5nLmNhbGwoYXJyYXkpICE9ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYXBwbHkgY2FsbGVkIHdpdGggbm9uLWFycmF5IGFyZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZi5hcHBseShudWxsLCBhcnJheSk7CiAgICAgICAgfTsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgID0gZmFjdG9yeSgpKQogICAgICAgIDogKHRoaXMud2hlbl9hcHBseSA9IGZhY3RvcnkoKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLypnbG9iYWwgc2V0VGltZW91dDp0cnVlKi8KCi8qKgogKiBkZWxheS5qcwogKgogKiBIZWxwZXIgdGhhdCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGFmdGVyIGEgZGVsYXkuCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgewpkZWZpbmUoJ3doZW4vZGVsYXknLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICB2YXIgdW5kZWY7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgYWZ0ZXIgYSBtc2VjIGRlbGF5LiAgSWYgcHJvbWlzZQogICAgICogaXMgc3VwcGxpZWQsIHRoZSBkZWxheSB3aWxsIHN0YXJ0ICphZnRlciogdGhlIHN1cHBsaWVkIHByb21pc2UgaXMgcmVzb2x2ZWQuCiAgICAgKgogICAgICogVXNhZ2U6CiAgICAgKiAvLyBEbyBzb21ldGhpbmcgYWZ0ZXIgMSBzZWNvbmQsIHNpbWlsYXIgdG8gdXNpbmcgc2V0VGltZW91dAogICAgICogZGVsYXkoMTAwMCkudGhlbihkb1NvbWV0aGluZyk7CiAgICAgKiAvLyBvcgogICAgICogd2hlbihkZWxheSgxMDAwKSwgZG9Tb21ldGhpbmcpOwogICAgICoKICAgICAqIC8vIERvIHNvbWV0aGluZyAxIHNlY29uZCBhZnRlciB0cmlnZ2VyaW5nUHJvbWlzZSByZXNvbHZlcwogICAgICogZGVsYXkodHJpZ2dlcmluZ1Byb21pc2UsIDEwMDApLnRoZW4oZG9Tb21ldGhpbmcsIGhhbmRsZVJlamVjdGlvbik7CiAgICAgKiAvLyBvcgogICAgICogd2hlbihkZWxheSh0cmlnZ2VyaW5nUHJvbWlzZSwgMTAwMCksIGRvU29tZXRoaW5nLCBoYW5kbGVSZWplY3Rpb24pOwogICAgICoKICAgICAqIEBwYXJhbSBbcHJvbWlzZV0gYW55dGhpbmcgLSBhbnkgcHJvbWlzZSBvciB2YWx1ZSBhZnRlciB3aGljaCB0aGUgZGVsYXkgd2lsbCBzdGFydAogICAgICogQHBhcmFtIG1zZWMge051bWJlcn0gZGVsYXkgaW4gbWlsbGlzZWNvbmRzCiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiBkZWxheShwcm9taXNlLCBtc2VjKSB7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgbXNlYyA9IHByb21pc2UgPj4+IDA7CiAgICAgICAgICAgIHByb21pc2UgPSB1bmRlZjsKICAgICAgICB9CgogICAgICAgIHZhciBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShwcm9taXNlKTsKICAgICAgICB9LCBtc2VjKTsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuX2RlbGF5ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKmdsb2JhbCBzZXRUaW1lb3V0OnRydWUsIGNsZWFyVGltZW91dDp0cnVlKi8KCi8qKgogKiB0aW1lb3V0LmpzCiAqCiAqIEhlbHBlciB0aGF0IHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVqZWN0cyBhZnRlciBhIHNwZWNpZmllZCB0aW1lb3V0LAogKiBpZiBub3QgZXhwbGljaXRseSByZXNvbHZlZCBvciByZWplY3RlZCBiZWZvcmUgdGhhdC4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi90aW1lb3V0JyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgdmFyIHVuZGVmOwoKICAgIC8qKgogICAgICogUmV0dXJucyBhIG5ldyBwcm9taXNlIHRoYXQgd2lsbCBhdXRvbWF0aWNhbGx5IHJlamVjdCBhZnRlciBtc2VjIGlmCiAgICAgKiB0aGUgc3VwcGxpZWQgcHJvbWlzZSBkb2Vzbid0IHJlc29sdmUgb3IgcmVqZWN0IGJlZm9yZSB0aGF0LgogICAgICoKICAgICAqIFVzYWdlOgogICAgICoKICAgICAqIHZhciBkID0gd2hlbi5kZWZlcigpOwogICAgICogLy8gU2V0dXAgZCBob3dldmVyIHlvdSBuZWVkCiAgICAgKgogICAgICogLy8gcmV0dXJuIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgZCBkb2Vzbid0IHJlc29sdmUvcmVqZWN0IGZpcnN0CiAgICAgKiByZXR1cm4gdGltZW91dChkLnByb21pc2UsIDEwMDApOwogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlIGFueXRoaW5nIC0gYW55IHByb21pc2Ugb3IgdmFsdWUgdGhhdCBzaG91bGQgdHJpZ2dlcgogICAgICogIHRoZSByZXR1cm5lZCBwcm9taXNlIHRvIHJlc29sdmUgb3IgcmVqZWN0IGJlZm9yZSB0aGUgbXNlYyB0aW1lb3V0CiAgICAgKiBAcGFyYW0gbXNlYyB7TnVtYmVyfSB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcwogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24gdGltZW91dChwcm9taXNlLCBtc2VjKSB7CiAgICAgICAgdmFyIGRlZmVycmVkLCB0aW1lb3V0UmVmOwoKICAgICAgICBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgdGltZW91dFJlZiA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICAgICAgICB0aW1lb3V0UmVmICYmIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoJ3RpbWVkIG91dCcpKTsKICAgICAgICB9LCBtc2VjKTsKCiAgICAgICAgZnVuY3Rpb24gY2FuY2VsVGltZW91dCgpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRSZWYpOwogICAgICAgICAgICB0aW1lb3V0UmVmID0gdW5kZWY7CiAgICAgICAgfQoKICAgICAgICB3aGVuKHByb21pc2UsCiAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgfQogICAgICAgICk7CgogICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl90aW1lb3V0ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogcGFyYWxsZWwuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHBhcmFsbGVsLiAgQWxsIHRhc2tzIHdpbGwKICogcmVjZWl2ZSB0aGUgc2FtZSBhcmdzCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgewpkZWZpbmUoJ3doZW4vcGFyYWxsZWwnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCgkvKioKCSAqIFJ1biBhcnJheSBvZiB0YXNrcyBpbiBwYXJhbGxlbAoJICogQHBhcmFtIHRhc2tzIHtBcnJheXxQcm9taXNlfSBhcnJheSBvciBwcm9taXNlRm9yQXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbYXJnc10geyp9IGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gYWxsIHRhc2tzCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciBhcnJheSBjb250YWluaW5nIHRoZQoJICogcmVzdWx0IG9mIGVhY2ggdGFzayBpbiB0aGUgYXJyYXkgcG9zaXRpb24gY29ycmVzcG9uZGluZwoJICogdG8gcG9zaXRpb24gb2YgdGhlIHRhc2sgaW4gdGhlIHRhc2tzIGFycmF5CgkgKi8KCXJldHVybiBmdW5jdGlvbiBwYXJhbGxlbCh0YXNrcyAvKiwgYXJncy4uLiAqLykgewoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gd2hlbi5tYXAodGFza3MsIGZ1bmN0aW9uKHRhc2spIHsKCQkJcmV0dXJuIHRhc2suYXBwbHkobnVsbCwgYXJncyk7CgkJfSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3BhcmFsbGVsID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogcGlwZWxpbmUuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHNlcXVlbmNlLCBwYXNzaW5nIHRoZSByZXN1bHQKICogb2YgdGhlIHByZXZpb3VzIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBuZXh0LiAgTGlrZSBhIHNoZWxsCiAqIHBpcGVsaW5lLCBlLmcuIGBjYXQgZmlsZS50eHQgfCBncmVwICdmb28nIHwgc2VkIC1lICdzL2Zvby9iYXIvZycKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9waXBlbGluZScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIGEgcGlwZWxpbmUgd2hlcmUgdGhlIG5leHQKCSAqIHRhc2tzIHJlY2VpdmVzIHRoZSByZXN1bHQgb2YgdGhlIHByZXZpb3VzLiAgVGhlIGZpcnN0IHRhc2sKCSAqIHdpbGwgcmVjZWl2ZSB0aGUgaW5pdGlhbEFyZ3MgYXMgaXRzIGFyZ3VtZW50IGxpc3QuCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2UgZm9yIGFycmF5IG9mIHRhc2sgZnVuY3Rpb25zCgkgKiBAcGFyYW0gW2luaXRpYWxBcmdzLi4uXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZmlyc3QgdGFzawoJICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSBmb3IgcmV0dXJuIHZhbHVlIG9mIHRoZSBmaW5hbCB0YXNrCgkgKi8KCXJldHVybiBmdW5jdGlvbiBwaXBlbGluZSh0YXNrcyAvKiBpbml0aWFsQXJncy4uLiAqLykgewoJCXZhciBpbml0aWFsQXJncywgcnVuVGFzazsKCgkJaW5pdGlhbEFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKCQkvLyBTZWxmLW9wdGltaXppbmcgZnVuY3Rpb24gdG8gcnVuIGZpcnN0IHRhc2sgd2l0aCBtdWx0aXBsZQoJCS8vIGFyZ3MgdXNpbmcgYXBwbHksIGJ1dCBzdWJzZXF1ZW5jZSB0YXNrcyB2aWEgZGlyZWN0IGludm9jYXRpb24KCQlydW5UYXNrID0gZnVuY3Rpb24odGFzaywgYXJncykgewoJCQlydW5UYXNrID0gZnVuY3Rpb24odGFzaywgYXJnKSB7CgkJCQlyZXR1cm4gdGFzayhhcmcpOwoJCQl9OwoJCQkKCQkJcmV0dXJuIHRhc2suYXBwbHkobnVsbCwgYXJncyk7CgkJfTsKCgkJcmV0dXJuIHdoZW4ucmVkdWNlKHRhc2tzLAoJCQlmdW5jdGlvbihhcmdzLCB0YXNrKSB7CgkJCQlyZXR1cm4gcnVuVGFzayh0YXNrLCBhcmdzKTsKCQkJfSwKCQkJaW5pdGlhbEFyZ3MKCQkpOwoJfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZAoJPyBkZWZpbmUKCTogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcKCQk/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQoJCTogKHRoaXMud2hlbl9waXBlbGluZSA9IGZhY3RvcnkodGhpcy53aGVuKSk7Cgl9CgkvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIHNlcXVlbmNlLmpzCiAqCiAqIFJ1biBhIHNldCBvZiB0YXNrIGZ1bmN0aW9ucyBpbiBzZXF1ZW5jZS4gIEFsbCB0YXNrcyB3aWxsCiAqIHJlY2VpdmUgdGhlIHNhbWUgYXJncy4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9zZXF1ZW5jZScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIHNlcXVlbmNlIHdpdGggbm8gb3ZlcmxhcAoJICogQHBhcmFtIHRhc2tzIHtBcnJheXxQcm9taXNlfSBhcnJheSBvciBwcm9taXNlRm9yQXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbYXJnc10geyp9IGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gYWxsIHRhc2tzCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciBhbiBhcnJheSBjb250YWluaW5nCgkgKiB0aGUgcmVzdWx0IG9mIGVhY2ggdGFzayBpbiB0aGUgYXJyYXkgcG9zaXRpb24gY29ycmVzcG9uZGluZwoJICogdG8gcG9zaXRpb24gb2YgdGhlIHRhc2sgaW4gdGhlIHRhc2tzIGFycmF5CgkgKi8KCXJldHVybiBmdW5jdGlvbiBzZXF1ZW5jZSh0YXNrcyAvKiwgYXJncy4uLiAqLykgewoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gd2hlbi5yZWR1Y2UodGFza3MsIGZ1bmN0aW9uKHJlc3VsdHMsIHRhc2spIHsKCQkJcmV0dXJuIHdoZW4odGFzay5hcHBseShudWxsLCBhcmdzKSwgZnVuY3Rpb24ocmVzdWx0KSB7CgkJCQlyZXN1bHRzLnB1c2gocmVzdWx0KTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9KTsKCQl9LCBbXSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3NlcXVlbmNlID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogY2FuY2VsYWJsZS5qcwogKgogKiBEZWNvcmF0b3IgdGhhdCBtYWtlcyBhIGRlZmVycmVkICJjYW5jZWxhYmxlIi4gIEl0IGFkZHMgYSBjYW5jZWwoKSBtZXRob2QgdGhhdAogKiB3aWxsIGNhbGwgYSBzcGVjaWFsIGNhbmNlbCBoYW5kbGVyIGZ1bmN0aW9uIGFuZCB0aGVuIHJlamVjdCB0aGUgZGVmZXJyZWQuICBUaGUKICogY2FuY2VsIGhhbmRsZXIgY2FuIGJlIHVzZWQgdG8gZG8gcmVzb3VyY2UgY2xlYW51cCwgb3IgYW55dGhpbmcgZWxzZSB0aGF0IHNob3VsZAogKiBiZSBkb25lIGJlZm9yZSBhbnkgb3RoZXIgcmVqZWN0aW9uIGhhbmRsZXJzIGFyZSBleGVjdXRlZC4KICoKICogVXNhZ2U6CiAqCiAqIHZhciBjYW5jZWxhYmxlRGVmZXJyZWQgPSBjYW5jZWxhYmxlKHdoZW4uZGVmZXIoKSwgbXlDYW5jZWxIYW5kbGVyKTsKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9jYW5jZWxhYmxlJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgLyoqCiAgICAgKiBNYWtlcyBkZWZlcnJlZCBjYW5jZWxhYmxlLCBhZGRpbmcgYSBjYW5jZWwoKSBtZXRob2QuCiAgICAgKgogICAgICogQHBhcmFtIGRlZmVycmVkIHtEZWZlcnJlZH0gdGhlIHtAbGluayBEZWZlcnJlZH0gdG8gbWFrZSBjYW5jZWxhYmxlCiAgICAgKiBAcGFyYW0gY2FuY2VsZXIge0Z1bmN0aW9ufSBjYW5jZWwgaGFuZGxlciBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdGhpcyBkZWZlcnJlZCBpcyBjYW5jZWxlZC4gIFRoaXMKICAgICAqIGlzIGd1YXJhbnRlZWQgdG8gcnVuIGJlZm9yZSBhbGwgb3RoZXIgcmVqZWN0aW9uIGhhbmRsZXJzLiAgVGhlIGNhbmNlbGVyIHdpbGwgTk9UIGJlIGV4ZWN1dGVkIGlmIHRoZQogICAgICogZGVmZXJyZWQgaXMgcmVqZWN0ZWQgaW4gdGhlIHN0YW5kYXJkIHdheSwgaS5lLiBkZWZlcnJlZC5yZWplY3QoKS4gIEl0IE9OTFkgZXhlY3V0ZXMgaWYgdGhlIGRlZmVycmVkCiAgICAgKiBpcyBjYW5jZWxlZCwgaS5lLiBkZWZlcnJlZC5jYW5jZWwoKQogICAgICoKICAgICAqIEByZXR1cm5zIGRlZmVycmVkLCB3aXRoIGFuIGFkZGVkIGNhbmNlbCgpIG1ldGhvZC4KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGRlZmVycmVkLCBjYW5jZWxlcikgewoKICAgICAgICB2YXIgZGVsZWdhdGUgPSB3aGVuLmRlZmVyKCk7CgogICAgICAgIC8vIEFkZCBhIGNhbmNlbCBtZXRob2QgdG8gdGhlIGRlZmVycmVkIHRvIHJlamVjdCB0aGUgZGVsZWdhdGUKICAgICAgICAvLyB3aXRoIHRoZSBzcGVjaWFsIGNhbmNlbGVkIGluZGljYXRvci4KICAgICAgICBkZWZlcnJlZC5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlLnJlamVjdChjYW5jZWxlcihkZWZlcnJlZCkpOwogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBvcmlnaW5hbCByZXNvbHZlLCByZWplY3QsIGFuZCBwcm9ncmVzcyBhbGwgZm9yd2FyZAogICAgICAgIC8vIHRvIHRoZSBkZWxlZ2F0ZQogICAgICAgIGRlZmVycmVkLnByb21pc2UudGhlbihkZWxlZ2F0ZS5yZXNvbHZlLCBkZWxlZ2F0ZS5yZWplY3QsIGRlbGVnYXRlLnByb2dyZXNzKTsKCiAgICAgICAgLy8gUmVwbGFjZSBkZWZlcnJlZCdzIHByb21pc2Ugd2l0aCB0aGUgZGVsZWdhdGUgcHJvbWlzZQogICAgICAgIGRlZmVycmVkLnByb21pc2UgPSBkZWxlZ2F0ZS5wcm9taXNlOwoKICAgICAgICAvLyBBbHNvIHJlcGxhY2UgZGVmZXJyZWQudGhlbiB0byBhbGxvdyBpdCB0byBiZSBjYWxsZWQgc2FmZWx5IGFuZAogICAgICAgIC8vIG9ic2VydmUgdGhlIGNhbmNlbGxhdGlvbgoJCS8vIFRPRE86IFJlbW92ZSBvbmNlIGRlZmVycmVkLnRoZW4gaXMgcmVtb3ZlZAogICAgICAgIGRlZmVycmVkLnRoZW4gPSBkZWxlZ2F0ZS5wcm9taXNlLnRoZW47CgogICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW5fY2FuY2VsYWJsZSA9IGZhY3RvcnkodGhpcy53aGVuKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKOyhmdW5jdGlvbihnKXsKCiAgICAvLyBzdW1tYXJ5OiBBIHNpbXBsZSBmZWF0dXJlIGRldGVjdGlvbiBmdW5jdGlvbi9mcmFtZXdvcmsuCiAgICAvLwogICAgLy8gbmFtZTogU3RyaW5nCiAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIGRldGVjdCwgYXMgZGVmaW5lZCBieSB0aGUgb3ZlcmFsbCBgaGFzYCB0ZXN0cy4KICAgIC8vICAgICAgVGVzdHMgY2FuIGJlIHJlZ2lzdGVyZWQgdmlhIGBoYXMuYWRkKHRlc3RuYW1lLCB0ZXN0ZnVuY3Rpb24pYC4KICAgIC8vCiAgICAvLyBleGFtcGxlOgogICAgLy8gICAgICBteWxpYnJhcnkuYmluZCA9IGhhcygibmF0aXZlLWJpbmQiKSA/IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgIC8vICAgICAgICAgIHJldHVybiBmbi5iaW5kKGNvbnRleHQpOwogICAgLy8gICAgICB9IDogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAvLyAgICAgICAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgIC8vICAgICAgICAgIH0KICAgIC8vICAgICAgfQoKICAgIHZhciBOT05fSE9TVF9UWVBFUyA9IHsgImJvb2xlYW4iOiAxLCAibnVtYmVyIjogMSwgInN0cmluZyI6IDEsICJ1bmRlZmluZWQiOiAxIH0sCiAgICAgICAgVkVORE9SX1BSRUZJWEVTID0gWyJXZWJraXQiLCAiTW96IiwgIk8iLCAibXMiLCAiS2h0bWwiXSwKICAgICAgICBkID0gaXNIb3N0VHlwZShnLCAiZG9jdW1lbnQiKSAmJiBnLmRvY3VtZW50LAogICAgICAgIGVsID0gZCAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVFbGVtZW50IikgJiYgZC5jcmVhdGVFbGVtZW50KCJEaVYiKSwKICAgICAgICBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICJvYmplY3QiICYmIGV4cG9ydHMsCiAgICAgICAgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIgJiYgbW9kdWxlLAogICAgICAgIHRlc3RDYWNoZSA9IHt9CiAgICA7CgogICAgZnVuY3Rpb24gaGFzKC8qIFN0cmluZyAqL25hbWUpewogICAgICAgIGlmKHR5cGVvZiB0ZXN0Q2FjaGVbbmFtZV0gPT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgIHRlc3RDYWNoZVtuYW1lXSA9IHRlc3RDYWNoZVtuYW1lXShnLCBkLCBlbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZXN0Q2FjaGVbbmFtZV07IC8vIEJvb2xlYW4KICAgIH0KCiAgICBmdW5jdGlvbiBhZGQoLyogU3RyaW5nICovbmFtZSwgLyogRnVuY3Rpb24gKi90ZXN0LCAvKiBCb29sZWFuPyAqL25vdyl7CiAgICAgICAgLy8gc3VtbWFyeTogUmVnaXN0ZXIgYSBuZXcgZmVhdHVyZSBkZXRlY3Rpb24gdGVzdCBmb3Igc29tZSBuYW1lZCBmZWF0dXJlCiAgICAgICAgLy8KICAgICAgICAvLyBuYW1lOiBTdHJpbmcKICAgICAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIHRlc3QuCiAgICAgICAgLy8KICAgICAgICAvLyB0ZXN0OiBGdW5jdGlvbgogICAgICAgIC8vICAgICAgQSB0ZXN0IGZ1bmN0aW9uIHRvIHJlZ2lzdGVyLiBJZiBhIGZ1bmN0aW9uLCBxdWV1ZWQgZm9yIHRlc3RpbmcgdW50aWwgYWN0dWFsbHkKICAgICAgICAvLyAgICAgIG5lZWRlZC4gVGhlIHRlc3QgZnVuY3Rpb24gc2hvdWxkIHJldHVybiBhIGJvb2xlYW4gaW5kaWNhdGluZwogICAgICAgIC8vICAgICAgdGhlIHByZXNlbmNlIG9mIGEgZmVhdHVyZSBvciBidWcuCiAgICAgICAgLy8KICAgICAgICAvLyBub3c6IEJvb2xlYW4/CiAgICAgICAgLy8gICAgICBPcHRpb25hbC4gT21pdCBpZiBgdGVzdGAgaXMgbm90IGEgZnVuY3Rpb24uIFByb3ZpZGVzIGEgd2F5IHRvIGltbWVkaWF0ZWx5CiAgICAgICAgLy8gICAgICBydW4gdGhlIHRlc3QgYW5kIGNhY2hlIHRoZSByZXN1bHQuCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIEEgcmVkdW5kYW50IHRlc3QsIHRlc3RGbiB3aXRoIGltbWVkaWF0ZSBleGVjdXRpb246CiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiamF2YXNjcmlwdCIsIGZ1bmN0aW9uKCl7IHJldHVybiB0cnVlOyB9LCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBBZ2FpbiB3aXRoIHRoZSByZWR1bmRhbnRuZXNzLiBZb3UgY2FuIGRvIHRoaXMgaW4geW91ciB0ZXN0cywgYnV0IHdlIHNob3VsZAogICAgICAgIC8vICAgICAgbm90IGJlIGRvaW5nIHRoaXMgaW4gYW55IGludGVybmFsIGhhcy5qcyB0ZXN0cwogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImphdmFzY3JpcHQiLCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBUaHJlZSB0aGluZ3MgYXJlIHBhc3NlZCB0byB0aGUgdGVzdEZ1bmN0aW9uLiBgZ2xvYmFsYCwgYGRvY3VtZW50YCwgYW5kIGEgZ2VuZXJpYyBlbGVtZW50CiAgICAgICAgLy8gICAgICBmcm9tIHdoaWNoIHRvIHdvcmsgeW91ciB0ZXN0IHNob3VsZCB0aGUgbmVlZCBhcmlzZS4KICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJidWctYnlpZCIsIGZ1bmN0aW9uKGcsIGQsIGVsKXsKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZyAgPT0gZ2xvYmFsLCB0eXBpY2FsbHkgd2luZG93LCB5YWRkYSB5YWRkYQogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBkICA9PSBkb2N1bWVudCBvYmplY3QKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZWwgPT0gdGhlIGdlbmVyaWMgZWxlbWVudC4gYSBgaGFzYCBlbGVtZW50LgogICAgICAgIC8vICB8ICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGZha2UgdGVzdCwgYnlpZC13aGVuLWZvcm0taGFzLW5hbWUtbWF0Y2hpbmctYW4taWQgaXMgc2xpZ2h0bHkgbG9uZ2VyCiAgICAgICAgLy8gIHwgICAgICAgfSk7CiAgICAgICAgdGVzdENhY2hlW25hbWVdID0gbm93ID8gdGVzdChnLCBkLCBlbCkgOiB0ZXN0OwogICAgfQoKICAgIC8vIGNzc3Byb3AgYWRhcHRlZCBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTk4MDA4ICh0aGFua3MsIF5waSkKICAgIGZ1bmN0aW9uIGNzc3Byb3AobmFtZSwgZWwpewogICAgICAgIHZhciBzdXBwb3J0ZWQgPSBmYWxzZSwKICAgICAgICAgICAgY2FwaXRhbGl6ZWQgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgICAgICAgICAgbGVuZ3RoID0gVkVORE9SX1BSRUZJWEVTLmxlbmd0aCwKICAgICAgICAgICAgc3R5bGUgPSBlbC5zdHlsZTsKCiAgICAgICAgaWYodHlwZW9mIHN0eWxlW25hbWVdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgd2hpbGUobGVuZ3RoLS0pewogICAgICAgICAgICAgICAgaWYodHlwZW9mIHN0eWxlW1ZFTkRPUl9QUkVGSVhFU1tsZW5ndGhdICsgY2FwaXRhbGl6ZWRdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdXBwb3J0ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJFbGVtZW50KGVsKXsKICAgICAgICBpZihlbCl7CiAgICAgICAgICAgIHdoaWxlKGVsLmxhc3RDaGlsZCl7CiAgICAgICAgICAgICAgICBlbC5yZW1vdmVDaGlsZChlbC5sYXN0Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbDsKICAgIH0KCiAgICAvLyBIb3N0IG9iamVjdHMgY2FuIHJldHVybiB0eXBlIHZhbHVlcyB0aGF0IGFyZSBkaWZmZXJlbnQgZnJvbSB0aGVpciBhY3R1YWwKICAgIC8vIGRhdGEgdHlwZS4gVGhlIG9iamVjdHMgd2UgYXJlIGNvbmNlcm5lZCB3aXRoIHVzdWFsbHkgcmV0dXJuIG5vbi1wcmltaXRpdmUKICAgIC8vIHR5cGVzIG9mIG9iamVjdCwgZnVuY3Rpb24sIG9yIHVua25vd24uCiAgICBmdW5jdGlvbiBpc0hvc3RUeXBlKG9iamVjdCwgcHJvcGVydHkpewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgcmV0dXJuIHR5cGUgPT0gIm9iamVjdCIgPyAhIW9iamVjdFtwcm9wZXJ0eV0gOiAhTk9OX0hPU1RfVFlQRVNbdHlwZV07CiAgICB9CgogICAgICAgIGhhcy5hZGQgPSBhZGQ7CiAgICBoYXMuY2xlYXJFbGVtZW50ID0gY2xlYXJFbGVtZW50OwogICAgaGFzLmNzc3Byb3AgPSBjc3Nwcm9wOwogICAgaGFzLmlzSG9zdFR5cGUgPSBpc0hvc3RUeXBlOwogICAgaGFzLl90ZXN0cyA9IHRlc3RDYWNoZTsKCiAgICBoYXMuYWRkKCJkb20iLCBmdW5jdGlvbihnLCBkLCBlbCl7CiAgICAgICAgcmV0dXJuIGQgJiYgZWwgJiYgaXNIb3N0VHlwZShnLCAibG9jYXRpb24iKSAmJiBpc0hvc3RUeXBlKGQsICJkb2N1bWVudEVsZW1lbnQiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50QnlJZCIpICYmIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRzQnlOYW1lIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudHNCeVRhZ05hbWUiKSAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVDb21tZW50IikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiY3JlYXRlRWxlbWVudCIpICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZVRleHROb2RlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgImFwcGVuZENoaWxkIikgJiYgaXNIb3N0VHlwZShlbCwgImluc2VydEJlZm9yZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJyZW1vdmVDaGlsZCIpICYmIGlzSG9zdFR5cGUoZWwsICJnZXRBdHRyaWJ1dGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAic2V0QXR0cmlidXRlIikgJiYgaXNIb3N0VHlwZShlbCwgInJlbW92ZUF0dHJpYnV0ZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJzdHlsZSIpICYmIHR5cGVvZiBlbC5zdHlsZS5jc3NUZXh0ID09ICJzdHJpbmciOwogICAgfSk7CgogICAgLy8gU3RvcCByZXBlYXQgYmFja2dyb3VuZC1pbWFnZSByZXF1ZXN0cyBhbmQgcmVkdWNlIG1lbW9yeSBjb25zdW1wdGlvbiBpbiBJRTYgU1AxCiAgICAvLyBodHRwOi8vbWlzdGVycGl4ZWwuYmxvZ3Nwb3QuY29tLzIwMDYvMDkvZm9yZW5zaWMtYW5hbHlzaXMtb2YtaWU2Lmh0bWwKICAgIC8vIGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2N3aWxzby9hcmNoaXZlLzIwMDYvMTEvMDcvaWUtcmUtZG93bmxvYWRpbmctYmFja2dyb3VuZC1pbWFnZXMuYXNweD9QYWdlSW5kZXg9MQogICAgLy8gaHR0cDovL3N1cHBvcnQubWljcm9zb2Z0LmNvbS9rYi84MjM3MjcKICAgIHRyeXsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiQmFja2dyb3VuZEltYWdlQ2FjaGUiLCBmYWxzZSwgdHJ1ZSk7CiAgICB9Y2F0Y2goZSl7fQoKICAgIC8vIEV4cG9zZSBoYXMoKQogICAgLy8gc29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zIGxpa2UgdGhlIGZvbGxvd2luZzoKICAgIGlmKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAib2JqZWN0IiAmJiBkZWZpbmUuYW1kKXsKICAgICAgICBkZWZpbmUoImhhcyIsW10sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBoYXM7CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgICBlbHNlIGlmKGZyZWVFeHBvcnRzKXsKICAgICAgICAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgICAgIGlmKGZyZWVNb2R1bGUgJiYgZnJlZU1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKXsKICAgICAgICAgIChmcmVlTW9kdWxlLmV4cG9ydHMgPSBoYXMpLmhhcyA9IGhhczsKICAgICAgICB9CiAgICAgICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgICAgICBlbHNlewogICAgICAgICAgZnJlZUV4cG9ydHMuaGFzID0gaGFzOwogICAgICAgIH0KICAgIH0KICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgZWxzZXsKICAgICAgICAvLyB1c2Ugc3F1YXJlIGJyYWNrZXQgbm90YXRpb24gc28gQ2xvc3VyZSBDb21waWxlciB3b24ndCBtdW5nZSBgaGFzYAogICAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vY2xvc3VyZS9jb21waWxlci9kb2NzL2FwaS10dXRvcmlhbDMuaHRtbCNleHBvcnQKICAgICAgICBnWyJoYXMiXSA9IGhhczsKICAgIH0KfSkodGhpcyk7CgpkZWZpbmUoJ3RocnVzdC9jYXBzdWxlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBmbGF0dGVuID0gXy5mbGF0dGVuLCBwbHVjayA9IF8ucGx1Y2ssIGZsYXR0ZW5Ub1Byb21pc2VzID0gdXRpbC5mbGF0dGVuVG9Qcm9taXNlcywgdGhydXN0Q2FjaGUgPSB7CiAgICB9LCBfX29wdGlvbmFsTWV0aG9kcyA9IFsKICAgICAgICAvLyBPcHRpb25hbCBtZXRob2RzIHRoYXQgbWF5IGJlIG9uIGEgbW9kdWxlCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnY29uZmlnJywgCiAgICAgICAgCiAgICBdLCBfX3JlcXVpcmVkTWV0aG9kcyA9IFsKICAgICAgICAvLyBSZXF1aXJlZCBtZXRob2RzIHRoYXQgbXVzdCBiZSBvbiBldmVyeSBtb2R1bGUKICAgICAgICAnaW5pdCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgCiAgICBdOwogICAgLyoqCiAgICBNb3ZlcyBhbGwgcHJvcGVydGllcywgdGhhdCBzaG91bGQgZXhpc3Qgb3V0c2lkZSBvZiB0aGUgbW9kdWxlLCBpbnRvIGEgcHJpdmF0ZSBvYmplY3QgZm9yIGhvbGRpbmcuCiAgICAKICAgIEBtZXRob2QgbW92ZVRvVGhydXN0Q2FjaGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gZnJvbSBPYmplY3QgdG8gZXh0cmFjdCBpdGVtcyBmcm9tCiAgICBAcGFyYW0ge09iamVjdH0gdG8gT2JqZWN0IHRvIHBsYWNlIGl0ZW1zIG9uCiAgICBAcGFyYW0ge0FycmF5fSBsaXN0IEl0ZW1zIHRvIG1vdmUgZnJvbSB0byB0aGUgb3RoZXIgb2JqZWN0CiAgICAqKi8KICAgIGZ1bmN0aW9uIG1vdmVUb1RocnVzdENhY2hlKGZyb20sIHRvLCBsaXN0KSB7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGxpc3QubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHRvW2xpc3RbaV1dID0gZnJvbVtsaXN0W2ldXTsKICAgICAgICAgICAgZGVsZXRlIGZyb21bbGlzdFtpXV07CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0RXZlbnROYW1lc3BhY2UobmFtZSwgcHJlZml4KSB7CiAgICAgICAgaWYoIXByZWZpeCkgewogICAgICAgICAgICBwcmVmaXggPSAnbW9kdWxlLSc7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnLicgKyAobmFtZSA9PT0gJ2dsb2JhbCcgPyAnZ2xvYmFsJyA6IHByZWZpeCArIG5hbWUucmVwbGFjZSgvXC4vZywgJy0nKSk7CiAgICB9CiAgICBmdW5jdGlvbiBjYWxsRmFjYWRlTWV0aG9kcyhtZXRob2QsIG1vZHVsZUNhY2hlKSB7CiAgICAgICAgdmFyIG0gPSBtb2R1bGVDYWNoZS5tb2R1bGU7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBfLmZvck93bihtb2R1bGVDYWNoZS5mYWNhZGVzLCBmdW5jdGlvbiAoZmFjYWRlLCBpKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgndGhydXN0L2NhcHN1bGU6IENhbGxpbmcgZmFjYWRlICJ7MH0iIHsxfSgpJywgaSwgbWV0aG9kKSk7CiAgICAgICAgICAgIGlmKGZhY2FkZVttZXRob2RdICYmIGlzT2JqZWN0KGZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChmYWNhZGVbbWV0aG9kXS5jYWxsKGZhY2FkZSwgbSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKHV0aWwuc2FmZUludm9rZSgobS50aHJ1c3QpLl9fdGhydXN0Q29udmVudGlvbnMsIG1ldGhvZCwgbSwgbW9kdWxlQ2FjaGUuZmFjYWRlcykpOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgLyoqCiAgICBUaGUgbW9kdWxlIGlzIHRoZSBoZWFydCBvZiB0aGUgdGhydXN0LCBldmVyeSBtb2R1bGUgZ2V0cyBvbmUgZmFjYWRlIHBlciBtb2R1bGUuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAY2xhc3MgdGhydXN0Lk1vZHVsZQogICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge09iamVjdH0gZGVmIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXSBUaGUgbW9kdWxlIG5hbWUuCiAgICAqKi8KICAgIHZhciBNb2R1bGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vdmFyIE1vZHVsZSA9CiAgICAgICAgZnVuY3Rpb24gTW9kdWxlKHRocnVzdCwgZGVmLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSB0aGlzLm5hbWUgPSAobmFtZSB8fCBkZWYubmFtZSk7CiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGRlZiA9IGRlZihuYW1lKTsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWlkID0gdGhpcy5taWQgPSB0aHJ1c3QubmFtZSArICc6JyArIG5hbWU7CiAgICAgICAgICAgIHZhciB0Q2FjaGUgPSB0aHJ1c3RDYWNoZVtkZWYuaGFzaCB8fCBtaWRdOwogICAgICAgICAgICAvLyBDbGVhciBhbnkgcG90ZW50aWFsIGNhY2hlZCBjb25maWcgb2JqZWN0cywgdG8gbWFrZSBzdXJlIHRoZXkgcmVmcmVzaCBpZiB0aGUgbW9kdWxlIGlzIHJlZGVmaW5lZC4KICAgICAgICAgICAgaWYodENhY2hlKSB7CiAgICAgICAgICAgICAgICBfLmtleXModENhY2hlKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgPT09IDA7CiAgICAgICAgICAgICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSB0Q2FjaGVbeF07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmluc3RhbmNlID0gZXh0ZW5kKGRlZiwgdENhY2hlICYmIHRDYWNoZS5pbnN0YW5jZSB8fCB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm5hbWUgPSAodGhpcy5pbnN0YW5jZS5uYW1lIHx8IG5hbWUpOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm1pZCA9IG1pZDsKICAgICAgICAgICAgaWYoIXRoaXMuaW5zdGFuY2UubmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbGwgTW9kdWxlcyBtdXN0IGhhdmUgYSBuYW1lIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgbXVzdCBoYXZlIGFuIGluaXQgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLCBpdCdzIHVwIHRvIHRoZSBtb2R1bGUgZGV2ZWxvcGVyIHRvIHBvcHVsYXRlIHRoZXNlIG1ldGhvZHMuCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBfX3JlcXVpcmVkTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCFkZWZbX19yZXF1aXJlZE1ldGhvZHNbaV1dKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUmVxdWlyZWQgInswfSIgbWV0aG9kIG5vdCBmb3VuZCBvbiBtb2R1bGUgInsxfSIhJywgX19yZXF1aXJlZE1ldGhvZHNbaV0sIG5hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJZiB0aGUgbW9kdWxlIG5hbWUgaXMgdW5kZWZpbmVkLCBicmluZyB0aGUgbmFtZSBpbnRvIHRoZSBtb2R1bGUuCiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYubmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhydXN0TW9kdWxlQ2FjaGVJdGVtID0gdGhydXN0Q2FjaGVbbWlkXSA9IGV4dGVuZCh0Q2FjaGUgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBfc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBuYW1lOiB1dGlsLmdldE1vZHVsZU5hbWVGb3JQYXRoKG5hbWUpLAogICAgICAgICAgICAgICAgbW9kdWxlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgdGhydXN0Q2FjaGVbZGVmLmhhc2hdOwogICAgICAgICAgICB2YXIgZmFjYWRlcyA9IHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzIHx8ICh0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKCF0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpIHsKICAgICAgICAgICAgICAgIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IGZsYXR0ZW4ocGx1Y2sodGhydXN0Ll9fY29udmVudGlvbnMgfHwgW10sICdwcm9wZXJ0aWVzJykpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSAhPT0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgYWxsIHNwZWNpYWwgcHJvcGVydGllcyBvZmYgdG8gdGhlIHRocnVzdCdzIGludGVybmFsIG1ldGhvZC4KICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX3JlcXVpcmVkTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19vcHRpb25hbE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSk7CiAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aHJ1c3QsICdjcmVhdGVGYWNhZGUnLCB0aHJ1c3QsIHRoaXMuaW5zdGFuY2UsIGZhY2FkZXMpOwogICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gZ2V0RXZlbnROYW1lc3BhY2UodGhpcy5pbnN0YW5jZS5uYW1lKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSB0aHJ1c3Q7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSB0aHJ1c3RDYWNoZVttaWRdOwogICAgICAgIH0KICAgICAgICBNb2R1bGUudGhydXN0Q2FjaGUgPSB0aHJ1c3RDYWNoZTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmNvbnZlbnRpb24gPSAvKioKICAgICAgICBHZXR0ZXIvU2V0dGVyIGZvciBjb252ZW50aW9uIG1ldGhvZHMuCiAgICAgICAgR2V0cyB0aGUgdmFsdWUgY29udmVudGlvbiBwcm9wZXJ0eSAoZGVmaW5lZCBpbiB0aGUgcHJvcGVydGllcyBhcnJheSBvZiBhIGZhY2FkZSkuCiAgICAgICAgU2V0cyB0aGUgdmFsdWUgb2YgYSBjb252ZW50aW9uIHByb3BlcnR5IChmb3Igc3RvcmluZyBjb252ZW50aW9uIGNvbmZpZ3VyYXRpb24pCiAgICAgICAgCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgQHBhcmFtIHtvYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldAogICAgICAgIEBtZXRob2QgY29udmVudGlvbgogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSB2YWxhdWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgdGMgPSB0aGlzLmNhY2hlOwogICAgICAgICAgICBpZihwcm9wZXJ0eS5pbmRleE9mKCdjb25maWcuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0Y1twcm9wZXJ0eV0gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdGhpcy5nZXRWYWx1ZUZyb21QYXRoKHByb3BlcnR5LCB0YykgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRjW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuZ2V0VmFsdWVGcm9tUGF0aCA9IGZ1bmN0aW9uIChwYXRoLCBvYmplY3QpIHsKICAgICAgICAgICAgdmFyIHBhdGhzID0gcGF0aC5zcGxpdCgnLicpLCB2ID0gb2JqZWN0OwogICAgICAgICAgICBfLmVhY2gocGF0aHMsIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICB2ID0gdiAmJiB2W3BdOwogICAgICAgICAgICAgICAgaWYoIXYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q3JlYXRlID0gLyoqCiAgICAgICAgSW5qZWN0cyB0aGlzIG1vZHVsZSBpbnRvIHRoZSBnaXZlbiB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDcmVhdGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB0aHJ1c3QuX19pbmplY3RNb2R1bGUodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENhbGwgPSAvKioKICAgICAgICBNYWtlcyBhIGNhbGwgdG8gYWxsIHRoZSBtb2R1bGVzIGZhY2FkZXMKICAgICAgICBUaGUgb3JkZXIgb2YgdGhlIGNhbGwgZGVwZW5kcyBvbiB0aGUgb3JkZXIgcmVxdWlyZWQuCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydHVwIHN0YWdlIChpbml0LCBzdGFydCwgcmVhZHkpIGZhY2FkZXMgYXJlIGNhbGxlZCBmaXJzdC4KICAgICAgICBEdXJpbmcgdGhlIHNodXRkb3duIHN0YXRlIChzdG9wLCBkZXN0cm95KSBmYWNhZGVzIGFyZSBjYWxsZWQgbGFzdC4KICAgICAgICBUaGlzIGFsbG93cyBtb2R1bGVzIHRvIHN0YXJ0dXAgYW5kIHNodXRkb3duIHdpbGwgYWxsIHRoZSB0b29scyBpdCBoYWQgdG8gYmVnaW4gd2l0aC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENhbGwKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgbWV0aG9kIHRvIGNhbGwKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZhY2FkZUFmdGVyIGNhbGxzIGZhY2FkZSBtZXRob2RzIGJlZm9yZSBvciBhZnRlciBtb2R1bGUgbWV0aG9kLgogICAgICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgQXJncyB0byBiZSBwYXNzZWQgb250byB0aGUgbW9kdWxlIG1ldGhvZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobWV0aG9kLCBmYWNhZGVBZnRlciwgYXJncykgewogICAgICAgICAgICB2YXIgc2VxID0gW10sIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZXMgZm9yICJ7MH0iJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHRoaXMuY2FjaGUsIG0gPSBjYWNoZVttZXRob2RdOwogICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBjYWNoZSk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKG0pIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFjYWRlQWZ0ZXIpIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKHNlcS5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShzZXEpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBtb2R1bGUsIGluc2lkZSB0aGUgdGhydXN0IGNvbnRhaW5lciBpdCB3YXMgY3JlYXRlZCBvbi4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0LnRocnVzdC5zdGFydCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgU3RvcCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RvcCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIE1vZHVsZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1vZHVsZSA9IE1vZHVsZTsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZS4KICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e21vZHVsZU5hbWV9CiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgbW9kdWxlTmFtZSA9IHBhcnRzWzFdOwogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSB0aHJ1c3QubW9kdWxlc1ttb2R1bGVOYW1lXTsKICAgICAgICAgICAgaWYoIW1vZHVsZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBtb2R1bGVOYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jYXBzdWxlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2luc3RhbmNlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19jYXBzdWxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIC8qKgogICAgR2V0cyB0aGUgdGhydXN0IGluc3RhbmNlcy4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciBjYXBzdWxlID0gX19jYXBzdWxlX187CgogICAgLyoqCiAgICBUaGUgYXZhaWxhYmxlIHRocnVzdCBpbnN0YW5jZXMKICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQGZvciB0aHJ1c3QuaW5zdGFuY2UKICAgIEBwcm9wZXJ0eSBpbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMuaW5zdGFuY2VzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGxvYWRpbmcgdGh1cnN0IGluc3RhbmNlcy4KICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQHByb3BlcnR5IGxvYWRpbmdJbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIAogICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICoqLwogICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgIHJldHVybiBleHBvcnRzLmluc3RhbmNlc1tuYW1lXSB8fCBudWxsOwogICAgfQogICAgZXhwb3J0cy5nZXRJbnN0YW5jZSA9IGdldEluc3RhbmNlOwogICAgLyoqCiAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAKICAgIEBtZXRob2QgZmV0Y2hJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgKiovCiAgICBmdW5jdGlvbiBmZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICB2YXIgZGVmZXIgPSBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gfHwgKGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1tuYW1lXSA9IHdoZW4uZGVmZXIoKSk7CiAgICAgICAgcmV0dXJuIGRlZmVyOwogICAgfQogICAgZXhwb3J0cy5mZXRjaEluc3RhbmNlID0gZmV0Y2hJbnN0YW5jZTsKICAgIC8qKgogICAgQ2xlYXJzIHRoZSBUaHJ1c3QgSW5zdGFuY2UgY2FjaGUsIHRoaXMgaXMgdXNlZCBmb3IgdW5pdCB0ZXN0aW5nLCBhbmQgY2xlYXJpbmcgYWxsIHRoZSBjYWNoZSBkYXRhIGVhY2ggcnVuLgogICAgCiAgICBAbWV0aG9kIGNsZWFyQ2FjaGUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5pbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmluc3RhbmNlc1t4XSA9IG51bGw7CiAgICAgICAgICAgIGRlbGV0ZSBleHBvcnRzLmluc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdOwogICAgICAgIH0pOwogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF07CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsZWFyQ2FjaGUgPSBjbGVhckNhY2hlOwogICAgLyp9Ki8gfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aW5zdGFuY2UuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdGhydXN0SW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgY29uZmlnIHsqLwogICAgCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBpZiBpdCBzaG91bGQgdGhyb3cgZXJyb3JzIG9yIG5vdC4KICAgIEluIHByb2R1Y3Rpb24gaXQncyByZWNvbW1lbmRlZCBub3QgdG8gdGhyb3cgZXJyb3JzLCB0aGF0IHdheSBpZiBhIGNvbXBvbmVudCBmYWlscwogICAgdGhlcmUgaXMgYSBjaGFuY2UgdGhlIGFwcGxpY2F0aW9uIGNhbiBzdGlsbCByZWNvdmVyLgogICAgCiAgICBAZm9yIHRocnVzdC5jb25maWcKICAgIEBwcm9wZXJ0eSB0aHJvd0Vycm9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqKi8KICAgIGV4cG9ydHMudGhyb3dFcnJvcnMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aGUgZnJhbWV3b3JrIHRvIHJ1biBpbiBhc3luYyBtb2RlLCB0aGlzIG1heSBkZWxheSBzdGFydCB1cCwgYnV0IHdpbGwgbWFrZSBpbWFnZSBsb2FkaW5nIGFuZCBpbml0YWwgcnVubmluZyBhcHBlYXIgZmFzdGVyLgogICAgCiAgICBAcHJvcGVydHkgYXN5bmMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuYXN5bmMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aHJ1c3QgdG8gZXhwb3NlIGVhY2ggaW5zdGFuY2UgYXMgYSBnbG9iYWwsIHRoaXMgYWxsb3dzIGxlZ2FjeSBjb21wb25lbnRzIHRvIHV0aWxpemUgcGFydHMgb2YgdGhydXN0LCBvciBlYXNpbHkKICAgIGdldCBhdCB5b3VyIHRocnVzdCBpbnN0YW5jZSBkdXJpbmcgZGVidWdnaW5nLgogICAgCiAgICBAcHJvcGVydHkgZXhwb3NlR2xvYmFscwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IHRydWUKICAgICoqLwogICAgZXhwb3J0cy5leHBvc2VHbG9iYWxzID0gdHJ1ZTsKICAgIGV4cG9ydHMudXJsID0gewogICAgICAgIHBhdGg6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIGdpdmVzIHRoZSBmcmFtZXdvcmsgaXQncyBkZWZhdWx0IHBhdGgsIGlmIGRpZmZlcmVudCB0aGFuICcvJwogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwucGF0aAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgIi8iCiAgICAgICAgKiovCiAgICAgICAgJy8nLAogICAgICAgIHRyYWRpdGlvbmFsRW5jb2Rpbmc6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaG93IGl0IHNob3VsZCBlbmNvZGUgYXJyYXkgZm9ybSBkYXRhLgogICAgICAgIEluIGdlbmVyYWwsIGZvciBBU1AuTkVUIGJhc2VkIGFwcGxpY2F0aW9ucywgdHJhZGl0aW9uYWwgc2hvdWxkIGJlIHRydWUuCiAgICAgICAgRm9yIFJ1YnkvUHl0aG9uIGJhc2VkIGFwcGxpY2F0aW9ucywgdGhpcyBzaG91bGQgYmUgZmFsc2UuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IHVybC50cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgZXhwb3J0cy5sb2cgPSB7CiAgICAgICAgbGV2ZWw6IC8qKgogICAgICAgIFRoaXMgbGVuZHMgdG8gdGhlIGxvZyBsZXZlbCBvZiB0aHJ1c3QuCiAgICAgICAgCiAgICAgICAgRVJST1I6IDEKICAgICAgICBXQVJOOiAyCiAgICAgICAgSU5GTzogMwogICAgICAgIERFQlVHOiA0CiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5sZXZlbAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgMQogICAgICAgICoqLwogICAgICAgIDQsCiAgICAgICAgZW5hYmxlZDogLyoqCiAgICAgICAgVGhpcyB0b2dnbGVzIGVuYWJsaW5nIG9uIG9yIG9mZi4KICAgICAgICAKICAgICAgICBAcHJvcGVydHkgbG9nLmVuYWJsZWQKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICoqLwogICAgICAgIHRydWUKICAgIH07CiAgICAvKioKICAgIFBsdWdpbnMgZm9yIHRocnVzdCB0byBsb2FkLCBvdmVycmlkZSB3aXRoIHlvdXIgb3duIHNldCBpZiB5b3UgaGF2ZSBhIGRpZmZlcmVudCBzZXQuCiAgICAKICAgIEBwcm9wZXJ0eSBwbHVnaW5zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5wbHVnaW5zID0gW107CiAgICAvKioKICAgICogVGhlIHNldCBvZiBtb2R1bGVzIHRvIHByZWxvYWQgd2l0aCB0aGUgaW5pdGFsIHdpcmV1cCBvZiB0aGUgVGhydXN0IGluc3RhbmNlLgogICAgKgogICAgKiBBY2NlcHRzIHRoZSBtb2R1bGUgcGF0aCBhIHN0cmluZyBvciB0aGUgbW9kdWxlIGFzIGFuIG9iamVjdCBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdC4KICAgICogICBXaGVyZSBhcmdzIHdpbGwgYmUgaGFuZGVkIG9mZiB0byB0aGUgbW9kdWxlIGxpZmUgY3ljbGUgbWV0aG9kcy4KICAgICoKICAgICogICAgewogICAgKiAgICAgICAgcGF0aDogJycsCiAgICAqICAgICAgICBhcmdzOiBbXQogICAgKiAgICB9CiAgICAqCiAgICAqIEBwcm9wZXJ0eSBtb2R1bGVzCiAgICAqIEByZWFkT25seQogICAgKiBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMubW9kdWxlcyA9IFtdOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluZSBpZiB0aGUgbGlmZS1jeWNsZSBpcyBjb250cm9sbGVkIGJ5IHRocnVzdCwgb3IgYSBwYXJlbnQgaW5zdGFuY2UuCiAgICAKICAgIEBwcm9wZXJ0eSBjaGlsZEluc3RhbmNlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgKiovCiAgICBleHBvcnRzLmNoaWxkSW5zdGFuY2UgPSBmYWxzZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhydXN0IHNob3VsZCBjb250cm9sIHRoZSBsaWZlLWN5Y2xlLCBvciB0aGUgY29uc3VtZXIKICAgIAogICAgQHByb3BlcnR5IGF1dG9tYXRpY0xpZmVjeWNsZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvbWF0aWNMaWZlY3ljbGUgPSB0cnVlOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluIGlmIHRoZSB0aHJ1c3QgaW5zdGFuY2Ugc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgdXBvbiBjcmVhdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGF1dG9TdGFydAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvU3RhcnQgPSBmYWxzZTsKICAgIC8qKgogICAgRGVmaW5lIHRoZSBjb252ZW50aW9ucyB0aGF0IHVuaXF1ZSB0byB0aHJ1c3QsIHRoZXkgYXJlIG5vdCBzcGVjaWZpYyB0byBhbnkgb25lIHBsdWdpbi4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vY29udGFpbmVyJywgCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycKICAgIF07CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgY29uZmlnIGZvciB0aGUgY3VycmVudCB0aHJ1c3QgaW5zdGFuY2UsIG9yIHRoZSBjb25maWcgb2YgdGhlIGdpdmVuIHBsdWdpbi4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBjb25maWcgcGx1Z2luLgogICAgdGhydXN0L2NvbmZpZyFnbG9iYWwgPSB0aHJ1c3QhZ2xvYmFsOmNvbmZpZyA9IFRocnVzdCBpbnN0YW5jZSBjb25maWcgZnJvbSB0aGUgaW5zdGFuY2UgbmFtZWQgZ2xvYmFsLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8IGZhbHNlOwogICAgICAgIHZhciBpbnN0YW5jZURlZmVycmVkID0gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VEZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IHBsdWdpbk5hbWUgJiYgY29udGV4dC5jZmdbcGx1Z2luTmFtZV0gfHwgY29udGV4dC5jb25maWc7CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luICInICsgcGx1Z2luTmFtZSArICciIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiJyArIHJlYWxOYW1lICsgJyIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9sb2cnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vY29uZmlnJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdENvbmZpZ19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgCiAgICAqKi8KICAgIAogICAgLy8gTG9nIGxldmVscwogICAgdmFyIExFVkVMID0gewogICAgICAgIERFQlVHOiA0LAogICAgICAgIElORk86IDMsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMQogICAgfTsKICAgIC8vIERlY2xhcmUgb3VyIHZhcmlhYmxlcwogICAgICAgIHZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGUsIHRpbWVycyA9IHsKICAgIH0sIGNMb2cgPSAoY29uc29sZSAmJiBjb25zb2xlLmxvZykgfHwgZmFsc2UsIGNXYXJuID0gKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB8fCBmYWxzZSwgY0luZm8gPSAoY29uc29sZSAmJiBjb25zb2xlLmluZm8pIHx8IGZhbHNlLCBjRXJyb3IgPSAoY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB8fCBmYWxzZSwgY1RpbWUgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lJ10pIHx8IGZhbHNlLCBjVGltZUVuZCA9IChjb25zb2xlICYmIGNvbnNvbGVbJ3RpbWVFbmQnXSkgfHwgZmFsc2UsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBjb25maWdMZXZlbCA9IHRDb25maWcubG9nLmxldmVsIHx8IExFVkVMLkVSUk9SLCBsb2dMZXZlbCA9IExFVkVMW2NvbmZpZ0xldmVsXSB8fCAodHlwZW9mIGNvbmZpZ0xldmVsID09PSAnc3RyaW5nJyAmJiBMRVZFTFtjb25maWdMZXZlbC50b1VwcGVyQ2FzZSgpXSkgfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ251bWJlcicgJiYgY29uZmlnTGV2ZWwpIHx8IExFVkVMLkVSUk9SOwogICAgLy8gVmFyaW91cyBsb2dnZXJzIHRvIGhhbmRsZSBJRTgvOSBzdXBwb3J0LgogICAgdmFyIGxvZ1J1bm5lciA9IGZ1bmN0aW9uIChjb25zb2xlTWV0aG9kLCBsb2dUeXBlKSB7CiAgICAgICAgLy8gU2hvdyBsb2dzIHdoZW4gZW5hYmxlZCBvciBpZiB0aGV5IGFyZSBlcnJvcnMKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBpZihjb25zb2xlTWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGNvbnNvbGVNZXRob2QuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKCFjb25zb2xlTWV0aG9kICYmIGNMb2cpIHsKICAgICAgICAgICAgaWYoY0xvZy5hcHBseSkgewogICAgICAgICAgICAgICAgY0xvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNMb2coYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkxvZwogICAgKiovCiAgICAvKioKICAgIExvZ3MgYSBkZWJ1ZyB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZAogICAgCiAgICBAbWV0aG9kIGRlYnVnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNMb2cpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2xvZycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZGVidWcgPSBkZWJ1ZzsKICAgIC8qKgogICAgTG9ncyBhIGluZm8gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGluZm8gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCBpbmZvCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLklORk8pIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjSW5mbyk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnaW5mbycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5mbyA9IGluZm87CiAgICAvKioKICAgIExvZ3MgYSB3YXJuIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB3YXJuIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2Qgd2FybgogICAgKiovCiAgICBmdW5jdGlvbiB3YXJuKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5XQVJOKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1dhcm4pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ3dhcm4nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLndhcm4gPSB3YXJuOwogICAgLyoqCiAgICBMb2dzIGEgZXJyb3IgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGVycm9yIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgZXJyb3IKICAgICoqLwogICAgZnVuY3Rpb24gZXJyb3IoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLkVSUk9SKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0Vycm9yKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdlcnJvcicpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZXJyb3IgPSBlcnJvcjsKICAgIC8qKgogICAgTG9ncyBhIHRpbWUgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWUgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCB0aW1lCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWUobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0gPSB7CiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1zZyA9IHV0aWwuZm9ybWF0KCd7MH06IHRpbWVyIHN0YXJ0ZWQnLCBtZXNzYWdlKSwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZSk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWUgPSB0aW1lOwogICAgLyoqCiAgICBMb2dzIGEgdGltZUVuZCB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZUVuZCBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgQ2F1c2VzIHRoZSB0aW1lciB0byBlbmQsIGZvciB0aGUgZ2l2ZW4gbWVzc2FnZS4KICAgIAogICAgQG1ldGhvZCB0aW1lRW5kCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWVFbmQobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0uZW5kID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKICAgICAgICAgICAgdmFyIHRpbWUgPSB0aW1lcnNbbWVzc2FnZV0uZW5kIC0gdGltZXJzW21lc3NhZ2VdLnN0YXJ0LCBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB7MX1tcycsIG1lc3NhZ2UsIHRpbWUpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZUVuZCk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWVFbmQgPSB0aW1lRW5kOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1sb2cuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvaWduaXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdtb2R1bGUnLCAndGhydXN0L3V0aWwnLCAnLi9jb25maWcnLCAnLi9jYXBzdWxlJywgJy4vaW5zdGFuY2UnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19yZXF1aXJlTW9kdWxlX18sIF9fdXRpbF9fLCBfX2NvbmZpZ19fLCBfX3RtX18sIF9faW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgcmVxdWlyZU1vZHVsZSA9IF9fcmVxdWlyZU1vZHVsZV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0bSA9IF9fdG1fXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBpc0FycmF5ID0gXy5pc0FycmF5LCB0b0FycmF5ID0gXy50b0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgYW55ID0gXy5hbnksIGFsbCA9IF8uYWxsLCB3aGVuID0gdXRpbC53aGVuLCBleHRlbmQgPSBfLmV4dGVuZCwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGtleXMgPSBfLmtleXMsIHVuaW9uID0gXy51bmlvbjsKICAgIC8qZnVuY3Rpb24gcmVjb25jaWxlQXJyYXlzKGNvbmZpZywgc2V0dGluZ3MsIHRvKQogICAgewogICAgdmFyIGtleXMgPSBfLmtleXMoY29uZmlnKTsKICAgIGlmIChzZXR0aW5ncykKICAgIHsKICAgIGtleXMgPSB1bmlvbihfLmtleXMoc2V0dGluZ3MpLCBrZXlzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgIHNldHRpbmdzID0ge307CiAgICB9CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChpKQogICAgewogICAgdmFyIHggPSBzZXR0aW5nc1tpXSB8fCBjb25maWdbaV07CiAgICBpZiAoaXNBcnJheSh4KSkKICAgIHsKICAgIHRvW2ldID0gdG9BcnJheShzZXR0aW5nc1tpXSB8fCB0b1tpXSk7CiAgICB9CiAgICBlbHNlIGlmIChpc09iamVjdCh4KSAmJiAhaXNGdW5jdGlvbih4KSkKICAgIHsKICAgIHJlY29uY2lsZUFycmF5cyh4LCBudWxsLCB0b1tpXSk7CiAgICB9CiAgICB9KTsKICAgIH0qLwogICAgZnVuY3Rpb24gbWVyZ2VTZXR0aW5ncyhzZXR0aW5ncykgewogICAgICAgIGlmKChzZXR0aW5ncykuX19zZXR0aW5nc01lcmdlZCkgewogICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgfQogICAgICAgIHZhciByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgcGx1Z2lucyA9IFsKICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvcicKICAgICAgICBdLmNvbmNhdChzZXR0aW5ncy5wbHVnaW5zIHx8IHJlcXVpcmVDb25maWcucGx1Z2lucyB8fCBjb25maWcucGx1Z2lucyB8fCBbXSksIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHJlcXVpcmVNb2R1bGUuY29uZmlnKCkuY29udmVudGlvbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pOwogICAgICAgIHNldHRpbmdzID0gXy5tZXJnZSh7CiAgICAgICAgfSwgY29uZmlnLCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLCBzZXR0aW5ncywgewogICAgICAgICAgICBfX3NldHRpbmdzTWVyZ2VkOiB0cnVlLAogICAgICAgICAgICBwbHVnaW5zOiBwbHVnaW5zLAogICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICB9KTsKICAgICAgICBzZXR0aW5ncy5wbHVnaW5zID0gcGx1Z2luczsKICAgICAgICBzZXR0aW5ncy5jb252ZW50aW9ucyA9IGNvbnZlbnRpb25zOwogICAgICAgIHJldHVybiBzZXR0aW5nczsKICAgIH0KICAgIGV4cG9ydHMubWVyZ2VTZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3M7CiAgICBmdW5jdGlvbiBmdXNlKHNldHRpbmdzKSB7CiAgICAgICAgdmFyIHBpcGUgPSBbXTsKICAgICAgICBzZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgIGlmKCFpbnN0YW5jZS5pbnN0YW5jZXNbc2V0dGluZ3MubmFtZV0pIHsKICAgICAgICAgICAgcGlwZS5wdXNoKHN0YWdlT25lKTsKICAgICAgICB9CiAgICAgICAgcGlwZS5wdXNoKHN0YWdlVHdvKTsKICAgICAgICBpZihzZXR0aW5ncy5tb2R1bGVzICYmIHNldHRpbmdzLm1vZHVsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZVRocmVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuZnVzZSA9IGZ1c2U7CiAgICAvKioKICAgIENvbnRydWN0cyBhIHdpcmUgc3BlYyBmb3IgdGhydXN0IHRvIGxhdW5jaCBmcm9tLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIE1lcmdlcyBhIGFsbCB0aGUgcGx1Z2lucyBjb25maWd1cmF0aW9ucywgd2l0aCB0aGUgZGVmYXVsdCBjb25maWcsIGFuZCB0aGVuIGZpbmFsbHkgd2l0aAogICAgYW55IGN1c3RvbWl6ZWQgY29uZmlnIGZyb20gcmVxdWlyZWpzCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VPbmUKICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGludHMgdG8gcGFzcyBvbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYmVpbmcgY3JlYXRlZC4KICAgICoqLwogICAgZnVuY3Rpb24gc3RhZ2VPbmUoc2V0dGluZ3MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBzZXR0aW5ncy5wbHVnaW5zLCByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgcmVxdWlyZShwbHVnaW5zLm1hcChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9KSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcGx1Z2lucy5mb3JFYWNoKGZ1bmN0aW9uIChwbHVnaW4sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5TZXR0aW5ncyA9IHNldHRpbmdzW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpblJlcXVpcmVDb25maWcgPSByZXF1aXJlQ29uZmlnW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpbkNsYXNzID0gYXJnc1tpXVthcmdzW2ldLmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICBpZighY29uZmlnW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnW25hbWVdID0gXy5tZXJnZShwbHVnaW5DbGFzcy5jb25maWcsIHBsdWdpblJlcXVpcmVDb25maWcgfHwgewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHBsdWdpblNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHBsdWdpblJlcXVpcmVDb25maWcuY29udmVudGlvbnMgfHwgY29uZmlnW25hbWVdLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdID0gXy5tZXJnZSh7CiAgICAgICAgICAgICAgICB9LCBjb25maWdbbmFtZV0sIHBsdWdpblNldHRpbmdzIHx8IHsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0dGluZ3NbbmFtZV0uY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc2V0dGluZ3MpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlT25lID0gc3RhZ2VPbmU7CiAgICAvKioKICAgIENyZWF0ZXMgYSB0aHJ1c3QgaW5zdGFuY2UsIGZyb20gdGhlIGdpdmVuIHNldHRpbmdzLgogICAgSW5jbHVkaW5nIHRoZSBwbHVnaW5zLgogICAgCiAgICBAbWV0aG9kIHN0YWdlVHdvCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVHdvKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgIC8vIEdldCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gc2V0dGluZ3MsIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIC8vIE1lZGlhdG9yIGlzIGEgcmVxdWlyZWQgcGx1Z2luLCBpbmNsdWRlIGFsbCB0aGUgb3RoZXJzIGluIGFkZGl0aW9uIHRvIGl0LgogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBsb2NhbENvbmZpZy5wbHVnaW5zLCBtb2R1bGVzVG9Mb2FkID0gLy8gVGhlIG1vZHVsZXMgdG8gbG9hZAogICAgICAgIFtdLCB0aHJ1c3RDb252ZW50aW9ucyA9IHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdLCBtb2R1bGVzQ29uZmlndXJhdGlvbnMgPSAvLyBUaGUgbW9kdWxlIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgewogICAgICAgICAgICB0aHJ1c3Q6ICd0aHJ1c3QnCiAgICAgICAgfTsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zLCBjcmVhdGluZyBhIHByb3BlciBkZXBlbmRhbmN5IGxpc3QuCiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5zW2ldLCBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSBsb2NhbENvbmZpZ1tuYW1lXTsKICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbik7CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW5Db25maWcgJiYgcGx1Z2luQ29uZmlnLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgbW9kdWxlc0NvbmZpZ3VyYXRpb25zW3BsdWdpbl0gPSBwbHVnaW5Db25maWc7CiAgICAgICAgfQogICAgICAgIC8vIE5hbWUgYW5kIGNmZyBhcmUgZGVmYXVsdCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIGNvbnRleHQKICAgICAgICAgICAgICAgIHZhciBvcmRlcmVkUGx1Z2lucyA9IFsKICAgICAgICAgICAgJ25hbWUnLCAKICAgICAgICAgICAgJ2NmZycKICAgICAgICBdLCByZWxvb3AgPSAvLyBXZSBsb29wIHRocm91Z2ggdW50aWwgYWxsIHRoZSBwbHVnaW5zIGFyZSBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgdHJ1ZSwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoLCBpID0gMDsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zIHVudGlsIHdlIGhhdmUgYSBzZXQgdGhhdCB3aWxsIGxvYWQgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHdoaWxlKGkgPCBpTGVuKSB7CiAgICAgICAgICAgIC8vIFRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG5hbWUgPSAvLyBUaGUgaW1wbGllZCBwbHVnaW4gbmFtZQogICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHBsdWdpbkNvbmZpZyA9IC8vIFRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBwbHVnaW4gaGFzIHRvIHJlc29sdmUgYW55IG90aGVyIHBsdWdpbnMKICAgICAgICAgICAgaWYocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlLmxlbmd0aCA+IDAgJiYgIWFsbChwbHVnaW5Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbnkob3JkZXJlZFBsdWdpbnMsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHggPT09IHogfHwgeCA9PT0gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSkgewogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZC4KICAgICAgICAgICAgICAgIC8vIEFsc28gaW5jbHVkZXMgYW55IGNvbnZlbnRpb25zLgogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIG1vZHVsZXNUb0xvYWQuc3BsaWNlKGksIDIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgb3JkZXJlZFBsdWdpbnMucHVzaChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBUaGUgbW9kdWxlcyBjb25maWcKICAgICAgICB2YXIgbW9kdWxlcyA9IGxvY2FsQ29uZmlnLm1vZHVsZXMgfHwgW107CiAgICAgICAgLy8gVGhydXN0IGFuZCB0aHJ1c3QvY2Fwc3VsZSBhbHNvIG5lZWQgdG8gYmUgbG9hZGVkLgogICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBbCiAgICAgICAgICAgICd0aHJ1c3QnLCAKICAgICAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgfHwgW10KICAgICAgICBdKTsKICAgICAgICAvLyBGbGF0dGVuIHRoZSByZXN1bHRhbnQgYXJyYXkKICAgICAgICBtb2R1bGVzVG9Mb2FkID0gZmxhdHRlbihtb2R1bGVzVG9Mb2FkKTsKICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZ3VyYXRpb24gc3BlYwogICAgICAgIHZhciBzcGVjID0gewogICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnCiAgICAgICAgfTsKICAgICAgICAvLyBMb2FkIGV2ZXJ5dGhpbmcKICAgICAgICByZXF1aXJlKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gR2V0IHJlYWR5IHRvIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRQbHVnaW4gPSBudWxsLCBhbGxDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBtb2R1bGVzIGJlaW5nIGxvYWRlZAogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlc1RvTG9hZC5sZW5ndGg7IGkgPCBpTGVuIC0gdGhydXN0Q29udmVudGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIEdldCBwbHVnaW4gYW5kIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gbW9kdWxlc1RvTG9hZFtpXSwgbUNvbmZpZyA9IG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICBpZihtQ29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhIG5ldyBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luT2JqZWN0ID0gYXJnc1tpXSwgbmFtZSA9IC8vIEdldCB0aGUgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHJlc29sdmVJdGVtcyA9IC8vIFJlc29sdmUgYWxsIHRoZSByZXF1aXJlZCBpdGVtcy4KICAgICAgICAgICAgICAgICAgICBtYXAobUNvbmZpZy5yZXNvbHZlLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3BlY1t4XTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luQ2xhc3MgPSBwbHVnaW5PYmplY3RbcGx1Z2luT2JqZWN0LmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4gPSBzcGVjW25hbWVdID0gdXRpbC5pbnN0YW50aWF0ZShwbHVnaW5DbGFzcywgcmVzb2x2ZUl0ZW1zKTsKICAgICAgICAgICAgICAgICAgICAvLyBTZXR1cCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBMb2FkIGFsbCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9ucyBpbnRvIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGFyZ3NbaV0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGxDb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRoZSBsYXN0IGN1cnJlbnQgcGx1Z2luLCB3aWxsIGFsd2F5cyBiZSB0aHJ1c3QuCiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IGFsbENvbnZlbnRpb25zOwogICAgICAgICAgICB2YXIgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zID0gYXJncy5zbGljZShtb2R1bGVzVG9Mb2FkLmxlbmd0aCAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGZsYXR0ZW4obWFwKHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXAoeCwgZnVuY3Rpb24gKHopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX190aHJ1c3RDb252ZW50aW9ucyA9IHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9uczsKICAgICAgICAgICAgYWxsQ29udmVudGlvbnMucHVzaC5hcHBseShhbGxDb252ZW50aW9ucywgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zKTsKICAgICAgICAgICAgLy8gRXh0ZW5kIHRocnVzdCB3aXRoIHRoZSBzcGVjCiAgICAgICAgICAgIGV4dGVuZChjdXJyZW50UGx1Z2luLCBzcGVjKTsKICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShzcGVjKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVR3byA9IHN0YWdlVHdvOwogICAgLyoqCiAgICBMb2FkcyB1cCB0aGUgZGVmYXVsdCBtb2R1bGVzIGFzIGluZGljYXRlZCB0byB0aHJ1c3QuCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VUaHJlZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gdXNlIHRvIGxvYWQgdGhlIG1vZHVsZXMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVGhyZWUoY29udGV4dCkgewogICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZGVmZXIgPSB3aGVuLmRlZmVyKCksIG1vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzOwogICAgICAgIG1vZHVsZXMgPSBfLmZpbHRlcihtb2R1bGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4gIXRocnVzdC5tb2R1bGVzW3hdOwogICAgICAgIH0pOwogICAgICAgIHJlcXVpcmUobW9kdWxlcywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgTW9kdWxlID0gdG0uTW9kdWxlOwogICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb25zCiAgICAgICAgICAgIHZhciBtb2R1bGVEZWZpbml0aW9ucyA9IGFyZ3M7CiAgICAgICAgICAgIC8vIExvb3Agb3ZlciBhbGwgdGhlIG1vZHVsZXMKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIG1vZHVsZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZCA9IG1vZHVsZXNbaV0sIGRlZmluaXRpb24gPSAvLyBHZXQgdGhlIGRlZmluaXRpb24KICAgICAgICAgICAgICAgIG1vZHVsZURlZmluaXRpb25zW2ldOwogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbmV3IE1vZHVsZSh0aHJ1c3QsIGRlZmluaXRpb24sIG1vZCk7CiAgICAgICAgICAgICAgICAvLyBJbmplY3QgaXQgaW50byB0aGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50aHJ1c3RDcmVhdGUodGhydXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlVGhyZWUgPSBzdGFnZVRocmVlOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1pZ25pdGUuanMubWFwCjsKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyBkb21SZWFkeSAyLjAuMSBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL3JlcXVpcmVqcy9kb21SZWFkeSBmb3IgZGV0YWlscwogKi8KLypqc2xpbnQgKi8KLypnbG9iYWwgcmVxdWlyZTogZmFsc2UsIGRlZmluZTogZmFsc2UsIHJlcXVpcmVqczogZmFsc2UsCiAgd2luZG93OiBmYWxzZSwgY2xlYXJJbnRlcnZhbDogZmFsc2UsIGRvY3VtZW50OiBmYWxzZSwKICBzZWxmOiBmYWxzZSwgc2V0SW50ZXJ2YWw6IGZhbHNlICovCgoKZGVmaW5lKCdkb21SZWFkeScsW10sZnVuY3Rpb24gKCkgewogICAgCgogICAgdmFyIGlzVG9wLCB0ZXN0RGl2LCBzY3JvbGxJbnRlcnZhbElkLAogICAgICAgIGlzQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCwKICAgICAgICBpc1BhZ2VMb2FkZWQgPSAhaXNCcm93c2VyLAogICAgICAgIGRvYyA9IGlzQnJvd3NlciA/IGRvY3VtZW50IDogbnVsbCwKICAgICAgICByZWFkeUNhbGxzID0gW107CgogICAgZnVuY3Rpb24gcnVuQ2FsbGJhY2tzKGNhbGxiYWNrcykgewogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgY2FsbGJhY2tzW2ldKGRvYyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGxSZWFkeSgpIHsKICAgICAgICB2YXIgY2FsbGJhY2tzID0gcmVhZHlDYWxsczsKCiAgICAgICAgaWYgKGlzUGFnZUxvYWRlZCkgewogICAgICAgICAgICAvL0NhbGwgdGhlIERPTSByZWFkeSBjYWxsYmFja3MKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlYWR5Q2FsbHMgPSBbXTsKICAgICAgICAgICAgICAgIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGFnZSBhcyBsb2FkZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhZ2VMb2FkZWQoKSB7CiAgICAgICAgaWYgKCFpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgaXNQYWdlTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHNjcm9sbEludGVydmFsSWQpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc2Nyb2xsSW50ZXJ2YWxJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhbGxSZWFkeSgpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNCcm93c2VyKSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgLy9TdGFuZGFyZHMuIEhvb3JheSEgQXNzdW1wdGlvbiBoZXJlIHRoYXQgaWYgc3RhbmRhcmRzIGJhc2VkLAogICAgICAgICAgICAvL2l0IGtub3dzIGFib3V0IERPTUNvbnRlbnRMb2FkZWQuCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBwYWdlTG9hZGVkLCBmYWxzZSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAod2luZG93LmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgcGFnZUxvYWRlZCk7CgogICAgICAgICAgICB0ZXN0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpc1RvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT09IG51bGw7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgICAgICAvL0RPTUNvbnRlbnRMb2FkZWQgYXBwcm94aW1hdGlvbiB0aGF0IHVzZXMgYSBkb1Njcm9sbCwgYXMgZm91bmQgYnkKICAgICAgICAgICAgLy9EaWVnbyBQZXJpbmk6IGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvLAogICAgICAgICAgICAvL2J1dCBtb2RpZmllZCBieSBvdGhlciBjb250cmlidXRvcnMsIGluY2x1ZGluZyBqZGFsdG9uCiAgICAgICAgICAgIGlmICh0ZXN0RGl2LmRvU2Nyb2xsICYmIGlzVG9wICYmIHdpbmRvdy5leHRlcm5hbCkgewogICAgICAgICAgICAgICAgc2Nyb2xsSW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXN0RGl2LmRvU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICAgICAgfSwgMzApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0NoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgY29tcGxldGUsIGFuZCBpZiBzbywganVzdCB0cmlnZ2VyIHBhZ2UgbG9hZAogICAgICAgIC8vbGlzdGVuZXJzLiBMYXRlc3Qgd2Via2l0IGJyb3dzZXJzIGFsc28gdXNlICJpbnRlcmFjdGl2ZSIsIGFuZAogICAgICAgIC8vd2lsbCBmaXJlIHRoZSBvbkRPTUNvbnRlbnRMb2FkZWQgYmVmb3JlICJpbnRlcmFjdGl2ZSIgYnV0IG5vdCBhZnRlcgogICAgICAgIC8vZW50ZXJpbmcgImludGVyYWN0aXZlIiBvciAiY29tcGxldGUiLiBNb3JlIGRldGFpbHM6CiAgICAgICAgLy9odHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL3RoZS1lbmQuaHRtbCN0aGUtZW5kCiAgICAgICAgLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM2NjU1NjEvZG9jdW1lbnQtcmVhZHlzdGF0ZS1vZi1pbnRlcmFjdGl2ZS12cy1vbmRvbWNvbnRlbnRsb2FkZWQKICAgICAgICAvL0htbSwgdGhpcyBpcyBtb3JlIGNvbXBsaWNhdGVkIG9uIGZ1cnRoZXIgdXNlLCBzZWUgImZpcmluZyB0b28gZWFybHkiCiAgICAgICAgLy9idWc6IGh0dHBzOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvZG9tUmVhZHkvaXNzdWVzLzEKICAgICAgICAvL3NvIHJlbW92aW5nIHRoZSB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiaW50ZXJhY3RpdmUiIHRlc3QuCiAgICAgICAgLy9UaGVyZSBpcyBzdGlsbCBhIHdpbmRvdy5vbmxvYWQgYmluZGluZyB0aGF0IHNob3VsZCBnZXQgZmlyZWQgaWYKICAgICAgICAvL0RPTUNvbnRlbnRMb2FkZWQgaXMgbWlzc2VkLgogICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIFNUQVJUIE9GIFBVQkxJQyBBUEkgKiovCgogICAgLyoqCiAgICAgKiBSZWdpc3RlcnMgYSBjYWxsYmFjayBmb3IgRE9NIHJlYWR5LiBJZiBET00gaXMgYWxyZWFkeSByZWFkeSwgdGhlCiAgICAgKiBjYWxsYmFjayBpcyBjYWxsZWQgaW1tZWRpYXRlbHkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICovCiAgICBmdW5jdGlvbiBkb21SZWFkeShjYWxsYmFjaykgewogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgY2FsbGJhY2soZG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWFkeUNhbGxzLnB1c2goY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZG9tUmVhZHk7CiAgICB9CgogICAgZG9tUmVhZHkudmVyc2lvbiA9ICcyLjAuMSc7CgogICAgLyoqCiAgICAgKiBMb2FkZXIgUGx1Z2luIEFQSSBtZXRob2QKICAgICAqLwogICAgZG9tUmVhZHkubG9hZCA9IGZ1bmN0aW9uIChuYW1lLCByZXEsIG9uTG9hZCwgY29uZmlnKSB7CiAgICAgICAgaWYgKGNvbmZpZy5pc0J1aWxkKSB7CiAgICAgICAgICAgIG9uTG9hZChudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb21SZWFkeShvbkxvYWQpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqIEVORCBPRiBQVUJMSUMgQVBJICoqLwoKICAgIHJldHVybiBkb21SZWFkeTsKfSk7CgpkZWZpbmUoJ3RocnVzdC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2xvZycsICcuL2luc3RhbmNlJywgJy4vaWduaXRlJywgJy4vY2Fwc3VsZScsICdkb21SZWFkeScsICdoYXMnLCAndGhydXN0L2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX190aHJ1c3RJbnN0YW5jZV9fLCBfX2lnbml0ZVNwZWNfXywgX19tX18sIF9fZG9tUmVhZHlfXywgX19oYXNfXywgX190Q29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIHZhciBpZ25pdGVTcGVjID0gX19pZ25pdGVTcGVjX187CgogICAgdmFyIG0gPSBfX21fXzsKCiAgICB2YXIgTW9kdWxlID0gbS5Nb2R1bGU7CiAgICB2YXIgZG9tUmVhZHkgPSBfX2RvbVJlYWR5X187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUaHJ1c3QnOwogICAgLyoqCiAgICBUaGUgdGhydXN0IGFwcGxpY2F0aW9uIQogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQG1haW4gdGhydXN0CiAgICAqKi8KICAgICAgICB2YXIgSU5JVCA9ICdpbml0JywgU1RBUlQgPSAnc3RhcnQnLCBSRUFEWSA9ICdyZWFkeScsIFNUT1AgPSAnc3RvcCcsIERFU1RST1kgPSAnZGVzdHJveScsIENPVU5URE9XTiA9ICdjb3VudGRvd24nLCBJR05JVEUgPSAnaWduaXRlJywgT1JCSVQgPSAnb3JiaXQnLCBERVBMT1kgPSAnZGVwbG95JywgREVPUkJJVCA9ICdkZW9yYml0JywgU1BMQVNIRE9XTiA9ICdzcGxhc2hkb3duJywgSU5PUkJJVCA9ICdpbk9yYml0JywgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpc0FycmF5ID0gXy5pc0FycmF5LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgdG9BcnJheSA9IF8udG9BcnJheSwgbWVyZ2UgPSBfLm1lcmdlLCBmbGF0dGVuID0gXy5mbGF0dGVuLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgcmVzb2x2ZU1ldGhvZHMgPSBbCiAgICAgICAgSU5JVCwgCiAgICAgICAgU1RBUlQsIAogICAgICAgIFJFQURZLCAKICAgICAgICBTVE9QLCAKICAgICAgICBERVNUUk9ZCiAgICBdLCBpbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5pbnN0YW5jZXMsIGxvYWRpbmdJbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5sb2FkaW5nSW5zdGFuY2VzLCBzYWZlSW52b2tlID0gdXRpbC5zYWZlSW52b2tlOwogICAgLy8jcmVnaW9uIFJ1bm5lciBGYWN0b3JpZXMKICAgIHZhciBydW5SdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgdmFyIGNvbnZlbnRpb25NZXRob2QgPSAobWV0aG9kID09PSBTVE9QICYmIFNUQVJUKSB8fCAobWV0aG9kID09PSBERVNUUk9ZICYmIElOSVQpIHx8IG1ldGhvZCwgY29udmVudGlvblZhbHVlID0gIShtZXRob2QgPT09IFNUT1AgfHwgbWV0aG9kID09PSBERVNUUk9ZKSwgdW5zZXRSZWFkeSA9IG1ldGhvZCA9PT0gU1RPUCwgY29udmVudGlvbkNoZWNrID0gY29udmVudGlvbk1ldGhvZCAhPT0gbWV0aG9kLCBjb252ZW50aW9uTmFtZSA9IGZvcm1hdCgnezB9LXN0YXR1cycsIGNvbnZlbnRpb25NZXRob2QpLCBydW5uZXIgPSBydW5uZXJGYWN0b3J5KG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSksIGxvZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iIGZhaWxlZCEnLCBtZXRob2QpLCBydW5uaW5nTWVzc2FnZSA9IGZvcm1hdCgnVGhydXN0OiBSdW5uaW5nIHswfSBmb3IgbW9kdWxlICJ7ezB9fSIuJywgbWV0aG9kKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZXMpKSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncywgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBlYWNoKG5hbWVzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KHJ1bm5pbmdNZXNzYWdlLCBuYW1lKSk7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICAgICAgaWYoIW1vZCAmJiAhdGhhdC5mYWlsZWRNb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIGZldGNoIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuaW5nIHRoZSBwcm9wZXIgZGVmZXIgaW4gaXQncyBwbGFjZQogICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXJEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZQogICAgICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3JlYXRlTW9kdWxlKG1vZHVsZURlZm4gJiYgbW9kdWxlRGVmbi5uYW1lIHx8IG5hbWUsIG1vZHVsZURlZm4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZURlZm4ubmFtZQogICAgICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4od2hlbi5hbGwoZmxhdHRlbihyZXN1bHQpKSwgbG9hZGVyRGVmZXIpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5mYWlsZWRNb2R1bGVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyRGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChsb2FkZXJEZWZlci5wcm9taXNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZigoY29udmVudGlvbkNoZWNrICYmIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkgfHwgIW1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGlmKHRydWUgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZXJyb3IoZm9ybWF0KGxvZ01lc3NhZ2UsIG5hbWUpLCBlLCBlLnN0YWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aCAmJiByZXN1bHRzOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBydW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KSB7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGZvcm1hdCgndGhydXN0L21vZHVsZS97MH0nLCBtZXRob2QpLCBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IicsIG1ldGhvZC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG1ldGhvZC5zdWJzdHJpbmcoMSkpLCBkZWJ1Z0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiBDYWxsaW5nIG1vZHVsZSAie3swfX0iIHswfSgpJywgbWV0aG9kKSwgY29tcEFmdGVyID0gbWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSB8fCBmYWxzZTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQsIG5hbWUsIG1vZCwgYXJncykgewogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBuYW1lKSk7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG1hcChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHguY29udmVudGlvbignYXV0b1N0YXJ0JykgJiYgaTsKICAgICAgICAgICAgfSkuam9pbignLCAnKSkpOwogICAgICAgICAgICBlYWNoKG1vZHVsZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICBpZighY2hlY2tBdXRvU3RhcnQgfHwgKGNoZWNrQXV0b1N0YXJ0ICYmIHguY29udmVudGlvbignYXV0b1N0YXJ0JykpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRoYXRbbWV0aG9kXShpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0aW5nTW9kdWxlcyAmJiBjaGVja0F1dG9TdGFydCkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoaW5mb0Zvcm1hdCwgdGhhdC5zdGFydGluZ01vZHVsZXMuam9pbignLCAnKSkpOwogICAgICAgICAgICAgICAgdGhhdFttZXRob2RdKHRoYXQuc3RhcnRpbmdNb2R1bGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwocmVzdWx0cyk7CiAgICAgICAgfTsKICAgIH0pOwogICAgZnVuY3Rpb24gZmlyZVRocnVzdEV2ZW50KHRoYXQsIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUoZXZlbnQpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgbWV0aG9kLCBzdG9wcGluZykgewogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGVhY2godGhhdC5jaGlsZHJlbiwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgIGlmKHN0b3BwaW5nKSB7CiAgICAgICAgICAgICAgICBjaGlsZC5fX3ByZXZpb3VzU3RhdGUgPSBjaGlsZC5zdGFydGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNoaWxkLmNmZy5hdXRvU3RhcnQgfHwgKCFzdG9wcGluZyAmJiBjaGlsZC5fX3ByZXZpb3VzU3RhdGUpIHx8IChzdG9wcGluZyAmJiBjaGlsZC5zdGFydGVkKSkgewogICAgICAgICAgICAgICAgaXRlbXMucHVzaChjaGlsZFttZXRob2RdKGZhbHNlLCB0cnVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZihpdGVtcy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGl0ZW1zKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIGFycikgewogICAgICAgIHJldHVybiB1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzKGFyci5jb25jYXQodGhhdC5jZmcuYXN5bmMgJiYgWwogICAgICAgICAgICB3aGVuLmRlbGF5KDApCiAgICAgICAgXSB8fCBbXSkpOwogICAgfQogICAgdmFyIHRocnVzdExvZ0V2ZW50OwogICAgaWYodHJ1ZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0OiBDcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgInswfSInLCBuYW1lKSk7CiAgICAgICAgICAgIHZhciBvbGRNb2R1bGUsIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihwcmVCdWlsdCkgewogICAgICAgICAgICAgICAgb2xkTW9kdWxlID0gbW9kOwogICAgICAgICAgICAgICAgbW9kID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFwcmVCdWlsdCkgewogICAgICAgICAgICAgICAgbW9kID0gbmV3IG0uTW9kdWxlKHRoYXQsIG1vZCwgbmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtb2QgPSBvbGRNb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW9kdWxlcyBjYW5ub3QgaGF2ZSBkdXBsaWNhdGUgbmFtZXMsIGNob29zZSBhIG5ldyBvbmUuCiAgICAgICAgICAgIGlmKHRoYXQubW9kdWxlc1ttb2QubmFtZV0pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ0R1cGxpY2F0ZSBtb2R1bGUgbmFtZSAiezB9Ii4nLCBuYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbSBpcyB0aGUgbWVkaWF0b3JzIGludGVybmFsIG1vZHVsZS4KICAgICAgICAgICAgdGhhdC5tb2R1bGVzW21vZC5uYW1lXSA9IG1vZDsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRlZCBtb2R1bGUgInswfSInLCBuYW1lKSk7CiAgICAgICAgICAgIC8vIE5vdGlmeSB0aGUgbWVkaWF0b3IgdGhhdCBhIG1vZHVsZSBoYXMgYmVlbiBjcmVhdGVkLgogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9tb2R1bGUvY3JlYXRlJywgbmFtZSk7CiAgICAgICAgICAgIGlmKHRoYXQgJiYgdGhhdC5zdGFydGVkICYmIG1vZC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydChtb2QubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZDsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnR1cCA9IC8vI3JlZ2lvbiBHbG9iYWwgUnVubmVycwogICAgICAgIGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBldmVudCwgdGhhdCksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIGV2ZW50KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fY291bnRkb3duID0gZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gaW5pdGFsaXplZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmNvdW50ZG93biA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgY291bnRkb3duIHRvIHRocnVzdHMgc3RhcnQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGNvdW50ZG93biBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhhdC5jZmcuYXV0b21hdGljTGlmZWN5Y2xlICYmICghdGhhdC5jZmcuY2hpbGRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoU2VxdWVuY2UodGhhdCwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0Ll9jb3VudGRvd24oY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pZ25pdGUgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGluZ2l0aW9uIGFzIHRocnVzdCBzdGFydHMgdXAuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdGaXJpbmcgcm9ja2V0cyBmb3IgdGh1cnN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKElHTklURSwgU1RBUlQpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnRmlyaW5nIHN0YWdlIHR3byB0aHJ1c3RlcnMgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpKCk7CiAgICAgICAgICAgIHZhciBkb21SZWFkeURlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBkb21SZWFkeURlZmVyLnByb21pc2UudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9kb20vcmVhZHknKSk7CiAgICAgICAgICAgIGRvbVJlYWR5KGRvbVJlYWR5RGVmZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICBkb21SZWFkeURlZmVyLnByb21pc2UsIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIE9SQklULCB0aGF0KSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgT1JCSVQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBhbG1vc3QgcmVhZHkuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5kZXBsb3kgPSAvKioKICAgICAgICBUaHJ1c3QgZGVwbG95cyBjb21wb25lbnRzIGluIG9yYml0CiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVwbG95CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhydXN0IGhhcyBmdWxseSBkZXBsb3llZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgcmVhZHkuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pbk9yYml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuc3RhcnRlZCA9IHRydWU7CiAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBJTk9SQklUKTsKICAgICAgICAgICAgaWYodHJ1ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVTdGFydCA9IHRoYXQuY29uZmlnLmRlYnVnLnRpbWVTdGFydCwgdGltZUVuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBzdGFydFRpbWUgPSAodGltZUVuZCAtIHRpbWVTdGFydCk7CiAgICAgICAgICAgICAgICBsb2cuaW5mbygnU3RhcnRlZCBpbiAnICsgc3RhcnRUaW1lICsgJ21zJyk7CiAgICAgICAgICAgICAgICB2YXIgdHRyRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0cicpOwogICAgICAgICAgICAgICAgaWYodHRyRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRyRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc2h1dGRvd24gPSBmdW5jdGlvbiAoZXZlbnQsIGV2ZW50VHlwZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQsIHRydWUpLCAKICAgICAgICAgICAgICAgIHRoYXRbZXZlbnRUeXBlXSgpLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBldmVudCwgdGhhdCkKICAgICAgICAgICAgXSkpOwogICAgICAgICAgICB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvJyArIGV2ZW50VHlwZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuX2Rlb3JiaXQgPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyBzdG9wcGVkLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuZGVvcmJpdCA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgZGVvcmJpdCBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgU2h1dGRvd24gY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShbCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuX2Rlb3JiaXQsIHRoYXQpLCAKICAgICAgICAgICAgICAgICAgICBfLmJpbmQodGhhdC5zcGxhc2hkb3duLCB0aGF0KQogICAgICAgICAgICAgICAgXSwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0Ll9kZW9yYml0KGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3BsYXNoZG93biA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgc3BsYXNoZG93biBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgU2h1dGRvd24gY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ0xhbmRpbmcgaW4gdGhlIG1pZGRsZSBvZiB0aGUgYXRsYW50aWMgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXMuc2h1dGRvd24oU1BMQVNIRE9XTiwgREVTVFJPWSk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHJ1ZSkgewogICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVidWcgPSB7CiAgICAgICAgICAgICAgICAgICAgdGltZVN0YXJ0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXR0aW5ncyA9IGlnbml0ZVNwZWMubWVyZ2VTZXR0aW5ncyhzZXR0aW5ncyk7CiAgICAgICAgICAgIHZhciBwaXBlID0gWwogICAgICAgICAgICAgICAgaWduaXRlU3BlYy5mdXNlCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHZhciBzZXR1cERlZmVyID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShzZXR0aW5ncy5uYW1lKTsKICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIG1vZHVsZXMgPSB0aHJ1c3Quc3RhcnRpbmdNb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlcywgY29uZmlnID0gdGhydXN0LmNvbmZpZyA9IHRocnVzdC5jZmc7CiAgICAgICAgICAgICAgICBpbnN0YW5jZXNbdGhydXN0Lm5hbWVdID0gdGhydXN0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihzZXR0aW5ncy5hdXRvbWF0aWNMaWZlY3ljbGUpIHsKICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBUaHJ1c3QubGF1bmNoU2VxdWVuY2UodGhydXN0LCBjYWxsZWRCeVBhcmVudCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnJlc29sdmUoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwaXBlbGluZSA9IHdoZW4ucGlwZWxpbmUocGlwZSwgc2V0dGluZ3MpLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXR1cERlZmVyLnJlc29sdmUoY29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBXZSdyZSBvbmx5IGdvaW5nIHRvIGV4cG9zZSBnbG9iYWxzIGlmIHJlcXVlc3RlZC4gIFRoaXMgaXMgYSBwb3RlbnRpYWwgdXNlY2FzZSB0aGF0IG1heSBiZSBuZWVkZWQgZm9yIHNvbWUgdGVhbXMuCiAgICAgICAgICAgIGlmKHRDb25maWcuZXhwb3NlR2xvYmFscykgewogICAgICAgICAgICAgICAgaWYoIXdpbmRvd1snVGhydXN0J10pIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbJ1RocnVzdCddID0gVGhydXN0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGlwZWxpbmUudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvd1tzZXR0aW5ncy5uYW1lXSA9IGNvbnRleHQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGlwZWxpbmU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuZ2V0SW5zdGFuY2UgPSAvKioKICAgICAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5nZXRJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2ZldGNoSW5zdGFuY2UgPSAvKioKICAgICAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgICAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgICAgIAogICAgICAgIEBtZXRob2QgX19mZXRjaEluc3RhbmNlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIF9fZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmNyZWF0ZU1vZHVsZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgbW9kdWxlIGFuZCBoYW5kcyBpdCBvZmYgdG8gdGhlIGdpdmVuIGluc3RhbmNlLCBpZiB0aGF0IGluc3RhbmNlIGV4aXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZU1vZHVsZShpbnN0YW5jZU5hbWUsIG5hbWUsIG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gVGhydXN0LmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgIGlmKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gbmV3IE1vZHVsZShpbnN0YW5jZSwgbW9kdWxlRGVmbiwgbmFtZSk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5fX2luamVjdE1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlID0gLyoqCiAgICAgICAgUmVnaXN0ZXJzIGEgc3BlY2lmaWMgbW9kdWxlIG5hbWUsIGFuZCBhcmd1bWVudHMuICBUaGUgYXJndW1lbnRzIHdpbGwgYmUgdXNlZCB3aGVuIGluaXRhbnRpYXRpbmcgdGhlIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlZ2lzdGVyTW9kdWxlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSB0aGUgbW9kdWxlIGlzIHRvIGJlIGFzc29jaWF0ZWQgd2l0aC4KICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUgdG8gYXNzaWduIHRoZSBhcmd1bWVudHMgd2l0aC4KICAgICAgICBAcGFyYW0ge09iamVjdCp9IGFyZ3VtZW50cywgYWRkaXRpb25hbCBhcmd1bWVudHMgdGhhdCB3aWxsIGJlIHBhc3NlZCBvbnRvIHRoZSBtb3VkbGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck1vZHVsZShpbnN0YW5jZU5hbWUsIG5hbWUpIHsKICAgICAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnN0YW5jZU5hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdKSB7CiAgICAgICAgICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDIpOwogICAgICAgICAgICBpZihUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV1bbmFtZV0pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBhbHJlYWR5IHJlZ2lzdGVyZWQgdG8gaW5zdGFuY2UgInsxfSInLCBuYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV1bbmFtZV0gPSBhcmdzIHx8IFtdOwogICAgICAgIH07CiAgICAgICAgVGhydXN0Ll9fZ2V0TW9kdWxlQXJncyA9IF9fZ2V0TW9kdWxlQXJnczsKICAgICAgICByZXR1cm4gVGhydXN0OwogICAgfSkoKTsKICAgIGV4cG9ydHMuVGhydXN0ID0gVGhydXN0OyAgICAKICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgY3VycmVudCB0aHVyc3QgaW5zdGFuY2UsIGJ5IGV4cGVjdGVkIG5hbWUuCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgcGx1Z2luLgogICAgdGhydXN0IWdsb2JhbCA9IFRocnVzdCBpbnN0YW5jZQogICAgdGhydXN0IWdsb2JhbDpkb20gPSBUaGUgdGhydXN0IGRvbSBwbHVnaW4gaW5zdGFuY2UKICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCAndGhydXN0JzsKICAgICAgICB2YXIgaW5zdGFuY2VQcm9taXNlID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VQcm9taXNlLnByb21pc2UudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gY29udGV4dFtwbHVnaW5OYW1lXTsKICAgICAgICAgICAgaWYoIXBsdWdpbikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUGx1Z2luICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBwbHVnaW5OYW1lLCByZWFsTmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QnLCBbJ3RocnVzdC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBBIENvbnZlbnRpb24gYWxsb3dzIHRocnVzdCB0byBiZSBhcyBleHRlbmRhYmxlIGFzIHBvc3NpYmxlLCBieSBnaXZpbmcgZXh0ZW5zaW9uIHBvaW50cyBhdCBldmVyeSBzdGVwIGFsb25nIHRoZSB3YXkuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gWwogICAgICAgICdjcmVhdGUnLCAKICAgICAgICAnaW5pdCcsIAogICAgICAgICdzdGFydCcsIAogICAgICAgICdyZWFkeScsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ2Rlc3Ryb3knLCAKICAgICAgICAnY291bnRkb3duJywgCiAgICAgICAgJ2lnbml0ZScsIAogICAgICAgICdvcmJpdCcsIAogICAgICAgICdkZW9yYml0JywgCiAgICAgICAgJ3NwbGFzaGRvd24nCiAgICBdOwogICAgLyoqCiAgICBUaGUgY29udmVudGlvbiBjbGFzcywgdGFrZXMgYW4gb3ZlcmxvYWRlZCBzZXQgb2YgbWV0aG9kcywgZm9yIGFueSBtZXRob2QgdGhhdCBuZWVkcyB0byBiZSBvdmVybG9hZGVkLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkNvbnZlbnRpb24KICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgQW4gb2JqZWN0IG9mIGFwcGxpY2FibGUgbWV0aG9kcy4KICAgICoqLwogICAgdmFyIENvbnZlbnRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENvbnZlbnRpb24obWV0aG9kT3ZlcnJpZGVzKSB7CiAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMsIG1ldGhvZE92ZXJyaWRlcyk7CiAgICAgICAgICAgIHZhciBrZXlzID0gXy5kaWZmZXJlbmNlKG1ldGhvZHMsIF8uaW50ZXJzZWN0aW9uKG1ldGhvZHMsIF8ua2V5cyhtZXRob2RPdmVycmlkZXMpKSk7CiAgICAgICAgICAgIF8uZWFjaChrZXlzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgaWYoXy5pc0Z1bmN0aW9uKHRoaXNbeF0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm9vcCBpcyB1c2VkIGluIHNhZmVpbnZva2UsIGFzIGEgc2FmZSBpZ25vcmUgZnVuY3Rpb24sIG5vIG90aGVyIG5vb3Agd2lsbCB3b3JrIGNvcnJlY3RseS4KICAgICAgICAgICAgICAgICAgICB0aGlzW3hdID0gdXRpbC5ub29wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIGNyZWF0ZSBvZiBhIG1vZHVsZSwgZ2VuZXJhbGx5IHVzZWQgdG8gY3JlYXRlIGEgZmFjYWRlLCB0aGF0IGlzIHRoZW4gYm91bmQgdG8gdGhlIG1vZHVsZS4KICAgICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgQWxsIHRoZSBmYWNhZGVzIGFscmVhZHkgYXR0YWNoZWQgdG8gdGhlIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmluaXQgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgaW5pdCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBpbml0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBpbml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RhcnQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3Mgc3RhcnQgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUucmVhZHkgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgcmVhZHkgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgcmVhZHkgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlYWR5CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdG9wIHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0b3AgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZXN0cm95ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGRlc3Ryb3kgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgZGVzdHJveSBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVzdHJveQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNvdW50ZG93biA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pZ25pdGUgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLm9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSByZWFkeSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIG9yYml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHN0b3AgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGRlc3Ryb3kgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIHJldHVybiBDb252ZW50aW9uOwogICAgfSkoKTsKICAgIGV4cG9ydHMuQ29udmVudGlvbiA9IENvbnZlbnRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb252ZW50aW9uLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2V2ZW50cycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9sb2cnLCAnLi9jb25maWcnLCAnaGFzJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fbG9nX18sIF9fdENvbmZpZ19fLCBfX2hhc19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvLyAgICAgQmFja2JvbmUuanMgMC45LjEKICAgIC8vICAgICAoYykgMjAxMC0yMDEyIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCiAgICAvLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAgICAvLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgogICAgLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgogICAgCiAgICAqIEV2ZW50cyBjYW4gYmUgZmlyZWQgYXN5bmNyb25vdXNseS4KICAgICogRXZlbnRzIGNhbiBiZSBuYW1lc3BhY2VkLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgRXZlbnROb2RlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBFdmVudE5vZGUoKSB7CiAgICAgICAgICAgIHRoaXMudGFpbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubmV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9ICcnOwogICAgICAgICAgICB0aGlzLm9uY2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV2ZW50Tm9kZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkV2ZW50Tm9kZSA9IEV2ZW50Tm9kZTsgICAgCiAgICB2YXIgY3JlYXRlQXN5bmNFdmVudCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uIGYoZXZlbnRzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90cmlnZ2VyLmFwcGx5KG9iamVjdCwgWwogICAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfTsKICAgICAgICBmLmFzeW5jID0gZnVuY3Rpb24gKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZjsKICAgIH07CiAgICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFzeW5jRmlyZSwgbm9vcCA9IHV0aWwubm9vcCwgd2hlbiA9IHV0aWwud2hlbiwgc2l6ZSA9IF8uc2l6ZSwgZWFjaCA9IF8uZWFjaCwgZGVmZXIgPSBfLmRlZmVyLCBiaW5kID0gXy5iaW5kLCBleHRlbmQgPSBfLmV4dGVuZCwgZm9ybWF0ID0gdXRpbC5mb3JtYXQ7CiAgICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvLCBBTEwgPSAnYWxsJywgU1RBUkFMTCA9ICcqYWxsJzsKICAgIC8qKgogICAgTm9ybWFsaXplcyB0aGUgZ2l2ZW4gZXZlbnRzIHRvIHRoZSBleHBlY3RlZCBuYW1lc3BhY2UuCiAgICAKICAgIEBtZXRob2Qgbm9ybWFsaXplRXZlbnRzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBUaGUgZXZlbnRzIGRlbGltaXRlZCBieSBhIHNwYWNlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlIFRoZSBuYW1lc3BhY2UsIGluY2x1ZGluZyBwcmVmaXhlZCAnLicKICAgICoqLwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHNBcnJheS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYoZXZlbnRzQXJyYXlbaV0uaW5kZXhPZignLicpID09PSAtMSkgewogICAgICAgICAgICAgICAgZXZlbnRzQXJyYXlbaV0gPSBldmVudHNBcnJheVtpXSArIG5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnRzQXJyYXkuam9pbignICcpOwogICAgfQogICAgLyoqCiAgICBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICAKICAgIEBtZXRob2QgX3RyaWdnZXIKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgIEByZXR1cm5zIElmIGFzeW5jIHRoZW4gcmV0dXJucyBhIFByb21pc2UsIHdoZXJlIHRoZSBmaXJzdCBhcmd1bWVudCBjb250YWlucyBhbGwgdGhlIHJldHVybmVkIHZhbHVlcywgYXMgYW4gYXJyYXkKICAgIElmIHN5bmMgdGhlbiByZXR1cm5zIGFuIGFycmF5IG9mIHRoZSByZXR1cm4gdmFsdWVzLgogICAgSWYgbW9yZSB0aGFuIG9uZSBldmVudCwgcmV0dXJucyBhbiBvYmplY3Qgb2YgYXJyYXlzIG9yIHByb21pc2VzLCB3aXRoIHRoZSBrZXkgZm9yIGVhY2ggZXZlbnQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF90cmlnZ2VyKGFzeW5jLCBldmVudHMpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBldmVudCwgbm9kZSwgY2FsbHMsIHRhaWwsIGFyZ3MsIGFsbCwgcmVzdCwgbmFtZXNwYWNlLCBvbmNlTm9kZXM7CiAgICAgICAgaWYoIShjYWxscyA9IHRoaXMuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgfQogICAgICAgIGFsbCA9IGNhbGxzLmFsbDsKICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgaWYobm9kZSA9IGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgdHJpZ2dlck5vZGVzKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZSwgcmVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobm9kZSA9IGFsbCkgewogICAgICAgICAgICAgICAgdHJpZ2dlck5vZGVzKHRoYXQsIEFMTCwgYXN5bmMsIG5vZGUsIFsKICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgXS5jb25jYXQocmVzdCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBUcmlnZ2VycyBhbGwgZXZlbnRzIG9uIGEgbm9kZS4KICAgIEFsc28gdW5iaW5kcyBhbnkgbm9kZSB0aGF0IGlzIHNldCB0byBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgCiAgICBAbWV0aG9kIHRyaWdnZXJOb2RlcwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBldmVudCBjb250YWluZXIgY29udGV4dC4KICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQgdG8gYmUgYm91bmQgb3IgdW5ib3VuZC4KICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gbm9kZSBUaGUgbm9kZSBsaW5rZWQgbGlzdC4KICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIHRyaWdnZXJlZCBub2RlcwogICAgCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGVMaXN0LCBhcmdzKSB7CiAgICAgICAgdmFyIHRhaWwsIG9uY2VOb2RlcyA9IFtdOwogICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KCd7MH06IHRyaWdnZXJpbmcgezF9IGV2ZW50ICJ7Mn0iJywgdGhhdC5fX3B1YlN1Yk5hbWUsIGFzeW5jICYmICdhc3luYycgfHwgJycsIGV2ZW50KSk7CiAgICAgICAgZWFjaChub2RlTGlzdCwgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgdGFpbCA9IG5vZGUudGFpbDsKICAgICAgICAgICAgd2hpbGUoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIG5vZGUuY2FsbGJhY2ssIG5vZGUuY29udGV4dCB8fCB0aGF0LCBhcmdzKTsKICAgICAgICAgICAgICAgIG5vZGUub25jZSAmJiBvbmNlTm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKG9uY2VOb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgZWFjaChvbmNlTm9kZXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICB0aGF0LnVuc3Vic2NyaWJlKGV2ZW50LCB4LmNhbGxiYWNrLCB4LmNvbnRleHQsIHgubmFtZXNwYWNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBJbnZva2VzIGEgdHJpZ2dlciBjYWxsYmFjawogICAgCiAgICBAbWV0aG9kIHRyaWdnZXJDYWxsYmFjawogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kCiAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY2FsbGluZyBjb250ZXh0CiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aC4KICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSByZXR1cm5lZCB2YWx1ZS4KICAgIEZvciBhc3luYyBjYWxscywgdGhpcyBpcyBhIHByb21pc2UKICAgIEZvciBzeW5jIGNhbGxzIHRoaXMgaXMgdGhlIHZhbHVlIGZyb20gdGhlIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckNhbGxiYWNrKGFzeW5jLCBjYWxsYmFjaywgY29udGV4dCwgYXJncykgewogICAgICAgIGlmKGFzeW5jKSB7CiAgICAgICAgICAgIGRlZmVyKHRyaWdnZXJBc3luY0NhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSwgMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5ICB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGlmKHRDb25maWcudGhyb3dFcnJvcnMpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDcmVhdGVzIGFuIGFzeW5jIGV2ZW50IGhhbmRsZXIKICAgIAogICAgQG1ldGhvZCBhc3luY0V2ZW50RmFjdG9yeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgZm9yIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRyaWdnZXJBc3luY0NhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFJlc3Vic2NyaWJlcyB0byB0aGUgYXBwcm9wcmlhdGUgZXZlbnRzCiAgICAKICAgIEBtZXRob2QgX29mZlByb2Nlc3NOb2RlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGV2ZW50IGNvbnRleHQKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQKICAgIEBwYXJhbSB7T2JqZWN0fSBub2RlIFRoZSBub2RlIGxpbmtlZCBsaXN0LgogICAgQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZXZlbnQgY2FsbGJhY2sgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0gVGhlIGV2ZW50IGNvbnRleHQgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZXNwYWNlXSBUaGUgbmFtZXNwYWNlIHRvIHVuc3Vic2NyaWJlCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB2YXIgdGFpbCwgY2IsIGN0eCwgbnM7CiAgICAgICAgdGFpbCA9IG5vZGUudGFpbDsKICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgY2IgPSBub2RlLmNhbGxiYWNrOwogICAgICAgICAgICBjdHggPSBub2RlLmNvbnRleHQ7CiAgICAgICAgICAgIG5zID0gbm9kZS5uYW1lc3BhY2U7CiAgICAgICAgICAgIGlmKChjYWxsYmFjayAmJiBjYiAhPT0gY2FsbGJhY2spIHx8IChjb250ZXh0ICYmIGN0eCAhPT0gY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKGV2ZW50ICsgKG5zICYmICgnLicgKyBucykgfHwgJycpLCBjYiwgY3R4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgR2V0cyB0aGUgbmFtZXNwYWNlIGluZm9ybWF0aW9uLCB0aGUgcmVhbCBldmVudCB0byBwYXNzIGJhY2sgb250byB0aGUgbWV0aG9kcy4KICAgIAogICAgQG1ldGhvZCBnZXROYW1lc3BhY2VEYXRhCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0byBjYXB0dXJlIG5hbWVzcGFjZSBkYXRhIGZyb20uCiAgICBAcmV0dXJucyB7T2JqZWN0fSBDb250YWluaW5nIGV2ZW50IGFuZCBuYW1lc3BhY2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldE5hbWVzcGFjZURhdGEoZXZlbnQpIHsKICAgICAgICB2YXIgbnNJbmRleCA9IChldmVudCB8fCAnJykuaW5kZXhPZignLicpLCBoYXNOcyA9IG5zSW5kZXggPiAtMSwgbmFtZXNwYWNlID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcobnNJbmRleCArIDEpIDogdW5kZWZpbmVkLCBldmVudCA9IGhhc05zID8gZXZlbnQuc3Vic3RyaW5nKDAsIG5zSW5kZXgpIDogZXZlbnQ7CiAgICAgICAgaWYobnNJbmRleCA9PT0gMCkgewogICAgICAgICAgICBldmVudCA9IFNUQVJBTEw7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGV2ZW50OiBldmVudCwKICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UKICAgICAgICB9OwogICAgfQogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgogICAgCiAgICAqIEV2ZW50cyBjYW4gYmUgZmlyZWQgYXN5bmNyb25vdXNseS4KICAgICogRXZlbnRzIGNhbiBiZSBuYW1lc3BhY2VkLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkV2ZW50cwogICAgKiovCiAgICBleHBvcnRzLkV2ZW50cyA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IHsKICAgICAgICAgICAgc3Vic2NyaWJlOiAvKioKICAgICAgICAgICAgQmluZCBvbmUgb3IgbW9yZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnRzLCBgZXZlbnRzYCwgdG8gYSBgY2FsbGJhY2tgCiAgICAgICAgICAgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBDYWxsIHRoaXMgZXZlbnQgb25seSBvbmNlLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxzLCBldmVudCwgbm9kZSwgdGFpbCwgbGlzdCwgbmQ7CiAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGlzLl9fbmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgICAgICAgICBjYWxscyA9IHRoaXMuX2NhbGxiYWNrcyB8fCAodGhpcy5fY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYW4gaW1tdXRhYmxlIGNhbGxiYWNrIGxpc3QsIGFsbG93aW5nIHRyYXZlcnNhbCBkdXJpbmcKICAgICAgICAgICAgICAgIC8vIG1vZGlmaWNhdGlvbi4gIFRoZSB0YWlsIGlzIGFuIGVtcHR5IG9iamVjdCB0aGF0IHdpbGwgYWx3YXlzIGJlIHVzZWQKICAgICAgICAgICAgICAgIC8vIGFzIHRoZSBuZXh0IG5vZGUuCiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGNhbGxzW2V2ZW50XSB8fCAoY2FsbHNbZXZlbnRdID0gewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGxpc3QgPSBsaXN0W25kLm5hbWVzcGFjZV07CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGxpc3QgPyBsaXN0LnRhaWwgOiBuZXcgRXZlbnROb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGFpbCA9IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLmNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXMuX19kZWZhdWx0Q29udGV4dCB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIGlmKG5kLm5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLm5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYob25jZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLm9uY2UgPSBvbmNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsc1tldmVudF1bbmQubmFtZXNwYWNlXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFpbDogdGFpbCwKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDogbGlzdCA/IGxpc3QubmV4dCA6IG5vZGUKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uY2U6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBFYWNoIGV2ZW50IHdpbGwgb25seSBiZSBjYWxsZWQgb25jZS4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgb25jZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQGNoYWluYWJsZQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZShldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgY2FsbGJhY2tzCiAgICAgICAgICAgIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MgZm9yIHRoZQogICAgICAgICAgICBldmVudC4gSWYgYGV2ZW50YCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZCBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHVuc3Vic2NyaWJlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50LCBjYWxscywgbm9kZSwgbmQsIG91ck5zLCBuYW1lc3BhY2UsIHRoYXQgPSB0aGlzLCBoYXNOczsKICAgICAgICAgICAgICAgIG91ck5zID0gdGhhdC5fX25hbWVzcGFjZTsKICAgICAgICAgICAgICAgIG91ck5zICYmIChvdXJOcyA9IG91ck5zLnN1YnN0cmluZygxKSk7CiAgICAgICAgICAgICAgICAvLyBObyBldmVudHMsIG9yIHJlbW92aW5nICphbGwqIGV2ZW50cy4KICAgICAgICAgICAgICAgIGlmKCEoY2FsbHMgPSB0aGF0Ll9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoIShldmVudHMgfHwgY2FsbGJhY2sgfHwgY29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBpZighb3VyTnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoYXQuX2NhbGxiYWNrczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2JzID0gdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2JzW2ldW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2JzW2ldKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGxpc3RlZCBldmVudHMgYW5kIGNvbnRleHRzLCBzcGxpY2luZyB0aGVtIG91dCBvZiB0aGUKICAgICAgICAgICAgICAgIC8vIGxpbmtlZCBsaXN0IG9mIGNhbGxiYWNrcyBpZiBhcHByb3ByaWF0ZS4KICAgICAgICAgICAgICAgIG91ck5zICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGF0Ll9fbmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMgPyBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcikgOiBfLmtleXMoY2FsbHMpOwogICAgICAgICAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICAgICAgbmQgPSBnZXROYW1lc3BhY2VEYXRhKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICBldmVudCA9IG5kLmV2ZW50OwogICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgICBoYXNOcyA9ICEhbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICBpZihzaXplKGNhbGxzW2V2ZW50XSkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoIW5vZGUgfHwgIShjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLyppZiAoZXZlbnQgIT09IFNUQVJBTEwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50ICE9PSBTVEFSQUxMICYmICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZXZlbnQgPT09IEFMTCB8fCAhY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpIGluIGNhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihoYXNOcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgaSwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9fcHViU3ViTmFtZTogLyoqCiAgICAgICAgICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgICAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgICAgICAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAgICAgICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgZmlyZQogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICAgICAgICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgICAgICAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgICAgICAgICAgQHJldHVybnMge0FycmF5IG9mIFZhbHVlc30gSWYgbW9yZSB0aGFuIG9uIGV2ZW50IGlzIGZpcmVkLCBhbiBPYmplY3Qgb2YgQXJyYXlzIGlzIHJldHVybmVkLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgJ0V2ZW50cycsCiAgICAgICAgICAgIGluaXRFdmVudHM6IC8qKgogICAgICAgICAgICBJbml0J3MgdGhlIEV2ZW50IG1vZHVsZS4KICAgICAgICAgICAgVGhpcyBpcyBvbmx5IHJlcXVpcmVkIGlmIHlvdSB3aXNoIHRvIHVzZSBmaXJlLmFzeW5jLCBhbmQgbmFtZXNwYWNpbmcuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIGluaXRFdmVudHMKICAgICAgICAgICAgQGNoYWluYWJsZQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKGRlZmF1bHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmUgPSB0aGlzLnB1Ymxpc2ggPSBjcmVhdGVBc3luY0V2ZW50KHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzID0gbm9vcDsKICAgICAgICAgICAgICAgIHRoaXMuX19wdWJTdWJOYW1lID0gdGhpcy5uYW1lIHx8ICdFdmVudHMnOwogICAgICAgICAgICAgICAgaWYodGhpcy5uYW1lICYmICF0aGlzLl9fbmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX25hbWVzcGFjZSA9ICcuJyArIHRoaXMubmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX19kZWZhdWx0Q29udGV4dCA9IGRlZmF1bHRDb250ZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGV4dGVuZDogLyoqCiAgICAgICAgICAgIEV4dGVuZHMgRXZlbnRzIGludG8gdGhlIGdpdmVuIG9iamVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgZXh0ZW5kCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSB0byBUaGUgb2JqZWN0IG90IGV4dGVuZCBldmVudHMgb250bwogICAgICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IFtpbml0XSBPcHRpb25hbGx5IGluaXQgdGhlIGV2ZW50cy4KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICAgICAgXy5leHRlbmQodG8sIGV4cG9ydHMuRXZlbnRzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0by5leHRlbmQ7CiAgICAgICAgICAgICAgICBpbml0ICYmIHRvLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0bzsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXZlbnRzLmZpcmUgPSBldmVudHMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQoewogICAgICAgIH0pOwogICAgICAgIHJldHVybiBldmVudHM7CiAgICB9KSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudHMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZmFjYWRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fdG1fXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHRtID0gX190bV9fOwoKICAgIHZhciBNb2R1bGUgPSB0bS5Nb2R1bGU7CiAgICAvKioKICAgIAogICAgVGhlIEZhY2FkZSBtb2R1bGUgb2ZmZXJzIHRoZSBhYmlsaXR5IHRvIGNyZWF0ZSBhbiBpbnRlcmZhY2Ugb3Igc2ltaWxhciBjb25jZXB0LgogICAgV2l0aCB0aGUgRmFjYWRlIGluIHRocnVzdCwgaXQgYWxsb3dzIHlvdSB0byBjYXB0dXJlIGV2ZW50cyBmcm9tIGEgbW9kdWxlLCB3aGVuIGxvYWRlZCB2aWEgY29udmVudGlvbi4KICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgogICAgCiAgICBGYWNhZGUgaGFzIHRoZXNlIGJ1aWx0IGluIG1ldGhvZHM6CiAgICAqIGluaXQKICAgICogc3RhcnQKICAgICogcmVhZHkKICAgICogc3RvcAogICAgKiBkZXN0cm95CiAgICAKICAgIEJlaGluZCB0aGUgc2NlbmVzIHRoZSBmYWNhZGUgbWV0aG9kcywgaW52b2tlIGFueSBjb252ZW50aW9ucyBsb2FkZWQgZm9yIHRoZSBwbHVnaW4uCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRmFjYWRlCiAgICAqKi8KICAgIHZhciB0aHJ1c3RDYWNoZSA9IE1vZHVsZS50aHJ1c3RDYWNoZTsKICAgIHZhciBmYWNhZGVNZXRob2RzID0gWwogICAgICAgICdpbml0JywgCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnZGVzdHJveScKICAgIF0sIGRlZmF1bHRQcm90b3R5cGUgPSB7CiAgICB9OwogICAgZnVuY3Rpb24gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlcyA9IFtdOwogICAgICAgICAgICBpZihtICYmICEoKG0pLmNvbnZlbnRpb24pKSB7CiAgICAgICAgICAgICAgICBtID0gdGhydXN0Q2FjaGVbbS5taWRdLm1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0Ll9fY29udmVudGlvbnMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBuYW1lLCBtLCB0aGF0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBtZXRob2RXcmFwKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZikgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGYuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgIHZhciBtZXRob2QgPSBmYWNhZGVNZXRob2RzW2ldOwogICAgICAgIGRlZmF1bHRQcm90b3R5cGVbbWV0aG9kXSA9IGNvbnZlbnRpb25GdW5jdGlvbkZhY3RvcnkobWV0aG9kKTsKICAgIH0KICAgIC8qKgogICAgRmFjYWRlIGluaXQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIGluaXQKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHN0YXJ0CiAgICAKICAgIENhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RhcnQKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHJlYWR5CiAgICAKICAgIENhbGxlZCBkdXJpbmcgdGhlIHJlYWR5IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgcmVhZHkKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHN0b3AKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIHN0b3AKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIGRlc3Ryb3kKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIGRlc3Ryb3kKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgbW9kdWxlIGluc3RhbmNlCiAgICAKICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e3BsdWdpbk5hbWV9OntoYXNoS2V5fQogICAgCiAgICBoYXNLZXk6IGlzIGEgdW5pcXVlIGtleSwgdGhhdCB0aGUgbW9kdWxlIHNoYXJlcyB3aXRoIHRoZSBmYWNhZGUsIGFsbG93cyBmb3IgZGVmaW5pbmcgZGVwZW5kZW5jaWVzCiAgICBpbiB5b3VyIGRlZmluZSBibG9jaywgYW5kIGdldCBhY2Nlc3MgdG8gdGhlIG1vZHVsZXMgZmFjYWRlLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBvYnNvbGV0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luID0gcGFydHNbMV0sIHBsdWdpbk5hbWUgPSBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSB8fCAwKSwgaGFzaEtleSA9IHBhcnRzWzJdOwogICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnN0YW5jZU5hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIGlmKCFwbHVnaW5OYW1lKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncGx1Z2luTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIWhhc2hLZXkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoYXNoS2V5IGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgdGhydXN0UGx1Z2luID0gdGhydXN0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICBpZighdGhydXN0UGx1Z2luKSB7CiAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICBwbHVnaW4KICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZChwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0gPSB0aHJ1c3RDYWNoZVtoYXNoS2V5XSB8fCAodGhydXN0Q2FjaGVbaGFzaEtleV0gPSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5zdGFuY2U6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBmYWNhZGUgPSB0aHJ1c3RQbHVnaW4uY3JlYXRlRmFjYWRlKHRocnVzdCwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyk7CiAgICAgICAgICAgIGxvYWQoZmFjYWRlKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICBmdW5jdGlvbiBjcmVhdGVGYWNhZGUoaW5pdE1ldGhvZCkgewogICAgICAgIHZhciBmID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIEZhY2FkZSA9IGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICAgICAgICAgIGluaXRNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBmYWNhZGVNZXRob2RzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXNbbWV0aG9kXSAhPT0gZGVmYXVsdFByb3RvdHlwZVttZXRob2RdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbbWV0aG9kXSA9IF8ud3JhcCh0aGlzW21ldGhvZF0sIG1ldGhvZFdyYXAoZGVmYXVsdFByb3RvdHlwZVttZXRob2RdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5tb2QgPSBtb2Q7CiAgICAgICAgICAgICAgICAvL3RoaXMuaW5pdChtb2QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgRmFjYWRlLnByb3RvdHlwZSA9IF8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIHVwZGF0ZUZhY2FkZTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBkZWZhdWx0UHJvdG90eXBlKTsKICAgICAgICAgICAgcmV0dXJuIEZhY2FkZTsKICAgICAgICB9KSgpOwogICAgICAgIHJldHVybiBmOwogICAgfQogICAgZXhwb3J0cy5jcmVhdGVGYWNhZGUgPSBjcmVhdGVGYWNhZGU7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWZhY2FkZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3QvbWVkaWF0b3JfXyBDb252ZW50aW9uIC0gQXV0byBTdGFydAogICAgKgogICAgKiBUaGUgYXV0byBzdGFydCBwcm9wZXJ0eSBhbGxvd3MgZm9yIGEgbW9kdWxlLCB0byBiZSBhdXRvbWF0aWNhbGx5IHN0YXJ0ZWQgb25jZSBpdCBpcwogICAgKiBpbmNsdWRlZCBpbnRvIGEgdGhydXN0IGluc3RuYWNlLCB3aXRob3V0IGhhdmluZyB0byBleHBsaWNpdHkgY2FsbCBzdGFydCBvbiB0aGUgbW9kdWxlLgogICAgKgogICAgKgogICAgKiBUaGlzIGlzIHVzZWZ1bCBmb3IgY2VydGlhbiB0eXBlcyBvZiBtb2R1bGVzLCB1c3VhbGx5IHBlcnNpc3RhbnQgb25lcyB0aGF0IGFsd2F5cyBuZWVkIHRvIGxvYWQgcmVnYXJkbGVzcy4KICAgICogRm9yIGV4YW1wbGUgYSBuYXZpZ2F0aW9uIG1vZHVsZSwgb3IgdXNlciBzZXR0aW5ncyBtb2R1bGUuCiAgICAqCiAgICAqIEBmb3IgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IGF1dG9TdGFydAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgICdjb25maWcuYXV0b1N0YXJ0JwogICAgICAgIF0KICAgIH07CiAgICBleHBvcnRzLmF1dG9zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hdXRvc3RhcnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgICAgIHZhciBldmVudCA9IHsKICAgICAgICBhbnlDb250YWluZXI6ICd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXIvYW55JywKICAgICAgICBjaGFuZ2VDb250YWluZXI6ICd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXIvY2hhbmdlJwogICAgfSwgYW55ID0gXy5hbnksIGJpbmQgPSBfLmJpbmQsIENPTlRBSU5FUiA9ICdjb25maWcuY29udGFpbmVyJywgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgZGVmZXIgPSBfLmRlZmVyOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBDT05UQUlORVIKICAgICAgICBdLAogICAgICAgIGNoYW5nZTogZnVuY3Rpb24gKG1vZCwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXJWYWx1ZSA9IG1vZC5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmKGNvbnRhaW5lclZhbHVlICYmIGNvbnRhaW5lciAmJiBjb250YWluZXJWYWx1ZSA9PT0gY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBpZihtb2QuY29udmVudGlvbihTVEFSVCkpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcihiaW5kKG1vZC5zdG9wLCBtb2QpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBjb250YWluZXJWYWx1ZSA9IG1vZC5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmKGNvbnRhaW5lclZhbHVlKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLmZpcmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBjb250YWluZXJWYWx1ZSk7CiAgICAgICAgICAgICAgICAvLyBTdWJzY3JpcHRpb25zIGdldCB1bnN1YnNjcmliZWQgd2hlbiBzdG9wcGluZyBhIG1vZHVsZSwgc28gd2UgbmVlZCB0byByZXN1YnNjcmliZSBldmVyeSB0aW1lIGhlcmUuCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHByb2JhYmx5IGJldHRlciwgYXMgdGhlIGV2ZW50cyB3aWxsIGJlIGxlc3MgY2hhdHR5LgogICAgICAgICAgICAgICAgZmFjYWRlcy5tZWRpYXRvci5zdWJzY3JpYmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBiaW5kKHRoYXQuY2hhbmdlLCB0aGF0LCBtb2QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250YWluZXIuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGFueSA9IF8uYW55LCBtYXAgPSBfLm1hcCwgRE1PRFVMRVMgPSAnY29uZmlnLmRlcGVuZGVudE1vZHVsZXMnLCBDTU9EVUxFUyA9ICdjb25maWcuY2hpbGRNb2R1bGVzJywgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgZGVmZXIgPSBfLmRlZmVyLCBiaW5kID0gXy5iaW5kOwogICAgdmFyIGludm9rZWRlcGVuZGVudE1vZHVsZXMgPSBmdW5jdGlvbiAobW9kLCBtZXRob2QpIHsKICAgICAgICB2YXIgcmVxdWlyZWRNb2R1bGVzID0gbW9kLmNvbnZlbnRpb24oRE1PRFVMRVMpOwogICAgICAgIGlmKHJlcXVpcmVkTW9kdWxlcykgewogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdFttZXRob2RdKHJlcXVpcmVkTW9kdWxlcyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBpbnZva2VDaGlsZE1vZHVsZXMgPSBmdW5jdGlvbiAobW9kLCBtZXRob2QpIHsKICAgICAgICB2YXIgcmVxdWlyZWRNb2R1bGVzID0gbW9kLmNvbnZlbnRpb24oQ01PRFVMRVMpOwogICAgICAgIGlmKHJlcXVpcmVkTW9kdWxlcykgewogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdFttZXRob2RdKHJlcXVpcmVkTW9kdWxlcyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgRE1PRFVMRVMsIAogICAgICAgICAgICBDTU9EVUxFUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAnc3RhcnQnKSwgCiAgICAgICAgICAgICAgICBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnc3RhcnQnKQogICAgICAgICAgICBdOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoIW1vZC50aHJ1c3Quc3RhcnRlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICBpbnZva2VkZXBlbmRlbnRNb2R1bGVzKG1vZCwgJ3JlYWR5JyksIAogICAgICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdyZWFkeScpCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnc3RvcCcpOwogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ2Rlc3Ryb3knKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5kZXBlbmRlbnRNb2R1bGVzID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWRlcGVuZGVudC5tb2R1bGVzLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLmNvbmZpZwogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5yZXNvbHZlID0gWwogICAgICAgICduYW1lJywgCiAgICAgICAgJ2NmZycKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9tZWRpYXRvci4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vc3Vic2NyaXB0aW9uJwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vc3Vic2NyaXB0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIFRoZSBmYWNhZGUgY29udmVudGlvbiwgY3JlYXRlcyB0aGUgbWVkaWF0b3IgZmFjYWRlIGZvciBlYWNoIG1vZHVsZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgICAgIHZhciBTVUJTQ1JJUFRJT05TID0gJ2NvbmZpZy5tZWRpYXRvci5zdWJzY3JpcHRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzUGxhaW5PYmplY3QgPSBfLmlzUGxhaW5PYmplY3QsIGZvck93biA9IF8uZm9yT3duLCBlYWNoID0gXy5lYWNoOwogICAgdmFyIGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIgPSBbCiAgICAgICAgJ2hhbmRsZXInLCAKICAgICAgICAnY29udGV4dCcKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIFNVQlNDUklQVElPTlMKICAgICAgICBdLAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnMgPSBtb2QuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKTsKICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9ucyAmJiAhKHN1YnNjcmlwdGlvbnMpLl9zdWJzY3JpcHRpb25zU2V0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgICAgICBmb3JPd24oc3Vic2NyaXB0aW9ucywgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24sIHN1YnNjcmlwdGlvbk5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShzdWJzY3JpcHRpb25Db2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlYWNoKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24sIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShzdWJzY3JpcHRpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25ld1N1YnNjcmlwdGlvbi5wdXNoLmFwcGx5KG5ld1N1YnNjcmlwdGlvbiwgc3Vic2NyaXB0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uLCBmdW5jdGlvbiAoaGFuZGxlck9iamVjdCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdTdWJzY3JpcHRpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbk5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKG1vZC5pbnN0YW5jZVtoYW5kbGVyT2JqZWN0XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0Z1bmN0aW9uKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzdWJzY3JpcHRpb25baSArIDFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChzdWJzY3JpcHRpb25baSArIDFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3JldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNQbGFpbk9iamVjdChoYW5kbGVyT2JqZWN0KSAmJiAoJ21vZHVsZUhhbmRsZXInIGluIGhhbmRsZXJPYmplY3QgfHwgJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uID0gW3N1YnNjcmlwdGlvbk5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZignbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QubW9kdWxlSGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdoYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyT2JqZWN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKG1vZC5pbnN0YW5jZVtoYW5kbGVyT2JqZWN0LmhhbmRsZXJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdC5oYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZignY29udGV4dCcgaW4gaGFuZGxlck9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdC5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihuZXdTdWJzY3JpcHRpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNhZGUuc3Vic2NyaWJlLmFwcGx5KGZhY2FkZSwgbmV3U3Vic2NyaXB0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKS5fc3Vic2NyaXB0aW9uc1NldCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmIHN1YnNjcmlwdGlvbnMuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdWJzY3JpcHRpb24gPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3Vic2NyaXB0aW9uLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAc3VibW9kdWxlIHRocnVzdC5kYXRhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L2RvbS4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcKICAgIF07CiAgICAvKioKICAgIERlY2lkZXMgaWYgYHRocnVzdC9kYXRhYCBzaG91bGQgY2FjaGUgcmVxdWVzdHMgb3Igbm90LgogICAgCiAgICBZb3Ugc2hvdWxkIHR1cm4gdGhpcyB0byBgZmFsc2VgLCBpZiB5b3UgYXJlIGV4cGVyaWVuY2luZyBjYWNoaW5nIGlzc3VlcyBhbmQgbmVlZCB0byBkZWJ1Zy4KICAgIAogICAgQHByb3BlcnR5IGNhY2hlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmNhY2hlID0gdHJ1ZTsKICAgIC8qKgogICAgKgogICAgKiBgc3RhcnRUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgcmVxdWVzdHMKICAgICogYXJlIHN0YXJ0ZWQuCiAgICAqCiAgICAqCiAgICAqIFRoZSBxdWV1ZWluZyBzeXN0ZW0gd29ya3MgaW4gdGhlIGZvbGxvd2lnIG1hbm5lci4gIEFsbCByZXF1ZXN0cyB0aGF0IGFyZSBxdWV1ZWQgdG9nZXRoZXIgcGVyIEhUVFAKICAgICogcmVxdWVzdCBtZXRob2QgKGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwgYFBBVENIYCwgZXRjKS4gIEFmdGVyIHRoZSBmaXJzdCByZXF1ZXN0LCB0aGUgdGltZXIKICAgICogc3RhcnRzLCBvbmNlIHRoZSB0aW1lb3V0IGVsYXBzZXMsIGFsbCB0aGUgcmVxdWVzdHMgYXJlIHNoaXBwZWQgb2ZmIGF0IG9uY2UuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgY291bnRlciBpbnR1aXRpdmUgaWYgeW91J3JlIGxvb2tpbmcgdG8gZ2V0IHRoZSByZXF1ZXN0IGJhY2sgaW1tZWRpYXRlbHksIGJ1dCBmcm9tIGEgVVggcGVyc3BlY3RpdmUKICAgICogdGhpcyBhbGxvd3MgdGhlIFVJIHRvIHN0YXkgaW4gc3luYyBhbmQgZ2l2ZSB0aGUgdXNlciBhIGNvaGVzaXZlLCBpbnN0ZWFkIG9mIHNlZWluZyBsb2FkZXJzLCBzaG93IHVwIGFuZAogICAgKiBkaXNhcHBlYXIgYXQgc2VlbWluZ2x5IHJhbmRvbSBpbnRlcnZhbHMsIHRoZSB1c2VyIGRvZXMgYW4gYWN0aW9uLCBhbmQgdGhlbiBzZWVzIGEgcmVzcG9uc2UuCiAgICAqCiAgICAqCiAgICAqIEBwcm9wZXJ0eSBzdGFydFRpbWVvdXQKICAgICogQHJlYWRPbmx5CiAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAqIEBkZWZhdWx0IDUwMAogICAgKiovCiAgICBleHBvcnRzLnN0YXJ0VGltZW91dCA9IDEwMDsKICAgIC8qKgogICAgKgogICAgKiBgZmluaXNoVGltZW91dGAgaXMgcGFydCBvZiBxdWV1ZWluZyBidWlsdCBpbnRvIGB0aHJ1c3QvZGF0YWAuICBJdCBkZWZpbmVzIHRoZSB3YWl0IHRpbWUgYmVmb3JlIHRoZQogICAgKiBxdWV1ZSBpcyBjb21wbGV0ZWQuICBJZiBhbGwgdGhlIHJlcXVlc3RzIGZpbmlzaCBlYXJseSwgdGhlIHRpbWVvdXQgaXMgY2FuY2VsZWQuCiAgICAqCiAgICAqCiAgICAqIFRoZSBxdWV1ZWluZyBzeXN0ZW0gd29ya3MgaW4gdGhlIGZvbGxvd2lnIG1hbm5lci4gIEFsbCByZXF1ZXN0cyB0aGF0IGFyZSBxdWV1ZWQgdG9nZXRoZXIgcGVyIEhUVFAKICAgICogcmVxdWVzdCBtZXRob2QgKGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwgYFBBVENIYCwgZXRjKS4gIEFmdGVyIHRoZSByZXF1ZXN0cyBhcmUgZmlyZWQgb2ZmCiAgICAqIGB0aHJ1c3QvZGF0YWAgd2lsbCB3YWl0IHVudGlsIGl0IGdldHMgYSByZXNwb25zZSBmcm9tIGV2ZXJ5b25lIG9mIHRoZW0uICBJZiBmb3Igc29tZSByZWFzb24gYSByZXF1ZXN0CiAgICAqIHRha2VzIHRvIGxvbmcsIGFuZCB0aGUgdGltZW91dCBpcyBoaXQsIGFsbCB0aGUgcmVxdWVzdHMgdGhhdCBoYXZlIGNvbXBsZXRlZCwgd2lsbCBiZSByZWxlYXNlZWQsIGFsbG93aW5nCiAgICAqIHRoZSBhcHBsaWNhdGlvbiB0byBjb250aW51ZSB1bmRpc3J1cHRlZC4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgIEBwcm9wZXJ0eSBmaW5pc2hUaW1lb3V0CiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtOdW1iZXJ9CiAgICBAZGVmYXVsdCAyMDAwCiAgICAqKi8KICAgIGV4cG9ydHMuZmluaXNoVGltZW91dCA9IDIwMDA7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LnR5cGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvKioKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgKiovCiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvd2FpdGAgZXZlbnQgaXMgZmlyZWQgb25jZSBhIGRhdGEgY2FsbCBpcyBtYWRlLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvd2FpdAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgKiovCiAgICBleHBvcnRzLndhaXQgPSAndGhydXN0L2RhdGEvd2FpdCc7CiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvc3RhcnRgIGV2ZW50IGlzIGZpcmVkIHRoZSBxdWV1ZSBpcyBzdGFydGVkLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhcnQKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgb3V0Z29pbmcgY2FsbCBjb3VudAogICAgKiovCiAgICBleHBvcnRzLnN0YXJ0ID0gJ3RocnVzdC9kYXRhL3N0YXJ0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGF0dXNgIGV2ZW50IGlzIGZpcmVkIGZvciBldmVyeSBpdGVtIHRoYXQgcmV0dXJucyBmcm9tIHRoZSBxdWV1ZS4KICAgIAogICAgTk9URTogSXQgaXMgZW50aXJlbHkgcG9zc2libGUgZm9yIGB0aHJ1c3QvZGF0YS9zdGF0dXMqKiB0byBiZSBjYWxsZWQgYWZ0ZXIgYHRocnVzdC9kYXRhL3N0b3AqKiBpZiBzZXZlcmFsCiAgICBjYWxscyB0YWtlIHRvIGxvbmcgdG8gY29tcGxldGUuICBUaGlzIGlzIGludGVuZGVkLCBhbmQgcG90ZW50aWFsbHkgdXNlZnVsIGluZm9ybWF0aW9uLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhdHVzCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIGN1cnJlbnQgY29tcGxldGVkIGNhbGwgY291bnQgZm9yIHRoaXMgcXVldWUuCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhdHVzID0gJ3RocnVzdC9kYXRhL3N0YXR1cyc7CiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvc3RvcGAgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbGwgaXRlbXMgaW4gdGhlIHF1ZXVlIHJldHVybiwgb3IgdGhlIGZpbmlzaGVkVGltZW91dCBzZXR0aW5nIGVsYXBzZXMuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdG9wCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIChjdXJyZW50KSBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdG9wID0gJ3RocnVzdC9kYXRhL3N0b3AnOwogICAgZXhwb3J0cy5ldmVudCA9IHsKICAgICAgICBiZWZvcmVTZW5kOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZCcsCiAgICAgICAgc3RhcnQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3RhcnRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0YXJ0JywKICAgICAgICBzZW5kOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L3NlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zZW5kCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc2VuZCcsCiAgICAgICAgZXJyb3I6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvZXJyb3JgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcgogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2Vycm9yJywKICAgICAgICBzdWNjZXNzOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3NgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zdWNjZXNzCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3VjZXNzJywKICAgICAgICBjb21wbGV0ZTogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZWAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUnLAogICAgICAgIHN0b3A6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3RvcGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0b3AKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdG9wJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQudHlwZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9ldmVudC5mYWN0b3J5JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuL2V2ZW50LnR5cGVzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19ldmVudFR5cGVzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGV2ZW50VHlwZXMgPSBfX2V2ZW50VHlwZXNfXzsKCiAgICB2YXIgY2FtZWxDYXNlID0gdXRpbC5jYW1lbENhc2UsIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBiaW5kID0gXy5iaW5kLCBkYXRhRXZlbnRzID0gZXZlbnRUeXBlcy5ldmVudCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIG1lbW9pemUgPSBfLm1lbW9pemU7CiAgICAvKioKICAgIFRoZSBldmVudCBmYWN0b3J5IGxpbmtzIGpRdWVyeSBFdmVudHMgdXAgdG8gdGhydXN0IGNlbnRyaWMgZXZlbnRzLgogICAgVGhlIGV2ZW50IGZhY3Rvcnkgd291bGQgYmUgcmVwbGFjZWQgaWYgd2Ugd2VyZSBldmVyIG1vdmVkIG9mZiBvZiB0aGUgalF1ZXJ5IGRlcGVuZGFuY3kuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgICoqLwogICAgdmFyIGV2ZW50SGFuZGxlcnMgPSB7CiAgICAgICAgJ2JlZm9yZS1zZW5kJzogLy8gU3VwcG9ydGVkIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgdHJ1ZSwKICAgICAgICAnc2VuZCc6IHRydWUsCiAgICAgICAgJ2Vycm9yJzogdHJ1ZSwKICAgICAgICAnc3VjY2Vzcyc6IHRydWUsCiAgICAgICAgJ2NvbXBsZXRlJzogdHJ1ZSwKICAgICAgICAnc3RhcnQnOiB0cnVlLAogICAgICAgICdzdG9wJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgV3JhcHMgYmVmb3JlU2VuZCwgd2hpY2ggaXMgYSBjdXN0b20gcHJvcGVydHkgb24gdGhlIGpRdWVyeSBhamF4IGRhdGEgY2FsbC4KICAgIAogICAgQG1ldGhvZCBiZWZvcmVTZW5kTWV0aG9kCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBiZWZvcmVTZW5kTWV0aG9kKGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgdGhpcy5maXJlKGRhdGFFdmVudHNbJ2JlZm9yZVNlbmQnXSwganFYSFIsIHNldHRpbmdzKTsKICAgIH0KICAgIGV4cG9ydHMuYmVmb3JlU2VuZE1ldGhvZCA9IGJlZm9yZVNlbmRNZXRob2Q7CiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgZXZ0ID0gZGF0YUV2ZW50c1tldmVudF07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChldnQpOwogICAgICAgICAgICB0aGlzLmZpcmUuYXBwbHkodGhpcy5maXJlLmFzeW5jLCBhcmdzKTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgbm9ybWFsaXplRXZlbnRzID0gZnVuY3Rpb24gKGV2dHMpIHsKICAgICAgICBldnRzID0gZXZ0cy5zcGxpdCgnICcpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZighZXZlbnRIYW5kbGVyc1tldnRzW2ldXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnRXZlbnQgInswfSIgaXMgbm90IGEgdmFsaWQgZGF0YSBldmVudCcsIGV2dHNbaV0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBldnRzW2ldID0gZGF0YUV2ZW50c1tldnRzW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2dHMuam9pbignICcpOwogICAgfTsKICAgIHZhciBzZW5kRXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKGkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV2ZW50LCBqcVhIUiwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgaWYoIXNldHRpbmdzLl9fbWVkaWF0b3JfZGF0YV9maXJlZF9fKSB7CiAgICAgICAgICAgICAgICBqcVhIUi5hYm9ydCgpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQsIGFsbCBhamF4IGNhbGxzIG11c3QgcGFzcyB0aHJvdWdoIHRocnVzdC1kYXRhLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50RmFjdG9yeShpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIEJpbmRzIGFsbCB0aGUgalF1ZXJ5IGRhdGEgZXZlbnRzIGFuZCBjcmVhdGVzIGV2ZW50IG5hdGl2ZSB0aHJ1c3QgZXZlbnRzIG91dCBvZiB0aGVtLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBpbml0CiAgICBAcGFyYW0ge2pRdWVyeX0gQSBqUXVlcnkgaW5zdGFuY2Ugd3JhcHBpbmcgJ2RvY3VtZW50JwogICAgKiovCiAgICBmdW5jdGlvbiBpbml0KGpEb2MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgIGZvcih2YXIgaSBpbiBldmVudEhhbmRsZXJzKSB7CiAgICAgICAgICAgIHZhciBqcUV2dCA9ICdhamF4LScgKyBpLCBtZXRob2QgPSBldmVudEZhY3RvcnkoaSk7CiAgICAgICAgICAgIGlmKGkgPT09ICdzZW5kJykgewogICAgICAgICAgICAgICAgbWV0aG9kID0gYmluZChzZW5kRXZlbnRGYWN0b3J5KGkpLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqRG9jLm9uKGNhbWVsQ2FzZShqcUV2dCkgKyB0aGlzLm5hbWVzcGFjZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluaXQgPSBpbml0Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC5mYWN0b3J5LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvcmVzcG9uc2UucXVldWUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnLCAnanF1ZXJ5JywgJ3RocnVzdC9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19ldmVudFR5cGVzX18sIF9falF1ZXJ5X18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCB1aWQgPSBfLnVuaXF1ZUlkLCBhamF4ID0galF1ZXJ5LmFqYXgsIGRhdGFFdmVudFdhaXQgPSBldmVudFR5cGVzLndhaXQsIGRhdGFFdmVudFN0YXJ0ID0gZXZlbnRUeXBlcy5zdGFydCwgZGF0YUV2ZW50U3RvcCA9IGV2ZW50VHlwZXMuc3RvcCwgZGF0YUV2ZW50U3RhdHVzID0gZXZlbnRUeXBlcy5zdGF0dXMsIHF1ZXVlID0gewogICAgfSwgdXBkYXRlWEhSSW50ZXJuYWxzID0gZnVuY3Rpb24gKGRmbywgeGhyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYoIWRmby5feGhyKSB7CiAgICAgICAgICAgICAgICBkZm8uX3hociA9IHhocjsKICAgICAgICAgICAgICAgIGRmby5nZXRBbGxSZXNwb25zZUhlYWRlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRmby5feGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5nZXRSZXNwb25zZUhlYWRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzZ2V0UmVzcG9uc2VIZWFkZXIoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uYWJvcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRmby5feGhyLmFib3J0KCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLnNldFJlcXVlc3RIZWFkZXIgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuc2V0UmVxdWVzdEhlYWRlcihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRmby5yZXNwb25zZVRleHQgPSB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICBkZm8ucmVzcG9uc2VYTUwgPSB4aHIucmVzcG9uc2VYTUw7CiAgICAgICAgICAgIGRmby5yZWFkeVN0YXRlID0geGhyLnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGRmby5zdGF0dXMgPSB4aHIuc3RhdHVzOwogICAgICAgICAgICBkZm8uc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwogICAgICAgIH07CiAgICB9LCBhcmd1bWVudFJlc29sdmVyID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QoXy50b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIH07CiAgICB9LCBkZWZlckNvbnRyb2xsZXJJdGVtQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZnVuYykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpcywgYXJndW1lbnRzWzBdWzBdKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgVGhlIHJlc3BvbnNlIHF1ZXVlIGNsYXNzIGhhbmRsZXMgY3JlYXRpb24gb2YgYSBxdWV1ZSBvciBiYXRjaGluZyBzeXN0ZW0uCiAgICBXaXRoIHRoaXMgc3lzdGVtLCB3ZSBjYW4gYmF0Y2ggdXAgYWxsIG91ciBzZXJ2ZXIgcmVxdWVzdHMsIGFuZCByZXF1ZXN0IHRoZW0gZnJvbSB0aGUgc2VydmVyIGFsbCBhcm91bmQgdGhlIHNhbWUgdGltZS4KICAgIEluIGFkZGl0aW9uIHRvIHRoYXQsIHdoZW4gdGhlIHJlcXVlc3RzIGNvbWUgYmFjayB3ZSBjYW4gYWxzbyBzcG9vbCB0aGVtIHRvZ2V0aGVyLCBzbyB0aGF0IHRoZSBjYWxscyBkb24ndCByZXNvbHZlIHVudGlsCiAgICBlaXRoZXIgYWxsIHRoZSBjYWxscyBjb21lIGJhY2ssIG9yIGEgc3BlY2lmaWMgdGltZSBoYXMgZWxhcHNlZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLlJlc3BvbnNlUXVldWUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIHJlc3BvbnNlIHF1ZXVlIGZvcgogICAgQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0VGltZW91dCBUaGUgdGltZSB0byB3YWl0IGZvciBhZGRpdGlvbmFsIHJlcXVlc3RzLgogICAgQHBhcmFtIHtOdW1iZXJ9IGZpbmlzaFRpbWVvdXQgVGhlIG1heGltdW0gdGltZSB0byB3YWl0IGZvciByZXF1ZXN0cyB0byByZXR1cm4uCiAgICAqKi8KICAgIHZhciBSZXNwb25zZVF1ZXVlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBSZXNwb25zZVF1ZXVlKG1vZHVsZSwgc3RhcnRUaW1lb3V0LCBmaW5pc2hUaW1lb3V0KSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lb3V0ID0gc3RhcnRUaW1lb3V0OwogICAgICAgICAgICB0aGlzLmZpbmlzaFRpbWVvdXQgPSBmaW5pc2hUaW1lb3V0OwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSBtb2R1bGUubmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5hZGRUb1F1ZXVlID0gLyoqCiAgICAgICAgQWRkcyBhIHJlcXVlc3QgdG8gdGhlIHF1ZXVlCiAgICAgICAgUXVldWVzIGFyZSBzcGxpdCB1cCBieSBIVFRQIHR5cGUsIHNvIEdFVCByZXF1ZXN0cyBnbyB3aXRoIEdFVCByZXF1ZXN0cyBhbmQgUE9TVCByZXF1ZXN0cyBnbyB3aXRoIFBPU1QgcmVxdWVzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBhZGRUb1F1ZXVlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSAoUE9TVCwgR0VULCBldGMpCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgcmVxdWVzdCB1cmwgdG8gcXVldWUgdXAKICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgcmVxdWVzdCBvcHRpb25zLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBvciByZWplY3QsIHdoZW4gdGhlIHJlcXVlc3QgaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0eXBlLCB1cmwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuYmVmb3JlU2VuZCkgewogICAgICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoZnVuY3Rpb24gKGV2ZW50VHlwZSkgewogICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50VHlwZSAmJiBldmVudFR5cGUgPT0gJ2JlZm9yZS1zZW5kJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlU2VuZC5hcHBseShiZWZvcmVTZW5kLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2UuYWx3YXlzKG9wdGlvbnMuY29tcGxldGUpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuY29tcGxldGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS50aGVuKG9wdGlvbnMuc3VjY2Vzcyk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMuZXJyb3IpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLm90aGVyd2lzZShvcHRpb25zLmVycm9yKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNRdWV1ZSA9ICEhcXVldWVbdHlwZV0sIGxpc3QgPSBxdWV1ZVt0eXBlXSB8fCAocXVldWVbdHlwZV0gPSB7CiAgICAgICAgICAgIH0pLCB0YWlsID0gbGlzdC50YWlsIHx8IChsaXN0LnRhaWwgPSBsaXN0Lm5leHQgPSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBleHRlbmQodGFpbCwgewogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgICAgICAgICAgZGZvOiBkZm8KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxpc3QudGFpbCA9IHRhaWwubmV4dCA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoIWhhc1F1ZXVlKSB7CiAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuc3RhcnRUaW1lb3V0KS50aGVuKHRoYXQucHJvY2Vzcyh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgIH07CiAgICAgICAgUmVzcG9uc2VRdWV1ZS5wcm90b3R5cGUucHJvY2VzcyA9IC8qKgogICAgICAgIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCB3aWxsIHByb2Nlc3MgdGhlIGdpdmVuIHF1ZXVlIGFmdGVyIHRoZSBzdGFydCB0aW1lIGhhcyBlbGFwc2VkLgogICAgICAgIAogICAgICAgIEBtZXRob2QgcHJvY2VzcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBxdWV1ZSB0eXBlLCB0byBwcm9jZXNzLgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBkbyB0aGUgd29yayBvbiB0aGUgcXVldWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IHF1ZXVlW3R5cGVdLCBub2RlID0gcGFyZW50LCB0aGF0ID0gdGhpcywgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBQcm9jZXNzaW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgICAgIHZhciB3aGVuUXVldWUgPSBbXSwgZGVmZXJDb250cm9sbGVyID0gd2hlbi5kZWZlcigpLCByZXR1cm5Db3VudCA9IDA7CiAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogRmluaXNoaW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0b3AsIHF1ZXJ5SWQsIHR5cGUsIHJldHVybkNvdW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIHF1ZXVlW3R5cGVdOwogICAgICAgICAgICAgICAgdmFyIHRhaWwgPSBub2RlLnRhaWwsIHN0YXR1c0NhbGxiYWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RhdHVzLCBxdWVyeUlkLCB0eXBlLCArK3JldHVybkNvdW50KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGZvID0gbm9kZS5kZm8sIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgICAgIH0sIG5vZGUub3B0aW9ucyksIHhockRmbyA9IHdoZW4uZGVmZXIoKSwgeGhyID0gbm9kZS54aHIgPSBhamF4KG5vZGUudXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKHhockRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgICAgICB4aHJEZm8ucHJvbWlzZS50aGVuKHN0YXR1c0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB3aGVuUXVldWUucHVzaCh4aHIpOwogICAgICAgICAgICAgICAgICAgIHdoZW4uYWxsKFsKICAgICAgICAgICAgICAgICAgICAgICAgeGhyRGZvLCAKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UKICAgICAgICAgICAgICAgICAgICBdLCB3aGVuLmFwcGx5KGRmby5yZXNvbHZlKSwgd2hlbi5hcHBseShkZm8ucmVqZWN0KSwgdXBkYXRlWEhSSW50ZXJuYWxzKGRmbywgeGhyKSk7CiAgICAgICAgICAgICAgICAgICAgZGZvLnByb2dyZXNzKCdiZWZvcmUtc2VuZCcsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZGZvLCAKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucwogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGFydCwgcXVlcnlJZCwgdHlwZSwgd2hlblF1ZXVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB3aGVuLmFueShbCiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwod2hlblF1ZXVlKSwgCiAgICAgICAgICAgICAgICAgICAgd2hlbi5kZWxheSh0aGF0LmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgICAgICBdLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSwgZGVmZXJDb250cm9sbGVyLnJlc29sdmUpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFJlc3BvbnNlUXVldWU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5SZXNwb25zZVF1ZXVlID0gUmVzcG9uc2VRdWV1ZTsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXJlc3BvbnNlLnF1ZXVlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgd2hlblF1ZXVlID0gW107CiAgICBmdW5jdGlvbiB3YWl0Q2FsbGJhY2sodWlkKSB7CiAgICAgICAgdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgZC5yZXNvbHZlclsndWlkJ10gPSB1aWQ7CiAgICAgICAgd2hlblF1ZXVlLnB1c2goewogICAgICAgICAgICB1aWQ6IHVpZCwKICAgICAgICAgICAgcmVzb2x2ZXI6IGQucmVzb2x2ZXIKICAgICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgaXRlbSA9IF8uZmluZCh3aGVuUXVldWUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB4LnVpZCA9PT0gdWlkOwogICAgICAgIH0pOwogICAgICAgIHdoZW5RdWV1ZSA9IF8ud2l0aG91dCh3aGVuUXVldWUsIGl0ZW0pOwogICAgICAgIGl0ZW0ucmVzb2x2ZXIucmVzb2x2ZSgpOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIC8vIFN1YnNjcmliZSB0byB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS93YWl0Jywgd2FpdENhbGxiYWNrKTsKICAgICAgICAgICAgdGhydXN0LmRhdGEuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS9zdG9wJywgc3RvcENhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIC8vIFVuc3Vic2NyaWJlIGZyb20gdGhlIHdhaXQgYW5kIHN0b3AgZXZlbnRzCiAgICAgICAgICAgIHRocnVzdC5kYXRhLnVuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS93YWl0Jywgd2FpdENhbGxiYWNrKTsKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgICAgICAvLyBkZWZlciB1bnRpbCBhbnkgb2YgdGhlIGV2ZW50cyB0aGF0IHdlcmUgY2FwdHVyZWQgYXJlIHJlc29sdmVkLCBvciB0aGUgZGVsYXkgcGFzc2VzLgogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRocnVzdC5jZmcuZGF0YS5maW5pc2hUaW1lb3V0ID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwod2hlblF1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgd2hlbi5hbGwod2hlblF1ZXVlKSwgCiAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRocnVzdC5jZmcuZGF0YS5maW5pc2hUaW1lb3V0KQogICAgICAgICAgICBdLCBkZWZlci5yZXNvbHZlLCBkZWZlci5yZWplY3QpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC5kb20uY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJywgCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JywgCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9ldmVudCcKICAgIF07Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vc3VianF1ZXJ5JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19qUXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgalF1ZXJ5ID0gX19qUXVlcnlfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBleHRlbmQgPSBfLmV4dGVuZCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgR0xPQkFMID0gJy5nbG9iYWwnOwogICAgdmFyIGpRdWVyeUZuTWV0aG9kQmxhY2tMaXN0ID0gWwogICAgICAgICdyZWFkeScsIAogICAgICAgICdleHRlbmQnLCAKICAgICAgICAncXVldWUnLCAKICAgICAgICAnZGVxdWV1ZScsIAogICAgICAgICdjbGVhclF1ZXVlJywgCiAgICAgICAgJ3Byb21pc2UnLCAKICAgICAgICAnYmluZCcsIAogICAgICAgICd1bmJpbmQnLCAKICAgICAgICAnbGl2ZScsIAogICAgICAgICdkaWUnLCAKICAgICAgICAnZGVsZWdhdGUnLCAKICAgICAgICAndW5kZWxlZ2F0ZScsIAogICAgICAgICdibHVyJywgCiAgICAgICAgJ2ZvY3VzJywgCiAgICAgICAgJ2ZvY3VzaW4nLCAKICAgICAgICAnZm9jdXNvdXQnLCAKICAgICAgICAnbG9hZCcsIAogICAgICAgICdyZXNpemUnLCAKICAgICAgICAnc2Nyb2xsJywgCiAgICAgICAgJ3VubG9hZCcsIAogICAgICAgICdjbGljaycsIAogICAgICAgICdkYmxjbGljaycsIAogICAgICAgICdtb3VzZWRvd24nLCAKICAgICAgICAnbW91c2V1cCcsIAogICAgICAgICdtb3VzZW1vdmUnLCAKICAgICAgICAnbW91c2VvdmVyJywgCiAgICAgICAgJ21vdXNlb3V0JywgCiAgICAgICAgJ21vdXNlZW50ZXInLCAKICAgICAgICAnbW91c2VsZWF2ZScsIAogICAgICAgICdjaGFuZ2UnLCAKICAgICAgICAnc2VsZWN0JywgCiAgICAgICAgJ3N1Ym1pdCcsIAogICAgICAgICdrZXlkb3duJywgCiAgICAgICAgJ2tleXByZXNzJywgCiAgICAgICAgJ2tleXVwJywgCiAgICAgICAgJ2Vycm9yJywgCiAgICAgICAgJ3NlcmlhbGl6ZScsIAogICAgICAgICdzZXJpYWxpemVBcnJheScsIAogICAgICAgICdhamF4U3RhcnQnLCAKICAgICAgICAnYWpheFN0b3AnLCAKICAgICAgICAnYWpheENvbXBsZXRlJywgCiAgICAgICAgJ2FqYXhFcnJvcicsIAogICAgICAgICdhamF4U3VjY2VzcycsIAogICAgICAgICdhamF4U2VuZCcsIAogICAgICAgICdfdG9nZ2xlJywgCiAgICAgICAgJ2ZhZGVUbycsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3NsaWRlRG93bicsIAogICAgICAgICdzbGlkZVVwJywgCiAgICAgICAgJ3NsaWRlVG9nZ2xlJywgCiAgICAgICAgJ2ZhZGVJbicsIAogICAgICAgICdmYWRlT3V0JywgCiAgICAgICAgJ2ZhZGVUb2dnbGUnLyosICdvbicsICdvZmYnLCAnb25lJyovIAogICAgXTsKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIGlmKCFuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgICB9CiAgICAgICAgaWYoaXNPYmplY3QoZXZlbnRzKSkgewogICAgICAgICAgICAvLyBDcmVhdGUgbmV3IG9iamVjdCwgc28gdGhhdCBvcmlnaW5hbCBvYmplY3Qgd2lsbCBub3QgYmUgbW9kaWZpZWQgd2hlbiBiaW5kaW5nLgogICAgICAgICAgICBldmVudHMgPSBleHRlbmQoewogICAgICAgICAgICB9LCBldmVudHMpOwogICAgICAgICAgICBmb3IodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICAgICAgICAgIGlmKGtleS5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRzW2tleSArIG5hbWVzcGFjZV0gPSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZighZXZlbnRzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cy5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGV2dCA9IGV2ZW50c1tpXTsKICAgICAgICAgICAgICAgIGlmKGV2dC5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRzW2ldID0gZXZ0ICsgbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBldmVudHMuam9pbignICcpOwogICAgICAgIH0KICAgIH0KICAgIC8qCiAgICBDbG9uZSBqcXVlcnkKICAgIFJlbW92ZSBhbGwgZXhjZXNzIG1ldGhvZHMgd2UgZG9uJ3Qgd2FudCB0byBleHBvc2UgbmF0aXZlbHkuCiAgICBvdmVycmxvYWQgYW55IG1ldGhvZHMgd2Ugd2FudCB0byBjaGFuZ2UgYmVoYXZpb3Igb2YgKG5vdGVhYmx5IG9uLCBvbmUsIGFuZCBvZmYpCiAgICAKICAgIEluc3RlYWQgb2YgZHVwbGljYXRpbmcgdGhlIGpxdWVyeSBiZWhhdmlvciB3ZSBpbnN0ZWFkIHJlYWxpZ24gaXQgdG8gb3VyIG93bi4KICAgICovCiAgICAvLyBqUXVlcnkgc3ViCiAgICBmdW5jdGlvbiBzdWJKUXVlcnkoKSB7CiAgICAgICAgdmFyIHRRdWVyeSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdFF1ZXJ5LnByb3RvdHlwZS5pbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UgfHwgKHRoaXMgJiYgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICB9OwogICAgICAgIF8ubWVyZ2UodFF1ZXJ5LCBqUXVlcnkpOwogICAgICAgIC8vIERvIG5vdCBsaWtlCiAgICAgICAgLy8gcHJvYmFibHkgbmVlZGVkIGluIHNvbWUgc3BlY2lhbCB1bmlxdWUgY2FzZXMKICAgICAgICB0UXVlcnkualF1ZXJ5ID0galF1ZXJ5OwogICAgICAgIC8vIGV4cG9zZSBldmVudHMgZm9yIGRvaW5nIHNwZWNpYWwgZXZlbnRzIGFzIHJlcXVpcmVkLgogICAgICAgIHRRdWVyeS5ldmVudCA9IChqUXVlcnkpLmV2ZW50OwogICAgICAgIHRRdWVyeS5mbiA9IHRRdWVyeS5wcm90b3R5cGUgPSBleHRlbmQoewogICAgICAgIH0sIGpRdWVyeS5mbik7CiAgICAgICAgdFF1ZXJ5LmZuLmNvbnN0cnVjdG9yID0gdFF1ZXJ5OwogICAgICAgIHRRdWVyeS5mbi5pbml0ID0gZnVuY3Rpb24gaW5pdChzZWxlY3RvciwgY29udGV4dCwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHZhciBpb0RvbSA9IGNvbnRleHQgaW5zdGFuY2VvZiB0UXVlcnk7CiAgICAgICAgICAgIGlmKGNvbnRleHQgJiYgY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSAmJiAhKGlvRG9tKSkgewogICAgICAgICAgICAgICAgY29udGV4dCA9IHRRdWVyeShjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0ID0galF1ZXJ5LmZuLmluaXQuY2FsbCh0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgdFF1ZXJ5Um9vdCk7CiAgICAgICAgICAgIGlmKG5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgcmVzdWx0Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKICAgICAgICAgICAgfSBlbHNlIGlmKGlvRG9tKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gY29udGV4dC5uYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICAgIHRRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IHRRdWVyeS5mbjsKICAgICAgICB2YXIgdFF1ZXJ5Um9vdCA9IHRRdWVyeShkb2N1bWVudCk7CiAgICAgICAgLy8gcmVtb3ZlIGFsbCBub3QgYXBwbGljYWJsZSBtZXRob2RzIG9mZiBvZiBmbi4KICAgICAgICBlYWNoKGpRdWVyeUZuTWV0aG9kQmxhY2tMaXN0LCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBpZih0UXVlcnkuZm5beF0pIHsKICAgICAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IG51bGw7CiAgICAgICAgICAgICAgICBkZWxldGUgdFF1ZXJ5LmZuW3hdOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgXy5lYWNoKFsKICAgICAgICAgICAgJ29uJywgCiAgICAgICAgICAgICdvbmUnLCAKICAgICAgICAgICAgJ29mZicKICAgICAgICBdLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICB0UXVlcnkuZm5beF0gPSBfLndyYXAodFF1ZXJ5LmZuW3hdLCBmdW5jdGlvbiAoZikgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7Ci8vIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2Mi4yLjAKLy8gKGMpIFN0ZXZlbiBTYW5kZXJzb24gLSBodHRwOi8va25vY2tvdXRqcy5jb20vCi8vIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgooZnVuY3Rpb24oKXsKdmFyIERFQlVHPXRydWU7CihmdW5jdGlvbih3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yLGpRdWVyeSx1bmRlZmluZWQpewohZnVuY3Rpb24oZmFjdG9yeSkgewogICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKICAgIGlmICh0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwogICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwogICAgICAgIGZhY3RvcnkodGFyZ2V0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CiAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCiAgICAgICAgZGVmaW5lKCdrbm9ja291dCcsWydleHBvcnRzJ10sIGZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgICAgICAgZmFjdG9yeSh3aW5kb3dbJ2tvJ10gPSB7fSk7CiAgICB9Cn0oZnVuY3Rpb24oa29FeHBvcnRzKXsKLy8gSW50ZXJuYWxseSwgYWxsIEtPIG9iamVjdHMgYXJlIGF0dGFjaGVkIHRvIGtvRXhwb3J0cyAoZXZlbiB0aGUgbm9uLWV4cG9ydGVkIG9uZXMgd2hvc2UgbmFtZXMgd2lsbCBiZSBtaW5pZmllZCBieSB0aGUgY2xvc3VyZSBjb21waWxlcikuCi8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCnZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307Ci8vIEdvb2dsZSBDbG9zdXJlIENvbXBpbGVyIGhlbHBlcnMgKHVzZWQgb25seSB0byBtYWtlIHRoZSBtaW5pZmllZCBmaWxlIHNtYWxsZXIpCmtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7Cgl2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJLy8gSW4gdGhlIGZ1dHVyZSwgImtvIiBtYXkgYmVjb21lIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgKHNvIHRoYXQgbm9uLWV4cG9ydGVkIG9iamVjdHMgYXJlIG5vdCByZWFjaGFibGUpCgkvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJdmFyIHRhcmdldCA9IGtvOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aCAtIDE7IGkrKykKCQl0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCXRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKfTsKa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CiAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cn07CmtvLnZlcnNpb24gPSAiMi4yLjAiOwoKa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7CmtvLnV0aWxzID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyaW5nVHJpbVJlZ2V4ID0gL14oXHN8XHUwMEEwKSt8KFxzfFx1MDBBMCkrJC9nOwoKICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCiAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKICAgIHZhciBrZXlFdmVudFR5cGVOYW1lID0gL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpID8gJ0tleWJvYXJkRXZlbnQnIDogJ1VJRXZlbnRzJzsKICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CiAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBrbm93bkV2ZW50cykgewogICAgICAgIHZhciBrbm93bkV2ZW50c0ZvclR5cGUgPSBrbm93bkV2ZW50c1tldmVudFR5cGVdOwogICAgICAgIGlmIChrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CiAgICAgICAgfQogICAgfQogICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCiAgICAvLyBOb3RlIHRoYXQsIHNpbmNlIElFIDEwIGRvZXMgbm90IHN1cHBvcnQgY29uZGl0aW9uYWwgY29tbWVudHMsIHRoZSBmb2xsb3dpbmcgbG9naWMgb25seSBkZXRlY3RzIElFIDwgMTAuCiAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgogICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgogICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAogICAgICAgIHdoaWxlICgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAogICAgICAgICAgICBpRWxlbXNbMF0KICAgICAgICApOwogICAgICAgIHJldHVybiB2ZXJzaW9uID4gNCA/IHZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICB9KCkpOwogICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAogICAgICAgIGlzSWU3ID0gaWVWZXJzaW9uID09PSA3OwoKICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZXZlbnRUeXBlLnRvTG93ZXJDYXNlKCkgIT0gImNsaWNrIikgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgogICAgICAgIGFycmF5Rm9yRWFjaDogZnVuY3Rpb24gKGFycmF5LCBhY3Rpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0pOwogICAgICAgIH0sCgogICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpcnN0OiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSwgcHJlZGljYXRlT3duZXIpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbaV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIGFycmF5UmVtb3ZlSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtVG9SZW1vdmUpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlHZXREaXN0aW5jdFZhbHVlczogZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGFycmF5TWFwOiBmdW5jdGlvbiAoYXJyYXksIG1hcHBpbmcpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0pKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVB1c2hBbGw6IGZ1bmN0aW9uIChhcnJheSwgdmFsdWVzVG9QdXNoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9LAoKICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgICAgICAgIHdoaWxlIChkb21Ob2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRoZSB1bmRlcmx5aW5nIGNvbGxlY3Rpb24gdG8gY2hhbmdlIHdoaWxlIHdlJ3JlIGRvaW5nIHRoYXQuCiAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjsKICAgICAgICB9LAoKICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoLCBuZXdOb2Rlc0FycmF5ID0gW107IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwogICAgICAgIH0sCgogICAgICAgIHNldERvbU5vZGVDaGlsZHJlbjogZnVuY3Rpb24gKGRvbU5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CiAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CiAgICAgICAgICAgIGlmIChub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbmV3Tm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShub2Rlc1RvUmVwbGFjZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZTogZnVuY3Rpb24gKG9wdGlvbk5vZGUsIGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKICAgICAgICAgICAgICAgIG9wdGlvbk5vZGUuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIGlzU2VsZWN0ZWQpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nIHx8ICIiKS5yZXBsYWNlKHN0cmluZ1RyaW1SZWdleCwgIiIpOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1Rva2VuaXplOiBmdW5jdGlvbiAoc3RyaW5nLCBkZWxpbWl0ZXIpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gKHN0cmluZyB8fCAiIikuc3BsaXQoZGVsaW1pdGVyKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB0b2tlbnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJpbW1lZCA9IGtvLnV0aWxzLnN0cmluZ1RyaW0odG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgIGlmICh0cmltbWVkICE9PSAiIikKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0cmltbWVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nIHx8ICIiOwogICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZygwLCBzdGFydHNXaXRoLmxlbmd0aCkgPT09IHN0YXJ0c1dpdGg7CiAgICAgICAgfSwKCiAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKICAgICAgICAgICAgICAgIHJldHVybiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpID09IDE2OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb250YWluZWRCeU5vZGUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlSXNDb250YWluZWRCeShub2RlLCBub2RlLm93bmVyRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCiAgICAgICAgICAgIC8vIFBvc3NpYmxlIGZ1dHVyZSBvcHRpbWl6YXRpb246IElmIHdlIGtub3cgaXQncyBhbiBlbGVtZW50IGZyb20gYW4gWEhUTUwgZG9jdW1lbnQgKG5vdCBIVE1MKSwKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwogICAgICAgICAgICBpZiAoIW11c3RVc2VBdHRhY2hFdmVudCAmJiB0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzLCBqUXVlcnkgaW50ZXJmZXJlcyB3aXRoIHRoZSBldmVudCBoYW5kbGluZyBpbiBhbiBhd2t3YXJkIHdheToKICAgICAgICAgICAgICAgICAgICAvLyBpdCB0b2dnbGVzIHRoZSBlbGVtZW50IGNoZWNrZWQgc3RhdGUgKmFmdGVyKiB0aGUgY2xpY2sgZXZlbnQgaGFuZGxlcnMgcnVuLCB3aGVyZWFzIG5hdGl2ZQogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrIGV2ZW50cyB0b2dnbGUgdGhlIGNoZWNrZWQgc3RhdGUgKmJlZm9yZSogdGhlIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgaW50ZWNlcHRpbmcgdGhlIGhhbmRsZXIgYW5kIGFwcGx5aW5nIHRoZSBjb3JyZWN0IGNoZWNrZWRuZXNzIGJlZm9yZSBpdCBydW5zLgogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEhhbmRsZXIgPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZXZlbnREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZSA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50RGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGV2ZW50RGF0YS5jaGVja2VkU3RhdGVCZWZvcmVFdmVudCAhPT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxIYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZTsgLy8gUmVzdG9yZSB0aGUgc3RhdGUgalF1ZXJ5IGFwcGxpZWQKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWydiaW5kJ10oZXZlbnRUeXBlLCBoYW5kbGVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuYXR0YWNoRXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVsZW1lbnQgbXVzdCBiZSBhIERPTSBub2RlIHdoZW4gY2FsbGluZyB0cmlnZ2VyRXZlbnQiKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgdGhlIGpRdWVyeSAiY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMiIGlzc3VlIGRlc2NyaWJlZCBhYm92ZSBieSBzdG9yaW5nIHRoZSBvcmlnaW5hbCBjaGVja2VkIHN0YXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgZXZlbnREYXRhLnB1c2goeyBjaGVja2VkU3RhdGVCZWZvcmVFdmVudDogZWxlbWVudC5jaGVja2VkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWyd0cmlnZ2VyJ10oZXZlbnRUeXBlLCBldmVudERhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQuZGlzcGF0Y2hFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKICAgICAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5maXJlRXZlbnQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIFVubGlrZSBvdGhlciBicm93c2VycywgSUUgZG9lc24ndCBjaGFuZ2UgdGhlIGNoZWNrZWQgc3RhdGUgb2YgY2hlY2tib3hlcy9yYWRpb2J1dHRvbnMgd2hlbiB5b3UgdHJpZ2dlciB0aGVpciAiY2xpY2siIGV2ZW50CiAgICAgICAgICAgICAgICAvLyBzbyB0byBtYWtlIGl0IGNvbnNpc3RlbnQsIHdlJ2xsIGRvIGl0IG1hbnVhbGx5IGhlcmUKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gZWxlbWVudC5jaGVja2VkICE9PSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0cmlnZ2VyaW5nIGV2ZW50cyIpOwogICAgICAgIH0sCgogICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUucGVlaygpIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CiAgICAgICAgICAgIGlmIChjbGFzc05hbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvW1x3LV0rL2csCiAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goY2xhc3NOYW1lcy5tYXRjaChjc3NDbGFzc05hbWVSZWdleCksIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9mQ2xhc3MgPSBrby51dGlscy5hcnJheUluZGV4T2YoY3VycmVudENsYXNzTmFtZXMsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2ZDbGFzcyA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2hvdWxkSGF2ZUNsYXNzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMuc3BsaWNlKGluZGV4T2ZDbGFzcywgMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZEhhdmVDbGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwogICAgICAgICAgICBpZiAoKHZhbHVlID09PSBudWxsKSB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCkpCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAogICAgICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KICAgICAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2RvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlKV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpbm5lclRleHROb2RlLmRhdGEgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrby51dGlscy5mb3JjZVJlZnJlc2goZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRFbGVtZW50TmFtZTogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE5NwogICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHt9IC8vIEZvciBJRTkgd2l0aCBkb2MgbW9kZSAiSUU5IFN0YW5kYXJkcyIgYW5kIGJyb3dzZXIgbW9kZSAiSUU5IENvbXBhdGliaWxpdHkgVmlldyIKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZvcmNlUmVmcmVzaDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CiAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewogICAgICAgICAgICAgICAgLy8gRm9yIHRleHQgbm9kZXMgYW5kIGNvbW1lbnQgbm9kZXMgKG1vc3QgbGlrZWx5IHZpcnR1YWwgZWxlbWVudHMpLCB3ZSB3aWxsIGhhdmUgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKICAgICAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLnpvb20gPSBlbGVtLnN0eWxlLnpvb207CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBlbnN1cmVTZWxlY3RFbGVtZW50SXNSZW5kZXJlZENvcnJlY3RseTogZnVuY3Rpb24oc2VsZWN0RWxlbWVudCkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQogICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aCA9IG9yaWdpbmFsV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBpc0llNiA6IGlzSWU2LAogICAgICAgIGlzSWU3IDogaXNJZTcsCiAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKICAgICAgICBnZXRGb3JtRmllbGRzOiBmdW5jdGlvbihmb3JtLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgPyBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGQubmFtZSA9PT0gZmllbGROYW1lIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgICAgICB9LAoKICAgICAgICBwYXJzZUpzb246IGZ1bmN0aW9uIChqc29uU3RyaW5nKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICBpZiAoanNvblN0cmluZykgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkpTT04ucGFyc2UoanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvblN0cmluZykpKCk7IC8vIEZhbGxiYWNrIG9uIGxlc3Mgc2FmZSBwYXJzaW5nIGZvciBvbGRlciBicm93c2VycwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgICAgIGlmICgodHlwZW9mIEpTT04gPT0gInVuZGVmaW5lZCIpIHx8ICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgPT0gInVuZGVmaW5lZCIpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBKU09OLnN0cmluZ2lmeSgpLiBTb21lIGJyb3dzZXJzIChlLmcuLCBJRSA8IDgpIGRvbid0IHN1cHBvcnQgaXQgbmF0aXZlbHksIGJ1dCB5b3UgY2FuIG92ZXJjb21lIHRoaXMgYnkgYWRkaW5nIGEgc2NyaXB0IHJlZmVyZW5jZSB0byBqc29uMi5qcywgZG93bmxvYWRhYmxlIGZyb20gaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyIpOwogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKICAgICAgICB9LAoKICAgICAgICBwb3N0SnNvbjogZnVuY3Rpb24gKHVybE9yRm9ybSwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5jbHVkZUZpZWxkcyA9IG9wdGlvbnNbJ2luY2x1ZGVGaWVsZHMnXSB8fCB0aGlzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OwogICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwogICAgICAgICAgICBpZigodHlwZW9mIHVybE9yRm9ybSA9PSAnb2JqZWN0JykgJiYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcih1cmxPckZvcm0pID09PSAiZm9ybSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwogICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmNsdWRlRmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZmllbGRzW2pdLm5hbWVdID0gZmllbGRzW2pdLnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKTsKICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CiAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSB1cmw7CiAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0ga2V5OwogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKICAgICAgICB9CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3V0aWxzJywga28udXRpbHMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5RmlsdGVyJywga28udXRpbHMuYXJyYXlGaWx0ZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5TWFwJywga28udXRpbHMuYXJyYXlNYXApOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5leHRlbmQnLCBrby51dGlscy5leHRlbmQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wZWVrT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyJywga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MnLCBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoKaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewogICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCiAgICAvLyBJbiBjYXNlIHRoZSBicm93c2VyIGRvZXNuJ3QgaW1wbGVtZW50IGl0IG5hdGl2ZWx5LCBwcm92aWRlIGEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbi4gVGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBiYXNlZCBvbiB0aGUgb25lIGluIHByb3RvdHlwZS5qcwogICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICB9Owp9Cgprby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgdW5pcXVlSWQgPSAwOwogICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgdmFyIGRhdGFTdG9yZSA9IHt9OwogICAgcmV0dXJuIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGFsbERhdGFGb3JOb2RlID0ga28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgYWN0dWFsbHkgY3JlYXRlIGEgbmV3IGRvbURhdGEga2V5IGlmIHdlIGFyZSBhY3R1YWxseSBkZWxldGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIHRydWUpOwogICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRBbGw6IGZ1bmN0aW9uIChub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgICAgIHZhciBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB2YXIgaGFzRXhpc3RpbmdEYXRhU3RvcmUgPSBkYXRhU3RvcmVLZXkgJiYgKGRhdGFTdG9yZUtleSAhPT0gIm51bGwiKSAmJiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICAgICAgaWYgKCFoYXNFeGlzdGluZ0RhdGFTdG9yZSkgewogICAgICAgICAgICAgICAgaWYgKCFjcmVhdGVJZk5vdEZvdW5kKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdID0gImtvIiArIHVuaXF1ZUlkKys7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgaWYgKGRhdGFTdG9yZUtleSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwogICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gRXhwb3NpbmcgImRpZCBjbGVhbiIgZmxhZyBwdXJlbHkgc28gc3BlY3MgY2FuIGluZmVyIHdoZXRoZXIgdGhpbmdzIGhhdmUgYmVlbiBjbGVhbmVkIHVwIGFzIGludGVuZGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YScsIGtvLnV0aWxzLmRvbURhdGEpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCmtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIGRvbURhdGFLZXkgPSAiX19rb19kb21Ob2RlRGlzcG9zYWxfXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCiAgICBmdW5jdGlvbiBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICBhbGxEaXNwb3NlQ2FsbGJhY2tzID0gW107CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsRGlzcG9zZUNhbGxiYWNrczsKICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBkb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CiAgICAgICAgLy8gUnVuIGFsbCB0aGUgZGlzcG9zZSBjYWxsYmFja3MKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwogICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzLnNsaWNlKDApOyAvLyBDbG9uZSwgYXMgdGhlIGFycmF5IG1heSBiZSBtb2RpZmllZCBkdXJpbmcgaXRlcmF0aW9uICh0eXBpY2FsbHksIGNhbGxiYWNrcyB3aWxsIHJlbW92ZSB0aGVtc2VsdmVzKQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKICAgICAgICB9CgogICAgICAgIC8vIEFsc28gZXJhc2UgdGhlIERPTSBkYXRhCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5jbGVhcihub2RlKTsKCiAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCiAgICAgICAgLy8gc28gbm90aWZ5IGl0IHRvIHRlYXIgZG93biBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbm9kZSAmIGRlc2NlbmRhbnRzIGhlcmUuCiAgICAgICAgaWYgKCh0eXBlb2YgalF1ZXJ5ID09ICJmdW5jdGlvbiIpICYmICh0eXBlb2YgalF1ZXJ5WydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKICAgICAgICAgICAgalF1ZXJ5WydjbGVhbkRhdGEnXShbbm9kZV0pOwoKICAgICAgICAvLyBBbHNvIGNsZWFyIGFueSBpbW1lZGlhdGUtY2hpbGQgY29tbWVudCBub2RlcywgYXMgdGhlc2Ugd291bGRuJ3QgaGF2ZSBiZWVuIGZvdW5kIGJ5CiAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQogICAgICAgICAgICBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKICAgICAgICB2YXIgY2hpbGQsIG5leHRDaGlsZCA9IG5vZGVXaXRoQ2hpbGRyZW4uZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBjbGVhbk5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQogICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICBjbGVhblNpbmdsZU5vZGUobm9kZSk7CgogICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIGRlc2NlbmRhbnRzIGxpc3QgaW4gY2FzZSBpdCBjaGFuZ2VzIGR1cmluZyBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBkZXNjZW5kYW50cy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgIH0KICAgIH0KfSkoKTsKa28uY2xlYW5Ob2RlID0ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmNsZWFuTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKa28uZXhwb3J0U3ltYm9sKCdyZW1vdmVOb2RlJywga28ucmVtb3ZlTm9kZSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2spOwooZnVuY3Rpb24gKCkgewogICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCiAgICBmdW5jdGlvbiBzaW1wbGVIdG1sUGFyc2UoaHRtbCkgewogICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCiAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgogICAgICAgIC8vIE5vdGUgdGhhdCB0aGVyZSdzIHN0aWxsIGFuIGlzc3VlIGluIElFIDwgOSB3aGVyZWJ5IGl0IHdpbGwgZGlzY2FyZCBjb21tZW50IG5vZGVzIHRoYXQgYXJlIHRoZSBmaXJzdCBjaGlsZCBvZgogICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgogICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQogICAgICAgIC8vIChwb3NzaWJseSBhIHRleHQgbm9kZSkgaW4gZnJvbnQgb2YgdGhlIGNvbW1lbnQuIFNvLCBLTyBkb2VzIG5vdCBhdHRlbXB0IHRvIHdvcmthcm91bmQgdGhpcyBJRSBpc3N1ZSBhdXRvbWF0aWNhbGx5IGF0IHByZXNlbnQuCgogICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAogICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAgICAgLy8gRmluZHMgdGhlIGZpcnN0IG1hdGNoIGZyb20gdGhlIGxlZnQgY29sdW1uLCBhbmQgcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyAid3JhcCIgZGF0YSBmcm9tIHRoZSByaWdodCBjb2x1bW4KICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAoIXRhZ3MuaW5kZXhPZigiPHRkIikgfHwgIXRhZ3MuaW5kZXhPZigiPHRoIikpICAgJiYgWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCiAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhbHdheXMgcHJlZml4IHdpdGggc29tZSBkdW1teSB0ZXh0LCBiZWNhdXNlIG90aGVyd2lzZSwgSUU8OSB3aWxsIHN0cmlwIG91dCBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgaW4gZGVzY2VuZGFudHMuIFRvdGFsIG1hZG5lc3MuCiAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHdpbmRvd1snaW5uZXJTaGl2J10obWFya3VwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCiAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKICAgICAgICAgICAgZGl2ID0gZGl2Lmxhc3RDaGlsZDsKCiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGpRdWVyeUh0bWxQYXJzZShodG1sKSB7CiAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5WydjbGVhbiddKFtodG1sXSk7CgogICAgICAgIC8vIEFzIG9mIGpRdWVyeSAxLjcuMSwgalF1ZXJ5IHBhcnNlcyB0aGUgSFRNTCBieSBhcHBlbmRpbmcgaXQgdG8gc29tZSBkdW1teSBwYXJlbnQgbm9kZXMgaGVsZCBpbiBhbiBpbi1tZW1vcnkgZG9jdW1lbnQgZnJhZ21lbnQuCiAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCiAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCiAgICAgICAgaWYgKGVsZW1zICYmIGVsZW1zWzBdKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CiAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CiAgICAgICAgICAgIHdoaWxlIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5wYXJlbnROb2RlLm5vZGVUeXBlICE9PSAxMSAvKiBpLmUuLCBEb2N1bWVudEZyYWdtZW50ICovKQogICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CiAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWxlbXM7CiAgICB9CgogICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcgPyBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgICAvLyBBcyBiZWxvdywgYmVuZWZpdCBmcm9tIGpRdWVyeSdzIG9wdGltaXNhdGlvbnMgd2hlcmUgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCiAgICB9OwoKICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKICAgICAgICAvLyBUaGVyZSdzIG5vIGxlZ2l0aW1hdGUgcmVhc29uIHRvIGRpc3BsYXkgYSBzdHJpbmdpZmllZCBvYnNlcnZhYmxlIHdpdGhvdXQgdW53cmFwcGluZyBpdCwgc28gd2UnbGwgdW53cmFwIGl0CiAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgogICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sICE9ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAogICAgICAgICAgICAvLyBmb3IgZXhhbXBsZSA8dHI+IGVsZW1lbnRzIHdoaWNoIGFyZSBub3Qgbm9ybWFsbHkgYWxsb3dlZCB0byBleGlzdCBvbiB0aGVpciBvd24uCiAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShub2RlKVsnaHRtbCddKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkTm9kZXMgPSBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7Cgprby5tZW1vaXphdGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb3MgPSB7fTsKCiAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDAwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewogICAgICAgIHJldHVybiByYW5kb21NYXg4SGV4Q2hhcnMoKSArIHJhbmRvbU1heDhIZXhDaGFycygpOwogICAgfQogICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewogICAgICAgIGlmICghcm9vdE5vZGUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewogICAgICAgICAgICB2YXIgbWVtb0lkID0ga28ubWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dChyb290Tm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCiAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBtZW1vaXplOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwogICAgICAgICAgICB2YXIgbWVtb0lkID0gZ2VuZXJhdGVSYW5kb21JZCgpOwogICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CiAgICAgICAgfSwKCiAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBjYWxsYmFja1BhcmFtcyB8fCBbXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsgZGVsZXRlIG1lbW9zW21lbW9JZF07IH0KICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG1lbW9zID0gW107CiAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZW1vc1tpXS5kb21Ob2RlOwogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoY29tYmluZWRQYXJhbXMsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSk7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CiAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwprby5leHRlbmRlcnMgPSB7CiAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgogICAgICAgIC8vICgxKSBGb3IgZGVwZW5kZW50IG9ic2VydmFibGVzLCB3ZSB0aHJvdHRsZSAqZXZhbHVhdGlvbnMqIHNvIHRoYXQsIG5vIG1hdHRlciBob3cgZmFzdCBpdHMgZGVwZW5kZW5jaWVzCiAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCiAgICAgICAgLy8gKDIpIEZvciB3cml0YWJsZSB0YXJnZXRzIChvYnNlcnZhYmxlcywgb3Igd3JpdGFibGUgZGVwZW5kZW50IG9ic2VydmFibGVzKSwgd2UgdGhyb3R0bGUgKndyaXRlcyoKICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHsKICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCiAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod3JpdGVUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CiAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZSB9IC8vIFRyZWF0IGFsbCB2YWx1ZXMgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDoga28ub2JzZXJ2YWJsZVsiZm4iXVsiZXF1YWxpdHlDb21wYXJlciJdOwogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cn07CgpmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgIHZhciB0YXJnZXQgPSB0aGlzOwogICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBleHRlbmRlckhhbmRsZXIodGFyZ2V0LCByZXF1ZXN0ZWRFeHRlbmRlcnNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0Owp9Cgprby5leHBvcnRTeW1ib2woJ2V4dGVuZGVycycsIGtvLmV4dGVuZGVycyk7Cgprby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwp9Owprby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2soKTsKfTsKCmtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBrby51dGlscy5leHRlbmQodGhpcywga28uc3Vic2NyaWJhYmxlWydmbiddKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdzdWJzY3JpYmUnLCB0aGlzLnN1YnNjcmliZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZXh0ZW5kJywgdGhpcy5leHRlbmQpOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIHRoaXMuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKfQoKdmFyIGRlZmF1bHRFdmVudCA9ICJjaGFuZ2UiOwoKa28uc3Vic2NyaWJhYmxlWydmbiddID0gewogICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gbmV3IGtvLnN1YnNjcmlwdGlvbih0aGlzLCBib3VuZENhbGxiYWNrLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKICAgICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdKQogICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwogICAgfSwKCiAgICAibm90aWZ5U3Vic2NyaWJlcnMiOiBmdW5jdGlvbiAodmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pIHsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0uc2xpY2UoMCksIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIGEgc3Vic2NyaXB0aW9uIHdhcyBkaXNwb3NlZCBkdXJpbmcgdGhlIGFycmF5Rm9yRWFjaCBjeWNsZSwgY2hlY2sKICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiAoc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgIT09IHRydWUpKQogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50TmFtZV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG90YWw7CiAgICB9LAoKICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKfTsKCgprby5pc1N1YnNjcmliYWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIHR5cGVvZiBpbnN0YW5jZS5zdWJzY3JpYmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2VbIm5vdGlmeVN1YnNjcmliZXJzIl0gPT0gImZ1bmN0aW9uIjsKfTsKCmtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1N1YnNjcmliYWJsZScsIGtvLmlzU3Vic2NyaWJhYmxlKTsKCmtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIF9mcmFtZXMgPSBbXTsKCiAgICByZXR1cm4gewogICAgICAgIGJlZ2luOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBkaXN0aW5jdERlcGVuZGVuY2llczpbXSB9KTsKICAgICAgICB9LAoKICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckRlcGVuZGVuY3k6IGZ1bmN0aW9uIChzdWJzY3JpYmFibGUpIHsKICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKICAgICAgICAgICAgaWYgKF9mcmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRvcEZyYW1lID0gX2ZyYW1lc1tfZnJhbWVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgaWYgKCF0b3BGcmFtZSB8fCBrby51dGlscy5hcnJheUluZGV4T2YodG9wRnJhbWUuZGlzdGluY3REZXBlbmRlbmNpZXMsIHN1YnNjcmliYWJsZSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcy5wdXNoKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaWdub3JlOiBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CnZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6dHJ1ZSwgJ2Jvb2xlYW4nOnRydWUsICdudW1iZXInOnRydWUsICdzdHJpbmcnOnRydWUgfTsKCmtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlID0gaW5pdGlhbFZhbHVlOwoKICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFdyaXRlCgogICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAogICAgICAgICAgICBpZiAoKCFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10pIHx8ICFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10oX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8gUmVhZAogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQogICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwogICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7IH0KICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CiAgICBrby51dGlscy5leHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlSGFzTXV0YXRlZCIsIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgogICAgcmV0dXJuIG9ic2VydmFibGU7Cn0KCmtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CiAgICAiZXF1YWxpdHlDb21wYXJlciI6IGZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKICAgICAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwogICAgfQp9OwoKdmFyIHByb3RvUHJvcGVydHkgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHkgPSAiX19rb19wcm90b19fIjsKa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7Cgprby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CiAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IHByb3RvdHlwZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KfTsKCmtvLmlzT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cn0Ka28uaXNXcml0ZWFibGVPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAvLyBPYnNlcnZhYmxlCiAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBBbnl0aGluZyBlbHNlCiAgICByZXR1cm4gZmFsc2U7Cn0KCgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwprby5leHBvcnRTeW1ib2woJ2lzV3JpdGVhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7CmtvLm9ic2VydmFibGVBcnJheSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWVzKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgLy8gWmVyby1wYXJhbWV0ZXIgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgdG8gZW1wdHkgYXJyYXkKICAgICAgICBpbml0aWFsVmFsdWVzID0gW107CiAgICB9CiAgICBpZiAoKGluaXRpYWxWYWx1ZXMgIT09IG51bGwpICYmIChpbml0aWFsVmFsdWVzICE9PSB1bmRlZmluZWQpICYmICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKICAgIHZhciByZXN1bHQgPSBrby5vYnNlcnZhYmxlKGluaXRpYWxWYWx1ZXMpOwogICAga28udXRpbHMuZXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCmtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKICAgICdyZW1vdmUnOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwogICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHJlbW92ZWRWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbW92ZWRWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKICAgIH0sCgogICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIHJldHVybiBhbGxWYWx1ZXM7CiAgICAgICAgfQogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdkZXN0cm95JzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheVtpXVsiX2Rlc3Ryb3kiXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICB9LAoKICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CiAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2luZGV4T2YnOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwogICAgfSwKCiAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwovLyBJbXBvcnRhbnQ6IERvIG5vdCBhZGQgYW55IGFkZGl0aW9uYWwgZnVuY3Rpb25zIGhlcmUgdGhhdCBtYXkgcmVhc29uYWJseSBiZSB1c2VkIHRvICpyZWFkKiBkYXRhIGZyb20gdGhlIGFycmF5Ci8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ11bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICB2YXIgbWV0aG9kQ2FsbFJlc3VsdCA9IHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKICAgIH07Cn0pOwoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsic2xpY2UiXSwgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwogICAgfTsKfSk7Cgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7CmtvLmRlcGVuZGVudE9ic2VydmFibGUgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlLAogICAgICAgIF9oYXNCZWVuRXZhbHVhdGVkID0gZmFsc2UsCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICByZWFkRnVuY3Rpb24gPSBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9uczsKCiAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKICAgICAgICAvLyBTaW5nbGUtcGFyYW1ldGVyIHN5bnRheCAtIGV2ZXJ5dGhpbmcgaXMgb24gdGhpcyAib3B0aW9ucyIgcGFyYW0KICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwogICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoIXJlYWRGdW5jdGlvbikKICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfQogICAgaWYgKHR5cGVvZiByZWFkRnVuY3Rpb24gIT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpIHsKICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdOwogICAgfQoKICAgIGZ1bmN0aW9uIGV2YWx1YXRlUG9zc2libHlBc3luYygpIHsKICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwogICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZSgpIHsKICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgZGVzaXJhYmxlIChpdCdzIGhhcmQgZm9yIGEgZGV2ZWxvcGVyIHRvIHJlYWxpc2UgYSBjaGFpbiBvZiBkZXBlbmRlbmNpZXMgbWlnaHQgY2F1c2UgdGhpcywgYW5kIHRoZXkgYWxtb3N0CiAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwogICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBkaXNwb3NlIG9uIGZpcnN0IGV2YWx1YXRpb24sIGJlY2F1c2UgdGhlICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgbWlnaHQKICAgICAgICAvLyBlLmcuLCBkaXNwb3NlIHdoZW4gdGhlIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgaXNuJ3QgaW4gdGhlIGRvYywgYW5kIGl0J3Mgbm90CiAgICAgICAgLy8gZ29pbmcgdG8gYmUgaW4gdGhlIGRvYyB1bnRpbCAqYWZ0ZXIqIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgaWYgKF9oYXNCZWVuRXZhbHVhdGVkICYmIGRpc3Bvc2VXaGVuKCkpIHsKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSW5pdGlhbGx5LCB3ZSBhc3N1bWUgdGhhdCBub25lIG9mIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBzdGlsbCBiZWluZyB1c2VkIChpLmUuLCBhbGwgYXJlIGNhbmRpZGF0ZXMgZm9yIGRpc3Bvc2FsKS4KICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgogICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0ga28udXRpbHMuYXJyYXlNYXAoX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24oaXRlbSkge3JldHVybiBpdGVtLnRhcmdldDt9KTsKCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oZnVuY3Rpb24oc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5PbGQ7CiAgICAgICAgICAgICAgICBpZiAoKGluT2xkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGRpc3Bvc2FsQ2FuZGlkYXRlcywgc3Vic2NyaWJhYmxlKSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICBkaXNwb3NhbENhbmRpZGF0ZXNbaW5PbGRdID0gdW5kZWZpbmVkOyAvLyBEb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhpcyBzdWJzY3JpcHRpb24sIGFzIGl0J3Mgc3RpbGwgYmVpbmcgdXNlZAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpOyAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc3Vic2NyaXB0aW9uIG5vIGxvbmdlciBiZWluZyB1c2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgYWN0aXZlIHN1YnNjcmlwdGlvbnMgbGlzdCBhbmQgZGlzcG9zZSBpdAogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcG9zYWxDYW5kaWRhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDYW5kaWRhdGVzW2ldKQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpWzBdLmRpc3Bvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfaGFzQmVlbkV2YWx1YXRlZCA9IHRydWU7CgogICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwogICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKERFQlVHKSBkZXBlbmRlbnRPYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOwogICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CiAgICAgICAgaWYgKCFfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLmxlbmd0aCkKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlcGVuZGVudE9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgLy8gV3JpdGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd3JpdGUgYSB2YWx1ZSB0byBhIGtvLmNvbXB1dGVkIHVubGVzcyB5b3Ugc3BlY2lmeSBhICd3cml0ZScgb3B0aW9uLiBJZiB5b3Ugd2lzaCB0byByZWFkIHRoZSBjdXJyZW50IHZhbHVlLCBkb24ndCBwYXNzIGFueSBwYXJhbWV0ZXJzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAoIV9oYXNCZWVuRXZhbHVhdGVkKQogICAgICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHBlZWsoKSB7CiAgICAgICAgaWYgKCFfaGFzQmVlbkV2YWx1YXRlZCkKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgIHJldHVybiAhX2hhc0JlZW5FdmFsdWF0ZWQgfHwgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGggPiAwOwogICAgfQoKICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKICAgICAgICBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgPSBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB8fCBudWxsLAogICAgICAgIGRpc3Bvc2VXaGVuID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgICAgICAgZGlzcG9zZSA9IGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsCiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdLAogICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCiAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPSBvcHRpb25zWyJvd25lciJdOwoKICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGg7IH07CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSA9IGlzQWN0aXZlOwoKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwogICAga28udXRpbHMuZXh0ZW5kKGRlcGVuZGVudE9ic2VydmFibGUsIGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdwZWVrJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwogICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2dldERlcGVuZGVuY2llc0NvdW50JywgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCk7CgogICAgLy8gRXZhbHVhdGUsIHVubGVzcyBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQogICAgaWYgKG9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddICE9PSB0cnVlKQogICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgogICAgLy8gQnVpbGQgImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgYW5kICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWRDYWxsYmFjayIgb3B0aW9uIHZhbHVlcy4KICAgIC8vIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCiAgICAvLyAoTm90ZTogImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgb3B0aW9uIGJvdGggcHJvYWN0aXZlbHkgZGlzcG9zZXMgYXMgc29vbiBhcyB0aGUgbm9kZSBpcyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUoKSwKICAgIC8vIHBsdXMgYWRkcyBhICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgdGhhdCwgb24gZWFjaCBldmFsdWF0aW9uLCBkaXNwb3NlcyBpZiB0aGUgbm9kZSB3YXMgcmVtb3ZlZCBieSBzb21lIG90aGVyIG1lYW5zLikKICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgJiYgaXNBY3RpdmUoKSkgewogICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbiA9IGRpc3Bvc2VXaGVuOwogICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKfTsKCmtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cn07Cgp2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgprby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSA9IHt9Owprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKa28uZXhwb3J0U3ltYm9sKCdpc0NvbXB1dGVkJywga28uaXNDb21wdXRlZCk7CgooZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF4TmVzdGVkT2JzZXJ2YWJsZURlcHRoID0gMTA7IC8vIEVzY2FwZSB0aGUgKHVubGlrZWx5KSBwYXRoYWxvZ2ljYWwgY2FzZSB3aGVyZSBhbiBvYnNlcnZhYmxlJ3MgY3VycmVudCB2YWx1ZSBpcyBpdHNlbGYgKG9yIHNpbWlsYXIgcmVmZXJlbmNlIGN5Y2xlKQoKICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaGVuIGNhbGxpbmcga28udG9KUywgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IHRvIGNvbnZlcnQuIik7CgogICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAogICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKICAgICAgICAgICAgLy8gTG9vcCBiZWNhdXNlIGFuIG9ic2VydmFibGUncyB2YWx1ZSBtaWdodCBpbiB0dXJuIGJlIGFub3RoZXIgb2JzZXJ2YWJsZSB3cmFwcGVyCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCiAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwogICAgICAgICAgICByZXR1cm4gdmFsdWVUb01hcDsKICAgICAgICB9KTsKICAgIH07CgogICAga28udG9KU09OID0gZnVuY3Rpb24ocm9vdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwogICAgfTsKCiAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CiAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgogICAgICAgIHJvb3RPYmplY3QgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3QpOwogICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSk7CiAgICAgICAgaWYgKCFjYW5IYXZlUHJvcGVydGllcykKICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgogICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKICAgICAgICB2aXNpdGVkT2JqZWN0cy5zYXZlKHJvb3RPYmplY3QsIG91dHB1dFByb3BlcnRpZXMpOwoKICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseU1hcHBlZFZhbHVlID0gdmlzaXRlZE9iamVjdHMuZ2V0KHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogbWFwSnNPYmplY3RHcmFwaChwcm9wZXJ0eVZhbHVlLCBtYXBJbnB1dENhbGxiYWNrLCB2aXNpdGVkT2JqZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaXRQcm9wZXJ0aWVzT3JBcnJheUVudHJpZXMocm9vdE9iamVjdCwgdmlzaXRvckNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soaSk7CgogICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCiAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjaygndG9KU09OJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKICAgICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICB0aGlzLnNhdmUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtleXMsIGtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgICAgICB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgcmV0dXJuIChleGlzdGluZ0luZGV4ID49IDApID8gdmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7CmtvLmV4cG9ydFN5bWJvbCgndG9KU09OJywga28udG9KU09OKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCiAgICAvLyBOb3JtYWxseSwgU0VMRUNUIGVsZW1lbnRzIGFuZCB0aGVpciBPUFRJT05zIGNhbiBvbmx5IHRha2UgdmFsdWUgb2YgdHlwZSAnc3RyaW5nJyAoYmVjYXVzZSB0aGUgdmFsdWVzCiAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCiAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMgPSB7CiAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmllVmVyc2lvbiA8PSA3CiAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICA6IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tpXSkgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUpOwprby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCA9IC9cQGtvX3Rva2VuXyhcZCspXEAvZzsKICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSJdOwoKICAgIC8vIE1hdGNoZXMgc29tZXRoaW5nIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvLS1laXRoZXIgYW4gaXNvbGF0ZWQgaWRlbnRpZmllciBvciBzb21ldGhpbmcgZW5kaW5nIHdpdGggYSBwcm9wZXJ0eSBhY2Nlc3NvcgogICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCiAgICB2YXIgamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQgPSAvXig/OlskX2Etel1bJFx3XSp8KC4rKShcLlxzKlskX2Etel1bJFx3XSp8XFsuK1xdKSkkL2k7CgogICAgZnVuY3Rpb24gcmVzdG9yZVRva2VucyhzdHJpbmcsIHRva2VucykgewogICAgICAgIHZhciBwcmV2VmFsdWUgPSBudWxsOwogICAgICAgIHdoaWxlIChzdHJpbmcgIT0gcHJldlZhbHVlKSB7IC8vIEtlZXAgcmVzdG9yaW5nIHRva2VucyB1bnRpbCBpdCBubyBsb25nZXIgbWFrZXMgYSBkaWZmZXJlbmNlICh0aGV5IG1heSBiZSBuZXN0ZWQpCiAgICAgICAgICAgIHByZXZWYWx1ZSA9IHN0cmluZzsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVzdG9yZUNhcHR1cmVkVG9rZW5zUmVnZXgsIGZ1bmN0aW9uIChtYXRjaCwgdG9rZW5JbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1t0b2tlbkluZGV4XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewogICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGtvLnV0aWxzLnN0cmluZ1RyaW0oZXhwcmVzc2lvbikudG9Mb3dlckNhc2UoKSkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwogICAgICAgIHJldHVybiBtYXRjaCA9PT0gbnVsbCA/IGZhbHNlIDogbWF0Y2hbMV0gPyAoJ09iamVjdCgnICsgbWF0Y2hbMV0gKyAnKScgKyBtYXRjaFsyXSkgOiBleHByZXNzaW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGVuc3VyZVF1b3RlZChrZXkpIHsKICAgICAgICB2YXIgdHJpbW1lZEtleSA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5KTsKICAgICAgICBzd2l0Y2ggKHRyaW1tZWRLZXkubGVuZ3RoICYmIHRyaW1tZWRLZXkuY2hhckF0KDApKSB7CiAgICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIiciICsgdHJpbW1lZEtleSArICInIjsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IGZ1bmN0aW9uKG9iamVjdExpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgLy8gQSBmdWxsIHRva2VuaXNlcitsZXhlciB3b3VsZCBhZGQgdG9vIG11Y2ggd2VpZ2h0IHRvIHRoaXMgbGlicmFyeSwgc28gaGVyZSdzIGEgc2ltcGxlIHBhcnNlcgogICAgICAgICAgICAvLyB0aGF0IGlzIHN1ZmZpY2llbnQganVzdCB0byBzcGxpdCBhbiBvYmplY3QgbGl0ZXJhbCBzdHJpbmcgaW50byBhIHNldCBvZiB0b3AtbGV2ZWwga2V5LXZhbHVlIHBhaXJzCgogICAgICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPCAzKQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICBpZiAoc3RyLmNoYXJBdCgwKSA9PT0gInsiKS8vIElnbm9yZSBhbnkgYnJhY2VzIHN1cnJvdW5kaW5nIHRoZSB3aG9sZSBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygxLCBzdHIubGVuZ3RoIC0gMSk7CgogICAgICAgICAgICAvLyBQdWxsIG91dCBhbnkgc3RyaW5nIGxpdGVyYWxzIGFuZCByZWdleCBsaXRlcmFscwogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHZhciB0b2tlblN0YXJ0ID0gbnVsbCwgdG9rZW5FbmRDaGFyOwogICAgICAgICAgICBmb3IgKHZhciBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgc3RyLmxlbmd0aDsgcG9zaXRpb24rKykgewogICAgICAgICAgICAgICAgdmFyIGMgPSBzdHIuY2hhckF0KHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlblN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICInIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYyA9PSB0b2tlbkVuZENoYXIpICYmIChzdHIuY2hhckF0KHBvc2l0aW9uIC0gMSkgIT09ICJcXCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gc3RyLnN1YnN0cmluZyh0b2tlblN0YXJ0LCBwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSAiQGtvX3Rva2VuXyIgKyAodG9rZW5zLmxlbmd0aCAtIDEpICsgIkAiOwogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgdG9rZW5TdGFydCkgKyByZXBsYWNlbWVudCArIHN0ci5zdWJzdHJpbmcocG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTmV4dCBwdWxsIG91dCBiYWxhbmNlZCBwYXJlbiwgYnJhY2UsIGFuZCBicmFja2V0IGJsb2NrcwogICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRva2VuRGVwdGggPSAwLCB0b2tlblN0YXJ0Q2hhciA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIHBvc2l0aW9uID0gMDsgcG9zaXRpb24gPCBzdHIubGVuZ3RoOyBwb3NpdGlvbisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQXQocG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuU3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAieyI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIn0iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIigiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICIpIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJbIjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAiXSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGMgPT09IHRva2VuU3RhcnRDaGFyKQogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgrKzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IHRva2VuRW5kQ2hhcikgewogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5EZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBzdHIuc3Vic3RyaW5nKHRva2VuU3RhcnQsIHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gIkBrb190b2tlbl8iICsgKHRva2Vucy5sZW5ndGggLSAxKSArICJAIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCB0b2tlblN0YXJ0KSArIHJlcGxhY2VtZW50ICsgc3RyLnN1YnN0cmluZyhwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3cgd2UgY2FuIHNhZmVseSBzcGxpdCBvbiBjb21tYXMgdG8gZ2V0IHRoZSBrZXkvdmFsdWUgcGFpcnMKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIga2V5VmFsdWVQYWlycyA9IHN0ci5zcGxpdCgiLCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGtleVZhbHVlUGFpcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IGtleVZhbHVlUGFpcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgY29sb25Qb3MgPSBwYWlyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgIGlmICgoY29sb25Qb3MgPiAwKSAmJiAoY29sb25Qb3MgPCBwYWlyLmxlbmd0aCAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHBhaXIuc3Vic3RyaW5nKDAsIGNvbG9uUG9zKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYWlyLnN1YnN0cmluZyhjb2xvblBvcyArIDEpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgJ2tleSc6IHJlc3RvcmVUb2tlbnMoa2V5LCB0b2tlbnMpLCAndmFsdWUnOiByZXN0b3JlVG9rZW5zKHZhbHVlLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7ICd1bmtub3duJzogcmVzdG9yZVRva2VucyhwYWlyLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgcHJlUHJvY2Vzc0JpbmRpbmdzOiBmdW5jdGlvbiAob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5ID09PSAic3RyaW5nIgogICAgICAgICAgICAgICAgPyBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KQogICAgICAgICAgICAgICAgOiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5OwogICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5ncyA9IFtdLCBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdOwoKICAgICAgICAgICAgdmFyIGtleVZhbHVlRW50cnk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrZXlWYWx1ZUVudHJ5ID0ga2V5VmFsdWVBcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiLCIpOwoKICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZUVudHJ5WydrZXknXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdW90ZWRLZXkgPSBlbnN1cmVRdW90ZWQoa2V5VmFsdWVFbnRyeVsna2V5J10pLCB2YWwgPSBrZXlWYWx1ZUVudHJ5Wyd2YWx1ZSddOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiOiIpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUoa28udXRpbHMuc3RyaW5nVHJpbSh2YWwpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2goIiwgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5ICsgIiA6IGZ1bmN0aW9uKF9fa29fdmFsdWUpIHsgIiArIHZhbCArICIgPSBfX2tvX3ZhbHVlOyB9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goa2V5VmFsdWVFbnRyeVsndW5rbm93biddKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbWJpbmVkUmVzdWx0ID0gcmVzdWx0U3RyaW5ncy5qb2luKCIiKTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBhbGxQcm9wZXJ0eUFjY2Vzc29ycyA9IHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgY29tYmluZWRSZXN1bHQgPSBjb21iaW5lZFJlc3VsdCArICIsICdfa29fcHJvcGVydHlfd3JpdGVycycgOiB7ICIgKyBhbGxQcm9wZXJ0eUFjY2Vzc29ycyArICIgfSAiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tYmluZWRSZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5VmFsdWVBcnJheVtpXVsna2V5J10pID09IGtleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKICAgICAgICAvLyBwcm9wZXJ0eTogICAgICAgICAgICBJZiB0aGUgcHJvcGVydHkgYmVpbmcgdXBkYXRlZCBpcyAob3IgbWlnaHQgYmUpIGFuIG9ic2VydmFibGUsIHBhc3MgaXQgaGVyZQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQogICAgICAgIC8vIGFsbEJpbmRpbmdzQWNjZXNzb3I6IEFsbCBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICBUaGlzIHdpbGwgYmUgc2VhcmNoZWQgZm9yIGEgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyBwcm9wZXJ0eSBpbiBjYXNlIHlvdSdyZSB3cml0aW5nIHRvIGEgbm9uLW9ic2VydmFibGUKICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICAgIC8vIGNoZWNrSWZEaWZmZXJlbnQ6ICAgIElmIHRydWUsIGFuZCBpZiB0aGUgcHJvcGVydHkgYmVpbmcgd3JpdHRlbiBpcyBhIHdyaXRhYmxlIG9ic2VydmFibGUsIHRoZSB2YWx1ZSB3aWxsIG9ubHkgYmUgd3JpdHRlbiBpZgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIGtleSwgdmFsdWUsIGNoZWNrSWZEaWZmZXJlbnQpIHsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWydfa29fcHJvcGVydHlfd3JpdGVycyddOwogICAgICAgICAgICAgICAgaWYgKHByb3BXcml0ZXJzICYmIHByb3BXcml0ZXJzW2tleV0pCiAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOwoKLy8gRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGRlZmluZSB0aGUgZm9sbG93aW5nIGFsaWFzZXMuIChQcmV2aW91c2x5LCB0aGVzZSBmdW5jdGlvbiBuYW1lcyB3ZXJlIG1pc2xlYWRpbmcgYmVjYXVzZQovLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOyhmdW5jdGlvbigpIHsKICAgIC8vICJWaXJ0dWFsIGVsZW1lbnRzIiBpcyBhbiBhYnN0cmFjdGlvbiBvbiB0b3Agb2YgdGhlIHVzdWFsIERPTSBBUEkgd2hpY2ggdW5kZXJzdGFuZHMgdGhlIG5vdGlvbiB0aGF0IGNvbW1lbnQgbm9kZXMKICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCiAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQogICAgLy8gb2YgdGhhdCB2aXJ0dWFsIGhpZXJhcmNoeQogICAgLy8KICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHNjYXR0ZXIgc3BlY2lhbCBjYXNlcyBhbGwgb3ZlciB0aGUgYmluZGluZyBhbmQgdGVtcGxhdGluZyBjb2RlLgoKICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCiAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KICAgIC8vIFNvLCB1c2Ugbm9kZS50ZXh0IHdoZXJlIGF2YWlsYWJsZSwgYW5kIG5vZGUubm9kZVZhbHVlIGVsc2V3aGVyZQogICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCiAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyokLzsKICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgogICAgZnVuY3Rpb24gaXNTdGFydENvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFbmRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goZW5kQ29tbWVudFJlZ2V4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CiAgICAgICAgdmFyIGRlcHRoID0gMTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgfQogICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIGNsb3NpbmcgY29tbWVudCB0YWcgdG8gbWF0Y2g6ICIgKyBzdGFydENvbW1lbnQubm9kZVZhbHVlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaGluZ0VuZENvbW1lbnQoc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChhbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKG5vZGUpIHsKICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgogICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CiAgICAgICAgdmFyIGNoaWxkTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCwgY2FwdHVyZVJlbWFpbmluZyA9IG51bGw7CiAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZVJlbWFpbmluZykgICAgICAgICAgICAgICAgICAgLy8gV2UgYWxyZWFkeSBoaXQgYW4gdW5iYWxhbmNlZCBub2RlIGFuZCBhcmUgbm93IGp1c3Qgc2Nvb3BpbmcgdXAgYWxsIHN1YnNlcXVlbnQgbm9kZXMKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdFbmRDb21tZW50ID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KGNoaWxkTm9kZSwgLyogYWxsb3dVbmJhbGFuY2VkOiAqLyB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgICAgIC8vIEl0J3MgdW5iYWxhbmNlZCAoaWYgaXQgd2Fzbid0LCB3ZSdkIGhhdmUgc2tpcHBlZCBvdmVyIGl0IGFscmVhZHkpLCBzbyBzdGFydCBjYXB0dXJpbmcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CiAgICB9CgogICAga28udmlydHVhbEVsZW1lbnRzID0gewogICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgogICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzU3RhcnRDb21tZW50KG5vZGUpID8gZ2V0VmlydHVhbENoaWxkcmVuKG5vZGUpIDogbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsQ2hpbGRyZW4gPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2Rlcyhub2RlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGVuZENvbW1lbnROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkTm9kZXNbaV0sIGVuZENvbW1lbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb1ByZXBlbmQpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9QcmVwZW5kLCBjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAvLyBJbnNlcnQgYWZ0ZXIgaW5zZXJ0aW9uIHBvaW50CiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDaGlsZHJlbiBvZiBzdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9LAoKICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSwKCiAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSBpc1N0YXJ0Q29tbWVudChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZTogZnVuY3Rpb24oZWxlbWVudFZlcmlmaWVkKSB7CiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CiAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwogICAgICAgICAgICAvLyB0aGF0IGFyZSBkaXJlY3QgZGVzY2VuZGFudHMgb2YgPHVsPiBpbnRvIHRoZSBwcmVjZWRpbmcgPGxpPikKICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNjYW4gaW1tZWRpYXRlIGNoaWxkcmVuIHRvIHNlZSBpZiB0aGV5IGNvbnRhaW4gdW5iYWxhbmNlZCBjb21tZW50IHRhZ3MuIElmIHRoZXkgZG8sIHRob3NlIGNvbW1lbnQgdGFncwogICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5iYWxhbmNlZFRhZ3MgPSBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVRvSW5zZXJ0QmVmb3JlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWZXJpZmllZC5pbnNlcnRCZWZvcmUodW5iYWxhbmNlZFRhZ3NbaV0sIG5vZGVUb0luc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzJywga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncyk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwovL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcicsIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcik7Ci8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4nLCBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKTsKKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKICAgIGtvLmJpbmRpbmdQcm92aWRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CiAgICB9OwoKICAgIGtvLnV0aWxzLmV4dGVuZChrby5iaW5kaW5nUHJvdmlkZXIucHJvdG90eXBlLCB7CiAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGw7ICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4ga28udmlydHVhbEVsZW1lbnRzLnZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlKG5vZGUpICE9IG51bGw7IC8vIENvbW1lbnQgbm9kZQogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUpIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCiAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgogICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlKTsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5NZXNzYWdlOiAiICsgZXggKyAiO1xuQmluZGluZ3MgdmFsdWU6ICIgKyBiaW5kaW5nc1N0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgogICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgY2FjaGUpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZzsKICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCiAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nKSB7CiAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKICAgICAgICAvLyBGb3IgZWFjaCBzY29wZSB2YXJpYWJsZSwgYWRkIGFuIGV4dHJhIGxldmVsIG9mICJ3aXRoIiBuZXN0aW5nCiAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CiAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcpLAogICAgICAgICAgICBmdW5jdGlvbkJvZHkgPSAid2l0aCgkY29udGV4dCl7d2l0aCgkZGF0YXx8e30pe3JldHVybnsiICsgcmV3cml0dGVuQmluZGluZ3MgKyAifX19IjsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CihmdW5jdGlvbiAoKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMgPSB7fTsKCiAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtLCBwYXJlbnRCaW5kaW5nQ29udGV4dCwgZGF0YUl0ZW1BbGlhcykgewogICAgICAgIGlmIChwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBrby51dGlscy5leHRlbmQodGhpcywgcGFyZW50QmluZGluZ0NvbnRleHQpOyAvLyBJbmhlcml0ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMKICAgICAgICAgICAgdGhpc1snJHBhcmVudENvbnRleHQnXSA9IHBhcmVudEJpbmRpbmdDb250ZXh0OwogICAgICAgICAgICB0aGlzWyckcGFyZW50J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnJGRhdGEnXTsKICAgICAgICAgICAgdGhpc1snJHBhcmVudHMnXSA9IChwYXJlbnRCaW5kaW5nQ29udGV4dFsnJHBhcmVudHMnXSB8fCBbXSkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10udW5zaGlmdCh0aGlzWyckcGFyZW50J10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSBbXTsKICAgICAgICAgICAgdGhpc1snJHJvb3QnXSA9IGRhdGFJdGVtOwogICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDkwCiAgICAgICAgICAgIHRoaXNbJ2tvJ10gPSBrbzsKICAgICAgICB9CiAgICAgICAgdGhpc1snJGRhdGEnXSA9IGRhdGFJdGVtOwogICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQogICAgICAgICAgICB0aGlzW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CiAgICB9CiAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2NyZWF0ZUNoaWxkQ29udGV4dCddID0gZnVuY3Rpb24gKGRhdGFJdGVtLCBkYXRhSXRlbUFsaWFzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dChkYXRhSXRlbSwgdGhpcywgZGF0YUl0ZW1BbGlhcyk7CiAgICB9OwogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydleHRlbmQnXSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgY2xvbmUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLmJpbmRpbmdDb250ZXh0KCksIHRoaXMpOwogICAgICAgIHJldHVybiBrby51dGlscy5leHRlbmQoY2xvbmUsIHByb3BlcnRpZXMpOwogICAgfTsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdOYW1lKSB7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgIGlmICghdmFsaWRhdG9yKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBiaW5kaW5nICciICsgYmluZGluZ05hbWUgKyAiJyBjYW5ub3QgYmUgdXNlZCB3aXRoIHZpcnR1YWwgZWxlbWVudHMiKQogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CiAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgogICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCiAgICAgICAgLy8gUGVyZiBvcHRpbWlzYXRpb246IEFwcGx5IGJpbmRpbmdzIG9ubHkgaWYuLi4KICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCiAgICAgICAgLy8gKDIpIEl0IG1pZ2h0IGhhdmUgYmluZGluZ3MgKGUuZy4sIGl0IGhhcyBhIGRhdGEtYmluZCBhdHRyaWJ1dGUsIG9yIGl0J3MgYSBtYXJrZXIgZm9yIGEgY29udGFpbmVybGVzcyB0ZW1wbGF0ZSkKICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGVWZXJpZmllZCk7CgogICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQogICAgICAgIGlmIChzaG91bGRBcHBseUJpbmRpbmdzKQogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpLnNob3VsZEJpbmREZXNjZW5kYW50czsKCiAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cykgewogICAgICAgICAgICAvLyBXZSdyZSByZWN1cnNpbmcgYXV0b21hdGljYWxseSBpbnRvIChyZWFsIG9yIHZpcnR1YWwpIGNoaWxkIG5vZGVzIHdpdGhvdXQgY2hhbmdpbmcgYmluZGluZyBjb250ZXh0cy4gU28sCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICp2aXJ0dWFsKiBlbGVtZW50LCB3ZSBjYW4ndCBiZSBzdXJlLiBFdmFsdWF0aW5nIC5wYXJlbnROb2RlIG9uIHRob3NlIGNoaWxkcmVuIG1heQogICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwgKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gTmVlZCB0byBiZSBzdXJlIHRoYXQgaW5pdHMgYXJlIG9ubHkgcnVuIG9uY2UsIGFuZCB1cGRhdGVzIG5ldmVyIHJ1biB1bnRpbCBhbGwgdGhlIGluaXRzIGhhdmUgYmVlbiBydW4KICAgICAgICB2YXIgaW5pdFBoYXNlID0gMDsgLy8gMCA9IGJlZm9yZSBhbGwgaW5pdHMsIDEgPSBkdXJpbmcgaW5pdHMsIDIgPSBhZnRlciBhbGwgaW5pdHMKCiAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBkZXBlbmRlbnRPYnNlcnZhYmxlIGlzIGV2YWx1YXRlZCAoYWZ0ZXIgZGF0YSBjaGFuZ2VzKSwKICAgICAgICAvLyB0aGUgYmluZGluZyBhdHRyaWJ1dGUgaXMgcmVwYXJzZWQgc28gdGhhdCBpdCBjYW4gcGljayBvdXQgdGhlIGNvcnJlY3QKICAgICAgICAvLyBtb2RlbCBwcm9wZXJ0aWVzIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjaGFuZ2VkIGRhdGEuCiAgICAgICAgLy8gRE9NIGV2ZW50IGNhbGxiYWNrcyBuZWVkIHRvIGJlIGFibGUgdG8gYWNjZXNzIHRoaXMgY2hhbmdlZCBkYXRhLAogICAgICAgIC8vIHNvIHdlIG5lZWQgYSBzaW5nbGUgcGFyc2VkQmluZGluZ3MgdmFyaWFibGUgKHNoYXJlZCBieSBhbGwgY2FsbGJhY2tzCiAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgbm9kZSdzIGJpbmRpbmdzKSB0aGF0IGFsbCB0aGUgY2xvc3VyZXMgY2FuIGFjY2Vzcy4KICAgICAgICB2YXIgcGFyc2VkQmluZGluZ3M7CiAgICAgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyc2VkQmluZGluZ3NbYmluZGluZ0tleV0gfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZWRCaW5kaW5nc0FjY2Vzc29yKCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VkQmluZGluZ3M7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CiAgICAgICAga28uZGVwZW5kZW50T2JzZXJ2YWJsZSgKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBub25udWxsIGJpbmRpbmcgY29udGV4dCB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dEluc3RhbmNlID0gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCAmJiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KQogICAgICAgICAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCkpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0SW5zdGFuY2VbJyRkYXRhJ107CgogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSBpZiBpdCdzIGRlZmluaXRlbHkgdGhlIHNhbWUgYXMgb24gbm9kZS5wYXJlbnROb2RlLCBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgLy8gVXNlIGV2YWx1YXRlZEJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCiAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdGVkQmluZGluZ3MgPSAodHlwZW9mIGJpbmRpbmdzID09ICJmdW5jdGlvbiIpID8gYmluZGluZ3MoYmluZGluZ0NvbnRleHRJbnN0YW5jZSwgbm9kZSkgOiBiaW5kaW5nczsKICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gZXZhbHVhdGVkQmluZGluZ3MgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydnZXRCaW5kaW5ncyddKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHJ1biBhbGwgdGhlIGluaXRzLCBzbyBiaW5kaW5ncyBjYW4gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbiBvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbml0UGhhc2UgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1siaW5pdCJdID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdbImluaXQiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBydW4gYWxsIHRoZSB1cGRhdGVzLCB3aGljaCBtaWdodCB0cmlnZ2VyIGNoYW5nZXMgZXZlbiBvbiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIChpbml0UGhhc2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYmluZGluZ0tleSBpbiBwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1sidXBkYXRlIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nWyJ1cGRhdGUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIDogbm9kZSB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2hvdWxkQmluZERlc2NlbmRhbnRzOiBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9PT0gdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH07CgogICAgdmFyIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSA9ICJfX2tvX2JpbmRpbmdDb250ZXh0X18iOwogICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5KTsKICAgIH0KCiAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgLy8gSWYgaXQncyBhbiBlbGVtZW50LCB3b3JrYXJvdW5kIElFIDw9IDggSFRNTCBwYXJzaW5nIHdlaXJkbmVzcwogICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CiAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsLCB0cnVlKTsKICAgIH07CgogICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMgPSBmdW5jdGlvbih2aWV3TW9kZWwsIHJvb3ROb2RlKSB7CiAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKHZpZXdNb2RlbCwgcm9vdE5vZGUsIHRydWUpOwogICAgfTsKCiAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbCwgcm9vdE5vZGUpIHsKICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImtvLmFwcGx5QmluZGluZ3M6IGZpcnN0IHBhcmFtZXRlciBzaG91bGQgYmUgeW91ciB2aWV3IG1vZGVsOyBzZWNvbmQgcGFyYW1ldGVyIHNob3VsZCBiZSBhIERPTSBub2RlIik7CiAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIHJvb3ROb2RlLCB0cnVlKTsKICAgIH07CgogICAgLy8gUmV0cmlldmluZyBiaW5kaW5nIGNvbnRleHQgZnJvbSBhcmJpdHJhcnkgbm9kZXMKICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlKTsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CiAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKICAgICAgICByZXR1cm4gY29udGV4dCA/IGNvbnRleHRbJyRkYXRhJ10gOiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5ncycsIGtvLmFwcGx5QmluZGluZ3MpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ3NUb05vZGUpOwogICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CiAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKfSkoKTsKdmFyIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwID0geyAnY2xhc3MnOiAnY2xhc3NOYW1lJywgJ2Zvcic6ICdodG1sRm9yJyB9Owprby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwogICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2F0dHJOYW1lXSk7CgogICAgICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CiAgICAgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCiAgICAgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgogICAgICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCiAgICAgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwogICAgICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQogICAgICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCiAgICAgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KICAgICAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUgPSBlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAoZWxlbWVudC5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gImNoZWNrZWQiIGJpbmRpbmcgb25seSByZXNwb25kcyB0byBjaGVja2JveGVzIGFuZCBzZWxlY3RlZCByYWRpbyBidXR0b25zCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB1bndyYXBwZWRWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIpICYmICh1bndyYXBwZWRWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgLy8gRm9yIGNoZWNrYm94ZXMgYm91bmQgdG8gYW4gYXJyYXksIHdlIGFkZC9yZW1vdmUgdGhlIGNoZWNrYm94IHZhbHVlIHRvIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIC8vIFRoaXMgd29ya3MgZm9yIGJvdGggb2JzZXJ2YWJsZSBhbmQgbm9uLW9ic2VydmFibGUgYXJyYXlzCiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHVud3JhcHBlZFZhbHVlLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmNoZWNrZWQgJiYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUucHVzaChlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCghZWxlbWVudC5jaGVja2VkKSAmJiAoZXhpc3RpbmdFbnRyeUluZGV4ID49IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUuc3BsaWNlKGV4aXN0aW5nRW50cnlJbmRleCwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdjaGVja2VkJywgdmFsdWVUb1dyaXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlSGFuZGxlcik7CgogICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQogICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJyYWRpbyIpICYmICFlbGVtZW50Lm5hbWUpCiAgICAgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddWydpbml0J10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFuIGFycmF5LCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIGl0cyB2YWx1ZSBiZWluZyBwcmVzZW50IGluIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih2YWx1ZSwgZWxlbWVudC52YWx1ZSkgPj0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYm91bmQgdG8gYW55dGhpbmcgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIHRoZSBjaGVja2JveCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgdGhlIHZhbHVlIGJlaW5nIHRydWVpc2gKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgewogICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSAoZWxlbWVudC52YWx1ZSA9PSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQp9Owp2YXIgY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXkgPSAnX19rb19fY3NzVmFsdWUnOwprby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVtjbGFzc05hbWVdKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSB8fCAnJyk7IC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCB0cnkgdG8gc3RvcmUgb3Igc2V0IGEgbm9uLXN0cmluZyB2YWx1ZQogICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIHZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmICghZWxlbWVudC5kaXNhYmxlZCkpCiAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddWyd1cGRhdGUnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfSk7CiAgICB9Cn07Ci8vIEZvciBjZXJ0YWluIGNvbW1vbiBldmVudHMgKGN1cnJlbnRseSBqdXN0ICdjbGljaycpLCBhbGxvdyBhIHNpbXBsaWZpZWQgZGF0YS1iaW5kaW5nIHN5bnRheAovLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CmZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tldmVudE5hbWVdID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50TmFtZV0gPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWydldmVudCddWydpbml0J10uY2FsbCh0aGlzLCBlbGVtZW50LCBuZXdWYWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpOwogICAgICAgIH0KICAgIH0KfQoKa28uYmluZGluZ0hhbmRsZXJzWydldmVudCddID0gewogICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKICAgICAgICBmb3IodmFyIGV2ZW50TmFtZU91dHNpZGVDbG9zdXJlIGluIGV2ZW50c1RvSGFuZGxlKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZTsgLy8gU2VwYXJhdGUgdmFyaWFibGUgdG8gYmUgY2FwdHVyZWQgYnkgZXZlbnQgaGFuZGxlciBjbG9zdXJlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5nc1tldmVudE5hbWUgKyAnQnViYmxlJ10gIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9Cn07Ci8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKLy8gImZvcmVhY2g6IHsgZGF0YTogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAogICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKICAgICAgICAgICAgLy8gSWYgdW53cmFwcGVkVmFsdWUgaXMgdGhlIGFycmF5LCBwYXNzIGluIHRoZSB3cmFwcGVkIHZhbHVlIG9uIGl0cyBvd24KICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwogICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQogICAgICAgICAgICBpZiAoKCF1bndyYXBwZWRWYWx1ZSkgfHwgdHlwZW9mIHVud3JhcHBlZFZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikKICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCiAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCiAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnYXMnOiB1bndyYXBwZWRWYWx1ZVsnYXMnXSwKICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAogICAgICAgICAgICAgICAgJ2JlZm9yZVJlbW92ZSc6IHVud3JhcHBlZFZhbHVlWydiZWZvcmVSZW1vdmUnXSwKICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAogICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAogICAgICAgICAgICAgICAgJ2FmdGVyTW92ZSc6IHVud3JhcHBlZFZhbHVlWydhZnRlck1vdmUnXSwKICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2ZvcmVhY2gnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwp2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UgPSBmdW5jdGlvbihpc0ZvY3VzZWQpIHsKICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KICAgICAgICAgICAgLy8gSG93ZXZlciwgbm90IGFsbCBLTy10YXJnZXRlZCBicm93c2VycyAoRmlyZWZveCAyKSBzdXBwb3J0IGFjdGl2ZUVsZW1lbnQuIEZvciB0aG9zZSBicm93c2VycywKICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwogICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KICAgICAgICAgICAgLy8gRGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zNTIKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAoImFjdGl2ZUVsZW1lbnQiIGluIG93bmVyRG9jKSB7CiAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAob3duZXJEb2MuYWN0aXZlRWxlbWVudCA9PT0gZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3NBY2Nlc3NvciwgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3Vzb3V0IiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7IC8vIEZvciBJRQogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldKSB7CiAgICAgICAgICAgIHZhbHVlID8gZWxlbWVudC5mb2N1cygpIDogZWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQogICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKICAgICAgICBrby51dGlscy5zZXRIdG1sKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CiAgICB9Cn07CnZhciB3aXRoSWZEb21EYXRhS2V5ID0gJ19fa29fd2l0aElmQmluZGluZ0RhdGEnOwovLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCmZ1bmN0aW9uIG1ha2VXaXRoSWZCaW5kaW5nKGJpbmRpbmdLZXksIGlzV2l0aCwgaXNOb3QsIG1ha2VDb250ZXh0Q2FsbGJhY2spIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgd2l0aElmRG9tRGF0YUtleSwge30pOwogICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICAgICAgfSwKICAgICAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgd2l0aElmRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHdpdGhJZkRvbURhdGFLZXkpLAogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAogICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQogICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICF3aXRoSWZEYXRhLnNhdmVkTm9kZXMsCiAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gd2l0aElmRGF0YS5kaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCiAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2l0aElmRGF0YS5zYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIGtvLnV0aWxzLmNsb25lTm9kZXMod2l0aElmRGF0YS5zYXZlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdpdGhJZkRhdGEuZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbYmluZGluZ0tleV0gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwp9CgovLyBDb25zdHJ1Y3QgdGhlIGFjdHVhbCBiaW5kaW5nIGhhbmRsZXJzCm1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwptYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwptYWtlV2l0aElmQmluZGluZygnd2l0aCcsIHRydWUgLyogaXNXaXRoICovLCBmYWxzZSAvKiBpc05vdCAqLywKICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CiAgICB9Cik7CmZ1bmN0aW9uIGVuc3VyZURyb3Bkb3duU2VsZWN0aW9uSXNDb25zaXN0ZW50V2l0aE1vZGVsVmFsdWUoZWxlbWVudCwgbW9kZWxWYWx1ZSwgcHJlZmVyTW9kZWxWYWx1ZSkgewogICAgaWYgKHByZWZlck1vZGVsVmFsdWUpIHsKICAgICAgICBpZiAobW9kZWxWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpCiAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBtb2RlbFZhbHVlKTsKICAgIH0KCiAgICAvLyBObyBtYXR0ZXIgd2hpY2ggZGlyZWN0aW9uIHdlJ3JlIHN5bmNpbmcgaW4sIHdlIHdhbnQgdGhlIGVuZCByZXN1bHQgdG8gYmUgZXF1YWxpdHkgYmV0d2VlbiBkcm9wZG93biB2YWx1ZSBhbmQgbW9kZWwgdmFsdWUuCiAgICAvLyBJZiB0aGV5IGFyZW4ndCBlcXVhbCwgZWl0aGVyIHdlIHByZWZlciB0aGUgZHJvcGRvd24gdmFsdWUsIG9yIHRoZSBtb2RlbCB2YWx1ZSBjb3VsZG4ndCBiZSByZXByZXNlbnRlZCwgc28gZWl0aGVyIHdheSwKICAgIC8vIGNoYW5nZSB0aGUgbW9kZWwgdmFsdWUgdG8gbWF0Y2ggdGhlIGRyb3Bkb3duLgogICAgaWYgKG1vZGVsVmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKQogICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJzZWxlY3QiKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgPSBlbGVtZW50Lmxlbmd0aCA9PSAwOwogICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0ga28udXRpbHMuYXJyYXlNYXAoa28udXRpbHMuYXJyYXlGaWx0ZXIoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lICYmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKSAmJiBub2RlLnNlbGVjdGVkOwogICAgICAgIH0pLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudDsKICAgICAgICB9KTsKICAgICAgICB2YXIgcHJldmlvdXNTY3JvbGxUb3AgPSBlbGVtZW50LnNjcm9sbFRvcDsKCiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyA8b3B0aW9uPnMuCiAgICAgICAgLy8gTmVlZCB0byB1c2UgLnJlbW92ZSgpIHJhdGhlciB0aGFuIC5yZW1vdmVDaGlsZCgpIGZvciA8b3B0aW9uPnMgb3RoZXJ3aXNlIElFIGJlaGF2ZXMgb2RkbHkgKGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTM0KQogICAgICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKGVsZW1lbnQub3B0aW9uc1swXSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKSwKICAgICAgICAgICAgICAgIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5nc1snb3B0aW9uc0luY2x1ZGVEZXN0cm95ZWQnXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoICE9ICJudW1iZXIiKQogICAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ29wdGlvbnNDYXB0aW9uJ10pIHsKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwob3B0aW9uLCBhbGxCaW5kaW5nc1snb3B0aW9uc0NhcHRpb24nXSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChvcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgLy8gU2tpcCBkZXN0cm95ZWQgaXRlbXMKICAgICAgICAgICAgICAgIHZhciBhcnJheUVudHJ5ID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSAmJiBhcnJheUVudHJ5WydfZGVzdHJveSddICYmICFpbmNsdWRlRGVzdHJveWVkKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZVR5cGUgPT0gImZ1bmN0aW9uIikgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbjsgcnVuIGl0IGFnYWluc3QgdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtwcmVkaWNhdGVdOwogICAgICAgICAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVmFsdWUgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXSwgYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgc29tZSB0ZXh0IHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVGV4dCddLCBvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChvcHRpb24sIG9wdGlvblRleHQpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KICAgICAgICAgICAgdmFyIG5ld09wdGlvbnMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKTsKICAgICAgICAgICAgdmFyIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdPcHRpb25zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zW2ldKSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zW2ldLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb3VudFNlbGVjdGlvbnNSZXRhaW5lZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSAmJiAoJ3ZhbHVlJyBpbiBhbGxCaW5kaW5ncykpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW5jeSBiZXR3ZWVuIG1vZGVsIHZhbHVlIGFuZCBzZWxlY3RlZCBvcHRpb24uCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gaXMgYmVpbmcgcG9wdWxhdGVkIGZvciB0aGUgZmlyc3QgdGltZSBoZXJlIChvciB3YXMgb3RoZXJ3aXNlIHByZXZpb3VzbHkgZW1wdHkpLAogICAgICAgICAgICAgICAgLy8gdGhlIGRyb3Bkb3duIHNlbGVjdGlvbiBzdGF0ZSBpcyBtZWFuaW5nbGVzcywgc28gd2UgcHJlc2VydmUgdGhlIG1vZGVsIHZhbHVlLgogICAgICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShhbGxCaW5kaW5nc1sndmFsdWUnXSksIC8qIHByZWZlck1vZGVsVmFsdWUgKi8gdHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSBidWcKICAgICAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSAnX19rby5vcHRpb25WYWx1ZURvbURhdGFfXyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAndmFsdWUnLCB2YWx1ZVRvV3JpdGUpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKG5ld1ZhbHVlICYmIHR5cGVvZiBuZXdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobm9kZSwgaXNTZWxlY3RlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW3N0eWxlTmFtZV0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZSB8fCAiIjsgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snc3VibWl0J10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAic3VibWl0IiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdHJ5IHsgaGFuZGxlclJldHVyblZhbHVlID0gdmFsdWUuY2FsbCh2aWV3TW9kZWwsIGVsZW1lbnQpOyB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwogICAgfQp9Owprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZXh0J10gPSB0cnVlOwprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gImtvX3VuaXF1ZV8iICsgKCsra28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4KTsKICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwprby5iaW5kaW5nSGFuZGxlcnNbJ3ZhbHVlJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCiAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwogICAgICAgIHZhciByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWyJ2YWx1ZVVwZGF0ZSJdOwogICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgIGlmIChyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZXZlbnRzVG9DYXRjaCwgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCk7CiAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlVXBkYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgogICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAogICAgICAgIHZhciBpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgPSBrby51dGlscy5pZVZlcnNpb24gJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiBlbGVtZW50LnR5cGUgPT0gInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwogICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJwcm9wZXJ0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSB0cnVlIH0pOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVVcGRhdGVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKICAgICAgICAgICAgLy8gVGhpcyBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCB0byBjYXRjaCAia2V5ZG93biIgZXZlbnRzIGFmdGVyIHRoZSBicm93c2VyIGhhcyB1cGRhdGVkIHRoZSBjb250cm9sCiAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwogICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nU3RhcnRzV2l0aChldmVudE5hbWUsICJhZnRlciIpKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7IHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKSB9OwogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWVJc1NlbGVjdE9wdGlvbiA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCI7CiAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICB2YXIgdmFsdWVIYXNDaGFuZ2VkID0gKG5ld1ZhbHVlICE9IGVsZW1lbnRWYWx1ZSk7CgogICAgICAgIC8vIEphdmFTY3JpcHQncyAwID09ICIiIGJlaGF2aW91cyBpcyB1bmZvcnR1bmF0ZSBoZXJlIGFzIGl0IHByZXZlbnRzIHdyaXRpbmcgMCB0byBhbiBlbXB0eSB0ZXh0IGJveCAobG9vc2UgZXF1YWxpdHkgc3VnZ2VzdHMgdGhlIHZhbHVlcyBhcmUgdGhlIHNhbWUpLgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZG8gYSBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbiBhcyB0aGF0IGlzIG1vcmUgY29uZnVzaW5nIGZvciBkZXZlbG9wZXJzIGluIGNlcnRhaW4gY2FzZXMsIHNvIHdlIHNwZWNpZmljYWxseSBzcGVjaWFsIGNhc2UgMCAhPSAiIiBoZXJlLgogICAgICAgIGlmICgobmV3VmFsdWUgPT09IDApICYmIChlbGVtZW50VmFsdWUgIT09IDApICYmIChlbGVtZW50VmFsdWUgIT09ICIwIikpCiAgICAgICAgICAgIHZhbHVlSGFzQ2hhbmdlZCA9IHRydWU7CgogICAgICAgIGlmICh2YWx1ZUhhc0NoYW5nZWQpIHsKICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7IH07CiAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFNiBidWc6IEl0IHdvbid0IHJlbGlhYmx5IGFwcGx5IHZhbHVlcyB0byBTRUxFQ1Qgbm9kZXMgZHVyaW5nIHRoZSBzYW1lIGV4ZWN1dGlvbiB0aHJlYWQKICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCiAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgogICAgICAgICAgICB2YXIgYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkgPSB2YWx1ZUlzU2VsZWN0T3B0aW9uOwogICAgICAgICAgICBpZiAoYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFwcGx5VmFsdWVBY3Rpb24sIDApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgeW91IHRyeSB0byBzZXQgYSBtb2RlbCB2YWx1ZSB0aGF0IGNhbid0IGJlIHJlcHJlc2VudGVkIGluIGFuIGFscmVhZHktcG9wdWxhdGVkIGRyb3Bkb3duLCByZWplY3QgdGhhdCBjaGFuZ2UsCiAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KICAgICAgICBpZiAodmFsdWVJc1NlbGVjdE9wdGlvbiAmJiAoZWxlbWVudC5sZW5ndGggPiAwKSkKICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyBmYWxzZSk7CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwogICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KfTsKLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9Cm1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dCgnY2xpY2snKTsKLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCi8vCi8vIFsxXSBJbmhlcml0IGZyb20gdGhpcyBjbGFzcyAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQovLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKLy8KLy8gICAgICAgIGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQovLyAgICAgICAgICAgIC8vICAgLSB5b3UgbWlnaHQgYWxzbyB3YW50IHRvIG1ha2UgYmluZGluZ0NvbnRleHQuJHBhcmVudCwgYmluZGluZ0NvbnRleHQuJHBhcmVudHMsCi8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwovLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCi8vICAgICAgICAgICAgLy8KLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwovLyAgICAgICAgfQovLwovLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6Ci8vCi8vICAgICAgICBmdW5jdGlvbiAoc2NyaXB0KSB7Ci8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCi8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKLy8gICAgICAgIH0KLy8KLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCi8vICAgICBJZiB5b3UgZG9uJ3Qgd2FudCB0byBhbGxvdyB0aGF0LCB5b3UgY2FuIHNldCB0aGUgcHJvcGVydHkgJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnIHRvIGZhbHNlIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCi8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCmtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXSA9IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ21ha2VUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgdGVtcGxhdGVEb2N1bWVudCA9IHRlbXBsYXRlRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKICAgICAgICBpZiAoIWVsZW0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgd2l0aCBJRCAiICsgdGVtcGxhdGUpOwogICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CiAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKICAgICAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGUKICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICB9IGVsc2UKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdGVtcGxhdGUgdHlwZTogIiArIHRlbXBsYXRlKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCiAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmV3cml0ZVRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHJld3JpdGVyQ2FsbGJhY2ssIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CiAgICB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKHJld3JpdHRlbik7CiAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwp9OwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZUVuZ2luZScsIGtvLnRlbXBsYXRlRW5naW5lKTsKCmtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPFthLXpdK1xkKihccysoPyFkYXRhLWJpbmQ9KVthLXowLTlcLV0rKD0oXCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kPShbIiddKShbXHNcU10qPylcNS9naTsKICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGtleVZhbHVlQXJyYXkpIHsKICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0ga2V5VmFsdWVBcnJheVtpXVsna2V5J107CiAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWxpZGF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocG9zc2libGVFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCB0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgIHZhciBkYXRhQmluZEtleVZhbHVlQXJyYXkgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CiAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXkpOwoKICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCiAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwogICAgICAgIC8vIGV4dHJhIGluZGlyZWN0aW9uLgogICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CiAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSkiOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10oYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQpICsgdGFnVG9SZXRhaW47CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBlbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnRlbXBsYXRlUmV3cml0aW5nLm1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4KGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIG1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4OiBmdW5jdGlvbiAoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzZdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UobWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXgsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGRvbU5vZGUubmV4dFNpYmxpbmcsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfSkoKTsKCgovLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwooZnVuY3Rpb24oKSB7CiAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwogICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCiAgICAvLwogICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgogICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CiAgICAvLyAgMi4ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c0VsZW1lbnQgLSB1c2VzIGtvLnV0aWxzLmRvbURhdGEgdG8gcmVhZC93cml0ZSB0ZXh0ICphc3NvY2lhdGVkKiB3aXRoIHRoZSBET00gZWxlbWVudCwgYnV0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCiAgICAvLyBZb3UgY2FuIGltcGxlbWVudCB5b3VyIG93biB0ZW1wbGF0ZSBzb3VyY2UgaWYgeW91IHdhbnQgdG8gZmV0Y2gvc3RvcmUgdGVtcGxhdGVzIHNvbWV3aGVyZSBvdGhlciB0aGFuIGluIERPTSBlbGVtZW50cy4KICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgogICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIHRleHQodmFsdWUpCQktIHdyaXRlcyB0aGUgc3VwcGxpZWQgdGVtcGxhdGUgdGV4dCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQogICAgLy8gICBub2Rlcyh2YWx1ZSkgICAgICAgLSB3cml0ZXMgdGhlIGdpdmVuIERPTSBlbGVtZW50IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCiAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KICAgIC8vCiAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgogICAga28udGVtcGxhdGVTb3VyY2VzID0ge307CgogICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKHRoaXMuZG9tRWxlbWVudCksCiAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiaW5uZXJIVE1MIjsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbCh0aGlzLmRvbUVsZW1lbnQsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CiAgICAgICAgfQogICAgfTsKCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgInRlbXBsYXRlU291cmNlRGF0YV8iICsga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSwgYXJndW1lbnRzWzFdKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KICAgIC8vIEZvciBjb21wYXRpYmlsaXR5LCB5b3UgY2FuIGFsc28gcmVhZCAidGV4dCI7IGl0IHdpbGwgYmUgc2VyaWFsaXplZCBmcm9tIHRoZSBub2RlcyBvbiBkZW1hbmQuCiAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgogICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSAiX19rb19hbm9uX3RlbXBsYXRlX18iOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEudGV4dERhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7dGV4dERhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ25vZGVzJ10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7Y29udGFpbmVyRGF0YTogdmFsdWVUb1dyaXRlfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcycsIGtvLnRlbXBsYXRlU291cmNlcyk7CiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwp9KSgpOwooZnVuY3Rpb24gKCkgewogICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKICAgIGtvLnNldFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKICAgICAgICBfdGVtcGxhdGVFbmdpbmUgPSB0ZW1wbGF0ZUVuZ2luZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewogICAgICAgIHZhciBub2RlLCBuZXh0SW5RdWV1ZSA9IGZpcnN0Tm9kZSwgZmlyc3RPdXRPZlJhbmdlTm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhsYXN0Tm9kZSk7CiAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICBhY3Rpb24obm9kZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CiAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCiAgICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3Igd2Fsa2luZyB0aGVtIHJlbGllcyBvbiB0aGlzKSwgYW5kIGZvciBlYWNoIHRvcC1sZXZlbCBpdGVtIGluIHRoZSB2aXJ0dWFsLWVsZW1lbnQgc2Vuc2UsCiAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgogICAgICAgIGlmIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgogICAgICAgICAgICAvLyBOZWVkIHRvIGFwcGx5QmluZGluZ3MgKmJlZm9yZSogdW5tZW1vemlhdGlvbiwgYmVjYXVzZSB1bm1lbW9pemF0aW9uIG1pZ2h0IGludHJvZHVjZSBleHRyYSBub2RlcyAodGhhdCB3ZSBkb24ndCB3YW50IHRvIHJlLWJpbmQpCiAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwogICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMobm9kZSwgW2JpbmRpbmdDb250ZXh0XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheShub2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwogICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwogICAgICAgIHZhciB0ZW1wbGF0ZUVuZ2luZVRvVXNlID0gKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKTsKICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKICAgICAgICAvLyBMb29zZWx5IGNoZWNrIHJlc3VsdCBpcyBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKICAgICAgICB2YXIgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewogICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbih0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CiAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJyZXBsYWNlTm9kZSI6CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlck1vZGU6ICIgKyByZW5kZXJNb2RlKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQogICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICB9CgogICAga28ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IGEgdGVtcGxhdGUgZW5naW5lIGJlZm9yZSBjYWxsaW5nIHJlbmRlclRlbXBsYXRlIik7CiAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgogICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgogICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgogICAgICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSggLy8gU28gdGhlIERPTSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdDb250ZXh0ID0gKGRhdGFPckJpbmRpbmdDb250ZXh0ICYmIChkYXRhT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gdHlwZW9mKHRlbXBsYXRlKSA9PSAnZnVuY3Rpb24nID8gdGVtcGxhdGUoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSA6IHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGVOYW1lLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXROb2RlT3JOb2RlQXJyYXkgPSByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gU2luY2Ugc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBhbHdheXMgY2FsbHMgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCB0aGVuCiAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCBieSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIHRvIGdldCB0aGUgbm9kZXMgdG8gYWRkIHRvIHRhcmdldE5vZGUKICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dCA9IHBhcmVudEJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5VmFsdWUpLCBvcHRpb25zWydhcyddKTsKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dFsnJGluZGV4J10gPSBpbmRleDsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpIDogdGVtcGxhdGU7CiAgICAgICAgICAgIHJldHVybiBleGVjdXRlVGVtcGxhdGUobnVsbCwgImlnbm9yZVRhcmdldE5vZGUiLCB0ZW1wbGF0ZU5hbWUsIGFycmF5SXRlbUNvbnRleHQsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayA9IGZ1bmN0aW9uKGFycmF5VmFsdWUsIGFkZGVkTm9kZXNBcnJheSwgaW5kZXgpIHsKICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10oYWRkZWROb2Rlc0FycmF5LCBhcnJheVZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlPck9ic2VydmFibGVBcnJheSkgfHwgW107CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgYW55IGVudHJpZXMgbWFya2VkIGFzIGRlc3Ryb3llZAogICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCiAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcsIG51bGwsIFt0YXJnZXROb2RlLCBmaWx0ZXJlZEFycmF5LCBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0sIG9wdGlvbnMsIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFja10pOwoKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKICAgIH07CgogICAgdmFyIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5ID0gJ19fa29fX3RlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5X18nOwogICAgZnVuY3Rpb24gZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgbmV3Q29tcHV0ZWQpIHsKICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CiAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCiAgICAgICAgICAgIG9sZENvbXB1dGVkLmRpc3Bvc2UoKTsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwogICAgfQoKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCiAgICAgICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgICAgIGlmICgodHlwZW9mIGJpbmRpbmdWYWx1ZSAhPSAic3RyaW5nIikgJiYgKCFiaW5kaW5nVmFsdWVbJ25hbWUnXSkgJiYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09IDgpKSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGVsZW1lbnQubm9kZVR5cGUgPT0gMSA/IGVsZW1lbnQuY2hpbGROb2RlcyA6IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGtvLnV0aWxzLm1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQodGVtcGxhdGVOb2Rlcyk7IC8vIFRoaXMgYWxzbyByZW1vdmVzIHRoZSBub2RlcyBmcm9tIHRoZWlyIGN1cnJlbnQgcGFyZW50CiAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwogICAgICAgIH0sCiAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCiAgICAgICAgICAgICAgICBvcHRpb25zID0ge30sCiAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZU5hbWUgIT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZW1wbGF0ZU5hbWU7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSBvcHRpb25zWyduYW1lJ107CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwogICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydpZiddKTsKICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydkYXRhJ10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciBlYWNoIGRhdGEgcG9pbnQgKHRyZWF0aW5nIGRhdGEgc2V0IGFzIGVtcHR5IGlmIHNob3VsZERpc3BsYXk9PWZhbHNlKQogICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciB0aGlzIHNpbmdsZSBkYXRhIHBvaW50IChvciB1c2UgdGhlIHZpZXdNb2RlbCBpZiBubyBkYXRhIHdhcyBwcm92aWRlZCkKICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBleHBsaWNpdCAnZGF0YScgdmFsdWUsIHdlIHJldGFpbiB0aGUgc2FtZSBiaW5kaW5nIGNvbnRleHQKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEl0IG9ubHkgbWFrZXMgc2Vuc2UgdG8gaGF2ZSBhIHNpbmdsZSB0ZW1wbGF0ZSBjb21wdXRlZCBwZXIgZWxlbWVudCAob3RoZXJ3aXNlIHdoaWNoIG9uZSBzaG91bGQgaGF2ZSBpdHMgb3V0cHV0IGRpc3BsYXllZD8pCiAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdWYWx1ZSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGJpbmRpbmdWYWx1ZSk7CgogICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgogICAgICAgIGlmIChrby5leHByZXNzaW9uUmV3cml0aW5nLmtleVZhbHVlQXJyYXlDb250YWluc0tleShwYXJzZWRCaW5kaW5nVmFsdWUsICJuYW1lIikpCiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwogICAgfTsKCiAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnc2V0VGVtcGxhdGVFbmdpbmUnLCBrby5zZXRUZW1wbGF0ZUVuZ2luZSk7CmtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7Cgprby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzdGF0dXNOb3RJbk9sZCA9ICdhZGRlZCcsIHN0YXR1c05vdEluTmV3ID0gJ2RlbGV0ZWQnOwoKICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBkb250TGltaXRNb3ZlcykgewogICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CiAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCiAgICAgICAgaWYgKG9sZEFycmF5Lmxlbmd0aCA8PSBuZXdBcnJheS5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIGRvbnRMaW1pdE1vdmVzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIGRvbnRMaW1pdE1vdmVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkoc21sQXJyYXksIGJpZ0FycmF5LCBzdGF0dXNOb3RJblNtbCwgc3RhdHVzTm90SW5CaWcsIGRvbnRMaW1pdE1vdmVzKSB7CiAgICAgICAgdmFyIG15TWluID0gTWF0aC5taW4sCiAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCiAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAogICAgICAgICAgICBzbWxJbmRleCwgc21sSW5kZXhNYXggPSBzbWxBcnJheS5sZW5ndGgsCiAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCiAgICAgICAgICAgIG1heERpc3RhbmNlID0gc21sSW5kZXhNYXggKyBiaWdJbmRleE1heCArIDEsCiAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCiAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCiAgICAgICAgZm9yIChzbWxJbmRleCA9IDA7IHNtbEluZGV4IDw9IHNtbEluZGV4TWF4OyBzbWxJbmRleCsrKSB7CiAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwogICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwogICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdyA9IG15TWluKGJpZ0luZGV4TWF4LCBzbWxJbmRleCArIGNvbXBhcmVSYW5nZSk7CiAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewogICAgICAgICAgICAgICAgaWYgKCFiaWdJbmRleCkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwogICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gYmlnSW5kZXggKyAxOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCiAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IG15TWluKG5vcnRoRGlzdGFuY2UsIHdlc3REaXN0YW5jZSkgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwogICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CiAgICAgICAgICAgIG1lTWludXNPbmUgPSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4XSAtIDE7CiAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CiAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5TbWwsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCiAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc21sSW5kZXggJiYgbWVNaW51c09uZSA9PT0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4IC0gMV1bYmlnSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBzbWxBcnJheVstLXNtbEluZGV4XSwKICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0gfSk7CiAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm90SW5TbWwubGVuZ3RoICYmIG5vdEluQmlnLmxlbmd0aCkgewogICAgICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKICAgICAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCiAgICAgICAgICAgIHZhciBsaW1pdEZhaWxlZENvbXBhcmVzID0gc21sSW5kZXhNYXggKiAxMCwgZmFpbGVkQ29tcGFyZXMsCiAgICAgICAgICAgICAgICBhLCBkLCBub3RJblNtbEl0ZW0sIG5vdEluQmlnSXRlbTsKICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgaXRlbXMgdGhhdCBoYXZlIGJlZW4gYWRkZWQgYW5kIGRlbGV0ZWQgYW5kIHRyeSB0byBmaW5kIG1hdGNoZXMgYmV0d2VlbiB0aGVtLgogICAgICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gYSA9IDA7IChkb250TGltaXRNb3ZlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChub3RJblNtbEl0ZW0gPSBub3RJblNtbFthXSk7IGErKykgewogICAgICAgICAgICAgICAgZm9yIChkID0gMDsgbm90SW5CaWdJdGVtID0gbm90SW5CaWdbZF07IGQrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChub3RJblNtbEl0ZW1bJ3ZhbHVlJ10gPT09IG5vdEluQmlnSXRlbVsndmFsdWUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICBub3RJblNtbEl0ZW1bJ21vdmVkJ10gPSBub3RJbkJpZ0l0ZW1bJ2luZGV4J107CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEluQmlnSXRlbVsnbW92ZWQnXSA9IG5vdEluU21sSXRlbVsnaW5kZXgnXTsKICAgICAgICAgICAgICAgICAgICAgICAgbm90SW5CaWcuc3BsaWNlKGQsMSk7ICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIG5vdEluQmlnIGxpc3QKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSBkID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSBkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlZGl0U2NyaXB0LnJldmVyc2UoKTsKICAgIH0KCiAgICByZXR1cm4gY29tcGFyZUFycmF5czsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIE9iamVjdGl2ZToKICAgIC8vICogR2l2ZW4gYW4gaW5wdXQgYXJyYXksIGEgY29udGFpbmVyIERPTSBub2RlLCBhbmQgYSBmdW5jdGlvbiBmcm9tIGFycmF5IGVsZW1lbnRzIHRvIGFycmF5cyBvZiBET00gbm9kZXMsCiAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gICBzbyB0aGF0IGl0cyBjaGlsZHJlbiBpcyBhZ2FpbiB0aGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgbWFwcGluZ3Mgb2YgdGhlIGFycmF5IGVsZW1lbnRzLCBidXQgZG9uJ3QgcmUtbWFwIGFueSBhcnJheSBlbGVtZW50cyB0aGF0IHdlCiAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCiAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCiAgICAvLyBZb3UgY2FuIHVzZSB0aGlzLCBmb3IgZXhhbXBsZSwgdG8gYWN0aXZhdGUgYmluZGluZ3Mgb24gdGhvc2Ugbm9kZXMuCgogICAgZnVuY3Rpb24gZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChjb250aWd1b3VzTm9kZUFycmF5KSB7CiAgICAgICAgLy8gQmVmb3JlIG1vdmluZywgZGVsZXRpbmcsIG9yIHJlcGxhY2luZyBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgdGhlICJtYXAiIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQogICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIG9yIHRoYXQgbmV3IG5vZGVzIG1pZ2h0IGhhdmUgYmVlbiBpbnNlcnRlZCBpbiB0aGUgbWlkZGxlLCBmb3IgZXhhbXBsZSBieSBhIGJpbmRpbmcuIEFsc28sIHRoZXJlIG1heSBwcmV2aW91c2x5IGhhdmUgYmVlbgogICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2Ygd2hhdCBzZXQgb2YgY3VycmVudCBET00gbm9kZXMgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgICAgLy8KICAgICAgICAvLyBSdWxlczoKICAgICAgICAvLyAgIFtBXSBBbnkgbGVhZGluZyBub2RlcyB0aGF0IGFyZW4ndCBpbiB0aGUgZG9jdW1lbnQgYW55IG1vcmUgc2hvdWxkIGJlIGlnbm9yZWQKICAgICAgICAvLyAgICAgICBUaGVzZSBtb3N0IGxpa2VseSBjb3JyZXNwb25kIHRvIG1lbW9pemF0aW9uIG5vZGVzIHRoYXQgd2VyZSBhbHJlYWR5IHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcKICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCiAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aWd1b3VzIHNlcmllcyBvZiBub2RlcyB0aGF0IGFyZSBzdGlsbCBpbiB0aGUgZG9jdW1lbnQuIFNvLCBpZ25vcmUgYW55IG5vZGVzIHRoYXQKICAgICAgICAvLyAgICAgICBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCiAgICAgICAgLy8gUnVsZSBbQV0KICAgICAgICB3aGlsZSAoY29udGlndW91c05vZGVBcnJheS5sZW5ndGggJiYgIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChjb250aWd1b3VzTm9kZUFycmF5WzBdKSkKICAgICAgICAgICAgY29udGlndW91c05vZGVBcnJheS5zcGxpY2UoMCwgMSk7CgogICAgICAgIC8vIFJ1bGUgW0JdCiAgICAgICAgaWYgKGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewogICAgICAgICAgICAvLyBCdWlsZCB1cCB0aGUgYWN0dWFsIG5ldyBjb250aWd1b3VzIG5vZGUgc2V0CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGlndW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpZ3VvdXNOb2RlQXJyYXlbY29udGlndW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwgbmV3Q29udGlndW91c1NldCA9IFtjdXJyZW50XTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBuZXdDb250aWd1b3VzU2V0LnB1c2goY3VycmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC4uLiB0aGVuIG11dGF0ZSB0aGUgaW5wdXQgYXJyYXkgdG8gbWF0Y2ggdGhpcy4KICAgICAgICAgICAgLy8gKFRoZSBmb2xsb3dpbmcgbGluZSByZXBsYWNlcyB0aGUgY29udGVudHMgb2YgY29udGlndW91c05vZGVBcnJheSB3aXRoIG5ld0NvbnRpZ3VvdXNTZXQpCiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoY29udGlndW91c05vZGVBcnJheSwgWzAsIGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoXS5jb25jYXQobmV3Q29udGlndW91c1NldCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29udGlndW91c05vZGVBcnJheTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKICAgICAgICAvLyBNYXAgdGhpcyBhcnJheSB2YWx1ZSBpbnNpZGUgYSBkZXBlbmRlbnRPYnNlcnZhYmxlIHNvIHdlIHJlLW1hcCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXdNYXBwZWROb2RlcyA9IG1hcHBpbmcodmFsdWVUb01hcCwgaW5kZXgpIHx8IFtdOwoKICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwogICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKGZpeFVwTm9kZXNUb0JlTW92ZWRPclJlbW92ZWQobWFwcGVkTm9kZXMpLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQogICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAogICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCiAgICAgICAgICAgIG1hcHBlZE5vZGVzLnNwbGljZSgwLCBtYXBwZWROb2Rlcy5sZW5ndGgpOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gKG1hcHBlZE5vZGVzLmxlbmd0aCA9PSAwKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzWzBdKSB9IH0pOwogICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKICAgIH0KCiAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5ID0gInNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmdfbGFzdE1hcHBpbmdSZXN1bHQiOwoKICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgPSBmdW5jdGlvbiAoZG9tTm9kZSwgYXJyYXksIG1hcHBpbmcsIG9wdGlvbnMsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykgewogICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKICAgICAgICB2YXIgbGFzdEFycmF5ID0ga28udXRpbHMuYXJyYXlNYXAobGFzdE1hcHBpbmdSZXN1bHQsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmFycmF5RW50cnk7IH0pOwogICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5KTsKCiAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0ID0gW107CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKICAgICAgICB2YXIgbm9kZXNUb0RlbGV0ZSA9IFtdOwogICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0Zvck1vdmVDYWxsYmFja3MgPSBbXTsKICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBtYXBEYXRhOwoKICAgICAgICBmdW5jdGlvbiBpdGVtTW92ZWRPclJldGFpbmVkKGVkaXRTY3JpcHRJbmRleCwgb2xkUG9zaXRpb24pIHsKICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCiAgICAgICAgICAgICAgICBpdGVtc0Zvck1vdmVDYWxsYmFja3NbZWRpdFNjcmlwdEluZGV4XSA9IG1hcERhdGE7CiAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcE5vZGVzVG9CZU1vdmVkT3JSZW1vdmVkCiAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKTsKICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwogICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChpdGVtc1tpXS5tYXBwZWROb2RlcywgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewogICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CiAgICAgICAgICAgIHN3aXRjaCAoZWRpdFNjcmlwdEl0ZW1bJ3N0YXR1cyddKSB7CiAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAicmV0YWluZWQiOgogICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJhZGRlZCI6CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBOZXh0IHJlbW92ZSBub2RlcyBmb3IgZGVsZXRlZCBpdGVtcyAob3IganVzdCBjbGVhbiBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5leHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZG9tTm9kZSksIGxhc3ROb2RlLCBub2RlOyBtYXBEYXRhID0gaXRlbXNUb1Byb2Nlc3NbaV07IGkrKykgewogICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCiAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChtYXBEYXRhLCBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGRvbU5vZGUsIG1hcHBpbmcsIG1hcERhdGEuYXJyYXlFbnRyeSwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSkpOwoKICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgIT09IG5leHROb2RlKQogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biB0aGUgY2FsbGJhY2tzIGZvciBuZXdseSBhZGRlZCBub2RlcyAoZm9yIGV4YW1wbGUsIHRvIGFwcGx5IGJpbmRpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgICAgICBtYXBEYXRhLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaywgY2FsbCBpdCBhZnRlciByZW9yZGVyaW5nLgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQogICAgICAgIC8vIGNhbGxiYWNrIGluc3RlYWQgcmVtb3ZlcyB0aGUgbm9kZXMgcmlnaHQgYXdheSwgaXQgd291bGQgYmUgbW9yZSBlZmZpY2llbnQgdG8gc2tpcCByZW9yZGVyaW5nIHRoZW0uCiAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgogICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBGaW5hbGx5IGNhbGwgYWZ0ZXJNb3ZlIGFuZCBhZnRlckFkZCBjYWxsYmFja3MKICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CiAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKICAgICAgICAvLyBTdG9yZSBhIGNvcHkgb2YgdGhlIGFycmF5IGl0ZW1zIHdlIGp1c3QgY29uc2lkZXJlZCBzbyB3ZSBjYW4gZGlmZmVyZW5jZSBpdCBuZXh0IHRpbWUKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7CmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID0gZmFsc2U7Cn0KCmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdXNlTm9kZXNJZkF2YWlsYWJsZSA9ICEoa28udXRpbHMuaWVWZXJzaW9uIDwgOSksIC8vIElFPDkgY2xvbmVOb2RlIGRvZXNuJ3Qgd29yayBwcm9wZXJseQogICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCiAgICBpZiAodGVtcGxhdGVOb2RlcykgewogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CiAgICB9Cn07Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwprby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7Cgprby5leHBvcnRTeW1ib2woJ25hdGl2ZVRlbXBsYXRlRW5naW5lJywga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUpOwooZnVuY3Rpb24oKSB7CiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRGV0ZWN0IHdoaWNoIHZlcnNpb24gb2YganF1ZXJ5LXRtcGwgeW91J3JlIHVzaW5nLiBVbmZvcnR1bmF0ZWx5IGpxdWVyeS10bXBsCiAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAogICAgICAgIC8vIHdoaWNoIEtPIGludGVybmFsbHkgcmVmZXJzIHRvIGFzIHZlcnNpb24gIjIiLCBzbyBvbGRlciB2ZXJzaW9ucyBhcmUgbm8gbG9uZ2VyIGRldGVjdGVkLgogICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgodHlwZW9mKGpRdWVyeSkgPT0gInVuZGVmaW5lZCIpIHx8ICEoalF1ZXJ5Wyd0bXBsJ10pKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ3RtcGwnXVsnb3BlbiddLnRvU3RyaW5nKCkuaW5kZXhPZignX18nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCiAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3VyIHZlcnNpb24gb2YgalF1ZXJ5LnRtcGwgaXMgdG9vIG9sZC4gUGxlYXNlIHVwZ3JhZGUgdG8galF1ZXJ5LnRtcGwgMS4wLjBwcmUgb3IgbGF0ZXIuIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnlbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQogICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwogICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKICAgICAgICAgICAgICAgIHRlbXBsYXRlVGV4dCA9ICJ7e2tvX3dpdGggJGl0ZW0ua29CaW5kaW5nQ29udGV4dH19IiArIHRlbXBsYXRlVGV4dCArICJ7ey9rb193aXRofX0iOwoKICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5Wyd0ZW1wbGF0ZSddKG51bGwsIHRlbXBsYXRlVGV4dCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBbYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dOyAvLyBQcmV3cmFwIHRoZSBkYXRhIGluIGFuIGFycmF5IHRvIHN0b3AganF1ZXJ5LnRtcGwgZnJvbSB0cnlpbmcgdG8gdW53cmFwIGFueSBhcnJheXMKICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeVsnZXh0ZW5kJ10oeyAna29CaW5kaW5nQ29udGV4dCc6IGJpbmRpbmdDb250ZXh0IH0sIG9wdGlvbnNbJ3RlbXBsYXRlT3B0aW9ucyddKTsKCiAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgogICAgICAgICAgICBqUXVlcnlbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwogICAgICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKICAgICAgICAgICAgcmV0dXJuICJ7e2tvX2NvZGUgKChmdW5jdGlvbigpIHsgcmV0dXJuICIgKyBzY3JpcHQgKyAiIH0pKCkpIH19IjsKICAgICAgICB9OwoKICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewogICAgICAgICAgICBkb2N1bWVudC53cml0ZSgiPHNjcmlwdCB0eXBlPSd0ZXh0L2h0bWwnIGlkPSciICsgdGVtcGxhdGVOYW1lICsgIic+IiArIHRlbXBsYXRlTWFya3VwICsgIjwvc2NyaXB0PiIpOwogICAgICAgIH07CgogICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgogICAgICAgICAgICB9OwogICAgICAgICAgICBqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ2tvX3dpdGgnXSA9IHsKICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlRW5naW5lKCk7CgogICAgLy8gVXNlIHRoaXMgb25lIGJ5IGRlZmF1bHQgKm9ubHkgaWYganF1ZXJ5LnRtcGwgaXMgcmVmZXJlbmNlZCoKICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCiAgICAgICAga28uc2V0VGVtcGxhdGVFbmdpbmUoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UpOwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKfSkoKTsKfSk7Cn0pKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3Isd2luZG93WyJqUXVlcnkiXSk7Cn0pKCk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAna25vY2tvdXQnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2tvX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIga28gPSBfX2tvX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQsIGtub2Nrb3V0VGVtcGxhdGVzID0gewogICAgfTsKICAgIHZhciBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbiA9IGZ1bmN0aW9uICh0ZW1wbGF0ZU1hbmFnZXIpIHsKICAgICAgICB2YXIgVGhydXN0VGVtcGxhdGVTb3VyY2UgPSAoa28pLnRlbXBsYXRlU291cmNlcy50aHJ1c3RUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3RUZW1wbGF0ZVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5odG1sOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmh0bWwgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ1RocnVzdCBUZW1wbGF0ZSBkb2VzIG5vdCBzdXBwb3J0IHJld3JpdGluZy4uLicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRlbXBsYXRlLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAvLyBCZWdpbiBpbnRlZ3JhdGlvbiBvZiB0ZW1wbGF0ZSBwbHVnaW4sIHdpdGggS25vY2tvdXQuCiAgICAgICAgdmFyIG9sZEVuZ2luZSA9IChrbykubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2U7CiAgICAgICAgdmFyIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgY29udmVudGlvblRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IGtvLnV0aWxzLmV4dGVuZChuZXcgKGtvKS50ZW1wbGF0ZUVuZ2luZSgpLCB7CiAgICAgICAgICAgIHJlbmRlclRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZih0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGhpcy5ldmFsdWF0b3JzOwogICAgICAgICAgICAgICAgICAgIGlmKCFldmFsdWF0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9ycyA9IGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwcmVjb21waWxlZCA9IHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0gdGVtcGxhdGVNYW5hZ2VyLmNvbXBpbGUoJ3t7IHdpdGgoJGRhdGEpIHsgfX0gJyArIHRlbXBsYXRlU291cmNlLnRleHQoKSArICIge3sgfSB9fSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSB0ZW1wbGF0ZSBhbmQgcGFyc2UgaXRzIG91dHB1dCBpbnRvIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE1hcmt1cCA9IHRlbXBsYXRlU291cmNlLnRlbXBsYXRlLmNvbXBpbGVkKGJpbmRpbmdDb250ZXh0KS5yZXBsYWNlKC9ccysvZywgIiAiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGtvKS51dGlscy5wYXJzZUh0bWxGcmFnbWVudChyZW5kZXJlZE1hcmt1cCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLnJlbmRlclRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrOiBmdW5jdGlvbiAoc2NyaXB0KSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5ldmFsdWF0b3JDYWNoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9yQ2FjaGUgPSBldmFsdWF0b3JzLmxlZnQgKyBzY3JpcHQgKyBldmFsdWF0b3JzLnJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yQ2FjaGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1ha2VUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgICAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSB0ZW1wbGF0ZU1hbmFnZXIuZ2V0KHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGhydXN0VGVtcGxhdGVTb3VyY2UoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5tYWtlVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgKGtvKS5zZXRUZW1wbGF0ZUVuZ2luZShuZXcgKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUoKSk7CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIGluaXRLbm9ja291dEludGVncmF0aW9uKHRocnVzdC50ZW1wbGF0ZSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMua25vY2tvdXRFbmdpbmUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9a25vY2tvdXQuZW5naW5lLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24vdGVtcGxhdGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBURU1QTEFURVMgPSAndGVtcGxhdGVzJywgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZDsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgVEVNUExBVEVTCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICB2YXIgdGVtcGxhdGVzID0gbW9kLmNvbnZlbnRpb24oVEVNUExBVEVTKSwgaW52ZXJ0ZWRUZW1wbGF0ZXMgPSB1dGlsLmludmVydCh0ZW1wbGF0ZXMpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYodGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJzID0gW107CiAgICAgICAgICAgICAgICBlYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnMucHVzaChmYWNhZGUuZmV0Y2godGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSA9IHdoZW4uYWxsKGRlZmVycykudGhlbihmdW5jdGlvbiAobG9hZGVkVGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChpbnZlcnRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gXy5maW5kKGxvYWRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LnNob3J0TmFtZSA9PT0gaSB8fCB4Lm5hbWUgPT09IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50ZW1wbGF0ZXNbaV0gPSB0ZW1wbGF0ZS5jb21waWxlZDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWNhZGUubG9hZGluZ1Byb21pc2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnRlbXBsYXRlID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXRlbXBsYXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LnNwYS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvbWVkaWF0b3IuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsIAogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycKICAgIF07CiAgICAvKioKICAgIERlZmluZXMgdGhlIHZhbHVlIG9mIGN1c3RvbSBwYXJhbWV0ZXJzLgogICAgWW91IGNhbiBhbHNvIGRlZmluZSBjdXN0b20gcGFyYW1ldGVycyB0byBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYW5kIHRoZW4gdXNlIHRoZW0gaW4geW91ciByb3V0ZXMKICAgIAogICAgQHByb3BlcnR5IHBhcmFtcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnBhcmFtcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBwcmVkZmluZWQgcm91dGVzIHRvIGJlIHVzZWQgYnkgc3BhLgogICAgCiAgICBAcHJvcGVydHkgcm91dGVzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucm91dGVzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGZpbGUgZXhzdGVuaW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgd2hlbiByZXNvbHZpbmcgcm91dGVzIGFuZCBzdGFydGluZyBtb2R1bGVzLgogICAgCiAgICBAcHJvcGVydHkgZmlsZUV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgKiovCiAgICBleHBvcnRzLmZpbGVFeHRlbnNpb24gPSAnLmh0bWwnOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2RvbS9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciAkID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciBwYXJzZUZ1bGxIcmVmID0gZnVuY3Rpb24gKGhyZWYpIHsKICAgICAgICB2YXIgYmFzZVVybCA9IGxvY2F0aW9uLnBhdGhuYW1lLnN1YnN0cmluZygwLCBsb2NhdGlvbi5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICBpZihocmVmLmluZGV4T2YoJy8nKSAhPSAtMSkgewogICAgICAgICAgICBocmVmID0gaHJlZi5zdWJzdHJpbmcoaHJlZi5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBocmVmID0gJy8nICsgaHJlZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhc2VVcmwgKyBocmVmOwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QuZG9tCiAgICBAc3VibW9kdWxlIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9kb21fXyBDb252ZW50aW9uIC0gU2luZ2xlIFBhZ2UgQXBwIExpbmsKICAgICoKICAgICogUmVxdWlyZXMgdGhydXN0L2RvbQogICAgKgogICAgKiBAZm9yIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3BhO2luawogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhydXN0LmNvbmZpZywgc3BhID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgJC5vbignY2xpY2snLCAnYScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHBhcnNlRnVsbEhyZWYodGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICBpZihsaW5rLmluZGV4T2YoY29uZmlnLnVybC5wYXRoKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHNwYS5uYXZpZ2F0ZShsaW5rKTsKICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnNwYWxpbmsgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3BhbGluay5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3Qvc3BhX18gQ29udmVudGlvbiAtIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBzaW5nbGUgcGFnZSBhcHAgc3RhcnQgY29udmVudGlvbiwgZG9lcyB0aGUgYWN0dWFsIHN0YXJ0aW5nIG9mIHRoZSBwbHVnaW4sIGluIGFkZGl0aW9uIGl0IGFsc28gZGVsYXlzCiAgICAqIGZ1bGwgb3JiaXQsIHVudGlsIGFueSBtb2R1bGUgaXQgaGFzIHN0YXJ0ZWQgaGFzIGJlZW4gbG9hZGVkLgogICAgKgogICAgKiBAZm9yIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3RhcnQKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgIHJvdXRlci5zdGFydCgpOwogICAgICAgICAgICByZXR1cm4gdGhydXN0LnNwYS5zdGFydGluZ01vZHVsZVByb21pc2UgfHwgbnVsbDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICdoYXMnLCAndGhydXN0L2NvbmZpZycsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19jb25maWdfXywgX19tZWRpYXRvckNvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9oYXMuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgLy9pbXBvcnQgZXZlbnRzID0gbW9kdWxlKCd0aHJ1c3QvZXZlbnRzJyk7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciBtZWRpYXRvckNvbmZpZyA9IF9fbWVkaWF0b3JDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdNZWRpYXRvcic7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IC8vIHN0cmluZyBmb3JtYXQgbWV0aG9kCiAgICBfLmV4dGVuZCwgd2hlbiA9IC8vIG9iamVjdCBleHRlbnNpb24gbWV0aG9kCiAgICB1dGlsLndoZW4sIG1lbW9pemUgPSBfLm1lbW9pemUsIG1lZGlhdG9yLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBjID0gY29uZmlnOwogICAgLy8jcmVnaW9uIEZhY2FkZQogICAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IG1lZGlhdG9yIGZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0Lk1lZGlhdG9yfSBwYXJlbnQgVGhlIHBhcmVudCBtZWRpYXRvciB0byBjcmVhdGUgdGhlIGZhY2FkZSBvbi4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbWVkaWF0b3JGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZTsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cyhtb2R1bGUpOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgICAgICAvKioKICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0IG9mIGEgbWVkaWF0b3IgZmFjYWRlLCBzdGFydCBjcmVhdGVzIHRoZSBpbnRlcm5hbCBzdWJzY3JpcHRpb25zIGFycmF5LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYoIXRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdDsKICAgICAgICAvKioKICAgICAgICBPdmVycmlkZXMgdGhlIHN1YnNjcmliZSBtZXRob2QsIGFuZCB0cmFja3MgdGhlIGFueSBldmVudCB0aGF0IGlzIGJvdW5kLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAqKi8KICAgICAgICAobWVkaWF0b3JGYWNhZGUpLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudHM6IGV2ZW50cywKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEV2ZW50cy5zdWJzY3JpYmUuY2FsbCh0aGlzLCBldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICB9OwogICAgICAgIC8qKgogICAgICAgIFVuc3Vic2NyaWJlcyBmcm9tIGFsbCBldmVudHMgdGhhdCB3ZXJlIHN1YnNjcmliZWQgdG8uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKHN1Yi5ldmVudHMsIHN1Yi5jYWxsYmFjaywgc3ViLmNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBtZWRpYXRvckZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vIE91ciBkZWZhdWx0IG5hbWVzcGFjZSBwcmVmaXguCiAgICAvKioKICAgIE1lZGlhdG9yIGNsYXNzLgogICAgVGhpcyBjcmVhdGVzIGEgaW5zdGFuY2Ugb2YgdGhlIG1lZGlhdG9yLCBmb3IgdXNlIGluc2lkZSB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtZWRpYXRvci4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBNZWRpYXRvcihuYW1lLCBjb25maWcpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBhcHBQYXRoID0gY29uZmlnICYmIGNvbmZpZy51cmwgJiYgY29uZmlnLnVybC5wYXRoOwogICAgICAgICAgICB0aGF0Lm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ01lZGlhdG9yOiBDcmVhdGluZyBuZXcgTWVkaWF0b3IgezB9JywgbmFtZSkpOwogICAgICAgICAgICB0aGF0LmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoJ3RocnVzdC9yZWFkeScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oJ01lZGlhdG9yOiBSZWFkeSEnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IgJiYgIShmYWNhZGVzLm1lZGlhdG9yIGluc3RhbmNlb2YgTWVkaWF0b3JGYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJtZWRpYXRvciIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtZWRpYXRvcjsKICAgICAgICAgICAgaWYoZmFjYWRlcy5tZWRpYXRvcikgewogICAgICAgICAgICAgICAgZmFjYWRlcy5tZWRpYXRvci51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIG1lZGlhdG9yID0gZmFjYWRlcy5tZWRpYXRvcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lZGlhdG9yID0gZmFjYWRlcy5tZWRpYXRvciA9IChtb2QpLm1lZGlhdG9yID0gbmV3IE1lZGlhdG9yRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lZGlhdG9yOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IuY29uZmlnID0gbWVkaWF0b3JDb25maWc7CiAgICAgICAgcmV0dXJuIE1lZGlhdG9yOwogICAgfSkoKTsKICAgIGV4cG9ydHMuTWVkaWF0b3IgPSBNZWRpYXRvcjsgICAgCiAgICAvLyBHZXQgdGhlIGFjdHVhbCBldmVudCBtZXRob2RzIG9udG8gdGhlIE1lZGlhdG9yCiAgICBfLmV4dGVuZChNZWRpYXRvci5wcm90b3R5cGUsIEV2ZW50cyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3InLCBbJ3RocnVzdC9tZWRpYXRvci9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RhdGEvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnanF1ZXJ5JywgJ3RocnVzdC9sb2cnLCAnLi9jb25maWcnLCAndGhydXN0L2NvbmZpZycsICcuL2V2ZW50LmZhY3RvcnknLCAnLi9yZXNwb25zZS5xdWV1ZScsICd0aHJ1c3QvZXZlbnRzJywgJ3RocnVzdC9mYWNhZGUnLCAnLi9ldmVudC50eXBlcycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2pRdWVyeV9fLCBfX2xvZ19fLCBfX2NvbmZpZ19fLCBfX3RDb25maWdfXywgX19ldmVudEZhY3RvcnlfXywgX19yZXNwb25zZVF1ZXVlX18sIF9fZXZlbnRzX18sIF9fZmFjYWRlX18sIF9fZXZlbnRUeXBlc19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgalF1ZXJ5ID0gX19qUXVlcnlfXzsKCiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciBldmVudEZhY3RvcnkgPSBfX2V2ZW50RmFjdG9yeV9fOwoKICAgIHZhciByZXNwb25zZVF1ZXVlID0gX19yZXNwb25zZVF1ZXVlX187CgogICAgdmFyIFJlc3BvbnNlUXVldWUgPSByZXNwb25zZVF1ZXVlLlJlc3BvbnNlUXVldWU7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRGF0YSc7CiAgICBjb25maWc7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgYWpheCA9IGpRdWVyeS5hamF4LCB1aWQgPSBfLnVuaXF1ZUlkLCBkYXRhRXZlbnRXYWl0ID0gZXZlbnRUeXBlc1snd2FpdCddLCBkYXRhRXZlbnRTdGFydCA9IGV2ZW50VHlwZXNbJ3N0YXJ0J10sIGRhdGFFdmVudFN0b3AgPSBldmVudFR5cGVzWydzdG9wJ10sIGRhdGFFdmVudFN0YXR1cyA9IGV2ZW50VHlwZXNbJ3N0YXR1cyddLCBhcmd1bWVudFJlc29sdmVyID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QoXy50b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIH07CiAgICB9OwogICAgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbCA9ICEhdENvbmZpZy51cmwudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgIHZhciBqRG9jID0galF1ZXJ5KGRvY3VtZW50KTsKICAgIGV2ZW50RmFjdG9yeS5pbml0KGpEb2MpOwogICAgLy8jcmVnaW9uIERhdGFGYWNhZGUKICAgIC8qKgogICAgVGhlIGRhdGEgZmFjYWRlIHRoYXQgaXMgaGFuZGVkIG9mZiB0byBtb2R1bGVzLgogICAgCiAgICAKICAgIEVuYWJsZXMgZGF0YSB0cmFuc3BvcnQsIHVzaW5nIGpRdWVyeSBmb3IgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0LmRhdGEuRGF0YX0gcGFyZW50IFRoZSBwYXJlbnQgdGhydXN0IGRhdGEgb2JqZWN0IHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvci4KICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgRGF0YUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRhdGFGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZSArICctZGF0YSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLnJlc3BvbnNlUXVldWUgPSBwYXJlbnQucmVzcG9uc2VRdWV1ZTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSBwYXJlbnQuZGVmYXVsdHM7CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IHBhcmVudC5hcHBQYXRoOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKGRhdGFGYWNhZGUucHJvdG90eXBlLCBldmVudHMpOwogICAgICAgIHJldHVybiBkYXRhRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLyoqCiAgICBUaGUgbWFzdGVyIGRhdGEgcGx1Z2luLgogICAgCiAgICAKICAgIEVuYWJsZXMgZGF0YSB0cmFuc3BvcnQsIHVzaW5nIGpRdWVyeSBmb3IgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuRGF0YQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lLgogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3J9IG1lZGlhdG9yIFRoZSB0aHJ1c3QgbWVkaWF0b3IgaW5zdGFuY2UuCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0aHJ1c3QgaW5zdGFuY2UgY29uZmlndXJhdGlvbi4KICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgRGF0YSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRGF0YShuYW1lLCBtZWRpYXRvciwgY29uZmlnKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGE6IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLnJlc3BvbnNlUXVldWUgPSBuZXcgUmVzcG9uc2VRdWV1ZSh0aGlzLCBjb25maWcuZGF0YS5zdGFydFRpbWVvdXQsIGNvbmZpZy5kYXRhLmZpbmlzaFRpbWVvdXQpOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAodGhpcykubWVkaWF0b3IuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICBjYWNoZTogY29uZmlnLmRhdGEuY2FjaGUsCiAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCwKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgICAgICB1cmw6ICcnLAogICAgICAgICAgICAgICAgZGF0YTogJycsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgICAgX19tZWRpYXRvcl9kYXRhX2ZpcmVkX186IHRydWUsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IGNvbmZpZy51cmwucGF0aCArICcvJzsKICAgICAgICB9CiAgICAgICAgRGF0YS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgRGF0YUZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBhdmFpbGFibGUgZmFjYWRlcwogICAgICAgIEByZXR1cm5zIHtEYXRhRmFjYWRlfSBUaGUgbmV3IERhdGFGYWNhZGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYobW9kLmRhdGEgJiYgIShmYWNhZGVzLmRhdGEgaW5zdGFuY2VvZiBEYXRhRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZGF0YSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZihmYWNhZGVzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZGF0YS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhID0gbW9kLmRhdGEgPSBuZXcgRGF0YUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3REYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAnZ2V0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0ID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdwb3N0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5hamF4ID0gLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvcHRpb25zLCB0eXBlLCBiZWZvcmVTZW5kOwogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnRGF0YVt7MH1dOiBGZXRjaGluZyBkYXRhIGZyb20gInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdXJsKSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gdXRpbC5maXh1cFVybCh1cmwsIHRoYXQuYXBwUGF0aCk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgIHZhciBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICAgICAgdHlwZSA9IHNldHRpbmdzLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgewogICAgICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IHV0aWwubm9vcAogICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgYWpheCh1cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcihkZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICB9LCB0aGF0LmRlZmF1bHRzLCBzZXR0aW5ncywgewogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHR5cGUgPSBvcHRpb25zLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2VRdWV1ZS5hZGRUb1F1ZXVlKHR5cGUsIHVybCwgb3B0aW9ucyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gRGF0YTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRhdGEgPSBEYXRhOyAgICAKICAgIF8uZXh0ZW5kKERhdGEucHJvdG90eXBlLCBFdmVudHMpOwogICAgXy5leHRlbmQoRGF0YUZhY2FkZS5wcm90b3R5cGUsIERhdGEucHJvdG90eXBlKTsKICAgIC8vIFRha2UgYSBob2xkIG9mIGpRdWVyeS4uLiB0aGlzIGlzIHN1cmUgdG8gYmUgY29udHJhdmVzaWFsCiAgICBqUXVlcnkuYWpheCA9IChEYXRhKS5wcm90b3R5cGUuYWpheDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhJywgWyd0aHJ1c3QvZGF0YS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RvbS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL3N1YmpxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3N1YmpxdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgdFF1ZXJ5ID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRG9tJzsKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIGJpbmQgPSBfLmJpbmQsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHdoZW4gPSB1dGlsLndoZW4sIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICAvLyNyZWdpb24gRG9tRmFjYWRlCiAgICB2YXIgRG9tRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZG9tRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gcGFyZW50Lm5hbWU7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0UXVlcnkoZG9jdW1lbnQsIHVuZGVmaW5lZCwgdGhpcy5uYW1lKTsKICAgICAgICB9KTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoZmFrZSkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IHRoaXMuX2ludGVybmFsRXZlbnRzIHx8IFtdOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBJbml0YWxpemluZyB7MX1Eb20gZmFjYWRlJywgdGhpcy5uYW1lLCBmYWtlID8gJ2Zha2UgJyA6ICcnKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0YXJ0aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdG9wcGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsRXZlbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxFdmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBzdWIuY29udGV4dC5vZmYuYXBwbHkodGhpcywgKGlzQXJyYXkoc3ViKSkgPyBzdWIgOiAoaXNBcnJheShzdWIuYXJncykpID8gc3ViLmFyZ3MgOiBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBEZXN0cm95aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ludGVybmFsRXZlbnRzOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBkb21GYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gRG9tCiAgICB2YXIgRG9tID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBEb20obmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKG1lZGlhdG9yKS5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpLnByb21pc2UudGhlbihmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gewogICAgICAgICAgICAgICAgfSwgZmFjYWRlID0gdGhhdC5jcmVhdGVGYWNhZGUodGhydXN0LCBtb2QsIHsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIERvbS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5jb25maWcgPSBjb25maWc7CiAgICAgICAgRG9tLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20gJiYgIShmYWNhZGVzLmRvbSBpbnN0YW5jZW9mIERvbUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRvbSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb207CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRvbS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb20gPSBuZXcgRG9tRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBEb207CiAgICB9KSgpOwogICAgZXhwb3J0cy5Eb20gPSBEb207ICAgIAogICAgLy8jZW5kcmVnaW9uCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbScsIFsndGhydXN0L2RvbS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L3RlbXBsYXRlL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ2RvbVJlYWR5JywgJ3RocnVzdC9mYWNhZGUnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fZG9tUmVhZHlfXywgX19mYWNhZGVfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICAKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUZW1wbGF0ZSc7CiAgICBjb25maWc7CiAgICB2YXIgTE9ORyA9ICdsb25nJywgU0hPUlQgPSAnc2hvcnQnLCBJRCA9ICdpZCcsIGRlZXBDb3B5ID0gXy5tZXJnZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGJpbmQgPSBfLmJpbmQsIHdoZW4gPSB1dGlsLndoZW4sIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIGdldExvbmdOYW1lID0gZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9ICh0aGF0LnNob3J0TmFtZShuYW1lKSArICcuJyArICh0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbikudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0U2hvcnROYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHJlZHVjZSh0aGF0LnRlbXBsYXRlVHlwZXMsIGZ1bmN0aW9uIChtZW1vLCB4KSB7CiAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UoJy4nICsgeC50b0xvd2VyQ2FzZSgpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgfSwgbmFtZS50b0xvd2VyQ2FzZSgpKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRUZW1wbGF0ZUlkID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLnJlcGxhY2UoL1wvL2csICctJyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAcmVxdWlyZXMgdGhydXN0LmRhdGEKICAgICoqLwogICAgLyoqCiAgICBUaGUgdGVtcGxhdGUgcGx1Z2luIGNvbnN0dXJjdG9yLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGNvbmZpZyBvYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSB0aHJ1c3QgZGF0YSBpbnN0YW5jZQogICAgQHVzZXMgdGhydXN0LmRhdGEuRGF0YQogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGVtcGxhdGUoY29uZmlnLCBkYXRhKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGVDb25maWcgPSB0aGlzLmNvbmZpZyA9IGNvbmZpZy50ZW1wbGF0ZTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZVR5cGVzID0gbWFwKHRlbXBsYXRlQ29uZmlnLnR5cGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGxvbmc6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzaG9ydDogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlkOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubG9uZ05hbWUgPSBtZW1vaXplKGJpbmQoZ2V0TG9uZ05hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5zaG9ydE5hbWUgPSBtZW1vaXplKGJpbmQoZ2V0U2hvcnROYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVJZCA9IG1lbW9pemUoYmluZChnZXRUZW1wbGF0ZUlkLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuZW5naW5lcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5kYXRhID0gZGF0YTsKICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAodGVtcGxhdGVDb25maWcudGVtcGxhdGVQYXRoc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGUpCiAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICBkb21SZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgKF8oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXguZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgfSkuZWFjaChiaW5kKHRoYXQuY3JlYXRlRnJvbURvbU5vZGUsIHRoYXQpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IG51bGwsIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMubG9uZ1t0aGF0LmxvbmdOYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuc2hvcnRbdGhhdC5zaG9ydE5hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5pZFt0aGF0LnRlbXBsYXRlSWQobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuc2V0ID0gLyoqCiAgICAgICAgU2V0cyBhIHRlbXBsYXRlIHRvIHRoZSBjYWNoZSwgd2l0aCB0aGUgZ2l2ZW4gaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2Qgc2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjb21waWxlZFRlbXBsYXRlIFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCB0ZW1wbGF0ZUlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICB0ZW1wbGF0ZXMubG9uZ1tsb25nTmFtZV0gPSB0ZW1wbGF0ZXMuc2hvcnRbc2hvcnROYW1lXSA9IHRlbXBsYXRlcy5pZFt0ZW1wbGF0ZUlkXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBpZDogdGVtcGxhdGVJZCwKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICBodG1sOiBodG1sLAogICAgICAgICAgICAgICAgY29tcGlsZWQ6IGNvbXBpbGVkVGVtcGxhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5oYXMgPSAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiAhIXRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLm5ld1RlbXBsYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBnaXZlbiB0aGUgaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgbmV3VGVtcGxhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZQogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXcgdGVtcGxhdGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgaHRtbCwgaHRtbC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoaHRtbCwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY29tcGlsZSA9IC8qKgogICAgICAgIENvbXBpbGVzIGEgdGVtcGxhdGUgZ2l2ZW4gdGhlIGh0bWwgYW5kIHRoZSBlbmdpbmUgdHlwZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY29tcGlsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSBodG1sIHRvIGdlbmVyYXRlIHRoZSB0ZW1wbGF0ZSBmcm9tCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lIHRoYXQgaXMgYmVpbmcgdXNlZC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgaWYoIWVuZ2luZSkgewogICAgICAgICAgICAgICAgZW5naW5lID0gdGhhdC5lbmdpbmVzW3RoYXQuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgZW5naW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lOwogICAgICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGVuZ2luZS50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGluZ01ldGhvZChodG1sKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5mZXRjaCA9IC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdHlwZSA9IHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSkpIHsKICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhhdC5kYXRhLmdldCh0aGF0LmNvbmZpZy5iYXNlVXJsICsgbG9uZ05hbWUsIHsKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnLAogICAgICAgICAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgICAgICAgIH0pLnRoZW4od2hlbi5hcHBseShmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5lbmdpbmVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgdGhhdC5lbmdpbmVzW3R5cGVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5jb25maWcudGVtcGxhdGVQYXRoc1t0eXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0eXBlKQogICAgICAgICAgICAgICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwgZGVmZXIucmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRnJvbURvbU5vZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGZyb20gdGhlIGdpdmVuIERPTSBOb2RlCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZyb21Eb21Ob2RlCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7Tm9kZX0gZWxlbWVudCBUSGUgZG9tZSBlbGVtZW50LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5uZXdUZW1wbGF0ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpLCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10eXBlJyksIGVsZW1lbnQudGV4dCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVJbnN0YW5jZSA9IHRocnVzdC50ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IGZhY2FkZXMudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgbW9kLnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZmV0Y2gsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZ2V0LCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGhhczogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmhhcywgdGVtcGxhdGVJbnN0YW5jZSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gVGVtcGxhdGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UZW1wbGF0ZSA9IFRlbXBsYXRlOyAgICAKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGV9IHBhcmVudCBUaGUgdGVtcGxhdGUgaW5zdGFuY2UgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgKiovCiAgICB2YXIgVGVtcGxhdGVGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy10ZW1wbGF0ZSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIGV4dGVuZCh0aGlzLCB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZChwYXJlbnQuZmV0Y2gsIHBhcmVudCksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQocGFyZW50LmdldCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGhhczogYmluZChwYXJlbnQuaGFzLCBwYXJlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUZhY2FkZTsKICAgIH0pKCk7CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIHRocnVzdC90ZW1wbGF0ZSBieSBwYXRoLgogICAgUmVxdWlyZXMgdGhlIGluc3RhbmNlLCB0aGF0IHRoZSB0ZW1wbGF0ZSBpcyBleHBlY3RlZCB0byBjb21lIGZyb20uCiAgICB0aHJ1c3RJbnN0YW5jZVs6ZW5naW5lTmFtZV06dGVtcGxhdGVQYXRoCiAgICAKICAgIFByZWZpeCB3aXRoIDxlbmdpbmVOYW1lPjogdG8gc2VsZWN0IGEgc3BlY2lmaWMgdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWdsb2JhbDp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gU3BlY2lmaWMgdGVtcGxhdGUKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6dGVtcGxhdGVzL215VGVtcGxhdGUgPSBVc2VzIGRlZmF1bHQgZXh0ZW5zaW9uIGZyb20gY29uZmlnCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UzOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUgd2l0aCB0aGUgZGVmYXVsdCBleHRlbnNpb24KICAgIAogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICAvLyBOb3QgY29tcGxldGVkIHlldAogICAgLy8gU2hvdWxkIGJlaGF2ZSBzaW1pbGFybHkgdG8gdGV4dCEKICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGxvYWQobmFtZTogc3RyaW5nLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICAvL3sKICAgIC8vICAgIHZhciB0ZW1wbGF0ZVBhdGggPSBuYW1lLAogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lLAogICAgLy8gICAgICAgIGNvbG9uID0gdGVtcGxhdGVQYXRoLmluZGV4T2YoJzonKTsKICAgIC8vCXZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgIC8vICAgICAgICBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwKICAgIC8vCQl0ZW1wbGF0ZUVuZ2luZSA9IHBhcnRzWzFdLAogICAgLy8JCXRlbXBsYXRlUGF0aCA9IHBhcnRzWzJdIHx8IHRlbXBsYXRlRW5naW5lOwogICAgLy8gICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMikKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSA9IG51bGw7CiAgICAvLwkvL3ZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgIC8vICAgIC8vIEdldCB0aGUgZGF0YSBwbHVnaW4uCiAgICAvLyAgICBwYXJlbnRSZXF1aXJlKFsndGhydXN0IWRhdGE6JyArIGluc3RhbmNlTmFtZV0sIChkYXRhUGx1Z2luKSA9PgogICAgLy8gICAgewogICAgLy8gICAgICAgIHZhciBkYXRhUGx1Z2luID0gZGF0YVBsdWdpbgogICAgLy8gICAgfSk7CiAgICAvL30KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUnLCBbJ3RocnVzdC90ZW1wbGF0ZS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCgoKLy8KLy8gR2VuZXJhdGVkIG9uIFN1biBEZWMgMTYgMjAxMiAyMjo0NzowNSBHTVQtMDUwMCAoRVNUKSBieSBOb2Rlaml0c3UsIEluYyAoVXNpbmcgQ29kZXN1cmdlb24pLgovLyBWZXJzaW9uIDEuMS45Ci8vCgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCgovKgogKiBicm93c2VyLmpzOiBCcm93c2VyIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkgZm9yIGRpcmVjdG9yLgogKgogKiAoQykgMjAxMSwgTm9kZWppdHN1IEluYy4KICogTUlUIExJQ0VOU0UKICoKICovCgppZiAoIUFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICBBcnJheS5wcm90b3R5cGUuZmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyLCB0aGF0KSB7CiAgICB2YXIgb3RoZXIgPSBbXSwgdjsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gdGhpcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgaWYgKGkgaW4gdGhpcyAmJiBmaWx0ZXIuY2FsbCh0aGF0LCB2ID0gdGhpc1tpXSwgaSwgdGhpcykpIHsKICAgICAgICBvdGhlci5wdXNoKHYpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3RoZXI7CiAgfTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KXsKICBBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfQoKdmFyIGRsb2MgPSBkb2N1bWVudC5sb2NhdGlvbjsKCmZ1bmN0aW9uIGRsb2NIYXNoRW1wdHkoKSB7CiAgLy8gTm9uLUlFIGJyb3dzZXJzIHJldHVybiAnJyB3aGVuIHRoZSBhZGRyZXNzIGJhciBzaG93cyAnIyc7IERpcmVjdG9yJ3MgbG9naWMKICAvLyBhc3N1bWVzIGJvdGggbWVhbiBlbXB0eS4KICByZXR1cm4gZGxvYy5oYXNoID09PSAnJyB8fCBkbG9jLmhhc2ggPT09ICcjJzsKfQoKdmFyIGxpc3RlbmVyID0gewogIG1vZGU6ICdtb2Rlcm4nLAogIGhhc2g6IGRsb2MuaGFzaCwKICBoaXN0b3J5OiBmYWxzZSwKCiAgY2hlY2s6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBoID0gZGxvYy5oYXNoOwogICAgaWYgKGggIT0gdGhpcy5oYXNoKSB7CiAgICAgIHRoaXMuaGFzaCA9IGg7CiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCgpOwogICAgfQogIH0sCgogIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLm1vZGUgPT09ICdtb2Rlcm4nKSB7CiAgICAgIHRoaXMuaGlzdG9yeSA9PT0gdHJ1ZSA/IHdpbmRvdy5vbnBvcHN0YXRlKCkgOiB3aW5kb3cub25oYXNoY2hhbmdlKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhpcy5vbkhhc2hDaGFuZ2VkKCk7CiAgICB9CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24gKGZuLCBoaXN0b3J5KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoKICAgIGlmICghUm91dGVyLmxpc3RlbmVycykgewogICAgICBSb3V0ZXIubGlzdGVuZXJzID0gW107CiAgICB9CgogICAgZnVuY3Rpb24gb25jaGFuZ2Uob25DaGFuZ2VFdmVudCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IFJvdXRlci5saXN0ZW5lcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgUm91dGVyLmxpc3RlbmVyc1tpXShvbkNoYW5nZUV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vbm90ZSBJRTggaXMgYmVpbmcgY291bnRlZCBhcyAnbW9kZXJuJyBiZWNhdXNlIGl0IGhhcyB0aGUgaGFzaGNoYW5nZSBldmVudAogICAgaWYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09PSB1bmRlZmluZWQKICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNykpIHsKICAgICAgLy8gQXQgbGVhc3QgZm9yIG5vdyBIVE1MNSBoaXN0b3J5IGlzIGF2YWlsYWJsZSBmb3IgJ21vZGVybicgYnJvd3NlcnMgb25seQogICAgICBpZiAodGhpcy5oaXN0b3J5ID09PSB0cnVlKSB7CiAgICAgICAgLy8gVGhlcmUgaXMgYW4gb2xkIGJ1ZyBpbiBDaHJvbWUgdGhhdCBjYXVzZXMgb25wb3BzdGF0ZSB0byBmaXJlIGV2ZW4KICAgICAgICAvLyB1cG9uIGluaXRpYWwgcGFnZSBsb2FkLiBTaW5jZSB0aGUgaGFuZGxlciBpcyBydW4gbWFudWFsbHkgaW4gaW5pdCgpLAogICAgICAgIC8vIHRoaXMgd291bGQgY2F1c2UgQ2hyb21lIHRvIHJ1biBpdCB0d2lzZS4gQ3VycmVudGx5IHRoZSBvbmx5CiAgICAgICAgLy8gd29ya2Fyb3VuZCBzZWVtcyB0byBiZSB0byBzZXQgdGhlIGhhbmRsZXIgYWZ0ZXIgdGhlIGluaXRpYWwgcGFnZSBsb2FkCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NjMwNDAKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgd2luZG93Lm9ucG9wc3RhdGUgPSBvbmNoYW5nZTsKICAgICAgICB9LCA1MDApOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBvbmNoYW5nZTsKICAgICAgfQogICAgICB0aGlzLm1vZGUgPSAnbW9kZXJuJzsKICAgIH0KICAgIGVsc2UgewogICAgICAvLwogICAgICAvLyBJRSBzdXBwb3J0LCBiYXNlZCBvbiBhIGNvbmNlcHQgYnkgRXJpayBBcnZpZHNvbiAuLi4KICAgICAgLy8KICAgICAgdmFyIGZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgIGZyYW1lLmlkID0gJ3N0YXRlLWZyYW1lJzsKICAgICAgZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmcmFtZSk7CiAgICAgIHRoaXMud3JpdGVGcmFtZSgnJyk7CgogICAgICBpZiAoJ29ucHJvcGVydHljaGFuZ2UnIGluIGRvY3VtZW50ICYmICdhdHRhY2hFdmVudCcgaW4gZG9jdW1lbnQpIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgnb25wcm9wZXJ0eWNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChldmVudC5wcm9wZXJ0eU5hbWUgPT09ICdsb2NhdGlvbicpIHsKICAgICAgICAgICAgc2VsZi5jaGVjaygpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgeyBzZWxmLmNoZWNrKCk7IH0sIDUwKTsKCiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCA9IG9uY2hhbmdlOwogICAgICB0aGlzLm1vZGUgPSAnbGVnYWN5JzsKICAgIH0KCiAgICBSb3V0ZXIubGlzdGVuZXJzLnB1c2goZm4pOwoKICAgIHJldHVybiB0aGlzLm1vZGU7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAoIVJvdXRlciB8fCAhUm91dGVyLmxpc3RlbmVycykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGxpc3RlbmVycyA9IFJvdXRlci5saXN0ZW5lcnM7CgogICAgZm9yICh2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBmbikgewogICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICB9LAoKICBzZXRIYXNoOiBmdW5jdGlvbiAocykgewogICAgLy8gTW96aWxsYSBhbHdheXMgYWRkcyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeQogICAgaWYgKHRoaXMubW9kZSA9PT0gJ2xlZ2FjeScpIHsKICAgICAgdGhpcy53cml0ZUZyYW1lKHMpOwogICAgfQoKICAgIGlmICh0aGlzLmhpc3RvcnkgPT09IHRydWUpIHsKICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcyk7CiAgICAgIC8vIEZpcmUgYW4gb25wb3BzdGF0ZSBldmVudCBtYW51YWxseSBzaW5jZSBwdXNoaW5nIGRvZXMgbm90IG9idmlvdXNseQogICAgICAvLyB0cmlnZ2VyIHRoZSBwb3AgZXZlbnQuCiAgICAgIHRoaXMuZmlyZSgpOwogICAgfSBlbHNlIHsKICAgICAgZGxvYy5oYXNoID0gKHNbMF0gPT09ICcvJykgPyBzIDogJy8nICsgczsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIHdyaXRlRnJhbWU6IGZ1bmN0aW9uIChzKSB7CiAgICAvLyBJRSBzdXBwb3J0Li4uCiAgICB2YXIgZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0ZS1mcmFtZScpOwogICAgdmFyIGQgPSBmLmNvbnRlbnREb2N1bWVudCB8fCBmLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICBkLm9wZW4oKTsKICAgIGQud3JpdGUoIjxzY3JpcHQ+X2hhc2ggPSAnIiArIHMgKyAiJzsgb25sb2FkID0gcGFyZW50Lmxpc3RlbmVyLnN5bmNIYXNoOzxzY3JpcHQ+Iik7CiAgICBkLmNsb3NlKCk7CiAgfSwKCiAgc3luY0hhc2g6IGZ1bmN0aW9uICgpIHsKICAgIC8vIElFIHN1cHBvcnQuLi4KICAgIHZhciBzID0gdGhpcy5faGFzaDsKICAgIGlmIChzICE9IGRsb2MuaGFzaCkgewogICAgICBkbG9jLmhhc2ggPSBzOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb25IYXNoQ2hhbmdlZDogZnVuY3Rpb24gKCkge30KfTsKCnZhciBSb3V0ZXIgPSBleHBvcnRzLlJvdXRlciA9IGZ1bmN0aW9uIChyb3V0ZXMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUm91dGVyKSkgcmV0dXJuIG5ldyBSb3V0ZXIocm91dGVzKTsKCiAgdGhpcy5wYXJhbXMgICA9IHt9OwogIHRoaXMucm91dGVzICAgPSB7fTsKICB0aGlzLm1ldGhvZHMgID0gWydvbicsICdvbmNlJywgJ2FmdGVyJywgJ2JlZm9yZSddOwogIHRoaXMuc2NvcGUgICAgPSBbXTsKICB0aGlzLl9tZXRob2RzID0ge307CgogIHRoaXMuX2luc2VydCA9IHRoaXMuaW5zZXJ0OwogIHRoaXMuaW5zZXJ0ID0gdGhpcy5pbnNlcnRFeDsKCiAgdGhpcy5oaXN0b3J5U3VwcG9ydCA9ICh3aW5kb3cuaGlzdG9yeSAhPSBudWxsID8gd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlIDogbnVsbCkgIT0gbnVsbAoKICB0aGlzLmNvbmZpZ3VyZSgpOwogIHRoaXMubW91bnQocm91dGVzIHx8IHt9KTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChyKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuaGFuZGxlciA9IGZ1bmN0aW9uKG9uQ2hhbmdlRXZlbnQpIHsKICAgIHZhciBuZXdVUkwgPSBvbkNoYW5nZUV2ZW50ICYmIG9uQ2hhbmdlRXZlbnQubmV3VVJMIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgdmFyIHVybCA9IHNlbGYuaGlzdG9yeSA9PT0gdHJ1ZSA/IHNlbGYuZ2V0UGF0aCgpIDogbmV3VVJMLnJlcGxhY2UoLy4qIy8sICcnKTsKICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgdXJsKTsKICB9OwoKICBsaXN0ZW5lci5pbml0KHRoaXMuaGFuZGxlciwgdGhpcy5oaXN0b3J5KTsKCiAgaWYgKHRoaXMuaGlzdG9yeSA9PT0gZmFsc2UpIHsKICAgIGlmIChkbG9jSGFzaEVtcHR5KCkgJiYgcikgewogICAgICBkbG9jLmhhc2ggPSByOwogICAgfSBlbHNlIGlmICghZGxvY0hhc2hFbXB0eSgpKSB7CiAgICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgZGxvYy5oYXNoLnJlcGxhY2UoL14jLywgJycpKTsKICAgIH0KICB9CiAgZWxzZSB7CiAgICB2YXIgcm91dGVUbyA9IGRsb2NIYXNoRW1wdHkoKSAmJiByID8gciA6ICFkbG9jSGFzaEVtcHR5KCkgPyBkbG9jLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiBudWxsOwogICAgaWYgKHJvdXRlVG8pIHsKICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcm91dGVUbyk7CiAgICB9CgogICAgLy8gUm91dGVyIGhhcyBiZWVuIGluaXRpYWxpemVkLCBidXQgZHVlIHRvIHRoZSBjaHJvbWUgYnVnIGl0IHdpbGwgbm90CiAgICAvLyB5ZXQgYWN0dWFsbHkgcm91dGUgSFRNTDUgaGlzdG9yeSBzdGF0ZSBjaGFuZ2VzLiBUaHVzLCBkZWNpZGUgaWYgc2hvdWxkIHJvdXRlLgogICAgaWYgKHJvdXRlVG8gfHwgdGhpcy5ydW5faW5faW5pdCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLmhhbmRsZXIoKTsKICAgIH0KICB9CgogIHJldHVybiB0aGlzOwp9OwoKUm91dGVyLnByb3RvdHlwZS5leHBsb2RlID0gZnVuY3Rpb24gKCkgewogIHZhciB2ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlID8gdGhpcy5nZXRQYXRoKCkgOiBkbG9jLmhhc2g7CiAgaWYgKHYuY2hhckF0KDEpID09PSAnLycpIHsgdj12LnNsaWNlKDEpIH0KICByZXR1cm4gdi5zbGljZSgxLCB2Lmxlbmd0aCkuc3BsaXQoIi8iKTsKfTsKClJvdXRlci5wcm90b3R5cGUuc2V0Um91dGUgPSBmdW5jdGlvbiAoaSwgdiwgdmFsKSB7CiAgdmFyIHVybCA9IHRoaXMuZXhwbG9kZSgpOwoKICBpZiAodHlwZW9mIGkgPT09ICdudW1iZXInICYmIHR5cGVvZiB2ID09PSAnc3RyaW5nJykgewogICAgdXJsW2ldID0gdjsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHVybC5zcGxpY2UoaSwgdiwgcyk7CiAgfQogIGVsc2UgewogICAgdXJsID0gW2ldOwogIH0KCiAgbGlzdGVuZXIuc2V0SGFzaCh1cmwuam9pbignLycpKTsKICByZXR1cm4gdXJsOwp9OwoKLy8KLy8gIyMjIGZ1bmN0aW9uIGluc2VydEV4KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudCkKLy8gIyMjIyBAbWV0aG9kIHtzdHJpbmd9IE1ldGhvZCB0byBpbnNlcnQgdGhlIHNwZWNpZmljIGByb3V0ZWAuCi8vICMjIyMgQHBhdGgge0FycmF5fSBQYXJzZWQgcGF0aCB0byBpbnNlcnQgdGhlIGByb3V0ZWAgYXQuCi8vICMjIyMgQHJvdXRlIHtBcnJheXxmdW5jdGlvbn0gUm91dGUgaGFuZGxlcnMgdG8gaW5zZXJ0LgovLyAjIyMjIEBwYXJlbnQge09iamVjdH0gKipPcHRpb25hbCoqIFBhcmVudCAicm91dGVzIiB0byBpbnNlcnQgaW50by4KLy8gaW5zZXJ0IGEgY2FsbGJhY2sgdGhhdCB3aWxsIG9ubHkgb2NjdXIgb25jZSBwZXIgdGhlIG1hdGNoZWQgcm91dGUuCi8vClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0RXggPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlLCBwYXJlbnQpIHsKICBpZiAobWV0aG9kID09PSAib25jZSIpIHsKICAgIG1ldGhvZCA9ICJvbiI7CiAgICByb3V0ZSA9IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHZhciBvbmNlID0gZmFsc2U7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAob25jZSkgcmV0dXJuOwogICAgICAgIG9uY2UgPSB0cnVlOwogICAgICAgIHJldHVybiByb3V0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfShyb3V0ZSk7CiAgfQogIHJldHVybiB0aGlzLl9pbnNlcnQobWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KTsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0Um91dGUgPSBmdW5jdGlvbiAodikgewogIHZhciByZXQgPSB2OwoKICBpZiAodHlwZW9mIHYgPT09ICJudW1iZXIiKSB7CiAgICByZXQgPSB0aGlzLmV4cGxvZGUoKVt2XTsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKXsKICAgIHZhciBoID0gdGhpcy5leHBsb2RlKCk7CiAgICByZXQgPSBoLmluZGV4T2Yodik7CiAgfQogIGVsc2UgewogICAgcmV0ID0gdGhpcy5leHBsb2RlKCk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKUm91dGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIGxpc3RlbmVyLmRlc3Ryb3kodGhpcy5oYW5kbGVyKTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0UGF0aCA9IGZ1bmN0aW9uICgpIHsKICB2YXIgcGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsKICBpZiAocGF0aC5zdWJzdHIoMCwgMSkgIT09ICcvJykgewogICAgcGF0aCA9ICcvJyArIHBhdGg7CiAgfQogIHJldHVybiBwYXRoOwp9OwpmdW5jdGlvbiBfZXZlcnkoYXJyLCBpdGVyYXRvcikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBpZiAoaXRlcmF0b3IoYXJyW2ldLCBpLCBhcnIpID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBfZmxhdHRlbihhcnIpIHsKICB2YXIgZmxhdCA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBuID0gYXJyLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgZmxhdCA9IGZsYXQuY29uY2F0KGFycltpXSk7CiAgfQogIHJldHVybiBmbGF0Owp9CgpmdW5jdGlvbiBfYXN5bmNFdmVyeVNlcmllcyhhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogIGlmICghYXJyLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgfQogIHZhciBjb21wbGV0ZWQgPSAwOwogIChmdW5jdGlvbiBpdGVyYXRlKCkgewogICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyIHx8IGVyciA9PT0gZmFsc2UpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICBpZiAoY29tcGxldGVkID09PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KSgpOwp9CgpmdW5jdGlvbiBwYXJhbWlmeVN0cmluZyhzdHIsIHBhcmFtcywgbW9kKSB7CiAgbW9kID0gc3RyOwogIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgaWYgKHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgbW9kID0gcGFyYW1zW3BhcmFtXShzdHIpOwogICAgICBpZiAobW9kICE9PSBzdHIpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbW9kID09PSBzdHIgPyAiKFsuX2EtekEtWjAtOS1dKykiIDogbW9kOwp9CgpmdW5jdGlvbiByZWdpZnlTdHJpbmcoc3RyLCBwYXJhbXMpIHsKICB2YXIgbWF0Y2hlcywgbGFzdCA9IDAsIG91dCA9ICIiOwogIHdoaWxlIChtYXRjaGVzID0gc3RyLnN1YnN0cihsYXN0KS5tYXRjaCgvW15cd1xkXC0gJUAmXSpcKlteXHdcZFwtICVAJl0qLykpIHsKICAgIGxhc3QgPSBtYXRjaGVzLmluZGV4ICsgbWF0Y2hlc1swXS5sZW5ndGg7CiAgICBtYXRjaGVzWzBdID0gbWF0Y2hlc1swXS5yZXBsYWNlKC9eXCovLCAiKFtfLigpIVxcICVAJmEtekEtWjAtOS1dKykiKTsKICAgIG91dCArPSBzdHIuc3Vic3RyKDAsIG1hdGNoZXMuaW5kZXgpICsgbWF0Y2hlc1swXTsKICB9CiAgc3RyID0gb3V0ICs9IHN0ci5zdWJzdHIobGFzdCk7CiAgdmFyIGNhcHR1cmVzID0gc3RyLm1hdGNoKC86KFteXC9dKykvaWcpLCBsZW5ndGg7CiAgaWYgKGNhcHR1cmVzKSB7CiAgICBsZW5ndGggPSBjYXB0dXJlcy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKGNhcHR1cmVzW2ldLCBwYXJhbWlmeVN0cmluZyhjYXB0dXJlc1tpXSwgcGFyYW1zKSk7CiAgICB9CiAgfQogIHJldHVybiBzdHI7Cn0KCmZ1bmN0aW9uIHRlcm1pbmF0b3Iocm91dGVzLCBkZWxpbWl0ZXIsIHN0YXJ0LCBzdG9wKSB7CiAgdmFyIGxhc3QgPSAwLCBsZWZ0ID0gMCwgcmlnaHQgPSAwLCBzdGFydCA9IChzdGFydCB8fCAiKCIpLnRvU3RyaW5nKCksIHN0b3AgPSAoc3RvcCB8fCAiKSIpLnRvU3RyaW5nKCksIGk7CiAgZm9yIChpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIGNodW5rID0gcm91dGVzW2ldOwogICAgaWYgKGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpID4gY2h1bmsuaW5kZXhPZihzdG9wLCBsYXN0KSB8fCB+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgIX5jaHVuay5pbmRleE9mKHN0b3AsIGxhc3QpIHx8ICF+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgfmNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCkpIHsKICAgICAgbGVmdCA9IGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpOwogICAgICByaWdodCA9IGNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCk7CiAgICAgIGlmICh+bGVmdCAmJiAhfnJpZ2h0IHx8ICF+bGVmdCAmJiB+cmlnaHQpIHsKICAgICAgICB2YXIgdG1wID0gcm91dGVzLnNsaWNlKDAsIChpIHx8IDEpICsgMSkuam9pbihkZWxpbWl0ZXIpOwogICAgICAgIHJvdXRlcyA9IFsgdG1wIF0uY29uY2F0KHJvdXRlcy5zbGljZSgoaSB8fCAxKSArIDEpKTsKICAgICAgfQogICAgICBsYXN0ID0gKHJpZ2h0ID4gbGVmdCA/IHJpZ2h0IDogbGVmdCkgKyAxOwogICAgICBpID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGxhc3QgPSAwOwogICAgfQogIH0KICByZXR1cm4gcm91dGVzOwp9CgpSb3V0ZXIucHJvdG90eXBlLmNvbmZpZ3VyZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWV0aG9kcy5sZW5ndGg7IGkrKykgewogICAgdGhpcy5fbWV0aG9kc1t0aGlzLm1ldGhvZHNbaV1dID0gdHJ1ZTsKICB9CiAgdGhpcy5yZWN1cnNlID0gb3B0aW9ucy5yZWN1cnNlIHx8IHRoaXMucmVjdXJzZSB8fCBmYWxzZTsKICB0aGlzLmFzeW5jID0gb3B0aW9ucy5hc3luYyB8fCBmYWxzZTsKICB0aGlzLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICIvIjsKICB0aGlzLnN0cmljdCA9IHR5cGVvZiBvcHRpb25zLnN0cmljdCA9PT0gInVuZGVmaW5lZCIgPyB0cnVlIDogb3B0aW9ucy5zdHJpY3Q7CiAgdGhpcy5ub3Rmb3VuZCA9IG9wdGlvbnMubm90Zm91bmQ7CiAgdGhpcy5yZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgdGhpcy5oaXN0b3J5ID0gb3B0aW9ucy5odG1sNWhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5U3VwcG9ydCB8fCBmYWxzZTsKICB0aGlzLnJ1bl9pbl9pbml0ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlICYmIG9wdGlvbnMucnVuX2hhbmRsZXJfaW5faW5pdCAhPT0gZmFsc2U7CiAgdGhpcy5ldmVyeSA9IHsKICAgIGFmdGVyOiBvcHRpb25zLmFmdGVyIHx8IG51bGwsCiAgICBiZWZvcmU6IG9wdGlvbnMuYmVmb3JlIHx8IG51bGwsCiAgICBvbjogb3B0aW9ucy5vbiB8fCBudWxsCiAgfTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUucGFyYW0gPSBmdW5jdGlvbih0b2tlbiwgbWF0Y2hlcikgewogIGlmICh0b2tlblswXSAhPT0gIjoiKSB7CiAgICB0b2tlbiA9ICI6IiArIHRva2VuOwogIH0KICB2YXIgY29tcGlsZWQgPSBuZXcgUmVnRXhwKHRva2VuLCAiZyIpOwogIHRoaXMucGFyYW1zW3Rva2VuXSA9IGZ1bmN0aW9uKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNvbXBpbGVkLCBtYXRjaGVyLnNvdXJjZSB8fCBtYXRjaGVyKTsKICB9Owp9OwoKUm91dGVyLnByb3RvdHlwZS5vbiA9IFJvdXRlci5wcm90b3R5cGUucm91dGUgPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmICghcm91dGUgJiYgdHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgcm91dGUgPSBwYXRoOwogICAgcGF0aCA9IG1ldGhvZDsKICAgIG1ldGhvZCA9ICJvbiI7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHBhdGgpKSB7CiAgICByZXR1cm4gcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKHApIHsKICAgICAgc2VsZi5vbihtZXRob2QsIHAsIHJvdXRlKTsKICAgIH0pOwogIH0KICBpZiAocGF0aC5zb3VyY2UpIHsKICAgIHBhdGggPSBwYXRoLnNvdXJjZS5yZXBsYWNlKC9cXFwvL2lnLCAiLyIpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShtZXRob2QpKSB7CiAgICByZXR1cm4gbWV0aG9kLmZvckVhY2goZnVuY3Rpb24obSkgewogICAgICBzZWxmLm9uKG0udG9Mb3dlckNhc2UoKSwgcGF0aCwgcm91dGUpOwogICAgfSk7CiAgfQogIHBhdGggPSBwYXRoLnNwbGl0KG5ldyBSZWdFeHAodGhpcy5kZWxpbWl0ZXIpKTsKICBwYXRoID0gdGVybWluYXRvcihwYXRoLCB0aGlzLmRlbGltaXRlcik7CiAgdGhpcy5pbnNlcnQobWV0aG9kLCB0aGlzLnNjb3BlLmNvbmNhdChwYXRoKSwgcm91dGUpOwp9OwoKUm91dGVyLnByb3RvdHlwZS5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXMsIGZucyA9IHRoaXMudHJhdmVyc2UobWV0aG9kLCBwYXRoLCB0aGlzLnJvdXRlcywgIiIpLCBpbnZva2VkID0gdGhpcy5faW52b2tlZCwgYWZ0ZXI7CiAgdGhpcy5faW52b2tlZCA9IHRydWU7CiAgaWYgKCFmbnMgfHwgZm5zLmxlbmd0aCA9PT0gMCkgewogICAgdGhpcy5sYXN0ID0gW107CiAgICBpZiAodHlwZW9mIHRoaXMubm90Zm91bmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhpcy5pbnZva2UoWyB0aGlzLm5vdGZvdW5kIF0sIHsKICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICBwYXRoOiBwYXRoCiAgICAgIH0sIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHRoaXMucmVjdXJzZSA9PT0gImZvcndhcmQiKSB7CiAgICBmbnMgPSBmbnMucmV2ZXJzZSgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGVBbmRJbnZva2UoKSB7CiAgICBzZWxmLmxhc3QgPSBmbnMuYWZ0ZXI7CiAgICBzZWxmLmludm9rZShzZWxmLnJ1bmxpc3QoZm5zKSwgc2VsZiwgY2FsbGJhY2spOwogIH0KICBhZnRlciA9IHRoaXMuZXZlcnkgJiYgdGhpcy5ldmVyeS5hZnRlciA/IFsgdGhpcy5ldmVyeS5hZnRlciBdLmNvbmNhdCh0aGlzLmxhc3QpIDogWyB0aGlzLmxhc3QgXTsKICBpZiAoYWZ0ZXIgJiYgYWZ0ZXIubGVuZ3RoID4gMCAmJiBpbnZva2VkKSB7CiAgICBpZiAodGhpcy5hc3luYykgewogICAgICB0aGlzLmludm9rZShhZnRlciwgdGhpcywgdXBkYXRlQW5kSW52b2tlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaW52b2tlKGFmdGVyLCB0aGlzKTsKICAgICAgdXBkYXRlQW5kSW52b2tlKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdXBkYXRlQW5kSW52b2tlKCk7CiAgcmV0dXJuIHRydWU7Cn07CgpSb3V0ZXIucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uKGZucywgdGhpc0FyZywgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgaWYgKHRoaXMuYXN5bmMpIHsKICAgIF9hc3luY0V2ZXJ5U2VyaWVzKGZucywgZnVuY3Rpb24gYXBwbHkoZm4sIG5leHQpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm4pKSB7CiAgICAgICAgcmV0dXJuIF9hc3luY0V2ZXJ5U2VyaWVzKGZuLCBhcHBseSwgbmV4dCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBmbi5hcHBseSh0aGlzQXJnLCBmbnMuY2FwdHVyZXMuY29uY2F0KG5leHQpKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXNBcmcsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBfZXZlcnkoZm5zLCBmdW5jdGlvbiBhcHBseShmbikgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShmbikpIHsKICAgICAgICByZXR1cm4gX2V2ZXJ5KGZuLCBhcHBseSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNBcmcsIGZucy5jYXB0dXJlcyB8fCBbXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAic3RyaW5nIiAmJiBzZWxmLnJlc291cmNlKSB7CiAgICAgICAgc2VsZi5yZXNvdXJjZVtmbl0uYXBwbHkodGhpc0FyZywgZm5zLmNhcHR1cmVzIHx8IFtdKTsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKUm91dGVyLnByb3RvdHlwZS50cmF2ZXJzZSA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgcm91dGVzLCByZWdleHAsIGZpbHRlcikgewogIHZhciBmbnMgPSBbXSwgY3VycmVudCwgZXhhY3QsIG1hdGNoLCBuZXh0LCB0aGF0OwogIGZ1bmN0aW9uIGZpbHRlclJvdXRlcyhyb3V0ZXMpIHsKICAgIGlmICghZmlsdGVyKSB7CiAgICAgIHJldHVybiByb3V0ZXM7CiAgICB9CiAgICBmdW5jdGlvbiBkZWVwQ29weShzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdFtpXSA9IEFycmF5LmlzQXJyYXkoc291cmNlW2ldKSA/IGRlZXBDb3B5KHNvdXJjZVtpXSkgOiBzb3VyY2VbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RmlsdGVyKGZucykgewogICAgICBmb3IgKHZhciBpID0gZm5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zW2ldKSkgewogICAgICAgICAgYXBwbHlGaWx0ZXIoZm5zW2ldKTsKICAgICAgICAgIGlmIChmbnNbaV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGZucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZmlsdGVyKGZuc1tpXSkpIHsKICAgICAgICAgICAgZm5zLnNwbGljZShpLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBuZXdSb3V0ZXMgPSBkZWVwQ29weShyb3V0ZXMpOwogICAgbmV3Um91dGVzLm1hdGNoZWQgPSByb3V0ZXMubWF0Y2hlZDsKICAgIG5ld1JvdXRlcy5jYXB0dXJlcyA9IHJvdXRlcy5jYXB0dXJlczsKICAgIG5ld1JvdXRlcy5hZnRlciA9IHJvdXRlcy5hZnRlci5maWx0ZXIoZmlsdGVyKTsKICAgIGFwcGx5RmlsdGVyKG5ld1JvdXRlcyk7CiAgICByZXR1cm4gbmV3Um91dGVzOwogIH0KICBpZiAocGF0aCA9PT0gdGhpcy5kZWxpbWl0ZXIgJiYgcm91dGVzW21ldGhvZF0pIHsKICAgIG5leHQgPSBbIFsgcm91dGVzLmJlZm9yZSwgcm91dGVzW21ldGhvZF0gXS5maWx0ZXIoQm9vbGVhbikgXTsKICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlcy5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgIG5leHQubWF0Y2hlZCA9IHRydWU7CiAgICBuZXh0LmNhcHR1cmVzID0gW107CiAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogIH0KICBmb3IgKHZhciByIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyKSAmJiAoIXRoaXMuX21ldGhvZHNbcl0gfHwgdGhpcy5fbWV0aG9kc1tyXSAmJiB0eXBlb2Ygcm91dGVzW3JdID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShyb3V0ZXNbcl0pKSkgewogICAgICBjdXJyZW50ID0gZXhhY3QgPSByZWdleHAgKyB0aGlzLmRlbGltaXRlciArIHI7CiAgICAgIGlmICghdGhpcy5zdHJpY3QpIHsKICAgICAgICBleGFjdCArPSAiWyIgKyB0aGlzLmRlbGltaXRlciArICJdPyI7CiAgICAgIH0KICAgICAgbWF0Y2ggPSBwYXRoLm1hdGNoKG5ldyBSZWdFeHAoIl4iICsgZXhhY3QpKTsKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChtYXRjaFswXSAmJiBtYXRjaFswXSA9PSBwYXRoICYmIHJvdXRlc1tyXVttZXRob2RdKSB7CiAgICAgICAgbmV4dCA9IFsgWyByb3V0ZXNbcl0uYmVmb3JlLCByb3V0ZXNbcl1bbWV0aG9kXSBdLmZpbHRlcihCb29sZWFuKSBdOwogICAgICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgICAgICBuZXh0Lm1hdGNoZWQgPSB0cnVlOwogICAgICAgIG5leHQuY2FwdHVyZXMgPSBtYXRjaC5zbGljZSgxKTsKICAgICAgICBpZiAodGhpcy5yZWN1cnNlICYmIHJvdXRlcyA9PT0gdGhpcy5yb3V0ZXMpIHsKICAgICAgICAgIG5leHQucHVzaChbIHJvdXRlcy5iZWZvcmUsIHJvdXRlcy5vbiBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBuZXh0LmFmdGVyID0gbmV4dC5hZnRlci5jb25jYXQoWyByb3V0ZXMuYWZ0ZXIgXS5maWx0ZXIoQm9vbGVhbikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogICAgICB9CiAgICAgIG5leHQgPSB0aGlzLnRyYXZlcnNlKG1ldGhvZCwgcGF0aCwgcm91dGVzW3JdLCBjdXJyZW50KTsKICAgICAgaWYgKG5leHQubWF0Y2hlZCkgewogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZucyA9IGZucy5jb25jYXQobmV4dCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlY3Vyc2UpIHsKICAgICAgICAgIGZucy5wdXNoKFsgcm91dGVzW3JdLmJlZm9yZSwgcm91dGVzW3JdLm9uIF0uZmlsdGVyKEJvb2xlYW4pKTsKICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBpZiAocm91dGVzID09PSB0aGlzLnJvdXRlcykgewogICAgICAgICAgICBmbnMucHVzaChbIHJvdXRlc1siYmVmb3JlIl0sIHJvdXRlc1sib24iXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1siYWZ0ZXIiXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZucy5tYXRjaGVkID0gdHJ1ZTsKICAgICAgICBmbnMuY2FwdHVyZXMgPSBuZXh0LmNhcHR1cmVzOwogICAgICAgIGZucy5hZnRlciA9IG5leHQuYWZ0ZXI7CiAgICAgICAgcmV0dXJuIGZpbHRlclJvdXRlcyhmbnMpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24obWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KSB7CiAgdmFyIG1ldGhvZFR5cGUsIHBhcmVudFR5cGUsIGlzQXJyYXksIG5lc3RlZCwgcGFydDsKICBwYXRoID0gcGF0aC5maWx0ZXIoZnVuY3Rpb24ocCkgewogICAgcmV0dXJuIHAgJiYgcC5sZW5ndGggPiAwOwogIH0pOwogIHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLnJvdXRlczsKICBwYXJ0ID0gcGF0aC5zaGlmdCgpOwogIGlmICgvXDp8XCovLnRlc3QocGFydCkgJiYgIS9cXGR8XFx3Ly50ZXN0KHBhcnQpKSB7CiAgICBwYXJ0ID0gcmVnaWZ5U3RyaW5nKHBhcnQsIHRoaXMucGFyYW1zKTsKICB9CiAgaWYgKHBhdGgubGVuZ3RoID4gMCkgewogICAgcGFyZW50W3BhcnRdID0gcGFyZW50W3BhcnRdIHx8IHt9OwogICAgcmV0dXJuIHRoaXMuaW5zZXJ0KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudFtwYXJ0XSk7CiAgfQogIGlmICghcGFydCAmJiAhcGF0aC5sZW5ndGggJiYgcGFyZW50ID09PSB0aGlzLnJvdXRlcykgewogICAgbWV0aG9kVHlwZSA9IHR5cGVvZiBwYXJlbnRbbWV0aG9kXTsKICAgIHN3aXRjaCAobWV0aG9kVHlwZSkgewogICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgcGFyZW50W21ldGhvZF0gPSBbIHBhcmVudFttZXRob2RdLCByb3V0ZSBdOwogICAgICByZXR1cm47CiAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgcGFyZW50W21ldGhvZF0ucHVzaChyb3V0ZSk7CiAgICAgIHJldHVybjsKICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICBwYXJlbnRbbWV0aG9kXSA9IHJvdXRlOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm47CiAgfQogIHBhcmVudFR5cGUgPSB0eXBlb2YgcGFyZW50W3BhcnRdOwogIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KHBhcmVudFtwYXJ0XSk7CiAgaWYgKHBhcmVudFtwYXJ0XSAmJiAhaXNBcnJheSAmJiBwYXJlbnRUeXBlID09ICJvYmplY3QiKSB7CiAgICBtZXRob2RUeXBlID0gdHlwZW9mIHBhcmVudFtwYXJ0XVttZXRob2RdOwogICAgc3dpdGNoIChtZXRob2RUeXBlKSB7CiAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXSA9IFsgcGFyZW50W3BhcnRdW21ldGhvZF0sIHJvdXRlIF07CiAgICAgIHJldHVybjsKICAgICBjYXNlICJvYmplY3QiOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXS5wdXNoKHJvdXRlKTsKICAgICAgcmV0dXJuOwogICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgIHBhcmVudFtwYXJ0XVttZXRob2RdID0gcm91dGU7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHBhcmVudFR5cGUgPT0gInVuZGVmaW5lZCIpIHsKICAgIG5lc3RlZCA9IHt9OwogICAgbmVzdGVkW21ldGhvZF0gPSByb3V0ZTsKICAgIHBhcmVudFtwYXJ0XSA9IG5lc3RlZDsKICAgIHJldHVybjsKICB9CiAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdXRlIGNvbnRleHQ6ICIgKyBwYXJlbnRUeXBlKTsKfTsKCgoKUm91dGVyLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihtZXRob2RzKSB7CiAgdmFyIHNlbGYgPSB0aGlzLCBsZW4gPSBtZXRob2RzLmxlbmd0aCwgaTsKICBmdW5jdGlvbiBleHRlbmQobWV0aG9kKSB7CiAgICBzZWxmLl9tZXRob2RzW21ldGhvZF0gPSB0cnVlOwogICAgc2VsZlttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBleHRyYSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBbIG1ldGhvZCwgIiIgXSA6IFsgbWV0aG9kIF07CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CiAgfQogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgZXh0ZW5kKG1ldGhvZHNbaV0pOwogIH0KfTsKClJvdXRlci5wcm90b3R5cGUucnVubGlzdCA9IGZ1bmN0aW9uKGZucykgewogIHZhciBydW5saXN0ID0gdGhpcy5ldmVyeSAmJiB0aGlzLmV2ZXJ5LmJlZm9yZSA/IFsgdGhpcy5ldmVyeS5iZWZvcmUgXS5jb25jYXQoX2ZsYXR0ZW4oZm5zKSkgOiBfZmxhdHRlbihmbnMpOwogIGlmICh0aGlzLmV2ZXJ5ICYmIHRoaXMuZXZlcnkub24pIHsKICAgIHJ1bmxpc3QucHVzaCh0aGlzLmV2ZXJ5Lm9uKTsKICB9CiAgcnVubGlzdC5jYXB0dXJlcyA9IGZucy5jYXB0dXJlczsKICBydW5saXN0LnNvdXJjZSA9IGZucy5zb3VyY2U7CiAgcmV0dXJuIHJ1bmxpc3Q7Cn07CgpSb3V0ZXIucHJvdG90eXBlLm1vdW50ID0gZnVuY3Rpb24ocm91dGVzLCBwYXRoKSB7CiAgaWYgKCFyb3V0ZXMgfHwgdHlwZW9mIHJvdXRlcyAhPT0gIm9iamVjdCIgfHwgQXJyYXkuaXNBcnJheShyb3V0ZXMpKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBzZWxmID0gdGhpczsKICBwYXRoID0gcGF0aCB8fCBbXTsKICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHsKICAgIHBhdGggPSBwYXRoLnNwbGl0KHNlbGYuZGVsaW1pdGVyKTsKICB9CiAgZnVuY3Rpb24gaW5zZXJ0T3JNb3VudChyb3V0ZSwgbG9jYWwpIHsKICAgIHZhciByZW5hbWUgPSByb3V0ZSwgcGFydHMgPSByb3V0ZS5zcGxpdChzZWxmLmRlbGltaXRlciksIHJvdXRlVHlwZSA9IHR5cGVvZiByb3V0ZXNbcm91dGVdLCBpc1JvdXRlID0gcGFydHNbMF0gPT09ICIiIHx8ICFzZWxmLl9tZXRob2RzW3BhcnRzWzBdXSwgZXZlbnQgPSBpc1JvdXRlID8gIm9uIiA6IHJlbmFtZTsKICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIHJlbmFtZSA9IHJlbmFtZS5zbGljZSgocmVuYW1lLm1hdGNoKG5ldyBSZWdFeHAoc2VsZi5kZWxpbWl0ZXIpKSB8fCBbICIiIF0pWzBdLmxlbmd0aCk7CiAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICB9CiAgICBpZiAoaXNSb3V0ZSAmJiByb3V0ZVR5cGUgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KHJvdXRlc1tyb3V0ZV0pKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHBhcnRzKTsKICAgICAgc2VsZi5tb3VudChyb3V0ZXNbcm91dGVdLCBsb2NhbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHJlbmFtZS5zcGxpdChzZWxmLmRlbGltaXRlcikpOwogICAgICBsb2NhbCA9IHRlcm1pbmF0b3IobG9jYWwsIHNlbGYuZGVsaW1pdGVyKTsKICAgIH0KICAgIHNlbGYuaW5zZXJ0KGV2ZW50LCBsb2NhbCwgcm91dGVzW3JvdXRlXSk7CiAgfQogIGZvciAodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgaW5zZXJ0T3JNb3VudChyb3V0ZSwgcGF0aC5zbGljZSgwKSk7CiAgICB9CiAgfQp9OwoKCgp9KHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IiA/IGV4cG9ydHMgOiB3aW5kb3cpKTsKZGVmaW5lKCJmbGF0aXJvbi9kaXJlY3RvciIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLlJvdXRlcjsKICAgIH07Cn0odGhpcykpKTsKCmRlZmluZSgndGhydXN0L3NwYS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QnLCAndGhydXN0L2xvZycsICdoYXMnLCAnZmxhdGlyb24vZGlyZWN0b3InLCAndGhydXN0L2luc3RhbmNlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX3RocnVzdF9fLCBfX2xvZ19fLCBfX2hhc19fLCBfX2ZsYXRpcm9uUm91dGVyX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciB0aHJ1c3QgPSBfX3RocnVzdF9fOwoKICAgIHZhciBUaHJ1c3QgPSB0aHJ1c3QuVGhydXN0OwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZsYXRpcm9uUm91dGVyID0gX19mbGF0aXJvblJvdXRlcl9fOwoKICAgIHZhciBSb3V0ZXIgPSBmbGF0aXJvblJvdXRlci5Sb3V0ZXIgfHwgZmxhdGlyb25Sb3V0ZXI7CiAgICAKICAgIHZhciBpbnN0YW5jZSA9IF9faW5zdGFuY2VfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdTaW5nbGVQYWdlQXBwbGljYXRpb24nOwogICAgY29uZmlnOwogICAgdmFyIGVhY2ggPSBfLmVhY2gsIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc1JlZ0V4cCA9IF8uaXNSZWdFeHAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBvbmNlID0gXy5vbmNlLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpbnZva2UgPSBfLmludm9rZSwgcGx1Y2sgPSBfLnBsdWNrLCBtYXAgPSBfLm1hcCwgZGVmZXIgPSBfLmRlZmVyLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgdG9BcnJheSA9IF8udG9BcnJheSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIFNUQVJUID0gJ3N0YXJ0JzsKICAgIHZhciBleHRyYWN0UGFyYW1zID0gZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdLCBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKSwgc2xhc2hJbmRleDsKICAgICAgICB3aGlsZShpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5pbmRleE9mKCcvJywgaW5kZXgpOwogICAgICAgICAgICBpZihzbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChyb3V0ZS5zdWJzdHJpbmcoaW5kZXgsIHNsYXNoSW5kZXggLSBpbmRleCArIDEpKTsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHJpbmcoc2xhc2hJbmRleCk7CiAgICAgICAgICAgIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgfTsKICAgIHZhciBldmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoZXZlbnQsIG1lZGlhdG9yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEKICAgIEBjbGFzcyB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvck1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IGluc3RhbmNlIG1lZGlhdG9yCiAgICAqKi8KICAgIHZhciBTaW5nbGVQYWdlQXBwbGljYXRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbihjb25maWcsIGluc3RhbmNlTmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5zdGFydGluZ01vZHVsZVByb21pc2UgPSBudWxsOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuYmFzZVVybCA9IGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdmFyIHNwYUNvbmZpZyA9IGNvbmZpZy5zcGE7CiAgICAgICAgICAgIHRoYXQuZmlsZUV4dGVuc2lvbiA9IHNwYUNvbmZpZy5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICB2YXIgcm91dGVzID0gdGhhdC5jb25maWd1cmVSb3V0ZXMoc3BhQ29uZmlnLnJvdXRlcyksIHBhcmFtcyA9IHNwYUNvbmZpZy5wYXJhbXM7CiAgICAgICAgICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0ZpcmluZyBzcGEgInswfSIgd2l0aCBbezF9XScsIGV2ZW50LCB0b0FycmF5KGFyZ3VtZW50cykuam9pbignLCcpKSk7CiAgICAgICAgICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciByb3V0ZXIgPSB0aGF0LnJvdXRlciA9IG5ldyBSb3V0ZXIocm91dGVzKS5jb25maWd1cmUoewogICAgICAgICAgICAgICAgcmVjdXJzZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzdHJpY3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgaHRtbDVoaXN0b3J5OiB0cnVlLAogICAgICAgICAgICAgICAgbm90Zm91bmQ6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ub3Rmb3VuZCcpLAogICAgICAgICAgICAgICAgYmVmb3JlOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYmVmb3JlJyksCiAgICAgICAgICAgICAgICBvbjogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL3J1bicpLAogICAgICAgICAgICAgICAgYWZ0ZXI6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9hZnRlcicpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBfLmVhY2gocGFyYW1zLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcm91dGVyLnBhcmFtKGksIHgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFN0YXJ0IHRoZSBzaW5nbGUgcGFnZSBhcHAgcm91dGVyLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICAgICAqKi8KICAgICAgICAgICAgdGhhdC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQudGhydXN0ID0gaW5zdGFuY2UuZ2V0SW5zdGFuY2UoaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgICAgIHRoYXQucm91dGVyLmluaXQoKTsKICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMoJ3RocnVzdC9zcGEvc3RhcnQnKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICB9CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5uYXZpZ2F0ZSA9IC8qKgogICAgICAgIE5hdmlnYXRlcyB0byB0aGUgZ2l2ZW4gdXJsLgogICAgICAgIAogICAgICAgIEBtZXRob2QgbmF2aWdhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbG9jYXRpb24gVGhlIGxvY2F0aW9uIHRvIG5hdmlnYXRlIHRvLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChsb2NhdGlvbikgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciB1cmwgPSB1dGlsLmZpeHVwVXJsKGxvY2F0aW9uLCB0aGF0LmJhc2VVcmwpOwogICAgICAgICAgICB0aGF0LnJvdXRlci5zZXRSb3V0ZSh1cmwpOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBzaW5nbGUgcGFnZSBhcHAgcm91dGVyLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMudGhydXN0ID0gaW5zdGFuY2UuZ2V0SW5zdGFuY2UodGhpcy5pbnN0YW5jZU5hbWUpOwogICAgICAgICAgICB0aGlzLnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgIHRoaXMudGhydXN0Lm1lZGlhdG9yLmZpcmUuYXN5bmMoJ3RocnVzdC9zcGEvc3RhcnQnKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuY29uZmlndXJlUm91dGVzID0gLyoqCiAgICAgICAgQ29uZmlndXJlcyB0aGUgcm91dGUgb2JqZWN0IGZvciB0aGUgc3BhIGluc3RhbmNlCiAgICAgICAgCiAgICAgICAgUm91dGVzIGNhbiBiZSBpbiA0IGZvcm1zCiAgICAgICAgCiAgICAgICAgewogICAgICAgICcvcGF0aC90by86Zm9vJzogJ3BhdGgvdG8vbW9kdWxlJywKICAgICAgICAnL3BhdGgvdG8vOmJhcic6IFsncGF0aC90by9tb2R1bGUxJywgJ3BhdGgvdG8vbW9kdWxlMiddLAogICAgICAgICcvcGF0aC90by86ZmInOiB7IHBhdGg6ICdwYXRoL3RvL21vZHVsZScsIGFyZ3M6IFsnYXJncycsICd0bycsICdoYW5kIG9mZiB0byBzdGFydCddIH0KICAgICAgICAnL3BhdGgvdG8vOmZvby86YmFyJzogZnVuY3Rpb24oZm9vLCBiYXIpeyAgY3VzdG9tIGhhbmRsZXIgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvbmZpZ3VyZVJvdXRlcwogICAgICAgIEBwYXJhbSB7T2JqZWN0fSByb3V0ZXMgT2JqZWN0IG9mIHJvdXRlcy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocm91dGVzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgY29uZmlndXJlZFJvdXRlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gZWFjaChyb3V0ZXMsIGZ1bmN0aW9uICh2YWx1ZSwgcm91dGUpIHsKICAgICAgICAgICAgZm9yKHZhciByb3V0ZSBpbiByb3V0ZXMpIHsKICAgICAgICAgICAgICAgIGlmKF8uaGFzKHJvdXRlcywgcm91dGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcm91dGVzW3JvdXRlXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVhbFJvdXRlID0gdXRpbC5maXh1cFVybChyb3V0ZSwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgICAgICAgICBpZihpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSBbXSwgbWV0aG9kcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9IHZhbHVlW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcodikgfHwgaXNPYmplY3QodikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNGdW5jdGlvbih2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHMucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlQ2FsbGJhY2sgPSB0aGF0Lm1vZHVsZVN0YXJ0Q2FsbGJhY2socm91dGUsIG1vZHVsZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2gobW9kdWxlQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtZXRob2RzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IG1vZHVsZUNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvL30pOwogICAgICAgICAgICByZXR1cm4gY29uZmlndXJlZFJvdXRlczsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubW9kdWxlU3RhcnRDYWxsYmFjayA9IC8qKgogICAgICAgIAogICAgICAgIEBtZXRob2QgbW9kdWxlU3RhcnRDYWxsYmFjawogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmcgfCBBcnJheSB8IE9iamVjdH0gbW9kdWxlcyBTdHJpbmcgdG8gc3RhcnQgYSBzaW5nbGUgbW9kdWxlLCBBcnJheSB0byBzdGFydCBtYW55IG1vZHVsZXMsIE9iamVjdCB0byBzdGFydCBhIG1vZHVsZSB3aXRoIHNwZWNpZmljIGFyZ3VtZW50cy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocm91dGUsIG1vZHVsZXMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwgcGFyYW1zID0gZXh0cmFjdFBhcmFtcyhyb3V0ZSksIHRoYXQgPSB0aGlzLCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICBpZihpc09iamVjdChtb2R1bGVzKSkgewogICAgICAgICAgICAgICAgYXJncyA9IG1vZHVsZXMuYXJncyB8fCBhcmdzOwogICAgICAgICAgICAgICAgbW9kdWxlcyA9IG1vZHVsZXMucGF0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihpc1N0cmluZyhtb2R1bGVzKSkgewogICAgICAgICAgICAgICAgbW9kdWxlcyA9IFsKICAgICAgICAgICAgICAgICAgICBtb2R1bGVzCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXIgPSB0b0FycmF5KGFyZ3VtZW50cyksIHRocnVzdCA9IHRoYXQudGhydXN0LCBtYXBwZWRNb2R1bGVzID0gbWFwKG1vZHVsZXMsIGZ1bmN0aW9uIChtb2R1bGVQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZHVjZShhciwgZnVuY3Rpb24gKG1lbW8sIGFyZywgaSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVtby5yZXBsYWNlKHBhcmFtc1tpXSwgYXJnLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIH0sIG1vZHVsZVBhdGgpLnJlcGxhY2UoZmlsZUV4dGVuc2lvbiwgJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRocnVzdC5zdGFydC5hcHBseSh0aHJ1c3QsIFsKICAgICAgICAgICAgICAgICAgICBtYXBwZWRNb2R1bGVzCiAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICBpZighdGhhdC50aHJ1c3Quc3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocnVzdC5yZWFkeShtYXBwZWRNb2R1bGVzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gcHJvbWlzZTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgSGFuZHMgdGhlIG5hdmlnYXRlIG1ldGhvZCBvZmYgdG8gdGhlIG1vZHVsZSwgc28gYW55IG1vZHVsZSBjYW4gdHJpZ2dlciBhIG5hdmlnYXRpb24gZXZlbnQuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZCBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKG1vZC5uYXZpZ2F0ZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibmF2aWdhdGUiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBbHJlYWR5IHByZSBib3VuZCwgc28gd2Ugb25seSBwYXNzIGFyb3VuZCAxIGZ1bmN0aW9uIHBlciBpbnN0YW5jZS4KICAgICAgICAgICAgbW9kLm5hdmlnYXRlID0gdGhhdC5uYXZpZ2F0ZS5iaW5kKHRoYXQpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLlNpbmdsZVBhZ2VBcHBsaWNhdGlvbiA9IFNpbmdsZVBhZ2VBcHBsaWNhdGlvbjsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhJywgWyd0aHJ1c3Qvc3BhL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwo=",
                "body": "LyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KLyoqCiAqIEBsaWNlbnNlCiAqIExvLURhc2ggMS4wLjAtcmMuMyA8aHR0cDovL2xvZGFzaC5jb20vPgogKiBDb3B5cmlnaHQgMjAxMi0yMDEzIFRoZSBEb2pvIEZvdW5kYXRpb24gPGh0dHA6Ly9kb2pvZm91bmRhdGlvbi5vcmcvPgogKiBCYXNlZCBvbiBVbmRlcnNjb3JlLmpzIDEuNC4zIDxodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8+CiAqIENvcHlyaWdodCAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KICogQXZhaWxhYmxlIHVuZGVyIE1JVCBsaWNlbnNlIDxodHRwOi8vbG9kYXNoLmNvbS9saWNlbnNlPgogKi8KOyhmdW5jdGlvbih3aW5kb3csIHVuZGVmaW5lZCkgewoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGV4cG9ydHNgICovCiAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0czsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBnbG9iYWxgIGFuZCB1c2UgaXQgYXMgYHdpbmRvd2AgKi8KICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwogIGlmIChmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCkgewogICAgd2luZG93ID0gZnJlZUdsb2JhbDsKICB9CgogIC8qKiBVc2VkIGZvciBhcnJheSBhbmQgb2JqZWN0IG1ldGhvZCByZWZlcmVuY2VzICovCiAgdmFyIGFycmF5UmVmID0gW10sCiAgICAgIG9iamVjdFJlZiA9IHt9OwoKICAvKiogVXNlZCB0byBnZW5lcmF0ZSB1bmlxdWUgSURzICovCiAgdmFyIGlkQ291bnRlciA9IDA7CgogIC8qKiBVc2VkIGludGVybmFsbHkgdG8gaW5kaWNhdGUgdmFyaW91cyB0aGluZ3MgKi8KICB2YXIgaW5kaWNhdG9yT2JqZWN0ID0gb2JqZWN0UmVmOwoKICAvKiogVXNlZCBieSBgY2FjaGVkQ29udGFpbnNgIGFzIHRoZSBkZWZhdWx0IHNpemUgd2hlbiBvcHRpbWl6YXRpb25zIGFyZSBlbmFibGVkIGZvciBsYXJnZSBhcnJheXMgKi8KICB2YXIgbGFyZ2VBcnJheVNpemUgPSAzMDsKCiAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgbm9Db25mbGljdGAgKi8KICB2YXIgb2xkRGFzaCA9IHdpbmRvdy5fOwoKICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGVudGl0aWVzICovCiAgdmFyIHJlRXNjYXBlZEh0bWwgPSAvJig/OmFtcHxsdHxndHxxdW90fCN4MjcpOy9nOwoKICAvKiogVXNlZCB0byBtYXRjaCBlbXB0eSBzdHJpbmcgbGl0ZXJhbHMgaW4gY29tcGlsZWQgdGVtcGxhdGUgc291cmNlICovCiAgdmFyIHJlRW1wdHlTdHJpbmdMZWFkaW5nID0gL1xiX19wIFwrPSAnJzsvZywKICAgICAgcmVFbXB0eVN0cmluZ01pZGRsZSA9IC9cYihfX3AgXCs9KSAnJyBcKy9nLAogICAgICByZUVtcHR5U3RyaW5nVHJhaWxpbmcgPSAvKF9fZVwoLio/XCl8XGJfX3RcKSkgXCtcbicnOy9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGlmIGEgbWV0aG9kIGlzIG5hdGl2ZSAqLwogIHZhciByZU5hdGl2ZSA9IFJlZ0V4cCgnXicgKwogICAgKG9iamVjdFJlZi52YWx1ZU9mICsgJycpCiAgICAgIC5yZXBsYWNlKC9bLiorP149IToke30oKXxbXF1cL1xcXS9nLCAnXFwkJicpCiAgICAgIC5yZXBsYWNlKC92YWx1ZU9mfGZvciBbXlxdXSsvZywgJy4rPycpICsgJyQnCiAgKTsKCiAgLyoqCiAgICogVXNlZCB0byBtYXRjaCBFUzYgdGVtcGxhdGUgZGVsaW1pdGVycwogICAqIGh0dHA6Ly9wZW9wbGUubW96aWxsYS5vcmcvfmpvcmVuZG9yZmYvZXM2LWRyYWZ0Lmh0bWwjc2VjLTcuOC42CiAgICovCiAgdmFyIHJlRXNUZW1wbGF0ZSA9IC9cJFx7KCg/Oig/PVxcPylcXD9bXHNcU10pKj8pfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCAiaW50ZXJwb2xhdGUiIHRlbXBsYXRlIGRlbGltaXRlcnMgKi8KICB2YXIgcmVJbnRlcnBvbGF0ZSA9IC88JT0oW1xzXFNdKz8pJT4vZzsKCiAgLyoqIFVzZWQgdG8gZW5zdXJlIGNhcHR1cmluZyBvcmRlciBvZiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlTm9NYXRjaCA9IC8oJF4pLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggSFRNTCBjaGFyYWN0ZXJzICovCiAgdmFyIHJlVW5lc2NhcGVkSHRtbCA9IC9bJjw+IiddL2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHVuZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciByZVVuZXNjYXBlZFN0cmluZyA9IC9bJ1xuXHJcdFx1MjAyOFx1MjAyOVxcXS9nOwoKICAvKiogVXNlZCB0byBmaXggdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZyAqLwogIHZhciBzaGFkb3dlZCA9IFsKICAgICdjb25zdHJ1Y3RvcicsICdoYXNPd25Qcm9wZXJ0eScsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICd0b0xvY2FsZVN0cmluZycsICd0b1N0cmluZycsICd2YWx1ZU9mJwogIF07CgogIC8qKiBVc2VkIHRvIG1ha2UgdGVtcGxhdGUgc291cmNlVVJMcyBlYXNpZXIgdG8gaWRlbnRpZnkgKi8KICB2YXIgdGVtcGxhdGVDb3VudGVyID0gMDsKCiAgLyoqIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzICovCiAgdmFyIGNlaWwgPSBNYXRoLmNlaWwsCiAgICAgIGNvbmNhdCA9IGFycmF5UmVmLmNvbmNhdCwKICAgICAgZmxvb3IgPSBNYXRoLmZsb29yLAogICAgICBnZXRQcm90b3R5cGVPZiA9IHJlTmF0aXZlLnRlc3QoZ2V0UHJvdG90eXBlT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YpICYmIGdldFByb3RvdHlwZU9mLAogICAgICBoYXNPd25Qcm9wZXJ0eSA9IG9iamVjdFJlZi5oYXNPd25Qcm9wZXJ0eSwKICAgICAgcHVzaCA9IGFycmF5UmVmLnB1c2gsCiAgICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gb2JqZWN0UmVmLnByb3BlcnR5SXNFbnVtZXJhYmxlLAogICAgICB0b1N0cmluZyA9IG9iamVjdFJlZi50b1N0cmluZzsKCiAgLyogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgZm9yIG1ldGhvZHMgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIG90aGVyIGBsb2Rhc2hgIG1ldGhvZHMgKi8KICB2YXIgbmF0aXZlQmluZCA9IHJlTmF0aXZlLnRlc3QobmF0aXZlQmluZCA9IHNsaWNlLmJpbmQpICYmIG5hdGl2ZUJpbmQsCiAgICAgIG5hdGl2ZUlzQXJyYXkgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KSAmJiBuYXRpdmVJc0FycmF5LAogICAgICBuYXRpdmVJc0Zpbml0ZSA9IHdpbmRvdy5pc0Zpbml0ZSwKICAgICAgbmF0aXZlSXNOYU4gPSB3aW5kb3cuaXNOYU4sCiAgICAgIG5hdGl2ZUtleXMgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUtleXMgPSBPYmplY3Qua2V5cykgJiYgbmF0aXZlS2V5cywKICAgICAgbmF0aXZlTWF4ID0gTWF0aC5tYXgsCiAgICAgIG5hdGl2ZU1pbiA9IE1hdGgubWluLAogICAgICBuYXRpdmVSYW5kb20gPSBNYXRoLnJhbmRvbTsKCiAgLyoqIGBPYmplY3QjdG9TdHJpbmdgIHJlc3VsdCBzaG9ydGN1dHMgKi8KICB2YXIgYXJnc0NsYXNzID0gJ1tvYmplY3QgQXJndW1lbnRzXScsCiAgICAgIGFycmF5Q2xhc3MgPSAnW29iamVjdCBBcnJheV0nLAogICAgICBib29sQ2xhc3MgPSAnW29iamVjdCBCb29sZWFuXScsCiAgICAgIGRhdGVDbGFzcyA9ICdbb2JqZWN0IERhdGVdJywKICAgICAgZnVuY0NsYXNzID0gJ1tvYmplY3QgRnVuY3Rpb25dJywKICAgICAgbnVtYmVyQ2xhc3MgPSAnW29iamVjdCBOdW1iZXJdJywKICAgICAgb2JqZWN0Q2xhc3MgPSAnW29iamVjdCBPYmplY3RdJywKICAgICAgcmVnZXhwQ2xhc3MgPSAnW29iamVjdCBSZWdFeHBdJywKICAgICAgc3RyaW5nQ2xhc3MgPSAnW29iamVjdCBTdHJpbmddJzsKCiAgLyoqIERldGVjdCB2YXJpb3VzIGVudmlyb25tZW50cyAqLwogIHZhciBpc0llT3BlcmEgPSAhIXdpbmRvdy5hdHRhY2hFdmVudCwKICAgICAgaXNWOCA9IG5hdGl2ZUJpbmQgJiYgIS9cbnx0cnVlLy50ZXN0KG5hdGl2ZUJpbmQgKyBpc0llT3BlcmEpOwoKICAvKiBEZXRlY3QgaWYgYEZ1bmN0aW9uI2JpbmRgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoYWxsIGJ1dCBWOCkgKi8KICB2YXIgaXNCaW5kRmFzdCA9IG5hdGl2ZUJpbmQgJiYgIWlzVjg7CgogIC8qIERldGVjdCBpZiBgT2JqZWN0LmtleXNgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoSUUsIE9wZXJhLCBWOCkgKi8KICB2YXIgaXNLZXlzRmFzdCA9IG5hdGl2ZUtleXMgJiYgKGlzSWVPcGVyYSB8fCBpc1Y4KTsKCiAgLyoqCiAgICogRGV0ZWN0IHRoZSBKU2NyaXB0IFtbRG9udEVudW1dXSBidWc6CiAgICoKICAgKiBJbiBJRSA8IDkgYW4gb2JqZWN0cyBvd24gcHJvcGVydGllcywgc2hhZG93aW5nIG5vbi1lbnVtZXJhYmxlIG9uZXMsIGFyZQogICAqIG1hZGUgbm9uLWVudW1lcmFibGUgYXMgd2VsbC4KICAgKi8KICB2YXIgaGFzRG9udEVudW1CdWc7CgogIC8qKiBEZXRlY3QgaWYgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGFmdGVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIChJRSA8IDkpICovCiAgdmFyIGl0ZXJhdGVzT3duTGFzdDsKCiAgLyoqCiAgICogRGV0ZWN0IGlmIGBBcnJheSNzaGlmdGAgYW5kIGBBcnJheSNzcGxpY2VgIGF1Z21lbnQgYXJyYXktbGlrZSBvYmplY3RzCiAgICogaW5jb3JyZWN0bHk6CiAgICoKICAgKiBGaXJlZm94IDwgMTAsIElFIGNvbXBhdGliaWxpdHkgbW9kZSwgYW5kIElFIDwgOSBoYXZlIGJ1Z2d5IEFycmF5IGBzaGlmdCgpYAogICAqIGFuZCBgc3BsaWNlKClgIGZ1bmN0aW9ucyB0aGF0IGZhaWwgdG8gcmVtb3ZlIHRoZSBsYXN0IGVsZW1lbnQsIGB2YWx1ZVswXWAsCiAgICogb2YgYXJyYXktbGlrZSBvYmplY3RzIGV2ZW4gdGhvdWdoIHRoZSBgbGVuZ3RoYCBwcm9wZXJ0eSBpcyBzZXQgdG8gYDBgLgogICAqIFRoZSBgc2hpZnQoKWAgbWV0aG9kIGlzIGJ1Z2d5IGluIElFIDggY29tcGF0aWJpbGl0eSBtb2RlLCB3aGlsZSBgc3BsaWNlKClgCiAgICogaXMgYnVnZ3kgcmVnYXJkbGVzcyBvZiBtb2RlIGluIElFIDwgOSBhbmQgYnVnZ3kgaW4gY29tcGF0aWJpbGl0eSBtb2RlIGluIElFIDkuCiAgICovCiAgdmFyIGhhc09iamVjdFNwbGljZUJ1ZyA9IChoYXNPYmplY3RTcGxpY2VCdWcgPSB7ICcwJzogMSwgJ2xlbmd0aCc6IDEgfSwKICAgIGFycmF5UmVmLnNwbGljZS5jYWxsKGhhc09iamVjdFNwbGljZUJ1ZywgMCwgMSksIGhhc09iamVjdFNwbGljZUJ1Z1swXSk7CgogIC8qKiBEZXRlY3QgaWYgYW4gYGFyZ3VtZW50c2Agb2JqZWN0J3MgaW5kZXhlcyBhcmUgbm9uLWVudW1lcmFibGUgKElFIDwgOSkgKi8KICB2YXIgbm9uRW51bUFyZ3MgPSB0cnVlOwoKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgcHJvcHMgPSBbXTsKICAgIGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMueCA9IDE7IH0KICAgIGN0b3IucHJvdG90eXBlID0geyAndmFsdWVPZic6IDEsICd5JzogMSB9OwogICAgZm9yICh2YXIgcHJvcCBpbiBuZXcgY3RvcikgeyBwcm9wcy5wdXNoKHByb3ApOyB9CiAgICBmb3IgKHByb3AgaW4gYXJndW1lbnRzKSB7IG5vbkVudW1BcmdzID0gIXByb3A7IH0KCiAgICBoYXNEb250RW51bUJ1ZyA9ICEvdmFsdWVPZi8udGVzdChwcm9wcyk7CiAgICBpdGVyYXRlc093bkxhc3QgPSBwcm9wc1swXSAhPSAneCc7CiAgfSgxKSk7CgogIC8qKiBEZXRlY3QgaWYgYGFyZ3VtZW50c2Agb2JqZWN0cyBhcmUgYE9iamVjdGAgb2JqZWN0cyAoYWxsIGJ1dCBPcGVyYSA8IDEwLjUpICovCiAgdmFyIGFyZ3NBcmVPYmplY3RzID0gYXJndW1lbnRzLmNvbnN0cnVjdG9yID09IE9iamVjdDsKCiAgLyoqIERldGVjdCBpZiBgYXJndW1lbnRzYCBvYmplY3RzIFtbQ2xhc3NdXSBpcyB1bnJlc29sdmFibGUgKEZpcmVmb3ggPCA0LCBJRSA8IDkpICovCiAgdmFyIG5vQXJnc0NsYXNzID0gIWlzQXJndW1lbnRzKGFyZ3VtZW50cyk7CgogIC8qKgogICAqIERldGVjdCBsYWNrIG9mIHN1cHBvcnQgZm9yIGFjY2Vzc2luZyBzdHJpbmcgY2hhcmFjdGVycyBieSBpbmRleDoKICAgKgogICAqIElFIDwgOCBjYW4ndCBhY2Nlc3MgY2hhcmFjdGVycyBieSBpbmRleCBhbmQgSUUgOCBjYW4gb25seSBhY2Nlc3MKICAgKiBjaGFyYWN0ZXJzIGJ5IGluZGV4IG9uIHN0cmluZyBsaXRlcmFscy4KICAgKi8KICB2YXIgbm9DaGFyQnlJbmRleCA9ICgneCdbMF0gKyBPYmplY3QoJ3gnKVswXSkgIT0gJ3h4JzsKCiAgLyoqCiAgICogRGV0ZWN0IGlmIGEgbm9kZSdzIFtbQ2xhc3NdXSBpcyB1bnJlc29sdmFibGUgKElFIDwgOSkKICAgKiBhbmQgdGhhdCB0aGUgSlMgZW5naW5lIHdvbid0IGVycm9yIHdoZW4gYXR0ZW1wdGluZyB0byBjb2VyY2UgYW4gb2JqZWN0IHRvCiAgICogYSBzdHJpbmcgd2l0aG91dCBhIGB0b1N0cmluZ2AgZnVuY3Rpb24uCiAgICovCiAgdHJ5IHsKICAgIHZhciBub05vZGVDbGFzcyA9IHRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09IG9iamVjdENsYXNzICYmICEoeyAndG9TdHJpbmcnOiAwIH0gKyAnJyk7CiAgfSBjYXRjaChlKSB7IH0KCiAgLyoqIFVzZWQgdG8gaWRlbnRpZnkgb2JqZWN0IGNsYXNzaWZpY2F0aW9ucyB0aGF0IGBfLmNsb25lYCBzdXBwb3J0cyAqLwogIHZhciBjbG9uZWFibGVDbGFzc2VzID0ge307CiAgY2xvbmVhYmxlQ2xhc3Nlc1tmdW5jQ2xhc3NdID0gZmFsc2U7CiAgY2xvbmVhYmxlQ2xhc3Nlc1thcmdzQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1thcnJheUNsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tib29sQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tkYXRlQ2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW251bWJlckNsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbb2JqZWN0Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW3JlZ2V4cENsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbc3RyaW5nQ2xhc3NdID0gdHJ1ZTsKCiAgLyoqIFVzZWQgdG8gbG9va3VwIGEgYnVpbHQtaW4gY29uc3RydWN0b3IgYnkgW1tDbGFzc11dICovCiAgdmFyIGN0b3JCeUNsYXNzID0ge307CiAgY3RvckJ5Q2xhc3NbYXJyYXlDbGFzc10gPSBBcnJheTsKICBjdG9yQnlDbGFzc1tib29sQ2xhc3NdID0gQm9vbGVhbjsKICBjdG9yQnlDbGFzc1tkYXRlQ2xhc3NdID0gRGF0ZTsKICBjdG9yQnlDbGFzc1tvYmplY3RDbGFzc10gPSBPYmplY3Q7CiAgY3RvckJ5Q2xhc3NbbnVtYmVyQ2xhc3NdID0gTnVtYmVyOwogIGN0b3JCeUNsYXNzW3JlZ2V4cENsYXNzXSA9IFJlZ0V4cDsKICBjdG9yQnlDbGFzc1tzdHJpbmdDbGFzc10gPSBTdHJpbmc7CgogIC8qKiBVc2VkIHRvIGRldGVybWluZSBpZiB2YWx1ZXMgYXJlIG9mIHRoZSBsYW5ndWFnZSB0eXBlIE9iamVjdCAqLwogIHZhciBvYmplY3RUeXBlcyA9IHsKICAgICdib29sZWFuJzogZmFsc2UsCiAgICAnZnVuY3Rpb24nOiB0cnVlLAogICAgJ29iamVjdCc6IHRydWUsCiAgICAnbnVtYmVyJzogZmFsc2UsCiAgICAnc3RyaW5nJzogZmFsc2UsCiAgICAndW5kZWZpbmVkJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciBzdHJpbmdFc2NhcGVzID0gewogICAgJ1xcJzogJ1xcJywKICAgICInIjogIiciLAogICAgJ1xuJzogJ24nLAogICAgJ1xyJzogJ3InLAogICAgJ1x0JzogJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0LCB0aGF0IHdyYXBzIHRoZSBnaXZlbiBgdmFsdWVgLCB0byBlbmFibGUgbWV0aG9kCiAgICogY2hhaW5pbmcuCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBMby1EYXNoIG1ldGhvZHMsIHdyYXBwZXJzIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGBBcnJheWAgbWV0aG9kczoKICAgKiBgY29uY2F0YCwgYGpvaW5gLCBgcG9wYCwgYHB1c2hgLCBgcmV2ZXJzZWAsIGBzaGlmdGAsIGBzbGljZWAsIGBzb3J0YCwgYHNwbGljZWAsCiAgICogYW5kIGB1bnNoaWZ0YAogICAqCiAgICogVGhlIGNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICogYGFmdGVyYCwgYGFzc2lnbmAsIGBiaW5kYCwgYGJpbmRBbGxgLCBgYmluZEtleWAsIGBjaGFpbmAsIGBjb21wYWN0YCwgYGNvbXBvc2VgLAogICAqIGBjb25jYXRgLCBgY291bnRCeWAsIGBkZWJvdW5jZWAsIGBkZWZhdWx0c2AsIGBkZWZlcmAsIGBkZWxheWAsIGBkaWZmZXJlbmNlYCwKICAgKiBgZmlsdGVyYCwgYGZsYXR0ZW5gLCBgZm9yRWFjaGAsIGBmb3JJbmAsIGBmb3JPd25gLCBgZnVuY3Rpb25zYCwgYGdyb3VwQnlgLAogICAqIGBpbml0aWFsYCwgYGludGVyc2VjdGlvbmAsIGBpbnZlcnRgLCBgaW52b2tlYCwgYGtleXNgLCBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwKICAgKiBgbWVyZ2VgLCBgbWluYCwgYG9iamVjdGAsIGBvbWl0YCwgYG9uY2VgLCBgcGFpcnNgLCBgcGFydGlhbGAsIGBwYXJ0aWFsUmlnaHRgLAogICAqIGBwaWNrYCwgYHBsdWNrYCwgYHB1c2hgLCBgcmFuZ2VgLCBgcmVqZWN0YCwgYHJlc3RgLCBgcmV2ZXJzZWAsIGBzaHVmZmxlYCwKICAgKiBgc2xpY2VgLCBgc29ydGAsIGBzb3J0QnlgLCBgc3BsaWNlYCwgYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwKICAgKiBgdW5pb25gLCBgdW5pcWAsIGB1bnNoaWZ0YCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLCBhbmQgYHppcGAKICAgKgogICAqIFRoZSBub24tY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgKiBgY2xvbmVgLCBgY2xvbmVEZWVwYCwgYGNvbnRhaW5zYCwgYGVzY2FwZWAsIGBldmVyeWAsIGBmaW5kYCwgYGhhc2AsIGBpZGVudGl0eWAsCiAgICogYGluZGV4T2ZgLCBgaXNBcmd1bWVudHNgLCBgaXNBcnJheWAsIGBpc0Jvb2xlYW5gLCBgaXNEYXRlYCwgYGlzRWxlbWVudGAsIGBpc0VtcHR5YCwKICAgKiBgaXNFcXVhbGAsIGBpc0Zpbml0ZWAsIGBpc0Z1bmN0aW9uYCwgYGlzTmFOYCwgYGlzTnVsbGAsIGBpc051bWJlcmAsIGBpc09iamVjdGAsCiAgICogYGlzUGxhaW5PYmplY3RgLCBgaXNSZWdFeHBgLCBgaXNTdHJpbmdgLCBgaXNVbmRlZmluZWRgLCBgam9pbmAsIGBsYXN0SW5kZXhPZmAsCiAgICogYG1peGluYCwgYG5vQ29uZmxpY3RgLCBgcG9wYCwgYHJhbmRvbWAsIGByZWR1Y2VgLCBgcmVkdWNlUmlnaHRgLCBgcmVzdWx0YCwKICAgKiBgc2hpZnRgLCBgc2l6ZWAsIGBzb21lYCwgYHNvcnRlZEluZGV4YCwgYHRlbXBsYXRlYCwgYHVuZXNjYXBlYCwgYW5kIGB1bmlxdWVJZGAKICAgKgogICAqIFRoZSB3cmFwcGVyIGZ1bmN0aW9ucyBgZmlyc3RgIGFuZCBgbGFzdGAgcmV0dXJuIHdyYXBwZWQgdmFsdWVzIHdoZW4gYG5gIGlzCiAgICogcGFzc2VkLCBvdGhlcndpc2UgdGhleSByZXR1cm4gdW53cmFwcGVkIHZhbHVlcy4KICAgKgogICAqIEBuYW1lIF8KICAgKiBAY29uc3RydWN0b3IKICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcCBpbiBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgKi8KICBmdW5jdGlvbiBsb2Rhc2godmFsdWUpIHsKICAgIC8vIGV4aXQgZWFybHkgaWYgYWxyZWFkeSB3cmFwcGVkLCBldmVuIGlmIHdyYXBwZWQgYnkgYSBkaWZmZXJlbnQgYGxvZGFzaGAgY29uc3RydWN0b3IKICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdmFsdWUuX193cmFwcGVkX18pIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgLy8gYWxsb3cgaW52b2tpbmcgYGxvZGFzaGAgd2l0aG91dCB0aGUgYG5ld2Agb3BlcmF0b3IKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBsb2Rhc2gpKSB7CiAgICAgIHJldHVybiBuZXcgbG9kYXNoKHZhbHVlKTsKICAgIH0KICAgIHRoaXMuX193cmFwcGVkX18gPSB2YWx1ZTsKICB9CgogIC8qKgogICAqIEJ5IGRlZmF1bHQsIHRoZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzIHVzZWQgYnkgTG8tRGFzaCBhcmUgc2ltaWxhciB0byB0aG9zZSBpbgogICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAqIGRlbGltaXRlcnMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBPYmplY3QKICAgKi8KICBsb2Rhc2gudGVtcGxhdGVTZXR0aW5ncyA9IHsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICovCiAgICAnZXNjYXBlJzogLzwlLShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgY29kZSB0byBiZSBldmFsdWF0ZWQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBpbmplY3QuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdpbnRlcnBvbGF0ZSc6IHJlSW50ZXJwb2xhdGUsCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgICd2YXJpYWJsZSc6ICcnLAoKICAgIC8qKgogICAgICogVXNlZCB0byBpbXBvcnQgdmFyaWFibGVzIGludG8gdGhlIGNvbXBpbGVkIHRlbXBsYXRlLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICAnaW1wb3J0cyc6IHsKCiAgICAgIC8qKgogICAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MuaW1wb3J0cwogICAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICAgKi8KICAgICAgJ18nOiBsb2Rhc2gKICAgIH0KICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIHRlbXBsYXRlIHVzZWQgdG8gY3JlYXRlIGl0ZXJhdG9yIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dC4KICAgKi8KICB2YXIgaXRlcmF0b3JUZW1wbGF0ZSA9IHRlbXBsYXRlKAogICAgLy8gdGhlIGBpdGVyYWJsZWAgbWF5IGJlIHJlYXNzaWduZWQgYnkgdGhlIGB0b3BgIHNuaXBwZXQKICAgICd2YXIgaW5kZXgsIGl0ZXJhYmxlID0gPCU9IGZpcnN0QXJnICU+LCAnICsKICAgIC8vIGFzc2lnbiB0aGUgYHJlc3VsdGAgdmFyaWFibGUgYW4gaW5pdGlhbCB2YWx1ZQogICAgJ3Jlc3VsdCA9IDwlPSBmaXJzdEFyZyAlPjtcbicgKwogICAgLy8gZXhpdCBlYXJseSBpZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgZmFsc2V5CiAgICAnaWYgKCE8JT0gZmlyc3RBcmcgJT4pIHJldHVybiByZXN1bHQ7XG4nICsKICAgIC8vIGFkZCBjb2RlIGJlZm9yZSB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzCiAgICAnPCU9IHRvcCAlPjtcbicgKwoKICAgIC8vIGFycmF5LWxpa2UgaXRlcmF0aW9uOgogICAgJzwlIGlmIChhcnJheXMpIHsgJT4nICsKICAgICd2YXIgbGVuZ3RoID0gaXRlcmFibGUubGVuZ3RoOyBpbmRleCA9IC0xO1xuJyArCiAgICAiaWYgKDwlPSBhcnJheXMgJT4pIHsiICsKCiAgICAvLyBhZGQgc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4IGlmIG5lZWRlZAogICAgJyAgPCUgaWYgKG5vQ2hhckJ5SW5kZXgpIHsgJT5cbicgKwogICAgJyAgaWYgKGlzU3RyaW5nKGl0ZXJhYmxlKSkge1xuJyArCiAgICAiICAgIGl0ZXJhYmxlID0gaXRlcmFibGUuc3BsaXQoJycpXG4iICsKICAgICcgIH0nICsKICAgICcgIDwlIH0gJT5cbicgKwoKICAgIC8vIGl0ZXJhdGUgb3ZlciB0aGUgYXJyYXktbGlrZSB2YWx1ZQogICAgJyAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICA8JT0gbG9vcCAlPlxuJyArCiAgICAnICB9XG4nICsKICAgICd9XG4nICsKICAgICdlbHNlIHsnICsKCiAgICAvLyBvYmplY3QgaXRlcmF0aW9uOgogICAgLy8gYWRkIHN1cHBvcnQgZm9yIGl0ZXJhdGluZyBvdmVyIGBhcmd1bWVudHNgIG9iamVjdHMgaWYgbmVlZGVkCiAgICAnICA8JSAgfSBlbHNlIGlmIChub25FbnVtQXJncykgeyAlPlxuJyArCiAgICAnICB2YXIgbGVuZ3RoID0gaXRlcmFibGUubGVuZ3RoOyBpbmRleCA9IC0xO1xuJyArCiAgICAnICBpZiAobGVuZ3RoICYmIGlzQXJndW1lbnRzKGl0ZXJhYmxlKSkge1xuJyArCiAgICAnICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7XG4nICsKICAgICIgICAgICBpbmRleCArPSAnJztcbiIgKwogICAgJyAgICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgICAgfVxuJyArCiAgICAnICB9IGVsc2UgeycgKwogICAgJyAgPCUgfSAlPicgKwoKICAgIC8vIEZpcmVmb3ggPCAzLjYsIE9wZXJhID4gOS41MCAtIE9wZXJhIDwgMTEuNjAsIGFuZCBTYWZhcmkgPCA1LjEKICAgIC8vIChpZiB0aGUgcHJvdG90eXBlIG9yIGEgcHJvcGVydHkgb24gdGhlIHByb3RvdHlwZSBoYXMgYmVlbiBzZXQpCiAgICAvLyBpbmNvcnJlY3RseSBzZXRzIGEgZnVuY3Rpb24ncyBgcHJvdG90eXBlYCBwcm9wZXJ0eSBbW0VudW1lcmFibGVdXQogICAgLy8gdmFsdWUgdG8gYHRydWVgLiBCZWNhdXNlIG9mIHRoaXMgTG8tRGFzaCBzdGFuZGFyZGl6ZXMgb24gc2tpcHBpbmcKICAgIC8vIHRoZSB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkgb2YgZnVuY3Rpb25zIHJlZ2FyZGxlc3Mgb2YgaXRzCiAgICAvLyBbW0VudW1lcmFibGVdXSB2YWx1ZS4KICAgICcgIDwlIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT5cbicgKwogICAgIiAgdmFyIHNraXBQcm90byA9IHR5cGVvZiBpdGVyYWJsZSA9PSAnZnVuY3Rpb24nICYmIFxuIiArCiAgICAiICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoaXRlcmFibGUsICdwcm90b3R5cGUnKTtcbiIgKwogICAgJyAgPCUgfSAlPicgKwoKICAgIC8vIGl0ZXJhdGUgb3duIHByb3BlcnRpZXMgdXNpbmcgYE9iamVjdC5rZXlzYCBpZiBpdCdzIGZhc3QKICAgICcgIDwlIGlmIChpc0tleXNGYXN0ICYmIHVzZUhhcykgeyAlPlxuJyArCiAgICAnICB2YXIgb3duSW5kZXggPSAtMSxcbicgKwogICAgJyAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSA/IG5hdGl2ZUtleXMoaXRlcmFibGUpIDogW10sXG4nICsKICAgICcgICAgICBsZW5ndGggPSBvd25Qcm9wcy5sZW5ndGg7XG5cbicgKwogICAgJyAgd2hpbGUgKCsrb3duSW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTtcbicgKwogICAgIiAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnKSB7ICU+aWYgKCEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKSkge1xuICA8JSB9ICU+IiArCiAgICAnICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgICAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPn1cbjwlIH0gJT4nICsKICAgICcgIH0nICsKCiAgICAvLyBlbHNlIHVzaW5nIGEgZm9yLWluIGxvb3AKICAgICcgIDwlIH0gZWxzZSB7ICU+XG4nICsKICAgICcgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHs8JScgKwogICAgJyAgICBpZiAoIWhhc0RvbnRFbnVtQnVnIHx8IHVzZUhhcykgeyAlPlxuICAgIGlmICg8JScgKwogICAgIiAgICAgIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT4hKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJyk8JSB9IiArCiAgICAnICAgICAgaWYgKCFoYXNEb250RW51bUJ1ZyAmJiB1c2VIYXMpIHsgJT4gJiYgPCUgfScgKwogICAgJyAgICAgIGlmICh1c2VIYXMpIHsgJT5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCk8JSB9JyArCiAgICAnICAgICU+KSB7JyArCiAgICAnICAgIDwlIH0gJT5cbicgKwogICAgJyAgICA8JT0gbG9vcCAlPjsnICsKICAgICcgICAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZyB8fCB1c2VIYXMpIHsgJT5cbiAgICB9PCUgfSAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gQmVjYXVzZSBJRSA8IDkgY2FuJ3Qgc2V0IHRoZSBgW1tFbnVtZXJhYmxlXV1gIGF0dHJpYnV0ZSBvZiBhbgogICAgLy8gZXhpc3RpbmcgcHJvcGVydHkgYW5kIHRoZSBgY29uc3RydWN0b3JgIHByb3BlcnR5IG9mIGEgcHJvdG90eXBlCiAgICAvLyBkZWZhdWx0cyB0byBub24tZW51bWVyYWJsZSwgTG8tRGFzaCBza2lwcyB0aGUgYGNvbnN0cnVjdG9yYAogICAgLy8gcHJvcGVydHkgd2hlbiBpdCBpbmZlcnMgaXQncyBpdGVyYXRpbmcgb3ZlciBhIGBwcm90b3R5cGVgIG9iamVjdC4KICAgICcgIDwlIGlmIChoYXNEb250RW51bUJ1ZykgeyAlPlxuXG4nICsKICAgICcgIHZhciBjdG9yID0gaXRlcmFibGUuY29uc3RydWN0b3I7XG4nICsKICAgICcgICAgPCUgZm9yICh2YXIgayA9IDA7IGsgPCA3OyBrKyspIHsgJT5cbicgKwogICAgIiAgaW5kZXggPSAnPCU9IHNoYWRvd2VkW2tdICU+JztcbiIgKwogICAgJyAgaWYgKDwlJyArCiAgICAiICAgICAgaWYgKHNoYWRvd2VkW2tdID09ICdjb25zdHJ1Y3RvcicpIHsiICsKICAgICcgICAgICAgICU+IShjdG9yICYmIGN0b3IucHJvdG90eXBlID09PSBpdGVyYWJsZSkgJiYgPCUnICsKICAgICcgICAgICB9ICU+aGFzT3duUHJvcGVydHkuY2FsbChpdGVyYWJsZSwgaW5kZXgpKSB7XG4nICsKICAgICcgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgfScgKwogICAgJyAgICA8JSB9ICU+JyArCiAgICAnICA8JSB9ICU+JyArCiAgICAnICA8JSBpZiAoYXJyYXlzIHx8IG5vbkVudW1BcmdzKSB7ICU+XG59PCUgfSAlPlxuJyArCgogICAgLy8gYWRkIGNvZGUgdG8gdGhlIGJvdHRvbSBvZiB0aGUgaXRlcmF0aW9uIGZ1bmN0aW9uCiAgICAnPCU9IGJvdHRvbSAlPjtcbicgKwogICAgLy8gZmluYWxseSwgcmV0dXJuIHRoZSBgcmVzdWx0YAogICAgJ3JldHVybiByZXN1bHQnCiAgKTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBhc3NpZ25gIGFuZCBgZGVmYXVsdHNgICovCiAgdmFyIGFzc2lnbkl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdhcmdzJzogJ29iamVjdCwgc291cmNlLCBndWFyZCcsCiAgICAndG9wJzoKICAgICAgJ3ZhciBhcmdzSW5kZXggPSAwLFxuJyArCiAgICAgICIgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmd1bWVudHMubGVuZ3RoO1xuIiArCiAgICAgICd3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7XG4nICsKICAgICAgJyAgaWYgKChpdGVyYWJsZSA9IGFyZ3VtZW50c1thcmdzSW5kZXhdKSkgeycsCiAgICAnbG9vcCc6ICdyZXN1bHRbaW5kZXhdID0gaXRlcmFibGVbaW5kZXhdJywKICAgICdib3R0b20nOiAnICB9XG59JwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIHNoYXJlZCBieSBgZWFjaGAsIGBmb3JJbmAsIGFuZCBgZm9yT3duYCAqLwogIHZhciBlYWNoSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FyZ3MnOiAnY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcnLAogICAgJ3RvcCc6ICJjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZykiLAogICAgJ2FycmF5cyc6ICJ0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInIiwKICAgICdsb29wJzogJ2lmIChjYWxsYmFjayhpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHJldHVybiByZXN1bHQnCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBmb3JJbmAgYW5kIGBmb3JPd25gICovCiAgdmFyIGZvck93bkl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdhcnJheXMnOiBmYWxzZQogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gb3B0aW1pemVkIHRvIHNlYXJjaCBsYXJnZSBhcnJheXMgZm9yIGEgZ2l2ZW4gYHZhbHVlYCwKICAgKiBzdGFydGluZyBhdCBgZnJvbUluZGV4YCwgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtsYXJnZVNpemU9MzBdIFRoZSBsZW5ndGggYXQgd2hpY2ggYW4gYXJyYXkgaXMgY29uc2lkZXJlZCBsYXJnZS4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgZm91bmQsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBjYWNoZWRDb250YWlucyhhcnJheSwgZnJvbUluZGV4LCBsYXJnZVNpemUpIHsKICAgIGZyb21JbmRleCB8fCAoZnJvbUluZGV4ID0gMCk7CgogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBpc0xhcmdlID0gKGxlbmd0aCAtIGZyb21JbmRleCkgPj0gKGxhcmdlU2l6ZSB8fCBsYXJnZUFycmF5U2l6ZSk7CgogICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgdmFyIGNhY2hlID0ge30sCiAgICAgICAgICBpbmRleCA9IGZyb21JbmRleCAtIDE7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIC8vIG1hbnVhbGx5IGNvZXJjZSBgdmFsdWVgIHRvIGEgc3RyaW5nIGJlY2F1c2UgYGhhc093blByb3BlcnR5YCwgaW4gc29tZQogICAgICAgIC8vIG9sZGVyIHZlcnNpb25zIG9mIEZpcmVmb3gsIGNvZXJjZXMgb2JqZWN0cyBpbmNvcnJlY3RseQogICAgICAgIHZhciBrZXkgPSBhcnJheVtpbmRleF0gKyAnJzsKICAgICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KSA/IGNhY2hlW2tleV0gOiAoY2FjaGVba2V5XSA9IFtdKSkucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICB2YXIga2V5ID0gdmFsdWUgKyAnJzsKICAgICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KSAmJiBpbmRleE9mKGNhY2hlW2tleV0sIHZhbHVlKSA+IC0xOwogICAgICB9CiAgICAgIHJldHVybiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSA+IC0xOwogICAgfQogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgXy5tYXhgIGFuZCBgXy5taW5gIGFzIHRoZSBkZWZhdWx0IGBjYWxsYmFja2Agd2hlbiBhIGdpdmVuCiAgICogYGNvbGxlY3Rpb25gIGlzIGEgc3RyaW5nIHZhbHVlLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIGNoYXJhY3RlciB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGNvZGUgdW5pdCBvZiBnaXZlbiBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gY2hhckF0Q2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5jaGFyQ29kZUF0KDApOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgc29ydEJ5YCB0byBjb21wYXJlIHRyYW5zZm9ybWVkIGBjb2xsZWN0aW9uYCB2YWx1ZXMsIHN0YWJsZSBzb3J0aW5nCiAgICogdGhlbSBpbiBhc2NlbmRpbmcgb3JkZXIuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBhIFRoZSBvYmplY3QgdG8gY29tcGFyZSB0byBgYmAuCiAgICogQHBhcmFtIHtPYmplY3R9IGIgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBhYC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIHRoZSBzb3J0IG9yZGVyIGluZGljYXRvciBvZiBgMWAgb3IgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjb21wYXJlQXNjZW5kaW5nKGEsIGIpIHsKICAgIHZhciBhaSA9IGEuaW5kZXgsCiAgICAgICAgYmkgPSBiLmluZGV4OwoKICAgIGEgPSBhLmNyaXRlcmlhOwogICAgYiA9IGIuY3JpdGVyaWE7CgogICAgLy8gZW5zdXJlIGEgc3RhYmxlIHNvcnQgaW4gVjggYW5kIG90aGVyIGVuZ2luZXMKICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTkwCiAgICBpZiAoYSAhPT0gYikgewogICAgICBpZiAoYSA+IGIgfHwgdHlwZW9mIGEgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYSA8IGIgfHwgdHlwZW9mIGIgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhaSA8IGJpID8gLTEgOiAxOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZwogICAqIG9mIGB0aGlzQXJnYCBhbmQgcHJlcGVuZHMgYW55IGBwYXJ0aWFsQXJnc2AgdG8gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlCiAgICogYm91bmQgZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kIG9yIHRoZSBtZXRob2QgbmFtZS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgKiBAcGFyYW0ge0FycmF5fSBwYXJ0aWFsQXJncyBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHBhcmFtIHtPYmplY3R9IFtyaWdodF0gVXNlZCB0byBpbmRpY2F0ZSBwYXJ0aWFsbHkgYXBwbHlpbmcgYXJndW1lbnRzIGZyb20gdGhlIHJpZ2h0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUJvdW5kKGZ1bmMsIHRoaXNBcmcsIHBhcnRpYWxBcmdzLCByaWdodCkgewogICAgdmFyIGlzRnVuYyA9IGlzRnVuY3Rpb24oZnVuYyksCiAgICAgICAgaXNQYXJ0aWFsID0gIXBhcnRpYWxBcmdzLAogICAgICAgIGtleSA9IHRoaXNBcmc7CgogICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgaWYgKGlzUGFydGlhbCkgewogICAgICBwYXJ0aWFsQXJncyA9IHRoaXNBcmc7CiAgICB9CiAgICBpZiAoIWlzRnVuYykgewogICAgICB0aGlzQXJnID0gZnVuYzsKICAgIH0KCiAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgLy8gYEZ1bmN0aW9uI2JpbmRgIHNwZWMKICAgICAgLy8gaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMy40LjUKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICB0aGlzQmluZGluZyA9IGlzUGFydGlhbCA/IHRoaXMgOiB0aGlzQXJnOwoKICAgICAgaWYgKCFpc0Z1bmMpIHsKICAgICAgICBmdW5jID0gdGhpc0FyZ1trZXldOwogICAgICB9CiAgICAgIGlmIChwYXJ0aWFsQXJncy5sZW5ndGgpIHsKICAgICAgICBhcmdzID0gYXJncy5sZW5ndGgKICAgICAgICAgID8gKGFyZ3MgPSBzbGljZShhcmdzKSwgcmlnaHQgPyBhcmdzLmNvbmNhdChwYXJ0aWFsQXJncykgOiBwYXJ0aWFsQXJncy5jb25jYXQoYXJncykpCiAgICAgICAgICA6IHBhcnRpYWxBcmdzOwogICAgICB9CiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgYm91bmQpIHsKICAgICAgICAvLyBlbnN1cmUgYG5ldyBib3VuZGAgaXMgYW4gaW5zdGFuY2Ugb2YgYGJvdW5kYCBhbmQgYGZ1bmNgCiAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBmdW5jLnByb3RvdHlwZTsKICAgICAgICB0aGlzQmluZGluZyA9IG5ldyBub29wOwogICAgICAgIG5vb3AucHJvdG90eXBlID0gbnVsbDsKCiAgICAgICAgLy8gbWltaWMgdGhlIGNvbnN0cnVjdG9yJ3MgYHJldHVybmAgYmVoYXZpb3IKICAgICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxMy4yLjIKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgfQogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICB9CiAgICByZXR1cm4gYm91bmQ7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhbiBpdGVyYXRpb24gY2FsbGJhY2sgYm91bmQgdG8gYW4gb3B0aW9uYWwgYHRoaXNBcmdgLiBJZiBgZnVuY2AgaXMKICAgKiBhIHByb3BlcnR5IG5hbWUsIHRoZSBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgZm9yIGEgZ2l2ZW4gZWxlbWVudC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFtmdW5jPWlkZW50aXR5fHByb3BlcnR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlcgogICAqIGl0ZXJhdGlvbiBvciBwcm9wZXJ0eSBuYW1lIHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcGFyYW0ge09iamVjdH0gW2FjY3VtdWxhdGluZ10gVXNlZCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBjYWxsYmFjayBzaG91bGQKICAgKiAgYWNjZXB0IGFuIGBhY2N1bXVsYXRvcmAgYXJndW1lbnQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGEgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYWNjdW11bGF0aW5nKSB7CiAgICBpZiAoIWZ1bmMpIHsKICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgfQogICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgIGlmICh0eXBlICE9ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2Z1bmNdOwogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHZhciBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gaXNFcXVhbChvYmplY3RbcHJvcHNbbGVuZ3RoXV0sIGZ1bmNbcHJvcHNbbGVuZ3RoXV0pKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgdGhpc0FyZyAhPSAndW5kZWZpbmVkJykgewogICAgICBpZiAoYWNjdW11bGF0aW5nKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBvYmplY3QpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gZnVuYzsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgY29tcGlsZWQgaXRlcmF0aW9uIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zMSwgb3B0aW9uczIsIC4uLl0gVGhlIGNvbXBpbGUgb3B0aW9ucyBvYmplY3QocykuCiAgICogIGFycmF5cyAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBpdGVyYWJsZSBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlLgogICAqICB1c2VIYXMgLSBBIGJvb2xlYW4gdG8gc3BlY2lmeSB1c2luZyBgaGFzT3duUHJvcGVydHlgIGNoZWNrcyBpbiB0aGUgb2JqZWN0IGxvb3AuCiAgICogIGFyZ3MgLSBBIHN0cmluZyBvZiBjb21tYSBzZXBhcmF0ZWQgYXJndW1lbnRzIHRoZSBpdGVyYXRpb24gZnVuY3Rpb24gd2lsbCBhY2NlcHQuCiAgICogIHRvcCAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBiZWZvcmUgdGhlIGl0ZXJhdGlvbiBicmFuY2hlcy4KICAgKiAgbG9vcCAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBpbiB0aGUgb2JqZWN0IGxvb3AuCiAgICogIGJvdHRvbSAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBhZnRlciB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzLgogICAqCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBjb21waWxlZCBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBjcmVhdGVJdGVyYXRvcigpIHsKICAgIHZhciBkYXRhID0gewogICAgICAvLyBzdXBwb3J0IHByb3BlcnRpZXMKICAgICAgJ2hhc0RvbnRFbnVtQnVnJzogaGFzRG9udEVudW1CdWcsCiAgICAgICdpc0tleXNGYXN0JzogaXNLZXlzRmFzdCwKICAgICAgJ25vbkVudW1BcmdzJzogbm9uRW51bUFyZ3MsCiAgICAgICdub0NoYXJCeUluZGV4Jzogbm9DaGFyQnlJbmRleCwKICAgICAgJ3NoYWRvd2VkJzogc2hhZG93ZWQsCgogICAgICAvLyBpdGVyYXRvciBvcHRpb25zCiAgICAgICdhcnJheXMnOiAnaXNBcnJheShpdGVyYWJsZSknLAogICAgICAnYm90dG9tJzogJycsCiAgICAgICdsb29wJzogJycsCiAgICAgICd0b3AnOiAnJywKICAgICAgJ3VzZUhhcyc6IHRydWUKICAgIH07CgogICAgLy8gbWVyZ2Ugb3B0aW9ucyBpbnRvIGEgdGVtcGxhdGUgZGF0YSBvYmplY3QKICAgIGZvciAodmFyIG9iamVjdCwgaW5kZXggPSAwOyBvYmplY3QgPSBhcmd1bWVudHNbaW5kZXhdOyBpbmRleCsrKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBkYXRhW2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgfQogICAgfQogICAgdmFyIGFyZ3MgPSBkYXRhLmFyZ3M7CiAgICBkYXRhLmZpcnN0QXJnID0gL15bXixdKy8uZXhlYyhhcmdzKVswXTsKCiAgICAvLyBjcmVhdGUgdGhlIGZ1bmN0aW9uIGZhY3RvcnkKICAgIHZhciBmYWN0b3J5ID0gRnVuY3Rpb24oCiAgICAgICAgJ2NyZWF0ZUNhbGxiYWNrLCBoYXNPd25Qcm9wZXJ0eSwgaXNBcmd1bWVudHMsIGlzQXJyYXksIGlzU3RyaW5nLCAnICsKICAgICAgICAnb2JqZWN0VHlwZXMsIG5hdGl2ZUtleXMsIHByb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICAgJ3JldHVybiBmdW5jdGlvbignICsgYXJncyArICcpIHtcbicgKyBpdGVyYXRvclRlbXBsYXRlKGRhdGEpICsgJ1xufScKICAgICk7CiAgICAvLyByZXR1cm4gdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICByZXR1cm4gZmFjdG9yeSgKICAgICAgY3JlYXRlQ2FsbGJhY2ssIGhhc093blByb3BlcnR5LCBpc0FyZ3VtZW50cywgaXNBcnJheSwgaXNTdHJpbmcsCiAgICAgIG9iamVjdFR5cGVzLCBuYXRpdmVLZXlzLCBwcm9wZXJ0eUlzRW51bWVyYWJsZQogICAgKTsKICB9CgogIC8qKgogICAqIEEgZnVuY3Rpb24gY29tcGlsZWQgdG8gaXRlcmF0ZSBgYXJndW1lbnRzYCBvYmplY3RzLCBhcnJheXMsIG9iamVjdHMsIGFuZAogICAqIHN0cmluZ3MgY29uc2lzdGVubHkgYWNyb3NzIGVudmlyb25tZW50cywgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoCiAgICogZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgKiB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLiBDYWxsYmFja3MgbWF5IGV4aXQKICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxTdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAqLwogIHZhciBlYWNoID0gY3JlYXRlSXRlcmF0b3IoZWFjaEl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIFVzZWQgYnkgYHRlbXBsYXRlYCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkCiAgICogc3RyaW5nIGxpdGVyYWxzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIGVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVTdHJpbmdDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gJ1xcJyArIHN0cmluZ0VzY2FwZXNbbWF0Y2hdOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgIHJldHVybiBodG1sRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIERPTSBub2RlIGluIElFIDwgOS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIERPTSBub2RlLCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gaXNOb2RlKHZhbHVlKSB7CiAgICAvLyBJRSA8IDkgcHJlc2VudHMgRE9NIG5vZGVzIGFzIGBPYmplY3RgIG9iamVjdHMgZXhjZXB0IHRoZXkgaGF2ZSBgdG9TdHJpbmdgCiAgICAvLyBtZXRob2RzIHRoYXQgYXJlIGB0eXBlb2ZgICJzdHJpbmciIGFuZCBzdGlsbCBjYW4gY29lcmNlIG5vZGVzIHRvIHN0cmluZ3MKICAgIHJldHVybiB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgKHZhbHVlICsgJycpID09ICdzdHJpbmcnOwogIH0KCiAgLyoqCiAgICogQSBuby1vcGVyYXRpb24gZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgfQoKICAvKioKICAgKiBTbGljZXMgdGhlIGBjb2xsZWN0aW9uYCBmcm9tIHRoZSBgc3RhcnRgIGluZGV4IHVwIHRvLCBidXQgbm90IGluY2x1ZGluZywKICAgKiB0aGUgYGVuZGAgaW5kZXguCiAgICoKICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQsIGluc3RlYWQgb2YgYEFycmF5I3NsaWNlYCwgdG8gc3VwcG9ydCBub2RlIGxpc3RzCiAgICogaW4gSUUgPCA5IGFuZCB0byBlbnN1cmUgZGVuc2UgYXJyYXlzIGFyZSByZXR1cm5lZC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNsaWNlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgaW5kZXguCiAgICogQHBhcmFtIHtOdW1iZXJ9IGVuZCBUaGUgZW5kIGluZGV4LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5LgogICAqLwogIGZ1bmN0aW9uIHNsaWNlKGFycmF5LCBzdGFydCwgZW5kKSB7CiAgICBzdGFydCB8fCAoc3RhcnQgPSAwKTsKICAgIGlmICh0eXBlb2YgZW5kID09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuZCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGVuZCAtIHN0YXJ0IHx8IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBhcnJheVtzdGFydCArIGluZGV4XTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB1bmVzY2FwZWAgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gdW5lc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiB1bmVzY2FwZUh0bWxDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gaHRtbFVuZXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYGFyZ3VtZW50c2Agb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpOyB9KSgxLCAyLCAzKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzQXJndW1lbnRzKFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFyZ3NDbGFzczsKICB9CiAgLy8gZmFsbGJhY2sgZm9yIGJyb3dzZXJzIHRoYXQgY2FuJ3QgZGV0ZWN0IGBhcmd1bWVudHNgIG9iamVjdHMgYnkgW1tDbGFzc11dCiAgaWYgKG5vQXJnc0NsYXNzKSB7CiAgICBpc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdjYWxsZWUnKSA6IGZhbHNlOwogICAgfTsKICB9CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYG9iamVjdGAncyBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZwogICAqIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICogaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24KICAgKiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBmdW5jdGlvbiBEb2cobmFtZSkgewogICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgKiB9CiAgICoKICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgKiAgIGFsZXJ0KCdXb29mLCB3b29mIScpOwogICAqIH07CiAgICoKICAgKiBfLmZvckluKG5ldyBEb2coJ0RhZ255JyksIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIGFsZXJ0KGtleSk7CiAgICogfSk7CiAgICogLy8gPT4gYWxlcnRzICduYW1lJyBhbmQgJ2JhcmsnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9ySW4gPSBjcmVhdGVJdGVyYXRvcihlYWNoSXRlcmF0b3JPcHRpb25zLCBmb3JPd25JdGVyYXRvck9wdGlvbnMsIHsKICAgICd1c2VIYXMnOiBmYWxzZQogIH0pOwoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGFuIG9iamVjdCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZyB0aGUgYGNhbGxiYWNrYAogICAqIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseQogICAqIHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZvck93bih7ICcwJzogJ3plcm8nLCAnMSc6ICdvbmUnLCAnbGVuZ3RoJzogMiB9LCBmdW5jdGlvbihudW0sIGtleSkgewogICAqICAgYWxlcnQoa2V5KTsKICAgKiB9KTsKICAgKiAvLyA9PiBhbGVydHMgJzAnLCAnMScsIGFuZCAnbGVuZ3RoJyAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGZvck93biA9IGNyZWF0ZUl0ZXJhdG9yKGVhY2hJdGVyYXRvck9wdGlvbnMsIGZvck93bkl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJyYXkoYXJndW1lbnRzKTsgfSkoKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0FycmF5KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIHZhciBpc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbih2YWx1ZSkgewogICAgLy8gYGluc3RhbmNlb2ZgIG1heSBjYXVzZSBhIG1lbW9yeSBsZWFrIGluIElFIDcgaWYgYHZhbHVlYCBpcyBhIGhvc3Qgb2JqZWN0CiAgICAvLyBodHRwOi8vYWpheGlhbi5jb20vYXJjaGl2ZXMvd29ya2luZy1hcm91bmctdGhlLWluc3RhbmNlb2YtbWVtb3J5LWxlYWsKICAgIHJldHVybiAoYXJnc0FyZU9iamVjdHMgJiYgdmFsdWUgaW5zdGFuY2VvZiBBcnJheSkgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYXJyYXlDbGFzczsKICB9OwoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbXBvc2VkIG9mIHRoZSBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcyBvZiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmtleXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gWydvbmUnLCAndHdvJywgJ3RocmVlJ10gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIHZhciBrZXlzID0gIW5hdGl2ZUtleXMgPyBzaGltS2V5cyA6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgLy8gYXZvaWQgaXRlcmF0aW5nIG92ZXIgdGhlIGBwcm90b3R5cGVgIHByb3BlcnR5CiAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PSAnZnVuY3Rpb24nICYmIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCAncHJvdG90eXBlJykKICAgICAgPyBzaGltS2V5cyhvYmplY3QpCiAgICAgIDogKGlzT2JqZWN0KG9iamVjdCkgPyBuYXRpdmVLZXlzKG9iamVjdCkgOiBbXSk7CiAgfTsKCiAgLyoqCiAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgaXNQbGFpbk9iamVjdGAgdGhhdCBjaGVja3MgaWYgYSBnaXZlbiBgdmFsdWVgCiAgICogaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLCBhc3N1bWluZyBvYmplY3RzIGNyZWF0ZWQKICAgKiBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IgaGF2ZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGFuZCB0aGF0CiAgICogdGhlcmUgYXJlIG5vIGBPYmplY3QucHJvdG90eXBlYCBleHRlbnNpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gc2hpbUlzUGxhaW5PYmplY3QodmFsdWUpIHsKICAgIC8vIGF2b2lkIG5vbi1vYmplY3RzIGFuZCBmYWxzZSBwb3NpdGl2ZXMgZm9yIGBhcmd1bWVudHNgIG9iamVjdHMKICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgIGlmICghKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykgfHwgaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvLyBjaGVjayB0aGF0IHRoZSBjb25zdHJ1Y3RvciBpcyBgT2JqZWN0YCAoaS5lLiBgT2JqZWN0IGluc3RhbmNlb2YgT2JqZWN0YCkKICAgIHZhciBjdG9yID0gdmFsdWUuY29uc3RydWN0b3I7CiAgICBpZiAoKCFpc0Z1bmN0aW9uKGN0b3IpICYmICghbm9Ob2RlQ2xhc3MgfHwgIWlzTm9kZSh2YWx1ZSkpKSB8fCBjdG9yIGluc3RhbmNlb2YgY3RvcikgewogICAgICAvLyBJRSA8IDkgaXRlcmF0ZXMgaW5oZXJpdGVkIHByb3BlcnRpZXMgYmVmb3JlIG93biBwcm9wZXJ0aWVzLiBJZiB0aGUgZmlyc3QKICAgICAgLy8gaXRlcmF0ZWQgcHJvcGVydHkgaXMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnR5IHRoZW4gdGhlcmUgYXJlIG5vIGluaGVyaXRlZAogICAgICAvLyBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgIGlmIChpdGVyYXRlc093bkxhc3QpIHsKICAgICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgICByZXN1bHQgPSAhaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gSW4gbW9zdCBlbnZpcm9ubWVudHMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGJlZm9yZQogICAgICAvLyBpdHMgaW5oZXJpdGVkIHByb3BlcnRpZXMuIElmIHRoZSBsYXN0IGl0ZXJhdGVkIHByb3BlcnR5IGlzIGFuIG9iamVjdCdzCiAgICAgIC8vIG93biBwcm9wZXJ0eSB0aGVuIHRoZXJlIGFyZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQgPT09IGZhbHNlIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgT2JqZWN0LmtleXNgIHRoYXQgcHJvZHVjZXMgYW4gYXJyYXkgb2YgdGhlCiAgICogZ2l2ZW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgKi8KICBmdW5jdGlvbiBzaGltS2V5cyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvck93bihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFVzZWQgdG8gY29udmVydCBjaGFyYWN0ZXJzIHRvIEhUTUwgZW50aXRpZXM6CiAgICoKICAgKiBUaG91Z2ggdGhlIGA+YCBjaGFyYWN0ZXIgaXMgZXNjYXBlZCBmb3Igc3ltbWV0cnksIGNoYXJhY3RlcnMgbGlrZSBgPmAgYW5kIGAvYAogICAqIGRvbid0IHJlcXVpcmUgZXNjYXBpbmcgaW4gSFRNTCBhbmQgaGF2ZSBubyBzcGVjaWFsIG1lYW5pbmcgdW5sZXNzIHRoZXkncmUgcGFydAogICAqIG9mIGEgdGFnIG9yIGFuIHVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZS4KICAgKiBodHRwOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9hbWJpZ3VvdXMtYW1wZXJzYW5kcyAodW5kZXIgInNlbWktcmVsYXRlZCBmdW4gZmFjdCIpCiAgICovCiAgdmFyIGh0bWxFc2NhcGVzID0gewogICAgJyYnOiAnJmFtcDsnLAogICAgJzwnOiAnJmx0OycsCiAgICAnPic6ICcmZ3Q7JywKICAgICciJzogJyZxdW90OycsCiAgICAiJyI6ICcmI3gyNzsnCiAgfTsKCiAgLyoqIFVzZWQgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMgKi8KICB2YXIgaHRtbFVuZXNjYXBlcyA9IGludmVydChodG1sRXNjYXBlcyk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgYGRlc3RpbmF0aW9uYAogICAqIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzIHdpbGwgb3ZlcndyaXRlIHByb3BlcnkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMKICAgKiBzb3VyY2VzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGV4dGVuZAogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBbc291cmNlMSwgc291cmNlMiwgLi4uXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7T2JqZWN0fSBbZ3VhcmRdIEludGVybmFsbHkgdXNlZCB0byBhbGxvdyB0aGlzIG1ldGhvZCB0byB3b3JrIHdpdGgKICAgKiAgYF8ucmVkdWNlYCB3aXRob3V0IHVzaW5nIGl0cyBjYWxsYmFjaydzIGBrZXkgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5hc3NpZ24oeyAnbmFtZSc6ICdtb2UnIH0sIHsgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgKi8KICB2YXIgYXNzaWduID0gY3JlYXRlSXRlcmF0b3IoYXNzaWduSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGB2YWx1ZWAuIElmIGBkZWVwYCBpcyBgdHJ1ZWAsIG5lc3RlZCBvYmplY3RzIHdpbGwgYWxzbwogICAqIGJlIGNsb25lZCwgb3RoZXJ3aXNlIHRoZXkgd2lsbCBiZSBhc3NpZ25lZCBieSByZWZlcmVuY2UuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRlZXAgQSBmbGFnIHRvIGluZGljYXRlIGEgZGVlcCBjbG9uZS4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBvdGhlcnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcgdGhlaXIgY2FsbGJhY2sgYGluZGV4YCBhcmd1bWVudCBmb3IgYGRlZXBgLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gdHJhY2sgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tCPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gYXNzb2NpYXRlIGNsb25lcyB3aXRoIHRoZWlyCiAgICogIHNvdXJjZSBjb3VudGVycGFydHMuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBjbG9uZWQgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIHZhciBzaGFsbG93ID0gXy5jbG9uZShzdG9vZ2VzKTsKICAgKiBzaGFsbG93WzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIHZhciBkZWVwID0gXy5jbG9uZShzdG9vZ2VzLCB0cnVlKTsKICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gY2xvbmUodmFsdWUsIGRlZXAsIGd1YXJkLCBzdGFja0EsIHN0YWNrQikgewogICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKGd1YXJkKSB7CiAgICAgIGRlZXAgPSBmYWxzZTsKICAgIH0KICAgIC8vIGluc3BlY3QgW1tDbGFzc11dCiAgICB2YXIgaXNPYmogPSBpc09iamVjdCh2YWx1ZSk7CiAgICBpZiAoaXNPYmopIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgICBpZiAoIWNsb25lYWJsZUNsYXNzZXNbY2xhc3NOYW1lXSB8fCAobm9Ob2RlQ2xhc3MgJiYgaXNOb2RlKHZhbHVlKSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSk7CiAgICB9CiAgICAvLyBzaGFsbG93IGNsb25lCiAgICBpZiAoIWlzT2JqIHx8ICFkZWVwKSB7CiAgICAgIHJldHVybiBpc09iagogICAgICAgID8gKGlzQXJyID8gc2xpY2UodmFsdWUpIDogYXNzaWduKHt9LCB2YWx1ZSkpCiAgICAgICAgOiB2YWx1ZTsKICAgIH0KICAgIHZhciBjdG9yID0gY3RvckJ5Q2xhc3NbY2xhc3NOYW1lXTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICByZXR1cm4gbmV3IGN0b3IoK3ZhbHVlKTsKCiAgICAgIGNhc2UgbnVtYmVyQ2xhc3M6CiAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgcmV0dXJuIG5ldyBjdG9yKHZhbHVlKTsKCiAgICAgIGNhc2UgcmVnZXhwQ2xhc3M6CiAgICAgICAgcmV0dXJuIGN0b3IodmFsdWUuc291cmNlLCByZUZsYWdzLmV4ZWModmFsdWUpKTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VzIGFuZCByZXR1cm4gY29ycmVzcG9uZGluZyBjbG9uZQogICAgc3RhY2tBIHx8IChzdGFja0EgPSBbXSk7CiAgICBzdGFja0IgfHwgKHN0YWNrQiA9IFtdKTsKCiAgICB2YXIgbGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBpZiAoc3RhY2tBW2xlbmd0aF0gPT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF07CiAgICAgIH0KICAgIH0KICAgIC8vIGluaXQgY2xvbmVkIG9iamVjdAogICAgdmFyIHJlc3VsdCA9IGlzQXJyID8gY3Rvcih2YWx1ZS5sZW5ndGgpIDoge307CgogICAgLy8gYWRkIHRoZSBzb3VyY2UgdmFsdWUgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzCiAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICBzdGFja0EucHVzaCh2YWx1ZSk7CiAgICBzdGFja0IucHVzaChyZXN1bHQpOwoKICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgIChpc0FyciA/IGZvckVhY2ggOiBmb3JPd24pKHZhbHVlLCBmdW5jdGlvbihvYmpWYWx1ZSwga2V5KSB7CiAgICAgIHJlc3VsdFtrZXldID0gY2xvbmUob2JqVmFsdWUsIGRlZXAsIG51bGwsIHN0YWNrQSwgc3RhY2tCKTsKICAgIH0pOwoKICAgIC8vIGFkZCBhcnJheSBwcm9wZXJ0aWVzIGFzc2lnbmVkIGJ5IGBSZWdFeHAjZXhlY2AKICAgIGlmIChpc0FycikgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2luZGV4JykpIHsKICAgICAgICByZXN1bHQuaW5kZXggPSB2YWx1ZS5pbmRleDsKICAgICAgfQogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2lucHV0JykpIHsKICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZS5pbnB1dDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBkZWVwIGNsb25lIG9mIGB2YWx1ZWAuIEZ1bmN0aW9ucyBhbmQgRE9NIG5vZGVzIGFyZSAqKm5vdCoqIGNsb25lZC4KICAgKiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kIG9iamVjdHMgY3JlYXRlZCBieQogICAqIGNvbnN0cnVjdG9ycyBvdGhlciB0aGFuIGBPYmplY3RgIGFyZSBjbG9uZWQgdG8gcGxhaW4gYE9iamVjdGAgb2JqZWN0cy4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgbG9vc2VseSBiYXNlZCBvbiB0aGUgc3RydWN0dXJlZCBjbG9uZSBhbGdvcml0aG0uCiAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogdmFyIGRlZXAgPSBfLmNsb25lRGVlcChzdG9vZ2VzKTsKICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gY2xvbmVEZWVwKHZhbHVlKSB7CiAgICByZXR1cm4gY2xvbmUodmFsdWUsIHRydWUpOwogIH0KCiAgLyoqCiAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGBkZXN0aW5hdGlvbmAKICAgKiBvYmplY3QgZm9yIGFsbCBgZGVzdGluYXRpb25gIHByb3BlcnRpZXMgdGhhdCByZXNvbHZlIHRvIGBudWxsYC9gdW5kZWZpbmVkYC4KICAgKiBPbmNlIGEgcHJvcGVydHkgaXMgc2V0LCBhZGRpdGlvbmFsIGRlZmF1bHRzIG9mIHRoZSBzYW1lIHByb3BlcnR5IHdpbGwgYmUKICAgKiBpZ25vcmVkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzIGNhbGxiYWNrJ3MgYGtleWAgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGljZUNyZWFtID0geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScgfTsKICAgKiBfLmRlZmF1bHRzKGljZUNyZWFtLCB7ICdmbGF2b3InOiAndmFuaWxsYScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfSk7CiAgICogLy8gPT4geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfQogICAqLwogIHZhciBkZWZhdWx0cyA9IGNyZWF0ZUl0ZXJhdG9yKGFzc2lnbkl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2xvb3AnOiAnaWYgKHJlc3VsdFtpbmRleF0gPT0gbnVsbCkgJyArIGFzc2lnbkl0ZXJhdG9yT3B0aW9ucy5sb29wCiAgfSk7CgogIC8qKgogICAqIENyZWF0ZXMgYSBzb3J0ZWQgYXJyYXkgb2YgYWxsIGVudW1lcmFibGUgcHJvcGVydGllcywgb3duIGFuZCBpbmhlcml0ZWQsCiAgICogb2YgYG9iamVjdGAgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBtZXRob2RzCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5mdW5jdGlvbnMoXyk7CiAgICogLy8gPT4gWydhbGwnLCAnYW55JywgJ2JpbmQnLCAnYmluZEFsbCcsICdjbG9uZScsICdjb21wYWN0JywgJ2NvbXBvc2UnLCAuLi5dCiAgICovCiAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5zb3J0KCk7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgYHByb3BlcnR5YCBleGlzdHMgYW5kIGlzIGEgZGlyZWN0IHByb3BlcnR5LAogICAqIGluc3RlYWQgb2YgYW4gaW5oZXJpdGVkIHByb3BlcnR5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY2hlY2suCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBjaGVjayBmb3IuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaGFzKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIHJldHVybiBvYmplY3QgPyBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpIDogZmFsc2U7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgaW52ZXJ0ZWQga2V5cyBhbmQgdmFsdWVzIG9mIHRoZSBnaXZlbiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGludmVydC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjcmVhdGVkIGludmVydGVkIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogIF8uaW52ZXJ0KHsgJ2ZpcnN0JzogJ01vZScsICdzZWNvbmQnOiAnTGFycnknLCAndGhpcmQnOiAnQ3VybHknIH0pOwogICAqIC8vID0+IHsgJ01vZSc6ICdmaXJzdCcsICdMYXJyeSc6ICdzZWNvbmQnLCAnQ3VybHknOiAndGhpcmQnIH0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIGludmVydChvYmplY3QpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICByZXN1bHRbb2JqZWN0W2tleV1dID0ga2V5OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBib29sZWFuIHZhbHVlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNCb29sZWFuKG51bGwpOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGJvb2xDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZGF0ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBkYXRlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNEYXRlKG5ldyBEYXRlKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBEYXRlIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGRhdGVDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0VsZW1lbnQoZG9jdW1lbnQuYm9keSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRWxlbWVudCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID8gdmFsdWUubm9kZVR5cGUgPT09IDEgOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGVtcHR5LiBBcnJheXMsIHN0cmluZ3MsIG9yIGBhcmd1bWVudHNgIG9iamVjdHMgd2l0aCBhCiAgICogbGVuZ3RoIG9mIGAwYCBhbmQgb2JqZWN0cyB3aXRoIG5vIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGNvbnNpZGVyZWQKICAgKiAiZW1wdHkiLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgZW1wdHksIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0VtcHR5KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNFbXB0eSh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0VtcHR5KCcnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFbXB0eSh2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAoIXZhbHVlKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSksCiAgICAgICAgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOwoKICAgIGlmICgoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MgfHwgY2xhc3NOYW1lID09IHN0cmluZ0NsYXNzIHx8CiAgICAgICAgY2xhc3NOYW1lID09IGFyZ3NDbGFzcyB8fCAobm9BcmdzQ2xhc3MgJiYgaXNBcmd1bWVudHModmFsdWUpKSkgfHwKICAgICAgICAoY2xhc3NOYW1lID09IG9iamVjdENsYXNzICYmIHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgJiYgaXNGdW5jdGlvbih2YWx1ZS5zcGxpY2UpKSkgewogICAgICByZXR1cm4gIWxlbmd0aDsKICAgIH0KICAgIGZvck93bih2YWx1ZSwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAocmVzdWx0ID0gZmFsc2UpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUGVyZm9ybXMgYSBkZWVwIGNvbXBhcmlzb24gYmV0d2VlbiB0d28gdmFsdWVzIHRvIGRldGVybWluZSBpZiB0aGV5IGFyZQogICAqIGVxdWl2YWxlbnQgdG8gZWFjaCBvdGhlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gYSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgKiBAcGFyYW0ge01peGVkfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbS0ge09iamVjdH0gW3N0YWNrQT1bXV0gSW50ZXJuYWxseSB1c2VkIHRyYWNrIHRyYXZlcnNlZCBgYWAgb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0cmFjayB0cmF2ZXJzZWQgYGJgIG9iamVjdHMuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgdmFsdWVzIGFyZSBlcXV2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqIHZhciBjbG9uZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqCiAgICogbW9lID09IGNsb25lOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzRXF1YWwobW9lLCBjbG9uZSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYiwgc3RhY2tBLCBzdGFja0IpIHsKICAgIC8vIGV4aXQgZWFybHkgZm9yIGlkZW50aWNhbCB2YWx1ZXMKICAgIGlmIChhID09PSBiKSB7CiAgICAgIC8vIHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgIHJldHVybiBhICE9PSAwIHx8ICgxIC8gYSA9PSAxIC8gYik7CiAgICB9CiAgICAvLyBleGl0IGVhcmx5IGZvciB1bmxpa2UgYG51bGxgIG9yIGB1bmRlZmluZWRgIHZhbHVlcwogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gY29tcGFyZSBbW0NsYXNzXV0gbmFtZXMKICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpLAogICAgICAgIG90aGVyTmFtZSA9IHRvU3RyaW5nLmNhbGwoYik7CgogICAgaWYgKGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MpIHsKICAgICAgY2xhc3NOYW1lID0gb2JqZWN0Q2xhc3M7CiAgICB9CiAgICBpZiAob3RoZXJOYW1lID09IGFyZ3NDbGFzcykgewogICAgICBvdGhlck5hbWUgPSBvYmplY3RDbGFzczsKICAgIH0KICAgIGlmIChjbGFzc05hbWUgIT0gb3RoZXJOYW1lKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICAvLyBjb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWJlcnMsIGRhdGVzIHRvIG1pbGxpc2Vjb25kcyBhbmQgYm9vbGVhbnMKICAgICAgICAvLyB0byBgMWAgb3IgYDBgLCB0cmVhdGluZyBpbnZhbGlkIGRhdGVzIGNvZXJjZWQgdG8gYE5hTmAgYXMgbm90IGVxdWFsCiAgICAgICAgcmV0dXJuICthID09ICtiOwoKICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAvLyB0cmVhdCBgTmFOYCB2cy4gYE5hTmAgYXMgZXF1YWwKICAgICAgICByZXR1cm4gYSAhPSArYQogICAgICAgICAgPyBiICE9ICtiCiAgICAgICAgICAvLyBidXQgdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICAgIDogKGEgPT0gMCA/ICgxIC8gYSA9PSAxIC8gYikgOiBhID09ICtiKTsKCiAgICAgIGNhc2UgcmVnZXhwQ2xhc3M6CiAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgLy8gY29lcmNlIHJlZ2V4ZXMgdG8gc3RyaW5ncyAoaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMTAuNi40KQogICAgICAgIC8vIHRyZWF0IHN0cmluZyBwcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCBpbnN0YW5jZXMgYXMgZXF1YWwKICAgICAgICByZXR1cm4gYSA9PSBiICsgJyc7CiAgICB9CiAgICB2YXIgaXNBcnIgPSBjbGFzc05hbWUgPT0gYXJyYXlDbGFzczsKICAgIGlmICghaXNBcnIpIHsKICAgICAgLy8gdW53cmFwIGFueSBgbG9kYXNoYCB3cmFwcGVkIHZhbHVlcwogICAgICBpZiAoYS5fX3dyYXBwZWRfXyB8fCBiLl9fd3JhcHBlZF9fKSB7CiAgICAgICAgcmV0dXJuIGlzRXF1YWwoYS5fX3dyYXBwZWRfXyB8fCBhLCBiLl9fd3JhcHBlZF9fIHx8IGIpOwogICAgICB9CiAgICAgIC8vIGV4aXQgZm9yIGZ1bmN0aW9ucyBhbmQgRE9NIG5vZGVzCiAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MgfHwgKG5vTm9kZUNsYXNzICYmIChpc05vZGUoYSkgfHwgaXNOb2RlKGIpKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICB2YXIgY3RvckEgPSAhYXJnc0FyZU9iamVjdHMgJiYgaXNBcmd1bWVudHMoYSkgPyBPYmplY3QgOiBhLmNvbnN0cnVjdG9yLAogICAgICAgICAgY3RvckIgPSAhYXJnc0FyZU9iamVjdHMgJiYgaXNBcmd1bWVudHMoYikgPyBPYmplY3QgOiBiLmNvbnN0cnVjdG9yOwoKICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgaWYgKGN0b3JBICE9IGN0b3JCICYmICEoCiAgICAgICAgICAgIGlzRnVuY3Rpb24oY3RvckEpICYmIGN0b3JBIGluc3RhbmNlb2YgY3RvckEgJiYKICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQgogICAgICAgICAgKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgLy8gYXNzdW1lIGN5Y2xpYyBzdHJ1Y3R1cmVzIGFyZSBlcXVhbAogICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgIC8vIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AgKGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjEyLjMpCiAgICBzdGFja0EgfHwgKHN0YWNrQSA9IFtdKTsKICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gW10pOwoKICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrQltsZW5ndGhdID09IGI7CiAgICAgIH0KICAgIH0KICAgIHZhciByZXN1bHQgPSB0cnVlLAogICAgICAgIHNpemUgPSAwOwoKICAgIC8vIGFkZCBgYWAgYW5kIGBiYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgIHN0YWNrQS5wdXNoKGEpOwogICAgc3RhY2tCLnB1c2goYik7CgogICAgLy8gcmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgaWYgKGlzQXJyKSB7CiAgICAgIC8vIGNvbXBhcmUgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5CiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBkZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gaXNFcXVhbChhW3NpemVdLCBiW3NpemVdLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLy8gZGVlcCBjb21wYXJlIG9iamVjdHMgdXNpbmcgYGZvckluYCwgaW5zdGVhZCBvZiBgZm9yT3duYCwgdG8gYXZvaWQgYE9iamVjdC5rZXlzYAogICAgLy8gd2hpY2gsIGluIHRoaXMgY2FzZSwgaXMgbW9yZSBjb3N0bHkKICAgIGZvckluKGEsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGEpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoYSwga2V5KSkgewogICAgICAgIC8vIGNvdW50IHRoZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICBzaXplKys7CiAgICAgICAgLy8gZGVlcCBjb21wYXJlIGVhY2ggcHJvcGVydHkgdmFsdWUuCiAgICAgICAgcmV0dXJuIChyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkgJiYgaXNFcXVhbCh2YWx1ZSwgYltrZXldLCBzdGFja0EsIHN0YWNrQikpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAocmVzdWx0KSB7CiAgICAgIC8vIGVuc3VyZSBib3RoIG9iamVjdHMgaGF2ZSB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcwogICAgICBmb3JJbihiLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBiKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSkgewogICAgICAgICAgLy8gYHNpemVgIHdpbGwgYmUgYC0xYCBpZiBgYmAgaGFzIG1vcmUgcHJvcGVydGllcyB0aGFuIGBhYAogICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcywgb3IgY2FuIGJlIGNvZXJjZWQgdG8sIGEgZmluaXRlIG51bWJlci4KICAgKgogICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNGaW5pdGVgLCB3aGljaCB3aWxsIHJldHVybiB0cnVlIGZvcgogICAqIGJvb2xlYW5zIGFuZCBlbXB0eSBzdHJpbmdzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMS4yLjUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGZpbml0ZSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRmluaXRlKC0xMDEpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNGaW5pdGUoJzEwJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0Zpbml0ZSh0cnVlKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0Zpbml0ZSgnJyk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gaXNGaW5pdGUodmFsdWUpIHsKICAgIHJldHVybiBuYXRpdmVJc0Zpbml0ZSh2YWx1ZSkgJiYgIW5hdGl2ZUlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Z1bmN0aW9uKF8pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbic7CiAgfQogIC8vIGZhbGxiYWNrIGZvciBvbGRlciB2ZXJzaW9ucyBvZiBDaHJvbWUgYW5kIFNhZmFyaQogIGlmIChpc0Z1bmN0aW9uKC94LykpIHsKICAgIGlzRnVuY3Rpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBGdW5jdGlvbiB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBmdW5jQ2xhc3M7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgdGhlIGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0LgogICAqIChlLmcuIGFycmF5cywgZnVuY3Rpb25zLCBvYmplY3RzLCByZWdleGVzLCBgbmV3IE51bWJlcigwKWAsIGFuZCBgbmV3IFN0cmluZygnJylgKQogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc09iamVjdCh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc09iamVjdChbMSwgMiwgM10pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNPYmplY3QoMSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgLy8gY2hlY2sgaWYgdGhlIHZhbHVlIGlzIHRoZSBFQ01BU2NyaXB0IGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0CiAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3g4CiAgICAvLyBhbmQgYXZvaWQgYSBWOCBidWcKICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIyOTEKICAgIHJldHVybiB2YWx1ZSA/IG9iamVjdFR5cGVzW3R5cGVvZiB2YWx1ZV0gOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGBOYU5gLgogICAqCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc05hTmAsIHdoaWNoIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IKICAgKiBgdW5kZWZpbmVkYCBhbmQgb3RoZXIgdmFsdWVzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMS4yLjQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGBOYU5gLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOYU4oTmFOKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKG5ldyBOdW1iZXIoTmFOKSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc05hTih2YWx1ZSkgewogICAgLy8gYE5hTmAgYXMgYSBwcmltaXRpdmUgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBpcyBub3QgZXF1YWwgdG8gaXRzZWxmCiAgICAvLyAocGVyZm9ybSB0aGUgW1tDbGFzc11dIGNoZWNrIGZpcnN0IHRvIGF2b2lkIGVycm9ycyB3aXRoIHNvbWUgaG9zdCBvYmplY3RzIGluIElFKQogICAgcmV0dXJuIGlzTnVtYmVyKHZhbHVlKSAmJiB2YWx1ZSAhPSArdmFsdWUKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGBudWxsYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdWxsKG51bGwpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOdWxsKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgbnVtYmVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIG51bWJlciwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzTnVtYmVyKDguNCAqIDUpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGB2YWx1ZWAgaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIGZ1bmN0aW9uIFN0b29nZShuYW1lLCBhZ2UpIHsKICAgKiAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICogICB0aGlzLmFnZSA9IGFnZTsKICAgKiB9CiAgICoKICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFN0b29nZSgnbW9lJywgNDApKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNQbGFpbk9iamVjdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzUGxhaW5PYmplY3QgPSAhZ2V0UHJvdG90eXBlT2YgPyBzaGltSXNQbGFpbk9iamVjdCA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoISh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciB2YWx1ZU9mID0gdmFsdWUudmFsdWVPZiwKICAgICAgICBvYmpQcm90byA9IHR5cGVvZiB2YWx1ZU9mID09ICdmdW5jdGlvbicgJiYgKG9ialByb3RvID0gZ2V0UHJvdG90eXBlT2YodmFsdWVPZikpICYmIGdldFByb3RvdHlwZU9mKG9ialByb3RvKTsKCiAgICByZXR1cm4gb2JqUHJvdG8KICAgICAgPyB2YWx1ZSA9PSBvYmpQcm90byB8fCAoZ2V0UHJvdG90eXBlT2YodmFsdWUpID09IG9ialByb3RvICYmICFpc0FyZ3VtZW50cyh2YWx1ZSkpCiAgICAgIDogc2hpbUlzUGxhaW5PYmplY3QodmFsdWUpOwogIH07CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzUmVnRXhwKC9tb2UvKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFJlZ0V4cCB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIHN0cmluZywgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzU3RyaW5nKCdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gc3RyaW5nQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYHVuZGVmaW5lZGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc1VuZGVmaW5lZCh2b2lkIDApOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzsKICB9CgogIC8qKgogICAqIFJlY3Vyc2l2ZWx5IG1lcmdlcyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHRoZSBzb3VyY2Ugb2JqZWN0KHMpLCB0aGF0CiAgICogZG9uJ3QgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYCwgaW50byB0aGUgYGRlc3RpbmF0aW9uYCBvYmplY3QuIFN1YnNlcXVlbnQgc291cmNlcwogICAqIHdpbGwgb3ZlcndyaXRlIHByb3BlcnkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMgc291cmNlcy4gSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uCiAgICogaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIG1lcmdlZCB2YWx1ZXMgb2YgdGhlIGRlc3RpbmF0aW9uCiAgICogYW5kIHNvdXJjZSBvYmplY3QgcHJvcGVydGllcy4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkCiAgICogd2l0aCB0d28gYXJndW1lbnRzOyAob2JqZWN0VmFsdWUsIHNvdXJjZVZhbHVlKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBbc291cmNlMSwgc291cmNlMiwgLi4uXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIGZvciBlYWNoIHByb3BlcnR5IHRvIG1lcmdlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtpbmRpY2F0b3JdIEludGVybmFsbHkgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBgc3RhY2tgCiAgICogIGFyZ3VtZW50IGlzIGFuIGFycmF5IG9mIHRyYXZlcnNlZCBvYmplY3RzIGluc3RlYWQgb2YgYW5vdGhlciBzb3VyY2Ugb2JqZWN0LgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gdHJhY2sgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge0FycmF5fSBbc3RhY2tCPVtdXSBJbnRlcm5hbGx5IHVzZWQgdG8gYXNzb2NpYXRlIHZhbHVlcyB3aXRoIHRoZWlyCiAgICogIHNvdXJjZSBjb3VudGVycGFydHMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbmFtZXMgPSB7CiAgICogICAnc3Rvb2dlcyc6IFsKICAgKiAgICAgeyAnbmFtZSc6ICdtb2UnIH0sCiAgICogICAgIHsgJ25hbWUnOiAnbGFycnknIH0KICAgKiAgIF0KICAgKiB9OwogICAqCiAgICogdmFyIGFnZXMgPSB7CiAgICogICAnc3Rvb2dlcyc6IFsKICAgKiAgICAgeyAnYWdlJzogNDAgfSwKICAgKiAgICAgeyAnYWdlJzogNTAgfQogICAqICAgXQogICAqIH07CiAgICoKICAgKiBfLm1lcmdlKG5hbWVzLCBhZ2VzKTsKICAgKiAvLyA9PiB7ICdzdG9vZ2VzJzogW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0gfQogICAqLwogIGZ1bmN0aW9uIG1lcmdlKG9iamVjdCwgc291cmNlLCBpbmRpY2F0b3IpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgIGluZGV4ID0gMCwKICAgICAgICBsZW5ndGggPSAyOwoKICAgIGlmICghb2JqZWN0KSB7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CiAgICBpZiAoaW5kaWNhdG9yID09PSBpbmRpY2F0b3JPYmplY3QpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gYXJnc1szXSwKICAgICAgICAgIHN0YWNrQSA9IGFyZ3NbNF0sCiAgICAgICAgICBzdGFja0IgPSBhcmdzWzVdOwogICAgfQogICAgZWxzZSB7CiAgICAgIHN0YWNrQSA9IFtdOwogICAgICBzdGFja0IgPSBbXTsKICAgICAgaWYgKHR5cGVvZiBpbmRpY2F0b3IgIT0gJ251bWJlcicpIHsKICAgICAgICBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IHR5cGVvZiAoY2FsbGJhY2sgPSBhcmdzW2xlbmd0aCAtIDJdKSA9PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBhcmdzWy0tbGVuZ3RoXSkKICAgICAgICAgIDogKHR5cGVvZiAoY2FsbGJhY2sgPSBhcmdzW2xlbmd0aCAtIDFdKSA9PSAnZnVuY3Rpb24nICYmIGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShhcmdzW2luZGV4XSk7CiAgICAgIChpc0FyciA/IGZvckVhY2ggOiBmb3JPd24pKGFyZ3NbaW5kZXhdLCBmdW5jdGlvbihzb3VyY2UsIGtleSkgewogICAgICAgIHZhciBmb3VuZCwKICAgICAgICAgICAgaXNPYmosCiAgICAgICAgICAgIHZhbHVlID0gb2JqZWN0W2tleV07CgogICAgICAgIGlmIChzb3VyY2UgJiYgKChpc09iaiA9IGlzUGxhaW5PYmplY3Qoc291cmNlKSkgfHwgaXNBcnJheShzb3VyY2UpKSkgewogICAgICAgICAgLy8gYXZvaWQgbWVyZ2luZyBwcmV2aW91c2x5IG1lcmdlZCBjeWNsaWMgc291cmNlcwogICAgICAgICAgdmFyIHN0YWNrTGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdGFja0xlbmd0aC0tKSB7CiAgICAgICAgICAgIGlmICgoZm91bmQgPSBzdGFja0Fbc3RhY2tMZW5ndGhdID09IHNvdXJjZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IHN0YWNrQltzdGFja0xlbmd0aF07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgdmFsdWUgPSBpc09iagogICAgICAgICAgICAgID8gKGlzUGxhaW5PYmplY3QodmFsdWUpID8gdmFsdWUgOiB7fSkKICAgICAgICAgICAgICA6IChpc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW10pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhZGQgYHNvdXJjZWAgYW5kIGFzc29jaWF0ZWQgYHZhbHVlYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgICAgICAgICAgc3RhY2tBLnB1c2goc291cmNlKTsKICAgICAgICAgICAgc3RhY2tCLnB1c2godmFsdWUpOwoKICAgICAgICAgICAgLy8gcmVjdXJzaXZlbHkgbWVyZ2Ugb2JqZWN0cyBhbmQgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSAmJiBtZXJnZSh2YWx1ZSwgc291cmNlLCBpbmRpY2F0b3JPYmplY3QsIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpc0FyciB8fCB0eXBlb2Ygc291cmNlICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICB2YWx1ZSA9IHNvdXJjZTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgZXhjbHVkaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KICAgKiBQcm9wZXJ0eSBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZgogICAqIHByb3BlcnR5IG5hbWVzLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCBwcm9wZXJ0eQogICAqIGluIHRoZSBgb2JqZWN0YCwgb21pdHRpbmcgdGhlIHByb3BlcnRpZXMgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZQogICAqIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8W3Byb3AxLCBwcm9wMiwgLi4uXSBUaGUgcHJvcGVydGllcyB0byBvbWl0CiAgICogIG9yIHRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3Qgd2l0aG91dCB0aGUgb21pdHRlZCBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm9taXQoeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAsICd1c2VyaWQnOiAnbW9lMScgfSwgJ3VzZXJpZCcpOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgKgogICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdfaGludCc6ICdrbnVja2xlaGVhZCcsICdfc2VlZCc6ICc5NmM0ZWInIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApID09ICdfJzsKICAgKiB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAqLwogIGZ1bmN0aW9uIG9taXQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGlzRnVuYyA9IHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIGlmIChpc0Z1bmMpIHsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgcHJvcHMgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICBpZiAoaXNGdW5jCiAgICAgICAgICAgID8gIWNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkKICAgICAgICAgICAgOiBpbmRleE9mKHByb3BzLCBrZXksIDEpIDwgMAogICAgICAgICAgKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHR3byBkaW1lbnNpb25hbCBhcnJheSBvZiB0aGUgZ2l2ZW4gb2JqZWN0J3Mga2V5LXZhbHVlIHBhaXJzLAogICAqIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIG5ldyBhcnJheSBvZiBrZXktdmFsdWUgcGFpcnMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucGFpcnMoeyAnbW9lJzogMzAsICdsYXJyeSc6IDQwLCAnY3VybHknOiA1MCB9KTsKICAgKiAvLyA9PiBbWydtb2UnLCAzMF0sIFsnbGFycnknLCA0MF0sIFsnY3VybHknLCA1MF1dIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBwYWlycyhvYmplY3QpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgIHJlc3VsdFtpbmRleF0gPSBba2V5LCBvYmplY3Rba2V5XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgY29tcG9zZWQgb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mIHByb3BlcnR5CiAgICogbmFtZXMuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHByb3BlcnR5IGluIHRoZQogICAqIGBvYmplY3RgLCBwaWNraW5nIHRoZSBwcm9wZXJ0aWVzIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHNvdXJjZSBvYmplY3QuCiAgICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfFtwcm9wMSwgcHJvcDIsIC4uLl0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAqICBwZXIgaXRlcmF0aW9uIG9yIHByb3BlcnRpZXMgdG8gcGljaywgZWl0aGVyIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFycmF5cy4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIHBpY2tlZCBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnBpY2soeyAnbmFtZSc6ICdtb2UnLCAnX3VzZXJpZCc6ICdtb2UxJyB9LCAnbmFtZScpOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJyB9CiAgICoKICAgKiBfLnBpY2soeyAnbmFtZSc6ICdtb2UnLCAnX3VzZXJpZCc6ICdtb2UxJyB9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICogICByZXR1cm4ga2V5LmNoYXJBdCgwKSAhPSAnXyc7CiAgICogfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnIH0KICAgKi8KICBmdW5jdGlvbiBwaWNrKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgcHJvcHMgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gb2JqZWN0W2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IHZhbHVlcyBvZiBgb2JqZWN0YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy52YWx1ZXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IG9iamVjdFtwcm9wc1tpbmRleF1dOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzIGZyb20gdGhlIHNwZWNpZmllZCBpbmRleChlcyksIG9yIGtleXMsIG9mIHRoZQogICAqIGBjb2xsZWN0aW9uYC4gSW5kZXhlcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cwogICAqIG9mIGluZGV4ZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7QXJyYXl8TnVtYmVyfFN0cmluZ30gW2luZGV4MSwgaW5kZXgyLCAuLi5dIFRoZSBpbmRleChlcykgb2YKICAgKiAgYGNvbGxlY3Rpb25gIHRvIHJldHJpZXZlLCBlaXRoZXIgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXJyYXlzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyBjb3JyZXNwb25kaW5nIHRvIHRoZQogICAqICBwcm92aWRlZCBpbmRleGVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmF0KFsnYScsICdiJywgJ2MnLCAnZCcsICdlJ10sIFswLCAyLCA0XSk7CiAgICogLy8gPT4gWydhJywgJ2MnLCAnZSddCiAgICoKICAgKiBfLmF0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIDAsIDIpOwogICAqIC8vID0+IFsnbW9lJywgJ2N1cmx5J10KICAgKi8KICBmdW5jdGlvbiBhdChjb2xsZWN0aW9uKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgc2xpY2UoYXJndW1lbnRzLCAxKSksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgaWYgKG5vQ2hhckJ5SW5kZXggJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpIHsKICAgICAgY29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uc3BsaXQoJycpOwogICAgfQogICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gY29sbGVjdGlvbltwcm9wc1tpbmRleF1dOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGB0YXJnZXRgIGVsZW1lbnQgaXMgcHJlc2VudCBpbiBhIGBjb2xsZWN0aW9uYCB1c2luZyBzdHJpY3QKICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaW5jbHVkZQogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gdGFyZ2V0IFRoZSB2YWx1ZSB0byBjaGVjayBmb3IuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHRhcmdldGAgZWxlbWVudCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5jb250YWlucyhbMSwgMiwgM10sIDEsIDIpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmNvbnRhaW5zKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sICdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKCdjdXJseScsICd1cicpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBmYWxzZTsKCiAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgcmVzdWx0ID0gKGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjb2xsZWN0aW9uLmluZGV4T2YodGFyZ2V0LCBmcm9tSW5kZXgpCiAgICAgICAgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KQogICAgICApID4gLTE7CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCsraW5kZXggPj0gZnJvbUluZGV4KSB7CiAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgcmV0dXJuZWQgZnJvbSBydW5uaW5nIGVhY2ggZWxlbWVudCBvZgogICAqIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb2YgZWFjaCBrZXkgaXMKICAgKiB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBrZXkgd2FzIHJldHVybmVkIGJ5IGBjYWxsYmFja2AuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICogVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBjb3VudCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBjb3VudCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jb3VudEJ5KFs0LjMsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IHsgJzQnOiAxLCAnNic6IDIgfQogICAqCiAgICogXy5jb3VudEJ5KFs0LjMsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IHsgJzQnOiAxLCAnNic6IDIgfQogICAqCiAgICogXy5jb3VudEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4geyAnMyc6IDIsICc1JzogMSB9CiAgICovCiAgZnVuY3Rpb24gY291bnRCeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgIGtleSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pICsgJyc7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgYSB0cnV0aHkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbGwKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYWxsIGVsZW1lbnRzIHBhc3MgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAqICBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXZlcnkoW3RydWUsIDEsIG51bGwsICd5ZXMnXSwgQm9vbGVhbik7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBldmVyeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZXN1bHQgPSAhIWNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAhIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyBhbiBhcnJheSBvZiBhbGwgZWxlbWVudHMKICAgKiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgc2VsZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgcGFzc2VkIHRoZSBjYWxsYmFjayBjaGVjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGV2ZW5zID0gXy5maWx0ZXIoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gWzIsIDQsIDZdCiAgICovCiAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogRXhhbWluZXMgZWFjaCBlbGVtZW50IGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgdGhlIGZpcnN0IG9uZSB0aGUgYGNhbGxiYWNrYAogICAqIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBhbiBhY2NlcHRhYmxlCiAgICogZWxlbWVudCwgYW5kIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBkZXRlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGVsZW1lbnQgdGhhdCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAqICBlbHNlIGB1bmRlZmluZWRgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZXZlbiA9IF8uZmluZChbMSwgMiwgMywgNCwgNSwgNl0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KTsKICAgKiAvLyA9PiAyCiAgICovCiAgZnVuY3Rpb24gZmluZChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdDsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGEgYGNvbGxlY3Rpb25gLCBleGVjdXRpbmcgdGhlIGBjYWxsYmFja2AgZm9yIGVhY2ggZWxlbWVudCBpbgogICAqIHRoZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuIENhbGxiYWNrcyBtYXkgZXhpdCBpdGVyYXRpb24gZWFybHkKICAgKiBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGVhY2gKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fFN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS5mb3JFYWNoKGFsZXJ0KS5qb2luKCcsJyk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIGFuZCByZXR1cm5zICcxLDIsMycKICAgKgogICAqIF8uZm9yRWFjaCh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9LCBhbGVydCk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIHZhbHVlIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9CiAgICByZXR1cm4gY29sbGVjdGlvbjsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgcmV0dXJuZWQgZnJvbSBydW5uaW5nIGVhY2ggZWxlbWVudCBvZgogICAqIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb2YgZWFjaCBrZXkgaXMgYW4KICAgKiBhcnJheSBvZiBlbGVtZW50cyBwYXNzZWQgdG8gYGNhbGxiYWNrYCB0aGF0IHJldHVybmVkIHRoZSBrZXkuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICogVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBncm91cCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBncm91cCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgKgogICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgKiAvLyA9PiB7ICc0JzogWzQuMl0sICc2JzogWzYuMSwgNi40XSB9CiAgICoKICAgKiBfLmdyb3VwQnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiB7ICczJzogWydvbmUnLCAndHdvJ10sICc1JzogWyd0aHJlZSddIH0KICAgKi8KICBmdW5jdGlvbiBncm91cEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAga2V5ID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbikgKyAnJzsKICAgICAgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiByZXN1bHRba2V5XSA9IFtdKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEludm9rZXMgdGhlIG1ldGhvZCBuYW1lZCBieSBgbWV0aG9kTmFtZWAgb24gZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAsCiAgICogcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICogd2lsbCBiZSBwYXNzZWQgdG8gZWFjaCBpbnZva2VkIG1ldGhvZC4gSWYgYG1ldGhvZE5hbWVgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwKICAgKiBiZSBpbnZva2VkIGZvciwgYW5kIGB0aGlzYCBib3VuZCB0bywgZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gaW52b2tlIG9yCiAgICogIHRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgbWV0aG9kIHdpdGguCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW52b2tlKFtbNSwgMSwgN10sIFszLCAyLCAxXV0sICdzb3J0Jyk7CiAgICogLy8gPT4gW1sxLCA1LCA3XSwgWzEsIDIsIDNdXQogICAqCiAgICogXy5pbnZva2UoWzEyMywgNDU2XSwgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCwgJycpOwogICAqIC8vID0+IFtbJzEnLCAnMicsICczJ10sIFsnNCcsICc1JywgJzYnXV0KICAgKi8KICBmdW5jdGlvbiBpbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpLAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgaXNGdW5jID0gdHlwZW9mIG1ldGhvZE5hbWUgPT0gJ2Z1bmN0aW9uJywKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogdmFsdWVbbWV0aG9kTmFtZV0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdmFsdWVzIGJ5IHJ1bm5pbmcgZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAKICAgKiB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgKiB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBjb2xsZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWFwKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgKiAvLyA9PiBbMywgNiwgOV0KICAgKgogICAqIF8ubWFwKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogMzsgfSk7CiAgICogLy8gPT4gWzMsIDYsIDldIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICBmdW5jdGlvbiBtYXAoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmVzdWx0WysraW5kZXhdID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgbWF4aW11bSB2YWx1ZSBvZiBhbiBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwKICAgKiBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHZhbHVlIGluIHRoZSBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZQogICAqIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUgaXMgcmFua2VkLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0bwogICAqIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLm1heChzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfTsKICAgKi8KICBmdW5jdGlvbiBtYXgoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICBpZiAoIWNhbGxiYWNrICYmIGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgaWYgKHZhbHVlID4gcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gIWNhbGxiYWNrICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjaGFyQXRDYWxsYmFjawogICAgICAgIDogY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgaWYgKGN1cnJlbnQgPiBjb21wdXRlZCkgewogICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIG1pbmltdW0gdmFsdWUgb2YgYW4gYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsCiAgICogaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgYGFycmF5YCB0byBnZW5lcmF0ZSB0aGUKICAgKiBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlIGlzIHJhbmtlZC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1pbihbMTAsIDUsIDEwMCwgMiwgMTAwMF0pOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBtaW4oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IEluZmluaXR5LAogICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAodmFsdWUgPCByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSAhY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICBpZiAoY3VycmVudCA8IGNvbXB1dGVkKSB7CiAgICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgcHJvcGVydHkgZnJvbSBhbGwgZWxlbWVudHMgaW4KICAgKiB0aGUgYGNvbGxlY3Rpb25gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIHBsdWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLnBsdWNrKHN0b29nZXMsICduYW1lJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnY3VybHknXQogICAqLwogIGZ1bmN0aW9uIHBsdWNrKGNvbGxlY3Rpb24sIHByb3BlcnR5KSB7CiAgICByZXR1cm4gbWFwKGNvbGxlY3Rpb24sIHByb3BlcnR5ICsgJycpOwogIH0KCiAgLyoqCiAgICogUmVkdWNlcyBhIGBjb2xsZWN0aW9uYCB0byBhIHNpbmdsZSB2YWx1ZS4gVGhlIGluaXRpYWwgc3RhdGUgb2YgdGhlIHJlZHVjdGlvbgogICAqIGlzIGBhY2N1bXVsYXRvcmAgYW5kIGVhY2ggc3VjY2Vzc2l2ZSBzdGVwIG9mIGl0IHNob3VsZCBiZSByZXR1cm5lZCBieSB0aGUKICAgKiBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBmb3VyCiAgICogYXJndW1lbnRzOyBmb3IgYXJyYXlzIHRoZXkgYXJlIChhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FjY3VtdWxhdG9yXSBJbml0aWFsIHZhbHVlIG9mIHRoZSBhY2N1bXVsYXRvci4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24obWVtbywgbnVtKSB7IHJldHVybiBtZW1vICsgbnVtOyB9KTsKICAgKiAvLyA9PiA2CiAgICovCiAgZnVuY3Rpb24gcmVkdWNlKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCBhY2N1bXVsYXRvciwgdGhpc0FyZykgewogICAgdmFyIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIGluZGljYXRvck9iamVjdCk7CgogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIGlmIChub2FjY3VtKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICB9CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IG5vYWNjdW0KICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICA6IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogIH0KCiAgLyoqCiAgICogVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byBgXy5yZWR1Y2VgLCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGEKICAgKiBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGZvbGRyCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGlzdCA9IFtbMCwgMV0sIFsyLCAzXSwgWzQsIDVdXTsKICAgKiB2YXIgZmxhdCA9IF8ucmVkdWNlUmlnaHQobGlzdCwgZnVuY3Rpb24oYSwgYikgeyByZXR1cm4gYS5jb25jYXQoYik7IH0sIFtdKTsKICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgKi8KICBmdW5jdGlvbiByZWR1Y2VSaWdodChjb2xsZWN0aW9uLCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcpIHsKICAgIHZhciBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CgogICAgaWYgKHR5cGVvZiBsZW5ndGggIT0gJ251bWJlcicpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhjb2xsZWN0aW9uKTsKICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgfSBlbHNlIGlmIChub0NoYXJCeUluZGV4ICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pKSB7CiAgICAgIGl0ZXJhYmxlID0gY29sbGVjdGlvbi5zcGxpdCgnJyk7CiAgICB9CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCBpbmRpY2F0b3JPYmplY3QpOwogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgaW5kZXggPSBwcm9wcyA/IHByb3BzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBhY2N1bXVsYXRvciA9IG5vYWNjdW0KICAgICAgICA/IChub2FjY3VtID0gZmFsc2UsIGl0ZXJhYmxlW2luZGV4XSkKICAgICAgICA6IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgIH0pOwogICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogIH0KCiAgLyoqCiAgICogVGhlIG9wcG9zaXRlIG9mIGBfLmZpbHRlcmAsIHRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGVsZW1lbnRzIG9mIGEKICAgKiBgY29sbGVjdGlvbmAgdGhhdCBgY2FsbGJhY2tgIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1dGh5IGZvci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyB0aGF0IGRpZCAqKm5vdCoqIHBhc3MgdGhlCiAgICogIGNhbGxiYWNrIGNoZWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IFsxLCAzLCA1XQogICAqLwogIGZ1bmN0aW9uIHJlamVjdChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICByZXR1cm4gZmlsdGVyKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICByZXR1cm4gIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICB9KTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgYGFycmF5YCB2YWx1ZXMsIHVzaW5nIGEgdmVyc2lvbiBvZiB0aGUKICAgKiBGaXNoZXItWWF0ZXMgc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2h1ZmZsZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICogLy8gPT4gWzQsIDEsIDYsIDMsIDUsIDJdCiAgICovCiAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByYW5kID0gZmxvb3IobmF0aXZlUmFuZG9tKCkgKiAoKytpbmRleCArIDEpKTsKICAgICAgcmVzdWx0W2luZGV4XSA9IHJlc3VsdFtyYW5kXTsKICAgICAgcmVzdWx0W3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBzaXplIG9mIHRoZSBgY29sbGVjdGlvbmAgYnkgcmV0dXJuaW5nIGBjb2xsZWN0aW9uLmxlbmd0aGAgZm9yIGFycmF5cwogICAqIGFuZCBhcnJheS1saWtlIG9iamVjdHMgb3IgdGhlIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGZvciBvYmplY3RzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBgY29sbGVjdGlvbi5sZW5ndGhgIG9yIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNpemUoWzEsIDJdKTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiBfLnNpemUoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gMwogICAqCiAgICogXy5zaXplKCdjdXJseScpOwogICAqIC8vID0+IDUKICAgKi8KICBmdW5jdGlvbiBzaXplKGNvbGxlY3Rpb24pIHsKICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgcmV0dXJuIHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiBrZXlzKGNvbGxlY3Rpb24pLmxlbmd0aDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIGEgdHJ1dGh5IHZhbHVlIGZvciAqKmFueSoqIGVsZW1lbnQgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBwYXNzaW5nIHZhbHVlLCBhbmQKICAgKiBkb2VzIG5vdCBpdGVyYXRlIG92ZXIgdGhlIGVudGlyZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgYW55CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFueSBlbGVtZW50IHBhc3NlcyB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gc29tZShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdDsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmICgocmVzdWx0ID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gIShyZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5LCBzdGFibGUgc29ydGVkIGluIGFzY2VuZGluZyBvcmRlciBieSB0aGUgcmVzdWx0cyBvZgogICAqIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mIGBjb2xsZWN0aW9uYCB0aHJvdWdoIGEgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIHNvcnQgYnkgKGUuZy4gJ2xlbmd0aCcpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8cHJvcGVydHkgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uCiAgICogIG9yIHByb3BlcnR5IG5hbWUgdG8gc29ydCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHNvcnRlZCBlbGVtZW50cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguc2luKG51bSk7IH0pOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuc2luKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWydsYXJyeScsICdicmVuZGFuJywgJ21vZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnYnJlbmRhbiddCiAgICovCiAgZnVuY3Rpb24gc29ydEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICByZXN1bHRbKytpbmRleF0gPSB7CiAgICAgICAgJ2NyaXRlcmlhJzogY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbiksCiAgICAgICAgJ2luZGV4JzogaW5kZXgsCiAgICAgICAgJ3ZhbHVlJzogdmFsdWUKICAgICAgfTsKICAgIH0pOwoKICAgIGxlbmd0aCA9IHJlc3VsdC5sZW5ndGg7CiAgICByZXN1bHQuc29ydChjb21wYXJlQXNjZW5kaW5nKTsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICByZXN1bHRbbGVuZ3RoXSA9IHJlc3VsdFtsZW5ndGhdLnZhbHVlOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gY29udmVydC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgKiAvLyA9PiBbMiwgMywgNF0KICAgKi8KICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgIGlmIChjb2xsZWN0aW9uICYmIHR5cGVvZiBjb2xsZWN0aW9uLmxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICByZXR1cm4gbm9DaGFyQnlJbmRleCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKQogICAgICAgID8gY29sbGVjdGlvbi5zcGxpdCgnJykKICAgICAgICA6IHNsaWNlKGNvbGxlY3Rpb24pOwogICAgfQogICAgcmV0dXJuIHZhbHVlcyhjb2xsZWN0aW9uKTsKICB9CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggZWxlbWVudCBpbiBhIGBjb2xsZWN0aW9uYCwgcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFsbCBlbGVtZW50cwogICAqIHRoYXQgY29udGFpbiB0aGUgZ2l2ZW4gYHByb3BlcnRpZXNgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBmaWx0ZXIgYnkuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgY29udGFpbiB0aGUgZ2l2ZW4gYHByb3BlcnRpZXNgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogXy53aGVyZShzdG9vZ2VzLCB7ICdhZ2UnOiA0MCB9KTsKICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfV0KICAgKi8KICBmdW5jdGlvbiB3aGVyZShjb2xsZWN0aW9uLCBwcm9wZXJ0aWVzKSB7CiAgICByZXR1cm4gZmlsdGVyKGNvbGxlY3Rpb24sIHByb3BlcnRpZXMpOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgd2l0aCBhbGwgZmFsc2V5IHZhbHVlcyBvZiBgYXJyYXlgIHJlbW92ZWQuIFRoZSB2YWx1ZXMKICAgKiBgZmFsc2VgLCBgbnVsbGAsIGAwYCwgYCIiYCwgYHVuZGVmaW5lZGAgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmaWx0ZXJlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jb21wYWN0KFswLCAxLCBmYWxzZSwgMiwgJycsIDNdKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAodmFsdWUpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGBhcnJheWAgZWxlbWVudHMgbm90IHByZXNlbnQgaW4gdGhlIG90aGVyIGFycmF5cwogICAqIHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgYGFycmF5YCBlbGVtZW50cyBub3QgcHJlc2VudCBpbiB0aGUKICAgKiAgb3RoZXIgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmRpZmZlcmVuY2UoWzEsIDIsIDMsIDQsIDVdLCBbNSwgMiwgMTBdKTsKICAgKiAvLyA9PiBbMSwgMywgNF0KICAgKi8KICBmdW5jdGlvbiBkaWZmZXJlbmNlKGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgZmxhdHRlbmVkID0gY29uY2F0LmFwcGx5KGFycmF5UmVmLCBhcmd1bWVudHMpLAogICAgICAgIGNvbnRhaW5zID0gY2FjaGVkQ29udGFpbnMoZmxhdHRlbmVkLCBsZW5ndGgpLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKCFjb250YWlucyh2YWx1ZSkpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBmaXJzdCBlbGVtZW50IG9mIHRoZSBgYXJyYXlgLiBJZiBhIG51bWJlciBgbmAgaXMgcGFzc2VkLCB0aGUgZmlyc3QKICAgKiBgbmAgZWxlbWVudHMgb2YgdGhlIGBhcnJheWAgYXJlIHJldHVybmVkLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLAogICAqIHRoZSBmaXJzdCBlbGVtZW50cyB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IgYXJlIHJldHVybmVkLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGhlYWQsIHRha2UKICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7RnVuY3Rpb258TnVtYmVyfSBbY2FsbGJhY2t8bl0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiAxCiAgICoKICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzEsIDJdCiAgICoKICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtIDwgMzsKICAgKiB9KTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKi8KICBmdW5jdGlvbiBmaXJzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChhcnJheSkgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IGNhbGxiYWNrOwogICAgICAgIGlmIChuID09IG51bGwgfHwgdGhpc0FyZykgewogICAgICAgICAgcmV0dXJuIGFycmF5WzBdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIDAsIG5hdGl2ZU1pbihuYXRpdmVNYXgoMCwgbiksIGxlbmd0aCkpOwogICAgfQogIH0KCiAgLyoqCiAgICogRmxhdHRlbnMgYSBuZXN0ZWQgYXJyYXkgKHRoZSBuZXN0aW5nIGNhbiBiZSB0byBhbnkgZGVwdGgpLiBJZiBgc2hhbGxvd2AgaXMKICAgKiB0cnV0aHksIGBhcnJheWAgd2lsbCBvbmx5IGJlIGZsYXR0ZW5lZCBhIHNpbmdsZSBsZXZlbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IHNoYWxsb3cgQSBmbGFnIHRvIGluZGljYXRlIG9ubHkgZmxhdHRlbmluZyBhIHNpbmdsZSBsZXZlbC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0pOwogICAqIC8vID0+IFsxLCAyLCAzLCA0XTsKICAgKgogICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSwgdHJ1ZSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIFtbNF1dXTsKICAgKi8KICBmdW5jdGlvbiBmbGF0dGVuKGFycmF5LCBzaGFsbG93KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgLy8gcmVjdXJzaXZlbHkgZmxhdHRlbiBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdCwgc2hhbGxvdyA/IHZhbHVlIDogZmxhdHRlbih2YWx1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcKICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5CiAgICogc29ydGVkLCBwYXNzaW5nIGB0cnVlYCBmb3IgYGZyb21JbmRleGAgd2lsbCBydW4gYSBmYXN0ZXIgYmluYXJ5IHNlYXJjaC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7Qm9vbGVhbnxOdW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tIG9yIGB0cnVlYCB0bwogICAqICBwZXJmb3JtIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBgYXJyYXlgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDEKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIsIDMpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMSwgMiwgMiwgMywgM10sIDIsIHRydWUpOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT0gJ251bWJlcicpIHsKICAgICAgaW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4IHx8IDApIC0gMTsKICAgIH0gZWxzZSBpZiAoZnJvbUluZGV4KSB7CiAgICAgIGluZGV4ID0gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlKTsKICAgICAgcmV0dXJuIGFycmF5W2luZGV4XSA9PT0gdmFsdWUgPyBpbmRleCA6IC0xOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIEdldHMgYWxsIGJ1dCB0aGUgbGFzdCBlbGVtZW50IG9mIGBhcnJheWAuIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZQogICAqIGxhc3QgYG5gIGVsZW1lbnRzIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbgogICAqIGlzIHBhc3NlZCwgdGhlIGxhc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yIGFyZSBleGNsdWRlZAogICAqIGZyb20gdGhlIHJlc3VsdC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGVsZW1lbnQgb3IKICAgKiAgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKgogICAqIF8uaW5pdGlhbChbMSwgMiwgM10sIDIpOwogICAqIC8vID0+IFsxXQogICAqCiAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtID4gMTsKICAgKiB9KTsKICAgKiAvLyA9PiBbMV0KICAgKi8KICBmdW5jdGlvbiBpbml0aWFsKGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICB2YXIgbiA9IDAsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB3aGlsZSAoaW5kZXgtLSAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICBuKys7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBjYWxsYmFjayB8fCBuOwogICAgfQogICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pLCBsZW5ndGgpKTsKICB9CgogIC8qKgogICAqIENvbXB1dGVzIHRoZSBpbnRlcnNlY3Rpb24gb2YgYWxsIHRoZSBwYXNzZWQtaW4gYXJyYXlzIHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAqIGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHVuaXF1ZSBlbGVtZW50cyB0aGF0IGFyZSBwcmVzZW50CiAgICogIGluICoqYWxsKiogb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbnRlcnNlY3Rpb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICogLy8gPT4gWzEsIDJdCiAgICovCiAgZnVuY3Rpb24gaW50ZXJzZWN0aW9uKGFycmF5KSB7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgY2FjaGUgPSB7ICcwJzoge30gfSwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBpc0xhcmdlID0gbGVuZ3RoID49IDEwMCwKICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICBzZWVuID0gcmVzdWx0OwoKICAgIG91dGVyOgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSB2YWx1ZSArICcnOwogICAgICAgIHZhciBpbml0ZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlWzBdLCBrZXkpCiAgICAgICAgICA/ICEoc2VlbiA9IGNhY2hlWzBdW2tleV0pCiAgICAgICAgICA6IChzZWVuID0gY2FjaGVbMF1ba2V5XSA9IFtdKTsKICAgICAgfQogICAgICBpZiAoaW5pdGVkIHx8IGluZGV4T2Yoc2VlbiwgdmFsdWUpIDwgMCkgewogICAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgICB2YXIgYXJnc0luZGV4ID0gYXJnc0xlbmd0aDsKICAgICAgICB3aGlsZSAoLS1hcmdzSW5kZXgpIHsKICAgICAgICAgIGlmICghKGNhY2hlW2FyZ3NJbmRleF0gfHwgKGNhY2hlW2FyZ3NJbmRleF0gPSBjYWNoZWRDb250YWlucyhhcmdzW2FyZ3NJbmRleF0sIDAsIDEwMCkpKSh2YWx1ZSkpIHsKICAgICAgICAgICAgY29udGludWUgb3V0ZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGxhc3QgZWxlbWVudCBvZiB0aGUgYGFycmF5YC4gSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlIGxhc3QKICAgKiBgbmAgZWxlbWVudHMgb2YgdGhlIGBhcnJheWAgYXJlIHJldHVybmVkLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLAogICAqIHRoZSBsYXN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvciBhcmUgcmV0dXJuZWQuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7RnVuY3Rpb258TnVtYmVyfSBbY2FsbGJhY2t8bl0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBsYXN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gMwogICAqCiAgICogXy5sYXN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzIsIDNdCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPiAxOwogICAqIH0pOwogICAqIC8vID0+IFsyLCAzXQogICAqLwogIGZ1bmN0aW9uIGxhc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXlbbGVuZ3RoIC0gMV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgbmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pKTsKICAgIH0KICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBsYXN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCB1c2luZyBzdHJpY3QKICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD1hcnJheS5sZW5ndGgtMV0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiA0CiAgICoKICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gMQogICAqLwogIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGluZGV4ICsgZnJvbUluZGV4KSA6IG5hdGl2ZU1pbihmcm9tSW5kZXgsIGluZGV4IC0gMSkpICsgMTsKICAgIH0KICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBmcm9tIGFycmF5cyBvZiBga2V5c2AgYW5kIGB2YWx1ZXNgLiBQYXNzIGVpdGhlcgogICAqIGEgc2luZ2xlIHR3byBkaW1lbnNpb25hbCBhcnJheSwgaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLCBvcgogICAqIHR3byBhcnJheXMsIG9uZSBvZiBga2V5c2AgYW5kIG9uZSBvZiBjb3JyZXNwb25kaW5nIGB2YWx1ZXNgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGFycmF5IG9mIGtleXMuCiAgICogQHBhcmFtIHtBcnJheX0gW3ZhbHVlcz1bXV0gVGhlIGFycmF5IG9mIHZhbHVlcy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4ga2V5cyBhbmQKICAgKiAgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ub2JqZWN0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIFszMCwgNDAsIDUwXSk7CiAgICogLy8gPT4geyAnbW9lJzogMzAsICdsYXJyeSc6IDQwLCAnY3VybHknOiA1MCB9CiAgICovCiAgZnVuY3Rpb24gb2JqZWN0KGtleXMsIHZhbHVlcykgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0ga2V5cyA/IGtleXMubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIga2V5ID0ga2V5c1tpbmRleF07CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2tleVswXV0gPSBrZXlbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG51bWJlcnMgKHBvc2l0aXZlIGFuZC9vciBuZWdhdGl2ZSkgcHJvZ3Jlc3NpbmcgZnJvbQogICAqIGBzdGFydGAgdXAgdG8gYnV0IG5vdCBpbmNsdWRpbmcgYGVuZGAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtzdGVwPTFdIFRoZSB2YWx1ZSB0byBpbmNyZW1lbnQgb3IgZGVzY3JlbWVudCBieS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgcmFuZ2UgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucmFuZ2UoMTApOwogICAqIC8vID0+IFswLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5XQogICAqCiAgICogXy5yYW5nZSgxLCAxMSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwXQogICAqCiAgICogXy5yYW5nZSgwLCAzMCwgNSk7CiAgICogLy8gPT4gWzAsIDUsIDEwLCAxNSwgMjAsIDI1XQogICAqCiAgICogXy5yYW5nZSgwLCAtMTAsIC0xKTsKICAgKiAvLyA9PiBbMCwgLTEsIC0yLCAtMywgLTQsIC01LCAtNiwgLTcsIC04LCAtOV0KICAgKgogICAqIF8ucmFuZ2UoMCk7CiAgICogLy8gPT4gW10KICAgKi8KICBmdW5jdGlvbiByYW5nZShzdGFydCwgZW5kLCBzdGVwKSB7CiAgICBzdGFydCA9ICtzdGFydCB8fCAwOwogICAgc3RlcCA9ICtzdGVwIHx8IDE7CgogICAgaWYgKGVuZCA9PSBudWxsKSB7CiAgICAgIGVuZCA9IHN0YXJ0OwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICAvLyB1c2UgYEFycmF5KGxlbmd0aClgIHNvIFY4IHdpbGwgYXZvaWQgdGhlIHNsb3dlciAiZGljdGlvbmFyeSIgbW9kZQogICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBuYXRpdmVNYXgoMCwgY2VpbCgoZW5kIC0gc3RhcnQpIC8gc3RlcCkpLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5pbml0aWFsYCwgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCB2YWx1ZSBvZiBgYXJyYXlgLgogICAqIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZSBmaXJzdCBgbmAgdmFsdWVzIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuCiAgICogSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uIGlzIHBhc3NlZCwgdGhlIGZpcnN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMKICAgKiB0cnV0aHkgZm9yIGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAqIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZHJvcCwgdGFpbAogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGVsZW1lbnQgb3IKICAgKiAgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJlc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBbMiwgM10KICAgKgogICAqIF8ucmVzdChbMSwgMiwgM10sIDIpOwogICAqIC8vID0+IFszXQogICAqCiAgICogXy5yZXN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICogICByZXR1cm4gbnVtIDwgMzsKICAgKiB9KTsKICAgKiAvLyA9PiBbM10KICAgKi8KICBmdW5jdGlvbiByZXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGggJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgbisrOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBuID0gKGNhbGxiYWNrID09IG51bGwgfHwgdGhpc0FyZykgPyAxIDogbmF0aXZlTWF4KDAsIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBzbGljZShhcnJheSwgbik7CiAgfQoKICAvKioKICAgKiBVc2VzIGEgYmluYXJ5IHNlYXJjaCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIHRoZSBgdmFsdWVgCiAgICogc2hvdWxkIGJlIGluc2VydGVkIGludG8gYGFycmF5YCBpbiBvcmRlciB0byBtYWludGFpbiB0aGUgc29ydCBvcmRlciBvZiB0aGUKICAgKiBzb3J0ZWQgYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGB2YWx1ZWAgYW5kCiAgICogZWFjaCBlbGVtZW50IGluIGBhcnJheWAgdG8gY29tcHV0ZSB0aGVpciBzb3J0IHJhbmtpbmcuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLiBUaGUgYGNhbGxiYWNrYAogICAqIGFyZ3VtZW50IG1heSBhbHNvIGJlIHRoZSBuYW1lIG9mIGEgcHJvcGVydHkgdG8gb3JkZXIgYnkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eXxwcm9wZXJ0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAqICBwZXIgaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWUgdG8gb3JkZXIgYnkuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSB2YWx1ZSBzaG91bGQgYmUgaW5zZXJ0ZWQKICAgKiAgaW50byBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsyMCwgMzAsIDUwXSwgNDApOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc29ydGVkSW5kZXgoW3sgJ3gnOiAyMCB9LCB7ICd4JzogMzAgfSwgeyAneCc6IDUwIH1dLCB7ICd4JzogNDAgfSwgJ3gnKTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiB2YXIgZGljdCA9IHsKICAgKiAgICd3b3JkVG9OdW1iZXInOiB7ICd0d2VudHknOiAyMCwgJ3RoaXJ0eSc6IDMwLCAnZm91cnR5JzogNDAsICdmaWZ0eSc6IDUwIH0KICAgKiB9OwogICAqCiAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgKiAgIHJldHVybiBkaWN0LndvcmRUb051bWJlclt3b3JkXTsKICAgKiB9KTsKICAgKiAvLyA9PiAyCiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAqICAgcmV0dXJuIHRoaXMud29yZFRvTnVtYmVyW3dvcmRdOwogICAqIH0sIGRpY3QpOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgbG93ID0gMCwKICAgICAgICBoaWdoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiBsb3c7CgogICAgLy8gZXhwbGljaXRseSByZWZlcmVuY2UgYGlkZW50aXR5YCBmb3IgYmV0dGVyIGlubGluaW5nIGluIEZpcmVmb3gKICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPyBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZykgOiBpZGVudGl0eTsKICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUpOwoKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSAobG93ICsgaGlnaCkgPj4+IDE7CiAgICAgIGNhbGxiYWNrKGFycmF5W21pZF0pIDwgdmFsdWUKICAgICAgICA/IGxvdyA9IG1pZCArIDEKICAgICAgICA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH0KCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHVuaW9uIG9mIHRoZSBwYXNzZWQtaW4gYXJyYXlzIHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IKICAgKiBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCB0aGF0IGFyZQogICAqICBwcmVzZW50IGluIG9uZSBvciBtb3JlIG9mIHRoZSBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDEwMSwgMTBdCiAgICovCiAgZnVuY3Rpb24gdW5pb24oKSB7CiAgICByZXR1cm4gdW5pcShjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cykpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGBhcnJheWAgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5IHNvcnRlZCwgcGFzc2luZyBgdHJ1ZWAKICAgKiBmb3IgYGlzU29ydGVkYCB3aWxsIHJ1biBhIGZhc3RlciBhbGdvcml0aG0uIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBlYWNoCiAgICogZWxlbWVudCBvZiBgYXJyYXlgIGlzIHBhc3NlZCB0aHJvdWdoIGEgY2FsbGJhY2tgIGJlZm9yZSB1bmlxdWVuZXNzIGlzIGNvbXB1dGVkLgogICAqIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHVuaXF1ZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgdGhlIGBhcnJheWAgaXMgYWxyZWFkeSBzb3J0ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEsIDMsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMSwgMiwgMiwgM10sIHRydWUpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLjUsIDMsIDIuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMiwgMS41LCAzLCAyLjVdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gdW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gW10sCiAgICAgICAgc2VlbiA9IHJlc3VsdDsKCiAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICBjYWxsYmFjayA9IGlzU29ydGVkOwogICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgfQogICAgLy8gaW5pdCB2YWx1ZSBjYWNoZSBmb3IgbGFyZ2UgYXJyYXlzCiAgICB2YXIgaXNMYXJnZSA9ICFpc1NvcnRlZCAmJiBsZW5ndGggPj0gNzU7CiAgICBpZiAoaXNMYXJnZSkgewogICAgICB2YXIgY2FjaGUgPSB7fTsKICAgIH0KICAgIGlmIChjYWxsYmFjaykgewogICAgICBzZWVuID0gW107CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdLAogICAgICAgICAgY29tcHV0ZWQgPSBjYWxsYmFjayA/IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgYXJyYXkpIDogdmFsdWU7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSBjb21wdXRlZCArICcnOwogICAgICAgIHZhciBpbml0ZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/ICEoc2VlbiA9IGNhY2hlW2tleV0pCiAgICAgICAgICA6IChzZWVuID0gY2FjaGVba2V5XSA9IFtdKTsKICAgICAgfQogICAgICBpZiAoaXNTb3J0ZWQKICAgICAgICAgICAgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSBjb21wdXRlZAogICAgICAgICAgICA6IGluaXRlZCB8fCBpbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDAKICAgICAgICAgICkgewogICAgICAgIGlmIChjYWxsYmFjayB8fCBpc0xhcmdlKSB7CiAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGFuIGFycmF5IHdpdGggYWxsIG9jY3VycmVuY2VzIG9mIHRoZSBwYXNzZWQgdmFsdWVzIHJlbW92ZWQgdXNpbmcKICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gW3ZhbHVlMSwgdmFsdWUyLCAuLi5dIFZhbHVlcyB0byByZW1vdmUuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZpbHRlcmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLndpdGhvdXQoWzEsIDIsIDEsIDAsIDMsIDEsIDRdLCAwLCAxKTsKICAgKiAvLyA9PiBbMiwgMywgNF0KICAgKi8KICBmdW5jdGlvbiB3aXRob3V0KGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgY29udGFpbnMgPSBjYWNoZWRDb250YWlucyhhcmd1bWVudHMsIDEpLAogICAgICAgIHJlc3VsdCA9IFtdOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKCFjb250YWlucyh2YWx1ZSkpIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHcm91cHMgdGhlIGVsZW1lbnRzIG9mIGVhY2ggYXJyYXkgYXQgdGhlaXIgY29ycmVzcG9uZGluZyBpbmRleGVzLiBVc2VmdWwgZm9yCiAgICogc2VwYXJhdGUgZGF0YSBzb3VyY2VzIHRoYXQgYXJlIGNvb3JkaW5hdGVkIHRocm91Z2ggbWF0Y2hpbmcgYXJyYXkgaW5kZXhlcy4KICAgKiBGb3IgYSBtYXRyaXggb2YgbmVzdGVkIGFycmF5cywgYF8uemlwLmFwcGx5KC4uLilgIGNhbiB0cmFuc3Bvc2UgdGhlIG1hdHJpeAogICAqIGluIGEgc2ltaWxhciBmYXNoaW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy56aXAoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgWzMwLCA0MCwgNTBdLCBbdHJ1ZSwgZmFsc2UsIGZhbHNlXSk7CiAgICogLy8gPT4gW1snbW9lJywgMzAsIHRydWVdLCBbJ2xhcnJ5JywgNDAsIGZhbHNlXSwgWydjdXJseScsIDUwLCBmYWxzZV1dCiAgICovCiAgZnVuY3Rpb24gemlwKGFycmF5KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IG1heChwbHVjayhhcmd1bWVudHMsICdsZW5ndGgnKSkgOiAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHBsdWNrKGFyZ3VtZW50cywgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIGV4ZWN1dGluZyBgZnVuY2Agb25seSBhZnRlciBpdCBpcwogICAqIGNhbGxlZCBgbmAgdGltZXMuIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlCiAgICogY3JlYXRlZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge051bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBmdW5jdGlvbiBtdXN0IGJlIGNhbGxlZCBiZWZvcmUKICAgKiBpdCBpcyBleGVjdXRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgcmVuZGVyTm90ZXMgPSBfLmFmdGVyKG5vdGVzLmxlbmd0aCwgcmVuZGVyKTsKICAgKiBfLmZvckVhY2gobm90ZXMsIGZ1bmN0aW9uKG5vdGUpIHsKICAgKiAgIG5vdGUuYXN5bmNTYXZlKHsgJ3N1Y2Nlc3MnOiByZW5kZXJOb3RlcyB9KTsKICAgKiB9KTsKICAgKiAvLyBgcmVuZGVyTm90ZXNgIGlzIHJ1biBvbmNlLCBhZnRlciBhbGwgbm90ZXMgaGF2ZSBzYXZlZAogICAqLwogIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgIGlmIChuIDwgMSkgewogICAgICByZXR1cm4gZnVuYygpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS1uIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggdGhlIGB0aGlzYAogICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICogcGFzc2VkIHRvIHRoZSBib3VuZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgdGhpcy5uYW1lOwogICAqIH07CiAgICoKICAgKiBmdW5jID0gXy5iaW5kKGZ1bmMsIHsgJ25hbWUnOiAnbW9lJyB9LCAnaGknKTsKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpIG1vZScKICAgKi8KICBmdW5jdGlvbiBiaW5kKGZ1bmMsIHRoaXNBcmcpIHsKICAgIC8vIHVzZSBgRnVuY3Rpb24jYmluZGAgaWYgaXQgZXhpc3RzIGFuZCBpcyBmYXN0CiAgICAvLyAoaW4gVjggYEZ1bmN0aW9uI2JpbmRgIGlzIHNsb3dlciBleGNlcHQgd2hlbiBwYXJ0aWFsbHkgYXBwbGllZCkKICAgIHJldHVybiBpc0JpbmRGYXN0IHx8IChuYXRpdmVCaW5kICYmIGFyZ3VtZW50cy5sZW5ndGggPiAyKQogICAgICA/IG5hdGl2ZUJpbmQuY2FsbC5hcHBseShuYXRpdmVCaW5kLCBhcmd1bWVudHMpCiAgICAgIDogY3JlYXRlQm91bmQoZnVuYywgdGhpc0FyZywgc2xpY2UoYXJndW1lbnRzLCAyKSk7CiAgfQoKICAvKioKICAgKiBCaW5kcyBtZXRob2RzIG9uIGBvYmplY3RgIHRvIGBvYmplY3RgLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcgbWV0aG9kLgogICAqIE1ldGhvZCBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZiBtZXRob2QKICAgKiBuYW1lcy4gSWYgbm8gbWV0aG9kIG5hbWVzIGFyZSBwcm92aWRlZCwgYWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgCiAgICogd2lsbCBiZSBib3VuZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYmluZCBhbmQgYXNzaWduIHRoZSBib3VuZCBtZXRob2RzIHRvLgogICAqIEBwYXJhbSB7U3RyaW5nfSBbbWV0aG9kTmFtZTEsIG1ldGhvZE5hbWUyLCAuLi5dIE1ldGhvZCBuYW1lcyBvbiB0aGUgb2JqZWN0IHRvIGJpbmQuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGJ1dHRvblZpZXcgPSB7CiAgICogICdsYWJlbCc6ICdsb2Rhc2gnLAogICAqICAnb25DbGljayc6IGZ1bmN0aW9uKCkgeyBhbGVydCgnY2xpY2tlZDogJyArIHRoaXMubGFiZWwpOyB9CiAgICogfTsKICAgKgogICAqIF8uYmluZEFsbChidXR0b25WaWV3KTsKICAgKiBqUXVlcnkoJyNsb2Rhc2hfYnV0dG9uJykub24oJ2NsaWNrJywgYnV0dG9uVmlldy5vbkNsaWNrKTsKICAgKiAvLyA9PiBXaGVuIHRoZSBidXR0b24gaXMgY2xpY2tlZCwgYHRoaXMubGFiZWxgIHdpbGwgaGF2ZSB0aGUgY29ycmVjdCB2YWx1ZQogICAqLwogIGZ1bmN0aW9uIGJpbmRBbGwob2JqZWN0KSB7CiAgICB2YXIgZnVuY3MgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgaW5kZXggPSBmdW5jcy5sZW5ndGggPiAxID8gMCA6IChmdW5jcyA9IGZ1bmN0aW9ucyhvYmplY3QpLCAtMSksCiAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBmdW5jc1tpbmRleF07CiAgICAgIG9iamVjdFtrZXldID0gYmluZChvYmplY3Rba2V5XSwgb2JqZWN0KTsKICAgIH0KICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgdGhlIG1ldGhvZCBhdCBgb2JqZWN0W2tleV1gCiAgICogYW5kIHByZXBlbmRzIGFueSBhZGRpdGlvbmFsIGBiaW5kS2V5YCBhcmd1bWVudHMgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSBib3VuZAogICAqIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZCBkaWZmZXJzIGZyb20gYF8uYmluZGAgYnkgYWxsb3dpbmcgYm91bmQgZnVuY3Rpb25zIHRvCiAgICogcmVmZXJlbmNlIG1ldGhvZHMgdGhhdCB3aWxsIGJlIHJlZGVmaW5lZCBvciBkb24ndCB5ZXQgZXhpc3QuCiAgICogU2VlIGh0dHA6Ly9taWNoYXV4LmNhL2FydGljbGVzL2xhenktZnVuY3Rpb24tZGVmaW5pdGlvbi1wYXR0ZXJuLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGUgbWV0aG9kIGJlbG9uZ3MgdG8uCiAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBtZXRob2QuCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2JqZWN0ID0gewogICAqICAgJ25hbWUnOiAnbW9lJywKICAgKiAgICdncmVldCc6IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICAgIHJldHVybiBncmVldGluZyArICcgJyArIHRoaXMubmFtZTsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpIG1vZScKICAgKgogICAqIG9iamVjdC5ncmVldCA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnLCAnICsgdGhpcy5uYW1lICsgJyEnOwogICAqIH07CiAgICoKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpLCBtb2UhJwogICAqLwogIGZ1bmN0aW9uIGJpbmRLZXkob2JqZWN0LCBrZXkpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChvYmplY3QsIGtleSwgc2xpY2UoYXJndW1lbnRzLCAyKSk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHBhc3NlZCBmdW5jdGlvbnMsCiAgICogd2hlcmUgZWFjaCBmdW5jdGlvbiBjb25zdW1lcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAqIEVhY2ggZnVuY3Rpb24gaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNvbXBvc2VkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtmdW5jMSwgZnVuYzIsIC4uLl0gRnVuY3Rpb25zIHRvIGNvbXBvc2UuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgY29tcG9zZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBncmVldCA9IGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuICdoaTogJyArIG5hbWU7IH07CiAgICogdmFyIGV4Y2xhaW0gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsgcmV0dXJuIHN0YXRlbWVudCArICchJzsgfTsKICAgKiB2YXIgd2VsY29tZSA9IF8uY29tcG9zZShleGNsYWltLCBncmVldCk7CiAgICogd2VsY29tZSgnbW9lJyk7CiAgICogLy8gPT4gJ2hpOiBtb2UhJwogICAqLwogIGZ1bmN0aW9uIGNvbXBvc2UoKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgYXJncyA9IFtmdW5jc1tsZW5ndGhdLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgYGZ1bmNgIHVudGlsIGFmdGVyCiAgICogYHdhaXRgIG1pbGxpc2Vjb25kcyBoYXZlIGVsYXBzZWQgc2luY2UgdGhlIGxhc3QgdGltZSBpdCB3YXMgaW52b2tlZC4gUGFzcwogICAqIGB0cnVlYCBmb3IgYGltbWVkaWF0ZWAgdG8gY2F1c2UgZGVib3VuY2UgdG8gaW52b2tlIGBmdW5jYCBvbiB0aGUgbGVhZGluZywKICAgKiBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZywgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8KICAgKiB0aGUgZGVib3VuY2VkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVib3VuY2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkuCiAgICogQHBhcmFtIHtCb29sZWFufSBpbW1lZGlhdGUgQSBmbGFnIHRvIGluZGljYXRlIGV4ZWN1dGlvbiBpcyBvbiB0aGUgbGVhZGluZwogICAqICBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGRlYm91bmNlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGxhenlMYXlvdXQgPSBfLmRlYm91bmNlKGNhbGN1bGF0ZUxheW91dCwgMzAwKTsKICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgbGF6eUxheW91dCk7CiAgICovCiAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgYXJncywKICAgICAgICByZXN1bHQsCiAgICAgICAgdGhpc0FyZywKICAgICAgICB0aW1lb3V0SWQ7CgogICAgZnVuY3Rpb24gZGVsYXllZCgpIHsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgaWYgKCFpbW1lZGlhdGUpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpc0ltbWVkaWF0ZSA9IGltbWVkaWF0ZSAmJiAhdGltZW91dElkOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aGlzQXJnID0gdGhpczsKCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGRlbGF5ZWQsIHdhaXQpOwoKICAgICAgaWYgKGlzSW1tZWRpYXRlKSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZnVuY2AgZnVuY3Rpb24gYWZ0ZXIgYHdhaXRgIG1pbGxpc2Vjb25kcy4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgKiB3aWxsIGJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAqIEBwYXJhbSB7TnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIGRlbGF5IGV4ZWN1dGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGBzZXRUaW1lb3V0YCB0aW1lb3V0IGlkLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbG9nID0gXy5iaW5kKGNvbnNvbGUubG9nLCBjb25zb2xlKTsKICAgKiBfLmRlbGF5KGxvZywgMTAwMCwgJ2xvZ2dlZCBsYXRlcicpOwogICAqIC8vID0+ICdsb2dnZWQgbGF0ZXInIChBcHBlYXJzIGFmdGVyIG9uZSBzZWNvbmQuKQogICAqLwogIGZ1bmN0aW9uIGRlbGF5KGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIHdhaXQpOwogIH0KCiAgLyoqCiAgICogRGVmZXJzIGV4ZWN1dGluZyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIHVudGlsIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzIGNsZWFyZWQuCiAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBwYXNzZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWZlci4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGBzZXRUaW1lb3V0YCB0aW1lb3V0IGlkLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmRlZmVyKGZ1bmN0aW9uKCkgeyBhbGVydCgnZGVmZXJyZWQnKTsgfSk7CiAgICogLy8gcmV0dXJucyBmcm9tIHRoZSBmdW5jdGlvbiBiZWZvcmUgYGFsZXJ0YCBpcyBjYWxsZWQKICAgKi8KICBmdW5jdGlvbiBkZWZlcihmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnVuYy5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOyB9LCAxKTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICogcGFzc2VkLCBpdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBjYWNoZSBrZXkgZm9yIHN0b3JpbmcgdGhlIHJlc3VsdAogICAqIGJhc2VkIG9uIHRoZSBhcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4gQnkgZGVmYXVsdCwgdGhlIGZpcnN0CiAgICogYXJndW1lbnQgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBjYWNoZSBrZXkuIFRoZSBgZnVuY2AKICAgKiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtyZXNvbHZlcl0gQSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIGNhY2hlIGtleS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtZW1vaXppbmcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBmaWJvbmFjY2kgPSBfLm1lbW9pemUoZnVuY3Rpb24obikgewogICAqICAgcmV0dXJuIG4gPCAyID8gbiA6IGZpYm9uYWNjaShuIC0gMSkgKyBmaWJvbmFjY2kobiAtIDIpOwogICAqIH0pOwogICAqLwogIGZ1bmN0aW9uIG1lbW9pemUoZnVuYywgcmVzb2x2ZXIpIHsKICAgIHZhciBjYWNoZSA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gKHJlc29sdmVyID8gcmVzb2x2ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGFyZ3VtZW50c1swXSkgKyAnJzsKICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGtleSkKICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICA6IChjYWNoZVtrZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIGV4ZWN1dGUgYGZ1bmNgIG9uY2UuIFJlcGVhdCBjYWxscyB0bwogICAqIHRoZSBmdW5jdGlvbiB3aWxsIHJldHVybiB0aGUgdmFsdWUgb2YgdGhlIGZpcnN0IGNhbGwuIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQKICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICogaW5pdGlhbGl6ZSgpOwogICAqIGluaXRpYWxpemUoKTsKICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICovCiAgZnVuY3Rpb24gb25jZShmdW5jKSB7CiAgICB2YXIgcmFuLAogICAgICAgIHJlc3VsdDsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgKiBgcGFydGlhbGAgYXJndW1lbnRzIHByZXBlbmRlZCB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4gVGhpcwogICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgLCBleGNlcHQgaXQgZG9lcyAqKm5vdCoqIGFsdGVyIHRoZSBgdGhpc2AgYmluZGluZy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJzogJyArIG5hbWU7IH07CiAgICogdmFyIGhpID0gXy5wYXJ0aWFsKGdyZWV0LCAnaGknKTsKICAgKiBoaSgnbW9lJyk7CiAgICogLy8gPT4gJ2hpOiBtb2UnCiAgICovCiAgZnVuY3Rpb24gcGFydGlhbChmdW5jKSB7CiAgICByZXR1cm4gY3JlYXRlQm91bmQoZnVuYywgc2xpY2UoYXJndW1lbnRzLCAxKSk7CiAgfQoKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLnBhcnRpYWxgLCBleGNlcHQgdGhhdCBgcGFydGlhbGAgYXJndW1lbnRzIGFyZQogICAqIGFwcGVuZGVkIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1peGluKHsKICAgKiAgICdkZWZhdWx0c0RlZXAnOiBfLnBhcnRpYWxSaWdodChfLm1lcmdlLCBfLmRlZmF1bHRzKQogICAqIH0pOwogICAqCiAgICogdmFyIG9wdGlvbnMgPSB7CiAgICogICAndmFyaWFibGUnOiAnZGF0YScsCiAgICogICAnaW1wb3J0cyc6IHsgJ2pxJzogJCB9CiAgICogfTsKICAgKgogICAqIF8uZGVmYXVsdHNEZWVwKG9wdGlvbnMsIF8udGVtcGxhdGVTZXR0aW5ncyk7CiAgICoKICAgKiBvcHRpb25zLnZhcmlhYmxlCiAgICogLy8gPT4gJ2RhdGEnCiAgICoKICAgKiBvcHRpb25zLmltcG9ydHMKICAgKiAvLyA9PiB7ICdfJzogXywgJ2pxJzogJCB9CiAgICovCiAgZnVuY3Rpb24gcGFydGlhbFJpZ2h0KGZ1bmMpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChmdW5jLCBzbGljZShhcmd1bWVudHMsIDEpLCBudWxsLCBpbmRpY2F0b3JPYmplY3QpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gZXhlY3V0ZWQsIHdpbGwgb25seSBjYWxsIHRoZSBgZnVuY2AKICAgKiBmdW5jdGlvbiBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IGB3YWl0YCBtaWxsaXNlY29uZHMuIElmIHRoZSB0aHJvdHRsZWQKICAgKiBmdW5jdGlvbiBpcyBpbnZva2VkIG1vcmUgdGhhbiBvbmNlIGR1cmluZyB0aGUgYHdhaXRgIHRpbWVvdXQsIGBmdW5jYCB3aWxsCiAgICogYWxzbyBiZSBjYWxsZWQgb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlCiAgICogdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdGhyb3R0bGUgZXhlY3V0aW9ucyB0by4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB0aHJvdHRsZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciB0aHJvdHRsZWQgPSBfLnRocm90dGxlKHVwZGF0ZVBvc2l0aW9uLCAxMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdzY3JvbGwnLCB0aHJvdHRsZWQpOwogICAqLwogIGZ1bmN0aW9uIHRocm90dGxlKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZCwKICAgICAgICBsYXN0Q2FsbGVkID0gMDsKCiAgICBmdW5jdGlvbiB0cmFpbGluZ0NhbGwoKSB7CiAgICAgIGxhc3RDYWxsZWQgPSBuZXcgRGF0ZTsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlLAogICAgICAgICAgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBsYXN0Q2FsbGVkKTsKCiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRoaXNBcmcgPSB0aGlzOwoKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICBsYXN0Q2FsbGVkID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIXRpbWVvdXRJZCkgewogICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQodHJhaWxpbmdDYWxsLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcGFzc2VzIGB2YWx1ZWAgdG8gdGhlIGB3cmFwcGVyYCBmdW5jdGlvbiBhcyBpdHMKICAgKiBmaXJzdCBhcmd1bWVudC4gQWRkaXRpb25hbCBhcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiBhcmUgYXBwZW5kZWQKICAgKiB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIGB3cmFwcGVyYCBmdW5jdGlvbi4gVGhlIGB3cmFwcGVyYCBpcyBleGVjdXRlZCB3aXRoCiAgICogdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IHdyYXBwZXIgVGhlIHdyYXBwZXIgZnVuY3Rpb24uCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBoZWxsbyA9IGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuICdoZWxsbyAnICsgbmFtZTsgfTsKICAgKiBoZWxsbyA9IF8ud3JhcChoZWxsbywgZnVuY3Rpb24oZnVuYykgewogICAqICAgcmV0dXJuICdiZWZvcmUsICcgKyBmdW5jKCdtb2UnKSArICcsIGFmdGVyJzsKICAgKiB9KTsKICAgKiBoZWxsbygpOwogICAqIC8vID0+ICdiZWZvcmUsIGhlbGxvIG1vZSwgYWZ0ZXInCiAgICovCiAgZnVuY3Rpb24gd3JhcCh2YWx1ZSwgd3JhcHBlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IFt2YWx1ZV07CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBjaGFyYWN0ZXJzIGAmYCwgYDxgLCBgPmAsIGAiYCwgYW5kIGAnYCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAqIGNvcnJlc3BvbmRpbmcgSFRNTCBlbnRpdGllcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgc3RyaW5nLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmVzY2FwZSgnTW9lLCBMYXJyeSAmIEN1cmx5Jyk7CiAgICogLy8gPT4gJ01vZSwgTGFycnkgJmFtcDsgQ3VybHknCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiAoc3RyaW5nICsgJycpLnJlcGxhY2UocmVVbmVzY2FwZWRIdG1sLCBlc2NhcGVIdG1sQ2hhcik7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byBpdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBBbnkgdmFsdWUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScgfTsKICAgKiBtb2UgPT09IF8uaWRlbnRpdHkobW9lKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEFkZHMgZnVuY3Rpb25zIHByb3BlcnRpZXMgb2YgYG9iamVjdGAgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uIGFuZCBjaGFpbmFibGUKICAgKiB3cmFwcGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5taXhpbih7CiAgICogICAnY2FwaXRhbGl6ZSc6IGZ1bmN0aW9uKHN0cmluZykgewogICAqICAgICByZXR1cm4gc3RyaW5nLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICogICB9CiAgICogfSk7CiAgICoKICAgKiBfLmNhcGl0YWxpemUoJ2xhcnJ5Jyk7CiAgICogLy8gPT4gJ0xhcnJ5JwogICAqCiAgICogXygnY3VybHknKS5jYXBpdGFsaXplKCk7CiAgICogLy8gPT4gJ0N1cmx5JwogICAqLwogIGZ1bmN0aW9uIG1peGluKG9iamVjdCkgewogICAgZm9yRWFjaChmdW5jdGlvbnMob2JqZWN0KSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGxvZGFzaFttZXRob2ROYW1lXSA9IG9iamVjdFttZXRob2ROYW1lXTsKCiAgICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl9fd3JhcHBlZF9fXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIG5ldyBsb2Rhc2goZnVuYy5hcHBseShsb2Rhc2gsIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUmV2ZXJ0cyB0aGUgJ18nIHZhcmlhYmxlIHRvIGl0cyBwcmV2aW91cyB2YWx1ZSBhbmQgcmV0dXJucyBhIHJlZmVyZW5jZSB0bwogICAqIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbG9kYXNoID0gXy5ub0NvbmZsaWN0KCk7CiAgICovCiAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgIHdpbmRvdy5fID0gb2xkRGFzaDsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYSByYW5kb20gbnVtYmVyIGJldHdlZW4gYG1pbmAgYW5kIGBtYXhgIChpbmNsdXNpdmUpLiBJZiBvbmx5IG9uZQogICAqIGFyZ3VtZW50IGlzIHBhc3NlZCwgYSBudW1iZXIgYmV0d2VlbiBgMGAgYW5kIHRoZSBnaXZlbiBudW1iZXIgd2lsbCBiZSByZXR1cm5lZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge051bWJlcn0gW21pbj0wXSBUaGUgbWluaW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgKiBAcGFyYW0ge051bWJlcn0gW21heD0xXSBUaGUgbWF4aW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGEgcmFuZG9tIG51bWJlci4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5yYW5kb20oMCwgNSk7CiAgICogLy8gPT4gYSBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICoKICAgKiBfLnJhbmRvbSg1KTsKICAgKiAvLyA9PiBhbHNvIGEgbnVtYmVyIGJldHdlZW4gMCBhbmQgNQogICAqLwogIGZ1bmN0aW9uIHJhbmRvbShtaW4sIG1heCkgewogICAgaWYgKG1pbiA9PSBudWxsICYmIG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IDE7CiAgICB9CiAgICBtaW4gPSArbWluIHx8IDA7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIGZsb29yKG5hdGl2ZVJhbmRvbSgpICogKCgrbWF4IHx8IDApIC0gbWluICsgMSkpOwogIH0KCiAgLyoqCiAgICogUmVzb2x2ZXMgdGhlIHZhbHVlIG9mIGBwcm9wZXJ0eWAgb24gYG9iamVjdGAuIElmIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiwKICAgKiBpdCB3aWxsIGJlIGludm9rZWQgYW5kIGl0cyByZXN1bHQgcmV0dXJuZWQsIGVsc2UgdGhlIHByb3BlcnR5IHZhbHVlIGlzCiAgICogcmV0dXJuZWQuIElmIGBvYmplY3RgIGlzIGZhbHNleSwgdGhlbiBgbnVsbGAgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgdGhlIHZhbHVlIG9mLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgcmVzb2x2ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvYmplY3QgPSB7CiAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgKiAgICdzdHVmZic6IGZ1bmN0aW9uKCkgewogICAqICAgICByZXR1cm4gJ25vbnNlbnNlJzsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICogLy8gPT4gJ2NydW1wZXRzJwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgKiAvLyA9PiAnbm9uc2Vuc2UnCiAgICovCiAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKICAgIC8vIGJhc2VkIG9uIEJhY2tib25lJ3MgcHJpdmF0ZSBgZ2V0VmFsdWVgIGZ1bmN0aW9uCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZG9jdW1lbnRjbG91ZC9iYWNrYm9uZS9ibG9iLzAuOS4yL2JhY2tib25lLmpzI0wxNDE5LTE0MjQKICAgIHZhciB2YWx1ZSA9IG9iamVjdCA/IG9iamVjdFtwcm9wZXJ0eV0gOiBudWxsOwogICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7CiAgfQoKICAvKioKICAgKiBBIG1pY3JvLXRlbXBsYXRpbmcgbWV0aG9kIHRoYXQgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzCiAgICogd2hpdGVzcGFjZSwgYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgICoKICAgKiBOb3RlOiBJbiB0aGUgZGV2ZWxvcG1lbnQgYnVpbGQgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAqIGRlYnVnZ2luZy4gU2VlIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgKgogICAqIE5vdGU6IExvLURhc2ggbWF5IGJlIHVzZWQgaW4gQ2hyb21lIGV4dGVuc2lvbnMgYnkgZWl0aGVyIGNyZWF0aW5nIGEgYGxvZGFzaCBjc3BgCiAgICogYnVpbGQgYW5kIGF2b2lkaW5nIGBfLnRlbXBsYXRlYCB1c2UsIG9yIGxvYWRpbmcgTG8tRGFzaCBpbiBhIHNhbmRib3hlZCBwYWdlLgogICAqIFNlZSBodHRwOi8vZGV2ZWxvcGVyLmNocm9tZS5jb20vdHJ1bmsvZXh0ZW5zaW9ucy9zYW5kYm94aW5nRXZhbC5odG1sCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHRlbXBsYXRlIHRleHQuCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICogIGVzY2FwZSAtIFRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIgcmVnZXhwLgogICAqICBldmFsdWF0ZSAtIFRoZSAiZXZhbHVhdGUiIGRlbGltaXRlciByZWdleHAuCiAgICogIGludGVycG9sYXRlIC0gVGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyIHJlZ2V4cC4KICAgKiAgc291cmNlVVJMIC0gVGhlIHNvdXJjZVVSTCBvZiB0aGUgdGVtcGxhdGUncyBjb21waWxlZCBzb3VyY2UuCiAgICogIHZhcmlhYmxlIC0gVGhlIGRhdGEgb2JqZWN0IHZhcmlhYmxlIG5hbWUuCiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb258U3RyaW5nfSBSZXR1cm5zIGEgY29tcGlsZWQgZnVuY3Rpb24gd2hlbiBubyBgZGF0YWAgb2JqZWN0CiAgICogIGlzIGdpdmVuLCBlbHNlIGl0IHJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAvLyB1c2luZyBhIGNvbXBpbGVkIHRlbXBsYXRlCiAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nKTsKICAgKiBjb21waWxlZCh7ICduYW1lJzogJ21vZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIG1vZScKICAgKgogICAqIHZhciBsaXN0ID0gJzwlIF8uZm9yRWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCU9IG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICogXy50ZW1wbGF0ZShsaXN0LCB7ICdwZW9wbGUnOiBbJ21vZScsICdsYXJyeScsICdjdXJseSddIH0pOwogICAqIC8vID0+ICc8bGk+bW9lPC9saT48bGk+bGFycnk8L2xpPjxsaT5jdXJseTwvbGk+JwogICAqCiAgICogLy8gdXNpbmcgdGhlICJlc2NhcGUiIGRlbGltaXRlciB0byBlc2NhcGUgSFRNTCBpbiBkYXRhIHByb3BlcnR5IHZhbHVlcwogICAqIF8udGVtcGxhdGUoJzxiPjwlLSB2YWx1ZSAlPjwvYj4nLCB7ICd2YWx1ZSc6ICc8c2NyaXB0PicgfSk7CiAgICogLy8gPT4gJzxiPiZsdDtzY3JpcHQmZ3Q7PC9iPicKICAgKgogICAqIC8vIHVzaW5nIHRoZSBFUzYgZGVsaW1pdGVyIGFzIGFuIGFsdGVybmF0aXZlIHRvIHRoZSBkZWZhdWx0ICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyCiAgICogXy50ZW1wbGF0ZSgnaGVsbG8gJHsgbmFtZSB9JywgeyAnbmFtZSc6ICdjdXJseScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIGN1cmx5JwogICAqCiAgICogLy8gdXNpbmcgdGhlIGludGVybmFsIGBwcmludGAgZnVuY3Rpb24gaW4gImV2YWx1YXRlIiBkZWxpbWl0ZXJzCiAgICogXy50ZW1wbGF0ZSgnPCUgcHJpbnQoImhlbGxvICIgKyBlcGl0aGV0KTsgJT4hJywgeyAnZXBpdGhldCc6ICdzdG9vZ2UnIH0pOwogICAqIC8vID0+ICdoZWxsbyBzdG9vZ2UhJwogICAqCiAgICogLy8gdXNpbmcgY3VzdG9tIHRlbXBsYXRlIGRlbGltaXRlcnMKICAgKiBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICogICAnaW50ZXJwb2xhdGUnOiAve3soW1xzXFNdKz8pfX0vZwogICAqIH07CiAgICoKICAgKiBfLnRlbXBsYXRlKCdoZWxsbyB7eyBuYW1lIH19IScsIHsgJ25hbWUnOiAnbXVzdGFjaGUnIH0pOwogICAqIC8vID0+ICdoZWxsbyBtdXN0YWNoZSEnCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZVVSTGAgb3B0aW9uIHRvIHNwZWNpZnkgYSBjdXN0b20gc291cmNlVVJMIGZvciB0aGUgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gbmFtZSAlPicsIG51bGwsIHsgJ3NvdXJjZVVSTCc6ICcvYmFzaWMvZ3JlZXRpbmcuanN0JyB9KTsKICAgKiBjb21waWxlZChkYXRhKTsKICAgKiAvLyA9PiBmaW5kIHRoZSBzb3VyY2Ugb2YgImdyZWV0aW5nLmpzdCIgdW5kZXIgdGhlIFNvdXJjZXMgdGFiIG9yIFJlc291cmNlcyBwYW5lbCBvZiB0aGUgd2ViIGluc3BlY3RvcgogICAqCiAgICogLy8gdXNpbmcgdGhlIGB2YXJpYWJsZWAgb3B0aW9uIHRvIGVuc3VyZSBhIHdpdGgtc3RhdGVtZW50IGlzbid0IHVzZWQgaW4gdGhlIGNvbXBpbGVkIHRlbXBsYXRlCiAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IGRhdGEubmFtZSAlPiEnLCBudWxsLCB7ICd2YXJpYWJsZSc6ICdkYXRhJyB9KTsKICAgKiBjb21waWxlZC5zb3VyY2U7CiAgICogLy8gPT4gZnVuY3Rpb24oZGF0YSkgewogICAqICAgdmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlOwogICAqICAgX19wICs9ICdoZWxsbyAnICsgKChfX3QgPSAoIGRhdGEubmFtZSApKSA9PSBudWxsID8gJycgOiBfX3QpICsgJyEnOwogICAqICAgcmV0dXJuIF9fcDsKICAgKiB9CiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZWAgcHJvcGVydHkgdG8gaW5saW5lIGNvbXBpbGVkIHRlbXBsYXRlcyBmb3IgbWVhbmluZ2Z1bAogICAqIC8vIGxpbmUgbnVtYmVycyBpbiBlcnJvciBtZXNzYWdlcyBhbmQgYSBzdGFjayB0cmFjZQogICAqIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGN3ZCwgJ2pzdC5qcycpLCAnXAogICAqICAgdmFyIEpTVCA9IHtcCiAgICogICAgICJtYWluIjogJyArIF8udGVtcGxhdGUobWFpblRleHQpLnNvdXJjZSArICdcCiAgICogICB9O1wKICAgKiAnKTsKICAgKi8KICBmdW5jdGlvbiB0ZW1wbGF0ZSh0ZXh0LCBkYXRhLCBvcHRpb25zKSB7CiAgICAvLyBiYXNlZCBvbiBKb2huIFJlc2lnJ3MgYHRtcGxgIGltcGxlbWVudGF0aW9uCiAgICAvLyBodHRwOi8vZWpvaG4ub3JnL2Jsb2cvamF2YXNjcmlwdC1taWNyby10ZW1wbGF0aW5nLwogICAgLy8gYW5kIExhdXJhIERva3Rvcm92YSdzIGRvVC5qcwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL29sYWRvL2RvVAogICAgdmFyIHNldHRpbmdzID0gbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3M7CiAgICB0ZXh0IHx8ICh0ZXh0ID0gJycpOwoKICAgIC8vIGF2b2lkIG1pc3NpbmcgZGVwZW5kZW5jaWVzIHdoZW4gYGl0ZXJhdG9yVGVtcGxhdGVgIGlzIG5vdCBkZWZpbmVkCiAgICBvcHRpb25zID0gaXRlcmF0b3JUZW1wbGF0ZSA/IGRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXR0aW5ncykgOiBzZXR0aW5nczsKCiAgICB2YXIgaW1wb3J0cyA9IGl0ZXJhdG9yVGVtcGxhdGUgJiYgZGVmYXVsdHMoe30sIG9wdGlvbnMuaW1wb3J0cywgc2V0dGluZ3MuaW1wb3J0cyksCiAgICAgICAgaW1wb3J0c0tleXMgPSBpdGVyYXRvclRlbXBsYXRlID8ga2V5cyhpbXBvcnRzKSA6IFsnXyddLAogICAgICAgIGltcG9ydHNWYWx1ZXMgPSBpdGVyYXRvclRlbXBsYXRlID8gdmFsdWVzKGltcG9ydHMpIDogW2xvZGFzaF07CgogICAgdmFyIGlzRXZhbHVhdGluZywKICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgaW50ZXJwb2xhdGUgPSBvcHRpb25zLmludGVycG9sYXRlIHx8IHJlTm9NYXRjaCwKICAgICAgICBzb3VyY2UgPSAiX19wICs9ICciOwoKICAgIC8vIGNvbXBpbGUgcmVnZXhwIHRvIG1hdGNoIGVhY2ggZGVsaW1pdGVyCiAgICB2YXIgcmVEZWxpbWl0ZXJzID0gUmVnRXhwKAogICAgICAob3B0aW9ucy5lc2NhcGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICBpbnRlcnBvbGF0ZS5zb3VyY2UgKyAnfCcgKwogICAgICAoaW50ZXJwb2xhdGUgPT09IHJlSW50ZXJwb2xhdGUgPyByZUVzVGVtcGxhdGUgOiByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgIChvcHRpb25zLmV2YWx1YXRlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wkJwogICAgLCAnZycpOwoKICAgIHRleHQucmVwbGFjZShyZURlbGltaXRlcnMsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGVWYWx1ZSwgaW50ZXJwb2xhdGVWYWx1ZSwgZXNUZW1wbGF0ZVZhbHVlLCBldmFsdWF0ZVZhbHVlLCBvZmZzZXQpIHsKICAgICAgaW50ZXJwb2xhdGVWYWx1ZSB8fCAoaW50ZXJwb2xhdGVWYWx1ZSA9IGVzVGVtcGxhdGVWYWx1ZSk7CgogICAgICAvLyBlc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbm5vdCBiZSBpbmNsdWRlZCBpbiBzdHJpbmcgbGl0ZXJhbHMKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShyZVVuZXNjYXBlZFN0cmluZywgZXNjYXBlU3RyaW5nQ2hhcik7CgogICAgICAvLyByZXBsYWNlIGRlbGltaXRlcnMgd2l0aCBzbmlwcGV0cwogICAgICBpZiAoZXNjYXBlVmFsdWUpIHsKICAgICAgICBzb3VyY2UgKz0gIicgK1xuX19lKCIgKyBlc2NhcGVWYWx1ZSArICIpICtcbiciOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZVZhbHVlKSB7CiAgICAgICAgaXNFdmFsdWF0aW5nID0gdHJ1ZTsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGVWYWx1ZSArICI7XG5fX3AgKz0gJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlVmFsdWUpIHsKICAgICAgICBzb3VyY2UgKz0gIicgK1xuKChfX3QgPSAoIiArIGludGVycG9sYXRlVmFsdWUgKyAiKSkgPT0gbnVsbCA/ICcnIDogX190KSArXG4nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKCiAgICAgIC8vIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgcHJvZHVjdHMgcmVxdWlyZXMgcmV0dXJuaW5nIHRoZSBgbWF0Y2hgCiAgICAgIC8vIHN0cmluZyBpbiBvcmRlciB0byBwcm9kdWNlIHRoZSBjb3JyZWN0IGBvZmZzZXRgIHZhbHVlCiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwoKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gaWYgYHZhcmlhYmxlYCBpcyBub3Qgc3BlY2lmaWVkIGFuZCB0aGUgdGVtcGxhdGUgY29udGFpbnMgImV2YWx1YXRlIgogICAgLy8gZGVsaW1pdGVycywgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkIGNvZGUgdG8gYWRkIHRoZQogICAgLy8gZGF0YSBvYmplY3QgdG8gdGhlIHRvcCBvZiB0aGUgc2NvcGUgY2hhaW4KICAgIHZhciB2YXJpYWJsZSA9IG9wdGlvbnMudmFyaWFibGUsCiAgICAgICAgaGFzVmFyaWFibGUgPSB2YXJpYWJsZTsKCiAgICBpZiAoIWhhc1ZhcmlhYmxlKSB7CiAgICAgIHZhcmlhYmxlID0gJ29iaic7CiAgICAgIHNvdXJjZSA9ICd3aXRoICgnICsgdmFyaWFibGUgKyAnKSB7XG4nICsgc291cmNlICsgJ1xufVxuJzsKICAgIH0KICAgIC8vIGNsZWFudXAgY29kZSBieSBzdHJpcHBpbmcgZW1wdHkgc3RyaW5ncwogICAgc291cmNlID0gKGlzRXZhbHVhdGluZyA/IHNvdXJjZS5yZXBsYWNlKHJlRW1wdHlTdHJpbmdMZWFkaW5nLCAnJykgOiBzb3VyY2UpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdNaWRkbGUsICckMScpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdUcmFpbGluZywgJyQxOycpOwoKICAgIC8vIGZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkKICAgIHNvdXJjZSA9ICdmdW5jdGlvbignICsgdmFyaWFibGUgKyAnKSB7XG4nICsKICAgICAgKGhhc1ZhcmlhYmxlID8gJycgOiB2YXJpYWJsZSArICcgfHwgKCcgKyB2YXJpYWJsZSArICcgPSB7fSk7XG4nKSArCiAgICAgICJ2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGUiICsKICAgICAgKGlzRXZhbHVhdGluZwogICAgICAgID8gJywgX19qID0gQXJyYXkucHJvdG90eXBlLmpvaW47XG4nICsKICAgICAgICAgICJmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgJycpIH1cbiIKICAgICAgICA6IChoYXNWYXJpYWJsZSA/ICcnIDogJywgX19kID0gJyArIHZhcmlhYmxlICsgJy4nICsgdmFyaWFibGUgKyAnIHx8ICcgKyB2YXJpYWJsZSkgKyAnO1xuJwogICAgICApICsKICAgICAgc291cmNlICsKICAgICAgJ3JldHVybiBfX3Bcbn0nOwoKICAgIC8vIFVzZSBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZyBhbmQgd3JhcCBpbiBhIG11bHRpLWxpbmUgY29tbWVudCB0bwogICAgLy8gYXZvaWQgaXNzdWVzIHdpdGggTmFyd2hhbCwgSUUgY29uZGl0aW9uYWwgY29tcGlsYXRpb24sIGFuZCB0aGUgSlMgZW5naW5lCiAgICAvLyBlbWJlZGRlZCBpbiBBZG9iZSBwcm9kdWN0cy4KICAgIC8vIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgIHZhciBzb3VyY2VVUkwgPSAnXG4vKlxuLy9AIHNvdXJjZVVSTD0nICsgKG9wdGlvbnMuc291cmNlVVJMIHx8ICcvbG9kYXNoL3RlbXBsYXRlL3NvdXJjZVsnICsgKHRlbXBsYXRlQ291bnRlcisrKSArICddJykgKyAnXG4qLyc7CgogICAgdHJ5IHsKICAgICAgdmFyIHJlc3VsdCA9IEZ1bmN0aW9uKGltcG9ydHNLZXlzLCAncmV0dXJuICcgKyBzb3VyY2UgKyBzb3VyY2VVUkwpLmFwcGx5KHVuZGVmaW5lZCwgaW1wb3J0c1ZhbHVlcyk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CiAgICBpZiAoZGF0YSkgewogICAgICByZXR1cm4gcmVzdWx0KGRhdGEpOwogICAgfQogICAgLy8gcHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24ncyBzb3VyY2UgdmlhIGl0cyBgdG9TdHJpbmdgIG1ldGhvZCwgaW4KICAgIC8vIHN1cHBvcnRlZCBlbnZpcm9ubWVudHMsIG9yIHRoZSBgc291cmNlYCBwcm9wZXJ0eSBhcyBhIGNvbnZlbmllbmNlIGZvcgogICAgLy8gaW5saW5pbmcgY29tcGlsZWQgdGVtcGxhdGVzIGR1cmluZyB0aGUgYnVpbGQgcHJvY2VzcwogICAgcmVzdWx0LnNvdXJjZSA9IHNvdXJjZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGVjdXRlcyB0aGUgYGNhbGxiYWNrYCBmdW5jdGlvbiBgbmAgdGltZXMsIHJldHVybmluZyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cwogICAqIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAqIHdpdGggb25lIGFyZ3VtZW50OyAoaW5kZXgpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2suCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGRpY2VSb2xscyA9IF8udGltZXMoMywgXy5wYXJ0aWFsKF8ucmFuZG9tLCAxLCA2KSk7CiAgICogLy8gPT4gWzMsIDYsIDRdCiAgICoKICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgbWFnZS5jYXN0U3BlbGwobik7IH0pOwogICAqIC8vID0+IGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMsIHBhc3NpbmcgYG5gIG9mIGAwYCwgYDFgLCBhbmQgYDJgIHJlc3BlY3RpdmVseQogICAqCiAgICogXy50aW1lcygzLCBmdW5jdGlvbihuKSB7IHRoaXMuY2FzdChuKTsgfSwgbWFnZSk7CiAgICogLy8gPT4gYWxzbyBjYWxscyBgbWFnZS5jYXN0U3BlbGwobilgIHRocmVlIHRpbWVzCiAgICovCiAgZnVuY3Rpb24gdGltZXMobiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIG4gPSArbiB8fCAwOwogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobik7CgogICAgd2hpbGUgKCsraW5kZXggPCBuKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjay5jYWxsKHRoaXNBcmcsIGluZGV4KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZXNjYXBlYCwgdGhpcyBtZXRob2QgY29udmVydHMgdGhlIEhUTUwgZW50aXRpZXMKICAgKiBgJmFtcDtgLCBgJmx0O2AsIGAmZ3Q7YCwgYCZxdW90O2AsIGFuZCBgJiN4Mjc7YCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAqIGNvcnJlc3BvbmRpbmcgY2hhcmFjdGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gdW5lc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIHN0cmluZy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmVzY2FwZSgnTW9lLCBMYXJyeSAmYW1wOyBDdXJseScpOwogICAqIC8vID0+ICdNb2UsIExhcnJ5ICYgQ3VybHknCiAgICovCiAgZnVuY3Rpb24gdW5lc2NhcGUoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IChzdHJpbmcgKyAnJykucmVwbGFjZShyZUVzY2FwZWRIdG1sLCB1bmVzY2FwZUh0bWxDaGFyKTsKICB9CgogIC8qKgogICAqIEdlbmVyYXRlcyBhIHVuaXF1ZSBJRC4gSWYgYHByZWZpeGAgaXMgcGFzc2VkLCB0aGUgSUQgd2lsbCBiZSBhcHBlbmRlZCB0byBpdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0gVGhlIHZhbHVlIHRvIHByZWZpeCB0aGUgSUQgd2l0aC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmlxdWUgSUQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pcXVlSWQoJ2NvbnRhY3RfJyk7CiAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAqCiAgICogXy51bmlxdWVJZCgpOwogICAqIC8vID0+ICcxMDUnCiAgICovCiAgZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICAgIHJldHVybiAocHJlZml4ID09IG51bGwgPyAnJyA6IHByZWZpeCArICcnKSArIGlkOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIEludm9rZXMgYGludGVyY2VwdG9yYCB3aXRoIHRoZSBgdmFsdWVgIGFzIHRoZSBmaXJzdCBhcmd1bWVudCwgYW5kIHRoZW4KICAgKiByZXR1cm5zIGB2YWx1ZWAuIFRoZSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sCiAgICogaW4gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgaW50ZXJjZXB0b3JgLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGludGVyY2VwdG9yIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDMsIDRdKQogICAqICAuZmlsdGVyKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KQogICAqICAudGFwKGFsZXJ0KQogICAqICAubWFwKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogbnVtOyB9KQogICAqICAudmFsdWUoKTsKICAgKiAvLyA9PiAvLyBbMiwgNF0gKGFsZXJ0ZWQpCiAgICogLy8gPT4gWzQsIDE2XQogICAqLwogIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKHZhbHVlKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgKgogICAqIEBuYW1lIHRvU3RyaW5nCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVzdWx0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudG9TdHJpbmcoKTsKICAgKiAvLyA9PiAnMSwyLDMnCiAgICovCiAgZnVuY3Rpb24gd3JhcHBlclRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX193cmFwcGVkX18gKyAnJzsKICB9CgogIC8qKgogICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqCiAgICogQG5hbWUgdmFsdWVPZgogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHZhbHVlCiAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudmFsdWVPZigpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIHdyYXBwZXJWYWx1ZU9mKCkgewogICAgcmV0dXJuIHRoaXMuX193cmFwcGVkX187CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gYWRkIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB3cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgbG9kYXNoLmFzc2lnbiA9IGFzc2lnbjsKICBsb2Rhc2guYXQgPSBhdDsKICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgbG9kYXNoLmJpbmRBbGwgPSBiaW5kQWxsOwogIGxvZGFzaC5iaW5kS2V5ID0gYmluZEtleTsKICBsb2Rhc2guY29tcGFjdCA9IGNvbXBhY3Q7CiAgbG9kYXNoLmNvbXBvc2UgPSBjb21wb3NlOwogIGxvZGFzaC5jb3VudEJ5ID0gY291bnRCeTsKICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICBsb2Rhc2guZGVmYXVsdHMgPSBkZWZhdWx0czsKICBsb2Rhc2guZGVmZXIgPSBkZWZlcjsKICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICBsb2Rhc2guZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2U7CiAgbG9kYXNoLmZpbHRlciA9IGZpbHRlcjsKICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgbG9kYXNoLmZvckVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5mb3JJbiA9IGZvckluOwogIGxvZGFzaC5mb3JPd24gPSBmb3JPd247CiAgbG9kYXNoLmZ1bmN0aW9ucyA9IGZ1bmN0aW9uczsKICBsb2Rhc2guZ3JvdXBCeSA9IGdyb3VwQnk7CiAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogIGxvZGFzaC5pbnRlcnNlY3Rpb24gPSBpbnRlcnNlY3Rpb247CiAgbG9kYXNoLmludmVydCA9IGludmVydDsKICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogIGxvZGFzaC5rZXlzID0ga2V5czsKICBsb2Rhc2gubWFwID0gbWFwOwogIGxvZGFzaC5tYXggPSBtYXg7CiAgbG9kYXNoLm1lbW9pemUgPSBtZW1vaXplOwogIGxvZGFzaC5tZXJnZSA9IG1lcmdlOwogIGxvZGFzaC5taW4gPSBtaW47CiAgbG9kYXNoLm9iamVjdCA9IG9iamVjdDsKICBsb2Rhc2gub21pdCA9IG9taXQ7CiAgbG9kYXNoLm9uY2UgPSBvbmNlOwogIGxvZGFzaC5wYWlycyA9IHBhaXJzOwogIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICBsb2Rhc2gucGFydGlhbFJpZ2h0ID0gcGFydGlhbFJpZ2h0OwogIGxvZGFzaC5waWNrID0gcGljazsKICBsb2Rhc2gucGx1Y2sgPSBwbHVjazsKICBsb2Rhc2gucmFuZ2UgPSByYW5nZTsKICBsb2Rhc2gucmVqZWN0ID0gcmVqZWN0OwogIGxvZGFzaC5yZXN0ID0gcmVzdDsKICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgbG9kYXNoLnNvcnRCeSA9IHNvcnRCeTsKICBsb2Rhc2gudGFwID0gdGFwOwogIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogIGxvZGFzaC50aW1lcyA9IHRpbWVzOwogIGxvZGFzaC50b0FycmF5ID0gdG9BcnJheTsKICBsb2Rhc2gudW5pb24gPSB1bmlvbjsKICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgbG9kYXNoLnZhbHVlcyA9IHZhbHVlczsKICBsb2Rhc2gud2hlcmUgPSB3aGVyZTsKICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgbG9kYXNoLndyYXAgPSB3cmFwOwogIGxvZGFzaC56aXAgPSB6aXA7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLmNvbGxlY3QgPSBtYXA7CiAgbG9kYXNoLmRyb3AgPSByZXN0OwogIGxvZGFzaC5lYWNoID0gZm9yRWFjaDsKICBsb2Rhc2guZXh0ZW5kID0gYXNzaWduOwogIGxvZGFzaC5tZXRob2RzID0gZnVuY3Rpb25zOwogIGxvZGFzaC5zZWxlY3QgPSBmaWx0ZXI7CiAgbG9kYXNoLnRhaWwgPSByZXN0OwogIGxvZGFzaC51bmlxdWUgPSB1bmlxOwoKICAvLyBhZGQgZnVuY3Rpb25zIHRvIGBsb2Rhc2gucHJvdG90eXBlYAogIG1peGluKGxvZGFzaCk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogIGxvZGFzaC5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgbG9kYXNoLmNvbnRhaW5zID0gY29udGFpbnM7CiAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICBsb2Rhc2guZXZlcnkgPSBldmVyeTsKICBsb2Rhc2guZmluZCA9IGZpbmQ7CiAgbG9kYXNoLmhhcyA9IGhhczsKICBsb2Rhc2guaWRlbnRpdHkgPSBpZGVudGl0eTsKICBsb2Rhc2guaW5kZXhPZiA9IGluZGV4T2Y7CiAgbG9kYXNoLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgbG9kYXNoLmlzQXJyYXkgPSBpc0FycmF5OwogIGxvZGFzaC5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgbG9kYXNoLmlzRGF0ZSA9IGlzRGF0ZTsKICBsb2Rhc2guaXNFbGVtZW50ID0gaXNFbGVtZW50OwogIGxvZGFzaC5pc0VtcHR5ID0gaXNFbXB0eTsKICBsb2Rhc2guaXNFcXVhbCA9IGlzRXF1YWw7CiAgbG9kYXNoLmlzRmluaXRlID0gaXNGaW5pdGU7CiAgbG9kYXNoLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIGxvZGFzaC5pc05hTiA9IGlzTmFOOwogIGxvZGFzaC5pc051bGwgPSBpc051bGw7CiAgbG9kYXNoLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgbG9kYXNoLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgbG9kYXNoLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0OwogIGxvZGFzaC5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogIGxvZGFzaC5pc1N0cmluZyA9IGlzU3RyaW5nOwogIGxvZGFzaC5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIGxvZGFzaC5sYXN0SW5kZXhPZiA9IGxhc3RJbmRleE9mOwogIGxvZGFzaC5taXhpbiA9IG1peGluOwogIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICBsb2Rhc2gucmFuZG9tID0gcmFuZG9tOwogIGxvZGFzaC5yZWR1Y2UgPSByZWR1Y2U7CiAgbG9kYXNoLnJlZHVjZVJpZ2h0ID0gcmVkdWNlUmlnaHQ7CiAgbG9kYXNoLnJlc3VsdCA9IHJlc3VsdDsKICBsb2Rhc2guc2l6ZSA9IHNpemU7CiAgbG9kYXNoLnNvbWUgPSBzb21lOwogIGxvZGFzaC5zb3J0ZWRJbmRleCA9IHNvcnRlZEluZGV4OwogIGxvZGFzaC50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogIGxvZGFzaC51bmVzY2FwZSA9IHVuZXNjYXBlOwogIGxvZGFzaC51bmlxdWVJZCA9IHVuaXF1ZUlkOwoKICAvLyBhZGQgYWxpYXNlcwogIGxvZGFzaC5hbGwgPSBldmVyeTsKICBsb2Rhc2guYW55ID0gc29tZTsKICBsb2Rhc2guZGV0ZWN0ID0gZmluZDsKICBsb2Rhc2guZm9sZGwgPSByZWR1Y2U7CiAgbG9kYXNoLmZvbGRyID0gcmVkdWNlUmlnaHQ7CiAgbG9kYXNoLmluY2x1ZGUgPSBjb250YWluczsKICBsb2Rhc2guaW5qZWN0ID0gcmVkdWNlOwoKICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX193cmFwcGVkX19dOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseShsb2Rhc2gsIGFyZ3MpOwogICAgICB9OwogICAgfQogIH0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gYWRkIGZ1bmN0aW9ucyBjYXBhYmxlIG9mIHJldHVybmluZyB3cmFwcGVkIGFuZCB1bndyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICBsb2Rhc2guZmlyc3QgPSBmaXJzdDsKICBsb2Rhc2gubGFzdCA9IGxhc3Q7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLnRha2UgPSBmaXJzdDsKICBsb2Rhc2guaGVhZCA9IGZpcnN0OwoKICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXT0gZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYyh0aGlzLl9fd3JhcHBlZF9fLCBjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrID09IG51bGwgfHwgKHRoaXNBcmcgJiYgdHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicpCiAgICAgICAgICA/IHJlc3VsdAogICAgICAgICAgOiBuZXcgbG9kYXNoKHJlc3VsdCk7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBTdHJpbmcKICAgKi8KICBsb2Rhc2guVkVSU0lPTiA9ICcxLjAuMC1yYy4zJzsKCiAgLy8gYWRkICJDaGFpbmluZyIgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyCiAgbG9kYXNoLnByb3RvdHlwZS50b1N0cmluZyA9IHdyYXBwZXJUb1N0cmluZzsKICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlID0gd3JhcHBlclZhbHVlT2Y7CiAgbG9kYXNoLnByb3RvdHlwZS52YWx1ZU9mID0gd3JhcHBlclZhbHVlT2Y7CgogIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzCiAgZWFjaChbJ2pvaW4nLCAncG9wJywgJ3NoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CiAgICB9OwogIH0pOwoKICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdGhlIHdyYXBwZWQgdmFsdWUKICBlYWNoKFsncHVzaCcsICdyZXZlcnNlJywgJ3NvcnQnLCAndW5zaGlmdCddLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIG5ldyB3cmFwcGVkIHZhbHVlcwogIGVhY2goWydjb25jYXQnLCAnc2xpY2UnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgbG9kYXNoKGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKSk7CiAgICB9OwogIH0pOwoKICAvLyBhdm9pZCBhcnJheS1saWtlIG9iamVjdCBidWdzIHdpdGggYEFycmF5I3NoaWZ0YCBhbmQgYEFycmF5I3NwbGljZWAKICAvLyBpbiBGaXJlZm94IDwgMTAgYW5kIElFIDwgOQogIGlmIChoYXNPYmplY3RTcGxpY2VCdWcpIHsKICAgIGVhY2goWydwb3AnLCAnc2hpZnQnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXSwKICAgICAgICAgIGlzU3BsaWNlID0gbWV0aG9kTmFtZSA9PSAnc3BsaWNlJzsKCiAgICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9fd3JhcHBlZF9fLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHZhbHVlLCBhcmd1bWVudHMpOwoKICAgICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBkZWxldGUgdmFsdWVbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1NwbGljZSA/IG5ldyBsb2Rhc2gocmVzdWx0KSA6IHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgLy8gYWRkIHBzZXVkbyBwcml2YXRlIHByb3BlcnR5IHRvIGJlIHVzZWQgYW5kIHJlbW92ZWQgZHVyaW5nIHRoZSBidWlsZCBwcm9jZXNzCiAgbG9kYXNoLl9lYWNoID0gZWFjaDsKICBsb2Rhc2guX2l0ZXJhdG9yVGVtcGxhdGUgPSBpdGVyYXRvclRlbXBsYXRlOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gZXhwb3NlIExvLURhc2gKICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIHdhcyBpbmplY3RlZCBieSBhIHRoaXJkLXBhcnR5IHNjcmlwdCBhbmQgbm90IGludGVuZGVkIHRvIGJlCiAgICAvLyBsb2FkZWQgYXMgYSBtb2R1bGUuIFRoZSBnbG9iYWwgYXNzaWdubWVudCBjYW4gYmUgcmV2ZXJ0ZWQgaW4gdGhlIExvLURhc2gKICAgIC8vIG1vZHVsZSB2aWEgaXRzIGBub0NvbmZsaWN0KClgIG1ldGhvZC4KICAgIHdpbmRvdy5fID0gbG9kYXNoOwoKICAgIC8vIGRlZmluZSBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlIHNvLCB0aHJvdWdoIHBhdGggbWFwcGluZywgaXQgY2FuIGJlCiAgICAvLyByZWZlcmVuY2VkIGFzIHRoZSAidW5kZXJzY29yZSIgbW9kdWxlCiAgICBkZWZpbmUoJ2xvZGFzaCcsW10sZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBsb2Rhc2g7CiAgICB9KTsKICB9CiAgLy8gY2hlY2sgZm9yIGBleHBvcnRzYCBhZnRlciBgZGVmaW5lYCBpbiBjYXNlIGEgYnVpbGQgb3B0aW1pemVyIGFkZHMgYW4gYGV4cG9ydHNgIG9iamVjdAogIGVsc2UgaWYgKGZyZWVFeHBvcnRzKSB7CiAgICAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgaWYgKHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmIG1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKSB7CiAgICAgIChtb2R1bGUuZXhwb3J0cyA9IGxvZGFzaCkuXyA9IGxvZGFzaDsKICAgIH0KICAgIC8vIGluIE5hcndoYWwgb3IgUmluZ29KUyB2MC43LjAtCiAgICBlbHNlIHsKICAgICAgZnJlZUV4cG9ydHMuXyA9IGxvZGFzaDsKICAgIH0KICB9CiAgZWxzZSB7CiAgICAvLyBpbiBhIGJyb3dzZXIgb3IgUmhpbm8KICAgIHdpbmRvdy5fID0gbG9kYXNoOwogIH0KfSh0aGlzKSk7CgovLyAgVW5kZXJzY29yZS5zdHJpbmcKLy8gIChjKSAyMDEwIEVzYS1NYXR0aSBTdXVyb25lbiA8ZXNhLW1hdHRpIGFldCBzdXVyb25lbiBkb3Qgb3JnPgovLyAgVW5kZXJzY29yZS5zdHJpbmcgaXMgZnJlZWx5IGRpc3RyaWJ1dGFibGUgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBNSVQgbGljZW5zZS4KLy8gIERvY3VtZW50YXRpb246IGh0dHBzOi8vZ2l0aHViLmNvbS9lcGVsaS91bmRlcnNjb3JlLnN0cmluZwovLyAgU29tZSBjb2RlIGlzIGJvcnJvd2VkIGZyb20gTW9vVG9vbHMgYW5kIEFsZXhhbmRydSBNYXJhc3RlYW51LgovLyAgVmVyc2lvbiAnMi4zLjEnCgohZnVuY3Rpb24ocm9vdCwgU3RyaW5nKXsKICAKCiAgLy8gRGVmaW5pbmcgaGVscGVyIGZ1bmN0aW9ucy4KCiAgdmFyIG5hdGl2ZVRyaW0gPSBTdHJpbmcucHJvdG90eXBlLnRyaW07CiAgdmFyIG5hdGl2ZVRyaW1SaWdodCA9IFN0cmluZy5wcm90b3R5cGUudHJpbVJpZ2h0OwogIHZhciBuYXRpdmVUcmltTGVmdCA9IFN0cmluZy5wcm90b3R5cGUudHJpbUxlZnQ7CgogIHZhciBwYXJzZU51bWJlciA9IGZ1bmN0aW9uKHNvdXJjZSkgeyByZXR1cm4gc291cmNlICogMSB8fCAwOyB9OwoKICB2YXIgc3RyUmVwZWF0ID0gZnVuY3Rpb24oc3RyLCBxdHkpewogICAgaWYgKHF0eSA8IDEpIHJldHVybiAnJzsKICAgIHZhciByZXN1bHQgPSAnJzsKICAgIHdoaWxlIChxdHkgPiAwKSB7CiAgICAgIGlmIChxdHkgJiAxKSByZXN1bHQgKz0gc3RyOwogICAgICBxdHkgPj49IDEsIHN0ciArPSBzdHI7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIHZhciBzbGljZSA9IFtdLnNsaWNlOwoKICB2YXIgZGVmYXVsdFRvV2hpdGVTcGFjZSA9IGZ1bmN0aW9uKGNoYXJhY3RlcnMpIHsKICAgIGlmIChjaGFyYWN0ZXJzID09IG51bGwpCiAgICAgIHJldHVybiAnXFxzJzsKICAgIGVsc2UgaWYgKGNoYXJhY3RlcnMuc291cmNlKQogICAgICByZXR1cm4gY2hhcmFjdGVycy5zb3VyY2U7CiAgICBlbHNlCiAgICAgIHJldHVybiAnWycgKyBfcy5lc2NhcGVSZWdFeHAoY2hhcmFjdGVycykgKyAnXSc7CiAgfTsKCiAgdmFyIGVzY2FwZUNoYXJzID0gewogICAgbHQ6ICc8JywKICAgIGd0OiAnPicsCiAgICBxdW90OiAnIicsCiAgICBhbXA6ICcmJywKICAgIGFwb3M6ICInIgogIH07CgogIHZhciByZXZlcnNlZEVzY2FwZUNoYXJzID0ge307CiAgZm9yKHZhciBrZXkgaW4gZXNjYXBlQ2hhcnMpIHJldmVyc2VkRXNjYXBlQ2hhcnNbZXNjYXBlQ2hhcnNba2V5XV0gPSBrZXk7CiAgcmV2ZXJzZWRFc2NhcGVDaGFyc1siJyJdID0gJyMzOSc7CgogIC8vIHNwcmludGYoKSBmb3IgSmF2YVNjcmlwdCAwLjctYmV0YTEKICAvLyBodHRwOi8vd3d3LmRpdmVpbnRvamF2YXNjcmlwdC5jb20vcHJvamVjdHMvamF2YXNjcmlwdC1zcHJpbnRmCiAgLy8KICAvLyBDb3B5cmlnaHQgKGMpIEFsZXhhbmRydSBNYXJhc3RlYW51IDxhbGV4YWhvbGljIFthdCkgZ21haWwgKGRvdF0gY29tPgogIC8vIEFsbCByaWdodHMgcmVzZXJ2ZWQuCgogIHZhciBzcHJpbnRmID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7CiAgICB9CgogICAgdmFyIHN0cl9yZXBlYXQgPSBzdHJSZXBlYXQ7CgogICAgdmFyIHN0cl9mb3JtYXQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFzdHJfZm9ybWF0LmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKICAgICAgICBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzdHJfZm9ybWF0LnBhcnNlKGFyZ3VtZW50c1swXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0cl9mb3JtYXQuZm9ybWF0LmNhbGwobnVsbCwgc3RyX2Zvcm1hdC5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKICAgICAgdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewogICAgICAgIG5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIGlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgICBtYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKICAgICAgICAgIGlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yXTsKICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3ByaW50ZignW18uc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQogICAgICAgICAgICBhcmcgPSBhcmd2W2N1cnNvcisrXTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3ByaW50ZignW18uc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKG1hdGNoWzhdKSB7CiAgICAgICAgICAgIGNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICd1JzogYXJnID0gTWF0aC5hYnMoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKICAgICAgICAgIHBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKICAgICAgICAgIHBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKICAgICAgICAgIHBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwogICAgICAgICAgb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmNhY2hlID0ge307CgogICAgc3RyX2Zvcm1hdC5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewogICAgICB2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwogICAgICB3aGlsZSAoX2ZtdCkgewogICAgICAgIGlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKCclJyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDE7CiAgICAgICAgICAgIHZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CiAgICAgICAgICAgIGlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKICAgICAgICAgICAgICB3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewogICAgICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tfLnNwcmludGZdIGh1aD8nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJnX25hbWVzID09PSAzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgIH0KICAgICAgICBfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgfQogICAgICByZXR1cm4gcGFyc2VfdHJlZTsKICAgIH07CgogICAgcmV0dXJuIHN0cl9mb3JtYXQ7CiAgfSkoKTsKCgoKICAvLyBEZWZpbmluZyB1bmRlcnNjb3JlLnN0cmluZwoKICB2YXIgX3MgPSB7CgogICAgVkVSU0lPTjogJzIuMy4xJywKCiAgICBpc0JsYW5rOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHN0ciA9ICcnOwogICAgICByZXR1cm4gKC9eXHMqJC8pLnRlc3Qoc3RyKTsKICAgIH0sCgogICAgc3RyaXBUYWdzOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLzxcLz9bXj5dKz4vZywgJycpOwogICAgfSwKCiAgICBjYXBpdGFsaXplIDogZnVuY3Rpb24oc3RyKXsKICAgICAgc3RyID0gc3RyID09IG51bGwgPyAnJyA6IFN0cmluZyhzdHIpOwogICAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogICAgfSwKCiAgICBjaG9wOiBmdW5jdGlvbihzdHIsIHN0ZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiBbXTsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHN0ZXAgPSB+fnN0ZXA7CiAgICAgIHJldHVybiBzdGVwID4gMCA/IHN0ci5tYXRjaChuZXcgUmVnRXhwKCcuezEsJyArIHN0ZXAgKyAnfScsICdnJykpIDogW3N0cl07CiAgICB9LAoKICAgIGNsZWFuOiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3Muc3RyaXAoc3RyKS5yZXBsYWNlKC9ccysvZywgJyAnKTsKICAgIH0sCgogICAgY291bnQ6IGZ1bmN0aW9uKHN0ciwgc3Vic3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsIHx8IHN1YnN0ciA9PSBudWxsKSByZXR1cm4gMDsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOwogICAgICBzdWJzdHIgPSBTdHJpbmcoc3Vic3RyKTsKCiAgICAgIHZhciBjb3VudCA9IDAsCiAgICAgICAgcG9zID0gMCwKICAgICAgICBsZW5ndGggPSBzdWJzdHIubGVuZ3RoOwoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBwb3MgPSBzdHIuaW5kZXhPZihzdWJzdHIsIHBvcyk7CiAgICAgICAgaWYgKHBvcyA9PT0gLTEpIGJyZWFrOwogICAgICAgIGNvdW50Kys7CiAgICAgICAgcG9zICs9IGxlbmd0aDsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvdW50OwogICAgfSwKCiAgICBjaGFyczogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuc3BsaXQoJycpOwogICAgfSwKCiAgICBzd2FwQ2FzZTogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvXFMvZywgZnVuY3Rpb24oYyl7CiAgICAgICAgcmV0dXJuIGMgPT09IGMudG9VcHBlckNhc2UoKSA/IGMudG9Mb3dlckNhc2UoKSA6IGMudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAoKICAgIGVzY2FwZUhUTUw6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoL1smPD4iJ10vZywgZnVuY3Rpb24obSl7IHJldHVybiAnJicgKyByZXZlcnNlZEVzY2FwZUNoYXJzW21dICsgJzsnOyB9KTsKICAgIH0sCgogICAgdW5lc2NhcGVIVE1MOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC9cJihbXjtdKyk7L2csIGZ1bmN0aW9uKGVudGl0eSwgZW50aXR5Q29kZSl7CiAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICBpZiAoZW50aXR5Q29kZSBpbiBlc2NhcGVDaGFycykgewogICAgICAgICAgcmV0dXJuIGVzY2FwZUNoYXJzW2VudGl0eUNvZGVdOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBlbnRpdHlDb2RlLm1hdGNoKC9eI3goW1xkYS1mQS1GXSspJC8pKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChtYXRjaFsxXSwgMTYpKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoID0gZW50aXR5Q29kZS5tYXRjaCgvXiMoXGQrKSQvKSkgewogICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUofn5tYXRjaFsxXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBlbnRpdHk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgZXNjYXBlUmVnRXhwOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLyhbLiorP149IToke30oKXxbXF1cL1xcXSkvZywgJ1xcJDEnKTsKICAgIH0sCgogICAgc3BsaWNlOiBmdW5jdGlvbihzdHIsIGksIGhvd21hbnksIHN1YnN0cil7CiAgICAgIHZhciBhcnIgPSBfcy5jaGFycyhzdHIpOwogICAgICBhcnIuc3BsaWNlKH5+aSwgfn5ob3dtYW55LCBzdWJzdHIpOwogICAgICByZXR1cm4gYXJyLmpvaW4oJycpOwogICAgfSwKCiAgICBpbnNlcnQ6IGZ1bmN0aW9uKHN0ciwgaSwgc3Vic3RyKXsKICAgICAgcmV0dXJuIF9zLnNwbGljZShzdHIsIGksIDAsIHN1YnN0cik7CiAgICB9LAoKICAgIGluY2x1ZGU6IGZ1bmN0aW9uKHN0ciwgbmVlZGxlKXsKICAgICAgaWYgKG5lZWRsZSA9PT0gJycpIHJldHVybiB0cnVlOwogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLmluZGV4T2YobmVlZGxlKSAhPT0gLTE7CiAgICB9LAoKICAgIGpvaW46IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICBzZXBhcmF0b3IgPSBhcmdzLnNoaWZ0KCk7CgogICAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHNlcGFyYXRvciA9ICcnOwoKICAgICAgcmV0dXJuIGFyZ3Muam9pbihzZXBhcmF0b3IpOwogICAgfSwKCiAgICBsaW5lczogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuc3BsaXQoIlxuIik7CiAgICB9LAoKICAgIHJldmVyc2U6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5jaGFycyhzdHIpLnJldmVyc2UoKS5qb2luKCcnKTsKICAgIH0sCgogICAgc3RhcnRzV2l0aDogZnVuY3Rpb24oc3RyLCBzdGFydHMpewogICAgICBpZiAoc3RhcnRzID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCB8fCBzdGFydHMgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgc3RhcnRzID0gU3RyaW5nKHN0YXJ0cyk7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID49IHN0YXJ0cy5sZW5ndGggJiYgc3RyLnNsaWNlKDAsIHN0YXJ0cy5sZW5ndGgpID09PSBzdGFydHM7CiAgICB9LAoKICAgIGVuZHNXaXRoOiBmdW5jdGlvbihzdHIsIGVuZHMpewogICAgICBpZiAoZW5kcyA9PT0gJycpIHJldHVybiB0cnVlOwogICAgICBpZiAoc3RyID09IG51bGwgfHwgZW5kcyA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBlbmRzID0gU3RyaW5nKGVuZHMpOwogICAgICByZXR1cm4gc3RyLmxlbmd0aCA+PSBlbmRzLmxlbmd0aCAmJiBzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIGVuZHMubGVuZ3RoKSA9PT0gZW5kczsKICAgIH0sCgogICAgc3VjYzogZnVuY3Rpb24oc3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOwogICAgICByZXR1cm4gc3RyLnNsaWNlKDAsIC0xKSArIFN0cmluZy5mcm9tQ2hhckNvZGUoc3RyLmNoYXJDb2RlQXQoc3RyLmxlbmd0aC0xKSArIDEpOwogICAgfSwKCiAgICB0aXRsZWl6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8oPzpefFxzKVxTL2csIGZ1bmN0aW9uKGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOyB9KTsKICAgIH0sCgogICAgY2FtZWxpemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvWy1fXHNdKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOyB9KTsKICAgIH0sCgogICAgdW5kZXJzY29yZWQ6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKykvZywgJyQxXyQyJykucmVwbGFjZSgvWy1cc10rL2csICdfJykudG9Mb3dlckNhc2UoKTsKICAgIH0sCgogICAgZGFzaGVyaXplOiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3MudHJpbShzdHIpLnJlcGxhY2UoLyhbQS1aXSkvZywgJy0kMScpLnJlcGxhY2UoL1stX1xzXSsvZywgJy0nKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICBjbGFzc2lmeTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRpdGxlaXplKFN0cmluZyhzdHIpLnJlcGxhY2UoL1tcV19dL2csICcgJykpLnJlcGxhY2UoL1xzL2csICcnKTsKICAgIH0sCgogICAgaHVtYW5pemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5jYXBpdGFsaXplKF9zLnVuZGVyc2NvcmVkKHN0cikucmVwbGFjZSgvX2lkJC8sJycpLnJlcGxhY2UoL18vZywgJyAnKSk7CiAgICB9LAoKICAgIHRyaW06IGZ1bmN0aW9uKHN0ciwgY2hhcmFjdGVycyl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBpZiAoIWNoYXJhY3RlcnMgJiYgbmF0aXZlVHJpbSkgcmV0dXJuIG5hdGl2ZVRyaW0uY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cCgnXF4nICsgY2hhcmFjdGVycyArICcrfCcgKyBjaGFyYWN0ZXJzICsgJyskJywgJ2cnKSwgJycpOwogICAgfSwKCiAgICBsdHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltTGVmdCkgcmV0dXJuIG5hdGl2ZVRyaW1MZWZ0LmNhbGwoc3RyKTsKICAgICAgY2hhcmFjdGVycyA9IGRlZmF1bHRUb1doaXRlU3BhY2UoY2hhcmFjdGVycyk7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKG5ldyBSZWdFeHAoJ14nICsgY2hhcmFjdGVycyArICcrJyksICcnKTsKICAgIH0sCgogICAgcnRyaW06IGZ1bmN0aW9uKHN0ciwgY2hhcmFjdGVycyl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBpZiAoIWNoYXJhY3RlcnMgJiYgbmF0aXZlVHJpbVJpZ2h0KSByZXR1cm4gbmF0aXZlVHJpbVJpZ2h0LmNhbGwoc3RyKTsKICAgICAgY2hhcmFjdGVycyA9IGRlZmF1bHRUb1doaXRlU3BhY2UoY2hhcmFjdGVycyk7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKG5ldyBSZWdFeHAoY2hhcmFjdGVycyArICcrJCcpLCAnJyk7CiAgICB9LAoKICAgIHRydW5jYXRlOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgdHJ1bmNhdGVTdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHRydW5jYXRlU3RyID0gdHJ1bmNhdGVTdHIgfHwgJy4uLic7CiAgICAgIGxlbmd0aCA9IH5+bGVuZ3RoOwogICAgICByZXR1cm4gc3RyLmxlbmd0aCA+IGxlbmd0aCA/IHN0ci5zbGljZSgwLCBsZW5ndGgpICsgdHJ1bmNhdGVTdHIgOiBzdHI7CiAgICB9LAoKICAgIC8qKgogICAgICogX3MucHJ1bmU6IGEgbW9yZSBlbGVnYW50IHZlcnNpb24gb2YgdHJ1bmNhdGUKICAgICAqIHBydW5lIGV4dHJhIGNoYXJzLCBuZXZlciBsZWF2aW5nIGEgaGFsZi1jaG9wcGVkIHdvcmQuCiAgICAgKiBAYXV0aG9yIGdpdGh1Yi5jb20vcnd6CiAgICAgKi8KICAgIHBydW5lOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcHJ1bmVTdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBsZW5ndGggPSB+fmxlbmd0aDsKICAgICAgcHJ1bmVTdHIgPSBwcnVuZVN0ciAhPSBudWxsID8gU3RyaW5nKHBydW5lU3RyKSA6ICcuLi4nOwoKICAgICAgaWYgKHN0ci5sZW5ndGggPD0gbGVuZ3RoKSByZXR1cm4gc3RyOwoKICAgICAgdmFyIHRtcGwgPSBmdW5jdGlvbihjKXsgcmV0dXJuIGMudG9VcHBlckNhc2UoKSAhPT0gYy50b0xvd2VyQ2FzZSgpID8gJ0EnIDogJyAnOyB9LAogICAgICAgIHRlbXBsYXRlID0gc3RyLnNsaWNlKDAsIGxlbmd0aCsxKS5yZXBsYWNlKC8uKD89XFcqXHcqJCkvZywgdG1wbCk7IC8vICdIZWxsbywgd29ybGQnIC0+ICdIZWxsQUEgQUFBQUEnCgogICAgICBpZiAodGVtcGxhdGUuc2xpY2UodGVtcGxhdGUubGVuZ3RoLTIpLm1hdGNoKC9cd1x3LykpCiAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZS5yZXBsYWNlKC9ccypcUyskLywgJycpOwogICAgICBlbHNlCiAgICAgICAgdGVtcGxhdGUgPSBfcy5ydHJpbSh0ZW1wbGF0ZS5zbGljZSgwLCB0ZW1wbGF0ZS5sZW5ndGgtMSkpOwoKICAgICAgcmV0dXJuICh0ZW1wbGF0ZStwcnVuZVN0cikubGVuZ3RoID4gc3RyLmxlbmd0aCA/IHN0ciA6IHN0ci5zbGljZSgwLCB0ZW1wbGF0ZS5sZW5ndGgpK3BydW5lU3RyOwogICAgfSwKCiAgICB3b3JkczogZnVuY3Rpb24oc3RyLCBkZWxpbWl0ZXIpIHsKICAgICAgaWYgKF9zLmlzQmxhbmsoc3RyKSkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gX3MudHJpbShzdHIsIGRlbGltaXRlcikuc3BsaXQoZGVsaW1pdGVyIHx8IC9ccysvKTsKICAgIH0sCgogICAgcGFkOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcGFkU3RyLCB0eXBlKSB7CiAgICAgIHN0ciA9IHN0ciA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyKTsKICAgICAgbGVuZ3RoID0gfn5sZW5ndGg7CgogICAgICB2YXIgcGFkbGVuICA9IDA7CgogICAgICBpZiAoIXBhZFN0cikKICAgICAgICBwYWRTdHIgPSAnICc7CiAgICAgIGVsc2UgaWYgKHBhZFN0ci5sZW5ndGggPiAxKQogICAgICAgIHBhZFN0ciA9IHBhZFN0ci5jaGFyQXQoMCk7CgogICAgICBzd2l0Y2godHlwZSkgewogICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyICsgc3RyUmVwZWF0KHBhZFN0ciwgcGFkbGVuKTsKICAgICAgICBjYXNlICdib3RoJzoKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyUmVwZWF0KHBhZFN0ciwgTWF0aC5jZWlsKHBhZGxlbi8yKSkgKyBzdHIKICAgICAgICAgICAgICAgICAgKyBzdHJSZXBlYXQocGFkU3RyLCBNYXRoLmZsb29yKHBhZGxlbi8yKSk7CiAgICAgICAgZGVmYXVsdDogLy8gJ2xlZnQnCiAgICAgICAgICBwYWRsZW4gPSBsZW5ndGggLSBzdHIubGVuZ3RoOwogICAgICAgICAgcmV0dXJuIHN0clJlcGVhdChwYWRTdHIsIHBhZGxlbikgKyBzdHI7CiAgICAgICAgfQogICAgfSwKCiAgICBscGFkOiBmdW5jdGlvbihzdHIsIGxlbmd0aCwgcGFkU3RyKSB7CiAgICAgIHJldHVybiBfcy5wYWQoc3RyLCBsZW5ndGgsIHBhZFN0cik7CiAgICB9LAoKICAgIHJwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyLCAncmlnaHQnKTsKICAgIH0sCgogICAgbHJwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyLCAnYm90aCcpOwogICAgfSwKCiAgICBzcHJpbnRmOiBzcHJpbnRmLAoKICAgIHZzcHJpbnRmOiBmdW5jdGlvbihmbXQsIGFyZ3YpewogICAgICBhcmd2LnVuc2hpZnQoZm10KTsKICAgICAgcmV0dXJuIHNwcmludGYuYXBwbHkobnVsbCwgYXJndik7CiAgICB9LAoKICAgIHRvTnVtYmVyOiBmdW5jdGlvbihzdHIsIGRlY2ltYWxzKSB7CiAgICAgIGlmICghc3RyKSByZXR1cm4gMDsKICAgICAgc3RyID0gX3MudHJpbShzdHIpOwogICAgICBpZiAoIXN0ci5tYXRjaCgvXi0/XGQrKD86XC5cZCspPyQvKSkgcmV0dXJuIE5hTjsKICAgICAgcmV0dXJuIHBhcnNlTnVtYmVyKHBhcnNlTnVtYmVyKHN0cikudG9GaXhlZCh+fmRlY2ltYWxzKSk7CiAgICB9LAoKICAgIG51bWJlckZvcm1hdCA6IGZ1bmN0aW9uKG51bWJlciwgZGVjLCBkc2VwLCB0c2VwKSB7CiAgICAgIGlmIChpc05hTihudW1iZXIpIHx8IG51bWJlciA9PSBudWxsKSByZXR1cm4gJyc7CgogICAgICBudW1iZXIgPSBudW1iZXIudG9GaXhlZCh+fmRlYyk7CiAgICAgIHRzZXAgPSB0eXBlb2YgdHNlcCA9PSAnc3RyaW5nJyA/IHRzZXAgOiAnLCc7CgogICAgICB2YXIgcGFydHMgPSBudW1iZXIuc3BsaXQoJy4nKSwgZm51bXMgPSBwYXJ0c1swXSwKICAgICAgICBkZWNpbWFscyA9IHBhcnRzWzFdID8gKGRzZXAgfHwgJy4nKSArIHBhcnRzWzFdIDogJyc7CgogICAgICByZXR1cm4gZm51bXMucmVwbGFjZSgvKFxkKSg/PSg/OlxkezN9KSskKS9nLCAnJDEnICsgdHNlcCkgKyBkZWNpbWFsczsKICAgIH0sCgogICAgc3RyUmlnaHQ6IGZ1bmN0aW9uKHN0ciwgc2VwKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzZXAgPSBzZXAgIT0gbnVsbCA/IFN0cmluZyhzZXApIDogc2VwOwogICAgICB2YXIgcG9zID0gIXNlcCA/IC0xIDogc3RyLmluZGV4T2Yoc2VwKTsKICAgICAgcmV0dXJuIH5wb3MgPyBzdHIuc2xpY2UocG9zK3NlcC5sZW5ndGgsIHN0ci5sZW5ndGgpIDogc3RyOwogICAgfSwKCiAgICBzdHJSaWdodEJhY2s6IGZ1bmN0aW9uKHN0ciwgc2VwKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzZXAgPSBzZXAgIT0gbnVsbCA/IFN0cmluZyhzZXApIDogc2VwOwogICAgICB2YXIgcG9zID0gIXNlcCA/IC0xIDogc3RyLmxhc3RJbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKHBvcytzZXAubGVuZ3RoLCBzdHIubGVuZ3RoKSA6IHN0cjsKICAgIH0sCgogICAgc3RyTGVmdDogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIuaW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZSgwLCBwb3MpIDogc3RyOwogICAgfSwKCiAgICBzdHJMZWZ0QmFjazogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyICs9ICcnOyBzZXAgPSBzZXAgIT0gbnVsbCA/ICcnK3NlcCA6IHNlcDsKICAgICAgdmFyIHBvcyA9IHN0ci5sYXN0SW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZSgwLCBwb3MpIDogc3RyOwogICAgfSwKCiAgICB0b1NlbnRlbmNlOiBmdW5jdGlvbihhcnJheSwgc2VwYXJhdG9yLCBsYXN0U2VwYXJhdG9yLCBzZXJpYWwpIHsKICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICcsICcKICAgICAgbGFzdFNlcGFyYXRvciA9IGxhc3RTZXBhcmF0b3IgfHwgJyBhbmQgJwogICAgICB2YXIgYSA9IGFycmF5LnNsaWNlKCksIGxhc3RNZW1iZXIgPSBhLnBvcCgpOwoKICAgICAgaWYgKGFycmF5Lmxlbmd0aCA+IDIgJiYgc2VyaWFsKSBsYXN0U2VwYXJhdG9yID0gX3MucnRyaW0oc2VwYXJhdG9yKSArIGxhc3RTZXBhcmF0b3I7CgogICAgICByZXR1cm4gYS5sZW5ndGggPyBhLmpvaW4oc2VwYXJhdG9yKSArIGxhc3RTZXBhcmF0b3IgKyBsYXN0TWVtYmVyIDogbGFzdE1lbWJlcjsKICAgIH0sCgogICAgdG9TZW50ZW5jZVNlcmlhbDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzWzNdID0gdHJ1ZTsKICAgICAgcmV0dXJuIF9zLnRvU2VudGVuY2UuYXBwbHkoX3MsIGFyZ3MpOwogICAgfSwKCiAgICBzbHVnaWZ5OiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CgogICAgICB2YXIgZnJvbSAgPSAixIXDoMOhw6TDosOjw6XDpsSHxJnDqMOpw6vDqsOsw63Dr8OuxYLFhMOyw7PDtsO0w7XDuMO5w7rDvMO7w7HDp8W8xboiLAogICAgICAgICAgdG8gICAgPSAiYWFhYWFhYWFjZWVlZWVpaWlpbG5vb29vb291dXV1bmN6eiIsCiAgICAgICAgICByZWdleCA9IG5ldyBSZWdFeHAoZGVmYXVsdFRvV2hpdGVTcGFjZShmcm9tKSwgJ2cnKTsKCiAgICAgIHN0ciA9IFN0cmluZyhzdHIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShyZWdleCwgZnVuY3Rpb24oYyl7CiAgICAgICAgdmFyIGluZGV4ID0gZnJvbS5pbmRleE9mKGMpOwogICAgICAgIHJldHVybiB0by5jaGFyQXQoaW5kZXgpIHx8ICctJzsKICAgICAgfSk7CgogICAgICByZXR1cm4gX3MuZGFzaGVyaXplKHN0ci5yZXBsYWNlKC9bXlx3XHMtXS9nLCAnJykpOwogICAgfSwKCiAgICBzdXJyb3VuZDogZnVuY3Rpb24oc3RyLCB3cmFwcGVyKSB7CiAgICAgIHJldHVybiBbd3JhcHBlciwgc3RyLCB3cmFwcGVyXS5qb2luKCcnKTsKICAgIH0sCgogICAgcXVvdGU6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gX3Muc3Vycm91bmQoc3RyLCAnIicpOwogICAgfSwKCiAgICBleHBvcnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzKSB7CiAgICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KHByb3ApIHx8IHByb3AubWF0Y2goL14oPzppbmNsdWRlfGNvbnRhaW5zfHJldmVyc2UpJC8pKSBjb250aW51ZTsKICAgICAgICByZXN1bHRbcHJvcF0gPSB0aGlzW3Byb3BdOwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICByZXBlYXQ6IGZ1bmN0aW9uKHN0ciwgcXR5LCBzZXBhcmF0b3IpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHF0eSA9IH5+cXR5OwoKICAgICAgLy8gdXNpbmcgZmFzdGVyIGltcGxlbWVudGF0aW9uIGlmIHNlcGFyYXRvciBpcyBub3QgbmVlZGVkOwogICAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHJldHVybiBzdHJSZXBlYXQoU3RyaW5nKHN0ciksIHF0eSk7CgogICAgICAvLyB0aGlzIG9uZSBpcyBhYm91dCAzMDB4IHNsb3dlciBpbiBHb29nbGUgQ2hyb21lCiAgICAgIGZvciAodmFyIHJlcGVhdCA9IFtdOyBxdHkgPiAwOyByZXBlYXRbLS1xdHldID0gc3RyKSB7fQogICAgICByZXR1cm4gcmVwZWF0LmpvaW4oc2VwYXJhdG9yKTsKICAgIH0sCgogICAgbGV2ZW5zaHRlaW46IGZ1bmN0aW9uKHN0cjEsIHN0cjIpIHsKICAgICAgaWYgKHN0cjEgPT0gbnVsbCAmJiBzdHIyID09IG51bGwpIHJldHVybiAwOwogICAgICBpZiAoc3RyMSA9PSBudWxsKSByZXR1cm4gU3RyaW5nKHN0cjIpLmxlbmd0aDsKICAgICAgaWYgKHN0cjIgPT0gbnVsbCkgcmV0dXJuIFN0cmluZyhzdHIxKS5sZW5ndGg7CgogICAgICBzdHIxID0gU3RyaW5nKHN0cjEpOyBzdHIyID0gU3RyaW5nKHN0cjIpOwoKICAgICAgdmFyIGN1cnJlbnQgPSBbXSwgcHJldiwgdmFsdWU7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBzdHIyLmxlbmd0aDsgaSsrKQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDw9IHN0cjEubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChpICYmIGopCiAgICAgICAgICAgIGlmIChzdHIxLmNoYXJBdChqIC0gMSkgPT09IHN0cjIuY2hhckF0KGkgLSAxKSkKICAgICAgICAgICAgICB2YWx1ZSA9IHByZXY7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGgubWluKGN1cnJlbnRbal0sIGN1cnJlbnRbaiAtIDFdLCBwcmV2KSArIDE7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHZhbHVlID0gaSArIGo7CgogICAgICAgICAgcHJldiA9IGN1cnJlbnRbal07CiAgICAgICAgICBjdXJyZW50W2pdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgcmV0dXJuIGN1cnJlbnQucG9wKCk7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcwoKICBfcy5zdHJpcCAgICA9IF9zLnRyaW07CiAgX3MubHN0cmlwICAgPSBfcy5sdHJpbTsKICBfcy5yc3RyaXAgICA9IF9zLnJ0cmltOwogIF9zLmNlbnRlciAgID0gX3MubHJwYWQ7CiAgX3Mucmp1c3QgICAgPSBfcy5scGFkOwogIF9zLmxqdXN0ICAgID0gX3MucnBhZDsKICBfcy5jb250YWlucyA9IF9zLmluY2x1ZGU7CiAgX3MucSAgICAgICAgPSBfcy5xdW90ZTsKCiAgLy8gRXhwb3J0aW5nCgogIC8vIENvbW1vbkpTIG1vZHVsZSBpcyBkZWZpbmVkCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKQogICAgICBtb2R1bGUuZXhwb3J0cyA9IF9zOwoKICAgIGV4cG9ydHMuX3MgPSBfczsKICB9CgogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgbW9kdWxlIHdpdGggQU1ELgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpCiAgICBkZWZpbmUoJ3VuZGVyc2NvcmUuc3RyaW5nJywgW10sIGZ1bmN0aW9uKCl7IHJldHVybiBfczsgfSk7CgoKICAvLyBJbnRlZ3JhdGUgd2l0aCBVbmRlcnNjb3JlLmpzIGlmIGRlZmluZWQKICAvLyBvciBjcmVhdGUgb3VyIG93biB1bmRlcnNjb3JlIG9iamVjdC4KICByb290Ll8gPSByb290Ll8gfHwge307CiAgcm9vdC5fLnN0cmluZyA9IHJvb3QuXy5zdHIgPSBfczsKfSh0aGlzLCBTdHJpbmcpOwoKLy8gICAgIG5vZGUtdXVpZC91dWlkLmpzCi8vCi8vICAgICBDb3B5cmlnaHQgKGMpIDIwMTAgUm9iZXJ0IEtpZWZmZXIKLy8gICAgIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyAgICAgRG9jdW1lbnRhdGlvbiBhbmQgZGV0YWlscyBhdCBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZAooZnVuY3Rpb24oKSB7CiAgdmFyIF9nbG9iYWwgPSB0aGlzOwoKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLCBidXQKICAvLyBNYXRoLnJhbmRvbSgpIGRvZXMgbm90IGd1YXJhbnRlZSAiY3J5cHRvZ3JhcGhpYyBxdWFsaXR5Ii4gIFNvIHdlIGZlYXR1cmUKICAvLyBkZXRlY3QgZm9yIG1vcmUgcm9idXN0IEFQSXMsIG5vcm1hbGl6aW5nIGVhY2ggbWV0aG9kIHRvIHJldHVybiAxMjgtYml0cwogIC8vICgxNiBieXRlcykgb2YgcmFuZG9tIGRhdGEuCiAgdmFyIG1hdGhSTkcsIG5vZGVSTkcsIHdoYXR3Z1JORzsKCiAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCBSTkcuICBBbGwgcGxhdGZvcm1zLCB2ZXJ5IGZhc3QsIHVua25vd24gcXVhbGl0eQogIHZhciBfcm5kQnl0ZXMgPSBuZXcgQXJyYXkoMTYpOwogIG1hdGhSTkcgPSBmdW5jdGlvbigpIHsKICAgIHZhciByLCBiID0gX3JuZEJ5dGVzLCBpID0gMDsKCiAgICBmb3IgKHZhciBpID0gMCwgcjsgaSA8IDE2OyBpKyspIHsKICAgICAgaWYgKChpICYgMHgwMykgPT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgYltpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgIH0KCiAgICByZXR1cm4gYjsKICB9CgogIC8vIFdIQVRXRyBjcnlwdG8tYmFzZWQgUk5HIC0gaHR0cDovL3dpa2kud2hhdHdnLm9yZy93aWtpL0NyeXB0bwogIC8vIFdlYktpdCBvbmx5IChjdXJyZW50bHkpLCBtb2RlcmF0ZWx5IGZhc3QsIGhpZ2ggcXVhbGl0eQogIGlmIChfZ2xvYmFsLmNyeXB0byAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICB2YXIgX3JuZHMgPSBuZXcgVWludDMyQXJyYXkoNCk7CiAgICB3aGF0d2dSTkcgPSBmdW5jdGlvbigpIHsKICAgICAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhfcm5kcyk7CgogICAgICBmb3IgKHZhciBjID0gMCA7IGMgPCAxNjsgYysrKSB7CiAgICAgICAgX3JuZEJ5dGVzW2NdID0gX3JuZHNbYyA+PiAyXSA+Pj4gKChjICYgMHgwMykgKiA4KSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIF9ybmRCeXRlczsKICAgIH0KICB9CgogIC8vIE5vZGUuanMgY3J5cHRvLWJhc2VkIFJORyAtIGh0dHA6Ly9ub2RlanMub3JnL2RvY3MvdjAuNi4yL2FwaS9jcnlwdG8uaHRtbAogIC8vIE5vZGUuanMgb25seSwgbW9kZXJhdGVseSBmYXN0LCBoaWdoIHF1YWxpdHkKICB0cnkgewogICAgdmFyIF9yYiA9IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzOwogICAgbm9kZVJORyA9IF9yYiAmJiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF9yYigxNik7CiAgICB9OwogIH0gY2F0Y2ggKGUpIHt9CgogIC8vIFNlbGVjdCBSTkcgd2l0aCBiZXN0IHF1YWxpdHkKICB2YXIgX3JuZyA9IG5vZGVSTkcgfHwgd2hhdHdnUk5HIHx8IG1hdGhSTkc7CgogIC8vIEJ1ZmZlciBjbGFzcyB0byB1c2UKICB2YXIgQnVmZmVyQ2xhc3MgPSB0eXBlb2YoQnVmZmVyKSA9PSAnZnVuY3Rpb24nID8gQnVmZmVyIDogQXJyYXk7CgogIC8vIE1hcHMgZm9yIG51bWJlciA8LT4gaGV4IHN0cmluZyBjb252ZXJzaW9uCiAgdmFyIF9ieXRlVG9IZXggPSBbXTsKICB2YXIgX2hleFRvQnl0ZSA9IHt9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyBpKyspIHsKICAgIF9ieXRlVG9IZXhbaV0gPSAoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpOwogICAgX2hleFRvQnl0ZVtfYnl0ZVRvSGV4W2ldXSA9IGk7CiAgfQoKICAvLyAqKmBwYXJzZSgpYCAtIFBhcnNlIGEgVVVJRCBpbnRvIGl0J3MgY29tcG9uZW50IGJ5dGVzKioKICBmdW5jdGlvbiBwYXJzZShzLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSAoYnVmICYmIG9mZnNldCkgfHwgMCwgaWkgPSAwOwoKICAgIGJ1ZiA9IGJ1ZiB8fCBbXTsKICAgIHMudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bMC05YS1mXXsyfS9nLCBmdW5jdGlvbihieXRlKSB7CiAgICAgIGlmIChpaSA8IDE2KSB7IC8vIERvbid0IG92ZXJmbG93IQogICAgICAgIGJ1ZltpICsgaWkrK10gPSBfaGV4VG9CeXRlW2J5dGVdOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBaZXJvIG91dCByZW1haW5pbmcgYnl0ZXMgaWYgc3RyaW5nIHdhcyBzaG9ydAogICAgd2hpbGUgKGlpIDwgMTYpIHsKICAgICAgYnVmW2kgKyBpaSsrXSA9IDA7CiAgICB9CgogICAgcmV0dXJuIGJ1ZjsKICB9CgogIC8vICoqYHVucGFyc2UoKWAgLSBDb252ZXJ0IFVVSUQgYnl0ZSBhcnJheSAoYWxhIHBhcnNlKCkpIGludG8gYSBzdHJpbmcqKgogIGZ1bmN0aW9uIHVucGFyc2UoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDAsIGJ0aCA9IF9ieXRlVG9IZXg7CiAgICByZXR1cm4gIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV07CiAgfQoKICAvLyAqKmB2MSgpYCAtIEdlbmVyYXRlIHRpbWUtYmFzZWQgVVVJRCoqCiAgLy8KICAvLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwogIC8vIGFuZCBodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvdXVpZC5odG1sCgogIC8vIHJhbmRvbSAjJ3Mgd2UgbmVlZCB0byBpbml0IG5vZGUgYW5kIGNsb2Nrc2VxCiAgdmFyIF9zZWVkQnl0ZXMgPSBfcm5nKCk7CgogIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogIHZhciBfbm9kZUlkID0gWwogICAgX3NlZWRCeXRlc1swXSB8IDB4MDEsCiAgICBfc2VlZEJ5dGVzWzFdLCBfc2VlZEJ5dGVzWzJdLCBfc2VlZEJ5dGVzWzNdLCBfc2VlZEJ5dGVzWzRdLCBfc2VlZEJ5dGVzWzVdCiAgXTsKCiAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICB2YXIgX2Nsb2Nrc2VxID0gKF9zZWVkQnl0ZXNbNl0gPDwgOCB8IF9zZWVkQnl0ZXNbN10pICYgMHgzZmZmOwoKICAvLyBQcmV2aW91cyB1dWlkIGNyZWF0aW9uIHRpbWUKICB2YXIgX2xhc3RNU2VjcyA9IDAsIF9sYXN0TlNlY3MgPSAwOwoKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgdmFyIGIgPSBidWYgfHwgW107CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIGNsb2Nrc2VxID0gb3B0aW9ucy5jbG9ja3NlcSAhPSBudWxsID8gb3B0aW9ucy5jbG9ja3NlcSA6IF9jbG9ja3NlcTsKCiAgICAvLyBVVUlEIHRpbWVzdGFtcHMgYXJlIDEwMCBuYW5vLXNlY29uZCB1bml0cyBzaW5jZSB0aGUgR3JlZ29yaWFuIGVwb2NoLAogICAgLy8gKDE1ODItMTAtMTUgMDA6MDApLiAgSlNOdW1iZXJzIGFyZW4ndCBwcmVjaXNlIGVub3VnaCBmb3IgdGhpcywgc28KICAgIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogICAgLy8gKDEwMC1uYW5vc2Vjb25kcyBvZmZzZXQgZnJvbSBtc2Vjcykgc2luY2UgdW5peCBlcG9jaCwgMTk3MC0wMS0wMSAwMDowMC4KICAgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT0gbnVsbCA/IG9wdGlvbnMubXNlY3MgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCiAgICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawogICAgdmFyIG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPSBudWxsID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOwoKICAgIC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKICAgIHZhciBkdCA9IChtc2VjcyAtIF9sYXN0TVNlY3MpICsgKG5zZWNzIC0gX2xhc3ROU2VjcykvMTAwMDA7CgogICAgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgogICAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgICB9CgogICAgLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKICAgIC8vIHRpbWUgaW50ZXJ2YWwKICAgIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PSBudWxsKSB7CiAgICAgIG5zZWNzID0gMDsKICAgIH0KCiAgICAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCiAgICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dWlkLnYxKCk6IENhblwndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMnKTsKICAgIH0KCiAgICBfbGFzdE1TZWNzID0gbXNlY3M7CiAgICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsKCiAgICAvLyBQZXIgNC4xLjQgLSBDb252ZXJ0IGZyb20gdW5peCBlcG9jaCB0byBHcmVnb3JpYW4gZXBvY2gKICAgIG1zZWNzICs9IDEyMjE5MjkyODAwMDAwOwoKICAgIC8vIGB0aW1lX2xvd2AKICAgIHZhciB0bCA9ICgobXNlY3MgJiAweGZmZmZmZmYpICogMTAwMDAgKyBuc2VjcykgJSAweDEwMDAwMDAwMDsKICAgIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdGwgJiAweGZmOwoKICAgIC8vIGB0aW1lX21pZGAKICAgIHZhciB0bWggPSAobXNlY3MgLyAweDEwMDAwMDAwMCAqIDEwMDAwKSAmIDB4ZmZmZmZmZjsKICAgIGJbaSsrXSA9IHRtaCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bWggJiAweGZmOwoKICAgIC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCiAgICBiW2krK10gPSB0bWggPj4+IDI0ICYgMHhmIHwgMHgxMDsgLy8gaW5jbHVkZSB2ZXJzaW9uCiAgICBiW2krK10gPSB0bWggPj4+IDE2ICYgMHhmZjsKCiAgICAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKICAgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsKCiAgICAvLyBgY2xvY2tfc2VxX2xvd2AKICAgIGJbaSsrXSA9IGNsb2Nrc2VxICYgMHhmZjsKCiAgICAvLyBgbm9kZWAKICAgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CiAgICBmb3IgKHZhciBuID0gMDsgbiA8IDY7IG4rKykgewogICAgICBiW2kgKyBuXSA9IG5vZGVbbl07CiAgICB9CgogICAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6IHVucGFyc2UoYik7CiAgfQoKICAvLyAqKmB2NCgpYCAtIEdlbmVyYXRlIHJhbmRvbSBVVUlEKioKCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICAvLyBEZXByZWNhdGVkIC0gJ2Zvcm1hdCcgYXJndW1lbnQsIGFzIHN1cHBvcnRlZCBpbiB2MS4yCiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT0gJ2JpbmFyeScgPyBuZXcgQnVmZmVyQ2xhc3MoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBfcm5nKSgpOwoKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyBpaSsrKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBidWYgfHwgdW5wYXJzZShybmRzKTsKICB9CgogIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnYxID0gdjE7CiAgdXVpZC52NCA9IHY0OwogIHV1aWQucGFyc2UgPSBwYXJzZTsKICB1dWlkLnVucGFyc2UgPSB1bnBhcnNlOwogIHV1aWQuQnVmZmVyQ2xhc3MgPSBCdWZmZXJDbGFzczsKCiAgLy8gRXhwb3J0IFJORyBvcHRpb25zCiAgdXVpZC5tYXRoUk5HID0gbWF0aFJORzsKICB1dWlkLm5vZGVSTkcgPSBub2RlUk5HOwogIHV1aWQud2hhdHdnUk5HID0gd2hhdHdnUk5HOwoKICBpZiAodHlwZW9mKG1vZHVsZSkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgIC8vIFBsYXkgbmljZSB3aXRoIG5vZGUuanMKICAgIG1vZHVsZS5leHBvcnRzID0gdXVpZDsKICB9IGVsc2UgewogICAgLy8gUGxheSBuaWNlIHdpdGggYnJvd3NlcnMKICAgIHZhciBfcHJldmlvdXNSb290ID0gX2dsb2JhbC51dWlkOwoKICAgIC8vICoqYG5vQ29uZmxpY3QoKWAgLSAoYnJvd3NlciBvbmx5KSB0byByZXNldCBnbG9iYWwgJ3V1aWQnIHZhcioqCiAgICB1dWlkLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgX2dsb2JhbC51dWlkID0gX3ByZXZpb3VzUm9vdDsKICAgICAgcmV0dXJuIHV1aWQ7CiAgICB9CiAgICBfZ2xvYmFsLnV1aWQgPSB1dWlkOwogIH0KfSgpKTsKCmRlZmluZSgidXVpZCIsIGZ1bmN0aW9uKCl7fSk7CgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogQSBsaWdodHdlaWdodCBDb21tb25KUyBQcm9taXNlcy9BIGFuZCB3aGVuKCkgaW1wbGVtZW50YXRpb24KICogd2hlbiBpcyBwYXJ0IG9mIHRoZSBjdWpvLmpzIGZhbWlseSBvZiBsaWJyYXJpZXMgKGh0dHA6Ly9jdWpvanMuY29tLykKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIGF0OgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKgogKiBAdmVyc2lvbiAxLjcuMQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsgCmRlZmluZSgnd2hlbi93aGVuJyxbXSxmdW5jdGlvbiAoKSB7Cgl2YXIgcmVkdWNlQXJyYXksIHNsaWNlLCB1bmRlZjsKCgkvLwoJLy8gUHVibGljIEFQSQoJLy8KCgl3aGVuLmRlZmVyICAgICA9IGRlZmVyOyAgICAgLy8gQ3JlYXRlIGEgZGVmZXJyZWQKCXdoZW4ucmVzb2x2ZSAgID0gcmVzb2x2ZTsgICAvLyBDcmVhdGUgYSByZXNvbHZlZCBwcm9taXNlCgl3aGVuLnJlamVjdCAgICA9IHJlamVjdDsgICAgLy8gQ3JlYXRlIGEgcmVqZWN0ZWQgcHJvbWlzZQoKCXdoZW4uam9pbiAgICAgID0gam9pbjsgICAgICAvLyBKb2luIDIgb3IgbW9yZSBwcm9taXNlcwoKCXdoZW4uYWxsICAgICAgID0gYWxsOyAgICAgICAvLyBSZXNvbHZlIGEgbGlzdCBvZiBwcm9taXNlcwoJd2hlbi5tYXAgICAgICAgPSBtYXA7ICAgICAgIC8vIEFycmF5Lm1hcCgpIGZvciBwcm9taXNlcwoJd2hlbi5yZWR1Y2UgICAgPSByZWR1Y2U7ICAgIC8vIEFycmF5LnJlZHVjZSgpIGZvciBwcm9taXNlcwoKCXdoZW4uYW55ICAgICAgID0gYW55OyAgICAgICAvLyBPbmUtd2lubmVyIHJhY2UKCXdoZW4uc29tZSAgICAgID0gc29tZTsgICAgICAvLyBNdWx0aS13aW5uZXIgcmFjZQoKCXdoZW4uY2hhaW4gICAgID0gY2hhaW47ICAgICAvLyBNYWtlIGEgcHJvbWlzZSB0cmlnZ2VyIGFub3RoZXIgcmVzb2x2ZXIKCgl3aGVuLmlzUHJvbWlzZSA9IGlzUHJvbWlzZTsgLy8gRGV0ZXJtaW5lIGlmIGEgdGhpbmcgaXMgYSBwcm9taXNlCgoJLyoqCgkgKiBSZWdpc3RlciBhbiBvYnNlcnZlciBmb3IgYSBwcm9taXNlIG9yIGltbWVkaWF0ZSB2YWx1ZS4KCSAqCgkgKiBAcGFyYW0geyp9IHByb21pc2VPclZhbHVlCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9taXNlT3JWYWx1ZSBpcwoJICogICBzdWNjZXNzZnVsbHkgZnVsZmlsbGVkLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYW4gaW1tZWRpYXRlIHZhbHVlLCBjYWxsYmFjawoJICogICB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkuCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb21pc2VPclZhbHVlIGlzCgkgKiAgIHJlamVjdGVkLgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9ncmVzcyB1cGRhdGVzCgkgKiAgIGFyZSBpc3N1ZWQgZm9yIHByb21pc2VPclZhbHVlLgoJICogQHJldHVybnMge1Byb21pc2V9IGEgbmV3IHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgY29tcGxldGUgd2l0aCB0aGUgcmV0dXJuCgkgKiAgIHZhbHVlIG9mIGNhbGxiYWNrIG9yIGVycmJhY2sgb3IgdGhlIGNvbXBsZXRpb24gdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUgaWYKCSAqICAgY2FsbGJhY2sgYW5kL29yIGVycmJhY2sgaXMgbm90IHN1cHBsaWVkLgoJICovCglmdW5jdGlvbiB3aGVuKHByb21pc2VPclZhbHVlLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCS8vIEdldCBhIHRydXN0ZWQgcHJvbWlzZSBmb3IgdGhlIGlucHV0IHByb21pc2VPclZhbHVlLCBhbmQgdGhlbgoJCS8vIHJlZ2lzdGVyIHByb21pc2UgaGFuZGxlcnMKCQlyZXR1cm4gcmVzb2x2ZShwcm9taXNlT3JWYWx1ZSkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBSZXR1cm5zIHByb21pc2VPclZhbHVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9LCBhIG5ldyBQcm9taXNlIGlmCgkgKiBwcm9taXNlT3JWYWx1ZSBpcyBhIGZvcmVpZ24gcHJvbWlzZSwgb3IgYSBuZXcsIGFscmVhZHktZnVsZmlsbGVkIHtAbGluayBQcm9taXNlfQoJICogd2hvc2UgdmFsdWUgaXMgcHJvbWlzZU9yVmFsdWUgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYW4gaW1tZWRpYXRlIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUKCSAqIEByZXR1cm5zIEd1YXJhbnRlZWQgdG8gcmV0dXJuIGEgdHJ1c3RlZCBQcm9taXNlLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYSB3aGVuLmpzIHtAbGluayBQcm9taXNlfQoJICogICByZXR1cm5zIHByb21pc2VPclZhbHVlLCBvdGhlcndpc2UsIHJldHVybnMgYSBuZXcsIGFscmVhZHktcmVzb2x2ZWQsIHdoZW4uanMge0BsaW5rIFByb21pc2V9CgkgKiAgIHdob3NlIHJlc29sdXRpb24gdmFsdWUgaXM6CgkgKiAgICogdGhlIHJlc29sdXRpb24gdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUgaWYgaXQncyBhIGZvcmVpZ24gcHJvbWlzZSwgb3IKCSAqICAgKiBwcm9taXNlT3JWYWx1ZSBpZiBpdCdzIGEgdmFsdWUKCSAqLwoJZnVuY3Rpb24gcmVzb2x2ZShwcm9taXNlT3JWYWx1ZSkgewoJCXZhciBwcm9taXNlLCBkZWZlcnJlZDsKCgkJaWYocHJvbWlzZU9yVmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSB7CgkJCS8vIEl0J3MgYSB3aGVuLmpzIHByb21pc2UsIHNvIHdlIHRydXN0IGl0CgkJCXByb21pc2UgPSBwcm9taXNlT3JWYWx1ZTsKCgkJfSBlbHNlIHsKCQkJLy8gSXQncyBub3QgYSB3aGVuLmpzIHByb21pc2UuIFNlZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlIG9yIGEgdmFsdWUuCgkJCWlmKGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkpIHsKCQkJCS8vIEl0J3MgYSB0aGVuYWJsZSwgYnV0IHdlIGRvbid0IGtub3cgd2hlcmUgaXQgY2FtZSBmcm9tLCBzbyBkb24ndCB0cnVzdAoJCQkJLy8gaXRzIGltcGxlbWVudGF0aW9uIGVudGlyZWx5LiAgSW50cm9kdWNlIGEgdHJ1c3RlZCBtaWRkbGVtYW4gd2hlbi5qcyBwcm9taXNlCgkJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQkJLy8gSU1QT1JUQU5UOiBUaGlzIGlzIHRoZSBvbmx5IHBsYWNlIHdoZW4uanMgc2hvdWxkIGV2ZXIgY2FsbCAudGhlbigpIG9uIGFuCgkJCQkvLyB1bnRydXN0ZWQgcHJvbWlzZS4gRG9uJ3QgZXhwb3NlIHRoZSByZXR1cm4gdmFsdWUgdG8gdGhlIHVudHJ1c3RlZCBwcm9taXNlCgkJCQlwcm9taXNlT3JWYWx1ZS50aGVuKAoJCQkJCWZ1bmN0aW9uKHZhbHVlKSAgeyBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlKTsgfSwKCQkJCQlmdW5jdGlvbihyZWFzb24pIHsgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7IH0sCgkJCQkJZnVuY3Rpb24odXBkYXRlKSB7IGRlZmVycmVkLnByb2dyZXNzKHVwZGF0ZSk7IH0KCQkJCSk7CgoJCQkJcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CgoJCQl9IGVsc2UgewoJCQkJLy8gSXQncyBhIHZhbHVlLCBub3QgYSBwcm9taXNlLiAgQ3JlYXRlIGEgcmVzb2x2ZWQgcHJvbWlzZSBmb3IgaXQuCgkJCQlwcm9taXNlID0gZnVsZmlsbGVkKHByb21pc2VPclZhbHVlKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLyoqCgkgKiBSZXR1cm5zIGEgcmVqZWN0ZWQgcHJvbWlzZSBmb3IgdGhlIHN1cHBsaWVkIHByb21pc2VPclZhbHVlLiAgVGhlIHJldHVybmVkCgkgKiBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aDoKCSAqIC0gcHJvbWlzZU9yVmFsdWUsIGlmIGl0IGlzIGEgdmFsdWUsIG9yCgkgKiAtIGlmIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZQoJICogICAtIHByb21pc2VPclZhbHVlJ3MgdmFsdWUgYWZ0ZXIgaXQgaXMgZnVsZmlsbGVkCgkgKiAgIC0gcHJvbWlzZU9yVmFsdWUncyByZWFzb24gYWZ0ZXIgaXQgaXMgcmVqZWN0ZWQKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUgdGhlIHJlamVjdGVkIHZhbHVlIG9mIHRoZSByZXR1cm5lZCB7QGxpbmsgUHJvbWlzZX0KCSAqIEByZXR1cm4ge1Byb21pc2V9IHJlamVjdGVkIHtAbGluayBQcm9taXNlfQoJICovCglmdW5jdGlvbiByZWplY3QocHJvbWlzZU9yVmFsdWUpIHsKCQlyZXR1cm4gd2hlbihwcm9taXNlT3JWYWx1ZSwgcmVqZWN0ZWQpOwoJfQoKCS8qKgoJICogVHJ1c3RlZCBQcm9taXNlIGNvbnN0cnVjdG9yLiAgQSBQcm9taXNlIGNyZWF0ZWQgZnJvbSB0aGlzIGNvbnN0cnVjdG9yIGlzCgkgKiBhIHRydXN0ZWQgd2hlbi5qcyBwcm9taXNlLiAgQW55IG90aGVyIGR1Y2stdHlwZWQgcHJvbWlzZSBpcyBjb25zaWRlcmVkCgkgKiB1bnRydXN0ZWQuCgkgKiBAY29uc3RydWN0b3IKCSAqIEBuYW1lIFByb21pc2UKCSAqLwoJZnVuY3Rpb24gUHJvbWlzZSh0aGVuKSB7CgkJdGhpcy50aGVuID0gdGhlbjsKCX0KCglQcm9taXNlLnByb3RvdHlwZSA9IHsKCQkvKioKCQkgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBhIHByb21pc2UgaXMKCQkgKiBmdWxmaWxsZWQgb3IgcmVqZWN0ZWQuICBPcHRpb25hbGx5IGFsc28gcmVnaXN0ZXIgYSBwcm9ncmVzcyBoYW5kbGVyLgoJCSAqIFNob3J0Y3V0IGZvciAudGhlbihvbkZ1bGZpbGxlZE9yUmVqZWN0ZWQsIG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25Qcm9ncmVzcykKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkT3JSZWplY3RlZF0KCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdCgkJICogQHJldHVybiB7UHJvbWlzZX0KCQkgKi8KCQlhbHdheXM6IGZ1bmN0aW9uKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQlyZXR1cm4gdGhpcy50aGVuKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKTsKCQl9LAoKCQkvKioKCQkgKiBSZWdpc3RlciBhIHJlamVjdGlvbiBoYW5kbGVyLiAgU2hvcnRjdXQgZm9yIC50aGVuKHVuZGVmaW5lZCwgb25SZWplY3RlZCkKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gb25SZWplY3RlZAoJCSAqIEByZXR1cm4ge1Byb21pc2V9CgkJICovCgkJb3RoZXJ3aXNlOiBmdW5jdGlvbihvblJlamVjdGVkKSB7CgkJCXJldHVybiB0aGlzLnRoZW4odW5kZWYsIG9uUmVqZWN0ZWQpOwoJCX0sCgoJCS8qKgoJCSAqIFNob3J0Y3V0IGZvciAudGhlbihmdW5jdGlvbigpIHsgcmV0dXJuIHZhbHVlOyB9KQoJCSAqIEBwYXJhbSAgeyp9IHZhbHVlCgkJICogQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQ6CgkJICogIC0gaXMgZnVsZmlsbGVkIGlmIHZhbHVlIGlzIG5vdCBhIHByb21pc2UsIG9yCgkJICogIC0gaWYgdmFsdWUgaXMgYSBwcm9taXNlLCB3aWxsIGZ1bGZpbGwgd2l0aCBpdHMgdmFsdWUsIG9yIHJlamVjdAoJCSAqICAgIHdpdGggaXRzIHJlYXNvbi4KCQkgKi8KCQl5aWVsZDogZnVuY3Rpb24odmFsdWUpIHsKCQkJcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbigpIHsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfSk7CgkJfSwKCgkJLyoqCgkJICogQXNzdW1lcyB0aGF0IHRoaXMgcHJvbWlzZSB3aWxsIGZ1bGZpbGwgd2l0aCBhbiBhcnJheSwgYW5kIGFycmFuZ2VzCgkJICogZm9yIHRoZSBvbkZ1bGZpbGxlZCB0byBiZSBjYWxsZWQgd2l0aCB0aGUgYXJyYXkgYXMgaXRzIGFyZ3VtZW50IGxpc3QKCQkgKiBpLmUuIG9uRnVsZmlsbGVkLnNwcmVhZCh1bmRlZmluZWQsIGFycmF5KS4KCQkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBvbkZ1bGZpbGxlZCBmdW5jdGlvbiB0byByZWNlaXZlIHNwcmVhZCBhcmd1bWVudHMKCQkgKiBAcmV0dXJuIHtQcm9taXNlfQoJCSAqLwoJCXNwcmVhZDogZnVuY3Rpb24ob25GdWxmaWxsZWQpIHsKCQkJcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbihhcnJheSkgewoJCQkJLy8gYXJyYXkgbWF5IGNvbnRhaW4gcHJvbWlzZXMsIHNvIHJlc29sdmUgaXRzIGNvbnRlbnRzLgoJCQkJcmV0dXJuIGFsbChhcnJheSwgZnVuY3Rpb24oYXJyYXkpIHsKCQkJCQlyZXR1cm4gb25GdWxmaWxsZWQuYXBwbHkodW5kZWYsIGFycmF5KTsKCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGFuIGFscmVhZHktcmVzb2x2ZWQgcHJvbWlzZSBmb3IgdGhlIHN1cHBsaWVkIHZhbHVlCgkgKiBAcHJpdmF0ZQoJICoKCSAqIEBwYXJhbSB7Kn0gdmFsdWUKCSAqIEByZXR1cm4ge1Byb21pc2V9IGZ1bGZpbGxlZCBwcm9taXNlCgkgKi8KCWZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewoJCXZhciBwID0gbmV3IFByb21pc2UoZnVuY3Rpb24ob25GdWxmaWxsZWQpIHsKCQkJLy8gVE9ETzogUHJvbWlzZXMvQSsgY2hlY2sgdHlwZW9mIG9uRnVsZmlsbGVkCgkJCXRyeSB7CgkJCQlyZXR1cm4gcmVzb2x2ZShvbkZ1bGZpbGxlZCA/IG9uRnVsZmlsbGVkKHZhbHVlKSA6IHZhbHVlKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlyZXR1cm4gcmVqZWN0ZWQoZSk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHA7Cgl9CgoJLyoqCgkgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZWplY3RlZCB7QGxpbmsgUHJvbWlzZX0gd2l0aCB0aGUgc3VwcGxpZWQKCSAqIHJlamVjdGlvbiByZWFzb24uCgkgKiBAcHJpdmF0ZQoJICoKCSAqIEBwYXJhbSB7Kn0gcmVhc29uCgkgKiBAcmV0dXJuIHtQcm9taXNlfSByZWplY3RlZCBwcm9taXNlCgkgKi8KCWZ1bmN0aW9uIHJlamVjdGVkKHJlYXNvbikgewoJCXZhciBwID0gbmV3IFByb21pc2UoZnVuY3Rpb24oXywgb25SZWplY3RlZCkgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25SZWplY3RlZAoJCQl0cnkgewoJCQkJcmV0dXJuIG9uUmVqZWN0ZWQgPyByZXNvbHZlKG9uUmVqZWN0ZWQocmVhc29uKSkgOiByZWplY3RlZChyZWFzb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJldHVybiByZWplY3RlZChlKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gcDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYSBuZXcsIERlZmVycmVkIHdpdGggZnVsbHkgaXNvbGF0ZWQgcmVzb2x2ZXIgYW5kIHByb21pc2UgcGFydHMsCgkgKiBlaXRoZXIgb3IgYm90aCBvZiB3aGljaCBtYXkgYmUgZ2l2ZW4gb3V0IHNhZmVseSB0byBjb25zdW1lcnMuCgkgKiBUaGUgRGVmZXJyZWQgaXRzZWxmIGhhcyB0aGUgZnVsbCBBUEk6IHJlc29sdmUsIHJlamVjdCwgcHJvZ3Jlc3MsIGFuZAoJICogdGhlbi4gVGhlIHJlc29sdmVyIGhhcyByZXNvbHZlLCByZWplY3QsIGFuZCBwcm9ncmVzcy4gIFRoZSBwcm9taXNlCgkgKiBvbmx5IGhhcyB0aGVuLgoJICoKCSAqIEByZXR1cm4ge0RlZmVycmVkfQoJICovCglmdW5jdGlvbiBkZWZlcigpIHsKCQl2YXIgZGVmZXJyZWQsIHByb21pc2UsIGhhbmRsZXJzLCBwcm9ncmVzc0hhbmRsZXJzLAoJCQlfdGhlbiwgX3Byb2dyZXNzLCBfcmVzb2x2ZTsKCgkJLyoqCgkJICogVGhlIHByb21pc2UgZm9yIHRoZSBuZXcgZGVmZXJyZWQKCQkgKiBAdHlwZSB7UHJvbWlzZX0KCQkgKi8KCQlwcm9taXNlID0gbmV3IFByb21pc2UodGhlbik7CgoJCS8qKgoJCSAqIFRoZSBmdWxsIERlZmVycmVkIG9iamVjdCwgd2l0aCB7QGxpbmsgUHJvbWlzZX0gYW5kIHtAbGluayBSZXNvbHZlcn0gcGFydHMKCQkgKiBAY2xhc3MgRGVmZXJyZWQKCQkgKiBAbmFtZSBEZWZlcnJlZAoJCSAqLwoJCWRlZmVycmVkID0gewoJCQl0aGVuOiAgICAgdGhlbiwgLy8gREVQUkVDQVRFRDogdXNlIGRlZmVycmVkLnByb21pc2UudGhlbgoJCQlyZXNvbHZlOiAgcHJvbWlzZVJlc29sdmUsCgkJCXJlamVjdDogICBwcm9taXNlUmVqZWN0LAoJCQkvLyBUT0RPOiBDb25zaWRlciByZW5hbWluZyBwcm9ncmVzcygpIHRvIG5vdGlmeSgpCgkJCXByb2dyZXNzOiBwcm9taXNlUHJvZ3Jlc3MsCgoJCQlwcm9taXNlOiAgcHJvbWlzZSwKCgkJCXJlc29sdmVyOiB7CgkJCQlyZXNvbHZlOiAgcHJvbWlzZVJlc29sdmUsCgkJCQlyZWplY3Q6ICAgcHJvbWlzZVJlamVjdCwKCQkJCXByb2dyZXNzOiBwcm9taXNlUHJvZ3Jlc3MKCQkJfQoJCX07CgoJCWhhbmRsZXJzID0gW107CgkJcHJvZ3Jlc3NIYW5kbGVycyA9IFtdOwoKCQkvKioKCQkgKiBQcmUtcmVzb2x1dGlvbiB0aGVuKCkgdGhhdCBhZGRzIHRoZSBzdXBwbGllZCBjYWxsYmFjaywgZXJyYmFjaywgYW5kIHByb2diYWNrCgkJICogZnVuY3Rpb25zIHRvIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVycwoJCSAqIEBwcml2YXRlCgkJICoKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSByZXNvbHV0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkJICovCgkJX3RoZW4gPSBmdW5jdGlvbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MKCQkJdmFyIGRlZmVycmVkLCBwcm9ncmVzc0hhbmRsZXI7CgoJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQlwcm9ncmVzc0hhbmRsZXIgPSB0eXBlb2Ygb25Qcm9ncmVzcyA9PT0gJ2Z1bmN0aW9uJwoJCQkJPyBmdW5jdGlvbih1cGRhdGUpIHsKCQkJCQl0cnkgewoJCQkJCQkvLyBBbGxvdyBwcm9ncmVzcyBoYW5kbGVyIHRvIHRyYW5zZm9ybSBwcm9ncmVzcyBldmVudAoJCQkJCQlkZWZlcnJlZC5wcm9ncmVzcyhvblByb2dyZXNzKHVwZGF0ZSkpOwoJCQkJCX0gY2F0Y2goZSkgewoJCQkJCQkvLyBVc2UgY2F1Z2h0IHZhbHVlIGFzIHByb2dyZXNzCgkJCQkJCWRlZmVycmVkLnByb2dyZXNzKGUpOwoJCQkJCX0KCQkJCX0KCQkJCTogZnVuY3Rpb24odXBkYXRlKSB7IGRlZmVycmVkLnByb2dyZXNzKHVwZGF0ZSk7IH07CgoJCQloYW5kbGVycy5wdXNoKGZ1bmN0aW9uKHByb21pc2UpIHsKCQkJCXByb21pc2UudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkKCQkJCQkudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QsIHByb2dyZXNzSGFuZGxlcik7CgkJCX0pOwoKCQkJcHJvZ3Jlc3NIYW5kbGVycy5wdXNoKHByb2dyZXNzSGFuZGxlcik7CgoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKCQl9OwoKCQkvKioKCQkgKiBJc3N1ZSBhIHByb2dyZXNzIGV2ZW50LCBub3RpZnlpbmcgYWxsIHByb2dyZXNzIGxpc3RlbmVycwoJCSAqIEBwcml2YXRlCgkJICogQHBhcmFtIHsqfSB1cGRhdGUgcHJvZ3Jlc3MgZXZlbnQgcGF5bG9hZCB0byBwYXNzIHRvIGFsbCBsaXN0ZW5lcnMKCQkgKi8KCQlfcHJvZ3Jlc3MgPSBmdW5jdGlvbih1cGRhdGUpIHsKCQkJcHJvY2Vzc1F1ZXVlKHByb2dyZXNzSGFuZGxlcnMsIHVwZGF0ZSk7CgkJCXJldHVybiB1cGRhdGU7CgkJfTsKCgkJLyoqCgkJICogVHJhbnNpdGlvbiBmcm9tIHByZS1yZXNvbHV0aW9uIHN0YXRlIHRvIHBvc3QtcmVzb2x1dGlvbiBzdGF0ZSwgbm90aWZ5aW5nCgkJICogYWxsIGxpc3RlbmVycyBvZiB0aGUgcmVzb2x1dGlvbiBvciByZWplY3Rpb24KCQkgKiBAcHJpdmF0ZQoJCSAqIEBwYXJhbSB7Kn0gdmFsdWUgdGhlIHZhbHVlIG9mIHRoaXMgZGVmZXJyZWQKCQkgKi8KCQlfcmVzb2x2ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXZhbHVlID0gcmVzb2x2ZSh2YWx1ZSk7CgoJCQkvLyBSZXBsYWNlIF90aGVuIHdpdGggb25lIHRoYXQgZGlyZWN0bHkgbm90aWZpZXMgd2l0aCB0aGUgcmVzdWx0LgoJCQlfdGhlbiA9IHZhbHVlLnRoZW47CgkJCS8vIFJlcGxhY2UgX3Jlc29sdmUgc28gdGhhdCB0aGlzIERlZmVycmVkIGNhbiBvbmx5IGJlIHJlc29sdmVkIG9uY2UKCQkJX3Jlc29sdmUgPSByZXNvbHZlOwoJCQkvLyBNYWtlIF9wcm9ncmVzcyBhIG5vb3AsIHRvIGRpc2FsbG93IHByb2dyZXNzIGZvciB0aGUgcmVzb2x2ZWQgcHJvbWlzZS4KCQkJX3Byb2dyZXNzID0gbm9vcDsKCgkJCS8vIE5vdGlmeSBoYW5kbGVycwoJCQlwcm9jZXNzUXVldWUoaGFuZGxlcnMsIHZhbHVlKTsKCgkJCS8vIEZyZWUgcHJvZ3Jlc3NIYW5kbGVycyBhcnJheSBzaW5jZSB3ZSdsbCBuZXZlciBpc3N1ZSBwcm9ncmVzcyBldmVudHMKCQkJcHJvZ3Jlc3NIYW5kbGVycyA9IGhhbmRsZXJzID0gdW5kZWY7CgoJCQlyZXR1cm4gdmFsdWU7CgkJfTsKCgkJcmV0dXJuIGRlZmVycmVkOwoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF90aGVuIHRvIGJlIHJlcGxhY2VkIHNhZmVseQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCQkgKiBAcmV0dXJuIHtQcm9taXNlfSBuZXcgcHJvbWlzZQoJCSAqLwoJCWZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCQkJLy8gVE9ETzogUHJvbWlzZXMvQSsgY2hlY2sgdHlwZW9mIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzCgkJCXJldHVybiBfdGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9yZXNvbHZlIHRvIGJlIHJlcGxhY2VkCgkJICovCgkJZnVuY3Rpb24gcHJvbWlzZVJlc29sdmUodmFsKSB7CgkJCXJldHVybiBfcmVzb2x2ZSh2YWwpOwoJCX0KCgkJLyoqCgkJICogV3JhcHBlciB0byBhbGxvdyBfcmVqZWN0IHRvIGJlIHJlcGxhY2VkCgkJICovCgkJZnVuY3Rpb24gcHJvbWlzZVJlamVjdChlcnIpIHsKCQkJcmV0dXJuIF9yZXNvbHZlKHJlamVjdGVkKGVycikpOwoJCX0KCgkJLyoqCgkJICogV3JhcHBlciB0byBhbGxvdyBfcHJvZ3Jlc3MgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUHJvZ3Jlc3ModXBkYXRlKSB7CgkJCXJldHVybiBfcHJvZ3Jlc3ModXBkYXRlKTsKCQl9Cgl9CgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZSBvciBub3QuICBVc2VzIHRoZSBmZWF0dXJlCgkgKiB0ZXN0IGZyb20gaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMvQSB0byBkZXRlcm1pbmUgaWYKCSAqIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZS4KCSAqCgkgKiBAcGFyYW0geyp9IHByb21pc2VPclZhbHVlIGFueXRoaW5nCgkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHtAbGluayBQcm9taXNlfQoJICovCglmdW5jdGlvbiBpc1Byb21pc2UocHJvbWlzZU9yVmFsdWUpIHsKCQlyZXR1cm4gcHJvbWlzZU9yVmFsdWUgJiYgdHlwZW9mIHByb21pc2VPclZhbHVlLnRoZW4gPT09ICdmdW5jdGlvbic7Cgl9CgoJLyoqCgkgKiBJbml0aWF0ZXMgYSBjb21wZXRpdGl2ZSByYWNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4KCSAqIGhvd01hbnkgb2YgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMgaGF2ZSByZXNvbHZlZCwgb3Igd2lsbCByZWplY3Qgd2hlbgoJICogaXQgYmVjb21lcyBpbXBvc3NpYmxlIGZvciBob3dNYW55IHRvIHJlc29sdmUsIGZvciBleGFtcGxlLCB3aGVuCgkgKiAocHJvbWlzZXNPclZhbHVlcy5sZW5ndGggLSBob3dNYW55KSArIDEgaW5wdXQgcHJvbWlzZXMgcmVqZWN0LgoJICoKCSAqIEBwYXJhbSB7QXJyYXl9IHByb21pc2VzT3JWYWx1ZXMgYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CgkgKiAgICAgIG9mIHByb21pc2VzIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSBob3dNYW55IHtudW1iZXJ9IG51bWJlciBvZiBwcm9taXNlc09yVmFsdWVzIHRvIHJlc29sdmUKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhbiBhcnJheSBvZiBob3dNYW55IHZhbHVlcyB0aGF0CgkgKiByZXNvbHZlZCBmaXJzdCwgb3Igd2lsbCByZWplY3Qgd2l0aCBhbiBhcnJheSBvZiAocHJvbWlzZXNPclZhbHVlcy5sZW5ndGggLSBob3dNYW55KSArIDEKCSAqIHJlamVjdGlvbiByZWFzb25zLgoJICovCglmdW5jdGlvbiBzb21lKHByb21pc2VzT3JWYWx1ZXMsIGhvd01hbnksIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgoJCWNoZWNrQ2FsbGJhY2tzKDIsIGFyZ3VtZW50cyk7CgoJCXJldHVybiB3aGVuKHByb21pc2VzT3JWYWx1ZXMsIGZ1bmN0aW9uKHByb21pc2VzT3JWYWx1ZXMpIHsKCgkJCXZhciB0b1Jlc29sdmUsIHRvUmVqZWN0LCB2YWx1ZXMsIHJlYXNvbnMsIGRlZmVycmVkLCBmdWxmaWxsT25lLCByZWplY3RPbmUsIHByb2dyZXNzLCBsZW4sIGk7CgoJCQlsZW4gPSBwcm9taXNlc09yVmFsdWVzLmxlbmd0aCA+Pj4gMDsKCgkJCXRvUmVzb2x2ZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKGhvd01hbnksIGxlbikpOwoJCQl2YWx1ZXMgPSBbXTsKCgkJCXRvUmVqZWN0ID0gKGxlbiAtIHRvUmVzb2x2ZSkgKyAxOwoJCQlyZWFzb25zID0gW107CgoJCQlkZWZlcnJlZCA9IGRlZmVyKCk7CgoJCQkvLyBObyBpdGVtcyBpbiB0aGUgaW5wdXQsIHJlc29sdmUgaW1tZWRpYXRlbHkKCQkJaWYgKCF0b1Jlc29sdmUpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUodmFsdWVzKTsKCgkJCX0gZWxzZSB7CgkJCQlwcm9ncmVzcyA9IGRlZmVycmVkLnByb2dyZXNzOwoKCQkJCXJlamVjdE9uZSA9IGZ1bmN0aW9uKHJlYXNvbikgewoJCQkJCXJlYXNvbnMucHVzaChyZWFzb24pOwoJCQkJCWlmKCEtLXRvUmVqZWN0KSB7CgkJCQkJCWZ1bGZpbGxPbmUgPSByZWplY3RPbmUgPSBub29wOwoJCQkJCQlkZWZlcnJlZC5yZWplY3QocmVhc29ucyk7CgkJCQkJfQoJCQkJfTsKCgkJCQlmdWxmaWxsT25lID0gZnVuY3Rpb24odmFsKSB7CgkJCQkJLy8gVGhpcyBvcmRlcnMgdGhlIHZhbHVlcyBiYXNlZCBvbiBwcm9taXNlIHJlc29sdXRpb24gb3JkZXIKCQkJCQkvLyBBbm90aGVyIHN0cmF0ZWd5IHdvdWxkIGJlIHRvIHVzZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24gb2YKCQkJCQkvLyB0aGUgY29ycmVzcG9uZGluZyBwcm9taXNlLgoJCQkJCXZhbHVlcy5wdXNoKHZhbCk7CgoJCQkJCWlmICghLS10b1Jlc29sdmUpIHsKCQkJCQkJZnVsZmlsbE9uZSA9IHJlamVjdE9uZSA9IG5vb3A7CgkJCQkJCWRlZmVycmVkLnJlc29sdmUodmFsdWVzKTsKCQkJCQl9CgkJCQl9OwoKCQkJCWZvcihpID0gMDsgaSA8IGxlbjsgKytpKSB7CgkJCQkJaWYoaSBpbiBwcm9taXNlc09yVmFsdWVzKSB7CgkJCQkJCXdoZW4ocHJvbWlzZXNPclZhbHVlc1tpXSwgZnVsZmlsbGVyLCByZWplY3RlciwgcHJvZ3Jlc3MpOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRlZmVycmVkLnRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpOwoKCQkJZnVuY3Rpb24gcmVqZWN0ZXIocmVhc29uKSB7CgkJCQlyZWplY3RPbmUocmVhc29uKTsKCQkJfQoKCQkJZnVuY3Rpb24gZnVsZmlsbGVyKHZhbCkgewoJCQkJZnVsZmlsbE9uZSh2YWwpOwoJCQl9CgoJCX0pOwoJfQoKCS8qKgoJICogSW5pdGlhdGVzIGEgY29tcGV0aXRpdmUgcmFjZSwgcmV0dXJuaW5nIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB3aGVuCgkgKiBhbnkgb25lIG9mIHRoZSBzdXBwbGllZCBwcm9taXNlc09yVmFsdWVzIGhhcyByZXNvbHZlZCBvciB3aWxsIHJlamVjdCB3aGVuCgkgKiAqYWxsKiBwcm9taXNlc09yVmFsdWVzIGhhdmUgcmVqZWN0ZWQuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlc09yVmFsdWVzIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB0byB0aGUgdmFsdWUgdGhhdCByZXNvbHZlZCBmaXJzdCwgb3IKCSAqIHdpbGwgcmVqZWN0IHdpdGggYW4gYXJyYXkgb2YgYWxsIHJlamVjdGVkIGlucHV0cy4KCSAqLwoJZnVuY3Rpb24gYW55KHByb21pc2VzT3JWYWx1ZXMsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgoJCWZ1bmN0aW9uIHVud3JhcFNpbmdsZVJlc3VsdCh2YWwpIHsKCQkJcmV0dXJuIG9uRnVsZmlsbGVkID8gb25GdWxmaWxsZWQodmFsWzBdKSA6IHZhbFswXTsKCQl9CgoJCXJldHVybiBzb21lKHByb21pc2VzT3JWYWx1ZXMsIDEsIHVud3JhcFNpbmdsZVJlc3VsdCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBSZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9ubHkgb25jZSBhbGwgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMKCSAqIGhhdmUgcmVzb2x2ZWQuIFRoZSByZXNvbHV0aW9uIHZhbHVlIG9mIHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgYW4gYXJyYXkKCSAqIGNvbnRhaW5pbmcgdGhlIHJlc29sdXRpb24gdmFsdWVzIG9mIGVhY2ggb2YgdGhlIHByb21pc2VzT3JWYWx1ZXMuCgkgKiBAbWVtYmVyT2Ygd2hlbgoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZXNPclZhbHVlcyBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uRnVsZmlsbGVkXSByZXNvbHV0aW9uIGhhbmRsZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10gcHJvZ3Jlc3MgaGFuZGxlcgoJICogQHJldHVybnMge1Byb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGFsbChwcm9taXNlc09yVmFsdWVzLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCWNoZWNrQ2FsbGJhY2tzKDEsIGFyZ3VtZW50cyk7CgkJcmV0dXJuIG1hcChwcm9taXNlc09yVmFsdWVzLCBpZGVudGl0eSkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7Cgl9CgoJLyoqCgkgKiBKb2lucyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHJldHVybmVkIHByb21pc2UuCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGZ1bGZpbGwgd2hlbiAqYWxsKiB0aGUgaW5wdXQgcHJvbWlzZXMKCSAqIGhhdmUgZnVsZmlsbGVkLCBvciB3aWxsIHJlamVjdCB3aGVuICphbnkgb25lKiBvZiB0aGUgaW5wdXQgcHJvbWlzZXMgcmVqZWN0cy4KCSAqLwoJZnVuY3Rpb24gam9pbigvKiAuLi5wcm9taXNlcyAqLykgewoJCXJldHVybiBtYXAoYXJndW1lbnRzLCBpZGVudGl0eSk7Cgl9CgoJLyoqCgkgKiBUcmFkaXRpb25hbCBtYXAgZnVuY3Rpb24sIHNpbWlsYXIgdG8gYEFycmF5LnByb3RvdHlwZS5tYXAoKWAsIGJ1dCBhbGxvd3MKCSAqIGlucHV0IHRvIGNvbnRhaW4ge0BsaW5rIFByb21pc2V9cyBhbmQvb3IgdmFsdWVzLCBhbmQgbWFwRnVuYyBtYXkgcmV0dXJuCgkgKiBlaXRoZXIgYSB2YWx1ZSBvciBhIHtAbGluayBQcm9taXNlfQoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZSBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzCgkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBtYXBGdW5jIG1hcHBpbmcgZnVuY3Rpb24gbWFwRnVuYyh2YWx1ZSkgd2hpY2ggbWF5IHJldHVybgoJICogICAgICBlaXRoZXIgYSB7QGxpbmsgUHJvbWlzZX0gb3IgdmFsdWUKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBhIHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhbiBhcnJheSBjb250YWluaW5nCgkgKiAgICAgIHRoZSBtYXBwZWQgb3V0cHV0IHZhbHVlcy4KCSAqLwoJZnVuY3Rpb24gbWFwKHByb21pc2UsIG1hcEZ1bmMpIHsKCQlyZXR1cm4gd2hlbihwcm9taXNlLCBmdW5jdGlvbihhcnJheSkgewoJCQl2YXIgcmVzdWx0cywgbGVuLCB0b1Jlc29sdmUsIHJlc29sdmUsIGksIGQ7CgoJCQkvLyBTaW5jZSB3ZSBrbm93IHRoZSByZXN1bHRpbmcgbGVuZ3RoLCB3ZSBjYW4gcHJlYWxsb2NhdGUgdGhlIHJlc3VsdHMKCQkJLy8gYXJyYXkgdG8gYXZvaWQgYXJyYXkgZXhwYW5zaW9ucy4KCQkJdG9SZXNvbHZlID0gbGVuID0gYXJyYXkubGVuZ3RoID4+PiAwOwoJCQlyZXN1bHRzID0gW107CgkJCWQgPSBkZWZlcigpOwoKCQkJaWYoIXRvUmVzb2x2ZSkgewoJCQkJZC5yZXNvbHZlKHJlc3VsdHMpOwoJCQl9IGVsc2UgewoKCQkJCXJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlT25lKGl0ZW0sIGkpIHsKCQkJCQl3aGVuKGl0ZW0sIG1hcEZ1bmMpLnRoZW4oZnVuY3Rpb24obWFwcGVkKSB7CgkJCQkJCXJlc3VsdHNbaV0gPSBtYXBwZWQ7CgoJCQkJCQlpZighLS10b1Jlc29sdmUpIHsKCQkJCQkJCWQucmVzb2x2ZShyZXN1bHRzKTsKCQkJCQkJfQoJCQkJCX0sIGQucmVqZWN0KTsKCQkJCX07CgoJCQkJLy8gU2luY2UgbWFwRnVuYyBtYXkgYmUgYXN5bmMsIGdldCBhbGwgaW52b2NhdGlvbnMgb2YgaXQgaW50byBmbGlnaHQKCQkJCWZvcihpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCQkJaWYoaSBpbiBhcnJheSkgewoJCQkJCQlyZXNvbHZlKGFycmF5W2ldLCBpKTsKCQkJCQl9IGVsc2UgewoJCQkJCQktLXRvUmVzb2x2ZTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gZC5wcm9taXNlOwoKCQl9KTsKCX0KCgkvKioKCSAqIFRyYWRpdGlvbmFsIHJlZHVjZSBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLnJlZHVjZSgpYCwgYnV0CgkgKiBpbnB1dCBtYXkgY29udGFpbiBwcm9taXNlcyBhbmQvb3IgdmFsdWVzLCBhbmQgcmVkdWNlRnVuYwoJICogbWF5IHJldHVybiBlaXRoZXIgYSB2YWx1ZSBvciBhIHByb21pc2UsICphbmQqIGluaXRpYWxWYWx1ZSBtYXkKCSAqIGJlIGEgcHJvbWlzZSBmb3IgdGhlIHN0YXJ0aW5nIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7QXJyYXl8UHJvbWlzZX0gcHJvbWlzZSBhcnJheSBvciBwcm9taXNlIGZvciBhbiBhcnJheSBvZiBhbnl0aGluZywKCSAqICAgICAgbWF5IGNvbnRhaW4gYSBtaXggb2YgcHJvbWlzZXMgYW5kIHZhbHVlcy4KCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlZHVjZUZ1bmMgcmVkdWNlIGZ1bmN0aW9uIHJlZHVjZShjdXJyZW50VmFsdWUsIG5leHRWYWx1ZSwgaW5kZXgsIHRvdGFsKSwKCSAqICAgICAgd2hlcmUgdG90YWwgaXMgdGhlIHRvdGFsIG51bWJlciBvZiBpdGVtcyBiZWluZyByZWR1Y2VkLCBhbmQgd2lsbCBiZSB0aGUgc2FtZQoJICogICAgICBpbiBlYWNoIGNhbGwgdG8gcmVkdWNlRnVuYy4KCSAqIEByZXR1cm5zIHtQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byB0aGUgZmluYWwgcmVkdWNlZCB2YWx1ZQoJICovCglmdW5jdGlvbiByZWR1Y2UocHJvbWlzZSwgcmVkdWNlRnVuYyAvKiwgaW5pdGlhbFZhbHVlICovKSB7CgkJdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgoJCXJldHVybiB3aGVuKHByb21pc2UsIGZ1bmN0aW9uKGFycmF5KSB7CgkJCXZhciB0b3RhbDsKCgkJCXRvdGFsID0gYXJyYXkubGVuZ3RoOwoKCQkJLy8gV3JhcCB0aGUgc3VwcGxpZWQgcmVkdWNlRnVuYyB3aXRoIG9uZSB0aGF0IGhhbmRsZXMgcHJvbWlzZXMgYW5kIHRoZW4KCQkJLy8gZGVsZWdhdGVzIHRvIHRoZSBzdXBwbGllZC4KCQkJYXJnc1swXSA9IGZ1bmN0aW9uIChjdXJyZW50LCB2YWwsIGkpIHsKCQkJCXJldHVybiB3aGVuKGN1cnJlbnQsIGZ1bmN0aW9uIChjKSB7CgkJCQkJcmV0dXJuIHdoZW4odmFsLCBmdW5jdGlvbiAodmFsdWUpIHsKCQkJCQkJcmV0dXJuIHJlZHVjZUZ1bmMoYywgdmFsdWUsIGksIHRvdGFsKTsKCQkJCQl9KTsKCQkJCX0pOwoJCQl9OwoKCQkJcmV0dXJuIHJlZHVjZUFycmF5LmFwcGx5KGFycmF5LCBhcmdzKTsKCQl9KTsKCX0KCgkvKioKCSAqIEVuc3VyZSB0aGF0IHJlc29sdXRpb24gb2YgcHJvbWlzZU9yVmFsdWUgd2lsbCB0cmlnZ2VyIHJlc29sdmVyIHdpdGggdGhlCgkgKiB2YWx1ZSBvciByZWFzb24gb2YgcHJvbWlzZU9yVmFsdWUsIG9yIGluc3RlYWQgd2l0aCByZXNvbHZlVmFsdWUgaWYgaXQgaXMgcHJvdmlkZWQuCgkgKgoJICogQHBhcmFtIHByb21pc2VPclZhbHVlCgkgKiBAcGFyYW0ge09iamVjdH0gcmVzb2x2ZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlc29sdmVyLnJlc29sdmUKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IHJlc29sdmVyLnJlamVjdAoJICogQHBhcmFtIHsqfSBbcmVzb2x2ZVZhbHVlXQoJICogQHJldHVybnMge1Byb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGNoYWluKHByb21pc2VPclZhbHVlLCByZXNvbHZlciwgcmVzb2x2ZVZhbHVlKSB7CgkJdmFyIHVzZVJlc29sdmVWYWx1ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwoKCQlyZXR1cm4gd2hlbihwcm9taXNlT3JWYWx1ZSwKCQkJZnVuY3Rpb24odmFsKSB7CgkJCQl2YWwgPSB1c2VSZXNvbHZlVmFsdWUgPyByZXNvbHZlVmFsdWUgOiB2YWw7CgkJCQlyZXNvbHZlci5yZXNvbHZlKHZhbCk7CgkJCQlyZXR1cm4gdmFsOwoJCQl9LAoJCQlmdW5jdGlvbihyZWFzb24pIHsKCQkJCXJlc29sdmVyLnJlamVjdChyZWFzb24pOwoJCQkJcmV0dXJuIHJlamVjdGVkKHJlYXNvbik7CgkJCX0sCgkJCXJlc29sdmVyLnByb2dyZXNzCgkJKTsKCX0KCgkvLwoJLy8gVXRpbGl0eSBmdW5jdGlvbnMKCS8vCgoJLyoqCgkgKiBBcHBseSBhbGwgZnVuY3Rpb25zIGluIHF1ZXVlIHRvIHZhbHVlCgkgKiBAcGFyYW0ge0FycmF5fSBxdWV1ZSBhcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZQoJICogQHBhcmFtIHsqfSB2YWx1ZSBhcmd1bWVudCBwYXNzZWQgdG8gZWFjaCBmdW5jdGlvbgoJICovCglmdW5jdGlvbiBwcm9jZXNzUXVldWUocXVldWUsIHZhbHVlKSB7CgkJdmFyIGhhbmRsZXIsIGkgPSAwOwoKCQl3aGlsZSAoaGFuZGxlciA9IHF1ZXVlW2krK10pIHsKCQkJaGFuZGxlcih2YWx1ZSk7CgkJfQoJfQoKCS8qKgoJICogSGVscGVyIHRoYXQgY2hlY2tzIGFycmF5T2ZDYWxsYmFja3MgdG8gZW5zdXJlIHRoYXQgZWFjaCBlbGVtZW50IGlzIGVpdGhlcgoJICogYSBmdW5jdGlvbiwgb3IgbnVsbCBvciB1bmRlZmluZWQuCgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IGluZGV4IGF0IHdoaWNoIHRvIHN0YXJ0IGNoZWNraW5nIGl0ZW1zIGluIGFycmF5T2ZDYWxsYmFja3MKCSAqIEBwYXJhbSB7QXJyYXl9IGFycmF5T2ZDYWxsYmFja3MgYXJyYXkgdG8gY2hlY2sKCSAqIEB0aHJvd3Mge0Vycm9yfSBpZiBhbnkgZWxlbWVudCBvZiBhcnJheU9mQ2FsbGJhY2tzIGlzIHNvbWV0aGluZyBvdGhlciB0aGFuCgkgKiBhIGZ1bmN0aW9ucywgbnVsbCwgb3IgdW5kZWZpbmVkLgoJICovCglmdW5jdGlvbiBjaGVja0NhbGxiYWNrcyhzdGFydCwgYXJyYXlPZkNhbGxiYWNrcykgewoJCS8vIFRPRE86IFByb21pc2VzL0ErIHVwZGF0ZSB0eXBlIGNoZWNraW5nIGFuZCBkb2NzCgkJdmFyIGFyZywgaSA9IGFycmF5T2ZDYWxsYmFja3MubGVuZ3RoOwoKCQl3aGlsZShpID4gc3RhcnQpIHsKCQkJYXJnID0gYXJyYXlPZkNhbGxiYWNrc1stLWldOwoKCQkJaWYgKGFyZyAhPSBudWxsICYmIHR5cGVvZiBhcmcgIT0gJ2Z1bmN0aW9uJykgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdhcmcgJytpKycgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgkJCX0KCQl9Cgl9CgoJLyoqCgkgKiBOby1PcCBmdW5jdGlvbiB1c2VkIGluIG1ldGhvZCByZXBsYWNlbWVudAoJICogQHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gbm9vcCgpIHt9CgoJc2xpY2UgPSBbXS5zbGljZTsKCgkvLyBFUzUgcmVkdWNlIGltcGxlbWVudGF0aW9uIGlmIG5hdGl2ZSBub3QgYXZhaWxhYmxlCgkvLyBTZWU6IGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjQuNC4yMSBhcyB0aGVyZSBhcmUgbWFueQoJLy8gc3BlY2lmaWNzIGFuZCBlZGdlIGNhc2VzLgoJcmVkdWNlQXJyYXkgPSBbXS5yZWR1Y2UgfHwKCQlmdW5jdGlvbihyZWR1Y2VGdW5jIC8qLCBpbml0aWFsVmFsdWUgKi8pIHsKCQkJLypqc2hpbnQgbWF4Y29tcGxleGl0eTogNyovCgoJCQkvLyBFUzUgZGljdGF0ZXMgdGhhdCByZWR1Y2UubGVuZ3RoID09PSAxCgoJCQkvLyBUaGlzIGltcGxlbWVudGF0aW9uIGRldmlhdGVzIGZyb20gRVM1IHNwZWMgaW4gdGhlIGZvbGxvd2luZyB3YXlzOgoJCQkvLyAxLiBJdCBkb2VzIG5vdCBjaGVjayBpZiByZWR1Y2VGdW5jIGlzIGEgQ2FsbGFibGUKCgkJCXZhciBhcnIsIGFyZ3MsIHJlZHVjZWQsIGxlbiwgaTsKCgkJCWkgPSAwOwoJCQkvLyBUaGlzIGdlbmVyYXRlcyBhIGpzaGludCB3YXJuaW5nLCBkZXNwaXRlIGJlaW5nIHZhbGlkCgkJCS8vICJNaXNzaW5nICduZXcnIHByZWZpeCB3aGVuIGludm9raW5nIGEgY29uc3RydWN0b3IuIgoJCQkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pzaGludC9qc2hpbnQvaXNzdWVzLzM5MgoJCQlhcnIgPSBPYmplY3QodGhpcyk7CgkJCWxlbiA9IGFyci5sZW5ndGggPj4+IDA7CgkJCWFyZ3MgPSBhcmd1bWVudHM7CgoJCQkvLyBJZiBubyBpbml0aWFsVmFsdWUsIHVzZSBmaXJzdCBpdGVtIG9mIGFycmF5ICh3ZSBrbm93IGxlbmd0aCAhPT0gMCBoZXJlKQoJCQkvLyBhbmQgYWRqdXN0IGkgdG8gc3RhcnQgYXQgc2Vjb25kIGl0ZW0KCQkJaWYoYXJncy5sZW5ndGggPD0gMSkgewoJCQkJLy8gU2tpcCB0byB0aGUgZmlyc3QgcmVhbCBlbGVtZW50IGluIHRoZSBhcnJheQoJCQkJZm9yKDs7KSB7CgkJCQkJaWYoaSBpbiBhcnIpIHsKCQkJCQkJcmVkdWNlZCA9IGFycltpKytdOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCS8vIElmIHdlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgYXJyYXkgd2l0aG91dCBmaW5kaW5nIGFueSByZWFsCgkJCQkJLy8gZWxlbWVudHMsIGl0J3MgYSBUeXBlRXJyb3IKCQkJCQlpZigrK2kgPj0gbGVuKSB7CgkJCQkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBJZiBpbml0aWFsVmFsdWUgcHJvdmlkZWQsIHVzZSBpdAoJCQkJcmVkdWNlZCA9IGFyZ3NbMV07CgkJCX0KCgkJCS8vIERvIHRoZSBhY3R1YWwgcmVkdWNlCgkJCWZvcig7aSA8IGxlbjsgKytpKSB7CgkJCQkvLyBTa2lwIGhvbGVzCgkJCQlpZihpIGluIGFycikgewoJCQkJCXJlZHVjZWQgPSByZWR1Y2VGdW5jKHJlZHVjZWQsIGFycltpXSwgaSwgYXJyKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHJlZHVjZWQ7CgkJfTsKCglmdW5jdGlvbiBpZGVudGl0eSh4KSB7CgkJcmV0dXJuIHg7Cgl9CgoJcmV0dXJuIHdoZW47Cn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZAoJPyBkZWZpbmUKCTogZnVuY3Rpb24gKGZhY3RvcnkpIHsgdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCkpCgkJOiAodGhpcy53aGVuICAgICAgPSBmYWN0b3J5KCkpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgpkZWZpbmUoJ3doZW4nLCBbJ3doZW4vd2hlbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogYXBwbHkuanMKICogSGVscGVyIGZvciB1c2luZyBhcmd1bWVudHMtYmFzZWQgYW5kIHZhcmlhZGljIGNhbGxiYWNrcyB3aXRoIGFueQogKiB7QGxpbmsgUHJvbWlzZX0gdGhhdCByZXNvbHZlcyB0byBhbiBhcnJheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9hcHBseScsW10sZnVuY3Rpb24oKSB7CgogICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBpbmRpdmlkdWFsCiAgICAgKiBhcmd1bWVudHMgKGl0IGNhbiBiZSB2YXJpYWRpYywgdG9vKSwgYW5kIHJldHVybnMgYSBuZXcgZnVuY3Rpb24gdGhhdAogICAgICogdGFrZXMgYSBzaW5nbGUgYXJyYXkgYXMgaXRzIG9ubHkgcGFyYW06CiAgICAgKgogICAgICogZnVuY3Rpb24gYXJnQmFzZWQoYSwgYiwgYykgewogICAgICogICByZXR1cm4gYSArIGIgKyBjOwogICAgICogfQogICAgICoKICAgICAqIGFyZ0Jhc2VkKDEsIDIsIDMpOyAvLyA2CiAgICAgKgogICAgICogLy8gQ3JlYXRlIGFuIGFycmF5LWJhc2VkIHZlcnNpb24gb2YgYXJnQmFzZWQKICAgICAqIHZhciBhcnJheUJhc2VkID0gYXBwbHkoYXJnQmFzZWQpOwogICAgICogdmFyIGlucHV0cyA9IFsxLCAyLCAzXTsKICAgICAqCiAgICAgKiBhcnJheUJhc2VkKGlucHV0cyk7IC8vIDYKICAgICAqCiAgICAgKiBXaXRoIHByb21pc2VzOgogICAgICoKICAgICAqIHZhciBkID0gd2hlbi5kZWZlcigpOwogICAgICogZC5wcm9taXNlLnRoZW4oYXJyYXlCYXNlZCk7CiAgICAgKgogICAgICogZC5yZXNvbHZlKFsxLCAyLCAzXSk7IC8vIGFycmF5QmFzZWQgY2FsbGVkIHdpdGggYXJncyAxLCAyLCAzIC0+IDYKICAgICAqCiAgICAgKiBAcGFyYW0gZiB7RnVuY3Rpb259IGFyZ3VtZW50cy1iYXNlZCBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gYSBuZXcgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGFuIGFycmF5CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbihmKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGFycmF5IHtBcnJheX0gbXVzdCBiZSBhbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gdXNlIHRvIGFwcGx5IHRoZSBvcmlnaW5hbCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMgdGhlIHJlc3VsdCBvZiBhcHBseWluZyBmIHdpdGggdGhlIGFyZ3VtZW50cyBpbiBhcnJheS4KICAgICAgICAgKi8KICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICAgICAgLy8gSXQgYmV0dGVyIGJlIGFuIGFycmF5CiAgICAgICAgICAgIGlmKHRvU3RyaW5nLmNhbGwoYXJyYXkpICE9ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYXBwbHkgY2FsbGVkIHdpdGggbm9uLWFycmF5IGFyZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZi5hcHBseShudWxsLCBhcnJheSk7CiAgICAgICAgfTsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgID0gZmFjdG9yeSgpKQogICAgICAgIDogKHRoaXMud2hlbl9hcHBseSA9IGZhY3RvcnkoKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLypnbG9iYWwgc2V0VGltZW91dDp0cnVlKi8KCi8qKgogKiBkZWxheS5qcwogKgogKiBIZWxwZXIgdGhhdCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGFmdGVyIGEgZGVsYXkuCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgewpkZWZpbmUoJ3doZW4vZGVsYXknLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICB2YXIgdW5kZWY7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgYWZ0ZXIgYSBtc2VjIGRlbGF5LiAgSWYgcHJvbWlzZQogICAgICogaXMgc3VwcGxpZWQsIHRoZSBkZWxheSB3aWxsIHN0YXJ0ICphZnRlciogdGhlIHN1cHBsaWVkIHByb21pc2UgaXMgcmVzb2x2ZWQuCiAgICAgKgogICAgICogVXNhZ2U6CiAgICAgKiAvLyBEbyBzb21ldGhpbmcgYWZ0ZXIgMSBzZWNvbmQsIHNpbWlsYXIgdG8gdXNpbmcgc2V0VGltZW91dAogICAgICogZGVsYXkoMTAwMCkudGhlbihkb1NvbWV0aGluZyk7CiAgICAgKiAvLyBvcgogICAgICogd2hlbihkZWxheSgxMDAwKSwgZG9Tb21ldGhpbmcpOwogICAgICoKICAgICAqIC8vIERvIHNvbWV0aGluZyAxIHNlY29uZCBhZnRlciB0cmlnZ2VyaW5nUHJvbWlzZSByZXNvbHZlcwogICAgICogZGVsYXkodHJpZ2dlcmluZ1Byb21pc2UsIDEwMDApLnRoZW4oZG9Tb21ldGhpbmcsIGhhbmRsZVJlamVjdGlvbik7CiAgICAgKiAvLyBvcgogICAgICogd2hlbihkZWxheSh0cmlnZ2VyaW5nUHJvbWlzZSwgMTAwMCksIGRvU29tZXRoaW5nLCBoYW5kbGVSZWplY3Rpb24pOwogICAgICoKICAgICAqIEBwYXJhbSBbcHJvbWlzZV0gYW55dGhpbmcgLSBhbnkgcHJvbWlzZSBvciB2YWx1ZSBhZnRlciB3aGljaCB0aGUgZGVsYXkgd2lsbCBzdGFydAogICAgICogQHBhcmFtIG1zZWMge051bWJlcn0gZGVsYXkgaW4gbWlsbGlzZWNvbmRzCiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiBkZWxheShwcm9taXNlLCBtc2VjKSB7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgbXNlYyA9IHByb21pc2UgPj4+IDA7CiAgICAgICAgICAgIHByb21pc2UgPSB1bmRlZjsKICAgICAgICB9CgogICAgICAgIHZhciBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShwcm9taXNlKTsKICAgICAgICB9LCBtc2VjKTsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuX2RlbGF5ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKmdsb2JhbCBzZXRUaW1lb3V0OnRydWUsIGNsZWFyVGltZW91dDp0cnVlKi8KCi8qKgogKiB0aW1lb3V0LmpzCiAqCiAqIEhlbHBlciB0aGF0IHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVqZWN0cyBhZnRlciBhIHNwZWNpZmllZCB0aW1lb3V0LAogKiBpZiBub3QgZXhwbGljaXRseSByZXNvbHZlZCBvciByZWplY3RlZCBiZWZvcmUgdGhhdC4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi90aW1lb3V0JyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgdmFyIHVuZGVmOwoKICAgIC8qKgogICAgICogUmV0dXJucyBhIG5ldyBwcm9taXNlIHRoYXQgd2lsbCBhdXRvbWF0aWNhbGx5IHJlamVjdCBhZnRlciBtc2VjIGlmCiAgICAgKiB0aGUgc3VwcGxpZWQgcHJvbWlzZSBkb2Vzbid0IHJlc29sdmUgb3IgcmVqZWN0IGJlZm9yZSB0aGF0LgogICAgICoKICAgICAqIFVzYWdlOgogICAgICoKICAgICAqIHZhciBkID0gd2hlbi5kZWZlcigpOwogICAgICogLy8gU2V0dXAgZCBob3dldmVyIHlvdSBuZWVkCiAgICAgKgogICAgICogLy8gcmV0dXJuIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgZCBkb2Vzbid0IHJlc29sdmUvcmVqZWN0IGZpcnN0CiAgICAgKiByZXR1cm4gdGltZW91dChkLnByb21pc2UsIDEwMDApOwogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlIGFueXRoaW5nIC0gYW55IHByb21pc2Ugb3IgdmFsdWUgdGhhdCBzaG91bGQgdHJpZ2dlcgogICAgICogIHRoZSByZXR1cm5lZCBwcm9taXNlIHRvIHJlc29sdmUgb3IgcmVqZWN0IGJlZm9yZSB0aGUgbXNlYyB0aW1lb3V0CiAgICAgKiBAcGFyYW0gbXNlYyB7TnVtYmVyfSB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcwogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24gdGltZW91dChwcm9taXNlLCBtc2VjKSB7CiAgICAgICAgdmFyIGRlZmVycmVkLCB0aW1lb3V0UmVmOwoKICAgICAgICBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgdGltZW91dFJlZiA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICAgICAgICB0aW1lb3V0UmVmICYmIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoJ3RpbWVkIG91dCcpKTsKICAgICAgICB9LCBtc2VjKTsKCiAgICAgICAgZnVuY3Rpb24gY2FuY2VsVGltZW91dCgpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRSZWYpOwogICAgICAgICAgICB0aW1lb3V0UmVmID0gdW5kZWY7CiAgICAgICAgfQoKICAgICAgICB3aGVuKHByb21pc2UsCiAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgfQogICAgICAgICk7CgogICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl90aW1lb3V0ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogcGFyYWxsZWwuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHBhcmFsbGVsLiAgQWxsIHRhc2tzIHdpbGwKICogcmVjZWl2ZSB0aGUgc2FtZSBhcmdzCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgewpkZWZpbmUoJ3doZW4vcGFyYWxsZWwnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCgkvKioKCSAqIFJ1biBhcnJheSBvZiB0YXNrcyBpbiBwYXJhbGxlbAoJICogQHBhcmFtIHRhc2tzIHtBcnJheXxQcm9taXNlfSBhcnJheSBvciBwcm9taXNlRm9yQXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbYXJnc10geyp9IGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gYWxsIHRhc2tzCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciBhcnJheSBjb250YWluaW5nIHRoZQoJICogcmVzdWx0IG9mIGVhY2ggdGFzayBpbiB0aGUgYXJyYXkgcG9zaXRpb24gY29ycmVzcG9uZGluZwoJICogdG8gcG9zaXRpb24gb2YgdGhlIHRhc2sgaW4gdGhlIHRhc2tzIGFycmF5CgkgKi8KCXJldHVybiBmdW5jdGlvbiBwYXJhbGxlbCh0YXNrcyAvKiwgYXJncy4uLiAqLykgewoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gd2hlbi5tYXAodGFza3MsIGZ1bmN0aW9uKHRhc2spIHsKCQkJcmV0dXJuIHRhc2suYXBwbHkobnVsbCwgYXJncyk7CgkJfSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3BhcmFsbGVsID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogcGlwZWxpbmUuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHNlcXVlbmNlLCBwYXNzaW5nIHRoZSByZXN1bHQKICogb2YgdGhlIHByZXZpb3VzIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBuZXh0LiAgTGlrZSBhIHNoZWxsCiAqIHBpcGVsaW5lLCBlLmcuIGBjYXQgZmlsZS50eHQgfCBncmVwICdmb28nIHwgc2VkIC1lICdzL2Zvby9iYXIvZycKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9waXBlbGluZScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIGEgcGlwZWxpbmUgd2hlcmUgdGhlIG5leHQKCSAqIHRhc2tzIHJlY2VpdmVzIHRoZSByZXN1bHQgb2YgdGhlIHByZXZpb3VzLiAgVGhlIGZpcnN0IHRhc2sKCSAqIHdpbGwgcmVjZWl2ZSB0aGUgaW5pdGlhbEFyZ3MgYXMgaXRzIGFyZ3VtZW50IGxpc3QuCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2UgZm9yIGFycmF5IG9mIHRhc2sgZnVuY3Rpb25zCgkgKiBAcGFyYW0gW2luaXRpYWxBcmdzLi4uXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZmlyc3QgdGFzawoJICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSBmb3IgcmV0dXJuIHZhbHVlIG9mIHRoZSBmaW5hbCB0YXNrCgkgKi8KCXJldHVybiBmdW5jdGlvbiBwaXBlbGluZSh0YXNrcyAvKiBpbml0aWFsQXJncy4uLiAqLykgewoJCXZhciBpbml0aWFsQXJncywgcnVuVGFzazsKCgkJaW5pdGlhbEFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKCQkvLyBTZWxmLW9wdGltaXppbmcgZnVuY3Rpb24gdG8gcnVuIGZpcnN0IHRhc2sgd2l0aCBtdWx0aXBsZQoJCS8vIGFyZ3MgdXNpbmcgYXBwbHksIGJ1dCBzdWJzZXF1ZW5jZSB0YXNrcyB2aWEgZGlyZWN0IGludm9jYXRpb24KCQlydW5UYXNrID0gZnVuY3Rpb24odGFzaywgYXJncykgewoJCQlydW5UYXNrID0gZnVuY3Rpb24odGFzaywgYXJnKSB7CgkJCQlyZXR1cm4gdGFzayhhcmcpOwoJCQl9OwoJCQkKCQkJcmV0dXJuIHRhc2suYXBwbHkobnVsbCwgYXJncyk7CgkJfTsKCgkJcmV0dXJuIHdoZW4ucmVkdWNlKHRhc2tzLAoJCQlmdW5jdGlvbihhcmdzLCB0YXNrKSB7CgkJCQlyZXR1cm4gcnVuVGFzayh0YXNrLCBhcmdzKTsKCQkJfSwKCQkJaW5pdGlhbEFyZ3MKCQkpOwoJfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZAoJPyBkZWZpbmUKCTogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcKCQk/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQoJCTogKHRoaXMud2hlbl9waXBlbGluZSA9IGZhY3RvcnkodGhpcy53aGVuKSk7Cgl9CgkvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIHNlcXVlbmNlLmpzCiAqCiAqIFJ1biBhIHNldCBvZiB0YXNrIGZ1bmN0aW9ucyBpbiBzZXF1ZW5jZS4gIEFsbCB0YXNrcyB3aWxsCiAqIHJlY2VpdmUgdGhlIHNhbWUgYXJncy4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9zZXF1ZW5jZScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIHNlcXVlbmNlIHdpdGggbm8gb3ZlcmxhcAoJICogQHBhcmFtIHRhc2tzIHtBcnJheXxQcm9taXNlfSBhcnJheSBvciBwcm9taXNlRm9yQXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbYXJnc10geyp9IGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gYWxsIHRhc2tzCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciBhbiBhcnJheSBjb250YWluaW5nCgkgKiB0aGUgcmVzdWx0IG9mIGVhY2ggdGFzayBpbiB0aGUgYXJyYXkgcG9zaXRpb24gY29ycmVzcG9uZGluZwoJICogdG8gcG9zaXRpb24gb2YgdGhlIHRhc2sgaW4gdGhlIHRhc2tzIGFycmF5CgkgKi8KCXJldHVybiBmdW5jdGlvbiBzZXF1ZW5jZSh0YXNrcyAvKiwgYXJncy4uLiAqLykgewoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gd2hlbi5yZWR1Y2UodGFza3MsIGZ1bmN0aW9uKHJlc3VsdHMsIHRhc2spIHsKCQkJcmV0dXJuIHdoZW4odGFzay5hcHBseShudWxsLCBhcmdzKSwgZnVuY3Rpb24ocmVzdWx0KSB7CgkJCQlyZXN1bHRzLnB1c2gocmVzdWx0KTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9KTsKCQl9LCBbXSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3NlcXVlbmNlID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogY2FuY2VsYWJsZS5qcwogKgogKiBEZWNvcmF0b3IgdGhhdCBtYWtlcyBhIGRlZmVycmVkICJjYW5jZWxhYmxlIi4gIEl0IGFkZHMgYSBjYW5jZWwoKSBtZXRob2QgdGhhdAogKiB3aWxsIGNhbGwgYSBzcGVjaWFsIGNhbmNlbCBoYW5kbGVyIGZ1bmN0aW9uIGFuZCB0aGVuIHJlamVjdCB0aGUgZGVmZXJyZWQuICBUaGUKICogY2FuY2VsIGhhbmRsZXIgY2FuIGJlIHVzZWQgdG8gZG8gcmVzb3VyY2UgY2xlYW51cCwgb3IgYW55dGhpbmcgZWxzZSB0aGF0IHNob3VsZAogKiBiZSBkb25lIGJlZm9yZSBhbnkgb3RoZXIgcmVqZWN0aW9uIGhhbmRsZXJzIGFyZSBleGVjdXRlZC4KICoKICogVXNhZ2U6CiAqCiAqIHZhciBjYW5jZWxhYmxlRGVmZXJyZWQgPSBjYW5jZWxhYmxlKHdoZW4uZGVmZXIoKSwgbXlDYW5jZWxIYW5kbGVyKTsKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9jYW5jZWxhYmxlJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgLyoqCiAgICAgKiBNYWtlcyBkZWZlcnJlZCBjYW5jZWxhYmxlLCBhZGRpbmcgYSBjYW5jZWwoKSBtZXRob2QuCiAgICAgKgogICAgICogQHBhcmFtIGRlZmVycmVkIHtEZWZlcnJlZH0gdGhlIHtAbGluayBEZWZlcnJlZH0gdG8gbWFrZSBjYW5jZWxhYmxlCiAgICAgKiBAcGFyYW0gY2FuY2VsZXIge0Z1bmN0aW9ufSBjYW5jZWwgaGFuZGxlciBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdGhpcyBkZWZlcnJlZCBpcyBjYW5jZWxlZC4gIFRoaXMKICAgICAqIGlzIGd1YXJhbnRlZWQgdG8gcnVuIGJlZm9yZSBhbGwgb3RoZXIgcmVqZWN0aW9uIGhhbmRsZXJzLiAgVGhlIGNhbmNlbGVyIHdpbGwgTk9UIGJlIGV4ZWN1dGVkIGlmIHRoZQogICAgICogZGVmZXJyZWQgaXMgcmVqZWN0ZWQgaW4gdGhlIHN0YW5kYXJkIHdheSwgaS5lLiBkZWZlcnJlZC5yZWplY3QoKS4gIEl0IE9OTFkgZXhlY3V0ZXMgaWYgdGhlIGRlZmVycmVkCiAgICAgKiBpcyBjYW5jZWxlZCwgaS5lLiBkZWZlcnJlZC5jYW5jZWwoKQogICAgICoKICAgICAqIEByZXR1cm5zIGRlZmVycmVkLCB3aXRoIGFuIGFkZGVkIGNhbmNlbCgpIG1ldGhvZC4KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGRlZmVycmVkLCBjYW5jZWxlcikgewoKICAgICAgICB2YXIgZGVsZWdhdGUgPSB3aGVuLmRlZmVyKCk7CgogICAgICAgIC8vIEFkZCBhIGNhbmNlbCBtZXRob2QgdG8gdGhlIGRlZmVycmVkIHRvIHJlamVjdCB0aGUgZGVsZWdhdGUKICAgICAgICAvLyB3aXRoIHRoZSBzcGVjaWFsIGNhbmNlbGVkIGluZGljYXRvci4KICAgICAgICBkZWZlcnJlZC5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlLnJlamVjdChjYW5jZWxlcihkZWZlcnJlZCkpOwogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBvcmlnaW5hbCByZXNvbHZlLCByZWplY3QsIGFuZCBwcm9ncmVzcyBhbGwgZm9yd2FyZAogICAgICAgIC8vIHRvIHRoZSBkZWxlZ2F0ZQogICAgICAgIGRlZmVycmVkLnByb21pc2UudGhlbihkZWxlZ2F0ZS5yZXNvbHZlLCBkZWxlZ2F0ZS5yZWplY3QsIGRlbGVnYXRlLnByb2dyZXNzKTsKCiAgICAgICAgLy8gUmVwbGFjZSBkZWZlcnJlZCdzIHByb21pc2Ugd2l0aCB0aGUgZGVsZWdhdGUgcHJvbWlzZQogICAgICAgIGRlZmVycmVkLnByb21pc2UgPSBkZWxlZ2F0ZS5wcm9taXNlOwoKICAgICAgICAvLyBBbHNvIHJlcGxhY2UgZGVmZXJyZWQudGhlbiB0byBhbGxvdyBpdCB0byBiZSBjYWxsZWQgc2FmZWx5IGFuZAogICAgICAgIC8vIG9ic2VydmUgdGhlIGNhbmNlbGxhdGlvbgoJCS8vIFRPRE86IFJlbW92ZSBvbmNlIGRlZmVycmVkLnRoZW4gaXMgcmVtb3ZlZAogICAgICAgIGRlZmVycmVkLnRoZW4gPSBkZWxlZ2F0ZS5wcm9taXNlLnRoZW47CgogICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW5fY2FuY2VsYWJsZSA9IGZhY3RvcnkodGhpcy53aGVuKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKOyhmdW5jdGlvbihnKXsKCiAgICAvLyBzdW1tYXJ5OiBBIHNpbXBsZSBmZWF0dXJlIGRldGVjdGlvbiBmdW5jdGlvbi9mcmFtZXdvcmsuCiAgICAvLwogICAgLy8gbmFtZTogU3RyaW5nCiAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIGRldGVjdCwgYXMgZGVmaW5lZCBieSB0aGUgb3ZlcmFsbCBgaGFzYCB0ZXN0cy4KICAgIC8vICAgICAgVGVzdHMgY2FuIGJlIHJlZ2lzdGVyZWQgdmlhIGBoYXMuYWRkKHRlc3RuYW1lLCB0ZXN0ZnVuY3Rpb24pYC4KICAgIC8vCiAgICAvLyBleGFtcGxlOgogICAgLy8gICAgICBteWxpYnJhcnkuYmluZCA9IGhhcygibmF0aXZlLWJpbmQiKSA/IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgIC8vICAgICAgICAgIHJldHVybiBmbi5iaW5kKGNvbnRleHQpOwogICAgLy8gICAgICB9IDogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAvLyAgICAgICAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgIC8vICAgICAgICAgIH0KICAgIC8vICAgICAgfQoKICAgIHZhciBOT05fSE9TVF9UWVBFUyA9IHsgImJvb2xlYW4iOiAxLCAibnVtYmVyIjogMSwgInN0cmluZyI6IDEsICJ1bmRlZmluZWQiOiAxIH0sCiAgICAgICAgVkVORE9SX1BSRUZJWEVTID0gWyJXZWJraXQiLCAiTW96IiwgIk8iLCAibXMiLCAiS2h0bWwiXSwKICAgICAgICBkID0gaXNIb3N0VHlwZShnLCAiZG9jdW1lbnQiKSAmJiBnLmRvY3VtZW50LAogICAgICAgIGVsID0gZCAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVFbGVtZW50IikgJiYgZC5jcmVhdGVFbGVtZW50KCJEaVYiKSwKICAgICAgICBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICJvYmplY3QiICYmIGV4cG9ydHMsCiAgICAgICAgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIgJiYgbW9kdWxlLAogICAgICAgIHRlc3RDYWNoZSA9IHt9CiAgICA7CgogICAgZnVuY3Rpb24gaGFzKC8qIFN0cmluZyAqL25hbWUpewogICAgICAgIGlmKHR5cGVvZiB0ZXN0Q2FjaGVbbmFtZV0gPT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgIHRlc3RDYWNoZVtuYW1lXSA9IHRlc3RDYWNoZVtuYW1lXShnLCBkLCBlbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZXN0Q2FjaGVbbmFtZV07IC8vIEJvb2xlYW4KICAgIH0KCiAgICBmdW5jdGlvbiBhZGQoLyogU3RyaW5nICovbmFtZSwgLyogRnVuY3Rpb24gKi90ZXN0LCAvKiBCb29sZWFuPyAqL25vdyl7CiAgICAgICAgLy8gc3VtbWFyeTogUmVnaXN0ZXIgYSBuZXcgZmVhdHVyZSBkZXRlY3Rpb24gdGVzdCBmb3Igc29tZSBuYW1lZCBmZWF0dXJlCiAgICAgICAgLy8KICAgICAgICAvLyBuYW1lOiBTdHJpbmcKICAgICAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIHRlc3QuCiAgICAgICAgLy8KICAgICAgICAvLyB0ZXN0OiBGdW5jdGlvbgogICAgICAgIC8vICAgICAgQSB0ZXN0IGZ1bmN0aW9uIHRvIHJlZ2lzdGVyLiBJZiBhIGZ1bmN0aW9uLCBxdWV1ZWQgZm9yIHRlc3RpbmcgdW50aWwgYWN0dWFsbHkKICAgICAgICAvLyAgICAgIG5lZWRlZC4gVGhlIHRlc3QgZnVuY3Rpb24gc2hvdWxkIHJldHVybiBhIGJvb2xlYW4gaW5kaWNhdGluZwogICAgICAgIC8vICAgICAgdGhlIHByZXNlbmNlIG9mIGEgZmVhdHVyZSBvciBidWcuCiAgICAgICAgLy8KICAgICAgICAvLyBub3c6IEJvb2xlYW4/CiAgICAgICAgLy8gICAgICBPcHRpb25hbC4gT21pdCBpZiBgdGVzdGAgaXMgbm90IGEgZnVuY3Rpb24uIFByb3ZpZGVzIGEgd2F5IHRvIGltbWVkaWF0ZWx5CiAgICAgICAgLy8gICAgICBydW4gdGhlIHRlc3QgYW5kIGNhY2hlIHRoZSByZXN1bHQuCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIEEgcmVkdW5kYW50IHRlc3QsIHRlc3RGbiB3aXRoIGltbWVkaWF0ZSBleGVjdXRpb246CiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiamF2YXNjcmlwdCIsIGZ1bmN0aW9uKCl7IHJldHVybiB0cnVlOyB9LCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBBZ2FpbiB3aXRoIHRoZSByZWR1bmRhbnRuZXNzLiBZb3UgY2FuIGRvIHRoaXMgaW4geW91ciB0ZXN0cywgYnV0IHdlIHNob3VsZAogICAgICAgIC8vICAgICAgbm90IGJlIGRvaW5nIHRoaXMgaW4gYW55IGludGVybmFsIGhhcy5qcyB0ZXN0cwogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImphdmFzY3JpcHQiLCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBUaHJlZSB0aGluZ3MgYXJlIHBhc3NlZCB0byB0aGUgdGVzdEZ1bmN0aW9uLiBgZ2xvYmFsYCwgYGRvY3VtZW50YCwgYW5kIGEgZ2VuZXJpYyBlbGVtZW50CiAgICAgICAgLy8gICAgICBmcm9tIHdoaWNoIHRvIHdvcmsgeW91ciB0ZXN0IHNob3VsZCB0aGUgbmVlZCBhcmlzZS4KICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJidWctYnlpZCIsIGZ1bmN0aW9uKGcsIGQsIGVsKXsKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZyAgPT0gZ2xvYmFsLCB0eXBpY2FsbHkgd2luZG93LCB5YWRkYSB5YWRkYQogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBkICA9PSBkb2N1bWVudCBvYmplY3QKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZWwgPT0gdGhlIGdlbmVyaWMgZWxlbWVudC4gYSBgaGFzYCBlbGVtZW50LgogICAgICAgIC8vICB8ICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGZha2UgdGVzdCwgYnlpZC13aGVuLWZvcm0taGFzLW5hbWUtbWF0Y2hpbmctYW4taWQgaXMgc2xpZ2h0bHkgbG9uZ2VyCiAgICAgICAgLy8gIHwgICAgICAgfSk7CiAgICAgICAgdGVzdENhY2hlW25hbWVdID0gbm93ID8gdGVzdChnLCBkLCBlbCkgOiB0ZXN0OwogICAgfQoKICAgIC8vIGNzc3Byb3AgYWRhcHRlZCBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTk4MDA4ICh0aGFua3MsIF5waSkKICAgIGZ1bmN0aW9uIGNzc3Byb3AobmFtZSwgZWwpewogICAgICAgIHZhciBzdXBwb3J0ZWQgPSBmYWxzZSwKICAgICAgICAgICAgY2FwaXRhbGl6ZWQgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgICAgICAgICAgbGVuZ3RoID0gVkVORE9SX1BSRUZJWEVTLmxlbmd0aCwKICAgICAgICAgICAgc3R5bGUgPSBlbC5zdHlsZTsKCiAgICAgICAgaWYodHlwZW9mIHN0eWxlW25hbWVdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgd2hpbGUobGVuZ3RoLS0pewogICAgICAgICAgICAgICAgaWYodHlwZW9mIHN0eWxlW1ZFTkRPUl9QUkVGSVhFU1tsZW5ndGhdICsgY2FwaXRhbGl6ZWRdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdXBwb3J0ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJFbGVtZW50KGVsKXsKICAgICAgICBpZihlbCl7CiAgICAgICAgICAgIHdoaWxlKGVsLmxhc3RDaGlsZCl7CiAgICAgICAgICAgICAgICBlbC5yZW1vdmVDaGlsZChlbC5sYXN0Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbDsKICAgIH0KCiAgICAvLyBIb3N0IG9iamVjdHMgY2FuIHJldHVybiB0eXBlIHZhbHVlcyB0aGF0IGFyZSBkaWZmZXJlbnQgZnJvbSB0aGVpciBhY3R1YWwKICAgIC8vIGRhdGEgdHlwZS4gVGhlIG9iamVjdHMgd2UgYXJlIGNvbmNlcm5lZCB3aXRoIHVzdWFsbHkgcmV0dXJuIG5vbi1wcmltaXRpdmUKICAgIC8vIHR5cGVzIG9mIG9iamVjdCwgZnVuY3Rpb24sIG9yIHVua25vd24uCiAgICBmdW5jdGlvbiBpc0hvc3RUeXBlKG9iamVjdCwgcHJvcGVydHkpewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgcmV0dXJuIHR5cGUgPT0gIm9iamVjdCIgPyAhIW9iamVjdFtwcm9wZXJ0eV0gOiAhTk9OX0hPU1RfVFlQRVNbdHlwZV07CiAgICB9CgogICAgICAgIGhhcy5hZGQgPSBhZGQ7CiAgICBoYXMuY2xlYXJFbGVtZW50ID0gY2xlYXJFbGVtZW50OwogICAgaGFzLmNzc3Byb3AgPSBjc3Nwcm9wOwogICAgaGFzLmlzSG9zdFR5cGUgPSBpc0hvc3RUeXBlOwogICAgaGFzLl90ZXN0cyA9IHRlc3RDYWNoZTsKCiAgICBoYXMuYWRkKCJkb20iLCBmdW5jdGlvbihnLCBkLCBlbCl7CiAgICAgICAgcmV0dXJuIGQgJiYgZWwgJiYgaXNIb3N0VHlwZShnLCAibG9jYXRpb24iKSAmJiBpc0hvc3RUeXBlKGQsICJkb2N1bWVudEVsZW1lbnQiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50QnlJZCIpICYmIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRzQnlOYW1lIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudHNCeVRhZ05hbWUiKSAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVDb21tZW50IikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiY3JlYXRlRWxlbWVudCIpICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZVRleHROb2RlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgImFwcGVuZENoaWxkIikgJiYgaXNIb3N0VHlwZShlbCwgImluc2VydEJlZm9yZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJyZW1vdmVDaGlsZCIpICYmIGlzSG9zdFR5cGUoZWwsICJnZXRBdHRyaWJ1dGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAic2V0QXR0cmlidXRlIikgJiYgaXNIb3N0VHlwZShlbCwgInJlbW92ZUF0dHJpYnV0ZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJzdHlsZSIpICYmIHR5cGVvZiBlbC5zdHlsZS5jc3NUZXh0ID09ICJzdHJpbmciOwogICAgfSk7CgogICAgLy8gU3RvcCByZXBlYXQgYmFja2dyb3VuZC1pbWFnZSByZXF1ZXN0cyBhbmQgcmVkdWNlIG1lbW9yeSBjb25zdW1wdGlvbiBpbiBJRTYgU1AxCiAgICAvLyBodHRwOi8vbWlzdGVycGl4ZWwuYmxvZ3Nwb3QuY29tLzIwMDYvMDkvZm9yZW5zaWMtYW5hbHlzaXMtb2YtaWU2Lmh0bWwKICAgIC8vIGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2N3aWxzby9hcmNoaXZlLzIwMDYvMTEvMDcvaWUtcmUtZG93bmxvYWRpbmctYmFja2dyb3VuZC1pbWFnZXMuYXNweD9QYWdlSW5kZXg9MQogICAgLy8gaHR0cDovL3N1cHBvcnQubWljcm9zb2Z0LmNvbS9rYi84MjM3MjcKICAgIHRyeXsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiQmFja2dyb3VuZEltYWdlQ2FjaGUiLCBmYWxzZSwgdHJ1ZSk7CiAgICB9Y2F0Y2goZSl7fQoKICAgIC8vIEV4cG9zZSBoYXMoKQogICAgLy8gc29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zIGxpa2UgdGhlIGZvbGxvd2luZzoKICAgIGlmKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAib2JqZWN0IiAmJiBkZWZpbmUuYW1kKXsKICAgICAgICBkZWZpbmUoImhhcyIsW10sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBoYXM7CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgICBlbHNlIGlmKGZyZWVFeHBvcnRzKXsKICAgICAgICAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgICAgIGlmKGZyZWVNb2R1bGUgJiYgZnJlZU1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKXsKICAgICAgICAgIChmcmVlTW9kdWxlLmV4cG9ydHMgPSBoYXMpLmhhcyA9IGhhczsKICAgICAgICB9CiAgICAgICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgICAgICBlbHNlewogICAgICAgICAgZnJlZUV4cG9ydHMuaGFzID0gaGFzOwogICAgICAgIH0KICAgIH0KICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgZWxzZXsKICAgICAgICAvLyB1c2Ugc3F1YXJlIGJyYWNrZXQgbm90YXRpb24gc28gQ2xvc3VyZSBDb21waWxlciB3b24ndCBtdW5nZSBgaGFzYAogICAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vY2xvc3VyZS9jb21waWxlci9kb2NzL2FwaS10dXRvcmlhbDMuaHRtbCNleHBvcnQKICAgICAgICBnWyJoYXMiXSA9IGhhczsKICAgIH0KfSkodGhpcyk7CgpkZWZpbmUoJ3RocnVzdC9jYXBzdWxlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBmbGF0dGVuID0gXy5mbGF0dGVuLCBwbHVjayA9IF8ucGx1Y2ssIGZsYXR0ZW5Ub1Byb21pc2VzID0gdXRpbC5mbGF0dGVuVG9Qcm9taXNlcywgdGhydXN0Q2FjaGUgPSB7CiAgICB9LCBfX29wdGlvbmFsTWV0aG9kcyA9IFsKICAgICAgICAvLyBPcHRpb25hbCBtZXRob2RzIHRoYXQgbWF5IGJlIG9uIGEgbW9kdWxlCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnY29uZmlnJywgCiAgICAgICAgCiAgICBdLCBfX3JlcXVpcmVkTWV0aG9kcyA9IFsKICAgICAgICAvLyBSZXF1aXJlZCBtZXRob2RzIHRoYXQgbXVzdCBiZSBvbiBldmVyeSBtb2R1bGUKICAgICAgICAnaW5pdCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgCiAgICBdOwogICAgLyoqCiAgICBNb3ZlcyBhbGwgcHJvcGVydGllcywgdGhhdCBzaG91bGQgZXhpc3Qgb3V0c2lkZSBvZiB0aGUgbW9kdWxlLCBpbnRvIGEgcHJpdmF0ZSBvYmplY3QgZm9yIGhvbGRpbmcuCiAgICAKICAgIEBtZXRob2QgbW92ZVRvVGhydXN0Q2FjaGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gZnJvbSBPYmplY3QgdG8gZXh0cmFjdCBpdGVtcyBmcm9tCiAgICBAcGFyYW0ge09iamVjdH0gdG8gT2JqZWN0IHRvIHBsYWNlIGl0ZW1zIG9uCiAgICBAcGFyYW0ge0FycmF5fSBsaXN0IEl0ZW1zIHRvIG1vdmUgZnJvbSB0byB0aGUgb3RoZXIgb2JqZWN0CiAgICAqKi8KICAgIGZ1bmN0aW9uIG1vdmVUb1RocnVzdENhY2hlKGZyb20sIHRvLCBsaXN0KSB7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGxpc3QubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHRvW2xpc3RbaV1dID0gZnJvbVtsaXN0W2ldXTsKICAgICAgICAgICAgZGVsZXRlIGZyb21bbGlzdFtpXV07CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0RXZlbnROYW1lc3BhY2UobmFtZSwgcHJlZml4KSB7CiAgICAgICAgaWYoIXByZWZpeCkgewogICAgICAgICAgICBwcmVmaXggPSAnbW9kdWxlLSc7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnLicgKyAobmFtZSA9PT0gJ2dsb2JhbCcgPyAnZ2xvYmFsJyA6IHByZWZpeCArIG5hbWUucmVwbGFjZSgvXC4vZywgJy0nKSk7CiAgICB9CiAgICBmdW5jdGlvbiBjYWxsRmFjYWRlTWV0aG9kcyhtZXRob2QsIG1vZHVsZUNhY2hlKSB7CiAgICAgICAgdmFyIG0gPSBtb2R1bGVDYWNoZS5tb2R1bGU7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBfLmZvck93bihtb2R1bGVDYWNoZS5mYWNhZGVzLCBmdW5jdGlvbiAoZmFjYWRlLCBpKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgndGhydXN0L2NhcHN1bGU6IENhbGxpbmcgZmFjYWRlICJ7MH0iIHsxfSgpJywgaSwgbWV0aG9kKSk7CiAgICAgICAgICAgIGlmKGZhY2FkZVttZXRob2RdICYmIGlzT2JqZWN0KGZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChmYWNhZGVbbWV0aG9kXS5jYWxsKGZhY2FkZSwgbSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKHV0aWwuc2FmZUludm9rZSgobS50aHJ1c3QpLl9fdGhydXN0Q29udmVudGlvbnMsIG1ldGhvZCwgbSwgbW9kdWxlQ2FjaGUuZmFjYWRlcykpOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgLyoqCiAgICBUaGUgbW9kdWxlIGlzIHRoZSBoZWFydCBvZiB0aGUgdGhydXN0LCBldmVyeSBtb2R1bGUgZ2V0cyBvbmUgZmFjYWRlIHBlciBtb2R1bGUuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAY2xhc3MgdGhydXN0Lk1vZHVsZQogICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge09iamVjdH0gZGVmIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXSBUaGUgbW9kdWxlIG5hbWUuCiAgICAqKi8KICAgIHZhciBNb2R1bGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vdmFyIE1vZHVsZSA9CiAgICAgICAgZnVuY3Rpb24gTW9kdWxlKHRocnVzdCwgZGVmLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSB0aGlzLm5hbWUgPSAobmFtZSB8fCBkZWYubmFtZSk7CiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGRlZiA9IGRlZihuYW1lKTsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWlkID0gdGhpcy5taWQgPSB0aHJ1c3QubmFtZSArICc6JyArIG5hbWU7CiAgICAgICAgICAgIHZhciB0Q2FjaGUgPSB0aHJ1c3RDYWNoZVtkZWYuaGFzaCB8fCBtaWRdOwogICAgICAgICAgICAvLyBDbGVhciBhbnkgcG90ZW50aWFsIGNhY2hlZCBjb25maWcgb2JqZWN0cywgdG8gbWFrZSBzdXJlIHRoZXkgcmVmcmVzaCBpZiB0aGUgbW9kdWxlIGlzIHJlZGVmaW5lZC4KICAgICAgICAgICAgaWYodENhY2hlKSB7CiAgICAgICAgICAgICAgICBfLmtleXModENhY2hlKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgPT09IDA7CiAgICAgICAgICAgICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSB0Q2FjaGVbeF07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmluc3RhbmNlID0gZXh0ZW5kKGRlZiwgdENhY2hlICYmIHRDYWNoZS5pbnN0YW5jZSB8fCB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm5hbWUgPSAodGhpcy5pbnN0YW5jZS5uYW1lIHx8IG5hbWUpOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm1pZCA9IG1pZDsKICAgICAgICAgICAgaWYoIXRoaXMuaW5zdGFuY2UubmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbGwgTW9kdWxlcyBtdXN0IGhhdmUgYSBuYW1lIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgbXVzdCBoYXZlIGFuIGluaXQgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLCBpdCdzIHVwIHRvIHRoZSBtb2R1bGUgZGV2ZWxvcGVyIHRvIHBvcHVsYXRlIHRoZXNlIG1ldGhvZHMuCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBfX3JlcXVpcmVkTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCFkZWZbX19yZXF1aXJlZE1ldGhvZHNbaV1dKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUmVxdWlyZWQgInswfSIgbWV0aG9kIG5vdCBmb3VuZCBvbiBtb2R1bGUgInsxfSIhJywgX19yZXF1aXJlZE1ldGhvZHNbaV0sIG5hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJZiB0aGUgbW9kdWxlIG5hbWUgaXMgdW5kZWZpbmVkLCBicmluZyB0aGUgbmFtZSBpbnRvIHRoZSBtb2R1bGUuCiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYubmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhydXN0TW9kdWxlQ2FjaGVJdGVtID0gdGhydXN0Q2FjaGVbbWlkXSA9IGV4dGVuZCh0Q2FjaGUgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBfc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBuYW1lOiB1dGlsLmdldE1vZHVsZU5hbWVGb3JQYXRoKG5hbWUpLAogICAgICAgICAgICAgICAgbW9kdWxlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgdGhydXN0Q2FjaGVbZGVmLmhhc2hdOwogICAgICAgICAgICB2YXIgZmFjYWRlcyA9IHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzIHx8ICh0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKCF0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpIHsKICAgICAgICAgICAgICAgIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IGZsYXR0ZW4ocGx1Y2sodGhydXN0Ll9fY29udmVudGlvbnMgfHwgW10sICdwcm9wZXJ0aWVzJykpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSAhPT0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgYWxsIHNwZWNpYWwgcHJvcGVydGllcyBvZmYgdG8gdGhlIHRocnVzdCdzIGludGVybmFsIG1ldGhvZC4KICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX3JlcXVpcmVkTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19vcHRpb25hbE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSk7CiAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aHJ1c3QsICdjcmVhdGVGYWNhZGUnLCB0aHJ1c3QsIHRoaXMuaW5zdGFuY2UsIGZhY2FkZXMpOwogICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gZ2V0RXZlbnROYW1lc3BhY2UodGhpcy5pbnN0YW5jZS5uYW1lKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSB0aHJ1c3Q7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSB0aHJ1c3RDYWNoZVttaWRdOwogICAgICAgIH0KICAgICAgICBNb2R1bGUudGhydXN0Q2FjaGUgPSB0aHJ1c3RDYWNoZTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmNvbnZlbnRpb24gPSAvKioKICAgICAgICBHZXR0ZXIvU2V0dGVyIGZvciBjb252ZW50aW9uIG1ldGhvZHMuCiAgICAgICAgR2V0cyB0aGUgdmFsdWUgY29udmVudGlvbiBwcm9wZXJ0eSAoZGVmaW5lZCBpbiB0aGUgcHJvcGVydGllcyBhcnJheSBvZiBhIGZhY2FkZSkuCiAgICAgICAgU2V0cyB0aGUgdmFsdWUgb2YgYSBjb252ZW50aW9uIHByb3BlcnR5IChmb3Igc3RvcmluZyBjb252ZW50aW9uIGNvbmZpZ3VyYXRpb24pCiAgICAgICAgCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgQHBhcmFtIHtvYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldAogICAgICAgIEBtZXRob2QgY29udmVudGlvbgogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSB2YWxhdWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgdGMgPSB0aGlzLmNhY2hlOwogICAgICAgICAgICBpZihwcm9wZXJ0eS5pbmRleE9mKCdjb25maWcuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0Y1twcm9wZXJ0eV0gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdGhpcy5nZXRWYWx1ZUZyb21QYXRoKHByb3BlcnR5LCB0YykgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRjW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuZ2V0VmFsdWVGcm9tUGF0aCA9IGZ1bmN0aW9uIChwYXRoLCBvYmplY3QpIHsKICAgICAgICAgICAgdmFyIHBhdGhzID0gcGF0aC5zcGxpdCgnLicpLCB2ID0gb2JqZWN0OwogICAgICAgICAgICBfLmVhY2gocGF0aHMsIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICB2ID0gdiAmJiB2W3BdOwogICAgICAgICAgICAgICAgaWYoIXYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q3JlYXRlID0gLyoqCiAgICAgICAgSW5qZWN0cyB0aGlzIG1vZHVsZSBpbnRvIHRoZSBnaXZlbiB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDcmVhdGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB0aHJ1c3QuX19pbmplY3RNb2R1bGUodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENhbGwgPSAvKioKICAgICAgICBNYWtlcyBhIGNhbGwgdG8gYWxsIHRoZSBtb2R1bGVzIGZhY2FkZXMKICAgICAgICBUaGUgb3JkZXIgb2YgdGhlIGNhbGwgZGVwZW5kcyBvbiB0aGUgb3JkZXIgcmVxdWlyZWQuCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydHVwIHN0YWdlIChpbml0LCBzdGFydCwgcmVhZHkpIGZhY2FkZXMgYXJlIGNhbGxlZCBmaXJzdC4KICAgICAgICBEdXJpbmcgdGhlIHNodXRkb3duIHN0YXRlIChzdG9wLCBkZXN0cm95KSBmYWNhZGVzIGFyZSBjYWxsZWQgbGFzdC4KICAgICAgICBUaGlzIGFsbG93cyBtb2R1bGVzIHRvIHN0YXJ0dXAgYW5kIHNodXRkb3duIHdpbGwgYWxsIHRoZSB0b29scyBpdCBoYWQgdG8gYmVnaW4gd2l0aC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENhbGwKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgbWV0aG9kIHRvIGNhbGwKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZhY2FkZUFmdGVyIGNhbGxzIGZhY2FkZSBtZXRob2RzIGJlZm9yZSBvciBhZnRlciBtb2R1bGUgbWV0aG9kLgogICAgICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgQXJncyB0byBiZSBwYXNzZWQgb250byB0aGUgbW9kdWxlIG1ldGhvZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobWV0aG9kLCBmYWNhZGVBZnRlciwgYXJncykgewogICAgICAgICAgICB2YXIgc2VxID0gW10sIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZXMgZm9yICJ7MH0iJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHRoaXMuY2FjaGUsIG0gPSBjYWNoZVttZXRob2RdOwogICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBjYWNoZSk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKG0pIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFjYWRlQWZ0ZXIpIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKHNlcS5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShzZXEpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBtb2R1bGUsIGluc2lkZSB0aGUgdGhydXN0IGNvbnRhaW5lciBpdCB3YXMgY3JlYXRlZCBvbi4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0LnRocnVzdC5zdGFydCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgU3RvcCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RvcCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIE1vZHVsZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1vZHVsZSA9IE1vZHVsZTsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZS4KICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e21vZHVsZU5hbWV9CiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgbW9kdWxlTmFtZSA9IHBhcnRzWzFdOwogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSB0aHJ1c3QubW9kdWxlc1ttb2R1bGVOYW1lXTsKICAgICAgICAgICAgaWYoIW1vZHVsZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBtb2R1bGVOYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jYXBzdWxlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2luc3RhbmNlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19jYXBzdWxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIC8qKgogICAgR2V0cyB0aGUgdGhydXN0IGluc3RhbmNlcy4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciBjYXBzdWxlID0gX19jYXBzdWxlX187CgogICAgLyoqCiAgICBUaGUgYXZhaWxhYmxlIHRocnVzdCBpbnN0YW5jZXMKICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQGZvciB0aHJ1c3QuaW5zdGFuY2UKICAgIEBwcm9wZXJ0eSBpbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMuaW5zdGFuY2VzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGxvYWRpbmcgdGh1cnN0IGluc3RhbmNlcy4KICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQHByb3BlcnR5IGxvYWRpbmdJbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIAogICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICoqLwogICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgIHJldHVybiBleHBvcnRzLmluc3RhbmNlc1tuYW1lXSB8fCBudWxsOwogICAgfQogICAgZXhwb3J0cy5nZXRJbnN0YW5jZSA9IGdldEluc3RhbmNlOwogICAgLyoqCiAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAKICAgIEBtZXRob2QgZmV0Y2hJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgKiovCiAgICBmdW5jdGlvbiBmZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICB2YXIgZGVmZXIgPSBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gfHwgKGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1tuYW1lXSA9IHdoZW4uZGVmZXIoKSk7CiAgICAgICAgcmV0dXJuIGRlZmVyOwogICAgfQogICAgZXhwb3J0cy5mZXRjaEluc3RhbmNlID0gZmV0Y2hJbnN0YW5jZTsKICAgIC8qKgogICAgQ2xlYXJzIHRoZSBUaHJ1c3QgSW5zdGFuY2UgY2FjaGUsIHRoaXMgaXMgdXNlZCBmb3IgdW5pdCB0ZXN0aW5nLCBhbmQgY2xlYXJpbmcgYWxsIHRoZSBjYWNoZSBkYXRhIGVhY2ggcnVuLgogICAgCiAgICBAbWV0aG9kIGNsZWFyQ2FjaGUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5pbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmluc3RhbmNlc1t4XSA9IG51bGw7CiAgICAgICAgICAgIGRlbGV0ZSBleHBvcnRzLmluc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdOwogICAgICAgIH0pOwogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF07CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsZWFyQ2FjaGUgPSBjbGVhckNhY2hlOwogICAgLyp9Ki8gfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aW5zdGFuY2UuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdGhydXN0SW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgY29uZmlnIHsqLwogICAgCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBpZiBpdCBzaG91bGQgdGhyb3cgZXJyb3JzIG9yIG5vdC4KICAgIEluIHByb2R1Y3Rpb24gaXQncyByZWNvbW1lbmRlZCBub3QgdG8gdGhyb3cgZXJyb3JzLCB0aGF0IHdheSBpZiBhIGNvbXBvbmVudCBmYWlscwogICAgdGhlcmUgaXMgYSBjaGFuY2UgdGhlIGFwcGxpY2F0aW9uIGNhbiBzdGlsbCByZWNvdmVyLgogICAgCiAgICBAZm9yIHRocnVzdC5jb25maWcKICAgIEBwcm9wZXJ0eSB0aHJvd0Vycm9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqKi8KICAgIGV4cG9ydHMudGhyb3dFcnJvcnMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aGUgZnJhbWV3b3JrIHRvIHJ1biBpbiBhc3luYyBtb2RlLCB0aGlzIG1heSBkZWxheSBzdGFydCB1cCwgYnV0IHdpbGwgbWFrZSBpbWFnZSBsb2FkaW5nIGFuZCBpbml0YWwgcnVubmluZyBhcHBlYXIgZmFzdGVyLgogICAgCiAgICBAcHJvcGVydHkgYXN5bmMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuYXN5bmMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aHJ1c3QgdG8gZXhwb3NlIGVhY2ggaW5zdGFuY2UgYXMgYSBnbG9iYWwsIHRoaXMgYWxsb3dzIGxlZ2FjeSBjb21wb25lbnRzIHRvIHV0aWxpemUgcGFydHMgb2YgdGhydXN0LCBvciBlYXNpbHkKICAgIGdldCBhdCB5b3VyIHRocnVzdCBpbnN0YW5jZSBkdXJpbmcgZGVidWdnaW5nLgogICAgCiAgICBAcHJvcGVydHkgZXhwb3NlR2xvYmFscwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IHRydWUKICAgICoqLwogICAgZXhwb3J0cy5leHBvc2VHbG9iYWxzID0gdHJ1ZTsKICAgIGV4cG9ydHMudXJsID0gewogICAgICAgIHBhdGg6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIGdpdmVzIHRoZSBmcmFtZXdvcmsgaXQncyBkZWZhdWx0IHBhdGgsIGlmIGRpZmZlcmVudCB0aGFuICcvJwogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwucGF0aAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgIi8iCiAgICAgICAgKiovCiAgICAgICAgJy8nLAogICAgICAgIHRyYWRpdGlvbmFsRW5jb2Rpbmc6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaG93IGl0IHNob3VsZCBlbmNvZGUgYXJyYXkgZm9ybSBkYXRhLgogICAgICAgIEluIGdlbmVyYWwsIGZvciBBU1AuTkVUIGJhc2VkIGFwcGxpY2F0aW9ucywgdHJhZGl0aW9uYWwgc2hvdWxkIGJlIHRydWUuCiAgICAgICAgRm9yIFJ1YnkvUHl0aG9uIGJhc2VkIGFwcGxpY2F0aW9ucywgdGhpcyBzaG91bGQgYmUgZmFsc2UuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IHVybC50cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgZXhwb3J0cy5sb2cgPSB7CiAgICAgICAgbGV2ZWw6IC8qKgogICAgICAgIFRoaXMgbGVuZHMgdG8gdGhlIGxvZyBsZXZlbCBvZiB0aHJ1c3QuCiAgICAgICAgCiAgICAgICAgRVJST1I6IDEKICAgICAgICBXQVJOOiAyCiAgICAgICAgSU5GTzogMwogICAgICAgIERFQlVHOiA0CiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5sZXZlbAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgMQogICAgICAgICoqLwogICAgICAgIDQsCiAgICAgICAgZW5hYmxlZDogLyoqCiAgICAgICAgVGhpcyB0b2dnbGVzIGVuYWJsaW5nIG9uIG9yIG9mZi4KICAgICAgICAKICAgICAgICBAcHJvcGVydHkgbG9nLmVuYWJsZWQKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICoqLwogICAgICAgIHRydWUKICAgIH07CiAgICAvKioKICAgIFBsdWdpbnMgZm9yIHRocnVzdCB0byBsb2FkLCBvdmVycmlkZSB3aXRoIHlvdXIgb3duIHNldCBpZiB5b3UgaGF2ZSBhIGRpZmZlcmVudCBzZXQuCiAgICAKICAgIEBwcm9wZXJ0eSBwbHVnaW5zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5wbHVnaW5zID0gW107CiAgICAvKioKICAgICogVGhlIHNldCBvZiBtb2R1bGVzIHRvIHByZWxvYWQgd2l0aCB0aGUgaW5pdGFsIHdpcmV1cCBvZiB0aGUgVGhydXN0IGluc3RhbmNlLgogICAgKgogICAgKiBBY2NlcHRzIHRoZSBtb2R1bGUgcGF0aCBhIHN0cmluZyBvciB0aGUgbW9kdWxlIGFzIGFuIG9iamVjdCBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdC4KICAgICogICBXaGVyZSBhcmdzIHdpbGwgYmUgaGFuZGVkIG9mZiB0byB0aGUgbW9kdWxlIGxpZmUgY3ljbGUgbWV0aG9kcy4KICAgICoKICAgICogICAgewogICAgKiAgICAgICAgcGF0aDogJycsCiAgICAqICAgICAgICBhcmdzOiBbXQogICAgKiAgICB9CiAgICAqCiAgICAqIEBwcm9wZXJ0eSBtb2R1bGVzCiAgICAqIEByZWFkT25seQogICAgKiBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMubW9kdWxlcyA9IFtdOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluZSBpZiB0aGUgbGlmZS1jeWNsZSBpcyBjb250cm9sbGVkIGJ5IHRocnVzdCwgb3IgYSBwYXJlbnQgaW5zdGFuY2UuCiAgICAKICAgIEBwcm9wZXJ0eSBjaGlsZEluc3RhbmNlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgKiovCiAgICBleHBvcnRzLmNoaWxkSW5zdGFuY2UgPSBmYWxzZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhydXN0IHNob3VsZCBjb250cm9sIHRoZSBsaWZlLWN5Y2xlLCBvciB0aGUgY29uc3VtZXIKICAgIAogICAgQHByb3BlcnR5IGF1dG9tYXRpY0xpZmVjeWNsZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvbWF0aWNMaWZlY3ljbGUgPSB0cnVlOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluIGlmIHRoZSB0aHJ1c3QgaW5zdGFuY2Ugc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgdXBvbiBjcmVhdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGF1dG9TdGFydAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvU3RhcnQgPSBmYWxzZTsKICAgIC8qKgogICAgRGVmaW5lIHRoZSBjb252ZW50aW9ucyB0aGF0IHVuaXF1ZSB0byB0aHJ1c3QsIHRoZXkgYXJlIG5vdCBzcGVjaWZpYyB0byBhbnkgb25lIHBsdWdpbi4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vY29udGFpbmVyJywgCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycKICAgIF07CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgY29uZmlnIGZvciB0aGUgY3VycmVudCB0aHJ1c3QgaW5zdGFuY2UsIG9yIHRoZSBjb25maWcgb2YgdGhlIGdpdmVuIHBsdWdpbi4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBjb25maWcgcGx1Z2luLgogICAgdGhydXN0L2NvbmZpZyFnbG9iYWwgPSB0aHJ1c3QhZ2xvYmFsOmNvbmZpZyA9IFRocnVzdCBpbnN0YW5jZSBjb25maWcgZnJvbSB0aGUgaW5zdGFuY2UgbmFtZWQgZ2xvYmFsLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8IGZhbHNlOwogICAgICAgIHZhciBpbnN0YW5jZURlZmVycmVkID0gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VEZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IHBsdWdpbk5hbWUgJiYgY29udGV4dC5jZmdbcGx1Z2luTmFtZV0gfHwgY29udGV4dC5jb25maWc7CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luICInICsgcGx1Z2luTmFtZSArICciIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiJyArIHJlYWxOYW1lICsgJyIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9sb2cnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vY29uZmlnJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdENvbmZpZ19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgCiAgICAqKi8KICAgIAogICAgLy8gTG9nIGxldmVscwogICAgdmFyIExFVkVMID0gewogICAgICAgIERFQlVHOiA0LAogICAgICAgIElORk86IDMsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMQogICAgfTsKICAgIC8vIERlY2xhcmUgb3VyIHZhcmlhYmxlcwogICAgICAgIHZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGUsIHRpbWVycyA9IHsKICAgIH0sIGNMb2cgPSAoY29uc29sZSAmJiBjb25zb2xlLmxvZykgfHwgZmFsc2UsIGNXYXJuID0gKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB8fCBmYWxzZSwgY0luZm8gPSAoY29uc29sZSAmJiBjb25zb2xlLmluZm8pIHx8IGZhbHNlLCBjRXJyb3IgPSAoY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB8fCBmYWxzZSwgY1RpbWUgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lJ10pIHx8IGZhbHNlLCBjVGltZUVuZCA9IChjb25zb2xlICYmIGNvbnNvbGVbJ3RpbWVFbmQnXSkgfHwgZmFsc2UsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBjb25maWdMZXZlbCA9IHRDb25maWcubG9nLmxldmVsIHx8IExFVkVMLkVSUk9SLCBsb2dMZXZlbCA9IExFVkVMW2NvbmZpZ0xldmVsXSB8fCAodHlwZW9mIGNvbmZpZ0xldmVsID09PSAnc3RyaW5nJyAmJiBMRVZFTFtjb25maWdMZXZlbC50b1VwcGVyQ2FzZSgpXSkgfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ251bWJlcicgJiYgY29uZmlnTGV2ZWwpIHx8IExFVkVMLkVSUk9SOwogICAgLy8gVmFyaW91cyBsb2dnZXJzIHRvIGhhbmRsZSBJRTgvOSBzdXBwb3J0LgogICAgdmFyIGxvZ1J1bm5lciA9IGZ1bmN0aW9uIChjb25zb2xlTWV0aG9kLCBsb2dUeXBlKSB7CiAgICAgICAgLy8gU2hvdyBsb2dzIHdoZW4gZW5hYmxlZCBvciBpZiB0aGV5IGFyZSBlcnJvcnMKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBpZihjb25zb2xlTWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGNvbnNvbGVNZXRob2QuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKCFjb25zb2xlTWV0aG9kICYmIGNMb2cpIHsKICAgICAgICAgICAgaWYoY0xvZy5hcHBseSkgewogICAgICAgICAgICAgICAgY0xvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNMb2coYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkxvZwogICAgKiovCiAgICAvKioKICAgIExvZ3MgYSBkZWJ1ZyB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZAogICAgCiAgICBAbWV0aG9kIGRlYnVnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNMb2cpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2xvZycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZGVidWcgPSBkZWJ1ZzsKICAgIC8qKgogICAgTG9ncyBhIGluZm8gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGluZm8gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCBpbmZvCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLklORk8pIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjSW5mbyk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnaW5mbycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5mbyA9IGluZm87CiAgICAvKioKICAgIExvZ3MgYSB3YXJuIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB3YXJuIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2Qgd2FybgogICAgKiovCiAgICBmdW5jdGlvbiB3YXJuKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5XQVJOKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1dhcm4pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ3dhcm4nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLndhcm4gPSB3YXJuOwogICAgLyoqCiAgICBMb2dzIGEgZXJyb3IgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGVycm9yIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgZXJyb3IKICAgICoqLwogICAgZnVuY3Rpb24gZXJyb3IoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLkVSUk9SKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0Vycm9yKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdlcnJvcicpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZXJyb3IgPSBlcnJvcjsKICAgIC8qKgogICAgTG9ncyBhIHRpbWUgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWUgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCB0aW1lCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWUobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0gPSB7CiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1zZyA9IHV0aWwuZm9ybWF0KCd7MH06IHRpbWVyIHN0YXJ0ZWQnLCBtZXNzYWdlKSwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZSk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWUgPSB0aW1lOwogICAgLyoqCiAgICBMb2dzIGEgdGltZUVuZCB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZUVuZCBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgQ2F1c2VzIHRoZSB0aW1lciB0byBlbmQsIGZvciB0aGUgZ2l2ZW4gbWVzc2FnZS4KICAgIAogICAgQG1ldGhvZCB0aW1lRW5kCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWVFbmQobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0uZW5kID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKICAgICAgICAgICAgdmFyIHRpbWUgPSB0aW1lcnNbbWVzc2FnZV0uZW5kIC0gdGltZXJzW21lc3NhZ2VdLnN0YXJ0LCBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB7MX1tcycsIG1lc3NhZ2UsIHRpbWUpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZUVuZCk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWVFbmQgPSB0aW1lRW5kOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1sb2cuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvaWduaXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdtb2R1bGUnLCAndGhydXN0L3V0aWwnLCAnLi9jb25maWcnLCAnLi9jYXBzdWxlJywgJy4vaW5zdGFuY2UnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19yZXF1aXJlTW9kdWxlX18sIF9fdXRpbF9fLCBfX2NvbmZpZ19fLCBfX3RtX18sIF9faW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgcmVxdWlyZU1vZHVsZSA9IF9fcmVxdWlyZU1vZHVsZV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0bSA9IF9fdG1fXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBpc0FycmF5ID0gXy5pc0FycmF5LCB0b0FycmF5ID0gXy50b0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgYW55ID0gXy5hbnksIGFsbCA9IF8uYWxsLCB3aGVuID0gdXRpbC53aGVuLCBleHRlbmQgPSBfLmV4dGVuZCwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGtleXMgPSBfLmtleXMsIHVuaW9uID0gXy51bmlvbjsKICAgIC8qZnVuY3Rpb24gcmVjb25jaWxlQXJyYXlzKGNvbmZpZywgc2V0dGluZ3MsIHRvKQogICAgewogICAgdmFyIGtleXMgPSBfLmtleXMoY29uZmlnKTsKICAgIGlmIChzZXR0aW5ncykKICAgIHsKICAgIGtleXMgPSB1bmlvbihfLmtleXMoc2V0dGluZ3MpLCBrZXlzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgIHNldHRpbmdzID0ge307CiAgICB9CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChpKQogICAgewogICAgdmFyIHggPSBzZXR0aW5nc1tpXSB8fCBjb25maWdbaV07CiAgICBpZiAoaXNBcnJheSh4KSkKICAgIHsKICAgIHRvW2ldID0gdG9BcnJheShzZXR0aW5nc1tpXSB8fCB0b1tpXSk7CiAgICB9CiAgICBlbHNlIGlmIChpc09iamVjdCh4KSAmJiAhaXNGdW5jdGlvbih4KSkKICAgIHsKICAgIHJlY29uY2lsZUFycmF5cyh4LCBudWxsLCB0b1tpXSk7CiAgICB9CiAgICB9KTsKICAgIH0qLwogICAgZnVuY3Rpb24gbWVyZ2VTZXR0aW5ncyhzZXR0aW5ncykgewogICAgICAgIGlmKChzZXR0aW5ncykuX19zZXR0aW5nc01lcmdlZCkgewogICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgfQogICAgICAgIHZhciByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgcGx1Z2lucyA9IFsKICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvcicKICAgICAgICBdLmNvbmNhdChzZXR0aW5ncy5wbHVnaW5zIHx8IHJlcXVpcmVDb25maWcucGx1Z2lucyB8fCBjb25maWcucGx1Z2lucyB8fCBbXSksIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHJlcXVpcmVNb2R1bGUuY29uZmlnKCkuY29udmVudGlvbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pOwogICAgICAgIHNldHRpbmdzID0gXy5tZXJnZSh7CiAgICAgICAgfSwgY29uZmlnLCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLCBzZXR0aW5ncywgewogICAgICAgICAgICBfX3NldHRpbmdzTWVyZ2VkOiB0cnVlLAogICAgICAgICAgICBwbHVnaW5zOiBwbHVnaW5zLAogICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICB9KTsKICAgICAgICBzZXR0aW5ncy5wbHVnaW5zID0gcGx1Z2luczsKICAgICAgICBzZXR0aW5ncy5jb252ZW50aW9ucyA9IGNvbnZlbnRpb25zOwogICAgICAgIHJldHVybiBzZXR0aW5nczsKICAgIH0KICAgIGV4cG9ydHMubWVyZ2VTZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3M7CiAgICBmdW5jdGlvbiBmdXNlKHNldHRpbmdzKSB7CiAgICAgICAgdmFyIHBpcGUgPSBbXTsKICAgICAgICBzZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgIGlmKCFpbnN0YW5jZS5pbnN0YW5jZXNbc2V0dGluZ3MubmFtZV0pIHsKICAgICAgICAgICAgcGlwZS5wdXNoKHN0YWdlT25lKTsKICAgICAgICB9CiAgICAgICAgcGlwZS5wdXNoKHN0YWdlVHdvKTsKICAgICAgICBpZihzZXR0aW5ncy5tb2R1bGVzICYmIHNldHRpbmdzLm1vZHVsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZVRocmVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuZnVzZSA9IGZ1c2U7CiAgICAvKioKICAgIENvbnRydWN0cyBhIHdpcmUgc3BlYyBmb3IgdGhydXN0IHRvIGxhdW5jaCBmcm9tLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIE1lcmdlcyBhIGFsbCB0aGUgcGx1Z2lucyBjb25maWd1cmF0aW9ucywgd2l0aCB0aGUgZGVmYXVsdCBjb25maWcsIGFuZCB0aGVuIGZpbmFsbHkgd2l0aAogICAgYW55IGN1c3RvbWl6ZWQgY29uZmlnIGZyb20gcmVxdWlyZWpzCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VPbmUKICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGludHMgdG8gcGFzcyBvbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYmVpbmcgY3JlYXRlZC4KICAgICoqLwogICAgZnVuY3Rpb24gc3RhZ2VPbmUoc2V0dGluZ3MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBzZXR0aW5ncy5wbHVnaW5zLCByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgcmVxdWlyZShwbHVnaW5zLm1hcChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9KSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcGx1Z2lucy5mb3JFYWNoKGZ1bmN0aW9uIChwbHVnaW4sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5TZXR0aW5ncyA9IHNldHRpbmdzW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpblJlcXVpcmVDb25maWcgPSByZXF1aXJlQ29uZmlnW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpbkNsYXNzID0gYXJnc1tpXVthcmdzW2ldLmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICBpZighY29uZmlnW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnW25hbWVdID0gXy5tZXJnZShwbHVnaW5DbGFzcy5jb25maWcsIHBsdWdpblJlcXVpcmVDb25maWcgfHwgewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHBsdWdpblNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHBsdWdpblJlcXVpcmVDb25maWcuY29udmVudGlvbnMgfHwgY29uZmlnW25hbWVdLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdID0gXy5tZXJnZSh7CiAgICAgICAgICAgICAgICB9LCBjb25maWdbbmFtZV0sIHBsdWdpblNldHRpbmdzIHx8IHsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0dGluZ3NbbmFtZV0uY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc2V0dGluZ3MpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlT25lID0gc3RhZ2VPbmU7CiAgICAvKioKICAgIENyZWF0ZXMgYSB0aHJ1c3QgaW5zdGFuY2UsIGZyb20gdGhlIGdpdmVuIHNldHRpbmdzLgogICAgSW5jbHVkaW5nIHRoZSBwbHVnaW5zLgogICAgCiAgICBAbWV0aG9kIHN0YWdlVHdvCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVHdvKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgIC8vIEdldCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gc2V0dGluZ3MsIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIC8vIE1lZGlhdG9yIGlzIGEgcmVxdWlyZWQgcGx1Z2luLCBpbmNsdWRlIGFsbCB0aGUgb3RoZXJzIGluIGFkZGl0aW9uIHRvIGl0LgogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBsb2NhbENvbmZpZy5wbHVnaW5zLCBtb2R1bGVzVG9Mb2FkID0gLy8gVGhlIG1vZHVsZXMgdG8gbG9hZAogICAgICAgIFtdLCB0aHJ1c3RDb252ZW50aW9ucyA9IHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdLCBtb2R1bGVzQ29uZmlndXJhdGlvbnMgPSAvLyBUaGUgbW9kdWxlIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgewogICAgICAgICAgICB0aHJ1c3Q6ICd0aHJ1c3QnCiAgICAgICAgfTsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zLCBjcmVhdGluZyBhIHByb3BlciBkZXBlbmRhbmN5IGxpc3QuCiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5zW2ldLCBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSBsb2NhbENvbmZpZ1tuYW1lXTsKICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbik7CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW5Db25maWcgJiYgcGx1Z2luQ29uZmlnLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgbW9kdWxlc0NvbmZpZ3VyYXRpb25zW3BsdWdpbl0gPSBwbHVnaW5Db25maWc7CiAgICAgICAgfQogICAgICAgIC8vIE5hbWUgYW5kIGNmZyBhcmUgZGVmYXVsdCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIGNvbnRleHQKICAgICAgICAgICAgICAgIHZhciBvcmRlcmVkUGx1Z2lucyA9IFsKICAgICAgICAgICAgJ25hbWUnLCAKICAgICAgICAgICAgJ2NmZycKICAgICAgICBdLCByZWxvb3AgPSAvLyBXZSBsb29wIHRocm91Z2ggdW50aWwgYWxsIHRoZSBwbHVnaW5zIGFyZSBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgdHJ1ZSwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoLCBpID0gMDsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zIHVudGlsIHdlIGhhdmUgYSBzZXQgdGhhdCB3aWxsIGxvYWQgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHdoaWxlKGkgPCBpTGVuKSB7CiAgICAgICAgICAgIC8vIFRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG5hbWUgPSAvLyBUaGUgaW1wbGllZCBwbHVnaW4gbmFtZQogICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHBsdWdpbkNvbmZpZyA9IC8vIFRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBwbHVnaW4gaGFzIHRvIHJlc29sdmUgYW55IG90aGVyIHBsdWdpbnMKICAgICAgICAgICAgaWYocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlLmxlbmd0aCA+IDAgJiYgIWFsbChwbHVnaW5Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbnkob3JkZXJlZFBsdWdpbnMsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHggPT09IHogfHwgeCA9PT0gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSkgewogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZC4KICAgICAgICAgICAgICAgIC8vIEFsc28gaW5jbHVkZXMgYW55IGNvbnZlbnRpb25zLgogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIG1vZHVsZXNUb0xvYWQuc3BsaWNlKGksIDIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgb3JkZXJlZFBsdWdpbnMucHVzaChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBUaGUgbW9kdWxlcyBjb25maWcKICAgICAgICB2YXIgbW9kdWxlcyA9IGxvY2FsQ29uZmlnLm1vZHVsZXMgfHwgW107CiAgICAgICAgLy8gVGhydXN0IGFuZCB0aHJ1c3QvY2Fwc3VsZSBhbHNvIG5lZWQgdG8gYmUgbG9hZGVkLgogICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBbCiAgICAgICAgICAgICd0aHJ1c3QnLCAKICAgICAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgfHwgW10KICAgICAgICBdKTsKICAgICAgICAvLyBGbGF0dGVuIHRoZSByZXN1bHRhbnQgYXJyYXkKICAgICAgICBtb2R1bGVzVG9Mb2FkID0gZmxhdHRlbihtb2R1bGVzVG9Mb2FkKTsKICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZ3VyYXRpb24gc3BlYwogICAgICAgIHZhciBzcGVjID0gewogICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnCiAgICAgICAgfTsKICAgICAgICAvLyBMb2FkIGV2ZXJ5dGhpbmcKICAgICAgICByZXF1aXJlKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gR2V0IHJlYWR5IHRvIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRQbHVnaW4gPSBudWxsLCBhbGxDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBtb2R1bGVzIGJlaW5nIGxvYWRlZAogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlc1RvTG9hZC5sZW5ndGg7IGkgPCBpTGVuIC0gdGhydXN0Q29udmVudGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIEdldCBwbHVnaW4gYW5kIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gbW9kdWxlc1RvTG9hZFtpXSwgbUNvbmZpZyA9IG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICBpZihtQ29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhIG5ldyBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luT2JqZWN0ID0gYXJnc1tpXSwgbmFtZSA9IC8vIEdldCB0aGUgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHJlc29sdmVJdGVtcyA9IC8vIFJlc29sdmUgYWxsIHRoZSByZXF1aXJlZCBpdGVtcy4KICAgICAgICAgICAgICAgICAgICBtYXAobUNvbmZpZy5yZXNvbHZlLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3BlY1t4XTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luQ2xhc3MgPSBwbHVnaW5PYmplY3RbcGx1Z2luT2JqZWN0LmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4gPSBzcGVjW25hbWVdID0gdXRpbC5pbnN0YW50aWF0ZShwbHVnaW5DbGFzcywgcmVzb2x2ZUl0ZW1zKTsKICAgICAgICAgICAgICAgICAgICAvLyBTZXR1cCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBMb2FkIGFsbCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9ucyBpbnRvIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGFyZ3NbaV0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGxDb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRoZSBsYXN0IGN1cnJlbnQgcGx1Z2luLCB3aWxsIGFsd2F5cyBiZSB0aHJ1c3QuCiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IGFsbENvbnZlbnRpb25zOwogICAgICAgICAgICB2YXIgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zID0gYXJncy5zbGljZShtb2R1bGVzVG9Mb2FkLmxlbmd0aCAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGZsYXR0ZW4obWFwKHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXAoeCwgZnVuY3Rpb24gKHopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX190aHJ1c3RDb252ZW50aW9ucyA9IHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9uczsKICAgICAgICAgICAgYWxsQ29udmVudGlvbnMucHVzaC5hcHBseShhbGxDb252ZW50aW9ucywgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zKTsKICAgICAgICAgICAgLy8gRXh0ZW5kIHRocnVzdCB3aXRoIHRoZSBzcGVjCiAgICAgICAgICAgIGV4dGVuZChjdXJyZW50UGx1Z2luLCBzcGVjKTsKICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShzcGVjKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVR3byA9IHN0YWdlVHdvOwogICAgLyoqCiAgICBMb2FkcyB1cCB0aGUgZGVmYXVsdCBtb2R1bGVzIGFzIGluZGljYXRlZCB0byB0aHJ1c3QuCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VUaHJlZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gdXNlIHRvIGxvYWQgdGhlIG1vZHVsZXMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVGhyZWUoY29udGV4dCkgewogICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZGVmZXIgPSB3aGVuLmRlZmVyKCksIG1vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzOwogICAgICAgIG1vZHVsZXMgPSBfLmZpbHRlcihtb2R1bGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4gIXRocnVzdC5tb2R1bGVzW3hdOwogICAgICAgIH0pOwogICAgICAgIHJlcXVpcmUobW9kdWxlcywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgTW9kdWxlID0gdG0uTW9kdWxlOwogICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb25zCiAgICAgICAgICAgIHZhciBtb2R1bGVEZWZpbml0aW9ucyA9IGFyZ3M7CiAgICAgICAgICAgIC8vIExvb3Agb3ZlciBhbGwgdGhlIG1vZHVsZXMKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIG1vZHVsZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZCA9IG1vZHVsZXNbaV0sIGRlZmluaXRpb24gPSAvLyBHZXQgdGhlIGRlZmluaXRpb24KICAgICAgICAgICAgICAgIG1vZHVsZURlZmluaXRpb25zW2ldOwogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbmV3IE1vZHVsZSh0aHJ1c3QsIGRlZmluaXRpb24sIG1vZCk7CiAgICAgICAgICAgICAgICAvLyBJbmplY3QgaXQgaW50byB0aGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50aHJ1c3RDcmVhdGUodGhydXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlVGhyZWUgPSBzdGFnZVRocmVlOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1pZ25pdGUuanMubWFwCjsKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyBkb21SZWFkeSAyLjAuMSBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL3JlcXVpcmVqcy9kb21SZWFkeSBmb3IgZGV0YWlscwogKi8KLypqc2xpbnQgKi8KLypnbG9iYWwgcmVxdWlyZTogZmFsc2UsIGRlZmluZTogZmFsc2UsIHJlcXVpcmVqczogZmFsc2UsCiAgd2luZG93OiBmYWxzZSwgY2xlYXJJbnRlcnZhbDogZmFsc2UsIGRvY3VtZW50OiBmYWxzZSwKICBzZWxmOiBmYWxzZSwgc2V0SW50ZXJ2YWw6IGZhbHNlICovCgoKZGVmaW5lKCdkb21SZWFkeScsW10sZnVuY3Rpb24gKCkgewogICAgCgogICAgdmFyIGlzVG9wLCB0ZXN0RGl2LCBzY3JvbGxJbnRlcnZhbElkLAogICAgICAgIGlzQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCwKICAgICAgICBpc1BhZ2VMb2FkZWQgPSAhaXNCcm93c2VyLAogICAgICAgIGRvYyA9IGlzQnJvd3NlciA/IGRvY3VtZW50IDogbnVsbCwKICAgICAgICByZWFkeUNhbGxzID0gW107CgogICAgZnVuY3Rpb24gcnVuQ2FsbGJhY2tzKGNhbGxiYWNrcykgewogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgY2FsbGJhY2tzW2ldKGRvYyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGxSZWFkeSgpIHsKICAgICAgICB2YXIgY2FsbGJhY2tzID0gcmVhZHlDYWxsczsKCiAgICAgICAgaWYgKGlzUGFnZUxvYWRlZCkgewogICAgICAgICAgICAvL0NhbGwgdGhlIERPTSByZWFkeSBjYWxsYmFja3MKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlYWR5Q2FsbHMgPSBbXTsKICAgICAgICAgICAgICAgIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGFnZSBhcyBsb2FkZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhZ2VMb2FkZWQoKSB7CiAgICAgICAgaWYgKCFpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgaXNQYWdlTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHNjcm9sbEludGVydmFsSWQpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc2Nyb2xsSW50ZXJ2YWxJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhbGxSZWFkeSgpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNCcm93c2VyKSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgLy9TdGFuZGFyZHMuIEhvb3JheSEgQXNzdW1wdGlvbiBoZXJlIHRoYXQgaWYgc3RhbmRhcmRzIGJhc2VkLAogICAgICAgICAgICAvL2l0IGtub3dzIGFib3V0IERPTUNvbnRlbnRMb2FkZWQuCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBwYWdlTG9hZGVkLCBmYWxzZSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAod2luZG93LmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgcGFnZUxvYWRlZCk7CgogICAgICAgICAgICB0ZXN0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpc1RvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT09IG51bGw7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgICAgICAvL0RPTUNvbnRlbnRMb2FkZWQgYXBwcm94aW1hdGlvbiB0aGF0IHVzZXMgYSBkb1Njcm9sbCwgYXMgZm91bmQgYnkKICAgICAgICAgICAgLy9EaWVnbyBQZXJpbmk6IGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvLAogICAgICAgICAgICAvL2J1dCBtb2RpZmllZCBieSBvdGhlciBjb250cmlidXRvcnMsIGluY2x1ZGluZyBqZGFsdG9uCiAgICAgICAgICAgIGlmICh0ZXN0RGl2LmRvU2Nyb2xsICYmIGlzVG9wICYmIHdpbmRvdy5leHRlcm5hbCkgewogICAgICAgICAgICAgICAgc2Nyb2xsSW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXN0RGl2LmRvU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICAgICAgfSwgMzApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0NoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgY29tcGxldGUsIGFuZCBpZiBzbywganVzdCB0cmlnZ2VyIHBhZ2UgbG9hZAogICAgICAgIC8vbGlzdGVuZXJzLiBMYXRlc3Qgd2Via2l0IGJyb3dzZXJzIGFsc28gdXNlICJpbnRlcmFjdGl2ZSIsIGFuZAogICAgICAgIC8vd2lsbCBmaXJlIHRoZSBvbkRPTUNvbnRlbnRMb2FkZWQgYmVmb3JlICJpbnRlcmFjdGl2ZSIgYnV0IG5vdCBhZnRlcgogICAgICAgIC8vZW50ZXJpbmcgImludGVyYWN0aXZlIiBvciAiY29tcGxldGUiLiBNb3JlIGRldGFpbHM6CiAgICAgICAgLy9odHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL3RoZS1lbmQuaHRtbCN0aGUtZW5kCiAgICAgICAgLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM2NjU1NjEvZG9jdW1lbnQtcmVhZHlzdGF0ZS1vZi1pbnRlcmFjdGl2ZS12cy1vbmRvbWNvbnRlbnRsb2FkZWQKICAgICAgICAvL0htbSwgdGhpcyBpcyBtb3JlIGNvbXBsaWNhdGVkIG9uIGZ1cnRoZXIgdXNlLCBzZWUgImZpcmluZyB0b28gZWFybHkiCiAgICAgICAgLy9idWc6IGh0dHBzOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvZG9tUmVhZHkvaXNzdWVzLzEKICAgICAgICAvL3NvIHJlbW92aW5nIHRoZSB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiaW50ZXJhY3RpdmUiIHRlc3QuCiAgICAgICAgLy9UaGVyZSBpcyBzdGlsbCBhIHdpbmRvdy5vbmxvYWQgYmluZGluZyB0aGF0IHNob3VsZCBnZXQgZmlyZWQgaWYKICAgICAgICAvL0RPTUNvbnRlbnRMb2FkZWQgaXMgbWlzc2VkLgogICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIFNUQVJUIE9GIFBVQkxJQyBBUEkgKiovCgogICAgLyoqCiAgICAgKiBSZWdpc3RlcnMgYSBjYWxsYmFjayBmb3IgRE9NIHJlYWR5LiBJZiBET00gaXMgYWxyZWFkeSByZWFkeSwgdGhlCiAgICAgKiBjYWxsYmFjayBpcyBjYWxsZWQgaW1tZWRpYXRlbHkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICovCiAgICBmdW5jdGlvbiBkb21SZWFkeShjYWxsYmFjaykgewogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgY2FsbGJhY2soZG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWFkeUNhbGxzLnB1c2goY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZG9tUmVhZHk7CiAgICB9CgogICAgZG9tUmVhZHkudmVyc2lvbiA9ICcyLjAuMSc7CgogICAgLyoqCiAgICAgKiBMb2FkZXIgUGx1Z2luIEFQSSBtZXRob2QKICAgICAqLwogICAgZG9tUmVhZHkubG9hZCA9IGZ1bmN0aW9uIChuYW1lLCByZXEsIG9uTG9hZCwgY29uZmlnKSB7CiAgICAgICAgaWYgKGNvbmZpZy5pc0J1aWxkKSB7CiAgICAgICAgICAgIG9uTG9hZChudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb21SZWFkeShvbkxvYWQpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqIEVORCBPRiBQVUJMSUMgQVBJICoqLwoKICAgIHJldHVybiBkb21SZWFkeTsKfSk7CgpkZWZpbmUoJ3RocnVzdC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2xvZycsICcuL2luc3RhbmNlJywgJy4vaWduaXRlJywgJy4vY2Fwc3VsZScsICdkb21SZWFkeScsICdoYXMnLCAndGhydXN0L2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX190aHJ1c3RJbnN0YW5jZV9fLCBfX2lnbml0ZVNwZWNfXywgX19tX18sIF9fZG9tUmVhZHlfXywgX19oYXNfXywgX190Q29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIHZhciBpZ25pdGVTcGVjID0gX19pZ25pdGVTcGVjX187CgogICAgdmFyIG0gPSBfX21fXzsKCiAgICB2YXIgTW9kdWxlID0gbS5Nb2R1bGU7CiAgICB2YXIgZG9tUmVhZHkgPSBfX2RvbVJlYWR5X187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUaHJ1c3QnOwogICAgLyoqCiAgICBUaGUgdGhydXN0IGFwcGxpY2F0aW9uIQogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQG1haW4gdGhydXN0CiAgICAqKi8KICAgICAgICB2YXIgSU5JVCA9ICdpbml0JywgU1RBUlQgPSAnc3RhcnQnLCBSRUFEWSA9ICdyZWFkeScsIFNUT1AgPSAnc3RvcCcsIERFU1RST1kgPSAnZGVzdHJveScsIENPVU5URE9XTiA9ICdjb3VudGRvd24nLCBJR05JVEUgPSAnaWduaXRlJywgT1JCSVQgPSAnb3JiaXQnLCBERVBMT1kgPSAnZGVwbG95JywgREVPUkJJVCA9ICdkZW9yYml0JywgU1BMQVNIRE9XTiA9ICdzcGxhc2hkb3duJywgSU5PUkJJVCA9ICdpbk9yYml0JywgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpc0FycmF5ID0gXy5pc0FycmF5LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgdG9BcnJheSA9IF8udG9BcnJheSwgbWVyZ2UgPSBfLm1lcmdlLCBmbGF0dGVuID0gXy5mbGF0dGVuLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgcmVzb2x2ZU1ldGhvZHMgPSBbCiAgICAgICAgSU5JVCwgCiAgICAgICAgU1RBUlQsIAogICAgICAgIFJFQURZLCAKICAgICAgICBTVE9QLCAKICAgICAgICBERVNUUk9ZCiAgICBdLCBpbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5pbnN0YW5jZXMsIGxvYWRpbmdJbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5sb2FkaW5nSW5zdGFuY2VzLCBzYWZlSW52b2tlID0gdXRpbC5zYWZlSW52b2tlOwogICAgLy8jcmVnaW9uIFJ1bm5lciBGYWN0b3JpZXMKICAgIHZhciBydW5SdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgdmFyIGNvbnZlbnRpb25NZXRob2QgPSAobWV0aG9kID09PSBTVE9QICYmIFNUQVJUKSB8fCAobWV0aG9kID09PSBERVNUUk9ZICYmIElOSVQpIHx8IG1ldGhvZCwgY29udmVudGlvblZhbHVlID0gIShtZXRob2QgPT09IFNUT1AgfHwgbWV0aG9kID09PSBERVNUUk9ZKSwgdW5zZXRSZWFkeSA9IG1ldGhvZCA9PT0gU1RPUCwgY29udmVudGlvbkNoZWNrID0gY29udmVudGlvbk1ldGhvZCAhPT0gbWV0aG9kLCBjb252ZW50aW9uTmFtZSA9IGZvcm1hdCgnezB9LXN0YXR1cycsIGNvbnZlbnRpb25NZXRob2QpLCBydW5uZXIgPSBydW5uZXJGYWN0b3J5KG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSksIGxvZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iIGZhaWxlZCEnLCBtZXRob2QpLCBydW5uaW5nTWVzc2FnZSA9IGZvcm1hdCgnVGhydXN0OiBSdW5uaW5nIHswfSBmb3IgbW9kdWxlICJ7ezB9fSIuJywgbWV0aG9kKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZXMpKSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncywgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBlYWNoKG5hbWVzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KHJ1bm5pbmdNZXNzYWdlLCBuYW1lKSk7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICAgICAgaWYoIW1vZCAmJiAhdGhhdC5mYWlsZWRNb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIGZldGNoIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuaW5nIHRoZSBwcm9wZXIgZGVmZXIgaW4gaXQncyBwbGFjZQogICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXJEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZQogICAgICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3JlYXRlTW9kdWxlKG1vZHVsZURlZm4gJiYgbW9kdWxlRGVmbi5uYW1lIHx8IG5hbWUsIG1vZHVsZURlZm4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZURlZm4ubmFtZQogICAgICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4od2hlbi5hbGwoZmxhdHRlbihyZXN1bHQpKSwgbG9hZGVyRGVmZXIpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5mYWlsZWRNb2R1bGVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyRGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChsb2FkZXJEZWZlci5wcm9taXNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZigoY29udmVudGlvbkNoZWNrICYmIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkgfHwgIW1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGlmKHRydWUgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZXJyb3IoZm9ybWF0KGxvZ01lc3NhZ2UsIG5hbWUpLCBlLCBlLnN0YWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aCAmJiByZXN1bHRzOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBydW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KSB7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGZvcm1hdCgndGhydXN0L21vZHVsZS97MH0nLCBtZXRob2QpLCBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IicsIG1ldGhvZC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG1ldGhvZC5zdWJzdHJpbmcoMSkpLCBkZWJ1Z0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiBDYWxsaW5nIG1vZHVsZSAie3swfX0iIHswfSgpJywgbWV0aG9kKSwgY29tcEFmdGVyID0gbWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSB8fCBmYWxzZTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQsIG5hbWUsIG1vZCwgYXJncykgewogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBuYW1lKSk7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG1hcChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHguY29udmVudGlvbignYXV0b1N0YXJ0JykgJiYgaTsKICAgICAgICAgICAgfSkuam9pbignLCAnKSkpOwogICAgICAgICAgICBlYWNoKG1vZHVsZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICBpZighY2hlY2tBdXRvU3RhcnQgfHwgKGNoZWNrQXV0b1N0YXJ0ICYmIHguY29udmVudGlvbignYXV0b1N0YXJ0JykpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRoYXRbbWV0aG9kXShpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0aW5nTW9kdWxlcyAmJiBjaGVja0F1dG9TdGFydCkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoaW5mb0Zvcm1hdCwgdGhhdC5zdGFydGluZ01vZHVsZXMuam9pbignLCAnKSkpOwogICAgICAgICAgICAgICAgdGhhdFttZXRob2RdKHRoYXQuc3RhcnRpbmdNb2R1bGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwocmVzdWx0cyk7CiAgICAgICAgfTsKICAgIH0pOwogICAgZnVuY3Rpb24gZmlyZVRocnVzdEV2ZW50KHRoYXQsIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUoZXZlbnQpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgbWV0aG9kLCBzdG9wcGluZykgewogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGVhY2godGhhdC5jaGlsZHJlbiwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgIGlmKHN0b3BwaW5nKSB7CiAgICAgICAgICAgICAgICBjaGlsZC5fX3ByZXZpb3VzU3RhdGUgPSBjaGlsZC5zdGFydGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNoaWxkLmNmZy5hdXRvU3RhcnQgfHwgKCFzdG9wcGluZyAmJiBjaGlsZC5fX3ByZXZpb3VzU3RhdGUpIHx8IChzdG9wcGluZyAmJiBjaGlsZC5zdGFydGVkKSkgewogICAgICAgICAgICAgICAgaXRlbXMucHVzaChjaGlsZFttZXRob2RdKGZhbHNlLCB0cnVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZihpdGVtcy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGl0ZW1zKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIGFycikgewogICAgICAgIHJldHVybiB1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzKGFyci5jb25jYXQodGhhdC5jZmcuYXN5bmMgJiYgWwogICAgICAgICAgICB3aGVuLmRlbGF5KDApCiAgICAgICAgXSB8fCBbXSkpOwogICAgfQogICAgdmFyIHRocnVzdExvZ0V2ZW50OwogICAgaWYodHJ1ZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0OiBDcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgInswfSInLCBuYW1lKSk7CiAgICAgICAgICAgIHZhciBvbGRNb2R1bGUsIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihwcmVCdWlsdCkgewogICAgICAgICAgICAgICAgb2xkTW9kdWxlID0gbW9kOwogICAgICAgICAgICAgICAgbW9kID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFwcmVCdWlsdCkgewogICAgICAgICAgICAgICAgbW9kID0gbmV3IG0uTW9kdWxlKHRoYXQsIG1vZCwgbmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtb2QgPSBvbGRNb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW9kdWxlcyBjYW5ub3QgaGF2ZSBkdXBsaWNhdGUgbmFtZXMsIGNob29zZSBhIG5ldyBvbmUuCiAgICAgICAgICAgIGlmKHRoYXQubW9kdWxlc1ttb2QubmFtZV0pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ0R1cGxpY2F0ZSBtb2R1bGUgbmFtZSAiezB9Ii4nLCBuYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbSBpcyB0aGUgbWVkaWF0b3JzIGludGVybmFsIG1vZHVsZS4KICAgICAgICAgICAgdGhhdC5tb2R1bGVzW21vZC5uYW1lXSA9IG1vZDsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRlZCBtb2R1bGUgInswfSInLCBuYW1lKSk7CiAgICAgICAgICAgIC8vIE5vdGlmeSB0aGUgbWVkaWF0b3IgdGhhdCBhIG1vZHVsZSBoYXMgYmVlbiBjcmVhdGVkLgogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9tb2R1bGUvY3JlYXRlJywgbmFtZSk7CiAgICAgICAgICAgIGlmKHRoYXQgJiYgdGhhdC5zdGFydGVkICYmIG1vZC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydChtb2QubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZDsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnR1cCA9IC8vI3JlZ2lvbiBHbG9iYWwgUnVubmVycwogICAgICAgIGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBldmVudCwgdGhhdCksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIGV2ZW50KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fY291bnRkb3duID0gZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gaW5pdGFsaXplZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmNvdW50ZG93biA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgY291bnRkb3duIHRvIHRocnVzdHMgc3RhcnQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGNvdW50ZG93biBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhhdC5jZmcuYXV0b21hdGljTGlmZWN5Y2xlICYmICghdGhhdC5jZmcuY2hpbGRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoU2VxdWVuY2UodGhhdCwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0Ll9jb3VudGRvd24oY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pZ25pdGUgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGluZ2l0aW9uIGFzIHRocnVzdCBzdGFydHMgdXAuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdGaXJpbmcgcm9ja2V0cyBmb3IgdGh1cnN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKElHTklURSwgU1RBUlQpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnRmlyaW5nIHN0YWdlIHR3byB0aHJ1c3RlcnMgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpKCk7CiAgICAgICAgICAgIHZhciBkb21SZWFkeURlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBkb21SZWFkeURlZmVyLnByb21pc2UudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9kb20vcmVhZHknKSk7CiAgICAgICAgICAgIGRvbVJlYWR5KGRvbVJlYWR5RGVmZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICBkb21SZWFkeURlZmVyLnByb21pc2UsIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIE9SQklULCB0aGF0KSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgT1JCSVQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBhbG1vc3QgcmVhZHkuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5kZXBsb3kgPSAvKioKICAgICAgICBUaHJ1c3QgZGVwbG95cyBjb21wb25lbnRzIGluIG9yYml0CiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVwbG95CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhydXN0IGhhcyBmdWxseSBkZXBsb3llZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgcmVhZHkuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pbk9yYml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuc3RhcnRlZCA9IHRydWU7CiAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBJTk9SQklUKTsKICAgICAgICAgICAgaWYodHJ1ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVTdGFydCA9IHRoYXQuY29uZmlnLmRlYnVnLnRpbWVTdGFydCwgdGltZUVuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBzdGFydFRpbWUgPSAodGltZUVuZCAtIHRpbWVTdGFydCk7CiAgICAgICAgICAgICAgICBsb2cuaW5mbygnU3RhcnRlZCBpbiAnICsgc3RhcnRUaW1lICsgJ21zJyk7CiAgICAgICAgICAgICAgICB2YXIgdHRyRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0cicpOwogICAgICAgICAgICAgICAgaWYodHRyRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRyRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc2h1dGRvd24gPSBmdW5jdGlvbiAoZXZlbnQsIGV2ZW50VHlwZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQsIHRydWUpLCAKICAgICAgICAgICAgICAgIHRoYXRbZXZlbnRUeXBlXSgpLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBldmVudCwgdGhhdCkKICAgICAgICAgICAgXSkpOwogICAgICAgICAgICB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvJyArIGV2ZW50VHlwZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuX2Rlb3JiaXQgPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyBzdG9wcGVkLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuZGVvcmJpdCA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgZGVvcmJpdCBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgU2h1dGRvd24gY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShbCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuX2Rlb3JiaXQsIHRoYXQpLCAKICAgICAgICAgICAgICAgICAgICBfLmJpbmQodGhhdC5zcGxhc2hkb3duLCB0aGF0KQogICAgICAgICAgICAgICAgXSwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0Ll9kZW9yYml0KGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3BsYXNoZG93biA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgc3BsYXNoZG93biBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgU2h1dGRvd24gY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ0xhbmRpbmcgaW4gdGhlIG1pZGRsZSBvZiB0aGUgYXRsYW50aWMgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXMuc2h1dGRvd24oU1BMQVNIRE9XTiwgREVTVFJPWSk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHJ1ZSkgewogICAgICAgICAgICAgICAgc2V0dGluZ3MuZGVidWcgPSB7CiAgICAgICAgICAgICAgICAgICAgdGltZVN0YXJ0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXR0aW5ncyA9IGlnbml0ZVNwZWMubWVyZ2VTZXR0aW5ncyhzZXR0aW5ncyk7CiAgICAgICAgICAgIHZhciBwaXBlID0gWwogICAgICAgICAgICAgICAgaWduaXRlU3BlYy5mdXNlCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHZhciBzZXR1cERlZmVyID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShzZXR0aW5ncy5uYW1lKTsKICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIG1vZHVsZXMgPSB0aHJ1c3Quc3RhcnRpbmdNb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlcywgY29uZmlnID0gdGhydXN0LmNvbmZpZyA9IHRocnVzdC5jZmc7CiAgICAgICAgICAgICAgICBpbnN0YW5jZXNbdGhydXN0Lm5hbWVdID0gdGhydXN0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihzZXR0aW5ncy5hdXRvbWF0aWNMaWZlY3ljbGUpIHsKICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBUaHJ1c3QubGF1bmNoU2VxdWVuY2UodGhydXN0LCBjYWxsZWRCeVBhcmVudCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnJlc29sdmUoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwaXBlbGluZSA9IHdoZW4ucGlwZWxpbmUocGlwZSwgc2V0dGluZ3MpLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXR1cERlZmVyLnJlc29sdmUoY29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBXZSdyZSBvbmx5IGdvaW5nIHRvIGV4cG9zZSBnbG9iYWxzIGlmIHJlcXVlc3RlZC4gIFRoaXMgaXMgYSBwb3RlbnRpYWwgdXNlY2FzZSB0aGF0IG1heSBiZSBuZWVkZWQgZm9yIHNvbWUgdGVhbXMuCiAgICAgICAgICAgIGlmKHRDb25maWcuZXhwb3NlR2xvYmFscykgewogICAgICAgICAgICAgICAgaWYoIXdpbmRvd1snVGhydXN0J10pIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbJ1RocnVzdCddID0gVGhydXN0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGlwZWxpbmUudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvd1tzZXR0aW5ncy5uYW1lXSA9IGNvbnRleHQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGlwZWxpbmU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuZ2V0SW5zdGFuY2UgPSAvKioKICAgICAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5nZXRJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2ZldGNoSW5zdGFuY2UgPSAvKioKICAgICAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgICAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgICAgIAogICAgICAgIEBtZXRob2QgX19mZXRjaEluc3RhbmNlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIF9fZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmNyZWF0ZU1vZHVsZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgbW9kdWxlIGFuZCBoYW5kcyBpdCBvZmYgdG8gdGhlIGdpdmVuIGluc3RhbmNlLCBpZiB0aGF0IGluc3RhbmNlIGV4aXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZU1vZHVsZShpbnN0YW5jZU5hbWUsIG5hbWUsIG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gVGhydXN0LmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgIGlmKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gbmV3IE1vZHVsZShpbnN0YW5jZSwgbW9kdWxlRGVmbiwgbmFtZSk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5fX2luamVjdE1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlID0gLyoqCiAgICAgICAgUmVnaXN0ZXJzIGEgc3BlY2lmaWMgbW9kdWxlIG5hbWUsIGFuZCBhcmd1bWVudHMuICBUaGUgYXJndW1lbnRzIHdpbGwgYmUgdXNlZCB3aGVuIGluaXRhbnRpYXRpbmcgdGhlIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlZ2lzdGVyTW9kdWxlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSB0aGUgbW9kdWxlIGlzIHRvIGJlIGFzc29jaWF0ZWQgd2l0aC4KICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUgdG8gYXNzaWduIHRoZSBhcmd1bWVudHMgd2l0aC4KICAgICAgICBAcGFyYW0ge09iamVjdCp9IGFyZ3VtZW50cywgYWRkaXRpb25hbCBhcmd1bWVudHMgdGhhdCB3aWxsIGJlIHBhc3NlZCBvbnRvIHRoZSBtb3VkbGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck1vZHVsZShpbnN0YW5jZU5hbWUsIG5hbWUpIHsKICAgICAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnN0YW5jZU5hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdKSB7CiAgICAgICAgICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDIpOwogICAgICAgICAgICBpZihUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV1bbmFtZV0pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBhbHJlYWR5IHJlZ2lzdGVyZWQgdG8gaW5zdGFuY2UgInsxfSInLCBuYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV1bbmFtZV0gPSBhcmdzIHx8IFtdOwogICAgICAgIH07CiAgICAgICAgVGhydXN0Ll9fZ2V0TW9kdWxlQXJncyA9IF9fZ2V0TW9kdWxlQXJnczsKICAgICAgICByZXR1cm4gVGhydXN0OwogICAgfSkoKTsKICAgIGV4cG9ydHMuVGhydXN0ID0gVGhydXN0OyAgICAKICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgY3VycmVudCB0aHVyc3QgaW5zdGFuY2UsIGJ5IGV4cGVjdGVkIG5hbWUuCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgcGx1Z2luLgogICAgdGhydXN0IWdsb2JhbCA9IFRocnVzdCBpbnN0YW5jZQogICAgdGhydXN0IWdsb2JhbDpkb20gPSBUaGUgdGhydXN0IGRvbSBwbHVnaW4gaW5zdGFuY2UKICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCAndGhydXN0JzsKICAgICAgICB2YXIgaW5zdGFuY2VQcm9taXNlID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VQcm9taXNlLnByb21pc2UudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gY29udGV4dFtwbHVnaW5OYW1lXTsKICAgICAgICAgICAgaWYoIXBsdWdpbikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUGx1Z2luICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBwbHVnaW5OYW1lLCByZWFsTmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QnLCBbJ3RocnVzdC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBBIENvbnZlbnRpb24gYWxsb3dzIHRocnVzdCB0byBiZSBhcyBleHRlbmRhYmxlIGFzIHBvc3NpYmxlLCBieSBnaXZpbmcgZXh0ZW5zaW9uIHBvaW50cyBhdCBldmVyeSBzdGVwIGFsb25nIHRoZSB3YXkuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gWwogICAgICAgICdjcmVhdGUnLCAKICAgICAgICAnaW5pdCcsIAogICAgICAgICdzdGFydCcsIAogICAgICAgICdyZWFkeScsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ2Rlc3Ryb3knLCAKICAgICAgICAnY291bnRkb3duJywgCiAgICAgICAgJ2lnbml0ZScsIAogICAgICAgICdvcmJpdCcsIAogICAgICAgICdkZW9yYml0JywgCiAgICAgICAgJ3NwbGFzaGRvd24nCiAgICBdOwogICAgLyoqCiAgICBUaGUgY29udmVudGlvbiBjbGFzcywgdGFrZXMgYW4gb3ZlcmxvYWRlZCBzZXQgb2YgbWV0aG9kcywgZm9yIGFueSBtZXRob2QgdGhhdCBuZWVkcyB0byBiZSBvdmVybG9hZGVkLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkNvbnZlbnRpb24KICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgQW4gb2JqZWN0IG9mIGFwcGxpY2FibGUgbWV0aG9kcy4KICAgICoqLwogICAgdmFyIENvbnZlbnRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENvbnZlbnRpb24obWV0aG9kT3ZlcnJpZGVzKSB7CiAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMsIG1ldGhvZE92ZXJyaWRlcyk7CiAgICAgICAgICAgIHZhciBrZXlzID0gXy5kaWZmZXJlbmNlKG1ldGhvZHMsIF8uaW50ZXJzZWN0aW9uKG1ldGhvZHMsIF8ua2V5cyhtZXRob2RPdmVycmlkZXMpKSk7CiAgICAgICAgICAgIF8uZWFjaChrZXlzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgaWYoXy5pc0Z1bmN0aW9uKHRoaXNbeF0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm9vcCBpcyB1c2VkIGluIHNhZmVpbnZva2UsIGFzIGEgc2FmZSBpZ25vcmUgZnVuY3Rpb24sIG5vIG90aGVyIG5vb3Agd2lsbCB3b3JrIGNvcnJlY3RseS4KICAgICAgICAgICAgICAgICAgICB0aGlzW3hdID0gdXRpbC5ub29wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIGNyZWF0ZSBvZiBhIG1vZHVsZSwgZ2VuZXJhbGx5IHVzZWQgdG8gY3JlYXRlIGEgZmFjYWRlLCB0aGF0IGlzIHRoZW4gYm91bmQgdG8gdGhlIG1vZHVsZS4KICAgICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgQWxsIHRoZSBmYWNhZGVzIGFscmVhZHkgYXR0YWNoZWQgdG8gdGhlIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmluaXQgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgaW5pdCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBpbml0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBpbml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RhcnQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3Mgc3RhcnQgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUucmVhZHkgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgcmVhZHkgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgcmVhZHkgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlYWR5CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdG9wIHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0b3AgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZXN0cm95ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGRlc3Ryb3kgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgZGVzdHJveSBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVzdHJveQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNvdW50ZG93biA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pZ25pdGUgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLm9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSByZWFkeSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIG9yYml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHN0b3AgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGRlc3Ryb3kgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIHJldHVybiBDb252ZW50aW9uOwogICAgfSkoKTsKICAgIGV4cG9ydHMuQ29udmVudGlvbiA9IENvbnZlbnRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb252ZW50aW9uLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2V2ZW50cycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9sb2cnLCAnLi9jb25maWcnLCAnaGFzJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fbG9nX18sIF9fdENvbmZpZ19fLCBfX2hhc19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvLyAgICAgQmFja2JvbmUuanMgMC45LjEKICAgIC8vICAgICAoYykgMjAxMC0yMDEyIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCiAgICAvLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAgICAvLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgogICAgLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgogICAgCiAgICAqIEV2ZW50cyBjYW4gYmUgZmlyZWQgYXN5bmNyb25vdXNseS4KICAgICogRXZlbnRzIGNhbiBiZSBuYW1lc3BhY2VkLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgRXZlbnROb2RlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBFdmVudE5vZGUoKSB7CiAgICAgICAgICAgIHRoaXMudGFpbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubmV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9ICcnOwogICAgICAgICAgICB0aGlzLm9uY2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV2ZW50Tm9kZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkV2ZW50Tm9kZSA9IEV2ZW50Tm9kZTsgICAgCiAgICB2YXIgY3JlYXRlQXN5bmNFdmVudCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uIGYoZXZlbnRzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90cmlnZ2VyLmFwcGx5KG9iamVjdCwgWwogICAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfTsKICAgICAgICBmLmFzeW5jID0gZnVuY3Rpb24gKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZjsKICAgIH07CiAgICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFzeW5jRmlyZSwgbm9vcCA9IHV0aWwubm9vcCwgd2hlbiA9IHV0aWwud2hlbiwgc2l6ZSA9IF8uc2l6ZSwgZWFjaCA9IF8uZWFjaCwgZGVmZXIgPSBfLmRlZmVyLCBiaW5kID0gXy5iaW5kLCBleHRlbmQgPSBfLmV4dGVuZCwgZm9ybWF0ID0gdXRpbC5mb3JtYXQ7CiAgICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvLCBBTEwgPSAnYWxsJywgU1RBUkFMTCA9ICcqYWxsJzsKICAgIC8qKgogICAgTm9ybWFsaXplcyB0aGUgZ2l2ZW4gZXZlbnRzIHRvIHRoZSBleHBlY3RlZCBuYW1lc3BhY2UuCiAgICAKICAgIEBtZXRob2Qgbm9ybWFsaXplRXZlbnRzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBUaGUgZXZlbnRzIGRlbGltaXRlZCBieSBhIHNwYWNlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlIFRoZSBuYW1lc3BhY2UsIGluY2x1ZGluZyBwcmVmaXhlZCAnLicKICAgICoqLwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHNBcnJheS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYoZXZlbnRzQXJyYXlbaV0uaW5kZXhPZignLicpID09PSAtMSkgewogICAgICAgICAgICAgICAgZXZlbnRzQXJyYXlbaV0gPSBldmVudHNBcnJheVtpXSArIG5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnRzQXJyYXkuam9pbignICcpOwogICAgfQogICAgLyoqCiAgICBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICAKICAgIEBtZXRob2QgX3RyaWdnZXIKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgIEByZXR1cm5zIElmIGFzeW5jIHRoZW4gcmV0dXJucyBhIFByb21pc2UsIHdoZXJlIHRoZSBmaXJzdCBhcmd1bWVudCBjb250YWlucyBhbGwgdGhlIHJldHVybmVkIHZhbHVlcywgYXMgYW4gYXJyYXkKICAgIElmIHN5bmMgdGhlbiByZXR1cm5zIGFuIGFycmF5IG9mIHRoZSByZXR1cm4gdmFsdWVzLgogICAgSWYgbW9yZSB0aGFuIG9uZSBldmVudCwgcmV0dXJucyBhbiBvYmplY3Qgb2YgYXJyYXlzIG9yIHByb21pc2VzLCB3aXRoIHRoZSBrZXkgZm9yIGVhY2ggZXZlbnQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF90cmlnZ2VyKGFzeW5jLCBldmVudHMpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBldmVudCwgbm9kZSwgY2FsbHMsIHRhaWwsIGFyZ3MsIGFsbCwgcmVzdCwgbmFtZXNwYWNlLCBvbmNlTm9kZXM7CiAgICAgICAgaWYoIShjYWxscyA9IHRoaXMuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgfQogICAgICAgIGFsbCA9IGNhbGxzLmFsbDsKICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgaWYobm9kZSA9IGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgdHJpZ2dlck5vZGVzKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZSwgcmVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobm9kZSA9IGFsbCkgewogICAgICAgICAgICAgICAgdHJpZ2dlck5vZGVzKHRoYXQsIEFMTCwgYXN5bmMsIG5vZGUsIFsKICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgXS5jb25jYXQocmVzdCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBUcmlnZ2VycyBhbGwgZXZlbnRzIG9uIGEgbm9kZS4KICAgIEFsc28gdW5iaW5kcyBhbnkgbm9kZSB0aGF0IGlzIHNldCB0byBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgCiAgICBAbWV0aG9kIHRyaWdnZXJOb2RlcwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBldmVudCBjb250YWluZXIgY29udGV4dC4KICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQgdG8gYmUgYm91bmQgb3IgdW5ib3VuZC4KICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gbm9kZSBUaGUgbm9kZSBsaW5rZWQgbGlzdC4KICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIHRyaWdnZXJlZCBub2RlcwogICAgCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGVMaXN0LCBhcmdzKSB7CiAgICAgICAgdmFyIHRhaWwsIG9uY2VOb2RlcyA9IFtdOwogICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KCd7MH06IHRyaWdnZXJpbmcgezF9IGV2ZW50ICJ7Mn0iJywgdGhhdC5fX3B1YlN1Yk5hbWUsIGFzeW5jICYmICdhc3luYycgfHwgJycsIGV2ZW50KSk7CiAgICAgICAgZWFjaChub2RlTGlzdCwgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgdGFpbCA9IG5vZGUudGFpbDsKICAgICAgICAgICAgd2hpbGUoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIG5vZGUuY2FsbGJhY2ssIG5vZGUuY29udGV4dCB8fCB0aGF0LCBhcmdzKTsKICAgICAgICAgICAgICAgIG5vZGUub25jZSAmJiBvbmNlTm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKG9uY2VOb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgZWFjaChvbmNlTm9kZXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICB0aGF0LnVuc3Vic2NyaWJlKGV2ZW50LCB4LmNhbGxiYWNrLCB4LmNvbnRleHQsIHgubmFtZXNwYWNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBJbnZva2VzIGEgdHJpZ2dlciBjYWxsYmFjawogICAgCiAgICBAbWV0aG9kIHRyaWdnZXJDYWxsYmFjawogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kCiAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY2FsbGluZyBjb250ZXh0CiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aC4KICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSByZXR1cm5lZCB2YWx1ZS4KICAgIEZvciBhc3luYyBjYWxscywgdGhpcyBpcyBhIHByb21pc2UKICAgIEZvciBzeW5jIGNhbGxzIHRoaXMgaXMgdGhlIHZhbHVlIGZyb20gdGhlIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckNhbGxiYWNrKGFzeW5jLCBjYWxsYmFjaywgY29udGV4dCwgYXJncykgewogICAgICAgIGlmKGFzeW5jKSB7CiAgICAgICAgICAgIGRlZmVyKHRyaWdnZXJBc3luY0NhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSwgMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5ICB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGlmKHRDb25maWcudGhyb3dFcnJvcnMpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDcmVhdGVzIGFuIGFzeW5jIGV2ZW50IGhhbmRsZXIKICAgIAogICAgQG1ldGhvZCBhc3luY0V2ZW50RmFjdG9yeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgZm9yIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRyaWdnZXJBc3luY0NhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFJlc3Vic2NyaWJlcyB0byB0aGUgYXBwcm9wcmlhdGUgZXZlbnRzCiAgICAKICAgIEBtZXRob2QgX29mZlByb2Nlc3NOb2RlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGV2ZW50IGNvbnRleHQKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQKICAgIEBwYXJhbSB7T2JqZWN0fSBub2RlIFRoZSBub2RlIGxpbmtlZCBsaXN0LgogICAgQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZXZlbnQgY2FsbGJhY2sgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0gVGhlIGV2ZW50IGNvbnRleHQgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZXNwYWNlXSBUaGUgbmFtZXNwYWNlIHRvIHVuc3Vic2NyaWJlCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB2YXIgdGFpbCwgY2IsIGN0eCwgbnM7CiAgICAgICAgdGFpbCA9IG5vZGUudGFpbDsKICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgY2IgPSBub2RlLmNhbGxiYWNrOwogICAgICAgICAgICBjdHggPSBub2RlLmNvbnRleHQ7CiAgICAgICAgICAgIG5zID0gbm9kZS5uYW1lc3BhY2U7CiAgICAgICAgICAgIGlmKChjYWxsYmFjayAmJiBjYiAhPT0gY2FsbGJhY2spIHx8IChjb250ZXh0ICYmIGN0eCAhPT0gY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKGV2ZW50ICsgKG5zICYmICgnLicgKyBucykgfHwgJycpLCBjYiwgY3R4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgR2V0cyB0aGUgbmFtZXNwYWNlIGluZm9ybWF0aW9uLCB0aGUgcmVhbCBldmVudCB0byBwYXNzIGJhY2sgb250byB0aGUgbWV0aG9kcy4KICAgIAogICAgQG1ldGhvZCBnZXROYW1lc3BhY2VEYXRhCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0byBjYXB0dXJlIG5hbWVzcGFjZSBkYXRhIGZyb20uCiAgICBAcmV0dXJucyB7T2JqZWN0fSBDb250YWluaW5nIGV2ZW50IGFuZCBuYW1lc3BhY2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldE5hbWVzcGFjZURhdGEoZXZlbnQpIHsKICAgICAgICB2YXIgbnNJbmRleCA9IChldmVudCB8fCAnJykuaW5kZXhPZignLicpLCBoYXNOcyA9IG5zSW5kZXggPiAtMSwgbmFtZXNwYWNlID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcobnNJbmRleCArIDEpIDogdW5kZWZpbmVkLCBldmVudCA9IGhhc05zID8gZXZlbnQuc3Vic3RyaW5nKDAsIG5zSW5kZXgpIDogZXZlbnQ7CiAgICAgICAgaWYobnNJbmRleCA9PT0gMCkgewogICAgICAgICAgICBldmVudCA9IFNUQVJBTEw7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGV2ZW50OiBldmVudCwKICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UKICAgICAgICB9OwogICAgfQogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgogICAgCiAgICAqIEV2ZW50cyBjYW4gYmUgZmlyZWQgYXN5bmNyb25vdXNseS4KICAgICogRXZlbnRzIGNhbiBiZSBuYW1lc3BhY2VkLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkV2ZW50cwogICAgKiovCiAgICBleHBvcnRzLkV2ZW50cyA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IHsKICAgICAgICAgICAgc3Vic2NyaWJlOiAvKioKICAgICAgICAgICAgQmluZCBvbmUgb3IgbW9yZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnRzLCBgZXZlbnRzYCwgdG8gYSBgY2FsbGJhY2tgCiAgICAgICAgICAgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBDYWxsIHRoaXMgZXZlbnQgb25seSBvbmNlLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxzLCBldmVudCwgbm9kZSwgdGFpbCwgbGlzdCwgbmQ7CiAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGlzLl9fbmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgICAgICAgICBjYWxscyA9IHRoaXMuX2NhbGxiYWNrcyB8fCAodGhpcy5fY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYW4gaW1tdXRhYmxlIGNhbGxiYWNrIGxpc3QsIGFsbG93aW5nIHRyYXZlcnNhbCBkdXJpbmcKICAgICAgICAgICAgICAgIC8vIG1vZGlmaWNhdGlvbi4gIFRoZSB0YWlsIGlzIGFuIGVtcHR5IG9iamVjdCB0aGF0IHdpbGwgYWx3YXlzIGJlIHVzZWQKICAgICAgICAgICAgICAgIC8vIGFzIHRoZSBuZXh0IG5vZGUuCiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGNhbGxzW2V2ZW50XSB8fCAoY2FsbHNbZXZlbnRdID0gewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGxpc3QgPSBsaXN0W25kLm5hbWVzcGFjZV07CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGxpc3QgPyBsaXN0LnRhaWwgOiBuZXcgRXZlbnROb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGFpbCA9IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLmNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXMuX19kZWZhdWx0Q29udGV4dCB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIGlmKG5kLm5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLm5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYob25jZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLm9uY2UgPSBvbmNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsc1tldmVudF1bbmQubmFtZXNwYWNlXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFpbDogdGFpbCwKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDogbGlzdCA/IGxpc3QubmV4dCA6IG5vZGUKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uY2U6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBFYWNoIGV2ZW50IHdpbGwgb25seSBiZSBjYWxsZWQgb25jZS4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgb25jZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQGNoYWluYWJsZQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZShldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgY2FsbGJhY2tzCiAgICAgICAgICAgIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MgZm9yIHRoZQogICAgICAgICAgICBldmVudC4gSWYgYGV2ZW50YCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZCBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHVuc3Vic2NyaWJlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50LCBjYWxscywgbm9kZSwgbmQsIG91ck5zLCBuYW1lc3BhY2UsIHRoYXQgPSB0aGlzLCBoYXNOczsKICAgICAgICAgICAgICAgIG91ck5zID0gdGhhdC5fX25hbWVzcGFjZTsKICAgICAgICAgICAgICAgIG91ck5zICYmIChvdXJOcyA9IG91ck5zLnN1YnN0cmluZygxKSk7CiAgICAgICAgICAgICAgICAvLyBObyBldmVudHMsIG9yIHJlbW92aW5nICphbGwqIGV2ZW50cy4KICAgICAgICAgICAgICAgIGlmKCEoY2FsbHMgPSB0aGF0Ll9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoIShldmVudHMgfHwgY2FsbGJhY2sgfHwgY29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBpZighb3VyTnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoYXQuX2NhbGxiYWNrczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2JzID0gdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2JzW2ldW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2JzW2ldKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGxpc3RlZCBldmVudHMgYW5kIGNvbnRleHRzLCBzcGxpY2luZyB0aGVtIG91dCBvZiB0aGUKICAgICAgICAgICAgICAgIC8vIGxpbmtlZCBsaXN0IG9mIGNhbGxiYWNrcyBpZiBhcHByb3ByaWF0ZS4KICAgICAgICAgICAgICAgIG91ck5zICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGF0Ll9fbmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMgPyBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcikgOiBfLmtleXMoY2FsbHMpOwogICAgICAgICAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICAgICAgbmQgPSBnZXROYW1lc3BhY2VEYXRhKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICBldmVudCA9IG5kLmV2ZW50OwogICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgICBoYXNOcyA9ICEhbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICBpZihzaXplKGNhbGxzW2V2ZW50XSkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoIW5vZGUgfHwgIShjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLyppZiAoZXZlbnQgIT09IFNUQVJBTEwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50ICE9PSBTVEFSQUxMICYmICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZXZlbnQgPT09IEFMTCB8fCAhY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpIGluIGNhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihoYXNOcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgaSwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9fcHViU3ViTmFtZTogLyoqCiAgICAgICAgICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgICAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgICAgICAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAgICAgICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgZmlyZQogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICAgICAgICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgICAgICAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgICAgICAgICAgQHJldHVybnMge0FycmF5IG9mIFZhbHVlc30gSWYgbW9yZSB0aGFuIG9uIGV2ZW50IGlzIGZpcmVkLCBhbiBPYmplY3Qgb2YgQXJyYXlzIGlzIHJldHVybmVkLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgJ0V2ZW50cycsCiAgICAgICAgICAgIGluaXRFdmVudHM6IC8qKgogICAgICAgICAgICBJbml0J3MgdGhlIEV2ZW50IG1vZHVsZS4KICAgICAgICAgICAgVGhpcyBpcyBvbmx5IHJlcXVpcmVkIGlmIHlvdSB3aXNoIHRvIHVzZSBmaXJlLmFzeW5jLCBhbmQgbmFtZXNwYWNpbmcuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIGluaXRFdmVudHMKICAgICAgICAgICAgQGNoYWluYWJsZQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKGRlZmF1bHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmUgPSB0aGlzLnB1Ymxpc2ggPSBjcmVhdGVBc3luY0V2ZW50KHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzID0gbm9vcDsKICAgICAgICAgICAgICAgIHRoaXMuX19wdWJTdWJOYW1lID0gdGhpcy5uYW1lIHx8ICdFdmVudHMnOwogICAgICAgICAgICAgICAgaWYodGhpcy5uYW1lICYmICF0aGlzLl9fbmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX25hbWVzcGFjZSA9ICcuJyArIHRoaXMubmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX19kZWZhdWx0Q29udGV4dCA9IGRlZmF1bHRDb250ZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGV4dGVuZDogLyoqCiAgICAgICAgICAgIEV4dGVuZHMgRXZlbnRzIGludG8gdGhlIGdpdmVuIG9iamVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgZXh0ZW5kCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSB0byBUaGUgb2JqZWN0IG90IGV4dGVuZCBldmVudHMgb250bwogICAgICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IFtpbml0XSBPcHRpb25hbGx5IGluaXQgdGhlIGV2ZW50cy4KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICAgICAgXy5leHRlbmQodG8sIGV4cG9ydHMuRXZlbnRzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0by5leHRlbmQ7CiAgICAgICAgICAgICAgICBpbml0ICYmIHRvLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0bzsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXZlbnRzLmZpcmUgPSBldmVudHMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQoewogICAgICAgIH0pOwogICAgICAgIHJldHVybiBldmVudHM7CiAgICB9KSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudHMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZmFjYWRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICcuL2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fdG1fXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHRtID0gX190bV9fOwoKICAgIHZhciBNb2R1bGUgPSB0bS5Nb2R1bGU7CiAgICAvKioKICAgIAogICAgVGhlIEZhY2FkZSBtb2R1bGUgb2ZmZXJzIHRoZSBhYmlsaXR5IHRvIGNyZWF0ZSBhbiBpbnRlcmZhY2Ugb3Igc2ltaWxhciBjb25jZXB0LgogICAgV2l0aCB0aGUgRmFjYWRlIGluIHRocnVzdCwgaXQgYWxsb3dzIHlvdSB0byBjYXB0dXJlIGV2ZW50cyBmcm9tIGEgbW9kdWxlLCB3aGVuIGxvYWRlZCB2aWEgY29udmVudGlvbi4KICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgogICAgCiAgICBGYWNhZGUgaGFzIHRoZXNlIGJ1aWx0IGluIG1ldGhvZHM6CiAgICAqIGluaXQKICAgICogc3RhcnQKICAgICogcmVhZHkKICAgICogc3RvcAogICAgKiBkZXN0cm95CiAgICAKICAgIEJlaGluZCB0aGUgc2NlbmVzIHRoZSBmYWNhZGUgbWV0aG9kcywgaW52b2tlIGFueSBjb252ZW50aW9ucyBsb2FkZWQgZm9yIHRoZSBwbHVnaW4uCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRmFjYWRlCiAgICAqKi8KICAgIHZhciB0aHJ1c3RDYWNoZSA9IE1vZHVsZS50aHJ1c3RDYWNoZTsKICAgIHZhciBmYWNhZGVNZXRob2RzID0gWwogICAgICAgICdpbml0JywgCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnZGVzdHJveScKICAgIF0sIGRlZmF1bHRQcm90b3R5cGUgPSB7CiAgICB9OwogICAgZnVuY3Rpb24gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlcyA9IFtdOwogICAgICAgICAgICBpZihtICYmICEoKG0pLmNvbnZlbnRpb24pKSB7CiAgICAgICAgICAgICAgICBtID0gdGhydXN0Q2FjaGVbbS5taWRdLm1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0Ll9fY29udmVudGlvbnMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBuYW1lLCBtLCB0aGF0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBtZXRob2RXcmFwKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZikgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGYuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgIHZhciBtZXRob2QgPSBmYWNhZGVNZXRob2RzW2ldOwogICAgICAgIGRlZmF1bHRQcm90b3R5cGVbbWV0aG9kXSA9IGNvbnZlbnRpb25GdW5jdGlvbkZhY3RvcnkobWV0aG9kKTsKICAgIH0KICAgIC8qKgogICAgRmFjYWRlIGluaXQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIGluaXQKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHN0YXJ0CiAgICAKICAgIENhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RhcnQKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHJlYWR5CiAgICAKICAgIENhbGxlZCBkdXJpbmcgdGhlIHJlYWR5IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgcmVhZHkKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIHN0b3AKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIHN0b3AKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlIGRlc3Ryb3kKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgogICAgCiAgICBAbWV0aG9kIGRlc3Ryb3kKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgbW9kdWxlIGluc3RhbmNlCiAgICAKICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e3BsdWdpbk5hbWV9OntoYXNoS2V5fQogICAgCiAgICBoYXNLZXk6IGlzIGEgdW5pcXVlIGtleSwgdGhhdCB0aGUgbW9kdWxlIHNoYXJlcyB3aXRoIHRoZSBmYWNhZGUsIGFsbG93cyBmb3IgZGVmaW5pbmcgZGVwZW5kZW5jaWVzCiAgICBpbiB5b3VyIGRlZmluZSBibG9jaywgYW5kIGdldCBhY2Nlc3MgdG8gdGhlIG1vZHVsZXMgZmFjYWRlLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBvYnNvbGV0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luID0gcGFydHNbMV0sIHBsdWdpbk5hbWUgPSBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSB8fCAwKSwgaGFzaEtleSA9IHBhcnRzWzJdOwogICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnN0YW5jZU5hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIGlmKCFwbHVnaW5OYW1lKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncGx1Z2luTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIWhhc2hLZXkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoYXNoS2V5IGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgdGhydXN0UGx1Z2luID0gdGhydXN0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICBpZighdGhydXN0UGx1Z2luKSB7CiAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICBwbHVnaW4KICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZChwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0gPSB0aHJ1c3RDYWNoZVtoYXNoS2V5XSB8fCAodGhydXN0Q2FjaGVbaGFzaEtleV0gPSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5zdGFuY2U6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBmYWNhZGUgPSB0aHJ1c3RQbHVnaW4uY3JlYXRlRmFjYWRlKHRocnVzdCwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyk7CiAgICAgICAgICAgIGxvYWQoZmFjYWRlKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICBmdW5jdGlvbiBjcmVhdGVGYWNhZGUoaW5pdE1ldGhvZCkgewogICAgICAgIHZhciBmID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIEZhY2FkZSA9IGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICAgICAgICAgIGluaXRNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBmYWNhZGVNZXRob2RzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXNbbWV0aG9kXSAhPT0gZGVmYXVsdFByb3RvdHlwZVttZXRob2RdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbbWV0aG9kXSA9IF8ud3JhcCh0aGlzW21ldGhvZF0sIG1ldGhvZFdyYXAoZGVmYXVsdFByb3RvdHlwZVttZXRob2RdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5tb2QgPSBtb2Q7CiAgICAgICAgICAgICAgICAvL3RoaXMuaW5pdChtb2QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgRmFjYWRlLnByb3RvdHlwZSA9IF8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIHVwZGF0ZUZhY2FkZTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBkZWZhdWx0UHJvdG90eXBlKTsKICAgICAgICAgICAgcmV0dXJuIEZhY2FkZTsKICAgICAgICB9KSgpOwogICAgICAgIHJldHVybiBmOwogICAgfQogICAgZXhwb3J0cy5jcmVhdGVGYWNhZGUgPSBjcmVhdGVGYWNhZGU7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWZhY2FkZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3QvbWVkaWF0b3JfXyBDb252ZW50aW9uIC0gQXV0byBTdGFydAogICAgKgogICAgKiBUaGUgYXV0byBzdGFydCBwcm9wZXJ0eSBhbGxvd3MgZm9yIGEgbW9kdWxlLCB0byBiZSBhdXRvbWF0aWNhbGx5IHN0YXJ0ZWQgb25jZSBpdCBpcwogICAgKiBpbmNsdWRlZCBpbnRvIGEgdGhydXN0IGluc3RuYWNlLCB3aXRob3V0IGhhdmluZyB0byBleHBsaWNpdHkgY2FsbCBzdGFydCBvbiB0aGUgbW9kdWxlLgogICAgKgogICAgKgogICAgKiBUaGlzIGlzIHVzZWZ1bCBmb3IgY2VydGlhbiB0eXBlcyBvZiBtb2R1bGVzLCB1c3VhbGx5IHBlcnNpc3RhbnQgb25lcyB0aGF0IGFsd2F5cyBuZWVkIHRvIGxvYWQgcmVnYXJkbGVzcy4KICAgICogRm9yIGV4YW1wbGUgYSBuYXZpZ2F0aW9uIG1vZHVsZSwgb3IgdXNlciBzZXR0aW5ncyBtb2R1bGUuCiAgICAqCiAgICAqIEBmb3IgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IGF1dG9TdGFydAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgICdjb25maWcuYXV0b1N0YXJ0JwogICAgICAgIF0KICAgIH07CiAgICBleHBvcnRzLmF1dG9zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hdXRvc3RhcnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgICAgIHZhciBldmVudCA9IHsKICAgICAgICBhbnlDb250YWluZXI6ICd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXIvYW55JywKICAgICAgICBjaGFuZ2VDb250YWluZXI6ICd0aHJ1c3QvY29udmVudGlvbi9jb250YWluZXIvY2hhbmdlJwogICAgfSwgYW55ID0gXy5hbnksIGJpbmQgPSBfLmJpbmQsIENPTlRBSU5FUiA9ICdjb25maWcuY29udGFpbmVyJywgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgZGVmZXIgPSBfLmRlZmVyOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBDT05UQUlORVIKICAgICAgICBdLAogICAgICAgIGNoYW5nZTogZnVuY3Rpb24gKG1vZCwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXJWYWx1ZSA9IG1vZC5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmKGNvbnRhaW5lclZhbHVlICYmIGNvbnRhaW5lciAmJiBjb250YWluZXJWYWx1ZSA9PT0gY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBpZihtb2QuY29udmVudGlvbihTVEFSVCkpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcihiaW5kKG1vZC5zdG9wLCBtb2QpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBjb250YWluZXJWYWx1ZSA9IG1vZC5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmKGNvbnRhaW5lclZhbHVlKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLmZpcmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBjb250YWluZXJWYWx1ZSk7CiAgICAgICAgICAgICAgICAvLyBTdWJzY3JpcHRpb25zIGdldCB1bnN1YnNjcmliZWQgd2hlbiBzdG9wcGluZyBhIG1vZHVsZSwgc28gd2UgbmVlZCB0byByZXN1YnNjcmliZSBldmVyeSB0aW1lIGhlcmUuCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHByb2JhYmx5IGJldHRlciwgYXMgdGhlIGV2ZW50cyB3aWxsIGJlIGxlc3MgY2hhdHR5LgogICAgICAgICAgICAgICAgZmFjYWRlcy5tZWRpYXRvci5zdWJzY3JpYmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBiaW5kKHRoYXQuY2hhbmdlLCB0aGF0LCBtb2QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250YWluZXIuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGFueSA9IF8uYW55LCBtYXAgPSBfLm1hcCwgRE1PRFVMRVMgPSAnY29uZmlnLmRlcGVuZGVudE1vZHVsZXMnLCBDTU9EVUxFUyA9ICdjb25maWcuY2hpbGRNb2R1bGVzJywgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgZGVmZXIgPSBfLmRlZmVyLCBiaW5kID0gXy5iaW5kOwogICAgdmFyIGludm9rZWRlcGVuZGVudE1vZHVsZXMgPSBmdW5jdGlvbiAobW9kLCBtZXRob2QpIHsKICAgICAgICB2YXIgcmVxdWlyZWRNb2R1bGVzID0gbW9kLmNvbnZlbnRpb24oRE1PRFVMRVMpOwogICAgICAgIGlmKHJlcXVpcmVkTW9kdWxlcykgewogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdFttZXRob2RdKHJlcXVpcmVkTW9kdWxlcyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBpbnZva2VDaGlsZE1vZHVsZXMgPSBmdW5jdGlvbiAobW9kLCBtZXRob2QpIHsKICAgICAgICB2YXIgcmVxdWlyZWRNb2R1bGVzID0gbW9kLmNvbnZlbnRpb24oQ01PRFVMRVMpOwogICAgICAgIGlmKHJlcXVpcmVkTW9kdWxlcykgewogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdFttZXRob2RdKHJlcXVpcmVkTW9kdWxlcyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgRE1PRFVMRVMsIAogICAgICAgICAgICBDTU9EVUxFUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAnc3RhcnQnKSwgCiAgICAgICAgICAgICAgICBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnc3RhcnQnKQogICAgICAgICAgICBdOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoIW1vZC50aHJ1c3Quc3RhcnRlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICBpbnZva2VkZXBlbmRlbnRNb2R1bGVzKG1vZCwgJ3JlYWR5JyksIAogICAgICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdyZWFkeScpCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnc3RvcCcpOwogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ2Rlc3Ryb3knKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5kZXBlbmRlbnRNb2R1bGVzID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWRlcGVuZGVudC5tb2R1bGVzLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLmNvbmZpZwogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5yZXNvbHZlID0gWwogICAgICAgICduYW1lJywgCiAgICAgICAgJ2NmZycKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9tZWRpYXRvci4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vc3Vic2NyaXB0aW9uJwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vc3Vic2NyaXB0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIFRoZSBmYWNhZGUgY29udmVudGlvbiwgY3JlYXRlcyB0aGUgbWVkaWF0b3IgZmFjYWRlIGZvciBlYWNoIG1vZHVsZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QubWVkaWF0b3IKICAgIEBzdWJtb2R1bGUgdGhydXN0Lm1lZGlhdG9yLmNvbnZlbnRpb24KICAgICoqLwogICAgICAgIHZhciBTVUJTQ1JJUFRJT05TID0gJ2NvbmZpZy5tZWRpYXRvci5zdWJzY3JpcHRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzUGxhaW5PYmplY3QgPSBfLmlzUGxhaW5PYmplY3QsIGZvck93biA9IF8uZm9yT3duLCBlYWNoID0gXy5lYWNoOwogICAgdmFyIGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIgPSBbCiAgICAgICAgJ2hhbmRsZXInLCAKICAgICAgICAnY29udGV4dCcKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIFNVQlNDUklQVElPTlMKICAgICAgICBdLAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnMgPSBtb2QuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKTsKICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9ucyAmJiAhKHN1YnNjcmlwdGlvbnMpLl9zdWJzY3JpcHRpb25zU2V0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgICAgICBmb3JPd24oc3Vic2NyaXB0aW9ucywgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24sIHN1YnNjcmlwdGlvbk5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShzdWJzY3JpcHRpb25Db2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlYWNoKHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24sIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShzdWJzY3JpcHRpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25ld1N1YnNjcmlwdGlvbi5wdXNoLmFwcGx5KG5ld1N1YnNjcmlwdGlvbiwgc3Vic2NyaXB0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uLCBmdW5jdGlvbiAoaGFuZGxlck9iamVjdCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdTdWJzY3JpcHRpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbk5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKG1vZC5pbnN0YW5jZVtoYW5kbGVyT2JqZWN0XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0Z1bmN0aW9uKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzdWJzY3JpcHRpb25baSArIDFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChzdWJzY3JpcHRpb25baSArIDFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3JldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNQbGFpbk9iamVjdChoYW5kbGVyT2JqZWN0KSAmJiAoJ21vZHVsZUhhbmRsZXInIGluIGhhbmRsZXJPYmplY3QgfHwgJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uID0gW3N1YnNjcmlwdGlvbk5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZignbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QubW9kdWxlSGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdoYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyT2JqZWN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKG1vZC5pbnN0YW5jZVtoYW5kbGVyT2JqZWN0LmhhbmRsZXJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdC5oYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZignY29udGV4dCcgaW4gaGFuZGxlck9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdC5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihuZXdTdWJzY3JpcHRpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNhZGUuc3Vic2NyaWJlLmFwcGx5KGZhY2FkZSwgbmV3U3Vic2NyaXB0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKS5fc3Vic2NyaXB0aW9uc1NldCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmIHN1YnNjcmlwdGlvbnMuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdWJzY3JpcHRpb24gPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3Vic2NyaXB0aW9uLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAc3VibW9kdWxlIHRocnVzdC5kYXRhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L2RvbS4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcKICAgIF07CiAgICAvKioKICAgIERlY2lkZXMgaWYgYHRocnVzdC9kYXRhYCBzaG91bGQgY2FjaGUgcmVxdWVzdHMgb3Igbm90LgogICAgCiAgICBZb3Ugc2hvdWxkIHR1cm4gdGhpcyB0byBgZmFsc2VgLCBpZiB5b3UgYXJlIGV4cGVyaWVuY2luZyBjYWNoaW5nIGlzc3VlcyBhbmQgbmVlZCB0byBkZWJ1Zy4KICAgIAogICAgQHByb3BlcnR5IGNhY2hlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmNhY2hlID0gdHJ1ZTsKICAgIC8qKgogICAgKgogICAgKiBgc3RhcnRUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgcmVxdWVzdHMKICAgICogYXJlIHN0YXJ0ZWQuCiAgICAqCiAgICAqCiAgICAqIFRoZSBxdWV1ZWluZyBzeXN0ZW0gd29ya3MgaW4gdGhlIGZvbGxvd2lnIG1hbm5lci4gIEFsbCByZXF1ZXN0cyB0aGF0IGFyZSBxdWV1ZWQgdG9nZXRoZXIgcGVyIEhUVFAKICAgICogcmVxdWVzdCBtZXRob2QgKGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwgYFBBVENIYCwgZXRjKS4gIEFmdGVyIHRoZSBmaXJzdCByZXF1ZXN0LCB0aGUgdGltZXIKICAgICogc3RhcnRzLCBvbmNlIHRoZSB0aW1lb3V0IGVsYXBzZXMsIGFsbCB0aGUgcmVxdWVzdHMgYXJlIHNoaXBwZWQgb2ZmIGF0IG9uY2UuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgY291bnRlciBpbnR1aXRpdmUgaWYgeW91J3JlIGxvb2tpbmcgdG8gZ2V0IHRoZSByZXF1ZXN0IGJhY2sgaW1tZWRpYXRlbHksIGJ1dCBmcm9tIGEgVVggcGVyc3BlY3RpdmUKICAgICogdGhpcyBhbGxvd3MgdGhlIFVJIHRvIHN0YXkgaW4gc3luYyBhbmQgZ2l2ZSB0aGUgdXNlciBhIGNvaGVzaXZlLCBpbnN0ZWFkIG9mIHNlZWluZyBsb2FkZXJzLCBzaG93IHVwIGFuZAogICAgKiBkaXNhcHBlYXIgYXQgc2VlbWluZ2x5IHJhbmRvbSBpbnRlcnZhbHMsIHRoZSB1c2VyIGRvZXMgYW4gYWN0aW9uLCBhbmQgdGhlbiBzZWVzIGEgcmVzcG9uc2UuCiAgICAqCiAgICAqCiAgICAqIEBwcm9wZXJ0eSBzdGFydFRpbWVvdXQKICAgICogQHJlYWRPbmx5CiAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAqIEBkZWZhdWx0IDUwMAogICAgKiovCiAgICBleHBvcnRzLnN0YXJ0VGltZW91dCA9IDEwMDsKICAgIC8qKgogICAgKgogICAgKiBgZmluaXNoVGltZW91dGAgaXMgcGFydCBvZiBxdWV1ZWluZyBidWlsdCBpbnRvIGB0aHJ1c3QvZGF0YWAuICBJdCBkZWZpbmVzIHRoZSB3YWl0IHRpbWUgYmVmb3JlIHRoZQogICAgKiBxdWV1ZSBpcyBjb21wbGV0ZWQuICBJZiBhbGwgdGhlIHJlcXVlc3RzIGZpbmlzaCBlYXJseSwgdGhlIHRpbWVvdXQgaXMgY2FuY2VsZWQuCiAgICAqCiAgICAqCiAgICAqIFRoZSBxdWV1ZWluZyBzeXN0ZW0gd29ya3MgaW4gdGhlIGZvbGxvd2lnIG1hbm5lci4gIEFsbCByZXF1ZXN0cyB0aGF0IGFyZSBxdWV1ZWQgdG9nZXRoZXIgcGVyIEhUVFAKICAgICogcmVxdWVzdCBtZXRob2QgKGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwgYFBBVENIYCwgZXRjKS4gIEFmdGVyIHRoZSByZXF1ZXN0cyBhcmUgZmlyZWQgb2ZmCiAgICAqIGB0aHJ1c3QvZGF0YWAgd2lsbCB3YWl0IHVudGlsIGl0IGdldHMgYSByZXNwb25zZSBmcm9tIGV2ZXJ5b25lIG9mIHRoZW0uICBJZiBmb3Igc29tZSByZWFzb24gYSByZXF1ZXN0CiAgICAqIHRha2VzIHRvIGxvbmcsIGFuZCB0aGUgdGltZW91dCBpcyBoaXQsIGFsbCB0aGUgcmVxdWVzdHMgdGhhdCBoYXZlIGNvbXBsZXRlZCwgd2lsbCBiZSByZWxlYXNlZWQsIGFsbG93aW5nCiAgICAqIHRoZSBhcHBsaWNhdGlvbiB0byBjb250aW51ZSB1bmRpc3J1cHRlZC4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgIEBwcm9wZXJ0eSBmaW5pc2hUaW1lb3V0CiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtOdW1iZXJ9CiAgICBAZGVmYXVsdCAyMDAwCiAgICAqKi8KICAgIGV4cG9ydHMuZmluaXNoVGltZW91dCA9IDIwMDA7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LnR5cGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvKioKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgKiovCiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvd2FpdGAgZXZlbnQgaXMgZmlyZWQgb25jZSBhIGRhdGEgY2FsbCBpcyBtYWRlLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvd2FpdAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgKiovCiAgICBleHBvcnRzLndhaXQgPSAndGhydXN0L2RhdGEvd2FpdCc7CiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvc3RhcnRgIGV2ZW50IGlzIGZpcmVkIHRoZSBxdWV1ZSBpcyBzdGFydGVkLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhcnQKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgb3V0Z29pbmcgY2FsbCBjb3VudAogICAgKiovCiAgICBleHBvcnRzLnN0YXJ0ID0gJ3RocnVzdC9kYXRhL3N0YXJ0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGF0dXNgIGV2ZW50IGlzIGZpcmVkIGZvciBldmVyeSBpdGVtIHRoYXQgcmV0dXJucyBmcm9tIHRoZSBxdWV1ZS4KICAgIAogICAgTk9URTogSXQgaXMgZW50aXJlbHkgcG9zc2libGUgZm9yIGB0aHJ1c3QvZGF0YS9zdGF0dXMqKiB0byBiZSBjYWxsZWQgYWZ0ZXIgYHRocnVzdC9kYXRhL3N0b3AqKiBpZiBzZXZlcmFsCiAgICBjYWxscyB0YWtlIHRvIGxvbmcgdG8gY29tcGxldGUuICBUaGlzIGlzIGludGVuZGVkLCBhbmQgcG90ZW50aWFsbHkgdXNlZnVsIGluZm9ybWF0aW9uLgogICAgCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhdHVzCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIGN1cnJlbnQgY29tcGxldGVkIGNhbGwgY291bnQgZm9yIHRoaXMgcXVldWUuCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhdHVzID0gJ3RocnVzdC9kYXRhL3N0YXR1cyc7CiAgICAvKioKICAgIFRoZSBgdGhydXN0L2RhdGEvc3RvcGAgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbGwgaXRlbXMgaW4gdGhlIHF1ZXVlIHJldHVybiwgb3IgdGhlIGZpbmlzaGVkVGltZW91dCBzZXR0aW5nIGVsYXBzZXMuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdG9wCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIChjdXJyZW50KSBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdG9wID0gJ3RocnVzdC9kYXRhL3N0b3AnOwogICAgZXhwb3J0cy5ldmVudCA9IHsKICAgICAgICBiZWZvcmVTZW5kOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZCcsCiAgICAgICAgc3RhcnQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3RhcnRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0YXJ0JywKICAgICAgICBzZW5kOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L3NlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zZW5kCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc2VuZCcsCiAgICAgICAgZXJyb3I6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvZXJyb3JgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcgogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2Vycm9yJywKICAgICAgICBzdWNjZXNzOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3NgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zdWNjZXNzCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3VjZXNzJywKICAgICAgICBjb21wbGV0ZTogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZWAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUnLAogICAgICAgIHN0b3A6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3RvcGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0b3AKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdG9wJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQudHlwZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9ldmVudC5mYWN0b3J5JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuL2V2ZW50LnR5cGVzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19ldmVudFR5cGVzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGV2ZW50VHlwZXMgPSBfX2V2ZW50VHlwZXNfXzsKCiAgICB2YXIgY2FtZWxDYXNlID0gdXRpbC5jYW1lbENhc2UsIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBiaW5kID0gXy5iaW5kLCBkYXRhRXZlbnRzID0gZXZlbnRUeXBlcy5ldmVudCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIG1lbW9pemUgPSBfLm1lbW9pemU7CiAgICAvKioKICAgIFRoZSBldmVudCBmYWN0b3J5IGxpbmtzIGpRdWVyeSBFdmVudHMgdXAgdG8gdGhydXN0IGNlbnRyaWMgZXZlbnRzLgogICAgVGhlIGV2ZW50IGZhY3Rvcnkgd291bGQgYmUgcmVwbGFjZWQgaWYgd2Ugd2VyZSBldmVyIG1vdmVkIG9mZiBvZiB0aGUgalF1ZXJ5IGRlcGVuZGFuY3kuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgICoqLwogICAgdmFyIGV2ZW50SGFuZGxlcnMgPSB7CiAgICAgICAgJ2JlZm9yZS1zZW5kJzogLy8gU3VwcG9ydGVkIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgdHJ1ZSwKICAgICAgICAnc2VuZCc6IHRydWUsCiAgICAgICAgJ2Vycm9yJzogdHJ1ZSwKICAgICAgICAnc3VjY2Vzcyc6IHRydWUsCiAgICAgICAgJ2NvbXBsZXRlJzogdHJ1ZSwKICAgICAgICAnc3RhcnQnOiB0cnVlLAogICAgICAgICdzdG9wJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgV3JhcHMgYmVmb3JlU2VuZCwgd2hpY2ggaXMgYSBjdXN0b20gcHJvcGVydHkgb24gdGhlIGpRdWVyeSBhamF4IGRhdGEgY2FsbC4KICAgIAogICAgQG1ldGhvZCBiZWZvcmVTZW5kTWV0aG9kCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBiZWZvcmVTZW5kTWV0aG9kKGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgdGhpcy5maXJlKGRhdGFFdmVudHNbJ2JlZm9yZVNlbmQnXSwganFYSFIsIHNldHRpbmdzKTsKICAgIH0KICAgIGV4cG9ydHMuYmVmb3JlU2VuZE1ldGhvZCA9IGJlZm9yZVNlbmRNZXRob2Q7CiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgZXZ0ID0gZGF0YUV2ZW50c1tldmVudF07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChldnQpOwogICAgICAgICAgICB0aGlzLmZpcmUuYXBwbHkodGhpcy5maXJlLmFzeW5jLCBhcmdzKTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgbm9ybWFsaXplRXZlbnRzID0gZnVuY3Rpb24gKGV2dHMpIHsKICAgICAgICBldnRzID0gZXZ0cy5zcGxpdCgnICcpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZighZXZlbnRIYW5kbGVyc1tldnRzW2ldXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnRXZlbnQgInswfSIgaXMgbm90IGEgdmFsaWQgZGF0YSBldmVudCcsIGV2dHNbaV0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBldnRzW2ldID0gZGF0YUV2ZW50c1tldnRzW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2dHMuam9pbignICcpOwogICAgfTsKICAgIHZhciBzZW5kRXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKGkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV2ZW50LCBqcVhIUiwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgaWYoIXNldHRpbmdzLl9fbWVkaWF0b3JfZGF0YV9maXJlZF9fKSB7CiAgICAgICAgICAgICAgICBqcVhIUi5hYm9ydCgpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQsIGFsbCBhamF4IGNhbGxzIG11c3QgcGFzcyB0aHJvdWdoIHRocnVzdC1kYXRhLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50RmFjdG9yeShpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIEJpbmRzIGFsbCB0aGUgalF1ZXJ5IGRhdGEgZXZlbnRzIGFuZCBjcmVhdGVzIGV2ZW50IG5hdGl2ZSB0aHJ1c3QgZXZlbnRzIG91dCBvZiB0aGVtLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBpbml0CiAgICBAcGFyYW0ge2pRdWVyeX0gQSBqUXVlcnkgaW5zdGFuY2Ugd3JhcHBpbmcgJ2RvY3VtZW50JwogICAgKiovCiAgICBmdW5jdGlvbiBpbml0KGpEb2MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgIGZvcih2YXIgaSBpbiBldmVudEhhbmRsZXJzKSB7CiAgICAgICAgICAgIHZhciBqcUV2dCA9ICdhamF4LScgKyBpLCBtZXRob2QgPSBldmVudEZhY3RvcnkoaSk7CiAgICAgICAgICAgIGlmKGkgPT09ICdzZW5kJykgewogICAgICAgICAgICAgICAgbWV0aG9kID0gYmluZChzZW5kRXZlbnRGYWN0b3J5KGkpLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqRG9jLm9uKGNhbWVsQ2FzZShqcUV2dCkgKyB0aGlzLm5hbWVzcGFjZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluaXQgPSBpbml0Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC5mYWN0b3J5LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvcmVzcG9uc2UucXVldWUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnLCAnanF1ZXJ5JywgJ3RocnVzdC9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19ldmVudFR5cGVzX18sIF9falF1ZXJ5X18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCB1aWQgPSBfLnVuaXF1ZUlkLCBhamF4ID0galF1ZXJ5LmFqYXgsIGRhdGFFdmVudFdhaXQgPSBldmVudFR5cGVzLndhaXQsIGRhdGFFdmVudFN0YXJ0ID0gZXZlbnRUeXBlcy5zdGFydCwgZGF0YUV2ZW50U3RvcCA9IGV2ZW50VHlwZXMuc3RvcCwgZGF0YUV2ZW50U3RhdHVzID0gZXZlbnRUeXBlcy5zdGF0dXMsIHF1ZXVlID0gewogICAgfSwgdXBkYXRlWEhSSW50ZXJuYWxzID0gZnVuY3Rpb24gKGRmbywgeGhyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYoIWRmby5feGhyKSB7CiAgICAgICAgICAgICAgICBkZm8uX3hociA9IHhocjsKICAgICAgICAgICAgICAgIGRmby5nZXRBbGxSZXNwb25zZUhlYWRlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRmby5feGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5nZXRSZXNwb25zZUhlYWRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzZ2V0UmVzcG9uc2VIZWFkZXIoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uYWJvcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRmby5feGhyLmFib3J0KCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLnNldFJlcXVlc3RIZWFkZXIgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuc2V0UmVxdWVzdEhlYWRlcihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRmby5yZXNwb25zZVRleHQgPSB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICBkZm8ucmVzcG9uc2VYTUwgPSB4aHIucmVzcG9uc2VYTUw7CiAgICAgICAgICAgIGRmby5yZWFkeVN0YXRlID0geGhyLnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGRmby5zdGF0dXMgPSB4aHIuc3RhdHVzOwogICAgICAgICAgICBkZm8uc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwogICAgICAgIH07CiAgICB9LCBhcmd1bWVudFJlc29sdmVyID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QoXy50b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIH07CiAgICB9LCBkZWZlckNvbnRyb2xsZXJJdGVtQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZnVuYykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpcywgYXJndW1lbnRzWzBdWzBdKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgVGhlIHJlc3BvbnNlIHF1ZXVlIGNsYXNzIGhhbmRsZXMgY3JlYXRpb24gb2YgYSBxdWV1ZSBvciBiYXRjaGluZyBzeXN0ZW0uCiAgICBXaXRoIHRoaXMgc3lzdGVtLCB3ZSBjYW4gYmF0Y2ggdXAgYWxsIG91ciBzZXJ2ZXIgcmVxdWVzdHMsIGFuZCByZXF1ZXN0IHRoZW0gZnJvbSB0aGUgc2VydmVyIGFsbCBhcm91bmQgdGhlIHNhbWUgdGltZS4KICAgIEluIGFkZGl0aW9uIHRvIHRoYXQsIHdoZW4gdGhlIHJlcXVlc3RzIGNvbWUgYmFjayB3ZSBjYW4gYWxzbyBzcG9vbCB0aGVtIHRvZ2V0aGVyLCBzbyB0aGF0IHRoZSBjYWxscyBkb24ndCByZXNvbHZlIHVudGlsCiAgICBlaXRoZXIgYWxsIHRoZSBjYWxscyBjb21lIGJhY2ssIG9yIGEgc3BlY2lmaWMgdGltZSBoYXMgZWxhcHNlZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLlJlc3BvbnNlUXVldWUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIHJlc3BvbnNlIHF1ZXVlIGZvcgogICAgQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0VGltZW91dCBUaGUgdGltZSB0byB3YWl0IGZvciBhZGRpdGlvbmFsIHJlcXVlc3RzLgogICAgQHBhcmFtIHtOdW1iZXJ9IGZpbmlzaFRpbWVvdXQgVGhlIG1heGltdW0gdGltZSB0byB3YWl0IGZvciByZXF1ZXN0cyB0byByZXR1cm4uCiAgICAqKi8KICAgIHZhciBSZXNwb25zZVF1ZXVlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBSZXNwb25zZVF1ZXVlKG1vZHVsZSwgc3RhcnRUaW1lb3V0LCBmaW5pc2hUaW1lb3V0KSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lb3V0ID0gc3RhcnRUaW1lb3V0OwogICAgICAgICAgICB0aGlzLmZpbmlzaFRpbWVvdXQgPSBmaW5pc2hUaW1lb3V0OwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSBtb2R1bGUubmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5hZGRUb1F1ZXVlID0gLyoqCiAgICAgICAgQWRkcyBhIHJlcXVlc3QgdG8gdGhlIHF1ZXVlCiAgICAgICAgUXVldWVzIGFyZSBzcGxpdCB1cCBieSBIVFRQIHR5cGUsIHNvIEdFVCByZXF1ZXN0cyBnbyB3aXRoIEdFVCByZXF1ZXN0cyBhbmQgUE9TVCByZXF1ZXN0cyBnbyB3aXRoIFBPU1QgcmVxdWVzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBhZGRUb1F1ZXVlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSAoUE9TVCwgR0VULCBldGMpCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgcmVxdWVzdCB1cmwgdG8gcXVldWUgdXAKICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgcmVxdWVzdCBvcHRpb25zLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBvciByZWplY3QsIHdoZW4gdGhlIHJlcXVlc3QgaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0eXBlLCB1cmwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuYmVmb3JlU2VuZCkgewogICAgICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoZnVuY3Rpb24gKGV2ZW50VHlwZSkgewogICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50VHlwZSAmJiBldmVudFR5cGUgPT0gJ2JlZm9yZS1zZW5kJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlU2VuZC5hcHBseShiZWZvcmVTZW5kLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2UuYWx3YXlzKG9wdGlvbnMuY29tcGxldGUpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuY29tcGxldGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS50aGVuKG9wdGlvbnMuc3VjY2Vzcyk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMuZXJyb3IpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLm90aGVyd2lzZShvcHRpb25zLmVycm9yKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNRdWV1ZSA9ICEhcXVldWVbdHlwZV0sIGxpc3QgPSBxdWV1ZVt0eXBlXSB8fCAocXVldWVbdHlwZV0gPSB7CiAgICAgICAgICAgIH0pLCB0YWlsID0gbGlzdC50YWlsIHx8IChsaXN0LnRhaWwgPSBsaXN0Lm5leHQgPSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBleHRlbmQodGFpbCwgewogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgICAgICAgICAgZGZvOiBkZm8KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxpc3QudGFpbCA9IHRhaWwubmV4dCA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoIWhhc1F1ZXVlKSB7CiAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuc3RhcnRUaW1lb3V0KS50aGVuKHRoYXQucHJvY2Vzcyh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgIH07CiAgICAgICAgUmVzcG9uc2VRdWV1ZS5wcm90b3R5cGUucHJvY2VzcyA9IC8qKgogICAgICAgIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCB3aWxsIHByb2Nlc3MgdGhlIGdpdmVuIHF1ZXVlIGFmdGVyIHRoZSBzdGFydCB0aW1lIGhhcyBlbGFwc2VkLgogICAgICAgIAogICAgICAgIEBtZXRob2QgcHJvY2VzcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBxdWV1ZSB0eXBlLCB0byBwcm9jZXNzLgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBkbyB0aGUgd29yayBvbiB0aGUgcXVldWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IHF1ZXVlW3R5cGVdLCBub2RlID0gcGFyZW50LCB0aGF0ID0gdGhpcywgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBQcm9jZXNzaW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgICAgIHZhciB3aGVuUXVldWUgPSBbXSwgZGVmZXJDb250cm9sbGVyID0gd2hlbi5kZWZlcigpLCByZXR1cm5Db3VudCA9IDA7CiAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogRmluaXNoaW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0b3AsIHF1ZXJ5SWQsIHR5cGUsIHJldHVybkNvdW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIHF1ZXVlW3R5cGVdOwogICAgICAgICAgICAgICAgdmFyIHRhaWwgPSBub2RlLnRhaWwsIHN0YXR1c0NhbGxiYWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RhdHVzLCBxdWVyeUlkLCB0eXBlLCArK3JldHVybkNvdW50KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGZvID0gbm9kZS5kZm8sIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgICAgIH0sIG5vZGUub3B0aW9ucyksIHhockRmbyA9IHdoZW4uZGVmZXIoKSwgeGhyID0gbm9kZS54aHIgPSBhamF4KG5vZGUudXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKHhockRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgICAgICB4aHJEZm8ucHJvbWlzZS50aGVuKHN0YXR1c0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB3aGVuUXVldWUucHVzaCh4aHIpOwogICAgICAgICAgICAgICAgICAgIHdoZW4uYWxsKFsKICAgICAgICAgICAgICAgICAgICAgICAgeGhyRGZvLCAKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UKICAgICAgICAgICAgICAgICAgICBdLCB3aGVuLmFwcGx5KGRmby5yZXNvbHZlKSwgd2hlbi5hcHBseShkZm8ucmVqZWN0KSwgdXBkYXRlWEhSSW50ZXJuYWxzKGRmbywgeGhyKSk7CiAgICAgICAgICAgICAgICAgICAgZGZvLnByb2dyZXNzKCdiZWZvcmUtc2VuZCcsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZGZvLCAKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucwogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGFydCwgcXVlcnlJZCwgdHlwZSwgd2hlblF1ZXVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB3aGVuLmFueShbCiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwod2hlblF1ZXVlKSwgCiAgICAgICAgICAgICAgICAgICAgd2hlbi5kZWxheSh0aGF0LmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgICAgICBdLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSwgZGVmZXJDb250cm9sbGVyLnJlc29sdmUpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFJlc3BvbnNlUXVldWU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5SZXNwb25zZVF1ZXVlID0gUmVzcG9uc2VRdWV1ZTsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXJlc3BvbnNlLnF1ZXVlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgd2hlblF1ZXVlID0gW107CiAgICBmdW5jdGlvbiB3YWl0Q2FsbGJhY2sodWlkKSB7CiAgICAgICAgdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgZC5yZXNvbHZlclsndWlkJ10gPSB1aWQ7CiAgICAgICAgd2hlblF1ZXVlLnB1c2goewogICAgICAgICAgICB1aWQ6IHVpZCwKICAgICAgICAgICAgcmVzb2x2ZXI6IGQucmVzb2x2ZXIKICAgICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgaXRlbSA9IF8uZmluZCh3aGVuUXVldWUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB4LnVpZCA9PT0gdWlkOwogICAgICAgIH0pOwogICAgICAgIHdoZW5RdWV1ZSA9IF8ud2l0aG91dCh3aGVuUXVldWUsIGl0ZW0pOwogICAgICAgIGl0ZW0ucmVzb2x2ZXIucmVzb2x2ZSgpOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIC8vIFN1YnNjcmliZSB0byB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS93YWl0Jywgd2FpdENhbGxiYWNrKTsKICAgICAgICAgICAgdGhydXN0LmRhdGEuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS9zdG9wJywgc3RvcENhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIC8vIFVuc3Vic2NyaWJlIGZyb20gdGhlIHdhaXQgYW5kIHN0b3AgZXZlbnRzCiAgICAgICAgICAgIHRocnVzdC5kYXRhLnVuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS93YWl0Jywgd2FpdENhbGxiYWNrKTsKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgICAgICAvLyBkZWZlciB1bnRpbCBhbnkgb2YgdGhlIGV2ZW50cyB0aGF0IHdlcmUgY2FwdHVyZWQgYXJlIHJlc29sdmVkLCBvciB0aGUgZGVsYXkgcGFzc2VzLgogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRocnVzdC5jZmcuZGF0YS5maW5pc2hUaW1lb3V0ID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwod2hlblF1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgd2hlbi5hbGwod2hlblF1ZXVlKSwgCiAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRocnVzdC5jZmcuZGF0YS5maW5pc2hUaW1lb3V0KQogICAgICAgICAgICBdLCBkZWZlci5yZXNvbHZlLCBkZWZlci5yZWplY3QpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC5kb20uY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJywgCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JywgCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9ldmVudCcKICAgIF07Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vc3VianF1ZXJ5JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19qUXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgalF1ZXJ5ID0gX19qUXVlcnlfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBleHRlbmQgPSBfLmV4dGVuZCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgR0xPQkFMID0gJy5nbG9iYWwnOwogICAgdmFyIGpRdWVyeUZuTWV0aG9kQmxhY2tMaXN0ID0gWwogICAgICAgICdyZWFkeScsIAogICAgICAgICdleHRlbmQnLCAKICAgICAgICAncXVldWUnLCAKICAgICAgICAnZGVxdWV1ZScsIAogICAgICAgICdjbGVhclF1ZXVlJywgCiAgICAgICAgJ3Byb21pc2UnLCAKICAgICAgICAnYmluZCcsIAogICAgICAgICd1bmJpbmQnLCAKICAgICAgICAnbGl2ZScsIAogICAgICAgICdkaWUnLCAKICAgICAgICAnZGVsZWdhdGUnLCAKICAgICAgICAndW5kZWxlZ2F0ZScsIAogICAgICAgICdibHVyJywgCiAgICAgICAgJ2ZvY3VzJywgCiAgICAgICAgJ2ZvY3VzaW4nLCAKICAgICAgICAnZm9jdXNvdXQnLCAKICAgICAgICAnbG9hZCcsIAogICAgICAgICdyZXNpemUnLCAKICAgICAgICAnc2Nyb2xsJywgCiAgICAgICAgJ3VubG9hZCcsIAogICAgICAgICdjbGljaycsIAogICAgICAgICdkYmxjbGljaycsIAogICAgICAgICdtb3VzZWRvd24nLCAKICAgICAgICAnbW91c2V1cCcsIAogICAgICAgICdtb3VzZW1vdmUnLCAKICAgICAgICAnbW91c2VvdmVyJywgCiAgICAgICAgJ21vdXNlb3V0JywgCiAgICAgICAgJ21vdXNlZW50ZXInLCAKICAgICAgICAnbW91c2VsZWF2ZScsIAogICAgICAgICdjaGFuZ2UnLCAKICAgICAgICAnc2VsZWN0JywgCiAgICAgICAgJ3N1Ym1pdCcsIAogICAgICAgICdrZXlkb3duJywgCiAgICAgICAgJ2tleXByZXNzJywgCiAgICAgICAgJ2tleXVwJywgCiAgICAgICAgJ2Vycm9yJywgCiAgICAgICAgJ3NlcmlhbGl6ZScsIAogICAgICAgICdzZXJpYWxpemVBcnJheScsIAogICAgICAgICdhamF4U3RhcnQnLCAKICAgICAgICAnYWpheFN0b3AnLCAKICAgICAgICAnYWpheENvbXBsZXRlJywgCiAgICAgICAgJ2FqYXhFcnJvcicsIAogICAgICAgICdhamF4U3VjY2VzcycsIAogICAgICAgICdhamF4U2VuZCcsIAogICAgICAgICdfdG9nZ2xlJywgCiAgICAgICAgJ2ZhZGVUbycsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3NsaWRlRG93bicsIAogICAgICAgICdzbGlkZVVwJywgCiAgICAgICAgJ3NsaWRlVG9nZ2xlJywgCiAgICAgICAgJ2ZhZGVJbicsIAogICAgICAgICdmYWRlT3V0JywgCiAgICAgICAgJ2ZhZGVUb2dnbGUnLyosICdvbicsICdvZmYnLCAnb25lJyovIAogICAgXTsKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIGlmKCFuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgICB9CiAgICAgICAgaWYoaXNPYmplY3QoZXZlbnRzKSkgewogICAgICAgICAgICAvLyBDcmVhdGUgbmV3IG9iamVjdCwgc28gdGhhdCBvcmlnaW5hbCBvYmplY3Qgd2lsbCBub3QgYmUgbW9kaWZpZWQgd2hlbiBiaW5kaW5nLgogICAgICAgICAgICBldmVudHMgPSBleHRlbmQoewogICAgICAgICAgICB9LCBldmVudHMpOwogICAgICAgICAgICBmb3IodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICAgICAgICAgIGlmKGtleS5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRzW2tleSArIG5hbWVzcGFjZV0gPSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZighZXZlbnRzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cy5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGV2dCA9IGV2ZW50c1tpXTsKICAgICAgICAgICAgICAgIGlmKGV2dC5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRzW2ldID0gZXZ0ICsgbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBldmVudHMuam9pbignICcpOwogICAgICAgIH0KICAgIH0KICAgIC8qCiAgICBDbG9uZSBqcXVlcnkKICAgIFJlbW92ZSBhbGwgZXhjZXNzIG1ldGhvZHMgd2UgZG9uJ3Qgd2FudCB0byBleHBvc2UgbmF0aXZlbHkuCiAgICBvdmVycmxvYWQgYW55IG1ldGhvZHMgd2Ugd2FudCB0byBjaGFuZ2UgYmVoYXZpb3Igb2YgKG5vdGVhYmx5IG9uLCBvbmUsIGFuZCBvZmYpCiAgICAKICAgIEluc3RlYWQgb2YgZHVwbGljYXRpbmcgdGhlIGpxdWVyeSBiZWhhdmlvciB3ZSBpbnN0ZWFkIHJlYWxpZ24gaXQgdG8gb3VyIG93bi4KICAgICovCiAgICAvLyBqUXVlcnkgc3ViCiAgICBmdW5jdGlvbiBzdWJKUXVlcnkoKSB7CiAgICAgICAgdmFyIHRRdWVyeSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdFF1ZXJ5LnByb3RvdHlwZS5pbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UgfHwgKHRoaXMgJiYgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICB9OwogICAgICAgIF8ubWVyZ2UodFF1ZXJ5LCBqUXVlcnkpOwogICAgICAgIC8vIERvIG5vdCBsaWtlCiAgICAgICAgLy8gcHJvYmFibHkgbmVlZGVkIGluIHNvbWUgc3BlY2lhbCB1bmlxdWUgY2FzZXMKICAgICAgICB0UXVlcnkualF1ZXJ5ID0galF1ZXJ5OwogICAgICAgIC8vIGV4cG9zZSBldmVudHMgZm9yIGRvaW5nIHNwZWNpYWwgZXZlbnRzIGFzIHJlcXVpcmVkLgogICAgICAgIHRRdWVyeS5ldmVudCA9IChqUXVlcnkpLmV2ZW50OwogICAgICAgIHRRdWVyeS5mbiA9IHRRdWVyeS5wcm90b3R5cGUgPSBleHRlbmQoewogICAgICAgIH0sIGpRdWVyeS5mbik7CiAgICAgICAgdFF1ZXJ5LmZuLmNvbnN0cnVjdG9yID0gdFF1ZXJ5OwogICAgICAgIHRRdWVyeS5mbi5pbml0ID0gZnVuY3Rpb24gaW5pdChzZWxlY3RvciwgY29udGV4dCwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHZhciBpb0RvbSA9IGNvbnRleHQgaW5zdGFuY2VvZiB0UXVlcnk7CiAgICAgICAgICAgIGlmKGNvbnRleHQgJiYgY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSAmJiAhKGlvRG9tKSkgewogICAgICAgICAgICAgICAgY29udGV4dCA9IHRRdWVyeShjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0ID0galF1ZXJ5LmZuLmluaXQuY2FsbCh0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgdFF1ZXJ5Um9vdCk7CiAgICAgICAgICAgIGlmKG5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgcmVzdWx0Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKICAgICAgICAgICAgfSBlbHNlIGlmKGlvRG9tKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gY29udGV4dC5uYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICAgIHRRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IHRRdWVyeS5mbjsKICAgICAgICB2YXIgdFF1ZXJ5Um9vdCA9IHRRdWVyeShkb2N1bWVudCk7CiAgICAgICAgLy8gcmVtb3ZlIGFsbCBub3QgYXBwbGljYWJsZSBtZXRob2RzIG9mZiBvZiBmbi4KICAgICAgICBlYWNoKGpRdWVyeUZuTWV0aG9kQmxhY2tMaXN0LCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBpZih0UXVlcnkuZm5beF0pIHsKICAgICAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IG51bGw7CiAgICAgICAgICAgICAgICBkZWxldGUgdFF1ZXJ5LmZuW3hdOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgXy5lYWNoKFsKICAgICAgICAgICAgJ29uJywgCiAgICAgICAgICAgICdvbmUnLCAKICAgICAgICAgICAgJ29mZicKICAgICAgICBdLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICB0UXVlcnkuZm5beF0gPSBfLndyYXAodFF1ZXJ5LmZuW3hdLCBmdW5jdGlvbiAoZikgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7Ci8vIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2Mi4yLjAKLy8gKGMpIFN0ZXZlbiBTYW5kZXJzb24gLSBodHRwOi8va25vY2tvdXRqcy5jb20vCi8vIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgooZnVuY3Rpb24oKXsKdmFyIERFQlVHPXRydWU7CihmdW5jdGlvbih3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yLGpRdWVyeSx1bmRlZmluZWQpewohZnVuY3Rpb24oZmFjdG9yeSkgewogICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKICAgIGlmICh0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwogICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwogICAgICAgIGZhY3RvcnkodGFyZ2V0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CiAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCiAgICAgICAgZGVmaW5lKCdrbm9ja291dCcsWydleHBvcnRzJ10sIGZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgICAgICAgZmFjdG9yeSh3aW5kb3dbJ2tvJ10gPSB7fSk7CiAgICB9Cn0oZnVuY3Rpb24oa29FeHBvcnRzKXsKLy8gSW50ZXJuYWxseSwgYWxsIEtPIG9iamVjdHMgYXJlIGF0dGFjaGVkIHRvIGtvRXhwb3J0cyAoZXZlbiB0aGUgbm9uLWV4cG9ydGVkIG9uZXMgd2hvc2UgbmFtZXMgd2lsbCBiZSBtaW5pZmllZCBieSB0aGUgY2xvc3VyZSBjb21waWxlcikuCi8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCnZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307Ci8vIEdvb2dsZSBDbG9zdXJlIENvbXBpbGVyIGhlbHBlcnMgKHVzZWQgb25seSB0byBtYWtlIHRoZSBtaW5pZmllZCBmaWxlIHNtYWxsZXIpCmtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7Cgl2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJLy8gSW4gdGhlIGZ1dHVyZSwgImtvIiBtYXkgYmVjb21lIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgKHNvIHRoYXQgbm9uLWV4cG9ydGVkIG9iamVjdHMgYXJlIG5vdCByZWFjaGFibGUpCgkvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJdmFyIHRhcmdldCA9IGtvOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aCAtIDE7IGkrKykKCQl0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCXRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKfTsKa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CiAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cn07CmtvLnZlcnNpb24gPSAiMi4yLjAiOwoKa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7CmtvLnV0aWxzID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyaW5nVHJpbVJlZ2V4ID0gL14oXHN8XHUwMEEwKSt8KFxzfFx1MDBBMCkrJC9nOwoKICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCiAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKICAgIHZhciBrZXlFdmVudFR5cGVOYW1lID0gL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpID8gJ0tleWJvYXJkRXZlbnQnIDogJ1VJRXZlbnRzJzsKICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CiAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBrbm93bkV2ZW50cykgewogICAgICAgIHZhciBrbm93bkV2ZW50c0ZvclR5cGUgPSBrbm93bkV2ZW50c1tldmVudFR5cGVdOwogICAgICAgIGlmIChrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CiAgICAgICAgfQogICAgfQogICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCiAgICAvLyBOb3RlIHRoYXQsIHNpbmNlIElFIDEwIGRvZXMgbm90IHN1cHBvcnQgY29uZGl0aW9uYWwgY29tbWVudHMsIHRoZSBmb2xsb3dpbmcgbG9naWMgb25seSBkZXRlY3RzIElFIDwgMTAuCiAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgogICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgogICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAogICAgICAgIHdoaWxlICgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAogICAgICAgICAgICBpRWxlbXNbMF0KICAgICAgICApOwogICAgICAgIHJldHVybiB2ZXJzaW9uID4gNCA/IHZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICB9KCkpOwogICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAogICAgICAgIGlzSWU3ID0gaWVWZXJzaW9uID09PSA3OwoKICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZXZlbnRUeXBlLnRvTG93ZXJDYXNlKCkgIT0gImNsaWNrIikgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgogICAgICAgIGFycmF5Rm9yRWFjaDogZnVuY3Rpb24gKGFycmF5LCBhY3Rpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0pOwogICAgICAgIH0sCgogICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpcnN0OiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSwgcHJlZGljYXRlT3duZXIpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbaV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIGFycmF5UmVtb3ZlSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtVG9SZW1vdmUpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlHZXREaXN0aW5jdFZhbHVlczogZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGFycmF5TWFwOiBmdW5jdGlvbiAoYXJyYXksIG1hcHBpbmcpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0pKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVB1c2hBbGw6IGZ1bmN0aW9uIChhcnJheSwgdmFsdWVzVG9QdXNoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9LAoKICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgICAgICAgIHdoaWxlIChkb21Ob2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRoZSB1bmRlcmx5aW5nIGNvbGxlY3Rpb24gdG8gY2hhbmdlIHdoaWxlIHdlJ3JlIGRvaW5nIHRoYXQuCiAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjsKICAgICAgICB9LAoKICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoLCBuZXdOb2Rlc0FycmF5ID0gW107IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwogICAgICAgIH0sCgogICAgICAgIHNldERvbU5vZGVDaGlsZHJlbjogZnVuY3Rpb24gKGRvbU5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CiAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CiAgICAgICAgICAgIGlmIChub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbmV3Tm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShub2Rlc1RvUmVwbGFjZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZTogZnVuY3Rpb24gKG9wdGlvbk5vZGUsIGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKICAgICAgICAgICAgICAgIG9wdGlvbk5vZGUuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIGlzU2VsZWN0ZWQpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nIHx8ICIiKS5yZXBsYWNlKHN0cmluZ1RyaW1SZWdleCwgIiIpOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1Rva2VuaXplOiBmdW5jdGlvbiAoc3RyaW5nLCBkZWxpbWl0ZXIpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gKHN0cmluZyB8fCAiIikuc3BsaXQoZGVsaW1pdGVyKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB0b2tlbnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJpbW1lZCA9IGtvLnV0aWxzLnN0cmluZ1RyaW0odG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgIGlmICh0cmltbWVkICE9PSAiIikKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0cmltbWVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nIHx8ICIiOwogICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZygwLCBzdGFydHNXaXRoLmxlbmd0aCkgPT09IHN0YXJ0c1dpdGg7CiAgICAgICAgfSwKCiAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKICAgICAgICAgICAgICAgIHJldHVybiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpID09IDE2OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb250YWluZWRCeU5vZGUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlSXNDb250YWluZWRCeShub2RlLCBub2RlLm93bmVyRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCiAgICAgICAgICAgIC8vIFBvc3NpYmxlIGZ1dHVyZSBvcHRpbWl6YXRpb246IElmIHdlIGtub3cgaXQncyBhbiBlbGVtZW50IGZyb20gYW4gWEhUTUwgZG9jdW1lbnQgKG5vdCBIVE1MKSwKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwogICAgICAgICAgICBpZiAoIW11c3RVc2VBdHRhY2hFdmVudCAmJiB0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzLCBqUXVlcnkgaW50ZXJmZXJlcyB3aXRoIHRoZSBldmVudCBoYW5kbGluZyBpbiBhbiBhd2t3YXJkIHdheToKICAgICAgICAgICAgICAgICAgICAvLyBpdCB0b2dnbGVzIHRoZSBlbGVtZW50IGNoZWNrZWQgc3RhdGUgKmFmdGVyKiB0aGUgY2xpY2sgZXZlbnQgaGFuZGxlcnMgcnVuLCB3aGVyZWFzIG5hdGl2ZQogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrIGV2ZW50cyB0b2dnbGUgdGhlIGNoZWNrZWQgc3RhdGUgKmJlZm9yZSogdGhlIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgaW50ZWNlcHRpbmcgdGhlIGhhbmRsZXIgYW5kIGFwcGx5aW5nIHRoZSBjb3JyZWN0IGNoZWNrZWRuZXNzIGJlZm9yZSBpdCBydW5zLgogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEhhbmRsZXIgPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZXZlbnREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZSA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50RGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGV2ZW50RGF0YS5jaGVja2VkU3RhdGVCZWZvcmVFdmVudCAhPT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxIYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZTsgLy8gUmVzdG9yZSB0aGUgc3RhdGUgalF1ZXJ5IGFwcGxpZWQKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWydiaW5kJ10oZXZlbnRUeXBlLCBoYW5kbGVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuYXR0YWNoRXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVsZW1lbnQgbXVzdCBiZSBhIERPTSBub2RlIHdoZW4gY2FsbGluZyB0cmlnZ2VyRXZlbnQiKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgdGhlIGpRdWVyeSAiY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMiIGlzc3VlIGRlc2NyaWJlZCBhYm92ZSBieSBzdG9yaW5nIHRoZSBvcmlnaW5hbCBjaGVja2VkIHN0YXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgZXZlbnREYXRhLnB1c2goeyBjaGVja2VkU3RhdGVCZWZvcmVFdmVudDogZWxlbWVudC5jaGVja2VkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWyd0cmlnZ2VyJ10oZXZlbnRUeXBlLCBldmVudERhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQuZGlzcGF0Y2hFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKICAgICAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5maXJlRXZlbnQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIFVubGlrZSBvdGhlciBicm93c2VycywgSUUgZG9lc24ndCBjaGFuZ2UgdGhlIGNoZWNrZWQgc3RhdGUgb2YgY2hlY2tib3hlcy9yYWRpb2J1dHRvbnMgd2hlbiB5b3UgdHJpZ2dlciB0aGVpciAiY2xpY2siIGV2ZW50CiAgICAgICAgICAgICAgICAvLyBzbyB0byBtYWtlIGl0IGNvbnNpc3RlbnQsIHdlJ2xsIGRvIGl0IG1hbnVhbGx5IGhlcmUKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gZWxlbWVudC5jaGVja2VkICE9PSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0cmlnZ2VyaW5nIGV2ZW50cyIpOwogICAgICAgIH0sCgogICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUucGVlaygpIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CiAgICAgICAgICAgIGlmIChjbGFzc05hbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvW1x3LV0rL2csCiAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goY2xhc3NOYW1lcy5tYXRjaChjc3NDbGFzc05hbWVSZWdleCksIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9mQ2xhc3MgPSBrby51dGlscy5hcnJheUluZGV4T2YoY3VycmVudENsYXNzTmFtZXMsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2ZDbGFzcyA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2hvdWxkSGF2ZUNsYXNzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMuc3BsaWNlKGluZGV4T2ZDbGFzcywgMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZEhhdmVDbGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwogICAgICAgICAgICBpZiAoKHZhbHVlID09PSBudWxsKSB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCkpCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAogICAgICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KICAgICAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2RvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlKV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpbm5lclRleHROb2RlLmRhdGEgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrby51dGlscy5mb3JjZVJlZnJlc2goZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRFbGVtZW50TmFtZTogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE5NwogICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHt9IC8vIEZvciBJRTkgd2l0aCBkb2MgbW9kZSAiSUU5IFN0YW5kYXJkcyIgYW5kIGJyb3dzZXIgbW9kZSAiSUU5IENvbXBhdGliaWxpdHkgVmlldyIKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZvcmNlUmVmcmVzaDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CiAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewogICAgICAgICAgICAgICAgLy8gRm9yIHRleHQgbm9kZXMgYW5kIGNvbW1lbnQgbm9kZXMgKG1vc3QgbGlrZWx5IHZpcnR1YWwgZWxlbWVudHMpLCB3ZSB3aWxsIGhhdmUgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKICAgICAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLnpvb20gPSBlbGVtLnN0eWxlLnpvb207CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBlbnN1cmVTZWxlY3RFbGVtZW50SXNSZW5kZXJlZENvcnJlY3RseTogZnVuY3Rpb24oc2VsZWN0RWxlbWVudCkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQogICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aCA9IG9yaWdpbmFsV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBpc0llNiA6IGlzSWU2LAogICAgICAgIGlzSWU3IDogaXNJZTcsCiAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKICAgICAgICBnZXRGb3JtRmllbGRzOiBmdW5jdGlvbihmb3JtLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgPyBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGQubmFtZSA9PT0gZmllbGROYW1lIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgICAgICB9LAoKICAgICAgICBwYXJzZUpzb246IGZ1bmN0aW9uIChqc29uU3RyaW5nKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICBpZiAoanNvblN0cmluZykgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkpTT04ucGFyc2UoanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvblN0cmluZykpKCk7IC8vIEZhbGxiYWNrIG9uIGxlc3Mgc2FmZSBwYXJzaW5nIGZvciBvbGRlciBicm93c2VycwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgICAgIGlmICgodHlwZW9mIEpTT04gPT0gInVuZGVmaW5lZCIpIHx8ICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgPT0gInVuZGVmaW5lZCIpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBKU09OLnN0cmluZ2lmeSgpLiBTb21lIGJyb3dzZXJzIChlLmcuLCBJRSA8IDgpIGRvbid0IHN1cHBvcnQgaXQgbmF0aXZlbHksIGJ1dCB5b3UgY2FuIG92ZXJjb21lIHRoaXMgYnkgYWRkaW5nIGEgc2NyaXB0IHJlZmVyZW5jZSB0byBqc29uMi5qcywgZG93bmxvYWRhYmxlIGZyb20gaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyIpOwogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKICAgICAgICB9LAoKICAgICAgICBwb3N0SnNvbjogZnVuY3Rpb24gKHVybE9yRm9ybSwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5jbHVkZUZpZWxkcyA9IG9wdGlvbnNbJ2luY2x1ZGVGaWVsZHMnXSB8fCB0aGlzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OwogICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwogICAgICAgICAgICBpZigodHlwZW9mIHVybE9yRm9ybSA9PSAnb2JqZWN0JykgJiYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcih1cmxPckZvcm0pID09PSAiZm9ybSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwogICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmNsdWRlRmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZmllbGRzW2pdLm5hbWVdID0gZmllbGRzW2pdLnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKTsKICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CiAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSB1cmw7CiAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0ga2V5OwogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKICAgICAgICB9CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3V0aWxzJywga28udXRpbHMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5RmlsdGVyJywga28udXRpbHMuYXJyYXlGaWx0ZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5TWFwJywga28udXRpbHMuYXJyYXlNYXApOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5leHRlbmQnLCBrby51dGlscy5leHRlbmQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wZWVrT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyJywga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MnLCBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoKaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewogICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCiAgICAvLyBJbiBjYXNlIHRoZSBicm93c2VyIGRvZXNuJ3QgaW1wbGVtZW50IGl0IG5hdGl2ZWx5LCBwcm92aWRlIGEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbi4gVGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBiYXNlZCBvbiB0aGUgb25lIGluIHByb3RvdHlwZS5qcwogICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICB9Owp9Cgprby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgdW5pcXVlSWQgPSAwOwogICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgdmFyIGRhdGFTdG9yZSA9IHt9OwogICAgcmV0dXJuIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGFsbERhdGFGb3JOb2RlID0ga28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgYWN0dWFsbHkgY3JlYXRlIGEgbmV3IGRvbURhdGEga2V5IGlmIHdlIGFyZSBhY3R1YWxseSBkZWxldGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIHRydWUpOwogICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRBbGw6IGZ1bmN0aW9uIChub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgICAgIHZhciBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB2YXIgaGFzRXhpc3RpbmdEYXRhU3RvcmUgPSBkYXRhU3RvcmVLZXkgJiYgKGRhdGFTdG9yZUtleSAhPT0gIm51bGwiKSAmJiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICAgICAgaWYgKCFoYXNFeGlzdGluZ0RhdGFTdG9yZSkgewogICAgICAgICAgICAgICAgaWYgKCFjcmVhdGVJZk5vdEZvdW5kKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdID0gImtvIiArIHVuaXF1ZUlkKys7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgaWYgKGRhdGFTdG9yZUtleSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwogICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gRXhwb3NpbmcgImRpZCBjbGVhbiIgZmxhZyBwdXJlbHkgc28gc3BlY3MgY2FuIGluZmVyIHdoZXRoZXIgdGhpbmdzIGhhdmUgYmVlbiBjbGVhbmVkIHVwIGFzIGludGVuZGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YScsIGtvLnV0aWxzLmRvbURhdGEpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCmtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIGRvbURhdGFLZXkgPSAiX19rb19kb21Ob2RlRGlzcG9zYWxfXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCiAgICBmdW5jdGlvbiBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICBhbGxEaXNwb3NlQ2FsbGJhY2tzID0gW107CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsRGlzcG9zZUNhbGxiYWNrczsKICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBkb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CiAgICAgICAgLy8gUnVuIGFsbCB0aGUgZGlzcG9zZSBjYWxsYmFja3MKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwogICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzLnNsaWNlKDApOyAvLyBDbG9uZSwgYXMgdGhlIGFycmF5IG1heSBiZSBtb2RpZmllZCBkdXJpbmcgaXRlcmF0aW9uICh0eXBpY2FsbHksIGNhbGxiYWNrcyB3aWxsIHJlbW92ZSB0aGVtc2VsdmVzKQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKICAgICAgICB9CgogICAgICAgIC8vIEFsc28gZXJhc2UgdGhlIERPTSBkYXRhCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5jbGVhcihub2RlKTsKCiAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCiAgICAgICAgLy8gc28gbm90aWZ5IGl0IHRvIHRlYXIgZG93biBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbm9kZSAmIGRlc2NlbmRhbnRzIGhlcmUuCiAgICAgICAgaWYgKCh0eXBlb2YgalF1ZXJ5ID09ICJmdW5jdGlvbiIpICYmICh0eXBlb2YgalF1ZXJ5WydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKICAgICAgICAgICAgalF1ZXJ5WydjbGVhbkRhdGEnXShbbm9kZV0pOwoKICAgICAgICAvLyBBbHNvIGNsZWFyIGFueSBpbW1lZGlhdGUtY2hpbGQgY29tbWVudCBub2RlcywgYXMgdGhlc2Ugd291bGRuJ3QgaGF2ZSBiZWVuIGZvdW5kIGJ5CiAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQogICAgICAgICAgICBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKICAgICAgICB2YXIgY2hpbGQsIG5leHRDaGlsZCA9IG5vZGVXaXRoQ2hpbGRyZW4uZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBjbGVhbk5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQogICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICBjbGVhblNpbmdsZU5vZGUobm9kZSk7CgogICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIGRlc2NlbmRhbnRzIGxpc3QgaW4gY2FzZSBpdCBjaGFuZ2VzIGR1cmluZyBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBkZXNjZW5kYW50cy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgIH0KICAgIH0KfSkoKTsKa28uY2xlYW5Ob2RlID0ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmNsZWFuTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKa28uZXhwb3J0U3ltYm9sKCdyZW1vdmVOb2RlJywga28ucmVtb3ZlTm9kZSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2spOwooZnVuY3Rpb24gKCkgewogICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCiAgICBmdW5jdGlvbiBzaW1wbGVIdG1sUGFyc2UoaHRtbCkgewogICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCiAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgogICAgICAgIC8vIE5vdGUgdGhhdCB0aGVyZSdzIHN0aWxsIGFuIGlzc3VlIGluIElFIDwgOSB3aGVyZWJ5IGl0IHdpbGwgZGlzY2FyZCBjb21tZW50IG5vZGVzIHRoYXQgYXJlIHRoZSBmaXJzdCBjaGlsZCBvZgogICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgogICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQogICAgICAgIC8vIChwb3NzaWJseSBhIHRleHQgbm9kZSkgaW4gZnJvbnQgb2YgdGhlIGNvbW1lbnQuIFNvLCBLTyBkb2VzIG5vdCBhdHRlbXB0IHRvIHdvcmthcm91bmQgdGhpcyBJRSBpc3N1ZSBhdXRvbWF0aWNhbGx5IGF0IHByZXNlbnQuCgogICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAogICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAgICAgLy8gRmluZHMgdGhlIGZpcnN0IG1hdGNoIGZyb20gdGhlIGxlZnQgY29sdW1uLCBhbmQgcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyAid3JhcCIgZGF0YSBmcm9tIHRoZSByaWdodCBjb2x1bW4KICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAoIXRhZ3MuaW5kZXhPZigiPHRkIikgfHwgIXRhZ3MuaW5kZXhPZigiPHRoIikpICAgJiYgWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCiAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhbHdheXMgcHJlZml4IHdpdGggc29tZSBkdW1teSB0ZXh0LCBiZWNhdXNlIG90aGVyd2lzZSwgSUU8OSB3aWxsIHN0cmlwIG91dCBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgaW4gZGVzY2VuZGFudHMuIFRvdGFsIG1hZG5lc3MuCiAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHdpbmRvd1snaW5uZXJTaGl2J10obWFya3VwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCiAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKICAgICAgICAgICAgZGl2ID0gZGl2Lmxhc3RDaGlsZDsKCiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGpRdWVyeUh0bWxQYXJzZShodG1sKSB7CiAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5WydjbGVhbiddKFtodG1sXSk7CgogICAgICAgIC8vIEFzIG9mIGpRdWVyeSAxLjcuMSwgalF1ZXJ5IHBhcnNlcyB0aGUgSFRNTCBieSBhcHBlbmRpbmcgaXQgdG8gc29tZSBkdW1teSBwYXJlbnQgbm9kZXMgaGVsZCBpbiBhbiBpbi1tZW1vcnkgZG9jdW1lbnQgZnJhZ21lbnQuCiAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCiAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCiAgICAgICAgaWYgKGVsZW1zICYmIGVsZW1zWzBdKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CiAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CiAgICAgICAgICAgIHdoaWxlIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5wYXJlbnROb2RlLm5vZGVUeXBlICE9PSAxMSAvKiBpLmUuLCBEb2N1bWVudEZyYWdtZW50ICovKQogICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CiAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWxlbXM7CiAgICB9CgogICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcgPyBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgICAvLyBBcyBiZWxvdywgYmVuZWZpdCBmcm9tIGpRdWVyeSdzIG9wdGltaXNhdGlvbnMgd2hlcmUgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCiAgICB9OwoKICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKICAgICAgICAvLyBUaGVyZSdzIG5vIGxlZ2l0aW1hdGUgcmVhc29uIHRvIGRpc3BsYXkgYSBzdHJpbmdpZmllZCBvYnNlcnZhYmxlIHdpdGhvdXQgdW53cmFwcGluZyBpdCwgc28gd2UnbGwgdW53cmFwIGl0CiAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgogICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sICE9ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAogICAgICAgICAgICAvLyBmb3IgZXhhbXBsZSA8dHI+IGVsZW1lbnRzIHdoaWNoIGFyZSBub3Qgbm9ybWFsbHkgYWxsb3dlZCB0byBleGlzdCBvbiB0aGVpciBvd24uCiAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShub2RlKVsnaHRtbCddKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkTm9kZXMgPSBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7Cgprby5tZW1vaXphdGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb3MgPSB7fTsKCiAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDAwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewogICAgICAgIHJldHVybiByYW5kb21NYXg4SGV4Q2hhcnMoKSArIHJhbmRvbU1heDhIZXhDaGFycygpOwogICAgfQogICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewogICAgICAgIGlmICghcm9vdE5vZGUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewogICAgICAgICAgICB2YXIgbWVtb0lkID0ga28ubWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dChyb290Tm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCiAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBtZW1vaXplOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwogICAgICAgICAgICB2YXIgbWVtb0lkID0gZ2VuZXJhdGVSYW5kb21JZCgpOwogICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CiAgICAgICAgfSwKCiAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBjYWxsYmFja1BhcmFtcyB8fCBbXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsgZGVsZXRlIG1lbW9zW21lbW9JZF07IH0KICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG1lbW9zID0gW107CiAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZW1vc1tpXS5kb21Ob2RlOwogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoY29tYmluZWRQYXJhbXMsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSk7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CiAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwprby5leHRlbmRlcnMgPSB7CiAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgogICAgICAgIC8vICgxKSBGb3IgZGVwZW5kZW50IG9ic2VydmFibGVzLCB3ZSB0aHJvdHRsZSAqZXZhbHVhdGlvbnMqIHNvIHRoYXQsIG5vIG1hdHRlciBob3cgZmFzdCBpdHMgZGVwZW5kZW5jaWVzCiAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCiAgICAgICAgLy8gKDIpIEZvciB3cml0YWJsZSB0YXJnZXRzIChvYnNlcnZhYmxlcywgb3Igd3JpdGFibGUgZGVwZW5kZW50IG9ic2VydmFibGVzKSwgd2UgdGhyb3R0bGUgKndyaXRlcyoKICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHsKICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCiAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod3JpdGVUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CiAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZSB9IC8vIFRyZWF0IGFsbCB2YWx1ZXMgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDoga28ub2JzZXJ2YWJsZVsiZm4iXVsiZXF1YWxpdHlDb21wYXJlciJdOwogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cn07CgpmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgIHZhciB0YXJnZXQgPSB0aGlzOwogICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBleHRlbmRlckhhbmRsZXIodGFyZ2V0LCByZXF1ZXN0ZWRFeHRlbmRlcnNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0Owp9Cgprby5leHBvcnRTeW1ib2woJ2V4dGVuZGVycycsIGtvLmV4dGVuZGVycyk7Cgprby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwp9Owprby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2soKTsKfTsKCmtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBrby51dGlscy5leHRlbmQodGhpcywga28uc3Vic2NyaWJhYmxlWydmbiddKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdzdWJzY3JpYmUnLCB0aGlzLnN1YnNjcmliZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZXh0ZW5kJywgdGhpcy5leHRlbmQpOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIHRoaXMuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKfQoKdmFyIGRlZmF1bHRFdmVudCA9ICJjaGFuZ2UiOwoKa28uc3Vic2NyaWJhYmxlWydmbiddID0gewogICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gbmV3IGtvLnN1YnNjcmlwdGlvbih0aGlzLCBib3VuZENhbGxiYWNrLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKICAgICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdKQogICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwogICAgfSwKCiAgICAibm90aWZ5U3Vic2NyaWJlcnMiOiBmdW5jdGlvbiAodmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pIHsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0uc2xpY2UoMCksIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIGEgc3Vic2NyaXB0aW9uIHdhcyBkaXNwb3NlZCBkdXJpbmcgdGhlIGFycmF5Rm9yRWFjaCBjeWNsZSwgY2hlY2sKICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiAoc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgIT09IHRydWUpKQogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50TmFtZV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG90YWw7CiAgICB9LAoKICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKfTsKCgprby5pc1N1YnNjcmliYWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIHR5cGVvZiBpbnN0YW5jZS5zdWJzY3JpYmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2VbIm5vdGlmeVN1YnNjcmliZXJzIl0gPT0gImZ1bmN0aW9uIjsKfTsKCmtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1N1YnNjcmliYWJsZScsIGtvLmlzU3Vic2NyaWJhYmxlKTsKCmtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIF9mcmFtZXMgPSBbXTsKCiAgICByZXR1cm4gewogICAgICAgIGJlZ2luOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBkaXN0aW5jdERlcGVuZGVuY2llczpbXSB9KTsKICAgICAgICB9LAoKICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckRlcGVuZGVuY3k6IGZ1bmN0aW9uIChzdWJzY3JpYmFibGUpIHsKICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKICAgICAgICAgICAgaWYgKF9mcmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRvcEZyYW1lID0gX2ZyYW1lc1tfZnJhbWVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgaWYgKCF0b3BGcmFtZSB8fCBrby51dGlscy5hcnJheUluZGV4T2YodG9wRnJhbWUuZGlzdGluY3REZXBlbmRlbmNpZXMsIHN1YnNjcmliYWJsZSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcy5wdXNoKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaWdub3JlOiBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CnZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6dHJ1ZSwgJ2Jvb2xlYW4nOnRydWUsICdudW1iZXInOnRydWUsICdzdHJpbmcnOnRydWUgfTsKCmtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlID0gaW5pdGlhbFZhbHVlOwoKICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFdyaXRlCgogICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAogICAgICAgICAgICBpZiAoKCFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10pIHx8ICFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10oX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8gUmVhZAogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQogICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwogICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7IH0KICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CiAgICBrby51dGlscy5leHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlSGFzTXV0YXRlZCIsIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgogICAgcmV0dXJuIG9ic2VydmFibGU7Cn0KCmtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CiAgICAiZXF1YWxpdHlDb21wYXJlciI6IGZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKICAgICAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwogICAgfQp9OwoKdmFyIHByb3RvUHJvcGVydHkgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHkgPSAiX19rb19wcm90b19fIjsKa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7Cgprby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CiAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IHByb3RvdHlwZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KfTsKCmtvLmlzT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cn0Ka28uaXNXcml0ZWFibGVPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAvLyBPYnNlcnZhYmxlCiAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBBbnl0aGluZyBlbHNlCiAgICByZXR1cm4gZmFsc2U7Cn0KCgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwprby5leHBvcnRTeW1ib2woJ2lzV3JpdGVhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7CmtvLm9ic2VydmFibGVBcnJheSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWVzKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgLy8gWmVyby1wYXJhbWV0ZXIgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgdG8gZW1wdHkgYXJyYXkKICAgICAgICBpbml0aWFsVmFsdWVzID0gW107CiAgICB9CiAgICBpZiAoKGluaXRpYWxWYWx1ZXMgIT09IG51bGwpICYmIChpbml0aWFsVmFsdWVzICE9PSB1bmRlZmluZWQpICYmICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKICAgIHZhciByZXN1bHQgPSBrby5vYnNlcnZhYmxlKGluaXRpYWxWYWx1ZXMpOwogICAga28udXRpbHMuZXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCmtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKICAgICdyZW1vdmUnOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwogICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHJlbW92ZWRWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbW92ZWRWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKICAgIH0sCgogICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIHJldHVybiBhbGxWYWx1ZXM7CiAgICAgICAgfQogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdkZXN0cm95JzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheVtpXVsiX2Rlc3Ryb3kiXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICB9LAoKICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CiAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2luZGV4T2YnOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwogICAgfSwKCiAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwovLyBJbXBvcnRhbnQ6IERvIG5vdCBhZGQgYW55IGFkZGl0aW9uYWwgZnVuY3Rpb25zIGhlcmUgdGhhdCBtYXkgcmVhc29uYWJseSBiZSB1c2VkIHRvICpyZWFkKiBkYXRhIGZyb20gdGhlIGFycmF5Ci8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ11bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICB2YXIgbWV0aG9kQ2FsbFJlc3VsdCA9IHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKICAgIH07Cn0pOwoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsic2xpY2UiXSwgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwogICAgfTsKfSk7Cgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7CmtvLmRlcGVuZGVudE9ic2VydmFibGUgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlLAogICAgICAgIF9oYXNCZWVuRXZhbHVhdGVkID0gZmFsc2UsCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICByZWFkRnVuY3Rpb24gPSBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9uczsKCiAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKICAgICAgICAvLyBTaW5nbGUtcGFyYW1ldGVyIHN5bnRheCAtIGV2ZXJ5dGhpbmcgaXMgb24gdGhpcyAib3B0aW9ucyIgcGFyYW0KICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwogICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoIXJlYWRGdW5jdGlvbikKICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfQogICAgaWYgKHR5cGVvZiByZWFkRnVuY3Rpb24gIT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpIHsKICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdOwogICAgfQoKICAgIGZ1bmN0aW9uIGV2YWx1YXRlUG9zc2libHlBc3luYygpIHsKICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwogICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZSgpIHsKICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgZGVzaXJhYmxlIChpdCdzIGhhcmQgZm9yIGEgZGV2ZWxvcGVyIHRvIHJlYWxpc2UgYSBjaGFpbiBvZiBkZXBlbmRlbmNpZXMgbWlnaHQgY2F1c2UgdGhpcywgYW5kIHRoZXkgYWxtb3N0CiAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwogICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBkaXNwb3NlIG9uIGZpcnN0IGV2YWx1YXRpb24sIGJlY2F1c2UgdGhlICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgbWlnaHQKICAgICAgICAvLyBlLmcuLCBkaXNwb3NlIHdoZW4gdGhlIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgaXNuJ3QgaW4gdGhlIGRvYywgYW5kIGl0J3Mgbm90CiAgICAgICAgLy8gZ29pbmcgdG8gYmUgaW4gdGhlIGRvYyB1bnRpbCAqYWZ0ZXIqIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgaWYgKF9oYXNCZWVuRXZhbHVhdGVkICYmIGRpc3Bvc2VXaGVuKCkpIHsKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSW5pdGlhbGx5LCB3ZSBhc3N1bWUgdGhhdCBub25lIG9mIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBzdGlsbCBiZWluZyB1c2VkIChpLmUuLCBhbGwgYXJlIGNhbmRpZGF0ZXMgZm9yIGRpc3Bvc2FsKS4KICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgogICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0ga28udXRpbHMuYXJyYXlNYXAoX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24oaXRlbSkge3JldHVybiBpdGVtLnRhcmdldDt9KTsKCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oZnVuY3Rpb24oc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5PbGQ7CiAgICAgICAgICAgICAgICBpZiAoKGluT2xkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGRpc3Bvc2FsQ2FuZGlkYXRlcywgc3Vic2NyaWJhYmxlKSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICBkaXNwb3NhbENhbmRpZGF0ZXNbaW5PbGRdID0gdW5kZWZpbmVkOyAvLyBEb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhpcyBzdWJzY3JpcHRpb24sIGFzIGl0J3Mgc3RpbGwgYmVpbmcgdXNlZAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpOyAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc3Vic2NyaXB0aW9uIG5vIGxvbmdlciBiZWluZyB1c2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgYWN0aXZlIHN1YnNjcmlwdGlvbnMgbGlzdCBhbmQgZGlzcG9zZSBpdAogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcG9zYWxDYW5kaWRhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDYW5kaWRhdGVzW2ldKQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpWzBdLmRpc3Bvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfaGFzQmVlbkV2YWx1YXRlZCA9IHRydWU7CgogICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwogICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKERFQlVHKSBkZXBlbmRlbnRPYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOwogICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CiAgICAgICAgaWYgKCFfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLmxlbmd0aCkKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlcGVuZGVudE9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgLy8gV3JpdGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd3JpdGUgYSB2YWx1ZSB0byBhIGtvLmNvbXB1dGVkIHVubGVzcyB5b3Ugc3BlY2lmeSBhICd3cml0ZScgb3B0aW9uLiBJZiB5b3Ugd2lzaCB0byByZWFkIHRoZSBjdXJyZW50IHZhbHVlLCBkb24ndCBwYXNzIGFueSBwYXJhbWV0ZXJzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAoIV9oYXNCZWVuRXZhbHVhdGVkKQogICAgICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHBlZWsoKSB7CiAgICAgICAgaWYgKCFfaGFzQmVlbkV2YWx1YXRlZCkKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgIHJldHVybiAhX2hhc0JlZW5FdmFsdWF0ZWQgfHwgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGggPiAwOwogICAgfQoKICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKICAgICAgICBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgPSBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB8fCBudWxsLAogICAgICAgIGRpc3Bvc2VXaGVuID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgICAgICAgZGlzcG9zZSA9IGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsCiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdLAogICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCiAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPSBvcHRpb25zWyJvd25lciJdOwoKICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGg7IH07CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSA9IGlzQWN0aXZlOwoKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwogICAga28udXRpbHMuZXh0ZW5kKGRlcGVuZGVudE9ic2VydmFibGUsIGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdwZWVrJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwogICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2dldERlcGVuZGVuY2llc0NvdW50JywgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCk7CgogICAgLy8gRXZhbHVhdGUsIHVubGVzcyBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQogICAgaWYgKG9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddICE9PSB0cnVlKQogICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgogICAgLy8gQnVpbGQgImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgYW5kICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWRDYWxsYmFjayIgb3B0aW9uIHZhbHVlcy4KICAgIC8vIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCiAgICAvLyAoTm90ZTogImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgb3B0aW9uIGJvdGggcHJvYWN0aXZlbHkgZGlzcG9zZXMgYXMgc29vbiBhcyB0aGUgbm9kZSBpcyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUoKSwKICAgIC8vIHBsdXMgYWRkcyBhICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgdGhhdCwgb24gZWFjaCBldmFsdWF0aW9uLCBkaXNwb3NlcyBpZiB0aGUgbm9kZSB3YXMgcmVtb3ZlZCBieSBzb21lIG90aGVyIG1lYW5zLikKICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgJiYgaXNBY3RpdmUoKSkgewogICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbiA9IGRpc3Bvc2VXaGVuOwogICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKfTsKCmtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cn07Cgp2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgprby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSA9IHt9Owprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKa28uZXhwb3J0U3ltYm9sKCdpc0NvbXB1dGVkJywga28uaXNDb21wdXRlZCk7CgooZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF4TmVzdGVkT2JzZXJ2YWJsZURlcHRoID0gMTA7IC8vIEVzY2FwZSB0aGUgKHVubGlrZWx5KSBwYXRoYWxvZ2ljYWwgY2FzZSB3aGVyZSBhbiBvYnNlcnZhYmxlJ3MgY3VycmVudCB2YWx1ZSBpcyBpdHNlbGYgKG9yIHNpbWlsYXIgcmVmZXJlbmNlIGN5Y2xlKQoKICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaGVuIGNhbGxpbmcga28udG9KUywgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IHRvIGNvbnZlcnQuIik7CgogICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAogICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKICAgICAgICAgICAgLy8gTG9vcCBiZWNhdXNlIGFuIG9ic2VydmFibGUncyB2YWx1ZSBtaWdodCBpbiB0dXJuIGJlIGFub3RoZXIgb2JzZXJ2YWJsZSB3cmFwcGVyCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCiAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwogICAgICAgICAgICByZXR1cm4gdmFsdWVUb01hcDsKICAgICAgICB9KTsKICAgIH07CgogICAga28udG9KU09OID0gZnVuY3Rpb24ocm9vdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwogICAgfTsKCiAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CiAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgogICAgICAgIHJvb3RPYmplY3QgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3QpOwogICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSk7CiAgICAgICAgaWYgKCFjYW5IYXZlUHJvcGVydGllcykKICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgogICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKICAgICAgICB2aXNpdGVkT2JqZWN0cy5zYXZlKHJvb3RPYmplY3QsIG91dHB1dFByb3BlcnRpZXMpOwoKICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseU1hcHBlZFZhbHVlID0gdmlzaXRlZE9iamVjdHMuZ2V0KHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogbWFwSnNPYmplY3RHcmFwaChwcm9wZXJ0eVZhbHVlLCBtYXBJbnB1dENhbGxiYWNrLCB2aXNpdGVkT2JqZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaXRQcm9wZXJ0aWVzT3JBcnJheUVudHJpZXMocm9vdE9iamVjdCwgdmlzaXRvckNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soaSk7CgogICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCiAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjaygndG9KU09OJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKICAgICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICB0aGlzLnNhdmUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtleXMsIGtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgICAgICB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgcmV0dXJuIChleGlzdGluZ0luZGV4ID49IDApID8gdmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7CmtvLmV4cG9ydFN5bWJvbCgndG9KU09OJywga28udG9KU09OKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCiAgICAvLyBOb3JtYWxseSwgU0VMRUNUIGVsZW1lbnRzIGFuZCB0aGVpciBPUFRJT05zIGNhbiBvbmx5IHRha2UgdmFsdWUgb2YgdHlwZSAnc3RyaW5nJyAoYmVjYXVzZSB0aGUgdmFsdWVzCiAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCiAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMgPSB7CiAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmllVmVyc2lvbiA8PSA3CiAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICA6IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tpXSkgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUpOwprby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCA9IC9cQGtvX3Rva2VuXyhcZCspXEAvZzsKICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSJdOwoKICAgIC8vIE1hdGNoZXMgc29tZXRoaW5nIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvLS1laXRoZXIgYW4gaXNvbGF0ZWQgaWRlbnRpZmllciBvciBzb21ldGhpbmcgZW5kaW5nIHdpdGggYSBwcm9wZXJ0eSBhY2Nlc3NvcgogICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCiAgICB2YXIgamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQgPSAvXig/OlskX2Etel1bJFx3XSp8KC4rKShcLlxzKlskX2Etel1bJFx3XSp8XFsuK1xdKSkkL2k7CgogICAgZnVuY3Rpb24gcmVzdG9yZVRva2VucyhzdHJpbmcsIHRva2VucykgewogICAgICAgIHZhciBwcmV2VmFsdWUgPSBudWxsOwogICAgICAgIHdoaWxlIChzdHJpbmcgIT0gcHJldlZhbHVlKSB7IC8vIEtlZXAgcmVzdG9yaW5nIHRva2VucyB1bnRpbCBpdCBubyBsb25nZXIgbWFrZXMgYSBkaWZmZXJlbmNlICh0aGV5IG1heSBiZSBuZXN0ZWQpCiAgICAgICAgICAgIHByZXZWYWx1ZSA9IHN0cmluZzsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVzdG9yZUNhcHR1cmVkVG9rZW5zUmVnZXgsIGZ1bmN0aW9uIChtYXRjaCwgdG9rZW5JbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1t0b2tlbkluZGV4XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewogICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGtvLnV0aWxzLnN0cmluZ1RyaW0oZXhwcmVzc2lvbikudG9Mb3dlckNhc2UoKSkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwogICAgICAgIHJldHVybiBtYXRjaCA9PT0gbnVsbCA/IGZhbHNlIDogbWF0Y2hbMV0gPyAoJ09iamVjdCgnICsgbWF0Y2hbMV0gKyAnKScgKyBtYXRjaFsyXSkgOiBleHByZXNzaW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGVuc3VyZVF1b3RlZChrZXkpIHsKICAgICAgICB2YXIgdHJpbW1lZEtleSA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5KTsKICAgICAgICBzd2l0Y2ggKHRyaW1tZWRLZXkubGVuZ3RoICYmIHRyaW1tZWRLZXkuY2hhckF0KDApKSB7CiAgICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIiciICsgdHJpbW1lZEtleSArICInIjsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IGZ1bmN0aW9uKG9iamVjdExpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgLy8gQSBmdWxsIHRva2VuaXNlcitsZXhlciB3b3VsZCBhZGQgdG9vIG11Y2ggd2VpZ2h0IHRvIHRoaXMgbGlicmFyeSwgc28gaGVyZSdzIGEgc2ltcGxlIHBhcnNlcgogICAgICAgICAgICAvLyB0aGF0IGlzIHN1ZmZpY2llbnQganVzdCB0byBzcGxpdCBhbiBvYmplY3QgbGl0ZXJhbCBzdHJpbmcgaW50byBhIHNldCBvZiB0b3AtbGV2ZWwga2V5LXZhbHVlIHBhaXJzCgogICAgICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPCAzKQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICBpZiAoc3RyLmNoYXJBdCgwKSA9PT0gInsiKS8vIElnbm9yZSBhbnkgYnJhY2VzIHN1cnJvdW5kaW5nIHRoZSB3aG9sZSBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygxLCBzdHIubGVuZ3RoIC0gMSk7CgogICAgICAgICAgICAvLyBQdWxsIG91dCBhbnkgc3RyaW5nIGxpdGVyYWxzIGFuZCByZWdleCBsaXRlcmFscwogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHZhciB0b2tlblN0YXJ0ID0gbnVsbCwgdG9rZW5FbmRDaGFyOwogICAgICAgICAgICBmb3IgKHZhciBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgc3RyLmxlbmd0aDsgcG9zaXRpb24rKykgewogICAgICAgICAgICAgICAgdmFyIGMgPSBzdHIuY2hhckF0KHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlblN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICInIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYyA9PSB0b2tlbkVuZENoYXIpICYmIChzdHIuY2hhckF0KHBvc2l0aW9uIC0gMSkgIT09ICJcXCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gc3RyLnN1YnN0cmluZyh0b2tlblN0YXJ0LCBwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSAiQGtvX3Rva2VuXyIgKyAodG9rZW5zLmxlbmd0aCAtIDEpICsgIkAiOwogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgdG9rZW5TdGFydCkgKyByZXBsYWNlbWVudCArIHN0ci5zdWJzdHJpbmcocG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTmV4dCBwdWxsIG91dCBiYWxhbmNlZCBwYXJlbiwgYnJhY2UsIGFuZCBicmFja2V0IGJsb2NrcwogICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRva2VuRGVwdGggPSAwLCB0b2tlblN0YXJ0Q2hhciA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIHBvc2l0aW9uID0gMDsgcG9zaXRpb24gPCBzdHIubGVuZ3RoOyBwb3NpdGlvbisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQXQocG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuU3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAieyI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIn0iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIigiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICIpIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJbIjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAiXSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGMgPT09IHRva2VuU3RhcnRDaGFyKQogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgrKzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IHRva2VuRW5kQ2hhcikgewogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5EZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBzdHIuc3Vic3RyaW5nKHRva2VuU3RhcnQsIHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gIkBrb190b2tlbl8iICsgKHRva2Vucy5sZW5ndGggLSAxKSArICJAIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCB0b2tlblN0YXJ0KSArIHJlcGxhY2VtZW50ICsgc3RyLnN1YnN0cmluZyhwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3cgd2UgY2FuIHNhZmVseSBzcGxpdCBvbiBjb21tYXMgdG8gZ2V0IHRoZSBrZXkvdmFsdWUgcGFpcnMKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIga2V5VmFsdWVQYWlycyA9IHN0ci5zcGxpdCgiLCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGtleVZhbHVlUGFpcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IGtleVZhbHVlUGFpcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgY29sb25Qb3MgPSBwYWlyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgIGlmICgoY29sb25Qb3MgPiAwKSAmJiAoY29sb25Qb3MgPCBwYWlyLmxlbmd0aCAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHBhaXIuc3Vic3RyaW5nKDAsIGNvbG9uUG9zKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYWlyLnN1YnN0cmluZyhjb2xvblBvcyArIDEpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgJ2tleSc6IHJlc3RvcmVUb2tlbnMoa2V5LCB0b2tlbnMpLCAndmFsdWUnOiByZXN0b3JlVG9rZW5zKHZhbHVlLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7ICd1bmtub3duJzogcmVzdG9yZVRva2VucyhwYWlyLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgcHJlUHJvY2Vzc0JpbmRpbmdzOiBmdW5jdGlvbiAob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5ID09PSAic3RyaW5nIgogICAgICAgICAgICAgICAgPyBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KQogICAgICAgICAgICAgICAgOiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5OwogICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5ncyA9IFtdLCBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdOwoKICAgICAgICAgICAgdmFyIGtleVZhbHVlRW50cnk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrZXlWYWx1ZUVudHJ5ID0ga2V5VmFsdWVBcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiLCIpOwoKICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZUVudHJ5WydrZXknXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdW90ZWRLZXkgPSBlbnN1cmVRdW90ZWQoa2V5VmFsdWVFbnRyeVsna2V5J10pLCB2YWwgPSBrZXlWYWx1ZUVudHJ5Wyd2YWx1ZSddOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiOiIpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUoa28udXRpbHMuc3RyaW5nVHJpbSh2YWwpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2goIiwgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5ICsgIiA6IGZ1bmN0aW9uKF9fa29fdmFsdWUpIHsgIiArIHZhbCArICIgPSBfX2tvX3ZhbHVlOyB9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goa2V5VmFsdWVFbnRyeVsndW5rbm93biddKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbWJpbmVkUmVzdWx0ID0gcmVzdWx0U3RyaW5ncy5qb2luKCIiKTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBhbGxQcm9wZXJ0eUFjY2Vzc29ycyA9IHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgY29tYmluZWRSZXN1bHQgPSBjb21iaW5lZFJlc3VsdCArICIsICdfa29fcHJvcGVydHlfd3JpdGVycycgOiB7ICIgKyBhbGxQcm9wZXJ0eUFjY2Vzc29ycyArICIgfSAiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tYmluZWRSZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5VmFsdWVBcnJheVtpXVsna2V5J10pID09IGtleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKICAgICAgICAvLyBwcm9wZXJ0eTogICAgICAgICAgICBJZiB0aGUgcHJvcGVydHkgYmVpbmcgdXBkYXRlZCBpcyAob3IgbWlnaHQgYmUpIGFuIG9ic2VydmFibGUsIHBhc3MgaXQgaGVyZQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQogICAgICAgIC8vIGFsbEJpbmRpbmdzQWNjZXNzb3I6IEFsbCBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICBUaGlzIHdpbGwgYmUgc2VhcmNoZWQgZm9yIGEgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyBwcm9wZXJ0eSBpbiBjYXNlIHlvdSdyZSB3cml0aW5nIHRvIGEgbm9uLW9ic2VydmFibGUKICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICAgIC8vIGNoZWNrSWZEaWZmZXJlbnQ6ICAgIElmIHRydWUsIGFuZCBpZiB0aGUgcHJvcGVydHkgYmVpbmcgd3JpdHRlbiBpcyBhIHdyaXRhYmxlIG9ic2VydmFibGUsIHRoZSB2YWx1ZSB3aWxsIG9ubHkgYmUgd3JpdHRlbiBpZgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIGtleSwgdmFsdWUsIGNoZWNrSWZEaWZmZXJlbnQpIHsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWydfa29fcHJvcGVydHlfd3JpdGVycyddOwogICAgICAgICAgICAgICAgaWYgKHByb3BXcml0ZXJzICYmIHByb3BXcml0ZXJzW2tleV0pCiAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOwoKLy8gRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGRlZmluZSB0aGUgZm9sbG93aW5nIGFsaWFzZXMuIChQcmV2aW91c2x5LCB0aGVzZSBmdW5jdGlvbiBuYW1lcyB3ZXJlIG1pc2xlYWRpbmcgYmVjYXVzZQovLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOyhmdW5jdGlvbigpIHsKICAgIC8vICJWaXJ0dWFsIGVsZW1lbnRzIiBpcyBhbiBhYnN0cmFjdGlvbiBvbiB0b3Agb2YgdGhlIHVzdWFsIERPTSBBUEkgd2hpY2ggdW5kZXJzdGFuZHMgdGhlIG5vdGlvbiB0aGF0IGNvbW1lbnQgbm9kZXMKICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCiAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQogICAgLy8gb2YgdGhhdCB2aXJ0dWFsIGhpZXJhcmNoeQogICAgLy8KICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHNjYXR0ZXIgc3BlY2lhbCBjYXNlcyBhbGwgb3ZlciB0aGUgYmluZGluZyBhbmQgdGVtcGxhdGluZyBjb2RlLgoKICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCiAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KICAgIC8vIFNvLCB1c2Ugbm9kZS50ZXh0IHdoZXJlIGF2YWlsYWJsZSwgYW5kIG5vZGUubm9kZVZhbHVlIGVsc2V3aGVyZQogICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCiAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyokLzsKICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgogICAgZnVuY3Rpb24gaXNTdGFydENvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFbmRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goZW5kQ29tbWVudFJlZ2V4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CiAgICAgICAgdmFyIGRlcHRoID0gMTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgfQogICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIGNsb3NpbmcgY29tbWVudCB0YWcgdG8gbWF0Y2g6ICIgKyBzdGFydENvbW1lbnQubm9kZVZhbHVlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaGluZ0VuZENvbW1lbnQoc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChhbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKG5vZGUpIHsKICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgogICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CiAgICAgICAgdmFyIGNoaWxkTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCwgY2FwdHVyZVJlbWFpbmluZyA9IG51bGw7CiAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZVJlbWFpbmluZykgICAgICAgICAgICAgICAgICAgLy8gV2UgYWxyZWFkeSBoaXQgYW4gdW5iYWxhbmNlZCBub2RlIGFuZCBhcmUgbm93IGp1c3Qgc2Nvb3BpbmcgdXAgYWxsIHN1YnNlcXVlbnQgbm9kZXMKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdFbmRDb21tZW50ID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KGNoaWxkTm9kZSwgLyogYWxsb3dVbmJhbGFuY2VkOiAqLyB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgICAgIC8vIEl0J3MgdW5iYWxhbmNlZCAoaWYgaXQgd2Fzbid0LCB3ZSdkIGhhdmUgc2tpcHBlZCBvdmVyIGl0IGFscmVhZHkpLCBzbyBzdGFydCBjYXB0dXJpbmcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CiAgICB9CgogICAga28udmlydHVhbEVsZW1lbnRzID0gewogICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgogICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzU3RhcnRDb21tZW50KG5vZGUpID8gZ2V0VmlydHVhbENoaWxkcmVuKG5vZGUpIDogbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsQ2hpbGRyZW4gPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2Rlcyhub2RlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGVuZENvbW1lbnROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkTm9kZXNbaV0sIGVuZENvbW1lbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb1ByZXBlbmQpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9QcmVwZW5kLCBjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAvLyBJbnNlcnQgYWZ0ZXIgaW5zZXJ0aW9uIHBvaW50CiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDaGlsZHJlbiBvZiBzdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9LAoKICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSwKCiAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSBpc1N0YXJ0Q29tbWVudChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZTogZnVuY3Rpb24oZWxlbWVudFZlcmlmaWVkKSB7CiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CiAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwogICAgICAgICAgICAvLyB0aGF0IGFyZSBkaXJlY3QgZGVzY2VuZGFudHMgb2YgPHVsPiBpbnRvIHRoZSBwcmVjZWRpbmcgPGxpPikKICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNjYW4gaW1tZWRpYXRlIGNoaWxkcmVuIHRvIHNlZSBpZiB0aGV5IGNvbnRhaW4gdW5iYWxhbmNlZCBjb21tZW50IHRhZ3MuIElmIHRoZXkgZG8sIHRob3NlIGNvbW1lbnQgdGFncwogICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5iYWxhbmNlZFRhZ3MgPSBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVRvSW5zZXJ0QmVmb3JlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWZXJpZmllZC5pbnNlcnRCZWZvcmUodW5iYWxhbmNlZFRhZ3NbaV0sIG5vZGVUb0luc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzJywga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncyk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwovL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcicsIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcik7Ci8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4nLCBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKTsKKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKICAgIGtvLmJpbmRpbmdQcm92aWRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CiAgICB9OwoKICAgIGtvLnV0aWxzLmV4dGVuZChrby5iaW5kaW5nUHJvdmlkZXIucHJvdG90eXBlLCB7CiAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGw7ICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4ga28udmlydHVhbEVsZW1lbnRzLnZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlKG5vZGUpICE9IG51bGw7IC8vIENvbW1lbnQgbm9kZQogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUpIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCiAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgogICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlKTsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5NZXNzYWdlOiAiICsgZXggKyAiO1xuQmluZGluZ3MgdmFsdWU6ICIgKyBiaW5kaW5nc1N0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgogICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgY2FjaGUpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZzsKICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCiAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nKSB7CiAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKICAgICAgICAvLyBGb3IgZWFjaCBzY29wZSB2YXJpYWJsZSwgYWRkIGFuIGV4dHJhIGxldmVsIG9mICJ3aXRoIiBuZXN0aW5nCiAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CiAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcpLAogICAgICAgICAgICBmdW5jdGlvbkJvZHkgPSAid2l0aCgkY29udGV4dCl7d2l0aCgkZGF0YXx8e30pe3JldHVybnsiICsgcmV3cml0dGVuQmluZGluZ3MgKyAifX19IjsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CihmdW5jdGlvbiAoKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMgPSB7fTsKCiAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtLCBwYXJlbnRCaW5kaW5nQ29udGV4dCwgZGF0YUl0ZW1BbGlhcykgewogICAgICAgIGlmIChwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBrby51dGlscy5leHRlbmQodGhpcywgcGFyZW50QmluZGluZ0NvbnRleHQpOyAvLyBJbmhlcml0ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMKICAgICAgICAgICAgdGhpc1snJHBhcmVudENvbnRleHQnXSA9IHBhcmVudEJpbmRpbmdDb250ZXh0OwogICAgICAgICAgICB0aGlzWyckcGFyZW50J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnJGRhdGEnXTsKICAgICAgICAgICAgdGhpc1snJHBhcmVudHMnXSA9IChwYXJlbnRCaW5kaW5nQ29udGV4dFsnJHBhcmVudHMnXSB8fCBbXSkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10udW5zaGlmdCh0aGlzWyckcGFyZW50J10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSBbXTsKICAgICAgICAgICAgdGhpc1snJHJvb3QnXSA9IGRhdGFJdGVtOwogICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDkwCiAgICAgICAgICAgIHRoaXNbJ2tvJ10gPSBrbzsKICAgICAgICB9CiAgICAgICAgdGhpc1snJGRhdGEnXSA9IGRhdGFJdGVtOwogICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQogICAgICAgICAgICB0aGlzW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CiAgICB9CiAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2NyZWF0ZUNoaWxkQ29udGV4dCddID0gZnVuY3Rpb24gKGRhdGFJdGVtLCBkYXRhSXRlbUFsaWFzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dChkYXRhSXRlbSwgdGhpcywgZGF0YUl0ZW1BbGlhcyk7CiAgICB9OwogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydleHRlbmQnXSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgY2xvbmUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLmJpbmRpbmdDb250ZXh0KCksIHRoaXMpOwogICAgICAgIHJldHVybiBrby51dGlscy5leHRlbmQoY2xvbmUsIHByb3BlcnRpZXMpOwogICAgfTsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdOYW1lKSB7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgIGlmICghdmFsaWRhdG9yKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBiaW5kaW5nICciICsgYmluZGluZ05hbWUgKyAiJyBjYW5ub3QgYmUgdXNlZCB3aXRoIHZpcnR1YWwgZWxlbWVudHMiKQogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CiAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgogICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCiAgICAgICAgLy8gUGVyZiBvcHRpbWlzYXRpb246IEFwcGx5IGJpbmRpbmdzIG9ubHkgaWYuLi4KICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCiAgICAgICAgLy8gKDIpIEl0IG1pZ2h0IGhhdmUgYmluZGluZ3MgKGUuZy4sIGl0IGhhcyBhIGRhdGEtYmluZCBhdHRyaWJ1dGUsIG9yIGl0J3MgYSBtYXJrZXIgZm9yIGEgY29udGFpbmVybGVzcyB0ZW1wbGF0ZSkKICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGVWZXJpZmllZCk7CgogICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQogICAgICAgIGlmIChzaG91bGRBcHBseUJpbmRpbmdzKQogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpLnNob3VsZEJpbmREZXNjZW5kYW50czsKCiAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cykgewogICAgICAgICAgICAvLyBXZSdyZSByZWN1cnNpbmcgYXV0b21hdGljYWxseSBpbnRvIChyZWFsIG9yIHZpcnR1YWwpIGNoaWxkIG5vZGVzIHdpdGhvdXQgY2hhbmdpbmcgYmluZGluZyBjb250ZXh0cy4gU28sCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICp2aXJ0dWFsKiBlbGVtZW50LCB3ZSBjYW4ndCBiZSBzdXJlLiBFdmFsdWF0aW5nIC5wYXJlbnROb2RlIG9uIHRob3NlIGNoaWxkcmVuIG1heQogICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwgKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gTmVlZCB0byBiZSBzdXJlIHRoYXQgaW5pdHMgYXJlIG9ubHkgcnVuIG9uY2UsIGFuZCB1cGRhdGVzIG5ldmVyIHJ1biB1bnRpbCBhbGwgdGhlIGluaXRzIGhhdmUgYmVlbiBydW4KICAgICAgICB2YXIgaW5pdFBoYXNlID0gMDsgLy8gMCA9IGJlZm9yZSBhbGwgaW5pdHMsIDEgPSBkdXJpbmcgaW5pdHMsIDIgPSBhZnRlciBhbGwgaW5pdHMKCiAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBkZXBlbmRlbnRPYnNlcnZhYmxlIGlzIGV2YWx1YXRlZCAoYWZ0ZXIgZGF0YSBjaGFuZ2VzKSwKICAgICAgICAvLyB0aGUgYmluZGluZyBhdHRyaWJ1dGUgaXMgcmVwYXJzZWQgc28gdGhhdCBpdCBjYW4gcGljayBvdXQgdGhlIGNvcnJlY3QKICAgICAgICAvLyBtb2RlbCBwcm9wZXJ0aWVzIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjaGFuZ2VkIGRhdGEuCiAgICAgICAgLy8gRE9NIGV2ZW50IGNhbGxiYWNrcyBuZWVkIHRvIGJlIGFibGUgdG8gYWNjZXNzIHRoaXMgY2hhbmdlZCBkYXRhLAogICAgICAgIC8vIHNvIHdlIG5lZWQgYSBzaW5nbGUgcGFyc2VkQmluZGluZ3MgdmFyaWFibGUgKHNoYXJlZCBieSBhbGwgY2FsbGJhY2tzCiAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgbm9kZSdzIGJpbmRpbmdzKSB0aGF0IGFsbCB0aGUgY2xvc3VyZXMgY2FuIGFjY2Vzcy4KICAgICAgICB2YXIgcGFyc2VkQmluZGluZ3M7CiAgICAgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyc2VkQmluZGluZ3NbYmluZGluZ0tleV0gfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZWRCaW5kaW5nc0FjY2Vzc29yKCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VkQmluZGluZ3M7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CiAgICAgICAga28uZGVwZW5kZW50T2JzZXJ2YWJsZSgKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBub25udWxsIGJpbmRpbmcgY29udGV4dCB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dEluc3RhbmNlID0gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCAmJiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KQogICAgICAgICAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCkpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0SW5zdGFuY2VbJyRkYXRhJ107CgogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSBpZiBpdCdzIGRlZmluaXRlbHkgdGhlIHNhbWUgYXMgb24gbm9kZS5wYXJlbnROb2RlLCBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgLy8gVXNlIGV2YWx1YXRlZEJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCiAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdGVkQmluZGluZ3MgPSAodHlwZW9mIGJpbmRpbmdzID09ICJmdW5jdGlvbiIpID8gYmluZGluZ3MoYmluZGluZ0NvbnRleHRJbnN0YW5jZSwgbm9kZSkgOiBiaW5kaW5nczsKICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gZXZhbHVhdGVkQmluZGluZ3MgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydnZXRCaW5kaW5ncyddKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHJ1biBhbGwgdGhlIGluaXRzLCBzbyBiaW5kaW5ncyBjYW4gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbiBvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbml0UGhhc2UgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1siaW5pdCJdID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdbImluaXQiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBydW4gYWxsIHRoZSB1cGRhdGVzLCB3aGljaCBtaWdodCB0cmlnZ2VyIGNoYW5nZXMgZXZlbiBvbiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIChpbml0UGhhc2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYmluZGluZ0tleSBpbiBwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1sidXBkYXRlIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nWyJ1cGRhdGUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIDogbm9kZSB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2hvdWxkQmluZERlc2NlbmRhbnRzOiBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9PT0gdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH07CgogICAgdmFyIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSA9ICJfX2tvX2JpbmRpbmdDb250ZXh0X18iOwogICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5KTsKICAgIH0KCiAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgLy8gSWYgaXQncyBhbiBlbGVtZW50LCB3b3JrYXJvdW5kIElFIDw9IDggSFRNTCBwYXJzaW5nIHdlaXJkbmVzcwogICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CiAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsLCB0cnVlKTsKICAgIH07CgogICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMgPSBmdW5jdGlvbih2aWV3TW9kZWwsIHJvb3ROb2RlKSB7CiAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKHZpZXdNb2RlbCwgcm9vdE5vZGUsIHRydWUpOwogICAgfTsKCiAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbCwgcm9vdE5vZGUpIHsKICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImtvLmFwcGx5QmluZGluZ3M6IGZpcnN0IHBhcmFtZXRlciBzaG91bGQgYmUgeW91ciB2aWV3IG1vZGVsOyBzZWNvbmQgcGFyYW1ldGVyIHNob3VsZCBiZSBhIERPTSBub2RlIik7CiAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIHJvb3ROb2RlLCB0cnVlKTsKICAgIH07CgogICAgLy8gUmV0cmlldmluZyBiaW5kaW5nIGNvbnRleHQgZnJvbSBhcmJpdHJhcnkgbm9kZXMKICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlKTsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CiAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKICAgICAgICByZXR1cm4gY29udGV4dCA/IGNvbnRleHRbJyRkYXRhJ10gOiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5ncycsIGtvLmFwcGx5QmluZGluZ3MpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ3NUb05vZGUpOwogICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CiAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKfSkoKTsKdmFyIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwID0geyAnY2xhc3MnOiAnY2xhc3NOYW1lJywgJ2Zvcic6ICdodG1sRm9yJyB9Owprby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwogICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2F0dHJOYW1lXSk7CgogICAgICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CiAgICAgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCiAgICAgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgogICAgICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCiAgICAgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwogICAgICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQogICAgICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCiAgICAgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KICAgICAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUgPSBlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAoZWxlbWVudC5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gImNoZWNrZWQiIGJpbmRpbmcgb25seSByZXNwb25kcyB0byBjaGVja2JveGVzIGFuZCBzZWxlY3RlZCByYWRpbyBidXR0b25zCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB1bndyYXBwZWRWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIpICYmICh1bndyYXBwZWRWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgLy8gRm9yIGNoZWNrYm94ZXMgYm91bmQgdG8gYW4gYXJyYXksIHdlIGFkZC9yZW1vdmUgdGhlIGNoZWNrYm94IHZhbHVlIHRvIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIC8vIFRoaXMgd29ya3MgZm9yIGJvdGggb2JzZXJ2YWJsZSBhbmQgbm9uLW9ic2VydmFibGUgYXJyYXlzCiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHVud3JhcHBlZFZhbHVlLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmNoZWNrZWQgJiYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUucHVzaChlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCghZWxlbWVudC5jaGVja2VkKSAmJiAoZXhpc3RpbmdFbnRyeUluZGV4ID49IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUuc3BsaWNlKGV4aXN0aW5nRW50cnlJbmRleCwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdjaGVja2VkJywgdmFsdWVUb1dyaXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlSGFuZGxlcik7CgogICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQogICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJyYWRpbyIpICYmICFlbGVtZW50Lm5hbWUpCiAgICAgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddWydpbml0J10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFuIGFycmF5LCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIGl0cyB2YWx1ZSBiZWluZyBwcmVzZW50IGluIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih2YWx1ZSwgZWxlbWVudC52YWx1ZSkgPj0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYm91bmQgdG8gYW55dGhpbmcgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIHRoZSBjaGVja2JveCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgdGhlIHZhbHVlIGJlaW5nIHRydWVpc2gKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgewogICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSAoZWxlbWVudC52YWx1ZSA9PSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQp9Owp2YXIgY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXkgPSAnX19rb19fY3NzVmFsdWUnOwprby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVtjbGFzc05hbWVdKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSB8fCAnJyk7IC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCB0cnkgdG8gc3RvcmUgb3Igc2V0IGEgbm9uLXN0cmluZyB2YWx1ZQogICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIHZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmICghZWxlbWVudC5kaXNhYmxlZCkpCiAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddWyd1cGRhdGUnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfSk7CiAgICB9Cn07Ci8vIEZvciBjZXJ0YWluIGNvbW1vbiBldmVudHMgKGN1cnJlbnRseSBqdXN0ICdjbGljaycpLCBhbGxvdyBhIHNpbXBsaWZpZWQgZGF0YS1iaW5kaW5nIHN5bnRheAovLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CmZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tldmVudE5hbWVdID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50TmFtZV0gPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWydldmVudCddWydpbml0J10uY2FsbCh0aGlzLCBlbGVtZW50LCBuZXdWYWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpOwogICAgICAgIH0KICAgIH0KfQoKa28uYmluZGluZ0hhbmRsZXJzWydldmVudCddID0gewogICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKICAgICAgICBmb3IodmFyIGV2ZW50TmFtZU91dHNpZGVDbG9zdXJlIGluIGV2ZW50c1RvSGFuZGxlKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZTsgLy8gU2VwYXJhdGUgdmFyaWFibGUgdG8gYmUgY2FwdHVyZWQgYnkgZXZlbnQgaGFuZGxlciBjbG9zdXJlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5nc1tldmVudE5hbWUgKyAnQnViYmxlJ10gIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9Cn07Ci8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKLy8gImZvcmVhY2g6IHsgZGF0YTogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAogICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKICAgICAgICAgICAgLy8gSWYgdW53cmFwcGVkVmFsdWUgaXMgdGhlIGFycmF5LCBwYXNzIGluIHRoZSB3cmFwcGVkIHZhbHVlIG9uIGl0cyBvd24KICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwogICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQogICAgICAgICAgICBpZiAoKCF1bndyYXBwZWRWYWx1ZSkgfHwgdHlwZW9mIHVud3JhcHBlZFZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikKICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCiAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCiAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnYXMnOiB1bndyYXBwZWRWYWx1ZVsnYXMnXSwKICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAogICAgICAgICAgICAgICAgJ2JlZm9yZVJlbW92ZSc6IHVud3JhcHBlZFZhbHVlWydiZWZvcmVSZW1vdmUnXSwKICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAogICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAogICAgICAgICAgICAgICAgJ2FmdGVyTW92ZSc6IHVud3JhcHBlZFZhbHVlWydhZnRlck1vdmUnXSwKICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2ZvcmVhY2gnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwp2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UgPSBmdW5jdGlvbihpc0ZvY3VzZWQpIHsKICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KICAgICAgICAgICAgLy8gSG93ZXZlciwgbm90IGFsbCBLTy10YXJnZXRlZCBicm93c2VycyAoRmlyZWZveCAyKSBzdXBwb3J0IGFjdGl2ZUVsZW1lbnQuIEZvciB0aG9zZSBicm93c2VycywKICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwogICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KICAgICAgICAgICAgLy8gRGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zNTIKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAoImFjdGl2ZUVsZW1lbnQiIGluIG93bmVyRG9jKSB7CiAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAob3duZXJEb2MuYWN0aXZlRWxlbWVudCA9PT0gZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3NBY2Nlc3NvciwgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3Vzb3V0IiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7IC8vIEZvciBJRQogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldKSB7CiAgICAgICAgICAgIHZhbHVlID8gZWxlbWVudC5mb2N1cygpIDogZWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQogICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKICAgICAgICBrby51dGlscy5zZXRIdG1sKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CiAgICB9Cn07CnZhciB3aXRoSWZEb21EYXRhS2V5ID0gJ19fa29fd2l0aElmQmluZGluZ0RhdGEnOwovLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCmZ1bmN0aW9uIG1ha2VXaXRoSWZCaW5kaW5nKGJpbmRpbmdLZXksIGlzV2l0aCwgaXNOb3QsIG1ha2VDb250ZXh0Q2FsbGJhY2spIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgd2l0aElmRG9tRGF0YUtleSwge30pOwogICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICAgICAgfSwKICAgICAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgd2l0aElmRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHdpdGhJZkRvbURhdGFLZXkpLAogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAogICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQogICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICF3aXRoSWZEYXRhLnNhdmVkTm9kZXMsCiAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gd2l0aElmRGF0YS5kaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCiAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2l0aElmRGF0YS5zYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIGtvLnV0aWxzLmNsb25lTm9kZXMod2l0aElmRGF0YS5zYXZlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdpdGhJZkRhdGEuZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbYmluZGluZ0tleV0gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwp9CgovLyBDb25zdHJ1Y3QgdGhlIGFjdHVhbCBiaW5kaW5nIGhhbmRsZXJzCm1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwptYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwptYWtlV2l0aElmQmluZGluZygnd2l0aCcsIHRydWUgLyogaXNXaXRoICovLCBmYWxzZSAvKiBpc05vdCAqLywKICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CiAgICB9Cik7CmZ1bmN0aW9uIGVuc3VyZURyb3Bkb3duU2VsZWN0aW9uSXNDb25zaXN0ZW50V2l0aE1vZGVsVmFsdWUoZWxlbWVudCwgbW9kZWxWYWx1ZSwgcHJlZmVyTW9kZWxWYWx1ZSkgewogICAgaWYgKHByZWZlck1vZGVsVmFsdWUpIHsKICAgICAgICBpZiAobW9kZWxWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpCiAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBtb2RlbFZhbHVlKTsKICAgIH0KCiAgICAvLyBObyBtYXR0ZXIgd2hpY2ggZGlyZWN0aW9uIHdlJ3JlIHN5bmNpbmcgaW4sIHdlIHdhbnQgdGhlIGVuZCByZXN1bHQgdG8gYmUgZXF1YWxpdHkgYmV0d2VlbiBkcm9wZG93biB2YWx1ZSBhbmQgbW9kZWwgdmFsdWUuCiAgICAvLyBJZiB0aGV5IGFyZW4ndCBlcXVhbCwgZWl0aGVyIHdlIHByZWZlciB0aGUgZHJvcGRvd24gdmFsdWUsIG9yIHRoZSBtb2RlbCB2YWx1ZSBjb3VsZG4ndCBiZSByZXByZXNlbnRlZCwgc28gZWl0aGVyIHdheSwKICAgIC8vIGNoYW5nZSB0aGUgbW9kZWwgdmFsdWUgdG8gbWF0Y2ggdGhlIGRyb3Bkb3duLgogICAgaWYgKG1vZGVsVmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKQogICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJzZWxlY3QiKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgPSBlbGVtZW50Lmxlbmd0aCA9PSAwOwogICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0ga28udXRpbHMuYXJyYXlNYXAoa28udXRpbHMuYXJyYXlGaWx0ZXIoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lICYmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKSAmJiBub2RlLnNlbGVjdGVkOwogICAgICAgIH0pLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudDsKICAgICAgICB9KTsKICAgICAgICB2YXIgcHJldmlvdXNTY3JvbGxUb3AgPSBlbGVtZW50LnNjcm9sbFRvcDsKCiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyA8b3B0aW9uPnMuCiAgICAgICAgLy8gTmVlZCB0byB1c2UgLnJlbW92ZSgpIHJhdGhlciB0aGFuIC5yZW1vdmVDaGlsZCgpIGZvciA8b3B0aW9uPnMgb3RoZXJ3aXNlIElFIGJlaGF2ZXMgb2RkbHkgKGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTM0KQogICAgICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKGVsZW1lbnQub3B0aW9uc1swXSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKSwKICAgICAgICAgICAgICAgIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5nc1snb3B0aW9uc0luY2x1ZGVEZXN0cm95ZWQnXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoICE9ICJudW1iZXIiKQogICAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ29wdGlvbnNDYXB0aW9uJ10pIHsKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwob3B0aW9uLCBhbGxCaW5kaW5nc1snb3B0aW9uc0NhcHRpb24nXSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChvcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgLy8gU2tpcCBkZXN0cm95ZWQgaXRlbXMKICAgICAgICAgICAgICAgIHZhciBhcnJheUVudHJ5ID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSAmJiBhcnJheUVudHJ5WydfZGVzdHJveSddICYmICFpbmNsdWRlRGVzdHJveWVkKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZVR5cGUgPT0gImZ1bmN0aW9uIikgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbjsgcnVuIGl0IGFnYWluc3QgdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtwcmVkaWNhdGVdOwogICAgICAgICAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVmFsdWUgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXSwgYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgc29tZSB0ZXh0IHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVGV4dCddLCBvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChvcHRpb24sIG9wdGlvblRleHQpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KICAgICAgICAgICAgdmFyIG5ld09wdGlvbnMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKTsKICAgICAgICAgICAgdmFyIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdPcHRpb25zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zW2ldKSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zW2ldLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb3VudFNlbGVjdGlvbnNSZXRhaW5lZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSAmJiAoJ3ZhbHVlJyBpbiBhbGxCaW5kaW5ncykpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW5jeSBiZXR3ZWVuIG1vZGVsIHZhbHVlIGFuZCBzZWxlY3RlZCBvcHRpb24uCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gaXMgYmVpbmcgcG9wdWxhdGVkIGZvciB0aGUgZmlyc3QgdGltZSBoZXJlIChvciB3YXMgb3RoZXJ3aXNlIHByZXZpb3VzbHkgZW1wdHkpLAogICAgICAgICAgICAgICAgLy8gdGhlIGRyb3Bkb3duIHNlbGVjdGlvbiBzdGF0ZSBpcyBtZWFuaW5nbGVzcywgc28gd2UgcHJlc2VydmUgdGhlIG1vZGVsIHZhbHVlLgogICAgICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShhbGxCaW5kaW5nc1sndmFsdWUnXSksIC8qIHByZWZlck1vZGVsVmFsdWUgKi8gdHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSBidWcKICAgICAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSAnX19rby5vcHRpb25WYWx1ZURvbURhdGFfXyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAndmFsdWUnLCB2YWx1ZVRvV3JpdGUpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKG5ld1ZhbHVlICYmIHR5cGVvZiBuZXdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobm9kZSwgaXNTZWxlY3RlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW3N0eWxlTmFtZV0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZSB8fCAiIjsgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snc3VibWl0J10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAic3VibWl0IiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdHJ5IHsgaGFuZGxlclJldHVyblZhbHVlID0gdmFsdWUuY2FsbCh2aWV3TW9kZWwsIGVsZW1lbnQpOyB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwogICAgfQp9Owprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZXh0J10gPSB0cnVlOwprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gImtvX3VuaXF1ZV8iICsgKCsra28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4KTsKICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwprby5iaW5kaW5nSGFuZGxlcnNbJ3ZhbHVlJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCiAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwogICAgICAgIHZhciByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWyJ2YWx1ZVVwZGF0ZSJdOwogICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgIGlmIChyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZXZlbnRzVG9DYXRjaCwgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCk7CiAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlVXBkYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgogICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAogICAgICAgIHZhciBpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgPSBrby51dGlscy5pZVZlcnNpb24gJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiBlbGVtZW50LnR5cGUgPT0gInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwogICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJwcm9wZXJ0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSB0cnVlIH0pOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVVcGRhdGVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKICAgICAgICAgICAgLy8gVGhpcyBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCB0byBjYXRjaCAia2V5ZG93biIgZXZlbnRzIGFmdGVyIHRoZSBicm93c2VyIGhhcyB1cGRhdGVkIHRoZSBjb250cm9sCiAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwogICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nU3RhcnRzV2l0aChldmVudE5hbWUsICJhZnRlciIpKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7IHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKSB9OwogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWVJc1NlbGVjdE9wdGlvbiA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCI7CiAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICB2YXIgdmFsdWVIYXNDaGFuZ2VkID0gKG5ld1ZhbHVlICE9IGVsZW1lbnRWYWx1ZSk7CgogICAgICAgIC8vIEphdmFTY3JpcHQncyAwID09ICIiIGJlaGF2aW91cyBpcyB1bmZvcnR1bmF0ZSBoZXJlIGFzIGl0IHByZXZlbnRzIHdyaXRpbmcgMCB0byBhbiBlbXB0eSB0ZXh0IGJveCAobG9vc2UgZXF1YWxpdHkgc3VnZ2VzdHMgdGhlIHZhbHVlcyBhcmUgdGhlIHNhbWUpLgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZG8gYSBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbiBhcyB0aGF0IGlzIG1vcmUgY29uZnVzaW5nIGZvciBkZXZlbG9wZXJzIGluIGNlcnRhaW4gY2FzZXMsIHNvIHdlIHNwZWNpZmljYWxseSBzcGVjaWFsIGNhc2UgMCAhPSAiIiBoZXJlLgogICAgICAgIGlmICgobmV3VmFsdWUgPT09IDApICYmIChlbGVtZW50VmFsdWUgIT09IDApICYmIChlbGVtZW50VmFsdWUgIT09ICIwIikpCiAgICAgICAgICAgIHZhbHVlSGFzQ2hhbmdlZCA9IHRydWU7CgogICAgICAgIGlmICh2YWx1ZUhhc0NoYW5nZWQpIHsKICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7IH07CiAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFNiBidWc6IEl0IHdvbid0IHJlbGlhYmx5IGFwcGx5IHZhbHVlcyB0byBTRUxFQ1Qgbm9kZXMgZHVyaW5nIHRoZSBzYW1lIGV4ZWN1dGlvbiB0aHJlYWQKICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCiAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgogICAgICAgICAgICB2YXIgYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkgPSB2YWx1ZUlzU2VsZWN0T3B0aW9uOwogICAgICAgICAgICBpZiAoYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFwcGx5VmFsdWVBY3Rpb24sIDApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgeW91IHRyeSB0byBzZXQgYSBtb2RlbCB2YWx1ZSB0aGF0IGNhbid0IGJlIHJlcHJlc2VudGVkIGluIGFuIGFscmVhZHktcG9wdWxhdGVkIGRyb3Bkb3duLCByZWplY3QgdGhhdCBjaGFuZ2UsCiAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KICAgICAgICBpZiAodmFsdWVJc1NlbGVjdE9wdGlvbiAmJiAoZWxlbWVudC5sZW5ndGggPiAwKSkKICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyBmYWxzZSk7CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwogICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KfTsKLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9Cm1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dCgnY2xpY2snKTsKLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCi8vCi8vIFsxXSBJbmhlcml0IGZyb20gdGhpcyBjbGFzcyAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQovLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKLy8KLy8gICAgICAgIGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQovLyAgICAgICAgICAgIC8vICAgLSB5b3UgbWlnaHQgYWxzbyB3YW50IHRvIG1ha2UgYmluZGluZ0NvbnRleHQuJHBhcmVudCwgYmluZGluZ0NvbnRleHQuJHBhcmVudHMsCi8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwovLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCi8vICAgICAgICAgICAgLy8KLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwovLyAgICAgICAgfQovLwovLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6Ci8vCi8vICAgICAgICBmdW5jdGlvbiAoc2NyaXB0KSB7Ci8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCi8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKLy8gICAgICAgIH0KLy8KLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCi8vICAgICBJZiB5b3UgZG9uJ3Qgd2FudCB0byBhbGxvdyB0aGF0LCB5b3UgY2FuIHNldCB0aGUgcHJvcGVydHkgJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnIHRvIGZhbHNlIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCi8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCmtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXSA9IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ21ha2VUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgdGVtcGxhdGVEb2N1bWVudCA9IHRlbXBsYXRlRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKICAgICAgICBpZiAoIWVsZW0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgd2l0aCBJRCAiICsgdGVtcGxhdGUpOwogICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CiAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKICAgICAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGUKICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICB9IGVsc2UKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdGVtcGxhdGUgdHlwZTogIiArIHRlbXBsYXRlKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCiAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmV3cml0ZVRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHJld3JpdGVyQ2FsbGJhY2ssIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CiAgICB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKHJld3JpdHRlbik7CiAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwp9OwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZUVuZ2luZScsIGtvLnRlbXBsYXRlRW5naW5lKTsKCmtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPFthLXpdK1xkKihccysoPyFkYXRhLWJpbmQ9KVthLXowLTlcLV0rKD0oXCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kPShbIiddKShbXHNcU10qPylcNS9naTsKICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGtleVZhbHVlQXJyYXkpIHsKICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0ga2V5VmFsdWVBcnJheVtpXVsna2V5J107CiAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWxpZGF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocG9zc2libGVFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCB0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgIHZhciBkYXRhQmluZEtleVZhbHVlQXJyYXkgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CiAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXkpOwoKICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCiAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwogICAgICAgIC8vIGV4dHJhIGluZGlyZWN0aW9uLgogICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CiAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSkiOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10oYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQpICsgdGFnVG9SZXRhaW47CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBlbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnRlbXBsYXRlUmV3cml0aW5nLm1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4KGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIG1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4OiBmdW5jdGlvbiAoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzZdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UobWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXgsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGRvbU5vZGUubmV4dFNpYmxpbmcsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfSkoKTsKCgovLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwooZnVuY3Rpb24oKSB7CiAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwogICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCiAgICAvLwogICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgogICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CiAgICAvLyAgMi4ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c0VsZW1lbnQgLSB1c2VzIGtvLnV0aWxzLmRvbURhdGEgdG8gcmVhZC93cml0ZSB0ZXh0ICphc3NvY2lhdGVkKiB3aXRoIHRoZSBET00gZWxlbWVudCwgYnV0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCiAgICAvLyBZb3UgY2FuIGltcGxlbWVudCB5b3VyIG93biB0ZW1wbGF0ZSBzb3VyY2UgaWYgeW91IHdhbnQgdG8gZmV0Y2gvc3RvcmUgdGVtcGxhdGVzIHNvbWV3aGVyZSBvdGhlciB0aGFuIGluIERPTSBlbGVtZW50cy4KICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgogICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIHRleHQodmFsdWUpCQktIHdyaXRlcyB0aGUgc3VwcGxpZWQgdGVtcGxhdGUgdGV4dCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQogICAgLy8gICBub2Rlcyh2YWx1ZSkgICAgICAgLSB3cml0ZXMgdGhlIGdpdmVuIERPTSBlbGVtZW50IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCiAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KICAgIC8vCiAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgogICAga28udGVtcGxhdGVTb3VyY2VzID0ge307CgogICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKHRoaXMuZG9tRWxlbWVudCksCiAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiaW5uZXJIVE1MIjsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbCh0aGlzLmRvbUVsZW1lbnQsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CiAgICAgICAgfQogICAgfTsKCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgInRlbXBsYXRlU291cmNlRGF0YV8iICsga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSwgYXJndW1lbnRzWzFdKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KICAgIC8vIEZvciBjb21wYXRpYmlsaXR5LCB5b3UgY2FuIGFsc28gcmVhZCAidGV4dCI7IGl0IHdpbGwgYmUgc2VyaWFsaXplZCBmcm9tIHRoZSBub2RlcyBvbiBkZW1hbmQuCiAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgogICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSAiX19rb19hbm9uX3RlbXBsYXRlX18iOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEudGV4dERhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7dGV4dERhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ25vZGVzJ10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7Y29udGFpbmVyRGF0YTogdmFsdWVUb1dyaXRlfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcycsIGtvLnRlbXBsYXRlU291cmNlcyk7CiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwp9KSgpOwooZnVuY3Rpb24gKCkgewogICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKICAgIGtvLnNldFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKICAgICAgICBfdGVtcGxhdGVFbmdpbmUgPSB0ZW1wbGF0ZUVuZ2luZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewogICAgICAgIHZhciBub2RlLCBuZXh0SW5RdWV1ZSA9IGZpcnN0Tm9kZSwgZmlyc3RPdXRPZlJhbmdlTm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhsYXN0Tm9kZSk7CiAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICBhY3Rpb24obm9kZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CiAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCiAgICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3Igd2Fsa2luZyB0aGVtIHJlbGllcyBvbiB0aGlzKSwgYW5kIGZvciBlYWNoIHRvcC1sZXZlbCBpdGVtIGluIHRoZSB2aXJ0dWFsLWVsZW1lbnQgc2Vuc2UsCiAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgogICAgICAgIGlmIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgogICAgICAgICAgICAvLyBOZWVkIHRvIGFwcGx5QmluZGluZ3MgKmJlZm9yZSogdW5tZW1vemlhdGlvbiwgYmVjYXVzZSB1bm1lbW9pemF0aW9uIG1pZ2h0IGludHJvZHVjZSBleHRyYSBub2RlcyAodGhhdCB3ZSBkb24ndCB3YW50IHRvIHJlLWJpbmQpCiAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwogICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMobm9kZSwgW2JpbmRpbmdDb250ZXh0XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheShub2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwogICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwogICAgICAgIHZhciB0ZW1wbGF0ZUVuZ2luZVRvVXNlID0gKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKTsKICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKICAgICAgICAvLyBMb29zZWx5IGNoZWNrIHJlc3VsdCBpcyBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKICAgICAgICB2YXIgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewogICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbih0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CiAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJyZXBsYWNlTm9kZSI6CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlck1vZGU6ICIgKyByZW5kZXJNb2RlKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQogICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICB9CgogICAga28ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IGEgdGVtcGxhdGUgZW5naW5lIGJlZm9yZSBjYWxsaW5nIHJlbmRlclRlbXBsYXRlIik7CiAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgogICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgogICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgogICAgICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSggLy8gU28gdGhlIERPTSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdDb250ZXh0ID0gKGRhdGFPckJpbmRpbmdDb250ZXh0ICYmIChkYXRhT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gdHlwZW9mKHRlbXBsYXRlKSA9PSAnZnVuY3Rpb24nID8gdGVtcGxhdGUoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSA6IHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGVOYW1lLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXROb2RlT3JOb2RlQXJyYXkgPSByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gU2luY2Ugc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBhbHdheXMgY2FsbHMgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCB0aGVuCiAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCBieSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIHRvIGdldCB0aGUgbm9kZXMgdG8gYWRkIHRvIHRhcmdldE5vZGUKICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dCA9IHBhcmVudEJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5VmFsdWUpLCBvcHRpb25zWydhcyddKTsKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dFsnJGluZGV4J10gPSBpbmRleDsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpIDogdGVtcGxhdGU7CiAgICAgICAgICAgIHJldHVybiBleGVjdXRlVGVtcGxhdGUobnVsbCwgImlnbm9yZVRhcmdldE5vZGUiLCB0ZW1wbGF0ZU5hbWUsIGFycmF5SXRlbUNvbnRleHQsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayA9IGZ1bmN0aW9uKGFycmF5VmFsdWUsIGFkZGVkTm9kZXNBcnJheSwgaW5kZXgpIHsKICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10oYWRkZWROb2Rlc0FycmF5LCBhcnJheVZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlPck9ic2VydmFibGVBcnJheSkgfHwgW107CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgYW55IGVudHJpZXMgbWFya2VkIGFzIGRlc3Ryb3llZAogICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCiAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcsIG51bGwsIFt0YXJnZXROb2RlLCBmaWx0ZXJlZEFycmF5LCBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0sIG9wdGlvbnMsIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFja10pOwoKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKICAgIH07CgogICAgdmFyIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5ID0gJ19fa29fX3RlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5X18nOwogICAgZnVuY3Rpb24gZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgbmV3Q29tcHV0ZWQpIHsKICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CiAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCiAgICAgICAgICAgIG9sZENvbXB1dGVkLmRpc3Bvc2UoKTsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwogICAgfQoKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCiAgICAgICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgICAgIGlmICgodHlwZW9mIGJpbmRpbmdWYWx1ZSAhPSAic3RyaW5nIikgJiYgKCFiaW5kaW5nVmFsdWVbJ25hbWUnXSkgJiYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09IDgpKSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGVsZW1lbnQubm9kZVR5cGUgPT0gMSA/IGVsZW1lbnQuY2hpbGROb2RlcyA6IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGtvLnV0aWxzLm1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQodGVtcGxhdGVOb2Rlcyk7IC8vIFRoaXMgYWxzbyByZW1vdmVzIHRoZSBub2RlcyBmcm9tIHRoZWlyIGN1cnJlbnQgcGFyZW50CiAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwogICAgICAgIH0sCiAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCiAgICAgICAgICAgICAgICBvcHRpb25zID0ge30sCiAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZU5hbWUgIT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZW1wbGF0ZU5hbWU7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSBvcHRpb25zWyduYW1lJ107CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwogICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydpZiddKTsKICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydkYXRhJ10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciBlYWNoIGRhdGEgcG9pbnQgKHRyZWF0aW5nIGRhdGEgc2V0IGFzIGVtcHR5IGlmIHNob3VsZERpc3BsYXk9PWZhbHNlKQogICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciB0aGlzIHNpbmdsZSBkYXRhIHBvaW50IChvciB1c2UgdGhlIHZpZXdNb2RlbCBpZiBubyBkYXRhIHdhcyBwcm92aWRlZCkKICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBleHBsaWNpdCAnZGF0YScgdmFsdWUsIHdlIHJldGFpbiB0aGUgc2FtZSBiaW5kaW5nIGNvbnRleHQKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEl0IG9ubHkgbWFrZXMgc2Vuc2UgdG8gaGF2ZSBhIHNpbmdsZSB0ZW1wbGF0ZSBjb21wdXRlZCBwZXIgZWxlbWVudCAob3RoZXJ3aXNlIHdoaWNoIG9uZSBzaG91bGQgaGF2ZSBpdHMgb3V0cHV0IGRpc3BsYXllZD8pCiAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdWYWx1ZSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGJpbmRpbmdWYWx1ZSk7CgogICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgogICAgICAgIGlmIChrby5leHByZXNzaW9uUmV3cml0aW5nLmtleVZhbHVlQXJyYXlDb250YWluc0tleShwYXJzZWRCaW5kaW5nVmFsdWUsICJuYW1lIikpCiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwogICAgfTsKCiAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnc2V0VGVtcGxhdGVFbmdpbmUnLCBrby5zZXRUZW1wbGF0ZUVuZ2luZSk7CmtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7Cgprby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzdGF0dXNOb3RJbk9sZCA9ICdhZGRlZCcsIHN0YXR1c05vdEluTmV3ID0gJ2RlbGV0ZWQnOwoKICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBkb250TGltaXRNb3ZlcykgewogICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CiAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCiAgICAgICAgaWYgKG9sZEFycmF5Lmxlbmd0aCA8PSBuZXdBcnJheS5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIGRvbnRMaW1pdE1vdmVzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIGRvbnRMaW1pdE1vdmVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkoc21sQXJyYXksIGJpZ0FycmF5LCBzdGF0dXNOb3RJblNtbCwgc3RhdHVzTm90SW5CaWcsIGRvbnRMaW1pdE1vdmVzKSB7CiAgICAgICAgdmFyIG15TWluID0gTWF0aC5taW4sCiAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCiAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAogICAgICAgICAgICBzbWxJbmRleCwgc21sSW5kZXhNYXggPSBzbWxBcnJheS5sZW5ndGgsCiAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCiAgICAgICAgICAgIG1heERpc3RhbmNlID0gc21sSW5kZXhNYXggKyBiaWdJbmRleE1heCArIDEsCiAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCiAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCiAgICAgICAgZm9yIChzbWxJbmRleCA9IDA7IHNtbEluZGV4IDw9IHNtbEluZGV4TWF4OyBzbWxJbmRleCsrKSB7CiAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwogICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwogICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdyA9IG15TWluKGJpZ0luZGV4TWF4LCBzbWxJbmRleCArIGNvbXBhcmVSYW5nZSk7CiAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewogICAgICAgICAgICAgICAgaWYgKCFiaWdJbmRleCkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwogICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gYmlnSW5kZXggKyAxOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCiAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IG15TWluKG5vcnRoRGlzdGFuY2UsIHdlc3REaXN0YW5jZSkgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwogICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CiAgICAgICAgICAgIG1lTWludXNPbmUgPSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4XSAtIDE7CiAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CiAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5TbWwsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCiAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc21sSW5kZXggJiYgbWVNaW51c09uZSA9PT0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4IC0gMV1bYmlnSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBzbWxBcnJheVstLXNtbEluZGV4XSwKICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0gfSk7CiAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm90SW5TbWwubGVuZ3RoICYmIG5vdEluQmlnLmxlbmd0aCkgewogICAgICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKICAgICAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCiAgICAgICAgICAgIHZhciBsaW1pdEZhaWxlZENvbXBhcmVzID0gc21sSW5kZXhNYXggKiAxMCwgZmFpbGVkQ29tcGFyZXMsCiAgICAgICAgICAgICAgICBhLCBkLCBub3RJblNtbEl0ZW0sIG5vdEluQmlnSXRlbTsKICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgaXRlbXMgdGhhdCBoYXZlIGJlZW4gYWRkZWQgYW5kIGRlbGV0ZWQgYW5kIHRyeSB0byBmaW5kIG1hdGNoZXMgYmV0d2VlbiB0aGVtLgogICAgICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gYSA9IDA7IChkb250TGltaXRNb3ZlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChub3RJblNtbEl0ZW0gPSBub3RJblNtbFthXSk7IGErKykgewogICAgICAgICAgICAgICAgZm9yIChkID0gMDsgbm90SW5CaWdJdGVtID0gbm90SW5CaWdbZF07IGQrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChub3RJblNtbEl0ZW1bJ3ZhbHVlJ10gPT09IG5vdEluQmlnSXRlbVsndmFsdWUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICBub3RJblNtbEl0ZW1bJ21vdmVkJ10gPSBub3RJbkJpZ0l0ZW1bJ2luZGV4J107CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEluQmlnSXRlbVsnbW92ZWQnXSA9IG5vdEluU21sSXRlbVsnaW5kZXgnXTsKICAgICAgICAgICAgICAgICAgICAgICAgbm90SW5CaWcuc3BsaWNlKGQsMSk7ICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIG5vdEluQmlnIGxpc3QKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSBkID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSBkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlZGl0U2NyaXB0LnJldmVyc2UoKTsKICAgIH0KCiAgICByZXR1cm4gY29tcGFyZUFycmF5czsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIE9iamVjdGl2ZToKICAgIC8vICogR2l2ZW4gYW4gaW5wdXQgYXJyYXksIGEgY29udGFpbmVyIERPTSBub2RlLCBhbmQgYSBmdW5jdGlvbiBmcm9tIGFycmF5IGVsZW1lbnRzIHRvIGFycmF5cyBvZiBET00gbm9kZXMsCiAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gICBzbyB0aGF0IGl0cyBjaGlsZHJlbiBpcyBhZ2FpbiB0aGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgbWFwcGluZ3Mgb2YgdGhlIGFycmF5IGVsZW1lbnRzLCBidXQgZG9uJ3QgcmUtbWFwIGFueSBhcnJheSBlbGVtZW50cyB0aGF0IHdlCiAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCiAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCiAgICAvLyBZb3UgY2FuIHVzZSB0aGlzLCBmb3IgZXhhbXBsZSwgdG8gYWN0aXZhdGUgYmluZGluZ3Mgb24gdGhvc2Ugbm9kZXMuCgogICAgZnVuY3Rpb24gZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChjb250aWd1b3VzTm9kZUFycmF5KSB7CiAgICAgICAgLy8gQmVmb3JlIG1vdmluZywgZGVsZXRpbmcsIG9yIHJlcGxhY2luZyBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgdGhlICJtYXAiIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQogICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIG9yIHRoYXQgbmV3IG5vZGVzIG1pZ2h0IGhhdmUgYmVlbiBpbnNlcnRlZCBpbiB0aGUgbWlkZGxlLCBmb3IgZXhhbXBsZSBieSBhIGJpbmRpbmcuIEFsc28sIHRoZXJlIG1heSBwcmV2aW91c2x5IGhhdmUgYmVlbgogICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2Ygd2hhdCBzZXQgb2YgY3VycmVudCBET00gbm9kZXMgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgICAgLy8KICAgICAgICAvLyBSdWxlczoKICAgICAgICAvLyAgIFtBXSBBbnkgbGVhZGluZyBub2RlcyB0aGF0IGFyZW4ndCBpbiB0aGUgZG9jdW1lbnQgYW55IG1vcmUgc2hvdWxkIGJlIGlnbm9yZWQKICAgICAgICAvLyAgICAgICBUaGVzZSBtb3N0IGxpa2VseSBjb3JyZXNwb25kIHRvIG1lbW9pemF0aW9uIG5vZGVzIHRoYXQgd2VyZSBhbHJlYWR5IHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcKICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCiAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aWd1b3VzIHNlcmllcyBvZiBub2RlcyB0aGF0IGFyZSBzdGlsbCBpbiB0aGUgZG9jdW1lbnQuIFNvLCBpZ25vcmUgYW55IG5vZGVzIHRoYXQKICAgICAgICAvLyAgICAgICBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCiAgICAgICAgLy8gUnVsZSBbQV0KICAgICAgICB3aGlsZSAoY29udGlndW91c05vZGVBcnJheS5sZW5ndGggJiYgIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChjb250aWd1b3VzTm9kZUFycmF5WzBdKSkKICAgICAgICAgICAgY29udGlndW91c05vZGVBcnJheS5zcGxpY2UoMCwgMSk7CgogICAgICAgIC8vIFJ1bGUgW0JdCiAgICAgICAgaWYgKGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewogICAgICAgICAgICAvLyBCdWlsZCB1cCB0aGUgYWN0dWFsIG5ldyBjb250aWd1b3VzIG5vZGUgc2V0CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGlndW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpZ3VvdXNOb2RlQXJyYXlbY29udGlndW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwgbmV3Q29udGlndW91c1NldCA9IFtjdXJyZW50XTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBuZXdDb250aWd1b3VzU2V0LnB1c2goY3VycmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC4uLiB0aGVuIG11dGF0ZSB0aGUgaW5wdXQgYXJyYXkgdG8gbWF0Y2ggdGhpcy4KICAgICAgICAgICAgLy8gKFRoZSBmb2xsb3dpbmcgbGluZSByZXBsYWNlcyB0aGUgY29udGVudHMgb2YgY29udGlndW91c05vZGVBcnJheSB3aXRoIG5ld0NvbnRpZ3VvdXNTZXQpCiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoY29udGlndW91c05vZGVBcnJheSwgWzAsIGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoXS5jb25jYXQobmV3Q29udGlndW91c1NldCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29udGlndW91c05vZGVBcnJheTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKICAgICAgICAvLyBNYXAgdGhpcyBhcnJheSB2YWx1ZSBpbnNpZGUgYSBkZXBlbmRlbnRPYnNlcnZhYmxlIHNvIHdlIHJlLW1hcCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXdNYXBwZWROb2RlcyA9IG1hcHBpbmcodmFsdWVUb01hcCwgaW5kZXgpIHx8IFtdOwoKICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwogICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKGZpeFVwTm9kZXNUb0JlTW92ZWRPclJlbW92ZWQobWFwcGVkTm9kZXMpLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQogICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAogICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCiAgICAgICAgICAgIG1hcHBlZE5vZGVzLnNwbGljZSgwLCBtYXBwZWROb2Rlcy5sZW5ndGgpOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gKG1hcHBlZE5vZGVzLmxlbmd0aCA9PSAwKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzWzBdKSB9IH0pOwogICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKICAgIH0KCiAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5ID0gInNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmdfbGFzdE1hcHBpbmdSZXN1bHQiOwoKICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgPSBmdW5jdGlvbiAoZG9tTm9kZSwgYXJyYXksIG1hcHBpbmcsIG9wdGlvbnMsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykgewogICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKICAgICAgICB2YXIgbGFzdEFycmF5ID0ga28udXRpbHMuYXJyYXlNYXAobGFzdE1hcHBpbmdSZXN1bHQsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmFycmF5RW50cnk7IH0pOwogICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5KTsKCiAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0ID0gW107CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKICAgICAgICB2YXIgbm9kZXNUb0RlbGV0ZSA9IFtdOwogICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0Zvck1vdmVDYWxsYmFja3MgPSBbXTsKICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBtYXBEYXRhOwoKICAgICAgICBmdW5jdGlvbiBpdGVtTW92ZWRPclJldGFpbmVkKGVkaXRTY3JpcHRJbmRleCwgb2xkUG9zaXRpb24pIHsKICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCiAgICAgICAgICAgICAgICBpdGVtc0Zvck1vdmVDYWxsYmFja3NbZWRpdFNjcmlwdEluZGV4XSA9IG1hcERhdGE7CiAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcE5vZGVzVG9CZU1vdmVkT3JSZW1vdmVkCiAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKTsKICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwogICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChpdGVtc1tpXS5tYXBwZWROb2RlcywgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewogICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CiAgICAgICAgICAgIHN3aXRjaCAoZWRpdFNjcmlwdEl0ZW1bJ3N0YXR1cyddKSB7CiAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAicmV0YWluZWQiOgogICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJhZGRlZCI6CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBOZXh0IHJlbW92ZSBub2RlcyBmb3IgZGVsZXRlZCBpdGVtcyAob3IganVzdCBjbGVhbiBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5leHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZG9tTm9kZSksIGxhc3ROb2RlLCBub2RlOyBtYXBEYXRhID0gaXRlbXNUb1Byb2Nlc3NbaV07IGkrKykgewogICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCiAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChtYXBEYXRhLCBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGRvbU5vZGUsIG1hcHBpbmcsIG1hcERhdGEuYXJyYXlFbnRyeSwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSkpOwoKICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgIT09IG5leHROb2RlKQogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biB0aGUgY2FsbGJhY2tzIGZvciBuZXdseSBhZGRlZCBub2RlcyAoZm9yIGV4YW1wbGUsIHRvIGFwcGx5IGJpbmRpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgICAgICBtYXBEYXRhLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaywgY2FsbCBpdCBhZnRlciByZW9yZGVyaW5nLgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQogICAgICAgIC8vIGNhbGxiYWNrIGluc3RlYWQgcmVtb3ZlcyB0aGUgbm9kZXMgcmlnaHQgYXdheSwgaXQgd291bGQgYmUgbW9yZSBlZmZpY2llbnQgdG8gc2tpcCByZW9yZGVyaW5nIHRoZW0uCiAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgogICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBGaW5hbGx5IGNhbGwgYWZ0ZXJNb3ZlIGFuZCBhZnRlckFkZCBjYWxsYmFja3MKICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CiAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKICAgICAgICAvLyBTdG9yZSBhIGNvcHkgb2YgdGhlIGFycmF5IGl0ZW1zIHdlIGp1c3QgY29uc2lkZXJlZCBzbyB3ZSBjYW4gZGlmZmVyZW5jZSBpdCBuZXh0IHRpbWUKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7CmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID0gZmFsc2U7Cn0KCmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdXNlTm9kZXNJZkF2YWlsYWJsZSA9ICEoa28udXRpbHMuaWVWZXJzaW9uIDwgOSksIC8vIElFPDkgY2xvbmVOb2RlIGRvZXNuJ3Qgd29yayBwcm9wZXJseQogICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCiAgICBpZiAodGVtcGxhdGVOb2RlcykgewogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CiAgICB9Cn07Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwprby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7Cgprby5leHBvcnRTeW1ib2woJ25hdGl2ZVRlbXBsYXRlRW5naW5lJywga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUpOwooZnVuY3Rpb24oKSB7CiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRGV0ZWN0IHdoaWNoIHZlcnNpb24gb2YganF1ZXJ5LXRtcGwgeW91J3JlIHVzaW5nLiBVbmZvcnR1bmF0ZWx5IGpxdWVyeS10bXBsCiAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAogICAgICAgIC8vIHdoaWNoIEtPIGludGVybmFsbHkgcmVmZXJzIHRvIGFzIHZlcnNpb24gIjIiLCBzbyBvbGRlciB2ZXJzaW9ucyBhcmUgbm8gbG9uZ2VyIGRldGVjdGVkLgogICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgodHlwZW9mKGpRdWVyeSkgPT0gInVuZGVmaW5lZCIpIHx8ICEoalF1ZXJ5Wyd0bXBsJ10pKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ3RtcGwnXVsnb3BlbiddLnRvU3RyaW5nKCkuaW5kZXhPZignX18nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCiAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3VyIHZlcnNpb24gb2YgalF1ZXJ5LnRtcGwgaXMgdG9vIG9sZC4gUGxlYXNlIHVwZ3JhZGUgdG8galF1ZXJ5LnRtcGwgMS4wLjBwcmUgb3IgbGF0ZXIuIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnlbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQogICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwogICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKICAgICAgICAgICAgICAgIHRlbXBsYXRlVGV4dCA9ICJ7e2tvX3dpdGggJGl0ZW0ua29CaW5kaW5nQ29udGV4dH19IiArIHRlbXBsYXRlVGV4dCArICJ7ey9rb193aXRofX0iOwoKICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5Wyd0ZW1wbGF0ZSddKG51bGwsIHRlbXBsYXRlVGV4dCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBbYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dOyAvLyBQcmV3cmFwIHRoZSBkYXRhIGluIGFuIGFycmF5IHRvIHN0b3AganF1ZXJ5LnRtcGwgZnJvbSB0cnlpbmcgdG8gdW53cmFwIGFueSBhcnJheXMKICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeVsnZXh0ZW5kJ10oeyAna29CaW5kaW5nQ29udGV4dCc6IGJpbmRpbmdDb250ZXh0IH0sIG9wdGlvbnNbJ3RlbXBsYXRlT3B0aW9ucyddKTsKCiAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgogICAgICAgICAgICBqUXVlcnlbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwogICAgICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKICAgICAgICAgICAgcmV0dXJuICJ7e2tvX2NvZGUgKChmdW5jdGlvbigpIHsgcmV0dXJuICIgKyBzY3JpcHQgKyAiIH0pKCkpIH19IjsKICAgICAgICB9OwoKICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewogICAgICAgICAgICBkb2N1bWVudC53cml0ZSgiPHNjcmlwdCB0eXBlPSd0ZXh0L2h0bWwnIGlkPSciICsgdGVtcGxhdGVOYW1lICsgIic+IiArIHRlbXBsYXRlTWFya3VwICsgIjwvc2NyaXB0PiIpOwogICAgICAgIH07CgogICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgogICAgICAgICAgICB9OwogICAgICAgICAgICBqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ2tvX3dpdGgnXSA9IHsKICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlRW5naW5lKCk7CgogICAgLy8gVXNlIHRoaXMgb25lIGJ5IGRlZmF1bHQgKm9ubHkgaWYganF1ZXJ5LnRtcGwgaXMgcmVmZXJlbmNlZCoKICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCiAgICAgICAga28uc2V0VGVtcGxhdGVFbmdpbmUoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UpOwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKfSkoKTsKfSk7Cn0pKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3Isd2luZG93WyJqUXVlcnkiXSk7Cn0pKCk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAna25vY2tvdXQnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2tvX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIga28gPSBfX2tvX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQsIGtub2Nrb3V0VGVtcGxhdGVzID0gewogICAgfTsKICAgIHZhciBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbiA9IGZ1bmN0aW9uICh0ZW1wbGF0ZU1hbmFnZXIpIHsKICAgICAgICB2YXIgVGhydXN0VGVtcGxhdGVTb3VyY2UgPSAoa28pLnRlbXBsYXRlU291cmNlcy50aHJ1c3RUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3RUZW1wbGF0ZVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5odG1sOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmh0bWwgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ1RocnVzdCBUZW1wbGF0ZSBkb2VzIG5vdCBzdXBwb3J0IHJld3JpdGluZy4uLicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRlbXBsYXRlLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAvLyBCZWdpbiBpbnRlZ3JhdGlvbiBvZiB0ZW1wbGF0ZSBwbHVnaW4sIHdpdGggS25vY2tvdXQuCiAgICAgICAgdmFyIG9sZEVuZ2luZSA9IChrbykubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2U7CiAgICAgICAgdmFyIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgY29udmVudGlvblRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IGtvLnV0aWxzLmV4dGVuZChuZXcgKGtvKS50ZW1wbGF0ZUVuZ2luZSgpLCB7CiAgICAgICAgICAgIHJlbmRlclRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZih0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGhpcy5ldmFsdWF0b3JzOwogICAgICAgICAgICAgICAgICAgIGlmKCFldmFsdWF0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9ycyA9IGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwcmVjb21waWxlZCA9IHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0gdGVtcGxhdGVNYW5hZ2VyLmNvbXBpbGUoJ3t7IHdpdGgoJGRhdGEpIHsgfX0gJyArIHRlbXBsYXRlU291cmNlLnRleHQoKSArICIge3sgfSB9fSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSB0ZW1wbGF0ZSBhbmQgcGFyc2UgaXRzIG91dHB1dCBpbnRvIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE1hcmt1cCA9IHRlbXBsYXRlU291cmNlLnRlbXBsYXRlLmNvbXBpbGVkKGJpbmRpbmdDb250ZXh0KS5yZXBsYWNlKC9ccysvZywgIiAiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGtvKS51dGlscy5wYXJzZUh0bWxGcmFnbWVudChyZW5kZXJlZE1hcmt1cCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLnJlbmRlclRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrOiBmdW5jdGlvbiAoc2NyaXB0KSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5ldmFsdWF0b3JDYWNoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9yQ2FjaGUgPSBldmFsdWF0b3JzLmxlZnQgKyBzY3JpcHQgKyBldmFsdWF0b3JzLnJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yQ2FjaGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1ha2VUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgICAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSB0ZW1wbGF0ZU1hbmFnZXIuZ2V0KHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGhydXN0VGVtcGxhdGVTb3VyY2UoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5tYWtlVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgKGtvKS5zZXRUZW1wbGF0ZUVuZ2luZShuZXcgKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUoKSk7CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIGluaXRLbm9ja291dEludGVncmF0aW9uKHRocnVzdC50ZW1wbGF0ZSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMua25vY2tvdXRFbmdpbmUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9a25vY2tvdXQuZW5naW5lLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24vdGVtcGxhdGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBURU1QTEFURVMgPSAndGVtcGxhdGVzJywgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZDsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgVEVNUExBVEVTCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICB2YXIgdGVtcGxhdGVzID0gbW9kLmNvbnZlbnRpb24oVEVNUExBVEVTKSwgaW52ZXJ0ZWRUZW1wbGF0ZXMgPSB1dGlsLmludmVydCh0ZW1wbGF0ZXMpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYodGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJzID0gW107CiAgICAgICAgICAgICAgICBlYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnMucHVzaChmYWNhZGUuZmV0Y2godGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSA9IHdoZW4uYWxsKGRlZmVycykudGhlbihmdW5jdGlvbiAobG9hZGVkVGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChpbnZlcnRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gXy5maW5kKGxvYWRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LnNob3J0TmFtZSA9PT0gaSB8fCB4Lm5hbWUgPT09IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50ZW1wbGF0ZXNbaV0gPSB0ZW1wbGF0ZS5jb21waWxlZDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWNhZGUubG9hZGluZ1Byb21pc2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnRlbXBsYXRlID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXRlbXBsYXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LnNwYS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvbWVkaWF0b3IuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsIAogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycKICAgIF07CiAgICAvKioKICAgIERlZmluZXMgdGhlIHZhbHVlIG9mIGN1c3RvbSBwYXJhbWV0ZXJzLgogICAgWW91IGNhbiBhbHNvIGRlZmluZSBjdXN0b20gcGFyYW1ldGVycyB0byBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYW5kIHRoZW4gdXNlIHRoZW0gaW4geW91ciByb3V0ZXMKICAgIAogICAgQHByb3BlcnR5IHBhcmFtcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnBhcmFtcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBwcmVkZmluZWQgcm91dGVzIHRvIGJlIHVzZWQgYnkgc3BhLgogICAgCiAgICBAcHJvcGVydHkgcm91dGVzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucm91dGVzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGZpbGUgZXhzdGVuaW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgd2hlbiByZXNvbHZpbmcgcm91dGVzIGFuZCBzdGFydGluZyBtb2R1bGVzLgogICAgCiAgICBAcHJvcGVydHkgZmlsZUV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgKiovCiAgICBleHBvcnRzLmZpbGVFeHRlbnNpb24gPSAnLmh0bWwnOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2RvbS9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciAkID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciBwYXJzZUZ1bGxIcmVmID0gZnVuY3Rpb24gKGhyZWYpIHsKICAgICAgICB2YXIgYmFzZVVybCA9IGxvY2F0aW9uLnBhdGhuYW1lLnN1YnN0cmluZygwLCBsb2NhdGlvbi5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICBpZihocmVmLmluZGV4T2YoJy8nKSAhPSAtMSkgewogICAgICAgICAgICBocmVmID0gaHJlZi5zdWJzdHJpbmcoaHJlZi5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBocmVmID0gJy8nICsgaHJlZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhc2VVcmwgKyBocmVmOwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QuZG9tCiAgICBAc3VibW9kdWxlIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9kb21fXyBDb252ZW50aW9uIC0gU2luZ2xlIFBhZ2UgQXBwIExpbmsKICAgICoKICAgICogUmVxdWlyZXMgdGhydXN0L2RvbQogICAgKgogICAgKiBAZm9yIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3BhO2luawogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhydXN0LmNvbmZpZywgc3BhID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgJC5vbignY2xpY2snLCAnYScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHBhcnNlRnVsbEhyZWYodGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICBpZihsaW5rLmluZGV4T2YoY29uZmlnLnVybC5wYXRoKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHNwYS5uYXZpZ2F0ZShsaW5rKTsKICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnNwYWxpbmsgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3BhbGluay5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3Qvc3BhX18gQ29udmVudGlvbiAtIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBzaW5nbGUgcGFnZSBhcHAgc3RhcnQgY29udmVudGlvbiwgZG9lcyB0aGUgYWN0dWFsIHN0YXJ0aW5nIG9mIHRoZSBwbHVnaW4sIGluIGFkZGl0aW9uIGl0IGFsc28gZGVsYXlzCiAgICAqIGZ1bGwgb3JiaXQsIHVudGlsIGFueSBtb2R1bGUgaXQgaGFzIHN0YXJ0ZWQgaGFzIGJlZW4gbG9hZGVkLgogICAgKgogICAgKiBAZm9yIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3RhcnQKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgIHJvdXRlci5zdGFydCgpOwogICAgICAgICAgICByZXR1cm4gdGhydXN0LnNwYS5zdGFydGluZ01vZHVsZVByb21pc2UgfHwgbnVsbDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICdoYXMnLCAndGhydXN0L2NvbmZpZycsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19jb25maWdfXywgX19tZWRpYXRvckNvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9oYXMuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgLy9pbXBvcnQgZXZlbnRzID0gbW9kdWxlKCd0aHJ1c3QvZXZlbnRzJyk7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciBtZWRpYXRvckNvbmZpZyA9IF9fbWVkaWF0b3JDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdNZWRpYXRvcic7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IC8vIHN0cmluZyBmb3JtYXQgbWV0aG9kCiAgICBfLmV4dGVuZCwgd2hlbiA9IC8vIG9iamVjdCBleHRlbnNpb24gbWV0aG9kCiAgICB1dGlsLndoZW4sIG1lbW9pemUgPSBfLm1lbW9pemUsIG1lZGlhdG9yLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBjID0gY29uZmlnOwogICAgLy8jcmVnaW9uIEZhY2FkZQogICAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IG1lZGlhdG9yIGZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0Lk1lZGlhdG9yfSBwYXJlbnQgVGhlIHBhcmVudCBtZWRpYXRvciB0byBjcmVhdGUgdGhlIGZhY2FkZSBvbi4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbWVkaWF0b3JGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZTsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cyhtb2R1bGUpOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgICAgICAvKioKICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0IG9mIGEgbWVkaWF0b3IgZmFjYWRlLCBzdGFydCBjcmVhdGVzIHRoZSBpbnRlcm5hbCBzdWJzY3JpcHRpb25zIGFycmF5LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYoIXRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdDsKICAgICAgICAvKioKICAgICAgICBPdmVycmlkZXMgdGhlIHN1YnNjcmliZSBtZXRob2QsIGFuZCB0cmFja3MgdGhlIGFueSBldmVudCB0aGF0IGlzIGJvdW5kLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAqKi8KICAgICAgICAobWVkaWF0b3JGYWNhZGUpLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudHM6IGV2ZW50cywKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEV2ZW50cy5zdWJzY3JpYmUuY2FsbCh0aGlzLCBldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICB9OwogICAgICAgIC8qKgogICAgICAgIFVuc3Vic2NyaWJlcyBmcm9tIGFsbCBldmVudHMgdGhhdCB3ZXJlIHN1YnNjcmliZWQgdG8uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKHN1Yi5ldmVudHMsIHN1Yi5jYWxsYmFjaywgc3ViLmNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBtZWRpYXRvckZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vIE91ciBkZWZhdWx0IG5hbWVzcGFjZSBwcmVmaXguCiAgICAvKioKICAgIE1lZGlhdG9yIGNsYXNzLgogICAgVGhpcyBjcmVhdGVzIGEgaW5zdGFuY2Ugb2YgdGhlIG1lZGlhdG9yLCBmb3IgdXNlIGluc2lkZSB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtZWRpYXRvci4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBNZWRpYXRvcihuYW1lLCBjb25maWcpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBhcHBQYXRoID0gY29uZmlnICYmIGNvbmZpZy51cmwgJiYgY29uZmlnLnVybC5wYXRoOwogICAgICAgICAgICB0aGF0Lm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ01lZGlhdG9yOiBDcmVhdGluZyBuZXcgTWVkaWF0b3IgezB9JywgbmFtZSkpOwogICAgICAgICAgICB0aGF0LmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoJ3RocnVzdC9yZWFkeScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oJ01lZGlhdG9yOiBSZWFkeSEnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IgJiYgIShmYWNhZGVzLm1lZGlhdG9yIGluc3RhbmNlb2YgTWVkaWF0b3JGYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJtZWRpYXRvciIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtZWRpYXRvcjsKICAgICAgICAgICAgaWYoZmFjYWRlcy5tZWRpYXRvcikgewogICAgICAgICAgICAgICAgZmFjYWRlcy5tZWRpYXRvci51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIG1lZGlhdG9yID0gZmFjYWRlcy5tZWRpYXRvcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lZGlhdG9yID0gZmFjYWRlcy5tZWRpYXRvciA9IChtb2QpLm1lZGlhdG9yID0gbmV3IE1lZGlhdG9yRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lZGlhdG9yOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IuY29uZmlnID0gbWVkaWF0b3JDb25maWc7CiAgICAgICAgcmV0dXJuIE1lZGlhdG9yOwogICAgfSkoKTsKICAgIGV4cG9ydHMuTWVkaWF0b3IgPSBNZWRpYXRvcjsgICAgCiAgICAvLyBHZXQgdGhlIGFjdHVhbCBldmVudCBtZXRob2RzIG9udG8gdGhlIE1lZGlhdG9yCiAgICBfLmV4dGVuZChNZWRpYXRvci5wcm90b3R5cGUsIEV2ZW50cyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3InLCBbJ3RocnVzdC9tZWRpYXRvci9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RhdGEvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnanF1ZXJ5JywgJ3RocnVzdC9sb2cnLCAnLi9jb25maWcnLCAndGhydXN0L2NvbmZpZycsICcuL2V2ZW50LmZhY3RvcnknLCAnLi9yZXNwb25zZS5xdWV1ZScsICd0aHJ1c3QvZXZlbnRzJywgJ3RocnVzdC9mYWNhZGUnLCAnLi9ldmVudC50eXBlcycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2pRdWVyeV9fLCBfX2xvZ19fLCBfX2NvbmZpZ19fLCBfX3RDb25maWdfXywgX19ldmVudEZhY3RvcnlfXywgX19yZXNwb25zZVF1ZXVlX18sIF9fZXZlbnRzX18sIF9fZmFjYWRlX18sIF9fZXZlbnRUeXBlc19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgalF1ZXJ5ID0gX19qUXVlcnlfXzsKCiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciBldmVudEZhY3RvcnkgPSBfX2V2ZW50RmFjdG9yeV9fOwoKICAgIHZhciByZXNwb25zZVF1ZXVlID0gX19yZXNwb25zZVF1ZXVlX187CgogICAgdmFyIFJlc3BvbnNlUXVldWUgPSByZXNwb25zZVF1ZXVlLlJlc3BvbnNlUXVldWU7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRGF0YSc7CiAgICBjb25maWc7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCB3aGVuID0gdXRpbC53aGVuLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgYWpheCA9IGpRdWVyeS5hamF4LCB1aWQgPSBfLnVuaXF1ZUlkLCBkYXRhRXZlbnRXYWl0ID0gZXZlbnRUeXBlc1snd2FpdCddLCBkYXRhRXZlbnRTdGFydCA9IGV2ZW50VHlwZXNbJ3N0YXJ0J10sIGRhdGFFdmVudFN0b3AgPSBldmVudFR5cGVzWydzdG9wJ10sIGRhdGFFdmVudFN0YXR1cyA9IGV2ZW50VHlwZXNbJ3N0YXR1cyddLCBhcmd1bWVudFJlc29sdmVyID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QoXy50b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIH07CiAgICB9OwogICAgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbCA9ICEhdENvbmZpZy51cmwudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgIHZhciBqRG9jID0galF1ZXJ5KGRvY3VtZW50KTsKICAgIGV2ZW50RmFjdG9yeS5pbml0KGpEb2MpOwogICAgLy8jcmVnaW9uIERhdGFGYWNhZGUKICAgIC8qKgogICAgVGhlIGRhdGEgZmFjYWRlIHRoYXQgaXMgaGFuZGVkIG9mZiB0byBtb2R1bGVzLgogICAgCiAgICAKICAgIEVuYWJsZXMgZGF0YSB0cmFuc3BvcnQsIHVzaW5nIGpRdWVyeSBmb3IgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0LmRhdGEuRGF0YX0gcGFyZW50IFRoZSBwYXJlbnQgdGhydXN0IGRhdGEgb2JqZWN0IHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvci4KICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgRGF0YUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRhdGFGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZSArICctZGF0YSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLnJlc3BvbnNlUXVldWUgPSBwYXJlbnQucmVzcG9uc2VRdWV1ZTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSBwYXJlbnQuZGVmYXVsdHM7CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IHBhcmVudC5hcHBQYXRoOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKGRhdGFGYWNhZGUucHJvdG90eXBlLCBldmVudHMpOwogICAgICAgIHJldHVybiBkYXRhRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLyoqCiAgICBUaGUgbWFzdGVyIGRhdGEgcGx1Z2luLgogICAgCiAgICAKICAgIEVuYWJsZXMgZGF0YSB0cmFuc3BvcnQsIHVzaW5nIGpRdWVyeSBmb3IgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuRGF0YQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lLgogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3J9IG1lZGlhdG9yIFRoZSB0aHJ1c3QgbWVkaWF0b3IgaW5zdGFuY2UuCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0aHJ1c3QgaW5zdGFuY2UgY29uZmlndXJhdGlvbi4KICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgRGF0YSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRGF0YShuYW1lLCBtZWRpYXRvciwgY29uZmlnKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGE6IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLnJlc3BvbnNlUXVldWUgPSBuZXcgUmVzcG9uc2VRdWV1ZSh0aGlzLCBjb25maWcuZGF0YS5zdGFydFRpbWVvdXQsIGNvbmZpZy5kYXRhLmZpbmlzaFRpbWVvdXQpOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAodGhpcykubWVkaWF0b3IuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICBjYWNoZTogY29uZmlnLmRhdGEuY2FjaGUsCiAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCwKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgICAgICB1cmw6ICcnLAogICAgICAgICAgICAgICAgZGF0YTogJycsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgICAgX19tZWRpYXRvcl9kYXRhX2ZpcmVkX186IHRydWUsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IGNvbmZpZy51cmwucGF0aCArICcvJzsKICAgICAgICB9CiAgICAgICAgRGF0YS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgRGF0YUZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBhdmFpbGFibGUgZmFjYWRlcwogICAgICAgIEByZXR1cm5zIHtEYXRhRmFjYWRlfSBUaGUgbmV3IERhdGFGYWNhZGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYobW9kLmRhdGEgJiYgIShmYWNhZGVzLmRhdGEgaW5zdGFuY2VvZiBEYXRhRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZGF0YSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZihmYWNhZGVzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZGF0YS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhID0gbW9kLmRhdGEgPSBuZXcgRGF0YUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3REYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAnZ2V0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0ID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdwb3N0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5hamF4ID0gLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvcHRpb25zLCB0eXBlLCBiZWZvcmVTZW5kOwogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnRGF0YVt7MH1dOiBGZXRjaGluZyBkYXRhIGZyb20gInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdXJsKSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gdXRpbC5maXh1cFVybCh1cmwsIHRoYXQuYXBwUGF0aCk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgIHZhciBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICAgICAgdHlwZSA9IHNldHRpbmdzLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgewogICAgICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IHV0aWwubm9vcAogICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgYWpheCh1cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcihkZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICB9LCB0aGF0LmRlZmF1bHRzLCBzZXR0aW5ncywgewogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHR5cGUgPSBvcHRpb25zLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2VRdWV1ZS5hZGRUb1F1ZXVlKHR5cGUsIHVybCwgb3B0aW9ucyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gRGF0YTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRhdGEgPSBEYXRhOyAgICAKICAgIF8uZXh0ZW5kKERhdGEucHJvdG90eXBlLCBFdmVudHMpOwogICAgXy5leHRlbmQoRGF0YUZhY2FkZS5wcm90b3R5cGUsIERhdGEucHJvdG90eXBlKTsKICAgIC8vIFRha2UgYSBob2xkIG9mIGpRdWVyeS4uLiB0aGlzIGlzIHN1cmUgdG8gYmUgY29udHJhdmVzaWFsCiAgICBqUXVlcnkuYWpheCA9IChEYXRhKS5wcm90b3R5cGUuYWpheDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhJywgWyd0aHJ1c3QvZGF0YS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RvbS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL3N1YmpxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3N1YmpxdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgdFF1ZXJ5ID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRG9tJzsKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIGJpbmQgPSBfLmJpbmQsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHdoZW4gPSB1dGlsLndoZW4sIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICAvLyNyZWdpb24gRG9tRmFjYWRlCiAgICB2YXIgRG9tRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZG9tRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gcGFyZW50Lm5hbWU7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0UXVlcnkoZG9jdW1lbnQsIHVuZGVmaW5lZCwgdGhpcy5uYW1lKTsKICAgICAgICB9KTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoZmFrZSkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IHRoaXMuX2ludGVybmFsRXZlbnRzIHx8IFtdOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBJbml0YWxpemluZyB7MX1Eb20gZmFjYWRlJywgdGhpcy5uYW1lLCBmYWtlID8gJ2Zha2UgJyA6ICcnKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0YXJ0aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdG9wcGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsRXZlbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxFdmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBzdWIuY29udGV4dC5vZmYuYXBwbHkodGhpcywgKGlzQXJyYXkoc3ViKSkgPyBzdWIgOiAoaXNBcnJheShzdWIuYXJncykpID8gc3ViLmFyZ3MgOiBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBEZXN0cm95aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ludGVybmFsRXZlbnRzOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBkb21GYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gRG9tCiAgICB2YXIgRG9tID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBEb20obmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKG1lZGlhdG9yKS5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpLnByb21pc2UudGhlbihmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gewogICAgICAgICAgICAgICAgfSwgZmFjYWRlID0gdGhhdC5jcmVhdGVGYWNhZGUodGhydXN0LCBtb2QsIHsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIERvbS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5jb25maWcgPSBjb25maWc7CiAgICAgICAgRG9tLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20gJiYgIShmYWNhZGVzLmRvbSBpbnN0YW5jZW9mIERvbUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRvbSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb207CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRvbS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb20gPSBuZXcgRG9tRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBEb207CiAgICB9KSgpOwogICAgZXhwb3J0cy5Eb20gPSBEb207ICAgIAogICAgLy8jZW5kcmVnaW9uCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbScsIFsndGhydXN0L2RvbS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L3RlbXBsYXRlL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ2RvbVJlYWR5JywgJ3RocnVzdC9mYWNhZGUnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fZG9tUmVhZHlfXywgX19mYWNhZGVfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICAKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUZW1wbGF0ZSc7CiAgICBjb25maWc7CiAgICB2YXIgTE9ORyA9ICdsb25nJywgU0hPUlQgPSAnc2hvcnQnLCBJRCA9ICdpZCcsIGRlZXBDb3B5ID0gXy5tZXJnZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGJpbmQgPSBfLmJpbmQsIHdoZW4gPSB1dGlsLndoZW4sIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIGdldExvbmdOYW1lID0gZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9ICh0aGF0LnNob3J0TmFtZShuYW1lKSArICcuJyArICh0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbikudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0U2hvcnROYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHJlZHVjZSh0aGF0LnRlbXBsYXRlVHlwZXMsIGZ1bmN0aW9uIChtZW1vLCB4KSB7CiAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UoJy4nICsgeC50b0xvd2VyQ2FzZSgpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgfSwgbmFtZS50b0xvd2VyQ2FzZSgpKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRUZW1wbGF0ZUlkID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLnJlcGxhY2UoL1wvL2csICctJyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAcmVxdWlyZXMgdGhydXN0LmRhdGEKICAgICoqLwogICAgLyoqCiAgICBUaGUgdGVtcGxhdGUgcGx1Z2luIGNvbnN0dXJjdG9yLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGNvbmZpZyBvYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSB0aHJ1c3QgZGF0YSBpbnN0YW5jZQogICAgQHVzZXMgdGhydXN0LmRhdGEuRGF0YQogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGVtcGxhdGUoY29uZmlnLCBkYXRhKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGVDb25maWcgPSB0aGlzLmNvbmZpZyA9IGNvbmZpZy50ZW1wbGF0ZTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZVR5cGVzID0gbWFwKHRlbXBsYXRlQ29uZmlnLnR5cGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGxvbmc6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzaG9ydDogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlkOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubG9uZ05hbWUgPSBtZW1vaXplKGJpbmQoZ2V0TG9uZ05hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5zaG9ydE5hbWUgPSBtZW1vaXplKGJpbmQoZ2V0U2hvcnROYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVJZCA9IG1lbW9pemUoYmluZChnZXRUZW1wbGF0ZUlkLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuZW5naW5lcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5kYXRhID0gZGF0YTsKICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAodGVtcGxhdGVDb25maWcudGVtcGxhdGVQYXRoc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGUpCiAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICBkb21SZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgKF8oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXguZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgfSkuZWFjaChiaW5kKHRoYXQuY3JlYXRlRnJvbURvbU5vZGUsIHRoYXQpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IG51bGwsIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMubG9uZ1t0aGF0LmxvbmdOYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuc2hvcnRbdGhhdC5zaG9ydE5hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5pZFt0aGF0LnRlbXBsYXRlSWQobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuc2V0ID0gLyoqCiAgICAgICAgU2V0cyBhIHRlbXBsYXRlIHRvIHRoZSBjYWNoZSwgd2l0aCB0aGUgZ2l2ZW4gaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2Qgc2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjb21waWxlZFRlbXBsYXRlIFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCB0ZW1wbGF0ZUlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICB0ZW1wbGF0ZXMubG9uZ1tsb25nTmFtZV0gPSB0ZW1wbGF0ZXMuc2hvcnRbc2hvcnROYW1lXSA9IHRlbXBsYXRlcy5pZFt0ZW1wbGF0ZUlkXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBpZDogdGVtcGxhdGVJZCwKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICBodG1sOiBodG1sLAogICAgICAgICAgICAgICAgY29tcGlsZWQ6IGNvbXBpbGVkVGVtcGxhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5oYXMgPSAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiAhIXRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLm5ld1RlbXBsYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBnaXZlbiB0aGUgaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgbmV3VGVtcGxhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZQogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXcgdGVtcGxhdGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgaHRtbCwgaHRtbC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoaHRtbCwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY29tcGlsZSA9IC8qKgogICAgICAgIENvbXBpbGVzIGEgdGVtcGxhdGUgZ2l2ZW4gdGhlIGh0bWwgYW5kIHRoZSBlbmdpbmUgdHlwZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY29tcGlsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSBodG1sIHRvIGdlbmVyYXRlIHRoZSB0ZW1wbGF0ZSBmcm9tCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lIHRoYXQgaXMgYmVpbmcgdXNlZC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgaWYoIWVuZ2luZSkgewogICAgICAgICAgICAgICAgZW5naW5lID0gdGhhdC5lbmdpbmVzW3RoYXQuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgZW5naW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lOwogICAgICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGVuZ2luZS50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGluZ01ldGhvZChodG1sKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5mZXRjaCA9IC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdHlwZSA9IHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSkpIHsKICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhhdC5kYXRhLmdldCh0aGF0LmNvbmZpZy5iYXNlVXJsICsgbG9uZ05hbWUsIHsKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnLAogICAgICAgICAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgICAgICAgIH0pLnRoZW4od2hlbi5hcHBseShmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5lbmdpbmVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgdGhhdC5lbmdpbmVzW3R5cGVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5jb25maWcudGVtcGxhdGVQYXRoc1t0eXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0eXBlKQogICAgICAgICAgICAgICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwgZGVmZXIucmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRnJvbURvbU5vZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGZyb20gdGhlIGdpdmVuIERPTSBOb2RlCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZyb21Eb21Ob2RlCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7Tm9kZX0gZWxlbWVudCBUSGUgZG9tZSBlbGVtZW50LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5uZXdUZW1wbGF0ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpLCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10eXBlJyksIGVsZW1lbnQudGV4dCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVJbnN0YW5jZSA9IHRocnVzdC50ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IGZhY2FkZXMudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgbW9kLnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZmV0Y2gsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZ2V0LCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGhhczogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmhhcywgdGVtcGxhdGVJbnN0YW5jZSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gVGVtcGxhdGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UZW1wbGF0ZSA9IFRlbXBsYXRlOyAgICAKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGV9IHBhcmVudCBUaGUgdGVtcGxhdGUgaW5zdGFuY2UgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgKiovCiAgICB2YXIgVGVtcGxhdGVGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy10ZW1wbGF0ZSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIGV4dGVuZCh0aGlzLCB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZChwYXJlbnQuZmV0Y2gsIHBhcmVudCksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQocGFyZW50LmdldCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGhhczogYmluZChwYXJlbnQuaGFzLCBwYXJlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUZhY2FkZTsKICAgIH0pKCk7CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIHRocnVzdC90ZW1wbGF0ZSBieSBwYXRoLgogICAgUmVxdWlyZXMgdGhlIGluc3RhbmNlLCB0aGF0IHRoZSB0ZW1wbGF0ZSBpcyBleHBlY3RlZCB0byBjb21lIGZyb20uCiAgICB0aHJ1c3RJbnN0YW5jZVs6ZW5naW5lTmFtZV06dGVtcGxhdGVQYXRoCiAgICAKICAgIFByZWZpeCB3aXRoIDxlbmdpbmVOYW1lPjogdG8gc2VsZWN0IGEgc3BlY2lmaWMgdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWdsb2JhbDp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gU3BlY2lmaWMgdGVtcGxhdGUKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6dGVtcGxhdGVzL215VGVtcGxhdGUgPSBVc2VzIGRlZmF1bHQgZXh0ZW5zaW9uIGZyb20gY29uZmlnCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UzOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUgd2l0aCB0aGUgZGVmYXVsdCBleHRlbnNpb24KICAgIAogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICAvLyBOb3QgY29tcGxldGVkIHlldAogICAgLy8gU2hvdWxkIGJlaGF2ZSBzaW1pbGFybHkgdG8gdGV4dCEKICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGxvYWQobmFtZTogc3RyaW5nLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICAvL3sKICAgIC8vICAgIHZhciB0ZW1wbGF0ZVBhdGggPSBuYW1lLAogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lLAogICAgLy8gICAgICAgIGNvbG9uID0gdGVtcGxhdGVQYXRoLmluZGV4T2YoJzonKTsKICAgIC8vCXZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgIC8vICAgICAgICBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwKICAgIC8vCQl0ZW1wbGF0ZUVuZ2luZSA9IHBhcnRzWzFdLAogICAgLy8JCXRlbXBsYXRlUGF0aCA9IHBhcnRzWzJdIHx8IHRlbXBsYXRlRW5naW5lOwogICAgLy8gICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMikKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSA9IG51bGw7CiAgICAvLwkvL3ZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgIC8vICAgIC8vIEdldCB0aGUgZGF0YSBwbHVnaW4uCiAgICAvLyAgICBwYXJlbnRSZXF1aXJlKFsndGhydXN0IWRhdGE6JyArIGluc3RhbmNlTmFtZV0sIChkYXRhUGx1Z2luKSA9PgogICAgLy8gICAgewogICAgLy8gICAgICAgIHZhciBkYXRhUGx1Z2luID0gZGF0YVBsdWdpbgogICAgLy8gICAgfSk7CiAgICAvL30KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUnLCBbJ3RocnVzdC90ZW1wbGF0ZS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCgoKLy8KLy8gR2VuZXJhdGVkIG9uIFN1biBEZWMgMTYgMjAxMiAyMjo0NzowNSBHTVQtMDUwMCAoRVNUKSBieSBOb2Rlaml0c3UsIEluYyAoVXNpbmcgQ29kZXN1cmdlb24pLgovLyBWZXJzaW9uIDEuMS45Ci8vCgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCgovKgogKiBicm93c2VyLmpzOiBCcm93c2VyIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkgZm9yIGRpcmVjdG9yLgogKgogKiAoQykgMjAxMSwgTm9kZWppdHN1IEluYy4KICogTUlUIExJQ0VOU0UKICoKICovCgppZiAoIUFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICBBcnJheS5wcm90b3R5cGUuZmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyLCB0aGF0KSB7CiAgICB2YXIgb3RoZXIgPSBbXSwgdjsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gdGhpcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgaWYgKGkgaW4gdGhpcyAmJiBmaWx0ZXIuY2FsbCh0aGF0LCB2ID0gdGhpc1tpXSwgaSwgdGhpcykpIHsKICAgICAgICBvdGhlci5wdXNoKHYpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3RoZXI7CiAgfTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KXsKICBBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfQoKdmFyIGRsb2MgPSBkb2N1bWVudC5sb2NhdGlvbjsKCmZ1bmN0aW9uIGRsb2NIYXNoRW1wdHkoKSB7CiAgLy8gTm9uLUlFIGJyb3dzZXJzIHJldHVybiAnJyB3aGVuIHRoZSBhZGRyZXNzIGJhciBzaG93cyAnIyc7IERpcmVjdG9yJ3MgbG9naWMKICAvLyBhc3N1bWVzIGJvdGggbWVhbiBlbXB0eS4KICByZXR1cm4gZGxvYy5oYXNoID09PSAnJyB8fCBkbG9jLmhhc2ggPT09ICcjJzsKfQoKdmFyIGxpc3RlbmVyID0gewogIG1vZGU6ICdtb2Rlcm4nLAogIGhhc2g6IGRsb2MuaGFzaCwKICBoaXN0b3J5OiBmYWxzZSwKCiAgY2hlY2s6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBoID0gZGxvYy5oYXNoOwogICAgaWYgKGggIT0gdGhpcy5oYXNoKSB7CiAgICAgIHRoaXMuaGFzaCA9IGg7CiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCgpOwogICAgfQogIH0sCgogIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLm1vZGUgPT09ICdtb2Rlcm4nKSB7CiAgICAgIHRoaXMuaGlzdG9yeSA9PT0gdHJ1ZSA/IHdpbmRvdy5vbnBvcHN0YXRlKCkgOiB3aW5kb3cub25oYXNoY2hhbmdlKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhpcy5vbkhhc2hDaGFuZ2VkKCk7CiAgICB9CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24gKGZuLCBoaXN0b3J5KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoKICAgIGlmICghUm91dGVyLmxpc3RlbmVycykgewogICAgICBSb3V0ZXIubGlzdGVuZXJzID0gW107CiAgICB9CgogICAgZnVuY3Rpb24gb25jaGFuZ2Uob25DaGFuZ2VFdmVudCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IFJvdXRlci5saXN0ZW5lcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgUm91dGVyLmxpc3RlbmVyc1tpXShvbkNoYW5nZUV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vbm90ZSBJRTggaXMgYmVpbmcgY291bnRlZCBhcyAnbW9kZXJuJyBiZWNhdXNlIGl0IGhhcyB0aGUgaGFzaGNoYW5nZSBldmVudAogICAgaWYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09PSB1bmRlZmluZWQKICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNykpIHsKICAgICAgLy8gQXQgbGVhc3QgZm9yIG5vdyBIVE1MNSBoaXN0b3J5IGlzIGF2YWlsYWJsZSBmb3IgJ21vZGVybicgYnJvd3NlcnMgb25seQogICAgICBpZiAodGhpcy5oaXN0b3J5ID09PSB0cnVlKSB7CiAgICAgICAgLy8gVGhlcmUgaXMgYW4gb2xkIGJ1ZyBpbiBDaHJvbWUgdGhhdCBjYXVzZXMgb25wb3BzdGF0ZSB0byBmaXJlIGV2ZW4KICAgICAgICAvLyB1cG9uIGluaXRpYWwgcGFnZSBsb2FkLiBTaW5jZSB0aGUgaGFuZGxlciBpcyBydW4gbWFudWFsbHkgaW4gaW5pdCgpLAogICAgICAgIC8vIHRoaXMgd291bGQgY2F1c2UgQ2hyb21lIHRvIHJ1biBpdCB0d2lzZS4gQ3VycmVudGx5IHRoZSBvbmx5CiAgICAgICAgLy8gd29ya2Fyb3VuZCBzZWVtcyB0byBiZSB0byBzZXQgdGhlIGhhbmRsZXIgYWZ0ZXIgdGhlIGluaXRpYWwgcGFnZSBsb2FkCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NjMwNDAKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgd2luZG93Lm9ucG9wc3RhdGUgPSBvbmNoYW5nZTsKICAgICAgICB9LCA1MDApOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBvbmNoYW5nZTsKICAgICAgfQogICAgICB0aGlzLm1vZGUgPSAnbW9kZXJuJzsKICAgIH0KICAgIGVsc2UgewogICAgICAvLwogICAgICAvLyBJRSBzdXBwb3J0LCBiYXNlZCBvbiBhIGNvbmNlcHQgYnkgRXJpayBBcnZpZHNvbiAuLi4KICAgICAgLy8KICAgICAgdmFyIGZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgIGZyYW1lLmlkID0gJ3N0YXRlLWZyYW1lJzsKICAgICAgZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmcmFtZSk7CiAgICAgIHRoaXMud3JpdGVGcmFtZSgnJyk7CgogICAgICBpZiAoJ29ucHJvcGVydHljaGFuZ2UnIGluIGRvY3VtZW50ICYmICdhdHRhY2hFdmVudCcgaW4gZG9jdW1lbnQpIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgnb25wcm9wZXJ0eWNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChldmVudC5wcm9wZXJ0eU5hbWUgPT09ICdsb2NhdGlvbicpIHsKICAgICAgICAgICAgc2VsZi5jaGVjaygpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgeyBzZWxmLmNoZWNrKCk7IH0sIDUwKTsKCiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCA9IG9uY2hhbmdlOwogICAgICB0aGlzLm1vZGUgPSAnbGVnYWN5JzsKICAgIH0KCiAgICBSb3V0ZXIubGlzdGVuZXJzLnB1c2goZm4pOwoKICAgIHJldHVybiB0aGlzLm1vZGU7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAoIVJvdXRlciB8fCAhUm91dGVyLmxpc3RlbmVycykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGxpc3RlbmVycyA9IFJvdXRlci5saXN0ZW5lcnM7CgogICAgZm9yICh2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBmbikgewogICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICB9LAoKICBzZXRIYXNoOiBmdW5jdGlvbiAocykgewogICAgLy8gTW96aWxsYSBhbHdheXMgYWRkcyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeQogICAgaWYgKHRoaXMubW9kZSA9PT0gJ2xlZ2FjeScpIHsKICAgICAgdGhpcy53cml0ZUZyYW1lKHMpOwogICAgfQoKICAgIGlmICh0aGlzLmhpc3RvcnkgPT09IHRydWUpIHsKICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcyk7CiAgICAgIC8vIEZpcmUgYW4gb25wb3BzdGF0ZSBldmVudCBtYW51YWxseSBzaW5jZSBwdXNoaW5nIGRvZXMgbm90IG9idmlvdXNseQogICAgICAvLyB0cmlnZ2VyIHRoZSBwb3AgZXZlbnQuCiAgICAgIHRoaXMuZmlyZSgpOwogICAgfSBlbHNlIHsKICAgICAgZGxvYy5oYXNoID0gKHNbMF0gPT09ICcvJykgPyBzIDogJy8nICsgczsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIHdyaXRlRnJhbWU6IGZ1bmN0aW9uIChzKSB7CiAgICAvLyBJRSBzdXBwb3J0Li4uCiAgICB2YXIgZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0ZS1mcmFtZScpOwogICAgdmFyIGQgPSBmLmNvbnRlbnREb2N1bWVudCB8fCBmLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICBkLm9wZW4oKTsKICAgIGQud3JpdGUoIjxzY3JpcHQ+X2hhc2ggPSAnIiArIHMgKyAiJzsgb25sb2FkID0gcGFyZW50Lmxpc3RlbmVyLnN5bmNIYXNoOzxzY3JpcHQ+Iik7CiAgICBkLmNsb3NlKCk7CiAgfSwKCiAgc3luY0hhc2g6IGZ1bmN0aW9uICgpIHsKICAgIC8vIElFIHN1cHBvcnQuLi4KICAgIHZhciBzID0gdGhpcy5faGFzaDsKICAgIGlmIChzICE9IGRsb2MuaGFzaCkgewogICAgICBkbG9jLmhhc2ggPSBzOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb25IYXNoQ2hhbmdlZDogZnVuY3Rpb24gKCkge30KfTsKCnZhciBSb3V0ZXIgPSBleHBvcnRzLlJvdXRlciA9IGZ1bmN0aW9uIChyb3V0ZXMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUm91dGVyKSkgcmV0dXJuIG5ldyBSb3V0ZXIocm91dGVzKTsKCiAgdGhpcy5wYXJhbXMgICA9IHt9OwogIHRoaXMucm91dGVzICAgPSB7fTsKICB0aGlzLm1ldGhvZHMgID0gWydvbicsICdvbmNlJywgJ2FmdGVyJywgJ2JlZm9yZSddOwogIHRoaXMuc2NvcGUgICAgPSBbXTsKICB0aGlzLl9tZXRob2RzID0ge307CgogIHRoaXMuX2luc2VydCA9IHRoaXMuaW5zZXJ0OwogIHRoaXMuaW5zZXJ0ID0gdGhpcy5pbnNlcnRFeDsKCiAgdGhpcy5oaXN0b3J5U3VwcG9ydCA9ICh3aW5kb3cuaGlzdG9yeSAhPSBudWxsID8gd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlIDogbnVsbCkgIT0gbnVsbAoKICB0aGlzLmNvbmZpZ3VyZSgpOwogIHRoaXMubW91bnQocm91dGVzIHx8IHt9KTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChyKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuaGFuZGxlciA9IGZ1bmN0aW9uKG9uQ2hhbmdlRXZlbnQpIHsKICAgIHZhciBuZXdVUkwgPSBvbkNoYW5nZUV2ZW50ICYmIG9uQ2hhbmdlRXZlbnQubmV3VVJMIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgdmFyIHVybCA9IHNlbGYuaGlzdG9yeSA9PT0gdHJ1ZSA/IHNlbGYuZ2V0UGF0aCgpIDogbmV3VVJMLnJlcGxhY2UoLy4qIy8sICcnKTsKICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgdXJsKTsKICB9OwoKICBsaXN0ZW5lci5pbml0KHRoaXMuaGFuZGxlciwgdGhpcy5oaXN0b3J5KTsKCiAgaWYgKHRoaXMuaGlzdG9yeSA9PT0gZmFsc2UpIHsKICAgIGlmIChkbG9jSGFzaEVtcHR5KCkgJiYgcikgewogICAgICBkbG9jLmhhc2ggPSByOwogICAgfSBlbHNlIGlmICghZGxvY0hhc2hFbXB0eSgpKSB7CiAgICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgZGxvYy5oYXNoLnJlcGxhY2UoL14jLywgJycpKTsKICAgIH0KICB9CiAgZWxzZSB7CiAgICB2YXIgcm91dGVUbyA9IGRsb2NIYXNoRW1wdHkoKSAmJiByID8gciA6ICFkbG9jSGFzaEVtcHR5KCkgPyBkbG9jLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiBudWxsOwogICAgaWYgKHJvdXRlVG8pIHsKICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcm91dGVUbyk7CiAgICB9CgogICAgLy8gUm91dGVyIGhhcyBiZWVuIGluaXRpYWxpemVkLCBidXQgZHVlIHRvIHRoZSBjaHJvbWUgYnVnIGl0IHdpbGwgbm90CiAgICAvLyB5ZXQgYWN0dWFsbHkgcm91dGUgSFRNTDUgaGlzdG9yeSBzdGF0ZSBjaGFuZ2VzLiBUaHVzLCBkZWNpZGUgaWYgc2hvdWxkIHJvdXRlLgogICAgaWYgKHJvdXRlVG8gfHwgdGhpcy5ydW5faW5faW5pdCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLmhhbmRsZXIoKTsKICAgIH0KICB9CgogIHJldHVybiB0aGlzOwp9OwoKUm91dGVyLnByb3RvdHlwZS5leHBsb2RlID0gZnVuY3Rpb24gKCkgewogIHZhciB2ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlID8gdGhpcy5nZXRQYXRoKCkgOiBkbG9jLmhhc2g7CiAgaWYgKHYuY2hhckF0KDEpID09PSAnLycpIHsgdj12LnNsaWNlKDEpIH0KICByZXR1cm4gdi5zbGljZSgxLCB2Lmxlbmd0aCkuc3BsaXQoIi8iKTsKfTsKClJvdXRlci5wcm90b3R5cGUuc2V0Um91dGUgPSBmdW5jdGlvbiAoaSwgdiwgdmFsKSB7CiAgdmFyIHVybCA9IHRoaXMuZXhwbG9kZSgpOwoKICBpZiAodHlwZW9mIGkgPT09ICdudW1iZXInICYmIHR5cGVvZiB2ID09PSAnc3RyaW5nJykgewogICAgdXJsW2ldID0gdjsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHVybC5zcGxpY2UoaSwgdiwgcyk7CiAgfQogIGVsc2UgewogICAgdXJsID0gW2ldOwogIH0KCiAgbGlzdGVuZXIuc2V0SGFzaCh1cmwuam9pbignLycpKTsKICByZXR1cm4gdXJsOwp9OwoKLy8KLy8gIyMjIGZ1bmN0aW9uIGluc2VydEV4KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudCkKLy8gIyMjIyBAbWV0aG9kIHtzdHJpbmd9IE1ldGhvZCB0byBpbnNlcnQgdGhlIHNwZWNpZmljIGByb3V0ZWAuCi8vICMjIyMgQHBhdGgge0FycmF5fSBQYXJzZWQgcGF0aCB0byBpbnNlcnQgdGhlIGByb3V0ZWAgYXQuCi8vICMjIyMgQHJvdXRlIHtBcnJheXxmdW5jdGlvbn0gUm91dGUgaGFuZGxlcnMgdG8gaW5zZXJ0LgovLyAjIyMjIEBwYXJlbnQge09iamVjdH0gKipPcHRpb25hbCoqIFBhcmVudCAicm91dGVzIiB0byBpbnNlcnQgaW50by4KLy8gaW5zZXJ0IGEgY2FsbGJhY2sgdGhhdCB3aWxsIG9ubHkgb2NjdXIgb25jZSBwZXIgdGhlIG1hdGNoZWQgcm91dGUuCi8vClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0RXggPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlLCBwYXJlbnQpIHsKICBpZiAobWV0aG9kID09PSAib25jZSIpIHsKICAgIG1ldGhvZCA9ICJvbiI7CiAgICByb3V0ZSA9IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHZhciBvbmNlID0gZmFsc2U7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAob25jZSkgcmV0dXJuOwogICAgICAgIG9uY2UgPSB0cnVlOwogICAgICAgIHJldHVybiByb3V0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfShyb3V0ZSk7CiAgfQogIHJldHVybiB0aGlzLl9pbnNlcnQobWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KTsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0Um91dGUgPSBmdW5jdGlvbiAodikgewogIHZhciByZXQgPSB2OwoKICBpZiAodHlwZW9mIHYgPT09ICJudW1iZXIiKSB7CiAgICByZXQgPSB0aGlzLmV4cGxvZGUoKVt2XTsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKXsKICAgIHZhciBoID0gdGhpcy5leHBsb2RlKCk7CiAgICByZXQgPSBoLmluZGV4T2Yodik7CiAgfQogIGVsc2UgewogICAgcmV0ID0gdGhpcy5leHBsb2RlKCk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKUm91dGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIGxpc3RlbmVyLmRlc3Ryb3kodGhpcy5oYW5kbGVyKTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0UGF0aCA9IGZ1bmN0aW9uICgpIHsKICB2YXIgcGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsKICBpZiAocGF0aC5zdWJzdHIoMCwgMSkgIT09ICcvJykgewogICAgcGF0aCA9ICcvJyArIHBhdGg7CiAgfQogIHJldHVybiBwYXRoOwp9OwpmdW5jdGlvbiBfZXZlcnkoYXJyLCBpdGVyYXRvcikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBpZiAoaXRlcmF0b3IoYXJyW2ldLCBpLCBhcnIpID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBfZmxhdHRlbihhcnIpIHsKICB2YXIgZmxhdCA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBuID0gYXJyLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgZmxhdCA9IGZsYXQuY29uY2F0KGFycltpXSk7CiAgfQogIHJldHVybiBmbGF0Owp9CgpmdW5jdGlvbiBfYXN5bmNFdmVyeVNlcmllcyhhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogIGlmICghYXJyLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgfQogIHZhciBjb21wbGV0ZWQgPSAwOwogIChmdW5jdGlvbiBpdGVyYXRlKCkgewogICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyIHx8IGVyciA9PT0gZmFsc2UpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICBpZiAoY29tcGxldGVkID09PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KSgpOwp9CgpmdW5jdGlvbiBwYXJhbWlmeVN0cmluZyhzdHIsIHBhcmFtcywgbW9kKSB7CiAgbW9kID0gc3RyOwogIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgaWYgKHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgbW9kID0gcGFyYW1zW3BhcmFtXShzdHIpOwogICAgICBpZiAobW9kICE9PSBzdHIpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbW9kID09PSBzdHIgPyAiKFsuX2EtekEtWjAtOS1dKykiIDogbW9kOwp9CgpmdW5jdGlvbiByZWdpZnlTdHJpbmcoc3RyLCBwYXJhbXMpIHsKICB2YXIgbWF0Y2hlcywgbGFzdCA9IDAsIG91dCA9ICIiOwogIHdoaWxlIChtYXRjaGVzID0gc3RyLnN1YnN0cihsYXN0KS5tYXRjaCgvW15cd1xkXC0gJUAmXSpcKlteXHdcZFwtICVAJl0qLykpIHsKICAgIGxhc3QgPSBtYXRjaGVzLmluZGV4ICsgbWF0Y2hlc1swXS5sZW5ndGg7CiAgICBtYXRjaGVzWzBdID0gbWF0Y2hlc1swXS5yZXBsYWNlKC9eXCovLCAiKFtfLigpIVxcICVAJmEtekEtWjAtOS1dKykiKTsKICAgIG91dCArPSBzdHIuc3Vic3RyKDAsIG1hdGNoZXMuaW5kZXgpICsgbWF0Y2hlc1swXTsKICB9CiAgc3RyID0gb3V0ICs9IHN0ci5zdWJzdHIobGFzdCk7CiAgdmFyIGNhcHR1cmVzID0gc3RyLm1hdGNoKC86KFteXC9dKykvaWcpLCBsZW5ndGg7CiAgaWYgKGNhcHR1cmVzKSB7CiAgICBsZW5ndGggPSBjYXB0dXJlcy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKGNhcHR1cmVzW2ldLCBwYXJhbWlmeVN0cmluZyhjYXB0dXJlc1tpXSwgcGFyYW1zKSk7CiAgICB9CiAgfQogIHJldHVybiBzdHI7Cn0KCmZ1bmN0aW9uIHRlcm1pbmF0b3Iocm91dGVzLCBkZWxpbWl0ZXIsIHN0YXJ0LCBzdG9wKSB7CiAgdmFyIGxhc3QgPSAwLCBsZWZ0ID0gMCwgcmlnaHQgPSAwLCBzdGFydCA9IChzdGFydCB8fCAiKCIpLnRvU3RyaW5nKCksIHN0b3AgPSAoc3RvcCB8fCAiKSIpLnRvU3RyaW5nKCksIGk7CiAgZm9yIChpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIGNodW5rID0gcm91dGVzW2ldOwogICAgaWYgKGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpID4gY2h1bmsuaW5kZXhPZihzdG9wLCBsYXN0KSB8fCB+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgIX5jaHVuay5pbmRleE9mKHN0b3AsIGxhc3QpIHx8ICF+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgfmNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCkpIHsKICAgICAgbGVmdCA9IGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpOwogICAgICByaWdodCA9IGNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCk7CiAgICAgIGlmICh+bGVmdCAmJiAhfnJpZ2h0IHx8ICF+bGVmdCAmJiB+cmlnaHQpIHsKICAgICAgICB2YXIgdG1wID0gcm91dGVzLnNsaWNlKDAsIChpIHx8IDEpICsgMSkuam9pbihkZWxpbWl0ZXIpOwogICAgICAgIHJvdXRlcyA9IFsgdG1wIF0uY29uY2F0KHJvdXRlcy5zbGljZSgoaSB8fCAxKSArIDEpKTsKICAgICAgfQogICAgICBsYXN0ID0gKHJpZ2h0ID4gbGVmdCA/IHJpZ2h0IDogbGVmdCkgKyAxOwogICAgICBpID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGxhc3QgPSAwOwogICAgfQogIH0KICByZXR1cm4gcm91dGVzOwp9CgpSb3V0ZXIucHJvdG90eXBlLmNvbmZpZ3VyZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWV0aG9kcy5sZW5ndGg7IGkrKykgewogICAgdGhpcy5fbWV0aG9kc1t0aGlzLm1ldGhvZHNbaV1dID0gdHJ1ZTsKICB9CiAgdGhpcy5yZWN1cnNlID0gb3B0aW9ucy5yZWN1cnNlIHx8IHRoaXMucmVjdXJzZSB8fCBmYWxzZTsKICB0aGlzLmFzeW5jID0gb3B0aW9ucy5hc3luYyB8fCBmYWxzZTsKICB0aGlzLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICIvIjsKICB0aGlzLnN0cmljdCA9IHR5cGVvZiBvcHRpb25zLnN0cmljdCA9PT0gInVuZGVmaW5lZCIgPyB0cnVlIDogb3B0aW9ucy5zdHJpY3Q7CiAgdGhpcy5ub3Rmb3VuZCA9IG9wdGlvbnMubm90Zm91bmQ7CiAgdGhpcy5yZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgdGhpcy5oaXN0b3J5ID0gb3B0aW9ucy5odG1sNWhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5U3VwcG9ydCB8fCBmYWxzZTsKICB0aGlzLnJ1bl9pbl9pbml0ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlICYmIG9wdGlvbnMucnVuX2hhbmRsZXJfaW5faW5pdCAhPT0gZmFsc2U7CiAgdGhpcy5ldmVyeSA9IHsKICAgIGFmdGVyOiBvcHRpb25zLmFmdGVyIHx8IG51bGwsCiAgICBiZWZvcmU6IG9wdGlvbnMuYmVmb3JlIHx8IG51bGwsCiAgICBvbjogb3B0aW9ucy5vbiB8fCBudWxsCiAgfTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUucGFyYW0gPSBmdW5jdGlvbih0b2tlbiwgbWF0Y2hlcikgewogIGlmICh0b2tlblswXSAhPT0gIjoiKSB7CiAgICB0b2tlbiA9ICI6IiArIHRva2VuOwogIH0KICB2YXIgY29tcGlsZWQgPSBuZXcgUmVnRXhwKHRva2VuLCAiZyIpOwogIHRoaXMucGFyYW1zW3Rva2VuXSA9IGZ1bmN0aW9uKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNvbXBpbGVkLCBtYXRjaGVyLnNvdXJjZSB8fCBtYXRjaGVyKTsKICB9Owp9OwoKUm91dGVyLnByb3RvdHlwZS5vbiA9IFJvdXRlci5wcm90b3R5cGUucm91dGUgPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmICghcm91dGUgJiYgdHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgcm91dGUgPSBwYXRoOwogICAgcGF0aCA9IG1ldGhvZDsKICAgIG1ldGhvZCA9ICJvbiI7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHBhdGgpKSB7CiAgICByZXR1cm4gcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKHApIHsKICAgICAgc2VsZi5vbihtZXRob2QsIHAsIHJvdXRlKTsKICAgIH0pOwogIH0KICBpZiAocGF0aC5zb3VyY2UpIHsKICAgIHBhdGggPSBwYXRoLnNvdXJjZS5yZXBsYWNlKC9cXFwvL2lnLCAiLyIpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShtZXRob2QpKSB7CiAgICByZXR1cm4gbWV0aG9kLmZvckVhY2goZnVuY3Rpb24obSkgewogICAgICBzZWxmLm9uKG0udG9Mb3dlckNhc2UoKSwgcGF0aCwgcm91dGUpOwogICAgfSk7CiAgfQogIHBhdGggPSBwYXRoLnNwbGl0KG5ldyBSZWdFeHAodGhpcy5kZWxpbWl0ZXIpKTsKICBwYXRoID0gdGVybWluYXRvcihwYXRoLCB0aGlzLmRlbGltaXRlcik7CiAgdGhpcy5pbnNlcnQobWV0aG9kLCB0aGlzLnNjb3BlLmNvbmNhdChwYXRoKSwgcm91dGUpOwp9OwoKUm91dGVyLnByb3RvdHlwZS5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXMsIGZucyA9IHRoaXMudHJhdmVyc2UobWV0aG9kLCBwYXRoLCB0aGlzLnJvdXRlcywgIiIpLCBpbnZva2VkID0gdGhpcy5faW52b2tlZCwgYWZ0ZXI7CiAgdGhpcy5faW52b2tlZCA9IHRydWU7CiAgaWYgKCFmbnMgfHwgZm5zLmxlbmd0aCA9PT0gMCkgewogICAgdGhpcy5sYXN0ID0gW107CiAgICBpZiAodHlwZW9mIHRoaXMubm90Zm91bmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhpcy5pbnZva2UoWyB0aGlzLm5vdGZvdW5kIF0sIHsKICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICBwYXRoOiBwYXRoCiAgICAgIH0sIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHRoaXMucmVjdXJzZSA9PT0gImZvcndhcmQiKSB7CiAgICBmbnMgPSBmbnMucmV2ZXJzZSgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGVBbmRJbnZva2UoKSB7CiAgICBzZWxmLmxhc3QgPSBmbnMuYWZ0ZXI7CiAgICBzZWxmLmludm9rZShzZWxmLnJ1bmxpc3QoZm5zKSwgc2VsZiwgY2FsbGJhY2spOwogIH0KICBhZnRlciA9IHRoaXMuZXZlcnkgJiYgdGhpcy5ldmVyeS5hZnRlciA/IFsgdGhpcy5ldmVyeS5hZnRlciBdLmNvbmNhdCh0aGlzLmxhc3QpIDogWyB0aGlzLmxhc3QgXTsKICBpZiAoYWZ0ZXIgJiYgYWZ0ZXIubGVuZ3RoID4gMCAmJiBpbnZva2VkKSB7CiAgICBpZiAodGhpcy5hc3luYykgewogICAgICB0aGlzLmludm9rZShhZnRlciwgdGhpcywgdXBkYXRlQW5kSW52b2tlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaW52b2tlKGFmdGVyLCB0aGlzKTsKICAgICAgdXBkYXRlQW5kSW52b2tlKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdXBkYXRlQW5kSW52b2tlKCk7CiAgcmV0dXJuIHRydWU7Cn07CgpSb3V0ZXIucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uKGZucywgdGhpc0FyZywgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgaWYgKHRoaXMuYXN5bmMpIHsKICAgIF9hc3luY0V2ZXJ5U2VyaWVzKGZucywgZnVuY3Rpb24gYXBwbHkoZm4sIG5leHQpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm4pKSB7CiAgICAgICAgcmV0dXJuIF9hc3luY0V2ZXJ5U2VyaWVzKGZuLCBhcHBseSwgbmV4dCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBmbi5hcHBseSh0aGlzQXJnLCBmbnMuY2FwdHVyZXMuY29uY2F0KG5leHQpKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXNBcmcsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBfZXZlcnkoZm5zLCBmdW5jdGlvbiBhcHBseShmbikgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShmbikpIHsKICAgICAgICByZXR1cm4gX2V2ZXJ5KGZuLCBhcHBseSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNBcmcsIGZucy5jYXB0dXJlcyB8fCBbXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAic3RyaW5nIiAmJiBzZWxmLnJlc291cmNlKSB7CiAgICAgICAgc2VsZi5yZXNvdXJjZVtmbl0uYXBwbHkodGhpc0FyZywgZm5zLmNhcHR1cmVzIHx8IFtdKTsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKUm91dGVyLnByb3RvdHlwZS50cmF2ZXJzZSA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgcm91dGVzLCByZWdleHAsIGZpbHRlcikgewogIHZhciBmbnMgPSBbXSwgY3VycmVudCwgZXhhY3QsIG1hdGNoLCBuZXh0LCB0aGF0OwogIGZ1bmN0aW9uIGZpbHRlclJvdXRlcyhyb3V0ZXMpIHsKICAgIGlmICghZmlsdGVyKSB7CiAgICAgIHJldHVybiByb3V0ZXM7CiAgICB9CiAgICBmdW5jdGlvbiBkZWVwQ29weShzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdFtpXSA9IEFycmF5LmlzQXJyYXkoc291cmNlW2ldKSA/IGRlZXBDb3B5KHNvdXJjZVtpXSkgOiBzb3VyY2VbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RmlsdGVyKGZucykgewogICAgICBmb3IgKHZhciBpID0gZm5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zW2ldKSkgewogICAgICAgICAgYXBwbHlGaWx0ZXIoZm5zW2ldKTsKICAgICAgICAgIGlmIChmbnNbaV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGZucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZmlsdGVyKGZuc1tpXSkpIHsKICAgICAgICAgICAgZm5zLnNwbGljZShpLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBuZXdSb3V0ZXMgPSBkZWVwQ29weShyb3V0ZXMpOwogICAgbmV3Um91dGVzLm1hdGNoZWQgPSByb3V0ZXMubWF0Y2hlZDsKICAgIG5ld1JvdXRlcy5jYXB0dXJlcyA9IHJvdXRlcy5jYXB0dXJlczsKICAgIG5ld1JvdXRlcy5hZnRlciA9IHJvdXRlcy5hZnRlci5maWx0ZXIoZmlsdGVyKTsKICAgIGFwcGx5RmlsdGVyKG5ld1JvdXRlcyk7CiAgICByZXR1cm4gbmV3Um91dGVzOwogIH0KICBpZiAocGF0aCA9PT0gdGhpcy5kZWxpbWl0ZXIgJiYgcm91dGVzW21ldGhvZF0pIHsKICAgIG5leHQgPSBbIFsgcm91dGVzLmJlZm9yZSwgcm91dGVzW21ldGhvZF0gXS5maWx0ZXIoQm9vbGVhbikgXTsKICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlcy5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgIG5leHQubWF0Y2hlZCA9IHRydWU7CiAgICBuZXh0LmNhcHR1cmVzID0gW107CiAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogIH0KICBmb3IgKHZhciByIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyKSAmJiAoIXRoaXMuX21ldGhvZHNbcl0gfHwgdGhpcy5fbWV0aG9kc1tyXSAmJiB0eXBlb2Ygcm91dGVzW3JdID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShyb3V0ZXNbcl0pKSkgewogICAgICBjdXJyZW50ID0gZXhhY3QgPSByZWdleHAgKyB0aGlzLmRlbGltaXRlciArIHI7CiAgICAgIGlmICghdGhpcy5zdHJpY3QpIHsKICAgICAgICBleGFjdCArPSAiWyIgKyB0aGlzLmRlbGltaXRlciArICJdPyI7CiAgICAgIH0KICAgICAgbWF0Y2ggPSBwYXRoLm1hdGNoKG5ldyBSZWdFeHAoIl4iICsgZXhhY3QpKTsKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChtYXRjaFswXSAmJiBtYXRjaFswXSA9PSBwYXRoICYmIHJvdXRlc1tyXVttZXRob2RdKSB7CiAgICAgICAgbmV4dCA9IFsgWyByb3V0ZXNbcl0uYmVmb3JlLCByb3V0ZXNbcl1bbWV0aG9kXSBdLmZpbHRlcihCb29sZWFuKSBdOwogICAgICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgICAgICBuZXh0Lm1hdGNoZWQgPSB0cnVlOwogICAgICAgIG5leHQuY2FwdHVyZXMgPSBtYXRjaC5zbGljZSgxKTsKICAgICAgICBpZiAodGhpcy5yZWN1cnNlICYmIHJvdXRlcyA9PT0gdGhpcy5yb3V0ZXMpIHsKICAgICAgICAgIG5leHQucHVzaChbIHJvdXRlcy5iZWZvcmUsIHJvdXRlcy5vbiBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBuZXh0LmFmdGVyID0gbmV4dC5hZnRlci5jb25jYXQoWyByb3V0ZXMuYWZ0ZXIgXS5maWx0ZXIoQm9vbGVhbikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogICAgICB9CiAgICAgIG5leHQgPSB0aGlzLnRyYXZlcnNlKG1ldGhvZCwgcGF0aCwgcm91dGVzW3JdLCBjdXJyZW50KTsKICAgICAgaWYgKG5leHQubWF0Y2hlZCkgewogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZucyA9IGZucy5jb25jYXQobmV4dCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlY3Vyc2UpIHsKICAgICAgICAgIGZucy5wdXNoKFsgcm91dGVzW3JdLmJlZm9yZSwgcm91dGVzW3JdLm9uIF0uZmlsdGVyKEJvb2xlYW4pKTsKICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBpZiAocm91dGVzID09PSB0aGlzLnJvdXRlcykgewogICAgICAgICAgICBmbnMucHVzaChbIHJvdXRlc1siYmVmb3JlIl0sIHJvdXRlc1sib24iXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1siYWZ0ZXIiXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZucy5tYXRjaGVkID0gdHJ1ZTsKICAgICAgICBmbnMuY2FwdHVyZXMgPSBuZXh0LmNhcHR1cmVzOwogICAgICAgIGZucy5hZnRlciA9IG5leHQuYWZ0ZXI7CiAgICAgICAgcmV0dXJuIGZpbHRlclJvdXRlcyhmbnMpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24obWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KSB7CiAgdmFyIG1ldGhvZFR5cGUsIHBhcmVudFR5cGUsIGlzQXJyYXksIG5lc3RlZCwgcGFydDsKICBwYXRoID0gcGF0aC5maWx0ZXIoZnVuY3Rpb24ocCkgewogICAgcmV0dXJuIHAgJiYgcC5sZW5ndGggPiAwOwogIH0pOwogIHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLnJvdXRlczsKICBwYXJ0ID0gcGF0aC5zaGlmdCgpOwogIGlmICgvXDp8XCovLnRlc3QocGFydCkgJiYgIS9cXGR8XFx3Ly50ZXN0KHBhcnQpKSB7CiAgICBwYXJ0ID0gcmVnaWZ5U3RyaW5nKHBhcnQsIHRoaXMucGFyYW1zKTsKICB9CiAgaWYgKHBhdGgubGVuZ3RoID4gMCkgewogICAgcGFyZW50W3BhcnRdID0gcGFyZW50W3BhcnRdIHx8IHt9OwogICAgcmV0dXJuIHRoaXMuaW5zZXJ0KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudFtwYXJ0XSk7CiAgfQogIGlmICghcGFydCAmJiAhcGF0aC5sZW5ndGggJiYgcGFyZW50ID09PSB0aGlzLnJvdXRlcykgewogICAgbWV0aG9kVHlwZSA9IHR5cGVvZiBwYXJlbnRbbWV0aG9kXTsKICAgIHN3aXRjaCAobWV0aG9kVHlwZSkgewogICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgcGFyZW50W21ldGhvZF0gPSBbIHBhcmVudFttZXRob2RdLCByb3V0ZSBdOwogICAgICByZXR1cm47CiAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgcGFyZW50W21ldGhvZF0ucHVzaChyb3V0ZSk7CiAgICAgIHJldHVybjsKICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICBwYXJlbnRbbWV0aG9kXSA9IHJvdXRlOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm47CiAgfQogIHBhcmVudFR5cGUgPSB0eXBlb2YgcGFyZW50W3BhcnRdOwogIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KHBhcmVudFtwYXJ0XSk7CiAgaWYgKHBhcmVudFtwYXJ0XSAmJiAhaXNBcnJheSAmJiBwYXJlbnRUeXBlID09ICJvYmplY3QiKSB7CiAgICBtZXRob2RUeXBlID0gdHlwZW9mIHBhcmVudFtwYXJ0XVttZXRob2RdOwogICAgc3dpdGNoIChtZXRob2RUeXBlKSB7CiAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXSA9IFsgcGFyZW50W3BhcnRdW21ldGhvZF0sIHJvdXRlIF07CiAgICAgIHJldHVybjsKICAgICBjYXNlICJvYmplY3QiOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXS5wdXNoKHJvdXRlKTsKICAgICAgcmV0dXJuOwogICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgIHBhcmVudFtwYXJ0XVttZXRob2RdID0gcm91dGU7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHBhcmVudFR5cGUgPT0gInVuZGVmaW5lZCIpIHsKICAgIG5lc3RlZCA9IHt9OwogICAgbmVzdGVkW21ldGhvZF0gPSByb3V0ZTsKICAgIHBhcmVudFtwYXJ0XSA9IG5lc3RlZDsKICAgIHJldHVybjsKICB9CiAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdXRlIGNvbnRleHQ6ICIgKyBwYXJlbnRUeXBlKTsKfTsKCgoKUm91dGVyLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihtZXRob2RzKSB7CiAgdmFyIHNlbGYgPSB0aGlzLCBsZW4gPSBtZXRob2RzLmxlbmd0aCwgaTsKICBmdW5jdGlvbiBleHRlbmQobWV0aG9kKSB7CiAgICBzZWxmLl9tZXRob2RzW21ldGhvZF0gPSB0cnVlOwogICAgc2VsZlttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBleHRyYSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBbIG1ldGhvZCwgIiIgXSA6IFsgbWV0aG9kIF07CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CiAgfQogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgZXh0ZW5kKG1ldGhvZHNbaV0pOwogIH0KfTsKClJvdXRlci5wcm90b3R5cGUucnVubGlzdCA9IGZ1bmN0aW9uKGZucykgewogIHZhciBydW5saXN0ID0gdGhpcy5ldmVyeSAmJiB0aGlzLmV2ZXJ5LmJlZm9yZSA/IFsgdGhpcy5ldmVyeS5iZWZvcmUgXS5jb25jYXQoX2ZsYXR0ZW4oZm5zKSkgOiBfZmxhdHRlbihmbnMpOwogIGlmICh0aGlzLmV2ZXJ5ICYmIHRoaXMuZXZlcnkub24pIHsKICAgIHJ1bmxpc3QucHVzaCh0aGlzLmV2ZXJ5Lm9uKTsKICB9CiAgcnVubGlzdC5jYXB0dXJlcyA9IGZucy5jYXB0dXJlczsKICBydW5saXN0LnNvdXJjZSA9IGZucy5zb3VyY2U7CiAgcmV0dXJuIHJ1bmxpc3Q7Cn07CgpSb3V0ZXIucHJvdG90eXBlLm1vdW50ID0gZnVuY3Rpb24ocm91dGVzLCBwYXRoKSB7CiAgaWYgKCFyb3V0ZXMgfHwgdHlwZW9mIHJvdXRlcyAhPT0gIm9iamVjdCIgfHwgQXJyYXkuaXNBcnJheShyb3V0ZXMpKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBzZWxmID0gdGhpczsKICBwYXRoID0gcGF0aCB8fCBbXTsKICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHsKICAgIHBhdGggPSBwYXRoLnNwbGl0KHNlbGYuZGVsaW1pdGVyKTsKICB9CiAgZnVuY3Rpb24gaW5zZXJ0T3JNb3VudChyb3V0ZSwgbG9jYWwpIHsKICAgIHZhciByZW5hbWUgPSByb3V0ZSwgcGFydHMgPSByb3V0ZS5zcGxpdChzZWxmLmRlbGltaXRlciksIHJvdXRlVHlwZSA9IHR5cGVvZiByb3V0ZXNbcm91dGVdLCBpc1JvdXRlID0gcGFydHNbMF0gPT09ICIiIHx8ICFzZWxmLl9tZXRob2RzW3BhcnRzWzBdXSwgZXZlbnQgPSBpc1JvdXRlID8gIm9uIiA6IHJlbmFtZTsKICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIHJlbmFtZSA9IHJlbmFtZS5zbGljZSgocmVuYW1lLm1hdGNoKG5ldyBSZWdFeHAoc2VsZi5kZWxpbWl0ZXIpKSB8fCBbICIiIF0pWzBdLmxlbmd0aCk7CiAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICB9CiAgICBpZiAoaXNSb3V0ZSAmJiByb3V0ZVR5cGUgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KHJvdXRlc1tyb3V0ZV0pKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHBhcnRzKTsKICAgICAgc2VsZi5tb3VudChyb3V0ZXNbcm91dGVdLCBsb2NhbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHJlbmFtZS5zcGxpdChzZWxmLmRlbGltaXRlcikpOwogICAgICBsb2NhbCA9IHRlcm1pbmF0b3IobG9jYWwsIHNlbGYuZGVsaW1pdGVyKTsKICAgIH0KICAgIHNlbGYuaW5zZXJ0KGV2ZW50LCBsb2NhbCwgcm91dGVzW3JvdXRlXSk7CiAgfQogIGZvciAodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgaW5zZXJ0T3JNb3VudChyb3V0ZSwgcGF0aC5zbGljZSgwKSk7CiAgICB9CiAgfQp9OwoKCgp9KHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IiA/IGV4cG9ydHMgOiB3aW5kb3cpKTsKZGVmaW5lKCJmbGF0aXJvbi9kaXJlY3RvciIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLlJvdXRlcjsKICAgIH07Cn0odGhpcykpKTsKCmRlZmluZSgndGhydXN0L3NwYS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QnLCAndGhydXN0L2xvZycsICdoYXMnLCAnZmxhdGlyb24vZGlyZWN0b3InLCAndGhydXN0L2luc3RhbmNlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX3RocnVzdF9fLCBfX2xvZ19fLCBfX2hhc19fLCBfX2ZsYXRpcm9uUm91dGVyX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciB0aHJ1c3QgPSBfX3RocnVzdF9fOwoKICAgIHZhciBUaHJ1c3QgPSB0aHJ1c3QuVGhydXN0OwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZsYXRpcm9uUm91dGVyID0gX19mbGF0aXJvblJvdXRlcl9fOwoKICAgIHZhciBSb3V0ZXIgPSBmbGF0aXJvblJvdXRlci5Sb3V0ZXIgfHwgZmxhdGlyb25Sb3V0ZXI7CiAgICAKICAgIHZhciBpbnN0YW5jZSA9IF9faW5zdGFuY2VfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdTaW5nbGVQYWdlQXBwbGljYXRpb24nOwogICAgY29uZmlnOwogICAgdmFyIGVhY2ggPSBfLmVhY2gsIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc1JlZ0V4cCA9IF8uaXNSZWdFeHAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBvbmNlID0gXy5vbmNlLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpbnZva2UgPSBfLmludm9rZSwgcGx1Y2sgPSBfLnBsdWNrLCBtYXAgPSBfLm1hcCwgZGVmZXIgPSBfLmRlZmVyLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgdG9BcnJheSA9IF8udG9BcnJheSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIFNUQVJUID0gJ3N0YXJ0JzsKICAgIHZhciBleHRyYWN0UGFyYW1zID0gZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdLCBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKSwgc2xhc2hJbmRleDsKICAgICAgICB3aGlsZShpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5pbmRleE9mKCcvJywgaW5kZXgpOwogICAgICAgICAgICBpZihzbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChyb3V0ZS5zdWJzdHJpbmcoaW5kZXgsIHNsYXNoSW5kZXggLSBpbmRleCArIDEpKTsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHJpbmcoc2xhc2hJbmRleCk7CiAgICAgICAgICAgIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgfTsKICAgIHZhciBldmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoZXZlbnQsIG1lZGlhdG9yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEKICAgIEBjbGFzcyB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvck1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IGluc3RhbmNlIG1lZGlhdG9yCiAgICAqKi8KICAgIHZhciBTaW5nbGVQYWdlQXBwbGljYXRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbihjb25maWcsIGluc3RhbmNlTmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5zdGFydGluZ01vZHVsZVByb21pc2UgPSBudWxsOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuYmFzZVVybCA9IGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdmFyIHNwYUNvbmZpZyA9IGNvbmZpZy5zcGE7CiAgICAgICAgICAgIHRoYXQuZmlsZUV4dGVuc2lvbiA9IHNwYUNvbmZpZy5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICB2YXIgcm91dGVzID0gdGhhdC5jb25maWd1cmVSb3V0ZXMoc3BhQ29uZmlnLnJvdXRlcyksIHBhcmFtcyA9IHNwYUNvbmZpZy5wYXJhbXM7CiAgICAgICAgICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0ZpcmluZyBzcGEgInswfSIgd2l0aCBbezF9XScsIGV2ZW50LCB0b0FycmF5KGFyZ3VtZW50cykuam9pbignLCcpKSk7CiAgICAgICAgICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciByb3V0ZXIgPSB0aGF0LnJvdXRlciA9IG5ldyBSb3V0ZXIocm91dGVzKS5jb25maWd1cmUoewogICAgICAgICAgICAgICAgcmVjdXJzZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzdHJpY3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgaHRtbDVoaXN0b3J5OiB0cnVlLAogICAgICAgICAgICAgICAgbm90Zm91bmQ6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ub3Rmb3VuZCcpLAogICAgICAgICAgICAgICAgYmVmb3JlOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYmVmb3JlJyksCiAgICAgICAgICAgICAgICBvbjogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL3J1bicpLAogICAgICAgICAgICAgICAgYWZ0ZXI6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9hZnRlcicpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBfLmVhY2gocGFyYW1zLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcm91dGVyLnBhcmFtKGksIHgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFN0YXJ0IHRoZSBzaW5nbGUgcGFnZSBhcHAgcm91dGVyLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICAgICAqKi8KICAgICAgICAgICAgdGhhdC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQudGhydXN0ID0gaW5zdGFuY2UuZ2V0SW5zdGFuY2UoaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgICAgIHRoYXQucm91dGVyLmluaXQoKTsKICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMoJ3RocnVzdC9zcGEvc3RhcnQnKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICB9CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5uYXZpZ2F0ZSA9IC8qKgogICAgICAgIE5hdmlnYXRlcyB0byB0aGUgZ2l2ZW4gdXJsLgogICAgICAgIAogICAgICAgIEBtZXRob2QgbmF2aWdhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbG9jYXRpb24gVGhlIGxvY2F0aW9uIHRvIG5hdmlnYXRlIHRvLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChsb2NhdGlvbikgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciB1cmwgPSB1dGlsLmZpeHVwVXJsKGxvY2F0aW9uLCB0aGF0LmJhc2VVcmwpOwogICAgICAgICAgICB0aGF0LnJvdXRlci5zZXRSb3V0ZSh1cmwpOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBzaW5nbGUgcGFnZSBhcHAgcm91dGVyLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMudGhydXN0ID0gaW5zdGFuY2UuZ2V0SW5zdGFuY2UodGhpcy5pbnN0YW5jZU5hbWUpOwogICAgICAgICAgICB0aGlzLnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgIHRoaXMudGhydXN0Lm1lZGlhdG9yLmZpcmUuYXN5bmMoJ3RocnVzdC9zcGEvc3RhcnQnKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuY29uZmlndXJlUm91dGVzID0gLyoqCiAgICAgICAgQ29uZmlndXJlcyB0aGUgcm91dGUgb2JqZWN0IGZvciB0aGUgc3BhIGluc3RhbmNlCiAgICAgICAgCiAgICAgICAgUm91dGVzIGNhbiBiZSBpbiA0IGZvcm1zCiAgICAgICAgCiAgICAgICAgewogICAgICAgICcvcGF0aC90by86Zm9vJzogJ3BhdGgvdG8vbW9kdWxlJywKICAgICAgICAnL3BhdGgvdG8vOmJhcic6IFsncGF0aC90by9tb2R1bGUxJywgJ3BhdGgvdG8vbW9kdWxlMiddLAogICAgICAgICcvcGF0aC90by86ZmInOiB7IHBhdGg6ICdwYXRoL3RvL21vZHVsZScsIGFyZ3M6IFsnYXJncycsICd0bycsICdoYW5kIG9mZiB0byBzdGFydCddIH0KICAgICAgICAnL3BhdGgvdG8vOmZvby86YmFyJzogZnVuY3Rpb24oZm9vLCBiYXIpeyAgY3VzdG9tIGhhbmRsZXIgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvbmZpZ3VyZVJvdXRlcwogICAgICAgIEBwYXJhbSB7T2JqZWN0fSByb3V0ZXMgT2JqZWN0IG9mIHJvdXRlcy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocm91dGVzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgY29uZmlndXJlZFJvdXRlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gZWFjaChyb3V0ZXMsIGZ1bmN0aW9uICh2YWx1ZSwgcm91dGUpIHsKICAgICAgICAgICAgZm9yKHZhciByb3V0ZSBpbiByb3V0ZXMpIHsKICAgICAgICAgICAgICAgIGlmKF8uaGFzKHJvdXRlcywgcm91dGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcm91dGVzW3JvdXRlXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVhbFJvdXRlID0gdXRpbC5maXh1cFVybChyb3V0ZSwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgICAgICAgICBpZihpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSBbXSwgbWV0aG9kcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9IHZhbHVlW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcodikgfHwgaXNPYmplY3QodikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNGdW5jdGlvbih2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHMucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlQ2FsbGJhY2sgPSB0aGF0Lm1vZHVsZVN0YXJ0Q2FsbGJhY2socm91dGUsIG1vZHVsZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2gobW9kdWxlQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtZXRob2RzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IG1vZHVsZUNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvL30pOwogICAgICAgICAgICByZXR1cm4gY29uZmlndXJlZFJvdXRlczsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubW9kdWxlU3RhcnRDYWxsYmFjayA9IC8qKgogICAgICAgIAogICAgICAgIEBtZXRob2QgbW9kdWxlU3RhcnRDYWxsYmFjawogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmcgfCBBcnJheSB8IE9iamVjdH0gbW9kdWxlcyBTdHJpbmcgdG8gc3RhcnQgYSBzaW5nbGUgbW9kdWxlLCBBcnJheSB0byBzdGFydCBtYW55IG1vZHVsZXMsIE9iamVjdCB0byBzdGFydCBhIG1vZHVsZSB3aXRoIHNwZWNpZmljIGFyZ3VtZW50cy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocm91dGUsIG1vZHVsZXMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwgcGFyYW1zID0gZXh0cmFjdFBhcmFtcyhyb3V0ZSksIHRoYXQgPSB0aGlzLCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICBpZihpc09iamVjdChtb2R1bGVzKSkgewogICAgICAgICAgICAgICAgYXJncyA9IG1vZHVsZXMuYXJncyB8fCBhcmdzOwogICAgICAgICAgICAgICAgbW9kdWxlcyA9IG1vZHVsZXMucGF0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihpc1N0cmluZyhtb2R1bGVzKSkgewogICAgICAgICAgICAgICAgbW9kdWxlcyA9IFsKICAgICAgICAgICAgICAgICAgICBtb2R1bGVzCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXIgPSB0b0FycmF5KGFyZ3VtZW50cyksIHRocnVzdCA9IHRoYXQudGhydXN0LCBtYXBwZWRNb2R1bGVzID0gbWFwKG1vZHVsZXMsIGZ1bmN0aW9uIChtb2R1bGVQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZHVjZShhciwgZnVuY3Rpb24gKG1lbW8sIGFyZywgaSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVtby5yZXBsYWNlKHBhcmFtc1tpXSwgYXJnLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIH0sIG1vZHVsZVBhdGgpLnJlcGxhY2UoZmlsZUV4dGVuc2lvbiwgJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRocnVzdC5zdGFydC5hcHBseSh0aHJ1c3QsIFsKICAgICAgICAgICAgICAgICAgICBtYXBwZWRNb2R1bGVzCiAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICBpZighdGhhdC50aHJ1c3Quc3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocnVzdC5yZWFkeShtYXBwZWRNb2R1bGVzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gcHJvbWlzZTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgSGFuZHMgdGhlIG5hdmlnYXRlIG1ldGhvZCBvZmYgdG8gdGhlIG1vZHVsZSwgc28gYW55IG1vZHVsZSBjYW4gdHJpZ2dlciBhIG5hdmlnYXRpb24gZXZlbnQuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZCBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKG1vZC5uYXZpZ2F0ZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibmF2aWdhdGUiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBbHJlYWR5IHByZSBib3VuZCwgc28gd2Ugb25seSBwYXNzIGFyb3VuZCAxIGZ1bmN0aW9uIHBlciBpbnN0YW5jZS4KICAgICAgICAgICAgbW9kLm5hdmlnYXRlID0gdGhhdC5uYXZpZ2F0ZS5iaW5kKHRoYXQpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLlNpbmdsZVBhZ2VBcHBsaWNhdGlvbiA9IFNpbmdsZVBhZ2VBcHBsaWNhdGlvbjsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhJywgWyd0aHJ1c3Qvc3BhL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Length": "646925",
                    "Date": "Sat, 08 Nov 2014 20:05:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}