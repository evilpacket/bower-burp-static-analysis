{
    "url": "http://localhost:9999/monaca/monaca-component-jquery-mobile/jquery.mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/monaca/monaca-component-jquery-mobile/jquery.mobile.js",
                "path": "/monaca/monaca-component-jquery-mobile/jquery.mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tb25hY2EvbW9uYWNhLWNvbXBvbmVudC1qcXVlcnktbW9iaWxlL2pxdWVyeS5tb2JpbGUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzU5MDA1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDE2OjI2OjE0IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAxNjoyNjoxNCBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBNb24gQXByIDggMjAxMyAxOTo0MToyOCBVVEMKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwoqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCioKKi8KCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkICkgewoJJC5tb2JpbGUgPSB7fTsKfSggalF1ZXJ5ICkpOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4zLjEiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudCdzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKCB0aGlzICkudGV4dCgpICkuaHRtbCgpOwoJfTsKCgkvLyBmbHVlbnQgaGVscGVyIGZ1bmN0aW9uIGZvciB0aGUgbW9iaWxlIG5hbWVzcGFjZWQgZXF1aXZhbGVudAoJJC5mbi5qcW1FbmhhbmNlYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJfTsKCgkkLmZuLmpxbUhpamFja2FibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJfTsKCgkvLyBNb25rZXktcGF0Y2hpbmcgU2l6emxlIHRvIGZpbHRlciB0aGUgOmpxbURhdGEgc2VsZWN0b3IKCXZhciBvbGRGaW5kID0gJC5maW5kLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9Owp9KSggalF1ZXJ5LCB0aGlzICk7CgoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgdjEuMTAuMHByZSAtIDIwMTItMTEtMTMgKGZmMDU1YTBjMzUzYzNjOGNlNmU1YmZhMDdhZDdjYjAzZTg4ODViYzUpCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggOiBuYW1lCgl9LCBwcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9LAoKCXJhaXNlOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93ICJXaWRnZXQgWyIgKyB0aGlzLndpZGdldE5hbWUgKyAiXTogIiArIG1zZzsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBERVBSRUNBVEVECgkvLyBOT1RFIGdsb2JhbCBtb2JpbGUgb2JqZWN0IHNldHRpbmdzCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBERVBSRUNBVEVEIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgZGVmYXVsdCBtZXNzYWdlIHNldHRpbmcKCQlsb2FkaW5nTWVzc2FnZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVECgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ3Nob3cnLCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKTsKCQl9LAoKCQkvLyBERVBSRUNBVEVECgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ2hpZGUnICk7CgkJfSwKCgkJbG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCXRoaXMubG9hZGVyV2lkZ2V0LmxvYWRlci5hcHBseSggdGhpcy5sb2FkZXJXaWRnZXQsIGFyZ3VtZW50cyApOwoJCX0KCX0pOwoKCS8vIFRPRE8gbW92ZSBsb2FkZXIgY2xhc3MgZG93biBpbnRvIHRoZSB3aWRnZXQgc2V0dGluZ3MKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLCAkaHRtbCA9ICQoICJodG1sIiApLCAkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgJGhlYWRlciwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSh0aGVtZSkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJLy8gcHJlZmVyIG9iamVjdCBwcm9wZXJ0eSBmcm9tIHRoZSBwYXJhbSB0aGVuIHRoZSBvbGQgdGhlbWUgc2V0dGluZwoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbSB2YWx1ZSBwYXNzZWQgYXMgYSBzdHJpbmcgYXJndW1lbnQsIHRoZW4KCQkJCS8vIHdlIHByZWZlciB0aGUgZ2xvYmFsIG9wdGlvbiBiZWNhdXNlIHdlIGNhbid0IHVzZSB1bmRlZmluZWQgZGVmYXVsdAoJCQkJLy8gcHJvdG90eXBlIG9wdGlvbnMsIHRoZW4gdGhlIHByb3RvdHlwZSBvcHRpb24KCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgfHwgbG9hZFNldHRpbmdzLnRleHQ7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSAhPT0gZmFsc2UgfHwgbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkvLyBib29sZWFuIHZhbHVlcyByZXF1aXJlIGEgYml0IG1vcmUgd29yayA6UCwgc3VwcG9ydHMgb2JqZWN0IHByb3BlcnRpZXMKCQkJCS8vIGFuZCBvbGQgc2V0dGluZ3MKCQkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRleHRWaXNpYmxlID0gJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgkJCQl9CgoJCQkJLy8gYWRkIHRoZSBwcm9wZXIgY3NzIGdpdmVuIHRoZSBvcHRpb25zICh0aGVtZSwgdGV4dCwgZXRjKQoJCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoImNsYXNzIiwgbG9hZGVyQ2xhc3MgKwoJCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJCSggbG9hZFNldHRpbmdzLnRleHRvbmx5IHx8IHRleHRvbmx5ID8gIiB1aS1sb2FkZXItdGV4dG9ubHkiIDogIiIgKSApOwoKCQkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCQkvLyBpZiB0aGUgaHRtbCBhdHRyaWJ1dGUgaXMgZGVmaW5lZCBvbiB0aGUgbG9hZGluZyBzZXR0aW5ncywgdXNlIHRoYXQKCQkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJCXRoaXMuZWxlbWVudC5odG1sKCBsb2FkU2V0dGluZ3MuaHRtbCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJCX0KCgkJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkvLyBjaGVjayB0aGF0IHRoZSBsb2FkZXIgaXMgdmlzaWJsZQoJCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJCSR3aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbiggdmFsICkgeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICB3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCkgewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKTsKCglpZiggcmV0ICkgewoJCXJldHVybiAhIXJldDsKCX0KCgl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXRyYW5zZm9ybXMgPSB7CgkJCS8vIFdl4oCZcmUgb21pdHRpbmcgT3BlcmEgZm9yIHRoZSB0aW1lIGJlaW5nOyBNUyB1c2VzIHVucHJlZml4ZWQuCgkJCSdNb3pUcmFuc2Zvcm0nOictbW96LXRyYW5zZm9ybScsCgkJCSd0cmFuc2Zvcm0nOid0cmFuc2Zvcm0nCgkJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdmFyIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAndHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApJzsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7Cgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8CgkJdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicsIFsgIldlYmtpdCIsICJNb3oiLCAiIiBdICkgJiYKCQkhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAhb3BlcmEsCgoJLy8gTm90ZSwgQ2hyb21lIGZvciBpT1MgaGFzIGFuIGV4dHJlbWVseSBxdWlya3kgaW1wbGVtZW50YXRpb24gb2YgcG9wc3RhdGUuCgkvLyBXZSd2ZSBjaG9zZW4gdG8gdGFrZSB0aGUgc2hvcnRlc3QgcGF0aCB0byBhIGJ1ZyBmaXggaGVyZSBmb3IgaXNzdWUgIzU0MjYKCS8vIFNlZSB0aGUgZm9sbG93aW5nIGxpbmsgZm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSByZWdleCBjaG9zZW4KCS8vIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2Nocm9tZS9tb2JpbGUvZG9jcy91c2VyLWFnZW50I2Nocm9tZV9mb3JfaW9zX3VzZXItYWdlbnQKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCSJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkvLyBXaGVuIHJ1bm5pbmcgaW5zaWRlIGEgRkYgaWZyYW1lLCBjYWxsaW5nIHJlcGxhY2VTdGF0ZSBjYXVzZXMgYW4gZXJyb3IKCQkhKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiRmlyZWZveCIgKSA+PSAwICYmIHdpbmRvdy50b3AgIT09IHdpbmRvdyApICYmCgkJKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5zZWFyY2goL0NyaU9TLykgPT09IC0xICksCgoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsIGhpc3Rvcnk7CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30sCgkJCQlocmVmID0gbG9jYXRpb24uaHJlZjsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBkYXRhICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2VzICkgewoJCQlpZiggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICl7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgZG9jdW1lbnRCYXNlLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBzdGF0ZSwgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCXBhdGguZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCX07CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGg7CgoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2JhY2snICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2ZvcndhcmQnICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICl7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJaW5pdGlhbEhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCSQubW9iaWxlLk5hdmlnYXRvciA9IGZ1bmN0aW9uKCBoaXN0b3J5ICkgewoJCXRoaXMuaGlzdG9yeSA9IGhpc3Rvcnk7CgkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IHRydWU7CgoJCSQubW9iaWxlLndpbmRvdy5iaW5kKHsKCQkJInBvcHN0YXRlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLnBvcHN0YXRlLCB0aGlzICksCgkJCSJoYXNoY2hhbmdlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLmhhc2hjaGFuZ2UsIHRoaXMgKQoJCX0pOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5OYXZpZ2F0b3IucHJvdG90eXBlLCB7CgkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2ggPSBwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5zdHJpcEhhc2godXJsKSA6IHVybDsKCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBtYWtlIHN1cmUgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uIHdoZW4gaXQgaXNuJ3QgZXhwbGljaXRseSBzZXQgaW4gdGhlCgkJCS8vIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCB0byB0aGUgc3F1YXNoIG1ldGhvZAoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXZhciByZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXRoaXMuc3F1YXNoKCB1cmwsIHN0YXRlICk7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBhY3RpdmUsIGhhc2gsIHN0YXRlLCBjbG9zZXN0SW5kZXg7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKXsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCkge30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKTsKCgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCQlpZiAoIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQl9CgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgoJCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICkKCQkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wICk7CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IHdpbi53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCBlICkgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudC5wYXJlbnQoKSApICk7Cgl9LAoKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudG9nZ2xlQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQtdHJhbnNpdGlvbmluZyB2aWV3cG9ydC0iICsgbmFtZSApOwoJCQl9LAoJCQlzY3JvbGxQYWdlID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRvU2Nyb2xsICk7CgoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCQl9LCAxNTAgKTsKCQkJfSwKCQkJY2xlYW5Gcm9tID0gZnVuY3Rpb24oKSB7CgkJCQkkZnJvbQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCQkJfSwKCQkJc3RhcnRPdXQgPSBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgkJCQkJZG9uZU91dCgpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVPdXQgKTsKCQkJCX0KCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy8gTk9URTogcGF0aCBleHRlbnNpb25zIGRlcGVuZGVudCBvbiBjb3JlIGF0dHJpYnV0ZXMuIE1vdmVkIGhlcmUgdG8gcmVtb3ZlIGRlcHMgZnJvbQoJCS8vICAgICAgICQubW9iaWxlLnBhdGggZGVmaW5pdGlvbgoJCXBhdGggPSAkLmV4dGVuZCgkLm1vYmlsZS5wYXRoLCB7CgoJCQkvL3JldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcgYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAnJicgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy9jaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZCBvZiB0aGUKCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCWRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9KSwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbCwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLmRvY3VtZW50VXJsLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9IHBhdGguZG9jdW1lbnRCYXNlLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9IHBhdGguZG9jdW1lbnRCYXNlRGlmZmVycywKCgkJZ2V0U2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0OwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoaHJlZikuaHJlZk5vSGFzaDsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBwYXRoLmdldERvY3VtZW50QmFzZTsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCQlpZiAoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgPSBmdW5jdGlvbiByZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIGhlaWdodCApIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKT8gaGVpZ2h0IDogZ2V0U2NyZWVuSGVpZ2h0KCk7CgkJCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGhlaWdodCAtIGFQYWdlUGFkVCAtIGFQYWdlUGFkQiAtIGFQYWdlQm9yZGVyVCAtIGFQYWdlQm9yZGVyQiApOwoJfTsKCgkvL3NoYXJlZCBwYWdlIGVuaGFuY2VtZW50cwoJZnVuY3Rpb24gZW5oYW5jZVBhZ2UoICRwYWdlLCByb2xlICkgewoJCS8vIElmIGEgcm9sZSB3YXMgc3BlY2lmaWVkLCBtYWtlIHN1cmUgdGhlIGRhdGEtcm9sZSBhdHRyaWJ1dGUKCQkvLyBvbiB0aGUgcGFnZSBlbGVtZW50IGlzIGluIHN5bmMuCgkJaWYgKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJZnVuY3Rpb24gZmluZEJhc2VXaXRoRGVmYXVsdCgpIHsKCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCX0KCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSAkKCB0aGlzICk7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfTsKCgkvLyBMb2FkIGEgcGFnZSBpbnRvIHRoZSBET00uCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkvLyBrbm93IHdoZW4gdGhlIHBhZ2UgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkJLy8gVGhlIGRlZmF1bHQgbG9hZFBhZ2Ugb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkKCQkJLy8gdGhlIGNhbGxlci4KCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgoJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBwYWdlIGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJcGFnZSA9IG51bGwsCgoJCQkvLyBJZiB0aGUgcmVsb2FkUGFnZSBvcHRpb24gaXMgdHJ1ZSwgYW5kIHRoZSBwYWdlIGlzIGFscmVhZHkKCQkJLy8gaW4gdGhlIERPTSwgZHVwQ2FjaGVkUGFnZSB3aWxsIGJlIHNldCB0byB0aGUgcGFnZSBlbGVtZW50CgkJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHJlbW92ZWQgYWZ0ZXIgdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZQoJCQkvLyBwYWdlIGlzIGxvYWRlZCBvZmYgdGhlIG5ldHdvcmsuCgkJCWR1cENhY2hlZFBhZ2UgPSBudWxsLAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJc2V0dGluZ3MucmVsb2FkUGFnZSA9IHRydWU7CgkJfQoKCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3VicGFnZSBwYXJhbXMuCgkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIHBhZ2UgdG8gYmUgbG9hZGVkLgoJCXZhciBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggYWJzVXJsICksCgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBwYWdlLiBGb3IgZW1iZWRkZWQgcGFnZXMsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IgcGFnZXMKCQkJLy8gd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUgcmVsYXRpdmUKCQkJLy8gcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBwYWdlcyAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgcGFnZS4KCQkJZGF0YVVybCA9IHBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzVXJsICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzdWVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhIGRhdGEtdXJsCgkJLy8gYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICIjIiArIGRhdGFVcmwgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBkYXRhVXJsICkKCQkJCS5qcW1EYXRhKCAidXJsIiwgZGF0YVVybCApOwoJCX0KCgkJCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UKCQkvLyB0byB0aGUgZmlyc3QgcGFnZSBhbmQgcmVmZXJzIHRvIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlLCBlcnJvciBvdXQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UgJiYgcGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICkgewoJCQkJLy8gQ2hlY2sgdG8gbWFrZSBzdXJlIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseQoJCQkJLy8gaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0CgkJCQkvLyBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLCB3ZSBjaGVjayBmb3IgdGhpcwoJCQkJLy8gY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aCBhbiBpZAoJCQkJLy8gZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvcgoJCQkJLy8gY2FzZS4gSWYgdGhlIGZpcnN0LXBhZ2UgaXMgbm90IGluIHRoZSBET00sIHRoZW4gd2UgbGV0CgkJCQkvLyB0aGluZ3MgZmFsbCB0aHJvdWdoIHRvIHRoZSBhamF4IGxvYWRpbmcgY29kZSBiZWxvdyBzbwoJCQkJLy8gdGhhdCBpdCBnZXRzIHJlbG9hZGVkLgoJCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkubGVuZ3RoICkgewoJCQkJCXBhZ2UgPSAkKCAkLm1vYmlsZS5maXJzdFBhZ2UgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggZmlsZVVybCApICApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJfQoJCQoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQkvL2lmIHdlIGFyZSByZWxvYWRpbmcgdGhlIHBhZ2UgbWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2ggCgkJCQlpZiggYmFzZSAmJiAhb3B0aW9ucy5wcmVmZXRjaCApewoJCQkJCWJhc2Uuc2V0KHVybCk7CgkJCQl9CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCkgewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nIAoJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoJCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgKCBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gfHwgIiIgKSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmICggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCggdGhpcyApLmlzKCAnW3NyY10nICkgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCQloaWRlTXNnKCk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgdGhlIHBhZ2UgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gcGFnZTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UsIGR1cENhY2hlZFBhZ2UgKTsKCQkJCX0sCgkJCQllcnJvcjogZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiAoIHBsZkV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCQloaWRlTXNnKCk7CgoJCQkJCQkvLyBzaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJCQkJLy8gaGlkZSBhZnRlciBkZWxheQoJCQkJCQlzZXRUaW1lb3V0KCAkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2csIDE1MDAgKTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLCBpc1RvUGFnZVN0cmluZzsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgJC5tb2JpbGUuYWN0aXZlUGFnZTsKCgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkvLyAgICAgICBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbSB0aGUgaGFzaAoJCS8vICAgICAgIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0KCQkvLyAgICAgICBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9QYWdlLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQl9IGVsc2UgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gdG9QYWdlLmRhdGEoICdhYnNVcmwnICk7CgkJfQoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG9QYWdlIGluIHRoZSB0cmlnZ2VyCgkJLy8gZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvUGFnZSBpcyB1cGRhdGVkLgoJCS8vCgkJLy8gV2UgYWxzbyBuZWVkIHRvIHJlLWV2YWx1YXRlIHdoZXRoZXIgaXQgaXMgYSBzdHJpbmcsIGJlY2F1c2UgYW4gb2JqZWN0IGNhbgoJCS8vIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoJCWlzVG9QYWdlU3RyaW5nID0gKHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciKTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggaXNUb1BhZ2VTdHJpbmcgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZSBzaW1wbGlmaWVkCgkJCS8vIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJCS8vIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0KCQkJLy8gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0b1BhZ2U7CgoJCQkkLm1vYmlsZS5sb2FkUGFnZSggdG9QYWdlLCBzZXR0aW5ncyApCgkJCQkuZG9uZShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBuZXdQYWdlLCBkdXBDYWNoZWRQYWdlICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCQlvcHRpb25zLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgPSBkdXBDYWNoZWRQYWdlOwoKCQkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCQluZXdQYWdlLmRhdGEoICdhYnNVcmwnLCB0cmlnZ2VyRGF0YS5hYnNVcmwgKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCgkJCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCgkJCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCQl9KTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQlzZXR0aW5ncy5kYXRhVXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQl9CgoJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJdmFyIGZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UsCgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIHNldHRpbmdzLmRhdGFVcmwgKSApIHx8IHRvUGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZCBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybCwKCQkJZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIHVybCApLAoJCQlhY3RpdmUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCwKCQkJaGlzdG9yeURpciA9IDAsCgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlLAoJCQlpc0RpYWxvZyA9IHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyI7CgoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuZGlyZWN0KHsgdXJsOiB1cmwgfSk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCWVuaGFuY2VQYWdlKCB0b1BhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8gc2VlIGlmIHRoZQoJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJLy8gdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZSB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCWhpc3RvcnlEaXIgPSBvcHRpb25zLmRpcmVjdGlvbiA9PT0gImJhY2siID8gLTEgOiAxOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdib2R5JyApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaCggZSApIHt9CgoJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJdmFyIGFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBoYXNoLgoJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJLy8gYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2ggYW5kCgkJCS8vIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZSBvcmlnaW5hbCBkaWFsb2cKCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQlhY3RpdmUudXJsLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVQYWdlICYmCgkJCQkhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgJiYKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJfQoKCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbiBvZiBhIHN0YWxlIGRpYWxvZywKCQkJLy8gd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKTsKCgkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQlpZiggIWFscmVhZHlUaGVyZSAmJiB1cmwuaW5kZXhPZigiIyIpID4gLTEgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfSBlbHNlIHsKCQkJCXVybCArPSAiIyIgKyBkaWFsb2dIYXNoS2V5OwoJCQl9CgoJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9CgkJfQoKCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0IHVzZSBwYWdlVGl0bGUKCQl2YXIgbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICk/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwgdG9QYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmluZCggIi51aS10aXRsZSIgKS50ZXh0KCk7CgkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYgKCAhaGlzdG9yeURpciAmJiBhbHJlYWR5VGhlcmUgKSB7CgkJCXVybEhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl2YXIgcGFyYW1zOwoKCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJLy8gVE9ETyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWxseSBwYXNzZWQgaW4gcGF0aAoJCQlpZiggIXBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJdXJsID0gIiMiICsgdXJsOwoJCQl9CgoJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCXBhcmFtcyA9IHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCXJvbGU6IHNldHRpbmdzLnJvbGUKCQkJfTsKCgkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCBwYXJhbXMsIHRydWUpOwoJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJfQoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gcGFnZVRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkJdmFyIGdldEFqYXhGb3JtRGF0YSA9IGZ1bmN0aW9uKCAkZm9ybSwgY2FsY3VsYXRlT25seSApIHsKCQkJdmFyIHVybCwgcmV0ID0gdHJ1ZSwgZm9ybURhdGEsIHZjbGlja2VkTmFtZSwgbWV0aG9kOwoJCQkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKSApOwoKCQkJaWYgKCAoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlpZiAoICFjYWxjdWxhdGVPbmx5ICkgewoJCQkJZm9ybURhdGEgPSAkZm9ybS5zZXJpYWxpemVBcnJheSgpOwoKCQkJCWlmICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkWyAwIF0uZm9ybSA9PT0gJGZvcm1bIDAgXSApIHsKCQkJCQl2Y2xpY2tlZE5hbWUgPSAkbGFzdFZDbGlja2VkLmF0dHIoICJuYW1lIiApOwoJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhlIGxhc3QgY2xpY2tlZCBlbGVtZW50IGlzIGluY2x1ZGVkIGluIHRoZSBmb3JtCgkJCQkJCSQuZWFjaCggZm9ybURhdGEsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJCQkJaWYgKCB2YWx1ZS5uYW1lID09PSB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQkJLy8gVW5zZXQgdmNsaWNrZWROYW1lIC0gd2UndmUgZm91bmQgaXQgaW4gdGhlIHNlcmlhbGl6ZWQgZGF0YSBhbHJlYWR5CgkJCQkJCQkJdmNsaWNrZWROYW1lID0gIiI7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQlmb3JtRGF0YS5wdXNoKCB7IG5hbWU6IHZjbGlja2VkTmFtZSwgdmFsdWU6ICRsYXN0VkNsaWNrZWQuYXR0ciggInZhbHVlIiApIH0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXQgPSB7CgkJCQkJdXJsOiB1cmwsCgkJCQkJb3B0aW9uczogewoJCQkJCQl0eXBlOgkJbWV0aG9kLAoJCQkJCQlkYXRhOgkJJC5wYXJhbSggZm9ybURhdGEgKSwKCQkJCQkJdHJhbnNpdGlvbjoJJGZvcm0uanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJCXJldmVyc2U6CSRmb3JtLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJCX0KCQkJCX07CgkJCX0KCgkJCXJldHVybiByZXQ7CgkJfTsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgoJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJGJ0biwgYnRuRWxzLCB0YXJnZXQgPSBldmVudC50YXJnZXQsIG5lZWRDbG9zZXN0ID0gZmFsc2U7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlY29yZCB0aGF0IHRoaXMgZWxlbWVudCB3YXMgY2xpY2tlZCwgaW4gY2FzZSB3ZSBuZWVkIGl0IGZvciBjb3JyZWN0CgkJCS8vIGZvcm0gc3VibWlzc2lvbiBkdXJpbmcgdGhlICJzdWJtaXQiIGhhbmRsZXIgYWJvdmUKCQkJJGxhc3RWQ2xpY2tlZCA9ICQoIHRhcmdldCApOwoKCQkJLy8gVHJ5IHRvIGZpbmQgYSB0YXJnZXQgZWxlbWVudCB0byB3aGljaCB0aGUgYWN0aXZlIGNsYXNzIHdpbGwgYmUgYXBwbGllZAoJCQlpZiAoICQuZGF0YSggdGFyZ2V0LCAibW9iaWxlLWJ1dHRvbiIgKSApIHsKCQkJCS8vIElmIHRoZSBmb3JtIHdpbGwgbm90IGJlIHN1Ym1pdHRlZCB2aWEgQUpBWCwgZG8gbm90IGFkZCBhY3RpdmUgY2xhc3MKCQkJCWlmICggIWdldEFqYXhGb3JtRGF0YSggJCggdGFyZ2V0ICkuY2xvc2VzdCggImZvcm0iICksIHRydWUgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvLyBXZSB3aWxsIGFwcGx5IHRoZSBhY3RpdmUgc3RhdGUgdG8gdGhpcyBidXR0b24gd2lkZ2V0IC0gdGhlIHBhcmVudAoJCQkJLy8gb2YgdGhlIGlucHV0IHRoYXQgd2FzIGNsaWNrZWQgd2lsbCBoYXZlIHRoZSBhc3NvY2lhdGVkIGRhdGEKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0YXJnZXQgPSBmaW5kQ2xvc2VzdExpbmsoIHRhcmdldCApOwoJCQkJaWYgKCAhKCB0YXJnZXQgJiYgcGF0aC5wYXJzZVVybCggdGFyZ2V0LmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlCgkJCQkvLyBsaW5rIHdyYXBwaW5nIGNhbiBiZSBhdm9pZGVkCgkJCQlpZiAoICEkKCB0YXJnZXQgKS5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gQXZvaWQgY2FsbGluZyAuY2xvc2VzdCBieSB1c2luZyB0aGUgZGF0YSBzZXQgZHVyaW5nIC5idXR0b25NYXJrdXAoKQoJCQkvLyBMaXN0IGl0ZW1zIGhhdmUgdGhlIGJ1dHRvbiBkYXRhIGluIHRoZSBwYXJlbnQgb2YgdGhlIGVsZW1lbnQgY2xpY2tlZAoJCQlpZiAoICEhfnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZiggInVpLWxpbmstaW5oZXJpdCIgKSApIHsKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQucGFyZW50Tm9kZSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQkJfQoJCQkvLyBPdGhlcndpc2UsIGxvb2sgZm9yIHRoZSBkYXRhIG9uIHRoZSB0YXJnZXQgaXRzZWxmCgkJCX0gZWxzZSB7CgkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldCwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQl9CgkJCS8vIElmIGZvdW5kLCBncmFiIHRoZSBidXR0b24ncyBvdXRlciBlbGVtZW50CgkJCWlmICggYnRuRWxzICkgewoJCQkJdGFyZ2V0ID0gYnRuRWxzLm91dGVyOwoJCQl9IGVsc2UgewoJCQkJbmVlZENsb3Nlc3QgPSB0cnVlOwoJCQl9CgoJCQkkYnRuID0gJCggdGFyZ2V0ICk7CgkJCS8vIElmIHRoZSBvdXRlciBlbGVtZW50IHdhc24ndCBmb3VuZCBieSB0aGUgb3VyIGhldXJpc3RpY3MsIHVzZSAuY2xvc2VzdCgpCgkJCWlmICggbmVlZENsb3Nlc3QgKSB7CgkJCQkkYnRuID0gJGJ0bi5jbG9zZXN0KCAiLnVpLWJ0biIgKTsKCQkJfQoKCQkJaWYgKCAkYnRuLmxlbmd0aCA+IDAgJiYgISRidG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJGJ0bjsKCQkJCSRhY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLCAkbGluayA9ICQoIGxpbmsgKSwgaHR0cENsZWFudXA7CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBsaW5rIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2xpY2sgb3IgaXRzIG5vdCBhIGxlZnQKCQkJLy8gY2xpY2sgd2Ugd2FudCB0byBpZ25vcmUgdGhlIGNsaWNrCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhbGluayB8fCBldmVudC53aGljaCA+IDEgfHwgISRsaW5rLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vcmVtb3ZlIGFjdGl2ZSBsaW5rIGNsYXNzIGlmIGV4dGVybmFsICh0aGVuIGl0IHdvbid0IGJlIHRoZXJlIGlmIHlvdSBjb21lIGJhY2spCgkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQl9OwoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgIXBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdmFyIHRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCXJldmVyc2UgPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKHVybCksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUgdHJhbnNpdGlvbiBpcyBkZXJpdmVkIGZyb20gdGhlIHByZXZpb3VzCgkJCQkvLyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAodXJsSGlzdG9yeS5nZXRMYXN0KCkgfHwge30pLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIHNwZWNpYWwgY2FzZSBmb3IgZGlhbG9ncwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmIHVybEhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJaWYoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7CgkJCQkJfQoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vaWYgdG8gaXMgZGVmaW5lZCwgbG9hZCBpdAoJCQlpZiAoIHRvICkgewoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlIGVsZW1lbnQgZnJvbQoJCQkJLy8gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZS9hYnNvbHV0ZSBVUkwuIElmICd0bycgaXMKCQkJCS8vIGFuIGlkLCB3ZSBuZWVkIHRvIHJlc29sdmUgaXQgYWdhaW5zdCB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsCgkJCQkvLyBzaW5jZSB0aGUgaGFzaGNoYW5nZSBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsIHBhZ2UvZGlhbG9nLgoJCQkJdG8gPSAhcGF0aC5pc1BhdGgoIHRvICkgPyAoIHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB0bywgZG9jdW1lbnRCYXNlICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYSByZWZlcmVuY2UgdG8gYSBub24tZXhpc3RlbnQKCQkJCS8vIGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluc3RlYWQuIFdlIGtub3cgdGhhdCB0aGUgaW5pdGlhbCBoYXNoIHJlZmVycyB0byBhCgkJCQkvLyBub24tZXhpc3RlbnQgcGFnZSwgYmVjYXVzZSB0aGUgaW5pdGlhbCBoYXNoIGRpZCBub3QgZW5kIHVwIGluIHRoZSBpbml0aWFsIHVybEhpc3RvcnkgZW50cnkKCQkJCWlmICggdG8gPT09IHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB1cmxIaXN0b3J5LmluaXRpYWxEc3QsIGRvY3VtZW50QmFzZSApICYmCgkJCQkJdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggJiYgdXJsSGlzdG9yeS5zdGFja1swXS51cmwgIT09IHVybEhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gJC5tb2JpbGUuZmlyc3RQYWdlOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvLyBUT0RPIHJvbGwgdGhlIGxvZ2ljIGhlcmUgaW50byB0aGUgaGFuZGxlSGFzaENoYW5nZSBtZXRob2QKCQkkd2luZG93LmJpbmQoICJuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgdXJsOwoKCQkJaWYgKCBlLm9yaWdpbmFsRXZlbnQgJiYgZS5vcmlnaW5hbEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl1cmwgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUub3JpZ2luYWxFdmVudE5hbWUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYoICF1cmwgKSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQl9CgoJCQlpZiggIXVybCB8fCB1cmwgPT09ICIjIiB8fCB1cmwuaW5kZXhPZiggIiMiICsgJC5tb2JpbGUucGF0aC51aVN0YXRlS2V5ICkgPT09IDAgKXsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZXNob3ciLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkLm1vYmlsZS53aW5kb3cuYmluZCggInRocm90dGxlZHJlc2l6ZSIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCgkkKCBmdW5jdGlvbigpIHsgZG9tcmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7IH0gKTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKCgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoIGUudGFyZ2V0ICkgKSwgb3B0aW9uczsKCglpZiAoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWNvcm5lckNsYXNzID0gISF0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJZGlhbG9nV3JhcCA9ICQoICI8ZGl2Lz4iLCB7CgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKyBjb3JuZXJDbGFzcwoJCQkJfSk7CgoJCSRlbC5hZGRDbGFzcyggInVpLWRpYWxvZyB1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbC53cmFwSW5uZXIoIGRpYWxvZ1dyYXAgKTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkJdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9vbiggJGVsLCB7CgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3JlYXRlQ29tcGxldGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLCBidG4sIGxvY2F0aW9uOwoKCQlpZiAoIHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uICkgewoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbi5yZW1vdmUoKTsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBudWxsOwoJCX0KCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCS8vIFNhbml0aXplIHZhbHVlCgkJCWxvY2F0aW9uID0gKCB2YWx1ZSA9PT0gImxlZnQiID8gImxlZnQiIDogInJpZ2h0IiApOwoJCQlidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWJ0bi0iICsgbG9jYXRpb24gKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKS5wcmVwZW5kKCBidG4gKTsKCQkJaWYgKCB0aGlzLl9jcmVhdGVDb21wbGV0ZSAmJiAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCWJ0bi5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQl0aGlzLl9jcmVhdGVDb21wbGV0ZSA9IHRydWU7CgoJCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkJLy8gb24gdGhlIGJ1dHRvbiBhbmQgbGV0dGluZyBuYXYgaGFuZGxlIGl0CgkJCS8vCgkJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJCS8vIHJlb3BlbmluZyB0aGUgZGlhbG9nIGlmIHRoZSBkaWFsb2cgb3BlbmluZyBpdGVtIHdhcyBkaXJlY3RseSB1bmRlciB0aGUgY2xvc2UgYnV0dG9uLgoJCQlidG4uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImNsb3NlQnRuIiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCS8vIElmIHRoZSBoYXNoIGxpc3RlbmluZyBpcyBlbmFibGVkIGFuZCB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgcHJlY2VkaW5nIGhpc3RvcnkKCQkJLy8gZW50cnkgaXQncyBvayB0byBnbyBiYWNrLiBJbml0aWFsIHBhZ2VzIHdpdGggdGhlIGRpYWxvZyBoYXNoIHN0YXRlIGFyZSBhbiBleGFtcGxlCgkJCS8vIHdoZXJlIHRoZSBzdGFjayBjaGVjayBpcyBuZWNlc3NhcnkKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJiBoaXN0LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCWlkeCA9IE1hdGgubWF4KCAwLCBoaXN0LmFjdGl2ZUluZGV4IC0gMSApOwoJCQkJZHN0ID0gaGlzdC5zdGFja1sgaWR4IF0ucGFnZVVybCB8fCBoaXN0LnN0YWNrWyBpZHggXS51cmw7CgkJCQloaXN0LnByZXZpb3VzSW5kZXggPSBoaXN0LmFjdGl2ZUluZGV4OwoJCQkJaGlzdC5hY3RpdmVJbmRleCA9IGlkeDsKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCBkc3QgKSApIHsKCQkJCQlkc3QgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgZHN0ICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZHN0LCB7IGRpcmVjdGlvbjogImJhY2siLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCXZhciAkcGFnZSA9ICQoIGUudGFyZ2V0ICksCgkJbyA9ICRwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVGhpcyBmdW5jdGlvbiBjYWxscyBnZXRBdHRyaWJ1dGUsIHdoaWNoIHNob3VsZCBiZSBzYWZlIGZvciBkYXRhLSogYXR0cmlidXRlcwp2YXIgZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oIGUsIGtleSApIHsKCXZhciB2YWx1ZSA9IGUuZ2V0QXR0cmlidXRlKCBrZXkgKTsKCglyZXR1cm4gdmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCXZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCXZhbHVlID09PSBudWxsID8gdW5kZWZpbmVkIDogdmFsdWU7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQluc0tleSA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQlrZXk7CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAibWluaSIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoJCQlob3ZlciA9IGZhbHNlLAoJCQlzdGF0ZSA9ICJ1cCIsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQlmb3IgKCBrZXkgaW4gbyApIHsKCQkJaWYgKCBvWyBrZXkgXSA9PT0gdW5kZWZpbmVkIHx8IG9bIGtleSBdID09PSBudWxsICkgewoJCQkJZWwucmVtb3ZlQXR0ciggbnNLZXkgKyBrZXkgKTsKCQkJfSBlbHNlIHsKCQkJCWUuc2V0QXR0cmlidXRlKCBuc0tleSArIGtleSwgb1sga2V5IF0gKTsKCQkJfQoJCX0KCgkJaWYgKCBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInJlbCIgKSA9PT0gInBvcHVwIiAmJiBlbC5hdHRyKCAiaHJlZiIgKSApIHsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWhhc3BvcHVwIiwgdHJ1ZSApOwoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtb3ducyIsIGVsLmF0dHIoICJocmVmIiApICk7CgkJfQoKCQkvLyBDaGVjayBpZiB0aGlzIGVsZW1lbnQgaXMgYWxyZWFkeSBlbmhhbmNlZAoJCWJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAoICggZS50YWdOYW1lID09PSAiSU5QVVQiIHx8IGUudGFnTmFtZSA9PT0gIkJVVFRPTiIgKSA/IGUucGFyZW50Tm9kZSA6IGUgKSwgImJ1dHRvbkVsZW1lbnRzIiApOwoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJCggZSApOwoJCQlidXR0b25Jbm5lciA9IGJ1dHRvbkVsZW1lbnRzLmlubmVyOwoJCQlidXR0b25UZXh0ID0gYnV0dG9uRWxlbWVudHMudGV4dDsKCQkJLy8gV2Ugd2lsbCByZWNyZWF0ZSB0aGlzIGljb24gYmVsb3cKCQkJJCggYnV0dG9uRWxlbWVudHMuaWNvbiApLnJlbW92ZSgpOwoJCQlidXR0b25FbGVtZW50cy5pY29uID0gbnVsbDsKCQkJaG92ZXIgPSBidXR0b25FbGVtZW50cy5ob3ZlcjsKCQkJc3RhdGUgPSBidXR0b25FbGVtZW50cy5zdGF0ZTsKCQl9CgkJZWxzZSB7CgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQl9CgkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJaWYgKCBhdHRhY2hFdmVudHMgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biAiOwoJCWJ1dHRvbkNsYXNzICs9ICggaG92ZXIgPyAidWktYnRuLWhvdmVyLSIgKyBvLnRoZW1lIDogIiIgKTsKCQlidXR0b25DbGFzcyArPSAoIHN0YXRlID8gIiB1aS1idG4tIiArIHN0YXRlICsgIi0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gby5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQlidXR0b25DbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8ubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgbWluaWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8ubWluaSA9PT0gdHJ1ZSA/ICIgdWktbWluaSIgOiAiIHVpLWZ1bGxzaXplIjsKCQl9CgoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCQlidXR0b25UZXh0LmNsYXNzTmFtZSA9IHRleHRDbGFzczsKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCQl9CgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJaWYgKCAhKCBidXR0b25FbGVtZW50cyAmJiBidXR0b25FbGVtZW50cy5pY29uICkgKSB7CgkJCQlidXR0b25JY29uLmlubmVySFRNTCA9ICImIzE2MDsiOwoJCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvbkljb24gKTsKCQkJfQoJCX0KCgkJd2hpbGUgKCBlLmZpcnN0Q2hpbGQgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCX0KCgkJLy8gQXNzaWduIGEgc3RydWN0dXJlIGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uIHRvIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbi4gVGhpcwoJCS8vIHdpbGwgYWxsb3cgdXMgdG8gcmVjb2duaXplIHRoaXMgYXMgYW4gYWxyZWFkeS1lbmhhbmNlZCBidXR0b24gaW4gZnV0dXJlIGNhbGxzIHRvIGJ1dHRvbk1hcmt1cCgpLgoJCWJ1dHRvbkVsZW1lbnRzID0gewoJCQlob3ZlciA6IGhvdmVyLAoJCQlzdGF0ZSA6IHN0YXRlLAoJCQliY2xzICA6IGJ1dHRvbkNsYXNzLAoJCQlvdXRlciA6IGUsCgkJCWlubmVyIDogYnV0dG9uSW5uZXIsCgkJCXRleHQgIDogYnV0dG9uVGV4dCwKCQkJaWNvbiAgOiBidXR0b25JY29uCgkJfTsKCgkJJC5kYXRhKCBlLCAgICAgICAgICAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvbklubmVyLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uVGV4dCwgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJaWYgKCBidXR0b25JY29uICkgewoJCQkkLmRhdGEoIGJ1dHRvbkljb24sICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCXdyYXBwZXJFbHM6ICJzcGFuIgp9OwoKZnVuY3Rpb24gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGVsZW1lbnQgKSB7CiAgICB2YXIgY25hbWU7CgogICAgd2hpbGUgKCBlbGVtZW50ICkgewoJCS8vIE5vdGUgdGhhdCB3ZSBjaGVjayBmb3IgdHlwZW9mIGNsYXNzTmFtZSBiZWxvdyBiZWNhdXNlIHRoZSBlbGVtZW50IHdlCgkJLy8gaGFuZGVkIGNvdWxkIGJlIGluIGFuIFNWRyBET00gd2hlcmUgY2xhc3NOYW1lIG9uIFNWRyBlbGVtZW50cyBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgb2YgYSBkaWZmZXJlbnQgdHlwZSAoU1ZHQW5pbWF0ZWRTdHJpbmcpLiBXZSBvbmx5IG9wZXJhdGUgb24gSFRNTCBET00KCQkvLyBlbGVtZW50cywgc28gd2UgbG9vayBmb3IgcGxhaW4gInN0cmluZyIuCiAgICAgICAgY25hbWUgPSAoIHR5cGVvZiBlbGVtZW50LmNsYXNzTmFtZSA9PT0gJ3N0cmluZycgKSAmJiAoIGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICk7CiAgICAgICAgaWYgKCBjbmFtZSAmJiBjbmFtZS5pbmRleE9mKCAidWktYnRuICIgKSA+IC0xICYmIGNuYW1lLmluZGV4T2YoICJ1aS1kaXNhYmxlZCAiICkgPCAwICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCBjbGFzc1RvUmVtb3ZlLCBjbGFzc1RvQWRkLCBob3Zlciwgc3RhdGUgKSB7Cgl2YXIgYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICRidG5bIDAgXSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJJGJ0bi5yZW1vdmVDbGFzcyggY2xhc3NUb1JlbW92ZSApLmFkZENsYXNzKCBjbGFzc1RvQWRkICk7CglpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCWJ1dHRvbkVsZW1lbnRzLmJjbHMgPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICkKCQkJLmFkZENsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzICsgIiAiICsgY2xhc3NUb0FkZCApCgkJCS5yZW1vdmVDbGFzcyggY2xhc3NUb1JlbW92ZSApCgkJCS5hdHRyKCAiY2xhc3MiICk7CgkJaWYgKCBob3ZlciAhPT0gdW5kZWZpbmVkICkgewoJCQlidXR0b25FbGVtZW50cy5ob3ZlciA9IGhvdmVyOwoJCX0KCQlidXR0b25FbGVtZW50cy5zdGF0ZSA9IHN0YXRlOwoJfQp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7Cgl2YXIgaG92ZXJEZWxheSA9ICQubW9iaWxlLmJ1dHRvbk1hcmt1cC5ob3ZlckRlbGF5LCBob3YsIGZvYzsKCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWlzVG91Y2hFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL150b3VjaC8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICksCgkJCQlldnQgPSBldmVudC50eXBlOwoKCQkJaWYgKCAkYnRuLmxlbmd0aCApIHsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCB1bmRlZmluZWQsICJkb3duIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCB1bmRlZmluZWQsICJkb3duIiApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZWNhbmNlbCIgfHwgZXZ0ID09PSAidm1vdXNldXAiICkgewoJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAidXAiICk7CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdmVyIiB8fCBldnQgPT09ICJmb2N1cyIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlmb2MgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUsIHRydWUsICIiICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW91dCIgfHwgZXZ0ID09PSAiYmx1ciIgfHwgZXZ0ID09PSAic2Nyb2xsc3RhcnQiICkgewoJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIGZhbHNlLCAidXAiICk7CgkJCQkJaWYgKCBob3YgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaG92ICk7CgkJCQkJfQoJCQkJCWlmICggZm9jICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGZvYyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0sCgkJImZvY3VzaW4gZm9jdXMiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfSwKCQkiZm9jdXNvdXQgYmx1ciI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQljb2xsYXBzZWRJY29uOiAicGx1cyIsCgkJZXhwYW5kZWRJY29uOiAibWludXMiLAoJCWljb25wb3M6ICJsZWZ0IiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQljb2xsYXBzaWJsZSA9ICRlbC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlIiApLAoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oIG8uaGVhZGluZyApLmZpcnN0KCksCgkJCWNvbGxhcHNpYmxlQ29udGVudCA9IGNvbGxhcHNpYmxlLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQnPjwvZGl2PiIgKS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyA9ICIiOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIGNvbGxhcHNpYmxlSGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUhlYWRpbmcgKTsKCQkJY29sbGFwc2libGVIZWFkaW5nLm5leHQoKS5yZW1vdmUoKTsKCQl9CgoJCS8vIElmIHdlIGFyZSBpbiBhIGNvbGxhcHNpYmxlIHNldAoJCWlmICggY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29sbGFwc2libGVTZXQsICJjIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGNvbGxhcHNlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmNvbGxhcHNlZEljb24gPSAkZWwuanFtRGF0YSggImNvbGxhcHNlZC1pY29uIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb247CgoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGV4cGFuZGVkIGljb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uZXhwYW5kZWRJY29uID0gJGVsLmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApIHx8IG8uZXhwYW5kZWRJY29uOwoKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmljb25wb3MgPSAkZWwuanFtRGF0YSggImljb25wb3MiICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICkgfHwgby5pY29ucG9zOwoKCQkJLy8gSW5oZXJpdCB0aGUgcHJlZmVyZW5jZSBmb3IgaW5zZXQgZnJvbSBjb2xsYXBzaWJsZS1zZXQgb3Igc2V0IHRoZSBkZWZhdWx0IHZhbHVlIHRvIGVuc3VyZSBlcXVhbHR5IHdpdGhpbiBhIHNldAoJCQlpZiAoIGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJby5pbnNldCA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKTsKCQkJfSBlbHNlIHsKCQkJCW8uaW5zZXQgPSB0cnVlOwoJCQl9CgkJCS8vIFNldCBjb3JuZXJzIGZvciBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlcyB0byBmYWxzZSB3aGVuIGluIGEgY29sbGFwc2libGUtc2V0CgkJCW8uY29ybmVycyA9IGZhbHNlOwoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGZvciBtaW5pIGluIHRoZSBzZXQKCQkJaWYgKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBnZXQgaW5oZXJpdGVkIHRoZW1lIGlmIG5vdCBhIHNldCBhbmQgbm8gdGhlbWUgaGFzIGJlZW4gc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJCX0KCQl9CgoJCWlmICggISFvLmluc2V0ICkgewoJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb2xsYXBzaWJsZS1pbnNldCI7CgkJCWlmICggISFvLmNvcm5lcnMgKSB7CgkJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb3JuZXItYWxsIiA7CgkJCX0KCQl9CgkJaWYgKCBvLmNvbnRlbnRUaGVtZSApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQiOwoJCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApOwoJCX0KCQlpZiAoIGNvbGxhcHNpYmxlQ2xhc3NlcyAhPT0gIiIgKSB7CgkJCWNvbGxhcHNpYmxlLmFkZENsYXNzKCBjb2xsYXBzaWJsZUNsYXNzZXMgKTsKCQl9CgkJCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29ucG9zOiBvLmljb25wb3MsCgkJCQkJaWNvbjogby5jb2xsYXBzZWRJY29uLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSk7CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKTsKCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG8uZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG8uY29sbGFwc2VkSWNvbiwgKCBpc0NvbGxhcHNlIHx8IG8uZXhwYW5kZWRJY29uID09PSBvLmNvbGxhcHNlZEljb24gKSApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkJJHRoaXMudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29udGVudC1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApOwoKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQkJCX0KCQkJfSkKCQkJLnRyaWdnZXIoIG8uY29sbGFwc2VkID8gImNvbGxhcHNlIiA6ICJleHBhbmQiICk7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkuYmluZCggInRhcCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiYSIgKS5maXJzdCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCXZhciB0eXBlID0gY29sbGFwc2libGVIZWFkaW5nLmlzKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiApID8gImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXZpc2libGVzID0gJGVscy5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJaWYgKCB2aXNpYmxlcy5sZW5ndGggPT09IDAgKSB7CgkJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCX0KCQl9CgoJCXJldHVybiB2aXNpYmxlczsKCX0sCgoJX2FkZEZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzLCAkdmlzaWJsZXMsIGNyZWF0ZSApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCQkkdmlzaWJsZXMuZXEoIDAgKS5hZGRDbGFzcyggInVpLWZpcnN0LWNoaWxkIiApLmVuZCgpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxhc3QtY2hpbGQiICk7CgkJaWYgKCAhY3JlYXRlICkgewoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb3JuZXIgc3R5bGluZyBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29ybmVycyApIHsKCQkJby5jb3JuZXJzID0gJGVsLmpxbURhdGEoICJjb3JuZXJzIiApOwoJCX0KCQkKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCQlvLmNvcm5lcnMgPSBvLmNvcm5lcnMgIT09IHVuZGVmaW5lZCA/IG8uY29ybmVycyA6IHRydWU7CgkJCgkJaWYgKCAhIW8uY29ybmVycyAmJiAhIW8uaW5zZXQgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwiICk7CgkJfQoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKQoJCQkJCQkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQkJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkJLnRyaWdnZXIoICJjb2xsYXBzZSIgKTsKCQkJCQl9CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb2xsYXBzaWJsZXNJblNldCA9ICRlbC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICksCgkJCWV4cGFuZGVkID0gY29sbGFwc2libGVzSW5TZXQuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApOwoJCXRoaXMuX3JlZnJlc2goICJ0cnVlIiApOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJZXhwYW5kZWQudHJpZ2dlciggImV4cGFuZCIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gZmlsdGVyIGZ1bmN0aW9uIHJlbW92ZXMgd2hpdGVzcGFjZSBiZXR3ZWVuIGxhYmVsIGFuZCBmb3JtIGVsZW1lbnQgc28gd2UgY2FuIHVzZSBpbmxpbmUtYmxvY2sgKG5vZGVUeXBlIDMgPSB0ZXh0KQokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMKCQkuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICkKCQkuY29udGVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gKCB0aGlzLm5vZGVUeXBlID09PSAzICYmICEvXFMvLnRlc3QoIHRoaXMubm9kZVZhbHVlICkgKTsKCQl9KS5yZW1vdmUoKTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbmF2YmFyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIgdWktbWluaSIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zLmJ1dHRvbk1hcmt1cCh7CgkJCWNvcm5lcnM6CWZhbHNlLAoJCQlzaGFkb3c6CQlmYWxzZSwKCQkJaW5saW5lOiAgICAgdHJ1ZSwKCQkJaWNvbnBvczoJaWNvbnBvcwoJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIHVpLWJ0bi1pbm5lciBpcyByZXR1cm5lZCBhcyB0YXJnZXQKCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCAiYSIgKSA/ICQoIHRoaXMgKSA6ICQoIHRoaXMgKS5wYXJlbnQoICJhIiApOwoJCQkKCQkJaWYgKCAhdGFyZ2V0LmlzKCAiLnVpLWRpc2FibGVkLCAudWktYnRuLWFjdGl2ZSIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoJCQkJCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogImMiLAoJCWhlYWRlclRoZW1lOiAiYiIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJaWNvbjogImFycm93LXIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoZnVuY3Rpb24oIGksIG9yaWcgKSB7CgkJCXJldHVybiBvcmlnICsgIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaXN0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCWpzQ291bnQgPSAhJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQsCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBvbCAmJiBqc0NvdW50ICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggb2wgKSB7CgkJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKSAtIDE7CgkJCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJCQl9IGVsc2UgewoJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCWNvdW50ZXIgPSAxOwoJCQl9CgkJfQoKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJdmFyIGlzRGl2aWRlciA9ICggaXRlbS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSggImljb24iICk7CgoJCQkJCWl0ZW0uYnV0dG9uTWFya3VwKHsKCQkJCQkJd3JhcHBlckVsczogImRpdiIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQlpY29ucG9zOiAicmlnaHQiLAoJCQkJCQlpY29uOiBhLmxlbmd0aCA+IDEgfHwgaWNvbiA9PT0gZmFsc2UgPyBmYWxzZSA6IGljb24gfHwgbGlzdGljb24gfHwgby5pY29uLAoJCQkJCQl0aGVtZTogaXRlbVRoZW1lCgkJCQkJfSk7CgoJCQkJCWlmICggKCBpY29uICE9PSBmYWxzZSApICYmICggYS5sZW5ndGggPT09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKGxhc3QuZ2V0RW5jb2RlZFRleHQoKSkgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktbGktbGluay1hbHQiICkKCQkJCQkJCS5lbXB0eSgpCgkJCQkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQkJCXRoZW1lOiBpdGVtVGhlbWUsCgkJCQkJCQkJaWNvbjogZmFsc2UsCgkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIKCQkJCQkJCX0pCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCQkuYXBwZW5kKAoJCQkJCQkJCQkkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCQkJCQkJdGhlbWU6IHNwbGl0dGhlbWUsCgkJCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQkJCQkJCS8vIGxpbmsgaWNvbiBvdmVycmlkZXMgbGlzdCBpdGVtIGljb24gb3ZlcnJpZGVzIHVsIGVsZW1lbnQgb3ZlcnJpZGVzIG9wdGlvbnMKCQkJCQkJCQkJCWljb246IGxpbmtJY29uIHx8IGljb24gfHwgbGlzdHNwbGl0aWNvbiB8fCBvLnNwbGl0SWNvbgoJCQkJCQkJCQl9KQoJCQkJCQkJCSk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJhci0iICsgKCBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBkaXZpZGVydGhlbWUgKTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CgkJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCQkJCW5ld1N0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQljb3VudGVyID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQkJCQljb3VudGVyID0gMTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9IGVsc2UgewoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLXN0YXRpYyB1aS1idG4tdXAtIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKTsKCQkJCX0pLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyAoICRsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lKSArICIgdWktYnRuLWNvcm5lci1hbGwiICk7CgoJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gbG9vayBhdCB0aGUgZmlyc3QgaW1hZ2UgaW4gdGhlIGxpc3QgaXRlbQoJCS8vIGl0c2VsZiwgYW5kIGFueSAudWktbGluay1pbmhlcml0IGVsZW1lbnQgaXQgbWF5IGNvbnRhaW4sIHNvIHdlCgkJLy8gY2FuIHBsYWNlIHRoZSBhcHByb3ByaWF0ZSBjbGFzc2VzIG9uIHRoZSBpbWFnZSBhbmQgbGlzdCBpdGVtLgoJCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBzb21ldGhpbmcgbGlrZToKCQkvLwoJCS8vICAgIGxpLmZpbmQoIj5pbWc6ZXEoMCksIC51aS1saW5rLWluaGVyaXQ+aW1nOmVxKDApIikuZWFjaCggLi4uICk7CgkJLy8KCQkvLyBCdXQgZXhlY3V0aW5nIGEgZmluZCgpIGxpa2UgdGhhdCBvbiBXaW5kb3dzIFBob25lIDcuNSB0b29rIGEKCQkvLyByZWFsbHkgbG9uZyB0aW1lLiBXYWxraW5nIHRoaW5ncyBtYW51YWxseSB3aXRoIHRoZSBjb2RlIGJlbG93CgkJLy8gYWxsb3dzIHRoZSA0MDAgbGlzdHZpZXcgaXRlbSBwYWdlIHRvIGxvYWQgaW4gYWJvdXQgMyBzZWNvbmRzIGFzCgkJLy8gb3Bwb3NlZCB0byAzMCBzZWNvbmRzLgoKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCAkbGlzdC5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgdGhpcy5fZ2V0VmlzaWJsZXMoIGxpLCBjcmVhdGUgKSwgY3JlYXRlICk7CgkJLy8gYXV0b2RpdmlkZXJzIGJpbmRzIHRvIHRoaXMgdG8gcmVkcmF3IGRpdmlkZXJzIGFmdGVyIHRoZSBsaXN0dmlldyByZWZyZXNoCgkJdGhpcy5fdHJpZ2dlciggImFmdGVycmVmcmVzaCIgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzRnVsbCA9ICQoIGxpc3QucHJldkFsbCgpLnRvQXJyYXkoKS5yZXZlcnNlKCkgKSwKCQkJCW5vZGVFbHMgPSBub2RlRWxzRnVsbC5sZW5ndGggPyBub2RlRWxzRnVsbCA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKyBkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iICkgOiAiIiApCgkJCQkJCQkucGFyZW50KCkKCQkJCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCW5ld1BhZ2UucGFnZSgpOwoKCQkJYW5jaG9yID0gcGFyZW50LmZpbmQoICdhOmZpcnN0JyApOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYgKCBoYXNTdWJQYWdlcyAmJgoJCQlwYXJlbnRQYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICYmCgkJCXBhcmVudFBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgPT09IGZhbHNlICkgewoKCQkJdmFyIG5ld1JlbW92ZSA9IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTCwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCWlmICggdWkubmV4dFBhZ2UgKSB7CgkJCQkJbnBVUkwgPSBuZXh0UGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJCWlmICggbnBVUkwuaW5kZXhPZiggcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApICE9PSAwICkgewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS50cmlnZ2VyKCBwckV2ZW50ICk7CgkJCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCQlwYXJlbnRQYWdlLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICInKSIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSwgaW5wdXRbdHlwZT0nZmlsZSddIiwKCQljbGVhckJ0bjogZmFsc2UsCgkJY2xlYXJTZWFyY2hCdXR0b25UZXh0OiBudWxsLCAvL2RlcHJlY2F0aW5nIGZvciAxLjMuLi4KCQljbGVhckJ0blRleHQ6ICJjbGVhciB0ZXh0IiwKCQlkaXNhYmxlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pY2xhc3MgPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWlzU2VhcmNoID0gaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlmb2N1c2VkRWwsCgkJCWNsZWFyYnRuLAoJCQljbGVhckJ0blRleHQgPSBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCB8fCBvLmNsZWFyQnRuVGV4dCwKCQkJY2xlYXJCdG5CbGFja2xpc3QgPSBpbnB1dC5pcyggInRleHRhcmVhLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlpbnB1dE5lZWRzQ2xlYXJCdG4gPSAhIW8uY2xlYXJCdG4gJiYgIWNsZWFyQnRuQmxhY2tsaXN0LAoJCQlpbnB1dE5lZWRzV3JhcCA9IGlucHV0LmlzKCAiaW5wdXQiICkgJiYgIWlucHV0LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKTsKCgkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJfSwgMCApOwoJCX0KCgkJJCggImxhYmVsW2Zvcj0nIiArIGlucHV0LmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLWlucHV0LXRleHQiICk7CgoJCWZvY3VzZWRFbCA9IGlucHV0LmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoJCS8vInNlYXJjaCIgYW5kICJ0ZXh0IiBpbnB1dCB3aWRnZXRzCgkJaWYgKCBpc1NlYXJjaCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJfSBlbHNlIGlmICggaW5wdXROZWVkc1dyYXAgKSB7CgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC10ZXh0IHVpLXNoYWRvdy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3ciICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9CgoJCWlmKCBpbnB1dE5lZWRzQ2xlYXJCdG4gfHwgaXNTZWFyY2ggKSB7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9JyIgKyBjbGVhckJ0blRleHQgKyAiJz4iICsgY2xlYXJCdG5UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaW5wdXQKCQkJCQkJLnZhbCggIiIgKQoJCQkJCQkuZm9jdXMoKQoJCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQljbGVhcmJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSkKCQkJCS5hcHBlbmRUbyggZm9jdXNlZEVsICkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCWljb246ICJkZWxldGUiLAoJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCW1pbmk6IG8ubWluaQoJCQkJfSk7CgkJCQkKCQkJaWYgKCAhaXNTZWFyY2ggKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgkJCX0KCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCAicGFzdGUgY3V0IGtleXVwIGlucHV0IGZvY3VzIGNoYW5nZSBibHVyIiwgdG9nZ2xlQ2xlYXIgKTsKCQl9CgkJZWxzZSBpZiAoICFpbnB1dE5lZWRzV3JhcCAmJiAhaXNTZWFyY2ggKSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CQkJCgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CQkJCQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwVGltZW91dDsKCgkJCXRoaXMuX2tleXVwID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoJCQkJCQoJCQkJCWlucHV0LmhlaWdodCggc2Nyb2xsSGVpZ2h0IC0gcGFkZGluZ0hlaWdodCArIGV4dHJhTGluZUhlaWdodCApOwoJCQkJfQoJCQl9OwoKCQkJaW5wdXQub24oICJrZXl1cCBjaGFuZ2UgaW5wdXQgcGFzdGUiLCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyVGltZW91dCgga2V5dXBUaW1lb3V0ICk7CgkJCQlrZXl1cFRpbWVvdXQgPSBzZXRUaW1lb3V0KCBzZWxmLl9rZXl1cCwga2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJCX0pOwoKCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCS8vIGFqYXggdGhlIGhlaWdodCBpcyByZWNhbGN1bGF0ZWQgd2l0aG91dCB1c2VyIGlucHV0CgkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS5kb2N1bWVudCwgeyAicGFnZWNoYW5nZSI6ICJfa2V5dXAiIH0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIGlucHV0LnZhbCgpICkgKSB7CgkJCQkvLyBiaW5kIHRvIHRoZSB3aW5kb3cgbG9hZCB0byBtYWtlIHN1cmUgdGhlIGhlaWdodCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIEJPVEgKCQkJCS8vIHRoZSBET00gYW5kIENTUwoJCQkJdGhpcy5fb24oIHRydWUsICQubW9iaWxlLndpbmRvdywgeyJsb2FkIjogIl9rZXl1cCJ9KTsKCQkJfQoJCX0KCQlpZiAoIGlucHV0LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlucHV0TmVlZHNXcmFwID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCXBhcmVudE5lZWRzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApCSYmICggaW5wdXROZWVkc1dyYXAgfHwgaXNTZWFyY2ggKTsKCQkJCgkJaWYgKCBwYXJlbnROZWVkc0Rpc2FibGVkICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0VuYWJsZWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgoJCWlmICggcGFyZW50TmVlZHNFbmFibGVkICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUmV2ZWFsID0gZmFsc2U7Ci8vIFRPRE8gcmVuYW1lIGNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUsIGl0ZW0gKSB7CgkJcmV0dXJuIHRleHQudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwoJfTsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCwgb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibW9iaWxlLWxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmZpbHRlciApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQlsaXN0LmNoaWxkcmVuKCkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KS5zdWJtaXQoIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlYXJjaC5ibHVyKCk7CgkJfSksCgkJb25LZXlVcCA9IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGkgPSBsaXN0LmNoaWxkcmVuKCksCgkJCQlsYXN0dmFsID0gJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICkgKyAiIiwKCQkJCWNoaWxkSXRlbXMgPSBmYWxzZSwKCQkJCWl0ZW10ZXh0ID0gIiIsCgkJCQlpdGVtLAoJCQkJLy8gQ2hlY2sgaWYgYSBjdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMKCQkJCWlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgPSBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrICE9PSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsaXN0dmlldy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiB0aGlzIH0gKTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggaXNDdXN0b21GaWx0ZXJDYWxsYmFjayB8fCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgdmFsLmluZGV4T2YoIGxhc3R2YWwgKSAhPT0gMCApIHsKCgkJCQkvLyBDdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMgb3IgcmVtb3ZlZCBjaGFycyBvciBwYXN0ZWQgc29tZXRoaW5nIHRvdGFsbHkgZGlmZmVyZW50LCBjaGVjayBhbGwgaXRlbXMKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oKTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBPbmx5IGNoYXJzIGFkZGVkLCBub3QgcmVtb3ZlZCwgb25seSB1c2UgdmlzaWJsZSBzdWJzZXQKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICI6bm90KC51aS1zY3JlZW4taGlkZGVuKSIgKTsKCgkJCQlpZiAoICFsaXN0SXRlbXMubGVuZ3RoICYmIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICkgewoJCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCB2YWwgKSB7CgoJCQkJLy8gVGhpcyBoYW5kbGVzIGhpZGluZyByZWd1bGFyIHJvd3Mgd2l0aG91dCB0aGUgdGV4dCB3ZSBzZWFyY2ggZm9yCgkJCQkvLyBhbmQgYW55IGxpc3QgZGl2aWRlcnMgd2l0aG91dCByZWd1bGFyIHJvd3Mgc2hvd24gdW5kZXIgaXQKCgkJCQlmb3IgKCB2YXIgaSA9IGxpc3RJdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCQlpdGVtID0gJCggbGlzdEl0ZW1zWyBpIF0gKTsKCQkJCQlpdGVtdGV4dCA9IGl0ZW0uanFtRGF0YSggImZpbHRlcnRleHQiICkgfHwgaXRlbS50ZXh0KCk7CgoJCQkJCWlmICggaXRlbS5pcyggImxpOmpxbURhdGEocm9sZT1saXN0LWRpdmlkZXIpIiApICkgewoKCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgIWNoaWxkSXRlbXMgKTsKCgkJCQkJCS8vIE5ldyBidWNrZXQhCgkJCQkJCWNoaWxkSXRlbXMgPSBmYWxzZTsKCgkJCQkJfSBlbHNlIGlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayggaXRlbXRleHQsIHZhbCwgaXRlbSApICkgewoKCQkJCQkJLy9tYXJrIHRvIGJlIGhpZGRlbgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCB0cnVlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vIFRoZXJlJ3MgYSBzaG93biBpdGVtIGluIHRoZSBidWNrZXQKCQkJCQkJY2hpbGRJdGVtcyA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFNob3cgaXRlbXMsIG5vdCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiOm5vdCgudWktZmlsdGVyLWhpZGVxdWV1ZSkiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCgkJCQkvLyBIaWRlIGl0ZW1zLCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiLnVpLWZpbHRlci1oaWRlcXVldWUiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgdHJ1ZSApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIsIGZhbHNlICk7CgoJCQl9IGVsc2UgewoKCQkJCS8vZmlsdGVydmFsdWUgaXMgZW1wdHkgPT4gc2hvdyBhbGwKCQkJCWxpc3RJdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCAhIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICk7CgkJCX0KCQkJbGlzdHZpZXcuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCBsaXN0dmlldy5fZ2V0VmlzaWJsZXMoIGxpLCBmYWxzZSApLCBmYWxzZSApOwoJCX0sCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIGlucHV0Iiwgb25LZXlVcCApCgkJLmFwcGVuZFRvKCB3cmFwcGVyICkKCQkudGV4dGlucHV0KCk7CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmluc2V0ICkgewoJCXdyYXBwZXIuYWRkQ2xhc3MoICJ1aS1saXN0dmlldy1maWx0ZXItaW5zZXQiICk7Cgl9CgoJd3JhcHBlci5iaW5kKCAic3VibWl0IiwgZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSkKCS5pbnNlcnRCZWZvcmUoIGxpc3QgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVycyA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn07CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggInVsLG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7CgoJdmFyIGxpc3QgPSAkKCB0aGlzICksCgkJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibW9iaWxlLWxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHJlcGxhY2VEaXZpZGVycyA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQl2YXIgbGlzID0gbGlzdC5maW5kKCAnbGknICksCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsIGxpLCBkaXZpZGVyVGV4dDsKCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbaV07CgkJCWRpdmlkZXJUZXh0ID0gbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdkYXRhLScgKyAkLm1vYmlsZS5ucyArICdyb2xlJywgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9OwoKCXZhciBhZnRlckxpc3R2aWV3UmVmcmVzaCA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LnVuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCQlyZXBsYWNlRGl2aWRlcnMoKTsKCQlsaXN0dmlldy5yZWZyZXNoKCk7CgkJbGlzdC5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJfTsKCglhZnRlckxpc3R2aWV3UmVmcmVzaCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogdW5jaGVja2VkU3RhdGUsCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJYWN0aXZlID0gIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPyBhY3RpdmUgOiAiIiApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMuY2hlY2tlZGljb24gfSApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCBjaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLnVuY2hlY2tlZGljb24gfSApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNoZWNrYm94cmFkaW8ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQkvLyBjcmVhdGUgYSBjb3B5IG9mIHRoaXMub3B0aW9ucyB3ZSBjYW4gcGFzcyB0byBidXR0b25NYXJrdXAKCQkJbyA9ICggZnVuY3Rpb24oIHRkbyApIHsKCQkJCXZhciBrZXksIHJldCA9IHt9OwoKCQkJCWZvciAoIGtleSBpbiB0ZG8gKSB7CgkJCQkJaWYgKCB0ZG9bIGtleSBdICE9PSBudWxsICYmIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCQkJCXJldFsga2V5IF0gPSB0ZG9bIGtleSBdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gcmV0OwoJCQl9ICkoIHRoaXMub3B0aW9ucyApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gZ2V0IHRoZSBpbmhlcml0ZWQgdGhlbWUKCQkvLyBUT0RPIGNlbnRyYWxpemUgZm9yIGFsbCB3aWRnZXRzCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQlpZiAoIGNsYXNzZXMgKSB7CgkJCQljbGFzc2VzICs9ICIgdWktc3VibWl0IjsKCQkJfSBlbHNlIHsKCQkJCWNsYXNzZXMgPSAidWktc3VibWl0IjsKCQkJfQoJCX0KCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoIG8gKQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wID0ge307CgoJCW9wWyBrZXkgXSA9IHZhbHVlOwoJCWlmICgga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJdGhpcy5idXR0b24uYnV0dG9uTWFya3VwKCBvcCApOwoJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlciggIl9zZXRPcHRpb24iLCBrZXksIHZhbHVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzU2VsZWN0ID0gdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGNUeXBlID09PSAic2VsZWN0IiwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCQkJbWluID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlcjsKCQkJCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gW3RoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyICIgOiAidWktc2xpZGVyLXRyYWNrICIsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCIsIG1pbmlDbGFzc10uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogInNsaWRlciIsCgkJCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCQkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIHZhciBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgc2xpZGVyVGhlbWUsICIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCQkKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgkJCQoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gT25seSBhZGQgZm9jdXMgY2xhc3MgdG8gdG9nZ2xlIHN3aXRjaCwgc2xpZGVycyBnZXQgaXQgYXV0b21hdGljYWxseSBmcm9tIHVpLWJ0bgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCX0sCgoJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkvLyByYW5nZS9udW1iZXIgaW5wdXRzIGRvZXNuJ3QgdHJpZ2dlciBhIGNoYW5nZSB1bnRpbCB0aGUgZmllbGQgaXMKCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCV9jb250cm9sVk1vdXNlVXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJfQoJfSwKCglfc2xpZGVyVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICEoIGV2ZW50LndoaWNoID09PSAxIHx8IGV2ZW50LndoaWNoID09PSAwICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCQoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgkJCQkKCQkJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSB0aGlzLnVzZXJNb2RpZmllZAoJCQkJdGhpcy51c2VyTW9kaWZpZWQgPSB0aGlzLmJlZm9yZVN0YXJ0ICE9PSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMudmFsdWUgIT09IHRoaXMuX3ZhbHVlKCkgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleCA6IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC52YWwoKSApIDsKCX0sCgoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci10cmFjayIsIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgKCB0aGlzLm9wdGlvbnMubWluaSApID8gIiB1aS1taW5pIjoiIl0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pOwoKCQl2YXIgcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2gsCgkJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLAoJCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoJCQkKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJdmFyIHBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJZGlzYWJsZWQ6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Vjb25kTGFiZWwsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9XCJ1aS1yYW5nZXNsaWRlci1zbGlkZXJzXCIgLz4iICkuYXBwZW5kVG8oICRlbCApOwoJCQkKCQkJaWYgKCAkZWwuZmluZCggImxhYmVsIiApLmxlbmd0aCA+IDEgKSB7CgkJCQlzZWNvbmRMYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkubGFzdCgpLmhpZGUoKTsKCQkJfQoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoJCQkKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJbGFiZWwucHJlcGVuZFRvKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgkJCQoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCQkJCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQgCgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl0aGlzLl9zdXBlckFwcGx5KCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgkJCQoJCQkKCQkJaWYoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICl7CgkJCQl0aGlzU2xpZGVyLmJsdXIoKTsKCQkJfSBlbHNlIGlmKCBldmVudC50eXBlID09PSAibW91c2Vkb3duIiApewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMSApOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJfQoJCQkKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQoJCQlpZiAoIG1pbiA+PSBtYXggKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfdXBkYXRlSGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1pbiA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCW1heCA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApLmZpbmQoICJsYWJlbCIgKS5zaG93KCk7CgkJCXRoaXMuX2lucHV0Rmlyc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckZpcnN0ICk7CgkJCXRoaXMuX2lucHV0TGFzdC5hZnRlciggdGhpcy5fc2xpZGVyTGFzdCApOwoJCQl0aGlzLl9zbGlkZXJzLnJlbW92ZSgpOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QgdWktcmFuZ2VzbGlkZXItbGFzdCIgKS5zbGlkZXIoICJkZXN0cm95IiApOwoJCX0KCgl9KTsKCiQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5tb2JpbGUucmFuZ2VzbGlkZXIsICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUucmFuZ2VzbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykgKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICk7Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJfSwKCglfZm9jdXNCdXR0b24gOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCX0sIDQwKTsKCX0sCgoJX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnNlbGVjdC5maW5kKCAib3B0aW9uIiApOwoJfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBjbGFzc2VzID0gIiI7CgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaW5saW5lID0gb3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG9wdGlvbnMubWluaSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAibWluaSIgKSwKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PT0gLTEgPyAwIDogdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoKCQkJLy8gVE9ETyB2YWx1ZXMgYnV0dG9uSWQgYW5kIG1lbnVJZCBhcmUgdW5kZWZpbmVkIGhlcmUKCQkJYnV0dG9uID0gdGhpcy5idXR0b24KCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuc2VsZWN0ICkKCQkJCS5idXR0b25NYXJrdXAoIHsKCQkJCQl0aGVtZTogb3B0aW9ucy50aGVtZSwKCQkJCQlpY29uOiBvcHRpb25zLmljb24sCgkJCQkJaWNvbnBvczogaWNvbnBvcywKCQkJCQlpbmxpbmU6IGlubGluZSwKCQkJCQljb3JuZXJzOiBvcHRpb25zLmNvcm5lcnMsCgkJCQkJc2hhZG93OiBvcHRpb25zLnNoYWRvdywKCQkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3csCgkJCQkJbWluaTogbWluaQoJCQkJfSk7CgoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoKCQkvLyBPcGVyYSBkb2VzIG5vdCBwcm9wZXJseSBzdXBwb3J0IG9wYWNpdHkgb24gc2VsZWN0IGVsZW1lbnRzCgkJLy8gSW4gTWluaSwgaXQgaGlkZXMgdGhlIGVsZW1lbnQsIGJ1dCBub3QgaXRzIHRleHQKCQkvLyBPbiB0aGUgZGVza3RvcCxpdCBzZWVtcyB0byBkbyB0aGUgb3Bwb3NpdGUKCQkvLyBmb3IgdGhlc2UgcmVhc29ucywgdXNpbmcgdGhlIG5hdGl2ZU1lbnUgb3B0aW9uIHJlc3VsdHMgaW4gYSBmdWxsIG5hdGl2ZSBzZWxlY3QgaW4gT3BlcmEKCQlpZiAoIG9wdGlvbnMubmF0aXZlTWVudSAmJiB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gKSB7CgkJCWJ1dHRvbi5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoJCQkKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDAgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CQkJCQoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpblNpemUsIHNlZ1NpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCQl2YXIgcmV0ID0gZGVzaXJlZDsKCgkJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJCXJldCA9IG9mZnNldCArICggd2luU2l6ZSAtIHNlZ1NpemUgKSAvIDI7CgkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCQlyZXQgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ1NpemUgLyAyICksIG9mZnNldCArIHdpblNpemUgLSBzZWdTaXplICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdzsKCgkJcmV0dXJuIHsKCQkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJCXk6ICR3aW4uc2Nyb2xsVG9wKCksCgkJCWN4OiAoIHdpbmRvdy5pbm5lcldpZHRoIHx8ICR3aW4ud2lkdGgoKSApLAoJCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgkJfTsKCX0KCgkkLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQkJc2hhZG93OiB0cnVlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCQl0b2xlcmFuY2U6IG51bGwsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgkJCWRpc21pc3NpYmxlOiB0cnVlLAoKCQkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkJLy8gICAgICBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ3ODQKCQkJLy8KCQkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCQloaXN0b3J5OiAhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRQoJCX0sCgoJCV9lYXRFdmVudEFuZENsb3NlOiBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCWlmICggcG9wdXBIZWlnaHQgPiB0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCkgKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCBlICk7CgkJCX0KCQl9LAoKCQlfZXhwZWN0UmVzaXplRXZlbnQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCQlpZiAoIHdpbkNvb3Jkcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy54ICYmCgkJCQkJd2luQ29vcmRzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnkgJiYKCQkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQkJd2luQ29vcmRzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeSApIHsKCQkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJCXRpbWVvdXRJZDogc2V0VGltZW91dCggJC5wcm94eSggdGhpcywgIl9yZXNpemVUaW1lb3V0IiApLCAyMDAgKSwKCQkJCXdpbkNvb3Jkczogd2luQ29vcmRzCgkJCX07CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQlfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgkJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJCX0KCgkJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSwKCgkJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCgkJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJCX0KCQkJdGhpcy5faWdub3JlUmVzaXplVG8gPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgc2VsZi5faWdub3JlUmVzaXplVG8gPSAwOyB9LCAxMDAwICk7CgkJfSwKCgkJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKQoJCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQkJfQoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCQl9CgkJfSwKCgkJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCQkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCQlfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHRndCA9IGUudGFyZ2V0LCAkdGd0LCB1aSA9IHRoaXMuX3VpOwoKCQkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRndCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQkkdGd0ID0gJCggZS50YXJnZXQgKTsKCQkJCWlmICggMCA9PT0gJHRndC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJHRndC5ibHVyKCk7CgkJCQkJfSk7CgkJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJCXVpLmZvY3VzRWxlbWVudCA9ICR0Z3Q7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWkgPSB7CgkJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4nPjwvZGl2PiIgKSwKCQkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuJz48L2Rpdj4iICkKCQkJCX0sCgkJCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCQlteUlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCQl0aGlzLm9wdGlvbnMuaGlzdG9yeSA9IHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkJaWYgKCB0aGlzUGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCQl0aGlzUGFnZSA9ICQoICJib2R5IiApOwoJCQl9CgoJCQkvLyBkZWZpbmUgdGhlIGNvbnRhaW5lciBmb3IgbmF2aWdhdGlvbiBldmVudCBiaW5kaW5ncwoJCQkvLyBUT0RPIHRoaXMgd291bGQgYmUgbmljZSBhdCB0aGUgdGhlIG1vYmlsZSB3aWRnZXQgbGV2ZWwKCQkJdGhpcy5vcHRpb25zLmNvbnRhaW5lciA9IHRoaXMub3B0aW9ucy5jb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQl0aGlzUGFnZS5hcHBlbmQoIHVpLnNjcmVlbiApOwoJCQl1aS5jb250YWluZXIuaW5zZXJ0QWZ0ZXIoIHVpLnNjcmVlbiApOwoJCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoaXMuZWxlbWVudCApOwoJCQlpZiAoIG15SWQgKSB7CgkJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQkJdWkucGxhY2Vob2xkZXIuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJCX0KCQkJdWkuY29udGFpbmVyLmFwcGVuZCggdGhpcy5lbGVtZW50ICk7CgkJCXVpLmZvY3VzRWxlbWVudCA9IHVpLmNvbnRhaW5lcjsKCgkJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLXBvcHVwIiApOwoKCQkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3Njcm9sbFRvcDogMCwKCQkJCV9wYWdlOiB0aGlzUGFnZSwKCQkJCV91aTogdWksCgkJCQlfZmFsbGJhY2tUcmFuc2l0aW9uOiAiIiwKCQkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlfcHJlcmVxczogbnVsbCwKCQkJCV9pc09wZW46IGZhbHNlLAoJCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQkJX2lnbm9yZVJlc2l6ZVRvOiAwLAoJCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoKCQkJdWkuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCAkLnByb3h5KCB0aGlzLCAiX2VhdEV2ZW50QW5kQ2xvc2UiICkgKTsKCgkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJCX0pOwoJCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsKCQkJCWZvY3VzaW46ICQucHJveHkoIHRoaXMsICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiApCgkJCX0pOwoJCX0sCgoJCV9hcHBseVRoZW1lOiBmdW5jdGlvbiggZHN0LCB0aGVtZSwgcHJlZml4ICkgewoJCQl2YXIgY2xhc3NlcyA9ICggZHN0LmF0dHIoICJjbGFzcyIgKSB8fCAiIikuc3BsaXQoICIgIiApLAoJCQkJYWxyZWFkeUFkZGVkID0gdHJ1ZSwKCQkJCWN1cnJlbnRUaGVtZSA9IG51bGwsCgkJCQltYXRjaGVzLAoJCQkJdGhlbWVTdHIgPSBTdHJpbmcoIHRoZW1lICk7CgoJCQl3aGlsZSAoIGNsYXNzZXMubGVuZ3RoID4gMCApIHsKCQkJCWN1cnJlbnRUaGVtZSA9IGNsYXNzZXMucG9wKCk7CgkJCQltYXRjaGVzID0gKCBuZXcgUmVnRXhwKCAiXnVpLSIgKyBwcmVmaXggKyAiLShbYS16XSkkIiApICkuZXhlYyggY3VycmVudFRoZW1lICk7CgkJCQlpZiAoIG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAxICkgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG1hdGNoZXNbIDEgXTsKCQkJCQlicmVhazsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFRoZW1lID0gbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCB0aGVtZSAhPT0gY3VycmVudFRoZW1lICkgewoJCQkJZHN0LnJlbW92ZUNsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCAhICggdGhlbWUgPT09IG51bGwgfHwgdGhlbWUgPT09ICJub25lIiApICkgewoJCQkJCWRzdC5hZGRDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyB0aGVtZVN0ciApOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgdmFsdWUsICJib2R5IiApOwoJCX0sCgoJCV9zZXRPdmVybGF5VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCB2YWx1ZSwgIm92ZXJsYXkiICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXRoaXMuX3VpLnNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfSwKCgkJX3NldFNoYWRvdzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIHZhbHVlICk7CgkJfSwKCgkJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfSwKCgkJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICYmIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfSwKCgkJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCX0KCQl9LAoKCQlfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQl2YXIgYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQkJY2FzZSAxOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJCWNhc2UgMjoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQkJY2FzZSA0OgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQlkZWZhdWx0OgoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl2YXIgZXhjbHVzaW9ucywgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJCWlmICggdGhpc1sgc2V0dGVyIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXNbIHNldHRlciBdKCB2YWx1ZSApOwoJCQl9CgoJCQkvLyBUT0RPIFJFTU9WRSBGT1IgMS4yLjEgYnkgbW92aW5nIHRoZW0gb3V0IHRvIGEgZGVmYXVsdCBvcHRpb25zIG9iamVjdAoJCQlleGNsdXNpb25zID0gWwoJCQkJImluaXRTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rU2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua0V2ZW50cyIsCgkJCQkibmF2aWdhdGVFdmVudHMiLAoJCQkJImNsb3NlRXZlbnRzIiwKCQkJCSJoaXN0b3J5IiwKCQkJCSJjb250YWluZXIiCgkJCV07CgoJCQkkLm1vYmlsZS53aWRnZXQucHJvdG90eXBlLl9zZXRPcHRpb24uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQlpZiAoICQuaW5BcnJheSgga2V5LCBleGNsdXNpb25zICkgPT09IC0xICkgewoJCQkJLy8gUmVjb3JkIHRoZSBvcHRpb24gY2hhbmdlIGluIHRoZSBvcHRpb25zIGFuZCBpbiB0aGUgRE9NIGRhdGEtKiBhdHRyaWJ1dGVzCgkJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJCX0KCQl9LAoKCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBnaXZlbiBjb29yZGluYXRlcwoJCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQl2YXIKCQkJCXdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpLAoJCQkJcmMgPSB7CgkJCQkJeDogdGhpcy5fdG9sZXJhbmNlLmwsCgkJCQkJeTogd2luQ29vcmRzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCQljeDogd2luQ29vcmRzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCQljeTogd2luQ29vcmRzLmN5IC0gdGhpcy5fdG9sZXJhbmNlLnQgLSB0aGlzLl90b2xlcmFuY2UuYgoJCQkJfSwKCQkJCW1lbnVTaXplLCByZXQ7CgoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByYy5jeCApOwoJCQltZW51U2l6ZSA9IHsKCQkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJCX07CgoJCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkJLy8gdGhlIHdpbmRvdyB0b2xlcmFuY2VzLiBUaGlzIHdpbGwgY2VudGVyIHdydC4gdGhlIHdpbmRvdyBpZiB0aGUgcG9wdXAgaXMgdG9vIGxhcmdlLgoJCQlyZXQgPSB7CgkJCQl4OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3gsIG1lbnVTaXplLmN4LCByYy54LCBkZXNpcmVkLnggKSwKCQkJCXk6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeSwgbWVudVNpemUuY3ksIHJjLnksIGRlc2lyZWQueSApCgkJCX07CgoJCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJCXJldC55ID0gTWF0aC5tYXgoIDAsIHJldC55ICk7CgoJCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJCS8vIGZpeCBmb3IgJC5tb2JpbGUuZG9jdW1lbnQuaGVpZ2h0KCkgYnVnIGluIGNvcmUgMS43LjIuCgkJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCQlkb2NIZWlnaHQgPSBNYXRoLm1heCggZG9jRWwuY2xpZW50SGVpZ2h0LCBkb2NCb2R5LnNjcm9sbEhlaWdodCwgZG9jQm9keS5vZmZzZXRIZWlnaHQsIGRvY0VsLnNjcm9sbEhlaWdodCwgZG9jRWwub2Zmc2V0SGVpZ2h0ICk7CgoJCQlyZXQueSAtPSBNYXRoLm1pbiggcmV0LnksIE1hdGgubWF4KCAwLCByZXQueSArIG1lbnVTaXplLmN5IC0gZG9jSGVpZ2h0ICkgKTsKCgkJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07CgkJfSwKCgkJX2NyZWF0ZVByZXJlcXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXEsIGNvbnRhaW5lclByZXJlcSwgd2hlbkRvbmUgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIGFuZCBzZWxmLl9wcmVyZXFzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbgoJCQkvLyB0aGUgY2xvc3VyZSBvZiB0aGUgZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlIGxvY2FsIHZhcmlhYmxlIGFuZAoJCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJCS8vIG5leHQgdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQgdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaAoJCQkvLyAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMgZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdCBjYWxsZWQgZm9yCgkJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJCS8vIC0gbWFraW5nIGl0IHN0YWxlLiBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZSBzZWxmLl9wcmVyZXFzIGVuc3VyZXMgdGhhdAoJCQkvLyBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUgLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJCXByZXJlcXMgPSB7CgkJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJCX07CgoJCQlwcmVyZXFzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQljb250YWluZXJQcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQkkLndoZW4oIHByZXJlcXMuc2NyZWVuLCBwcmVyZXFzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNlbGYuX3ByZXJlcXMgPSBudWxsOwoJCQkJCXdoZW5Eb25lKCk7CgkJCQl9CgkJCX0pOwoKCQkJc2VsZi5fcHJlcmVxcyA9IHByZXJlcXM7CgkJfSwKCgkJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQkJfQoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXFzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKQoJCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCWFyZ3MucHJlcmVxcy5jb250YWluZXIucmVzb2x2ZSgpOwoJCX0sCgoJCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCQkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJCS8vIG9wdGlvbnM6IHsgeDogY29vcmRpbmF0ZSwgeTogY29vcmRpbmF0ZSwgcG9zaXRpb25Ubzogc3RyaW5nOiAib3JpZ2luIiwgIndpbmRvdyIsIG9yIGpRdWVyeSBzZWxlY3RvcgoJCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggbyApIHsKCQkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksIHggPSBvLngsIHkgPSBvLnksIHBUbyA9IG8ucG9zaXRpb25UbzsKCgkJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJCX0gZWxzZSB7CgkJCQkJdHJ5IHsKCQkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQkJaWYgKCBkc3QgKSB7CgkJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQkJaWYgKCBkc3QubGVuZ3RoID09PSAwICkgewoJCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gSWYgYW4gZWxlbWVudCB3YXMgZm91bmQsIGNlbnRlciBvdmVyIGl0CgkJCWlmICggZHN0ICkgewoJCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQkJeCA9IG9mZnNldC5sZWZ0ICsgZHN0Lm91dGVyV2lkdGgoKSAvIDI7CgkJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHggYW5kIHkgYXJlIHZhbGlkIG51bWJlcnMgLSBjZW50ZXIgb3ZlciB0aGUgd2luZG93CgkJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQl9CgkJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCQl5ID0gd2luQ29vcmRzLmN5IC8gMiArIHdpbkNvb3Jkcy55OwoJCQl9CgoJCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07CgkJfSwKCgkJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvICkgewoJCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJCW8gPSB7IHg6IG8ueCwgeTogby55LCBwb3NpdGlvblRvOiBvLnBvc2l0aW9uVG8gfTsKCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiwgbyApOwoJCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG8gKSApICk7CgkJfSwKCgkJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fcmVwb3NpdGlvbiggbyApOwoJCQl9CgkJfSwKCgkJX29wZW5QcmVyZXFzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCXRoaXMuX3RyaWdnZXIoICJhZnRlcm9wZW4iICk7CgkJfSwKCgkJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgbyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJCWlmKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9KCkpOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLm5vb3AsCgkJCQkkLm5vb3AsCgkJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXFzQ29tcGxldGUiICkgKTsKCgkJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gby50cmFuc2l0aW9uOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG8udHJhbnNpdGlvbiApOwoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIHRoaXMuX3BhZ2UuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLl9wYWdlLCAiYyIgKSApOwoJCQl9CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQkJdGhpcy5fcmVwb3NpdGlvbiggbyApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCQkvKiBUT0RPOgoJCQkJVGhlIG5hdGl2ZSBicm93c2VyIG9uIEFuZHJvaWQgNC4wLlggKCJJY2UgQ3JlYW0gU2FuZHdpY2giKSBzdWZmZXJzIGZyb20gYW4gaXNzdWUgd2hlcmUgdGhlIHBvcHVwIG92ZXJsYXkgYXBwZWFycyB0byBiZSB6LWluZGV4ZWQKCQkJCWFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluCgkJCQl0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9zY290dGplaGwvRGV2aWNlLUJ1Z3MvaXNzdWVzLzMKCgkJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODc0CgkJCQkqLwoKCQkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgkJCX0KCQkJdGhpcy5fYW5pbWF0ZSh7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0cnVlLAoJCQkJdHJhbnNpdGlvbjogby50cmFuc2l0aW9uLAoJCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9jbG9zZVByZXJlcVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKQoJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFzRG9uZTogZnVuY3Rpb24oKSB7CgkJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJCX0sCgoJCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCgkJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyByZXZlcnNlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxU2NyZWVuIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcUNvbnRhaW5lciIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFzRG9uZSIgKSApOwoKCQkJdGhpcy5fYW5pbWF0ZSggewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCQl0aGlzLl9zZXRUaGVtZSggIm5vbmUiICk7CgkJCXRoaXMuZWxlbWVudAoJCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkJLy8gdG8gdGhlIERPTSBhdCB0aGUgdGltZSB0aGUgd2lkZ2V0IHdhcyBjcmVhdGVkLCBhbmQgc28gdGhlIHBheWxvYWQKCQkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJCS8vIHdpbGwgY2F1c2UgYW4gaW5maW5pdGUgcmVjdXJzaW9uIC0gIzUyNDQKCQkJCS5kZXRhY2goKQoJCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIiApOwoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJCX0KCQl9LAoKCQlfY2xvc2VQb3B1cDogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciBwYXJzZWREc3QsIHRvVXJsLCBvID0gdGhpcy5vcHRpb25zLCBpbW1lZGlhdGUgPSBmYWxzZTsKCgkJCS8vIHJlc3RvcmUgbG9jYXRpb24gb24gc2NyZWVuCgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCQlpZiAoIGUgJiYgZS50eXBlID09PSAicGFnZWJlZm9yZWNoYW5nZSIgJiYgZGF0YSApIHsKCQkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQkJaWYgKCB0eXBlb2YgZGF0YS50b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQkJfSBlbHNlIHsKCQkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJfQoJCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCQl0b1VybCA9IHBhcnNlZERzdC5wYXRobmFtZSArIHBhcnNlZERzdC5zZWFyY2ggKyBwYXJzZWREc3QuaGFzaDsKCgkJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQkJby5jb250YWluZXIudW5iaW5kKCBvLmNsb3NlRXZlbnRzICk7CgkJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIG8uY2xvc2VMaW5rU2VsZWN0b3IsIG8uY2xvc2VMaW5rRXZlbnRzICk7CgoJCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7CgkJfSwKCgkJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJCS8vICAgICAgYWx0ZXIgdGhlIHVybCAoZWcsIGRpYWxvZ3MgZnJvbSBwb3B1cHMpCgkJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIKCQkJCS5vbmUoIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7CgkJfSwKCgkJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIG9wdHMgPSB0aGlzLm9wdGlvbnMsIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5OwoKCQkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJCWlmKCAhKCBvcHRzLmhpc3RvcnkgKSApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCQlzZWxmLmVsZW1lbnQKCQkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSk7CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS51cmxIaXN0b3J5OwoJCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJCWN1cnJlbnRJc0RpYWxvZyA9IGFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApOwoJCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJCWlmICggaGFzSGFzaCApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKXsKCQkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQkJfSBlbHNlIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCQl9CgoJCQkvLyBUYWNrIG9uIGFuIGV4dHJhIGhhc2hrZXkgaWYgdGhpcyBpcyB0aGUgZmlyc3QgcGFnZSBhbmQgd2UndmUganVzdCByZWNvbnN0cnVjdGVkIHRoZSBpbml0aWFsIGhhc2gKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGhhc2hrZXk7CgkJCX0KCgkJCS8vIHN3YWxsb3cgdGhlIHRoZSBpbml0aWFsIG5hdmlnYXRpb24gZXZlbnQsIGFuZCBiaW5kIGZvciB0aGUgbmV4dAoJCQkkKHdpbmRvdykub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQl9KTsKCgkJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHtyb2xlOiAiZGlhbG9nIn0gKTsKCQl9LAoKCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX3Njcm9sbFRvcCA9ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCWlmKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJCX0KCQl9Cgl9KTsKCgoJLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAoJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCQl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlzY29wZSA9ICggKCBjbG9zZXN0UGFnZS5sZW5ndGggPT09IDAgKSA/ICQoICJib2R5IiApIDogY2xvc2VzdFBhZ2UgKSwKCQkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkJLy8gICAgICBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQkJcG9wdXAgPSAkKCAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCRsaW5rLmF0dHIoICJocmVmIiApKS5oYXNoLCBzY29wZVswXSApLAoJCQlvZmZzZXQ7CgoJCWlmICggcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJCX0pOwoJCX0KCgkJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJLy8gQ2hlY2sgaWYgd2UgYXJlIGluIGEgbGlzdHZpZXcKCQkJdmFyICRwYXJlbnQgPSAkbGluay5wYXJlbnQoKS5wYXJlbnQoKTsKCQkJaWYgKCRwYXJlbnQuaGFzQ2xhc3MoInVpLWxpIikpIHsKCQkJCSRsaW5rID0gJHBhcmVudC5wYXJlbnQoKTsKCQkJfQoJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9LCAzMDAgKTsKCX07CgoJLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsoIGRhdGEub3B0aW9ucy5saW5rICk7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9KTsKCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKSB7CgoJCXZhciBzZWxlY3QgPSB3aWRnZXQuc2VsZWN0LAoJCQlvcmlnRGVzdHJveSA9IHdpZGdldC5fZGVzdHJveSwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlwcmVmaXggPSAoIHNlbGVjdElEID8gc2VsZWN0SUQgOiAoICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ1dWlkLSIgKyB3aWRnZXQudXVpZCApICksCgkJCXBvcHVwSUQgPSBwcmVmaXggKyAiLWxpc3Rib3giLAoJCQlkaWFsb2dJRCA9IHByZWZpeCArICItZGlhbG9nIiwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBpZD0nIiArIGRpYWxvZ0lEICsgIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJ0aGVtZT0nIisgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKyInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAib3ZlcmxheS10aGVtZT0nIisgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsiJz4iICsKCQkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyBsYWJlbC5nZXRFbmNvZGVkVGV4dCgpICsgIjwvZGl2PiIrCgkJCQkiPC9kaXY+IisKCQkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCQkiPC9kaXY+IiApLAoKCQkJbGlzdGJveCA9ICAkKCAiPGRpdiBpZD0nIiArIHBvcHVwSUQgKyAiJyBjbGFzcz0ndWktc2VsZWN0bWVudSc+IiApLmluc2VydEFmdGVyKCB3aWRnZXQuc2VsZWN0ICkucG9wdXAoIHsgdGhlbWU6IHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSB9ICksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMuZGl2aWRlclRoZW1lICkKCQkJCQkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiAoIHdpZGdldC5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKTsKCQl9CgoJCSQuZXh0ZW5kKCB3aWRnZXQsIHsKCQkJc2VsZWN0OiB3aWRnZXQuc2VsZWN0LAoJCQlzZWxlY3RJRDogc2VsZWN0SUQsCgkJCWJ1dHRvbklkOiBidXR0b25JZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSUQ6IHBvcHVwSUQsCgkJCWRpYWxvZ0lEOiBkaWFsb2dJRCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJaWYgKCBzZWxmLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkJCS8vIG5vbmUgcHJlc2VudC4KCQkJCQlzZWxmLl9vcmlnVGFiSW5kZXggPSAoIHNlbGYuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgfHwgc2VsZi5pc09wZW4gKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fAoJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCQkJCXNlbGYuX2RlY2lkZUZvcm1hdCgpOwoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgc2VsZi5wb3B1cElEICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAicG9wdXAiICk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlzZWxmLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHNlbGYuZGlhbG9nSUQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJkaWFsb2ciICk7CgkJCQkJCX0KCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCQkvLyBEbyBub3QgcHJldmVudCBkZWZhdWx0LCBzbyB0aGUgbmF2aWdhdGlvbiBtYXkgaGF2ZSBhIGNoYW5jZSB0byBhY3R1YWxseSBvcGVuIHRoZSBjaG9zZW4gZm9ybWF0CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCgkJCQkJfSkKCQkJCQkuYmluZCggImZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDM4OgoJCQkJCQkJcHJldiA9IGxpLnByZXYoKS5ub3QoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCgkJCQkJCQlpZiAoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJaWYgKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCWNhc2UgMTM6CgkJCQkJCWNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCQkJc2VsZi5saXN0Ym94LmJpbmQoICJwb3B1cGFmdGVyY2xvc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCWluZGljaWVzOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmICggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCQkJc2VsZi5tZW51UGFnZS5kaWFsb2coICJjbG9zZSIgKTsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLmxpc3Rib3gucG9wdXAoICJjbG9zZSIgKTsKCQkJCX0KCgkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCQkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQkJCXNlbGYuaXNPcGVuID0gZmFsc2U7CgkJCX0sCgoJCQlvcGVuOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuYnV0dG9uLmNsaWNrKCk7CgkJCX0sCgoJCQlfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCQkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQlmdW5jdGlvbiBmb2N1c01lbnVJdGVtKCkgewoJCQkJCXZhciBzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgYSIgKTsKCQkJCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggImxpLnVpLWJ0bjpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlCgkJCQkJCS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJZm9jdXNNZW51SXRlbSgpOwoJCQkJCQl9KQoJCQkJCQkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCQkJc2VsZi5saXN0Ym94Lm9uZSggInBvcHVwYWZ0ZXJvcGVuIiwgZm9jdXNNZW51SXRlbSApOwoJCQkJfQoJCQl9LAoKCQkJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJCQlvcHRncm91cHMgPSBbXSwKCQkJCQlsaXMgPSBbXSwKCQkJCQlkYXRhSWNvbiA9IHNlbGYuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIjsKCgkJCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoKCQkJCXZhciAkb3B0aW9ucyA9IHNlbGYuc2VsZWN0LmZpbmQoICJvcHRpb24iICksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAncGxhY2Vob2xkZXInLAoJCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQkJCXZhciBvcHRpb24gPSAkb3B0aW9uc1tpXSwKCQkJCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2EnICksCgkJCQkJCWNsYXNzZXMgPSBbXTsKCgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ2hyZWYnLCAnIycgKTsKCQkJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAoIHBhcmVudCAhPT0gc2VsZWN0ICYmIHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAib3B0Z3JvdXAiICkgewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCAnbGFiZWwnICk7CgkJCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAnbGlzdC1kaXZpZGVyJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdmlkZXIgKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSB0cnVlOwoKCQkJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJCQkvLyByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQkJCX0KCQkJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0cixpICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCX0KCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQkJCX0KCgkJCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggIjxhPiIsIHsKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJCX0pOwoJCQl9LAoKCQkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5jbG9zZSgpOwoKCQkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IGZhbHNlICkgewoJCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnNlbGVjdC5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFJlbW92ZSB0aGUgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGlmIHdlIHdlcmUgdGhlIG9uZXMgdG8gYWRkIGl0CgkJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCQkvLyBDaGFpbiB1cAoJCQkJb3JpZ0Rlc3Ryb3kuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgkJfSk7Cgl9OwoKCS8vIGlzc3VlICMzODk0IC0gY29yZSBkb2Vzbid0IHRyaWdnZXIgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHNlbGVjdG1lbnVXaWRnZXQgPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAibW9iaWxlLXNlbGVjdG1lbnUiICk7CgoJCWlmICggIXNlbGVjdG1lbnVXaWRnZXQub3B0aW9ucy5uYXRpdmVNZW51ICYmCgkJCQlzZWxlY3RtZW51V2lkZ2V0LmVsZW1lbnQucGFyZW50cyggIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiICkubGVuZ3RoID09PSAwICkgewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJCW9wdGlvbnM6IHsKCQkJc2hhZG93OiBmYWxzZSwKCQkJY29ybmVyczogdHJ1ZSwKCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJdHlwZTogInZlcnRpY2FsIiwKCQkJbWluaTogZmFsc2UsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJdWkgPSB7CgkJCQkJaW5uZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtY29udHJvbHMnPjwvZGl2PiIgKSwKCQkJCQlsZWdlbmQ6ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJfSwKCQkJCWdyb3VwbGVnZW5kID0gJGVsLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJJGVsLndyYXBJbm5lciggdWkuaW5uZXIgKTsKCQkJaWYgKCBncm91cGxlZ2VuZC5sZW5ndGggKSB7CgkJCQl1aS5sZWdlbmQuYXBwZW5kKCBncm91cGxlZ2VuZCApLmluc2VydEJlZm9yZSggJGVsLmNoaWxkcmVuKCAwICkgKTsKCQkJfQoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCIgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoJCX0sCgoJCV9pbml0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0VHlwZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyB2YWx1ZSApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfSwKCgkJY29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciBlbHMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCQljcmVhdGUgPSB0aGlzLl9pbml0aWFsUmVmcmVzaDsKCQkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJCX0KCQkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLCB0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLCBjcmVhdGUgKTsKCQkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCQl9Cgl9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgoJLy8gVE9ETzogSW1wbGVtZW50IGEgbWVjaGFuaXNtIHRvIGFsbG93IHdpZGdldHMgdG8gYmVjb21lIGVuaGFuY2VkIGluIHRoZQoJLy8gY29ycmVjdCBvcmRlciB3aGVuIHRoZWlyIGNvcnJlY3QgZW5oYW5jZW1lbnQgZGVwZW5kcyBvbiBvdGhlciB3aWRnZXRzIGluCgkvLyB0aGUgcGFnZSBiZWluZyBjb3JyZWN0bHkgZW5oYW5jZWQgYWxyZWFkeS4KCS8vCgkvLyBGb3Igbm93LCB3ZSB3YWl0IHVudGlsIGRvbS1yZWFkeSB0byBhdHRhY2ggdGhlIGNvbnRyb2xncm91cCdzIGVuaGFuY2VtZW50CgkvLyBob29rLCBiZWNhdXNlIGJ5IHRoYXQgdGltZSwgYWxsIHRoZSBvdGhlciB3aWRnZXRzJyBlbmhhbmNlbWVudCBob29rcyBzaG91bGQKCS8vIGFscmVhZHkgYmUgaW4gcGxhY2UsIGVuc3VyaW5nIHRoYXQgYWxsIHdpZGdldHMgdGhhdCBuZWVkIHRvIGJlIGdyb3VwZWQgd2lsbAoJLy8gYWxyZWFkeSBoYXZlIGJlZW4gZW5oYW5jZWQgYnkgdGhlIHRpbWUgdGhlIGNvbnRyb2xncm91cCBpcyBjcmVhdGVkLgoJJCggZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCQkkLm1vYmlsZS5jb250cm9sZ3JvdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7CgkJfSk7Cgl9KTsKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIGUudGFyZ2V0ICkKCQkuZmluZCggImEiICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLXBvcHVwLCAudWktcGFuZWwsIC51aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISQuc3VwcG9ydC5maXhlZFBvc2l0aW9uOwoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQkkcGFnZSA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgoJCQkvLyBGZWF0dXJlIGRldGVjdGluZyBzdXBwb3J0IGZvcgoJCQlpZiAoIG8uc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJc2VsZi5kZXN0cm95KCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1maXhlZCIgKTsKCgkJCS8vICJmdWxsc2NyZWVuIiBvdmVybGF5IHBvc2l0aW9uaW5nCgkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZnVsbHNjcmVlbiIgKTsKCQkJfQoJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQllbHNlewoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZpeGVkIiApOwoJCQl9CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3RoaXNQYWdlOiBudWxsCgkJCX0pOwogCgkJCXNlbGYuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoJCQlzZWxmLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkvL3BhZ2UgZXZlbnQgYmluZGluZ3MKCQkJLy8gRml4ZWQgdG9vbGJhcnMgcmVxdWlyZSBwYWdlIHpvb20gdG8gYmUgZGlzYWJsZWQsIG90aGVyd2lzZSB1c2FiaWxpdHkgaXNzdWVzIGNyb3AgdXAKCQkJLy8gVGhpcyBtZXRob2QgaXMgbWVhbnQgdG8gZGlzYWJsZSB6b29tIHdoaWxlIGEgZml4ZWQtcG9zaXRpb25lZCB0b29sYmFyIHBhZ2UgaXMgdmlzaWJsZQoJCQl0aGlzLl9vbiggdGhpcy5fdGhpc1BhZ2UsIHsKCQkJCSJwYWdlYmVmb3Jlc2hvdyI6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQkJIndlYmtpdEFuaW1hdGlvblN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJhbmltYXRpb25zdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVBhZ2VTaG93IiwKCQkJCSJwYWdlYmVmb3JlaGlkZSI6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJCX0pOwoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzLl90aGlzUGFnZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggJC5tb2JpbGUud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQl0aGlzSGVhZGVyID0gJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLl90aGlzUGFnZSApLAoJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKSwKCQkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgoJCQkJaWYgKCBuZXh0Rm9vdGVyLmxlbmd0aCB8fCBuZXh0SGVhZGVyLmxlbmd0aCApIHsKCgkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQluZXh0SGVhZGVyLnByZXBlbmRUbyggdGhpcyApOwoJCQkJCQluZXh0Rm9vdGVyLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApLAoJCQkJcG9zID0gcGFyc2VGbG9hdCggJGVsLmNzcyggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoKCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLiAKCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLl90aGlzUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciI7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0YnR5cGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0YnR5cGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoJ2luJyk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoIAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtIAoJCQkJCQkvL2NvbnRyb2xzIGNhdXNlcyBmaXhlZCBwb3NpdGlvbiwgdGFwLXRvZ2dsZSBmYWxzZSBIZWFkZXIgdG8gcmV2ZWFsIGl0c2VsZgoJCQkJCQkvLyBpc1Zpc2libGUgaW5zdGVhZCBvZiBzZWxmLl92aXNpYmxlIGJlY2F1c2UgdGhlIGZvY3VzaW4gYW5kIGZvY3Vzb3V0IGV2ZW50cyBmaXJlIHR3aWNlIGF0IHRoZSBzYW1lIHRpbWUKCQkJCQkJLy8gQWxzbyB1c2UgYSBkZWxheSBmb3IgaGlkaW5nIHRoZSB0b29sYmFycyBiZWNhdXNlIG9uIEFuZHJvaWQgbmF0aXZlIGJyb3dzZXIgZm9jdXNpbiBpcyBkaXJlY2x0eSBmb2xsb3dlZAoJCQkJCQkvLyBieSBhIGZvY3Vzb3V0IHdoZW4gYSBuYXRpdmUgc2VsZWN0cyBvcGVucyBhbmQgdGhlIG90aGVyIHdheSBhcm91bmQgd2hlbiBpdCBjbG9zZXMuCgkJCQkJCWlmICggZS50eXBlID09PSAiZm9jdXNvdXQiICYmICFpc1Zpc2libGUgKSB7CgkJCQkJCQlpc1Zpc2libGUgPSB0cnVlOwoJCQkJCQkJLy93YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGFuZCBzZWUgaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dAoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheUhpZGUgKTsKCQkJCQkJCWRlbGF5U2hvdyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuc2hvdygpOwoJCQkJCQkJfSwgMCApOyAKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOyAKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAiIiApOwoJCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1oZWFkZXItZml4ZWQgdWktZm9vdGVyLWZpeGVkIHVpLWhlYWRlci1mdWxsc2NyZWVuIHVpLWZvb3Rlci1mdWxsc2NyZWVuIGluIG91dCBmYWRlIHNsaWRlZG93biBzbGlkZXVwIHVpLWZpeGVkLWhpZGRlbiIgKTsKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtaGVhZGVyLWZpeGVkIHVpLXBhZ2UtZm9vdGVyLWZpeGVkIHVpLXBhZ2UtaGVhZGVyLWZ1bGxzY3JlZW4gdWktcGFnZS1mb290ZXItZnVsbHNjcmVlbiIgKTsKCQl9CgoJfSk7CgoJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCgkkLm1vYmlsZS5kb2N1bWVudAoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCS8vIERFUFJFQ0FURUQgaW4gMS4xOiBzdXBwb3J0IGZvciBkYXRhLWZ1bGxzY3JlZW49dHJ1ZXxmYWxzZSBvbiB0aGUgcGFnZSBlbGVtZW50LgoJCQkvLyBUaGlzIGxpbmUgZW5zdXJlcyBpdCBzdGlsbCB3b3JrcywgYnV0IHdlIHJlY29tbWVuZCBtb3ZpbmcgdGhlIGF0dHJpYnV0ZSB0byB0aGUgdG9vbGJhcnMgdGhlbXNlbHZlcy4KCQkJaWYgKCAkKCBlLnRhcmdldCApLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS5maXhlZHRvb2xiYXIsIHsKCgkJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fc3VwZXIoKTsKCQkJCXRoaXMuX3dvcmthcm91bmRzKCk7CgkJCX0sCgoJCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJCV93b3JrYXJvdW5kczogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCW9zID0gbnVsbCwKCQkJCXNlbGYgPSB0aGlzOwoJCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJCWlmKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApewoJCQkJCW9zID0gImlvcyI7CgkJCQl9IGVsc2UgaWYoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKXsKCQkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy9jaGVjayBvcyB2ZXJzaW9uIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJCWlmKCBvcyA9PT0gImlvcyIgKSB7CgkJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCX0gZWxzZSBpZiggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJCS8vQW5kcm9pZCAyLjMgcnVuIGFsbCBBbmRyb2lkIDIuMyB3b3JrYXJvdW5kCgkJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0sCgoJCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApLAoJCQkJCW9mZnNldCA9IE1hdGguYWJzKCRlbC5vZmZzZXQoKS50b3AgLSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkpOwoJCQkJaWYoICFoZWFkZXIgKSB7CgkJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZChvZmZzZXQgLSAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCkgKyAkZWwub3V0ZXJIZWlnaHQoKSktNjA7CgkJCQl9CgkJCQlyZXR1cm4gb2Zmc2V0OwoJCQl9LAoKCQkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbiAKCQkJX2JpbmRTY3JvbGxXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCS8vYmluZCB0byBzY3JvbGxzdG9wIGFuZCBjaGVjayBpZiB0aGUgdG9vbGJhcnMgYXJlIGNvcnJlY3RseSBwb3NpdGlvbmVkCgkJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkJLy9jaGVjayBpZiB0aGUgaGVhZGVyIGlzIHZpc2libGUgYW5kIGlmIGl0cyBpbiB0aGUgcmlnaHQgcGxhY2UKCQkJCQlpZiggdmlld3BvcnRPZmZzZXQgPiAyICYmIHNlbGYuX3Zpc2libGUpIHsKCQkJCQkJc2VsZi5fdHJpZ2dlclJlZHJhdygpOwoJCQkJCX0KCQkJCX19KTsKCQkJfSwKCgkJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCQkvL3RoZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgdGh1bWJuYWlsIGluIGEgbGlzdCB2aWV3IGNhdXNlcyBwcm9ibGVtcyB3aXRoIGZpeGVkIHBvc2l0aW9uIGJ1dHRvbnMgYWJvdmUgaW4gYSBuYXYgYmFyCgkJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCQlfYmluZExpc3RUaHVtYldvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoIi51aS1wYWdlIikuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCQl9LAoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCQkvL3RoaXMgYWxzbyBhZGRyZXNzZXMgbm90IG9uIGZpeGVkIHRvb2xiYXJzIHBhZ2UgaW4gZG9jcwoJCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KSAKCQkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyJweCIgKTsKCQkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQkJfSwgMCApOwoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLnggCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCgiLnVpLXBhZ2UtYWN0aXZlIikucmVtb3ZlQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeCIgKTsKCQkJfQoJfSk7CgoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJcGFuZWw6ICJ1aS1wYW5lbCIsCgkJCXBhbmVsT3BlbjogInVpLXBhbmVsLW9wZW4iLAoJCQlwYW5lbENsb3NlZDogInVpLXBhbmVsLWNsb3NlZCIsCgkJCXBhbmVsRml4ZWQ6ICJ1aS1wYW5lbC1maXhlZCIsCgkJCXBhbmVsSW5uZXI6ICJ1aS1wYW5lbC1pbm5lciIsCgkJCW1vZGFsOiAidWktcGFuZWwtZGlzbWlzcyIsCgkJCW1vZGFsT3BlbjogInVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCXBhZ2VQYW5lbDogInVpLXBhZ2UtcGFuZWwiLAoJCQlwYWdlUGFuZWxPcGVuOiAidWktcGFnZS1wYW5lbC1vcGVuIiwKCQkJY29udGVudFdyYXA6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAiLAoJCQljb250ZW50V3JhcE9wZW46ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtb3BlbiIsCgkJCWNvbnRlbnRXcmFwQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC13cmFwLWNsb3NlZCIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXI6ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXIiLAoJCQljb250ZW50Rml4ZWRUb29sYmFyT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhci1vcGVuIiwKCQkJY29udGVudEZpeGVkVG9vbGJhckNsb3NlZDogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhci1jbG9zZWQiLAoJCQlhbmltYXRlOiAidWktcGFuZWwtYW5pbWF0ZSIKCQl9LAoJCWFuaW1hdGU6IHRydWUsCgkJdGhlbWU6ICJjIiwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncGFuZWwnKSIsCgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQlwYWdlID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCV9nZXRQYWdlVGhlbWUgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhlbWUgPSAkLmRhdGEoIHBhZ2VbMF0sICJtb2JpbGVQYWdlIiApLm9wdGlvbnMudGhlbWUsCgkJCQkkcGFnZVRoZW1lQ2xhc3MgPSAidWktYm9keS0iICsgJHRoZW1lOwoJCQkJcmV0dXJuICRwYWdlVGhlbWVDbGFzczsKCQkJfSwKCQkJX2dldFBhbmVsSW5uZXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkcGFuZWxJbm5lciA9ICRlbC5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgkJCQlpZiAoICRwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkcGFuZWxJbm5lciA9ICRlbC5jaGlsZHJlbigpLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICciIC8+JyApLnBhcmVudCgpOwoJCQkJfQoJCQkJcmV0dXJuICRwYW5lbElubmVyOwoJCQl9LAoJCQlfZ2V0V3JhcHBlciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR3cmFwcGVyID0gcGFnZS5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcCApOwoJCQkJaWYgKCAkd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJHdyYXBwZXIgPSBwYWdlLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpLCAudWktY29udGVudDpub3QoOmpxbURhdGEocm9sZT0ncG9wdXAnKSksIC51aS1mb290ZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSIgKS53cmFwQWxsKCAnPGRpdiBjbGFzcz0iJyArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICsgJyAnICsgX2dldFBhZ2VUaGVtZSgpICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJHdyYXBwZXIuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gJHdyYXBwZXI7CgkJCX0sCgkJCV9nZXRGaXhlZFRvb2xiYXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkZml4ZWRUb29sYmFyID0gcGFnZS5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQlpZiAoICRmaXhlZFRvb2xiYXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCQkJCSRmaXhlZFRvb2xiYXIuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gJGZpeGVkVG9vbGJhcjsKCQkJfTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3BhbmVsSUQ6ICRlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6ICRlbC5maW5kKCAiOmpxbURhdGEocmVsPSdjbG9zZScpIiApLAoJCQlfcGFnZTogJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCV9wYWdlVGhlbWU6IF9nZXRQYWdlVGhlbWUoKSwKCQkJX3BhbmVsSW5uZXI6IF9nZXRQYW5lbElubmVyKCksCgkJCV93cmFwcGVyOiBfZ2V0V3JhcHBlcigpLAoJCQlfZml4ZWRUb29sYmFyOiBfZ2V0Rml4ZWRUb29sYmFyKCkKCQl9KTsKCQkKCQlzZWxmLl9hZGRQYW5lbENsYXNzZXMoKTsKCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCXNlbGYuX2ZpeGVkVG9vbGJhci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCS8vIGFkZCBjbGFzcyB0byBwYWdlIHNvIHdlIGNhbiBzZXQgIm92ZXJmbG93LXg6IGhpZGRlbjsiIGZvciBpdCB0byBmaXggQW5kcm9pZCB6b29tIGlzc3VlCgkJc2VsZi5fcGFnZS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMucGFnZVBhbmVsICk7CgkJCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoJCQoJCXNlbGYuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQlzZWxmLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQlzZWxmLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISFzZWxmLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXNlbGYuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQlzZWxmLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2NyZWF0ZU1vZGFsOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0aGlzLl9wYWdlICk7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5fY2xvc2VMaW5rLm9uKCAiY2xpY2sucGFuZWwiICwgZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSk7CgkJc2VsZi5lbGVtZW50Lm9uKCAiY2xpY2sucGFuZWwiICwgImE6anFtRGF0YShhamF4PSdmYWxzZScpIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsJCQoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlzZWxmLl9zY3JvbGxJbnRvVmlldyggcGFuZWxJbm5lckhlaWdodCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfc2Nyb2xsSW50b1ZpZXc6IGZ1bmN0aW9uKCBwYW5lbElubmVySGVpZ2h0ICkgewoJCWlmICggcGFuZWxJbm5lckhlaWdodCA8ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDAgKTsKCQl9CQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCQoJX2JpbmRVcGRhdGVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9wYWdlLm9uKCAiY2xpY2sucGFuZWwiICwgImEiLCBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHNlbGYuX3BhbmVsSUQgJiYgc2VsZi5fcGFuZWxJRCAhPT0gdW5kZWZpbmVkICkgewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApOwoJCQkJaWYgKCAhICRsaW5rLmhhc0NsYXNzKCAidWktbGluayIgKSApIHsKCQkJCQkkbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQlzZWxmLmVsZW1lbnQub25lKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJfSk7CgkJCQl9CgkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7Cgl9LAoJCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgkJCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQoJCXNlbGYuX3BhZ2UKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gY2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJCS5vbiggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkvLyBvbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJfSwKCgkvLyBzdGF0ZSBzdG9yYWdlIG9mIG9wZW4gb3IgY2xvc2VkCglfb3BlbjogZmFsc2UsCgoJX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXM6IG51bGwsCglfZml4ZWRUb29sYmFyT3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fcGFnZS5vZmYoICJwYW5lbGNsb3NlIiApOwoJCQkJCXNlbGYuX3BhZ2UuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgkJCQkJCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoJCQkJCQoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UKCQkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZVRoZW1lICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgkJCQkJCgkJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQkJCQoJCQkJCS8vIEZpeCBmb3IgSUU3IG1pbi1oZWlnaHQgYnVnCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlci5jc3MoICJtaW4taGVpZ2h0Iiwgc2VsZi5fcGFnZS5jc3MoICJtaW4taGVpZ2h0IiApICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJCQkJCgkJCQkJc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMubW9kYWwgKSArICIgIiArIG8uY2xhc3Nlcy5tb2RhbE9wZW47CgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoKCQkJCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCQoJCQkJCXNlbGYuX3RyaWdnZXIoICJvcGVuIiApOwoJCQkJfTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJCgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVvcGVuIiApOwoJCQkKCQkJaWYgKCBzZWxmLl9wYWdlLmpxbURhdGEoJ3BhbmVsJykgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuX3BhZ2Uub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCQkJCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXNlbGYgPSB0aGlzLAoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJCQkKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbC5yZW1vdmVDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKS5hZGRDbGFzcyggc2VsZi5fcGFnZVRoZW1lICk7CgkJCQkJCS8vIHJlc2V0IGZpeCBmb3IgSUU3IG1pbi1oZWlnaHQgYnVnCgkJCQkJCXNlbGYuX3dyYXBwZXIuY3NzKCAibWluLWhlaWdodCIsICIiICk7CgkJCQkJfQoJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCQkJCQkKCQkJCQlzZWxmLl93cmFwcGVyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCQkJCgkJCQkJc2VsZi5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoJCQkJfTsKCQkJCQoJCQlpZiAoIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLmxlbmd0aCA8IDAgKSB7CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9CgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVjbG9zZSIgKTsKCgkJCV9jbG9zZVBhbmVsKCk7CgoJCQlzZWxmLl9vcGVuID0gZmFsc2U7CgkJfQoJfSwKCQoJdG9nZ2xlOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBjbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMsCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQloYXNPdGhlclNpYmxpbmdQYW5lbHMgPSB0aGlzLmVsZW1lbnQuc2libGluZ3MoICIuIiArIGNsYXNzZXMucGFuZWwgKS5sZW5ndGg7CgoJCS8vIGNyZWF0ZQoJCWlmICggIWhhc090aGVyU2libGluZ1BhbmVscyApIHsKCQkJdGhpcy5fd3JhcHBlci5jaGlsZHJlbigpLnVud3JhcCgpOwoJCQl0aGlzLl9wYWdlLmZpbmQoICJhIiApLnVuYmluZCggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbCApOwoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJaWYgKCB0aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhlbWUgKS5hZGRDbGFzcyggdGhpcy5fcGFnZVRoZW1lICk7CgkJCQl9CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0gZWxzZSBpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCXRoaXMuX2ZpeGVkVG9vbGJhci5yZW1vdmVDbGFzcyggY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQl0aGlzLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCWlmICggdGhlbWUgKSB7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhlbWUgKS5hZGRDbGFzcyggdGhpcy5fcGFnZVRoZW1lICk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFuZWxJbm5lci5jaGlsZHJlbigpLnVud3JhcCgpOwoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIGNsYXNzZXMucGFuZWxBbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCgkJLy8gb3BlbiBhbmQgY2xvc2UKCQl0aGlzLmVsZW1lbnQub2ZmKCB0aGlzLl90cmFuc2l0aW9uRW5kRXZlbnRzICkKCQkJLnJlbW92ZUNsYXNzKCBbIGNsYXNzZXMucGFuZWxVbmZpeGVkLCBjbGFzc2VzLnBhbmVsQ2xvc2VkLCBjbGFzc2VzLnBhbmVsT3BlbiBdLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5wYW5lbC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJCW9wdGlvbnM6IHsKCQkJY2xhc3NlczogewoJCQkJdGFibGU6ICJ1aS10YWJsZSIKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQlzZWxmLnJlZnJlc2goIHRydWUgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbiAoY3JlYXRlKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCXRycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidGhlYWQgdHIiICk7CgoJCQlpZiAoIGNyZWF0ZSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQkJfQoKCQkJLy8gRXhwb3NlIGhlYWRlcnMgYW5kIGFsbEhlYWRlcnMgcHJvcGVydGllcyBvbiB0aGUgd2lkZ2V0CgkJCS8vIGhlYWRlcnMgcmVmZXJlbmNlcyB0aGUgVEhzIHdpdGhpbiB0aGUgZmlyc3QgVFIgaW4gdGhlIHRhYmxlCgkJCXNlbGYuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidHI6ZXEoMCkiICkuY2hpbGRyZW4oKTsKCgkJCS8vIGFsbEhlYWRlcnMgcmVmZXJlbmNlcyBoZWFkZXJzLCBwbHVzIGFsbCBUSHMgaW4gdGhlIHRoZWFkLCB3aGljaCBtYXkgaW5jbHVkZSBzZXZlcmFsIHJvd3MsIG9yIG5vdAoJCQlzZWxmLmFsbEhlYWRlcnMgPSBzZWxmLmhlYWRlcnMuYWRkKCB0cnMuY2hpbGRyZW4oKSApOwoKCQkJdHJzLmVhY2goZnVuY3Rpb24oKXsKCgkJCQl2YXIgY29sdGFsbHkgPSAwOwoKCQkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24oIGkgKXsKCgkJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlzZWwgPSAiOm50aC1jaGlsZCgiICsgKCBjb2x0YWxseSArIDEgKSArICIpIjsKCQkJCQkkKCB0aGlzICkKCQkJCQkJLmpxbURhdGEoICJjb2xzdGFydCIsIGNvbHRhbGx5ICsgMSApOwoKCQkJCQlpZiggc3BhbiApewoJCQkJCQlmb3IoIHZhciBqID0gMDsgaiA8IHNwYW4gLSAxOyBqKysgKXsKCQkJCQkJCWNvbHRhbGx5Kys7CgkJCQkJCQlzZWwgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x0YWxseSArIDEgKSArICIpIjsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJCh0aGlzKS5qcW1EYXRhKCJjZWxscyIsICIiKTsKCQkJCQl9CgkJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCQkkKCB0aGlzICkKCQkJCQkJLmpxbURhdGEoICJjZWxscyIsIHNlbGYuZWxlbWVudC5maW5kKCAidHIiICkubm90KCB0cnMuZXEoMCkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsICkgKTsKCgkJCQkJY29sdGFsbHkrKzsKCgkJCQl9KTsKCgkJCX0pOwoKCQkJLy8gdXBkYXRlIHRhYmxlIG1vZGVzCgkJCWlmICggY3JlYXRlID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggJ3JlZnJlc2gnICk7CgkJCX0KCX0KCn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMubW9kZSA9ICJjb2x1bW50b2dnbGUiOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uQnRuVGhlbWUgPSBudWxsOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uUG9wdXBUaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UZXh0ID0gIkNvbHVtbnMuLi4iOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcyA9ICQuZXh0ZW5kKAoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywKCXsKCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJfQopOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSd0YWJsZScpIiwgInRhYmxlY3JlYXRlIHJlZnJlc2giLCBmdW5jdGlvbiggZSApIHsKCQoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJZXZlbnQgPSBlLnR5cGUsCgkJbyA9IHNlbGYub3B0aW9ucywKCQlucyA9ICQubW9iaWxlLm5zLAoJCWlkID0gKCAkdGFibGUuYXR0ciggImlkIiApIHx8IG8uY2xhc3Nlcy5wb3B1cCApICsgIi1wb3B1cCIsIC8qIFRPRE8gQkVUVEVSIEZBTExCQUNLIElEIEhFUkUgKi8KCQkkbWVudUJ1dHRvbiwKCQkkcG9wdXAsCgkJJG1lbnUsCgkJJHN3aXRjaGJvYXJkOwoKCWlmICggby5tb2RlICE9PSAiY29sdW1udG9nZ2xlIiApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkKCQkkbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY29sdW1uQnRuICsgIicgZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAibWluaT0ndHJ1ZSc+IiArIG8uY29sdW1uQnRuVGV4dCArICI8L2E+IiApLAoJCSRwb3B1cCA9ICQoICI8ZGl2IGRhdGEtIiArIG5zICsgInJvbGU9J3BvcHVwJyBkYXRhLSIgKyBucyArICJyb2xlPSdmaWVsZGNvbnRhaW4nIGNsYXNzPSciICsgby5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIpLAoJCSRtZW51ID0gJCgiPGZpZWxkc2V0IGRhdGEtIiArIG5zICsgInJvbGU9J2NvbnRyb2xncm91cCc+PC9maWVsZHNldD4iKTsKCX0KCQoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJc2VsZi5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCXZhciBwcmlvcml0eSA9ICQoIHRoaXMgKS5qcW1EYXRhKCAicHJpb3JpdHkiICksCgkJCSRjZWxscyA9ICQoIHRoaXMgKS5hZGQoICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJaWYgKCBwcmlvcml0eSApIHsKCgkJCSRjZWxscy5hZGRDbGFzcyggby5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsgJCggdGhpcyApLnRleHQoKSArICI8L2xhYmVsPiIgKQoJCQkJCS5hcHBlbmRUbyggJG1lbnUgKQoJCQkJCS5jaGlsZHJlbiggMCApCgkJCQkJLmpxbURhdGEoICJjZWxscyIsICRjZWxscyApCgkJCQkJLmNoZWNrYm94cmFkaW8oewoJCQkJCQl0aGVtZTogby5jb2x1bW5Qb3B1cFRoZW1lCgkJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkKCAnIycgKyBpZCArICcgZmllbGRzZXQgZGl2OmVxKCcgKyBpICsnKScpLmZpbmQoJ2lucHV0JykuanFtRGF0YSggJ2NlbGxzJywgJGNlbGxzICk7CgkJCX0KCQl9Cgl9KTsKCQoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCSRtZW51LmFwcGVuZFRvKCAkcG9wdXAgKTsKCX0KCgkvLyBiaW5kIGNoYW5nZSBldmVudCBsaXN0ZW5lcnMgdG8gaW5wdXRzIC0gVE9ETzogbW92ZSB0byBhIHByaXZhdGUgbWV0aG9kPwoJaWYgKCAkbWVudSA9PT0gdW5kZWZpbmVkICkgewoJCSRzd2l0Y2hib2FyZCA9ICQoJyMnICsgaWQgKyAnIGZpZWxkc2V0Jyk7Cgl9IGVsc2UgewoJCSRzd2l0Y2hib2FyZCA9ICRtZW51OwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkc3dpdGNoYm9hcmQub24oICJjaGFuZ2UiLCAiaW5wdXQiLCBmdW5jdGlvbiggZSApewoJCQlpZiggdGhpcy5jaGVja2VkICl7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iICkuYWRkQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iICk7CgkJCX0KCQl9KTsKCgkJJG1lbnVCdXR0b24KCQkJLmluc2VydEJlZm9yZSggJHRhYmxlICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby5jb2x1bW5CdG5UaGVtZQoJCQl9KTsKCgkJJHBvcHVwCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5wb3B1cCgpOwoJfQoKCS8vIHJlZnJlc2ggbWV0aG9kCglzZWxmLnVwZGF0ZSA9IGZ1bmN0aW9uKCl7CgkJJHN3aXRjaGJvYXJkLmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpewoJCQlpZiAodGhpcy5jaGVja2VkKSB7CgkJCQl0aGlzLmNoZWNrZWQgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmVxKDApLmNzcyggImRpc3BsYXkiICkgPT09ICJ0YWJsZS1jZWxsIjsKCQkJCWlmIChldmVudCA9PT0gInJlZnJlc2giKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC12aXNpYmxlJyk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmFkZENsYXNzKCd1aS10YWJsZS1jZWxsLWhpZGRlbicpOwoJCQl9CgkJCSQoIHRoaXMgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX07CgoJJC5tb2JpbGUud2luZG93Lm9uKCAidGhyb3R0bGVkcmVzaXplIiwgc2VsZi51cGRhdGUgKTsKCglzZWxmLnVwZGF0ZSgpOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLm1vZGUgPSAicmVmbG93IjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMgPSAkLmV4dGVuZCgKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsCgl7CgkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCWNlbGxMYWJlbHM6ICJ1aS10YWJsZS1jZWxsLWxhYmVsIgoJfQopOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSd0YWJsZScpIiwgInRhYmxlY3JlYXRlIHJlZnJlc2giLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgJHRhYmxlID0gJCggdGhpcyApLAoJCWV2ZW50ID0gZS50eXBlLAoJCXNlbGYgPSAkdGFibGUuZGF0YSggIm1vYmlsZS10YWJsZSIgKSwKCQlvID0gc2VsZi5vcHRpb25zOwoKCS8vIElmIGl0J3Mgbm90IHJlZmxvdyBtb2RlLCByZXR1cm4gaGVyZS4KCWlmKCBvLm1vZGUgIT09ICJyZWZsb3ciICl7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoJfQoKCS8vIGdldCBoZWFkZXJzIGluIHJldmVyc2Ugb3JkZXIgc28gdGhhdCB0b3AtbGV2ZWwgaGVhZGVycyBhcmUgYXBwZW5kZWQgbGFzdAoJdmFyIHJldmVyc2VIZWFkZXJzID0gICQoIHNlbGYuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKTsKCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglyZXZlcnNlSGVhZGVycy5lYWNoKGZ1bmN0aW9uKCBpICl7CgkJdmFyICRjZWxscyA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICksCgkJCWNvbHN0YXJ0ID0gJCggdGhpcyApLmpxbURhdGEoICJjb2xzdGFydCIgKSwKCQkJaGllcmFyY2h5Q2xhc3MgPSAkY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQl0ZXh0ID0gJCh0aGlzKS50ZXh0KCk7CgoJCQlpZiggdGV4dCAhPT0gIiIgICl7CgoJCQkJaWYoIGhpZXJhcmNoeUNsYXNzICl7CgkJCQkJdmFyIGl0ZXJhdGlvbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCWZpbHRlciA9ICIiOwoKCQkJCQlpZiggaXRlcmF0aW9uICl7CgkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQl9CgkJCQkJJGNlbGxzLmZpbHRlciggZmlsdGVyICkucHJlcGVuZCggIjxiIGNsYXNzPSciICsgby5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGNlbGxzLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7CgkJCQl9CgoJCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gdHJ1ZTsKCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CglpZiggISggL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIC9PUyBbMS01XV9bMC05X10qIGxpa2UgTWFjIE9TIFgvaS50ZXN0KCB1YSApICYmIHVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSBmYWxzZTsKCQlyZXR1cm47Cgl9CgoJdmFyIHpvb20gPSAkLm1vYmlsZS56b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoKCWZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKCQlpZiAoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKSB7CgkJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCQl6b29tLmRpc2FibGUoKTsKCQkJCX0KCQl9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQkJem9vbS5lbmFibGUoKTsKCQl9Cgl9CgoJJC5tb2JpbGUuZG9jdW1lbnQub24oICJtb2JpbGVpbml0IiwgZnVuY3Rpb24oKXsKCQlpZiggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkoICQoIGhhc2hQYWdlICkuaXMoICc6anFtRGF0YShyb2xlPSJwYWdlIiknICkgfHwKCQkJCQkkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApIHx8CgkJCQkJaGFzaCA9PT0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApICkgKSB7CgoJCQkJLy8gU3RvcmUgdGhlIGluaXRpYWwgZGVzdGluYXRpb24KCQkJCWlmICggJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJCSQubW9iaWxlLnVybEhpc3RvcnkuaW5pdGlhbERzdCA9IGhhc2gucmVwbGFjZSggIiMiLCAiIiApOwoJCQkJfQoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgaW5pdGlhbCBwb3BzdGF0ZSBzdGF0ZSBpZiBpdCBleGlzdHMKCQkJCS8vIHNvIHRoYXQgbmF2aWdhdGlvbiBiYWNrIHRvIHRoZSBpbml0aWFsIHBhZ2Ugd29ya3MgcHJvcGVybHkKCQkJCWlmKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCgp9KSk7Cg==",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBNb24gQXByIDggMjAxMyAxOTo0MToyOCBVVEMKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwoqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCioKKi8KCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkICkgewoJJC5tb2JpbGUgPSB7fTsKfSggalF1ZXJ5ICkpOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4zLjEiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudCdzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKCB0aGlzICkudGV4dCgpICkuaHRtbCgpOwoJfTsKCgkvLyBmbHVlbnQgaGVscGVyIGZ1bmN0aW9uIGZvciB0aGUgbW9iaWxlIG5hbWVzcGFjZWQgZXF1aXZhbGVudAoJJC5mbi5qcW1FbmhhbmNlYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJfTsKCgkkLmZuLmpxbUhpamFja2FibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJfTsKCgkvLyBNb25rZXktcGF0Y2hpbmcgU2l6emxlIHRvIGZpbHRlciB0aGUgOmpxbURhdGEgc2VsZWN0b3IKCXZhciBvbGRGaW5kID0gJC5maW5kLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9Owp9KSggalF1ZXJ5LCB0aGlzICk7CgoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgdjEuMTAuMHByZSAtIDIwMTItMTEtMTMgKGZmMDU1YTBjMzUzYzNjOGNlNmU1YmZhMDdhZDdjYjAzZTg4ODViYzUpCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggOiBuYW1lCgl9LCBwcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9LAoKCXJhaXNlOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93ICJXaWRnZXQgWyIgKyB0aGlzLndpZGdldE5hbWUgKyAiXTogIiArIG1zZzsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBERVBSRUNBVEVECgkvLyBOT1RFIGdsb2JhbCBtb2JpbGUgb2JqZWN0IHNldHRpbmdzCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBERVBSRUNBVEVEIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgZGVmYXVsdCBtZXNzYWdlIHNldHRpbmcKCQlsb2FkaW5nTWVzc2FnZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVECgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ3Nob3cnLCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKTsKCQl9LAoKCQkvLyBERVBSRUNBVEVECgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ2hpZGUnICk7CgkJfSwKCgkJbG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCXRoaXMubG9hZGVyV2lkZ2V0LmxvYWRlci5hcHBseSggdGhpcy5sb2FkZXJXaWRnZXQsIGFyZ3VtZW50cyApOwoJCX0KCX0pOwoKCS8vIFRPRE8gbW92ZSBsb2FkZXIgY2xhc3MgZG93biBpbnRvIHRoZSB3aWRnZXQgc2V0dGluZ3MKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLCAkaHRtbCA9ICQoICJodG1sIiApLCAkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgJGhlYWRlciwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSh0aGVtZSkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJLy8gcHJlZmVyIG9iamVjdCBwcm9wZXJ0eSBmcm9tIHRoZSBwYXJhbSB0aGVuIHRoZSBvbGQgdGhlbWUgc2V0dGluZwoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbSB2YWx1ZSBwYXNzZWQgYXMgYSBzdHJpbmcgYXJndW1lbnQsIHRoZW4KCQkJCS8vIHdlIHByZWZlciB0aGUgZ2xvYmFsIG9wdGlvbiBiZWNhdXNlIHdlIGNhbid0IHVzZSB1bmRlZmluZWQgZGVmYXVsdAoJCQkJLy8gcHJvdG90eXBlIG9wdGlvbnMsIHRoZW4gdGhlIHByb3RvdHlwZSBvcHRpb24KCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgfHwgbG9hZFNldHRpbmdzLnRleHQ7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSAhPT0gZmFsc2UgfHwgbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkvLyBib29sZWFuIHZhbHVlcyByZXF1aXJlIGEgYml0IG1vcmUgd29yayA6UCwgc3VwcG9ydHMgb2JqZWN0IHByb3BlcnRpZXMKCQkJCS8vIGFuZCBvbGQgc2V0dGluZ3MKCQkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRleHRWaXNpYmxlID0gJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgkJCQl9CgoJCQkJLy8gYWRkIHRoZSBwcm9wZXIgY3NzIGdpdmVuIHRoZSBvcHRpb25zICh0aGVtZSwgdGV4dCwgZXRjKQoJCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoImNsYXNzIiwgbG9hZGVyQ2xhc3MgKwoJCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJCSggbG9hZFNldHRpbmdzLnRleHRvbmx5IHx8IHRleHRvbmx5ID8gIiB1aS1sb2FkZXItdGV4dG9ubHkiIDogIiIgKSApOwoKCQkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCQkvLyBpZiB0aGUgaHRtbCBhdHRyaWJ1dGUgaXMgZGVmaW5lZCBvbiB0aGUgbG9hZGluZyBzZXR0aW5ncywgdXNlIHRoYXQKCQkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJCXRoaXMuZWxlbWVudC5odG1sKCBsb2FkU2V0dGluZ3MuaHRtbCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJCX0KCgkJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkvLyBjaGVjayB0aGF0IHRoZSBsb2FkZXIgaXMgdmlzaWJsZQoJCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJCSR3aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbiggdmFsICkgeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICB3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCkgewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKTsKCglpZiggcmV0ICkgewoJCXJldHVybiAhIXJldDsKCX0KCgl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXRyYW5zZm9ybXMgPSB7CgkJCS8vIFdl4oCZcmUgb21pdHRpbmcgT3BlcmEgZm9yIHRoZSB0aW1lIGJlaW5nOyBNUyB1c2VzIHVucHJlZml4ZWQuCgkJCSdNb3pUcmFuc2Zvcm0nOictbW96LXRyYW5zZm9ybScsCgkJCSd0cmFuc2Zvcm0nOid0cmFuc2Zvcm0nCgkJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdmFyIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAndHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApJzsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7Cgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8CgkJdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicsIFsgIldlYmtpdCIsICJNb3oiLCAiIiBdICkgJiYKCQkhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAhb3BlcmEsCgoJLy8gTm90ZSwgQ2hyb21lIGZvciBpT1MgaGFzIGFuIGV4dHJlbWVseSBxdWlya3kgaW1wbGVtZW50YXRpb24gb2YgcG9wc3RhdGUuCgkvLyBXZSd2ZSBjaG9zZW4gdG8gdGFrZSB0aGUgc2hvcnRlc3QgcGF0aCB0byBhIGJ1ZyBmaXggaGVyZSBmb3IgaXNzdWUgIzU0MjYKCS8vIFNlZSB0aGUgZm9sbG93aW5nIGxpbmsgZm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSByZWdleCBjaG9zZW4KCS8vIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2Nocm9tZS9tb2JpbGUvZG9jcy91c2VyLWFnZW50I2Nocm9tZV9mb3JfaW9zX3VzZXItYWdlbnQKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCSJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkvLyBXaGVuIHJ1bm5pbmcgaW5zaWRlIGEgRkYgaWZyYW1lLCBjYWxsaW5nIHJlcGxhY2VTdGF0ZSBjYXVzZXMgYW4gZXJyb3IKCQkhKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiRmlyZWZveCIgKSA+PSAwICYmIHdpbmRvdy50b3AgIT09IHdpbmRvdyApICYmCgkJKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5zZWFyY2goL0NyaU9TLykgPT09IC0xICksCgoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsIGhpc3Rvcnk7CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30sCgkJCQlocmVmID0gbG9jYXRpb24uaHJlZjsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBkYXRhICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2VzICkgewoJCQlpZiggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICl7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgZG9jdW1lbnRCYXNlLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBzdGF0ZSwgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCXBhdGguZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCX07CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGg7CgoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2JhY2snICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2ZvcndhcmQnICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICl7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJaW5pdGlhbEhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCSQubW9iaWxlLk5hdmlnYXRvciA9IGZ1bmN0aW9uKCBoaXN0b3J5ICkgewoJCXRoaXMuaGlzdG9yeSA9IGhpc3Rvcnk7CgkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IHRydWU7CgoJCSQubW9iaWxlLndpbmRvdy5iaW5kKHsKCQkJInBvcHN0YXRlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLnBvcHN0YXRlLCB0aGlzICksCgkJCSJoYXNoY2hhbmdlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLmhhc2hjaGFuZ2UsIHRoaXMgKQoJCX0pOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5OYXZpZ2F0b3IucHJvdG90eXBlLCB7CgkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2ggPSBwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5zdHJpcEhhc2godXJsKSA6IHVybDsKCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBtYWtlIHN1cmUgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uIHdoZW4gaXQgaXNuJ3QgZXhwbGljaXRseSBzZXQgaW4gdGhlCgkJCS8vIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCB0byB0aGUgc3F1YXNoIG1ldGhvZAoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXZhciByZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXRoaXMuc3F1YXNoKCB1cmwsIHN0YXRlICk7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBhY3RpdmUsIGhhc2gsIHN0YXRlLCBjbG9zZXN0SW5kZXg7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKXsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCkge30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKTsKCgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCQlpZiAoIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQl9CgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgoJCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICkKCQkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wICk7CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IHdpbi53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCBlICkgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudC5wYXJlbnQoKSApICk7Cgl9LAoKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudG9nZ2xlQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQtdHJhbnNpdGlvbmluZyB2aWV3cG9ydC0iICsgbmFtZSApOwoJCQl9LAoJCQlzY3JvbGxQYWdlID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRvU2Nyb2xsICk7CgoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCQl9LCAxNTAgKTsKCQkJfSwKCQkJY2xlYW5Gcm9tID0gZnVuY3Rpb24oKSB7CgkJCQkkZnJvbQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCQkJfSwKCQkJc3RhcnRPdXQgPSBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgkJCQkJZG9uZU91dCgpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVPdXQgKTsKCQkJCX0KCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy8gTk9URTogcGF0aCBleHRlbnNpb25zIGRlcGVuZGVudCBvbiBjb3JlIGF0dHJpYnV0ZXMuIE1vdmVkIGhlcmUgdG8gcmVtb3ZlIGRlcHMgZnJvbQoJCS8vICAgICAgICQubW9iaWxlLnBhdGggZGVmaW5pdGlvbgoJCXBhdGggPSAkLmV4dGVuZCgkLm1vYmlsZS5wYXRoLCB7CgoJCQkvL3JldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcgYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAnJicgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy9jaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZCBvZiB0aGUKCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCWRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9KSwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbCwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLmRvY3VtZW50VXJsLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9IHBhdGguZG9jdW1lbnRCYXNlLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9IHBhdGguZG9jdW1lbnRCYXNlRGlmZmVycywKCgkJZ2V0U2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0OwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoaHJlZikuaHJlZk5vSGFzaDsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBwYXRoLmdldERvY3VtZW50QmFzZTsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCQlpZiAoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgPSBmdW5jdGlvbiByZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIGhlaWdodCApIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKT8gaGVpZ2h0IDogZ2V0U2NyZWVuSGVpZ2h0KCk7CgkJCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGhlaWdodCAtIGFQYWdlUGFkVCAtIGFQYWdlUGFkQiAtIGFQYWdlQm9yZGVyVCAtIGFQYWdlQm9yZGVyQiApOwoJfTsKCgkvL3NoYXJlZCBwYWdlIGVuaGFuY2VtZW50cwoJZnVuY3Rpb24gZW5oYW5jZVBhZ2UoICRwYWdlLCByb2xlICkgewoJCS8vIElmIGEgcm9sZSB3YXMgc3BlY2lmaWVkLCBtYWtlIHN1cmUgdGhlIGRhdGEtcm9sZSBhdHRyaWJ1dGUKCQkvLyBvbiB0aGUgcGFnZSBlbGVtZW50IGlzIGluIHN5bmMuCgkJaWYgKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJZnVuY3Rpb24gZmluZEJhc2VXaXRoRGVmYXVsdCgpIHsKCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCX0KCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSAkKCB0aGlzICk7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfTsKCgkvLyBMb2FkIGEgcGFnZSBpbnRvIHRoZSBET00uCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkvLyBrbm93IHdoZW4gdGhlIHBhZ2UgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkJLy8gVGhlIGRlZmF1bHQgbG9hZFBhZ2Ugb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkKCQkJLy8gdGhlIGNhbGxlci4KCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgoJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBwYWdlIGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJcGFnZSA9IG51bGwsCgoJCQkvLyBJZiB0aGUgcmVsb2FkUGFnZSBvcHRpb24gaXMgdHJ1ZSwgYW5kIHRoZSBwYWdlIGlzIGFscmVhZHkKCQkJLy8gaW4gdGhlIERPTSwgZHVwQ2FjaGVkUGFnZSB3aWxsIGJlIHNldCB0byB0aGUgcGFnZSBlbGVtZW50CgkJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHJlbW92ZWQgYWZ0ZXIgdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZQoJCQkvLyBwYWdlIGlzIGxvYWRlZCBvZmYgdGhlIG5ldHdvcmsuCgkJCWR1cENhY2hlZFBhZ2UgPSBudWxsLAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJc2V0dGluZ3MucmVsb2FkUGFnZSA9IHRydWU7CgkJfQoKCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3VicGFnZSBwYXJhbXMuCgkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIHBhZ2UgdG8gYmUgbG9hZGVkLgoJCXZhciBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggYWJzVXJsICksCgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBwYWdlLiBGb3IgZW1iZWRkZWQgcGFnZXMsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IgcGFnZXMKCQkJLy8gd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUgcmVsYXRpdmUKCQkJLy8gcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBwYWdlcyAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgcGFnZS4KCQkJZGF0YVVybCA9IHBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzVXJsICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzdWVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhIGRhdGEtdXJsCgkJLy8gYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICIjIiArIGRhdGFVcmwgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBkYXRhVXJsICkKCQkJCS5qcW1EYXRhKCAidXJsIiwgZGF0YVVybCApOwoJCX0KCgkJCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UKCQkvLyB0byB0aGUgZmlyc3QgcGFnZSBhbmQgcmVmZXJzIHRvIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlLCBlcnJvciBvdXQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UgJiYgcGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICkgewoJCQkJLy8gQ2hlY2sgdG8gbWFrZSBzdXJlIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseQoJCQkJLy8gaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0CgkJCQkvLyBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLCB3ZSBjaGVjayBmb3IgdGhpcwoJCQkJLy8gY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aCBhbiBpZAoJCQkJLy8gZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvcgoJCQkJLy8gY2FzZS4gSWYgdGhlIGZpcnN0LXBhZ2UgaXMgbm90IGluIHRoZSBET00sIHRoZW4gd2UgbGV0CgkJCQkvLyB0aGluZ3MgZmFsbCB0aHJvdWdoIHRvIHRoZSBhamF4IGxvYWRpbmcgY29kZSBiZWxvdyBzbwoJCQkJLy8gdGhhdCBpdCBnZXRzIHJlbG9hZGVkLgoJCQkJaWYgKCAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkubGVuZ3RoICkgewoJCQkJCXBhZ2UgPSAkKCAkLm1vYmlsZS5maXJzdFBhZ2UgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggZmlsZVVybCApICApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJfQoJCQoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQkvL2lmIHdlIGFyZSByZWxvYWRpbmcgdGhlIHBhZ2UgbWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2ggCgkJCQlpZiggYmFzZSAmJiAhb3B0aW9ucy5wcmVmZXRjaCApewoJCQkJCWJhc2Uuc2V0KHVybCk7CgkJCQl9CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCkgewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nIAoJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoJCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgKCBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gfHwgIiIgKSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmICggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCggdGhpcyApLmlzKCAnW3NyY10nICkgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCQloaWRlTXNnKCk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgdGhlIHBhZ2UgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gcGFnZTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UsIGR1cENhY2hlZFBhZ2UgKTsKCQkJCX0sCgkJCQllcnJvcjogZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiAoIHBsZkV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCQloaWRlTXNnKCk7CgoJCQkJCQkvLyBzaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJCQkJLy8gaGlkZSBhZnRlciBkZWxheQoJCQkJCQlzZXRUaW1lb3V0KCAkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2csIDE1MDAgKTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLCBpc1RvUGFnZVN0cmluZzsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgJC5tb2JpbGUuYWN0aXZlUGFnZTsKCgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkvLyAgICAgICBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbSB0aGUgaGFzaAoJCS8vICAgICAgIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0KCQkvLyAgICAgICBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9QYWdlLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQl9IGVsc2UgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gdG9QYWdlLmRhdGEoICdhYnNVcmwnICk7CgkJfQoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG9QYWdlIGluIHRoZSB0cmlnZ2VyCgkJLy8gZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvUGFnZSBpcyB1cGRhdGVkLgoJCS8vCgkJLy8gV2UgYWxzbyBuZWVkIHRvIHJlLWV2YWx1YXRlIHdoZXRoZXIgaXQgaXMgYSBzdHJpbmcsIGJlY2F1c2UgYW4gb2JqZWN0IGNhbgoJCS8vIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoJCWlzVG9QYWdlU3RyaW5nID0gKHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciKTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggaXNUb1BhZ2VTdHJpbmcgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZSBzaW1wbGlmaWVkCgkJCS8vIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJCS8vIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0KCQkJLy8gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0b1BhZ2U7CgoJCQkkLm1vYmlsZS5sb2FkUGFnZSggdG9QYWdlLCBzZXR0aW5ncyApCgkJCQkuZG9uZShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBuZXdQYWdlLCBkdXBDYWNoZWRQYWdlICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCQlvcHRpb25zLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgPSBkdXBDYWNoZWRQYWdlOwoKCQkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCQluZXdQYWdlLmRhdGEoICdhYnNVcmwnLCB0cmlnZ2VyRGF0YS5hYnNVcmwgKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCgkJCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCgkJCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCQl9KTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQlzZXR0aW5ncy5kYXRhVXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQl9CgoJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJdmFyIGZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UsCgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIHNldHRpbmdzLmRhdGFVcmwgKSApIHx8IHRvUGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZCBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybCwKCQkJZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIHVybCApLAoJCQlhY3RpdmUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCwKCQkJaGlzdG9yeURpciA9IDAsCgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlLAoJCQlpc0RpYWxvZyA9IHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyI7CgoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuZGlyZWN0KHsgdXJsOiB1cmwgfSk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCWVuaGFuY2VQYWdlKCB0b1BhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8gc2VlIGlmIHRoZQoJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJLy8gdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZSB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCWhpc3RvcnlEaXIgPSBvcHRpb25zLmRpcmVjdGlvbiA9PT0gImJhY2siID8gLTEgOiAxOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdib2R5JyApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaCggZSApIHt9CgoJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJdmFyIGFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBoYXNoLgoJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJLy8gYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2ggYW5kCgkJCS8vIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZSBvcmlnaW5hbCBkaWFsb2cKCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQlhY3RpdmUudXJsLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVQYWdlICYmCgkJCQkhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgJiYKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJfQoKCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbiBvZiBhIHN0YWxlIGRpYWxvZywKCQkJLy8gd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKTsKCgkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQlpZiggIWFscmVhZHlUaGVyZSAmJiB1cmwuaW5kZXhPZigiIyIpID4gLTEgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfSBlbHNlIHsKCQkJCXVybCArPSAiIyIgKyBkaWFsb2dIYXNoS2V5OwoJCQl9CgoJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9CgkJfQoKCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0IHVzZSBwYWdlVGl0bGUKCQl2YXIgbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICk/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwgdG9QYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmluZCggIi51aS10aXRsZSIgKS50ZXh0KCk7CgkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYgKCAhaGlzdG9yeURpciAmJiBhbHJlYWR5VGhlcmUgKSB7CgkJCXVybEhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl2YXIgcGFyYW1zOwoKCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJLy8gVE9ETyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWxseSBwYXNzZWQgaW4gcGF0aAoJCQlpZiggIXBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJdXJsID0gIiMiICsgdXJsOwoJCQl9CgoJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCXBhcmFtcyA9IHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCXJvbGU6IHNldHRpbmdzLnJvbGUKCQkJfTsKCgkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCBwYXJhbXMsIHRydWUpOwoJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJfQoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gcGFnZVRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkJdmFyIGdldEFqYXhGb3JtRGF0YSA9IGZ1bmN0aW9uKCAkZm9ybSwgY2FsY3VsYXRlT25seSApIHsKCQkJdmFyIHVybCwgcmV0ID0gdHJ1ZSwgZm9ybURhdGEsIHZjbGlja2VkTmFtZSwgbWV0aG9kOwoJCQkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKSApOwoKCQkJaWYgKCAoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlpZiAoICFjYWxjdWxhdGVPbmx5ICkgewoJCQkJZm9ybURhdGEgPSAkZm9ybS5zZXJpYWxpemVBcnJheSgpOwoKCQkJCWlmICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkWyAwIF0uZm9ybSA9PT0gJGZvcm1bIDAgXSApIHsKCQkJCQl2Y2xpY2tlZE5hbWUgPSAkbGFzdFZDbGlja2VkLmF0dHIoICJuYW1lIiApOwoJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhlIGxhc3QgY2xpY2tlZCBlbGVtZW50IGlzIGluY2x1ZGVkIGluIHRoZSBmb3JtCgkJCQkJCSQuZWFjaCggZm9ybURhdGEsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJCQkJaWYgKCB2YWx1ZS5uYW1lID09PSB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQkJLy8gVW5zZXQgdmNsaWNrZWROYW1lIC0gd2UndmUgZm91bmQgaXQgaW4gdGhlIHNlcmlhbGl6ZWQgZGF0YSBhbHJlYWR5CgkJCQkJCQkJdmNsaWNrZWROYW1lID0gIiI7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQlmb3JtRGF0YS5wdXNoKCB7IG5hbWU6IHZjbGlja2VkTmFtZSwgdmFsdWU6ICRsYXN0VkNsaWNrZWQuYXR0ciggInZhbHVlIiApIH0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXQgPSB7CgkJCQkJdXJsOiB1cmwsCgkJCQkJb3B0aW9uczogewoJCQkJCQl0eXBlOgkJbWV0aG9kLAoJCQkJCQlkYXRhOgkJJC5wYXJhbSggZm9ybURhdGEgKSwKCQkJCQkJdHJhbnNpdGlvbjoJJGZvcm0uanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJCXJldmVyc2U6CSRmb3JtLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJCX0KCQkJCX07CgkJCX0KCgkJCXJldHVybiByZXQ7CgkJfTsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgoJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJGJ0biwgYnRuRWxzLCB0YXJnZXQgPSBldmVudC50YXJnZXQsIG5lZWRDbG9zZXN0ID0gZmFsc2U7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlY29yZCB0aGF0IHRoaXMgZWxlbWVudCB3YXMgY2xpY2tlZCwgaW4gY2FzZSB3ZSBuZWVkIGl0IGZvciBjb3JyZWN0CgkJCS8vIGZvcm0gc3VibWlzc2lvbiBkdXJpbmcgdGhlICJzdWJtaXQiIGhhbmRsZXIgYWJvdmUKCQkJJGxhc3RWQ2xpY2tlZCA9ICQoIHRhcmdldCApOwoKCQkJLy8gVHJ5IHRvIGZpbmQgYSB0YXJnZXQgZWxlbWVudCB0byB3aGljaCB0aGUgYWN0aXZlIGNsYXNzIHdpbGwgYmUgYXBwbGllZAoJCQlpZiAoICQuZGF0YSggdGFyZ2V0LCAibW9iaWxlLWJ1dHRvbiIgKSApIHsKCQkJCS8vIElmIHRoZSBmb3JtIHdpbGwgbm90IGJlIHN1Ym1pdHRlZCB2aWEgQUpBWCwgZG8gbm90IGFkZCBhY3RpdmUgY2xhc3MKCQkJCWlmICggIWdldEFqYXhGb3JtRGF0YSggJCggdGFyZ2V0ICkuY2xvc2VzdCggImZvcm0iICksIHRydWUgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvLyBXZSB3aWxsIGFwcGx5IHRoZSBhY3RpdmUgc3RhdGUgdG8gdGhpcyBidXR0b24gd2lkZ2V0IC0gdGhlIHBhcmVudAoJCQkJLy8gb2YgdGhlIGlucHV0IHRoYXQgd2FzIGNsaWNrZWQgd2lsbCBoYXZlIHRoZSBhc3NvY2lhdGVkIGRhdGEKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0YXJnZXQgPSBmaW5kQ2xvc2VzdExpbmsoIHRhcmdldCApOwoJCQkJaWYgKCAhKCB0YXJnZXQgJiYgcGF0aC5wYXJzZVVybCggdGFyZ2V0LmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlCgkJCQkvLyBsaW5rIHdyYXBwaW5nIGNhbiBiZSBhdm9pZGVkCgkJCQlpZiAoICEkKCB0YXJnZXQgKS5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gQXZvaWQgY2FsbGluZyAuY2xvc2VzdCBieSB1c2luZyB0aGUgZGF0YSBzZXQgZHVyaW5nIC5idXR0b25NYXJrdXAoKQoJCQkvLyBMaXN0IGl0ZW1zIGhhdmUgdGhlIGJ1dHRvbiBkYXRhIGluIHRoZSBwYXJlbnQgb2YgdGhlIGVsZW1lbnQgY2xpY2tlZAoJCQlpZiAoICEhfnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZiggInVpLWxpbmstaW5oZXJpdCIgKSApIHsKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQucGFyZW50Tm9kZSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQkJfQoJCQkvLyBPdGhlcndpc2UsIGxvb2sgZm9yIHRoZSBkYXRhIG9uIHRoZSB0YXJnZXQgaXRzZWxmCgkJCX0gZWxzZSB7CgkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldCwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQl9CgkJCS8vIElmIGZvdW5kLCBncmFiIHRoZSBidXR0b24ncyBvdXRlciBlbGVtZW50CgkJCWlmICggYnRuRWxzICkgewoJCQkJdGFyZ2V0ID0gYnRuRWxzLm91dGVyOwoJCQl9IGVsc2UgewoJCQkJbmVlZENsb3Nlc3QgPSB0cnVlOwoJCQl9CgoJCQkkYnRuID0gJCggdGFyZ2V0ICk7CgkJCS8vIElmIHRoZSBvdXRlciBlbGVtZW50IHdhc24ndCBmb3VuZCBieSB0aGUgb3VyIGhldXJpc3RpY3MsIHVzZSAuY2xvc2VzdCgpCgkJCWlmICggbmVlZENsb3Nlc3QgKSB7CgkJCQkkYnRuID0gJGJ0bi5jbG9zZXN0KCAiLnVpLWJ0biIgKTsKCQkJfQoKCQkJaWYgKCAkYnRuLmxlbmd0aCA+IDAgJiYgISRidG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJGJ0bjsKCQkJCSRhY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLCAkbGluayA9ICQoIGxpbmsgKSwgaHR0cENsZWFudXA7CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBsaW5rIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2xpY2sgb3IgaXRzIG5vdCBhIGxlZnQKCQkJLy8gY2xpY2sgd2Ugd2FudCB0byBpZ25vcmUgdGhlIGNsaWNrCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhbGluayB8fCBldmVudC53aGljaCA+IDEgfHwgISRsaW5rLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vcmVtb3ZlIGFjdGl2ZSBsaW5rIGNsYXNzIGlmIGV4dGVybmFsICh0aGVuIGl0IHdvbid0IGJlIHRoZXJlIGlmIHlvdSBjb21lIGJhY2spCgkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQl9OwoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgIXBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdmFyIHRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCXJldmVyc2UgPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKHVybCksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUgdHJhbnNpdGlvbiBpcyBkZXJpdmVkIGZyb20gdGhlIHByZXZpb3VzCgkJCQkvLyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAodXJsSGlzdG9yeS5nZXRMYXN0KCkgfHwge30pLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIHNwZWNpYWwgY2FzZSBmb3IgZGlhbG9ncwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmIHVybEhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJaWYoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7CgkJCQkJfQoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vaWYgdG8gaXMgZGVmaW5lZCwgbG9hZCBpdAoJCQlpZiAoIHRvICkgewoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlIGVsZW1lbnQgZnJvbQoJCQkJLy8gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZS9hYnNvbHV0ZSBVUkwuIElmICd0bycgaXMKCQkJCS8vIGFuIGlkLCB3ZSBuZWVkIHRvIHJlc29sdmUgaXQgYWdhaW5zdCB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsCgkJCQkvLyBzaW5jZSB0aGUgaGFzaGNoYW5nZSBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsIHBhZ2UvZGlhbG9nLgoJCQkJdG8gPSAhcGF0aC5pc1BhdGgoIHRvICkgPyAoIHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB0bywgZG9jdW1lbnRCYXNlICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYSByZWZlcmVuY2UgdG8gYSBub24tZXhpc3RlbnQKCQkJCS8vIGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluc3RlYWQuIFdlIGtub3cgdGhhdCB0aGUgaW5pdGlhbCBoYXNoIHJlZmVycyB0byBhCgkJCQkvLyBub24tZXhpc3RlbnQgcGFnZSwgYmVjYXVzZSB0aGUgaW5pdGlhbCBoYXNoIGRpZCBub3QgZW5kIHVwIGluIHRoZSBpbml0aWFsIHVybEhpc3RvcnkgZW50cnkKCQkJCWlmICggdG8gPT09IHBhdGgubWFrZVVybEFic29sdXRlKCAnIycgKyB1cmxIaXN0b3J5LmluaXRpYWxEc3QsIGRvY3VtZW50QmFzZSApICYmCgkJCQkJdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggJiYgdXJsSGlzdG9yeS5zdGFja1swXS51cmwgIT09IHVybEhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gJC5tb2JpbGUuZmlyc3RQYWdlOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvLyBUT0RPIHJvbGwgdGhlIGxvZ2ljIGhlcmUgaW50byB0aGUgaGFuZGxlSGFzaENoYW5nZSBtZXRob2QKCQkkd2luZG93LmJpbmQoICJuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgdXJsOwoKCQkJaWYgKCBlLm9yaWdpbmFsRXZlbnQgJiYgZS5vcmlnaW5hbEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl1cmwgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUub3JpZ2luYWxFdmVudE5hbWUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYoICF1cmwgKSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQl9CgoJCQlpZiggIXVybCB8fCB1cmwgPT09ICIjIiB8fCB1cmwuaW5kZXhPZiggIiMiICsgJC5tb2JpbGUucGF0aC51aVN0YXRlS2V5ICkgPT09IDAgKXsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZXNob3ciLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkLm1vYmlsZS53aW5kb3cuYmluZCggInRocm90dGxlZHJlc2l6ZSIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCgkkKCBmdW5jdGlvbigpIHsgZG9tcmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7IH0gKTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKCgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoIGUudGFyZ2V0ICkgKSwgb3B0aW9uczsKCglpZiAoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWNvcm5lckNsYXNzID0gISF0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJZGlhbG9nV3JhcCA9ICQoICI8ZGl2Lz4iLCB7CgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKyBjb3JuZXJDbGFzcwoJCQkJfSk7CgoJCSRlbC5hZGRDbGFzcyggInVpLWRpYWxvZyB1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbC53cmFwSW5uZXIoIGRpYWxvZ1dyYXAgKTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkJdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9vbiggJGVsLCB7CgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3JlYXRlQ29tcGxldGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLCBidG4sIGxvY2F0aW9uOwoKCQlpZiAoIHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uICkgewoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbi5yZW1vdmUoKTsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBudWxsOwoJCX0KCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCS8vIFNhbml0aXplIHZhbHVlCgkJCWxvY2F0aW9uID0gKCB2YWx1ZSA9PT0gImxlZnQiID8gImxlZnQiIDogInJpZ2h0IiApOwoJCQlidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWJ0bi0iICsgbG9jYXRpb24gKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKS5wcmVwZW5kKCBidG4gKTsKCQkJaWYgKCB0aGlzLl9jcmVhdGVDb21wbGV0ZSAmJiAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCWJ0bi5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQl0aGlzLl9jcmVhdGVDb21wbGV0ZSA9IHRydWU7CgoJCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkJLy8gb24gdGhlIGJ1dHRvbiBhbmQgbGV0dGluZyBuYXYgaGFuZGxlIGl0CgkJCS8vCgkJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJCS8vIHJlb3BlbmluZyB0aGUgZGlhbG9nIGlmIHRoZSBkaWFsb2cgb3BlbmluZyBpdGVtIHdhcyBkaXJlY3RseSB1bmRlciB0aGUgY2xvc2UgYnV0dG9uLgoJCQlidG4uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImNsb3NlQnRuIiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCS8vIElmIHRoZSBoYXNoIGxpc3RlbmluZyBpcyBlbmFibGVkIGFuZCB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgcHJlY2VkaW5nIGhpc3RvcnkKCQkJLy8gZW50cnkgaXQncyBvayB0byBnbyBiYWNrLiBJbml0aWFsIHBhZ2VzIHdpdGggdGhlIGRpYWxvZyBoYXNoIHN0YXRlIGFyZSBhbiBleGFtcGxlCgkJCS8vIHdoZXJlIHRoZSBzdGFjayBjaGVjayBpcyBuZWNlc3NhcnkKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJiBoaXN0LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCWlkeCA9IE1hdGgubWF4KCAwLCBoaXN0LmFjdGl2ZUluZGV4IC0gMSApOwoJCQkJZHN0ID0gaGlzdC5zdGFja1sgaWR4IF0ucGFnZVVybCB8fCBoaXN0LnN0YWNrWyBpZHggXS51cmw7CgkJCQloaXN0LnByZXZpb3VzSW5kZXggPSBoaXN0LmFjdGl2ZUluZGV4OwoJCQkJaGlzdC5hY3RpdmVJbmRleCA9IGlkeDsKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCBkc3QgKSApIHsKCQkJCQlkc3QgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgZHN0ICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZHN0LCB7IGRpcmVjdGlvbjogImJhY2siLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCXZhciAkcGFnZSA9ICQoIGUudGFyZ2V0ICksCgkJbyA9ICRwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVGhpcyBmdW5jdGlvbiBjYWxscyBnZXRBdHRyaWJ1dGUsIHdoaWNoIHNob3VsZCBiZSBzYWZlIGZvciBkYXRhLSogYXR0cmlidXRlcwp2YXIgZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oIGUsIGtleSApIHsKCXZhciB2YWx1ZSA9IGUuZ2V0QXR0cmlidXRlKCBrZXkgKTsKCglyZXR1cm4gdmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCXZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCXZhbHVlID09PSBudWxsID8gdW5kZWZpbmVkIDogdmFsdWU7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQluc0tleSA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQlrZXk7CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAibWluaSIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoJCQlob3ZlciA9IGZhbHNlLAoJCQlzdGF0ZSA9ICJ1cCIsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQlmb3IgKCBrZXkgaW4gbyApIHsKCQkJaWYgKCBvWyBrZXkgXSA9PT0gdW5kZWZpbmVkIHx8IG9bIGtleSBdID09PSBudWxsICkgewoJCQkJZWwucmVtb3ZlQXR0ciggbnNLZXkgKyBrZXkgKTsKCQkJfSBlbHNlIHsKCQkJCWUuc2V0QXR0cmlidXRlKCBuc0tleSArIGtleSwgb1sga2V5IF0gKTsKCQkJfQoJCX0KCgkJaWYgKCBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInJlbCIgKSA9PT0gInBvcHVwIiAmJiBlbC5hdHRyKCAiaHJlZiIgKSApIHsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWhhc3BvcHVwIiwgdHJ1ZSApOwoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtb3ducyIsIGVsLmF0dHIoICJocmVmIiApICk7CgkJfQoKCQkvLyBDaGVjayBpZiB0aGlzIGVsZW1lbnQgaXMgYWxyZWFkeSBlbmhhbmNlZAoJCWJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAoICggZS50YWdOYW1lID09PSAiSU5QVVQiIHx8IGUudGFnTmFtZSA9PT0gIkJVVFRPTiIgKSA/IGUucGFyZW50Tm9kZSA6IGUgKSwgImJ1dHRvbkVsZW1lbnRzIiApOwoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJCggZSApOwoJCQlidXR0b25Jbm5lciA9IGJ1dHRvbkVsZW1lbnRzLmlubmVyOwoJCQlidXR0b25UZXh0ID0gYnV0dG9uRWxlbWVudHMudGV4dDsKCQkJLy8gV2Ugd2lsbCByZWNyZWF0ZSB0aGlzIGljb24gYmVsb3cKCQkJJCggYnV0dG9uRWxlbWVudHMuaWNvbiApLnJlbW92ZSgpOwoJCQlidXR0b25FbGVtZW50cy5pY29uID0gbnVsbDsKCQkJaG92ZXIgPSBidXR0b25FbGVtZW50cy5ob3ZlcjsKCQkJc3RhdGUgPSBidXR0b25FbGVtZW50cy5zdGF0ZTsKCQl9CgkJZWxzZSB7CgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQl9CgkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJaWYgKCBhdHRhY2hFdmVudHMgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biAiOwoJCWJ1dHRvbkNsYXNzICs9ICggaG92ZXIgPyAidWktYnRuLWhvdmVyLSIgKyBvLnRoZW1lIDogIiIgKTsKCQlidXR0b25DbGFzcyArPSAoIHN0YXRlID8gIiB1aS1idG4tIiArIHN0YXRlICsgIi0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gby5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQlidXR0b25DbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8ubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgbWluaWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8ubWluaSA9PT0gdHJ1ZSA/ICIgdWktbWluaSIgOiAiIHVpLWZ1bGxzaXplIjsKCQl9CgoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCQlidXR0b25UZXh0LmNsYXNzTmFtZSA9IHRleHRDbGFzczsKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCQl9CgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJaWYgKCAhKCBidXR0b25FbGVtZW50cyAmJiBidXR0b25FbGVtZW50cy5pY29uICkgKSB7CgkJCQlidXR0b25JY29uLmlubmVySFRNTCA9ICImIzE2MDsiOwoJCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvbkljb24gKTsKCQkJfQoJCX0KCgkJd2hpbGUgKCBlLmZpcnN0Q2hpbGQgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCX0KCgkJLy8gQXNzaWduIGEgc3RydWN0dXJlIGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uIHRvIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbi4gVGhpcwoJCS8vIHdpbGwgYWxsb3cgdXMgdG8gcmVjb2duaXplIHRoaXMgYXMgYW4gYWxyZWFkeS1lbmhhbmNlZCBidXR0b24gaW4gZnV0dXJlIGNhbGxzIHRvIGJ1dHRvbk1hcmt1cCgpLgoJCWJ1dHRvbkVsZW1lbnRzID0gewoJCQlob3ZlciA6IGhvdmVyLAoJCQlzdGF0ZSA6IHN0YXRlLAoJCQliY2xzICA6IGJ1dHRvbkNsYXNzLAoJCQlvdXRlciA6IGUsCgkJCWlubmVyIDogYnV0dG9uSW5uZXIsCgkJCXRleHQgIDogYnV0dG9uVGV4dCwKCQkJaWNvbiAgOiBidXR0b25JY29uCgkJfTsKCgkJJC5kYXRhKCBlLCAgICAgICAgICAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvbklubmVyLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uVGV4dCwgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJaWYgKCBidXR0b25JY29uICkgewoJCQkkLmRhdGEoIGJ1dHRvbkljb24sICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCXdyYXBwZXJFbHM6ICJzcGFuIgp9OwoKZnVuY3Rpb24gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGVsZW1lbnQgKSB7CiAgICB2YXIgY25hbWU7CgogICAgd2hpbGUgKCBlbGVtZW50ICkgewoJCS8vIE5vdGUgdGhhdCB3ZSBjaGVjayBmb3IgdHlwZW9mIGNsYXNzTmFtZSBiZWxvdyBiZWNhdXNlIHRoZSBlbGVtZW50IHdlCgkJLy8gaGFuZGVkIGNvdWxkIGJlIGluIGFuIFNWRyBET00gd2hlcmUgY2xhc3NOYW1lIG9uIFNWRyBlbGVtZW50cyBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgb2YgYSBkaWZmZXJlbnQgdHlwZSAoU1ZHQW5pbWF0ZWRTdHJpbmcpLiBXZSBvbmx5IG9wZXJhdGUgb24gSFRNTCBET00KCQkvLyBlbGVtZW50cywgc28gd2UgbG9vayBmb3IgcGxhaW4gInN0cmluZyIuCiAgICAgICAgY25hbWUgPSAoIHR5cGVvZiBlbGVtZW50LmNsYXNzTmFtZSA9PT0gJ3N0cmluZycgKSAmJiAoIGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICk7CiAgICAgICAgaWYgKCBjbmFtZSAmJiBjbmFtZS5pbmRleE9mKCAidWktYnRuICIgKSA+IC0xICYmIGNuYW1lLmluZGV4T2YoICJ1aS1kaXNhYmxlZCAiICkgPCAwICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCBjbGFzc1RvUmVtb3ZlLCBjbGFzc1RvQWRkLCBob3Zlciwgc3RhdGUgKSB7Cgl2YXIgYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICRidG5bIDAgXSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJJGJ0bi5yZW1vdmVDbGFzcyggY2xhc3NUb1JlbW92ZSApLmFkZENsYXNzKCBjbGFzc1RvQWRkICk7CglpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCWJ1dHRvbkVsZW1lbnRzLmJjbHMgPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICkKCQkJLmFkZENsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzICsgIiAiICsgY2xhc3NUb0FkZCApCgkJCS5yZW1vdmVDbGFzcyggY2xhc3NUb1JlbW92ZSApCgkJCS5hdHRyKCAiY2xhc3MiICk7CgkJaWYgKCBob3ZlciAhPT0gdW5kZWZpbmVkICkgewoJCQlidXR0b25FbGVtZW50cy5ob3ZlciA9IGhvdmVyOwoJCX0KCQlidXR0b25FbGVtZW50cy5zdGF0ZSA9IHN0YXRlOwoJfQp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7Cgl2YXIgaG92ZXJEZWxheSA9ICQubW9iaWxlLmJ1dHRvbk1hcmt1cC5ob3ZlckRlbGF5LCBob3YsIGZvYzsKCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWlzVG91Y2hFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL150b3VjaC8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICksCgkJCQlldnQgPSBldmVudC50eXBlOwoKCQkJaWYgKCAkYnRuLmxlbmd0aCApIHsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCB1bmRlZmluZWQsICJkb3duIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCB1bmRlZmluZWQsICJkb3duIiApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZWNhbmNlbCIgfHwgZXZ0ID09PSAidm1vdXNldXAiICkgewoJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLWRvd24tIiArIHRoZW1lLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAidXAiICk7CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdmVyIiB8fCBldnQgPT09ICJmb2N1cyIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlmb2MgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUsIHRydWUsICIiICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW91dCIgfHwgZXZ0ID09PSAiYmx1ciIgfHwgZXZ0ID09PSAic2Nyb2xsc3RhcnQiICkgewoJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIGZhbHNlLCAidXAiICk7CgkJCQkJaWYgKCBob3YgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaG92ICk7CgkJCQkJfQoJCQkJCWlmICggZm9jICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGZvYyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0sCgkJImZvY3VzaW4gZm9jdXMiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfSwKCQkiZm9jdXNvdXQgYmx1ciI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQljb2xsYXBzZWRJY29uOiAicGx1cyIsCgkJZXhwYW5kZWRJY29uOiAibWludXMiLAoJCWljb25wb3M6ICJsZWZ0IiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQljb2xsYXBzaWJsZSA9ICRlbC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlIiApLAoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oIG8uaGVhZGluZyApLmZpcnN0KCksCgkJCWNvbGxhcHNpYmxlQ29udGVudCA9IGNvbGxhcHNpYmxlLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQnPjwvZGl2PiIgKS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyA9ICIiOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIGNvbGxhcHNpYmxlSGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUhlYWRpbmcgKTsKCQkJY29sbGFwc2libGVIZWFkaW5nLm5leHQoKS5yZW1vdmUoKTsKCQl9CgoJCS8vIElmIHdlIGFyZSBpbiBhIGNvbGxhcHNpYmxlIHNldAoJCWlmICggY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29sbGFwc2libGVTZXQsICJjIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGNvbGxhcHNlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmNvbGxhcHNlZEljb24gPSAkZWwuanFtRGF0YSggImNvbGxhcHNlZC1pY29uIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb247CgoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGV4cGFuZGVkIGljb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uZXhwYW5kZWRJY29uID0gJGVsLmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApIHx8IG8uZXhwYW5kZWRJY29uOwoKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmljb25wb3MgPSAkZWwuanFtRGF0YSggImljb25wb3MiICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICkgfHwgby5pY29ucG9zOwoKCQkJLy8gSW5oZXJpdCB0aGUgcHJlZmVyZW5jZSBmb3IgaW5zZXQgZnJvbSBjb2xsYXBzaWJsZS1zZXQgb3Igc2V0IHRoZSBkZWZhdWx0IHZhbHVlIHRvIGVuc3VyZSBlcXVhbHR5IHdpdGhpbiBhIHNldAoJCQlpZiAoIGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJby5pbnNldCA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKTsKCQkJfSBlbHNlIHsKCQkJCW8uaW5zZXQgPSB0cnVlOwoJCQl9CgkJCS8vIFNldCBjb3JuZXJzIGZvciBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlcyB0byBmYWxzZSB3aGVuIGluIGEgY29sbGFwc2libGUtc2V0CgkJCW8uY29ybmVycyA9IGZhbHNlOwoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGZvciBtaW5pIGluIHRoZSBzZXQKCQkJaWYgKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBnZXQgaW5oZXJpdGVkIHRoZW1lIGlmIG5vdCBhIHNldCBhbmQgbm8gdGhlbWUgaGFzIGJlZW4gc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJCX0KCQl9CgoJCWlmICggISFvLmluc2V0ICkgewoJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb2xsYXBzaWJsZS1pbnNldCI7CgkJCWlmICggISFvLmNvcm5lcnMgKSB7CgkJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb3JuZXItYWxsIiA7CgkJCX0KCQl9CgkJaWYgKCBvLmNvbnRlbnRUaGVtZSApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQiOwoJCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApOwoJCX0KCQlpZiAoIGNvbGxhcHNpYmxlQ2xhc3NlcyAhPT0gIiIgKSB7CgkJCWNvbGxhcHNpYmxlLmFkZENsYXNzKCBjb2xsYXBzaWJsZUNsYXNzZXMgKTsKCQl9CgkJCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29ucG9zOiBvLmljb25wb3MsCgkJCQkJaWNvbjogby5jb2xsYXBzZWRJY29uLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSk7CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKTsKCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG8uZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG8uY29sbGFwc2VkSWNvbiwgKCBpc0NvbGxhcHNlIHx8IG8uZXhwYW5kZWRJY29uID09PSBvLmNvbGxhcHNlZEljb24gKSApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkJJHRoaXMudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29udGVudC1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApOwoKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQkJCX0KCQkJfSkKCQkJLnRyaWdnZXIoIG8uY29sbGFwc2VkID8gImNvbGxhcHNlIiA6ICJleHBhbmQiICk7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkuYmluZCggInRhcCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiYSIgKS5maXJzdCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCXZhciB0eXBlID0gY29sbGFwc2libGVIZWFkaW5nLmlzKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiApID8gImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXZpc2libGVzID0gJGVscy5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJaWYgKCB2aXNpYmxlcy5sZW5ndGggPT09IDAgKSB7CgkJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCX0KCQl9CgoJCXJldHVybiB2aXNpYmxlczsKCX0sCgoJX2FkZEZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzLCAkdmlzaWJsZXMsIGNyZWF0ZSApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCQkkdmlzaWJsZXMuZXEoIDAgKS5hZGRDbGFzcyggInVpLWZpcnN0LWNoaWxkIiApLmVuZCgpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxhc3QtY2hpbGQiICk7CgkJaWYgKCAhY3JlYXRlICkgewoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb3JuZXIgc3R5bGluZyBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29ybmVycyApIHsKCQkJby5jb3JuZXJzID0gJGVsLmpxbURhdGEoICJjb3JuZXJzIiApOwoJCX0KCQkKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCQlvLmNvcm5lcnMgPSBvLmNvcm5lcnMgIT09IHVuZGVmaW5lZCA/IG8uY29ybmVycyA6IHRydWU7CgkJCgkJaWYgKCAhIW8uY29ybmVycyAmJiAhIW8uaW5zZXQgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwiICk7CgkJfQoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKQoJCQkJCQkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQkJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkJLnRyaWdnZXIoICJjb2xsYXBzZSIgKTsKCQkJCQl9CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb2xsYXBzaWJsZXNJblNldCA9ICRlbC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICksCgkJCWV4cGFuZGVkID0gY29sbGFwc2libGVzSW5TZXQuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApOwoJCXRoaXMuX3JlZnJlc2goICJ0cnVlIiApOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJZXhwYW5kZWQudHJpZ2dlciggImV4cGFuZCIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gZmlsdGVyIGZ1bmN0aW9uIHJlbW92ZXMgd2hpdGVzcGFjZSBiZXR3ZWVuIGxhYmVsIGFuZCBmb3JtIGVsZW1lbnQgc28gd2UgY2FuIHVzZSBpbmxpbmUtYmxvY2sgKG5vZGVUeXBlIDMgPSB0ZXh0KQokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMKCQkuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICkKCQkuY29udGVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gKCB0aGlzLm5vZGVUeXBlID09PSAzICYmICEvXFMvLnRlc3QoIHRoaXMubm9kZVZhbHVlICkgKTsKCQl9KS5yZW1vdmUoKTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbmF2YmFyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIgdWktbWluaSIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zLmJ1dHRvbk1hcmt1cCh7CgkJCWNvcm5lcnM6CWZhbHNlLAoJCQlzaGFkb3c6CQlmYWxzZSwKCQkJaW5saW5lOiAgICAgdHJ1ZSwKCQkJaWNvbnBvczoJaWNvbnBvcwoJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIHVpLWJ0bi1pbm5lciBpcyByZXR1cm5lZCBhcyB0YXJnZXQKCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCAiYSIgKSA/ICQoIHRoaXMgKSA6ICQoIHRoaXMgKS5wYXJlbnQoICJhIiApOwoJCQkKCQkJaWYgKCAhdGFyZ2V0LmlzKCAiLnVpLWRpc2FibGVkLCAudWktYnRuLWFjdGl2ZSIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoJCQkJCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogImMiLAoJCWhlYWRlclRoZW1lOiAiYiIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJaWNvbjogImFycm93LXIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoZnVuY3Rpb24oIGksIG9yaWcgKSB7CgkJCXJldHVybiBvcmlnICsgIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaXN0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCWpzQ291bnQgPSAhJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQsCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBvbCAmJiBqc0NvdW50ICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggb2wgKSB7CgkJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKSAtIDE7CgkJCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJCQl9IGVsc2UgewoJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCWNvdW50ZXIgPSAxOwoJCQl9CgkJfQoKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJdmFyIGlzRGl2aWRlciA9ICggaXRlbS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSggImljb24iICk7CgoJCQkJCWl0ZW0uYnV0dG9uTWFya3VwKHsKCQkJCQkJd3JhcHBlckVsczogImRpdiIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQlpY29ucG9zOiAicmlnaHQiLAoJCQkJCQlpY29uOiBhLmxlbmd0aCA+IDEgfHwgaWNvbiA9PT0gZmFsc2UgPyBmYWxzZSA6IGljb24gfHwgbGlzdGljb24gfHwgby5pY29uLAoJCQkJCQl0aGVtZTogaXRlbVRoZW1lCgkJCQkJfSk7CgoJCQkJCWlmICggKCBpY29uICE9PSBmYWxzZSApICYmICggYS5sZW5ndGggPT09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKGxhc3QuZ2V0RW5jb2RlZFRleHQoKSkgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktbGktbGluay1hbHQiICkKCQkJCQkJCS5lbXB0eSgpCgkJCQkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQkJCXRoZW1lOiBpdGVtVGhlbWUsCgkJCQkJCQkJaWNvbjogZmFsc2UsCgkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIKCQkJCQkJCX0pCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCQkuYXBwZW5kKAoJCQkJCQkJCQkkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCQkJCQkJdGhlbWU6IHNwbGl0dGhlbWUsCgkJCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQkJCQkJCS8vIGxpbmsgaWNvbiBvdmVycmlkZXMgbGlzdCBpdGVtIGljb24gb3ZlcnJpZGVzIHVsIGVsZW1lbnQgb3ZlcnJpZGVzIG9wdGlvbnMKCQkJCQkJCQkJCWljb246IGxpbmtJY29uIHx8IGljb24gfHwgbGlzdHNwbGl0aWNvbiB8fCBvLnNwbGl0SWNvbgoJCQkJCQkJCQl9KQoJCQkJCQkJCSk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJhci0iICsgKCBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBkaXZpZGVydGhlbWUgKTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CgkJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCQkJCW5ld1N0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQljb3VudGVyID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQkJCQljb3VudGVyID0gMTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9IGVsc2UgewoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLXN0YXRpYyB1aS1idG4tdXAtIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKTsKCQkJCX0pLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyAoICRsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lKSArICIgdWktYnRuLWNvcm5lci1hbGwiICk7CgoJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gbG9vayBhdCB0aGUgZmlyc3QgaW1hZ2UgaW4gdGhlIGxpc3QgaXRlbQoJCS8vIGl0c2VsZiwgYW5kIGFueSAudWktbGluay1pbmhlcml0IGVsZW1lbnQgaXQgbWF5IGNvbnRhaW4sIHNvIHdlCgkJLy8gY2FuIHBsYWNlIHRoZSBhcHByb3ByaWF0ZSBjbGFzc2VzIG9uIHRoZSBpbWFnZSBhbmQgbGlzdCBpdGVtLgoJCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBzb21ldGhpbmcgbGlrZToKCQkvLwoJCS8vICAgIGxpLmZpbmQoIj5pbWc6ZXEoMCksIC51aS1saW5rLWluaGVyaXQ+aW1nOmVxKDApIikuZWFjaCggLi4uICk7CgkJLy8KCQkvLyBCdXQgZXhlY3V0aW5nIGEgZmluZCgpIGxpa2UgdGhhdCBvbiBXaW5kb3dzIFBob25lIDcuNSB0b29rIGEKCQkvLyByZWFsbHkgbG9uZyB0aW1lLiBXYWxraW5nIHRoaW5ncyBtYW51YWxseSB3aXRoIHRoZSBjb2RlIGJlbG93CgkJLy8gYWxsb3dzIHRoZSA0MDAgbGlzdHZpZXcgaXRlbSBwYWdlIHRvIGxvYWQgaW4gYWJvdXQgMyBzZWNvbmRzIGFzCgkJLy8gb3Bwb3NlZCB0byAzMCBzZWNvbmRzLgoKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCAkbGlzdC5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgdGhpcy5fZ2V0VmlzaWJsZXMoIGxpLCBjcmVhdGUgKSwgY3JlYXRlICk7CgkJLy8gYXV0b2RpdmlkZXJzIGJpbmRzIHRvIHRoaXMgdG8gcmVkcmF3IGRpdmlkZXJzIGFmdGVyIHRoZSBsaXN0dmlldyByZWZyZXNoCgkJdGhpcy5fdHJpZ2dlciggImFmdGVycmVmcmVzaCIgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzRnVsbCA9ICQoIGxpc3QucHJldkFsbCgpLnRvQXJyYXkoKS5yZXZlcnNlKCkgKSwKCQkJCW5vZGVFbHMgPSBub2RlRWxzRnVsbC5sZW5ndGggPyBub2RlRWxzRnVsbCA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKyBkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iICkgOiAiIiApCgkJCQkJCQkucGFyZW50KCkKCQkJCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCW5ld1BhZ2UucGFnZSgpOwoKCQkJYW5jaG9yID0gcGFyZW50LmZpbmQoICdhOmZpcnN0JyApOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYgKCBoYXNTdWJQYWdlcyAmJgoJCQlwYXJlbnRQYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICYmCgkJCXBhcmVudFBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgPT09IGZhbHNlICkgewoKCQkJdmFyIG5ld1JlbW92ZSA9IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTCwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCWlmICggdWkubmV4dFBhZ2UgKSB7CgkJCQkJbnBVUkwgPSBuZXh0UGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJCWlmICggbnBVUkwuaW5kZXhPZiggcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApICE9PSAwICkgewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS50cmlnZ2VyKCBwckV2ZW50ICk7CgkJCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCQlwYXJlbnRQYWdlLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICInKSIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSwgaW5wdXRbdHlwZT0nZmlsZSddIiwKCQljbGVhckJ0bjogZmFsc2UsCgkJY2xlYXJTZWFyY2hCdXR0b25UZXh0OiBudWxsLCAvL2RlcHJlY2F0aW5nIGZvciAxLjMuLi4KCQljbGVhckJ0blRleHQ6ICJjbGVhciB0ZXh0IiwKCQlkaXNhYmxlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pY2xhc3MgPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWlzU2VhcmNoID0gaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlmb2N1c2VkRWwsCgkJCWNsZWFyYnRuLAoJCQljbGVhckJ0blRleHQgPSBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCB8fCBvLmNsZWFyQnRuVGV4dCwKCQkJY2xlYXJCdG5CbGFja2xpc3QgPSBpbnB1dC5pcyggInRleHRhcmVhLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlpbnB1dE5lZWRzQ2xlYXJCdG4gPSAhIW8uY2xlYXJCdG4gJiYgIWNsZWFyQnRuQmxhY2tsaXN0LAoJCQlpbnB1dE5lZWRzV3JhcCA9IGlucHV0LmlzKCAiaW5wdXQiICkgJiYgIWlucHV0LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKTsKCgkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJfSwgMCApOwoJCX0KCgkJJCggImxhYmVsW2Zvcj0nIiArIGlucHV0LmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLWlucHV0LXRleHQiICk7CgoJCWZvY3VzZWRFbCA9IGlucHV0LmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoJCS8vInNlYXJjaCIgYW5kICJ0ZXh0IiBpbnB1dCB3aWRnZXRzCgkJaWYgKCBpc1NlYXJjaCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJfSBlbHNlIGlmICggaW5wdXROZWVkc1dyYXAgKSB7CgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC10ZXh0IHVpLXNoYWRvdy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3ciICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9CgoJCWlmKCBpbnB1dE5lZWRzQ2xlYXJCdG4gfHwgaXNTZWFyY2ggKSB7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9JyIgKyBjbGVhckJ0blRleHQgKyAiJz4iICsgY2xlYXJCdG5UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaW5wdXQKCQkJCQkJLnZhbCggIiIgKQoJCQkJCQkuZm9jdXMoKQoJCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQljbGVhcmJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSkKCQkJCS5hcHBlbmRUbyggZm9jdXNlZEVsICkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCWljb246ICJkZWxldGUiLAoJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCW1pbmk6IG8ubWluaQoJCQkJfSk7CgkJCQkKCQkJaWYgKCAhaXNTZWFyY2ggKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgkJCX0KCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCAicGFzdGUgY3V0IGtleXVwIGlucHV0IGZvY3VzIGNoYW5nZSBibHVyIiwgdG9nZ2xlQ2xlYXIgKTsKCQl9CgkJZWxzZSBpZiAoICFpbnB1dE5lZWRzV3JhcCAmJiAhaXNTZWFyY2ggKSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CQkJCgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CQkJCQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwVGltZW91dDsKCgkJCXRoaXMuX2tleXVwID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoJCQkJCQoJCQkJCWlucHV0LmhlaWdodCggc2Nyb2xsSGVpZ2h0IC0gcGFkZGluZ0hlaWdodCArIGV4dHJhTGluZUhlaWdodCApOwoJCQkJfQoJCQl9OwoKCQkJaW5wdXQub24oICJrZXl1cCBjaGFuZ2UgaW5wdXQgcGFzdGUiLCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyVGltZW91dCgga2V5dXBUaW1lb3V0ICk7CgkJCQlrZXl1cFRpbWVvdXQgPSBzZXRUaW1lb3V0KCBzZWxmLl9rZXl1cCwga2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJCX0pOwoKCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCS8vIGFqYXggdGhlIGhlaWdodCBpcyByZWNhbGN1bGF0ZWQgd2l0aG91dCB1c2VyIGlucHV0CgkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS5kb2N1bWVudCwgeyAicGFnZWNoYW5nZSI6ICJfa2V5dXAiIH0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIGlucHV0LnZhbCgpICkgKSB7CgkJCQkvLyBiaW5kIHRvIHRoZSB3aW5kb3cgbG9hZCB0byBtYWtlIHN1cmUgdGhlIGhlaWdodCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIEJPVEgKCQkJCS8vIHRoZSBET00gYW5kIENTUwoJCQkJdGhpcy5fb24oIHRydWUsICQubW9iaWxlLndpbmRvdywgeyJsb2FkIjogIl9rZXl1cCJ9KTsKCQkJfQoJCX0KCQlpZiAoIGlucHV0LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlucHV0TmVlZHNXcmFwID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCXBhcmVudE5lZWRzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApCSYmICggaW5wdXROZWVkc1dyYXAgfHwgaXNTZWFyY2ggKTsKCQkJCgkJaWYgKCBwYXJlbnROZWVkc0Rpc2FibGVkICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0VuYWJsZWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgoJCWlmICggcGFyZW50TmVlZHNFbmFibGVkICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUmV2ZWFsID0gZmFsc2U7Ci8vIFRPRE8gcmVuYW1lIGNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUsIGl0ZW0gKSB7CgkJcmV0dXJuIHRleHQudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwoJfTsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCwgb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibW9iaWxlLWxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmZpbHRlciApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQlsaXN0LmNoaWxkcmVuKCkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KS5zdWJtaXQoIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlYXJjaC5ibHVyKCk7CgkJfSksCgkJb25LZXlVcCA9IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGkgPSBsaXN0LmNoaWxkcmVuKCksCgkJCQlsYXN0dmFsID0gJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICkgKyAiIiwKCQkJCWNoaWxkSXRlbXMgPSBmYWxzZSwKCQkJCWl0ZW10ZXh0ID0gIiIsCgkJCQlpdGVtLAoJCQkJLy8gQ2hlY2sgaWYgYSBjdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMKCQkJCWlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgPSBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrICE9PSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsaXN0dmlldy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiB0aGlzIH0gKTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggaXNDdXN0b21GaWx0ZXJDYWxsYmFjayB8fCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgdmFsLmluZGV4T2YoIGxhc3R2YWwgKSAhPT0gMCApIHsKCgkJCQkvLyBDdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMgb3IgcmVtb3ZlZCBjaGFycyBvciBwYXN0ZWQgc29tZXRoaW5nIHRvdGFsbHkgZGlmZmVyZW50LCBjaGVjayBhbGwgaXRlbXMKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oKTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBPbmx5IGNoYXJzIGFkZGVkLCBub3QgcmVtb3ZlZCwgb25seSB1c2UgdmlzaWJsZSBzdWJzZXQKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICI6bm90KC51aS1zY3JlZW4taGlkZGVuKSIgKTsKCgkJCQlpZiAoICFsaXN0SXRlbXMubGVuZ3RoICYmIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICkgewoJCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCB2YWwgKSB7CgoJCQkJLy8gVGhpcyBoYW5kbGVzIGhpZGluZyByZWd1bGFyIHJvd3Mgd2l0aG91dCB0aGUgdGV4dCB3ZSBzZWFyY2ggZm9yCgkJCQkvLyBhbmQgYW55IGxpc3QgZGl2aWRlcnMgd2l0aG91dCByZWd1bGFyIHJvd3Mgc2hvd24gdW5kZXIgaXQKCgkJCQlmb3IgKCB2YXIgaSA9IGxpc3RJdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCQlpdGVtID0gJCggbGlzdEl0ZW1zWyBpIF0gKTsKCQkJCQlpdGVtdGV4dCA9IGl0ZW0uanFtRGF0YSggImZpbHRlcnRleHQiICkgfHwgaXRlbS50ZXh0KCk7CgoJCQkJCWlmICggaXRlbS5pcyggImxpOmpxbURhdGEocm9sZT1saXN0LWRpdmlkZXIpIiApICkgewoKCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgIWNoaWxkSXRlbXMgKTsKCgkJCQkJCS8vIE5ldyBidWNrZXQhCgkJCQkJCWNoaWxkSXRlbXMgPSBmYWxzZTsKCgkJCQkJfSBlbHNlIGlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayggaXRlbXRleHQsIHZhbCwgaXRlbSApICkgewoKCQkJCQkJLy9tYXJrIHRvIGJlIGhpZGRlbgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCB0cnVlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vIFRoZXJlJ3MgYSBzaG93biBpdGVtIGluIHRoZSBidWNrZXQKCQkJCQkJY2hpbGRJdGVtcyA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFNob3cgaXRlbXMsIG5vdCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiOm5vdCgudWktZmlsdGVyLWhpZGVxdWV1ZSkiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCgkJCQkvLyBIaWRlIGl0ZW1zLCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiLnVpLWZpbHRlci1oaWRlcXVldWUiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgdHJ1ZSApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIsIGZhbHNlICk7CgoJCQl9IGVsc2UgewoKCQkJCS8vZmlsdGVydmFsdWUgaXMgZW1wdHkgPT4gc2hvdyBhbGwKCQkJCWxpc3RJdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCAhIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICk7CgkJCX0KCQkJbGlzdHZpZXcuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCBsaXN0dmlldy5fZ2V0VmlzaWJsZXMoIGxpLCBmYWxzZSApLCBmYWxzZSApOwoJCX0sCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIGlucHV0Iiwgb25LZXlVcCApCgkJLmFwcGVuZFRvKCB3cmFwcGVyICkKCQkudGV4dGlucHV0KCk7CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmluc2V0ICkgewoJCXdyYXBwZXIuYWRkQ2xhc3MoICJ1aS1saXN0dmlldy1maWx0ZXItaW5zZXQiICk7Cgl9CgoJd3JhcHBlci5iaW5kKCAic3VibWl0IiwgZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSkKCS5pbnNlcnRCZWZvcmUoIGxpc3QgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVycyA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn07CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggInVsLG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7CgoJdmFyIGxpc3QgPSAkKCB0aGlzICksCgkJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibW9iaWxlLWxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHJlcGxhY2VEaXZpZGVycyA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQl2YXIgbGlzID0gbGlzdC5maW5kKCAnbGknICksCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsIGxpLCBkaXZpZGVyVGV4dDsKCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbaV07CgkJCWRpdmlkZXJUZXh0ID0gbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdkYXRhLScgKyAkLm1vYmlsZS5ucyArICdyb2xlJywgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9OwoKCXZhciBhZnRlckxpc3R2aWV3UmVmcmVzaCA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LnVuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCQlyZXBsYWNlRGl2aWRlcnMoKTsKCQlsaXN0dmlldy5yZWZyZXNoKCk7CgkJbGlzdC5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJfTsKCglhZnRlckxpc3R2aWV3UmVmcmVzaCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogdW5jaGVja2VkU3RhdGUsCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJYWN0aXZlID0gIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPyBhY3RpdmUgOiAiIiApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMuY2hlY2tlZGljb24gfSApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCBjaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLnVuY2hlY2tlZGljb24gfSApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNoZWNrYm94cmFkaW8ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQkvLyBjcmVhdGUgYSBjb3B5IG9mIHRoaXMub3B0aW9ucyB3ZSBjYW4gcGFzcyB0byBidXR0b25NYXJrdXAKCQkJbyA9ICggZnVuY3Rpb24oIHRkbyApIHsKCQkJCXZhciBrZXksIHJldCA9IHt9OwoKCQkJCWZvciAoIGtleSBpbiB0ZG8gKSB7CgkJCQkJaWYgKCB0ZG9bIGtleSBdICE9PSBudWxsICYmIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCQkJCXJldFsga2V5IF0gPSB0ZG9bIGtleSBdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gcmV0OwoJCQl9ICkoIHRoaXMub3B0aW9ucyApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gZ2V0IHRoZSBpbmhlcml0ZWQgdGhlbWUKCQkvLyBUT0RPIGNlbnRyYWxpemUgZm9yIGFsbCB3aWRnZXRzCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQlpZiAoIGNsYXNzZXMgKSB7CgkJCQljbGFzc2VzICs9ICIgdWktc3VibWl0IjsKCQkJfSBlbHNlIHsKCQkJCWNsYXNzZXMgPSAidWktc3VibWl0IjsKCQkJfQoJCX0KCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoIG8gKQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wID0ge307CgoJCW9wWyBrZXkgXSA9IHZhbHVlOwoJCWlmICgga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJdGhpcy5idXR0b24uYnV0dG9uTWFya3VwKCBvcCApOwoJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlciggIl9zZXRPcHRpb24iLCBrZXksIHZhbHVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzU2VsZWN0ID0gdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGNUeXBlID09PSAic2VsZWN0IiwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCQkJbWluID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlcjsKCQkJCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gW3RoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyICIgOiAidWktc2xpZGVyLXRyYWNrICIsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCIsIG1pbmlDbGFzc10uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogInNsaWRlciIsCgkJCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCQkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIHZhciBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgc2xpZGVyVGhlbWUsICIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCQkKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgkJCQoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gT25seSBhZGQgZm9jdXMgY2xhc3MgdG8gdG9nZ2xlIHN3aXRjaCwgc2xpZGVycyBnZXQgaXQgYXV0b21hdGljYWxseSBmcm9tIHVpLWJ0bgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCX0sCgoJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkvLyByYW5nZS9udW1iZXIgaW5wdXRzIGRvZXNuJ3QgdHJpZ2dlciBhIGNoYW5nZSB1bnRpbCB0aGUgZmllbGQgaXMKCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCV9jb250cm9sVk1vdXNlVXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJfQoJfSwKCglfc2xpZGVyVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICEoIGV2ZW50LndoaWNoID09PSAxIHx8IGV2ZW50LndoaWNoID09PSAwICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCQoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgkJCQkKCQkJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSB0aGlzLnVzZXJNb2RpZmllZAoJCQkJdGhpcy51c2VyTW9kaWZpZWQgPSB0aGlzLmJlZm9yZVN0YXJ0ICE9PSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMudmFsdWUgIT09IHRoaXMuX3ZhbHVlKCkgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleCA6IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC52YWwoKSApIDsKCX0sCgoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci10cmFjayIsIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgKCB0aGlzLm9wdGlvbnMubWluaSApID8gIiB1aS1taW5pIjoiIl0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pOwoKCQl2YXIgcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2gsCgkJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLAoJCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoJCQkKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJdmFyIHBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJZGlzYWJsZWQ6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Vjb25kTGFiZWwsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9XCJ1aS1yYW5nZXNsaWRlci1zbGlkZXJzXCIgLz4iICkuYXBwZW5kVG8oICRlbCApOwoJCQkKCQkJaWYgKCAkZWwuZmluZCggImxhYmVsIiApLmxlbmd0aCA+IDEgKSB7CgkJCQlzZWNvbmRMYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkubGFzdCgpLmhpZGUoKTsKCQkJfQoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoJCQkKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJbGFiZWwucHJlcGVuZFRvKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgkJCQoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCQkJCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQgCgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl0aGlzLl9zdXBlckFwcGx5KCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgkJCQoJCQkKCQkJaWYoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICl7CgkJCQl0aGlzU2xpZGVyLmJsdXIoKTsKCQkJfSBlbHNlIGlmKCBldmVudC50eXBlID09PSAibW91c2Vkb3duIiApewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMSApOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJfQoJCQkKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQoJCQlpZiAoIG1pbiA+PSBtYXggKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfdXBkYXRlSGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1pbiA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCW1heCA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApLmZpbmQoICJsYWJlbCIgKS5zaG93KCk7CgkJCXRoaXMuX2lucHV0Rmlyc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckZpcnN0ICk7CgkJCXRoaXMuX2lucHV0TGFzdC5hZnRlciggdGhpcy5fc2xpZGVyTGFzdCApOwoJCQl0aGlzLl9zbGlkZXJzLnJlbW92ZSgpOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QgdWktcmFuZ2VzbGlkZXItbGFzdCIgKS5zbGlkZXIoICJkZXN0cm95IiApOwoJCX0KCgl9KTsKCiQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5tb2JpbGUucmFuZ2VzbGlkZXIsICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUucmFuZ2VzbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykgKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICk7Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJfSwKCglfZm9jdXNCdXR0b24gOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCX0sIDQwKTsKCX0sCgoJX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnNlbGVjdC5maW5kKCAib3B0aW9uIiApOwoJfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBjbGFzc2VzID0gIiI7CgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaW5saW5lID0gb3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG9wdGlvbnMubWluaSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAibWluaSIgKSwKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PT0gLTEgPyAwIDogdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoKCQkJLy8gVE9ETyB2YWx1ZXMgYnV0dG9uSWQgYW5kIG1lbnVJZCBhcmUgdW5kZWZpbmVkIGhlcmUKCQkJYnV0dG9uID0gdGhpcy5idXR0b24KCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuc2VsZWN0ICkKCQkJCS5idXR0b25NYXJrdXAoIHsKCQkJCQl0aGVtZTogb3B0aW9ucy50aGVtZSwKCQkJCQlpY29uOiBvcHRpb25zLmljb24sCgkJCQkJaWNvbnBvczogaWNvbnBvcywKCQkJCQlpbmxpbmU6IGlubGluZSwKCQkJCQljb3JuZXJzOiBvcHRpb25zLmNvcm5lcnMsCgkJCQkJc2hhZG93OiBvcHRpb25zLnNoYWRvdywKCQkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3csCgkJCQkJbWluaTogbWluaQoJCQkJfSk7CgoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoKCQkvLyBPcGVyYSBkb2VzIG5vdCBwcm9wZXJseSBzdXBwb3J0IG9wYWNpdHkgb24gc2VsZWN0IGVsZW1lbnRzCgkJLy8gSW4gTWluaSwgaXQgaGlkZXMgdGhlIGVsZW1lbnQsIGJ1dCBub3QgaXRzIHRleHQKCQkvLyBPbiB0aGUgZGVza3RvcCxpdCBzZWVtcyB0byBkbyB0aGUgb3Bwb3NpdGUKCQkvLyBmb3IgdGhlc2UgcmVhc29ucywgdXNpbmcgdGhlIG5hdGl2ZU1lbnUgb3B0aW9uIHJlc3VsdHMgaW4gYSBmdWxsIG5hdGl2ZSBzZWxlY3QgaW4gT3BlcmEKCQlpZiAoIG9wdGlvbnMubmF0aXZlTWVudSAmJiB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gKSB7CgkJCWJ1dHRvbi5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoJCQkKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDAgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CQkJCQoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpblNpemUsIHNlZ1NpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCQl2YXIgcmV0ID0gZGVzaXJlZDsKCgkJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJCXJldCA9IG9mZnNldCArICggd2luU2l6ZSAtIHNlZ1NpemUgKSAvIDI7CgkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCQlyZXQgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ1NpemUgLyAyICksIG9mZnNldCArIHdpblNpemUgLSBzZWdTaXplICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdzsKCgkJcmV0dXJuIHsKCQkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJCXk6ICR3aW4uc2Nyb2xsVG9wKCksCgkJCWN4OiAoIHdpbmRvdy5pbm5lcldpZHRoIHx8ICR3aW4ud2lkdGgoKSApLAoJCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgkJfTsKCX0KCgkkLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQkJc2hhZG93OiB0cnVlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCQl0b2xlcmFuY2U6IG51bGwsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgkJCWRpc21pc3NpYmxlOiB0cnVlLAoKCQkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkJLy8gICAgICBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ3ODQKCQkJLy8KCQkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCQloaXN0b3J5OiAhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRQoJCX0sCgoJCV9lYXRFdmVudEFuZENsb3NlOiBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCWlmICggcG9wdXBIZWlnaHQgPiB0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCkgKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCBlICk7CgkJCX0KCQl9LAoKCQlfZXhwZWN0UmVzaXplRXZlbnQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCQlpZiAoIHdpbkNvb3Jkcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy54ICYmCgkJCQkJd2luQ29vcmRzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnkgJiYKCQkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQkJd2luQ29vcmRzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeSApIHsKCQkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJCXRpbWVvdXRJZDogc2V0VGltZW91dCggJC5wcm94eSggdGhpcywgIl9yZXNpemVUaW1lb3V0IiApLCAyMDAgKSwKCQkJCXdpbkNvb3Jkczogd2luQ29vcmRzCgkJCX07CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQlfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgkJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJCX0KCgkJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSwKCgkJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCgkJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJCX0KCQkJdGhpcy5faWdub3JlUmVzaXplVG8gPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgc2VsZi5faWdub3JlUmVzaXplVG8gPSAwOyB9LCAxMDAwICk7CgkJfSwKCgkJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKQoJCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQkJfQoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCQl9CgkJfSwKCgkJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCQkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCQlfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHRndCA9IGUudGFyZ2V0LCAkdGd0LCB1aSA9IHRoaXMuX3VpOwoKCQkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRndCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQkkdGd0ID0gJCggZS50YXJnZXQgKTsKCQkJCWlmICggMCA9PT0gJHRndC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJHRndC5ibHVyKCk7CgkJCQkJfSk7CgkJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJCXVpLmZvY3VzRWxlbWVudCA9ICR0Z3Q7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWkgPSB7CgkJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4nPjwvZGl2PiIgKSwKCQkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuJz48L2Rpdj4iICkKCQkJCX0sCgkJCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCQlteUlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCQl0aGlzLm9wdGlvbnMuaGlzdG9yeSA9IHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkJaWYgKCB0aGlzUGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCQl0aGlzUGFnZSA9ICQoICJib2R5IiApOwoJCQl9CgoJCQkvLyBkZWZpbmUgdGhlIGNvbnRhaW5lciBmb3IgbmF2aWdhdGlvbiBldmVudCBiaW5kaW5ncwoJCQkvLyBUT0RPIHRoaXMgd291bGQgYmUgbmljZSBhdCB0aGUgdGhlIG1vYmlsZSB3aWRnZXQgbGV2ZWwKCQkJdGhpcy5vcHRpb25zLmNvbnRhaW5lciA9IHRoaXMub3B0aW9ucy5jb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQl0aGlzUGFnZS5hcHBlbmQoIHVpLnNjcmVlbiApOwoJCQl1aS5jb250YWluZXIuaW5zZXJ0QWZ0ZXIoIHVpLnNjcmVlbiApOwoJCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoaXMuZWxlbWVudCApOwoJCQlpZiAoIG15SWQgKSB7CgkJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQkJdWkucGxhY2Vob2xkZXIuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJCX0KCQkJdWkuY29udGFpbmVyLmFwcGVuZCggdGhpcy5lbGVtZW50ICk7CgkJCXVpLmZvY3VzRWxlbWVudCA9IHVpLmNvbnRhaW5lcjsKCgkJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLXBvcHVwIiApOwoKCQkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3Njcm9sbFRvcDogMCwKCQkJCV9wYWdlOiB0aGlzUGFnZSwKCQkJCV91aTogdWksCgkJCQlfZmFsbGJhY2tUcmFuc2l0aW9uOiAiIiwKCQkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlfcHJlcmVxczogbnVsbCwKCQkJCV9pc09wZW46IGZhbHNlLAoJCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQkJX2lnbm9yZVJlc2l6ZVRvOiAwLAoJCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoKCQkJdWkuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCAkLnByb3h5KCB0aGlzLCAiX2VhdEV2ZW50QW5kQ2xvc2UiICkgKTsKCgkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJCX0pOwoJCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsKCQkJCWZvY3VzaW46ICQucHJveHkoIHRoaXMsICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiApCgkJCX0pOwoJCX0sCgoJCV9hcHBseVRoZW1lOiBmdW5jdGlvbiggZHN0LCB0aGVtZSwgcHJlZml4ICkgewoJCQl2YXIgY2xhc3NlcyA9ICggZHN0LmF0dHIoICJjbGFzcyIgKSB8fCAiIikuc3BsaXQoICIgIiApLAoJCQkJYWxyZWFkeUFkZGVkID0gdHJ1ZSwKCQkJCWN1cnJlbnRUaGVtZSA9IG51bGwsCgkJCQltYXRjaGVzLAoJCQkJdGhlbWVTdHIgPSBTdHJpbmcoIHRoZW1lICk7CgoJCQl3aGlsZSAoIGNsYXNzZXMubGVuZ3RoID4gMCApIHsKCQkJCWN1cnJlbnRUaGVtZSA9IGNsYXNzZXMucG9wKCk7CgkJCQltYXRjaGVzID0gKCBuZXcgUmVnRXhwKCAiXnVpLSIgKyBwcmVmaXggKyAiLShbYS16XSkkIiApICkuZXhlYyggY3VycmVudFRoZW1lICk7CgkJCQlpZiAoIG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAxICkgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG1hdGNoZXNbIDEgXTsKCQkJCQlicmVhazsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFRoZW1lID0gbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCB0aGVtZSAhPT0gY3VycmVudFRoZW1lICkgewoJCQkJZHN0LnJlbW92ZUNsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCAhICggdGhlbWUgPT09IG51bGwgfHwgdGhlbWUgPT09ICJub25lIiApICkgewoJCQkJCWRzdC5hZGRDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyB0aGVtZVN0ciApOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgdmFsdWUsICJib2R5IiApOwoJCX0sCgoJCV9zZXRPdmVybGF5VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCB2YWx1ZSwgIm92ZXJsYXkiICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXRoaXMuX3VpLnNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfSwKCgkJX3NldFNoYWRvdzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIHZhbHVlICk7CgkJfSwKCgkJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfSwKCgkJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICYmIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfSwKCgkJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCX0KCQl9LAoKCQlfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQl2YXIgYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQkJY2FzZSAxOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJCWNhc2UgMjoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQkJY2FzZSA0OgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQlkZWZhdWx0OgoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl2YXIgZXhjbHVzaW9ucywgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJCWlmICggdGhpc1sgc2V0dGVyIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXNbIHNldHRlciBdKCB2YWx1ZSApOwoJCQl9CgoJCQkvLyBUT0RPIFJFTU9WRSBGT1IgMS4yLjEgYnkgbW92aW5nIHRoZW0gb3V0IHRvIGEgZGVmYXVsdCBvcHRpb25zIG9iamVjdAoJCQlleGNsdXNpb25zID0gWwoJCQkJImluaXRTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rU2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua0V2ZW50cyIsCgkJCQkibmF2aWdhdGVFdmVudHMiLAoJCQkJImNsb3NlRXZlbnRzIiwKCQkJCSJoaXN0b3J5IiwKCQkJCSJjb250YWluZXIiCgkJCV07CgoJCQkkLm1vYmlsZS53aWRnZXQucHJvdG90eXBlLl9zZXRPcHRpb24uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQlpZiAoICQuaW5BcnJheSgga2V5LCBleGNsdXNpb25zICkgPT09IC0xICkgewoJCQkJLy8gUmVjb3JkIHRoZSBvcHRpb24gY2hhbmdlIGluIHRoZSBvcHRpb25zIGFuZCBpbiB0aGUgRE9NIGRhdGEtKiBhdHRyaWJ1dGVzCgkJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJCX0KCQl9LAoKCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBnaXZlbiBjb29yZGluYXRlcwoJCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQl2YXIKCQkJCXdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpLAoJCQkJcmMgPSB7CgkJCQkJeDogdGhpcy5fdG9sZXJhbmNlLmwsCgkJCQkJeTogd2luQ29vcmRzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCQljeDogd2luQ29vcmRzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCQljeTogd2luQ29vcmRzLmN5IC0gdGhpcy5fdG9sZXJhbmNlLnQgLSB0aGlzLl90b2xlcmFuY2UuYgoJCQkJfSwKCQkJCW1lbnVTaXplLCByZXQ7CgoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByYy5jeCApOwoJCQltZW51U2l6ZSA9IHsKCQkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJCX07CgoJCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkJLy8gdGhlIHdpbmRvdyB0b2xlcmFuY2VzLiBUaGlzIHdpbGwgY2VudGVyIHdydC4gdGhlIHdpbmRvdyBpZiB0aGUgcG9wdXAgaXMgdG9vIGxhcmdlLgoJCQlyZXQgPSB7CgkJCQl4OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3gsIG1lbnVTaXplLmN4LCByYy54LCBkZXNpcmVkLnggKSwKCQkJCXk6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeSwgbWVudVNpemUuY3ksIHJjLnksIGRlc2lyZWQueSApCgkJCX07CgoJCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJCXJldC55ID0gTWF0aC5tYXgoIDAsIHJldC55ICk7CgoJCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJCS8vIGZpeCBmb3IgJC5tb2JpbGUuZG9jdW1lbnQuaGVpZ2h0KCkgYnVnIGluIGNvcmUgMS43LjIuCgkJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCQlkb2NIZWlnaHQgPSBNYXRoLm1heCggZG9jRWwuY2xpZW50SGVpZ2h0LCBkb2NCb2R5LnNjcm9sbEhlaWdodCwgZG9jQm9keS5vZmZzZXRIZWlnaHQsIGRvY0VsLnNjcm9sbEhlaWdodCwgZG9jRWwub2Zmc2V0SGVpZ2h0ICk7CgoJCQlyZXQueSAtPSBNYXRoLm1pbiggcmV0LnksIE1hdGgubWF4KCAwLCByZXQueSArIG1lbnVTaXplLmN5IC0gZG9jSGVpZ2h0ICkgKTsKCgkJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07CgkJfSwKCgkJX2NyZWF0ZVByZXJlcXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXEsIGNvbnRhaW5lclByZXJlcSwgd2hlbkRvbmUgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIGFuZCBzZWxmLl9wcmVyZXFzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbgoJCQkvLyB0aGUgY2xvc3VyZSBvZiB0aGUgZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlIGxvY2FsIHZhcmlhYmxlIGFuZAoJCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJCS8vIG5leHQgdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQgdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaAoJCQkvLyAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMgZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdCBjYWxsZWQgZm9yCgkJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJCS8vIC0gbWFraW5nIGl0IHN0YWxlLiBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZSBzZWxmLl9wcmVyZXFzIGVuc3VyZXMgdGhhdAoJCQkvLyBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUgLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJCXByZXJlcXMgPSB7CgkJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJCX07CgoJCQlwcmVyZXFzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQljb250YWluZXJQcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQkkLndoZW4oIHByZXJlcXMuc2NyZWVuLCBwcmVyZXFzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNlbGYuX3ByZXJlcXMgPSBudWxsOwoJCQkJCXdoZW5Eb25lKCk7CgkJCQl9CgkJCX0pOwoKCQkJc2VsZi5fcHJlcmVxcyA9IHByZXJlcXM7CgkJfSwKCgkJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQkJfQoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXFzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKQoJCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCWFyZ3MucHJlcmVxcy5jb250YWluZXIucmVzb2x2ZSgpOwoJCX0sCgoJCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCQkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJCS8vIG9wdGlvbnM6IHsgeDogY29vcmRpbmF0ZSwgeTogY29vcmRpbmF0ZSwgcG9zaXRpb25Ubzogc3RyaW5nOiAib3JpZ2luIiwgIndpbmRvdyIsIG9yIGpRdWVyeSBzZWxlY3RvcgoJCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggbyApIHsKCQkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksIHggPSBvLngsIHkgPSBvLnksIHBUbyA9IG8ucG9zaXRpb25UbzsKCgkJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJCX0gZWxzZSB7CgkJCQkJdHJ5IHsKCQkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQkJaWYgKCBkc3QgKSB7CgkJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQkJaWYgKCBkc3QubGVuZ3RoID09PSAwICkgewoJCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gSWYgYW4gZWxlbWVudCB3YXMgZm91bmQsIGNlbnRlciBvdmVyIGl0CgkJCWlmICggZHN0ICkgewoJCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQkJeCA9IG9mZnNldC5sZWZ0ICsgZHN0Lm91dGVyV2lkdGgoKSAvIDI7CgkJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHggYW5kIHkgYXJlIHZhbGlkIG51bWJlcnMgLSBjZW50ZXIgb3ZlciB0aGUgd2luZG93CgkJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQl9CgkJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCQl5ID0gd2luQ29vcmRzLmN5IC8gMiArIHdpbkNvb3Jkcy55OwoJCQl9CgoJCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07CgkJfSwKCgkJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvICkgewoJCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJCW8gPSB7IHg6IG8ueCwgeTogby55LCBwb3NpdGlvblRvOiBvLnBvc2l0aW9uVG8gfTsKCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiwgbyApOwoJCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG8gKSApICk7CgkJfSwKCgkJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fcmVwb3NpdGlvbiggbyApOwoJCQl9CgkJfSwKCgkJX29wZW5QcmVyZXFzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCXRoaXMuX3RyaWdnZXIoICJhZnRlcm9wZW4iICk7CgkJfSwKCgkJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgbyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJCWlmKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9KCkpOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLm5vb3AsCgkJCQkkLm5vb3AsCgkJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXFzQ29tcGxldGUiICkgKTsKCgkJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gby50cmFuc2l0aW9uOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG8udHJhbnNpdGlvbiApOwoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIHRoaXMuX3BhZ2UuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLl9wYWdlLCAiYyIgKSApOwoJCQl9CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQkJdGhpcy5fcmVwb3NpdGlvbiggbyApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCQkvKiBUT0RPOgoJCQkJVGhlIG5hdGl2ZSBicm93c2VyIG9uIEFuZHJvaWQgNC4wLlggKCJJY2UgQ3JlYW0gU2FuZHdpY2giKSBzdWZmZXJzIGZyb20gYW4gaXNzdWUgd2hlcmUgdGhlIHBvcHVwIG92ZXJsYXkgYXBwZWFycyB0byBiZSB6LWluZGV4ZWQKCQkJCWFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluCgkJCQl0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9zY290dGplaGwvRGV2aWNlLUJ1Z3MvaXNzdWVzLzMKCgkJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODc0CgkJCQkqLwoKCQkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgkJCX0KCQkJdGhpcy5fYW5pbWF0ZSh7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0cnVlLAoJCQkJdHJhbnNpdGlvbjogby50cmFuc2l0aW9uLAoJCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9jbG9zZVByZXJlcVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKQoJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFzRG9uZTogZnVuY3Rpb24oKSB7CgkJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJCX0sCgoJCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCgkJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyByZXZlcnNlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxU2NyZWVuIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcUNvbnRhaW5lciIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFzRG9uZSIgKSApOwoKCQkJdGhpcy5fYW5pbWF0ZSggewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCQl0aGlzLl9zZXRUaGVtZSggIm5vbmUiICk7CgkJCXRoaXMuZWxlbWVudAoJCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkJLy8gdG8gdGhlIERPTSBhdCB0aGUgdGltZSB0aGUgd2lkZ2V0IHdhcyBjcmVhdGVkLCBhbmQgc28gdGhlIHBheWxvYWQKCQkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJCS8vIHdpbGwgY2F1c2UgYW4gaW5maW5pdGUgcmVjdXJzaW9uIC0gIzUyNDQKCQkJCS5kZXRhY2goKQoJCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIiApOwoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJCX0KCQl9LAoKCQlfY2xvc2VQb3B1cDogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciBwYXJzZWREc3QsIHRvVXJsLCBvID0gdGhpcy5vcHRpb25zLCBpbW1lZGlhdGUgPSBmYWxzZTsKCgkJCS8vIHJlc3RvcmUgbG9jYXRpb24gb24gc2NyZWVuCgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCQlpZiAoIGUgJiYgZS50eXBlID09PSAicGFnZWJlZm9yZWNoYW5nZSIgJiYgZGF0YSApIHsKCQkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQkJaWYgKCB0eXBlb2YgZGF0YS50b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQkJfSBlbHNlIHsKCQkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJfQoJCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCQl0b1VybCA9IHBhcnNlZERzdC5wYXRobmFtZSArIHBhcnNlZERzdC5zZWFyY2ggKyBwYXJzZWREc3QuaGFzaDsKCgkJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQkJby5jb250YWluZXIudW5iaW5kKCBvLmNsb3NlRXZlbnRzICk7CgkJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIG8uY2xvc2VMaW5rU2VsZWN0b3IsIG8uY2xvc2VMaW5rRXZlbnRzICk7CgoJCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7CgkJfSwKCgkJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJCS8vICAgICAgYWx0ZXIgdGhlIHVybCAoZWcsIGRpYWxvZ3MgZnJvbSBwb3B1cHMpCgkJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIKCQkJCS5vbmUoIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7CgkJfSwKCgkJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIG9wdHMgPSB0aGlzLm9wdGlvbnMsIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5OwoKCQkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJCWlmKCAhKCBvcHRzLmhpc3RvcnkgKSApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCQlzZWxmLmVsZW1lbnQKCQkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSk7CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS51cmxIaXN0b3J5OwoJCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJCWN1cnJlbnRJc0RpYWxvZyA9IGFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApOwoJCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJCWlmICggaGFzSGFzaCApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKXsKCQkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQkJfSBlbHNlIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCQl9CgoJCQkvLyBUYWNrIG9uIGFuIGV4dHJhIGhhc2hrZXkgaWYgdGhpcyBpcyB0aGUgZmlyc3QgcGFnZSBhbmQgd2UndmUganVzdCByZWNvbnN0cnVjdGVkIHRoZSBpbml0aWFsIGhhc2gKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGhhc2hrZXk7CgkJCX0KCgkJCS8vIHN3YWxsb3cgdGhlIHRoZSBpbml0aWFsIG5hdmlnYXRpb24gZXZlbnQsIGFuZCBiaW5kIGZvciB0aGUgbmV4dAoJCQkkKHdpbmRvdykub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQl9KTsKCgkJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHtyb2xlOiAiZGlhbG9nIn0gKTsKCQl9LAoKCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX3Njcm9sbFRvcCA9ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCWlmKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJCX0KCQl9Cgl9KTsKCgoJLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAoJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCQl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlzY29wZSA9ICggKCBjbG9zZXN0UGFnZS5sZW5ndGggPT09IDAgKSA/ICQoICJib2R5IiApIDogY2xvc2VzdFBhZ2UgKSwKCQkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkJLy8gICAgICBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQkJcG9wdXAgPSAkKCAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCRsaW5rLmF0dHIoICJocmVmIiApKS5oYXNoLCBzY29wZVswXSApLAoJCQlvZmZzZXQ7CgoJCWlmICggcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJCX0pOwoJCX0KCgkJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJLy8gQ2hlY2sgaWYgd2UgYXJlIGluIGEgbGlzdHZpZXcKCQkJdmFyICRwYXJlbnQgPSAkbGluay5wYXJlbnQoKS5wYXJlbnQoKTsKCQkJaWYgKCRwYXJlbnQuaGFzQ2xhc3MoInVpLWxpIikpIHsKCQkJCSRsaW5rID0gJHBhcmVudC5wYXJlbnQoKTsKCQkJfQoJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9LCAzMDAgKTsKCX07CgoJLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsoIGRhdGEub3B0aW9ucy5saW5rICk7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9KTsKCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKSB7CgoJCXZhciBzZWxlY3QgPSB3aWRnZXQuc2VsZWN0LAoJCQlvcmlnRGVzdHJveSA9IHdpZGdldC5fZGVzdHJveSwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlwcmVmaXggPSAoIHNlbGVjdElEID8gc2VsZWN0SUQgOiAoICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ1dWlkLSIgKyB3aWRnZXQudXVpZCApICksCgkJCXBvcHVwSUQgPSBwcmVmaXggKyAiLWxpc3Rib3giLAoJCQlkaWFsb2dJRCA9IHByZWZpeCArICItZGlhbG9nIiwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBpZD0nIiArIGRpYWxvZ0lEICsgIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJ0aGVtZT0nIisgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKyInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAib3ZlcmxheS10aGVtZT0nIisgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsiJz4iICsKCQkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyBsYWJlbC5nZXRFbmNvZGVkVGV4dCgpICsgIjwvZGl2PiIrCgkJCQkiPC9kaXY+IisKCQkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCQkiPC9kaXY+IiApLAoKCQkJbGlzdGJveCA9ICAkKCAiPGRpdiBpZD0nIiArIHBvcHVwSUQgKyAiJyBjbGFzcz0ndWktc2VsZWN0bWVudSc+IiApLmluc2VydEFmdGVyKCB3aWRnZXQuc2VsZWN0ICkucG9wdXAoIHsgdGhlbWU6IHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSB9ICksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMuZGl2aWRlclRoZW1lICkKCQkJCQkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiAoIHdpZGdldC5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKTsKCQl9CgoJCSQuZXh0ZW5kKCB3aWRnZXQsIHsKCQkJc2VsZWN0OiB3aWRnZXQuc2VsZWN0LAoJCQlzZWxlY3RJRDogc2VsZWN0SUQsCgkJCWJ1dHRvbklkOiBidXR0b25JZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSUQ6IHBvcHVwSUQsCgkJCWRpYWxvZ0lEOiBkaWFsb2dJRCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJaWYgKCBzZWxmLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkJCS8vIG5vbmUgcHJlc2VudC4KCQkJCQlzZWxmLl9vcmlnVGFiSW5kZXggPSAoIHNlbGYuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgfHwgc2VsZi5pc09wZW4gKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fAoJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCQkJCXNlbGYuX2RlY2lkZUZvcm1hdCgpOwoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgc2VsZi5wb3B1cElEICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAicG9wdXAiICk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlzZWxmLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHNlbGYuZGlhbG9nSUQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJkaWFsb2ciICk7CgkJCQkJCX0KCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCQkvLyBEbyBub3QgcHJldmVudCBkZWZhdWx0LCBzbyB0aGUgbmF2aWdhdGlvbiBtYXkgaGF2ZSBhIGNoYW5jZSB0byBhY3R1YWxseSBvcGVuIHRoZSBjaG9zZW4gZm9ybWF0CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCgkJCQkJfSkKCQkJCQkuYmluZCggImZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDM4OgoJCQkJCQkJcHJldiA9IGxpLnByZXYoKS5ub3QoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCgkJCQkJCQlpZiAoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJaWYgKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCWNhc2UgMTM6CgkJCQkJCWNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCQkJc2VsZi5saXN0Ym94LmJpbmQoICJwb3B1cGFmdGVyY2xvc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCWluZGljaWVzOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmICggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCQkJc2VsZi5tZW51UGFnZS5kaWFsb2coICJjbG9zZSIgKTsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLmxpc3Rib3gucG9wdXAoICJjbG9zZSIgKTsKCQkJCX0KCgkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCQkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQkJCXNlbGYuaXNPcGVuID0gZmFsc2U7CgkJCX0sCgoJCQlvcGVuOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuYnV0dG9uLmNsaWNrKCk7CgkJCX0sCgoJCQlfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCQkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQlmdW5jdGlvbiBmb2N1c01lbnVJdGVtKCkgewoJCQkJCXZhciBzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgYSIgKTsKCQkJCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggImxpLnVpLWJ0bjpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlCgkJCQkJCS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJZm9jdXNNZW51SXRlbSgpOwoJCQkJCQl9KQoJCQkJCQkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCQkJc2VsZi5saXN0Ym94Lm9uZSggInBvcHVwYWZ0ZXJvcGVuIiwgZm9jdXNNZW51SXRlbSApOwoJCQkJfQoJCQl9LAoKCQkJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJCQlvcHRncm91cHMgPSBbXSwKCQkJCQlsaXMgPSBbXSwKCQkJCQlkYXRhSWNvbiA9IHNlbGYuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIjsKCgkJCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoKCQkJCXZhciAkb3B0aW9ucyA9IHNlbGYuc2VsZWN0LmZpbmQoICJvcHRpb24iICksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAncGxhY2Vob2xkZXInLAoJCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQkJCXZhciBvcHRpb24gPSAkb3B0aW9uc1tpXSwKCQkJCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2EnICksCgkJCQkJCWNsYXNzZXMgPSBbXTsKCgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ2hyZWYnLCAnIycgKTsKCQkJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAoIHBhcmVudCAhPT0gc2VsZWN0ICYmIHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAib3B0Z3JvdXAiICkgewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCAnbGFiZWwnICk7CgkJCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAnbGlzdC1kaXZpZGVyJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdmlkZXIgKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSB0cnVlOwoKCQkJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJCQkvLyByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQkJCX0KCQkJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0cixpICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCX0KCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQkJCX0KCgkJCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggIjxhPiIsIHsKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJCX0pOwoJCQl9LAoKCQkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5jbG9zZSgpOwoKCQkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IGZhbHNlICkgewoJCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnNlbGVjdC5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFJlbW92ZSB0aGUgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGlmIHdlIHdlcmUgdGhlIG9uZXMgdG8gYWRkIGl0CgkJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCQkvLyBDaGFpbiB1cAoJCQkJb3JpZ0Rlc3Ryb3kuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgkJfSk7Cgl9OwoKCS8vIGlzc3VlICMzODk0IC0gY29yZSBkb2Vzbid0IHRyaWdnZXIgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHNlbGVjdG1lbnVXaWRnZXQgPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAibW9iaWxlLXNlbGVjdG1lbnUiICk7CgoJCWlmICggIXNlbGVjdG1lbnVXaWRnZXQub3B0aW9ucy5uYXRpdmVNZW51ICYmCgkJCQlzZWxlY3RtZW51V2lkZ2V0LmVsZW1lbnQucGFyZW50cyggIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiICkubGVuZ3RoID09PSAwICkgewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJCW9wdGlvbnM6IHsKCQkJc2hhZG93OiBmYWxzZSwKCQkJY29ybmVyczogdHJ1ZSwKCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJdHlwZTogInZlcnRpY2FsIiwKCQkJbWluaTogZmFsc2UsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJdWkgPSB7CgkJCQkJaW5uZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtY29udHJvbHMnPjwvZGl2PiIgKSwKCQkJCQlsZWdlbmQ6ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJfSwKCQkJCWdyb3VwbGVnZW5kID0gJGVsLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJJGVsLndyYXBJbm5lciggdWkuaW5uZXIgKTsKCQkJaWYgKCBncm91cGxlZ2VuZC5sZW5ndGggKSB7CgkJCQl1aS5sZWdlbmQuYXBwZW5kKCBncm91cGxlZ2VuZCApLmluc2VydEJlZm9yZSggJGVsLmNoaWxkcmVuKCAwICkgKTsKCQkJfQoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCIgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoJCX0sCgoJCV9pbml0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0VHlwZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyB2YWx1ZSApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfSwKCgkJY29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciBlbHMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCQljcmVhdGUgPSB0aGlzLl9pbml0aWFsUmVmcmVzaDsKCQkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJCX0KCQkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLCB0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLCBjcmVhdGUgKTsKCQkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCQl9Cgl9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgoJLy8gVE9ETzogSW1wbGVtZW50IGEgbWVjaGFuaXNtIHRvIGFsbG93IHdpZGdldHMgdG8gYmVjb21lIGVuaGFuY2VkIGluIHRoZQoJLy8gY29ycmVjdCBvcmRlciB3aGVuIHRoZWlyIGNvcnJlY3QgZW5oYW5jZW1lbnQgZGVwZW5kcyBvbiBvdGhlciB3aWRnZXRzIGluCgkvLyB0aGUgcGFnZSBiZWluZyBjb3JyZWN0bHkgZW5oYW5jZWQgYWxyZWFkeS4KCS8vCgkvLyBGb3Igbm93LCB3ZSB3YWl0IHVudGlsIGRvbS1yZWFkeSB0byBhdHRhY2ggdGhlIGNvbnRyb2xncm91cCdzIGVuaGFuY2VtZW50CgkvLyBob29rLCBiZWNhdXNlIGJ5IHRoYXQgdGltZSwgYWxsIHRoZSBvdGhlciB3aWRnZXRzJyBlbmhhbmNlbWVudCBob29rcyBzaG91bGQKCS8vIGFscmVhZHkgYmUgaW4gcGxhY2UsIGVuc3VyaW5nIHRoYXQgYWxsIHdpZGdldHMgdGhhdCBuZWVkIHRvIGJlIGdyb3VwZWQgd2lsbAoJLy8gYWxyZWFkeSBoYXZlIGJlZW4gZW5oYW5jZWQgYnkgdGhlIHRpbWUgdGhlIGNvbnRyb2xncm91cCBpcyBjcmVhdGVkLgoJJCggZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCQkkLm1vYmlsZS5jb250cm9sZ3JvdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7CgkJfSk7Cgl9KTsKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIGUudGFyZ2V0ICkKCQkuZmluZCggImEiICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLXBvcHVwLCAudWktcGFuZWwsIC51aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISQuc3VwcG9ydC5maXhlZFBvc2l0aW9uOwoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQkkcGFnZSA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgoJCQkvLyBGZWF0dXJlIGRldGVjdGluZyBzdXBwb3J0IGZvcgoJCQlpZiAoIG8uc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJc2VsZi5kZXN0cm95KCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1maXhlZCIgKTsKCgkJCS8vICJmdWxsc2NyZWVuIiBvdmVybGF5IHBvc2l0aW9uaW5nCgkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZnVsbHNjcmVlbiIgKTsKCQkJfQoJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQllbHNlewoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZpeGVkIiApOwoJCQl9CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3RoaXNQYWdlOiBudWxsCgkJCX0pOwogCgkJCXNlbGYuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoJCQlzZWxmLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkvL3BhZ2UgZXZlbnQgYmluZGluZ3MKCQkJLy8gRml4ZWQgdG9vbGJhcnMgcmVxdWlyZSBwYWdlIHpvb20gdG8gYmUgZGlzYWJsZWQsIG90aGVyd2lzZSB1c2FiaWxpdHkgaXNzdWVzIGNyb3AgdXAKCQkJLy8gVGhpcyBtZXRob2QgaXMgbWVhbnQgdG8gZGlzYWJsZSB6b29tIHdoaWxlIGEgZml4ZWQtcG9zaXRpb25lZCB0b29sYmFyIHBhZ2UgaXMgdmlzaWJsZQoJCQl0aGlzLl9vbiggdGhpcy5fdGhpc1BhZ2UsIHsKCQkJCSJwYWdlYmVmb3Jlc2hvdyI6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQkJIndlYmtpdEFuaW1hdGlvblN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJhbmltYXRpb25zdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVBhZ2VTaG93IiwKCQkJCSJwYWdlYmVmb3JlaGlkZSI6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJCX0pOwoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzLl90aGlzUGFnZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggJC5tb2JpbGUud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQl0aGlzSGVhZGVyID0gJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLl90aGlzUGFnZSApLAoJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKSwKCQkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgoJCQkJaWYgKCBuZXh0Rm9vdGVyLmxlbmd0aCB8fCBuZXh0SGVhZGVyLmxlbmd0aCApIHsKCgkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQluZXh0SGVhZGVyLnByZXBlbmRUbyggdGhpcyApOwoJCQkJCQluZXh0Rm9vdGVyLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApLAoJCQkJcG9zID0gcGFyc2VGbG9hdCggJGVsLmNzcyggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoKCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLiAKCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLl90aGlzUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciI7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0YnR5cGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0YnR5cGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoJ2luJyk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoIAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtIAoJCQkJCQkvL2NvbnRyb2xzIGNhdXNlcyBmaXhlZCBwb3NpdGlvbiwgdGFwLXRvZ2dsZSBmYWxzZSBIZWFkZXIgdG8gcmV2ZWFsIGl0c2VsZgoJCQkJCQkvLyBpc1Zpc2libGUgaW5zdGVhZCBvZiBzZWxmLl92aXNpYmxlIGJlY2F1c2UgdGhlIGZvY3VzaW4gYW5kIGZvY3Vzb3V0IGV2ZW50cyBmaXJlIHR3aWNlIGF0IHRoZSBzYW1lIHRpbWUKCQkJCQkJLy8gQWxzbyB1c2UgYSBkZWxheSBmb3IgaGlkaW5nIHRoZSB0b29sYmFycyBiZWNhdXNlIG9uIEFuZHJvaWQgbmF0aXZlIGJyb3dzZXIgZm9jdXNpbiBpcyBkaXJlY2x0eSBmb2xsb3dlZAoJCQkJCQkvLyBieSBhIGZvY3Vzb3V0IHdoZW4gYSBuYXRpdmUgc2VsZWN0cyBvcGVucyBhbmQgdGhlIG90aGVyIHdheSBhcm91bmQgd2hlbiBpdCBjbG9zZXMuCgkJCQkJCWlmICggZS50eXBlID09PSAiZm9jdXNvdXQiICYmICFpc1Zpc2libGUgKSB7CgkJCQkJCQlpc1Zpc2libGUgPSB0cnVlOwoJCQkJCQkJLy93YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGFuZCBzZWUgaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dAoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheUhpZGUgKTsKCQkJCQkJCWRlbGF5U2hvdyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuc2hvdygpOwoJCQkJCQkJfSwgMCApOyAKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOyAKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAiIiApOwoJCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1oZWFkZXItZml4ZWQgdWktZm9vdGVyLWZpeGVkIHVpLWhlYWRlci1mdWxsc2NyZWVuIHVpLWZvb3Rlci1mdWxsc2NyZWVuIGluIG91dCBmYWRlIHNsaWRlZG93biBzbGlkZXVwIHVpLWZpeGVkLWhpZGRlbiIgKTsKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtaGVhZGVyLWZpeGVkIHVpLXBhZ2UtZm9vdGVyLWZpeGVkIHVpLXBhZ2UtaGVhZGVyLWZ1bGxzY3JlZW4gdWktcGFnZS1mb290ZXItZnVsbHNjcmVlbiIgKTsKCQl9CgoJfSk7CgoJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCgkkLm1vYmlsZS5kb2N1bWVudAoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCS8vIERFUFJFQ0FURUQgaW4gMS4xOiBzdXBwb3J0IGZvciBkYXRhLWZ1bGxzY3JlZW49dHJ1ZXxmYWxzZSBvbiB0aGUgcGFnZSBlbGVtZW50LgoJCQkvLyBUaGlzIGxpbmUgZW5zdXJlcyBpdCBzdGlsbCB3b3JrcywgYnV0IHdlIHJlY29tbWVuZCBtb3ZpbmcgdGhlIGF0dHJpYnV0ZSB0byB0aGUgdG9vbGJhcnMgdGhlbXNlbHZlcy4KCQkJaWYgKCAkKCBlLnRhcmdldCApLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS5maXhlZHRvb2xiYXIsIHsKCgkJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fc3VwZXIoKTsKCQkJCXRoaXMuX3dvcmthcm91bmRzKCk7CgkJCX0sCgoJCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJCV93b3JrYXJvdW5kczogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCW9zID0gbnVsbCwKCQkJCXNlbGYgPSB0aGlzOwoJCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJCWlmKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApewoJCQkJCW9zID0gImlvcyI7CgkJCQl9IGVsc2UgaWYoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKXsKCQkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy9jaGVjayBvcyB2ZXJzaW9uIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJCWlmKCBvcyA9PT0gImlvcyIgKSB7CgkJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCX0gZWxzZSBpZiggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJCS8vQW5kcm9pZCAyLjMgcnVuIGFsbCBBbmRyb2lkIDIuMyB3b3JrYXJvdW5kCgkJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0sCgoJCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApLAoJCQkJCW9mZnNldCA9IE1hdGguYWJzKCRlbC5vZmZzZXQoKS50b3AgLSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkpOwoJCQkJaWYoICFoZWFkZXIgKSB7CgkJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZChvZmZzZXQgLSAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCkgKyAkZWwub3V0ZXJIZWlnaHQoKSktNjA7CgkJCQl9CgkJCQlyZXR1cm4gb2Zmc2V0OwoJCQl9LAoKCQkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbiAKCQkJX2JpbmRTY3JvbGxXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCS8vYmluZCB0byBzY3JvbGxzdG9wIGFuZCBjaGVjayBpZiB0aGUgdG9vbGJhcnMgYXJlIGNvcnJlY3RseSBwb3NpdGlvbmVkCgkJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkJLy9jaGVjayBpZiB0aGUgaGVhZGVyIGlzIHZpc2libGUgYW5kIGlmIGl0cyBpbiB0aGUgcmlnaHQgcGxhY2UKCQkJCQlpZiggdmlld3BvcnRPZmZzZXQgPiAyICYmIHNlbGYuX3Zpc2libGUpIHsKCQkJCQkJc2VsZi5fdHJpZ2dlclJlZHJhdygpOwoJCQkJCX0KCQkJCX19KTsKCQkJfSwKCgkJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCQkvL3RoZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgdGh1bWJuYWlsIGluIGEgbGlzdCB2aWV3IGNhdXNlcyBwcm9ibGVtcyB3aXRoIGZpeGVkIHBvc2l0aW9uIGJ1dHRvbnMgYWJvdmUgaW4gYSBuYXYgYmFyCgkJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCQlfYmluZExpc3RUaHVtYldvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoIi51aS1wYWdlIikuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCQl9LAoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCQkvL3RoaXMgYWxzbyBhZGRyZXNzZXMgbm90IG9uIGZpeGVkIHRvb2xiYXJzIHBhZ2UgaW4gZG9jcwoJCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KSAKCQkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyJweCIgKTsKCQkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQkJfSwgMCApOwoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLnggCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCgiLnVpLXBhZ2UtYWN0aXZlIikucmVtb3ZlQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeCIgKTsKCQkJfQoJfSk7CgoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJcGFuZWw6ICJ1aS1wYW5lbCIsCgkJCXBhbmVsT3BlbjogInVpLXBhbmVsLW9wZW4iLAoJCQlwYW5lbENsb3NlZDogInVpLXBhbmVsLWNsb3NlZCIsCgkJCXBhbmVsRml4ZWQ6ICJ1aS1wYW5lbC1maXhlZCIsCgkJCXBhbmVsSW5uZXI6ICJ1aS1wYW5lbC1pbm5lciIsCgkJCW1vZGFsOiAidWktcGFuZWwtZGlzbWlzcyIsCgkJCW1vZGFsT3BlbjogInVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCXBhZ2VQYW5lbDogInVpLXBhZ2UtcGFuZWwiLAoJCQlwYWdlUGFuZWxPcGVuOiAidWktcGFnZS1wYW5lbC1vcGVuIiwKCQkJY29udGVudFdyYXA6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAiLAoJCQljb250ZW50V3JhcE9wZW46ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtb3BlbiIsCgkJCWNvbnRlbnRXcmFwQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC13cmFwLWNsb3NlZCIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXI6ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXIiLAoJCQljb250ZW50Rml4ZWRUb29sYmFyT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhci1vcGVuIiwKCQkJY29udGVudEZpeGVkVG9vbGJhckNsb3NlZDogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhci1jbG9zZWQiLAoJCQlhbmltYXRlOiAidWktcGFuZWwtYW5pbWF0ZSIKCQl9LAoJCWFuaW1hdGU6IHRydWUsCgkJdGhlbWU6ICJjIiwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncGFuZWwnKSIsCgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQlwYWdlID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCV9nZXRQYWdlVGhlbWUgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhlbWUgPSAkLmRhdGEoIHBhZ2VbMF0sICJtb2JpbGVQYWdlIiApLm9wdGlvbnMudGhlbWUsCgkJCQkkcGFnZVRoZW1lQ2xhc3MgPSAidWktYm9keS0iICsgJHRoZW1lOwoJCQkJcmV0dXJuICRwYWdlVGhlbWVDbGFzczsKCQkJfSwKCQkJX2dldFBhbmVsSW5uZXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkcGFuZWxJbm5lciA9ICRlbC5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgkJCQlpZiAoICRwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkcGFuZWxJbm5lciA9ICRlbC5jaGlsZHJlbigpLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICciIC8+JyApLnBhcmVudCgpOwoJCQkJfQoJCQkJcmV0dXJuICRwYW5lbElubmVyOwoJCQl9LAoJCQlfZ2V0V3JhcHBlciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR3cmFwcGVyID0gcGFnZS5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcCApOwoJCQkJaWYgKCAkd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJHdyYXBwZXIgPSBwYWdlLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpLCAudWktY29udGVudDpub3QoOmpxbURhdGEocm9sZT0ncG9wdXAnKSksIC51aS1mb290ZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSIgKS53cmFwQWxsKCAnPGRpdiBjbGFzcz0iJyArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICsgJyAnICsgX2dldFBhZ2VUaGVtZSgpICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJHdyYXBwZXIuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gJHdyYXBwZXI7CgkJCX0sCgkJCV9nZXRGaXhlZFRvb2xiYXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkZml4ZWRUb29sYmFyID0gcGFnZS5maW5kKCAiLiIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQlpZiAoICRmaXhlZFRvb2xiYXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCQkJCSRmaXhlZFRvb2xiYXIuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gJGZpeGVkVG9vbGJhcjsKCQkJfTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3BhbmVsSUQ6ICRlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6ICRlbC5maW5kKCAiOmpxbURhdGEocmVsPSdjbG9zZScpIiApLAoJCQlfcGFnZTogJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCV9wYWdlVGhlbWU6IF9nZXRQYWdlVGhlbWUoKSwKCQkJX3BhbmVsSW5uZXI6IF9nZXRQYW5lbElubmVyKCksCgkJCV93cmFwcGVyOiBfZ2V0V3JhcHBlcigpLAoJCQlfZml4ZWRUb29sYmFyOiBfZ2V0Rml4ZWRUb29sYmFyKCkKCQl9KTsKCQkKCQlzZWxmLl9hZGRQYW5lbENsYXNzZXMoKTsKCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCXNlbGYuX2ZpeGVkVG9vbGJhci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCS8vIGFkZCBjbGFzcyB0byBwYWdlIHNvIHdlIGNhbiBzZXQgIm92ZXJmbG93LXg6IGhpZGRlbjsiIGZvciBpdCB0byBmaXggQW5kcm9pZCB6b29tIGlzc3VlCgkJc2VsZi5fcGFnZS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMucGFnZVBhbmVsICk7CgkJCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoJCQoJCXNlbGYuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQlzZWxmLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQlzZWxmLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISFzZWxmLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXNlbGYuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQlzZWxmLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2NyZWF0ZU1vZGFsOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0aGlzLl9wYWdlICk7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5fY2xvc2VMaW5rLm9uKCAiY2xpY2sucGFuZWwiICwgZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSk7CgkJc2VsZi5lbGVtZW50Lm9uKCAiY2xpY2sucGFuZWwiICwgImE6anFtRGF0YShhamF4PSdmYWxzZScpIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsJCQoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlzZWxmLl9zY3JvbGxJbnRvVmlldyggcGFuZWxJbm5lckhlaWdodCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfc2Nyb2xsSW50b1ZpZXc6IGZ1bmN0aW9uKCBwYW5lbElubmVySGVpZ2h0ICkgewoJCWlmICggcGFuZWxJbm5lckhlaWdodCA8ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDAgKTsKCQl9CQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCQoJX2JpbmRVcGRhdGVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9wYWdlLm9uKCAiY2xpY2sucGFuZWwiICwgImEiLCBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHNlbGYuX3BhbmVsSUQgJiYgc2VsZi5fcGFuZWxJRCAhPT0gdW5kZWZpbmVkICkgewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApOwoJCQkJaWYgKCAhICRsaW5rLmhhc0NsYXNzKCAidWktbGluayIgKSApIHsKCQkJCQkkbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQlzZWxmLmVsZW1lbnQub25lKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJfSk7CgkJCQl9CgkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7Cgl9LAoJCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgkJCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQoJCXNlbGYuX3BhZ2UKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gY2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJCS5vbiggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkvLyBvbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJfSwKCgkvLyBzdGF0ZSBzdG9yYWdlIG9mIG9wZW4gb3IgY2xvc2VkCglfb3BlbjogZmFsc2UsCgoJX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXM6IG51bGwsCglfZml4ZWRUb29sYmFyT3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fcGFnZS5vZmYoICJwYW5lbGNsb3NlIiApOwoJCQkJCXNlbGYuX3BhZ2UuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgkJCQkJCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoJCQkJCQoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UKCQkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZVRoZW1lICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgkJCQkJCgkJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQkJCQoJCQkJCS8vIEZpeCBmb3IgSUU3IG1pbi1oZWlnaHQgYnVnCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlci5jc3MoICJtaW4taGVpZ2h0Iiwgc2VsZi5fcGFnZS5jc3MoICJtaW4taGVpZ2h0IiApICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJCQkJCgkJCQkJc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMubW9kYWwgKSArICIgIiArIG8uY2xhc3Nlcy5tb2RhbE9wZW47CgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoKCQkJCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCQoJCQkJCXNlbGYuX3RyaWdnZXIoICJvcGVuIiApOwoJCQkJfTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJCgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVvcGVuIiApOwoJCQkKCQkJaWYgKCBzZWxmLl9wYWdlLmpxbURhdGEoJ3BhbmVsJykgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuX3BhZ2Uub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCQkJCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXNlbGYgPSB0aGlzLAoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJCQkKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbC5yZW1vdmVDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKS5hZGRDbGFzcyggc2VsZi5fcGFnZVRoZW1lICk7CgkJCQkJCS8vIHJlc2V0IGZpeCBmb3IgSUU3IG1pbi1oZWlnaHQgYnVnCgkJCQkJCXNlbGYuX3dyYXBwZXIuY3NzKCAibWluLWhlaWdodCIsICIiICk7CgkJCQkJfQoJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCQkJCQkKCQkJCQlzZWxmLl93cmFwcGVyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCQkJCgkJCQkJc2VsZi5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoJCQkJfTsKCQkJCQoJCQlpZiAoIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLmxlbmd0aCA8IDAgKSB7CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9CgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVjbG9zZSIgKTsKCgkJCV9jbG9zZVBhbmVsKCk7CgoJCQlzZWxmLl9vcGVuID0gZmFsc2U7CgkJfQoJfSwKCQoJdG9nZ2xlOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBjbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMsCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQloYXNPdGhlclNpYmxpbmdQYW5lbHMgPSB0aGlzLmVsZW1lbnQuc2libGluZ3MoICIuIiArIGNsYXNzZXMucGFuZWwgKS5sZW5ndGg7CgoJCS8vIGNyZWF0ZQoJCWlmICggIWhhc090aGVyU2libGluZ1BhbmVscyApIHsKCQkJdGhpcy5fd3JhcHBlci5jaGlsZHJlbigpLnVud3JhcCgpOwoJCQl0aGlzLl9wYWdlLmZpbmQoICJhIiApLnVuYmluZCggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbCApOwoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJaWYgKCB0aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhlbWUgKS5hZGRDbGFzcyggdGhpcy5fcGFnZVRoZW1lICk7CgkJCQl9CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0gZWxzZSBpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCXRoaXMuX2ZpeGVkVG9vbGJhci5yZW1vdmVDbGFzcyggY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQl0aGlzLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCWlmICggdGhlbWUgKSB7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhlbWUgKS5hZGRDbGFzcyggdGhpcy5fcGFnZVRoZW1lICk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFuZWxJbm5lci5jaGlsZHJlbigpLnVud3JhcCgpOwoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIGNsYXNzZXMucGFuZWxBbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCgkJLy8gb3BlbiBhbmQgY2xvc2UKCQl0aGlzLmVsZW1lbnQub2ZmKCB0aGlzLl90cmFuc2l0aW9uRW5kRXZlbnRzICkKCQkJLnJlbW92ZUNsYXNzKCBbIGNsYXNzZXMucGFuZWxVbmZpeGVkLCBjbGFzc2VzLnBhbmVsQ2xvc2VkLCBjbGFzc2VzLnBhbmVsT3BlbiBdLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5wYW5lbC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJCW9wdGlvbnM6IHsKCQkJY2xhc3NlczogewoJCQkJdGFibGU6ICJ1aS10YWJsZSIKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQlzZWxmLnJlZnJlc2goIHRydWUgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbiAoY3JlYXRlKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCXRycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidGhlYWQgdHIiICk7CgoJCQlpZiAoIGNyZWF0ZSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQkJfQoKCQkJLy8gRXhwb3NlIGhlYWRlcnMgYW5kIGFsbEhlYWRlcnMgcHJvcGVydGllcyBvbiB0aGUgd2lkZ2V0CgkJCS8vIGhlYWRlcnMgcmVmZXJlbmNlcyB0aGUgVEhzIHdpdGhpbiB0aGUgZmlyc3QgVFIgaW4gdGhlIHRhYmxlCgkJCXNlbGYuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidHI6ZXEoMCkiICkuY2hpbGRyZW4oKTsKCgkJCS8vIGFsbEhlYWRlcnMgcmVmZXJlbmNlcyBoZWFkZXJzLCBwbHVzIGFsbCBUSHMgaW4gdGhlIHRoZWFkLCB3aGljaCBtYXkgaW5jbHVkZSBzZXZlcmFsIHJvd3MsIG9yIG5vdAoJCQlzZWxmLmFsbEhlYWRlcnMgPSBzZWxmLmhlYWRlcnMuYWRkKCB0cnMuY2hpbGRyZW4oKSApOwoKCQkJdHJzLmVhY2goZnVuY3Rpb24oKXsKCgkJCQl2YXIgY29sdGFsbHkgPSAwOwoKCQkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24oIGkgKXsKCgkJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlzZWwgPSAiOm50aC1jaGlsZCgiICsgKCBjb2x0YWxseSArIDEgKSArICIpIjsKCQkJCQkkKCB0aGlzICkKCQkJCQkJLmpxbURhdGEoICJjb2xzdGFydCIsIGNvbHRhbGx5ICsgMSApOwoKCQkJCQlpZiggc3BhbiApewoJCQkJCQlmb3IoIHZhciBqID0gMDsgaiA8IHNwYW4gLSAxOyBqKysgKXsKCQkJCQkJCWNvbHRhbGx5Kys7CgkJCQkJCQlzZWwgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x0YWxseSArIDEgKSArICIpIjsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJCh0aGlzKS5qcW1EYXRhKCJjZWxscyIsICIiKTsKCQkJCQl9CgkJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCQkkKCB0aGlzICkKCQkJCQkJLmpxbURhdGEoICJjZWxscyIsIHNlbGYuZWxlbWVudC5maW5kKCAidHIiICkubm90KCB0cnMuZXEoMCkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsICkgKTsKCgkJCQkJY29sdGFsbHkrKzsKCgkJCQl9KTsKCgkJCX0pOwoKCQkJLy8gdXBkYXRlIHRhYmxlIG1vZGVzCgkJCWlmICggY3JlYXRlID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggJ3JlZnJlc2gnICk7CgkJCX0KCX0KCn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMubW9kZSA9ICJjb2x1bW50b2dnbGUiOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uQnRuVGhlbWUgPSBudWxsOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uUG9wdXBUaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UZXh0ID0gIkNvbHVtbnMuLi4iOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcyA9ICQuZXh0ZW5kKAoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywKCXsKCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJfQopOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSd0YWJsZScpIiwgInRhYmxlY3JlYXRlIHJlZnJlc2giLCBmdW5jdGlvbiggZSApIHsKCQoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJZXZlbnQgPSBlLnR5cGUsCgkJbyA9IHNlbGYub3B0aW9ucywKCQlucyA9ICQubW9iaWxlLm5zLAoJCWlkID0gKCAkdGFibGUuYXR0ciggImlkIiApIHx8IG8uY2xhc3Nlcy5wb3B1cCApICsgIi1wb3B1cCIsIC8qIFRPRE8gQkVUVEVSIEZBTExCQUNLIElEIEhFUkUgKi8KCQkkbWVudUJ1dHRvbiwKCQkkcG9wdXAsCgkJJG1lbnUsCgkJJHN3aXRjaGJvYXJkOwoKCWlmICggby5tb2RlICE9PSAiY29sdW1udG9nZ2xlIiApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkKCQkkbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY29sdW1uQnRuICsgIicgZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAibWluaT0ndHJ1ZSc+IiArIG8uY29sdW1uQnRuVGV4dCArICI8L2E+IiApLAoJCSRwb3B1cCA9ICQoICI8ZGl2IGRhdGEtIiArIG5zICsgInJvbGU9J3BvcHVwJyBkYXRhLSIgKyBucyArICJyb2xlPSdmaWVsZGNvbnRhaW4nIGNsYXNzPSciICsgby5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIpLAoJCSRtZW51ID0gJCgiPGZpZWxkc2V0IGRhdGEtIiArIG5zICsgInJvbGU9J2NvbnRyb2xncm91cCc+PC9maWVsZHNldD4iKTsKCX0KCQoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJc2VsZi5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCXZhciBwcmlvcml0eSA9ICQoIHRoaXMgKS5qcW1EYXRhKCAicHJpb3JpdHkiICksCgkJCSRjZWxscyA9ICQoIHRoaXMgKS5hZGQoICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJaWYgKCBwcmlvcml0eSApIHsKCgkJCSRjZWxscy5hZGRDbGFzcyggby5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsgJCggdGhpcyApLnRleHQoKSArICI8L2xhYmVsPiIgKQoJCQkJCS5hcHBlbmRUbyggJG1lbnUgKQoJCQkJCS5jaGlsZHJlbiggMCApCgkJCQkJLmpxbURhdGEoICJjZWxscyIsICRjZWxscyApCgkJCQkJLmNoZWNrYm94cmFkaW8oewoJCQkJCQl0aGVtZTogby5jb2x1bW5Qb3B1cFRoZW1lCgkJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkKCAnIycgKyBpZCArICcgZmllbGRzZXQgZGl2OmVxKCcgKyBpICsnKScpLmZpbmQoJ2lucHV0JykuanFtRGF0YSggJ2NlbGxzJywgJGNlbGxzICk7CgkJCX0KCQl9Cgl9KTsKCQoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCSRtZW51LmFwcGVuZFRvKCAkcG9wdXAgKTsKCX0KCgkvLyBiaW5kIGNoYW5nZSBldmVudCBsaXN0ZW5lcnMgdG8gaW5wdXRzIC0gVE9ETzogbW92ZSB0byBhIHByaXZhdGUgbWV0aG9kPwoJaWYgKCAkbWVudSA9PT0gdW5kZWZpbmVkICkgewoJCSRzd2l0Y2hib2FyZCA9ICQoJyMnICsgaWQgKyAnIGZpZWxkc2V0Jyk7Cgl9IGVsc2UgewoJCSRzd2l0Y2hib2FyZCA9ICRtZW51OwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkc3dpdGNoYm9hcmQub24oICJjaGFuZ2UiLCAiaW5wdXQiLCBmdW5jdGlvbiggZSApewoJCQlpZiggdGhpcy5jaGVja2VkICl7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iICkuYWRkQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iICk7CgkJCX0KCQl9KTsKCgkJJG1lbnVCdXR0b24KCQkJLmluc2VydEJlZm9yZSggJHRhYmxlICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby5jb2x1bW5CdG5UaGVtZQoJCQl9KTsKCgkJJHBvcHVwCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5wb3B1cCgpOwoJfQoKCS8vIHJlZnJlc2ggbWV0aG9kCglzZWxmLnVwZGF0ZSA9IGZ1bmN0aW9uKCl7CgkJJHN3aXRjaGJvYXJkLmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpewoJCQlpZiAodGhpcy5jaGVja2VkKSB7CgkJCQl0aGlzLmNoZWNrZWQgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmVxKDApLmNzcyggImRpc3BsYXkiICkgPT09ICJ0YWJsZS1jZWxsIjsKCQkJCWlmIChldmVudCA9PT0gInJlZnJlc2giKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC12aXNpYmxlJyk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmFkZENsYXNzKCd1aS10YWJsZS1jZWxsLWhpZGRlbicpOwoJCQl9CgkJCSQoIHRoaXMgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX07CgoJJC5tb2JpbGUud2luZG93Lm9uKCAidGhyb3R0bGVkcmVzaXplIiwgc2VsZi51cGRhdGUgKTsKCglzZWxmLnVwZGF0ZSgpOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLm1vZGUgPSAicmVmbG93IjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMgPSAkLmV4dGVuZCgKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsCgl7CgkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCWNlbGxMYWJlbHM6ICJ1aS10YWJsZS1jZWxsLWxhYmVsIgoJfQopOwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICI6anFtRGF0YShyb2xlPSd0YWJsZScpIiwgInRhYmxlY3JlYXRlIHJlZnJlc2giLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgJHRhYmxlID0gJCggdGhpcyApLAoJCWV2ZW50ID0gZS50eXBlLAoJCXNlbGYgPSAkdGFibGUuZGF0YSggIm1vYmlsZS10YWJsZSIgKSwKCQlvID0gc2VsZi5vcHRpb25zOwoKCS8vIElmIGl0J3Mgbm90IHJlZmxvdyBtb2RlLCByZXR1cm4gaGVyZS4KCWlmKCBvLm1vZGUgIT09ICJyZWZsb3ciICl7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoJfQoKCS8vIGdldCBoZWFkZXJzIGluIHJldmVyc2Ugb3JkZXIgc28gdGhhdCB0b3AtbGV2ZWwgaGVhZGVycyBhcmUgYXBwZW5kZWQgbGFzdAoJdmFyIHJldmVyc2VIZWFkZXJzID0gICQoIHNlbGYuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKTsKCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglyZXZlcnNlSGVhZGVycy5lYWNoKGZ1bmN0aW9uKCBpICl7CgkJdmFyICRjZWxscyA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICksCgkJCWNvbHN0YXJ0ID0gJCggdGhpcyApLmpxbURhdGEoICJjb2xzdGFydCIgKSwKCQkJaGllcmFyY2h5Q2xhc3MgPSAkY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQl0ZXh0ID0gJCh0aGlzKS50ZXh0KCk7CgoJCQlpZiggdGV4dCAhPT0gIiIgICl7CgoJCQkJaWYoIGhpZXJhcmNoeUNsYXNzICl7CgkJCQkJdmFyIGl0ZXJhdGlvbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCWZpbHRlciA9ICIiOwoKCQkJCQlpZiggaXRlcmF0aW9uICl7CgkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQl9CgkJCQkJJGNlbGxzLmZpbHRlciggZmlsdGVyICkucHJlcGVuZCggIjxiIGNsYXNzPSciICsgby5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGNlbGxzLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7CgkJCQl9CgoJCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gdHJ1ZTsKCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CglpZiggISggL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIC9PUyBbMS01XV9bMC05X10qIGxpa2UgTWFjIE9TIFgvaS50ZXN0KCB1YSApICYmIHVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSBmYWxzZTsKCQlyZXR1cm47Cgl9CgoJdmFyIHpvb20gPSAkLm1vYmlsZS56b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoKCWZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKCQlpZiAoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKSB7CgkJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCQl6b29tLmRpc2FibGUoKTsKCQkJCX0KCQl9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQkJem9vbS5lbmFibGUoKTsKCQl9Cgl9CgoJJC5tb2JpbGUuZG9jdW1lbnQub24oICJtb2JpbGVpbml0IiwgZnVuY3Rpb24oKXsKCQlpZiggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkoICQoIGhhc2hQYWdlICkuaXMoICc6anFtRGF0YShyb2xlPSJwYWdlIiknICkgfHwKCQkJCQkkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApIHx8CgkJCQkJaGFzaCA9PT0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApICkgKSB7CgoJCQkJLy8gU3RvcmUgdGhlIGluaXRpYWwgZGVzdGluYXRpb24KCQkJCWlmICggJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJCSQubW9iaWxlLnVybEhpc3RvcnkuaW5pdGlhbERzdCA9IGhhc2gucmVwbGFjZSggIiMiLCAiIiApOwoJCQkJfQoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgaW5pdGlhbCBwb3BzdGF0ZSBzdGF0ZSBpZiBpdCBleGlzdHMKCQkJCS8vIHNvIHRoYXQgbmF2aWdhdGlvbiBiYWNrIHRvIHRoZSBpbml0aWFsIHBhZ2Ugd29ya3MgcHJvcGVybHkKCQkJCWlmKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCgp9KSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:26:14 GMT",
                    "Content-Length": "359005",
                    "Date": "Fri, 07 Nov 2014 16:26:14 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}