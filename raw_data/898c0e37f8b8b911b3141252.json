{
    "url": "http://localhost:9999/totty90/jquery-mobile-requirejs/js/jquery.mobile-1.3.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/totty90/jquery-mobile-requirejs/js/jquery.mobile-1.3.2.js",
                "path": "/totty90/jquery-mobile-requirejs/js/jquery.mobile-1.3.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC90b3R0eTkwL2pxdWVyeS1tb2JpbGUtcmVxdWlyZWpzL2pzL2pxdWVyeS5tb2JpbGUtMS4zLjIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzU5MDMwDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjU5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo1OSBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjMuMgoqIEdpdCBIRUFEIGhhc2g6IDUyOGNmMGU5Njk0MDY0NGVhNjQ0MDk2YmZlYjkxM2VkOTIwZmZhZWYgPD4gRGF0ZTogRnJpIEp1bCAxOSAyMDEzIDIyOjE3OjU3IFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwovLyBiYWNrdXAgZGVmaW5lCnZhciBfZGVmaW5lID0gZGVmaW5lOwovLyBoYWNrIGRlZmluZQpkZWZpbmUgPSBmdW5jdGlvbihkZXBzLCBmbil7CiAgICBfZGVmaW5lKGRlcHMsIGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gc2F2ZSBhcmd1bWVudHMgdGhhdCBjb250YWlucyBkZXBzCiAgICAgICAgdmFyIGRlZmluZUFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgLy8gbWFrZSBhIGZ1bmN0aW9uIHRoYXQgb25seSB3aGVuIHRyaWdnZXJlZCBvcGVucyB0aGUgcGFja2FnZQogICAgICAgIHZhciBvcGVuUGFja2FnZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh3aW5kb3csIGRlZmluZUFyZ3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3BlblBhY2thZ2U7CiAgICB9KQogICAgLy8gcmVzdG9yZSB0aGUgZGVmaW5lCiAgICBkZWZpbmUgPSBfZGVmaW5lOwp9CmRlZmluZS5hbWQgPSB0cnVlOwoKCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkICkgewoJJC5tb2JpbGUgPSB7fTsKfSggalF1ZXJ5ICkpOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4zLjIiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudCdzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKCB0aGlzICkudGV4dCgpICkuaHRtbCgpOwoJfTsKCgkvLyBmbHVlbnQgaGVscGVyIGZ1bmN0aW9uIGZvciB0aGUgbW9iaWxlIG5hbWVzcGFjZWQgZXF1aXZhbGVudAoJJC5mbi5qcW1FbmhhbmNlYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJfTsKCgkkLmZuLmpxbUhpamFja2FibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJfTsKCgkvLyBNb25rZXktcGF0Y2hpbmcgU2l6emxlIHRvIGZpbHRlciB0aGUgOmpxbURhdGEgc2VsZWN0b3IKCXZhciBvbGRGaW5kID0gJC5maW5kLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9Owp9KSggalF1ZXJ5LCB0aGlzICk7CgoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgdjEuMTAuMHByZSAtIDIwMTItMTEtMTMgKGZmMDU1YTBjMzUzYzNjOGNlNmU1YmZhMDdhZDdjYjAzZTg4ODViYzUpCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggOiBuYW1lCgl9LCBwcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9LAoKCXJhaXNlOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93ICJXaWRnZXQgWyIgKyB0aGlzLndpZGdldE5hbWUgKyAiXTogIiArIG1zZzsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBERVBSRUNBVEVECgkvLyBOT1RFIGdsb2JhbCBtb2JpbGUgb2JqZWN0IHNldHRpbmdzCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBERVBSRUNBVEVEIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgZGVmYXVsdCBtZXNzYWdlIHNldHRpbmcKCQlsb2FkaW5nTWVzc2FnZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVECgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ3Nob3cnLCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKTsKCQl9LAoKCQkvLyBERVBSRUNBVEVECgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ2hpZGUnICk7CgkJfSwKCgkJbG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCXRoaXMubG9hZGVyV2lkZ2V0LmxvYWRlci5hcHBseSggdGhpcy5sb2FkZXJXaWRnZXQsIGFyZ3VtZW50cyApOwoJCX0KCX0pOwoKCS8vIFRPRE8gbW92ZSBsb2FkZXIgY2xhc3MgZG93biBpbnRvIHRoZSB3aWRnZXQgc2V0dGluZ3MKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLCAkaHRtbCA9ICQoICJodG1sIiApLCAkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgJGhlYWRlciwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSh0aGVtZSkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJLy8gcHJlZmVyIG9iamVjdCBwcm9wZXJ0eSBmcm9tIHRoZSBwYXJhbSB0aGVuIHRoZSBvbGQgdGhlbWUgc2V0dGluZwoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbSB2YWx1ZSBwYXNzZWQgYXMgYSBzdHJpbmcgYXJndW1lbnQsIHRoZW4KCQkJCS8vIHdlIHByZWZlciB0aGUgZ2xvYmFsIG9wdGlvbiBiZWNhdXNlIHdlIGNhbid0IHVzZSB1bmRlZmluZWQgZGVmYXVsdAoJCQkJLy8gcHJvdG90eXBlIG9wdGlvbnMsIHRoZW4gdGhlIHByb3RvdHlwZSBvcHRpb24KCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgfHwgbG9hZFNldHRpbmdzLnRleHQ7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSAhPT0gZmFsc2UgfHwgbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkvLyBib29sZWFuIHZhbHVlcyByZXF1aXJlIGEgYml0IG1vcmUgd29yayA6UCwgc3VwcG9ydHMgb2JqZWN0IHByb3BlcnRpZXMKCQkJCS8vIGFuZCBvbGQgc2V0dGluZ3MKCQkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRleHRWaXNpYmxlID0gJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgkJCQl9CgoJCQkJLy8gYWRkIHRoZSBwcm9wZXIgY3NzIGdpdmVuIHRoZSBvcHRpb25zICh0aGVtZSwgdGV4dCwgZXRjKQoJCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoImNsYXNzIiwgbG9hZGVyQ2xhc3MgKwoJCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJCSggbG9hZFNldHRpbmdzLnRleHRvbmx5IHx8IHRleHRvbmx5ID8gIiB1aS1sb2FkZXItdGV4dG9ubHkiIDogIiIgKSApOwoKCQkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCQkvLyBpZiB0aGUgaHRtbCBhdHRyaWJ1dGUgaXMgZGVmaW5lZCBvbiB0aGUgbG9hZGluZyBzZXR0aW5ncywgdXNlIHRoYXQKCQkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJCXRoaXMuZWxlbWVudC5odG1sKCBsb2FkU2V0dGluZ3MuaHRtbCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJCX0KCgkJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkvLyBjaGVjayB0aGF0IHRoZSBsb2FkZXIgaXMgdmlzaWJsZQoJCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJCSR3aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8KLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8KLy8gQWJvdXQ6IExpY2Vuc2UKLy8KLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8KLy8gQWJvdXQ6IEV4YW1wbGVzCi8vCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8KLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLwovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLwovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8KLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8KLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8KLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLwovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAoKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCgogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwoKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8KICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8KICAvLyBVc2FnZToKICAvLwogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLwogIC8vIEFyZ3VtZW50czoKICAvLwogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLwogIC8vIFJldHVybnM6CiAgLy8KICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCgogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLwogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8KICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLwogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLwogIC8vIFVzYWdlOgogIC8vCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8KICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vCiAgLy8gVXNhZ2U6CiAgLy8KICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCgogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8KICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8KICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4KICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8KICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8KICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPgogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLwogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewoKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CgogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAoKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CgogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KCiAgfSk7CgogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAoKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAoKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24oIHZhbCApIHsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwoKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CgogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CgogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CgogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwoKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwoKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CgogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQoKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwoKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwoKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CgogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CgogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwoKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwoKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwoKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgoKICAgIHJldHVybiBzZWxmOwogIH0pKCk7Cgp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKTsKCglpZiggcmV0ICkgewoJCXJldHVybiAhIXJldDsKCX0KCgl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXRyYW5zZm9ybXMgPSB7CgkJCS8vIFdl4oCZcmUgb21pdHRpbmcgT3BlcmEgZm9yIHRoZSB0aW1lIGJlaW5nOyBNUyB1c2VzIHVucHJlZml4ZWQuCgkJCSdNb3pUcmFuc2Zvcm0nOictbW96LXRyYW5zZm9ybScsCgkJCSd0cmFuc2Zvcm0nOid0cmFuc2Zvcm0nCgkJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdmFyIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAndHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApJzsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7Cgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8CgkJdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicsIFsgIldlYmtpdCIsICJNb3oiLCAiIiBdICkgJiYKCQkhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAhb3BlcmEsCgoJLy8gTm90ZSwgQ2hyb21lIGZvciBpT1MgaGFzIGFuIGV4dHJlbWVseSBxdWlya3kgaW1wbGVtZW50YXRpb24gb2YgcG9wc3RhdGUuCgkvLyBXZSd2ZSBjaG9zZW4gdG8gdGFrZSB0aGUgc2hvcnRlc3QgcGF0aCB0byBhIGJ1ZyBmaXggaGVyZSBmb3IgaXNzdWUgIzU0MjYKCS8vIFNlZSB0aGUgZm9sbG93aW5nIGxpbmsgZm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSByZWdleCBjaG9zZW4KCS8vIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2Nocm9tZS9tb2JpbGUvZG9jcy91c2VyLWFnZW50I2Nocm9tZV9mb3JfaW9zX3VzZXItYWdlbnQKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCSJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkvLyBXaGVuIHJ1bm5pbmcgaW5zaWRlIGEgRkYgaWZyYW1lLCBjYWxsaW5nIHJlcGxhY2VTdGF0ZSBjYXVzZXMgYW4gZXJyb3IKCQkhKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiRmlyZWZveCIgKSA+PSAwICYmIHdpbmRvdy50b3AgIT09IHdpbmRvdyApICYmCgkJKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5zZWFyY2goL0NyaU9TLykgPT09IC0xICksCgoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsIGhpc3Rvcnk7CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30sCgkJCQlocmVmID0gbG9jYXRpb24uaHJlZjsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBkYXRhICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2VzICkgewoJCQlpZiggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICl7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgZG9jdW1lbnRCYXNlLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBzdGF0ZSwgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCXBhdGguZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCX07CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGg7CgoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2JhY2snICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2ZvcndhcmQnICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICl7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJaW5pdGlhbEhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCSQubW9iaWxlLk5hdmlnYXRvciA9IGZ1bmN0aW9uKCBoaXN0b3J5ICkgewoJCXRoaXMuaGlzdG9yeSA9IGhpc3Rvcnk7CgkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IHRydWU7CgoJCSQubW9iaWxlLndpbmRvdy5iaW5kKHsKCQkJInBvcHN0YXRlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLnBvcHN0YXRlLCB0aGlzICksCgkJCSJoYXNoY2hhbmdlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLmhhc2hjaGFuZ2UsIHRoaXMgKQoJCX0pOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5OYXZpZ2F0b3IucHJvdG90eXBlLCB7CgkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2ggPSBwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5zdHJpcEhhc2godXJsKSA6IHVybDsKCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBtYWtlIHN1cmUgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uIHdoZW4gaXQgaXNuJ3QgZXhwbGljaXRseSBzZXQgaW4gdGhlCgkJCS8vIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCB0byB0aGUgc3F1YXNoIG1ldGhvZAoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXZhciByZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXRoaXMuc3F1YXNoKCB1cmwsIHN0YXRlICk7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBhY3RpdmUsIGhhc2gsIHN0YXRlLCBjbG9zZXN0SW5kZXg7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKXsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCkge30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKTsKCgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCQlpZiAoIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQl9CgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgoJCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICkKCQkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wICk7CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IHdpbi53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCBlICkgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudC5wYXJlbnQoKSApICk7Cgl9LAoKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudG9nZ2xlQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQtdHJhbnNpdGlvbmluZyB2aWV3cG9ydC0iICsgbmFtZSApOwoJCQl9LAoJCQlzY3JvbGxQYWdlID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRvU2Nyb2xsICk7CgoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCQl9LCAxNTAgKTsKCQkJfSwKCQkJY2xlYW5Gcm9tID0gZnVuY3Rpb24oKSB7CgkJCQkkZnJvbQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCQkJfSwKCQkJc3RhcnRPdXQgPSBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgkJCQkJZG9uZU91dCgpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVPdXQgKTsKCQkJCX0KCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy8gTk9URTogcGF0aCBleHRlbnNpb25zIGRlcGVuZGVudCBvbiBjb3JlIGF0dHJpYnV0ZXMuIE1vdmVkIGhlcmUgdG8gcmVtb3ZlIGRlcHMgZnJvbQoJCS8vICAgICAgICQubW9iaWxlLnBhdGggZGVmaW5pdGlvbgoJCXBhdGggPSAkLmV4dGVuZCgkLm1vYmlsZS5wYXRoLCB7CgoJCQkvL3JldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcgYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAnJicgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy9jaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZCBvZiB0aGUKCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCWRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9KSwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbCwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLmRvY3VtZW50VXJsLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9IHBhdGguZG9jdW1lbnRCYXNlLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9IHBhdGguZG9jdW1lbnRCYXNlRGlmZmVycywKCgkJZ2V0U2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0OwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoaHJlZikuaHJlZk5vSGFzaDsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBwYXRoLmdldERvY3VtZW50QmFzZTsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCQlpZiAoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgPSBmdW5jdGlvbiByZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIGhlaWdodCApIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKT8gaGVpZ2h0IDogZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSBhUGFnZVBhZFQgLSBhUGFnZVBhZEIgLSBhUGFnZUJvcmRlclQgLSBhUGFnZUJvcmRlckIgKTsKCX07CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCWZ1bmN0aW9uIGZpbmRCYXNlV2l0aERlZmF1bHQoKSB7CgkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQkvL2lmIHdlIGFyZSByZWxvYWRpbmcgdGhlIHBhZ2UgbWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmKCBiYXNlICYmICFvcHRpb25zLnByZWZldGNoICl7CgkJCQkJYmFzZS5zZXQodXJsKTsKCQkJCX0KCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKSB7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQlpZiAoIGJhc2UgJiYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiICkgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoJCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJCWlmICggYmFzZSAmJiAoIHR5cGVvZiBvcHRpb25zID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSkgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyAoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksIGlzVG9QYWdlU3RyaW5nOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCS8vICAgICAgIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJLy8gICAgICAgdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCS8vICAgICAgIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB0b1BhZ2UsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCX0gZWxzZSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSB0b1BhZ2UuZGF0YSggJ2Fic1VybCcgKTsKCQl9CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgkJLy8KCQkvLyBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywgYmVjYXVzZSBhbiBvYmplY3QgY2FuCgkJLy8gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkJLy8gZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkJLy8gdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCQkvLyBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvUGFnZTsKCgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgoJCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCW5ld1BhZ2UuZGF0YSggJ2Fic1VybCcsIHRyaWdnZXJEYXRhLmFic1VybCApOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJaGlzdG9yeURpciA9IG9wdGlvbnMuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2JvZHknICkgewoJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKCBlICkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYKCQkJCSEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSAmJgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCWlmKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsICs9ICIjIiArIGRpYWxvZ0hhc2hLZXk7CgkJCX0KCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXZhciBwYXJhbXM7CgoJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCWlmKCAhcGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCX0KCgkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJcGFyYW1zID0gewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQl9OwoKCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQl9CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9IHBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCgkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiBwYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJiAhJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2godXJsKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZSB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMKCQkJCS8vIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICh1cmxIaXN0b3J5LmdldExhc3QoKSB8fCB7fSkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQlpZiggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQkJCQl9CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICFwYXRoLmlzUGF0aCggdG8gKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vIFRPRE8gcm9sbCB0aGUgbG9naWMgaGVyZSBpbnRvIHRoZSBoYW5kbGVIYXNoQ2hhbmdlIG1ldGhvZAoJCSR3aW5kb3cuYmluZCggIm5hdmlnYXRlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50TmFtZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiggIXVybCApIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCX0KCgkJCWlmKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApewoJCQkJdXJsID0gbG9jYXRpb24uaHJlZjsKCQkJfQoKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHVybCwgZGF0YS5zdGF0ZSApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb3JuZXJDbGFzcyA9ICEhdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsgY29ybmVyQ2xhc3MKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwud3JhcElubmVyKCBkaWFsb2dXcmFwICk7CgoJCS8qIGJpbmQgZXZlbnRzCgkJCS0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cgb3BlbmVkIHdpdGgKCQkJCXVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fb24oICRlbCwgewoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3JlYXRlQ29tcGxldGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLCBidG4sIGxvY2F0aW9uOwoKCQlpZiAoIHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uICkgewoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbi5yZW1vdmUoKTsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBudWxsOwoJCX0KCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCS8vIFNhbml0aXplIHZhbHVlCgkJCWxvY2F0aW9uID0gKCB2YWx1ZSA9PT0gImxlZnQiID8gImxlZnQiIDogInJpZ2h0IiApOwoJCQlidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWJ0bi0iICsgbG9jYXRpb24gKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKS5wcmVwZW5kKCBidG4gKTsKCQkJaWYgKCB0aGlzLl9jcmVhdGVDb21wbGV0ZSAmJiAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCWJ0bi5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQl0aGlzLl9jcmVhdGVDb21wbGV0ZSA9IHRydWU7CgoJCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkJLy8gb24gdGhlIGJ1dHRvbiBhbmQgbGV0dGluZyBuYXYgaGFuZGxlIGl0CgkJCS8vCgkJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJCS8vIHJlb3BlbmluZyB0aGUgZGlhbG9nIGlmIHRoZSBkaWFsb2cgb3BlbmluZyBpdGVtIHdhcyBkaXJlY3RseSB1bmRlciB0aGUgY2xvc2UgYnV0dG9uLgoJCQlidG4uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImNsb3NlQnRuIiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCS8vIElmIHRoZSBoYXNoIGxpc3RlbmluZyBpcyBlbmFibGVkIGFuZCB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgcHJlY2VkaW5nIGhpc3RvcnkKCQkJLy8gZW50cnkgaXQncyBvayB0byBnbyBiYWNrLiBJbml0aWFsIHBhZ2VzIHdpdGggdGhlIGRpYWxvZyBoYXNoIHN0YXRlIGFyZSBhbiBleGFtcGxlCgkJCS8vIHdoZXJlIHRoZSBzdGFjayBjaGVjayBpcyBuZWNlc3NhcnkKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJiBoaXN0LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCWlkeCA9IE1hdGgubWF4KCAwLCBoaXN0LmFjdGl2ZUluZGV4IC0gMSApOwoJCQkJZHN0ID0gaGlzdC5zdGFja1sgaWR4IF0ucGFnZVVybCB8fCBoaXN0LnN0YWNrWyBpZHggXS51cmw7CgkJCQloaXN0LnByZXZpb3VzSW5kZXggPSBoaXN0LmFjdGl2ZUluZGV4OwoJCQkJaGlzdC5hY3RpdmVJbmRleCA9IGlkeDsKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCBkc3QgKSApIHsKCQkJCQlkc3QgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgZHN0ICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZHN0LCB7IGRpcmVjdGlvbjogImJhY2siLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCXZhciAkcGFnZSA9ICQoIGUudGFyZ2V0ICksCgkJbyA9ICRwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVGhpcyBmdW5jdGlvbiBjYWxscyBnZXRBdHRyaWJ1dGUsIHdoaWNoIHNob3VsZCBiZSBzYWZlIGZvciBkYXRhLSogYXR0cmlidXRlcwp2YXIgZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oIGUsIGtleSApIHsKCXZhciB2YWx1ZSA9IGUuZ2V0QXR0cmlidXRlKCBrZXkgKTsKCglyZXR1cm4gdmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCXZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCXZhbHVlID09PSBudWxsID8gdW5kZWZpbmVkIDogdmFsdWU7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQluc0tleSA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQlrZXk7CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAibWluaSIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoJCQlob3ZlciA9IGZhbHNlLAoJCQlzdGF0ZSA9ICJ1cCIsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQlmb3IgKCBrZXkgaW4gbyApIHsKCQkJaWYgKCBvWyBrZXkgXSA9PT0gdW5kZWZpbmVkIHx8IG9bIGtleSBdID09PSBudWxsICkgewoJCQkJZWwucmVtb3ZlQXR0ciggbnNLZXkgKyBrZXkgKTsKCQkJfSBlbHNlIHsKCQkJCWUuc2V0QXR0cmlidXRlKCBuc0tleSArIGtleSwgb1sga2V5IF0gKTsKCQkJfQoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhpcyBlbGVtZW50IGlzIGFscmVhZHkgZW5oYW5jZWQKCQlidXR0b25FbGVtZW50cyA9ICQuZGF0YSggKCAoIGUudGFnTmFtZSA9PT0gIklOUFVUIiB8fCBlLnRhZ05hbWUgPT09ICJCVVRUT04iICkgPyBlLnBhcmVudE5vZGUgOiBlICksICJidXR0b25FbGVtZW50cyIgKTsKCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZSA9IGJ1dHRvbkVsZW1lbnRzLm91dGVyOwoJCQllbCA9ICQoIGUgKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoIGJ1dHRvbkVsZW1lbnRzLmljb24gKS5yZW1vdmUoKTsKCQkJYnV0dG9uRWxlbWVudHMuaWNvbiA9IG51bGw7CgkJCWhvdmVyID0gYnV0dG9uRWxlbWVudHMuaG92ZXI7CgkJCXN0YXRlID0gYnV0dG9uRWxlbWVudHMuc3RhdGU7CgkJfQoJCWVsc2UgewoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJfQoJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoKCQkvLyBpZiBub3QsIHRyeSB0byBmaW5kIGNsb3Nlc3QgdGhlbWUgY29udGFpbmVyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CgkJfQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gIjsKCQlidXR0b25DbGFzcyArPSAoIGhvdmVyID8gInVpLWJ0bi1ob3Zlci0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gKCBzdGF0ZSA/ICIgdWktYnRuLSIgKyBzdGF0ZSArICItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoKCQlpZiAoIG8uaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBpbmxpbmVgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gdHJ1ZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIHVpLWJ0bi1ibG9jayI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJaG92ZXIgOiBob3ZlciwKCQkJc3RhdGUgOiBzdGF0ZSwKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9CgpmdW5jdGlvbiB1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgY2xhc3NUb1JlbW92ZSwgY2xhc3NUb0FkZCwgaG92ZXIsIHN0YXRlICkgewoJdmFyIGJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAkYnRuWyAwIF0sICJidXR0b25FbGVtZW50cyIgKTsKCSRidG4ucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKS5hZGRDbGFzcyggY2xhc3NUb0FkZCApOwoJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQlidXR0b25FbGVtZW50cy5iY2xzID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApCgkJCS5hZGRDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyArICIgIiArIGNsYXNzVG9BZGQgKQoJCQkucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKQoJCQkuYXR0ciggImNsYXNzIiApOwoJCWlmICggaG92ZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJYnV0dG9uRWxlbWVudHMuaG92ZXIgPSBob3ZlcjsKCQl9CgkJYnV0dG9uRWxlbWVudHMuc3RhdGUgPSBzdGF0ZTsKCX0KfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlpc1RvdWNoRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9edG91Y2gvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApLAoJCQkJZXZ0ID0gZXZlbnQudHlwZTsKCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlob3YgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIHVuZGVmaW5lZCwgInVwIiApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCBmYWxzZSwgInVwIiApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZUNsYXNzZXMgPSAiIjsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5jb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uOwoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbjsKCgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5pY29ucG9zID0gJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvczsKCgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBTZXQgY29ybmVycyBmb3IgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZXMgdG8gZmFsc2Ugd2hlbiBpbiBhIGNvbGxhcHNpYmxlLXNldAoJCQlvLmNvcm5lcnMgPSBmYWxzZTsKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBmb3IgbWluaSBpbiB0aGUgc2V0CgkJCWlmICggIW8ubWluaSApIHsKCQkJCW8ubWluaSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJtaW5pIiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gZ2V0IGluaGVyaXRlZCB0aGVtZSBpZiBub3QgYSBzZXQgYW5kIG5vIHRoZW1lIGhhcyBiZWVuIHNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCQl9CgkJfQoKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtaW5zZXQiOwoJCQlpZiAoICEhby5jb3JuZXJzICkgewoJCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29ybmVyLWFsbCIgOwoJCQl9CgkJfQoJCWlmICggby5jb250ZW50VGhlbWUgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50IjsKCQkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9CgkJaWYgKCBjb2xsYXBzaWJsZUNsYXNzZXMgIT09ICIiICkgewoJCQljb2xsYXBzaWJsZS5hZGRDbGFzcyggY29sbGFwc2libGVDbGFzc2VzICk7CgkJfQoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCQlpY29uOiBvLmNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgby5leHBhbmRlZEljb24gPT09IG8uY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvcm5lciBzdHlsaW5nIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICk7CgkJfQoKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCQlvLmNvcm5lcnMgPSBvLmNvcm5lcnMgIT09IHVuZGVmaW5lZCA/IG8uY29ybmVycyA6IHRydWU7CgoJCWlmICggISFvLmNvcm5lcnMgJiYgISFvLmluc2V0ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLl9yZWZyZXNoKCAidHJ1ZSIgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICk7CgoJCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlKCBjb2xsYXBzaWJsZXNJblNldC5ub3QoICIudWktY29sbGFwc2libGUiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyB1aS1idG4taW5uZXIgaXMgcmV0dXJuZWQgYXMgdGFyZ2V0CgkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5pcyggImEiICkgPyAkKCB0aGlzICkgOiAkKCB0aGlzICkucGFyZW50KCAiYSIgKTsKCgkJCWlmICggIXRhcmdldC5pcyggIi51aS1kaXNhYmxlZCwgLnVpLWJ0bi1hY3RpdmUiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlpY29uOiAiYXJyb3ctciIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRoaXMgaXMgYSBnZW5lcmljIHV0aWxpdHkgbWV0aG9kIGZvciBmaW5kaW5nIHRoZSBmaXJzdAoJLy8gbm9kZSB3aXRoIGEgZ2l2ZW4gbm9kZU5hbWUuIEl0IHVzZXMgYmFzaWMgRE9NIHRyYXZlcnNhbAoJLy8gdG8gYmUgZmFzdCBhbmQgaXMgbWVhbnQgdG8gYmUgYSBzdWJzdGl0dXRlIGZvciBzaW1wbGUKCS8vICQuZm4uY2xvc2VzdCgpIGFuZCAkLmZuLmNoaWxkcmVuKCkgY2FsbHMgb24gYSBzaW5nbGUKCS8vIGVsZW1lbnQuIE5vdGUgdGhhdCBjYWxsZXJzIG11c3QgcGFzcyBib3RoIHRoZSBsb3dlckNhc2UKCS8vIGFuZCB1cHBlckNhc2UgdmVyc2lvbiBvZiB0aGUgbm9kZU5hbWUgdGhleSBhcmUgbG9va2luZyBmb3IuCgkvLyBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMgaXMgdGhhdCB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUKCS8vIGNhbGxlZCBtYW55IHRpbWVzIGFuZCB3ZSB3YW50IHRvIGF2b2lkIGhhdmluZyB0byBsb3dlcmNhc2UKCS8vIHRoZSBub2RlTmFtZSBmcm9tIHRoZSBlbGVtZW50IGV2ZXJ5IHRpbWUgdG8gZW5zdXJlIHdlIGhhdmUKCS8vIGEgbWF0Y2guIE5vdGUgdGhhdCB0aGlzIGZ1bmN0aW9uIGxpdmVzIGhlcmUgZm9yIG5vdywgYnV0IG1heQoJLy8gYmUgbW92ZWQgaW50byAkLm1vYmlsZSBpZiBvdGhlciBjb21wb25lbnRzIG5lZWQgYSBzaW1pbGFyIG1ldGhvZC4KCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJaW1nLmFkZENsYXNzKCAidWktbGktdGh1bWIiICk7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaXMoICIudWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMucGFyZW50UGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJdGhpcy5fY3JlYXRlU3ViUGFnZXMoKTsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlzZWxmID0gdGhpcywKCQkJZGl2aWRlcnRoZW1lID0gJGxpc3QuanFtRGF0YSggImRpdmlkZXJ0aGVtZSIgKSB8fCBvLmRpdmlkZXJUaGVtZSwKCQkJbGlzdHNwbGl0dGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAic3BsaXR0aGVtZSIgKSwKCQkJbGlzdHNwbGl0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJzcGxpdGljb24iICksCgkJCWxpc3RpY29uID0gJGxpc3QuanFtRGF0YSggImljb24iICksCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJanNDb3VudCA9ICEkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50ZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWcsIGxpbmtJY29uOwoKCQlpZiAoIG9sICYmIGpzQ291bnQgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCgkJaWYgKCBvbCApIHsKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0KCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCBsaXN0aWNvbiB8fCBvLmljb24sCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0obGFzdC5nZXRFbmNvZGVkVGV4dCgpKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IgoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpc0RpdmlkZXIgKSB7CgoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IGRpdmlkZXJ0aGVtZSApOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsKCQkJCQkJLy9yZXNldCBjb3VudGVyIHdoZW4gYSBkaXZpZGVyIGhlYWRpbmcgaXMgZW5jb3VudGVyZWQKCQkJCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCQkJCWNvdW50ZXIgPSAxOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoJCWNsZWFyQnRuOiBmYWxzZSwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6IG51bGwsIC8vZGVwcmVjYXRpbmcgZm9yIDEuMy4uLgoJCWNsZWFyQnRuVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmljbGFzcyA9IG8ubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJaXNTZWFyY2ggPSBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWZvY3VzZWRFbCwKCQkJY2xlYXJidG4sCgkJCWNsZWFyQnRuVGV4dCA9IG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0IHx8IG8uY2xlYXJCdG5UZXh0LAoJCQljbGVhckJ0bkJsYWNrbGlzdCA9IGlucHV0LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCWlucHV0TmVlZHNDbGVhckJ0biA9ICEhby5jbGVhckJ0biAmJiAhY2xlYXJCdG5CbGFja2xpc3QsCgkJCWlucHV0TmVlZHNXcmFwID0gaW5wdXQuaXMoICJpbnB1dCIgKSAmJiAhaW5wdXQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApOwoKCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQl9LCAwICk7CgkJfQoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIGlzU2VhcmNoICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9IGVsc2UgaWYgKCBpbnB1dE5lZWRzV3JhcCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXRleHQgdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0KCgkJaWYoIGlucHV0TmVlZHNDbGVhckJ0biB8fCBpc1NlYXJjaCApIHsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIGNsZWFyQnRuVGV4dCArICInPiIgKyBjbGVhckJ0blRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCgkJCWlmICggIWlzU2VhcmNoICkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggInBhc3RlIGN1dCBrZXl1cCBpbnB1dCBmb2N1cyBjaGFuZ2UgYmx1ciIsIHRvZ2dsZUNsZWFyICk7CgkJfQoJCWVsc2UgaWYgKCAhaW5wdXROZWVkc1dyYXAgJiYgIWlzU2VhcmNoICkgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwVGltZW91dDsKCgkJCXRoaXMuX2tleXVwID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCQlpbnB1dC5oZWlnaHQoIHNjcm9sbEhlaWdodCAtIHBhZGRpbmdIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQgKTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0Lm9uKCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiwgZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUuZG9jdW1lbnQsIHsgInBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgoJCWlmICggcGFyZW50TmVlZHNEaXNhYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNFbmFibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoKCQlpZiAoIHBhcmVudE5lZWRzRW5hYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclJldmVhbCA9IGZhbHNlOwovLyBUT0RPIHJlbmFtZSBjYWxsYmFjay9kZXByZWNhdGUgYW5kIGRlZmF1bHQgdG8gdGhlIGl0ZW0gaXRzZWxmIGFzIHRoZSBmaXJzdCBhcmd1bWVudAp2YXIgZGVmYXVsdEZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlLCBpdGVtICkgewoJCXJldHVybiB0ZXh0LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKCX07CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsIG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7Cgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJbGlzdC5jaGlsZHJlbigpLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSkuc3VibWl0KCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWFyY2guYmx1cigpOwoJCX0pLAoJCW9uS2V5VXAgPSBmdW5jdGlvbiggZSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxpID0gbGlzdC5jaGlsZHJlbigpLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgoJCQkJaWYgKCAhbGlzdEl0ZW1zLmxlbmd0aCAmJiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgISFsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApOwoJCQl9CgkJCWxpc3R2aWV3Ll9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgbGlzdHZpZXcuX2dldFZpc2libGVzKCBsaSwgZmFsc2UgKSwgZmFsc2UgKTsKCQl9LAoJCXNlYXJjaCA9ICQoICI8aW5wdXQ+IiwgewoJCQlwbGFjZWhvbGRlcjogbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlcgoJCX0pCgkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiwgInNlYXJjaCIgKQoJCS5qcW1EYXRhKCAibGFzdHZhbCIsICIiICkKCQkuYmluZCggImtleXVwIGNoYW5nZSBpbnB1dCIsIG9uS2V5VXAgKQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9OwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogdW5jaGVja2VkU3RhdGUsCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJYWN0aXZlID0gIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPyBhY3RpdmUgOiAiIiApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMuY2hlY2tlZGljb24gfSApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCBjaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLnVuY2hlY2tlZGljb24gfSApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNoZWNrYm94cmFkaW8ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQkvLyBjcmVhdGUgYSBjb3B5IG9mIHRoaXMub3B0aW9ucyB3ZSBjYW4gcGFzcyB0byBidXR0b25NYXJrdXAKCQkJbyA9ICggZnVuY3Rpb24oIHRkbyApIHsKCQkJCXZhciBrZXksIHJldCA9IHt9OwoKCQkJCWZvciAoIGtleSBpbiB0ZG8gKSB7CgkJCQkJaWYgKCB0ZG9bIGtleSBdICE9PSBudWxsICYmIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCQkJCXJldFsga2V5IF0gPSB0ZG9bIGtleSBdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gcmV0OwoJCQl9ICkoIHRoaXMub3B0aW9ucyApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gZ2V0IHRoZSBpbmhlcml0ZWQgdGhlbWUKCQkvLyBUT0RPIGNlbnRyYWxpemUgZm9yIGFsbCB3aWRnZXRzCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQlpZiAoIGNsYXNzZXMgKSB7CgkJCQljbGFzc2VzICs9ICIgdWktc3VibWl0IjsKCQkJfSBlbHNlIHsKCQkJCWNsYXNzZXMgPSAidWktc3VibWl0IjsKCQkJfQoJCX0KCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoIG8gKQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wID0ge307CgoJCW9wWyBrZXkgXSA9IHZhbHVlOwoJCWlmICgga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJdGhpcy5idXR0b24uYnV0dG9uTWFya3VwKCBvcCApOwoJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlciggIl9zZXRPcHRpb24iLCBrZXksIHZhbHVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzU2VsZWN0ID0gdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGNUeXBlID09PSAic2VsZWN0IiwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCQkJbWluID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlcjsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gW3RoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyICIgOiAidWktc2xpZGVyLXRyYWNrICIsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCIsIG1pbmlDbGFzc10uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogInNsaWRlciIsCgkJCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCQkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIHZhciBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgc2xpZGVyVGhlbWUsICIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4ICsgdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci10cmFjayIsIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgKCB0aGlzLm9wdGlvbnMubWluaSApID8gIiB1aS1taW5pIjoiIl0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pOwoKCQl2YXIgcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2gsCgkJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLAoJCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJdmFyIHBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJZGlzYWJsZWQ6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Vjb25kTGFiZWwsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9XCJ1aS1yYW5nZXNsaWRlci1zbGlkZXJzXCIgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJaWYgKCAkZWwuZmluZCggImxhYmVsIiApLmxlbmd0aCA+IDEgKSB7CgkJCQlzZWNvbmRMYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkubGFzdCgpLmhpZGUoKTsKCQkJfQoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJbGFiZWwucHJlcGVuZFRvKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgoJCQlpZiggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKXsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICkuZmluZCggImxhYmVsIiApLnNob3coKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0pOwoKJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS5yYW5nZXNsaWRlciwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5yYW5nZXNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luU2l6ZSwgc2VnU2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJdmFyIHJldCA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJfSBlbHNlIHsKCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJfQoKCXJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93OwoKCXJldHVybiB7CgkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkd2luLndpZHRoKCkgKSwKCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCWUucHJldmVudERlZmF1bHQoKTsKCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIGUgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCXdpbkNvb3Jkcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy55ICYmCgkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQl3aW5Db29yZHM6IHdpbkNvb3JkcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHNlbGYuX2lnbm9yZVJlc2l6ZVRvID0gMDsgfSwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHRndCA9IGUudGFyZ2V0LCAkdGd0LCB1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGd0ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJJHRndCA9ICQoIGUudGFyZ2V0ICk7CgkJCWlmICggMCA9PT0gJHRndC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCSR0Z3QuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9ICR0Z3Q7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB7CgkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuJz48L2Rpdj4iICkKCQkJfSwKCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlteUlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJa2V5LCB2YWx1ZTsKCgkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQlvLmhpc3RvcnkgPSBvLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQl0aGlzUGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkvLyBUT0RPIHRoaXMgd291bGQgYmUgbmljZSBhdCB0aGUgdGhlIG1vYmlsZSB3aWRnZXQgbGV2ZWwKCQlvLmNvbnRhaW5lciA9IG8uY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXIgfHwgdGhpc1BhZ2U7CgoJCS8vIEFwcGx5IHRoZSBwcm90bwoJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJaWYgKCBteUlkICkgewoJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQl1aS5mb2N1c0VsZW1lbnQgPSB1aS5jb250YWluZXI7CgoJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCV91aTogdWksCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCS8vIFRoaXMgZHVwbGljYXRlcyB0aGUgY29kZSBmcm9tIHRoZSB2YXJpb3VzIG9wdGlvbiBzZXR0ZXJzIGJlbG93IGZvcgoJCS8vIGJldHRlciBwZXJmb3JtYW5jZS4gSXQgbXVzdCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aG9zZSBzZXR0ZXJzLgoJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgby50aGVtZSwgImJvZHkiICk7CgkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCBvLm92ZXJsYXlUaGVtZSwgIm92ZXJsYXkiICk7CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvLnRyYW5zaXRpb24gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvLnNoYWRvdyApCgkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvLmNvcm5lcnMgKTsKCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG8udG9sZXJhbmNlICk7CgoJCXVpLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgJC5wcm94eSggdGhpcywgIl9lYXRFdmVudEFuZENsb3NlIiApICk7CgoJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJfSk7CgkJdGhpcy5fb24oICQubW9iaWxlLmRvY3VtZW50LCB7CgkJCWZvY3VzaW46ICQucHJveHkoIHRoaXMsICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiApCgkJfSk7Cgl9LAoKCV9hcHBseVRoZW1lOiBmdW5jdGlvbiggZHN0LCB0aGVtZSwgcHJlZml4ICkgewoJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCWN1cnJlbnRUaGVtZSA9IG51bGwsCgkJCW1hdGNoZXMsCgkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQl3aGlsZSAoIGNsYXNzZXMubGVuZ3RoID4gMCApIHsKCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQlpZiAoIG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAxICkgewoJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJYnJlYWs7CgkJCX0gZWxzZSB7CgkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQl9CgkJfQoKCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJaWYgKCAhICggdGhlbWUgPT09IG51bGwgfHwgdGhlbWUgPT09ICJub25lIiApICkgewoJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgdmFsdWUsICJib2R5IiApOwoJfSwKCglfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCB2YWx1ZSwgIm92ZXJsYXkiICk7CgoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQl9Cgl9LAoKCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJfQoJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCX0KCX0sCgoJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCX0KCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCXZhcgoJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJcmMgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQljeDogd2luQ29vcmRzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX0sCgkJCW1lbnVTaXplLCByZXQ7CgoJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQltZW51U2l6ZSA9IHsKCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCX07CgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQlyZXQgPSB7CgkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCX07CgoJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkvLyBmaXggZm9yICQubW9iaWxlLmRvY3VtZW50LmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCWRvY0hlaWdodCA9IE1hdGgubWF4KCBkb2NFbC5jbGllbnRIZWlnaHQsIGRvY0JvZHkuc2Nyb2xsSGVpZ2h0LCBkb2NCb2R5Lm9mZnNldEhlaWdodCwgZG9jRWwuc2Nyb2xsSGVpZ2h0LCBkb2NFbC5vZmZzZXRIZWlnaHQgKTsKCgkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07Cgl9LAoKCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgYW5kIHNlbGYuX3ByZXJlcXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluCgkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJLy8gbmV4dCB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZCB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoCgkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJLy8gLSBtYWtpbmcgaXQgc3RhbGUuIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlIHNlbGYuX3ByZXJlcXMgZW5zdXJlcyB0aGF0CgkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJc2VsZi5fcHJlcmVxcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG8gKSB7CgkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksIHggPSBvLngsIHkgPSBvLnksIHBUbyA9IG8ucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0gZWxzZSB7CgkJCQl0cnkgewoJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJfSBjYXRjaCggZSApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJfQoJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJbyA9IHsgeDogby54LCB5OiBvLnksIHBvc2l0aW9uVG86IG8ucG9zaXRpb25UbyB9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgbyApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3JkcyggbyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCQl9Cgl9LAoKCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG8gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG8udHJhbnNpdGlvbjsKCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG8udHJhbnNpdGlvbiApOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCB0aGlzLl9wYWdlLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5fcGFnZSwgImMiICkgKTsKCQl9CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOgoJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQl0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjoKCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogby50cmFuc2l0aW9uLAoJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCX0pOwoJfSwKCglfY2xvc2VQcmVyZXFTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIKCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7Cgl9LAoKCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyID0gdGhpcy5fdWkuY29udGFpbmVyOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldFRoZW1lKCAibm9uZSIgKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQl0aGlzLmNsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJfQoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsIG8gPSB0aGlzLm9wdGlvbnMsIGltbWVkaWF0ZSA9IGZhbHNlOwoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggZSAmJiBlLnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQlvLmNvbnRhaW5lci51bmJpbmQoIG8uY2xvc2VFdmVudHMgKTsKCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIG8uY2xvc2VMaW5rU2VsZWN0b3IsIG8uY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5vcHRpb25zLmNvbnRhaW5lcgoJCQkub25lKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiggISggb3B0cy5oaXN0b3J5ICkgKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJc2VsZi5lbGVtZW50CgkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJaWYgKCBoYXNIYXNoICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkkKHdpbmRvdykub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCX0pOwoKCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHtyb2xlOiAiZGlhbG9nIn0gKTsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9Cgl9Cn0pOwoKCi8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCXZhciBjbG9zZXN0UGFnZSA9ICRsaW5rLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkvLyAgICAgIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQlvZmZzZXQ7CgoJaWYgKCBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQl9KTsKCX0KCgkvL3JlbW92ZSBhZnRlciBkZWxheQoJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJLy8gQ2hlY2sgaWYgd2UgYXJlIGluIGEgbGlzdHZpZXcKCQl2YXIgJHBhcmVudCA9ICRsaW5rLnBhcmVudCgpLnBhcmVudCgpOwoJCWlmICgkcGFyZW50Lmhhc0NsYXNzKCJ1aS1saSIpKSB7CgkJCSRsaW5rID0gJHBhcmVudC5wYXJlbnQoKTsKCQl9CgkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7Cgl9LCAzMDAgKTsKfTsKCi8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCWUucHJldmVudERlZmF1bHQoKTsKCX0KfSk7CgokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJb3JpZ0Rlc3Ryb3kgPSB3aWRnZXQuX2Rlc3Ryb3ksCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJcHJlZml4ID0gKCBzZWxlY3RJRCA/IHNlbGVjdElEIDogKCAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidXVpZC0iICsgd2lkZ2V0LnV1aWQgKSApLAoJCQlwb3B1cElEID0gcHJlZml4ICsgIi1saXN0Ym94IiwKCQkJZGlhbG9nSUQgPSBwcmVmaXggKyAiLWRpYWxvZyIsCgkJCWxhYmVsID0gd2lkZ2V0LmxhYmVsLAoJCQl0aGlzUGFnZSA9IHdpZGdldC5zZWxlY3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlzZWxlY3RPcHRpb25zID0gd2lkZ2V0Ll9zZWxlY3RPcHRpb25zKCksCgkJCWlzTXVsdGlwbGUgPSB3aWRnZXQuaXNNdWx0aXBsZSA9IHdpZGdldC5zZWxlY3RbIDAgXS5tdWx0aXBsZSwKCQkJYnV0dG9uSWQgPSBzZWxlY3RJRCArICItYnV0dG9uIiwKCQkJbWVudUlkID0gc2VsZWN0SUQgKyAiLW1lbnUiLAoJCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgaWQ9JyIgKyBkaWFsb2dJRCArICInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElEICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZSIsIHdpZGdldC5vcHRpb25zLmRpdmlkZXJUaGVtZSApCgkJCQkJLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoKCQkJaGVhZGVyID0gJCggIjxkaXY+IiwgewoJCQkJImNsYXNzIjogInVpLWhlYWRlciB1aS1iYXItIiArIHdpZGdldC5vcHRpb25zLnRoZW1lCgkJCX0pLnByZXBlbmRUbyggbGlzdGJveCApLAoKCQkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS10aXRsZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApLAoKCQkJbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLAoJCQloZWFkZXJDbG9zZTsKCgkJaWYgKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElEOiBwb3B1cElELAoJCQlkaWFsb2dJRDogZGlhbG9nSUQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCWVzY2FwZUlkID0gZnVuY3Rpb24oIGlkICkgewoJCQkJCQlyZXR1cm4gaWQucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCQkJfTsKCgkJCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJCQlzZWxmLnJlZnJlc2goKTsKCgkJCQlpZiAoIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2Ugc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCQkJLy8gbm9uZSBwcmVzZW50LgoJCQkJCXNlbGYuX29yaWdUYWJJbmRleCA9ICggc2VsZi5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiBzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCQlzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCQkJfSk7CgoJCQkJLy8gQnV0dG9uIGV2ZW50cwoJCQkJc2VsZi5idXR0b24uYmluZCggInZjbGljayBrZXlkb3duIiAsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCB8fCBzZWxmLmlzT3BlbiApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5fZGVjaWRlRm9ybWF0KCk7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBlc2NhcGVJZCggc2VsZi5wb3B1cElEICkgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgZXNjYXBlSWQoIHNlbGYuZGlhbG9nSUQgKSApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJCQkJfQoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdXQiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJCW5ld0luZGV4ID0gc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmluZGV4KCB0aGlzICksCgkJCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCSQoIHRoaXMgKS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCQkJfQoKCQkJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCQl9CgoJCQkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0KCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSkKCQkJCQkua2V5ZG93bihmdW5jdGlvbiggZXZlbnQgKSB7ICAvL2tleWJvYXJkIGV2ZW50cyBmb3IgbWVudSBpdGVtcwoJCQkJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQkJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICksCgkJCQkJCQlwcmV2LCBuZXh0OwoKCQkJCQkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCQkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmICggcHJldi5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCXByZXYgPSBwcmV2LnByZXYoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBwcmV2Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQlwcmV2LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiAoIG5leHQuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQluZXh0ID0gbmV4dC5uZXh0KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJY2FzZSAxMzoKCQkJCQkJY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJfQoKCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5idXR0b24uY2xpY2soKTsKCQkJfSwKCgkJCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIGEiICk7CgkJCQkJfQoJCQkJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gub25lKCAicG9wdXBhZnRlcm9wZW4iLCBmb2N1c01lbnVJdGVtICk7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJCQl9CgkJCQkJfQoKCQkJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgnYXJpYS1kaXNhYmxlZCcsdHJ1ZSk7CgkJCQkJfQoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLGkgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJfQoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0sCgoJCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgoJCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCQl0aGlzLm1lbnVQYWdlLnJlbW92ZSgpOwoKCQkJCS8vIENoYWluIHVwCgkJCQlvcmlnRGVzdHJveS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlciBldmVudHMgb24gZGlzYWJsZWQgZGVsZWdhdGVzCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJtb2JpbGUtc2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250cm9sZ3JvdXAiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgkJb3B0aW9uczogewoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQl0eXBlOiAidmVydGljYWwiLAoJCQltaW5pOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQl1aSA9IHsKCQkJCQlpbm5lcjogJCggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApLAoJCQkJCWxlZ2VuZDogJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQl9LAoJCQkJZ3JvdXBsZWdlbmQgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQkkZWwud3JhcElubmVyKCB1aS5pbm5lciApOwoJCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJCXVpLmxlZ2VuZC5hcHBlbmQoIGdyb3VwbGVnZW5kICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oIDAgKSApOwoJCQl9CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIiApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgkJfSwKCgkJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUeXBlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArIHZhbHVlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9LAoKCQljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyIGVscyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQkJfQoJCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsIHRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsIGNyZWF0ZSApOwoJCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJCX0KCX0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCgkvLyBUT0RPOiBJbXBsZW1lbnQgYSBtZWNoYW5pc20gdG8gYWxsb3cgd2lkZ2V0cyB0byBiZWNvbWUgZW5oYW5jZWQgaW4gdGhlCgkvLyBjb3JyZWN0IG9yZGVyIHdoZW4gdGhlaXIgY29ycmVjdCBlbmhhbmNlbWVudCBkZXBlbmRzIG9uIG90aGVyIHdpZGdldHMgaW4KCS8vIHRoZSBwYWdlIGJlaW5nIGNvcnJlY3RseSBlbmhhbmNlZCBhbHJlYWR5LgoJLy8KCS8vIEZvciBub3csIHdlIHdhaXQgdW50aWwgZG9tLXJlYWR5IHRvIGF0dGFjaCB0aGUgY29udHJvbGdyb3VwJ3MgZW5oYW5jZW1lbnQKCS8vIGhvb2ssIGJlY2F1c2UgYnkgdGhhdCB0aW1lLCBhbGwgdGhlIG90aGVyIHdpZGdldHMnIGVuaGFuY2VtZW50IGhvb2tzIHNob3VsZAoJLy8gYWxyZWFkeSBiZSBpbiBwbGFjZSwgZW5zdXJpbmcgdGhhdCBhbGwgd2lkZ2V0cyB0aGF0IG5lZWQgdG8gYmUgZ3JvdXBlZCB3aWxsCgkvLyBhbHJlYWR5IGhhdmUgYmVlbiBlbmhhbmNlZCBieSB0aGUgdGltZSB0aGUgY29udHJvbGdyb3VwIGlzIGNyZWF0ZWQuCgkkKCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJCSQubW9iaWxlLmNvbnRyb2xncm91cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCQl9KTsKCX0pOwp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlID0gdGhpcywKCQkJCWhyZWYgPSAkKCB0aGlzICkuYXR0ciggImhyZWYiICksCgkJCQlpZHJlZiA9IGhyZWYuc3Vic3RyaW5nKCAxICk7CgoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJJCggZG9jdW1lbnQgKQoJCQkJLm9uKCAicG9wdXBhZnRlcm9wZW4iLCBocmVmLCBmdW5jdGlvbigpIHsKCQkJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCB0cnVlICk7CgkJCQl9KQoJCQkJLm9uKCAicG9wdXBhZnRlcmNsb3NlIiwgaHJlZiwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJCX0pOwoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfdGhpc1BhZ2U6IG51bGwKCQkJfSk7CgoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaXMoICIudWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHRoaXMuX3RoaXNQYWdlLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggIW8udmlzaWJsZU9uUGFnZVNob3cgKSB7CgkJCQl0aGlzLmhpZGUoIHRydWUgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVBbmltYXRpb25TdGFydDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCksCgkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4KCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLl90aGlzUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciI7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0YnR5cGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0YnR5cGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoJ2luJyk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQubW9iaWxlLmRvY3VtZW50CgkJLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiAoICQoIGUudGFyZ2V0ICkuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkKCAkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5vdCggIjpqcW1EYXRhKGZ1bGxzY3JlZW4pIiApLmpxbURhdGEoICJmdWxsc2NyZWVuIiwgdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7CgkJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLmZpeGVkdG9vbGJhciwgewoKCQkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQkJfSwKCgkJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJb3MgPSBudWxsLAoJCQkJc2VsZiA9IHRoaXM7CgkJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiaW9zIjsKCQkJCX0gZWxzZSBpZiggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApewoJCQkJCW9zID0gImFuZHJvaWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIG9zID09PSAiaW9zIiApIHsKCQkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIGlmKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfSwKCgkJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoJGVsLm9mZnNldCgpLnRvcCAtICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSk7CgkJCQlpZiggIWhlYWRlciApIHsKCQkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKG9mZnNldCAtICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpKS02MDsKCQkJCX0KCQkJCXJldHVybiBvZmZzZXQ7CgkJCX0sCgoJCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uCgkJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQkJaWYoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlKSB7CgkJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCQl9CgkJCQl9fSk7CgkJCX0sCgoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZSIpLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQkJfSwKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkKCQkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyJweCIgKTsKCQkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQkJfSwgMCApOwoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLngKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZS1hY3RpdmUiKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCQl9Cgl9KTsKCgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZVBhbmVsOiAidWktcGFnZS1wYW5lbCIsCgkJCXBhZ2VQYW5lbE9wZW46ICJ1aS1wYWdlLXBhbmVsLW9wZW4iLAoJCQljb250ZW50V3JhcDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcCIsCgkJCWNvbnRlbnRXcmFwT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1vcGVuIiwKCQkJY29udGVudFdyYXBDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtY2xvc2VkIiwKCQkJY29udGVudEZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhciIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLW9wZW4iLAoJCQljb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLWNsb3NlZCIsCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogImMiLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwYW5lbCcpIiwKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXI6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCXBhZ2UgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX2dldFBhZ2VUaGVtZSA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGVtZSA9ICQuZGF0YSggcGFnZVswXSwgIm1vYmlsZVBhZ2UiICkub3B0aW9ucy50aGVtZSwKCQkJCSRwYWdlVGhlbWVDbGFzcyA9ICJ1aS1ib2R5LSIgKyAkdGhlbWU7CgkJCQlyZXR1cm4gJHBhZ2VUaGVtZUNsYXNzOwoJCQl9LAoJCQlfZ2V0UGFuZWxJbm5lciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRwYW5lbElubmVyID0gJGVsLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCQkJCWlmICggJHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRwYW5lbElubmVyID0gJGVsLmNoaWxkcmVuKCkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQl9CgkJCQlyZXR1cm4gJHBhbmVsSW5uZXI7CgkJCX0sCgkJCV9nZXRXcmFwcGVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHdyYXBwZXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQlpZiAoICR3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkd3JhcHBlciA9IHBhZ2UuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKyAnICcgKyBfZ2V0UGFnZVRoZW1lKCkgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkd3JhcHBlci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkd3JhcHBlcjsKCQkJfSwKCQkJX2dldEZpeGVkVG9vbGJhciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCWlmICggJGZpeGVkVG9vbGJhci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJGZpeGVkVG9vbGJhci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkZml4ZWRUb29sYmFyOwoJCQl9OwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogJGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogJGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYWdlOiAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX3BhZ2VUaGVtZTogX2dldFBhZ2VUaGVtZSgpLAoJCQlfcGFuZWxJbm5lcjogX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IF9nZXRXcmFwcGVyKCksCgkJCV9maXhlZFRvb2xiYXI6IF9nZXRGaXhlZFRvb2xiYXIoKQoJCX0pOwoKCQlzZWxmLl9hZGRQYW5lbENsYXNzZXMoKTsKCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCXNlbGYuX2ZpeGVkVG9vbGJhci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCS8vIGFkZCBjbGFzcyB0byBwYWdlIHNvIHdlIGNhbiBzZXQgIm92ZXJmbG93LXg6IGhpZGRlbjsiIGZvciBpdCB0byBmaXggQW5kcm9pZCB6b29tIGlzc3VlCgkJc2VsZi5fcGFnZS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMucGFnZVBhbmVsICk7CgoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCgkJc2VsZi5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXNlbGYuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXNlbGYuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJc2VsZi5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXNlbGYuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0aGlzLl9wYWdlICk7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKCBlICkgewoJCQlzZWxmLmNsb3NlKCk7CgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhbmVsSW5uZXJIZWlnaHQgPSBzZWxmLl9wYW5lbElubmVyLm91dGVySGVpZ2h0KCksCgkJCWV4cGFuZCA9IHBhbmVsSW5uZXJIZWlnaHQgPiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYgKCBleHBhbmQgfHwgIXNlbGYub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlpZiAoIGV4cGFuZCApIHsKCQkJCXNlbGYuX3VuZml4UGFuZWwoKTsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCggcGFuZWxJbm5lckhlaWdodCApOwoJCQl9CgkJCXNlbGYuX3Njcm9sbEludG9WaWV3KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIHBhbmVsSW5uZXJIZWlnaHQgKSB7CgkJaWYgKCBwYW5lbElubmVySGVpZ2h0IDwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMCApOwoJCX0KCX0sCgoJX2JpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICQoIHdpbmRvdyApLCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAiX3Bvc2l0aW9uUGFuZWwiIH0pOwoJfSwKCglfdW5iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29mZiggJCggd2luZG93ICksICJ0aHJvdHRsZWRyZXNpemUiICk7Cgl9LAoKCV91bmZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2ZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2JpbmRVcGRhdGVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5lbGVtZW50Lm9uKCAidXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fcGFnZS5vbiggImNsaWNrLnBhbmVsIiAsICJhIiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5ocmVmLnNwbGl0KCAiIyIgKVsgMSBdID09PSBzZWxmLl9wYW5lbElEICYmIHNlbGYuX3BhbmVsSUQgIT09IHVuZGVmaW5lZCApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQkkcGFyZW50OwoJCQkJaWYgKCAhICRsaW5rLmhhc0NsYXNzKCAidWktbGluayIgKSApIHsKCQkJCQkvLyBDaGVjayBpZiB3ZSBhcmUgaW4gYSBsaXN0dmlldwoJCQkJCSRwYXJlbnQgPSAkbGluay5wYXJlbnQoKS5wYXJlbnQoKTsKCQkJCQlpZiAoICRwYXJlbnQuaGFzQ2xhc3MoICJ1aS1saSIgKSApIHsKCQkJCQkJJGxpbmsgPSAkcGFyZW50LnBhcmVudCgpOwoJCQkJCX0KCQkJCQkkbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQlzZWxmLmVsZW1lbnQub25lKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJfSk7CgkJCQl9CgkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX3BhZ2UKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gY2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJCS5vbiggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkvLyBvbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJfSwKCgkvLyBzdGF0ZSBzdG9yYWdlIG9mIG9wZW4gb3IgY2xvc2VkCglfb3BlbjogZmFsc2UsCgoJX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXM6IG51bGwsCglfZml4ZWRUb29sYmFyT3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fcGFnZS5vZmYoICJwYW5lbGNsb3NlIiApOwoJCQkJCXNlbGYuX3BhZ2UuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZQoJCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJLy8gRml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCBzZWxmLl9wYWdlLmNzcyggIm1pbi1oZWlnaHQiICkgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCgkJCQkJc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMubW9kYWwgKSArICIgIiArIG8uY2xhc3Nlcy5tb2RhbE9wZW47CgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoKCQkJCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgoJCQlpZiAoIHNlbGYuX3BhZ2UuanFtRGF0YSgncGFuZWwnKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5fcGFnZS5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkJc2VsZiA9IHRoaXMsCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApOwoJCQkJCQkvLyByZXNldCBmaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCAiIiApOwoJCQkJCX0KCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoJCQkJfTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaGFzT3RoZXJTaWJsaW5nUGFuZWxzID0gdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiLiIgKyBjbGFzc2VzLnBhbmVsICkubGVuZ3RoOwoKCQkvLyBjcmVhdGUKCQlpZiAoICFoYXNPdGhlclNpYmxpbmdQYW5lbHMgKSB7CgkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJdGhpcy5fcGFnZS5maW5kKCAiYSIgKS51bmJpbmQoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQkJfQoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9IGVsc2UgaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQl0aGlzLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQlpZiAoIHRoZW1lICkgewoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQl9CgkJfQoKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgY2xhc3Nlcy5wYW5lbEFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICk7CgoJCXRoaXMuX2Nsb3NlTGluay5vZmYoICJjbGljay5wYW5lbCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoKCQkvLyBvcGVuIGFuZCBjbG9zZQoJCXRoaXMuZWxlbWVudC5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKQoJCQkucmVtb3ZlQ2xhc3MoIFsgY2xhc3Nlcy5wYW5lbFVuZml4ZWQsIGNsYXNzZXMucGFuZWxDbG9zZWQsIGNsYXNzZXMucGFuZWxPcGVuIF0uam9pbiggIiAiICkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnBhbmVsLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQljbGFzc2VzOiB7CgkJCQl0YWJsZTogInVpLXRhYmxlIgoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSd0YWJsZScpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYucmVmcmVzaCggdHJ1ZSApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uIChjcmVhdGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJCWlmICggY3JlYXRlICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCQl9CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJc2VsZi5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heSBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCXNlbGYuYWxsSGVhZGVycyA9IHNlbGYuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7CgoJCQl0cnMuZWFjaChmdW5jdGlvbigpewoKCQkJCXZhciBjb2x0YWxseSA9IDA7CgoJCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbiggaSApewoKCQkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCXNlbCA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNvbHN0YXJ0IiwgY29sdGFsbHkgKyAxICk7CgoJCQkJCWlmKCBzcGFuICl7CgkJCQkJCWZvciggdmFyIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApewoJCQkJCQkJY29sdGFsbHkrKzsKCQkJCQkJCXNlbCArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkKHRoaXMpLmpxbURhdGEoImNlbGxzIiwgIiIpOwoJCQkJCX0KCQkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNlbGxzIiwgc2VsZi5lbGVtZW50LmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSgwKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWwgKSApOwoKCQkJCQljb2x0YWxseSsrOwoKCQkJCX0pOwoKCQkJfSk7CgoJCQkvLyB1cGRhdGUgdGFibGUgbW9kZXMKCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAncmVmcmVzaCcgKTsKCQkJfQoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gImNvbHVtbnRvZ2dsZSI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5Qb3B1cFRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRleHQgPSAiQ29sdW1ucy4uLiI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCWV2ZW50ID0gZS50eXBlLAoJCW8gPSBzZWxmLm9wdGlvbnMsCgkJbnMgPSAkLm1vYmlsZS5ucywKCQlpZCA9ICggJHRhYmxlLmF0dHIoICJpZCIgKSB8fCBvLmNsYXNzZXMucG9wdXAgKSArICItcG9wdXAiLCAvKiBUT0RPIEJFVFRFUiBGQUxMQkFDSyBJRCBIRVJFICovCgkJJG1lbnVCdXR0b24sCgkJJHBvcHVwLAoJCSRtZW51LAoJCSRzd2l0Y2hib2FyZDsKCglpZiAoIG8ubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoKCQkkbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY29sdW1uQnRuICsgIicgZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAibWluaT0ndHJ1ZSc+IiArIG8uY29sdW1uQnRuVGV4dCArICI8L2E+IiApLAoJCSRwb3B1cCA9ICQoICI8ZGl2IGRhdGEtIiArIG5zICsgInJvbGU9J3BvcHVwJyBkYXRhLSIgKyBucyArICJyb2xlPSdmaWVsZGNvbnRhaW4nIGNsYXNzPSciICsgby5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIpLAoJCSRtZW51ID0gJCgiPGZpZWxkc2V0IGRhdGEtIiArIG5zICsgInJvbGU9J2NvbnRyb2xncm91cCc+PC9maWVsZHNldD4iKTsKCX0KCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglzZWxmLmhlYWRlcnMubm90KCAidGQiICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJdmFyIHByaW9yaXR5ID0gJCggdGhpcyApLmpxbURhdGEoICJwcmlvcml0eSIgKSwKCQkJJGNlbGxzID0gJCggdGhpcyApLmFkZCggJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQlpZiAoIHByaW9yaXR5ICkgewoKCQkJJGNlbGxzLmFkZENsYXNzKCBvLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCQkJJCgiPGxhYmVsPjxpbnB1dCB0eXBlPSdjaGVja2JveCcgY2hlY2tlZCAvPiIgKyAkKCB0aGlzICkudGV4dCgpICsgIjwvbGFiZWw+IiApCgkJCQkJLmFwcGVuZFRvKCAkbWVudSApCgkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkuanFtRGF0YSggImNlbGxzIiwgJGNlbGxzICkKCQkJCQkuY2hlY2tib3hyYWRpbyh7CgkJCQkJCXRoZW1lOiBvLmNvbHVtblBvcHVwVGhlbWUKCQkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQoICcjJyArIGlkICsgJyBmaWVsZHNldCBkaXY6ZXEoJyArIGkgKycpJykuZmluZCgnaW5wdXQnKS5qcW1EYXRhKCAnY2VsbHMnLCAkY2VsbHMgKTsKCQkJfQoJCX0KCX0pOwoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkbWVudS5hcHBlbmRUbyggJHBvcHVwICk7Cgl9CgoJLy8gYmluZCBjaGFuZ2UgZXZlbnQgbGlzdGVuZXJzIHRvIGlucHV0cyAtIFRPRE86IG1vdmUgdG8gYSBwcml2YXRlIG1ldGhvZD8KCWlmICggJG1lbnUgPT09IHVuZGVmaW5lZCApIHsKCQkkc3dpdGNoYm9hcmQgPSAkKCcjJyArIGlkICsgJyBmaWVsZHNldCcpOwoJfSBlbHNlIHsKCQkkc3dpdGNoYm9hcmQgPSAkbWVudTsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJHN3aXRjaGJvYXJkLm9uKCAiY2hhbmdlIiwgImlucHV0IiwgZnVuY3Rpb24oIGUgKXsKCQkJaWYoIHRoaXMuY2hlY2tlZCApewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApOwoJCQl9CgkJfSk7CgoJCSRtZW51QnV0dG9uCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8uY29sdW1uQnRuVGhlbWUKCQkJfSk7CgoJCSRwb3B1cAoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkucG9wdXAoKTsKCX0KCgkvLyByZWZyZXNoIG1ldGhvZAoJc2VsZi51cGRhdGUgPSBmdW5jdGlvbigpewoJCSRzd2l0Y2hib2FyZC5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMuY2hlY2tlZCkgewoJCQkJdGhpcy5jaGVja2VkID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5lcSgwKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCQlpZiAoZXZlbnQgPT09ICJyZWZyZXNoIikgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtdmlzaWJsZScpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC1oaWRkZW4nKTsKCQkJfQoJCQkkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9OwoKCSQubW9iaWxlLndpbmRvdy5vbiggInRocm90dGxlZHJlc2l6ZSIsIHNlbGYudXBkYXRlICk7CgoJc2VsZi51cGRhdGUoKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gInJlZmxvdyI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlldmVudCA9IGUudHlwZSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJbyA9IHNlbGYub3B0aW9uczsKCgkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCglpZiggby5tb2RlICE9PSAicmVmbG93IiApewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCX0KCgkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCXZhciByZXZlcnNlSGVhZGVycyA9ICAkKCBzZWxmLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICk7CgoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJcmV2ZXJzZUhlYWRlcnMuZWFjaChmdW5jdGlvbiggaSApewoJCXZhciAkY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQljb2xzdGFydCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY29sc3RhcnQiICksCgkJCWhpZXJhcmNoeUNsYXNzID0gJGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJdGV4dCA9ICQodGhpcykudGV4dCgpOwoKCQkJaWYoIHRleHQgIT09ICIiICApewoKCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApewoJCQkJCXZhciBpdGVyYXRpb24gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJaWYoIGl0ZXJhdGlvbiApewoJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJfQoJCQkJCSRjZWxscy5maWx0ZXIoIGZpbHRlciApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRjZWxscy5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoKCQkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJaWYoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICl7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCl7CgkJaWYoICQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCApewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpIHsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBmaW5kIGFuZCBlbmhhbmNlIHRoZSBwYWdlcyBpbiB0aGUgZG9tIGFuZCB0cmFuc2l0aW9uIHRvIHRoZSBmaXJzdCBwYWdlLgoJCWluaXRpYWxpemVQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gZmluZCBwcmVzZW50IHBhZ2VzCgkJCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQkJCSRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9IHBhdGguc3RyaXBIYXNoKCBwYXRoLnN0cmlwUXVlcnlQYXJhbXMocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAnOmpxbURhdGEocm9sZT0icGFnZSIpJyApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjMuMgoqIEdpdCBIRUFEIGhhc2g6IDUyOGNmMGU5Njk0MDY0NGVhNjQ0MDk2YmZlYjkxM2VkOTIwZmZhZWYgPD4gRGF0ZTogRnJpIEp1bCAxOSAyMDEzIDIyOjE3OjU3IFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwovLyBiYWNrdXAgZGVmaW5lCnZhciBfZGVmaW5lID0gZGVmaW5lOwovLyBoYWNrIGRlZmluZQpkZWZpbmUgPSBmdW5jdGlvbihkZXBzLCBmbil7CiAgICBfZGVmaW5lKGRlcHMsIGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gc2F2ZSBhcmd1bWVudHMgdGhhdCBjb250YWlucyBkZXBzCiAgICAgICAgdmFyIGRlZmluZUFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgLy8gbWFrZSBhIGZ1bmN0aW9uIHRoYXQgb25seSB3aGVuIHRyaWdnZXJlZCBvcGVucyB0aGUgcGFja2FnZQogICAgICAgIHZhciBvcGVuUGFja2FnZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh3aW5kb3csIGRlZmluZUFyZ3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3BlblBhY2thZ2U7CiAgICB9KQogICAgLy8gcmVzdG9yZSB0aGUgZGVmaW5lCiAgICBkZWZpbmUgPSBfZGVmaW5lOwp9CmRlZmluZS5hbWQgPSB0cnVlOwoKCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkICkgewoJJC5tb2JpbGUgPSB7fTsKfSggalF1ZXJ5ICkpOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4zLjIiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudCdzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKCB0aGlzICkudGV4dCgpICkuaHRtbCgpOwoJfTsKCgkvLyBmbHVlbnQgaGVscGVyIGZ1bmN0aW9uIGZvciB0aGUgbW9iaWxlIG5hbWVzcGFjZWQgZXF1aXZhbGVudAoJJC5mbi5qcW1FbmhhbmNlYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJfTsKCgkkLmZuLmpxbUhpamFja2FibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJfTsKCgkvLyBNb25rZXktcGF0Y2hpbmcgU2l6emxlIHRvIGZpbHRlciB0aGUgOmpxbURhdGEgc2VsZWN0b3IKCXZhciBvbGRGaW5kID0gJC5maW5kLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9Owp9KSggalF1ZXJ5LCB0aGlzICk7CgoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgdjEuMTAuMHByZSAtIDIwMTItMTEtMTMgKGZmMDU1YTBjMzUzYzNjOGNlNmU1YmZhMDdhZDdjYjAzZTg4ODViYzUpCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTAsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggOiBuYW1lCgl9LCBwcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9LAoKCXJhaXNlOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93ICJXaWRnZXQgWyIgKyB0aGlzLndpZGdldE5hbWUgKyAiXTogIiArIG1zZzsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBERVBSRUNBVEVECgkvLyBOT1RFIGdsb2JhbCBtb2JpbGUgb2JqZWN0IHNldHRpbmdzCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBERVBSRUNBVEVEIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQgZGVmYXVsdCBtZXNzYWdlIHNldHRpbmcKCQlsb2FkaW5nTWVzc2FnZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVECgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ3Nob3cnLCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKTsKCQl9LAoKCQkvLyBERVBSRUNBVEVECgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUubG9hZGluZyggJ2hpZGUnICk7CgkJfSwKCgkJbG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCXRoaXMubG9hZGVyV2lkZ2V0LmxvYWRlci5hcHBseSggdGhpcy5sb2FkZXJXaWRnZXQsIGFyZ3VtZW50cyApOwoJCX0KCX0pOwoKCS8vIFRPRE8gbW92ZSBsb2FkZXIgY2xhc3MgZG93biBpbnRvIHRoZSB3aWRnZXQgc2V0dGluZ3MKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLCAkaHRtbCA9ICQoICJodG1sIiApLCAkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgJGhlYWRlciwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSh0aGVtZSkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJLy8gcHJlZmVyIG9iamVjdCBwcm9wZXJ0eSBmcm9tIHRoZSBwYXJhbSB0aGVuIHRoZSBvbGQgdGhlbWUgc2V0dGluZwoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbSB2YWx1ZSBwYXNzZWQgYXMgYSBzdHJpbmcgYXJndW1lbnQsIHRoZW4KCQkJCS8vIHdlIHByZWZlciB0aGUgZ2xvYmFsIG9wdGlvbiBiZWNhdXNlIHdlIGNhbid0IHVzZSB1bmRlZmluZWQgZGVmYXVsdAoJCQkJLy8gcHJvdG90eXBlIG9wdGlvbnMsIHRoZW4gdGhlIHByb3RvdHlwZSBvcHRpb24KCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgfHwgbG9hZFNldHRpbmdzLnRleHQ7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSAhPT0gZmFsc2UgfHwgbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkvLyBib29sZWFuIHZhbHVlcyByZXF1aXJlIGEgYml0IG1vcmUgd29yayA6UCwgc3VwcG9ydHMgb2JqZWN0IHByb3BlcnRpZXMKCQkJCS8vIGFuZCBvbGQgc2V0dGluZ3MKCQkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRleHRWaXNpYmxlID0gJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgkJCQl9CgoJCQkJLy8gYWRkIHRoZSBwcm9wZXIgY3NzIGdpdmVuIHRoZSBvcHRpb25zICh0aGVtZSwgdGV4dCwgZXRjKQoJCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoImNsYXNzIiwgbG9hZGVyQ2xhc3MgKwoJCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJCSggbG9hZFNldHRpbmdzLnRleHRvbmx5IHx8IHRleHRvbmx5ID8gIiB1aS1sb2FkZXItdGV4dG9ubHkiIDogIiIgKSApOwoKCQkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCQkvLyBpZiB0aGUgaHRtbCBhdHRyaWJ1dGUgaXMgZGVmaW5lZCBvbiB0aGUgbG9hZGluZyBzZXR0aW5ncywgdXNlIHRoYXQKCQkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJCXRoaXMuZWxlbWVudC5odG1sKCBsb2FkU2V0dGluZ3MuaHRtbCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJCX0KCgkJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkvLyBjaGVjayB0aGF0IHRoZSBsb2FkZXIgaXMgdmlzaWJsZQoJCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJCSR3aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8KLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8KLy8gQWJvdXQ6IExpY2Vuc2UKLy8KLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8KLy8gQWJvdXQ6IEV4YW1wbGVzCi8vCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8KLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLwovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLwovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8KLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8KLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8KLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLwovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAoKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCgogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwoKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8KICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8KICAvLyBVc2FnZToKICAvLwogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLwogIC8vIEFyZ3VtZW50czoKICAvLwogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLwogIC8vIFJldHVybnM6CiAgLy8KICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCgogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLwogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8KICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLwogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLwogIC8vIFVzYWdlOgogIC8vCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwoKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8KICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vCiAgLy8gVXNhZ2U6CiAgLy8KICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCgogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8KICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8KICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4KICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8KICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8KICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPgogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLwogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewoKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CgogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAoKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CgogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KCiAgfSk7CgogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAoKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAoKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24oIHZhbCApIHsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwoKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CgogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CgogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CgogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwoKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwoKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CgogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQoKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwoKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwoKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CgogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CgogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwoKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwoKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwoKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgoKICAgIHJldHVybiBzZWxmOwogIH0pKCk7Cgp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKTsKCglpZiggcmV0ICkgewoJCXJldHVybiAhIXJldDsKCX0KCgl2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXRyYW5zZm9ybXMgPSB7CgkJCS8vIFdl4oCZcmUgb21pdHRpbmcgT3BlcmEgZm9yIHRoZSB0aW1lIGJlaW5nOyBNUyB1c2VzIHVucHJlZml4ZWQuCgkJCSdNb3pUcmFuc2Zvcm0nOictbW96LXRyYW5zZm9ybScsCgkJCSd0cmFuc2Zvcm0nOid0cmFuc2Zvcm0nCgkJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdmFyIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAndHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApJzsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7Cgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8CgkJdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicsIFsgIldlYmtpdCIsICJNb3oiLCAiIiBdICkgJiYKCQkhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAhb3BlcmEsCgoJLy8gTm90ZSwgQ2hyb21lIGZvciBpT1MgaGFzIGFuIGV4dHJlbWVseSBxdWlya3kgaW1wbGVtZW50YXRpb24gb2YgcG9wc3RhdGUuCgkvLyBXZSd2ZSBjaG9zZW4gdG8gdGFrZSB0aGUgc2hvcnRlc3QgcGF0aCB0byBhIGJ1ZyBmaXggaGVyZSBmb3IgaXNzdWUgIzU0MjYKCS8vIFNlZSB0aGUgZm9sbG93aW5nIGxpbmsgZm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSByZWdleCBjaG9zZW4KCS8vIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2Nocm9tZS9tb2JpbGUvZG9jcy91c2VyLWFnZW50I2Nocm9tZV9mb3JfaW9zX3VzZXItYWdlbnQKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCSJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkvLyBXaGVuIHJ1bm5pbmcgaW5zaWRlIGEgRkYgaWZyYW1lLCBjYWxsaW5nIHJlcGxhY2VTdGF0ZSBjYXVzZXMgYW4gZXJyb3IKCQkhKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiRmlyZWZveCIgKSA+PSAwICYmIHdpbmRvdy50b3AgIT09IHdpbmRvdyApICYmCgkJKCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5zZWFyY2goL0NyaU9TLykgPT09IC0xICksCgoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsIGhpc3Rvcnk7CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30sCgkJCQlocmVmID0gbG9jYXRpb24uaHJlZjsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBkYXRhICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2VzICkgewoJCQlpZiggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICl7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgZG9jdW1lbnRCYXNlLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBzdGF0ZSwgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCXBhdGguZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCX07CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGg7CgoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2JhY2snICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgJ2ZvcndhcmQnICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICl7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJaW5pdGlhbEhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCSQubW9iaWxlLk5hdmlnYXRvciA9IGZ1bmN0aW9uKCBoaXN0b3J5ICkgewoJCXRoaXMuaGlzdG9yeSA9IGhpc3Rvcnk7CgkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IHRydWU7CgoJCSQubW9iaWxlLndpbmRvdy5iaW5kKHsKCQkJInBvcHN0YXRlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLnBvcHN0YXRlLCB0aGlzICksCgkJCSJoYXNoY2hhbmdlLmhpc3RvcnkiOiAkLnByb3h5KCB0aGlzLmhhc2hjaGFuZ2UsIHRoaXMgKQoJCX0pOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5OYXZpZ2F0b3IucHJvdG90eXBlLCB7CgkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2ggPSBwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5zdHJpcEhhc2godXJsKSA6IHVybDsKCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBtYWtlIHN1cmUgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uIHdoZW4gaXQgaXNuJ3QgZXhwbGljaXRseSBzZXQgaW4gdGhlCgkJCS8vIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCB0byB0aGUgc3F1YXNoIG1ldGhvZAoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXZhciByZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXRoaXMuc3F1YXNoKCB1cmwsIHN0YXRlICk7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBhY3RpdmUsIGhhc2gsIHN0YXRlLCBjbG9zZXN0SW5kZXg7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKXsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFnczsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCgoJaWYgKCBkaWRTY3JvbGwgJiYgIWRpZENhbmNlbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGZsYWdzICk7Cgl9CgoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW1vdmUiLCBldmVudCwgZmxhZ3MgKTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKCgl2YXIgZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSwKCQl0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2Y2xpY2siLCBldmVudCwgZmxhZ3MgKTsKCQlpZiAoIHZlICYmIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkvLyBUaGUgdGFyZ2V0IG9mIHRoZSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgdGhlIHRvdWNoZW5kCgkJCS8vIGV2ZW50IGRvbid0IG5lY2Vzc2FyaWx5IG1hdGNoIHRoZSB0YXJnZXQgdXNlZCBkdXJpbmcgdGhlCgkJCS8vIHRvdWNoLiBUaGlzIG1lYW5zIHdlIG5lZWQgdG8gcmVseSBvbiBjb29yZGluYXRlcyBmb3IgYmxvY2tpbmcKCQkJLy8gYW55IGNsaWNrIHRoYXQgaXMgZ2VuZXJhdGVkLgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkuY2hhbmdlZFRvdWNoZXNbIDAgXTsKCQkJY2xpY2tCbG9ja0xpc3QucHVzaCh7CgkJCQl0b3VjaElEOiBsYXN0VG91Y2hJRCwKCQkJCXg6IHQuY2xpZW50WCwKCQkJCXk6IHQuY2xpZW50WQoJCQl9KTsKCgkJCS8vIFByZXZlbnQgYW55IG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyBmcm9tIHRyaWdnZXJpbmcKCQkJLy8gdmlydHVhbCBldmVudCBub3RpZmljYXRpb25zLgoJCQlibG9ja01vdXNlVHJpZ2dlcnMgPSB0cnVlOwoJCX0KCX0KCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdXQiLCBldmVudCwgZmxhZ3MpOwoJZGlkU2Nyb2xsID0gZmFsc2U7CgoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhc1ZpcnR1YWxCaW5kaW5ncyggZWxlICkgewoJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCBlbGUsIGRhdGFQcm9wZXJ0eU5hbWUgKSwKCQlrOwoKCWlmICggYmluZGluZ3MgKSB7CgkJZm9yICggayBpbiBiaW5kaW5ncyApIHsKCQkJaWYgKCBiaW5kaW5nc1sgayBdICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGR1bW15TW91c2VIYW5kbGVyKCkge30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRlaHNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKTsKCgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCQlpZiAoIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQl9CgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgoJCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICkKCQkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wICk7CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IHdpbi53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCBlICkgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudC5wYXJlbnQoKSApICk7Cgl9LAoKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudG9nZ2xlQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQtdHJhbnNpdGlvbmluZyB2aWV3cG9ydC0iICsgbmFtZSApOwoJCQl9LAoJCQlzY3JvbGxQYWdlID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRvU2Nyb2xsICk7CgoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCQl9LCAxNTAgKTsKCQkJfSwKCQkJY2xlYW5Gcm9tID0gZnVuY3Rpb24oKSB7CgkJCQkkZnJvbQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCQkJfSwKCQkJc3RhcnRPdXQgPSBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgkJCQkJZG9uZU91dCgpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVPdXQgKTsKCQkJCX0KCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy8gTk9URTogcGF0aCBleHRlbnNpb25zIGRlcGVuZGVudCBvbiBjb3JlIGF0dHJpYnV0ZXMuIE1vdmVkIGhlcmUgdG8gcmVtb3ZlIGRlcHMgZnJvbQoJCS8vICAgICAgICQubW9iaWxlLnBhdGggZGVmaW5pdGlvbgoJCXBhdGggPSAkLmV4dGVuZCgkLm1vYmlsZS5wYXRoLCB7CgoJCQkvL3JldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcgYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAnJicgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy9jaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZCBvZiB0aGUKCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCWRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9KSwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbCwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLmRvY3VtZW50VXJsLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9IHBhdGguZG9jdW1lbnRCYXNlLAoKCQkvL2NhY2hlIHRoZSBjb21wYXJpc29uIG9uY2UuCgkJZG9jdW1lbnRCYXNlRGlmZmVycyA9IHBhdGguZG9jdW1lbnRCYXNlRGlmZmVycywKCgkJZ2V0U2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0OwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoaHJlZikuaHJlZk5vSGFzaDsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBwYXRoLmdldERvY3VtZW50QmFzZTsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCQlpZiAoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgPSBmdW5jdGlvbiByZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIGhlaWdodCApIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKT8gaGVpZ2h0IDogZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSBhUGFnZVBhZFQgLSBhUGFnZVBhZEIgLSBhUGFnZUJvcmRlclQgLSBhUGFnZUJvcmRlckIgKTsKCX07CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCWZ1bmN0aW9uIGZpbmRCYXNlV2l0aERlZmF1bHQoKSB7CgkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQkvL2lmIHdlIGFyZSByZWxvYWRpbmcgdGhlIHBhZ2UgbWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmKCBiYXNlICYmICFvcHRpb25zLnByZWZldGNoICl7CgkJCQkJYmFzZS5zZXQodXJsKTsKCQkJCX0KCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKSB7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQlpZiAoIGJhc2UgJiYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiICkgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoJCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJCWlmICggYmFzZSAmJiAoIHR5cGVvZiBvcHRpb25zID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSkgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyAoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksIGlzVG9QYWdlU3RyaW5nOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCS8vICAgICAgIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJLy8gICAgICAgdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCS8vICAgICAgIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB0b1BhZ2UsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCX0gZWxzZSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSB0b1BhZ2UuZGF0YSggJ2Fic1VybCcgKTsKCQl9CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgkJLy8KCQkvLyBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywgYmVjYXVzZSBhbiBvYmplY3QgY2FuCgkJLy8gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkJLy8gZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkJLy8gdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCQkvLyBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvUGFnZTsKCgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgoJCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCW5ld1BhZ2UuZGF0YSggJ2Fic1VybCcsIHRyaWdnZXJEYXRhLmFic1VybCApOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJaGlzdG9yeURpciA9IG9wdGlvbnMuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2JvZHknICkgewoJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKCBlICkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYKCQkJCSEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSAmJgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCWlmKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsICs9ICIjIiArIGRpYWxvZ0hhc2hLZXk7CgkJCX0KCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXZhciBwYXJhbXM7CgoJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCWlmKCAhcGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCX0KCgkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJcGFyYW1zID0gewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQl9OwoKCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQl9CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9IHBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCgkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiBwYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJiAhJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2godXJsKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZSB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMKCQkJCS8vIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICh1cmxIaXN0b3J5LmdldExhc3QoKSB8fCB7fSkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQlpZiggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQkJCQl9CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICFwYXRoLmlzUGF0aCggdG8gKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vIFRPRE8gcm9sbCB0aGUgbG9naWMgaGVyZSBpbnRvIHRoZSBoYW5kbGVIYXNoQ2hhbmdlIG1ldGhvZAoJCSR3aW5kb3cuYmluZCggIm5hdmlnYXRlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50TmFtZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiggIXVybCApIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCX0KCgkJCWlmKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApewoJCQkJdXJsID0gbG9jYXRpb24uaHJlZjsKCQkJfQoKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHVybCwgZGF0YS5zdGF0ZSApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb3JuZXJDbGFzcyA9ICEhdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsgY29ybmVyQ2xhc3MKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwud3JhcElubmVyKCBkaWFsb2dXcmFwICk7CgoJCS8qIGJpbmQgZXZlbnRzCgkJCS0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cgb3BlbmVkIHdpdGgKCQkJCXVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fb24oICRlbCwgewoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3JlYXRlQ29tcGxldGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLCBidG4sIGxvY2F0aW9uOwoKCQlpZiAoIHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uICkgewoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbi5yZW1vdmUoKTsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBudWxsOwoJCX0KCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCS8vIFNhbml0aXplIHZhbHVlCgkJCWxvY2F0aW9uID0gKCB2YWx1ZSA9PT0gImxlZnQiID8gImxlZnQiIDogInJpZ2h0IiApOwoJCQlidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWJ0bi0iICsgbG9jYXRpb24gKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApOwoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKS5wcmVwZW5kKCBidG4gKTsKCQkJaWYgKCB0aGlzLl9jcmVhdGVDb21wbGV0ZSAmJiAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCWJ0bi5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQl0aGlzLl9jcmVhdGVDb21wbGV0ZSA9IHRydWU7CgoJCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkJLy8gb24gdGhlIGJ1dHRvbiBhbmQgbGV0dGluZyBuYXYgaGFuZGxlIGl0CgkJCS8vCgkJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJCS8vIHJlb3BlbmluZyB0aGUgZGlhbG9nIGlmIHRoZSBkaWFsb2cgb3BlbmluZyBpdGVtIHdhcyBkaXJlY3RseSB1bmRlciB0aGUgY2xvc2UgYnV0dG9uLgoJCQlidG4uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImNsb3NlQnRuIiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCS8vIElmIHRoZSBoYXNoIGxpc3RlbmluZyBpcyBlbmFibGVkIGFuZCB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgcHJlY2VkaW5nIGhpc3RvcnkKCQkJLy8gZW50cnkgaXQncyBvayB0byBnbyBiYWNrLiBJbml0aWFsIHBhZ2VzIHdpdGggdGhlIGRpYWxvZyBoYXNoIHN0YXRlIGFyZSBhbiBleGFtcGxlCgkJCS8vIHdoZXJlIHRoZSBzdGFjayBjaGVjayBpcyBuZWNlc3NhcnkKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJiBoaXN0LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCWlkeCA9IE1hdGgubWF4KCAwLCBoaXN0LmFjdGl2ZUluZGV4IC0gMSApOwoJCQkJZHN0ID0gaGlzdC5zdGFja1sgaWR4IF0ucGFnZVVybCB8fCBoaXN0LnN0YWNrWyBpZHggXS51cmw7CgkJCQloaXN0LnByZXZpb3VzSW5kZXggPSBoaXN0LmFjdGl2ZUluZGV4OwoJCQkJaGlzdC5hY3RpdmVJbmRleCA9IGlkeDsKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCBkc3QgKSApIHsKCQkJCQlkc3QgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgZHN0ICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZHN0LCB7IGRpcmVjdGlvbjogImJhY2siLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCXZhciAkcGFnZSA9ICQoIGUudGFyZ2V0ICksCgkJbyA9ICRwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVGhpcyBmdW5jdGlvbiBjYWxscyBnZXRBdHRyaWJ1dGUsIHdoaWNoIHNob3VsZCBiZSBzYWZlIGZvciBkYXRhLSogYXR0cmlidXRlcwp2YXIgZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oIGUsIGtleSApIHsKCXZhciB2YWx1ZSA9IGUuZ2V0QXR0cmlidXRlKCBrZXkgKTsKCglyZXR1cm4gdmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCXZhbHVlID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCXZhbHVlID09PSBudWxsID8gdW5kZWZpbmVkIDogdmFsdWU7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQluc0tleSA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQlrZXk7CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgInNoYWRvdyIgKSwKCQkJCWNvcm5lcnM6ICAgIG9wdGlvbnMuY29ybmVycyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb3JuZXJzICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAibWluaSIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoJCQlob3ZlciA9IGZhbHNlLAoJCQlzdGF0ZSA9ICJ1cCIsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQlmb3IgKCBrZXkgaW4gbyApIHsKCQkJaWYgKCBvWyBrZXkgXSA9PT0gdW5kZWZpbmVkIHx8IG9bIGtleSBdID09PSBudWxsICkgewoJCQkJZWwucmVtb3ZlQXR0ciggbnNLZXkgKyBrZXkgKTsKCQkJfSBlbHNlIHsKCQkJCWUuc2V0QXR0cmlidXRlKCBuc0tleSArIGtleSwgb1sga2V5IF0gKTsKCQkJfQoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhpcyBlbGVtZW50IGlzIGFscmVhZHkgZW5oYW5jZWQKCQlidXR0b25FbGVtZW50cyA9ICQuZGF0YSggKCAoIGUudGFnTmFtZSA9PT0gIklOUFVUIiB8fCBlLnRhZ05hbWUgPT09ICJCVVRUT04iICkgPyBlLnBhcmVudE5vZGUgOiBlICksICJidXR0b25FbGVtZW50cyIgKTsKCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZSA9IGJ1dHRvbkVsZW1lbnRzLm91dGVyOwoJCQllbCA9ICQoIGUgKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoIGJ1dHRvbkVsZW1lbnRzLmljb24gKS5yZW1vdmUoKTsKCQkJYnV0dG9uRWxlbWVudHMuaWNvbiA9IG51bGw7CgkJCWhvdmVyID0gYnV0dG9uRWxlbWVudHMuaG92ZXI7CgkJCXN0YXRlID0gYnV0dG9uRWxlbWVudHMuc3RhdGU7CgkJfQoJCWVsc2UgewoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJfQoJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoKCQkvLyBpZiBub3QsIHRyeSB0byBmaW5kIGNsb3Nlc3QgdGhlbWUgY29udGFpbmVyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CgkJfQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gIjsKCQlidXR0b25DbGFzcyArPSAoIGhvdmVyID8gInVpLWJ0bi1ob3Zlci0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gKCBzdGF0ZSA/ICIgdWktYnRuLSIgKyBzdGF0ZSArICItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoKCQlpZiAoIG8uaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBpbmxpbmVgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gdHJ1ZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIHVpLWJ0bi1ibG9jayI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJaG92ZXIgOiBob3ZlciwKCQkJc3RhdGUgOiBzdGF0ZSwKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9CgpmdW5jdGlvbiB1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgY2xhc3NUb1JlbW92ZSwgY2xhc3NUb0FkZCwgaG92ZXIsIHN0YXRlICkgewoJdmFyIGJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAkYnRuWyAwIF0sICJidXR0b25FbGVtZW50cyIgKTsKCSRidG4ucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKS5hZGRDbGFzcyggY2xhc3NUb0FkZCApOwoJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQlidXR0b25FbGVtZW50cy5iY2xzID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApCgkJCS5hZGRDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyArICIgIiArIGNsYXNzVG9BZGQgKQoJCQkucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKQoJCQkuYXR0ciggImNsYXNzIiApOwoJCWlmICggaG92ZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJYnV0dG9uRWxlbWVudHMuaG92ZXIgPSBob3ZlcjsKCQl9CgkJYnV0dG9uRWxlbWVudHMuc3RhdGUgPSBzdGF0ZTsKCX0KfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlpc1RvdWNoRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9edG91Y2gvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApLAoJCQkJZXZ0ID0gZXZlbnQudHlwZTsKCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlob3YgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIHVuZGVmaW5lZCwgInVwIiApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCBmYWxzZSwgInVwIiApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZUNsYXNzZXMgPSAiIjsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5jb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uOwoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbjsKCgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5pY29ucG9zID0gJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvczsKCgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBTZXQgY29ybmVycyBmb3IgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZXMgdG8gZmFsc2Ugd2hlbiBpbiBhIGNvbGxhcHNpYmxlLXNldAoJCQlvLmNvcm5lcnMgPSBmYWxzZTsKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBmb3IgbWluaSBpbiB0aGUgc2V0CgkJCWlmICggIW8ubWluaSApIHsKCQkJCW8ubWluaSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJtaW5pIiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gZ2V0IGluaGVyaXRlZCB0aGVtZSBpZiBub3QgYSBzZXQgYW5kIG5vIHRoZW1lIGhhcyBiZWVuIHNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCQl9CgkJfQoKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtaW5zZXQiOwoJCQlpZiAoICEhby5jb3JuZXJzICkgewoJCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29ybmVyLWFsbCIgOwoJCQl9CgkJfQoJCWlmICggby5jb250ZW50VGhlbWUgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50IjsKCQkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9CgkJaWYgKCBjb2xsYXBzaWJsZUNsYXNzZXMgIT09ICIiICkgewoJCQljb2xsYXBzaWJsZS5hZGRDbGFzcyggY29sbGFwc2libGVDbGFzc2VzICk7CgkJfQoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCQlpY29uOiBvLmNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgby5leHBhbmRlZEljb24gPT09IG8uY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvcm5lciBzdHlsaW5nIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICk7CgkJfQoKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCQlvLmNvcm5lcnMgPSBvLmNvcm5lcnMgIT09IHVuZGVmaW5lZCA/IG8uY29ybmVycyA6IHRydWU7CgoJCWlmICggISFvLmNvcm5lcnMgJiYgISFvLmluc2V0ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLl9yZWZyZXNoKCAidHJ1ZSIgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICk7CgoJCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlKCBjb2xsYXBzaWJsZXNJblNldC5ub3QoICIudWktY29sbGFwc2libGUiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyB1aS1idG4taW5uZXIgaXMgcmV0dXJuZWQgYXMgdGFyZ2V0CgkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5pcyggImEiICkgPyAkKCB0aGlzICkgOiAkKCB0aGlzICkucGFyZW50KCAiYSIgKTsKCgkJCWlmICggIXRhcmdldC5pcyggIi51aS1kaXNhYmxlZCwgLnVpLWJ0bi1hY3RpdmUiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlpY29uOiAiYXJyb3ctciIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRoaXMgaXMgYSBnZW5lcmljIHV0aWxpdHkgbWV0aG9kIGZvciBmaW5kaW5nIHRoZSBmaXJzdAoJLy8gbm9kZSB3aXRoIGEgZ2l2ZW4gbm9kZU5hbWUuIEl0IHVzZXMgYmFzaWMgRE9NIHRyYXZlcnNhbAoJLy8gdG8gYmUgZmFzdCBhbmQgaXMgbWVhbnQgdG8gYmUgYSBzdWJzdGl0dXRlIGZvciBzaW1wbGUKCS8vICQuZm4uY2xvc2VzdCgpIGFuZCAkLmZuLmNoaWxkcmVuKCkgY2FsbHMgb24gYSBzaW5nbGUKCS8vIGVsZW1lbnQuIE5vdGUgdGhhdCBjYWxsZXJzIG11c3QgcGFzcyBib3RoIHRoZSBsb3dlckNhc2UKCS8vIGFuZCB1cHBlckNhc2UgdmVyc2lvbiBvZiB0aGUgbm9kZU5hbWUgdGhleSBhcmUgbG9va2luZyBmb3IuCgkvLyBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMgaXMgdGhhdCB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUKCS8vIGNhbGxlZCBtYW55IHRpbWVzIGFuZCB3ZSB3YW50IHRvIGF2b2lkIGhhdmluZyB0byBsb3dlcmNhc2UKCS8vIHRoZSBub2RlTmFtZSBmcm9tIHRoZSBlbGVtZW50IGV2ZXJ5IHRpbWUgdG8gZW5zdXJlIHdlIGhhdmUKCS8vIGEgbWF0Y2guIE5vdGUgdGhhdCB0aGlzIGZ1bmN0aW9uIGxpdmVzIGhlcmUgZm9yIG5vdywgYnV0IG1heQoJLy8gYmUgbW92ZWQgaW50byAkLm1vYmlsZSBpZiBvdGhlciBjb21wb25lbnRzIG5lZWQgYSBzaW1pbGFyIG1ldGhvZC4KCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJaW1nLmFkZENsYXNzKCAidWktbGktdGh1bWIiICk7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaXMoICIudWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMucGFyZW50UGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJdGhpcy5fY3JlYXRlU3ViUGFnZXMoKTsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlzZWxmID0gdGhpcywKCQkJZGl2aWRlcnRoZW1lID0gJGxpc3QuanFtRGF0YSggImRpdmlkZXJ0aGVtZSIgKSB8fCBvLmRpdmlkZXJUaGVtZSwKCQkJbGlzdHNwbGl0dGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAic3BsaXR0aGVtZSIgKSwKCQkJbGlzdHNwbGl0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJzcGxpdGljb24iICksCgkJCWxpc3RpY29uID0gJGxpc3QuanFtRGF0YSggImljb24iICksCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJanNDb3VudCA9ICEkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50ZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWcsIGxpbmtJY29uOwoKCQlpZiAoIG9sICYmIGpzQ291bnQgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCgkJaWYgKCBvbCApIHsKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0KCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCBsaXN0aWNvbiB8fCBvLmljb24sCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0obGFzdC5nZXRFbmNvZGVkVGV4dCgpKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IgoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpc0RpdmlkZXIgKSB7CgoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IGRpdmlkZXJ0aGVtZSApOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsKCQkJCQkJLy9yZXNldCBjb3VudGVyIHdoZW4gYSBkaXZpZGVyIGhlYWRpbmcgaXMgZW5jb3VudGVyZWQKCQkJCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCQkJCWNvdW50ZXIgPSAxOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoJCWNsZWFyQnRuOiBmYWxzZSwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6IG51bGwsIC8vZGVwcmVjYXRpbmcgZm9yIDEuMy4uLgoJCWNsZWFyQnRuVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmljbGFzcyA9IG8ubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJaXNTZWFyY2ggPSBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWZvY3VzZWRFbCwKCQkJY2xlYXJidG4sCgkJCWNsZWFyQnRuVGV4dCA9IG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0IHx8IG8uY2xlYXJCdG5UZXh0LAoJCQljbGVhckJ0bkJsYWNrbGlzdCA9IGlucHV0LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCWlucHV0TmVlZHNDbGVhckJ0biA9ICEhby5jbGVhckJ0biAmJiAhY2xlYXJCdG5CbGFja2xpc3QsCgkJCWlucHV0TmVlZHNXcmFwID0gaW5wdXQuaXMoICJpbnB1dCIgKSAmJiAhaW5wdXQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApOwoKCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQl9LCAwICk7CgkJfQoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIGlzU2VhcmNoICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9IGVsc2UgaWYgKCBpbnB1dE5lZWRzV3JhcCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXRleHQgdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0KCgkJaWYoIGlucHV0TmVlZHNDbGVhckJ0biB8fCBpc1NlYXJjaCApIHsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIGNsZWFyQnRuVGV4dCArICInPiIgKyBjbGVhckJ0blRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCgkJCWlmICggIWlzU2VhcmNoICkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggInBhc3RlIGN1dCBrZXl1cCBpbnB1dCBmb2N1cyBjaGFuZ2UgYmx1ciIsIHRvZ2dsZUNsZWFyICk7CgkJfQoJCWVsc2UgaWYgKCAhaW5wdXROZWVkc1dyYXAgJiYgIWlzU2VhcmNoICkgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwVGltZW91dDsKCgkJCXRoaXMuX2tleXVwID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCQlpbnB1dC5oZWlnaHQoIHNjcm9sbEhlaWdodCAtIHBhZGRpbmdIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQgKTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0Lm9uKCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiwgZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUuZG9jdW1lbnQsIHsgInBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgoJCWlmICggcGFyZW50TmVlZHNEaXNhYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNFbmFibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoKCQlpZiAoIHBhcmVudE5lZWRzRW5hYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclJldmVhbCA9IGZhbHNlOwovLyBUT0RPIHJlbmFtZSBjYWxsYmFjay9kZXByZWNhdGUgYW5kIGRlZmF1bHQgdG8gdGhlIGl0ZW0gaXRzZWxmIGFzIHRoZSBmaXJzdCBhcmd1bWVudAp2YXIgZGVmYXVsdEZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlLCBpdGVtICkgewoJCXJldHVybiB0ZXh0LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKCX07CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsIG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7Cgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJbGlzdC5jaGlsZHJlbigpLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSkuc3VibWl0KCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWFyY2guYmx1cigpOwoJCX0pLAoJCW9uS2V5VXAgPSBmdW5jdGlvbiggZSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxpID0gbGlzdC5jaGlsZHJlbigpLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgoJCQkJaWYgKCAhbGlzdEl0ZW1zLmxlbmd0aCAmJiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgISFsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApOwoJCQl9CgkJCWxpc3R2aWV3Ll9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgbGlzdHZpZXcuX2dldFZpc2libGVzKCBsaSwgZmFsc2UgKSwgZmFsc2UgKTsKCQl9LAoJCXNlYXJjaCA9ICQoICI8aW5wdXQ+IiwgewoJCQlwbGFjZWhvbGRlcjogbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlcgoJCX0pCgkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiwgInNlYXJjaCIgKQoJCS5qcW1EYXRhKCAibGFzdHZhbCIsICIiICkKCQkuYmluZCggImtleXVwIGNoYW5nZSBpbnB1dCIsIG9uS2V5VXAgKQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9OwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogdW5jaGVja2VkU3RhdGUsCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJYWN0aXZlID0gIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPyBhY3RpdmUgOiAiIiApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMuY2hlY2tlZGljb24gfSApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCBjaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLnVuY2hlY2tlZGljb24gfSApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNoZWNrYm94cmFkaW8ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQkvLyBjcmVhdGUgYSBjb3B5IG9mIHRoaXMub3B0aW9ucyB3ZSBjYW4gcGFzcyB0byBidXR0b25NYXJrdXAKCQkJbyA9ICggZnVuY3Rpb24oIHRkbyApIHsKCQkJCXZhciBrZXksIHJldCA9IHt9OwoKCQkJCWZvciAoIGtleSBpbiB0ZG8gKSB7CgkJCQkJaWYgKCB0ZG9bIGtleSBdICE9PSBudWxsICYmIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCQkJCXJldFsga2V5IF0gPSB0ZG9bIGtleSBdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gcmV0OwoJCQl9ICkoIHRoaXMub3B0aW9ucyApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gZ2V0IHRoZSBpbmhlcml0ZWQgdGhlbWUKCQkvLyBUT0RPIGNlbnRyYWxpemUgZm9yIGFsbCB3aWRnZXRzCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX4kZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQlpZiAoIGNsYXNzZXMgKSB7CgkJCQljbGFzc2VzICs9ICIgdWktc3VibWl0IjsKCQkJfSBlbHNlIHsKCQkJCWNsYXNzZXMgPSAidWktc3VibWl0IjsKCQkJfQoJCX0KCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoIG8gKQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wID0ge307CgoJCW9wWyBrZXkgXSA9IHZhbHVlOwoJCWlmICgga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJdGhpcy5idXR0b24uYnV0dG9uTWFya3VwKCBvcCApOwoJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlciggIl9zZXRPcHRpb24iLCBrZXksIHZhbHVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzU2VsZWN0ID0gdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGNUeXBlID09PSAic2VsZWN0IiwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCQkJbWluID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlcjsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gW3RoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyICIgOiAidWktc2xpZGVyLXRyYWNrICIsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCIsIG1pbmlDbGFzc10uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogInNsaWRlciIsCgkJCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCQkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIHZhciBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgc2xpZGVyVGhlbWUsICIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4ICsgdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci10cmFjayIsIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgKCB0aGlzLm9wdGlvbnMubWluaSApID8gIiB1aS1taW5pIjoiIl0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pOwoKCQl2YXIgcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2gsCgkJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLAoJCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFyIHZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQl2YXIgYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJdmFyIHBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJZGlzYWJsZWQ6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Vjb25kTGFiZWwsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9XCJ1aS1yYW5nZXNsaWRlci1zbGlkZXJzXCIgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJaWYgKCAkZWwuZmluZCggImxhYmVsIiApLmxlbmd0aCA+IDEgKSB7CgkJCQlzZWNvbmRMYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkubGFzdCgpLmhpZGUoKTsKCQkJfQoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJbGFiZWwucHJlcGVuZFRvKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgoJCQlpZiggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKXsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICkuZmluZCggImxhYmVsIiApLnNob3coKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0pOwoKJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS5yYW5nZXNsaWRlciwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5yYW5nZXNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luU2l6ZSwgc2VnU2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJdmFyIHJldCA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJfSBlbHNlIHsKCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJfQoKCXJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93OwoKCXJldHVybiB7CgkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkd2luLndpZHRoKCkgKSwKCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCWUucHJldmVudERlZmF1bHQoKTsKCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIGUgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCXdpbkNvb3Jkcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy55ICYmCgkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQl3aW5Db29yZHM6IHdpbkNvb3JkcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHNlbGYuX2lnbm9yZVJlc2l6ZVRvID0gMDsgfSwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHRndCA9IGUudGFyZ2V0LCAkdGd0LCB1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGd0ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJJHRndCA9ICQoIGUudGFyZ2V0ICk7CgkJCWlmICggMCA9PT0gJHRndC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCSR0Z3QuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9ICR0Z3Q7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB7CgkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuJz48L2Rpdj4iICkKCQkJfSwKCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlteUlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJa2V5LCB2YWx1ZTsKCgkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQlvLmhpc3RvcnkgPSBvLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQl0aGlzUGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkvLyBUT0RPIHRoaXMgd291bGQgYmUgbmljZSBhdCB0aGUgdGhlIG1vYmlsZSB3aWRnZXQgbGV2ZWwKCQlvLmNvbnRhaW5lciA9IG8uY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXIgfHwgdGhpc1BhZ2U7CgoJCS8vIEFwcGx5IHRoZSBwcm90bwoJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJaWYgKCBteUlkICkgewoJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQl1aS5mb2N1c0VsZW1lbnQgPSB1aS5jb250YWluZXI7CgoJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCV91aTogdWksCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCS8vIFRoaXMgZHVwbGljYXRlcyB0aGUgY29kZSBmcm9tIHRoZSB2YXJpb3VzIG9wdGlvbiBzZXR0ZXJzIGJlbG93IGZvcgoJCS8vIGJldHRlciBwZXJmb3JtYW5jZS4gSXQgbXVzdCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aG9zZSBzZXR0ZXJzLgoJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgby50aGVtZSwgImJvZHkiICk7CgkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCBvLm92ZXJsYXlUaGVtZSwgIm92ZXJsYXkiICk7CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvLnRyYW5zaXRpb24gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvLnNoYWRvdyApCgkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvLmNvcm5lcnMgKTsKCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG8udG9sZXJhbmNlICk7CgoJCXVpLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgJC5wcm94eSggdGhpcywgIl9lYXRFdmVudEFuZENsb3NlIiApICk7CgoJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJfSk7CgkJdGhpcy5fb24oICQubW9iaWxlLmRvY3VtZW50LCB7CgkJCWZvY3VzaW46ICQucHJveHkoIHRoaXMsICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiApCgkJfSk7Cgl9LAoKCV9hcHBseVRoZW1lOiBmdW5jdGlvbiggZHN0LCB0aGVtZSwgcHJlZml4ICkgewoJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCWN1cnJlbnRUaGVtZSA9IG51bGwsCgkJCW1hdGNoZXMsCgkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQl3aGlsZSAoIGNsYXNzZXMubGVuZ3RoID4gMCApIHsKCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQlpZiAoIG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAxICkgewoJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJYnJlYWs7CgkJCX0gZWxzZSB7CgkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQl9CgkJfQoKCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJaWYgKCAhICggdGhlbWUgPT09IG51bGwgfHwgdGhlbWUgPT09ICJub25lIiApICkgewoJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuZWxlbWVudCwgdmFsdWUsICJib2R5IiApOwoJfSwKCglfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5fdWkuc2NyZWVuLCB2YWx1ZSwgIm92ZXJsYXkiICk7CgoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQl9Cgl9LAoKCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJfQoJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCX0KCX0sCgoJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCX0KCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCXZhcgoJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJcmMgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQljeDogd2luQ29vcmRzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX0sCgkJCW1lbnVTaXplLCByZXQ7CgoJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQltZW51U2l6ZSA9IHsKCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCX07CgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQlyZXQgPSB7CgkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCX07CgoJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkvLyBmaXggZm9yICQubW9iaWxlLmRvY3VtZW50LmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCWRvY0hlaWdodCA9IE1hdGgubWF4KCBkb2NFbC5jbGllbnRIZWlnaHQsIGRvY0JvZHkuc2Nyb2xsSGVpZ2h0LCBkb2NCb2R5Lm9mZnNldEhlaWdodCwgZG9jRWwuc2Nyb2xsSGVpZ2h0LCBkb2NFbC5vZmZzZXRIZWlnaHQgKTsKCgkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07Cgl9LAoKCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgYW5kIHNlbGYuX3ByZXJlcXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluCgkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJLy8gbmV4dCB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZCB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoCgkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJLy8gLSBtYWtpbmcgaXQgc3RhbGUuIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlIHNlbGYuX3ByZXJlcXMgZW5zdXJlcyB0aGF0CgkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJc2VsZi5fcHJlcmVxcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG8gKSB7CgkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksIHggPSBvLngsIHkgPSBvLnksIHBUbyA9IG8ucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0gZWxzZSB7CgkJCQl0cnkgewoJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJfSBjYXRjaCggZSApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJfQoJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJbyA9IHsgeDogby54LCB5OiBvLnksIHBvc2l0aW9uVG86IG8ucG9zaXRpb25UbyB9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgbyApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3JkcyggbyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCQl9Cgl9LAoKCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG8gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG8udHJhbnNpdGlvbjsKCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG8udHJhbnNpdGlvbiApOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCB0aGlzLl9wYWdlLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5fcGFnZSwgImMiICkgKTsKCQl9CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOgoJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQl0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjoKCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogby50cmFuc2l0aW9uLAoJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCX0pOwoJfSwKCglfY2xvc2VQcmVyZXFTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIKCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7Cgl9LAoKCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyID0gdGhpcy5fdWkuY29udGFpbmVyOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldFRoZW1lKCAibm9uZSIgKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQl0aGlzLmNsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJfQoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsIG8gPSB0aGlzLm9wdGlvbnMsIGltbWVkaWF0ZSA9IGZhbHNlOwoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggZSAmJiBlLnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQlvLmNvbnRhaW5lci51bmJpbmQoIG8uY2xvc2VFdmVudHMgKTsKCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIG8uY2xvc2VMaW5rU2VsZWN0b3IsIG8uY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5vcHRpb25zLmNvbnRhaW5lcgoJCQkub25lKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiggISggb3B0cy5oaXN0b3J5ICkgKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJc2VsZi5lbGVtZW50CgkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJaWYgKCBoYXNIYXNoICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkkKHdpbmRvdykub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCX0pOwoKCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHtyb2xlOiAiZGlhbG9nIn0gKTsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9Cgl9Cn0pOwoKCi8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCXZhciBjbG9zZXN0UGFnZSA9ICRsaW5rLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkvLyAgICAgIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQlvZmZzZXQ7CgoJaWYgKCBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQl9KTsKCX0KCgkvL3JlbW92ZSBhZnRlciBkZWxheQoJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJLy8gQ2hlY2sgaWYgd2UgYXJlIGluIGEgbGlzdHZpZXcKCQl2YXIgJHBhcmVudCA9ICRsaW5rLnBhcmVudCgpLnBhcmVudCgpOwoJCWlmICgkcGFyZW50Lmhhc0NsYXNzKCJ1aS1saSIpKSB7CgkJCSRsaW5rID0gJHBhcmVudC5wYXJlbnQoKTsKCQl9CgkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7Cgl9LCAzMDAgKTsKfTsKCi8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCWUucHJldmVudERlZmF1bHQoKTsKCX0KfSk7CgokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJb3JpZ0Rlc3Ryb3kgPSB3aWRnZXQuX2Rlc3Ryb3ksCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJcHJlZml4ID0gKCBzZWxlY3RJRCA/IHNlbGVjdElEIDogKCAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidXVpZC0iICsgd2lkZ2V0LnV1aWQgKSApLAoJCQlwb3B1cElEID0gcHJlZml4ICsgIi1saXN0Ym94IiwKCQkJZGlhbG9nSUQgPSBwcmVmaXggKyAiLWRpYWxvZyIsCgkJCWxhYmVsID0gd2lkZ2V0LmxhYmVsLAoJCQl0aGlzUGFnZSA9IHdpZGdldC5zZWxlY3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlzZWxlY3RPcHRpb25zID0gd2lkZ2V0Ll9zZWxlY3RPcHRpb25zKCksCgkJCWlzTXVsdGlwbGUgPSB3aWRnZXQuaXNNdWx0aXBsZSA9IHdpZGdldC5zZWxlY3RbIDAgXS5tdWx0aXBsZSwKCQkJYnV0dG9uSWQgPSBzZWxlY3RJRCArICItYnV0dG9uIiwKCQkJbWVudUlkID0gc2VsZWN0SUQgKyAiLW1lbnUiLAoJCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgaWQ9JyIgKyBkaWFsb2dJRCArICInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElEICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZSIsIHdpZGdldC5vcHRpb25zLmRpdmlkZXJUaGVtZSApCgkJCQkJLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoKCQkJaGVhZGVyID0gJCggIjxkaXY+IiwgewoJCQkJImNsYXNzIjogInVpLWhlYWRlciB1aS1iYXItIiArIHdpZGdldC5vcHRpb25zLnRoZW1lCgkJCX0pLnByZXBlbmRUbyggbGlzdGJveCApLAoKCQkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS10aXRsZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApLAoKCQkJbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLAoJCQloZWFkZXJDbG9zZTsKCgkJaWYgKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElEOiBwb3B1cElELAoJCQlkaWFsb2dJRDogZGlhbG9nSUQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCWVzY2FwZUlkID0gZnVuY3Rpb24oIGlkICkgewoJCQkJCQlyZXR1cm4gaWQucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCQkJfTsKCgkJCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJCQlzZWxmLnJlZnJlc2goKTsKCgkJCQlpZiAoIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2Ugc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCQkJLy8gbm9uZSBwcmVzZW50LgoJCQkJCXNlbGYuX29yaWdUYWJJbmRleCA9ICggc2VsZi5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiBzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCQlzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCQkJfSk7CgoJCQkJLy8gQnV0dG9uIGV2ZW50cwoJCQkJc2VsZi5idXR0b24uYmluZCggInZjbGljayBrZXlkb3duIiAsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCB8fCBzZWxmLmlzT3BlbiApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5fZGVjaWRlRm9ybWF0KCk7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBlc2NhcGVJZCggc2VsZi5wb3B1cElEICkgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgZXNjYXBlSWQoIHNlbGYuZGlhbG9nSUQgKSApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJCQkJfQoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdXQiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJCW5ld0luZGV4ID0gc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmluZGV4KCB0aGlzICksCgkJCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCSQoIHRoaXMgKS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCQkJfQoKCQkJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCQl9CgoJCQkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0KCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSkKCQkJCQkua2V5ZG93bihmdW5jdGlvbiggZXZlbnQgKSB7ICAvL2tleWJvYXJkIGV2ZW50cyBmb3IgbWVudSBpdGVtcwoJCQkJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQkJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICksCgkJCQkJCQlwcmV2LCBuZXh0OwoKCQkJCQkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCQkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmICggcHJldi5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCXByZXYgPSBwcmV2LnByZXYoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBwcmV2Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQlwcmV2LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiAoIG5leHQuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQluZXh0ID0gbmV4dC5uZXh0KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJY2FzZSAxMzoKCQkJCQkJY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJfQoKCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5idXR0b24uY2xpY2soKTsKCQkJfSwKCgkJCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIGEiICk7CgkJCQkJfQoJCQkJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gub25lKCAicG9wdXBhZnRlcm9wZW4iLCBmb2N1c01lbnVJdGVtICk7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJCQl9CgkJCQkJfQoKCQkJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgnYXJpYS1kaXNhYmxlZCcsdHJ1ZSk7CgkJCQkJfQoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLGkgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJfQoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0sCgoJCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgoJCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCQl0aGlzLm1lbnVQYWdlLnJlbW92ZSgpOwoKCQkJCS8vIENoYWluIHVwCgkJCQlvcmlnRGVzdHJveS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlciBldmVudHMgb24gZGlzYWJsZWQgZGVsZWdhdGVzCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJtb2JpbGUtc2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250cm9sZ3JvdXAiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgkJb3B0aW9uczogewoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQl0eXBlOiAidmVydGljYWwiLAoJCQltaW5pOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQl1aSA9IHsKCQkJCQlpbm5lcjogJCggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApLAoJCQkJCWxlZ2VuZDogJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQl9LAoJCQkJZ3JvdXBsZWdlbmQgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQkkZWwud3JhcElubmVyKCB1aS5pbm5lciApOwoJCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJCXVpLmxlZ2VuZC5hcHBlbmQoIGdyb3VwbGVnZW5kICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oIDAgKSApOwoJCQl9CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIiApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgkJfSwKCgkJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUeXBlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArIHZhbHVlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9LAoKCQljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyIGVscyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQkJfQoJCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsIHRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsIGNyZWF0ZSApOwoJCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJCX0KCX0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCgkvLyBUT0RPOiBJbXBsZW1lbnQgYSBtZWNoYW5pc20gdG8gYWxsb3cgd2lkZ2V0cyB0byBiZWNvbWUgZW5oYW5jZWQgaW4gdGhlCgkvLyBjb3JyZWN0IG9yZGVyIHdoZW4gdGhlaXIgY29ycmVjdCBlbmhhbmNlbWVudCBkZXBlbmRzIG9uIG90aGVyIHdpZGdldHMgaW4KCS8vIHRoZSBwYWdlIGJlaW5nIGNvcnJlY3RseSBlbmhhbmNlZCBhbHJlYWR5LgoJLy8KCS8vIEZvciBub3csIHdlIHdhaXQgdW50aWwgZG9tLXJlYWR5IHRvIGF0dGFjaCB0aGUgY29udHJvbGdyb3VwJ3MgZW5oYW5jZW1lbnQKCS8vIGhvb2ssIGJlY2F1c2UgYnkgdGhhdCB0aW1lLCBhbGwgdGhlIG90aGVyIHdpZGdldHMnIGVuaGFuY2VtZW50IGhvb2tzIHNob3VsZAoJLy8gYWxyZWFkeSBiZSBpbiBwbGFjZSwgZW5zdXJpbmcgdGhhdCBhbGwgd2lkZ2V0cyB0aGF0IG5lZWQgdG8gYmUgZ3JvdXBlZCB3aWxsCgkvLyBhbHJlYWR5IGhhdmUgYmVlbiBlbmhhbmNlZCBieSB0aGUgdGltZSB0aGUgY29udHJvbGdyb3VwIGlzIGNyZWF0ZWQuCgkkKCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJCSQubW9iaWxlLmNvbnRyb2xncm91cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCQl9KTsKCX0pOwp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlID0gdGhpcywKCQkJCWhyZWYgPSAkKCB0aGlzICkuYXR0ciggImhyZWYiICksCgkJCQlpZHJlZiA9IGhyZWYuc3Vic3RyaW5nKCAxICk7CgoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJJCggZG9jdW1lbnQgKQoJCQkJLm9uKCAicG9wdXBhZnRlcm9wZW4iLCBocmVmLCBmdW5jdGlvbigpIHsKCQkJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCB0cnVlICk7CgkJCQl9KQoJCQkJLm9uKCAicG9wdXBhZnRlcmNsb3NlIiwgaHJlZiwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJCX0pOwoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfdGhpc1BhZ2U6IG51bGwKCQkJfSk7CgoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaXMoICIudWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHRoaXMuX3RoaXNQYWdlLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggIW8udmlzaWJsZU9uUGFnZVNob3cgKSB7CgkJCQl0aGlzLmhpZGUoIHRydWUgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVBbmltYXRpb25TdGFydDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCksCgkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4KCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLl90aGlzUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciI7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0YnR5cGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0YnR5cGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoJ2luJyk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQubW9iaWxlLmRvY3VtZW50CgkJLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiAoICQoIGUudGFyZ2V0ICkuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkKCAkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5vdCggIjpqcW1EYXRhKGZ1bGxzY3JlZW4pIiApLmpxbURhdGEoICJmdWxsc2NyZWVuIiwgdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7CgkJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLmZpeGVkdG9vbGJhciwgewoKCQkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQkJfSwKCgkJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJb3MgPSBudWxsLAoJCQkJc2VsZiA9IHRoaXM7CgkJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiaW9zIjsKCQkJCX0gZWxzZSBpZiggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApewoJCQkJCW9zID0gImFuZHJvaWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIG9zID09PSAiaW9zIiApIHsKCQkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIGlmKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfSwKCgkJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoJGVsLm9mZnNldCgpLnRvcCAtICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSk7CgkJCQlpZiggIWhlYWRlciApIHsKCQkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKG9mZnNldCAtICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpKS02MDsKCQkJCX0KCQkJCXJldHVybiBvZmZzZXQ7CgkJCX0sCgoJCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uCgkJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQkJaWYoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlKSB7CgkJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCQl9CgkJCQl9fSk7CgkJCX0sCgoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZSIpLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQkJfSwKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkKCQkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyJweCIgKTsKCQkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQkJfSwgMCApOwoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLngKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZS1hY3RpdmUiKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCQl9Cgl9KTsKCgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZVBhbmVsOiAidWktcGFnZS1wYW5lbCIsCgkJCXBhZ2VQYW5lbE9wZW46ICJ1aS1wYWdlLXBhbmVsLW9wZW4iLAoJCQljb250ZW50V3JhcDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcCIsCgkJCWNvbnRlbnRXcmFwT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1vcGVuIiwKCQkJY29udGVudFdyYXBDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtY2xvc2VkIiwKCQkJY29udGVudEZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhciIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLW9wZW4iLAoJCQljb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLWNsb3NlZCIsCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogImMiLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwYW5lbCcpIiwKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXI6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCXBhZ2UgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX2dldFBhZ2VUaGVtZSA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGVtZSA9ICQuZGF0YSggcGFnZVswXSwgIm1vYmlsZVBhZ2UiICkub3B0aW9ucy50aGVtZSwKCQkJCSRwYWdlVGhlbWVDbGFzcyA9ICJ1aS1ib2R5LSIgKyAkdGhlbWU7CgkJCQlyZXR1cm4gJHBhZ2VUaGVtZUNsYXNzOwoJCQl9LAoJCQlfZ2V0UGFuZWxJbm5lciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRwYW5lbElubmVyID0gJGVsLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCQkJCWlmICggJHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRwYW5lbElubmVyID0gJGVsLmNoaWxkcmVuKCkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQl9CgkJCQlyZXR1cm4gJHBhbmVsSW5uZXI7CgkJCX0sCgkJCV9nZXRXcmFwcGVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHdyYXBwZXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQlpZiAoICR3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkd3JhcHBlciA9IHBhZ2UuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKyAnICcgKyBfZ2V0UGFnZVRoZW1lKCkgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkd3JhcHBlci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkd3JhcHBlcjsKCQkJfSwKCQkJX2dldEZpeGVkVG9vbGJhciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCWlmICggJGZpeGVkVG9vbGJhci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJGZpeGVkVG9vbGJhci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkZml4ZWRUb29sYmFyOwoJCQl9OwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogJGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogJGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYWdlOiAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX3BhZ2VUaGVtZTogX2dldFBhZ2VUaGVtZSgpLAoJCQlfcGFuZWxJbm5lcjogX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IF9nZXRXcmFwcGVyKCksCgkJCV9maXhlZFRvb2xiYXI6IF9nZXRGaXhlZFRvb2xiYXIoKQoJCX0pOwoKCQlzZWxmLl9hZGRQYW5lbENsYXNzZXMoKTsKCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCXNlbGYuX2ZpeGVkVG9vbGJhci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApOwoJCS8vIGFkZCBjbGFzcyB0byBwYWdlIHNvIHdlIGNhbiBzZXQgIm92ZXJmbG93LXg6IGhpZGRlbjsiIGZvciBpdCB0byBmaXggQW5kcm9pZCB6b29tIGlzc3VlCgkJc2VsZi5fcGFnZS5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMucGFnZVBhbmVsICk7CgoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCgkJc2VsZi5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXNlbGYuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXNlbGYuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJc2VsZi5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXNlbGYuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0aGlzLl9wYWdlICk7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKCBlICkgewoJCQlzZWxmLmNsb3NlKCk7CgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhbmVsSW5uZXJIZWlnaHQgPSBzZWxmLl9wYW5lbElubmVyLm91dGVySGVpZ2h0KCksCgkJCWV4cGFuZCA9IHBhbmVsSW5uZXJIZWlnaHQgPiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYgKCBleHBhbmQgfHwgIXNlbGYub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlpZiAoIGV4cGFuZCApIHsKCQkJCXNlbGYuX3VuZml4UGFuZWwoKTsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCggcGFuZWxJbm5lckhlaWdodCApOwoJCQl9CgkJCXNlbGYuX3Njcm9sbEludG9WaWV3KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIHBhbmVsSW5uZXJIZWlnaHQgKSB7CgkJaWYgKCBwYW5lbElubmVySGVpZ2h0IDwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMCApOwoJCX0KCX0sCgoJX2JpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICQoIHdpbmRvdyApLCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAiX3Bvc2l0aW9uUGFuZWwiIH0pOwoJfSwKCglfdW5iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29mZiggJCggd2luZG93ICksICJ0aHJvdHRsZWRyZXNpemUiICk7Cgl9LAoKCV91bmZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2ZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2JpbmRVcGRhdGVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5lbGVtZW50Lm9uKCAidXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fcGFnZS5vbiggImNsaWNrLnBhbmVsIiAsICJhIiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5ocmVmLnNwbGl0KCAiIyIgKVsgMSBdID09PSBzZWxmLl9wYW5lbElEICYmIHNlbGYuX3BhbmVsSUQgIT09IHVuZGVmaW5lZCApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQkkcGFyZW50OwoJCQkJaWYgKCAhICRsaW5rLmhhc0NsYXNzKCAidWktbGluayIgKSApIHsKCQkJCQkvLyBDaGVjayBpZiB3ZSBhcmUgaW4gYSBsaXN0dmlldwoJCQkJCSRwYXJlbnQgPSAkbGluay5wYXJlbnQoKS5wYXJlbnQoKTsKCQkJCQlpZiAoICRwYXJlbnQuaGFzQ2xhc3MoICJ1aS1saSIgKSApIHsKCQkJCQkJJGxpbmsgPSAkcGFyZW50LnBhcmVudCgpOwoJCQkJCX0KCQkJCQkkbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQlzZWxmLmVsZW1lbnQub25lKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJfSk7CgkJCQl9CgkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX3BhZ2UKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gY2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJCS5vbiggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkvLyBvbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJfSwKCgkvLyBzdGF0ZSBzdG9yYWdlIG9mIG9wZW4gb3IgY2xvc2VkCglfb3BlbjogZmFsc2UsCgoJX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXM6IG51bGwsCglfZml4ZWRUb29sYmFyT3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fcGFnZS5vZmYoICJwYW5lbGNsb3NlIiApOwoJCQkJCXNlbGYuX3BhZ2UuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZQoJCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJLy8gRml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCBzZWxmLl9wYWdlLmNzcyggIm1pbi1oZWlnaHQiICkgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhckNsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCgkJCQkJc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMubW9kYWwgKSArICIgIiArIG8uY2xhc3Nlcy5tb2RhbE9wZW47CgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoKCQkJCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgoJCQlpZiAoIHNlbGYuX3BhZ2UuanFtRGF0YSgncGFuZWwnKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5fcGFnZS5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkJc2VsZiA9IHRoaXMsCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApOwoJCQkJCQkvLyByZXNldCBmaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCAiIiApOwoJCQkJCX0KCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoJCQkJfTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaGFzT3RoZXJTaWJsaW5nUGFuZWxzID0gdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiLiIgKyBjbGFzc2VzLnBhbmVsICkubGVuZ3RoOwoKCQkvLyBjcmVhdGUKCQlpZiAoICFoYXNPdGhlclNpYmxpbmdQYW5lbHMgKSB7CgkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJdGhpcy5fcGFnZS5maW5kKCAiYSIgKS51bmJpbmQoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQkJfQoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9IGVsc2UgaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQl0aGlzLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQlpZiAoIHRoZW1lICkgewoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQl9CgkJfQoKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgY2xhc3Nlcy5wYW5lbEFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICk7CgoJCXRoaXMuX2Nsb3NlTGluay5vZmYoICJjbGljay5wYW5lbCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoKCQkvLyBvcGVuIGFuZCBjbG9zZQoJCXRoaXMuZWxlbWVudC5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKQoJCQkucmVtb3ZlQ2xhc3MoIFsgY2xhc3Nlcy5wYW5lbFVuZml4ZWQsIGNsYXNzZXMucGFuZWxDbG9zZWQsIGNsYXNzZXMucGFuZWxPcGVuIF0uam9pbiggIiAiICkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnBhbmVsLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQljbGFzc2VzOiB7CgkJCQl0YWJsZTogInVpLXRhYmxlIgoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSd0YWJsZScpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYucmVmcmVzaCggdHJ1ZSApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uIChjcmVhdGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJCWlmICggY3JlYXRlICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCQl9CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJc2VsZi5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heSBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCXNlbGYuYWxsSGVhZGVycyA9IHNlbGYuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7CgoJCQl0cnMuZWFjaChmdW5jdGlvbigpewoKCQkJCXZhciBjb2x0YWxseSA9IDA7CgoJCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbiggaSApewoKCQkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCXNlbCA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNvbHN0YXJ0IiwgY29sdGFsbHkgKyAxICk7CgoJCQkJCWlmKCBzcGFuICl7CgkJCQkJCWZvciggdmFyIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApewoJCQkJCQkJY29sdGFsbHkrKzsKCQkJCQkJCXNlbCArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkKHRoaXMpLmpxbURhdGEoImNlbGxzIiwgIiIpOwoJCQkJCX0KCQkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNlbGxzIiwgc2VsZi5lbGVtZW50LmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSgwKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWwgKSApOwoKCQkJCQljb2x0YWxseSsrOwoKCQkJCX0pOwoKCQkJfSk7CgoJCQkvLyB1cGRhdGUgdGFibGUgbW9kZXMKCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAncmVmcmVzaCcgKTsKCQkJfQoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gImNvbHVtbnRvZ2dsZSI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5Qb3B1cFRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRleHQgPSAiQ29sdW1ucy4uLiI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCWV2ZW50ID0gZS50eXBlLAoJCW8gPSBzZWxmLm9wdGlvbnMsCgkJbnMgPSAkLm1vYmlsZS5ucywKCQlpZCA9ICggJHRhYmxlLmF0dHIoICJpZCIgKSB8fCBvLmNsYXNzZXMucG9wdXAgKSArICItcG9wdXAiLCAvKiBUT0RPIEJFVFRFUiBGQUxMQkFDSyBJRCBIRVJFICovCgkJJG1lbnVCdXR0b24sCgkJJHBvcHVwLAoJCSRtZW51LAoJCSRzd2l0Y2hib2FyZDsKCglpZiAoIG8ubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoKCQkkbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY29sdW1uQnRuICsgIicgZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAibWluaT0ndHJ1ZSc+IiArIG8uY29sdW1uQnRuVGV4dCArICI8L2E+IiApLAoJCSRwb3B1cCA9ICQoICI8ZGl2IGRhdGEtIiArIG5zICsgInJvbGU9J3BvcHVwJyBkYXRhLSIgKyBucyArICJyb2xlPSdmaWVsZGNvbnRhaW4nIGNsYXNzPSciICsgby5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIpLAoJCSRtZW51ID0gJCgiPGZpZWxkc2V0IGRhdGEtIiArIG5zICsgInJvbGU9J2NvbnRyb2xncm91cCc+PC9maWVsZHNldD4iKTsKCX0KCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglzZWxmLmhlYWRlcnMubm90KCAidGQiICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJdmFyIHByaW9yaXR5ID0gJCggdGhpcyApLmpxbURhdGEoICJwcmlvcml0eSIgKSwKCQkJJGNlbGxzID0gJCggdGhpcyApLmFkZCggJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQlpZiAoIHByaW9yaXR5ICkgewoKCQkJJGNlbGxzLmFkZENsYXNzKCBvLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCQkJJCgiPGxhYmVsPjxpbnB1dCB0eXBlPSdjaGVja2JveCcgY2hlY2tlZCAvPiIgKyAkKCB0aGlzICkudGV4dCgpICsgIjwvbGFiZWw+IiApCgkJCQkJLmFwcGVuZFRvKCAkbWVudSApCgkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkuanFtRGF0YSggImNlbGxzIiwgJGNlbGxzICkKCQkJCQkuY2hlY2tib3hyYWRpbyh7CgkJCQkJCXRoZW1lOiBvLmNvbHVtblBvcHVwVGhlbWUKCQkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQoICcjJyArIGlkICsgJyBmaWVsZHNldCBkaXY6ZXEoJyArIGkgKycpJykuZmluZCgnaW5wdXQnKS5qcW1EYXRhKCAnY2VsbHMnLCAkY2VsbHMgKTsKCQkJfQoJCX0KCX0pOwoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkbWVudS5hcHBlbmRUbyggJHBvcHVwICk7Cgl9CgoJLy8gYmluZCBjaGFuZ2UgZXZlbnQgbGlzdGVuZXJzIHRvIGlucHV0cyAtIFRPRE86IG1vdmUgdG8gYSBwcml2YXRlIG1ldGhvZD8KCWlmICggJG1lbnUgPT09IHVuZGVmaW5lZCApIHsKCQkkc3dpdGNoYm9hcmQgPSAkKCcjJyArIGlkICsgJyBmaWVsZHNldCcpOwoJfSBlbHNlIHsKCQkkc3dpdGNoYm9hcmQgPSAkbWVudTsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJHN3aXRjaGJvYXJkLm9uKCAiY2hhbmdlIiwgImlucHV0IiwgZnVuY3Rpb24oIGUgKXsKCQkJaWYoIHRoaXMuY2hlY2tlZCApewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApOwoJCQl9CgkJfSk7CgoJCSRtZW51QnV0dG9uCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8uY29sdW1uQnRuVGhlbWUKCQkJfSk7CgoJCSRwb3B1cAoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkucG9wdXAoKTsKCX0KCgkvLyByZWZyZXNoIG1ldGhvZAoJc2VsZi51cGRhdGUgPSBmdW5jdGlvbigpewoJCSRzd2l0Y2hib2FyZC5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMuY2hlY2tlZCkgewoJCQkJdGhpcy5jaGVja2VkID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5lcSgwKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCQlpZiAoZXZlbnQgPT09ICJyZWZyZXNoIikgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtdmlzaWJsZScpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC1oaWRkZW4nKTsKCQkJfQoJCQkkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9OwoKCSQubW9iaWxlLndpbmRvdy5vbiggInRocm90dGxlZHJlc2l6ZSIsIHNlbGYudXBkYXRlICk7CgoJc2VsZi51cGRhdGUoKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gInJlZmxvdyI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlldmVudCA9IGUudHlwZSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJbyA9IHNlbGYub3B0aW9uczsKCgkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCglpZiggby5tb2RlICE9PSAicmVmbG93IiApewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCX0KCgkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCXZhciByZXZlcnNlSGVhZGVycyA9ICAkKCBzZWxmLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICk7CgoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJcmV2ZXJzZUhlYWRlcnMuZWFjaChmdW5jdGlvbiggaSApewoJCXZhciAkY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQljb2xzdGFydCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY29sc3RhcnQiICksCgkJCWhpZXJhcmNoeUNsYXNzID0gJGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJdGV4dCA9ICQodGhpcykudGV4dCgpOwoKCQkJaWYoIHRleHQgIT09ICIiICApewoKCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApewoJCQkJCXZhciBpdGVyYXRpb24gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJaWYoIGl0ZXJhdGlvbiApewoJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJfQoJCQkJCSRjZWxscy5maWx0ZXIoIGZpbHRlciApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRjZWxscy5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoKCQkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJaWYoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICl7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCl7CgkJaWYoICQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCApewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpIHsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBmaW5kIGFuZCBlbmhhbmNlIHRoZSBwYWdlcyBpbiB0aGUgZG9tIGFuZCB0cmFuc2l0aW9uIHRvIHRoZSBmaXJzdCBwYWdlLgoJCWluaXRpYWxpemVQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gZmluZCBwcmVzZW50IHBhZ2VzCgkJCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQkJCSRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9IHBhdGguc3RyaXBIYXNoKCBwYXRoLnN0cmlwUXVlcnlQYXJhbXMocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAnOmpxbURhdGEocm9sZT0icGFnZSIpJyApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:59 GMT",
                    "Content-Length": "359030",
                    "Date": "Fri, 07 Nov 2014 06:49:59 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}