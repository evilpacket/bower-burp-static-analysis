{
    "url": "http://localhost:9999/components/thorax/thorax-combined-mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/components/thorax/thorax-combined-mobile.js",
                "path": "/components/thorax/thorax-combined-mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jb21wb25lbnRzL3Rob3JheC90aG9yYXgtY29tYmluZWQtbW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjY4MDAwDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDE1OjM0OjQ1IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAxNTozNDo0NSBHTVQNCg0KLyogWmVwdG8gdjEuMS4yIC0gemVwdG8gZXZlbnQgYWpheCBmb3JtIGllIC0gemVwdG9qcy5jb20vbGljZW5zZSAqLwoKCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsIGZpbHRlciA9IGVtcHR5QXJyYXkuZmlsdGVyLAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICBlbGVtZW50RGlzcGxheSA9IHt9LCBjbGFzc0NhY2hlID0ge30sCiAgICBjc3NOdW1iZXIgPSB7ICdjb2x1bW4tY291bnQnOiAxLCAnY29sdW1ucyc6IDEsICdmb250LXdlaWdodCc6IDEsICdsaW5lLWhlaWdodCc6IDEsJ29wYWNpdHknOiAxLCAnei1pbmRleCc6IDEsICd6b29tJzogMSB9LAogICAgZnJhZ21lbnRSRSA9IC9eXHMqPChcdyt8ISlbXj5dKj4vLAogICAgc2luZ2xlVGFnUkUgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAogICAgdGFnRXhwYW5kZXJSRSA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vaWcsCiAgICByb290Tm9kZVJFID0gL14oPzpib2R5fGh0bWwpJC9pLAogICAgY2FwaXRhbFJFID0gLyhbQS1aXSkvZywKCiAgICAvLyBzcGVjaWFsIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgZ2V0L3NldCB2aWEgbWV0aG9kIGNhbGxzCiAgICBtZXRob2RBdHRyaWJ1dGVzID0gWyd2YWwnLCAnY3NzJywgJ2h0bWwnLCAndGV4dCcsICdkYXRhJywgJ3dpZHRoJywgJ2hlaWdodCcsICdvZmZzZXQnXSwKCiAgICBhZGphY2VuY3lPcGVyYXRvcnMgPSBbICdhZnRlcicsICdwcmVwZW5kJywgJ2JlZm9yZScsICdhcHBlbmQnIF0sCiAgICB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyksCiAgICB0YWJsZVJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyksCiAgICBjb250YWluZXJzID0gewogICAgICAndHInOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0Ym9keScpLAogICAgICAndGJvZHknOiB0YWJsZSwgJ3RoZWFkJzogdGFibGUsICd0Zm9vdCc6IHRhYmxlLAogICAgICAndGQnOiB0YWJsZVJvdywgJ3RoJzogdGFibGVSb3csCiAgICAgICcqJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgIH0sCiAgICByZWFkeVJFID0gL2NvbXBsZXRlfGxvYWRlZHxpbnRlcmFjdGl2ZS8sCiAgICBjbGFzc1NlbGVjdG9yUkUgPSAvXlwuKFtcdy1dKykkLywKICAgIGlkU2VsZWN0b3JSRSA9IC9eIyhbXHctXSopJC8sCiAgICBzaW1wbGVTZWxlY3RvclJFID0gL15bXHctXSokLywKICAgIGNsYXNzMnR5cGUgPSB7fSwKICAgIHRvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZywKICAgIHplcHRvID0ge30sCiAgICBjYW1lbGl6ZSwgdW5pcSwKICAgIHRlbXBQYXJlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgIHByb3BNYXAgPSB7CiAgICAgICd0YWJpbmRleCc6ICd0YWJJbmRleCcsCiAgICAgICdyZWFkb25seSc6ICdyZWFkT25seScsCiAgICAgICdmb3InOiAnaHRtbEZvcicsCiAgICAgICdjbGFzcyc6ICdjbGFzc05hbWUnLAogICAgICAnbWF4bGVuZ3RoJzogJ21heExlbmd0aCcsCiAgICAgICdjZWxsc3BhY2luZyc6ICdjZWxsU3BhY2luZycsCiAgICAgICdjZWxscGFkZGluZyc6ICdjZWxsUGFkZGluZycsCiAgICAgICdyb3dzcGFuJzogJ3Jvd1NwYW4nLAogICAgICAnY29sc3Bhbic6ICdjb2xTcGFuJywKICAgICAgJ3VzZW1hcCc6ICd1c2VNYXAnLAogICAgICAnZnJhbWVib3JkZXInOiAnZnJhbWVCb3JkZXInLAogICAgICAnY29udGVudGVkaXRhYmxlJzogJ2NvbnRlbnRFZGl0YWJsZScKICAgIH0KCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIXNlbGVjdG9yIHx8ICFlbGVtZW50IHx8IGVsZW1lbnQubm9kZVR5cGUgIT09IDEpIHJldHVybiBmYWxzZQogICAgdmFyIG1hdGNoZXNTZWxlY3RvciA9IGVsZW1lbnQud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGVsZW1lbnQubW96TWF0Y2hlc1NlbGVjdG9yIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vTWF0Y2hlc1NlbGVjdG9yIHx8IGVsZW1lbnQubWF0Y2hlc1NlbGVjdG9yCiAgICBpZiAobWF0Y2hlc1NlbGVjdG9yKSByZXR1cm4gbWF0Y2hlc1NlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpCiAgICAvLyBmYWxsIGJhY2sgdG8gcGVyZm9ybWluZyBhIHNlbGVjdG9yOgogICAgdmFyIG1hdGNoLCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsIHRlbXAgPSAhcGFyZW50CiAgICBpZiAodGVtcCkgKHBhcmVudCA9IHRlbXBQYXJlbnQpLmFwcGVuZENoaWxkKGVsZW1lbnQpCiAgICBtYXRjaCA9IH56ZXB0by5xc2EocGFyZW50LCBzZWxlY3RvcikuaW5kZXhPZihlbGVtZW50KQogICAgdGVtcCAmJiB0ZW1wUGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpCiAgICByZXR1cm4gbWF0Y2gKICB9CgogIGZ1bmN0aW9uIHR5cGUob2JqKSB7CiAgICByZXR1cm4gb2JqID09IG51bGwgPyBTdHJpbmcob2JqKSA6CiAgICAgIGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAib2JqZWN0IgogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdHlwZSh2YWx1ZSkgPT0gImZ1bmN0aW9uIiB9CiAgZnVuY3Rpb24gaXNXaW5kb3cob2JqKSAgICAgeyByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09IG9iai53aW5kb3cgfQogIGZ1bmN0aW9uIGlzRG9jdW1lbnQob2JqKSAgIHsgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iai5ub2RlVHlwZSA9PSBvYmouRE9DVU1FTlRfTk9ERSB9CiAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSAgICAgeyByZXR1cm4gdHlwZShvYmopID09ICJvYmplY3QiIH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogICAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgIWlzV2luZG93KG9iaikgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT0gT2JqZWN0LnByb3RvdHlwZQogIH0KICBmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5IH0KICBmdW5jdGlvbiBsaWtlQXJyYXkob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqLmxlbmd0aCA9PSAnbnVtYmVyJyB9CgogIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsgcmV0dXJuIGZpbHRlci5jYWxsKGFycmF5LCBmdW5jdGlvbihpdGVtKXsgcmV0dXJuIGl0ZW0gIT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/ICQuZm4uY29uY2F0LmFwcGx5KFtdLCBhcnJheSkgOiBhcnJheSB9CiAgY2FtZWxpemUgPSBmdW5jdGlvbihzdHIpeyByZXR1cm4gc3RyLnJlcGxhY2UoLy0rKC4pPy9nLCBmdW5jdGlvbihtYXRjaCwgY2hyKXsgcmV0dXJuIGNociA/IGNoci50b1VwcGVyQ2FzZSgpIDogJycgfSkgfQogIGZ1bmN0aW9uIGRhc2hlcml6ZShzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvOjovZywgJy8nKQogICAgICAgICAgIC5yZXBsYWNlKC8oW0EtWl0rKShbQS1aXVthLXpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC8oW2EtelxkXSkoW0EtWl0pL2csICckMV8kMicpCiAgICAgICAgICAgLnJlcGxhY2UoL18vZywgJy0nKQogICAgICAgICAgIC50b0xvd2VyQ2FzZSgpCiAgfQogIHVuaXEgPSBmdW5jdGlvbihhcnJheSl7IHJldHVybiBmaWx0ZXIuY2FsbChhcnJheSwgZnVuY3Rpb24oaXRlbSwgaWR4KXsgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSkgPT0gaWR4IH0pIH0KCiAgZnVuY3Rpb24gY2xhc3NSRShuYW1lKSB7CiAgICByZXR1cm4gbmFtZSBpbiBjbGFzc0NhY2hlID8KICAgICAgY2xhc3NDYWNoZVtuYW1lXSA6IChjbGFzc0NhY2hlW25hbWVdID0gbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBuYW1lICsgJyhcXHN8JCknKSkKICB9CgogIGZ1bmN0aW9uIG1heWJlQWRkUHgobmFtZSwgdmFsdWUpIHsKICAgIHJldHVybiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmICFjc3NOdW1iZXJbZGFzaGVyaXplKG5hbWUpXSkgPyB2YWx1ZSArICJweCIgOiB2YWx1ZQogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKICAgIHZhciBlbGVtZW50LCBkaXNwbGF5CiAgICBpZiAoIWVsZW1lbnREaXNwbGF5W25vZGVOYW1lXSkgewogICAgICBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChub2RlTmFtZSkKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbGVtZW50KQogICAgICBkaXNwbGF5ID0gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpCiAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50KQogICAgICBkaXNwbGF5ID09ICJub25lIiAmJiAoZGlzcGxheSA9ICJibG9jayIpCiAgICAgIGVsZW1lbnREaXNwbGF5W25vZGVOYW1lXSA9IGRpc3BsYXkKICAgIH0KICAgIHJldHVybiBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0KICB9CgogIGZ1bmN0aW9uIGNoaWxkcmVuKGVsZW1lbnQpIHsKICAgIHJldHVybiAnY2hpbGRyZW4nIGluIGVsZW1lbnQgPwogICAgICBzbGljZS5jYWxsKGVsZW1lbnQuY2hpbGRyZW4pIDoKICAgICAgJC5tYXAoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihub2RlKXsgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIG5vZGUgfSkKICB9CgogIC8vIGAkLnplcHRvLmZyYWdtZW50YCB0YWtlcyBhIGh0bWwgc3RyaW5nIGFuZCBhbiBvcHRpb25hbCB0YWcgbmFtZQogIC8vIHRvIGdlbmVyYXRlIERPTSBub2RlcyBub2RlcyBmcm9tIHRoZSBnaXZlbiBodG1sIHN0cmluZy4KICAvLyBUaGUgZ2VuZXJhdGVkIERPTSBub2RlcyBhcmUgcmV0dXJuZWQgYXMgYW4gYXJyYXkuCiAgLy8gVGhpcyBmdW5jdGlvbiBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMgZm9yIGV4YW1wbGUgdG8gbWFrZQogIC8vIGl0IGNvbXBhdGlibGUgd2l0aCBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgdGhlIERPTSBmdWxseS4KICB6ZXB0by5mcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwsIG5hbWUsIHByb3BlcnRpZXMpIHsKICAgIHZhciBkb20sIG5vZGVzLCBjb250YWluZXIKCiAgICAvLyBBIHNwZWNpYWwgY2FzZSBvcHRpbWl6YXRpb24gZm9yIGEgc2luZ2xlIHRhZwogICAgaWYgKHNpbmdsZVRhZ1JFLnRlc3QoaHRtbCkpIGRvbSA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChSZWdFeHAuJDEpKQoKICAgIGlmICghZG9tKSB7CiAgICAgIGlmIChodG1sLnJlcGxhY2UpIGh0bWwgPSBodG1sLnJlcGxhY2UodGFnRXhwYW5kZXJSRSwgIjwkMT48LyQyPiIpCiAgICAgIGlmIChuYW1lID09PSB1bmRlZmluZWQpIG5hbWUgPSBmcmFnbWVudFJFLnRlc3QoaHRtbCkgJiYgUmVnRXhwLiQxCiAgICAgIGlmICghKG5hbWUgaW4gY29udGFpbmVycykpIG5hbWUgPSAnKicKCiAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnICsgaHRtbAogICAgICBkb20gPSAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9CgogICAgaWYgKGlzUGxhaW5PYmplY3QocHJvcGVydGllcykpIHsKICAgICAgbm9kZXMgPSAkKGRvbSkKICAgICAgJC5lYWNoKHByb3BlcnRpZXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAobWV0aG9kQXR0cmlidXRlcy5pbmRleE9mKGtleSkgPiAtMSkgbm9kZXNba2V5XSh2YWx1ZSkKICAgICAgICBlbHNlIG5vZGVzLmF0dHIoa2V5LCB2YWx1ZSkKICAgICAgfSkKICAgIH0KCiAgICByZXR1cm4gZG9tCiAgfQoKICAvLyBgJC56ZXB0by5aYCBzd2FwcyBvdXQgdGhlIHByb3RvdHlwZSBvZiB0aGUgZ2l2ZW4gYGRvbWAgYXJyYXkKICAvLyBvZiBub2RlcyB3aXRoIGAkLmZuYCBhbmQgdGh1cyBzdXBwbHlpbmcgYWxsIHRoZSBaZXB0byBmdW5jdGlvbnMKICAvLyB0byB0aGUgYXJyYXkuIE5vdGUgdGhhdCBgX19wcm90b19fYCBpcyBub3Qgc3VwcG9ydGVkIG9uIEludGVybmV0CiAgLy8gRXhwbG9yZXIuIFRoaXMgbWV0aG9kIGNhbiBiZSBvdmVycmlkZW4gaW4gcGx1Z2lucy4KICB6ZXB0by5aID0gZnVuY3Rpb24oZG9tLCBzZWxlY3RvcikgewogICAgZG9tID0gZG9tIHx8IFtdCiAgICBkb20uX19wcm90b19fID0gJC5mbgogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgZG9tCiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gT3B0aW1pemUgZm9yIHN0cmluZyBzZWxlY3RvcnMKICAgIGVsc2UgaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgewogICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKQogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgLy8gTm90ZTogSW4gYm90aCBDaHJvbWUgMjEgYW5kIEZpcmVmb3ggMTUsIERPTSBlcnJvciAxMgogICAgICAvLyBpcyB0aHJvd24gaWYgdGhlIGZyYWdtZW50IGRvZXNuJ3QgYmVnaW4gd2l0aCA8CiAgICAgIGlmIChzZWxlY3RvclswXSA9PSAnPCcgJiYgZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3RvciwgUmVnRXhwLiQxLCBjb250ZXh0KSwgc2VsZWN0b3IgPSBudWxsCiAgICAgIC8vIElmIHRoZXJlJ3MgYSBjb250ZXh0LCBjcmVhdGUgYSBjb2xsZWN0aW9uIG9uIHRoYXQgY29udGV4dCBmaXJzdCwgYW5kIHNlbGVjdAogICAgICAvLyBub2RlcyBmcm9tIHRoZXJlCiAgICAgIGVsc2UgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCkgcmV0dXJuICQoY29udGV4dCkuZmluZChzZWxlY3RvcikKICAgICAgLy8gSWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgfQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1c3QgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICAvLyBub3JtYWxpemUgYXJyYXkgaWYgYW4gYXJyYXkgb2Ygbm9kZXMgaXMgZ2l2ZW4KICAgICAgaWYgKGlzQXJyYXkoc2VsZWN0b3IpKSBkb20gPSBjb21wYWN0KHNlbGVjdG9yKQogICAgICAvLyBXcmFwIERPTSBub2Rlcy4KICAgICAgZWxzZSBpZiAoaXNPYmplY3Qoc2VsZWN0b3IpKQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSwgY29udGV4dCksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgfQogICAgLy8gY3JlYXRlIGEgbmV3IFplcHRvIGNvbGxlY3Rpb24gZnJvbSB0aGUgbm9kZXMgZm91bmQKICAgIHJldHVybiB6ZXB0by5aKGRvbSwgc2VsZWN0b3IpCiAgfQoKICAvLyBgJGAgd2lsbCBiZSB0aGUgYmFzZSBgWmVwdG9gIG9iamVjdC4gV2hlbiBjYWxsaW5nIHRoaXMKICAvLyBmdW5jdGlvbiBqdXN0IGNhbGwgYCQuemVwdG8uaW5pdCwgd2hpY2ggbWFrZXMgdGhlIGltcGxlbWVudGF0aW9uCiAgLy8gZGV0YWlscyBvZiBzZWxlY3Rpbmcgbm9kZXMgYW5kIGNyZWF0aW5nIFplcHRvIGNvbGxlY3Rpb25zCiAgLy8gcGF0Y2hhYmxlIGluIHBsdWdpbnMuCiAgJCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KXsKICAgIHJldHVybiB6ZXB0by5pbml0KHNlbGVjdG9yLCBjb250ZXh0KQogIH0KCiAgZnVuY3Rpb24gZXh0ZW5kKHRhcmdldCwgc291cmNlLCBkZWVwKSB7CiAgICBmb3IgKGtleSBpbiBzb3VyY2UpCiAgICAgIGlmIChkZWVwICYmIChpc1BsYWluT2JqZWN0KHNvdXJjZVtrZXldKSB8fCBpc0FycmF5KHNvdXJjZVtrZXldKSkpIHsKICAgICAgICBpZiAoaXNQbGFpbk9iamVjdChzb3VyY2Vba2V5XSkgJiYgIWlzUGxhaW5PYmplY3QodGFyZ2V0W2tleV0pKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSB7fQogICAgICAgIGlmIChpc0FycmF5KHNvdXJjZVtrZXldKSAmJiAhaXNBcnJheSh0YXJnZXRba2V5XSkpCiAgICAgICAgICB0YXJnZXRba2V5XSA9IFtdCiAgICAgICAgZXh0ZW5kKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSwgZGVlcCkKICAgICAgfQogICAgICBlbHNlIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKSB0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICB2YXIgZGVlcCwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKQogICAgaWYgKHR5cGVvZiB0YXJnZXQgPT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGRlZXAgPSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJncy5zaGlmdCgpCiAgICB9CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKXsgZXh0ZW5kKHRhcmdldCwgYXJnLCBkZWVwKSB9KQogICAgcmV0dXJuIHRhcmdldAogIH0KCiAgLy8gYCQuemVwdG8ucXNhYCBpcyBaZXB0bydzIENTUyBzZWxlY3RvciBpbXBsZW1lbnRhdGlvbiB3aGljaAogIC8vIHVzZXMgYGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGxgIGFuZCBvcHRpbWl6ZXMgZm9yIHNvbWUgc3BlY2lhbCBjYXNlcywgbGlrZSBgI2lkYC4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8ucXNhID0gZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IpewogICAgdmFyIGZvdW5kLAogICAgICAgIG1heWJlSUQgPSBzZWxlY3RvclswXSA9PSAnIycsCiAgICAgICAgbWF5YmVDbGFzcyA9ICFtYXliZUlEICYmIHNlbGVjdG9yWzBdID09ICcuJywKICAgICAgICBuYW1lT25seSA9IG1heWJlSUQgfHwgbWF5YmVDbGFzcyA/IHNlbGVjdG9yLnNsaWNlKDEpIDogc2VsZWN0b3IsIC8vIEVuc3VyZSB0aGF0IGEgMSBjaGFyIHRhZyBuYW1lIHN0aWxsIGdldHMgY2hlY2tlZAogICAgICAgIGlzU2ltcGxlID0gc2ltcGxlU2VsZWN0b3JSRS50ZXN0KG5hbWVPbmx5KQogICAgcmV0dXJuIChpc0RvY3VtZW50KGVsZW1lbnQpICYmIGlzU2ltcGxlICYmIG1heWJlSUQpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKG5hbWVPbmx5KSkgPyBbZm91bmRdIDogW10gKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gW10gOgogICAgICBzbGljZS5jYWxsKAogICAgICAgIGlzU2ltcGxlICYmICFtYXliZUlEID8KICAgICAgICAgIG1heWJlQ2xhc3MgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZU9ubHkpIDogLy8gSWYgaXQncyBzaW1wbGUsIGl0IGNvdWxkIGJlIGEgY2xhc3MKICAgICAgICAgIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpIDogLy8gT3IgYSB0YWcKICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikgLy8gT3IgaXQncyBub3Qgc2ltcGxlLCBhbmQgd2UgbmVlZCB0byBxdWVyeSBhbGwKICAgICAgKQogIH0KCiAgZnVuY3Rpb24gZmlsdGVyZWQobm9kZXMsIHNlbGVjdG9yKSB7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gbnVsbCA/ICQobm9kZXMpIDogJChub2RlcykuZmlsdGVyKHNlbGVjdG9yKQogIH0KCiAgJC5jb250YWlucyA9IGZ1bmN0aW9uKHBhcmVudCwgbm9kZSkgewogICAgcmV0dXJuIHBhcmVudCAhPT0gbm9kZSAmJiBwYXJlbnQuY29udGFpbnMobm9kZSkKICB9CgogIGZ1bmN0aW9uIGZ1bmNBcmcoY29udGV4dCwgYXJnLCBpZHgsIHBheWxvYWQpIHsKICAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSwgdmFsdWUpIHsKICAgIHZhbHVlID09IG51bGwgPyBub2RlLnJlbW92ZUF0dHJpYnV0ZShuYW1lKSA6IG5vZGUuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKQogIH0KCiAgLy8gYWNjZXNzIGNsYXNzTmFtZSBwcm9wZXJ0eSB3aGlsZSByZXNwZWN0aW5nIFNWR0FuaW1hdGVkU3RyaW5nCiAgZnVuY3Rpb24gY2xhc3NOYW1lKG5vZGUsIHZhbHVlKXsKICAgIHZhciBrbGFzcyA9IG5vZGUuY2xhc3NOYW1lLAogICAgICAgIHN2ZyAgID0ga2xhc3MgJiYga2xhc3MuYmFzZVZhbCAhPT0gdW5kZWZpbmVkCgogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBzdmcgPyBrbGFzcy5iYXNlVmFsIDoga2xhc3MKICAgIHN2ZyA/IChrbGFzcy5iYXNlVmFsID0gdmFsdWUpIDogKG5vZGUuY2xhc3NOYW1lID0gdmFsdWUpCiAgfQoKICAvLyAidHJ1ZSIgID0+IHRydWUKICAvLyAiZmFsc2UiID0+IGZhbHNlCiAgLy8gIm51bGwiICA9PiBudWxsCiAgLy8gIjQyIiAgICA9PiA0MgogIC8vICI0Mi41IiAgPT4gNDIuNQogIC8vICIwOCIgICAgPT4gIjA4IgogIC8vIEpTT04gICAgPT4gcGFyc2UgaWYgdmFsaWQKICAvLyBTdHJpbmcgID0+IHNlbGYKICBmdW5jdGlvbiBkZXNlcmlhbGl6ZVZhbHVlKHZhbHVlKSB7CiAgICB2YXIgbnVtCiAgICB0cnkgewogICAgICByZXR1cm4gdmFsdWUgPwogICAgICAgIHZhbHVlID09ICJ0cnVlIiB8fAogICAgICAgICggdmFsdWUgPT0gImZhbHNlIiA/IGZhbHNlIDoKICAgICAgICAgIHZhbHVlID09ICJudWxsIiA/IG51bGwgOgogICAgICAgICAgIS9eMC8udGVzdCh2YWx1ZSkgJiYgIWlzTmFOKG51bSA9IE51bWJlcih2YWx1ZSkpID8gbnVtIDoKICAgICAgICAgIC9eW1xbXHtdLy50ZXN0KHZhbHVlKSA/ICQucGFyc2VKU09OKHZhbHVlKSA6CiAgICAgICAgICB2YWx1ZSApCiAgICAgICAgOiB2YWx1ZQogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiB2YWx1ZQogICAgfQogIH0KCiAgJC50eXBlID0gdHlwZQogICQuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24KICAkLmlzV2luZG93ID0gaXNXaW5kb3cKICAkLmlzQXJyYXkgPSBpc0FycmF5CiAgJC5pc1BsYWluT2JqZWN0ID0gaXNQbGFpbk9iamVjdAoKICAkLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lCiAgICBmb3IgKG5hbWUgaW4gb2JqKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICAkLmluQXJyYXkgPSBmdW5jdGlvbihlbGVtLCBhcnJheSwgaSl7CiAgICByZXR1cm4gZW1wdHlBcnJheS5pbmRleE9mLmNhbGwoYXJyYXksIGVsZW0sIGkpCiAgfQoKICAkLmNhbWVsQ2FzZSA9IGNhbWVsaXplCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7CiAgICByZXR1cm4gc3RyID09IG51bGwgPyAiIiA6IFN0cmluZy5wcm90b3R5cGUudHJpbS5jYWxsKHN0cikKICB9CgogIC8vIHBsdWdpbiBjb21wYXRpYmlsaXR5CiAgJC51dWlkID0gMAogICQuc3VwcG9ydCA9IHsgfQogICQuZXhwciA9IHsgfQoKICAkLm1hcCA9IGZ1bmN0aW9uKGVsZW1lbnRzLCBjYWxsYmFjayl7CiAgICB2YXIgdmFsdWUsIHZhbHVlcyA9IFtdLCBpLCBrZXkKICAgIGlmIChsaWtlQXJyYXkoZWxlbWVudHMpKQogICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1lbnRzW2ldLCBpKQogICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB2YWx1ZXMucHVzaCh2YWx1ZSkKICAgICAgfQogICAgZWxzZQogICAgICBmb3IgKGtleSBpbiBlbGVtZW50cykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNba2V5XSwga2V5KQogICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB2YWx1ZXMucHVzaCh2YWx1ZSkKICAgICAgfQogICAgcmV0dXJuIGZsYXR0ZW4odmFsdWVzKQogIH0KCiAgJC5lYWNoID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciBpLCBrZXkKICAgIGlmIChsaWtlQXJyYXkoZWxlbWVudHMpKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChlbGVtZW50c1tpXSwgaSwgZWxlbWVudHNbaV0pID09PSBmYWxzZSkgcmV0dXJuIGVsZW1lbnRzCiAgICB9IGVsc2UgewogICAgICBmb3IgKGtleSBpbiBlbGVtZW50cykKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChlbGVtZW50c1trZXldLCBrZXksIGVsZW1lbnRzW2tleV0pID09PSBmYWxzZSkgcmV0dXJuIGVsZW1lbnRzCiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnRzCiAgfQoKICAkLmdyZXAgPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgcmV0dXJuIGZpbHRlci5jYWxsKGVsZW1lbnRzLCBjYWxsYmFjaykKICB9CgogIGlmICh3aW5kb3cuSlNPTikgJC5wYXJzZUpTT04gPSBKU09OLnBhcnNlCgogIC8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcAogICQuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oaSwgbmFtZSkgewogICAgY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKQogIH0pCgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBzb3J0OiBlbXB0eUFycmF5LnNvcnQsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQoJC5tYXAodGhpcywgZnVuY3Rpb24oZWwsIGkpeyByZXR1cm4gZm4uY2FsbChlbCwgaSwgZWwpIH0pKQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAvLyBuZWVkIHRvIGNoZWNrIGlmIGRvY3VtZW50LmJvZHkgZXhpc3RzIGZvciBJRSBhcyB0aGF0IGJyb3dzZXIgcmVwb3J0cwogICAgICAvLyBkb2N1bWVudCByZWFkeSB3aGVuIGl0IGhhc24ndCB5ZXQgY3JlYXRlZCB0aGUgYm9keSBlbGVtZW50CiAgICAgIGlmIChyZWFkeVJFLnRlc3QoZG9jdW1lbnQucmVhZHlTdGF0ZSkgJiYgZG9jdW1lbnQuYm9keSkgY2FsbGJhY2soJCkKICAgICAgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKXsgY2FsbGJhY2soJCkgfSwgZmFsc2UpCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSB1bmRlZmluZWQgPyBzbGljZS5jYWxsKHRoaXMpIDogdGhpc1tpZHggPj0gMCA/IGlkeCA6IGlkeCArIHRoaXMubGVuZ3RoXQogICAgfSwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmdldCgpIH0sCiAgICBzaXplOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGgKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlICE9IG51bGwpCiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykKICAgICAgfSkKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGVtcHR5QXJyYXkuZXZlcnkuY2FsbCh0aGlzLCBmdW5jdGlvbihlbCwgaWR4KXsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbCwgaWR4LCBlbCkgIT09IGZhbHNlCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHNlbGVjdG9yKSkgcmV0dXJuIHRoaXMubm90KHRoaXMubm90KHNlbGVjdG9yKSkKICAgICAgcmV0dXJuICQoZmlsdGVyLmNhbGwodGhpcywgZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgICAgcmV0dXJuIHplcHRvLm1hdGNoZXMoZWxlbWVudCwgc2VsZWN0b3IpCiAgICAgIH0pKQogICAgfSwKICAgIGFkZDogZnVuY3Rpb24oc2VsZWN0b3IsY29udGV4dCl7CiAgICAgIHJldHVybiAkKHVuaXEodGhpcy5jb25jYXQoJChzZWxlY3Rvcixjb250ZXh0KSkpKQogICAgfSwKICAgIGlzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA+IDAgJiYgemVwdG8ubWF0Y2hlcyh0aGlzWzBdLCBzZWxlY3RvcikKICAgIH0sCiAgICBub3Q6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIG5vZGVzPVtdCiAgICAgIGlmIChpc0Z1bmN0aW9uKHNlbGVjdG9yKSAmJiBzZWxlY3Rvci5jYWxsICE9PSB1bmRlZmluZWQpCiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgICBpZiAoIXNlbGVjdG9yLmNhbGwodGhpcyxpZHgpKSBub2Rlcy5wdXNoKHRoaXMpCiAgICAgICAgfSkKICAgICAgZWxzZSB7CiAgICAgICAgdmFyIGV4Y2x1ZGVzID0gdHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnID8gdGhpcy5maWx0ZXIoc2VsZWN0b3IpIDoKICAgICAgICAgIChsaWtlQXJyYXkoc2VsZWN0b3IpICYmIGlzRnVuY3Rpb24oc2VsZWN0b3IuaXRlbSkpID8gc2xpY2UuY2FsbChzZWxlY3RvcikgOiAkKHNlbGVjdG9yKQogICAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbihlbCl7CiAgICAgICAgICBpZiAoZXhjbHVkZXMuaW5kZXhPZihlbCkgPCAwKSBub2Rlcy5wdXNoKGVsKQogICAgICAgIH0pCiAgICAgIH0KICAgICAgcmV0dXJuICQobm9kZXMpCiAgICB9LAogICAgaGFzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbigpewogICAgICAgIHJldHVybiBpc09iamVjdChzZWxlY3RvcikgPwogICAgICAgICAgJC5jb250YWlucyh0aGlzLCBzZWxlY3RvcikgOgogICAgICAgICAgJCh0aGlzKS5maW5kKHNlbGVjdG9yKS5zaXplKCkKICAgICAgfSkKICAgIH0sCiAgICBlcTogZnVuY3Rpb24oaWR4KXsKICAgICAgcmV0dXJuIGlkeCA9PT0gLTEgPyB0aGlzLnNsaWNlKGlkeCkgOiB0aGlzLnNsaWNlKGlkeCwgKyBpZHggKyAxKQogICAgfSwKICAgIGZpcnN0OiBmdW5jdGlvbigpewogICAgICB2YXIgZWwgPSB0aGlzWzBdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGxhc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbdGhpcy5sZW5ndGggLSAxXQogICAgICByZXR1cm4gZWwgJiYgIWlzT2JqZWN0KGVsKSA/IGVsIDogJChlbCkKICAgIH0sCiAgICBmaW5kOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciByZXN1bHQsICR0aGlzID0gdGhpcwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09ICdvYmplY3QnKQogICAgICAgIHJlc3VsdCA9ICQoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbigpewogICAgICAgICAgdmFyIG5vZGUgPSB0aGlzCiAgICAgICAgICByZXR1cm4gZW1wdHlBcnJheS5zb21lLmNhbGwoJHRoaXMsIGZ1bmN0aW9uKHBhcmVudCl7CiAgICAgICAgICAgIHJldHVybiAkLmNvbnRhaW5zKHBhcmVudCwgbm9kZSkKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gJCh6ZXB0by5xc2EodGhpc1swXSwgc2VsZWN0b3IpKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiByZXN1bHQKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXSwgY29sbGVjdGlvbiA9IGZhbHNlCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ29iamVjdCcpIGNvbGxlY3Rpb24gPSAkKHNlbGVjdG9yKQogICAgICB3aGlsZSAobm9kZSAmJiAhKGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmluZGV4T2Yobm9kZSkgPj0gMCA6IHplcHRvLm1hdGNoZXMobm9kZSwgc2VsZWN0b3IpKSkKICAgICAgICBub2RlID0gbm9kZSAhPT0gY29udGV4dCAmJiAhaXNEb2N1bWVudChub2RlKSAmJiBub2RlLnBhcmVudE5vZGUKICAgICAgcmV0dXJuICQobm9kZSkKICAgIH0sCiAgICBwYXJlbnRzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBhbmNlc3RvcnMgPSBbXSwgbm9kZXMgPSB0aGlzCiAgICAgIHdoaWxlIChub2Rlcy5sZW5ndGggPiAwKQogICAgICAgIG5vZGVzID0gJC5tYXAobm9kZXMsIGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgaWYgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSAmJiAhaXNEb2N1bWVudChub2RlKSAmJiBhbmNlc3RvcnMuaW5kZXhPZihub2RlKSA8IDApIHsKICAgICAgICAgICAgYW5jZXN0b3JzLnB1c2gobm9kZSkKICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICByZXR1cm4gZmlsdGVyZWQoYW5jZXN0b3JzLCBzZWxlY3RvcikKICAgIH0sCiAgICBwYXJlbnQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHVuaXEodGhpcy5wbHVjaygncGFyZW50Tm9kZScpKSwgc2VsZWN0b3IpCiAgICB9LAogICAgY2hpbGRyZW46IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiBjaGlsZHJlbih0aGlzKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgY29udGVudHM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7IHJldHVybiBzbGljZS5jYWxsKHRoaXMuY2hpbGROb2RlcykgfSkKICAgIH0sCiAgICBzaWJsaW5nczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gZmlsdGVyZWQodGhpcy5tYXAoZnVuY3Rpb24oaSwgZWwpewogICAgICAgIHJldHVybiBmaWx0ZXIuY2FsbChjaGlsZHJlbihlbC5wYXJlbnROb2RlKSwgZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiAkLm1hcCh0aGlzLCBmdW5jdGlvbihlbCl7IHJldHVybiBlbFtwcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gJycpCiAgICAgICAgaWYgKGdldENvbXB1dGVkU3R5bGUodGhpcywgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKSA9PSAibm9uZSIpCiAgICAgICAgICB0aGlzLnN0eWxlLmRpc3BsYXkgPSBkZWZhdWx0RGlzcGxheSh0aGlzLm5vZGVOYW1lKQogICAgICB9KQogICAgfSwKICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuYmVmb3JlKG5ld0NvbnRlbnQpLnJlbW92ZSgpCiAgICB9LAogICAgd3JhcDogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgdmFyIGZ1bmMgPSBpc0Z1bmN0aW9uKHN0cnVjdHVyZSkKICAgICAgaWYgKHRoaXNbMF0gJiYgIWZ1bmMpCiAgICAgICAgdmFyIGRvbSAgID0gJChzdHJ1Y3R1cmUpLmdldCgwKSwKICAgICAgICAgICAgY2xvbmUgPSBkb20ucGFyZW50Tm9kZSB8fCB0aGlzLmxlbmd0aCA+IDEKCiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaW5kZXgpewogICAgICAgICQodGhpcykud3JhcEFsbCgKICAgICAgICAgIGZ1bmMgPyBzdHJ1Y3R1cmUuY2FsbCh0aGlzLCBpbmRleCkgOgogICAgICAgICAgICBjbG9uZSA/IGRvbS5jbG9uZU5vZGUodHJ1ZSkgOiBkb20KICAgICAgICApCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAkKHRoaXNbMF0pLmJlZm9yZShzdHJ1Y3R1cmUgPSAkKHN0cnVjdHVyZSkpCiAgICAgICAgdmFyIGNoaWxkcmVuCiAgICAgICAgLy8gZHJpbGwgZG93biB0byB0aGUgaW5tb3N0IGVsZW1lbnQKICAgICAgICB3aGlsZSAoKGNoaWxkcmVuID0gc3RydWN0dXJlLmNoaWxkcmVuKCkpLmxlbmd0aCkgc3RydWN0dXJlID0gY2hpbGRyZW4uZmlyc3QoKQogICAgICAgICQoc3RydWN0dXJlKS5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHdyYXBJbm5lcjogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgdmFyIGZ1bmMgPSBpc0Z1bmN0aW9uKHN0cnVjdHVyZSkKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpbmRleCl7CiAgICAgICAgdmFyIHNlbGYgPSAkKHRoaXMpLCBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKSwKICAgICAgICAgICAgZG9tICA9IGZ1bmMgPyBzdHJ1Y3R1cmUuY2FsbCh0aGlzLCBpbmRleCkgOiBzdHJ1Y3R1cmUKICAgICAgICBjb250ZW50cy5sZW5ndGggPyBjb250ZW50cy53cmFwQWxsKGRvbSkgOiBzZWxmLmFwcGVuZChkb20pCiAgICAgIH0pCiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbigpewogICAgICB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICAkKHRoaXMpLnJlcGxhY2VXaXRoKCQodGhpcykuY2hpbGRyZW4oKSkKICAgICAgfSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBjbG9uZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KQogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmNzcygiZGlzcGxheSIsICJub25lIikKICAgIH0sCiAgICB0b2dnbGU6IGZ1bmN0aW9uKHNldHRpbmcpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGVsID0gJCh0aGlzKQogICAgICAgIDsoc2V0dGluZyA9PT0gdW5kZWZpbmVkID8gZWwuY3NzKCJkaXNwbGF5IikgPT0gIm5vbmUiIDogc2V0dGluZykgPyBlbC5zaG93KCkgOiBlbC5oaWRlKCkKICAgICAgfSkKICAgIH0sCiAgICBwcmV2OiBmdW5jdGlvbihzZWxlY3Rvcil7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkuZmlsdGVyKHNlbGVjdG9yIHx8ICcqJykgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsgcmV0dXJuICQodGhpcy5wbHVjaygnbmV4dEVsZW1lbnRTaWJsaW5nJykpLmZpbHRlcihzZWxlY3RvciB8fCAnKicpIH0sCiAgICBodG1sOiBmdW5jdGlvbihodG1sKXsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLnRleHRDb250ZW50IDogbnVsbCkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbigpeyB0aGlzLnRleHRDb250ZW50ID0gKHRleHQgPT09IHVuZGVmaW5lZCkgPyAnJyA6ICcnK3RleHQgfSkKICAgIH0sCiAgICBhdHRyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciByZXN1bHQKICAgICAgcmV0dXJuICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID09IDAgfHwgdGhpc1swXS5ub2RlVHlwZSAhPT0gMSA/IHVuZGVmaW5lZCA6CiAgICAgICAgICAobmFtZSA9PSAndmFsdWUnICYmIHRoaXNbMF0ubm9kZU5hbWUgPT0gJ0lOUFVUJykgPyB0aGlzLnZhbCgpIDoKICAgICAgICAgICghKHJlc3VsdCA9IHRoaXNbMF0uZ2V0QXR0cmlidXRlKG5hbWUpKSAmJiBuYW1lIGluIHRoaXNbMF0pID8gdGhpc1swXVtuYW1lXSA6IHJlc3VsdAogICAgICAgICkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgIT09IDEpIHJldHVybgogICAgICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSBmb3IgKGtleSBpbiBuYW1lKSBzZXRBdHRyaWJ1dGUodGhpcywga2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHNldEF0dHJpYnV0ZSh0aGlzLCBuYW1lLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpKSkKICAgICAgICB9KQogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMubm9kZVR5cGUgPT09IDEgJiYgc2V0QXR0cmlidXRlKHRoaXMsIG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICBuYW1lID0gcHJvcE1hcFtuYW1lXSB8fCBuYW1lCiAgICAgIHJldHVybiAodmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzWzBdICYmIHRoaXNbMF1bbmFtZV0pIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBuYW1lLnJlcGxhY2UoY2FwaXRhbFJFLCAnLSQxJykudG9Mb3dlckNhc2UoKSwgdmFsdWUpCiAgICAgIHJldHVybiBkYXRhICE9PSBudWxsID8gZGVzZXJpYWxpemVWYWx1ZShkYXRhKSA6IHVuZGVmaW5lZAogICAgfSwKICAgIHZhbDogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCA/CiAgICAgICAgKHRoaXNbMF0gJiYgKHRoaXNbMF0ubXVsdGlwbGUgPwogICAgICAgICAgICQodGhpc1swXSkuZmluZCgnb3B0aW9uJykuZmlsdGVyKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLnNlbGVjdGVkIH0pLnBsdWNrKCd2YWx1ZScpIDoKICAgICAgICAgICB0aGlzWzBdLnZhbHVlKQogICAgICAgICkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgdGhpcy52YWx1ZSA9IGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy52YWx1ZSkKICAgICAgICB9KQogICAgfSwKICAgIG9mZnNldDogZnVuY3Rpb24oY29vcmRpbmF0ZXMpewogICAgICBpZiAoY29vcmRpbmF0ZXMpIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaW5kZXgpewogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgICAgICAgIGNvb3JkcyA9IGZ1bmNBcmcodGhpcywgY29vcmRpbmF0ZXMsIGluZGV4LCAkdGhpcy5vZmZzZXQoKSksCiAgICAgICAgICAgIHBhcmVudE9mZnNldCA9ICR0aGlzLm9mZnNldFBhcmVudCgpLm9mZnNldCgpLAogICAgICAgICAgICBwcm9wcyA9IHsKICAgICAgICAgICAgICB0b3A6ICBjb29yZHMudG9wICAtIHBhcmVudE9mZnNldC50b3AsCiAgICAgICAgICAgICAgbGVmdDogY29vcmRzLmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdAogICAgICAgICAgICB9CgogICAgICAgIGlmICgkdGhpcy5jc3MoJ3Bvc2l0aW9uJykgPT0gJ3N0YXRpYycpIHByb3BzWydwb3NpdGlvbiddID0gJ3JlbGF0aXZlJwogICAgICAgICR0aGlzLmNzcyhwcm9wcykKICAgICAgfSkKICAgICAgaWYgKHRoaXMubGVuZ3RoPT0wKSByZXR1cm4gbnVsbAogICAgICB2YXIgb2JqID0gdGhpc1swXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKQogICAgICByZXR1cm4gewogICAgICAgIGxlZnQ6IG9iai5sZWZ0ICsgd2luZG93LnBhZ2VYT2Zmc2V0LAogICAgICAgIHRvcDogb2JqLnRvcCArIHdpbmRvdy5wYWdlWU9mZnNldCwKICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChvYmoud2lkdGgpLAogICAgICAgIGhlaWdodDogTWF0aC5yb3VuZChvYmouaGVpZ2h0KQogICAgICB9CiAgICB9LAogICAgY3NzOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXNbMF0sIGNvbXB1dGVkU3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsICcnKQogICAgICAgIGlmKCFlbGVtZW50KSByZXR1cm4KICAgICAgICBpZiAodHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQuc3R5bGVbY2FtZWxpemUocHJvcGVydHkpXSB8fCBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpCiAgICAgICAgZWxzZSBpZiAoaXNBcnJheShwcm9wZXJ0eSkpIHsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9CiAgICAgICAgICAkLmVhY2goaXNBcnJheShwcm9wZXJ0eSkgPyBwcm9wZXJ0eTogW3Byb3BlcnR5XSwgZnVuY3Rpb24oXywgcHJvcCl7CiAgICAgICAgICAgIHByb3BzW3Byb3BdID0gKGVsZW1lbnQuc3R5bGVbY2FtZWxpemUocHJvcCldIHx8IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShwcm9wKSkKICAgICAgICAgIH0pCiAgICAgICAgICByZXR1cm4gcHJvcHMKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBjc3MgPSAnJwogICAgICBpZiAodHlwZShwcm9wZXJ0eSkgPT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoIXZhbHVlICYmIHZhbHVlICE9PSAwKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChrZXkgaW4gcHJvcGVydHkpCiAgICAgICAgICBpZiAoIXByb3BlcnR5W2tleV0gJiYgcHJvcGVydHlba2V5XSAhPT0gMCkKICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKGtleSkpIH0pCiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGNzcyArPSBkYXNoZXJpemUoa2V5KSArICc6JyArIG1heWJlQWRkUHgoa2V5LCBwcm9wZXJ0eVtrZXldKSArICc7JwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIGZhbHNlCiAgICAgIHJldHVybiBlbXB0eUFycmF5LnNvbWUuY2FsbCh0aGlzLCBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuIHRoaXMudGVzdChjbGFzc05hbWUoZWwpKQogICAgICB9LCBjbGFzc1JFKG5hbWUpKQogICAgfSwKICAgIGFkZENsYXNzOiBmdW5jdGlvbihuYW1lKXsKICAgICAgaWYgKCFuYW1lKSByZXR1cm4gdGhpcwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gY2xhc3NOYW1lKHRoaXMpLCBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNscykKICAgICAgICBuZXdOYW1lLnNwbGl0KC9ccysvZykuZm9yRWFjaChmdW5jdGlvbihrbGFzcyl7CiAgICAgICAgICBpZiAoISQodGhpcykuaGFzQ2xhc3Moa2xhc3MpKSBjbGFzc0xpc3QucHVzaChrbGFzcykKICAgICAgICB9LCB0aGlzKQogICAgICAgIGNsYXNzTGlzdC5sZW5ndGggJiYgY2xhc3NOYW1lKHRoaXMsIGNscyArIChjbHMgPyAiICIgOiAiIikgKyBjbGFzc0xpc3Quam9pbigiICIpKQogICAgICB9KQogICAgfSwKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihuYW1lKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIGlmIChuYW1lID09PSB1bmRlZmluZWQpIHJldHVybiBjbGFzc05hbWUodGhpcywgJycpCiAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NOYW1lKHRoaXMpCiAgICAgICAgZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNsYXNzTGlzdCkuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTGlzdC5yZXBsYWNlKGNsYXNzUkUoa2xhc3MpLCAiICIpCiAgICAgICAgfSkKICAgICAgICBjbGFzc05hbWUodGhpcywgY2xhc3NMaXN0LnRyaW0oKSkKICAgICAgfSkKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24obmFtZSwgd2hlbil7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIHRoaXMKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksIG5hbWVzID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNsYXNzTmFtZSh0aGlzKSkKICAgICAgICBuYW1lcy5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgKHdoZW4gPT09IHVuZGVmaW5lZCA/ICEkdGhpcy5oYXNDbGFzcyhrbGFzcykgOiB3aGVuKSA/CiAgICAgICAgICAgICR0aGlzLmFkZENsYXNzKGtsYXNzKSA6ICR0aGlzLnJlbW92ZUNsYXNzKGtsYXNzKQogICAgICAgIH0pCiAgICAgIH0pCiAgICB9LAogICAgc2Nyb2xsVG9wOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybgogICAgICB2YXIgaGFzU2Nyb2xsVG9wID0gJ3Njcm9sbFRvcCcgaW4gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGhhc1Njcm9sbFRvcCA/IHRoaXNbMF0uc2Nyb2xsVG9wIDogdGhpc1swXS5wYWdlWU9mZnNldAogICAgICByZXR1cm4gdGhpcy5lYWNoKGhhc1Njcm9sbFRvcCA/CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxUb3AgPSB2YWx1ZSB9IDoKICAgICAgICBmdW5jdGlvbigpeyB0aGlzLnNjcm9sbFRvKHRoaXMuc2Nyb2xsWCwgdmFsdWUpIH0pCiAgICB9LAogICAgc2Nyb2xsTGVmdDogZnVuY3Rpb24odmFsdWUpewogICAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm4KICAgICAgdmFyIGhhc1Njcm9sbExlZnQgPSAnc2Nyb2xsTGVmdCcgaW4gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGhhc1Njcm9sbExlZnQgPyB0aGlzWzBdLnNjcm9sbExlZnQgOiB0aGlzWzBdLnBhZ2VYT2Zmc2V0CiAgICAgIHJldHVybiB0aGlzLmVhY2goaGFzU2Nyb2xsTGVmdCA/CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxMZWZ0ID0gdmFsdWUgfSA6CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxUbyh2YWx1ZSwgdGhpcy5zY3JvbGxZKSB9KQogICAgfSwKICAgIHBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmxlbmd0aCkgcmV0dXJuCgogICAgICB2YXIgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAogICAgICAgIC8vIEdldCBjb3JyZWN0IG9mZnNldHMKICAgICAgICBvZmZzZXQgICAgICAgPSB0aGlzLm9mZnNldCgpLAogICAgICAgIHBhcmVudE9mZnNldCA9IHJvb3ROb2RlUkUudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKQoKICAgICAgLy8gU3VidHJhY3QgZWxlbWVudCBtYXJnaW5zCiAgICAgIC8vIG5vdGU6IHdoZW4gYW4gZWxlbWVudCBoYXMgbWFyZ2luOiBhdXRvIHRoZSBvZmZzZXRMZWZ0IGFuZCBtYXJnaW5MZWZ0CiAgICAgIC8vIGFyZSB0aGUgc2FtZSBpbiBTYWZhcmkgY2F1c2luZyBvZmZzZXQubGVmdCB0byBpbmNvcnJlY3RseSBiZSAwCiAgICAgIG9mZnNldC50b3AgIC09IHBhcnNlRmxvYXQoICQoZWxlbSkuY3NzKCdtYXJnaW4tdG9wJykgKSB8fCAwCiAgICAgIG9mZnNldC5sZWZ0IC09IHBhcnNlRmxvYXQoICQoZWxlbSkuY3NzKCdtYXJnaW4tbGVmdCcpICkgfHwgMAoKICAgICAgLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCiAgICAgIHBhcmVudE9mZnNldC50b3AgICs9IHBhcnNlRmxvYXQoICQob2Zmc2V0UGFyZW50WzBdKS5jc3MoJ2JvcmRlci10b3Atd2lkdGgnKSApIHx8IDAKICAgICAgcGFyZW50T2Zmc2V0LmxlZnQgKz0gcGFyc2VGbG9hdCggJChvZmZzZXRQYXJlbnRbMF0pLmNzcygnYm9yZGVyLWxlZnQtd2lkdGgnKSApIHx8IDAKCiAgICAgIC8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwogICAgICByZXR1cm4gewogICAgICAgIHRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCwKICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0CiAgICAgIH0KICAgIH0sCiAgICBvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keQogICAgICAgIHdoaWxlIChwYXJlbnQgJiYgIXJvb3ROb2RlUkUudGVzdChwYXJlbnQubm9kZU5hbWUpICYmICQocGFyZW50KS5jc3MoInBvc2l0aW9uIikgPT0gInN0YXRpYyIpCiAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50CiAgICAgICAgcmV0dXJuIHBhcmVudAogICAgICB9KQogICAgfQogIH0KCiAgLy8gZm9yIG5vdwogICQuZm4uZGV0YWNoID0gJC5mbi5yZW1vdmUKCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgIHZhciBkaW1lbnNpb25Qcm9wZXJ0eSA9CiAgICAgIGRpbWVuc2lvbi5yZXBsYWNlKC8uLywgZnVuY3Rpb24obSl7IHJldHVybiBtWzBdLnRvVXBwZXJDYXNlKCkgfSkKCiAgICAkLmZuW2RpbWVuc2lvbl0gPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHZhciBvZmZzZXQsIGVsID0gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGlzV2luZG93KGVsKSA/IGVsWydpbm5lcicgKyBkaW1lbnNpb25Qcm9wZXJ0eV0gOgogICAgICAgIGlzRG9jdW1lbnQoZWwpID8gZWwuZG9jdW1lbnRFbGVtZW50WydzY3JvbGwnICsgZGltZW5zaW9uUHJvcGVydHldIDoKICAgICAgICAob2Zmc2V0ID0gdGhpcy5vZmZzZXQoKSkgJiYgb2Zmc2V0W2RpbWVuc2lvbl0KICAgICAgZWxzZSByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgZWwgPSAkKHRoaXMpCiAgICAgICAgZWwuY3NzKGRpbWVuc2lvbiwgZnVuY0FyZyh0aGlzLCB2YWx1ZSwgaWR4LCBlbFtkaW1lbnNpb25dKCkpKQogICAgICB9KQogICAgfQogIH0pCgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKG9wZXJhdG9yLCBvcGVyYXRvckluZGV4KSB7CiAgICB2YXIgaW5zaWRlID0gb3BlcmF0b3JJbmRleCAlIDIgLy89PiBwcmVwZW5kLCBhcHBlbmQKCiAgICAkLmZuW29wZXJhdG9yXSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBhcmdUeXBlLCBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgIGFyZ1R5cGUgPSB0eXBlKGFyZykKICAgICAgICAgICAgcmV0dXJuIGFyZ1R5cGUgPT0gIm9iamVjdCIgfHwgYXJnVHlwZSA9PSAiYXJyYXkiIHx8IGFyZyA9PSBudWxsID8KICAgICAgICAgICAgICBhcmcgOiB6ZXB0by5mcmFnbWVudChhcmcpCiAgICAgICAgICB9KSwKICAgICAgICAgIHBhcmVudCwgY29weUJ5Q2xvbmUgPSB0aGlzLmxlbmd0aCA+IDEKICAgICAgaWYgKG5vZGVzLmxlbmd0aCA8IDEpIHJldHVybiB0aGlzCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKF8sIHRhcmdldCl7CiAgICAgICAgcGFyZW50ID0gaW5zaWRlID8gdGFyZ2V0IDogdGFyZ2V0LnBhcmVudE5vZGUKCiAgICAgICAgLy8gY29udmVydCBhbGwgbWV0aG9kcyB0byBhICJiZWZvcmUiIG9wZXJhdGlvbgogICAgICAgIHRhcmdldCA9IG9wZXJhdG9ySW5kZXggPT0gMCA/IHRhcmdldC5uZXh0U2libGluZyA6CiAgICAgICAgICAgICAgICAgb3BlcmF0b3JJbmRleCA9PSAxID8gdGFyZ2V0LmZpcnN0Q2hpbGQgOgogICAgICAgICAgICAgICAgIG9wZXJhdG9ySW5kZXggPT0gMiA/IHRhcmdldCA6CiAgICAgICAgICAgICAgICAgbnVsbAoKICAgICAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgaWYgKGNvcHlCeUNsb25lKSBub2RlID0gbm9kZS5jbG9uZU5vZGUodHJ1ZSkKICAgICAgICAgIGVsc2UgaWYgKCFwYXJlbnQpIHJldHVybiAkKG5vZGUpLnJlbW92ZSgpCgogICAgICAgICAgdHJhdmVyc2VOb2RlKHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgdGFyZ2V0KSwgZnVuY3Rpb24oZWwpewogICAgICAgICAgICBpZiAoZWwubm9kZU5hbWUgIT0gbnVsbCAmJiBlbC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJgogICAgICAgICAgICAgICAoIWVsLnR5cGUgfHwgZWwudHlwZSA9PT0gJ3RleHQvamF2YXNjcmlwdCcpICYmICFlbC5zcmMpCiAgICAgICAgICAgICAgd2luZG93WydldmFsJ10uY2FsbCh3aW5kb3csIGVsLmlubmVySFRNTCkKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgfSkKICAgIH0KCiAgICAvLyBhZnRlciAgICA9PiBpbnNlcnRBZnRlcgogICAgLy8gcHJlcGVuZCAgPT4gcHJlcGVuZFRvCiAgICAvLyBiZWZvcmUgICA9PiBpbnNlcnRCZWZvcmUKICAgIC8vIGFwcGVuZCAgID0+IGFwcGVuZFRvCiAgICAkLmZuW2luc2lkZSA/IG9wZXJhdG9yKydUbycgOiAnaW5zZXJ0Jysob3BlcmF0b3JJbmRleCA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClbb3BlcmF0b3JdKHRoaXMpCiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgemVwdG8uWi5wcm90b3R5cGUgPSAkLmZuCgogIC8vIEV4cG9ydCBpbnRlcm5hbCBBUEkgZnVuY3Rpb25zIGluIHRoZSBgJC56ZXB0b2AgbmFtZXNwYWNlCiAgemVwdG8udW5pcSA9IHVuaXEKICB6ZXB0by5kZXNlcmlhbGl6ZVZhbHVlID0gZGVzZXJpYWxpemVWYWx1ZQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgp3aW5kb3cuWmVwdG8gPSBaZXB0bwp3aW5kb3cuJCA9PT0gdW5kZWZpbmVkICYmICh3aW5kb3cuJCA9IFplcHRvKQoKOyhmdW5jdGlvbigkKXsKICB2YXIgJCQgPSAkLnplcHRvLnFzYSwgX3ppZCA9IDEsIHVuZGVmaW5lZCwKICAgICAgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgIGlzRnVuY3Rpb24gPSAkLmlzRnVuY3Rpb24sCiAgICAgIGlzU3RyaW5nID0gZnVuY3Rpb24ob2JqKXsgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ3N0cmluZycgfSwKICAgICAgaGFuZGxlcnMgPSB7fSwKICAgICAgc3BlY2lhbEV2ZW50cz17fSwKICAgICAgZm9jdXNpblN1cHBvcnRlZCA9ICdvbmZvY3VzaW4nIGluIHdpbmRvdywKICAgICAgZm9jdXMgPSB7IGZvY3VzOiAnZm9jdXNpbicsIGJsdXI6ICdmb2N1c291dCcgfSwKICAgICAgaG92ZXIgPSB7IG1vdXNlZW50ZXI6ICdtb3VzZW92ZXInLCBtb3VzZWxlYXZlOiAnbW91c2VvdXQnIH0KCiAgc3BlY2lhbEV2ZW50cy5jbGljayA9IHNwZWNpYWxFdmVudHMubW91c2Vkb3duID0gc3BlY2lhbEV2ZW50cy5tb3VzZXVwID0gc3BlY2lhbEV2ZW50cy5tb3VzZW1vdmUgPSAnTW91c2VFdmVudHMnCgogIGZ1bmN0aW9uIHppZChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5femlkIHx8IChlbGVtZW50Ll96aWQgPSBfemlkKyspCiAgfQogIGZ1bmN0aW9uIGZpbmRIYW5kbGVycyhlbGVtZW50LCBldmVudCwgZm4sIHNlbGVjdG9yKSB7CiAgICBldmVudCA9IHBhcnNlKGV2ZW50KQogICAgaWYgKGV2ZW50Lm5zKSB2YXIgbWF0Y2hlciA9IG1hdGNoZXJGb3IoZXZlbnQubnMpCiAgICByZXR1cm4gKGhhbmRsZXJzW3ppZChlbGVtZW50KV0gfHwgW10pLmZpbHRlcihmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgIHJldHVybiBoYW5kbGVyCiAgICAgICAgJiYgKCFldmVudC5lICB8fCBoYW5kbGVyLmUgPT0gZXZlbnQuZSkKICAgICAgICAmJiAoIWV2ZW50Lm5zIHx8IG1hdGNoZXIudGVzdChoYW5kbGVyLm5zKSkKICAgICAgICAmJiAoIWZuICAgICAgIHx8IHppZChoYW5kbGVyLmZuKSA9PT0gemlkKGZuKSkKICAgICAgICAmJiAoIXNlbGVjdG9yIHx8IGhhbmRsZXIuc2VsID09IHNlbGVjdG9yKQogICAgfSkKICB9CiAgZnVuY3Rpb24gcGFyc2UoZXZlbnQpIHsKICAgIHZhciBwYXJ0cyA9ICgnJyArIGV2ZW50KS5zcGxpdCgnLicpCiAgICByZXR1cm4ge2U6IHBhcnRzWzBdLCBuczogcGFydHMuc2xpY2UoMSkuc29ydCgpLmpvaW4oJyAnKX0KICB9CiAgZnVuY3Rpb24gbWF0Y2hlckZvcihucykgewogICAgcmV0dXJuIG5ldyBSZWdFeHAoJyg/Ol58ICknICsgbnMucmVwbGFjZSgnICcsICcgLiogPycpICsgJyg/OiB8JCknKQogIH0KCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKCFmb2N1c2luU3VwcG9ydGVkICYmIChoYW5kbGVyLmUgaW4gZm9jdXMpKSB8fAogICAgICAhIWNhcHR1cmVTZXR0aW5nCiAgfQoKICBmdW5jdGlvbiByZWFsRXZlbnQodHlwZSkgewogICAgcmV0dXJuIGhvdmVyW3R5cGVdIHx8IChmb2N1c2luU3VwcG9ydGVkICYmIGZvY3VzW3R5cGVdKSB8fCB0eXBlCiAgfQoKICBmdW5jdGlvbiBhZGQoZWxlbWVudCwgZXZlbnRzLCBmbiwgZGF0YSwgc2VsZWN0b3IsIGRlbGVnYXRvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCksIHNldCA9IChoYW5kbGVyc1tpZF0gfHwgKGhhbmRsZXJzW2lkXSA9IFtdKSkKICAgIGV2ZW50cy5zcGxpdCgvXHMvKS5mb3JFYWNoKGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50ID09ICdyZWFkeScpIHJldHVybiAkKGRvY3VtZW50KS5yZWFkeShmbikKICAgICAgdmFyIGhhbmRsZXIgICA9IHBhcnNlKGV2ZW50KQogICAgICBoYW5kbGVyLmZuICAgID0gZm4KICAgICAgaGFuZGxlci5zZWwgICA9IHNlbGVjdG9yCiAgICAgIC8vIGVtdWxhdGUgbW91c2VlbnRlciwgbW91c2VsZWF2ZQogICAgICBpZiAoaGFuZGxlci5lIGluIGhvdmVyKSBmbiA9IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciByZWxhdGVkID0gZS5yZWxhdGVkVGFyZ2V0CiAgICAgICAgaWYgKCFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0aGlzICYmICEkLmNvbnRhaW5zKHRoaXMsIHJlbGF0ZWQpKSkKICAgICAgICAgIHJldHVybiBoYW5kbGVyLmZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICAgICAgfQogICAgICBoYW5kbGVyLmRlbCAgID0gZGVsZWdhdG9yCiAgICAgIHZhciBjYWxsYmFjayAgPSBkZWxlZ2F0b3IgfHwgZm4KICAgICAgaGFuZGxlci5wcm94eSA9IGZ1bmN0aW9uKGUpewogICAgICAgIGUgPSBjb21wYXRpYmxlKGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuCiAgICAgICAgZS5kYXRhID0gZGF0YQogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjay5hcHBseShlbGVtZW50LCBlLl9hcmdzID09IHVuZGVmaW5lZCA/IFtlXSA6IFtlXS5jb25jYXQoZS5fYXJncykpCiAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIGUucHJldmVudERlZmF1bHQoKSwgZS5zdG9wUHJvcGFnYXRpb24oKQogICAgICAgIHJldHVybiByZXN1bHQKICAgICAgfQogICAgICBoYW5kbGVyLmkgPSBzZXQubGVuZ3RoCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGlmICgnYWRkRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCkKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIocmVhbEV2ZW50KGhhbmRsZXIuZSksIGhhbmRsZXIucHJveHksIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIDsoZXZlbnRzIHx8ICcnKS5zcGxpdCgvXHMvKS5mb3JFYWNoKGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LCBmbiwgc2VsZWN0b3IpLmZvckVhY2goZnVuY3Rpb24oaGFuZGxlcil7CiAgICAgICAgZGVsZXRlIGhhbmRsZXJzW2lkXVtoYW5kbGVyLmldCiAgICAgIGlmICgncmVtb3ZlRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCkKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIocmVhbEV2ZW50KGhhbmRsZXIuZSksIGhhbmRsZXIucHJveHksIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgICAgfSkKICAgIH0pCiAgfQoKICAkLmV2ZW50ID0geyBhZGQ6IGFkZCwgcmVtb3ZlOiByZW1vdmUgfQoKICAkLnByb3h5ID0gZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgIGlmIChpc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmIChpc1N0cmluZyhjb250ZXh0KSkgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgZGF0YSwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMub24oZXZlbnQsIGRhdGEsIGNhbGxiYWNrKQogIH0KICAkLmZuLnVuYmluZCA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5vZmYoZXZlbnQsIGNhbGxiYWNrKQogIH0KICAkLmZuLm9uZSA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgZGF0YSwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMub24oZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaywgMSkKICB9CgogIHZhciByZXR1cm5UcnVlID0gZnVuY3Rpb24oKXtyZXR1cm4gdHJ1ZX0sCiAgICAgIHJldHVybkZhbHNlID0gZnVuY3Rpb24oKXtyZXR1cm4gZmFsc2V9LAogICAgICBpZ25vcmVQcm9wZXJ0aWVzID0gL14oW0EtWl18cmV0dXJuVmFsdWUkfGxheWVyW1hZXSQpLywKICAgICAgZXZlbnRNZXRob2RzID0gewogICAgICAgIHByZXZlbnREZWZhdWx0OiAnaXNEZWZhdWx0UHJldmVudGVkJywKICAgICAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246ICdpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCcsCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiAnaXNQcm9wYWdhdGlvblN0b3BwZWQnCiAgICAgIH0KCiAgZnVuY3Rpb24gY29tcGF0aWJsZShldmVudCwgc291cmNlKSB7CiAgICBpZiAoc291cmNlIHx8ICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgc291cmNlIHx8IChzb3VyY2UgPSBldmVudCkKCiAgICAgICQuZWFjaChldmVudE1ldGhvZHMsIGZ1bmN0aW9uKG5hbWUsIHByZWRpY2F0ZSkgewogICAgICAgIHZhciBzb3VyY2VNZXRob2QgPSBzb3VyY2VbbmFtZV0KICAgICAgICBldmVudFtuYW1lXSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgICByZXR1cm4gc291cmNlTWV0aG9kICYmIHNvdXJjZU1ldGhvZC5hcHBseShzb3VyY2UsIGFyZ3VtZW50cykKICAgICAgICB9CiAgICAgICAgZXZlbnRbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICAgIH0pCgogICAgICBpZiAoc291cmNlLmRlZmF1bHRQcmV2ZW50ZWQgIT09IHVuZGVmaW5lZCA/IHNvdXJjZS5kZWZhdWx0UHJldmVudGVkIDoKICAgICAgICAgICdyZXR1cm5WYWx1ZScgaW4gc291cmNlID8gc291cmNlLnJldHVyblZhbHVlID09PSBmYWxzZSA6CiAgICAgICAgICBzb3VyY2UuZ2V0UHJldmVudERlZmF1bHQgJiYgc291cmNlLmdldFByZXZlbnREZWZhdWx0KCkpCiAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZQogICAgfQogICAgcmV0dXJuIGV2ZW50CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVQcm94eShldmVudCkgewogICAgdmFyIGtleSwgcHJveHkgPSB7IG9yaWdpbmFsRXZlbnQ6IGV2ZW50IH0KICAgIGZvciAoa2V5IGluIGV2ZW50KQogICAgICBpZiAoIWlnbm9yZVByb3BlcnRpZXMudGVzdChrZXkpICYmIGV2ZW50W2tleV0gIT09IHVuZGVmaW5lZCkgcHJveHlba2V5XSA9IGV2ZW50W2tleV0KCiAgICByZXR1cm4gY29tcGF0aWJsZShwcm94eSwgZXZlbnQpCiAgfQoKICAkLmZuLmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5vbihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKQogIH0KICAkLmZuLnVuZGVsZWdhdGUgPSBmdW5jdGlvbihzZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKXsKICAgIHJldHVybiB0aGlzLm9mZihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5saXZlID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkuZGVsZWdhdGUodGhpcy5zZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKQogICAgcmV0dXJuIHRoaXMKICB9CiAgJC5mbi5kaWUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgJChkb2N1bWVudC5ib2R5KS51bmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQoKICAkLmZuLm9uID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaywgb25lKXsKICAgIHZhciBhdXRvUmVtb3ZlLCBkZWxlZ2F0b3IsICR0aGlzID0gdGhpcwogICAgaWYgKGV2ZW50ICYmICFpc1N0cmluZyhldmVudCkpIHsKICAgICAgJC5lYWNoKGV2ZW50LCBmdW5jdGlvbih0eXBlLCBmbil7CiAgICAgICAgJHRoaXMub24odHlwZSwgc2VsZWN0b3IsIGRhdGEsIGZuLCBvbmUpCiAgICAgIH0pCiAgICAgIHJldHVybiAkdGhpcwogICAgfQoKICAgIGlmICghaXNTdHJpbmcoc2VsZWN0b3IpICYmICFpc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJiBjYWxsYmFjayAhPT0gZmFsc2UpCiAgICAgIGNhbGxiYWNrID0gZGF0YSwgZGF0YSA9IHNlbGVjdG9yLCBzZWxlY3RvciA9IHVuZGVmaW5lZAogICAgaWYgKGlzRnVuY3Rpb24oZGF0YSkgfHwgZGF0YSA9PT0gZmFsc2UpCiAgICAgIGNhbGxiYWNrID0gZGF0YSwgZGF0YSA9IHVuZGVmaW5lZAoKICAgIGlmIChjYWxsYmFjayA9PT0gZmFsc2UpIGNhbGxiYWNrID0gcmV0dXJuRmFsc2UKCiAgICByZXR1cm4gJHRoaXMuZWFjaChmdW5jdGlvbihfLCBlbGVtZW50KXsKICAgICAgaWYgKG9uZSkgYXV0b1JlbW92ZSA9IGZ1bmN0aW9uKGUpewogICAgICAgIHJlbW92ZShlbGVtZW50LCBlLnR5cGUsIGNhbGxiYWNrKQogICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICAgIH0KCiAgICAgIGlmIChzZWxlY3RvcikgZGVsZWdhdG9yID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGV2dCwgbWF0Y2ggPSAkKGUudGFyZ2V0KS5jbG9zZXN0KHNlbGVjdG9yLCBlbGVtZW50KS5nZXQoMCkKICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2ggIT09IGVsZW1lbnQpIHsKICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICByZXR1cm4gKGF1dG9SZW1vdmUgfHwgY2FsbGJhY2spLmFwcGx5KG1hdGNoLCBbZXZ0XS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGFkZChlbGVtZW50LCBldmVudCwgY2FsbGJhY2ssIGRhdGEsIHNlbGVjdG9yLCBkZWxlZ2F0b3IgfHwgYXV0b1JlbW92ZSkKICAgIH0pCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICB2YXIgJHRoaXMgPSB0aGlzCiAgICBpZiAoZXZlbnQgJiYgIWlzU3RyaW5nKGV2ZW50KSkgewogICAgICAkLmVhY2goZXZlbnQsIGZ1bmN0aW9uKHR5cGUsIGZuKXsKICAgICAgICAkdGhpcy5vZmYodHlwZSwgc2VsZWN0b3IsIGZuKQogICAgICB9KQogICAgICByZXR1cm4gJHRoaXMKICAgIH0KCiAgICBpZiAoIWlzU3RyaW5nKHNlbGVjdG9yKSAmJiAhaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2sgIT09IGZhbHNlKQogICAgICBjYWxsYmFjayA9IHNlbGVjdG9yLCBzZWxlY3RvciA9IHVuZGVmaW5lZAoKICAgIGlmIChjYWxsYmFjayA9PT0gZmFsc2UpIGNhbGxiYWNrID0gcmV0dXJuRmFsc2UKCiAgICByZXR1cm4gJHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrLCBzZWxlY3RvcikKICAgIH0pCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgYXJncyl7CiAgICBldmVudCA9IChpc1N0cmluZyhldmVudCkgfHwgJC5pc1BsYWluT2JqZWN0KGV2ZW50KSkgPyAkLkV2ZW50KGV2ZW50KSA6IGNvbXBhdGlibGUoZXZlbnQpCiAgICBldmVudC5fYXJncyA9IGFyZ3MKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgLy8gaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24gbWlnaHQgbm90IGJlIERPTSBlbGVtZW50cwogICAgICBpZignZGlzcGF0Y2hFdmVudCcgaW4gdGhpcykgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KQogICAgICBlbHNlICQodGhpcykudHJpZ2dlckhhbmRsZXIoZXZlbnQsIGFyZ3MpCiAgICB9KQogIH0KCiAgLy8gdHJpZ2dlcnMgZXZlbnQgaGFuZGxlcnMgb24gY3VycmVudCBlbGVtZW50IGp1c3QgYXMgaWYgYW4gZXZlbnQgb2NjdXJyZWQsCiAgLy8gZG9lc24ndCB0cmlnZ2VyIGFuIGFjdHVhbCBldmVudCwgZG9lc24ndCBidWJibGUKICAkLmZuLnRyaWdnZXJIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQsIGFyZ3MpewogICAgdmFyIGUsIHJlc3VsdAogICAgdGhpcy5lYWNoKGZ1bmN0aW9uKGksIGVsZW1lbnQpewogICAgICBlID0gY3JlYXRlUHJveHkoaXNTdHJpbmcoZXZlbnQpID8gJC5FdmVudChldmVudCkgOiBldmVudCkKICAgICAgZS5fYXJncyA9IGFyZ3MKICAgICAgZS50YXJnZXQgPSBlbGVtZW50CiAgICAgICQuZWFjaChmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQudHlwZSB8fCBldmVudCksIGZ1bmN0aW9uKGksIGhhbmRsZXIpewogICAgICAgIHJlc3VsdCA9IGhhbmRsZXIucHJveHkoZSkKICAgICAgICBpZiAoZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSByZXR1cm4gZmFsc2UKICAgICAgfSkKICAgIH0pCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvLyBzaG9ydGN1dCBtZXRob2RzIGZvciBgLmJpbmQoZXZlbnQsIGZuKWAgZm9yIGVhY2ggZXZlbnQgdHlwZQogIDsoJ2ZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAnKwogICdtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8KICAgICAgICB0aGlzLmJpbmQoZXZlbnQsIGNhbGxiYWNrKSA6CiAgICAgICAgdGhpcy50cmlnZ2VyKGV2ZW50KQogICAgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICB0cnkgeyB0aGlzW25hbWVdKCkgfQogICAgICAgIGNhdGNoKGUpIHt9CiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICBpZiAoIWlzU3RyaW5nKHR5cGUpKSBwcm9wcyA9IHR5cGUsIHR5cGUgPSBwcm9wcy50eXBlCiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlKQogICAgcmV0dXJuIGNvbXBhdGlibGUoZXZlbnQpCiAgfQoKfSkoWmVwdG8pCgo7KGZ1bmN0aW9uKCQpewogIHZhciBqc29ucElEID0gMCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpCiAgfQoKICAvLyB0cmlnZ2VyIGFuIEFqYXggImdsb2JhbCIgZXZlbnQKICBmdW5jdGlvbiB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCBldmVudE5hbWUsIGRhdGEpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwpIHJldHVybiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQgfHwgZG9jdW1lbnQsIGV2ZW50TmFtZSwgZGF0YSkKICB9CgogIC8vIE51bWJlciBvZiBhY3RpdmUgQWpheCByZXF1ZXN0cwogICQuYWN0aXZlID0gMAoKICBmdW5jdGlvbiBhamF4U3RhcnQoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgJC5hY3RpdmUrKyA9PT0gMCkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdGFydCcpCiAgfQogIGZ1bmN0aW9uIGFqYXhTdG9wKHNldHRpbmdzKSB7CiAgICBpZiAoc2V0dGluZ3MuZ2xvYmFsICYmICEoLS0kLmFjdGl2ZSkpIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIG51bGwsICdhamF4U3RvcCcpCiAgfQoKICAvLyB0cmlnZ2VycyBhbiBleHRyYSBnbG9iYWwgZXZlbnQgImFqYXhCZWZvcmVTZW5kIiB0aGF0J3MgbGlrZSAiYWpheFNlbmQiIGJ1dCBjYW5jZWxhYmxlCiAgZnVuY3Rpb24gYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBpZiAoc2V0dGluZ3MuYmVmb3JlU2VuZC5jYWxsKGNvbnRleHQsIHhociwgc2V0dGluZ3MpID09PSBmYWxzZSB8fAogICAgICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4QmVmb3JlU2VuZCcsIFt4aHIsIHNldHRpbmdzXSkgPT09IGZhbHNlKQogICAgICByZXR1cm4gZmFsc2UKCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheFNlbmQnLCBbeGhyLCBzZXR0aW5nc10pCiAgfQogIGZ1bmN0aW9uIGFqYXhTdWNjZXNzKGRhdGEsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQsIHN0YXR1cyA9ICdzdWNjZXNzJwogICAgc2V0dGluZ3Muc3VjY2Vzcy5jYWxsKGNvbnRleHQsIGRhdGEsIHN0YXR1cywgeGhyKQogICAgaWYgKGRlZmVycmVkKSBkZWZlcnJlZC5yZXNvbHZlV2l0aChjb250ZXh0LCBbZGF0YSwgc3RhdHVzLCB4aHJdKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhTdWNjZXNzJywgW3hociwgc2V0dGluZ3MsIGRhdGFdKQogICAgYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykKICB9CiAgLy8gdHlwZTogInRpbWVvdXQiLCAiZXJyb3IiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheEVycm9yKGVycm9yLCB0eXBlLCB4aHIsIHNldHRpbmdzLCBkZWZlcnJlZCkgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICBpZiAoZGVmZXJyZWQpIGRlZmVycmVkLnJlamVjdFdpdGgoY29udGV4dCwgW3hociwgdHlwZSwgZXJyb3JdKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhFcnJvcicsIFt4aHIsIHNldHRpbmdzLCBlcnJvciB8fCB0eXBlXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zLCBkZWZlcnJlZCl7CiAgICBpZiAoISgndHlwZScgaW4gb3B0aW9ucykpIHJldHVybiAkLmFqYXgob3B0aW9ucykKCiAgICB2YXIgX2NhbGxiYWNrTmFtZSA9IG9wdGlvbnMuanNvbnBDYWxsYmFjaywKICAgICAgY2FsbGJhY2tOYW1lID0gKCQuaXNGdW5jdGlvbihfY2FsbGJhY2tOYW1lKSA/CiAgICAgICAgX2NhbGxiYWNrTmFtZSgpIDogX2NhbGxiYWNrTmFtZSkgfHwgKCdqc29ucCcgKyAoKytqc29ucElEKSksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBvcmlnaW5hbENhbGxiYWNrID0gd2luZG93W2NhbGxiYWNrTmFtZV0sCiAgICAgIHJlc3BvbnNlRGF0YSwKICAgICAgYWJvcnQgPSBmdW5jdGlvbihlcnJvclR5cGUpIHsKICAgICAgICAkKHNjcmlwdCkudHJpZ2dlckhhbmRsZXIoJ2Vycm9yJywgZXJyb3JUeXBlIHx8ICdhYm9ydCcpCiAgICAgIH0sCiAgICAgIHhociA9IHsgYWJvcnQ6IGFib3J0IH0sIGFib3J0VGltZW91dAoKICAgIGlmIChkZWZlcnJlZCkgZGVmZXJyZWQucHJvbWlzZSh4aHIpCgogICAgJChzY3JpcHQpLm9uKCdsb2FkIGVycm9yJywgZnVuY3Rpb24oZSwgZXJyb3JUeXBlKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLm9mZigpLnJlbW92ZSgpCgogICAgICBpZiAoZS50eXBlID09ICdlcnJvcicgfHwgIXJlc3BvbnNlRGF0YSkgewogICAgICAgIGFqYXhFcnJvcihudWxsLCBlcnJvclR5cGUgfHwgJ2Vycm9yJywgeGhyLCBvcHRpb25zLCBkZWZlcnJlZCkKICAgICAgfSBlbHNlIHsKICAgICAgICBhamF4U3VjY2VzcyhyZXNwb25zZURhdGFbMF0sIHhociwgb3B0aW9ucywgZGVmZXJyZWQpCiAgICAgIH0KCiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gb3JpZ2luYWxDYWxsYmFjawogICAgICBpZiAocmVzcG9uc2VEYXRhICYmICQuaXNGdW5jdGlvbihvcmlnaW5hbENhbGxiYWNrKSkKICAgICAgICBvcmlnaW5hbENhbGxiYWNrKHJlc3BvbnNlRGF0YVswXSkKCiAgICAgIG9yaWdpbmFsQ2FsbGJhY2sgPSByZXNwb25zZURhdGEgPSB1bmRlZmluZWQKICAgIH0pCgogICAgaWYgKGFqYXhCZWZvcmVTZW5kKHhociwgb3B0aW9ucykgPT09IGZhbHNlKSB7CiAgICAgIGFib3J0KCdhYm9ydCcpCiAgICAgIHJldHVybiB4aHIKICAgIH0KCiAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7CiAgICAgIHJlc3BvbnNlRGF0YSA9IGFyZ3VtZW50cwogICAgfQoKICAgIHNjcmlwdC5zcmMgPSBvcHRpb25zLnVybC5yZXBsYWNlKC89XD8vLCAnPScgKyBjYWxsYmFja05hbWUpCiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCkKCiAgICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICBhYm9ydCgndGltZW91dCcpCiAgICB9LCBvcHRpb25zLnRpbWVvdXQpCgogICAgcmV0dXJuIHhocgogIH0KCiAgJC5hamF4U2V0dGluZ3MgPSB7CiAgICAvLyBEZWZhdWx0IHR5cGUgb2YgcmVxdWVzdAogICAgdHlwZTogJ0dFVCcsCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIGJlZm9yZSByZXF1ZXN0CiAgICBiZWZvcmVTZW5kOiBlbXB0eSwKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMKICAgIHN1Y2Nlc3M6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCB0aGUgdGhlIHNlcnZlciBkcm9wcyBlcnJvcgogICAgZXJyb3I6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBvbiByZXF1ZXN0IGNvbXBsZXRlIChib3RoOiBlcnJvciBhbmQgc3VjY2VzcykKICAgIGNvbXBsZXRlOiBlbXB0eSwKICAgIC8vIFRoZSBjb250ZXh0IGZvciB0aGUgY2FsbGJhY2tzCiAgICBjb250ZXh0OiBudWxsLAogICAgLy8gV2hldGhlciB0byB0cmlnZ2VyICJnbG9iYWwiIEFqYXggZXZlbnRzCiAgICBnbG9iYWw6IHRydWUsCiAgICAvLyBUcmFuc3BvcnQKICAgIHhocjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpCiAgICB9LAogICAgLy8gTUlNRSB0eXBlcyBtYXBwaW5nCiAgICAvLyBJSVMgcmV0dXJucyBKYXZhc2NyaXB0IGFzICJhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQiCiAgICBhY2NlcHRzOiB7CiAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwLAogICAgLy8gV2hldGhlciBkYXRhIHNob3VsZCBiZSBzZXJpYWxpemVkIHRvIHN0cmluZwogICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICAvLyBXaGV0aGVyIHRoZSBicm93c2VyIHNob3VsZCBiZSBhbGxvd2VkIHRvIGNhY2hlIEdFVCByZXNwb25zZXMKICAgIGNhY2hlOiB0cnVlCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICBpZiAobWltZSkgbWltZSA9IG1pbWUuc3BsaXQoJzsnLCAyKVswXQogICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IGh0bWxUeXBlID8gJ2h0bWwnIDoKICAgICAgbWltZSA9PSBqc29uVHlwZSA/ICdqc29uJyA6CiAgICAgIHNjcmlwdFR5cGVSRS50ZXN0KG1pbWUpID8gJ3NjcmlwdCcgOgogICAgICB4bWxUeXBlUkUudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogIH0KCiAgZnVuY3Rpb24gYXBwZW5kUXVlcnkodXJsLCBxdWVyeSkgewogICAgaWYgKHF1ZXJ5ID09ICcnKSByZXR1cm4gdXJsCiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMucHJvY2Vzc0RhdGEgJiYgb3B0aW9ucy5kYXRhICYmICQudHlwZShvcHRpb25zLmRhdGEpICE9ICJzdHJpbmciKQogICAgICBvcHRpb25zLmRhdGEgPSAkLnBhcmFtKG9wdGlvbnMuZGF0YSwgb3B0aW9ucy50cmFkaXRpb25hbCkKICAgIGlmIChvcHRpb25zLmRhdGEgJiYgKCFvcHRpb25zLnR5cGUgfHwgb3B0aW9ucy50eXBlLnRvVXBwZXJDYXNlKCkgPT0gJ0dFVCcpKQogICAgICBvcHRpb25zLnVybCA9IGFwcGVuZFF1ZXJ5KG9wdGlvbnMudXJsLCBvcHRpb25zLmRhdGEpLCBvcHRpb25zLmRhdGEgPSB1bmRlZmluZWQKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pLAogICAgICAgIGRlZmVycmVkID0gJC5EZWZlcnJlZCAmJiAkLkRlZmVycmVkKCkKICAgIGZvciAoa2V5IGluICQuYWpheFNldHRpbmdzKSBpZiAoc2V0dGluZ3Nba2V5XSA9PT0gdW5kZWZpbmVkKSBzZXR0aW5nc1trZXldID0gJC5hamF4U2V0dGluZ3Nba2V5XQoKICAgIGFqYXhTdGFydChzZXR0aW5ncykKCiAgICBpZiAoIXNldHRpbmdzLmNyb3NzRG9tYWluKSBzZXR0aW5ncy5jcm9zc0RvbWFpbiA9IC9eKFtcdy1dKzopP1wvXC8oW15cL10rKS8udGVzdChzZXR0aW5ncy51cmwpICYmCiAgICAgIFJlZ0V4cC4kMiAhPSB3aW5kb3cubG9jYXRpb24uaG9zdAoKICAgIGlmICghc2V0dGluZ3MudXJsKSBzZXR0aW5ncy51cmwgPSB3aW5kb3cubG9jYXRpb24udG9TdHJpbmcoKQogICAgc2VyaWFsaXplRGF0YShzZXR0aW5ncykKICAgIGlmIChzZXR0aW5ncy5jYWNoZSA9PT0gZmFsc2UpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ189JyArIERhdGUubm93KCkpCgogICAgdmFyIGRhdGFUeXBlID0gc2V0dGluZ3MuZGF0YVR5cGUsIGhhc1BsYWNlaG9sZGVyID0gLz1cPy8udGVzdChzZXR0aW5ncy51cmwpCiAgICBpZiAoZGF0YVR5cGUgPT0gJ2pzb25wJyB8fCBoYXNQbGFjZWhvbGRlcikgewogICAgICBpZiAoIWhhc1BsYWNlaG9sZGVyKQogICAgICAgIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwKICAgICAgICAgIHNldHRpbmdzLmpzb25wID8gKHNldHRpbmdzLmpzb25wICsgJz0/JykgOiBzZXR0aW5ncy5qc29ucCA9PT0gZmFsc2UgPyAnJyA6ICdjYWxsYmFjaz0/JykKICAgICAgcmV0dXJuICQuYWpheEpTT05QKHNldHRpbmdzLCBkZWZlcnJlZCkKICAgIH0KCiAgICB2YXIgbWltZSA9IHNldHRpbmdzLmFjY2VwdHNbZGF0YVR5cGVdLAogICAgICAgIGhlYWRlcnMgPSB7IH0sCiAgICAgICAgc2V0SGVhZGVyID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsgaGVhZGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldID0gW25hbWUsIHZhbHVlXSB9LAogICAgICAgIHByb3RvY29sID0gL14oW1x3LV0rOilcL1wvLy50ZXN0KHNldHRpbmdzLnVybCkgPyBSZWdFeHAuJDEgOiB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wsCiAgICAgICAgeGhyID0gc2V0dGluZ3MueGhyKCksCiAgICAgICAgbmF0aXZlU2V0SGVhZGVyID0geGhyLnNldFJlcXVlc3RIZWFkZXIsCiAgICAgICAgYWJvcnRUaW1lb3V0CgogICAgaWYgKGRlZmVycmVkKSBkZWZlcnJlZC5wcm9taXNlKHhocikKCiAgICBpZiAoIXNldHRpbmdzLmNyb3NzRG9tYWluKSBzZXRIZWFkZXIoJ1gtUmVxdWVzdGVkLVdpdGgnLCAnWE1MSHR0cFJlcXVlc3QnKQogICAgc2V0SGVhZGVyKCdBY2NlcHQnLCBtaW1lIHx8ICcqLyonKQogICAgaWYgKG1pbWUgPSBzZXR0aW5ncy5taW1lVHlwZSB8fCBtaW1lKSB7CiAgICAgIGlmIChtaW1lLmluZGV4T2YoJywnKSA+IC0xKSBtaW1lID0gbWltZS5zcGxpdCgnLCcsIDIpWzBdCiAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICB9CiAgICBpZiAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgKHNldHRpbmdzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSAmJiBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUudG9VcHBlckNhc2UoKSAhPSAnR0VUJykpCiAgICAgIHNldEhlYWRlcignQ29udGVudC1UeXBlJywgc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCgogICAgaWYgKHNldHRpbmdzLmhlYWRlcnMpIGZvciAobmFtZSBpbiBzZXR0aW5ncy5oZWFkZXJzKSBzZXRIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyID0gc2V0SGVhZGVyCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHNldHRpbmdzLm1pbWVUeXBlIHx8IHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vZ2xvYmFsLWV2YWwtd2hhdC1hcmUtdGhlLW9wdGlvbnMvCiAgICAgICAgICAgIGlmIChkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICBlbHNlIGlmIChkYXRhVHlwZSA9PSAneG1sJykgIHJlc3VsdCA9IHhoci5yZXNwb25zZVhNTAogICAgICAgICAgICBlbHNlIGlmIChkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IGJsYW5rUkUudGVzdChyZXN1bHQpID8gbnVsbCA6ICQucGFyc2VKU09OKHJlc3VsdCkKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgZXJyb3IgPSBlIH0KCiAgICAgICAgICBpZiAoZXJyb3IpIGFqYXhFcnJvcihlcnJvciwgJ3BhcnNlcmVycm9yJywgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFqYXhFcnJvcih4aHIuc3RhdHVzVGV4dCB8fCBudWxsLCB4aHIuc3RhdHVzID8gJ2Vycm9yJyA6ICdhYm9ydCcsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSA9PT0gZmFsc2UpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgYWpheEVycm9yKG51bGwsICdhYm9ydCcsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKQogICAgICByZXR1cm4geGhyCiAgICB9CgogICAgaWYgKHNldHRpbmdzLnhockZpZWxkcykgZm9yIChuYW1lIGluIHNldHRpbmdzLnhockZpZWxkcykgeGhyW25hbWVdID0gc2V0dGluZ3MueGhyRmllbGRzW25hbWVdCgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYywgc2V0dGluZ3MudXNlcm5hbWUsIHNldHRpbmdzLnBhc3N3b3JkKQoKICAgIGZvciAobmFtZSBpbiBoZWFkZXJzKSBuYXRpdmVTZXRIZWFkZXIuYXBwbHkoeGhyLCBoZWFkZXJzW25hbWVdKQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgIH0sIHNldHRpbmdzLnRpbWVvdXQpCgogICAgLy8gYXZvaWQgc2VuZGluZyBlbXB0eSBzdHJpbmcgKCMzMTkpCiAgICB4aHIuc2VuZChzZXR0aW5ncy5kYXRhID8gc2V0dGluZ3MuZGF0YSA6IG51bGwpCiAgICByZXR1cm4geGhyCiAgfQoKICAvLyBoYW5kbGUgb3B0aW9uYWwgZGF0YS9zdWNjZXNzIGFyZ3VtZW50cwogIGZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUpIHsKICAgIHZhciBoYXNEYXRhID0gISQuaXNGdW5jdGlvbihkYXRhKQogICAgcmV0dXJuIHsKICAgICAgdXJsOiAgICAgIHVybCwKICAgICAgZGF0YTogICAgIGhhc0RhdGEgID8gZGF0YSA6IHVuZGVmaW5lZCwKICAgICAgc3VjY2VzczogICFoYXNEYXRhID8gZGF0YSA6ICQuaXNGdW5jdGlvbihzdWNjZXNzKSA/IHN1Y2Nlc3MgOiB1bmRlZmluZWQsCiAgICAgIGRhdGFUeXBlOiBoYXNEYXRhICA/IGRhdGFUeXBlIHx8IHN1Y2Nlc3MgOiBzdWNjZXNzCiAgICB9CiAgfQoKICAkLmdldCA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUpewogICAgcmV0dXJuICQuYWpheChwYXJzZUFyZ3VtZW50cy5hcHBseShudWxsLCBhcmd1bWVudHMpKQogIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICB2YXIgb3B0aW9ucyA9IHBhcnNlQXJndW1lbnRzLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgIG9wdGlvbnMudHlwZSA9ICdQT1NUJwogICAgcmV0dXJuICQuYWpheChvcHRpb25zKQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzKXsKICAgIHZhciBvcHRpb25zID0gcGFyc2VBcmd1bWVudHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgb3B0aW9ucy5kYXRhVHlwZSA9ICdqc29uJwogICAgcmV0dXJuICQuYWpheChvcHRpb25zKQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvciwKICAgICAgICBvcHRpb25zID0gcGFyc2VBcmd1bWVudHModXJsLCBkYXRhLCBzdWNjZXNzKSwKICAgICAgICBjYWxsYmFjayA9IG9wdGlvbnMuc3VjY2VzcwogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIG9wdGlvbnMudXJsID0gcGFydHNbMF0sIHNlbGVjdG9yID0gcGFydHNbMV0KICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKCc8ZGl2PicpLmh0bWwocmVzcG9uc2UucmVwbGFjZShyc2NyaXB0LCAiIikpLmZpbmQoc2VsZWN0b3IpCiAgICAgICAgOiByZXNwb25zZSkKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgfQogICAgJC5hamF4KG9wdGlvbnMpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdmFyIGVzY2FwZSA9IGVuY29kZVVSSUNvbXBvbmVudAoKICBmdW5jdGlvbiBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsLCBzY29wZSl7CiAgICB2YXIgdHlwZSwgYXJyYXkgPSAkLmlzQXJyYXkob2JqKSwgaGFzaCA9ICQuaXNQbGFpbk9iamVjdChvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHR5cGUgPSAkLnR5cGUodmFsdWUpCiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6CiAgICAgICAgc2NvcGUgKyAnWycgKyAoaGFzaCB8fCB0eXBlID09ICdvYmplY3QnIHx8IHR5cGUgPT0gJ2FycmF5JyA/IGtleSA6ICcnKSArICddJwogICAgICAvLyBoYW5kbGUgZGF0YSBpbiBzZXJpYWxpemVBcnJheSgpIGZvcm1hdAogICAgICBpZiAoIXNjb3BlICYmIGFycmF5KSBwYXJhbXMuYWRkKHZhbHVlLm5hbWUsIHZhbHVlLnZhbHVlKQogICAgICAvLyByZWN1cnNlIGludG8gbmVzdGVkIG9iamVjdHMKICAgICAgZWxzZSBpZiAodHlwZSA9PSAiYXJyYXkiIHx8ICghdHJhZGl0aW9uYWwgJiYgdHlwZSA9PSAib2JqZWN0IikpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgvJTIwL2csICcrJykKICB9Cn0pKFplcHRvKQoKOyhmdW5jdGlvbigkKXsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzdWx0ID0gW10sIGVsCiAgICAkKFtdLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbigpewogICAgdmFyIHJlc3VsdCA9IFtdCiAgICB0aGlzLnNlcmlhbGl6ZUFycmF5KCkuZm9yRWFjaChmdW5jdGlvbihlbG0pewogICAgICByZXN1bHQucHVzaChlbmNvZGVVUklDb21wb25lbnQoZWxtLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGVsbS52YWx1ZSkpCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIGlmIChjYWxsYmFjaykgdGhpcy5iaW5kKCdzdWJtaXQnLCBjYWxsYmFjaykKICAgIGVsc2UgaWYgKHRoaXMubGVuZ3RoKSB7CiAgICAgIHZhciBldmVudCA9ICQuRXZlbnQoJ3N1Ym1pdCcpCiAgICAgIHRoaXMuZXEoMCkudHJpZ2dlcihldmVudCkKICAgICAgaWYgKCFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCgo7KGZ1bmN0aW9uKCQpewogIC8vIF9fcHJvdG9fXyBkb2Vzbid0IGV4aXN0IG9uIElFPDExLCBzbyByZWRlZmluZQogIC8vIHRoZSBaIGZ1bmN0aW9uIHRvIHVzZSBvYmplY3QgZXh0ZW5zaW9uIGluc3RlYWQKICBpZiAoISgnX19wcm90b19fJyBpbiB7fSkpIHsKICAgICQuZXh0ZW5kKCQuemVwdG8sIHsKICAgICAgWjogZnVuY3Rpb24oZG9tLCBzZWxlY3Rvcil7CiAgICAgICAgZG9tID0gZG9tIHx8IFtdCiAgICAgICAgJC5leHRlbmQoZG9tLCAkLmZuKQogICAgICAgIGRvbS5zZWxlY3RvciA9IHNlbGVjdG9yIHx8ICcnCiAgICAgICAgZG9tLl9fWiA9IHRydWUKICAgICAgICByZXR1cm4gZG9tCiAgICAgIH0sCiAgICAgIC8vIHRoaXMgaXMgYSBrbHVkZ2UgYnV0IHdvcmtzCiAgICAgIGlzWjogZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICByZXR1cm4gJC50eXBlKG9iamVjdCkgPT09ICdhcnJheScgJiYgJ19fWicgaW4gb2JqZWN0CiAgICAgIH0KICAgIH0pCiAgfQoKICAvLyBnZXRDb21wdXRlZFN0eWxlIHNob3VsZG4ndCBmcmVhayBvdXQgd2hlbiBjYWxsZWQKICAvLyB3aXRob3V0IGEgdmFsaWQgZWxlbWVudCBhcyBhcmd1bWVudAogIHRyeSB7CiAgICBnZXRDb21wdXRlZFN0eWxlKHVuZGVmaW5lZCkKICB9IGNhdGNoKGUpIHsKICAgIHZhciBuYXRpdmVHZXRDb21wdXRlZFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZTsKICAgIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlID0gZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5hdGl2ZUdldENvbXB1dGVkU3R5bGUoZWxlbWVudCkKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQogICAgfQogIH0KfSkoWmVwdG8pCi8qCgpDb3B5cmlnaHQgKEMpIDIwMTEgYnkgWWVodWRhIEthdHoKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgpUSEUgU09GVFdBUkUuCgoqLwoKLy8gbGliL2hhbmRsZWJhcnMvYnJvd3Nlci1wcmVmaXguanMKdmFyIEhhbmRsZWJhcnMgPSB7fTsKCihmdW5jdGlvbihIYW5kbGViYXJzLCB1bmRlZmluZWQpIHsKOwovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgpIYW5kbGViYXJzLlZFUlNJT04gPSAiMS4wLjAiOwpIYW5kbGViYXJzLkNPTVBJTEVSX1JFVklTSU9OID0gNDsKCkhhbmRsZWJhcnMuUkVWSVNJT05fQ0hBTkdFUyA9IHsKICAxOiAnPD0gMS4wLnJjLjInLCAvLyAxLjAucmMuMiBpcyBhY3R1YWxseSByZXYyIGJ1dCBkb2Vzbid0IHJlcG9ydCBpdAogIDI6ICc9PSAxLjAuMC1yYy4zJywKICAzOiAnPT0gMS4wLjAtcmMuNCcsCiAgNDogJz49IDEuMC4wJwp9OwoKSGFuZGxlYmFycy5oZWxwZXJzICA9IHt9OwpIYW5kbGViYXJzLnBhcnRpYWxzID0ge307Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgZnVuY3Rpb25UeXBlID0gJ1tvYmplY3QgRnVuY3Rpb25dJywKICAgIG9iamVjdFR5cGUgPSAnW29iamVjdCBPYmplY3RdJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CiAgICBpZiAoaW52ZXJzZSB8fCBmbikgeyB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oJ0FyZyBub3Qgc3VwcG9ydGVkIHdpdGggbXVsdGlwbGUgaGVscGVycycpOyB9CiAgICBIYW5kbGViYXJzLlV0aWxzLmV4dGVuZCh0aGlzLmhlbHBlcnMsIG5hbWUpOwogIH0gZWxzZSB7CiAgICBpZiAoaW52ZXJzZSkgeyBmbi5ub3QgPSBpbnZlcnNlOyB9CiAgICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmbjsKICB9Cn07CgpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCA9IGZ1bmN0aW9uKG5hbWUsIHN0cikgewogIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CiAgICBIYW5kbGViYXJzLlV0aWxzLmV4dGVuZCh0aGlzLnBhcnRpYWxzLCAgbmFtZSk7CiAgfSBlbHNlIHsKICAgIHRoaXMucGFydGlhbHNbbmFtZV0gPSBzdHI7CiAgfQp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBoZWxwZXI6ICciICsgYXJnICsgIiciKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwoKICBpZih0eXBlID09PSBmdW5jdGlvblR5cGUpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoKICBpZihjb250ZXh0ID09PSB0cnVlKSB7CiAgICByZXR1cm4gZm4odGhpcyk7CiAgfSBlbHNlIGlmKGNvbnRleHQgPT09IGZhbHNlIHx8IGNvbnRleHQgPT0gbnVsbCkgewogICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgfSBlbHNlIGlmKHR5cGUgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgIGlmKGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzLmVhY2goY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuIGZuKGNvbnRleHQpOwogIH0KfSk7CgpIYW5kbGViYXJzLksgPSBmdW5jdGlvbigpIHt9OwoKSGFuZGxlYmFycy5jcmVhdGVGcmFtZSA9IE9iamVjdC5jcmVhdGUgfHwgZnVuY3Rpb24ob2JqZWN0KSB7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG9iamVjdDsKICB2YXIgb2JqID0gbmV3IEhhbmRsZWJhcnMuSygpOwogIEhhbmRsZWJhcnMuSy5wcm90b3R5cGUgPSBudWxsOwogIHJldHVybiBvYmo7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICBtZXRob2RNYXA6IHswOiAnZGVidWcnLCAxOiAnaW5mbycsIDI6ICd3YXJuJywgMzogJ2Vycm9yJ30sCgogIC8vIGNhbiBiZSBvdmVycmlkZGVuIGluIHRoZSBob3N0IGVudmlyb25tZW50CiAgbG9nOiBmdW5jdGlvbihsZXZlbCwgb2JqKSB7CiAgICBpZiAoSGFuZGxlYmFycy5sb2dnZXIubGV2ZWwgPD0gbGV2ZWwpIHsKICAgICAgdmFyIG1ldGhvZCA9IEhhbmRsZWJhcnMubG9nZ2VyLm1ldGhvZE1hcFtsZXZlbF07CiAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29uc29sZVttZXRob2RdKSB7CiAgICAgICAgY29uc29sZVttZXRob2RdLmNhbGwoY29uc29sZSwgb2JqKTsKICAgICAgfQogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIG9iaikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIG9iaik7IH07CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlYWNoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgdmFyIGkgPSAwLCByZXQgPSAiIiwgZGF0YTsKCiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0ID09PSAnb2JqZWN0JykgewogICAgaWYoY29udGV4dCBpbnN0YW5jZW9mIEFycmF5KXsKICAgICAgZm9yKHZhciBqID0gY29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgICAgaWYgKGRhdGEpIHsgZGF0YS5pbmRleCA9IGk7IH0KICAgICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2ldLCB7IGRhdGE6IGRhdGEgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvcih2YXIga2V5IGluIGNvbnRleHQpIHsKICAgICAgICBpZihjb250ZXh0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGlmKGRhdGEpIHsgZGF0YS5rZXkgPSBrZXk7IH0KICAgICAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRba2V5XSwge2RhdGE6IGRhdGF9KTsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGlmKGkgPT09IDApewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CgogIHJldHVybiByZXQ7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWYnLCBmdW5jdGlvbihjb25kaXRpb25hbCwgb3B0aW9ucykgewogIHZhciB0eXBlID0gdG9TdHJpbmcuY2FsbChjb25kaXRpb25hbCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWwuY2FsbCh0aGlzKTsgfQoKICBpZighY29uZGl0aW9uYWwgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbmRpdGlvbmFsKSkgewogICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VubGVzcycsIGZ1bmN0aW9uKGNvbmRpdGlvbmFsLCBvcHRpb25zKSB7CiAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyc1snaWYnXS5jYWxsKHRoaXMsIGNvbmRpdGlvbmFsLCB7Zm46IG9wdGlvbnMuaW52ZXJzZSwgaW52ZXJzZTogb3B0aW9ucy5mbn0pOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3dpdGgnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmICghSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGxldmVsID0gb3B0aW9ucy5kYXRhICYmIG9wdGlvbnMuZGF0YS5sZXZlbCAhPSBudWxsID8gcGFyc2VJbnQob3B0aW9ucy5kYXRhLmxldmVsLCAxMCkgOiAxOwogIEhhbmRsZWJhcnMubG9nKGxldmVsLCBjb250ZXh0KTsKfSk7CjsKLy8gbGliL2hhbmRsZWJhcnMvdXRpbHMuanMKCnZhciBlcnJvclByb3BzID0gWydkZXNjcmlwdGlvbicsICdmaWxlTmFtZScsICdsaW5lTnVtYmVyJywgJ21lc3NhZ2UnLCAnbmFtZScsICdudW1iZXInLCAnc3RhY2snXTsKCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgLy8gVW5mb3J0dW5hdGVseSBlcnJvcnMgYXJlIG5vdCBlbnVtZXJhYmxlIGluIENocm9tZSAoYXQgbGVhc3QpLCBzbyBgZm9yIHByb3AgaW4gdG1wYCBkb2Vzbid0IHdvcmsuCiAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgZXJyb3JQcm9wcy5sZW5ndGg7IGlkeCsrKSB7CiAgICB0aGlzW2Vycm9yUHJvcHNbaWR4XV0gPSB0bXBbZXJyb3JQcm9wc1tpZHhdXTsKICB9Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCnZhciBlc2NhcGUgPSB7CiAgIiYiOiAiJmFtcDsiLAogICI8IjogIiZsdDsiLAogICI+IjogIiZndDsiLAogICciJzogIiZxdW90OyIsCiAgIiciOiAiJiN4Mjc7IiwKICAiYCI6ICImI3g2MDsiCn07Cgp2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYF0vZzsKdmFyIHBvc3NpYmxlID0gL1smPD4iJ2BdLzsKCnZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7Cn07CgpIYW5kbGViYXJzLlV0aWxzID0gewogIGV4dGVuZDogZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewogICAgZm9yKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgaWYodmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIG9ialtrZXldID0gdmFsdWVba2V5XTsKICAgICAgfQogICAgfQogIH0sCgogIGVzY2FwZUV4cHJlc3Npb246IGZ1bmN0aW9uKHN0cmluZykgewogICAgLy8gZG9uJ3QgZXNjYXBlIFNhZmVTdHJpbmdzLCBzaW5jZSB0aGV5J3JlIGFscmVhZHkgc2FmZQogICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgaWYgKHN0cmluZyA9PSBudWxsIHx8IHN0cmluZyA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuICIiOwogICAgfQoKICAgIC8vIEZvcmNlIGEgc3RyaW5nIGNvbnZlcnNpb24gYXMgdGhpcyB3aWxsIGJlIGRvbmUgYnkgdGhlIGFwcGVuZCByZWdhcmRsZXNzIGFuZAogICAgLy8gdGhlIHJlZ2V4IHRlc3Qgd2lsbCBkbyB0aGlzIHRyYW5zcGFyZW50bHkgYmVoaW5kIHRoZSBzY2VuZXMsIGNhdXNpbmcgaXNzdWVzIGlmCiAgICAvLyBhbiBvYmplY3QncyB0byBzdHJpbmcgaGFzIGVzY2FwZWQgY2hhcmFjdGVycyBpbiBpdC4KICAgIHN0cmluZyA9IHN0cmluZy50b1N0cmluZygpOwoKICAgIGlmKCFwb3NzaWJsZS50ZXN0KHN0cmluZykpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICB9LAoKICBpc0VtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSAmJiB2YWx1ZSAhPT0gMCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZih0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKCkhhbmRsZWJhcnMuVk0gPSB7CiAgdGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlU3BlYykgewogICAgLy8gSnVzdCBhZGQgd2F0ZXIKICAgIHZhciBjb250YWluZXIgPSB7CiAgICAgIGVzY2FwZUV4cHJlc3Npb246IEhhbmRsZWJhcnMuVXRpbHMuZXNjYXBlRXhwcmVzc2lvbiwKICAgICAgaW52b2tlUGFydGlhbDogSGFuZGxlYmFycy5WTS5pbnZva2VQYXJ0aWFsLAogICAgICBwcm9ncmFtczogW10sCiAgICAgIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CiAgICAgICAgdmFyIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXTsKICAgICAgICBpZihkYXRhKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShpLCBmbiwgZGF0YSk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShpLCBmbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgbWVyZ2U6IGZ1bmN0aW9uKHBhcmFtLCBjb21tb24pIHsKICAgICAgICB2YXIgcmV0ID0gcGFyYW0gfHwgY29tbW9uOwoKICAgICAgICBpZiAocGFyYW0gJiYgY29tbW9uKSB7CiAgICAgICAgICByZXQgPSB7fTsKICAgICAgICAgIEhhbmRsZWJhcnMuVXRpbHMuZXh0ZW5kKHJldCwgY29tbW9uKTsKICAgICAgICAgIEhhbmRsZWJhcnMuVXRpbHMuZXh0ZW5kKHJldCwgcGFyYW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgY29tcGlsZXJJbmZvOiBudWxsCiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgcmVzdWx0ID0gdGVtcGxhdGVTcGVjLmNhbGwoY29udGFpbmVyLCBIYW5kbGViYXJzLCBjb250ZXh0LCBvcHRpb25zLmhlbHBlcnMsIG9wdGlvbnMucGFydGlhbHMsIG9wdGlvbnMuZGF0YSk7CgogICAgICB2YXIgY29tcGlsZXJJbmZvID0gY29udGFpbmVyLmNvbXBpbGVySW5mbyB8fCBbXSwKICAgICAgICAgIGNvbXBpbGVyUmV2aXNpb24gPSBjb21waWxlckluZm9bMF0gfHwgMSwKICAgICAgICAgIGN1cnJlbnRSZXZpc2lvbiA9IEhhbmRsZWJhcnMuQ09NUElMRVJfUkVWSVNJT047CgogICAgICBpZiAoY29tcGlsZXJSZXZpc2lvbiAhPT0gY3VycmVudFJldmlzaW9uKSB7CiAgICAgICAgaWYgKGNvbXBpbGVyUmV2aXNpb24gPCBjdXJyZW50UmV2aXNpb24pIHsKICAgICAgICAgIHZhciBydW50aW1lVmVyc2lvbnMgPSBIYW5kbGViYXJzLlJFVklTSU9OX0NIQU5HRVNbY3VycmVudFJldmlzaW9uXSwKICAgICAgICAgICAgICBjb21waWxlclZlcnNpb25zID0gSGFuZGxlYmFycy5SRVZJU0lPTl9DSEFOR0VTW2NvbXBpbGVyUmV2aXNpb25dOwogICAgICAgICAgdGhyb3cgIlRlbXBsYXRlIHdhcyBwcmVjb21waWxlZCB3aXRoIGFuIG9sZGVyIHZlcnNpb24gb2YgSGFuZGxlYmFycyB0aGFuIHRoZSBjdXJyZW50IHJ1bnRpbWUuICIrCiAgICAgICAgICAgICAgICAiUGxlYXNlIHVwZGF0ZSB5b3VyIHByZWNvbXBpbGVyIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitydW50aW1lVmVyc2lvbnMrIikgb3IgZG93bmdyYWRlIHlvdXIgcnVudGltZSB0byBhbiBvbGRlciB2ZXJzaW9uICgiK2NvbXBpbGVyVmVyc2lvbnMrIikuIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVXNlIHRoZSBlbWJlZGRlZCB2ZXJzaW9uIGluZm8gc2luY2UgdGhlIHJ1bnRpbWUgZG9lc24ndCBrbm93IGFib3V0IHRoaXMgcmV2aXNpb24geWV0CiAgICAgICAgICB0aHJvdyAiVGVtcGxhdGUgd2FzIHByZWNvbXBpbGVkIHdpdGggYSBuZXdlciB2ZXJzaW9uIG9mIEhhbmRsZWJhcnMgdGhhbiB0aGUgY3VycmVudCBydW50aW1lLiAiKwogICAgICAgICAgICAgICAgIlBsZWFzZSB1cGRhdGUgeW91ciBydW50aW1lIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitjb21waWxlckluZm9bMV0rIikuIjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0sCgogIHByb2dyYW1XaXRoRGVwdGg6IGZ1bmN0aW9uKGksIGZuLCBkYXRhIC8qLCAkZGVwdGggKi8pIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKCiAgICB2YXIgcHJvZ3JhbSA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICAgIHByb2dyYW0ucHJvZ3JhbSA9IGk7CiAgICBwcm9ncmFtLmRlcHRoID0gYXJncy5sZW5ndGg7CiAgICByZXR1cm4gcHJvZ3JhbTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CiAgICB2YXIgcHJvZ3JhbSA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICAgIHByb2dyYW0ucHJvZ3JhbSA9IGk7CiAgICBwcm9ncmFtLmRlcHRoID0gMDsKICAgIHJldHVybiBwcm9ncmFtOwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKLy8gbGliL2hhbmRsZWJhcnMvYnJvd3Nlci1zdWZmaXguanMKfSkoSGFuZGxlYmFycyk7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC40Ci8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuNCc7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcmVkdWNlRXJyb3IgPSAnUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZSc7CgogIC8vICoqUmVkdWNlKiogYnVpbGRzIHVwIGEgc2luZ2xlIHJlc3VsdCBmcm9tIGEgbGlzdCBvZiB2YWx1ZXMsIGFrYSBgaW5qZWN0YCwKICAvLyBvciBgZm9sZGxgLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlYCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2UgJiYgb2JqLnJlZHVjZSA9PT0gbmF0aXZlUmVkdWNlKSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZShpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlKGl0ZXJhdG9yKTsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IHZhbHVlOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KICBfLmZpbmQgPSBfLmRldGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlRmlsdGVyICYmIG9iai5maWx0ZXIgPT09IG5hdGl2ZUZpbHRlcikgcmV0dXJuIG9iai5maWx0ZXIoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiAhaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMsIGZpcnN0KSB7CiAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gbnVsbCA6IFtdOwogICAgcmV0dXJuIF9bZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10ob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzKSB7CiAgICByZXR1cm4gXy53aGVyZShvYmosIGF0dHJzLCB0cnVlKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHksIHZhbHVlOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5LCB2YWx1ZTogSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA8IHJlc3VsdC5jb21wdXRlZCAmJiAocmVzdWx0ID0ge3ZhbHVlIDogdmFsdWUsIGNvbXB1dGVkIDogY29tcHV0ZWR9KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC52YWx1ZTsKICB9OwoKICAvLyBTaHVmZmxlIGFuIGFycmF5LgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKGluZGV4KyspOwogICAgICBzaHVmZmxlZFtpbmRleCAtIDFdID0gc2h1ZmZsZWRbcmFuZF07CiAgICAgIHNodWZmbGVkW3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBzaHVmZmxlZDsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBsb29rdXAgaXRlcmF0b3JzLgogIHZhciBsb29rdXBJdGVyYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24ob2JqKXsgcmV0dXJuIG9ialt2YWx1ZV07IH07CiAgfTsKCiAgLy8gU29ydCB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uIHByb2R1Y2VkIGJ5IGFuIGl0ZXJhdG9yLgogIF8uc29ydEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZSA6IHZhbHVlLAogICAgICAgIGluZGV4IDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWEgOiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkKICAgICAgfTsKICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdC5pbmRleCA8IHJpZ2h0LmluZGV4ID8gLTEgOiAxOwogICAgfSksICd2YWx1ZScpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCwgYmVoYXZpb3IpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlIHx8IF8uaWRlbnRpdHkpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXkpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CiAgICByZXR1cm4gKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSA/IG9iai5sZW5ndGggOiBfLmtleXMob2JqKS5sZW5ndGg7CiAgfTsKCiAgLy8gQXJyYXkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEdldCB0aGUgZmlyc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgZmlyc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYGhlYWRgIGFuZCBgdGFrZWAuIFRoZSAqKmd1YXJkKiogY2hlY2sKICAvLyBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5maXJzdCA9IF8uaGVhZCA9IF8udGFrZSA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgogIC8vIGF2YWlsYWJsZS4KICBfLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4KICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCByZXN1bHQ7CiAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHByZXZpb3VzID0gbmV3IERhdGU7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlOwogICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfSBlbHNlIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgYXMgbG9uZyBhcyBpdCBjb250aW51ZXMgdG8gYmUgaW52b2tlZCwgd2lsbCBub3QKICAvLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCiAgLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlCiAgLy8gbGVhZGluZyBlZGdlLCBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZy4KICBfLmRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCwgcmVzdWx0OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29udGV4dCA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICB9OwogICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmIChjYWxsTm93KSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHZhciByYW4gPSBmYWxzZSwgbWVtbzsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgcmV0dXJuIG1lbW87CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIG1lbW8gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGZ1bmMgPSBudWxsOwogICAgICByZXR1cm4gbWVtbzsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24oZnVuYywgd3JhcHBlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IFtmdW5jXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogIF8uY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgZm9yICh2YXIgaSA9IGZ1bmNzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgYXJncyA9IFtmdW5jc1tpXS5hcHBseSh0aGlzLCBhcmdzKV07CiAgICAgIH0KICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIGlmICh0aW1lcyA8PSAwKSByZXR1cm4gZnVuYygpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBuYXRpdmVLZXlzIHx8IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiAhPT0gT2JqZWN0KG9iaikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgb2JqZWN0Jyk7CiAgICB2YXIga2V5cyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkga2V5c1trZXlzLmxlbmd0aF0gPSBrZXk7CiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvLyBSZXRyaWV2ZSB0aGUgdmFsdWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgXy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHZhbHVlcy5wdXNoKG9ialtrZXldKTsKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLy8gQ29udmVydCBhbiBvYmplY3QgaW50byBhIGxpc3Qgb2YgYFtrZXksIHZhbHVlXWAgcGFpcnMuCiAgXy5wYWlycyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHBhaXJzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBwYWlycy5wdXNoKFtrZXksIG9ialtrZXldXSk7CiAgICByZXR1cm4gcGFpcnM7CiAgfTsKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXN1bHRbb2JqW2tleV1dID0ga2V5OwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIG5hbWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob2JqW2tleV0pKSBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CgogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShuKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgICByZXR1cm4gYWNjdW07CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyICsgJyc7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwoKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlKSB7CiAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gIic7XG4iOwoKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCiAgICBzb3VyY2UgPSAidmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLCIgKwogICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgICBzb3VyY2UgKyAicmV0dXJuIF9fcDtcbiI7CgogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAxLjEuMAoKLy8gICAgIChjKSAyMDEwLTIwMTEgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIChjKSAyMDExLTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCiAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgQmFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggdGhlIGJyb3dzZXIgYW5kIHRoZSBzZXJ2ZXIuCiAgdmFyIEJhY2tib25lOwogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIEJhY2tib25lID0gZXhwb3J0czsKICB9IGVsc2UgewogICAgQmFja2JvbmUgPSByb290LkJhY2tib25lID0ge307CiAgfQoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjAnOwoKICAvLyBSZXF1aXJlIFVuZGVyc2NvcmUsIGlmIHdlJ3JlIG9uIHRoZSBzZXJ2ZXIsIGFuZCBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQuCiAgdmFyIF8gPSByb290Ll87CiAgaWYgKCFfICYmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpKSBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAvLyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSByb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zID0gXy5leHRlbmQoe3ZhbGlkYXRlOiB0cnVlfSwgb3B0aW9ucyk7CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCiAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCiAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgogICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgogICAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLgogICAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICAgIH0KICAgICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIAogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdIHx8IHRoaXMuX2J5SWRbb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkocm91dGVyLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoIGFuZCBxdWVyeS4KICB2YXIgcGF0aFN0cmlwcGVyID0gL1s/I10uKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBmcmFnbWVudCBvZiB0aGUgcXVlcnkgYW5kIGhhc2ggZm9yIG1hdGNoaW5nLgogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UocGF0aFN0cmlwcGVyLCAnJyk7CgogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgogICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07Cgp9KS5jYWxsKHRoaXMpOwoKLyoKQ29weXJpZ2h0IChjKSAyMDExLTIwMTMgQFdhbG1hcnRMYWJzCgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0bwpkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZQpyaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3IKc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCkZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIKREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKOzsKKGZ1bmN0aW9uKCkgewoKLypnbG9iYWwgY2xvbmVJbmhlcml0VmFycywgY3JlYXRlSW5oZXJpdFZhcnMsIHJlc2V0SW5oZXJpdFZhcnMsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzLCBjcmVhdGVFcnJvck1lc3NhZ2UsIGFzc2lnblRlbXBsYXRlICovCgovL3N1cHBvcnQgemVwdG8uZm9yRWFjaCBvbiBqUXVlcnkKaWYgKCEkLmZuLmZvckVhY2gpIHsKICAkLmZuLmZvckVhY2ggPSBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgJC5mbi5lYWNoLmNhbGwodGhpcywgZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIHRoaXMsIGluZGV4KTsKICAgIH0pOwogIH07Cn0KCnZhciB2aWV3TmFtZUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LW5hbWUnLAogICAgdmlld0NpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LWNpZCcsCiAgICB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctaGVscGVyJzsKCi8vdmlldyBpbnN0YW5jZXMKdmFyIHZpZXdzSW5kZXhlZEJ5Q2lkID0ge307CgppZiAoIUhhbmRsZWJhcnMudGVtcGxhdGVzKSB7CiAgSGFuZGxlYmFycy50ZW1wbGF0ZXMgPSB7fTsKfQoKdmFyIFRob3JheCA9IHRoaXMuVGhvcmF4ID0gewogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgLy92aWV3IGNsYXNzZXMKICBWaWV3czoge30sCgogIC8vIEFsbG93cyB0YWdnaW5nIG9mIHNlY3Rpb25zIG9mIGNvZGUgd2l0aCBhIG5hbWUgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAvLyBUaGlzIG9yIG9uRXhjZXB0aW9uIHNob3VsZCBiZSBvdmVycmlkZW4gdG8gYWxsb3cgZm9yIHJlcG9ydGluZyBleGNlcHRpb25zIHRvIGFuYWx5dGljcyBzZXJ2ZXJzCiAgLy8gb3IgaW50ZWdyYXRpb24gd2l0aCBsaWJyYXJpZXMgc3VjaCBhcyBDb3N0YW56YS4KICBiaW5kU2VjdGlvbjogZnVuY3Rpb24obmFtZSwgaW5mbywgY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSBpbmZvOwogICAgICBpbmZvID0gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBUaG9yYXgub25FeGNlcHRpb24obmFtZSwgZXJyLCBpbmZvKTsKICAgICAgfQogICAgfTsKICB9LAogIHJ1blNlY3Rpb246IGZ1bmN0aW9uKG5hbWUsIGluZm8sIGNhbGxiYWNrKSB7CiAgICByZXR1cm4gVGhvcmF4LmJpbmRTZWN0aW9uKG5hbWUsIGluZm8sIGNhbGxiYWNrKSgpOwogIH0sCgogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIgLyogLCBpbmZvICovKSB7CiAgICB0aHJvdyBlcnI7CiAgfSwKCiAgLy9kZXByZWNhdGVkLCBoZXJlIHRvIGVuc3VyZSBleGlzdGluZyBwcm9qZWN0cyBhcmVuJ3QgbXVja2VkIHdpdGgKICB0ZW1wbGF0ZXM6IEhhbmRsZWJhcnMudGVtcGxhdGVzCn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICAvLyBzdG9yZSBmaXJzdCBhcmd1bWVudCBmb3IgY29uZmlndXJlVmlldygpCiAgICB0aGlzLl9jb25zdHJ1Y3RvckFyZyA9IGFyZ3VtZW50c1swXTsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGRlbGV0ZSB0aGlzLl9jb25zdHJ1Y3RvckFyZzsKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY3RvcikgewogICAgICAgIG9iai5jdG9yLmNhbGwodGhpcywgcmVzcG9uc2UpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICAvLyBWaWV3IGNvbmZpZ3VyYXRpb24sIF9jb25maWd1cmUgd2FzIHJlbW92ZWQKICAvLyBpbiBCYWNrYm9uZSAxLjEsIGRlZmluZSBfY29uZmlndXJlIGFzIGEgbm9vcAogIC8vIGZvciBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIDEuMCBhbmQgZWFybGllcgogIF9jb25maWd1cmU6IGZ1bmN0aW9uKCkge30sCiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgIGNvbmZpZ3VyZVZpZXcuY2FsbCh0aGlzKTsKICAgIHJldHVybiBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5jYWxsKHRoaXMpOwogIH0sCgogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAnW29iamVjdCBWaWV3LicgKyB0aGlzLm5hbWUgKyAnXSc7CiAgfSwKCiAgc2V0RWxlbWVudCA6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5uYW1lICYmIHRoaXMuJGVsLmF0dHIodmlld05hbWVBdHRyaWJ1dGVOYW1lLCB0aGlzLm5hbWUpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSwgdGhpcy5jaWQpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCgogIF9hZGRDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgaWYgKHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdKSB7CiAgICAgIHJldHVybiB2aWV3OwogICAgfQogICAgdmlldy5yZXRhaW4oKTsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIC8vIF9oZWxwZXJPcHRpb25zIGlzIHVzZWQgdG8gZGV0ZWN0IGlmIGlzIEhlbHBlclZpZXcKICAgIC8vIHdlIGRvIG5vdCB3YW50IHRvIHJlbW92ZSBjaGlsZCBpbiB0aGlzIGNhc2UgYXMKICAgIC8vIHdlIGFyZSBhZGRpbmcgdGhlIEhlbHBlclZpZXcgdG8gdGhlIGRlY2xhcmluZyB2aWV3CiAgICAvLyAod2hhdGV2ZXIgdmlldyB1c2VkIHRoZSB2aWV3IGhlbHBlciBpbiBpdCdzIHRlbXBsYXRlKQogICAgLy8gYnV0IGl0J3MgcGFyZW50IHdpbGwgbm90IGVxdWFsIHRoZSBkZWNsYXJpbmcgdmlldwogICAgLy8gaW4gdGhlIGNhc2Ugb2YgYSBuZXN0ZWQgaGVscGVyLCB3aGljaCB3aWxsIGNhdXNlIGFuIGVycm9yLgogICAgLy8gSW4gZWl0aGVyIGNhc2UgaXQncyBub3QgbmVjZXNzYXJ5IHRvIGV2ZXIgY2FsbAogICAgLy8gX3JlbW92ZUNoaWxkIG9uIGEgSGVscGVyVmlldyBhcyBfYWRkQ2hpbGQgc2hvdWxkIG9ubHkKICAgIC8vIGJlIGNhbGxlZCB3aGVuIGEgSGVscGVyVmlldyBpcyBjcmVhdGVkLgogICAgaWYgKHZpZXcucGFyZW50ICYmIHZpZXcucGFyZW50ICE9PSB0aGlzICYmICF2aWV3Ll9oZWxwZXJPcHRpb25zKSB7CiAgICAgIHZpZXcucGFyZW50Ll9yZW1vdmVDaGlsZCh2aWV3KTsKICAgIH0KICAgIHZpZXcucGFyZW50ID0gdGhpczsKICAgIHRoaXMudHJpZ2dlcignY2hpbGQnLCB2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIF9yZW1vdmVDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdOwogICAgdmlldy5wYXJlbnQgPSBudWxsOwogICAgdmlldy5yZWxlYXNlKCk7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBfZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCwgdGhpcy51bmJpbmREYXRhT2JqZWN0LCB0aGlzKTsKICAgIHRoaXMudHJpZ2dlcignZGVzdHJveWVkJyk7CiAgICBkZWxldGUgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdOwoKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICB9LCB0aGlzKTsKCiAgICBpZiAodGhpcy5lbCkgewogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy5yZW1vdmUoKTsgIC8vIFdpbGwgY2FsbCBzdG9wTGlzdGVuaW5nKCkKICAgICAgdGhpcy5vZmYoKTsgICAgIC8vIEtpbGxzIG9mZiByZW1haW5pbmcgZXZlbnRzCiAgICB9CgogICAgLy8gQWJzb2x1dGUgd29yc3QgY2FzZSBzY2VuYXJpbywga2lsbCBvZmYgc29tZSBrbm93biBmaWVsZHMgdG8gbWluaW1pemUgdGhlIGltcGFjdAogICAgLy8gb2YgYmVpbmcgcmV0YWluZWQuCiAgICB0aGlzLmVsID0gdGhpcy4kZWwgPSB1bmRlZmluZWQ7CiAgICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIHRoaXMubW9kZWwgPSB0aGlzLmNvbGxlY3Rpb24gPSB0aGlzLl9jb2xsZWN0aW9uID0gdW5kZWZpbmVkOwogICAgdGhpcy5faGVscGVyT3B0aW9ucyA9IHVuZGVmaW5lZDsKICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgLy8gTk9QIGZvciBkZXN0cm95ZWQgdmlld3MKICAgIGlmICghc2VsZi5lbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgVGhvcmF4LnJ1blNlY3Rpb24oJ3Rob3JheC1yZW5kZXInLCB7bmFtZTogc2VsZi5uYW1lfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzZWxmLl9yZW5kZXJpbmcpIHsKICAgICAgICAvLyBOZXN0ZWQgcmVuZGVyaW5nIG9mIHRoZSBzYW1lIHZpZXcgaW5zdGFuY2VzIGNhbiBsZWFkIHRvIHNvbWUgdmVyeSBuYXN0eSBpc3N1ZXMgd2l0aAogICAgICAgIC8vIHRoZSByb290IHJlbmRlciBwcm9jZXNzIG92ZXJ3cml0aW5nIGFueSB1cGRhdGVkIGRhdGEgdGhhdCBtYXkgaGF2ZSBiZWVuIG91dHB1dCBpbiB0aGUgY2hpbGQKICAgICAgICAvLyBleGVjdXRpb24uIElmIGluIGEgc2l0dWF0aW9uIHdoZXJlIHlvdSBuZWVkIHRvIHJlcmVuZGVyIGluIHJlc3BvbnNlIHRvIGFuIGV2ZW50IHRoYXQgaXMKICAgICAgICAvLyB0cmlnZ2VyZWQgc3luYyBpbiB0aGUgcmVuZGVyaW5nIGxpZmVjeWNsZSBpdCdzIHJlY29tbWVuZGVkIHRvIGRlZmVyIHRoZSBzdWJzZXF1ZW50IHJlbmRlcgogICAgICAgIC8vIG9yIHJlZmFjdG9yIHNvIHRoYXQgYWxsIHByZWNvbmRpdGlvbnMgYXJlIGtub3duIHByaW9yIHRvIGV4ZWMuCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbmVzdGVkLXJlbmRlcicpKTsKICAgICAgfQoKICAgICAgc2VsZi5fcHJldmlvdXNIZWxwZXJzID0gXy5maWx0ZXIoc2VsZi5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICByZXR1cm4gY2hpbGQuX2hlbHBlck9wdGlvbnM7CiAgICAgIH0pOwoKICAgICAgdmFyIGNoaWxkcmVuID0ge307CiAgICAgIF8uZWFjaChzZWxmLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCwga2V5KSB7CiAgICAgICAgaWYgKCFjaGlsZC5faGVscGVyT3B0aW9ucykgewogICAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHNlbGYuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICAgIHNlbGYudHJpZ2dlcignYmVmb3JlOnJlbmRlcmVkJyk7CiAgICAgIHNlbGYuX3JlbmRlcmluZyA9IHRydWU7CgogICAgICB0cnkgewogICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKG91dHB1dCkgfHwgKCFfLmlzRWxlbWVudChvdXRwdXQpICYmICFUaG9yYXguVXRpbC5pcyQob3V0cHV0KSAmJiAhKG91dHB1dCAmJiBvdXRwdXQuZWwpICYmICFfLmlzU3RyaW5nKG91dHB1dCkgJiYgIV8uaXNGdW5jdGlvbihvdXRwdXQpKSkgewogICAgICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgICAgIC8vIHlldCBoYXZlIG9uZSB3ZSBtdXN0IHJhaXNlCiAgICAgICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHNlbGYsICd0ZW1wbGF0ZScsIHsKICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgb3V0cHV0ID0gc2VsZi5yZW5kZXJUZW1wbGF0ZShzZWxmLnRlbXBsYXRlKTsKICAgICAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgICAgICBvdXRwdXQgPSBzZWxmLnJlbmRlclRlbXBsYXRlKG91dHB1dCk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgICAgIF8uZWFjaChzZWxmLl9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICBzZWxmLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgfSwgc2VsZik7CiAgICAgICAgc2VsZi5fcHJldmlvdXNIZWxwZXJzID0gdW5kZWZpbmVkOwoKICAgICAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICAgICAgc2VsZi5odG1sKChvdXRwdXQgJiYgb3V0cHV0LmVsKSB8fCAob3V0cHV0ICYmIG91dHB1dC5zdHJpbmcpIHx8IG91dHB1dCk7CgogICAgICAgICsrc2VsZi5fcmVuZGVyQ291bnQ7CiAgICAgICAgc2VsZi50cmlnZ2VyKCdyZW5kZXJlZCcpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHNlbGYuX3JlbmRlcmluZyA9IGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfSwKCiAgY29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcykgfHwge30pOwogIH0sCgogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLmV4dGVuZCh7fSwgdGhpcywgZ2V0VmFsdWUodGhpcywgJ2NvbnRleHQnKSB8fCB7fSk7CiAgfSwKCiAgLy8gUHJpdmF0ZSB2YXJpYWJsZXMgaW4gaGFuZGxlYmFycyAvIG9wdGlvbnMuZGF0YSBpbiB0ZW1wbGF0ZSBoZWxwZXJzCiAgX2dldERhdGE6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiB7CiAgICAgIHZpZXc6IHRoaXMsCiAgICAgIGNpZDogXy51bmlxdWVJZCgndCcpLAogICAgICB5aWVsZDogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gZm4gaXMgc2VlZGVkIGJ5IHRlbXBsYXRlIGhlbHBlciBwYXNzaW5nIGNvbnRleHQgdG8gZGF0YQogICAgICAgIHJldHVybiBkYXRhLmZuICYmIGRhdGEuZm4oZGF0YSk7CiAgICAgIH0KICAgIH07CiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKF8uaXNGdW5jdGlvbihmaWxlKSkgewogICAgICB0ZW1wbGF0ZSA9IGZpbGU7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKGZpbGUsIGlnbm9yZUVycm9ycyk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5oZWxwZXJzLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKICBzaG91bGRSZW5kZXI6IGZ1bmN0aW9uKGZsYWcpIHsKICAgIC8vIFJlbmRlciBpZiBmbGFnIGlzIHRydXRoeSBvciBpZiB3ZSBoYXZlIGFscmVhZHkgcmVuZGVyZWQgYW5kIGZsYWcgaXMgdW5kZWZpbmVkL251bGwKICAgIHJldHVybiBmbGFnIHx8IChmbGFnID09IG51bGwgJiYgdGhpcy5fcmVuZGVyQ291bnQpOwogIH0sCiAgY29uZGl0aW9uYWxSZW5kZXI6IGZ1bmN0aW9uKGZsYWcpIHsKICAgIGlmICh0aGlzLnNob3VsZFJlbmRlcihmbGFnKSkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfQogIH0sCgogIGFwcGVuZFRvOiBmdW5jdGlvbihlbCkgewogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgJChlbCkuYXBwZW5kKHRoaXMuZWwpOwogICAgdGhpcy50cmlnZ2VyKCdyZWFkeScsIHt0YXJnZXQ6IHRoaXN9KTsKICB9LAoKICBodG1sOiBmdW5jdGlvbihodG1sKSB7CiAgICBpZiAoXy5pc1VuZGVmaW5lZChodG1sKSkgewogICAgICByZXR1cm4gdGhpcy5lbC5pbm5lckhUTUw7CiAgICB9IGVsc2UgewogICAgICAvLyBFdmVudCBmb3IgSUUgZWxlbWVudCBmaXhlcwogICAgICB0aGlzLnRyaWdnZXIoJ2JlZm9yZTphcHBlbmQnKTsKICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLl9yZXBsYWNlSFRNTChodG1sKTsKICAgICAgdGhpcy50cmlnZ2VyKCdhcHBlbmQnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9CiAgfSwKCiAgcmVsZWFzZTogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuX3JlZmVyZW5jZUNvdW50OwogICAgaWYgKHRoaXMuX3JlZmVyZW5jZUNvdW50IDw9IDApIHsKICAgICAgdGhpcy5fZGVzdHJveSgpOwogICAgfQogIH0sCgogIHJldGFpbjogZnVuY3Rpb24ob3duZXIpIHsKICAgICsrdGhpcy5fcmVmZXJlbmNlQ291bnQ7CiAgICBpZiAob3duZXIpIHsKICAgICAgLy8gTm90IHVzaW5nIGxpc3RlblRvIGhlbHBlciBhcyB3ZSB3YW50IHRvIHJ1biBvbmNlIHRoZSBvd25lciBpcyBkZXN0cm95ZWQKICAgICAgdGhpcy5saXN0ZW5Ubyhvd25lciwgJ2Rlc3Ryb3llZCcsIG93bmVyLnJlbGVhc2UpOwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAnJzsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gY29uZmlndXJlVmlldyAoKSB7CiAgdmFyIG9wdGlvbnMgPSB0aGlzLl9jb25zdHJ1Y3RvckFyZzsKICB2YXIgc2VsZiA9IHRoaXM7CgogIHRoaXMuX3JlZmVyZW5jZUNvdW50ID0gMDsKCiAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkID0ge307CgogIC8vIFNldHVwIG9iamVjdCBldmVudCB0cmFja2luZwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogIH0pOwoKICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogIHRoaXMuY2hpbGRyZW4gPSB7fTsKICB0aGlzLl9yZW5kZXJDb3VudCA9IDA7CgogIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogIC8vcHJvcGVydGllcyBkaXJlY3RseSB3aXRoIHRoZSB2aWV3IGFuZCB0ZW1wbGF0ZSBjb250ZXh0CiAgXy5leHRlbmQodGhpcywgb3B0aW9ucyB8fCB7fSk7CgogIC8vIFNldHVwIGhlbHBlcnMKICBiaW5kSGVscGVycy5jYWxsKHRoaXMpOwoKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgb2JqLmNvbmZpZ3VyZS5jYWxsKHRoaXMpOwogICAgfQogIH0sIHRoaXMpOwoKICB0aGlzLnRyaWdnZXIoJ2NvbmZpZ3VyZScpOwp9CgpmdW5jdGlvbiBiaW5kSGVscGVycygpIHsKICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICBfLmVhY2godGhpcy5oZWxwZXJzLCBmdW5jdGlvbihoZWxwZXIsIG5hbWUpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzOwogICAgICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICBvcHRpb25zID0gXy5sYXN0KGFyZ3MpOwogICAgICAgIG9wdGlvbnMuY29udGV4dCA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGhlbHBlci5hcHBseSh2aWV3LCBhcmdzKTsKICAgICAgfTsKICAgIH0sIHRoaXMpOwogIH0KfQoKLy8kKHNlbGVjdG9yKS52aWV3KCkgaGVscGVyCiQuZm4udmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICBoZWxwZXI6IHRydWUKICB9KTsKICB2YXIgc2VsZWN0b3IgPSAnWycgKyB2aWV3Q2lkQXR0cmlidXRlTmFtZSArICddJzsKICBpZiAoIW9wdGlvbnMuaGVscGVyKSB7CiAgICBzZWxlY3RvciArPSAnOm5vdChbJyArIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lICsgJ10pJzsKICB9CiAgdmFyIGVsID0gJCh0aGlzKS5jbG9zZXN0KHNlbGVjdG9yKTsKICByZXR1cm4gKGVsICYmIHZpZXdzSW5kZXhlZEJ5Q2lkW2VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpXSkgfHwgZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXI6dHJ1ZSwgY2xvbmVFdmVudHM6IHRydWUgKi8KZnVuY3Rpb24gY3JlYXRlRXJyb3JNZXNzYWdlKGNvZGUpIHsKICByZXR1cm4gJ0Vycm9yICInICsgY29kZSArICciLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiB2aXNpdCBodHRwOi8vdGhvcmF4anMub3JnL2Vycm9yLWNvZGVzLmh0bWwnICsgJyMnICsgY29kZTsKfQoKZnVuY3Rpb24gY3JlYXRlUmVnaXN0cnlXcmFwcGVyKGtsYXNzLCBoYXNoKSB7CiAgdmFyICRzdXBlciA9IGtsYXNzLmV4dGVuZDsKICBrbGFzcy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjaGlsZCA9ICRzdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKGNoaWxkLnByb3RvdHlwZS5uYW1lKSB7CiAgICAgIGhhc2hbY2hpbGQucHJvdG90eXBlLm5hbWVdID0gY2hpbGQ7CiAgICB9CiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKfQoKZnVuY3Rpb24gcmVnaXN0cnlHZXQob2JqZWN0LCB0eXBlLCBuYW1lLCBpZ25vcmVFcnJvcnMpIHsKICB2YXIgdGFyZ2V0ID0gb2JqZWN0W3R5cGVdLAogICAgICB2YWx1ZTsKICBpZiAoXy5pbmRleE9mKG5hbWUsICcuJykgPj0gMCkgewogICAgdmFyIGJpdHMgPSBuYW1lLnNwbGl0KC9cLi8pOwogICAgbmFtZSA9IGJpdHMucG9wKCk7CiAgICBfLmVhY2goYml0cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIHRhcmdldCA9IHRhcmdldFtrZXldOwogICAgfSk7CiAgfQogIHRhcmdldCAmJiAodmFsdWUgPSB0YXJnZXRbbmFtZV0pOwogIGlmICghdmFsdWUgJiYgIWlnbm9yZUVycm9ycykgewogICAgdGhyb3cgbmV3IEVycm9yKHR5cGUgKyAnOiAnICsgbmFtZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIGFzc2lnblZpZXcoYXR0cmlidXRlTmFtZSwgb3B0aW9ucykgewogIHZhciBWaWV3Q2xhc3M7CiAgLy8gaWYgYXR0cmlidXRlIGlzIHRoZSBuYW1lIG9mIHZpZXcgdG8gZmV0Y2gKICBpZiAoXy5pc1N0cmluZyh0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgVmlld0NsYXNzID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0NsYXNzKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdmlldyBiYXNlZCBvbiB0aGUgbmFtZQogIH0gZWxzZSBpZiAodGhpcy5uYW1lICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIFZpZXdDbGFzcyA9IFRob3JheC5VdGlsLmdldFZpZXdDbGFzcyh0aGlzLm5hbWUgKyAob3B0aW9ucy5leHRlbnNpb24gfHwgJycpLCB0cnVlKTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAoVmlld0NsYXNzICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRoaXNbYXR0cmlidXRlTmFtZV0gPSBWaWV3Q2xhc3M7CiAgfQogIC8vIGlmIG5vdGhpbmcgd2FzIGZvdW5kIGFuZCBpdCdzIHJlcXVpcmVkLCB0aHJvdwogIGlmIChvcHRpb25zLnJlcXVpcmVkICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRocm93IG5ldyBFcnJvcignVmlldyAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnIHJlcXVpcmVzOiAnICsgYXR0cmlidXRlTmFtZSk7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB2YXIgZXJyID0gbmV3IEVycm9yKCd2aWV3LXJlcXVpcmVzOiAnICsgYXR0cmlidXRlTmFtZSk7CiAgICBlcnIuaW5mbyA9IHsKICAgICAgbmFtZTogdGhpcy5uYW1lIHx8IHRoaXMuY2lkLAogICAgICBwYXJlbnQ6IHRoaXMucGFyZW50ICYmICh0aGlzLnBhcmVudC5uYW1lIHx8IHRoaXMucGFyZW50LmNpZCksCiAgICAgIGhlbHBlck5hbWU6IHRoaXMuX2hlbHBlck5hbWUKICAgIH07CiAgICB0aHJvdyBlcnI7CiAgfQp9CgovLyBnZXRWYWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgXy5yZXN1bHQgYmVjYXVzZSB3ZQovLyBuZWVkIGFuIGV4dHJhIHNjb3BlIHBhcmFtZXRlciwgYW5kIHdpbGwgbWluaWZ5Ci8vIGJldHRlciB0aGFuIF8ucmVzdWx0CmZ1bmN0aW9uIGdldFZhbHVlKG9iamVjdCwgcHJvcCwgc2NvcGUpIHsKICBpZiAoIShvYmplY3QgJiYgb2JqZWN0W3Byb3BdKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKQogICAgPyBvYmplY3RbcHJvcF0uY2FsbChzY29wZSB8fCBvYmplY3QpCiAgICA6IG9iamVjdFtwcm9wXTsKfQoKdmFyIGluaGVyaXRWYXJzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIXNlbGZbb2JqLm5hbWVdKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gcmVzZXRJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICB9KTsKfQpmdW5jdGlvbiB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCBmaWVsZE5hbWUsIGlzU3RhdGljLCBjYWxsYmFjaykgewogIHZhciB0cmVlID0gW107CiAgaWYgKF8uaGFzKHNvdXJjZSwgZmllbGROYW1lKSkgewogICAgdHJlZS5wdXNoKHNvdXJjZSk7CiAgfQogIHZhciBpdGVyYXRlID0gc291cmNlOwogIGlmIChpc1N0YXRpYykgewogICAgd2hpbGUgKGl0ZXJhdGUgPSBpdGVyYXRlLl9fcGFyZW50X18pIHsKICAgICAgaWYgKF8uaGFzKGl0ZXJhdGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaXRlcmF0ZSA9IGl0ZXJhdGUuY29uc3RydWN0b3I7CiAgICB3aGlsZSAoaXRlcmF0ZSkgewogICAgICBpZiAoaXRlcmF0ZS5wcm90b3R5cGUgJiYgXy5oYXMoaXRlcmF0ZS5wcm90b3R5cGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZS5wcm90b3R5cGUpOwogICAgICB9CiAgICAgIGl0ZXJhdGUgPSBpdGVyYXRlLl9fc3VwZXJfXyAmJiBpdGVyYXRlLl9fc3VwZXJfXy5jb25zdHJ1Y3RvcjsKICAgIH0KICB9CgogIHZhciBpID0gdHJlZS5sZW5ndGg7CiAgd2hpbGUgKGktLSkgewogICAgXy5lYWNoKGdldFZhbHVlKHRyZWVbaV0sIGZpZWxkTmFtZSwgc291cmNlKSwgY2FsbGJhY2spOwogIH0KfQoKZnVuY3Rpb24gb2JqZWN0RXZlbnRzKHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzT2JqZWN0KGNhbGxiYWNrKSkgewogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1tldmVudE5hbWVdOwogICAgaWYgKHNwZWMgJiYgc3BlYy5ldmVudCkgewogICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5saXN0ZW5UbyAmJiB0YXJnZXRbZXZlbnROYW1lXSAmJiB0YXJnZXRbZXZlbnROYW1lXS5jaWQpIHsKICAgICAgICBhZGRFdmVudHModGFyZ2V0LCBjYWxsYmFjaywgY29udGV4dCwgZXZlbnROYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZGRFdmVudHModGFyZ2V0WydfJyArIGV2ZW50TmFtZSArICdFdmVudHMnXSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQovLyBpbnRlcm5hbCBsaXN0ZW5UbyBmdW5jdGlvbiB3aWxsIGVycm9yIG9uIGRlc3Ryb3llZAovLyByYWNlIGNvbmRpdGlvbgpmdW5jdGlvbiBsaXN0ZW5UbyhvYmplY3QsIHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIC8vIGdldEV2ZW50Q2FsbGJhY2sgd2lsbCByZXNvbHZlIGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbWV0aG9kCiAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogIHZhciBjYWxsYmFja01ldGhvZCA9IGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIG9iamVjdCksCiAgICAgIGRlc3Ryb3llZENvdW50ID0gMDsKCiAgZnVuY3Rpb24gZXZlbnRIYW5kbGVyKCkgewogICAgaWYgKG9iamVjdC5lbCkgewogICAgICBjYWxsYmFja01ldGhvZC5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgb3VyIGV2ZW50IGhhbmRsZXIgaXMgcmVtb3ZlZCBieSBkZXN0cm95IHdoaWxlIGFub3RoZXIgZXZlbnQgaXMgcHJvY2Vzc2luZyB0aGVuIHdlCiAgICAgIC8vIHdlIG1pZ2h0IHNlZSBvbmUgbGF0ZW50IGV2ZW50IHBlcmNvbGF0ZSB0aHJvdWdoIGR1ZSB0byBjYWNoaW5nIGluIHRoZSBldmVudCBsb29wLiBJZiB3ZQogICAgICAvLyBzZWUgbXVsdGlwbGUgZXZlbnRzIHRoaXMgaXMgYSBjb25jZXJuIGFuZCBhIHNpZ24gdGhhdCBzb21ldGhpbmcgd2FzIG5vdCBjbGVhbmVkIHByb3Blcmx5LgogICAgICBpZiAoZGVzdHJveWVkQ291bnQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Rlc3Ryb3llZC1ldmVudDonICsgb2JqZWN0Lm5hbWUgKyAnOicgKyBldmVudE5hbWUpOwogICAgICB9CiAgICAgIGRlc3Ryb3llZENvdW50Kys7CiAgICB9CiAgfQogIGV2ZW50SGFuZGxlci5fY2FsbGJhY2sgPSBjYWxsYmFja01ldGhvZC5fY2FsbGJhY2sgfHwgY2FsbGJhY2tNZXRob2Q7CiAgZXZlbnRIYW5kbGVyLl90aG9yYXhCaW5kID0gdHJ1ZTsKICBvYmplY3QubGlzdGVuVG8odGFyZ2V0LCBldmVudE5hbWUsIGV2ZW50SGFuZGxlcik7Cn0KCmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCwgbGlzdGVuVG9PYmplY3QpIHsKICBmdW5jdGlvbiBhZGRFdmVudChjYWxsYmFjaywgZXZlbnROYW1lKSB7CiAgICBpZiAobGlzdGVuVG9PYmplY3QpIHsKICAgICAgbGlzdGVuVG8odGFyZ2V0LCB0YXJnZXRbbGlzdGVuVG9PYmplY3RdLCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0IHx8IHRhcmdldCk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dF0pOwogICAgfQogIH0KCiAgXy5lYWNoKHNvdXJjZSwgZnVuY3Rpb24oY2FsbGJhY2ssIGV2ZW50TmFtZSkgewogICAgaWYgKF8uaXNBcnJheShjYWxsYmFjaykpIHsKICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgIGFkZEV2ZW50KGNiLCBldmVudE5hbWUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGFkZEV2ZW50KGNhbGxiYWNrLCBldmVudE5hbWUpOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBnZXRPcHRpb25zRGF0YShvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmRhdGEpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2hhbmRsZWJhcnMtbm8tZGF0YScpKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9Cgp2YXIgdm9pZFRhZ3M7CmZ1bmN0aW9uIGlzVm9pZFRhZyh0YWcpIHsKICBpZiAoIXZvaWRUYWdzKSB7CiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9odG1sL3dnL2RyYWZ0cy9odG1sL21hc3Rlci9zeW50YXguaHRtbCN2b2lkLWVsZW1lbnRzCiAgICB2YXIgdGFncyA9ICdhcmVhLGJhc2UsYnIsY29sLGVtYmVkLGhyLGltZyxpbnB1dCxrZXlnZW4sbGluayxtZW51aXRlbSxtZXRhLHBhcmFtLHNvdXJjZSx0cmFjayx3YnInOwoKICAgIHZvaWRUYWdzID0ge307CiAgICBfLmVhY2godGFncy5zcGxpdCgnLCcpLCBmdW5jdGlvbih0YWcpIHsKICAgICAgdm9pZFRhZ3NbdGFnXSA9IHRydWU7CiAgICB9KTsKICB9CgogIHJldHVybiB2b2lkVGFnc1t0YWddOwp9OwoKVGhvcmF4LlV0aWwgPSB7CiAgZ2V0Vmlld0luc3RhbmNlOiBmdW5jdGlvbihuYW1lLCBhdHRyaWJ1dGVzKSB7CiAgICB2YXIgVmlld0NsYXNzID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0NsYXNzKG5hbWUsIHRydWUpOwogICAgcmV0dXJuIFZpZXdDbGFzcyA/IG5ldyBWaWV3Q2xhc3MoYXR0cmlidXRlcyB8fCB7fSkgOiBuYW1lOwogIH0sCgogIGdldFZpZXdDbGFzczogZnVuY3Rpb24obmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgICBpZiAoXy5pc1N0cmluZyhuYW1lKSkgewogICAgICByZXR1cm4gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBpZ25vcmVFcnJvcnMpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGlnbm9yZUVycm9ycykgewogICAgLy9hcHBlbmQgdGhlIHRlbXBsYXRlIHBhdGggcHJlZml4IGlmIGl0IGlzIG1pc3NpbmcKICAgIHZhciBwYXRoUHJlZml4ID0gVGhvcmF4LnRlbXBsYXRlUGF0aFByZWZpeCwKICAgICAgICB0ZW1wbGF0ZTsKICAgIGlmIChwYXRoUHJlZml4ICYmIGZpbGUuc3Vic3RyKDAsIHBhdGhQcmVmaXgubGVuZ3RoKSAhPT0gcGF0aFByZWZpeCkgewogICAgICBmaWxlID0gcGF0aFByZWZpeCArIGZpbGU7CiAgICB9CgogICAgLy8gV2l0aG91dCBleHRlbnNpb24KICAgIGZpbGUgPSBmaWxlLnJlcGxhY2UoL1wuaGFuZGxlYmFycyQvLCAnJyk7CiAgICB0ZW1wbGF0ZSA9IEhhbmRsZWJhcnMudGVtcGxhdGVzW2ZpbGVdOwogICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAvLyBXaXRoIGV4dGVuc2lvbgogICAgICBmaWxlID0gZmlsZSArICcuaGFuZGxlYmFycyc7CiAgICAgIHRlbXBsYXRlID0gSGFuZGxlYmFycy50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSwgZW5jb2RlKSB7CiAgICBpZiAoaW5wdXQgJiYgaW5wdXQuaW5kZXhPZiAmJiBpbnB1dC5pbmRleE9mKCd7eycpID49IDApIHsKICAgICAgdmFyIHJlID0gLyg/Olx7P1tee10rKXwoPzpce1x7KFtefV0rKVx9XH0pL2csCiAgICAgICAgICBtYXRjaCwKICAgICAgICAgIHJldCA9IFtdOwogICAgICBmdW5jdGlvbiBkZXJlZih0b2tlbiwgc2NvcGUpIHsKICAgICAgICBpZiAodG9rZW4ubWF0Y2goL14oInwnKS8pICYmIHRva2VuLm1hdGNoKC8oInwnKSQvKSkgewogICAgICAgICAgcmV0dXJuIHRva2VuLnJlcGxhY2UoLyheKCJ8Jyl8KCd8IikkKS9nLCAnJyk7CiAgICAgICAgfQogICAgICAgIHZhciBzZWdtZW50cyA9IHRva2VuLnNwbGl0KCcuJyksCiAgICAgICAgICAgIGxlbiA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgc2NvcGUgJiYgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoc2VnbWVudHNbaV0gIT09ICd0aGlzJykgewogICAgICAgICAgICBzY29wZSA9IHNjb3BlW3NlZ21lbnRzW2ldXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGVuY29kZSAmJiBfLmlzU3RyaW5nKHNjb3BlKSkgewogICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzY29wZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBzY29wZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKG1hdGNoID0gcmUuZXhlYyhpbnB1dCkpIHsKICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgIHZhciBwYXJhbXMgPSBtYXRjaFsxXS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciA9IHBhcmFtcy5zaGlmdCgpOwogICAgICAgICAgICBwYXJhbXMgPSBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7IHJldHVybiBkZXJlZihwYXJhbSwgc2NvcGUpOyB9KTsKICAgICAgICAgICAgaWYgKEhhbmRsZWJhcnMuaGVscGVyc1toZWxwZXJdKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0uYXBwbHkoc2NvcGUsIHBhcmFtcykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGRlZmluZWQgZG8gbm90aGluZwogICAgICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0LnB1c2goZGVyZWYocGFyYW1zWzBdLCBzY29wZSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXQucHVzaChtYXRjaFswXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlucHV0ID0gcmV0LmpvaW4oJycpOwogICAgfQogICAgcmV0dXJuIGlucHV0OwogIH0sCiAgdGFnOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBjb250ZW50LCBzY29wZSkgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5vbWl0KGF0dHJpYnV0ZXMsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnLAogICAgICAgIG5vQ2xvc2UgPSBpc1ZvaWRUYWcodGFnKTsKCiAgICBpZiAobm9DbG9zZSAmJiBjb250ZW50KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ3ZvaWQtdGFnLWNvbnRlbnQnKSk7CiAgICB9CgogICAgdmFyIG9wZW5pbmdUYWcgPSAnPCcgKyB0YWcgKyAnICcgKyBfLm1hcChodG1sQXR0cmlidXRlcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICBpZiAoXy5pc1VuZGVmaW5lZCh2YWx1ZSkgfHwga2V5ID09PSAnZXhwYW5kLXRva2VucycpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KICAgICAgdmFyIGZvcm1hdHRlZFZhbHVlID0gdmFsdWU7CiAgICAgIGlmIChzY29wZSkgewogICAgICAgIGZvcm1hdHRlZFZhbHVlID0gVGhvcmF4LlV0aWwuZXhwYW5kVG9rZW4odmFsdWUsIHNjb3BlKTsKICAgICAgfQogICAgICByZXR1cm4gKGtleSA9PT0gJ2NsYXNzTmFtZScgPyAnY2xhc3MnIDoga2V5KSArICc9IicgKyBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24oZm9ybWF0dGVkVmFsdWUpICsgJyInOwogICAgfSkuam9pbignICcpICsgJz4nOwoKICAgIGlmIChub0Nsb3NlKSB7CiAgICAgIHJldHVybiBvcGVuaW5nVGFnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG9wZW5pbmdUYWcgKyAoXy5pc1VuZGVmaW5lZChjb250ZW50KSA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogICAgfQogIH0KfTsKCjs7ClRob3JheC5NaXhpbnMgPSB7fTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgbWl4aW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgIFRob3JheC5NaXhpbnNbbmFtZV0odGhpcyk7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICB2YXIgaXNJbnN0YW5jZSA9ICEhb2JqLmNpZDsKICAgICAgaWYgKG1ldGhvZHMpIHsKICAgICAgICBfLmV4dGVuZChpc0luc3RhbmNlID8gb2JqIDogb2JqLnByb3RvdHlwZSwgbWV0aG9kcyk7CiAgICAgIH0KICAgICAgaWYgKGlzSW5zdGFuY2UpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKG9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqLm9uKCdjb25maWd1cmUnLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBUaG9yYXguTWl4aW5zW25hbWVdKHRoaXMpOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBsaXN0ZW5Ubywgb2JqZWN0RXZlbnRzLCB3YWxrSW5oZXJpdFRyZWUgKi8KLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIF9vbiBtZXRob2QgdG8gY2FsbCBhcyBhICRzdXBlciBtZXRob2QKdmFyIF9vbiA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCmluaGVyaXRWYXJzLmV2ZW50ID0gewogIG5hbWU6ICdfZXZlbnRzJywKCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLmNvbnN0cnVjdG9yLCAnX2V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXZlbnQpOwogICAgfSk7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcywgJ2V2ZW50cycsIGZhbHNlLCBmdW5jdGlvbihoYW5kbGVyLCBldmVudE5hbWUpIHsKICAgICAgc2VsZi5vbihldmVudE5hbWUsIGhhbmRsZXIsIHNlbGYpOwogICAgfSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgY3JlYXRlSW5oZXJpdFZhcnModGhpcyk7CgogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogaGFuZGxlcn0pCiAgICBpZiAoXy5pc09iamVjdChldmVudE5hbWUpKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJyAmJiAhdGhpcy5fZXZlbnRzRGVsZWdhdGVkKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgICB0aGlzLl9ldmVudHNEZWxlZ2F0ZWQgPSB0cnVlOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgLy8gSWYgdGhpcyBpcyByZWN1cnN2aWUgZHVlIHRvIGxpc3RlblRvIGRlbGVnYXRlIGJlbG93IHRoZW4gcGFzcyB0aHJvdWdoIHRvIHN1cGVyIGNsYXNzCiAgICBpZiAocGFyYW1zLmhhbmRsZXIuX3Rob3JheEJpbmQpIHsKICAgICAgcmV0dXJuIF9vbi5jYWxsKHRoaXMsIHBhcmFtcy5uYW1lLCBwYXJhbXMuaGFuZGxlciwgcGFyYW1zLmNvbnRleHQgfHwgdGhpcyk7CiAgICB9CgogICAgdmFyIGJvdW5kSGFuZGxlciA9IGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCBwYXJhbXMudHlwZSArICctZXZlbnQ6JywgcGFyYW1zKTsKCiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICAvLyBJZiB3ZSBoYXZlIG91ciBjb250ZXh0IHNldCB0byBhbiBvdXRzaWRlIHZpZXcgdGhlbiBsaXN0ZW4gcmF0aGVyIHRoYW4gZGlyZWN0bHkgYmluZCBzbwogICAgICAvLyB3ZSBjYW4gY2xlYW51cCBwcm9wZXJseS4KICAgICAgaWYgKHBhcmFtcy5jb250ZXh0ICYmIHBhcmFtcy5jb250ZXh0ICE9PSB0aGlzICYmIHBhcmFtcy5jb250ZXh0IGluc3RhbmNlb2YgVGhvcmF4LlZpZXcpIHsKICAgICAgICBsaXN0ZW5UbyhwYXJhbXMuY29udGV4dCwgdGhpcywgcGFyYW1zLm5hbWUsIGJvdW5kSGFuZGxlciwgcGFyYW1zLmNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIsIHBhcmFtcy5jb250ZXh0IHx8IHRoaXMpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQoKICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgIGlmIChwYXJhbXMuc2VsZWN0b3IpIHsKICAgICAgICB0aGlzLiRlbC5vbihuYW1lLCBwYXJhbXMuc2VsZWN0b3IsIGJvdW5kSGFuZGxlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5wcm90b3R5cGUuYmluZCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC5faXNSZWFkeSB8fCBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsICdpbnB1dCcsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIHJldHVybiBoYW5kbGVyKGV2ZW50KTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBiaW5kRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSwgcGFyYW1zKSB7CiAgZXZlbnROYW1lICs9IHBhcmFtcy5vcmlnaW5hbE5hbWU7CgogIHZhciBjYWxsYmFjayA9IHBhcmFtcy5oYW5kbGVyLAogICAgICBtZXRob2QgPSBfLmlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiB0aGlzW2NhbGxiYWNrXTsKICBpZiAoIW1ldGhvZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFdmVudCAiJyArIGNhbGxiYWNrICsgJyIgZG9lcyBub3QgZXhpc3QgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lKTsKICB9CgogIHZhciBjb250ZXh0ID0gcGFyYW1zLmNvbnRleHQgfHwgdGhpcywKICAgICAgcmV0ID0gVGhvcmF4LmJpbmRTZWN0aW9uKAogICAgICAgICd0aG9yYXgtZXZlbnQnLAogICAgICAgIHt2aWV3OiBjb250ZXh0Lm5hbWUgfHwgY29udGV4dC5jaWQsIGV2ZW50TmFtZTogZXZlbnROYW1lfSwKICAgICAgICBfLmJpbmQobWV0aG9kLCBjb250ZXh0KSk7CgogIC8vIEJhY2tib25lIHdpbGwgZGVsZWdhdGUgdG8gX2NhbGxiYWNrIGluIG9mZiBjYWxscyBzbyB3ZSBzaG91bGQgc3RpbGwgYmUgYWJsZSB0byBzdXBwb3J0CiAgLy8gY2FsbGluZyBvZmYgb24gc3BlY2lmaWMgaGFuZGxlcnMuCiAgcmV0Ll9jYWxsYmFjayA9IG1ldGhvZDsKICByZXQuX3Rob3JheEJpbmQgPSB0cnVlOwogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbShuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgdmFyIHBhcmFtcyA9IHsKICAgIG9yaWdpbmFsTmFtZTogbmFtZSwKICAgIGhhbmRsZXI6IF8uaXNTdHJpbmcoaGFuZGxlcikgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zLCB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSAqLwp2YXIgdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctdG1wJywKICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyA9IHt9OwoKLy8gV2lsbCBiZSBzaGFyZWQgYnkgSGVscGVyVmlldyBhbmQgQ29sbGVjdGlvbkhlbHBlclZpZXcKdmFyIGhlbHBlclZpZXdQcm90b3R5cGUgPSB7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9Cn07CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZChoZWxwZXJWaWV3UHJvdG90eXBlKTsKCi8vIEVuc3VyZSBuZXN0ZWQgaW5saW5lIGhlbHBlcnMgd2lsbCBhbHdheXMgaGF2ZSB0aGlzLnBhcmVudAovLyBzZXQgdG8gdGhlIHZpZXcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUKZnVuY3Rpb24gZ2V0UGFyZW50KHBhcmVudCkgewogIC8vIFRoZSBgdmlld2AgaGVscGVyIGlzIGEgc3BlY2lhbCBjYXNlIGFzIGl0IGVtYmVkcwogIC8vIGEgdmlldyBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9uZQogIHdoaWxlIChwYXJlbnQuX2hlbHBlck5hbWUgJiYgcGFyZW50Ll9oZWxwZXJOYW1lICE9PSAndmlldycpIHsKICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgfQogIHJldHVybiBwYXJlbnQ7Cn0KCmZ1bmN0aW9uIGV4cGFuZEhhc2goY29udGV4dCwgaGFzaCkgewogIGlmIChoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICBoYXNoW2tleV0gPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih2YWx1ZSwgY29udGV4dCk7CiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBWaWV3Q2xhc3MsIGNhbGxiYWNrKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIGlmIChWaWV3Q2xhc3MuZmFjdG9yeSkgewogICAgICBjYWxsYmFjayA9IFZpZXdDbGFzcy5jYWxsYmFjazsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzOwogICAgICBWaWV3Q2xhc3MgPSBUaG9yYXguSGVscGVyVmlldzsKICAgIH0KICB9CgogIHZhciB2aWV3T3B0aW9uV2hpdGVMaXN0ID0gVmlld0NsYXNzLmF0dHJpYnV0ZVdoaXRlTGlzdDsKCiAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcihuYW1lLCBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAKICAgIC8vIEV2YWx1YXRlIGFueSBuZXN0ZWQgcGFyYW1ldGVycyB0aGF0IHdlIG1heSBoYXZlIHRvIGNvbnRlbnQgd2l0aAogICAgdmFyIGV4cGFuZFRva2VucyA9IGV4cGFuZEhhc2godGhpcywgb3B0aW9ucy5oYXNoKTsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIGludmVyc2U6IG9wdGlvbnMuaW52ZXJzZSwKICAgICAgb3B0aW9uczogb3B0aW9ucy5oYXNoLAogICAgICBkZWNsYXJpbmdWaWV3OiBkZWNsYXJpbmdWaWV3LAogICAgICBwYXJlbnQ6IGdldFBhcmVudChkZWNsYXJpbmdWaWV3KSwKICAgICAgX2hlbHBlck5hbWU6IG5hbWUsCiAgICAgIF9oZWxwZXJPcHRpb25zOiB7CiAgICAgICAgb3B0aW9uczogY2xvbmVIZWxwZXJPcHRpb25zKG9wdGlvbnMpLAogICAgICAgIGFyZ3M6IF8uY2xvbmUoYXJncykKICAgICAgfQogICAgfTsKCiAgICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5jbG9uZShvcHRpb25zLmhhc2gpOwoKICAgIC8vIFJlbWFwIGFueSB2aWV3IG9wdGlvbnMgcGVyIHRoZSB3aGl0ZWxpc3QgYW5kIHJlbW92ZSB0aGUgc291cmNlIGZvcm0gdGhlIEhUTUwKICAgIF8uZWFjaCh2aWV3T3B0aW9uV2hpdGVMaXN0LCBmdW5jdGlvbihkZXN0LCBzb3VyY2UpIHsKICAgICAgZGVsZXRlIGh0bWxBdHRyaWJ1dGVzW3NvdXJjZV07CiAgICAgIGlmICghXy5pc1VuZGVmaW5lZChvcHRpb25zLmhhc2hbc291cmNlXSkpIHsKICAgICAgICB2aWV3T3B0aW9uc1tkZXN0XSA9IG9wdGlvbnMuaGFzaFtzb3VyY2VdOwogICAgICB9CiAgICB9KTsKICAgIGlmKGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWUpIHsKICAgICAgdmlld09wdGlvbnMudGFnTmFtZSA9IGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWU7CiAgICB9CgogICAgdmlld09wdGlvbnMuYXR0cmlidXRlcyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXR0cnMgPSAoVmlld0NsYXNzLnByb3RvdHlwZSAmJiBWaWV3Q2xhc3MucHJvdG90eXBlLmF0dHJpYnV0ZXMpIHx8IHt9OwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGF0dHJzKSkgewogICAgICAgIGF0dHJzID0gYXR0cnMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBfLmV4dGVuZChhdHRycywgXy5vbWl0KGh0bWxBdHRyaWJ1dGVzLCBbJ3RhZ05hbWUnXSkpOwogICAgICAvLyBiYWNrYm9uZSB3YW50cyAiY2xhc3MiCiAgICAgIGlmIChhdHRycy5jbGFzc05hbWUpIHsKICAgICAgICBhdHRyc1snY2xhc3MnXSA9IGF0dHJzLmNsYXNzTmFtZTsKICAgICAgICBkZWxldGUgYXR0cnMuY2xhc3NOYW1lOwogICAgICB9CiAgICAgIHJldHVybiBhdHRyczsKICAgIH07CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgLy8gT25seSBhc3NpZ24gaWYgcHJlc2VudCwgYWxsb3cgaGVscGVyIHZpZXcgY2xhc3MgdG8KICAgICAgLy8gZGVjbGFyZSB0ZW1wbGF0ZQogICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IG9wdGlvbnMuZm47CiAgICB9IGVsc2UgaWYgKFZpZXdDbGFzcyAmJiBWaWV3Q2xhc3MucHJvdG90eXBlICYmICFWaWV3Q2xhc3MucHJvdG90eXBlLnRlbXBsYXRlKSB7CiAgICAgIC8vIFZpZXdDbGFzcyBtYXkgYWxzbyBiZSBhbiBpbnN0YW5jZSBvciBvYmplY3Qgd2l0aCBmYWN0b3J5IG1ldGhvZAogICAgICAvLyBzbyBuZWVkIHRvIGRvIHRoaXMgY2hlY2sKICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CgogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYW4gZXhpc3RpbmcgaW5zdGFuY2UgdGhhdCB3ZSBjYW4gcmV1c2UKICAgIHZhciBpbnN0YW5jZSA9IF8uZmluZChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHJldHVybiBjb21wYXJlSGVscGVyT3B0aW9ucyh2aWV3T3B0aW9ucywgY2hpbGQpOwogICAgfSk7CgogICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZSBpZiB3ZSBkb24ndCBhbHJlYWR5IGhhdmUgb25lCiAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgIGlmIChWaWV3Q2xhc3MuZmFjdG9yeSkgewogICAgICAgIGluc3RhbmNlID0gVmlld0NsYXNzLmZhY3RvcnkoYXJncywgdmlld09wdGlvbnMpOwogICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CgogICAgICAgIGluc3RhbmNlLl9oZWxwZXJOYW1lID0gdmlld09wdGlvbnMuX2hlbHBlck5hbWU7CiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck9wdGlvbnMgPSB2aWV3T3B0aW9ucy5faGVscGVyT3B0aW9uczsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnN0YW5jZSA9IG5ldyBWaWV3Q2xhc3Modmlld09wdGlvbnMpOwogICAgICB9CiAgICAgIGlmICghaW5zdGFuY2UuZWwpIHsKICAgICAgICAvLyBWaWV3Q2xhc3MuZmFjdG9yeSBtYXkgcmV0dXJuIGV4aXN0aW5nIG9iamVjdHMgd2hpY2ggbWF5IGhhdmUgYmVlbiBkZXN0cm95ZWQKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc2VydC1kZXN0cm95ZWQtZmFjdG9yeScpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgYW55IHBvc3NpYmxlIGVudHJ5IGluIHByZXZpb3VzIGhlbHBlcnMgaW4gY2FzZSB0aGlzIGlzIGEgY2FjaGVkIHZhbHVlIHJldHVybmVkIGZyb20KICAgICAgLy8gc2xpZ2h0bHkgZGlmZmVyZW50IGRhdGEgdGhhdCBkb2VzIG5vdCBxdWFsaWZ5IGZvciB0aGUgcHJldmlvdXMgaGVscGVycyBkaXJlY3QgcmV1c2UuCiAgICAgIC8vIChpLmUuIHdoZW4gdXNpbmcgYW4gYXJyYXkgdGhhdCBpcyBtb2RpZmllZCBiZXR3ZWVuIHJlbmRlcnMpCiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIWluc3RhbmNlLmVsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnNlcnQtZGVzdHJveWVkJyk7CiAgICAgIH0KCiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5jaGlsZHJlbltpbnN0YW5jZS5jaWRdID0gaW5zdGFuY2U7CiAgICB9CgogICAgaHRtbEF0dHJpYnV0ZXNbdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBpbnN0YW5jZS5jaWQ7CiAgICBpZiAoVmlld0NsYXNzLm1vZGlmeUhUTUxBdHRyaWJ1dGVzKSB7CiAgICAgIFZpZXdDbGFzcy5tb2RpZnlIVE1MQXR0cmlidXRlcyhodG1sQXR0cmlidXRlcywgaW5zdGFuY2UpOwogICAgfQogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzLCAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKICB9KTsKICB2YXIgaGVscGVyID0gSGFuZGxlYmFycy5oZWxwZXJzW25hbWVdOwogIHJldHVybiBoZWxwZXI7Cn07CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciBwbGFjZWhvbGRlcklkID0gZWwuZ2V0QXR0cmlidXRlKHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIHZpZXcgPSB0aGlzLmNoaWxkcmVuW3BsYWNlaG9sZGVySWRdOwogICAgaWYgKHZpZXcpIHsKICAgICAgLy9zZWUgaWYgdGhlIHZpZXcgaGVscGVyIGRlY2xhcmVkIGFuIG92ZXJyaWRlIGZvciB0aGUgdmlldwogICAgICAvL2lmIG5vdCwgZW5zdXJlIHRoZSB2aWV3IGhhcyBiZWVuIHJlbmRlcmVkIGF0IGxlYXN0IG9uY2UKICAgICAgaWYgKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSkgewogICAgICAgIHZpZXcucmVuZGVyKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSk7CiAgICAgICAgZGVsZXRlIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIH0KICAgICAgJChlbCkucmVwbGFjZVdpdGgodmlldy5lbCk7CiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKHZpZXcuZWwpOwogICAgfQogIH0sIHRoaXMpOwp9KTsKCgovKioKICogQ2xvbmVzIHRoZSBoZWxwZXIgb3B0aW9ucywgZHJvcHBpbmcgaXRlbXMgdGhhdCBhcmUga25vd24gdG8gY2hhbmdlCiAqIGJldHdlZW4gcmVuZGVyaW5nIGN5Y2xlcyBhcyBhcHByb3ByaWF0ZS4KICovCmZ1bmN0aW9uIGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSB7CiAgdmFyIHJldCA9IF8ucGljayhvcHRpb25zLCAnZm4nLCAnaW52ZXJzZScsICdoYXNoJywgJ2RhdGEnKTsKICByZXQuZGF0YSA9IF8ub21pdChvcHRpb25zLmRhdGEsICdjaWQnLCAndmlldycsICd5aWVsZCcsICdyb290JywgJ19wYXJlbnQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIGlmIChiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG90aGVyID0gYi5vcHRpb25zW2tleV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAhdmFsdWUuZGVwdGggJiYgb3RoZXIucHJvZ3JhbSA9PT0gdmFsdWUucHJvZ3JhbTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWU7CiAgICAgICAgfSk7Cn0KCjs7Ci8qZ2xvYmFsIGdldFZhbHVlLCBpbmhlcml0VmFycywgd2Fsa0luaGVyaXRUcmVlICovCgpmdW5jdGlvbiBkYXRhT2JqZWN0KHR5cGUsIHNwZWMpIHsKICBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV0gPSBfLmRlZmF1bHRzKHsKICAgIG5hbWU6ICdfJyArIHR5cGUgKyAnRXZlbnRzJywKICAgIGV2ZW50OiB0cnVlCiAgfSwgc3BlYyk7CgogIC8vIEFkZCBhIGNhbGxiYWNrIGluIHRoZSB2aWV3IGNvbnN0cnVjdG9yCiAgc3BlYy5jdG9yID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpc1t0eXBlXSkgewogICAgICAvLyBOZWVkIHRvIG51bGwgdGhpcy5tb2RlbC9jb2xsZWN0aW9uIHNvIHNldE1vZGVsL0NvbGxlY3Rpb24gd2lsbAogICAgICAvLyBub3QgdHJlYXQgaXQgYXMgdGhlIG9sZCBtb2RlbC9jb2xsZWN0aW9uIGFuZCBpbW1lZGlhdGVseSByZXR1cm4KICAgICAgdmFyIG9iamVjdCA9IHRoaXNbdHlwZV07CiAgICAgIHRoaXNbdHlwZV0gPSBudWxsOwogICAgICB0aGlzW3NwZWMuc2V0XShvYmplY3QpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICB2YXIgb2xkID0gdGhpc1t0eXBlXSwKICAgICAgICAkZWwgPSBnZXRWYWx1ZSh0aGlzLCBzcGVjLiRlbCk7CgogICAgaWYgKGRhdGFPYmplY3QgPT09IG9sZCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmIChvbGQpIHsKICAgICAgdGhpcy51bmJpbmREYXRhT2JqZWN0KG9sZCk7CiAgICB9CgogICAgaWYgKGRhdGFPYmplY3QpIHsKICAgICAgdGhpc1t0eXBlXSA9IGRhdGFPYmplY3Q7CgogICAgICBpZiAoc3BlYy5sb2FkaW5nKSB7CiAgICAgICAgc3BlYy5sb2FkaW5nLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuYmluZERhdGFPYmplY3QodHlwZSwgZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucykpOwogICAgICAkZWwgJiYgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbCAmJiAkZWwucmVtb3ZlQXR0cihzcGVjLmNpZEF0dHJOYW1lKTsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOmRhdGEtb2JqZWN0JywgdHlwZSwgZGF0YU9iamVjdCwgb2xkKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgVGhvcmF4LlZpZXcucHJvdG90eXBlW3NwZWMuc2V0XSA9IHNldE9iamVjdDsKfQoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgZ2V0T2JqZWN0T3B0aW9uczogZnVuY3Rpb24oZGF0YU9iamVjdCkgewogICAgcmV0dXJuIGRhdGFPYmplY3QgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICB9LAoKICBiaW5kRGF0YU9iamVjdDogZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgaWYgKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IGRhdGFPYmplY3Q7CgogICAgdmFyIG9wdGlvbnMgPSB0aGlzLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyhkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgaW5oZXJpdFZhcnNbdHlwZV0uZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBvcHRpb25zOwoKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzKTsKCiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdOwogICAgc3BlYy5iaW5kQ2FsbGJhY2sgJiYgc3BlYy5iaW5kQ2FsbGJhY2suY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKCiAgICBpZiAoZGF0YU9iamVjdC5zaG91bGRGZXRjaCAmJiBkYXRhT2JqZWN0LnNob3VsZEZldGNoKG9wdGlvbnMpKSB7CiAgICAgIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAvLyB3YW50IHRvIHRyaWdnZXIgYnVpbHQgaW4gcmVuZGVyaW5nIHdpdGhvdXQgdHJpZ2dlcmluZyBldmVudCBvbiBtb2RlbAogICAgICBpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UuY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgdGhpcy5zdG9wTGlzdGVuaW5nKGRhdGFPYmplY3QpOwogICAgZGVsZXRlIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBfbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnM6IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zOwogIH0KfSk7CgpmdW5jdGlvbiBiaW5kRXZlbnRzKHR5cGUsIHRhcmdldCwgc291cmNlKSB7CiAgdmFyIGNvbnRleHQgPSB0aGlzOwogIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsICdfJyArIHR5cGUgKyAnRXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIGxpc3RlblRvKGNvbnRleHQsIHRhcmdldCwgZXZlbnRbMF0sIGV2ZW50WzFdLCBldmVudFsyXSB8fCBjb250ZXh0KTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0gZWxzZSB7CiAgICByZXR1cm4gY29udGV4dFtjYWxsYmFja107CiAgfQp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldFZhbHVlLCBpbmhlcml0VmFycyAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB1bmRlZmluZWQsICAgIC8vIERlZmF1bHQgdG8gZGVmZXJyZWQgcmVuZGVyaW5nCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgaW52YWxpZDogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwsIG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNlcmlhbGl6aW5nKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKG1vZGVsKSB8fCB7fTsKICAvLyAhbW9kZWxPcHRpb25zIHdpbGwgYmUgdHJ1ZSB3aGVuIHNldE1vZGVsKGZhbHNlKSBpcyBjYWxsZWQKICB0aGlzLmNvbmRpdGlvbmFsUmVuZGVyKG1vZGVsT3B0aW9ucy5yZW5kZXIpOwp9CgpUaG9yYXguVmlldy5vbih7CiAgbW9kZWw6IHsKICAgIGludmFsaWQ6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuZ2V0T2JqZWN0T3B0aW9ucyhtb2RlbCkuaW52YWxpZCkgewogICAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIGVycm9ycywgbW9kZWwpOwogICAgICB9CiAgICB9LAogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCByZXNwLCBtb2RlbCk7CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICAvLyBJbmRpcmVjdCByZWZlcm5lY2UgdG8gYWxsb3cgZm9yIG92ZXJyaWRlcwogICAgICBpbmhlcml0VmFycy5tb2RlbC5jaGFuZ2UuY2FsbCh0aGlzLCBtb2RlbCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9KTsKCiQuZm4ubW9kZWwgPSBmdW5jdGlvbih2aWV3KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgbW9kZWxFbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBtb2RlbENpZCA9IG1vZGVsRWxlbWVudCAmJiBtb2RlbEVsZW1lbnQuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChtb2RlbENpZCkgewogICAgdmFyIHZpZXcgPSB2aWV3IHx8ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3ICYmIHZpZXcubW9kZWwgJiYgdmlldy5tb2RlbC5jaWQgPT09IG1vZGVsQ2lkKSB7CiAgICAgIHJldHVybiB2aWV3Lm1vZGVsIHx8IGZhbHNlOwogICAgfQogICAgdmFyIGNvbGxlY3Rpb24gPSAkdGhpcy5jb2xsZWN0aW9uKHZpZXcpOwogICAgaWYgKGNvbGxlY3Rpb24pIHsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZ2V0KG1vZGVsQ2lkKTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgYXNzaWduVmlldywgYXNzaWduVGVtcGxhdGUsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0RXZlbnRDYWxsYmFjaywgZ2V0VmFsdWUsIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKi8KdmFyIF9mZXRjaCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmZldGNoLAogICAgX3NldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnNldCwKICAgIF9yZXBsYWNlSFRNTCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fcmVwbGFjZUhUTUwsCiAgICBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tY2lkJywKICAgIGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVtcHR5JywKICAgIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZWxlbWVudCcsCiAgICBFTEVNRU5UX05PREVfVFlQRSA9IDE7CgpUaG9yYXguQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICBtb2RlbDogVGhvcmF4Lk1vZGVsIHx8IEJhY2tib25lLk1vZGVsLAogIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjb2xsZWN0aW9uJyk7CiAgICByZXR1cm4gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICBzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgdGhpcy5fZmV0Y2hlZCA9ICEhbW9kZWxzOwogICAgcmV0dXJuIF9zZXQuY2FsbCh0aGlzLCBtb2RlbHMsIG9wdGlvbnMpOwogIH0KfSk7CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBnZXRDb2xsZWN0aW9uVmlld3M6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pIHsKICAgIHJldHVybiBfLmZpbHRlcih0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIFRob3JheC5Db2xsZWN0aW9uVmlldykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiAhY29sbGVjdGlvbiB8fCAoY2hpbGQuY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbik7CiAgICB9KTsKICB9LAogIHVwZGF0ZUZpbHRlcjogZnVuY3Rpb24oY29sbGVjdGlvbikgewogICAgXy5pbnZva2UodGhpcy5nZXRDb2xsZWN0aW9uVmlld3MoY29sbGVjdGlvbiksICd1cGRhdGVGaWx0ZXInKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgYmluZENhbGxiYWNrOiBvblNldENvbGxlY3Rpb24sCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdW5kZWZpbmVkLCAgICAvLyBEZWZhdWx0IHRvIGRlZmVycmVkIHJlbmRlcmluZwogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGludmFsaWQ6IHRydWUsCiAgICBjaGFuZ2U6IHRydWUgICAgICAgICAgLy8gV2V0aGVyIG9yIG5vdCB0byByZS1yZW5kZXIgb24gbW9kZWw6Y2hhbmdlCiAgfSwKICBjaGFuZ2U6IG9uQ29sbGVjdGlvblJlc2V0LAogICRlbDogJ2dldENvbGxlY3Rpb25FbGVtZW50JywKICBjaWRBdHRyTmFtZTogY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUKfSk7CgpUaG9yYXguQ29sbGVjdGlvblZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICBfY29sbGVjdGlvblNlbGVjdG9yOiAnWycgKyBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgKyAnXScsCgogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5nZXRPYmplY3RPcHRpb25zKHRoaXMuY29sbGVjdGlvbikgJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNob3VsZFJlbmRlciA9IHRoaXMuc2hvdWxkUmVuZGVyKCk7CgogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKCFzaG91bGRSZW5kZXIpIHsKICAgICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uKCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgY29sbGVjdGlvbiA9IHRoaXMuY29sbGVjdGlvbjsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZmlsdGVyOiB0cnVlCiAgICB9KTsKICAgIC8vaWYgaW5kZXggYXJndW1lbnQgaXMgYSB2aWV3CiAgICBpbmRleCAmJiBpbmRleC5lbCAmJiAoaW5kZXggPSAkZWwuY2hpbGRyZW4oKS5pbmRleE9mKGluZGV4LmVsKSArIDEpOwogICAgLy9pZiBhcmd1bWVudCBpcyBhIHZpZXcsIG9yIGh0bWwgc3RyaW5nCiAgICBpZiAobW9kZWwuZWwgfHwgXy5pc1N0cmluZyhtb2RlbCkpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICAvLyBVc2luZyBjYWxsIGhlcmUgdG8gYXZvaWQgdjggcHJvdG90eXBlIGlubGluZSBvcHRpbWl6YXRpb24gYnVnIHRoYXQgaGVscGVyIHZpZXdzCiAgICAgIC8vIGV4cG9zZSB1bmRlciBBbmRyb2lkIDQuMyAoYXQgbWluaW11bSkKICAgICAgLy8gaHR0cHM6Ly90d2l0dGVyLmNvbS9rcGRlY2tlci9zdGF0dXMvNDIyMTQ5NjM0OTI5MDgyMzcwCiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtLmNhbGwodGhpcywgbW9kZWwsIGluZGV4KTsKICAgIH0KCiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaWYgKGl0ZW1WaWV3LmNpZCkgewogICAgICAgIGl0ZW1WaWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaXRlbVZpZXcpOwogICAgICB9CgogICAgICAvL2lmIHRoZSByZW5kZXJlcidzIG91dHB1dCB3YXNuJ3QgY29udGFpbmVkIGluIGEgdGFnLCB3cmFwIGl0IGluIGEgZGl2CiAgICAgIC8vcGxhaW4gdGV4dCwgb3IgYSBtaXh0dXJlIG9mIHRvcCBsZXZlbCB0ZXh0IG5vZGVzIGFuZCBlbGVtZW50IG5vZGVzCiAgICAgIC8vd2lsbCBnZXQgd3JhcHBlZAogICAgICBpZiAoXy5pc1N0cmluZyhpdGVtVmlldykgJiYgIWl0ZW1WaWV3Lm1hdGNoKC9eXHMqPC9tKSkgewogICAgICAgIGl0ZW1WaWV3ID0gJzxkaXY+JyArIGl0ZW1WaWV3ICsgJzwvZGl2Pic7CiAgICAgIH0KICAgICAgdmFyIGl0ZW1FbGVtZW50ID0gaXRlbVZpZXcuJGVsIHx8ICQoJC50cmltKGl0ZW1WaWV3KSkuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICAgIC8vZmlsdGVyIG91dCB0b3AgbGV2ZWwgd2hpdGVzcGFjZSBub2RlcwogICAgICAgIHJldHVybiB0aGlzLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREVfVFlQRTsKICAgICAgfSk7CgogICAgICBpZiAobW9kZWwpIHsKICAgICAgICBpdGVtRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfQogICAgICB2YXIgcHJldmlvdXNNb2RlbCA9IGluZGV4ID4gMCA/IGNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5jaGlsZHJlbignWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgcHJldmlvdXNNb2RlbC5jaWQgKyAnIl0nKS5sYXN0KCk7CiAgICAgICAgbGFzdC5hZnRlcihpdGVtRWxlbWVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJywgbnVsbCwgZnVuY3Rpb24oZWwpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB9KTsKCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOml0ZW0nLCB0aGlzLCBjb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5maWx0ZXIpIHsKICAgICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpdGVtVmlldzsKICB9LAoKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwoKICAgIC8vIE5PUCBGb3Igdmlld3MKICAgIGlmICh2aWV3RWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucmVtb3ZlSXRlbSh2aWV3RWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAoKICByZW1vdmVJdGVtOiBmdW5jdGlvbihtb2RlbCkgewogICAgdmFyIHZpZXdFbCA9IG1vZGVsOwogICAgaWYgKG1vZGVsLmNpZCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB2aWV3RWwgPSAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJyk7CiAgICB9CiAgICBpZiAoIXZpZXdFbC5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciB2aWV3Q2lkcyA9IHZpZXdFbC5maW5kKCdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nKS5tYXAoZnVuY3Rpb24oaSwgZWwpIHsKICAgICAgcmV0dXJuICQoZWwpLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpOwogICAgfSk7CgogICAgdmlld0VsLnJlbW92ZSgpOwoKICAgIHZpZXdDaWRzLnB1c2godmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpKTsKICAgIF8uZWFjaCh2aWV3Q2lkcywgZnVuY3Rpb24oY2lkKSB7CiAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bY2lkXTsKICAgICAgaWYgKGNoaWxkKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICByZW5kZXJDb2xsZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5pc0VtcHR5KCkpIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIGFzc2lnblZpZXcuY2FsbCh0aGlzLCAnZW1wdHlWaWV3JywgewogICAgICAgIGV4dGVuc2lvbjogJy1lbXB0eScKICAgICAgfSk7CiAgICB9CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVZpZXcpIHsKICAgICAgYXNzaWduVmlldy5jYWxsKHRoaXMsICdpdGVtVmlldycsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgaWYgKCF0aGlzLml0ZW1UZW1wbGF0ZSAmJiAhdGhpcy5pdGVtVmlldykgewogICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHRoaXMsICdpdGVtVGVtcGxhdGUnLCB7CiAgICAgICAgZXh0ZW5zaW9uOiAnLWl0ZW0nLAogICAgICAgIC8vIG9ubHkgcmVxdWlyZSBhbiBpdGVtVGVtcGxhdGUgaWYgYW4gaXRlbVZpZXcKICAgICAgICAvLyBpcyBub3QgcHJlc2VudAogICAgICAgIHJlcXVpcmVkOiAhdGhpcy5pdGVtVmlldwogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLml0ZW1WaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgfTsKICAgICAgaWYgKHRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLml0ZW1UZW1wbGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFVzaW5nIGNhbGwgaGVyZSB0byBhdm9pZCB2OCBwcm90b3R5cGUgaW5saW5lIG9wdGltaXphdGlvbiBidWcgdGhhdCBoZWxwZXIgdmlld3MKICAgICAgLy8gZXhwb3NlIHVuZGVyIEFuZHJvaWQgNC4zIChhdCBtaW5pbXVtKQogICAgICAvLyBodHRwczovL3R3aXR0ZXIuY29tL2twZGVja2VyL3N0YXR1cy80MjIxNDk2MzQ5MjkwODIzNzAKICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5pdGVtVGVtcGxhdGUsIHRoaXMuaXRlbUNvbnRleHQuY2FsbCh0aGlzLCBtb2RlbCwgaSkpOwogICAgfQogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKG1vZGVsIC8qLCBpICovKSB7CiAgICByZXR1cm4gbW9kZWwuYXR0cmlidXRlczsKICB9LAogIGFwcGVuZEVtcHR5OiBmdW5jdGlvbigpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAkZWwuZW1wdHkoKTsKCiAgICAvLyBVc2luZyBjYWxsIGhlcmUgdG8gYXZvaWQgdjggcHJvdG90eXBlIGlubGluZSBvcHRpbWl6YXRpb24gYnVnIHRoYXQgaGVscGVyIHZpZXdzCiAgICAvLyBleHBvc2UgdW5kZXIgQW5kcm9pZCA0LjMgKGF0IG1pbmltdW0pCiAgICAvLyBodHRwczovL3R3aXR0ZXIuY29tL2twZGVja2VyL3N0YXR1cy80MjIxNDk2MzQ5MjkwODIzNzAKICAgIHZhciBlbXB0eUNvbnRlbnQgPSB0aGlzLnJlbmRlckVtcHR5LmNhbGwodGhpcyk7CiAgICBlbXB0eUNvbnRlbnQgJiYgdGhpcy5hcHBlbmRJdGVtKGVtcHR5Q29udGVudCwgMCwgewogICAgICBzaWxlbnQ6IHRydWUsCiAgICAgIGZpbHRlcjogZmFsc2UKICAgIH0pOwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgfSwKICBnZXRDb2xsZWN0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZWxlbWVudCA9IHRoaXMuJCh0aGlzLl9jb2xsZWN0aW9uU2VsZWN0b3IpOwogICAgcmV0dXJuIGVsZW1lbnQubGVuZ3RoID09PSAwID8gdGhpcy4kZWwgOiBlbGVtZW50OwogIH0sCgogIHVwZGF0ZUZpbHRlcjogZnVuY3Rpb24oKSB7CiAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICByZXNldDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBzb3J0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9iamVjdE9wdGlvbnModGhpcy5jb2xsZWN0aW9uKTsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jaGFuZ2UpIHsKICAgICAgICB0aGlzLnVwZGF0ZUl0ZW0obW9kZWwpOwogICAgICB9CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwsIGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5yZW1vdmVJdGVtKG1vZGVsKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGNvbGxlY3Rpb246IHsKICAgIGludmFsaWQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuZ2V0T2JqZWN0T3B0aW9ucyhjb2xsZWN0aW9uKS5pbnZhbGlkKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgbWVzc2FnZSwgY29sbGVjdGlvbik7CiAgICAgIH0KICAgIH0sCiAgICBlcnJvcjogZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgcmVzcCwgY29sbGVjdGlvbik7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICAvLyBVbmRlZmluZWQgdG8gZm9yY2UgY29uZGl0aW9uYWwgcmVuZGVyCiAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9iamVjdE9wdGlvbnMoY29sbGVjdGlvbikgfHwgdW5kZWZpbmVkOwogIGlmICh0aGlzLnNob3VsZFJlbmRlcihvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uICYmIHRoaXMucmVuZGVyQ29sbGVjdGlvbigpOwogIH0KfQoKLy8gRXZlbiBpZiB0aGUgdmlldyBpcyBub3QgYSBDb2xsZWN0aW9uVmlldwovLyBlbnN1cmVSZW5kZXJlZCgpIHRvIHByb3ZpZGUgc2ltaWxhciBiZWhhdmlvcgovLyB0byBhIG1vZGVsCmZ1bmN0aW9uIG9uU2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKSB7CiAgLy8gVW5kZWZpbmVkIHRvIGZvcmNlIGNvbmRpdGlvbmFsIHJlbmRlcgogIHZhciBvcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKGNvbGxlY3Rpb24pIHx8IHVuZGVmaW5lZDsKICBpZiAodGhpcy5zaG91bGRSZW5kZXIob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIC8vIEVuc3VyZSB0aGF0IHNvbWV0aGluZyBpcyB0aGVyZSBpZiB3ZSBhcmUgZ29pbmcgdG8gcmVuZGVyIHRoZSBjb2xsZWN0aW9uLgogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogIH0KfQoKZnVuY3Rpb24gYXBwbHlWaXNpYmlsaXR5RmlsdGVyKCkgewogIGlmICh0aGlzLml0ZW1GaWx0ZXIpIHsKICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGFwcGx5SXRlbVZpc2libGl0eUZpbHRlciwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIC8vIFVzaW5nIGNhbGwgaGVyZSB0byBhdm9pZCB2OCBwcm90b3R5cGUgaW5saW5lIG9wdGltaXphdGlvbiBidWcgdGhhdCBoZWxwZXIgdmlld3MKICAvLyBleHBvc2UgdW5kZXIgQW5kcm9pZCA0LjMgKGF0IG1pbmltdW0pCiAgLy8gaHR0cHM6Ly90d2l0dGVyLmNvbS9rcGRlY2tlci9zdGF0dXMvNDIyMTQ5NjM0OTI5MDgyMzcwCiAgcmV0dXJuIHRoaXMuaXRlbUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsLCB0aGlzLmNvbGxlY3Rpb24uaW5kZXhPZihtb2RlbCkpOwp9CgpmdW5jdGlvbiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5KCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5lbXB0eUNsYXNzICYmICRlbC5yZW1vdmVDbGFzcyh0aGlzLmVtcHR5Q2xhc3MpOwogICRlbC5yZW1vdmVBdHRyKGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUpOwogICRlbC5lbXB0eSgpOwp9CgpmdW5jdGlvbiBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5KCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5lbXB0eUNsYXNzICYmICRlbC5hZGRDbGFzcyh0aGlzLmVtcHR5Q2xhc3MpOwogICRlbC5hdHRyKGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUsIHRydWUpOwogIHRoaXMuYXBwZW5kRW1wdHkoKTsKfQoKLy8kKHNlbGVjdG9yKS5jb2xsZWN0aW9uKCkgaGVscGVyCiQuZm4uY29sbGVjdGlvbiA9IGZ1bmN0aW9uKHZpZXcpIHsKICBpZiAodmlldyAmJiB2aWV3LmNvbGxlY3Rpb24pIHsKICAgIHJldHVybiB2aWV3LmNvbGxlY3Rpb247CiAgfQogIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgIGNvbGxlY3Rpb25FbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIGNvbGxlY3Rpb25DaWQgPSBjb2xsZWN0aW9uRWxlbWVudCAmJiBjb2xsZWN0aW9uRWxlbWVudC5hdHRyKGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lKTsKICBpZiAoY29sbGVjdGlvbkNpZCkgewogICAgdmlldyA9ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3KSB7CiAgICAgIHJldHVybiB2aWV3LmNvbGxlY3Rpb247CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGluaGVyaXRWYXJzICovCgppbmhlcml0VmFycy5tb2RlbC5kZWZhdWx0T3B0aW9ucy5wb3B1bGF0ZSA9IHRydWU7Cgp2YXIgb2xkTW9kZWxDaGFuZ2UgPSBpbmhlcml0VmFycy5tb2RlbC5jaGFuZ2U7CmluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZSA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgdGhpcy5faXNDaGFuZ2luZyA9IHRydWU7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB0aGlzLl9pc0NoYW5naW5nID0gZmFsc2U7CgogIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2VyaWFsaXppbmcpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBwb3B1bGF0ZSA9IHBvcHVsYXRlT3B0aW9ucyh0aGlzKTsKICBpZiAodGhpcy5fcmVuZGVyQ291bnQgJiYgcG9wdWxhdGUpIHsKICAgIHRoaXMucG9wdWxhdGUoIXBvcHVsYXRlLmNvbnRleHQgJiYgdGhpcy5tb2RlbC5hdHRyaWJ1dGVzLCBwb3B1bGF0ZSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgLy9zZXJpYWxpemVzIGEgZm9ybSBwcmVzZW50IGluIHRoZSB2aWV3LCByZXR1cm5pbmcgdGhlIHNlcmlhbGl6ZWQgZGF0YQogIC8vYXMgYW4gb2JqZWN0CiAgLy9wYXNzIHtzZXQ6ZmFsc2V9IHRvIG5vdCB1cGRhdGUgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgLy9jYW4gcGFzcyBvcHRpb25zLCBjYWxsYmFjayBvciBldmVudCBpbiBhbnkgb3JkZXIKICBzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrLCBvcHRpb25zLCBldmVudDsKICAgIC8vaWdub3JlIHVuZGVmaW5lZCBhcmd1bWVudHMgaW4gY2FzZSBldmVudCB3YXMgbnVsbAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgaWYgKCdzdG9wUHJvcGFnYXRpb24nIGluIGFyZ3VtZW50c1tpXSAmJiAncHJldmVudERlZmF1bHQnIGluIGFyZ3VtZW50c1tpXSkgewogICAgICAgICAgZXZlbnQgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGV2ZW50ICYmICF0aGlzLl9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbihldmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNldDogdHJ1ZSwKICAgICAgdmFsaWRhdGU6IHRydWUsCiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0KHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgdmFyIHZhbHVlID0gdmlldy5fZ2V0SW5wdXRWYWx1ZShlbGVtZW50LCBvcHRpb25zLCBlcnJvcnMpOwogICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIGVsZW1lbnQubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmICghb3B0aW9ucy5fc2lsZW50KSB7CiAgICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnQsIHNlcmlhbGl6aW5nOiB0cnVlfSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgdmFsdWUsCiAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgZWFjaE5hbWVkSW5wdXQodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUoYXR0cmlidXRlcywgZWxlbWVudC5uYW1lLCB7bW9kZTogJ3BvcHVsYXRlJ30sIGZ1bmN0aW9uKG9iamVjdCwga2V5KSB7CiAgICAgICAgdmFsdWUgPSBvYmplY3QgJiYgb2JqZWN0W2tleV07CgogICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgdmFyIGlzQmluYXJ5ID0gZWxlbWVudC50eXBlID09PSAnY2hlY2tib3gnIHx8IGVsZW1lbnQudHlwZSA9PT0gJ3JhZGlvJzsKICAgICAgICAgIGlmIChpc0JpbmFyeSAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQmluYXJ5KSB7CiAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlID09IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgICsrdGhpcy5fcG9wdWxhdGVDb3VudDsKICAgIGlmICghb3B0aW9ucy5fc2lsZW50KSB7CiAgICAgIHRoaXMudHJpZ2dlcigncG9wdWxhdGUnLCBhdHRyaWJ1dGVzKTsKICAgIH0KICB9LAoKICAvL3BlcmZvcm0gZm9ybSB2YWxpZGF0aW9uLCBpbXBsZW1lbnRlZCBieSBjaGlsZCBjbGFzcwogIHZhbGlkYXRlSW5wdXQ6IGZ1bmN0aW9uKC8qIGF0dHJpYnV0ZXMsIG9wdGlvbnMsIGVycm9ycyAqLykge30sCgogIF9nZXRJbnB1dFZhbHVlOiBmdW5jdGlvbihpbnB1dCAvKiAsIG9wdGlvbnMsIGVycm9ycyAqLykgewogICAgaWYgKGlucHV0LnR5cGUgPT09ICdjaGVja2JveCcgfHwgaW5wdXQudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBpZiAoaW5wdXQuY2hlY2tlZCkgewogICAgICAgIHJldHVybiBpbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgfHwgdHJ1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpbnB1dC5tdWx0aXBsZSA9PT0gdHJ1ZSkgewogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICQoJ29wdGlvbicsIGlucHV0KS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB2YWx1ZXMucHVzaCh0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgfQogIH0sCgogIF9wb3B1bGF0ZUNvdW50OiAwCn0pOwoKLy8gS2VlcGluZyBzdGF0ZSBpbiB0aGUgdmlld3MKVGhvcmF4LlZpZXcub24oewogICdiZWZvcmU6cmVuZGVyZWQnOiBmdW5jdGlvbigpIHsKICAgIC8vIERvIG5vdCBzdG9yZSBwcmV2aW91cyBvcHRpb25zIGlmIHdlIGhhdmUgbm90IHJlbmRlcmVkIG9yIGlmIHdlIGhhdmUgY2hhbmdlZCB0aGUgYXNzb2NpYXRlZAogICAgLy8gbW9kZWwgc2luY2UgdGhlIGxhc3QgcmVuZGVyCiAgICBpZiAoIXRoaXMuX3JlbmRlckNvdW50IHx8ICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuY2lkKSAhPT0gdGhpcy5fZm9ybU1vZGVsQ2lkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKHRoaXMubW9kZWwpOwogICAgLy8gV2hlbiB3ZSBoYXZlIHByZXZpb3VzbHkgcG9wdWxhdGVkIGFuZCByZW5kZXJlZCB0aGUgdmlldywgcmV1c2UgdGhlIHVzZXIgZGF0YQogICAgdGhpcy5wcmV2aW91c0Zvcm1EYXRhID0gZmlsdGVyT2JqZWN0KAogICAgICB0aGlzLnNlcmlhbGl6ZShfLmV4dGVuZCh7IHNldDogZmFsc2UsIHZhbGlkYXRlOiBmYWxzZSwgX3NpbGVudDogdHJ1ZSB9LCBtb2RlbE9wdGlvbnMpKSwKICAgICAgZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPSBudWxsOyB9CiAgICApOwogIH0sCiAgcmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIHBvcHVsYXRlID0gcG9wdWxhdGVPcHRpb25zKHRoaXMpOwoKICAgIGlmIChwb3B1bGF0ZSAmJiAhdGhpcy5faXNDaGFuZ2luZyAmJiAhdGhpcy5fcG9wdWxhdGVDb3VudCkgewogICAgICB0aGlzLnBvcHVsYXRlKCFwb3B1bGF0ZS5jb250ZXh0ICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcywgcG9wdWxhdGUpOwogICAgfQogICAgaWYgKHRoaXMucHJldmlvdXNGb3JtRGF0YSkgewogICAgICB0aGlzLnBvcHVsYXRlKHRoaXMucHJldmlvdXNGb3JtRGF0YSwgXy5leHRlbmQoe19zaWxlbnQ6IHRydWV9LCBwb3B1bGF0ZSkpOwogICAgfQoKICAgIHRoaXMuX2Zvcm1Nb2RlbENpZCA9IHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5jaWQ7CiAgICB0aGlzLnByZXZpb3VzRm9ybURhdGEgPSBudWxsOwogIH0KfSk7CgpmdW5jdGlvbiBmaWx0ZXJPYmplY3Qob2JqZWN0LCBjYWxsYmFjaykgewogIF8uZWFjaChvYmplY3QsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICBpZiAoXy5pc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGZpbHRlck9iamVjdCh2YWx1ZSwgY2FsbGJhY2spOwogICAgfQogICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkgPT09IGZhbHNlKSB7CiAgICAgIGRlbGV0ZSBvYmplY3Rba2V5XTsKICAgIH0KICB9KTsKICByZXR1cm4gb2JqZWN0Owp9CgpUaG9yYXguVmlldy5vbih7CiAgaW52YWxpZDogb25FcnJvck9ySW52YWxpZERhdGEsCiAgZXJyb3I6IG9uRXJyb3JPckludmFsaWREYXRhLAogIGRlYWN0aXZhdGVkOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLiRlbCkgewogICAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uRXJyb3JPckludmFsaWREYXRhICgpIHsKICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogIC8vIElmIHdlIGVycm9yZWQgd2l0aCBhIG1vZGVsIHdlIHdhbnQgdG8gcmVzZXQgdGhlIGNvbnRlbnQgYnV0IGxlYXZlIHRoZSBVSQogIC8vIGludGFjdC4gSWYgdGhlIHVzZXIgdXBkYXRlcyB0aGUgZGF0YSBhbmQgc2VyaWFsaXplcyBhbnkgb3ZlcndyaXR0ZW4gZGF0YQogIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMpIHsKICAgIHRoaXMubW9kZWwuc2V0KHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKCksIHsKICAgICAgc2lsZW50OiB0cnVlCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGVhY2hOYW1lZElucHV0KHZpZXcsIG9wdGlvbnMsIGl0ZXJhdG9yKSB7CiAgdmFyIGkgPSAwOwoKICAkKCdzZWxlY3QsaW5wdXQsdGV4dGFyZWEnLCBvcHRpb25zLnJvb3QgfHwgdmlldy5lbCkuZWFjaChmdW5jdGlvbigpIHsKICAgIGlmICghb3B0aW9ucy5jaGlsZHJlbikgewogICAgICBpZiAodmlldyAhPT0gJCh0aGlzKS52aWV3KHtoZWxwZXI6IGZhbHNlfSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnR5cGUgIT09ICdidXR0b24nICYmIHRoaXMudHlwZSAhPT0gJ2NhbmNlbCcgJiYgdGhpcy50eXBlICE9PSAnc3VibWl0JyAmJiB0aGlzLm5hbWUpIHsKICAgICAgaXRlcmF0b3IodGhpcywgaSk7CiAgICAgICsraTsKICAgIH0KICB9KTsKfQoKLy9jYWxscyBhIGNhbGxiYWNrIHdpdGggdGhlIGNvcnJlY3Qgb2JqZWN0IGZyYWdtZW50IGFuZCBrZXkgZnJvbSBhIGNvbXBvdW5kIG5hbWUKZnVuY3Rpb24gb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgdmFyIGtleSwKICAgICAgb2JqZWN0ID0gYXR0cmlidXRlcywKICAgICAga2V5cyA9IG5hbWUuc3BsaXQoJ1snKSwKICAgICAgbW9kZSA9IG9wdGlvbnMubW9kZTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aCAtIDE7ICsraSkgewogICAga2V5ID0ga2V5c1tpXS5yZXBsYWNlKCddJywgJycpOwogICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICBpZiAobW9kZSA9PT0gJ3NlcmlhbGl6ZScpIHsKICAgICAgICBvYmplY3Rba2V5XSA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjYWxsYmFjayh1bmRlZmluZWQsIGtleSk7CiAgICAgIH0KICAgIH0KICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogIH0KICBrZXkgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV0ucmVwbGFjZSgnXScsICcnKTsKICBjYWxsYmFjayhvYmplY3QsIGtleSk7Cn0KCmZ1bmN0aW9uIHJlc2V0U3VibWl0U3RhdGUoKSB7CiAgdGhpcy4kKCdmb3JtJykucmVtb3ZlQXR0cignZGF0YS1zdWJtaXQtd2FpdCcpOwp9CgpmdW5jdGlvbiBwb3B1bGF0ZU9wdGlvbnModmlldykgewogIHZhciBtb2RlbE9wdGlvbnMgPSB2aWV3LmdldE9iamVjdE9wdGlvbnModmlldy5tb2RlbCkgfHwge307CiAgcmV0dXJuIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwp2YXIgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWxheW91dC1jaWQnOwoKVGhvcmF4LkxheW91dFZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMudGVtcGxhdGUgPT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICAvLyBpZiB0aGVyZSBpcyBubyB0ZW1wbGF0ZSBzZXRWaWV3IHdpbGwgYXBwZW5kIHRvIHRoaXMuJGVsCiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYSB0ZW1wbGF0ZSB3YXMgc3BlY2lmaWVkIGlzIG11c3QgZGVjbGFyZSBhIGxheW91dC1lbGVtZW50CiAgICAgIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmIChfLmlzU3RyaW5nKHZpZXcpKSB7CiAgICAgIHZpZXcgPSBuZXcgKFRob3JheC5VdGlsLnJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgdmlldywgZmFsc2UpKSgpOwogICAgfQogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgdmFyIG9sZFZpZXcgPSB0aGlzLl92aWV3LCBhcHBlbmQsIHJlbW92ZSwgY29tcGxldGU7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OnN0YXJ0Jywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CgogICAgcmVtb3ZlID0gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICBpZiAob2xkVmlldykgewogICAgICAgIG9sZFZpZXcuJGVsICYmIG9sZFZpZXcuJGVsLnJlbW92ZSgpOwogICAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKG9sZFZpZXcsICdkZWFjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKG9sZFZpZXcpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICBhcHBlbmQgPSBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKHRoaXMsICdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5fdmlldy5hcHBlbmRUbyh0YXJnZXRFbGVtZW50KTsKICAgICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl92aWV3ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICBjb21wbGV0ZSA9IF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzplbmQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKICAgIH0sIHRoaXMpOwoKICAgIGlmICghb3B0aW9ucy50cmFuc2l0aW9uKSB7CiAgICAgIHJlbW92ZSgpOwogICAgICBhcHBlbmQoKTsKICAgICAgY29tcGxldGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIG9wdGlvbnMudHJhbnNpdGlvbih2aWV3LCBvbGRWaWV3LCBhcHBlbmQsIHJlbW92ZSwgY29tcGxldGUpOwogICAgfQoKICAgIHJldHVybiB2aWV3OwogIH0sCgogIGdldFZpZXc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXc7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xheW91dC1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIExheW91dFZpZXcKICBpZiAoIXZpZXcuZ2V0VmlldykgewogICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbGF5b3V0LWVsZW1lbnQtaGVscGVyJykpOwogIH0KICBvcHRpb25zLmhhc2hbbGF5b3V0Q2lkQXR0cmlidXRlTmFtZV0gPSB2aWV3LmNpZDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQoZXZlbnROYW1lLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy50YXJnZXQgPSB0aGlzOwogIHRoaXMudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIH0pOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLyogZ2xvYmFsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwoKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3ID0gVGhvcmF4LkNvbGxlY3Rpb25WaWV3LmV4dGVuZCh7CiAgLy8gRm9yd2FyZCByZW5kZXIgZXZlbnRzIHRvIHRoZSBwYXJlbnQKICBldmVudHM6IHsKICAgICdyZW5kZXJlZDppdGVtJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDppdGVtJyksCiAgICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6Y29sbGVjdGlvbicpLAogICAgJ3JlbmRlcmVkOmVtcHR5JzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDplbXB0eScpCiAgfSwKCiAgLy8gVGhvcmF4LkNvbGxlY3Rpb25WaWV3IGFsbG93cyBhIGNvbGxlY3Rpb25TZWxlY3RvcgogIC8vIHRvIGJlIHNwZWNpZmllZCwgZGlzYWxsb3cgaW4gYSBjb2xsZWN0aW9uIGhlbHBlcgogIC8vIGFzIGl0IHdpbGwgY2F1c2UgcHJvYmxlbXMgd2hlbiBuZXNldGVkCiAgZ2V0Q29sbGVjdGlvbkVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuJGVsOwogIH0sCgogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAvLyBuZWVkIHRvIGZldGNoIHRlbXBsYXRlcyBpZiB0ZW1wbGF0ZSBuYW1lIHdhcyBwYXNzZWQKICAgIGlmIChvcHRpb25zLm9wdGlvbnNbJ2l0ZW0tdGVtcGxhdGUnXSkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKG9wdGlvbnMub3B0aW9uc1snaXRlbS10ZW1wbGF0ZSddKTsKICAgIH0KICAgIGlmIChvcHRpb25zLm9wdGlvbnNbJ2VtcHR5LXRlbXBsYXRlJ10pIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUob3B0aW9ucy5vcHRpb25zWydlbXB0eS10ZW1wbGF0ZSddKTsKICAgIH0KCiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CgogICAgdmFyIHNob3VsZEJpbmRJdGVtQ29udGV4dCA9IF8uaXNGdW5jdGlvbihvcHRpb25zLml0ZW1Db250ZXh0KSwKICAgICAgICBzaG91bGRCaW5kSXRlbUZpbHRlciA9IF8uaXNGdW5jdGlvbihvcHRpb25zLml0ZW1GaWx0ZXIpOwoKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5IZWxwZXJWaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAKICAgIGlmIChzaG91bGRCaW5kSXRlbUNvbnRleHQpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IF8uYmluZCh0aGlzLml0ZW1Db250ZXh0LCB0aGlzLnBhcmVudCk7CiAgICB9IGVsc2UgaWYgKF8uaXNTdHJpbmcodGhpcy5pdGVtQ29udGV4dCkpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IF8uYmluZCh0aGlzLnBhcmVudFt0aGlzLml0ZW1Db250ZXh0XSwgdGhpcy5wYXJlbnQpOwogICAgfQoKICAgIGlmIChzaG91bGRCaW5kSXRlbUZpbHRlcikgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBfLmJpbmQodGhpcy5pdGVtRmlsdGVyLCB0aGlzLnBhcmVudCk7CiAgICB9IGVsc2UgaWYgKF8uaXNTdHJpbmcodGhpcy5pdGVtRmlsdGVyKSkgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBfLmJpbmQodGhpcy5wYXJlbnRbdGhpcy5pdGVtRmlsdGVyXSwgdGhpcy5wYXJlbnQpOwogICAgfQoKICAgIGlmICh0aGlzLnBhcmVudC5uYW1lKSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVZpZXcgJiYgIXRoaXMucGFyZW50LnJlbmRlckVtcHR5KSB7CiAgICAgICAgdGhpcy5lbXB0eVZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3Q2xhc3ModGhpcy5wYXJlbnQubmFtZSArICctZW1wdHknLCB0cnVlKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5wYXJlbnQucmVuZGVyRW1wdHkpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVmlldyAmJiAhdGhpcy5wYXJlbnQucmVuZGVySXRlbSkgewogICAgICAgIHRoaXMuaXRlbVZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3Q2xhc3ModGhpcy5wYXJlbnQubmFtZSArICctaXRlbScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUgJiYgIXRoaXMucGFyZW50LnJlbmRlckl0ZW0pIHsKICAgICAgICAvLyBpdGVtIHRlbXBsYXRlIG11c3QgYmUgcHJlc2VudCBpZiBhbiBpdGVtVmlldyBpcyBub3QKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCAhIXRoaXMuaXRlbVZpZXcpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oKSB7CiAgICBfLmVhY2goZm9yd2FyZGFibGVQcm9wZXJ0aWVzLCBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CiAgICB9LCB0aGlzKTsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBfLmVhY2goWydpdGVtRmlsdGVyJywgJ2l0ZW1Db250ZXh0JywgJ3JlbmRlckl0ZW0nLCAncmVuZGVyRW1wdHknXSwgZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIGlmIChzZWxmLnBhcmVudFtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgc2VsZltwcm9wZXJ0eU5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc2VsZi5wYXJlbnRbcHJvcGVydHlOYW1lXS5hcHBseShzZWxmLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgaGVscGVyVmlld1Byb3RvdHlwZSk7CgoKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LmF0dHJpYnV0ZVdoaXRlTGlzdCA9IHsKICAnaXRlbS1jb250ZXh0JzogJ2l0ZW1Db250ZXh0JywKICAnaXRlbS1maWx0ZXInOiAnaXRlbUZpbHRlcicsCiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Owp9Cgp2YXIgZm9yd2FyZGFibGVQcm9wZXJ0aWVzID0gWwogICdpdGVtVGVtcGxhdGUnLAogICdpdGVtVmlldycsCiAgJ2VtcHR5VGVtcGxhdGUnLAogICdlbXB0eVZpZXcnCl07CgpmdW5jdGlvbiBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5KHByb3BlcnR5TmFtZSkgewogIHZhciBwYXJlbnQgPSBnZXRQYXJlbnQodGhpcyk7CiAgaWYgKCF0aGlzW3Byb3BlcnR5TmFtZV0pIHsKICAgIHZhciBwcm9wID0gcGFyZW50W3Byb3BlcnR5TmFtZV07CiAgICBpZiAocHJvcCl7CiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHByb3A7CiAgICB9CiAgfQp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignY29sbGVjdGlvbicsIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldywgZnVuY3Rpb24oY29sbGVjdGlvbiwgdmlldykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSB2aWV3LnBhcmVudC5jb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiAmJiB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogICAgLy8gcHJvcGFnYXRlIGZ1dHVyZSBjaGFuZ2VzIHRvIHRoZSBwYXJlbnQncyBjb2xsZWN0aW9uIG9iamVjdAogICAgLy8gdG8gdGhlIGhlbHBlciB2aWV3CiAgICB2aWV3Lmxpc3RlblRvKHZpZXcucGFyZW50LCAnY2hhbmdlOmRhdGEtb2JqZWN0JywgZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCkgewogICAgICBpZiAodHlwZSA9PT0gJ2NvbGxlY3Rpb24nKSB7CiAgICAgICAgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICAgICAgdmlldy5zZXRDb2xsZWN0aW9uKGRhdGFPYmplY3QpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29sbGVjdGlvbiAmJiB2aWV3LnNldENvbGxlY3Rpb24oY29sbGVjdGlvbik7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY29sbGVjdGlvbi1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIGlmICghZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJDb2xsZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCdjb2xsZWN0aW9uLWVsZW1lbnQtaGVscGVyJykpOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgaGFzaFtjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBoYXNoLCAnJywgdGhpcykpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VtcHR5JywgZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gZGF0YU9iamVjdDsKICB9CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBkYXRhT2JqZWN0ID0gdmlldy5tb2RlbDsKICB9CiAgLy8gbGlzdGVuZXJzIGZvciB0aGUgZW1wdHkgaGVscGVyIHJhdGhlciB0aGFuIGxpc3RlbmVycwogIC8vIHRoYXQgYXJlIHRoZW1zZWx2ZXMgZW1wdHkKICBpZiAoIXZpZXcuX2VtcHR5TGlzdGVuZXJzKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVycyA9IHt9OwogIH0KICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIGNvbGxlY3Rpb24KICBpZiAoZGF0YU9iamVjdCAmJiAhdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdICYmIGRhdGFPYmplY3QubW9kZWxzICYmICgnbGVuZ3RoJyBpbiBkYXRhT2JqZWN0KSkgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdID0gdHJ1ZTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3JlbW92ZScsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDApIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3Jlc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICB9KTsKICB9CiAgcmV0dXJuICFkYXRhT2JqZWN0IHx8IGRhdGFPYmplY3QuaXNFbXB0eSgpID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB1cmwgPSB1cmwgfHwgJyc7CgogIHZhciBmcmFnbWVudDsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgIGZyYWdtZW50ID0gXy5tYXAoXy5oZWFkKGFyZ3VtZW50cywgYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBlbmNvZGVVUklDb21wb25lbnQpLmpvaW4oJy8nKTsKICB9IGVsc2UgewogICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHNbMV0sCiAgICAgICAgaGFzaCA9IChvcHRpb25zICYmIG9wdGlvbnMuaGFzaCkgfHwgb3B0aW9uczsKICAgIGlmIChoYXNoICYmIGhhc2hbJ2V4cGFuZC10b2tlbnMnXSkgewogICAgICBmcmFnbWVudCA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHVybCwgdGhpcywgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBmcmFnbWVudCA9IHVybDsKICAgIH0KICB9CiAgaWYgKEJhY2tib25lLmhpc3RvcnkuX2hhc1B1c2hTdGF0ZSkgewogICAgdmFyIHJvb3QgPSBCYWNrYm9uZS5oaXN0b3J5Lm9wdGlvbnMucm9vdDsKICAgIGlmIChyb290ID09PSAnLycgJiYgZnJhZ21lbnQuc3Vic3RyKDAsIDEpID09PSAnLycpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHJvb3QgKyBmcmFnbWVudDsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuICcjJyArIGZyYWdtZW50OwogIH0KfSk7Cgo7OwovKmdsb2JhbCB2aWV3VGVtcGxhdGVPdmVycmlkZXMsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcigndmlldycsIHsKICBmYWN0b3J5OiBmdW5jdGlvbihhcmdzLCBvcHRpb25zKSB7CiAgICB2YXIgVmlldyA9IGFyZ3MubGVuZ3RoID49IDEgPyBhcmdzWzBdIDogVGhvcmF4LlZpZXc7CiAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKFZpZXcsIG9wdGlvbnMub3B0aW9ucyk7CiAgfSwKICAvLyBlbnN1cmUgZ2VuZXJhdGVkIHBsYWNlaG9sZGVyIHRhZyBpbiB0ZW1wbGF0ZQogIC8vIHdpbGwgbWF0Y2ggdGFnIG9mIHZpZXcgaW5zdGFuY2UKICBtb2RpZnlIVE1MQXR0cmlidXRlczogZnVuY3Rpb24oaHRtbEF0dHJpYnV0ZXMsIGluc3RhbmNlKSB7CiAgICBodG1sQXR0cmlidXRlcy50YWdOYW1lID0gaW5zdGFuY2UuZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogIH0sCiAgY2FsbGJhY2s6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CiAgICAvLyB2aWV3IHdpbGwgYmUgdGhlIGFyZ3VtZW50IHBhc3NlZCB0byB0aGUgaGVscGVyLCBpZiBpdCB3YXMKICAgIC8vIGEgc3RyaW5nLCBhIG5ldyBpbnN0YW5jZSB3YXMgY3JlYXRlZCBvbiB0aGUgZmx5LCBvayB0byBwYXNzCiAgICAvLyBoYXNoIGFyZ3VtZW50cywgb3RoZXJ3aXNlIG5lZWQgdG8gdGhyb3cgYXMgdGVtcGxhdGVzIHNob3VsZAogICAgLy8gbm90IGludHJvZHVjZSBzaWRlIGVmZmVjdHMgdG8gZXhpc3RpbmcgdmlldyBpbnN0YW5jZXMKICAgIGlmICghXy5pc1N0cmluZyh2aWV3KSAmJiBvcHRpb25zLmhhc2ggJiYgXy5rZXlzKG9wdGlvbnMuaGFzaCkubGVuZ3RoID4gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCd2aWV3LWhlbHBlci1oYXNoLWFyZ3MnKSk7CiAgICB9CiAgICBpZiAob3B0aW9ucy5mbikgewogICAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0gPSBvcHRpb25zLmZuOwogICAgfQogIH0KfSk7Cgo7OwovKiBnbG9iYWwgY3JlYXRlRXJyb3JNZXNzYWdlICovCgp2YXIgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jYWxsLW1ldGhvZCcsCiAgICB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdHJpZ2dlci1ldmVudCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdidXR0b24nLCBmdW5jdGlvbihtZXRob2QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IG1ldGhvZDsKICAgIG1ldGhvZCA9IG9wdGlvbnMuaGFzaC5tZXRob2Q7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIW1ldGhvZCAmJiAhb3B0aW9ucy5oYXNoLnRyaWdnZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2J1dHRvbi10cmlnZ2VyJykpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2J1dHRvbic7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIG1ldGhvZCAmJiAoaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSBtZXRob2QpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xpbmsnLCBmdW5jdGlvbigpIHsKICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgLy8gdXJsIGlzIGFuIGFycmF5IHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHVybCBoZWxwZXIKICAgICAgdXJsID0gYXJncy5sZW5ndGggPT09IDAgPyBbaGFzaC5ocmVmXSA6IGFyZ3MsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghdXJsWzBdICYmIHVybFswXSAhPT0gJycpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2xpbmstaHJlZicpKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgdXJsLnB1c2gob3B0aW9ucyk7CiAgaGFzaC5ocmVmID0gSGFuZGxlYmFycy5oZWxwZXJzLnVybC5hcHBseSh0aGlzLCB1cmwpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgdmlldyA9ICR0aGlzLnZpZXcoe2hlbHBlcjogZmFsc2V9KSwKICAgICAgbWV0aG9kTmFtZSA9ICR0aGlzLmF0dHIoY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUpLAogICAgICBldmVudE5hbWUgPSAkdGhpcy5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0aGlzLnRhZ05hbWUgPT09ICdBJyAmJiBtZXRob2RSZXNwb25zZSA9PT0gZmFsc2UgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKdmFyIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWU7CgpmdW5jdGlvbiByZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSA9IFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lIHx8ICdjbGljayc7CiAgJChkb2N1bWVudCkub24obGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgpmdW5jdGlvbiB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgJiYgJChkb2N1bWVudCkub2ZmKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgaWYgKCFUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSkgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0pOwoKOzsKdmFyIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1lbGVtZW50LXRtcCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbGVtZW50JywgZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgb3B0aW9ucy5oYXNoW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcob3B0aW9ucy5oYXNoKSk7Cn0pOwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgJGVsID0gJChlbCksCiAgICAgICAgY2lkID0gJGVsLmF0dHIoZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSksCiAgICAgICAgZWxlbWVudCA9IHRoaXMuX2VsZW1lbnRzQnlDaWRbY2lkXTsKICAgIC8vIEEgY2FsbGJhY2sgZnVuY3Rpb24gbWF5IGJlIHNwZWNpZmllZCBhcyB0aGUgdmFsdWUKICAgIGlmIChfLmlzRnVuY3Rpb24oZWxlbWVudCkpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgICRlbC5yZXBsYWNlV2l0aChlbGVtZW50KTsKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVsZW1lbnQpOwogIH0sIHRoaXMpOwp9KTsKCjs7Ci8qIGdsb2JhbCBjcmVhdGVFcnJvck1lc3NhZ2UgKi8KCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1cGVyJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgcGFyZW50ID0gZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3RvciAmJiBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yLl9fc3VwZXJfXzsKICBpZiAocGFyZW50KSB7CiAgICB2YXIgdGVtcGxhdGUgPSBwYXJlbnQudGVtcGxhdGU7CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmICghcGFyZW50Lm5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCdzdXBlci1wYXJlbnQnKSk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBwYXJlbnQubmFtZTsKICAgIH0KICAgIGlmIChfLmlzU3RyaW5nKHRlbXBsYXRlKSkgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRlbXBsYXRlLCBmYWxzZSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycywgY3JlYXRlRXJyb3JNZXNzYWdlICovCgp2YXIgbG9hZFN0YXJ0ID0gJ2xvYWQ6c3RhcnQnLAogICAgbG9hZEVuZCA9ICdsb2FkOmVuZCcsCiAgICByb290T2JqZWN0OwoKVGhvcmF4LnNldFJvb3RPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByb290T2JqZWN0ID0gb2JqOwp9OwoKVGhvcmF4LmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgY29udGV4dCkgewogIHZhciBsb2FkQ291bnRlciA9IF8udW5pcXVlSWQoJ2xvYWQnKTsKICByZXR1cm4gZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICB2YXIgc2VsZiA9IGNvbnRleHQgfHwgdGhpczsKICAgIHNlbGYuX2xvYWRJbmZvID0gc2VsZi5fbG9hZEluZm8gfHwge307CiAgICB2YXIgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl07CgogICAgZnVuY3Rpb24gc3RhcnRMb2FkVGltZW91dCgpIHsKCiAgICAgIC8vIElmIHRoZSB0aW1lb3V0IGhhcyBiZWVuIHNldCBhbHJlYWR5IGJ1dCBoYXMgbm90IHRyaWdnZXJlZCB5ZXQgZG8gbm90aGluZwogICAgICAvLyBPdGhlcndpc2Ugc2V0IGEgbmV3IHRpbWVvdXQgKGVpdGhlciBpbml0aWFsIG9yIGZvciBnb2luZyBmcm9tIGJhY2tncm91bmQgdG8KICAgICAgLy8gbm9uLWJhY2tncm91bmQgbG9hZGluZykKICAgICAgaWYgKGxvYWRJbmZvLnRpbWVvdXQgJiYgIWxvYWRJbmZvLnJ1bikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxvYWRpbmdUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiAhPT0gdW5kZWZpbmVkID8KICAgICAgICBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uIDogVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dER1cmF0aW9uOwogICAgICBsb2FkSW5mby50aW1lb3V0ID0gc2V0VGltZW91dCgKICAgICAgICAgIFRob3JheC5iaW5kU2VjdGlvbignbG9hZC1zdGFydCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBXZSBoYXZlIGEgc2xpZ2h0IHJhY2UgY29uZHRpb24gaW4gaGVyZSB3aGVyZSB0aGUgZW5kIGV2ZW50IG1heSBoYXZlIG9jY3VycmVkCiAgICAgICAgICAgIC8vIGJ1dCB0aGUgZW5kIHRpbWVvdXQgaGFzIG5vdCBleGVjdXRlZC4gUmF0aGVyIHRoYW4ga2lsbGluZyBhIGN1bXVsYXRpdmUgdGltZW91dAogICAgICAgICAgICAvLyBpbW1lZGlhdGVseSB3ZSdsbCBwcm90ZWN0IGZyb20gdGhhdCBjYXNlIGhlcmUKICAgICAgICAgICAgaWYgKGxvYWRJbmZvLmV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICAgIHN0YXJ0LmNhbGwoc2VsZiwgbG9hZEluZm8ubWVzc2FnZSwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgaXNMb2FkaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBsb2FkSW5mby5ldmVudHMubGVuZ3RoOwogICAgICAgIH0sCgogICAgICAgIGNpZDogbG9hZENvdW50ZXIsCiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBQcmV2ZW50IGJpbmRzIHRvIHRoZSBzYW1lIG9iamVjdCBtdWx0aXBsZSB0aW1lcyBhcyB0aGlzIGNhbiBjYXVzZSB2ZXJ5IGJhZCB0aGluZ3MKICAgIC8vIHRvIGhhcHBlbiBmb3IgdGhlIGxvYWQ7bG9hZDtlbmQ7ZW5kIGV4ZWN1dGlvbiBmbG93LgogICAgaWYgKF8uaW5kZXhPZihsb2FkSW5mby5ldmVudHMsIG9iamVjdCkgPj0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKCiAgICBvYmplY3Qub24obG9hZEVuZCwgZnVuY3Rpb24gZW5kQ2FsbGJhY2soKSB7CiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IF8uaW5kZXhPZihldmVudHMsIG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwICYmICFvYmplY3QuaXNMb2FkaW5nKCkpIHsKICAgICAgICBldmVudHMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgaWYgKF8uaW5kZXhPZihldmVudHMsIG9iamVjdCkgPCAwKSB7CiAgICAgICAgICAvLyBMYXN0IGNhbGxiYWNrIGZvciB0aGlzIHBhcnRpY2xhciBvYmplY3QsIHJlbW92ZSB0aGUgYmluZAogICAgICAgICAgb2JqZWN0Lm9mZihsb2FkRW5kLCBlbmRDYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoCiAgICAgICAgICBUaG9yYXguYmluZFNlY3Rpb24oJ2xvYWQtZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChsb2FkSW5mby5ydW4pIHsKICAgICAgICAgICAgICAgIC8vIEVtaXQgdGhlIGVuZCBiZWhhdmlvciwgYnV0IG9ubHkgaWYgdGhlcmUgaXMgYSBwYWlyZWQgc3RhcnQKICAgICAgICAgICAgICAgIGVuZCAmJiBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSksCiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgKiAxMDAwKTsKICAgICAgfQogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBIZWxwZXIgbWV0aG9kIGZvciBwcm9wYWdhdGluZyBsb2FkOnN0YXJ0IGV2ZW50cyB0byBvdGhlciBvYmplY3RzLgogKgogKiBGb3J3YXJkcyBsb2FkOnN0YXJ0IGV2ZW50cyB0aGF0IG9jY3VyIG9uIGBzb3VyY2VgIHRvIGBkZXN0YC4KICovClRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyA9IGZ1bmN0aW9uKHNvdXJjZSwgZGVzdCwgb25jZSkgewogIGZ1bmN0aW9uIGxvYWQobWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpIHsKICAgIGlmIChvbmNlKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICAgIGRlc3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KTsKICB9CiAgc291cmNlLm9uKGxvYWRTdGFydCwgbG9hZCk7CiAgcmV0dXJuIHsKICAgIG9mZjogZnVuY3Rpb24oKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICB9Owp9OwoKLy8KLy8gRGF0YSBsb2FkIGV2ZW50IGdlbmVyYXRpb24KLy8KCi8qKgogKiBNaXhpbmcgZm9yIGdlbmVyYXRpbmcgbG9hZDpzdGFydCBhbmQgbG9hZDplbmQgZXZlbnRzLgogKi8KVGhvcmF4Lm1peGluTG9hZGFibGUgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgLy9sb2FkaW5nIGNvbmZpZwogICAgX2xvYWRpbmdDbGFzc05hbWU6ICdsb2FkaW5nJywKICAgIF9sb2FkaW5nVGltZW91dER1cmF0aW9uOiAwLjMzLAogICAgX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb246IDAuMTAsCgogICAgLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgogICAgb25Mb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgdGhhdC5faXNMb2FkaW5nID0gdHJ1ZTsKICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcnMKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdzdGFydCcsIGJhY2tncm91bmQpOwogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IGZhbHNlOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVyCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnZW5kJyk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBfbG9hZENvdW50OiAwLAoKICAgIGlzTG9hZGluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9sb2FkQ291bnQgPiAwOwogICAgfSwKCiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdGhpcy5fbG9hZENvdW50Kys7CgogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgdGhhdCk7CiAgICB9LAogICAgbG9hZEVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2xvYWRDb3VudC0tOwoKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkRW5kLCB0aGF0KTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5WaWV3LnByb3RvdHlwZSk7ClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5WaWV3LnByb3RvdHlwZSk7CgoKaWYgKFRob3JheC5IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgppZiAoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgLy8gRGVmZXIgaGVyZSB0byBtYWludGFpbiBhc3luYyBjYWxsYmFjayBiZWhhdmlvciBmb3IgYWxsIGxvYWRpbmcgY2FzZXMKICAgIHJldHVybiBfLmRlZmVyKGNhbGxiYWNrLCB0aGlzKTsKICB9CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmdW5jdGlvbigpIHsKICAgICAgc3VjY2Vzc0NhbGxiYWNrLmNhbmNlbCgpOwogICAgICBpZiAoIXJvdXRlQ2hhbmdlZCAmJiBmYWlsYmFjaykgewogICAgICAgIGZhaWxiYWNrLmFwcGx5KHNlbGYsIFt0cnVlXS5jb25jYXQoXy50b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgfQogICAgfQogIH0sIG9wdGlvbnMpKTsKfQoKZnVuY3Rpb24gZmV0Y2hRdWV1ZShvcHRpb25zLCAkc3VwZXIpIHsKICBpZiAob3B0aW9ucy5yZXNldFF1ZXVlKSB7CiAgICAvLyBXQVJOOiBTaG91bGQgZW5zdXJlIHRoYXQgbG9hZGVycyBhcmUgcHJvdGVjdGVkIGZyb20gb3V0IG9mIGJhbmQgZGF0YQogICAgLy8gICAgd2hlbiB1c2luZyB0aGlzIG9wdGlvbgogICAgdGhpcy5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogIH0gZWxzZSBpZiAodGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBjb25jdXJyZW50IHNldC9yZXNldCBmZXRjaCBldmVudHMgYXJlIG5vdCBhZHZpc2VkCiAgICB2YXIgcmVzZXQgPSAodGhpcy5mZXRjaFF1ZXVlWzBdIHx8IHt9KS5yZXNldDsKICAgIGlmIChyZXNldCAhPT0gb3B0aW9ucy5yZXNldCkgewogICAgICAvLyBmZXRjaCB3aXRoIGNvbmN1cnJlbnQgc2V0ICYgcmVzZXQgbm90IGFsbG93ZWQKICAgICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbWl4ZWQtZmV0Y2gnKSk7CiAgICB9CiAgfQoKICBpZiAoIXRoaXMuZmV0Y2hRdWV1ZSkgewogICAgLy8gS2ljayBvZmYgdGhlIHJlcXVlc3QKICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IFtvcHRpb25zXTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHsKICAgICAgc3VjY2VzczogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdzdWNjZXNzJyksCiAgICAgIGVycm9yOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2Vycm9yJyksCiAgICAgIGNvbXBsZXRlOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2NvbXBsZXRlJykKICAgIH0sIG9wdGlvbnMpOwoKICAgIC8vIEhhbmRsZSBjYWxsZXJzIHRoYXQgZG8gbm90IHBhc3MgaW4gYSBzdXBlciBjbGFzcyBhbmQgd2lzaCB0byBpbXBsZW1lbnQgdGhlaXIgb3duCiAgICAvLyBmZXRjaCBiZWhhdmlvcgogICAgaWYgKCRzdXBlcikgewogICAgICB2YXIgcHJvbWlzZSA9ICRzdXBlci5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAodGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAgICAgLy8gZW5zdXJlIHRoZSBmZXRjaFF1ZXVlIGhhcyBub3QgYmVlbiBjbGVhcmVkIG91dCAtIGh0dHBzOi8vZ2l0aHViLmNvbS93YWxtYXJ0bGFicy90aG9yYXgvaXNzdWVzLzMwNAogICAgICAgIC8vIFRoaXMgY2FuIG9jY3VyIGluIHNvbWUgZW52aXJvbm1lbnRzIGlmIHRoZSByZXF1ZXN0IGZhaWxzIHN5bmMgdG8gdGhpcyBjYWxsLCBjYXVzaW5nIHRoZSAKICAgICAgICAvLyBlcnJvciBoYW5kbGVyIHRvIGNsZWFyIG91dCB0aGUgZmV0Y2hRdWV1ZSBiZWZvcmUgd2UgZ2V0IHRvIHRoaXMgcG9pbnQuCiAgICAgICAgdGhpcy5mZXRjaFF1ZXVlLl9wcm9taXNlID0gcHJvbWlzZTsKICAgICAgfQogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBDdXJyZW50bHkgZmV0Y2hpbmcuIFF1ZXVlIGFuZCBwcm9jZXNzIG9uY2UgY29tcGxldGUKICAgIHRoaXMuZmV0Y2hRdWV1ZS5wdXNoKG9wdGlvbnMpOwogICAgcmV0dXJuIHRoaXMuZmV0Y2hRdWV1ZS5fcHJvbWlzZTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKERhdGFDbGFzcyA9PT0gVGhvcmF4LkNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoIV8uZmluZChbJ3Jlc2V0JywgJ3JlbW92ZScsICdhZGQnLCAndXBkYXRlJ10sIGZ1bmN0aW9uKGtleSkgeyByZXR1cm4gIV8uaXNVbmRlZmluZWQob3B0aW9uc1trZXldKTsgfSkpIHsKICAgICAgICAgIC8vIHVzZSBiYWNrYm9uZSA8IDEuMCBiZWhhdmlvciB0byBhbGxvdyB0cmlnZ2VyaW5nIG9mIHJlc2V0IGV2ZW50cwogICAgICAgICAgb3B0aW9ucy5yZXNldCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMubG9hZFRyaWdnZXJlZCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgZnVuY3Rpb24gZW5kV3JhcHBlcihtZXRob2QpIHsKICAgICAgICAgIHZhciAkc3VwZXIgPSBvcHRpb25zW21ldGhvZF07CiAgICAgICAgICBvcHRpb25zW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5sb2FkRW5kKCk7CiAgICAgICAgICAgICRzdXBlciAmJiAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBlbmRXcmFwcGVyKCdzdWNjZXNzJyk7CiAgICAgICAgZW5kV3JhcHBlcignZXJyb3InKTsKICAgICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spKSB7CiAgICAgICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBpZiAoIW9wdGlvbnMuYmFja2dyb3VuZCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpICYmIHJvb3RPYmplY3QpIHsKICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZ2xvYmFsIHNjb3BlIHNlZXMgdGhlIHByb3BlciBsb2FkIGV2ZW50cyBoZXJlCiAgICAgICAgLy8gaWYgd2UgYXJlIGxvYWRpbmcgaW4gc3RhbmRhbG9uZSBtb2RlCiAgICAgICAgaWYgKHRoaXMuaXNMb2FkaW5nKCkpIHsKICAgICAgICAgIC8vIHRyaWdnZXIgZGlyZWN0bHkgYmVjYXVzZSBsb2FkOnN0YXJ0IGhhcyBhbHJlYWR5IGJlZW4gdHJpZ2dlcmVkCiAgICAgICAgICByb290T2JqZWN0LnRyaWdnZXIobG9hZFN0YXJ0LCBvcHRpb25zLm1lc3NhZ2UsIG9wdGlvbnMuYmFja2dyb3VuZCwgdGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGxvYWREYXRhLmNhbGwodGhpcywgY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKTsKICAgIH0KICB9KTsKfSk7CgpUaG9yYXguVXRpbC5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwoKLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgpUaG9yYXguVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKLy8gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3IGluaGVyaXRzIGZyb20gQ29sbGVjdGlvblZpZXcKLy8gbm90IEhlbHBlclZpZXcgc28gbmVlZCB0byBzZXQgaXQgbWFudWFsbHkKVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldyk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldykgewogIF8uZXh0ZW5kKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5hdHRyaWJ1dGVXaGl0ZUxpc3QsIHsKICAgICdsb2FkaW5nLXRlbXBsYXRlJzogJ2xvYWRpbmdUZW1wbGF0ZScsCiAgICAnbG9hZGluZy12aWV3JzogJ2xvYWRpbmdWaWV3JywKICAgICdsb2FkaW5nLXBsYWNlbWVudCc6ICdsb2FkaW5nUGxhY2VtZW50JwogIH0pOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ2xvYWQ6c3RhcnQnOiBUaG9yYXgubG9hZEhhbmRsZXIoCiAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkU3RhcnQobWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRFbmQob2JqZWN0KTsKICAgICAgfSksCgogIGNvbGxlY3Rpb246IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfSwKICBtb2RlbDogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgdmlldy5vZmYoJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHZpZXcub24oJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHJldHVybiB2aWV3Ll9pc0xvYWRpbmcgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCmZ1bmN0aW9uIG9uTG9hZFN0YXRlQ2hhbmdlKCkgewogIHRoaXMucmVuZGVyKCk7Cn0KOzsKLypnbG9iYWwgcHVzaERvbUV2ZW50cyAqLwp2YXIgaXNpT1MgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oaVBob25lfGlQb2R8aVBhZCkvaSksCiAgICBpc0FuZHJvaWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYW5kcm9pZCIpID4gLTEgPyAxIDogMCwKICAgIG1pbmltdW1TY3JvbGxZT2Zmc2V0ID0gaXNBbmRyb2lkID8gMSA6IDA7CgpUaG9yYXguVXRpbC5zY3JvbGxUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICB5ID0geSB8fCBtaW5pbXVtU2Nyb2xsWU9mZnNldDsKICBmdW5jdGlvbiBfc2Nyb2xsVG8oKSB7CiAgICB3aW5kb3cuc2Nyb2xsVG8oeCwgeSk7CiAgfQogIGlmIChpc2lPUykgewogICAgLy8gYSBkZWZlciBpcyByZXF1aXJlZCBmb3IgaW9zCiAgICBfLmRlZmVyKF9zY3JvbGxUbyk7CiAgfSBlbHNlIHsKICAgIF9zY3JvbGxUbygpOwogIH0KICByZXR1cm4gW3gsIHldOwp9OwoKVGhvcmF4LkxheW91dFZpZXcub24oJ2NoYW5nZTp2aWV3OmVuZCcsIGZ1bmN0aW9uKG5ld1ZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpIHsKICBvcHRpb25zICYmIG9wdGlvbnMuc2Nyb2xsICYmIFRob3JheC5VdGlsLnNjcm9sbFRvKDAsIDApOwp9KTsKClRob3JheC5VdGlsLnNjcm9sbFRvVG9wID0gZnVuY3Rpb24oKSB7CiAgLy8gYW5kcm9pZCB3aWxsIHVzZSBoZWlnaHQgb2YgMSBiZWNhdXNlIG9mIG1pbmltdW1TY3JvbGxZT2Zmc2V0IGluIHNjcm9sbFRvKCkKICByZXR1cm4gdGhpcy5zY3JvbGxUbygwLCAwKTsKfTsKCnB1c2hEb21FdmVudHMoWwogICdzaW5nbGVUYXAnLCAnZG91YmxlVGFwJywgJ2xvbmdUYXAnLAogICdzd2lwZScsCiAgJ3N3aXBlVXAnLCAnc3dpcGVEb3duJywKICAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnCl0pOwoKLy9idWlsdCBpbiBkb20gZXZlbnRzClRob3JheC5WaWV3Lm9uKHsKICAnc3VibWl0IGZvcm0nOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgLy8gSGlkZSBhbnkgdmlydHVhbCBrZXlib2FyZHMgdGhhdCBtYXkgYmUgbGluZ2VyaW5nIGFyb3VuZAogICAgdmFyIGZvY3VzZWQgPSAkKCc6Zm9jdXMnKVswXTsKICAgIGZvY3VzZWQgJiYgZm9jdXNlZC5ibHVyKCk7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCAqLwoKLy8gVGhpcyBkb2Vzbid0IHdvcmsgb24gSFRDIGRldmljZXMgd2l0aCBBbmRyb2lkIDQuMC4KLy8gTm90IG11Y2ggY2FuIGJlIGRvbmUgYWJvdXQgaXQgYXMgaXQgc2VlbXMgdG8gYmUgYSBicm93c2VyIGJ1ZwovLyAoaXQgZG9lc24ndCB1cGRhdGUgdmlzdWFsIHN0eWxpbmcgd2hpbGUgeW91IGhvbGQgeW91ciBmaW5nZXIgb24gdGhlIHNjcmVlbikKJC5mbi50YXBIb2xkQW5kRW5kID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNhbGxiYWNrU3RhcnQsIGNhbGxiYWNrRW5kKSB7CiAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciB0YXBIb2xkU3RhcnQsCiAgICAgICAgdGltZXIsCiAgICAgICAgdGFyZ2V0OwoKICAgIGZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoZXZlbnQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKCiAgICAgIGlmICh0YXBIb2xkU3RhcnQgJiYgdGFyZ2V0KSB7CiAgICAgICAgY2FsbGJhY2tFbmQodGFyZ2V0KTsKICAgICAgfQoKICAgICAgdGFyZ2V0ID0gdW5kZWZpbmVkOwogICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZTsKICAgIH0KCiAgICAkKHRoaXMpLm9uKCd0b3VjaHN0YXJ0Jywgc2VsZWN0b3IsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKCQoZXZlbnQuY3VycmVudFRhcmdldCkuYXR0cignZGF0YS1uby10YXAtaGlnaGxpZ2h0JykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNsZWFyVGFwVGltZXIoKTsKCiAgICAgICAgdGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldDsKICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0YXBIb2xkU3RhcnQgPSB0cnVlOwogICAgICAgICAgY2FsbGJhY2tTdGFydCh0YXJnZXQpOwogICAgICAgIH0sIDUwKTsKICAgICAgfSkKICAgICAgLm9uKCd0b3VjaG1vdmUgdG91Y2hlbmQnLCBjbGVhclRhcFRpbWVyKTsKCiAgICAkKGRvY3VtZW50KS5vbigndG91Y2hjYW5jZWwnLCBjbGVhclRhcFRpbWVyKTsKICB9KTsKfTsKCi8vb25seSBlbmFibGUgb24gYW5kcm9pZAp2YXIgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gIWlzQW5kcm9pZDsKVGhvcmF4LmNvbmZpZ3VyZVRhcEhpZ2hsaWdodCA9IGZ1bmN0aW9uKHVzZU5hdGl2ZSwgaGlnaGxpZ2h0Q2xhc3MpIHsKICB1c2VOYXRpdmVIaWdobGlnaHQgPSB1c2VOYXRpdmU7CiAgaGlnaGxpZ2h0Q2xhc3MgPSBoaWdobGlnaHRDbGFzcyB8fCAndGFwLWhpZ2hsaWdodCc7CgogIGlmICghdXNlTmF0aXZlKSB7CiAgICBmdW5jdGlvbiBfdGFwSGlnaGxpZ2h0U3RhcnQodGFyZ2V0KSB7CiAgICAgIHZhciB0YWdOYW1lID0gdGFyZ2V0ICYmIHRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgICAgLy8gd2Ugd2FudCB0byBnaXZlIHByaW9yaXR5IHRvIGFueSBwYXJlbnQgdGhhdCBtYXkgcHJvdmlkZSBhIGZvY3VzIG9wZXJhdGlvbi4KICAgICAgaWYgKHRhZ05hbWUgPT09ICdpbnB1dCcgfHwgdGFnTmFtZSA9PT0gJ3NlbGVjdCcgfHwgdGFnTmFtZSA9PT0gJ3RleHRhcmVhJykgewogICAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyhoaWdobGlnaHRDbGFzcyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBfdGFwSGlnaGxpZ2h0RW5kKCkgewogICAgICAkKCcuJyArIGhpZ2hsaWdodENsYXNzKS5yZW1vdmVDbGFzcyhoaWdobGlnaHRDbGFzcyk7CiAgICB9CiAgICAkKGRvY3VtZW50LmJvZHkpLnRhcEhvbGRBbmRFbmQoCiAgICAgICAgICAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnLAogICAgICAgICAgX3RhcEhpZ2hsaWdodFN0YXJ0LAogICAgICAgICAgX3RhcEhpZ2hsaWdodEVuZCk7CiAgfQp9OwoKdmFyIE5BVElWRV9UQVBQQUJMRSA9IHsKICAnQSc6IHRydWUsCiAgJ0lOUFVUJzogdHJ1ZSwKICAnQlVUVE9OJzogdHJ1ZSwKICAnU0VMRUNUJzogdHJ1ZSwKICAnVEVYVEFSRUEnOiB0cnVlCn07CgovLyBPdXQgaGVyZSBzbyB3ZSBkbyBub3QgcmV0YWluIGEgc2NvcGUKZnVuY3Rpb24gTk9QKCl7fQoKZnVuY3Rpb24gZml4dXBUYXBIaWdobGlnaHQoKSB7CiAgXy5lYWNoKHRoaXMuX2RvbUV2ZW50cyB8fCBbXSwgZnVuY3Rpb24oYmluZCkgewogICAgdmFyIGNvbXBvbmVudHMgPSBiaW5kLnNwbGl0KCcgJyksCiAgICAgICAgc2VsZWN0b3IgPSBjb21wb25lbnRzLnNsaWNlKDEpLmpvaW4oJyAnKSB8fCB1bmRlZmluZWQ7ICAvLyBOZWVkZWQgdG8gbWFrZSB6ZXB0byBoYXBweQoKICAgIGlmIChjb21wb25lbnRzWzBdID09PSAnY2xpY2snKSB7CiAgICAgIC8vICFzZWxlY3RvciBjYXNlIGlzIGZvciByb290IGNsaWNrIGhhbmRsZXJzIG9uIHRoZSB2aWV3LCBpLmUuICdjbGljaycKICAgICAgJChzZWxlY3RvciB8fCB0aGlzLmVsLCBzZWxlY3RvciAmJiB0aGlzLmVsKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyICRlbCA9ICQoZWwpLmF0dHIoJ2RhdGEtdGFwcGFibGUnLCB0cnVlKTsKCiAgICAgICAgaWYgKHVzZU5hdGl2ZUhpZ2hsaWdodCAmJiAhTkFUSVZFX1RBUFBBQkxFW2VsLnRhZ05hbWVdKSB7CiAgICAgICAgICAvLyBBZGQgYW4gZXhwbGljaXQgTk9QIGJpbmQgdG8gYWxsb3cgdGFwLWhpZ2hsaWdodCBzdXBwb3J0CiAgICAgICAgICAkZWwub24oJ2NsaWNrJywgTk9QKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHRoaXMpOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ3JlbmRlcmVkJzogZml4dXBUYXBIaWdobGlnaHQsCiAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmaXh1cFRhcEhpZ2hsaWdodCwKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0LAogICdyZW5kZXJlZDplbXB0eSc6IGZpeHVwVGFwSGlnaGxpZ2h0Cn0pOwoKdmFyIF9hZGRFdmVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fYWRkRXZlbnQ7ClRob3JheC5WaWV3LnByb3RvdHlwZS5fYWRkRXZlbnQgPSBmdW5jdGlvbihwYXJhbXMpIHsKICB0aGlzLl9kb21FdmVudHMgPSB0aGlzLl9kb21FdmVudHMgfHwgW107CiAgaWYgKHBhcmFtcy50eXBlID09PSAiRE9NIikgewogICAgdGhpcy5fZG9tRXZlbnRzLnB1c2gocGFyYW1zLm9yaWdpbmFsTmFtZSk7CiAgfQogIHJldHVybiBfYWRkRXZlbnQuY2FsbCh0aGlzLCBwYXJhbXMpOwp9OwoKOzsKCgp9KSgpOwoKLy9AIHNvdXJjZU1hcHBpbmdVUkw9dGhvcmF4LW1vYmlsZS5qcy5tYXAKCg==",
                "body": "LyogWmVwdG8gdjEuMS4yIC0gemVwdG8gZXZlbnQgYWpheCBmb3JtIGllIC0gemVwdG9qcy5jb20vbGljZW5zZSAqLwoKCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsIGZpbHRlciA9IGVtcHR5QXJyYXkuZmlsdGVyLAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICBlbGVtZW50RGlzcGxheSA9IHt9LCBjbGFzc0NhY2hlID0ge30sCiAgICBjc3NOdW1iZXIgPSB7ICdjb2x1bW4tY291bnQnOiAxLCAnY29sdW1ucyc6IDEsICdmb250LXdlaWdodCc6IDEsICdsaW5lLWhlaWdodCc6IDEsJ29wYWNpdHknOiAxLCAnei1pbmRleCc6IDEsICd6b29tJzogMSB9LAogICAgZnJhZ21lbnRSRSA9IC9eXHMqPChcdyt8ISlbXj5dKj4vLAogICAgc2luZ2xlVGFnUkUgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAogICAgdGFnRXhwYW5kZXJSRSA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vaWcsCiAgICByb290Tm9kZVJFID0gL14oPzpib2R5fGh0bWwpJC9pLAogICAgY2FwaXRhbFJFID0gLyhbQS1aXSkvZywKCiAgICAvLyBzcGVjaWFsIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgZ2V0L3NldCB2aWEgbWV0aG9kIGNhbGxzCiAgICBtZXRob2RBdHRyaWJ1dGVzID0gWyd2YWwnLCAnY3NzJywgJ2h0bWwnLCAndGV4dCcsICdkYXRhJywgJ3dpZHRoJywgJ2hlaWdodCcsICdvZmZzZXQnXSwKCiAgICBhZGphY2VuY3lPcGVyYXRvcnMgPSBbICdhZnRlcicsICdwcmVwZW5kJywgJ2JlZm9yZScsICdhcHBlbmQnIF0sCiAgICB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyksCiAgICB0YWJsZVJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyksCiAgICBjb250YWluZXJzID0gewogICAgICAndHInOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0Ym9keScpLAogICAgICAndGJvZHknOiB0YWJsZSwgJ3RoZWFkJzogdGFibGUsICd0Zm9vdCc6IHRhYmxlLAogICAgICAndGQnOiB0YWJsZVJvdywgJ3RoJzogdGFibGVSb3csCiAgICAgICcqJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgIH0sCiAgICByZWFkeVJFID0gL2NvbXBsZXRlfGxvYWRlZHxpbnRlcmFjdGl2ZS8sCiAgICBjbGFzc1NlbGVjdG9yUkUgPSAvXlwuKFtcdy1dKykkLywKICAgIGlkU2VsZWN0b3JSRSA9IC9eIyhbXHctXSopJC8sCiAgICBzaW1wbGVTZWxlY3RvclJFID0gL15bXHctXSokLywKICAgIGNsYXNzMnR5cGUgPSB7fSwKICAgIHRvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZywKICAgIHplcHRvID0ge30sCiAgICBjYW1lbGl6ZSwgdW5pcSwKICAgIHRlbXBQYXJlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgIHByb3BNYXAgPSB7CiAgICAgICd0YWJpbmRleCc6ICd0YWJJbmRleCcsCiAgICAgICdyZWFkb25seSc6ICdyZWFkT25seScsCiAgICAgICdmb3InOiAnaHRtbEZvcicsCiAgICAgICdjbGFzcyc6ICdjbGFzc05hbWUnLAogICAgICAnbWF4bGVuZ3RoJzogJ21heExlbmd0aCcsCiAgICAgICdjZWxsc3BhY2luZyc6ICdjZWxsU3BhY2luZycsCiAgICAgICdjZWxscGFkZGluZyc6ICdjZWxsUGFkZGluZycsCiAgICAgICdyb3dzcGFuJzogJ3Jvd1NwYW4nLAogICAgICAnY29sc3Bhbic6ICdjb2xTcGFuJywKICAgICAgJ3VzZW1hcCc6ICd1c2VNYXAnLAogICAgICAnZnJhbWVib3JkZXInOiAnZnJhbWVCb3JkZXInLAogICAgICAnY29udGVudGVkaXRhYmxlJzogJ2NvbnRlbnRFZGl0YWJsZScKICAgIH0KCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIXNlbGVjdG9yIHx8ICFlbGVtZW50IHx8IGVsZW1lbnQubm9kZVR5cGUgIT09IDEpIHJldHVybiBmYWxzZQogICAgdmFyIG1hdGNoZXNTZWxlY3RvciA9IGVsZW1lbnQud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGVsZW1lbnQubW96TWF0Y2hlc1NlbGVjdG9yIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vTWF0Y2hlc1NlbGVjdG9yIHx8IGVsZW1lbnQubWF0Y2hlc1NlbGVjdG9yCiAgICBpZiAobWF0Y2hlc1NlbGVjdG9yKSByZXR1cm4gbWF0Y2hlc1NlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpCiAgICAvLyBmYWxsIGJhY2sgdG8gcGVyZm9ybWluZyBhIHNlbGVjdG9yOgogICAgdmFyIG1hdGNoLCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsIHRlbXAgPSAhcGFyZW50CiAgICBpZiAodGVtcCkgKHBhcmVudCA9IHRlbXBQYXJlbnQpLmFwcGVuZENoaWxkKGVsZW1lbnQpCiAgICBtYXRjaCA9IH56ZXB0by5xc2EocGFyZW50LCBzZWxlY3RvcikuaW5kZXhPZihlbGVtZW50KQogICAgdGVtcCAmJiB0ZW1wUGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpCiAgICByZXR1cm4gbWF0Y2gKICB9CgogIGZ1bmN0aW9uIHR5cGUob2JqKSB7CiAgICByZXR1cm4gb2JqID09IG51bGwgPyBTdHJpbmcob2JqKSA6CiAgICAgIGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAib2JqZWN0IgogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdHlwZSh2YWx1ZSkgPT0gImZ1bmN0aW9uIiB9CiAgZnVuY3Rpb24gaXNXaW5kb3cob2JqKSAgICAgeyByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09IG9iai53aW5kb3cgfQogIGZ1bmN0aW9uIGlzRG9jdW1lbnQob2JqKSAgIHsgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iai5ub2RlVHlwZSA9PSBvYmouRE9DVU1FTlRfTk9ERSB9CiAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSAgICAgeyByZXR1cm4gdHlwZShvYmopID09ICJvYmplY3QiIH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogICAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgIWlzV2luZG93KG9iaikgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT0gT2JqZWN0LnByb3RvdHlwZQogIH0KICBmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5IH0KICBmdW5jdGlvbiBsaWtlQXJyYXkob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqLmxlbmd0aCA9PSAnbnVtYmVyJyB9CgogIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsgcmV0dXJuIGZpbHRlci5jYWxsKGFycmF5LCBmdW5jdGlvbihpdGVtKXsgcmV0dXJuIGl0ZW0gIT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/ICQuZm4uY29uY2F0LmFwcGx5KFtdLCBhcnJheSkgOiBhcnJheSB9CiAgY2FtZWxpemUgPSBmdW5jdGlvbihzdHIpeyByZXR1cm4gc3RyLnJlcGxhY2UoLy0rKC4pPy9nLCBmdW5jdGlvbihtYXRjaCwgY2hyKXsgcmV0dXJuIGNociA/IGNoci50b1VwcGVyQ2FzZSgpIDogJycgfSkgfQogIGZ1bmN0aW9uIGRhc2hlcml6ZShzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvOjovZywgJy8nKQogICAgICAgICAgIC5yZXBsYWNlKC8oW0EtWl0rKShbQS1aXVthLXpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC8oW2EtelxkXSkoW0EtWl0pL2csICckMV8kMicpCiAgICAgICAgICAgLnJlcGxhY2UoL18vZywgJy0nKQogICAgICAgICAgIC50b0xvd2VyQ2FzZSgpCiAgfQogIHVuaXEgPSBmdW5jdGlvbihhcnJheSl7IHJldHVybiBmaWx0ZXIuY2FsbChhcnJheSwgZnVuY3Rpb24oaXRlbSwgaWR4KXsgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSkgPT0gaWR4IH0pIH0KCiAgZnVuY3Rpb24gY2xhc3NSRShuYW1lKSB7CiAgICByZXR1cm4gbmFtZSBpbiBjbGFzc0NhY2hlID8KICAgICAgY2xhc3NDYWNoZVtuYW1lXSA6IChjbGFzc0NhY2hlW25hbWVdID0gbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBuYW1lICsgJyhcXHN8JCknKSkKICB9CgogIGZ1bmN0aW9uIG1heWJlQWRkUHgobmFtZSwgdmFsdWUpIHsKICAgIHJldHVybiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmICFjc3NOdW1iZXJbZGFzaGVyaXplKG5hbWUpXSkgPyB2YWx1ZSArICJweCIgOiB2YWx1ZQogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKICAgIHZhciBlbGVtZW50LCBkaXNwbGF5CiAgICBpZiAoIWVsZW1lbnREaXNwbGF5W25vZGVOYW1lXSkgewogICAgICBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChub2RlTmFtZSkKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbGVtZW50KQogICAgICBkaXNwbGF5ID0gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpCiAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50KQogICAgICBkaXNwbGF5ID09ICJub25lIiAmJiAoZGlzcGxheSA9ICJibG9jayIpCiAgICAgIGVsZW1lbnREaXNwbGF5W25vZGVOYW1lXSA9IGRpc3BsYXkKICAgIH0KICAgIHJldHVybiBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0KICB9CgogIGZ1bmN0aW9uIGNoaWxkcmVuKGVsZW1lbnQpIHsKICAgIHJldHVybiAnY2hpbGRyZW4nIGluIGVsZW1lbnQgPwogICAgICBzbGljZS5jYWxsKGVsZW1lbnQuY2hpbGRyZW4pIDoKICAgICAgJC5tYXAoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihub2RlKXsgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIG5vZGUgfSkKICB9CgogIC8vIGAkLnplcHRvLmZyYWdtZW50YCB0YWtlcyBhIGh0bWwgc3RyaW5nIGFuZCBhbiBvcHRpb25hbCB0YWcgbmFtZQogIC8vIHRvIGdlbmVyYXRlIERPTSBub2RlcyBub2RlcyBmcm9tIHRoZSBnaXZlbiBodG1sIHN0cmluZy4KICAvLyBUaGUgZ2VuZXJhdGVkIERPTSBub2RlcyBhcmUgcmV0dXJuZWQgYXMgYW4gYXJyYXkuCiAgLy8gVGhpcyBmdW5jdGlvbiBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMgZm9yIGV4YW1wbGUgdG8gbWFrZQogIC8vIGl0IGNvbXBhdGlibGUgd2l0aCBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgdGhlIERPTSBmdWxseS4KICB6ZXB0by5mcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwsIG5hbWUsIHByb3BlcnRpZXMpIHsKICAgIHZhciBkb20sIG5vZGVzLCBjb250YWluZXIKCiAgICAvLyBBIHNwZWNpYWwgY2FzZSBvcHRpbWl6YXRpb24gZm9yIGEgc2luZ2xlIHRhZwogICAgaWYgKHNpbmdsZVRhZ1JFLnRlc3QoaHRtbCkpIGRvbSA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChSZWdFeHAuJDEpKQoKICAgIGlmICghZG9tKSB7CiAgICAgIGlmIChodG1sLnJlcGxhY2UpIGh0bWwgPSBodG1sLnJlcGxhY2UodGFnRXhwYW5kZXJSRSwgIjwkMT48LyQyPiIpCiAgICAgIGlmIChuYW1lID09PSB1bmRlZmluZWQpIG5hbWUgPSBmcmFnbWVudFJFLnRlc3QoaHRtbCkgJiYgUmVnRXhwLiQxCiAgICAgIGlmICghKG5hbWUgaW4gY29udGFpbmVycykpIG5hbWUgPSAnKicKCiAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnICsgaHRtbAogICAgICBkb20gPSAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9CgogICAgaWYgKGlzUGxhaW5PYmplY3QocHJvcGVydGllcykpIHsKICAgICAgbm9kZXMgPSAkKGRvbSkKICAgICAgJC5lYWNoKHByb3BlcnRpZXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAobWV0aG9kQXR0cmlidXRlcy5pbmRleE9mKGtleSkgPiAtMSkgbm9kZXNba2V5XSh2YWx1ZSkKICAgICAgICBlbHNlIG5vZGVzLmF0dHIoa2V5LCB2YWx1ZSkKICAgICAgfSkKICAgIH0KCiAgICByZXR1cm4gZG9tCiAgfQoKICAvLyBgJC56ZXB0by5aYCBzd2FwcyBvdXQgdGhlIHByb3RvdHlwZSBvZiB0aGUgZ2l2ZW4gYGRvbWAgYXJyYXkKICAvLyBvZiBub2RlcyB3aXRoIGAkLmZuYCBhbmQgdGh1cyBzdXBwbHlpbmcgYWxsIHRoZSBaZXB0byBmdW5jdGlvbnMKICAvLyB0byB0aGUgYXJyYXkuIE5vdGUgdGhhdCBgX19wcm90b19fYCBpcyBub3Qgc3VwcG9ydGVkIG9uIEludGVybmV0CiAgLy8gRXhwbG9yZXIuIFRoaXMgbWV0aG9kIGNhbiBiZSBvdmVycmlkZW4gaW4gcGx1Z2lucy4KICB6ZXB0by5aID0gZnVuY3Rpb24oZG9tLCBzZWxlY3RvcikgewogICAgZG9tID0gZG9tIHx8IFtdCiAgICBkb20uX19wcm90b19fID0gJC5mbgogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgZG9tCiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gT3B0aW1pemUgZm9yIHN0cmluZyBzZWxlY3RvcnMKICAgIGVsc2UgaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgewogICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKQogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgLy8gTm90ZTogSW4gYm90aCBDaHJvbWUgMjEgYW5kIEZpcmVmb3ggMTUsIERPTSBlcnJvciAxMgogICAgICAvLyBpcyB0aHJvd24gaWYgdGhlIGZyYWdtZW50IGRvZXNuJ3QgYmVnaW4gd2l0aCA8CiAgICAgIGlmIChzZWxlY3RvclswXSA9PSAnPCcgJiYgZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3RvciwgUmVnRXhwLiQxLCBjb250ZXh0KSwgc2VsZWN0b3IgPSBudWxsCiAgICAgIC8vIElmIHRoZXJlJ3MgYSBjb250ZXh0LCBjcmVhdGUgYSBjb2xsZWN0aW9uIG9uIHRoYXQgY29udGV4dCBmaXJzdCwgYW5kIHNlbGVjdAogICAgICAvLyBub2RlcyBmcm9tIHRoZXJlCiAgICAgIGVsc2UgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCkgcmV0dXJuICQoY29udGV4dCkuZmluZChzZWxlY3RvcikKICAgICAgLy8gSWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgfQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1c3QgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICAvLyBub3JtYWxpemUgYXJyYXkgaWYgYW4gYXJyYXkgb2Ygbm9kZXMgaXMgZ2l2ZW4KICAgICAgaWYgKGlzQXJyYXkoc2VsZWN0b3IpKSBkb20gPSBjb21wYWN0KHNlbGVjdG9yKQogICAgICAvLyBXcmFwIERPTSBub2Rlcy4KICAgICAgZWxzZSBpZiAoaXNPYmplY3Qoc2VsZWN0b3IpKQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSwgY29udGV4dCksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgfQogICAgLy8gY3JlYXRlIGEgbmV3IFplcHRvIGNvbGxlY3Rpb24gZnJvbSB0aGUgbm9kZXMgZm91bmQKICAgIHJldHVybiB6ZXB0by5aKGRvbSwgc2VsZWN0b3IpCiAgfQoKICAvLyBgJGAgd2lsbCBiZSB0aGUgYmFzZSBgWmVwdG9gIG9iamVjdC4gV2hlbiBjYWxsaW5nIHRoaXMKICAvLyBmdW5jdGlvbiBqdXN0IGNhbGwgYCQuemVwdG8uaW5pdCwgd2hpY2ggbWFrZXMgdGhlIGltcGxlbWVudGF0aW9uCiAgLy8gZGV0YWlscyBvZiBzZWxlY3Rpbmcgbm9kZXMgYW5kIGNyZWF0aW5nIFplcHRvIGNvbGxlY3Rpb25zCiAgLy8gcGF0Y2hhYmxlIGluIHBsdWdpbnMuCiAgJCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KXsKICAgIHJldHVybiB6ZXB0by5pbml0KHNlbGVjdG9yLCBjb250ZXh0KQogIH0KCiAgZnVuY3Rpb24gZXh0ZW5kKHRhcmdldCwgc291cmNlLCBkZWVwKSB7CiAgICBmb3IgKGtleSBpbiBzb3VyY2UpCiAgICAgIGlmIChkZWVwICYmIChpc1BsYWluT2JqZWN0KHNvdXJjZVtrZXldKSB8fCBpc0FycmF5KHNvdXJjZVtrZXldKSkpIHsKICAgICAgICBpZiAoaXNQbGFpbk9iamVjdChzb3VyY2Vba2V5XSkgJiYgIWlzUGxhaW5PYmplY3QodGFyZ2V0W2tleV0pKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSB7fQogICAgICAgIGlmIChpc0FycmF5KHNvdXJjZVtrZXldKSAmJiAhaXNBcnJheSh0YXJnZXRba2V5XSkpCiAgICAgICAgICB0YXJnZXRba2V5XSA9IFtdCiAgICAgICAgZXh0ZW5kKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSwgZGVlcCkKICAgICAgfQogICAgICBlbHNlIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKSB0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICB2YXIgZGVlcCwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKQogICAgaWYgKHR5cGVvZiB0YXJnZXQgPT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGRlZXAgPSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJncy5zaGlmdCgpCiAgICB9CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKXsgZXh0ZW5kKHRhcmdldCwgYXJnLCBkZWVwKSB9KQogICAgcmV0dXJuIHRhcmdldAogIH0KCiAgLy8gYCQuemVwdG8ucXNhYCBpcyBaZXB0bydzIENTUyBzZWxlY3RvciBpbXBsZW1lbnRhdGlvbiB3aGljaAogIC8vIHVzZXMgYGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGxgIGFuZCBvcHRpbWl6ZXMgZm9yIHNvbWUgc3BlY2lhbCBjYXNlcywgbGlrZSBgI2lkYC4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8ucXNhID0gZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IpewogICAgdmFyIGZvdW5kLAogICAgICAgIG1heWJlSUQgPSBzZWxlY3RvclswXSA9PSAnIycsCiAgICAgICAgbWF5YmVDbGFzcyA9ICFtYXliZUlEICYmIHNlbGVjdG9yWzBdID09ICcuJywKICAgICAgICBuYW1lT25seSA9IG1heWJlSUQgfHwgbWF5YmVDbGFzcyA/IHNlbGVjdG9yLnNsaWNlKDEpIDogc2VsZWN0b3IsIC8vIEVuc3VyZSB0aGF0IGEgMSBjaGFyIHRhZyBuYW1lIHN0aWxsIGdldHMgY2hlY2tlZAogICAgICAgIGlzU2ltcGxlID0gc2ltcGxlU2VsZWN0b3JSRS50ZXN0KG5hbWVPbmx5KQogICAgcmV0dXJuIChpc0RvY3VtZW50KGVsZW1lbnQpICYmIGlzU2ltcGxlICYmIG1heWJlSUQpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKG5hbWVPbmx5KSkgPyBbZm91bmRdIDogW10gKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gW10gOgogICAgICBzbGljZS5jYWxsKAogICAgICAgIGlzU2ltcGxlICYmICFtYXliZUlEID8KICAgICAgICAgIG1heWJlQ2xhc3MgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZU9ubHkpIDogLy8gSWYgaXQncyBzaW1wbGUsIGl0IGNvdWxkIGJlIGEgY2xhc3MKICAgICAgICAgIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpIDogLy8gT3IgYSB0YWcKICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikgLy8gT3IgaXQncyBub3Qgc2ltcGxlLCBhbmQgd2UgbmVlZCB0byBxdWVyeSBhbGwKICAgICAgKQogIH0KCiAgZnVuY3Rpb24gZmlsdGVyZWQobm9kZXMsIHNlbGVjdG9yKSB7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gbnVsbCA/ICQobm9kZXMpIDogJChub2RlcykuZmlsdGVyKHNlbGVjdG9yKQogIH0KCiAgJC5jb250YWlucyA9IGZ1bmN0aW9uKHBhcmVudCwgbm9kZSkgewogICAgcmV0dXJuIHBhcmVudCAhPT0gbm9kZSAmJiBwYXJlbnQuY29udGFpbnMobm9kZSkKICB9CgogIGZ1bmN0aW9uIGZ1bmNBcmcoY29udGV4dCwgYXJnLCBpZHgsIHBheWxvYWQpIHsKICAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSwgdmFsdWUpIHsKICAgIHZhbHVlID09IG51bGwgPyBub2RlLnJlbW92ZUF0dHJpYnV0ZShuYW1lKSA6IG5vZGUuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKQogIH0KCiAgLy8gYWNjZXNzIGNsYXNzTmFtZSBwcm9wZXJ0eSB3aGlsZSByZXNwZWN0aW5nIFNWR0FuaW1hdGVkU3RyaW5nCiAgZnVuY3Rpb24gY2xhc3NOYW1lKG5vZGUsIHZhbHVlKXsKICAgIHZhciBrbGFzcyA9IG5vZGUuY2xhc3NOYW1lLAogICAgICAgIHN2ZyAgID0ga2xhc3MgJiYga2xhc3MuYmFzZVZhbCAhPT0gdW5kZWZpbmVkCgogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBzdmcgPyBrbGFzcy5iYXNlVmFsIDoga2xhc3MKICAgIHN2ZyA/IChrbGFzcy5iYXNlVmFsID0gdmFsdWUpIDogKG5vZGUuY2xhc3NOYW1lID0gdmFsdWUpCiAgfQoKICAvLyAidHJ1ZSIgID0+IHRydWUKICAvLyAiZmFsc2UiID0+IGZhbHNlCiAgLy8gIm51bGwiICA9PiBudWxsCiAgLy8gIjQyIiAgICA9PiA0MgogIC8vICI0Mi41IiAgPT4gNDIuNQogIC8vICIwOCIgICAgPT4gIjA4IgogIC8vIEpTT04gICAgPT4gcGFyc2UgaWYgdmFsaWQKICAvLyBTdHJpbmcgID0+IHNlbGYKICBmdW5jdGlvbiBkZXNlcmlhbGl6ZVZhbHVlKHZhbHVlKSB7CiAgICB2YXIgbnVtCiAgICB0cnkgewogICAgICByZXR1cm4gdmFsdWUgPwogICAgICAgIHZhbHVlID09ICJ0cnVlIiB8fAogICAgICAgICggdmFsdWUgPT0gImZhbHNlIiA/IGZhbHNlIDoKICAgICAgICAgIHZhbHVlID09ICJudWxsIiA/IG51bGwgOgogICAgICAgICAgIS9eMC8udGVzdCh2YWx1ZSkgJiYgIWlzTmFOKG51bSA9IE51bWJlcih2YWx1ZSkpID8gbnVtIDoKICAgICAgICAgIC9eW1xbXHtdLy50ZXN0KHZhbHVlKSA/ICQucGFyc2VKU09OKHZhbHVlKSA6CiAgICAgICAgICB2YWx1ZSApCiAgICAgICAgOiB2YWx1ZQogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiB2YWx1ZQogICAgfQogIH0KCiAgJC50eXBlID0gdHlwZQogICQuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24KICAkLmlzV2luZG93ID0gaXNXaW5kb3cKICAkLmlzQXJyYXkgPSBpc0FycmF5CiAgJC5pc1BsYWluT2JqZWN0ID0gaXNQbGFpbk9iamVjdAoKICAkLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lCiAgICBmb3IgKG5hbWUgaW4gb2JqKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICAkLmluQXJyYXkgPSBmdW5jdGlvbihlbGVtLCBhcnJheSwgaSl7CiAgICByZXR1cm4gZW1wdHlBcnJheS5pbmRleE9mLmNhbGwoYXJyYXksIGVsZW0sIGkpCiAgfQoKICAkLmNhbWVsQ2FzZSA9IGNhbWVsaXplCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7CiAgICByZXR1cm4gc3RyID09IG51bGwgPyAiIiA6IFN0cmluZy5wcm90b3R5cGUudHJpbS5jYWxsKHN0cikKICB9CgogIC8vIHBsdWdpbiBjb21wYXRpYmlsaXR5CiAgJC51dWlkID0gMAogICQuc3VwcG9ydCA9IHsgfQogICQuZXhwciA9IHsgfQoKICAkLm1hcCA9IGZ1bmN0aW9uKGVsZW1lbnRzLCBjYWxsYmFjayl7CiAgICB2YXIgdmFsdWUsIHZhbHVlcyA9IFtdLCBpLCBrZXkKICAgIGlmIChsaWtlQXJyYXkoZWxlbWVudHMpKQogICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1lbnRzW2ldLCBpKQogICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB2YWx1ZXMucHVzaCh2YWx1ZSkKICAgICAgfQogICAgZWxzZQogICAgICBmb3IgKGtleSBpbiBlbGVtZW50cykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNba2V5XSwga2V5KQogICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB2YWx1ZXMucHVzaCh2YWx1ZSkKICAgICAgfQogICAgcmV0dXJuIGZsYXR0ZW4odmFsdWVzKQogIH0KCiAgJC5lYWNoID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciBpLCBrZXkKICAgIGlmIChsaWtlQXJyYXkoZWxlbWVudHMpKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChlbGVtZW50c1tpXSwgaSwgZWxlbWVudHNbaV0pID09PSBmYWxzZSkgcmV0dXJuIGVsZW1lbnRzCiAgICB9IGVsc2UgewogICAgICBmb3IgKGtleSBpbiBlbGVtZW50cykKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChlbGVtZW50c1trZXldLCBrZXksIGVsZW1lbnRzW2tleV0pID09PSBmYWxzZSkgcmV0dXJuIGVsZW1lbnRzCiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnRzCiAgfQoKICAkLmdyZXAgPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgcmV0dXJuIGZpbHRlci5jYWxsKGVsZW1lbnRzLCBjYWxsYmFjaykKICB9CgogIGlmICh3aW5kb3cuSlNPTikgJC5wYXJzZUpTT04gPSBKU09OLnBhcnNlCgogIC8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcAogICQuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oaSwgbmFtZSkgewogICAgY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKQogIH0pCgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBzb3J0OiBlbXB0eUFycmF5LnNvcnQsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQoJC5tYXAodGhpcywgZnVuY3Rpb24oZWwsIGkpeyByZXR1cm4gZm4uY2FsbChlbCwgaSwgZWwpIH0pKQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAvLyBuZWVkIHRvIGNoZWNrIGlmIGRvY3VtZW50LmJvZHkgZXhpc3RzIGZvciBJRSBhcyB0aGF0IGJyb3dzZXIgcmVwb3J0cwogICAgICAvLyBkb2N1bWVudCByZWFkeSB3aGVuIGl0IGhhc24ndCB5ZXQgY3JlYXRlZCB0aGUgYm9keSBlbGVtZW50CiAgICAgIGlmIChyZWFkeVJFLnRlc3QoZG9jdW1lbnQucmVhZHlTdGF0ZSkgJiYgZG9jdW1lbnQuYm9keSkgY2FsbGJhY2soJCkKICAgICAgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKXsgY2FsbGJhY2soJCkgfSwgZmFsc2UpCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSB1bmRlZmluZWQgPyBzbGljZS5jYWxsKHRoaXMpIDogdGhpc1tpZHggPj0gMCA/IGlkeCA6IGlkeCArIHRoaXMubGVuZ3RoXQogICAgfSwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmdldCgpIH0sCiAgICBzaXplOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGgKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlICE9IG51bGwpCiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykKICAgICAgfSkKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGVtcHR5QXJyYXkuZXZlcnkuY2FsbCh0aGlzLCBmdW5jdGlvbihlbCwgaWR4KXsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbCwgaWR4LCBlbCkgIT09IGZhbHNlCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHNlbGVjdG9yKSkgcmV0dXJuIHRoaXMubm90KHRoaXMubm90KHNlbGVjdG9yKSkKICAgICAgcmV0dXJuICQoZmlsdGVyLmNhbGwodGhpcywgZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgICAgcmV0dXJuIHplcHRvLm1hdGNoZXMoZWxlbWVudCwgc2VsZWN0b3IpCiAgICAgIH0pKQogICAgfSwKICAgIGFkZDogZnVuY3Rpb24oc2VsZWN0b3IsY29udGV4dCl7CiAgICAgIHJldHVybiAkKHVuaXEodGhpcy5jb25jYXQoJChzZWxlY3Rvcixjb250ZXh0KSkpKQogICAgfSwKICAgIGlzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA+IDAgJiYgemVwdG8ubWF0Y2hlcyh0aGlzWzBdLCBzZWxlY3RvcikKICAgIH0sCiAgICBub3Q6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIG5vZGVzPVtdCiAgICAgIGlmIChpc0Z1bmN0aW9uKHNlbGVjdG9yKSAmJiBzZWxlY3Rvci5jYWxsICE9PSB1bmRlZmluZWQpCiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgICBpZiAoIXNlbGVjdG9yLmNhbGwodGhpcyxpZHgpKSBub2Rlcy5wdXNoKHRoaXMpCiAgICAgICAgfSkKICAgICAgZWxzZSB7CiAgICAgICAgdmFyIGV4Y2x1ZGVzID0gdHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnID8gdGhpcy5maWx0ZXIoc2VsZWN0b3IpIDoKICAgICAgICAgIChsaWtlQXJyYXkoc2VsZWN0b3IpICYmIGlzRnVuY3Rpb24oc2VsZWN0b3IuaXRlbSkpID8gc2xpY2UuY2FsbChzZWxlY3RvcikgOiAkKHNlbGVjdG9yKQogICAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbihlbCl7CiAgICAgICAgICBpZiAoZXhjbHVkZXMuaW5kZXhPZihlbCkgPCAwKSBub2Rlcy5wdXNoKGVsKQogICAgICAgIH0pCiAgICAgIH0KICAgICAgcmV0dXJuICQobm9kZXMpCiAgICB9LAogICAgaGFzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbigpewogICAgICAgIHJldHVybiBpc09iamVjdChzZWxlY3RvcikgPwogICAgICAgICAgJC5jb250YWlucyh0aGlzLCBzZWxlY3RvcikgOgogICAgICAgICAgJCh0aGlzKS5maW5kKHNlbGVjdG9yKS5zaXplKCkKICAgICAgfSkKICAgIH0sCiAgICBlcTogZnVuY3Rpb24oaWR4KXsKICAgICAgcmV0dXJuIGlkeCA9PT0gLTEgPyB0aGlzLnNsaWNlKGlkeCkgOiB0aGlzLnNsaWNlKGlkeCwgKyBpZHggKyAxKQogICAgfSwKICAgIGZpcnN0OiBmdW5jdGlvbigpewogICAgICB2YXIgZWwgPSB0aGlzWzBdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGxhc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbdGhpcy5sZW5ndGggLSAxXQogICAgICByZXR1cm4gZWwgJiYgIWlzT2JqZWN0KGVsKSA/IGVsIDogJChlbCkKICAgIH0sCiAgICBmaW5kOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciByZXN1bHQsICR0aGlzID0gdGhpcwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09ICdvYmplY3QnKQogICAgICAgIHJlc3VsdCA9ICQoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbigpewogICAgICAgICAgdmFyIG5vZGUgPSB0aGlzCiAgICAgICAgICByZXR1cm4gZW1wdHlBcnJheS5zb21lLmNhbGwoJHRoaXMsIGZ1bmN0aW9uKHBhcmVudCl7CiAgICAgICAgICAgIHJldHVybiAkLmNvbnRhaW5zKHBhcmVudCwgbm9kZSkKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gJCh6ZXB0by5xc2EodGhpc1swXSwgc2VsZWN0b3IpKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiByZXN1bHQKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXSwgY29sbGVjdGlvbiA9IGZhbHNlCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ29iamVjdCcpIGNvbGxlY3Rpb24gPSAkKHNlbGVjdG9yKQogICAgICB3aGlsZSAobm9kZSAmJiAhKGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmluZGV4T2Yobm9kZSkgPj0gMCA6IHplcHRvLm1hdGNoZXMobm9kZSwgc2VsZWN0b3IpKSkKICAgICAgICBub2RlID0gbm9kZSAhPT0gY29udGV4dCAmJiAhaXNEb2N1bWVudChub2RlKSAmJiBub2RlLnBhcmVudE5vZGUKICAgICAgcmV0dXJuICQobm9kZSkKICAgIH0sCiAgICBwYXJlbnRzOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBhbmNlc3RvcnMgPSBbXSwgbm9kZXMgPSB0aGlzCiAgICAgIHdoaWxlIChub2Rlcy5sZW5ndGggPiAwKQogICAgICAgIG5vZGVzID0gJC5tYXAobm9kZXMsIGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgaWYgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSAmJiAhaXNEb2N1bWVudChub2RlKSAmJiBhbmNlc3RvcnMuaW5kZXhPZihub2RlKSA8IDApIHsKICAgICAgICAgICAgYW5jZXN0b3JzLnB1c2gobm9kZSkKICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICByZXR1cm4gZmlsdGVyZWQoYW5jZXN0b3JzLCBzZWxlY3RvcikKICAgIH0sCiAgICBwYXJlbnQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHVuaXEodGhpcy5wbHVjaygncGFyZW50Tm9kZScpKSwgc2VsZWN0b3IpCiAgICB9LAogICAgY2hpbGRyZW46IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiBjaGlsZHJlbih0aGlzKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgY29udGVudHM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7IHJldHVybiBzbGljZS5jYWxsKHRoaXMuY2hpbGROb2RlcykgfSkKICAgIH0sCiAgICBzaWJsaW5nczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gZmlsdGVyZWQodGhpcy5tYXAoZnVuY3Rpb24oaSwgZWwpewogICAgICAgIHJldHVybiBmaWx0ZXIuY2FsbChjaGlsZHJlbihlbC5wYXJlbnROb2RlKSwgZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiAkLm1hcCh0aGlzLCBmdW5jdGlvbihlbCl7IHJldHVybiBlbFtwcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gJycpCiAgICAgICAgaWYgKGdldENvbXB1dGVkU3R5bGUodGhpcywgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKSA9PSAibm9uZSIpCiAgICAgICAgICB0aGlzLnN0eWxlLmRpc3BsYXkgPSBkZWZhdWx0RGlzcGxheSh0aGlzLm5vZGVOYW1lKQogICAgICB9KQogICAgfSwKICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuYmVmb3JlKG5ld0NvbnRlbnQpLnJlbW92ZSgpCiAgICB9LAogICAgd3JhcDogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgdmFyIGZ1bmMgPSBpc0Z1bmN0aW9uKHN0cnVjdHVyZSkKICAgICAgaWYgKHRoaXNbMF0gJiYgIWZ1bmMpCiAgICAgICAgdmFyIGRvbSAgID0gJChzdHJ1Y3R1cmUpLmdldCgwKSwKICAgICAgICAgICAgY2xvbmUgPSBkb20ucGFyZW50Tm9kZSB8fCB0aGlzLmxlbmd0aCA+IDEKCiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaW5kZXgpewogICAgICAgICQodGhpcykud3JhcEFsbCgKICAgICAgICAgIGZ1bmMgPyBzdHJ1Y3R1cmUuY2FsbCh0aGlzLCBpbmRleCkgOgogICAgICAgICAgICBjbG9uZSA/IGRvbS5jbG9uZU5vZGUodHJ1ZSkgOiBkb20KICAgICAgICApCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAkKHRoaXNbMF0pLmJlZm9yZShzdHJ1Y3R1cmUgPSAkKHN0cnVjdHVyZSkpCiAgICAgICAgdmFyIGNoaWxkcmVuCiAgICAgICAgLy8gZHJpbGwgZG93biB0byB0aGUgaW5tb3N0IGVsZW1lbnQKICAgICAgICB3aGlsZSAoKGNoaWxkcmVuID0gc3RydWN0dXJlLmNoaWxkcmVuKCkpLmxlbmd0aCkgc3RydWN0dXJlID0gY2hpbGRyZW4uZmlyc3QoKQogICAgICAgICQoc3RydWN0dXJlKS5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHdyYXBJbm5lcjogZnVuY3Rpb24oc3RydWN0dXJlKXsKICAgICAgdmFyIGZ1bmMgPSBpc0Z1bmN0aW9uKHN0cnVjdHVyZSkKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpbmRleCl7CiAgICAgICAgdmFyIHNlbGYgPSAkKHRoaXMpLCBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKSwKICAgICAgICAgICAgZG9tICA9IGZ1bmMgPyBzdHJ1Y3R1cmUuY2FsbCh0aGlzLCBpbmRleCkgOiBzdHJ1Y3R1cmUKICAgICAgICBjb250ZW50cy5sZW5ndGggPyBjb250ZW50cy53cmFwQWxsKGRvbSkgOiBzZWxmLmFwcGVuZChkb20pCiAgICAgIH0pCiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbigpewogICAgICB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICAkKHRoaXMpLnJlcGxhY2VXaXRoKCQodGhpcykuY2hpbGRyZW4oKSkKICAgICAgfSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBjbG9uZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KQogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmNzcygiZGlzcGxheSIsICJub25lIikKICAgIH0sCiAgICB0b2dnbGU6IGZ1bmN0aW9uKHNldHRpbmcpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGVsID0gJCh0aGlzKQogICAgICAgIDsoc2V0dGluZyA9PT0gdW5kZWZpbmVkID8gZWwuY3NzKCJkaXNwbGF5IikgPT0gIm5vbmUiIDogc2V0dGluZykgPyBlbC5zaG93KCkgOiBlbC5oaWRlKCkKICAgICAgfSkKICAgIH0sCiAgICBwcmV2OiBmdW5jdGlvbihzZWxlY3Rvcil7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkuZmlsdGVyKHNlbGVjdG9yIHx8ICcqJykgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsgcmV0dXJuICQodGhpcy5wbHVjaygnbmV4dEVsZW1lbnRTaWJsaW5nJykpLmZpbHRlcihzZWxlY3RvciB8fCAnKicpIH0sCiAgICBodG1sOiBmdW5jdGlvbihodG1sKXsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLnRleHRDb250ZW50IDogbnVsbCkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbigpeyB0aGlzLnRleHRDb250ZW50ID0gKHRleHQgPT09IHVuZGVmaW5lZCkgPyAnJyA6ICcnK3RleHQgfSkKICAgIH0sCiAgICBhdHRyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciByZXN1bHQKICAgICAgcmV0dXJuICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID09IDAgfHwgdGhpc1swXS5ub2RlVHlwZSAhPT0gMSA/IHVuZGVmaW5lZCA6CiAgICAgICAgICAobmFtZSA9PSAndmFsdWUnICYmIHRoaXNbMF0ubm9kZU5hbWUgPT0gJ0lOUFVUJykgPyB0aGlzLnZhbCgpIDoKICAgICAgICAgICghKHJlc3VsdCA9IHRoaXNbMF0uZ2V0QXR0cmlidXRlKG5hbWUpKSAmJiBuYW1lIGluIHRoaXNbMF0pID8gdGhpc1swXVtuYW1lXSA6IHJlc3VsdAogICAgICAgICkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgIT09IDEpIHJldHVybgogICAgICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSBmb3IgKGtleSBpbiBuYW1lKSBzZXRBdHRyaWJ1dGUodGhpcywga2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHNldEF0dHJpYnV0ZSh0aGlzLCBuYW1lLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpKSkKICAgICAgICB9KQogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMubm9kZVR5cGUgPT09IDEgJiYgc2V0QXR0cmlidXRlKHRoaXMsIG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICBuYW1lID0gcHJvcE1hcFtuYW1lXSB8fCBuYW1lCiAgICAgIHJldHVybiAodmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzWzBdICYmIHRoaXNbMF1bbmFtZV0pIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBuYW1lLnJlcGxhY2UoY2FwaXRhbFJFLCAnLSQxJykudG9Mb3dlckNhc2UoKSwgdmFsdWUpCiAgICAgIHJldHVybiBkYXRhICE9PSBudWxsID8gZGVzZXJpYWxpemVWYWx1ZShkYXRhKSA6IHVuZGVmaW5lZAogICAgfSwKICAgIHZhbDogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCA/CiAgICAgICAgKHRoaXNbMF0gJiYgKHRoaXNbMF0ubXVsdGlwbGUgPwogICAgICAgICAgICQodGhpc1swXSkuZmluZCgnb3B0aW9uJykuZmlsdGVyKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLnNlbGVjdGVkIH0pLnBsdWNrKCd2YWx1ZScpIDoKICAgICAgICAgICB0aGlzWzBdLnZhbHVlKQogICAgICAgICkgOgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgdGhpcy52YWx1ZSA9IGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy52YWx1ZSkKICAgICAgICB9KQogICAgfSwKICAgIG9mZnNldDogZnVuY3Rpb24oY29vcmRpbmF0ZXMpewogICAgICBpZiAoY29vcmRpbmF0ZXMpIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaW5kZXgpewogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgICAgICAgIGNvb3JkcyA9IGZ1bmNBcmcodGhpcywgY29vcmRpbmF0ZXMsIGluZGV4LCAkdGhpcy5vZmZzZXQoKSksCiAgICAgICAgICAgIHBhcmVudE9mZnNldCA9ICR0aGlzLm9mZnNldFBhcmVudCgpLm9mZnNldCgpLAogICAgICAgICAgICBwcm9wcyA9IHsKICAgICAgICAgICAgICB0b3A6ICBjb29yZHMudG9wICAtIHBhcmVudE9mZnNldC50b3AsCiAgICAgICAgICAgICAgbGVmdDogY29vcmRzLmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdAogICAgICAgICAgICB9CgogICAgICAgIGlmICgkdGhpcy5jc3MoJ3Bvc2l0aW9uJykgPT0gJ3N0YXRpYycpIHByb3BzWydwb3NpdGlvbiddID0gJ3JlbGF0aXZlJwogICAgICAgICR0aGlzLmNzcyhwcm9wcykKICAgICAgfSkKICAgICAgaWYgKHRoaXMubGVuZ3RoPT0wKSByZXR1cm4gbnVsbAogICAgICB2YXIgb2JqID0gdGhpc1swXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKQogICAgICByZXR1cm4gewogICAgICAgIGxlZnQ6IG9iai5sZWZ0ICsgd2luZG93LnBhZ2VYT2Zmc2V0LAogICAgICAgIHRvcDogb2JqLnRvcCArIHdpbmRvdy5wYWdlWU9mZnNldCwKICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChvYmoud2lkdGgpLAogICAgICAgIGhlaWdodDogTWF0aC5yb3VuZChvYmouaGVpZ2h0KQogICAgICB9CiAgICB9LAogICAgY3NzOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXNbMF0sIGNvbXB1dGVkU3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsICcnKQogICAgICAgIGlmKCFlbGVtZW50KSByZXR1cm4KICAgICAgICBpZiAodHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQuc3R5bGVbY2FtZWxpemUocHJvcGVydHkpXSB8fCBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpCiAgICAgICAgZWxzZSBpZiAoaXNBcnJheShwcm9wZXJ0eSkpIHsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9CiAgICAgICAgICAkLmVhY2goaXNBcnJheShwcm9wZXJ0eSkgPyBwcm9wZXJ0eTogW3Byb3BlcnR5XSwgZnVuY3Rpb24oXywgcHJvcCl7CiAgICAgICAgICAgIHByb3BzW3Byb3BdID0gKGVsZW1lbnQuc3R5bGVbY2FtZWxpemUocHJvcCldIHx8IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShwcm9wKSkKICAgICAgICAgIH0pCiAgICAgICAgICByZXR1cm4gcHJvcHMKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBjc3MgPSAnJwogICAgICBpZiAodHlwZShwcm9wZXJ0eSkgPT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoIXZhbHVlICYmIHZhbHVlICE9PSAwKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChrZXkgaW4gcHJvcGVydHkpCiAgICAgICAgICBpZiAoIXByb3BlcnR5W2tleV0gJiYgcHJvcGVydHlba2V5XSAhPT0gMCkKICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKGtleSkpIH0pCiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGNzcyArPSBkYXNoZXJpemUoa2V5KSArICc6JyArIG1heWJlQWRkUHgoa2V5LCBwcm9wZXJ0eVtrZXldKSArICc7JwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIGZhbHNlCiAgICAgIHJldHVybiBlbXB0eUFycmF5LnNvbWUuY2FsbCh0aGlzLCBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuIHRoaXMudGVzdChjbGFzc05hbWUoZWwpKQogICAgICB9LCBjbGFzc1JFKG5hbWUpKQogICAgfSwKICAgIGFkZENsYXNzOiBmdW5jdGlvbihuYW1lKXsKICAgICAgaWYgKCFuYW1lKSByZXR1cm4gdGhpcwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gY2xhc3NOYW1lKHRoaXMpLCBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNscykKICAgICAgICBuZXdOYW1lLnNwbGl0KC9ccysvZykuZm9yRWFjaChmdW5jdGlvbihrbGFzcyl7CiAgICAgICAgICBpZiAoISQodGhpcykuaGFzQ2xhc3Moa2xhc3MpKSBjbGFzc0xpc3QucHVzaChrbGFzcykKICAgICAgICB9LCB0aGlzKQogICAgICAgIGNsYXNzTGlzdC5sZW5ndGggJiYgY2xhc3NOYW1lKHRoaXMsIGNscyArIChjbHMgPyAiICIgOiAiIikgKyBjbGFzc0xpc3Quam9pbigiICIpKQogICAgICB9KQogICAgfSwKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihuYW1lKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIGlmIChuYW1lID09PSB1bmRlZmluZWQpIHJldHVybiBjbGFzc05hbWUodGhpcywgJycpCiAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NOYW1lKHRoaXMpCiAgICAgICAgZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNsYXNzTGlzdCkuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTGlzdC5yZXBsYWNlKGNsYXNzUkUoa2xhc3MpLCAiICIpCiAgICAgICAgfSkKICAgICAgICBjbGFzc05hbWUodGhpcywgY2xhc3NMaXN0LnRyaW0oKSkKICAgICAgfSkKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24obmFtZSwgd2hlbil7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIHRoaXMKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksIG5hbWVzID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIGNsYXNzTmFtZSh0aGlzKSkKICAgICAgICBuYW1lcy5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgKHdoZW4gPT09IHVuZGVmaW5lZCA/ICEkdGhpcy5oYXNDbGFzcyhrbGFzcykgOiB3aGVuKSA/CiAgICAgICAgICAgICR0aGlzLmFkZENsYXNzKGtsYXNzKSA6ICR0aGlzLnJlbW92ZUNsYXNzKGtsYXNzKQogICAgICAgIH0pCiAgICAgIH0pCiAgICB9LAogICAgc2Nyb2xsVG9wOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybgogICAgICB2YXIgaGFzU2Nyb2xsVG9wID0gJ3Njcm9sbFRvcCcgaW4gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGhhc1Njcm9sbFRvcCA/IHRoaXNbMF0uc2Nyb2xsVG9wIDogdGhpc1swXS5wYWdlWU9mZnNldAogICAgICByZXR1cm4gdGhpcy5lYWNoKGhhc1Njcm9sbFRvcCA/CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxUb3AgPSB2YWx1ZSB9IDoKICAgICAgICBmdW5jdGlvbigpeyB0aGlzLnNjcm9sbFRvKHRoaXMuc2Nyb2xsWCwgdmFsdWUpIH0pCiAgICB9LAogICAgc2Nyb2xsTGVmdDogZnVuY3Rpb24odmFsdWUpewogICAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm4KICAgICAgdmFyIGhhc1Njcm9sbExlZnQgPSAnc2Nyb2xsTGVmdCcgaW4gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGhhc1Njcm9sbExlZnQgPyB0aGlzWzBdLnNjcm9sbExlZnQgOiB0aGlzWzBdLnBhZ2VYT2Zmc2V0CiAgICAgIHJldHVybiB0aGlzLmVhY2goaGFzU2Nyb2xsTGVmdCA/CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxMZWZ0ID0gdmFsdWUgfSA6CiAgICAgICAgZnVuY3Rpb24oKXsgdGhpcy5zY3JvbGxUbyh2YWx1ZSwgdGhpcy5zY3JvbGxZKSB9KQogICAgfSwKICAgIHBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmxlbmd0aCkgcmV0dXJuCgogICAgICB2YXIgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAogICAgICAgIC8vIEdldCBjb3JyZWN0IG9mZnNldHMKICAgICAgICBvZmZzZXQgICAgICAgPSB0aGlzLm9mZnNldCgpLAogICAgICAgIHBhcmVudE9mZnNldCA9IHJvb3ROb2RlUkUudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKQoKICAgICAgLy8gU3VidHJhY3QgZWxlbWVudCBtYXJnaW5zCiAgICAgIC8vIG5vdGU6IHdoZW4gYW4gZWxlbWVudCBoYXMgbWFyZ2luOiBhdXRvIHRoZSBvZmZzZXRMZWZ0IGFuZCBtYXJnaW5MZWZ0CiAgICAgIC8vIGFyZSB0aGUgc2FtZSBpbiBTYWZhcmkgY2F1c2luZyBvZmZzZXQubGVmdCB0byBpbmNvcnJlY3RseSBiZSAwCiAgICAgIG9mZnNldC50b3AgIC09IHBhcnNlRmxvYXQoICQoZWxlbSkuY3NzKCdtYXJnaW4tdG9wJykgKSB8fCAwCiAgICAgIG9mZnNldC5sZWZ0IC09IHBhcnNlRmxvYXQoICQoZWxlbSkuY3NzKCdtYXJnaW4tbGVmdCcpICkgfHwgMAoKICAgICAgLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCiAgICAgIHBhcmVudE9mZnNldC50b3AgICs9IHBhcnNlRmxvYXQoICQob2Zmc2V0UGFyZW50WzBdKS5jc3MoJ2JvcmRlci10b3Atd2lkdGgnKSApIHx8IDAKICAgICAgcGFyZW50T2Zmc2V0LmxlZnQgKz0gcGFyc2VGbG9hdCggJChvZmZzZXRQYXJlbnRbMF0pLmNzcygnYm9yZGVyLWxlZnQtd2lkdGgnKSApIHx8IDAKCiAgICAgIC8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwogICAgICByZXR1cm4gewogICAgICAgIHRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCwKICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0CiAgICAgIH0KICAgIH0sCiAgICBvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keQogICAgICAgIHdoaWxlIChwYXJlbnQgJiYgIXJvb3ROb2RlUkUudGVzdChwYXJlbnQubm9kZU5hbWUpICYmICQocGFyZW50KS5jc3MoInBvc2l0aW9uIikgPT0gInN0YXRpYyIpCiAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50CiAgICAgICAgcmV0dXJuIHBhcmVudAogICAgICB9KQogICAgfQogIH0KCiAgLy8gZm9yIG5vdwogICQuZm4uZGV0YWNoID0gJC5mbi5yZW1vdmUKCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgIHZhciBkaW1lbnNpb25Qcm9wZXJ0eSA9CiAgICAgIGRpbWVuc2lvbi5yZXBsYWNlKC8uLywgZnVuY3Rpb24obSl7IHJldHVybiBtWzBdLnRvVXBwZXJDYXNlKCkgfSkKCiAgICAkLmZuW2RpbWVuc2lvbl0gPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHZhciBvZmZzZXQsIGVsID0gdGhpc1swXQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGlzV2luZG93KGVsKSA/IGVsWydpbm5lcicgKyBkaW1lbnNpb25Qcm9wZXJ0eV0gOgogICAgICAgIGlzRG9jdW1lbnQoZWwpID8gZWwuZG9jdW1lbnRFbGVtZW50WydzY3JvbGwnICsgZGltZW5zaW9uUHJvcGVydHldIDoKICAgICAgICAob2Zmc2V0ID0gdGhpcy5vZmZzZXQoKSkgJiYgb2Zmc2V0W2RpbWVuc2lvbl0KICAgICAgZWxzZSByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgZWwgPSAkKHRoaXMpCiAgICAgICAgZWwuY3NzKGRpbWVuc2lvbiwgZnVuY0FyZyh0aGlzLCB2YWx1ZSwgaWR4LCBlbFtkaW1lbnNpb25dKCkpKQogICAgICB9KQogICAgfQogIH0pCgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKG9wZXJhdG9yLCBvcGVyYXRvckluZGV4KSB7CiAgICB2YXIgaW5zaWRlID0gb3BlcmF0b3JJbmRleCAlIDIgLy89PiBwcmVwZW5kLCBhcHBlbmQKCiAgICAkLmZuW29wZXJhdG9yXSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBhcmdUeXBlLCBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgIGFyZ1R5cGUgPSB0eXBlKGFyZykKICAgICAgICAgICAgcmV0dXJuIGFyZ1R5cGUgPT0gIm9iamVjdCIgfHwgYXJnVHlwZSA9PSAiYXJyYXkiIHx8IGFyZyA9PSBudWxsID8KICAgICAgICAgICAgICBhcmcgOiB6ZXB0by5mcmFnbWVudChhcmcpCiAgICAgICAgICB9KSwKICAgICAgICAgIHBhcmVudCwgY29weUJ5Q2xvbmUgPSB0aGlzLmxlbmd0aCA+IDEKICAgICAgaWYgKG5vZGVzLmxlbmd0aCA8IDEpIHJldHVybiB0aGlzCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKF8sIHRhcmdldCl7CiAgICAgICAgcGFyZW50ID0gaW5zaWRlID8gdGFyZ2V0IDogdGFyZ2V0LnBhcmVudE5vZGUKCiAgICAgICAgLy8gY29udmVydCBhbGwgbWV0aG9kcyB0byBhICJiZWZvcmUiIG9wZXJhdGlvbgogICAgICAgIHRhcmdldCA9IG9wZXJhdG9ySW5kZXggPT0gMCA/IHRhcmdldC5uZXh0U2libGluZyA6CiAgICAgICAgICAgICAgICAgb3BlcmF0b3JJbmRleCA9PSAxID8gdGFyZ2V0LmZpcnN0Q2hpbGQgOgogICAgICAgICAgICAgICAgIG9wZXJhdG9ySW5kZXggPT0gMiA/IHRhcmdldCA6CiAgICAgICAgICAgICAgICAgbnVsbAoKICAgICAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgaWYgKGNvcHlCeUNsb25lKSBub2RlID0gbm9kZS5jbG9uZU5vZGUodHJ1ZSkKICAgICAgICAgIGVsc2UgaWYgKCFwYXJlbnQpIHJldHVybiAkKG5vZGUpLnJlbW92ZSgpCgogICAgICAgICAgdHJhdmVyc2VOb2RlKHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgdGFyZ2V0KSwgZnVuY3Rpb24oZWwpewogICAgICAgICAgICBpZiAoZWwubm9kZU5hbWUgIT0gbnVsbCAmJiBlbC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJgogICAgICAgICAgICAgICAoIWVsLnR5cGUgfHwgZWwudHlwZSA9PT0gJ3RleHQvamF2YXNjcmlwdCcpICYmICFlbC5zcmMpCiAgICAgICAgICAgICAgd2luZG93WydldmFsJ10uY2FsbCh3aW5kb3csIGVsLmlubmVySFRNTCkKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgfSkKICAgIH0KCiAgICAvLyBhZnRlciAgICA9PiBpbnNlcnRBZnRlcgogICAgLy8gcHJlcGVuZCAgPT4gcHJlcGVuZFRvCiAgICAvLyBiZWZvcmUgICA9PiBpbnNlcnRCZWZvcmUKICAgIC8vIGFwcGVuZCAgID0+IGFwcGVuZFRvCiAgICAkLmZuW2luc2lkZSA/IG9wZXJhdG9yKydUbycgOiAnaW5zZXJ0Jysob3BlcmF0b3JJbmRleCA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClbb3BlcmF0b3JdKHRoaXMpCiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgemVwdG8uWi5wcm90b3R5cGUgPSAkLmZuCgogIC8vIEV4cG9ydCBpbnRlcm5hbCBBUEkgZnVuY3Rpb25zIGluIHRoZSBgJC56ZXB0b2AgbmFtZXNwYWNlCiAgemVwdG8udW5pcSA9IHVuaXEKICB6ZXB0by5kZXNlcmlhbGl6ZVZhbHVlID0gZGVzZXJpYWxpemVWYWx1ZQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgp3aW5kb3cuWmVwdG8gPSBaZXB0bwp3aW5kb3cuJCA9PT0gdW5kZWZpbmVkICYmICh3aW5kb3cuJCA9IFplcHRvKQoKOyhmdW5jdGlvbigkKXsKICB2YXIgJCQgPSAkLnplcHRvLnFzYSwgX3ppZCA9IDEsIHVuZGVmaW5lZCwKICAgICAgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgIGlzRnVuY3Rpb24gPSAkLmlzRnVuY3Rpb24sCiAgICAgIGlzU3RyaW5nID0gZnVuY3Rpb24ob2JqKXsgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ3N0cmluZycgfSwKICAgICAgaGFuZGxlcnMgPSB7fSwKICAgICAgc3BlY2lhbEV2ZW50cz17fSwKICAgICAgZm9jdXNpblN1cHBvcnRlZCA9ICdvbmZvY3VzaW4nIGluIHdpbmRvdywKICAgICAgZm9jdXMgPSB7IGZvY3VzOiAnZm9jdXNpbicsIGJsdXI6ICdmb2N1c291dCcgfSwKICAgICAgaG92ZXIgPSB7IG1vdXNlZW50ZXI6ICdtb3VzZW92ZXInLCBtb3VzZWxlYXZlOiAnbW91c2VvdXQnIH0KCiAgc3BlY2lhbEV2ZW50cy5jbGljayA9IHNwZWNpYWxFdmVudHMubW91c2Vkb3duID0gc3BlY2lhbEV2ZW50cy5tb3VzZXVwID0gc3BlY2lhbEV2ZW50cy5tb3VzZW1vdmUgPSAnTW91c2VFdmVudHMnCgogIGZ1bmN0aW9uIHppZChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5femlkIHx8IChlbGVtZW50Ll96aWQgPSBfemlkKyspCiAgfQogIGZ1bmN0aW9uIGZpbmRIYW5kbGVycyhlbGVtZW50LCBldmVudCwgZm4sIHNlbGVjdG9yKSB7CiAgICBldmVudCA9IHBhcnNlKGV2ZW50KQogICAgaWYgKGV2ZW50Lm5zKSB2YXIgbWF0Y2hlciA9IG1hdGNoZXJGb3IoZXZlbnQubnMpCiAgICByZXR1cm4gKGhhbmRsZXJzW3ppZChlbGVtZW50KV0gfHwgW10pLmZpbHRlcihmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgIHJldHVybiBoYW5kbGVyCiAgICAgICAgJiYgKCFldmVudC5lICB8fCBoYW5kbGVyLmUgPT0gZXZlbnQuZSkKICAgICAgICAmJiAoIWV2ZW50Lm5zIHx8IG1hdGNoZXIudGVzdChoYW5kbGVyLm5zKSkKICAgICAgICAmJiAoIWZuICAgICAgIHx8IHppZChoYW5kbGVyLmZuKSA9PT0gemlkKGZuKSkKICAgICAgICAmJiAoIXNlbGVjdG9yIHx8IGhhbmRsZXIuc2VsID09IHNlbGVjdG9yKQogICAgfSkKICB9CiAgZnVuY3Rpb24gcGFyc2UoZXZlbnQpIHsKICAgIHZhciBwYXJ0cyA9ICgnJyArIGV2ZW50KS5zcGxpdCgnLicpCiAgICByZXR1cm4ge2U6IHBhcnRzWzBdLCBuczogcGFydHMuc2xpY2UoMSkuc29ydCgpLmpvaW4oJyAnKX0KICB9CiAgZnVuY3Rpb24gbWF0Y2hlckZvcihucykgewogICAgcmV0dXJuIG5ldyBSZWdFeHAoJyg/Ol58ICknICsgbnMucmVwbGFjZSgnICcsICcgLiogPycpICsgJyg/OiB8JCknKQogIH0KCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKCFmb2N1c2luU3VwcG9ydGVkICYmIChoYW5kbGVyLmUgaW4gZm9jdXMpKSB8fAogICAgICAhIWNhcHR1cmVTZXR0aW5nCiAgfQoKICBmdW5jdGlvbiByZWFsRXZlbnQodHlwZSkgewogICAgcmV0dXJuIGhvdmVyW3R5cGVdIHx8IChmb2N1c2luU3VwcG9ydGVkICYmIGZvY3VzW3R5cGVdKSB8fCB0eXBlCiAgfQoKICBmdW5jdGlvbiBhZGQoZWxlbWVudCwgZXZlbnRzLCBmbiwgZGF0YSwgc2VsZWN0b3IsIGRlbGVnYXRvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCksIHNldCA9IChoYW5kbGVyc1tpZF0gfHwgKGhhbmRsZXJzW2lkXSA9IFtdKSkKICAgIGV2ZW50cy5zcGxpdCgvXHMvKS5mb3JFYWNoKGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50ID09ICdyZWFkeScpIHJldHVybiAkKGRvY3VtZW50KS5yZWFkeShmbikKICAgICAgdmFyIGhhbmRsZXIgICA9IHBhcnNlKGV2ZW50KQogICAgICBoYW5kbGVyLmZuICAgID0gZm4KICAgICAgaGFuZGxlci5zZWwgICA9IHNlbGVjdG9yCiAgICAgIC8vIGVtdWxhdGUgbW91c2VlbnRlciwgbW91c2VsZWF2ZQogICAgICBpZiAoaGFuZGxlci5lIGluIGhvdmVyKSBmbiA9IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciByZWxhdGVkID0gZS5yZWxhdGVkVGFyZ2V0CiAgICAgICAgaWYgKCFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0aGlzICYmICEkLmNvbnRhaW5zKHRoaXMsIHJlbGF0ZWQpKSkKICAgICAgICAgIHJldHVybiBoYW5kbGVyLmZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICAgICAgfQogICAgICBoYW5kbGVyLmRlbCAgID0gZGVsZWdhdG9yCiAgICAgIHZhciBjYWxsYmFjayAgPSBkZWxlZ2F0b3IgfHwgZm4KICAgICAgaGFuZGxlci5wcm94eSA9IGZ1bmN0aW9uKGUpewogICAgICAgIGUgPSBjb21wYXRpYmxlKGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuCiAgICAgICAgZS5kYXRhID0gZGF0YQogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjay5hcHBseShlbGVtZW50LCBlLl9hcmdzID09IHVuZGVmaW5lZCA/IFtlXSA6IFtlXS5jb25jYXQoZS5fYXJncykpCiAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIGUucHJldmVudERlZmF1bHQoKSwgZS5zdG9wUHJvcGFnYXRpb24oKQogICAgICAgIHJldHVybiByZXN1bHQKICAgICAgfQogICAgICBoYW5kbGVyLmkgPSBzZXQubGVuZ3RoCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGlmICgnYWRkRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCkKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIocmVhbEV2ZW50KGhhbmRsZXIuZSksIGhhbmRsZXIucHJveHksIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIDsoZXZlbnRzIHx8ICcnKS5zcGxpdCgvXHMvKS5mb3JFYWNoKGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LCBmbiwgc2VsZWN0b3IpLmZvckVhY2goZnVuY3Rpb24oaGFuZGxlcil7CiAgICAgICAgZGVsZXRlIGhhbmRsZXJzW2lkXVtoYW5kbGVyLmldCiAgICAgIGlmICgncmVtb3ZlRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCkKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIocmVhbEV2ZW50KGhhbmRsZXIuZSksIGhhbmRsZXIucHJveHksIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgICAgfSkKICAgIH0pCiAgfQoKICAkLmV2ZW50ID0geyBhZGQ6IGFkZCwgcmVtb3ZlOiByZW1vdmUgfQoKICAkLnByb3h5ID0gZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgIGlmIChpc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmIChpc1N0cmluZyhjb250ZXh0KSkgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgZGF0YSwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMub24oZXZlbnQsIGRhdGEsIGNhbGxiYWNrKQogIH0KICAkLmZuLnVuYmluZCA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5vZmYoZXZlbnQsIGNhbGxiYWNrKQogIH0KICAkLmZuLm9uZSA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgZGF0YSwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMub24oZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaywgMSkKICB9CgogIHZhciByZXR1cm5UcnVlID0gZnVuY3Rpb24oKXtyZXR1cm4gdHJ1ZX0sCiAgICAgIHJldHVybkZhbHNlID0gZnVuY3Rpb24oKXtyZXR1cm4gZmFsc2V9LAogICAgICBpZ25vcmVQcm9wZXJ0aWVzID0gL14oW0EtWl18cmV0dXJuVmFsdWUkfGxheWVyW1hZXSQpLywKICAgICAgZXZlbnRNZXRob2RzID0gewogICAgICAgIHByZXZlbnREZWZhdWx0OiAnaXNEZWZhdWx0UHJldmVudGVkJywKICAgICAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246ICdpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCcsCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiAnaXNQcm9wYWdhdGlvblN0b3BwZWQnCiAgICAgIH0KCiAgZnVuY3Rpb24gY29tcGF0aWJsZShldmVudCwgc291cmNlKSB7CiAgICBpZiAoc291cmNlIHx8ICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgc291cmNlIHx8IChzb3VyY2UgPSBldmVudCkKCiAgICAgICQuZWFjaChldmVudE1ldGhvZHMsIGZ1bmN0aW9uKG5hbWUsIHByZWRpY2F0ZSkgewogICAgICAgIHZhciBzb3VyY2VNZXRob2QgPSBzb3VyY2VbbmFtZV0KICAgICAgICBldmVudFtuYW1lXSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgICByZXR1cm4gc291cmNlTWV0aG9kICYmIHNvdXJjZU1ldGhvZC5hcHBseShzb3VyY2UsIGFyZ3VtZW50cykKICAgICAgICB9CiAgICAgICAgZXZlbnRbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICAgIH0pCgogICAgICBpZiAoc291cmNlLmRlZmF1bHRQcmV2ZW50ZWQgIT09IHVuZGVmaW5lZCA/IHNvdXJjZS5kZWZhdWx0UHJldmVudGVkIDoKICAgICAgICAgICdyZXR1cm5WYWx1ZScgaW4gc291cmNlID8gc291cmNlLnJldHVyblZhbHVlID09PSBmYWxzZSA6CiAgICAgICAgICBzb3VyY2UuZ2V0UHJldmVudERlZmF1bHQgJiYgc291cmNlLmdldFByZXZlbnREZWZhdWx0KCkpCiAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZQogICAgfQogICAgcmV0dXJuIGV2ZW50CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVQcm94eShldmVudCkgewogICAgdmFyIGtleSwgcHJveHkgPSB7IG9yaWdpbmFsRXZlbnQ6IGV2ZW50IH0KICAgIGZvciAoa2V5IGluIGV2ZW50KQogICAgICBpZiAoIWlnbm9yZVByb3BlcnRpZXMudGVzdChrZXkpICYmIGV2ZW50W2tleV0gIT09IHVuZGVmaW5lZCkgcHJveHlba2V5XSA9IGV2ZW50W2tleV0KCiAgICByZXR1cm4gY29tcGF0aWJsZShwcm94eSwgZXZlbnQpCiAgfQoKICAkLmZuLmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5vbihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKQogIH0KICAkLmZuLnVuZGVsZWdhdGUgPSBmdW5jdGlvbihzZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKXsKICAgIHJldHVybiB0aGlzLm9mZihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5saXZlID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkuZGVsZWdhdGUodGhpcy5zZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKQogICAgcmV0dXJuIHRoaXMKICB9CiAgJC5mbi5kaWUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgJChkb2N1bWVudC5ib2R5KS51bmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQoKICAkLmZuLm9uID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaywgb25lKXsKICAgIHZhciBhdXRvUmVtb3ZlLCBkZWxlZ2F0b3IsICR0aGlzID0gdGhpcwogICAgaWYgKGV2ZW50ICYmICFpc1N0cmluZyhldmVudCkpIHsKICAgICAgJC5lYWNoKGV2ZW50LCBmdW5jdGlvbih0eXBlLCBmbil7CiAgICAgICAgJHRoaXMub24odHlwZSwgc2VsZWN0b3IsIGRhdGEsIGZuLCBvbmUpCiAgICAgIH0pCiAgICAgIHJldHVybiAkdGhpcwogICAgfQoKICAgIGlmICghaXNTdHJpbmcoc2VsZWN0b3IpICYmICFpc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJiBjYWxsYmFjayAhPT0gZmFsc2UpCiAgICAgIGNhbGxiYWNrID0gZGF0YSwgZGF0YSA9IHNlbGVjdG9yLCBzZWxlY3RvciA9IHVuZGVmaW5lZAogICAgaWYgKGlzRnVuY3Rpb24oZGF0YSkgfHwgZGF0YSA9PT0gZmFsc2UpCiAgICAgIGNhbGxiYWNrID0gZGF0YSwgZGF0YSA9IHVuZGVmaW5lZAoKICAgIGlmIChjYWxsYmFjayA9PT0gZmFsc2UpIGNhbGxiYWNrID0gcmV0dXJuRmFsc2UKCiAgICByZXR1cm4gJHRoaXMuZWFjaChmdW5jdGlvbihfLCBlbGVtZW50KXsKICAgICAgaWYgKG9uZSkgYXV0b1JlbW92ZSA9IGZ1bmN0aW9uKGUpewogICAgICAgIHJlbW92ZShlbGVtZW50LCBlLnR5cGUsIGNhbGxiYWNrKQogICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICAgIH0KCiAgICAgIGlmIChzZWxlY3RvcikgZGVsZWdhdG9yID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGV2dCwgbWF0Y2ggPSAkKGUudGFyZ2V0KS5jbG9zZXN0KHNlbGVjdG9yLCBlbGVtZW50KS5nZXQoMCkKICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2ggIT09IGVsZW1lbnQpIHsKICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICByZXR1cm4gKGF1dG9SZW1vdmUgfHwgY2FsbGJhY2spLmFwcGx5KG1hdGNoLCBbZXZ0XS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGFkZChlbGVtZW50LCBldmVudCwgY2FsbGJhY2ssIGRhdGEsIHNlbGVjdG9yLCBkZWxlZ2F0b3IgfHwgYXV0b1JlbW92ZSkKICAgIH0pCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICB2YXIgJHRoaXMgPSB0aGlzCiAgICBpZiAoZXZlbnQgJiYgIWlzU3RyaW5nKGV2ZW50KSkgewogICAgICAkLmVhY2goZXZlbnQsIGZ1bmN0aW9uKHR5cGUsIGZuKXsKICAgICAgICAkdGhpcy5vZmYodHlwZSwgc2VsZWN0b3IsIGZuKQogICAgICB9KQogICAgICByZXR1cm4gJHRoaXMKICAgIH0KCiAgICBpZiAoIWlzU3RyaW5nKHNlbGVjdG9yKSAmJiAhaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2sgIT09IGZhbHNlKQogICAgICBjYWxsYmFjayA9IHNlbGVjdG9yLCBzZWxlY3RvciA9IHVuZGVmaW5lZAoKICAgIGlmIChjYWxsYmFjayA9PT0gZmFsc2UpIGNhbGxiYWNrID0gcmV0dXJuRmFsc2UKCiAgICByZXR1cm4gJHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrLCBzZWxlY3RvcikKICAgIH0pCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgYXJncyl7CiAgICBldmVudCA9IChpc1N0cmluZyhldmVudCkgfHwgJC5pc1BsYWluT2JqZWN0KGV2ZW50KSkgPyAkLkV2ZW50KGV2ZW50KSA6IGNvbXBhdGlibGUoZXZlbnQpCiAgICBldmVudC5fYXJncyA9IGFyZ3MKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgLy8gaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24gbWlnaHQgbm90IGJlIERPTSBlbGVtZW50cwogICAgICBpZignZGlzcGF0Y2hFdmVudCcgaW4gdGhpcykgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KQogICAgICBlbHNlICQodGhpcykudHJpZ2dlckhhbmRsZXIoZXZlbnQsIGFyZ3MpCiAgICB9KQogIH0KCiAgLy8gdHJpZ2dlcnMgZXZlbnQgaGFuZGxlcnMgb24gY3VycmVudCBlbGVtZW50IGp1c3QgYXMgaWYgYW4gZXZlbnQgb2NjdXJyZWQsCiAgLy8gZG9lc24ndCB0cmlnZ2VyIGFuIGFjdHVhbCBldmVudCwgZG9lc24ndCBidWJibGUKICAkLmZuLnRyaWdnZXJIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQsIGFyZ3MpewogICAgdmFyIGUsIHJlc3VsdAogICAgdGhpcy5lYWNoKGZ1bmN0aW9uKGksIGVsZW1lbnQpewogICAgICBlID0gY3JlYXRlUHJveHkoaXNTdHJpbmcoZXZlbnQpID8gJC5FdmVudChldmVudCkgOiBldmVudCkKICAgICAgZS5fYXJncyA9IGFyZ3MKICAgICAgZS50YXJnZXQgPSBlbGVtZW50CiAgICAgICQuZWFjaChmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQudHlwZSB8fCBldmVudCksIGZ1bmN0aW9uKGksIGhhbmRsZXIpewogICAgICAgIHJlc3VsdCA9IGhhbmRsZXIucHJveHkoZSkKICAgICAgICBpZiAoZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSByZXR1cm4gZmFsc2UKICAgICAgfSkKICAgIH0pCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvLyBzaG9ydGN1dCBtZXRob2RzIGZvciBgLmJpbmQoZXZlbnQsIGZuKWAgZm9yIGVhY2ggZXZlbnQgdHlwZQogIDsoJ2ZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAnKwogICdtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8KICAgICAgICB0aGlzLmJpbmQoZXZlbnQsIGNhbGxiYWNrKSA6CiAgICAgICAgdGhpcy50cmlnZ2VyKGV2ZW50KQogICAgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICB0cnkgeyB0aGlzW25hbWVdKCkgfQogICAgICAgIGNhdGNoKGUpIHt9CiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICBpZiAoIWlzU3RyaW5nKHR5cGUpKSBwcm9wcyA9IHR5cGUsIHR5cGUgPSBwcm9wcy50eXBlCiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlKQogICAgcmV0dXJuIGNvbXBhdGlibGUoZXZlbnQpCiAgfQoKfSkoWmVwdG8pCgo7KGZ1bmN0aW9uKCQpewogIHZhciBqc29ucElEID0gMCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpCiAgfQoKICAvLyB0cmlnZ2VyIGFuIEFqYXggImdsb2JhbCIgZXZlbnQKICBmdW5jdGlvbiB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCBldmVudE5hbWUsIGRhdGEpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwpIHJldHVybiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQgfHwgZG9jdW1lbnQsIGV2ZW50TmFtZSwgZGF0YSkKICB9CgogIC8vIE51bWJlciBvZiBhY3RpdmUgQWpheCByZXF1ZXN0cwogICQuYWN0aXZlID0gMAoKICBmdW5jdGlvbiBhamF4U3RhcnQoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgJC5hY3RpdmUrKyA9PT0gMCkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdGFydCcpCiAgfQogIGZ1bmN0aW9uIGFqYXhTdG9wKHNldHRpbmdzKSB7CiAgICBpZiAoc2V0dGluZ3MuZ2xvYmFsICYmICEoLS0kLmFjdGl2ZSkpIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIG51bGwsICdhamF4U3RvcCcpCiAgfQoKICAvLyB0cmlnZ2VycyBhbiBleHRyYSBnbG9iYWwgZXZlbnQgImFqYXhCZWZvcmVTZW5kIiB0aGF0J3MgbGlrZSAiYWpheFNlbmQiIGJ1dCBjYW5jZWxhYmxlCiAgZnVuY3Rpb24gYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBpZiAoc2V0dGluZ3MuYmVmb3JlU2VuZC5jYWxsKGNvbnRleHQsIHhociwgc2V0dGluZ3MpID09PSBmYWxzZSB8fAogICAgICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4QmVmb3JlU2VuZCcsIFt4aHIsIHNldHRpbmdzXSkgPT09IGZhbHNlKQogICAgICByZXR1cm4gZmFsc2UKCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheFNlbmQnLCBbeGhyLCBzZXR0aW5nc10pCiAgfQogIGZ1bmN0aW9uIGFqYXhTdWNjZXNzKGRhdGEsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQsIHN0YXR1cyA9ICdzdWNjZXNzJwogICAgc2V0dGluZ3Muc3VjY2Vzcy5jYWxsKGNvbnRleHQsIGRhdGEsIHN0YXR1cywgeGhyKQogICAgaWYgKGRlZmVycmVkKSBkZWZlcnJlZC5yZXNvbHZlV2l0aChjb250ZXh0LCBbZGF0YSwgc3RhdHVzLCB4aHJdKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhTdWNjZXNzJywgW3hociwgc2V0dGluZ3MsIGRhdGFdKQogICAgYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykKICB9CiAgLy8gdHlwZTogInRpbWVvdXQiLCAiZXJyb3IiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheEVycm9yKGVycm9yLCB0eXBlLCB4aHIsIHNldHRpbmdzLCBkZWZlcnJlZCkgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICBpZiAoZGVmZXJyZWQpIGRlZmVycmVkLnJlamVjdFdpdGgoY29udGV4dCwgW3hociwgdHlwZSwgZXJyb3JdKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhFcnJvcicsIFt4aHIsIHNldHRpbmdzLCBlcnJvciB8fCB0eXBlXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zLCBkZWZlcnJlZCl7CiAgICBpZiAoISgndHlwZScgaW4gb3B0aW9ucykpIHJldHVybiAkLmFqYXgob3B0aW9ucykKCiAgICB2YXIgX2NhbGxiYWNrTmFtZSA9IG9wdGlvbnMuanNvbnBDYWxsYmFjaywKICAgICAgY2FsbGJhY2tOYW1lID0gKCQuaXNGdW5jdGlvbihfY2FsbGJhY2tOYW1lKSA/CiAgICAgICAgX2NhbGxiYWNrTmFtZSgpIDogX2NhbGxiYWNrTmFtZSkgfHwgKCdqc29ucCcgKyAoKytqc29ucElEKSksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBvcmlnaW5hbENhbGxiYWNrID0gd2luZG93W2NhbGxiYWNrTmFtZV0sCiAgICAgIHJlc3BvbnNlRGF0YSwKICAgICAgYWJvcnQgPSBmdW5jdGlvbihlcnJvclR5cGUpIHsKICAgICAgICAkKHNjcmlwdCkudHJpZ2dlckhhbmRsZXIoJ2Vycm9yJywgZXJyb3JUeXBlIHx8ICdhYm9ydCcpCiAgICAgIH0sCiAgICAgIHhociA9IHsgYWJvcnQ6IGFib3J0IH0sIGFib3J0VGltZW91dAoKICAgIGlmIChkZWZlcnJlZCkgZGVmZXJyZWQucHJvbWlzZSh4aHIpCgogICAgJChzY3JpcHQpLm9uKCdsb2FkIGVycm9yJywgZnVuY3Rpb24oZSwgZXJyb3JUeXBlKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLm9mZigpLnJlbW92ZSgpCgogICAgICBpZiAoZS50eXBlID09ICdlcnJvcicgfHwgIXJlc3BvbnNlRGF0YSkgewogICAgICAgIGFqYXhFcnJvcihudWxsLCBlcnJvclR5cGUgfHwgJ2Vycm9yJywgeGhyLCBvcHRpb25zLCBkZWZlcnJlZCkKICAgICAgfSBlbHNlIHsKICAgICAgICBhamF4U3VjY2VzcyhyZXNwb25zZURhdGFbMF0sIHhociwgb3B0aW9ucywgZGVmZXJyZWQpCiAgICAgIH0KCiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gb3JpZ2luYWxDYWxsYmFjawogICAgICBpZiAocmVzcG9uc2VEYXRhICYmICQuaXNGdW5jdGlvbihvcmlnaW5hbENhbGxiYWNrKSkKICAgICAgICBvcmlnaW5hbENhbGxiYWNrKHJlc3BvbnNlRGF0YVswXSkKCiAgICAgIG9yaWdpbmFsQ2FsbGJhY2sgPSByZXNwb25zZURhdGEgPSB1bmRlZmluZWQKICAgIH0pCgogICAgaWYgKGFqYXhCZWZvcmVTZW5kKHhociwgb3B0aW9ucykgPT09IGZhbHNlKSB7CiAgICAgIGFib3J0KCdhYm9ydCcpCiAgICAgIHJldHVybiB4aHIKICAgIH0KCiAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7CiAgICAgIHJlc3BvbnNlRGF0YSA9IGFyZ3VtZW50cwogICAgfQoKICAgIHNjcmlwdC5zcmMgPSBvcHRpb25zLnVybC5yZXBsYWNlKC89XD8vLCAnPScgKyBjYWxsYmFja05hbWUpCiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCkKCiAgICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICBhYm9ydCgndGltZW91dCcpCiAgICB9LCBvcHRpb25zLnRpbWVvdXQpCgogICAgcmV0dXJuIHhocgogIH0KCiAgJC5hamF4U2V0dGluZ3MgPSB7CiAgICAvLyBEZWZhdWx0IHR5cGUgb2YgcmVxdWVzdAogICAgdHlwZTogJ0dFVCcsCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIGJlZm9yZSByZXF1ZXN0CiAgICBiZWZvcmVTZW5kOiBlbXB0eSwKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMKICAgIHN1Y2Nlc3M6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCB0aGUgdGhlIHNlcnZlciBkcm9wcyBlcnJvcgogICAgZXJyb3I6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBvbiByZXF1ZXN0IGNvbXBsZXRlIChib3RoOiBlcnJvciBhbmQgc3VjY2VzcykKICAgIGNvbXBsZXRlOiBlbXB0eSwKICAgIC8vIFRoZSBjb250ZXh0IGZvciB0aGUgY2FsbGJhY2tzCiAgICBjb250ZXh0OiBudWxsLAogICAgLy8gV2hldGhlciB0byB0cmlnZ2VyICJnbG9iYWwiIEFqYXggZXZlbnRzCiAgICBnbG9iYWw6IHRydWUsCiAgICAvLyBUcmFuc3BvcnQKICAgIHhocjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpCiAgICB9LAogICAgLy8gTUlNRSB0eXBlcyBtYXBwaW5nCiAgICAvLyBJSVMgcmV0dXJucyBKYXZhc2NyaXB0IGFzICJhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQiCiAgICBhY2NlcHRzOiB7CiAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwLAogICAgLy8gV2hldGhlciBkYXRhIHNob3VsZCBiZSBzZXJpYWxpemVkIHRvIHN0cmluZwogICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICAvLyBXaGV0aGVyIHRoZSBicm93c2VyIHNob3VsZCBiZSBhbGxvd2VkIHRvIGNhY2hlIEdFVCByZXNwb25zZXMKICAgIGNhY2hlOiB0cnVlCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICBpZiAobWltZSkgbWltZSA9IG1pbWUuc3BsaXQoJzsnLCAyKVswXQogICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IGh0bWxUeXBlID8gJ2h0bWwnIDoKICAgICAgbWltZSA9PSBqc29uVHlwZSA/ICdqc29uJyA6CiAgICAgIHNjcmlwdFR5cGVSRS50ZXN0KG1pbWUpID8gJ3NjcmlwdCcgOgogICAgICB4bWxUeXBlUkUudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogIH0KCiAgZnVuY3Rpb24gYXBwZW5kUXVlcnkodXJsLCBxdWVyeSkgewogICAgaWYgKHF1ZXJ5ID09ICcnKSByZXR1cm4gdXJsCiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMucHJvY2Vzc0RhdGEgJiYgb3B0aW9ucy5kYXRhICYmICQudHlwZShvcHRpb25zLmRhdGEpICE9ICJzdHJpbmciKQogICAgICBvcHRpb25zLmRhdGEgPSAkLnBhcmFtKG9wdGlvbnMuZGF0YSwgb3B0aW9ucy50cmFkaXRpb25hbCkKICAgIGlmIChvcHRpb25zLmRhdGEgJiYgKCFvcHRpb25zLnR5cGUgfHwgb3B0aW9ucy50eXBlLnRvVXBwZXJDYXNlKCkgPT0gJ0dFVCcpKQogICAgICBvcHRpb25zLnVybCA9IGFwcGVuZFF1ZXJ5KG9wdGlvbnMudXJsLCBvcHRpb25zLmRhdGEpLCBvcHRpb25zLmRhdGEgPSB1bmRlZmluZWQKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pLAogICAgICAgIGRlZmVycmVkID0gJC5EZWZlcnJlZCAmJiAkLkRlZmVycmVkKCkKICAgIGZvciAoa2V5IGluICQuYWpheFNldHRpbmdzKSBpZiAoc2V0dGluZ3Nba2V5XSA9PT0gdW5kZWZpbmVkKSBzZXR0aW5nc1trZXldID0gJC5hamF4U2V0dGluZ3Nba2V5XQoKICAgIGFqYXhTdGFydChzZXR0aW5ncykKCiAgICBpZiAoIXNldHRpbmdzLmNyb3NzRG9tYWluKSBzZXR0aW5ncy5jcm9zc0RvbWFpbiA9IC9eKFtcdy1dKzopP1wvXC8oW15cL10rKS8udGVzdChzZXR0aW5ncy51cmwpICYmCiAgICAgIFJlZ0V4cC4kMiAhPSB3aW5kb3cubG9jYXRpb24uaG9zdAoKICAgIGlmICghc2V0dGluZ3MudXJsKSBzZXR0aW5ncy51cmwgPSB3aW5kb3cubG9jYXRpb24udG9TdHJpbmcoKQogICAgc2VyaWFsaXplRGF0YShzZXR0aW5ncykKICAgIGlmIChzZXR0aW5ncy5jYWNoZSA9PT0gZmFsc2UpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ189JyArIERhdGUubm93KCkpCgogICAgdmFyIGRhdGFUeXBlID0gc2V0dGluZ3MuZGF0YVR5cGUsIGhhc1BsYWNlaG9sZGVyID0gLz1cPy8udGVzdChzZXR0aW5ncy51cmwpCiAgICBpZiAoZGF0YVR5cGUgPT0gJ2pzb25wJyB8fCBoYXNQbGFjZWhvbGRlcikgewogICAgICBpZiAoIWhhc1BsYWNlaG9sZGVyKQogICAgICAgIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwKICAgICAgICAgIHNldHRpbmdzLmpzb25wID8gKHNldHRpbmdzLmpzb25wICsgJz0/JykgOiBzZXR0aW5ncy5qc29ucCA9PT0gZmFsc2UgPyAnJyA6ICdjYWxsYmFjaz0/JykKICAgICAgcmV0dXJuICQuYWpheEpTT05QKHNldHRpbmdzLCBkZWZlcnJlZCkKICAgIH0KCiAgICB2YXIgbWltZSA9IHNldHRpbmdzLmFjY2VwdHNbZGF0YVR5cGVdLAogICAgICAgIGhlYWRlcnMgPSB7IH0sCiAgICAgICAgc2V0SGVhZGVyID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsgaGVhZGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldID0gW25hbWUsIHZhbHVlXSB9LAogICAgICAgIHByb3RvY29sID0gL14oW1x3LV0rOilcL1wvLy50ZXN0KHNldHRpbmdzLnVybCkgPyBSZWdFeHAuJDEgOiB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wsCiAgICAgICAgeGhyID0gc2V0dGluZ3MueGhyKCksCiAgICAgICAgbmF0aXZlU2V0SGVhZGVyID0geGhyLnNldFJlcXVlc3RIZWFkZXIsCiAgICAgICAgYWJvcnRUaW1lb3V0CgogICAgaWYgKGRlZmVycmVkKSBkZWZlcnJlZC5wcm9taXNlKHhocikKCiAgICBpZiAoIXNldHRpbmdzLmNyb3NzRG9tYWluKSBzZXRIZWFkZXIoJ1gtUmVxdWVzdGVkLVdpdGgnLCAnWE1MSHR0cFJlcXVlc3QnKQogICAgc2V0SGVhZGVyKCdBY2NlcHQnLCBtaW1lIHx8ICcqLyonKQogICAgaWYgKG1pbWUgPSBzZXR0aW5ncy5taW1lVHlwZSB8fCBtaW1lKSB7CiAgICAgIGlmIChtaW1lLmluZGV4T2YoJywnKSA+IC0xKSBtaW1lID0gbWltZS5zcGxpdCgnLCcsIDIpWzBdCiAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICB9CiAgICBpZiAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgKHNldHRpbmdzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSAmJiBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUudG9VcHBlckNhc2UoKSAhPSAnR0VUJykpCiAgICAgIHNldEhlYWRlcignQ29udGVudC1UeXBlJywgc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCgogICAgaWYgKHNldHRpbmdzLmhlYWRlcnMpIGZvciAobmFtZSBpbiBzZXR0aW5ncy5oZWFkZXJzKSBzZXRIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyID0gc2V0SGVhZGVyCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHNldHRpbmdzLm1pbWVUeXBlIHx8IHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vZ2xvYmFsLWV2YWwtd2hhdC1hcmUtdGhlLW9wdGlvbnMvCiAgICAgICAgICAgIGlmIChkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICBlbHNlIGlmIChkYXRhVHlwZSA9PSAneG1sJykgIHJlc3VsdCA9IHhoci5yZXNwb25zZVhNTAogICAgICAgICAgICBlbHNlIGlmIChkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IGJsYW5rUkUudGVzdChyZXN1bHQpID8gbnVsbCA6ICQucGFyc2VKU09OKHJlc3VsdCkKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgZXJyb3IgPSBlIH0KCiAgICAgICAgICBpZiAoZXJyb3IpIGFqYXhFcnJvcihlcnJvciwgJ3BhcnNlcmVycm9yJywgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFqYXhFcnJvcih4aHIuc3RhdHVzVGV4dCB8fCBudWxsLCB4aHIuc3RhdHVzID8gJ2Vycm9yJyA6ICdhYm9ydCcsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSA9PT0gZmFsc2UpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgYWpheEVycm9yKG51bGwsICdhYm9ydCcsIHhociwgc2V0dGluZ3MsIGRlZmVycmVkKQogICAgICByZXR1cm4geGhyCiAgICB9CgogICAgaWYgKHNldHRpbmdzLnhockZpZWxkcykgZm9yIChuYW1lIGluIHNldHRpbmdzLnhockZpZWxkcykgeGhyW25hbWVdID0gc2V0dGluZ3MueGhyRmllbGRzW25hbWVdCgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYywgc2V0dGluZ3MudXNlcm5hbWUsIHNldHRpbmdzLnBhc3N3b3JkKQoKICAgIGZvciAobmFtZSBpbiBoZWFkZXJzKSBuYXRpdmVTZXRIZWFkZXIuYXBwbHkoeGhyLCBoZWFkZXJzW25hbWVdKQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncywgZGVmZXJyZWQpCiAgICAgIH0sIHNldHRpbmdzLnRpbWVvdXQpCgogICAgLy8gYXZvaWQgc2VuZGluZyBlbXB0eSBzdHJpbmcgKCMzMTkpCiAgICB4aHIuc2VuZChzZXR0aW5ncy5kYXRhID8gc2V0dGluZ3MuZGF0YSA6IG51bGwpCiAgICByZXR1cm4geGhyCiAgfQoKICAvLyBoYW5kbGUgb3B0aW9uYWwgZGF0YS9zdWNjZXNzIGFyZ3VtZW50cwogIGZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUpIHsKICAgIHZhciBoYXNEYXRhID0gISQuaXNGdW5jdGlvbihkYXRhKQogICAgcmV0dXJuIHsKICAgICAgdXJsOiAgICAgIHVybCwKICAgICAgZGF0YTogICAgIGhhc0RhdGEgID8gZGF0YSA6IHVuZGVmaW5lZCwKICAgICAgc3VjY2VzczogICFoYXNEYXRhID8gZGF0YSA6ICQuaXNGdW5jdGlvbihzdWNjZXNzKSA/IHN1Y2Nlc3MgOiB1bmRlZmluZWQsCiAgICAgIGRhdGFUeXBlOiBoYXNEYXRhICA/IGRhdGFUeXBlIHx8IHN1Y2Nlc3MgOiBzdWNjZXNzCiAgICB9CiAgfQoKICAkLmdldCA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUpewogICAgcmV0dXJuICQuYWpheChwYXJzZUFyZ3VtZW50cy5hcHBseShudWxsLCBhcmd1bWVudHMpKQogIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICB2YXIgb3B0aW9ucyA9IHBhcnNlQXJndW1lbnRzLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgIG9wdGlvbnMudHlwZSA9ICdQT1NUJwogICAgcmV0dXJuICQuYWpheChvcHRpb25zKQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzKXsKICAgIHZhciBvcHRpb25zID0gcGFyc2VBcmd1bWVudHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgb3B0aW9ucy5kYXRhVHlwZSA9ICdqc29uJwogICAgcmV0dXJuICQuYWpheChvcHRpb25zKQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvciwKICAgICAgICBvcHRpb25zID0gcGFyc2VBcmd1bWVudHModXJsLCBkYXRhLCBzdWNjZXNzKSwKICAgICAgICBjYWxsYmFjayA9IG9wdGlvbnMuc3VjY2VzcwogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIG9wdGlvbnMudXJsID0gcGFydHNbMF0sIHNlbGVjdG9yID0gcGFydHNbMV0KICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKCc8ZGl2PicpLmh0bWwocmVzcG9uc2UucmVwbGFjZShyc2NyaXB0LCAiIikpLmZpbmQoc2VsZWN0b3IpCiAgICAgICAgOiByZXNwb25zZSkKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgfQogICAgJC5hamF4KG9wdGlvbnMpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdmFyIGVzY2FwZSA9IGVuY29kZVVSSUNvbXBvbmVudAoKICBmdW5jdGlvbiBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsLCBzY29wZSl7CiAgICB2YXIgdHlwZSwgYXJyYXkgPSAkLmlzQXJyYXkob2JqKSwgaGFzaCA9ICQuaXNQbGFpbk9iamVjdChvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHR5cGUgPSAkLnR5cGUodmFsdWUpCiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6CiAgICAgICAgc2NvcGUgKyAnWycgKyAoaGFzaCB8fCB0eXBlID09ICdvYmplY3QnIHx8IHR5cGUgPT0gJ2FycmF5JyA/IGtleSA6ICcnKSArICddJwogICAgICAvLyBoYW5kbGUgZGF0YSBpbiBzZXJpYWxpemVBcnJheSgpIGZvcm1hdAogICAgICBpZiAoIXNjb3BlICYmIGFycmF5KSBwYXJhbXMuYWRkKHZhbHVlLm5hbWUsIHZhbHVlLnZhbHVlKQogICAgICAvLyByZWN1cnNlIGludG8gbmVzdGVkIG9iamVjdHMKICAgICAgZWxzZSBpZiAodHlwZSA9PSAiYXJyYXkiIHx8ICghdHJhZGl0aW9uYWwgJiYgdHlwZSA9PSAib2JqZWN0IikpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgvJTIwL2csICcrJykKICB9Cn0pKFplcHRvKQoKOyhmdW5jdGlvbigkKXsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzdWx0ID0gW10sIGVsCiAgICAkKFtdLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbigpewogICAgdmFyIHJlc3VsdCA9IFtdCiAgICB0aGlzLnNlcmlhbGl6ZUFycmF5KCkuZm9yRWFjaChmdW5jdGlvbihlbG0pewogICAgICByZXN1bHQucHVzaChlbmNvZGVVUklDb21wb25lbnQoZWxtLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGVsbS52YWx1ZSkpCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIGlmIChjYWxsYmFjaykgdGhpcy5iaW5kKCdzdWJtaXQnLCBjYWxsYmFjaykKICAgIGVsc2UgaWYgKHRoaXMubGVuZ3RoKSB7CiAgICAgIHZhciBldmVudCA9ICQuRXZlbnQoJ3N1Ym1pdCcpCiAgICAgIHRoaXMuZXEoMCkudHJpZ2dlcihldmVudCkKICAgICAgaWYgKCFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCgo7KGZ1bmN0aW9uKCQpewogIC8vIF9fcHJvdG9fXyBkb2Vzbid0IGV4aXN0IG9uIElFPDExLCBzbyByZWRlZmluZQogIC8vIHRoZSBaIGZ1bmN0aW9uIHRvIHVzZSBvYmplY3QgZXh0ZW5zaW9uIGluc3RlYWQKICBpZiAoISgnX19wcm90b19fJyBpbiB7fSkpIHsKICAgICQuZXh0ZW5kKCQuemVwdG8sIHsKICAgICAgWjogZnVuY3Rpb24oZG9tLCBzZWxlY3Rvcil7CiAgICAgICAgZG9tID0gZG9tIHx8IFtdCiAgICAgICAgJC5leHRlbmQoZG9tLCAkLmZuKQogICAgICAgIGRvbS5zZWxlY3RvciA9IHNlbGVjdG9yIHx8ICcnCiAgICAgICAgZG9tLl9fWiA9IHRydWUKICAgICAgICByZXR1cm4gZG9tCiAgICAgIH0sCiAgICAgIC8vIHRoaXMgaXMgYSBrbHVkZ2UgYnV0IHdvcmtzCiAgICAgIGlzWjogZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICByZXR1cm4gJC50eXBlKG9iamVjdCkgPT09ICdhcnJheScgJiYgJ19fWicgaW4gb2JqZWN0CiAgICAgIH0KICAgIH0pCiAgfQoKICAvLyBnZXRDb21wdXRlZFN0eWxlIHNob3VsZG4ndCBmcmVhayBvdXQgd2hlbiBjYWxsZWQKICAvLyB3aXRob3V0IGEgdmFsaWQgZWxlbWVudCBhcyBhcmd1bWVudAogIHRyeSB7CiAgICBnZXRDb21wdXRlZFN0eWxlKHVuZGVmaW5lZCkKICB9IGNhdGNoKGUpIHsKICAgIHZhciBuYXRpdmVHZXRDb21wdXRlZFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZTsKICAgIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlID0gZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5hdGl2ZUdldENvbXB1dGVkU3R5bGUoZWxlbWVudCkKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQogICAgfQogIH0KfSkoWmVwdG8pCi8qCgpDb3B5cmlnaHQgKEMpIDIwMTEgYnkgWWVodWRhIEthdHoKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgpUSEUgU09GVFdBUkUuCgoqLwoKLy8gbGliL2hhbmRsZWJhcnMvYnJvd3Nlci1wcmVmaXguanMKdmFyIEhhbmRsZWJhcnMgPSB7fTsKCihmdW5jdGlvbihIYW5kbGViYXJzLCB1bmRlZmluZWQpIHsKOwovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgpIYW5kbGViYXJzLlZFUlNJT04gPSAiMS4wLjAiOwpIYW5kbGViYXJzLkNPTVBJTEVSX1JFVklTSU9OID0gNDsKCkhhbmRsZWJhcnMuUkVWSVNJT05fQ0hBTkdFUyA9IHsKICAxOiAnPD0gMS4wLnJjLjInLCAvLyAxLjAucmMuMiBpcyBhY3R1YWxseSByZXYyIGJ1dCBkb2Vzbid0IHJlcG9ydCBpdAogIDI6ICc9PSAxLjAuMC1yYy4zJywKICAzOiAnPT0gMS4wLjAtcmMuNCcsCiAgNDogJz49IDEuMC4wJwp9OwoKSGFuZGxlYmFycy5oZWxwZXJzICA9IHt9OwpIYW5kbGViYXJzLnBhcnRpYWxzID0ge307Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgZnVuY3Rpb25UeXBlID0gJ1tvYmplY3QgRnVuY3Rpb25dJywKICAgIG9iamVjdFR5cGUgPSAnW29iamVjdCBPYmplY3RdJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CiAgICBpZiAoaW52ZXJzZSB8fCBmbikgeyB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oJ0FyZyBub3Qgc3VwcG9ydGVkIHdpdGggbXVsdGlwbGUgaGVscGVycycpOyB9CiAgICBIYW5kbGViYXJzLlV0aWxzLmV4dGVuZCh0aGlzLmhlbHBlcnMsIG5hbWUpOwogIH0gZWxzZSB7CiAgICBpZiAoaW52ZXJzZSkgeyBmbi5ub3QgPSBpbnZlcnNlOyB9CiAgICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmbjsKICB9Cn07CgpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCA9IGZ1bmN0aW9uKG5hbWUsIHN0cikgewogIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CiAgICBIYW5kbGViYXJzLlV0aWxzLmV4dGVuZCh0aGlzLnBhcnRpYWxzLCAgbmFtZSk7CiAgfSBlbHNlIHsKICAgIHRoaXMucGFydGlhbHNbbmFtZV0gPSBzdHI7CiAgfQp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBoZWxwZXI6ICciICsgYXJnICsgIiciKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwoKICBpZih0eXBlID09PSBmdW5jdGlvblR5cGUpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoKICBpZihjb250ZXh0ID09PSB0cnVlKSB7CiAgICByZXR1cm4gZm4odGhpcyk7CiAgfSBlbHNlIGlmKGNvbnRleHQgPT09IGZhbHNlIHx8IGNvbnRleHQgPT0gbnVsbCkgewogICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgfSBlbHNlIGlmKHR5cGUgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgIGlmKGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzLmVhY2goY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuIGZuKGNvbnRleHQpOwogIH0KfSk7CgpIYW5kbGViYXJzLksgPSBmdW5jdGlvbigpIHt9OwoKSGFuZGxlYmFycy5jcmVhdGVGcmFtZSA9IE9iamVjdC5jcmVhdGUgfHwgZnVuY3Rpb24ob2JqZWN0KSB7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG9iamVjdDsKICB2YXIgb2JqID0gbmV3IEhhbmRsZWJhcnMuSygpOwogIEhhbmRsZWJhcnMuSy5wcm90b3R5cGUgPSBudWxsOwogIHJldHVybiBvYmo7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICBtZXRob2RNYXA6IHswOiAnZGVidWcnLCAxOiAnaW5mbycsIDI6ICd3YXJuJywgMzogJ2Vycm9yJ30sCgogIC8vIGNhbiBiZSBvdmVycmlkZGVuIGluIHRoZSBob3N0IGVudmlyb25tZW50CiAgbG9nOiBmdW5jdGlvbihsZXZlbCwgb2JqKSB7CiAgICBpZiAoSGFuZGxlYmFycy5sb2dnZXIubGV2ZWwgPD0gbGV2ZWwpIHsKICAgICAgdmFyIG1ldGhvZCA9IEhhbmRsZWJhcnMubG9nZ2VyLm1ldGhvZE1hcFtsZXZlbF07CiAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29uc29sZVttZXRob2RdKSB7CiAgICAgICAgY29uc29sZVttZXRob2RdLmNhbGwoY29uc29sZSwgb2JqKTsKICAgICAgfQogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIG9iaikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIG9iaik7IH07CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlYWNoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgdmFyIGkgPSAwLCByZXQgPSAiIiwgZGF0YTsKCiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0ID09PSAnb2JqZWN0JykgewogICAgaWYoY29udGV4dCBpbnN0YW5jZW9mIEFycmF5KXsKICAgICAgZm9yKHZhciBqID0gY29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgICAgaWYgKGRhdGEpIHsgZGF0YS5pbmRleCA9IGk7IH0KICAgICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2ldLCB7IGRhdGE6IGRhdGEgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvcih2YXIga2V5IGluIGNvbnRleHQpIHsKICAgICAgICBpZihjb250ZXh0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGlmKGRhdGEpIHsgZGF0YS5rZXkgPSBrZXk7IH0KICAgICAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRba2V5XSwge2RhdGE6IGRhdGF9KTsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGlmKGkgPT09IDApewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CgogIHJldHVybiByZXQ7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWYnLCBmdW5jdGlvbihjb25kaXRpb25hbCwgb3B0aW9ucykgewogIHZhciB0eXBlID0gdG9TdHJpbmcuY2FsbChjb25kaXRpb25hbCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWwuY2FsbCh0aGlzKTsgfQoKICBpZighY29uZGl0aW9uYWwgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbmRpdGlvbmFsKSkgewogICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VubGVzcycsIGZ1bmN0aW9uKGNvbmRpdGlvbmFsLCBvcHRpb25zKSB7CiAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyc1snaWYnXS5jYWxsKHRoaXMsIGNvbmRpdGlvbmFsLCB7Zm46IG9wdGlvbnMuaW52ZXJzZSwgaW52ZXJzZTogb3B0aW9ucy5mbn0pOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3dpdGgnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmICghSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGxldmVsID0gb3B0aW9ucy5kYXRhICYmIG9wdGlvbnMuZGF0YS5sZXZlbCAhPSBudWxsID8gcGFyc2VJbnQob3B0aW9ucy5kYXRhLmxldmVsLCAxMCkgOiAxOwogIEhhbmRsZWJhcnMubG9nKGxldmVsLCBjb250ZXh0KTsKfSk7CjsKLy8gbGliL2hhbmRsZWJhcnMvdXRpbHMuanMKCnZhciBlcnJvclByb3BzID0gWydkZXNjcmlwdGlvbicsICdmaWxlTmFtZScsICdsaW5lTnVtYmVyJywgJ21lc3NhZ2UnLCAnbmFtZScsICdudW1iZXInLCAnc3RhY2snXTsKCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgLy8gVW5mb3J0dW5hdGVseSBlcnJvcnMgYXJlIG5vdCBlbnVtZXJhYmxlIGluIENocm9tZSAoYXQgbGVhc3QpLCBzbyBgZm9yIHByb3AgaW4gdG1wYCBkb2Vzbid0IHdvcmsuCiAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgZXJyb3JQcm9wcy5sZW5ndGg7IGlkeCsrKSB7CiAgICB0aGlzW2Vycm9yUHJvcHNbaWR4XV0gPSB0bXBbZXJyb3JQcm9wc1tpZHhdXTsKICB9Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCnZhciBlc2NhcGUgPSB7CiAgIiYiOiAiJmFtcDsiLAogICI8IjogIiZsdDsiLAogICI+IjogIiZndDsiLAogICciJzogIiZxdW90OyIsCiAgIiciOiAiJiN4Mjc7IiwKICAiYCI6ICImI3g2MDsiCn07Cgp2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYF0vZzsKdmFyIHBvc3NpYmxlID0gL1smPD4iJ2BdLzsKCnZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7Cn07CgpIYW5kbGViYXJzLlV0aWxzID0gewogIGV4dGVuZDogZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewogICAgZm9yKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgaWYodmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIG9ialtrZXldID0gdmFsdWVba2V5XTsKICAgICAgfQogICAgfQogIH0sCgogIGVzY2FwZUV4cHJlc3Npb246IGZ1bmN0aW9uKHN0cmluZykgewogICAgLy8gZG9uJ3QgZXNjYXBlIFNhZmVTdHJpbmdzLCBzaW5jZSB0aGV5J3JlIGFscmVhZHkgc2FmZQogICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgaWYgKHN0cmluZyA9PSBudWxsIHx8IHN0cmluZyA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuICIiOwogICAgfQoKICAgIC8vIEZvcmNlIGEgc3RyaW5nIGNvbnZlcnNpb24gYXMgdGhpcyB3aWxsIGJlIGRvbmUgYnkgdGhlIGFwcGVuZCByZWdhcmRsZXNzIGFuZAogICAgLy8gdGhlIHJlZ2V4IHRlc3Qgd2lsbCBkbyB0aGlzIHRyYW5zcGFyZW50bHkgYmVoaW5kIHRoZSBzY2VuZXMsIGNhdXNpbmcgaXNzdWVzIGlmCiAgICAvLyBhbiBvYmplY3QncyB0byBzdHJpbmcgaGFzIGVzY2FwZWQgY2hhcmFjdGVycyBpbiBpdC4KICAgIHN0cmluZyA9IHN0cmluZy50b1N0cmluZygpOwoKICAgIGlmKCFwb3NzaWJsZS50ZXN0KHN0cmluZykpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICB9LAoKICBpc0VtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSAmJiB2YWx1ZSAhPT0gMCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZih0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKCkhhbmRsZWJhcnMuVk0gPSB7CiAgdGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlU3BlYykgewogICAgLy8gSnVzdCBhZGQgd2F0ZXIKICAgIHZhciBjb250YWluZXIgPSB7CiAgICAgIGVzY2FwZUV4cHJlc3Npb246IEhhbmRsZWJhcnMuVXRpbHMuZXNjYXBlRXhwcmVzc2lvbiwKICAgICAgaW52b2tlUGFydGlhbDogSGFuZGxlYmFycy5WTS5pbnZva2VQYXJ0aWFsLAogICAgICBwcm9ncmFtczogW10sCiAgICAgIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CiAgICAgICAgdmFyIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXTsKICAgICAgICBpZihkYXRhKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShpLCBmbiwgZGF0YSk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShpLCBmbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgbWVyZ2U6IGZ1bmN0aW9uKHBhcmFtLCBjb21tb24pIHsKICAgICAgICB2YXIgcmV0ID0gcGFyYW0gfHwgY29tbW9uOwoKICAgICAgICBpZiAocGFyYW0gJiYgY29tbW9uKSB7CiAgICAgICAgICByZXQgPSB7fTsKICAgICAgICAgIEhhbmRsZWJhcnMuVXRpbHMuZXh0ZW5kKHJldCwgY29tbW9uKTsKICAgICAgICAgIEhhbmRsZWJhcnMuVXRpbHMuZXh0ZW5kKHJldCwgcGFyYW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgY29tcGlsZXJJbmZvOiBudWxsCiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgcmVzdWx0ID0gdGVtcGxhdGVTcGVjLmNhbGwoY29udGFpbmVyLCBIYW5kbGViYXJzLCBjb250ZXh0LCBvcHRpb25zLmhlbHBlcnMsIG9wdGlvbnMucGFydGlhbHMsIG9wdGlvbnMuZGF0YSk7CgogICAgICB2YXIgY29tcGlsZXJJbmZvID0gY29udGFpbmVyLmNvbXBpbGVySW5mbyB8fCBbXSwKICAgICAgICAgIGNvbXBpbGVyUmV2aXNpb24gPSBjb21waWxlckluZm9bMF0gfHwgMSwKICAgICAgICAgIGN1cnJlbnRSZXZpc2lvbiA9IEhhbmRsZWJhcnMuQ09NUElMRVJfUkVWSVNJT047CgogICAgICBpZiAoY29tcGlsZXJSZXZpc2lvbiAhPT0gY3VycmVudFJldmlzaW9uKSB7CiAgICAgICAgaWYgKGNvbXBpbGVyUmV2aXNpb24gPCBjdXJyZW50UmV2aXNpb24pIHsKICAgICAgICAgIHZhciBydW50aW1lVmVyc2lvbnMgPSBIYW5kbGViYXJzLlJFVklTSU9OX0NIQU5HRVNbY3VycmVudFJldmlzaW9uXSwKICAgICAgICAgICAgICBjb21waWxlclZlcnNpb25zID0gSGFuZGxlYmFycy5SRVZJU0lPTl9DSEFOR0VTW2NvbXBpbGVyUmV2aXNpb25dOwogICAgICAgICAgdGhyb3cgIlRlbXBsYXRlIHdhcyBwcmVjb21waWxlZCB3aXRoIGFuIG9sZGVyIHZlcnNpb24gb2YgSGFuZGxlYmFycyB0aGFuIHRoZSBjdXJyZW50IHJ1bnRpbWUuICIrCiAgICAgICAgICAgICAgICAiUGxlYXNlIHVwZGF0ZSB5b3VyIHByZWNvbXBpbGVyIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitydW50aW1lVmVyc2lvbnMrIikgb3IgZG93bmdyYWRlIHlvdXIgcnVudGltZSB0byBhbiBvbGRlciB2ZXJzaW9uICgiK2NvbXBpbGVyVmVyc2lvbnMrIikuIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVXNlIHRoZSBlbWJlZGRlZCB2ZXJzaW9uIGluZm8gc2luY2UgdGhlIHJ1bnRpbWUgZG9lc24ndCBrbm93IGFib3V0IHRoaXMgcmV2aXNpb24geWV0CiAgICAgICAgICB0aHJvdyAiVGVtcGxhdGUgd2FzIHByZWNvbXBpbGVkIHdpdGggYSBuZXdlciB2ZXJzaW9uIG9mIEhhbmRsZWJhcnMgdGhhbiB0aGUgY3VycmVudCBydW50aW1lLiAiKwogICAgICAgICAgICAgICAgIlBsZWFzZSB1cGRhdGUgeW91ciBydW50aW1lIHRvIGEgbmV3ZXIgdmVyc2lvbiAoIitjb21waWxlckluZm9bMV0rIikuIjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0sCgogIHByb2dyYW1XaXRoRGVwdGg6IGZ1bmN0aW9uKGksIGZuLCBkYXRhIC8qLCAkZGVwdGggKi8pIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKCiAgICB2YXIgcHJvZ3JhbSA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICAgIHByb2dyYW0ucHJvZ3JhbSA9IGk7CiAgICBwcm9ncmFtLmRlcHRoID0gYXJncy5sZW5ndGg7CiAgICByZXR1cm4gcHJvZ3JhbTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CiAgICB2YXIgcHJvZ3JhbSA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICAgIHByb2dyYW0ucHJvZ3JhbSA9IGk7CiAgICBwcm9ncmFtLmRlcHRoID0gMDsKICAgIHJldHVybiBwcm9ncmFtOwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKLy8gbGliL2hhbmRsZWJhcnMvYnJvd3Nlci1zdWZmaXguanMKfSkoSGFuZGxlYmFycyk7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC40Ci8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuNCc7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcmVkdWNlRXJyb3IgPSAnUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZSc7CgogIC8vICoqUmVkdWNlKiogYnVpbGRzIHVwIGEgc2luZ2xlIHJlc3VsdCBmcm9tIGEgbGlzdCBvZiB2YWx1ZXMsIGFrYSBgaW5qZWN0YCwKICAvLyBvciBgZm9sZGxgLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlYCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2UgJiYgb2JqLnJlZHVjZSA9PT0gbmF0aXZlUmVkdWNlKSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZShpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlKGl0ZXJhdG9yKTsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IHZhbHVlOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KICBfLmZpbmQgPSBfLmRldGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlRmlsdGVyICYmIG9iai5maWx0ZXIgPT09IG5hdGl2ZUZpbHRlcikgcmV0dXJuIG9iai5maWx0ZXIoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiAhaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMsIGZpcnN0KSB7CiAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gbnVsbCA6IFtdOwogICAgcmV0dXJuIF9bZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10ob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzKSB7CiAgICByZXR1cm4gXy53aGVyZShvYmosIGF0dHJzLCB0cnVlKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHksIHZhbHVlOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5LCB2YWx1ZTogSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA8IHJlc3VsdC5jb21wdXRlZCAmJiAocmVzdWx0ID0ge3ZhbHVlIDogdmFsdWUsIGNvbXB1dGVkIDogY29tcHV0ZWR9KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC52YWx1ZTsKICB9OwoKICAvLyBTaHVmZmxlIGFuIGFycmF5LgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKGluZGV4KyspOwogICAgICBzaHVmZmxlZFtpbmRleCAtIDFdID0gc2h1ZmZsZWRbcmFuZF07CiAgICAgIHNodWZmbGVkW3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBzaHVmZmxlZDsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBsb29rdXAgaXRlcmF0b3JzLgogIHZhciBsb29rdXBJdGVyYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24ob2JqKXsgcmV0dXJuIG9ialt2YWx1ZV07IH07CiAgfTsKCiAgLy8gU29ydCB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uIHByb2R1Y2VkIGJ5IGFuIGl0ZXJhdG9yLgogIF8uc29ydEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZSA6IHZhbHVlLAogICAgICAgIGluZGV4IDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWEgOiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkKICAgICAgfTsKICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdC5pbmRleCA8IHJpZ2h0LmluZGV4ID8gLTEgOiAxOwogICAgfSksICd2YWx1ZScpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCwgYmVoYXZpb3IpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlIHx8IF8uaWRlbnRpdHkpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXkpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CiAgICByZXR1cm4gKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSA/IG9iai5sZW5ndGggOiBfLmtleXMob2JqKS5sZW5ndGg7CiAgfTsKCiAgLy8gQXJyYXkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEdldCB0aGUgZmlyc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgZmlyc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYGhlYWRgIGFuZCBgdGFrZWAuIFRoZSAqKmd1YXJkKiogY2hlY2sKICAvLyBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5maXJzdCA9IF8uaGVhZCA9IF8udGFrZSA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgogIC8vIGF2YWlsYWJsZS4KICBfLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4KICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCByZXN1bHQ7CiAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHByZXZpb3VzID0gbmV3IERhdGU7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlOwogICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfSBlbHNlIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgYXMgbG9uZyBhcyBpdCBjb250aW51ZXMgdG8gYmUgaW52b2tlZCwgd2lsbCBub3QKICAvLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCiAgLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlCiAgLy8gbGVhZGluZyBlZGdlLCBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZy4KICBfLmRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCwgcmVzdWx0OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29udGV4dCA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICB9OwogICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmIChjYWxsTm93KSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHZhciByYW4gPSBmYWxzZSwgbWVtbzsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgcmV0dXJuIG1lbW87CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIG1lbW8gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGZ1bmMgPSBudWxsOwogICAgICByZXR1cm4gbWVtbzsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24oZnVuYywgd3JhcHBlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IFtmdW5jXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogIF8uY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgZm9yICh2YXIgaSA9IGZ1bmNzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgYXJncyA9IFtmdW5jc1tpXS5hcHBseSh0aGlzLCBhcmdzKV07CiAgICAgIH0KICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIGlmICh0aW1lcyA8PSAwKSByZXR1cm4gZnVuYygpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBuYXRpdmVLZXlzIHx8IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiAhPT0gT2JqZWN0KG9iaikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgb2JqZWN0Jyk7CiAgICB2YXIga2V5cyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkga2V5c1trZXlzLmxlbmd0aF0gPSBrZXk7CiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvLyBSZXRyaWV2ZSB0aGUgdmFsdWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgXy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHZhbHVlcy5wdXNoKG9ialtrZXldKTsKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLy8gQ29udmVydCBhbiBvYmplY3QgaW50byBhIGxpc3Qgb2YgYFtrZXksIHZhbHVlXWAgcGFpcnMuCiAgXy5wYWlycyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHBhaXJzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBwYWlycy5wdXNoKFtrZXksIG9ialtrZXldXSk7CiAgICByZXR1cm4gcGFpcnM7CiAgfTsKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXN1bHRbb2JqW2tleV1dID0ga2V5OwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIG5hbWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob2JqW2tleV0pKSBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CgogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShuKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgICByZXR1cm4gYWNjdW07CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyICsgJyc7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwoKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlKSB7CiAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gIic7XG4iOwoKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCiAgICBzb3VyY2UgPSAidmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLCIgKwogICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgICBzb3VyY2UgKyAicmV0dXJuIF9fcDtcbiI7CgogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAxLjEuMAoKLy8gICAgIChjKSAyMDEwLTIwMTEgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIChjKSAyMDExLTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCiAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgQmFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggdGhlIGJyb3dzZXIgYW5kIHRoZSBzZXJ2ZXIuCiAgdmFyIEJhY2tib25lOwogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIEJhY2tib25lID0gZXhwb3J0czsKICB9IGVsc2UgewogICAgQmFja2JvbmUgPSByb290LkJhY2tib25lID0ge307CiAgfQoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjAnOwoKICAvLyBSZXF1aXJlIFVuZGVyc2NvcmUsIGlmIHdlJ3JlIG9uIHRoZSBzZXJ2ZXIsIGFuZCBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQuCiAgdmFyIF8gPSByb290Ll87CiAgaWYgKCFfICYmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpKSBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAvLyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSByb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zID0gXy5leHRlbmQoe3ZhbGlkYXRlOiB0cnVlfSwgb3B0aW9ucyk7CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCiAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCiAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgogICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgogICAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLgogICAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICAgIH0KICAgICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIAogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdIHx8IHRoaXMuX2J5SWRbb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkocm91dGVyLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoIGFuZCBxdWVyeS4KICB2YXIgcGF0aFN0cmlwcGVyID0gL1s/I10uKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBmcmFnbWVudCBvZiB0aGUgcXVlcnkgYW5kIGhhc2ggZm9yIG1hdGNoaW5nLgogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UocGF0aFN0cmlwcGVyLCAnJyk7CgogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgogICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07Cgp9KS5jYWxsKHRoaXMpOwoKLyoKQ29weXJpZ2h0IChjKSAyMDExLTIwMTMgQFdhbG1hcnRMYWJzCgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0bwpkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZQpyaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3IKc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCkZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIKREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKOzsKKGZ1bmN0aW9uKCkgewoKLypnbG9iYWwgY2xvbmVJbmhlcml0VmFycywgY3JlYXRlSW5oZXJpdFZhcnMsIHJlc2V0SW5oZXJpdFZhcnMsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzLCBjcmVhdGVFcnJvck1lc3NhZ2UsIGFzc2lnblRlbXBsYXRlICovCgovL3N1cHBvcnQgemVwdG8uZm9yRWFjaCBvbiBqUXVlcnkKaWYgKCEkLmZuLmZvckVhY2gpIHsKICAkLmZuLmZvckVhY2ggPSBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgJC5mbi5lYWNoLmNhbGwodGhpcywgZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIHRoaXMsIGluZGV4KTsKICAgIH0pOwogIH07Cn0KCnZhciB2aWV3TmFtZUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LW5hbWUnLAogICAgdmlld0NpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LWNpZCcsCiAgICB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctaGVscGVyJzsKCi8vdmlldyBpbnN0YW5jZXMKdmFyIHZpZXdzSW5kZXhlZEJ5Q2lkID0ge307CgppZiAoIUhhbmRsZWJhcnMudGVtcGxhdGVzKSB7CiAgSGFuZGxlYmFycy50ZW1wbGF0ZXMgPSB7fTsKfQoKdmFyIFRob3JheCA9IHRoaXMuVGhvcmF4ID0gewogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgLy92aWV3IGNsYXNzZXMKICBWaWV3czoge30sCgogIC8vIEFsbG93cyB0YWdnaW5nIG9mIHNlY3Rpb25zIG9mIGNvZGUgd2l0aCBhIG5hbWUgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAvLyBUaGlzIG9yIG9uRXhjZXB0aW9uIHNob3VsZCBiZSBvdmVycmlkZW4gdG8gYWxsb3cgZm9yIHJlcG9ydGluZyBleGNlcHRpb25zIHRvIGFuYWx5dGljcyBzZXJ2ZXJzCiAgLy8gb3IgaW50ZWdyYXRpb24gd2l0aCBsaWJyYXJpZXMgc3VjaCBhcyBDb3N0YW56YS4KICBiaW5kU2VjdGlvbjogZnVuY3Rpb24obmFtZSwgaW5mbywgY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSBpbmZvOwogICAgICBpbmZvID0gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBUaG9yYXgub25FeGNlcHRpb24obmFtZSwgZXJyLCBpbmZvKTsKICAgICAgfQogICAgfTsKICB9LAogIHJ1blNlY3Rpb246IGZ1bmN0aW9uKG5hbWUsIGluZm8sIGNhbGxiYWNrKSB7CiAgICByZXR1cm4gVGhvcmF4LmJpbmRTZWN0aW9uKG5hbWUsIGluZm8sIGNhbGxiYWNrKSgpOwogIH0sCgogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIgLyogLCBpbmZvICovKSB7CiAgICB0aHJvdyBlcnI7CiAgfSwKCiAgLy9kZXByZWNhdGVkLCBoZXJlIHRvIGVuc3VyZSBleGlzdGluZyBwcm9qZWN0cyBhcmVuJ3QgbXVja2VkIHdpdGgKICB0ZW1wbGF0ZXM6IEhhbmRsZWJhcnMudGVtcGxhdGVzCn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICAvLyBzdG9yZSBmaXJzdCBhcmd1bWVudCBmb3IgY29uZmlndXJlVmlldygpCiAgICB0aGlzLl9jb25zdHJ1Y3RvckFyZyA9IGFyZ3VtZW50c1swXTsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGRlbGV0ZSB0aGlzLl9jb25zdHJ1Y3RvckFyZzsKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY3RvcikgewogICAgICAgIG9iai5jdG9yLmNhbGwodGhpcywgcmVzcG9uc2UpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICAvLyBWaWV3IGNvbmZpZ3VyYXRpb24sIF9jb25maWd1cmUgd2FzIHJlbW92ZWQKICAvLyBpbiBCYWNrYm9uZSAxLjEsIGRlZmluZSBfY29uZmlndXJlIGFzIGEgbm9vcAogIC8vIGZvciBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIDEuMCBhbmQgZWFybGllcgogIF9jb25maWd1cmU6IGZ1bmN0aW9uKCkge30sCiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgIGNvbmZpZ3VyZVZpZXcuY2FsbCh0aGlzKTsKICAgIHJldHVybiBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5jYWxsKHRoaXMpOwogIH0sCgogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAnW29iamVjdCBWaWV3LicgKyB0aGlzLm5hbWUgKyAnXSc7CiAgfSwKCiAgc2V0RWxlbWVudCA6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5uYW1lICYmIHRoaXMuJGVsLmF0dHIodmlld05hbWVBdHRyaWJ1dGVOYW1lLCB0aGlzLm5hbWUpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSwgdGhpcy5jaWQpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCgogIF9hZGRDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgaWYgKHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdKSB7CiAgICAgIHJldHVybiB2aWV3OwogICAgfQogICAgdmlldy5yZXRhaW4oKTsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIC8vIF9oZWxwZXJPcHRpb25zIGlzIHVzZWQgdG8gZGV0ZWN0IGlmIGlzIEhlbHBlclZpZXcKICAgIC8vIHdlIGRvIG5vdCB3YW50IHRvIHJlbW92ZSBjaGlsZCBpbiB0aGlzIGNhc2UgYXMKICAgIC8vIHdlIGFyZSBhZGRpbmcgdGhlIEhlbHBlclZpZXcgdG8gdGhlIGRlY2xhcmluZyB2aWV3CiAgICAvLyAod2hhdGV2ZXIgdmlldyB1c2VkIHRoZSB2aWV3IGhlbHBlciBpbiBpdCdzIHRlbXBsYXRlKQogICAgLy8gYnV0IGl0J3MgcGFyZW50IHdpbGwgbm90IGVxdWFsIHRoZSBkZWNsYXJpbmcgdmlldwogICAgLy8gaW4gdGhlIGNhc2Ugb2YgYSBuZXN0ZWQgaGVscGVyLCB3aGljaCB3aWxsIGNhdXNlIGFuIGVycm9yLgogICAgLy8gSW4gZWl0aGVyIGNhc2UgaXQncyBub3QgbmVjZXNzYXJ5IHRvIGV2ZXIgY2FsbAogICAgLy8gX3JlbW92ZUNoaWxkIG9uIGEgSGVscGVyVmlldyBhcyBfYWRkQ2hpbGQgc2hvdWxkIG9ubHkKICAgIC8vIGJlIGNhbGxlZCB3aGVuIGEgSGVscGVyVmlldyBpcyBjcmVhdGVkLgogICAgaWYgKHZpZXcucGFyZW50ICYmIHZpZXcucGFyZW50ICE9PSB0aGlzICYmICF2aWV3Ll9oZWxwZXJPcHRpb25zKSB7CiAgICAgIHZpZXcucGFyZW50Ll9yZW1vdmVDaGlsZCh2aWV3KTsKICAgIH0KICAgIHZpZXcucGFyZW50ID0gdGhpczsKICAgIHRoaXMudHJpZ2dlcignY2hpbGQnLCB2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIF9yZW1vdmVDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdOwogICAgdmlldy5wYXJlbnQgPSBudWxsOwogICAgdmlldy5yZWxlYXNlKCk7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBfZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCwgdGhpcy51bmJpbmREYXRhT2JqZWN0LCB0aGlzKTsKICAgIHRoaXMudHJpZ2dlcignZGVzdHJveWVkJyk7CiAgICBkZWxldGUgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdOwoKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICB9LCB0aGlzKTsKCiAgICBpZiAodGhpcy5lbCkgewogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy5yZW1vdmUoKTsgIC8vIFdpbGwgY2FsbCBzdG9wTGlzdGVuaW5nKCkKICAgICAgdGhpcy5vZmYoKTsgICAgIC8vIEtpbGxzIG9mZiByZW1haW5pbmcgZXZlbnRzCiAgICB9CgogICAgLy8gQWJzb2x1dGUgd29yc3QgY2FzZSBzY2VuYXJpbywga2lsbCBvZmYgc29tZSBrbm93biBmaWVsZHMgdG8gbWluaW1pemUgdGhlIGltcGFjdAogICAgLy8gb2YgYmVpbmcgcmV0YWluZWQuCiAgICB0aGlzLmVsID0gdGhpcy4kZWwgPSB1bmRlZmluZWQ7CiAgICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIHRoaXMubW9kZWwgPSB0aGlzLmNvbGxlY3Rpb24gPSB0aGlzLl9jb2xsZWN0aW9uID0gdW5kZWZpbmVkOwogICAgdGhpcy5faGVscGVyT3B0aW9ucyA9IHVuZGVmaW5lZDsKICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgLy8gTk9QIGZvciBkZXN0cm95ZWQgdmlld3MKICAgIGlmICghc2VsZi5lbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgVGhvcmF4LnJ1blNlY3Rpb24oJ3Rob3JheC1yZW5kZXInLCB7bmFtZTogc2VsZi5uYW1lfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzZWxmLl9yZW5kZXJpbmcpIHsKICAgICAgICAvLyBOZXN0ZWQgcmVuZGVyaW5nIG9mIHRoZSBzYW1lIHZpZXcgaW5zdGFuY2VzIGNhbiBsZWFkIHRvIHNvbWUgdmVyeSBuYXN0eSBpc3N1ZXMgd2l0aAogICAgICAgIC8vIHRoZSByb290IHJlbmRlciBwcm9jZXNzIG92ZXJ3cml0aW5nIGFueSB1cGRhdGVkIGRhdGEgdGhhdCBtYXkgaGF2ZSBiZWVuIG91dHB1dCBpbiB0aGUgY2hpbGQKICAgICAgICAvLyBleGVjdXRpb24uIElmIGluIGEgc2l0dWF0aW9uIHdoZXJlIHlvdSBuZWVkIHRvIHJlcmVuZGVyIGluIHJlc3BvbnNlIHRvIGFuIGV2ZW50IHRoYXQgaXMKICAgICAgICAvLyB0cmlnZ2VyZWQgc3luYyBpbiB0aGUgcmVuZGVyaW5nIGxpZmVjeWNsZSBpdCdzIHJlY29tbWVuZGVkIHRvIGRlZmVyIHRoZSBzdWJzZXF1ZW50IHJlbmRlcgogICAgICAgIC8vIG9yIHJlZmFjdG9yIHNvIHRoYXQgYWxsIHByZWNvbmRpdGlvbnMgYXJlIGtub3duIHByaW9yIHRvIGV4ZWMuCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbmVzdGVkLXJlbmRlcicpKTsKICAgICAgfQoKICAgICAgc2VsZi5fcHJldmlvdXNIZWxwZXJzID0gXy5maWx0ZXIoc2VsZi5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICByZXR1cm4gY2hpbGQuX2hlbHBlck9wdGlvbnM7CiAgICAgIH0pOwoKICAgICAgdmFyIGNoaWxkcmVuID0ge307CiAgICAgIF8uZWFjaChzZWxmLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCwga2V5KSB7CiAgICAgICAgaWYgKCFjaGlsZC5faGVscGVyT3B0aW9ucykgewogICAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHNlbGYuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICAgIHNlbGYudHJpZ2dlcignYmVmb3JlOnJlbmRlcmVkJyk7CiAgICAgIHNlbGYuX3JlbmRlcmluZyA9IHRydWU7CgogICAgICB0cnkgewogICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKG91dHB1dCkgfHwgKCFfLmlzRWxlbWVudChvdXRwdXQpICYmICFUaG9yYXguVXRpbC5pcyQob3V0cHV0KSAmJiAhKG91dHB1dCAmJiBvdXRwdXQuZWwpICYmICFfLmlzU3RyaW5nKG91dHB1dCkgJiYgIV8uaXNGdW5jdGlvbihvdXRwdXQpKSkgewogICAgICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgICAgIC8vIHlldCBoYXZlIG9uZSB3ZSBtdXN0IHJhaXNlCiAgICAgICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHNlbGYsICd0ZW1wbGF0ZScsIHsKICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgb3V0cHV0ID0gc2VsZi5yZW5kZXJUZW1wbGF0ZShzZWxmLnRlbXBsYXRlKTsKICAgICAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgICAgICBvdXRwdXQgPSBzZWxmLnJlbmRlclRlbXBsYXRlKG91dHB1dCk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgICAgIF8uZWFjaChzZWxmLl9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICBzZWxmLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgfSwgc2VsZik7CiAgICAgICAgc2VsZi5fcHJldmlvdXNIZWxwZXJzID0gdW5kZWZpbmVkOwoKICAgICAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICAgICAgc2VsZi5odG1sKChvdXRwdXQgJiYgb3V0cHV0LmVsKSB8fCAob3V0cHV0ICYmIG91dHB1dC5zdHJpbmcpIHx8IG91dHB1dCk7CgogICAgICAgICsrc2VsZi5fcmVuZGVyQ291bnQ7CiAgICAgICAgc2VsZi50cmlnZ2VyKCdyZW5kZXJlZCcpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHNlbGYuX3JlbmRlcmluZyA9IGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfSwKCiAgY29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcykgfHwge30pOwogIH0sCgogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLmV4dGVuZCh7fSwgdGhpcywgZ2V0VmFsdWUodGhpcywgJ2NvbnRleHQnKSB8fCB7fSk7CiAgfSwKCiAgLy8gUHJpdmF0ZSB2YXJpYWJsZXMgaW4gaGFuZGxlYmFycyAvIG9wdGlvbnMuZGF0YSBpbiB0ZW1wbGF0ZSBoZWxwZXJzCiAgX2dldERhdGE6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiB7CiAgICAgIHZpZXc6IHRoaXMsCiAgICAgIGNpZDogXy51bmlxdWVJZCgndCcpLAogICAgICB5aWVsZDogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gZm4gaXMgc2VlZGVkIGJ5IHRlbXBsYXRlIGhlbHBlciBwYXNzaW5nIGNvbnRleHQgdG8gZGF0YQogICAgICAgIHJldHVybiBkYXRhLmZuICYmIGRhdGEuZm4oZGF0YSk7CiAgICAgIH0KICAgIH07CiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKF8uaXNGdW5jdGlvbihmaWxlKSkgewogICAgICB0ZW1wbGF0ZSA9IGZpbGU7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKGZpbGUsIGlnbm9yZUVycm9ycyk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5oZWxwZXJzLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKICBzaG91bGRSZW5kZXI6IGZ1bmN0aW9uKGZsYWcpIHsKICAgIC8vIFJlbmRlciBpZiBmbGFnIGlzIHRydXRoeSBvciBpZiB3ZSBoYXZlIGFscmVhZHkgcmVuZGVyZWQgYW5kIGZsYWcgaXMgdW5kZWZpbmVkL251bGwKICAgIHJldHVybiBmbGFnIHx8IChmbGFnID09IG51bGwgJiYgdGhpcy5fcmVuZGVyQ291bnQpOwogIH0sCiAgY29uZGl0aW9uYWxSZW5kZXI6IGZ1bmN0aW9uKGZsYWcpIHsKICAgIGlmICh0aGlzLnNob3VsZFJlbmRlcihmbGFnKSkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfQogIH0sCgogIGFwcGVuZFRvOiBmdW5jdGlvbihlbCkgewogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgJChlbCkuYXBwZW5kKHRoaXMuZWwpOwogICAgdGhpcy50cmlnZ2VyKCdyZWFkeScsIHt0YXJnZXQ6IHRoaXN9KTsKICB9LAoKICBodG1sOiBmdW5jdGlvbihodG1sKSB7CiAgICBpZiAoXy5pc1VuZGVmaW5lZChodG1sKSkgewogICAgICByZXR1cm4gdGhpcy5lbC5pbm5lckhUTUw7CiAgICB9IGVsc2UgewogICAgICAvLyBFdmVudCBmb3IgSUUgZWxlbWVudCBmaXhlcwogICAgICB0aGlzLnRyaWdnZXIoJ2JlZm9yZTphcHBlbmQnKTsKICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLl9yZXBsYWNlSFRNTChodG1sKTsKICAgICAgdGhpcy50cmlnZ2VyKCdhcHBlbmQnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9CiAgfSwKCiAgcmVsZWFzZTogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuX3JlZmVyZW5jZUNvdW50OwogICAgaWYgKHRoaXMuX3JlZmVyZW5jZUNvdW50IDw9IDApIHsKICAgICAgdGhpcy5fZGVzdHJveSgpOwogICAgfQogIH0sCgogIHJldGFpbjogZnVuY3Rpb24ob3duZXIpIHsKICAgICsrdGhpcy5fcmVmZXJlbmNlQ291bnQ7CiAgICBpZiAob3duZXIpIHsKICAgICAgLy8gTm90IHVzaW5nIGxpc3RlblRvIGhlbHBlciBhcyB3ZSB3YW50IHRvIHJ1biBvbmNlIHRoZSBvd25lciBpcyBkZXN0cm95ZWQKICAgICAgdGhpcy5saXN0ZW5Ubyhvd25lciwgJ2Rlc3Ryb3llZCcsIG93bmVyLnJlbGVhc2UpOwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAnJzsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gY29uZmlndXJlVmlldyAoKSB7CiAgdmFyIG9wdGlvbnMgPSB0aGlzLl9jb25zdHJ1Y3RvckFyZzsKICB2YXIgc2VsZiA9IHRoaXM7CgogIHRoaXMuX3JlZmVyZW5jZUNvdW50ID0gMDsKCiAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkID0ge307CgogIC8vIFNldHVwIG9iamVjdCBldmVudCB0cmFja2luZwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogIH0pOwoKICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogIHRoaXMuY2hpbGRyZW4gPSB7fTsKICB0aGlzLl9yZW5kZXJDb3VudCA9IDA7CgogIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogIC8vcHJvcGVydGllcyBkaXJlY3RseSB3aXRoIHRoZSB2aWV3IGFuZCB0ZW1wbGF0ZSBjb250ZXh0CiAgXy5leHRlbmQodGhpcywgb3B0aW9ucyB8fCB7fSk7CgogIC8vIFNldHVwIGhlbHBlcnMKICBiaW5kSGVscGVycy5jYWxsKHRoaXMpOwoKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgb2JqLmNvbmZpZ3VyZS5jYWxsKHRoaXMpOwogICAgfQogIH0sIHRoaXMpOwoKICB0aGlzLnRyaWdnZXIoJ2NvbmZpZ3VyZScpOwp9CgpmdW5jdGlvbiBiaW5kSGVscGVycygpIHsKICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICBfLmVhY2godGhpcy5oZWxwZXJzLCBmdW5jdGlvbihoZWxwZXIsIG5hbWUpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzOwogICAgICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICBvcHRpb25zID0gXy5sYXN0KGFyZ3MpOwogICAgICAgIG9wdGlvbnMuY29udGV4dCA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGhlbHBlci5hcHBseSh2aWV3LCBhcmdzKTsKICAgICAgfTsKICAgIH0sIHRoaXMpOwogIH0KfQoKLy8kKHNlbGVjdG9yKS52aWV3KCkgaGVscGVyCiQuZm4udmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICBoZWxwZXI6IHRydWUKICB9KTsKICB2YXIgc2VsZWN0b3IgPSAnWycgKyB2aWV3Q2lkQXR0cmlidXRlTmFtZSArICddJzsKICBpZiAoIW9wdGlvbnMuaGVscGVyKSB7CiAgICBzZWxlY3RvciArPSAnOm5vdChbJyArIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lICsgJ10pJzsKICB9CiAgdmFyIGVsID0gJCh0aGlzKS5jbG9zZXN0KHNlbGVjdG9yKTsKICByZXR1cm4gKGVsICYmIHZpZXdzSW5kZXhlZEJ5Q2lkW2VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpXSkgfHwgZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXI6dHJ1ZSwgY2xvbmVFdmVudHM6IHRydWUgKi8KZnVuY3Rpb24gY3JlYXRlRXJyb3JNZXNzYWdlKGNvZGUpIHsKICByZXR1cm4gJ0Vycm9yICInICsgY29kZSArICciLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiB2aXNpdCBodHRwOi8vdGhvcmF4anMub3JnL2Vycm9yLWNvZGVzLmh0bWwnICsgJyMnICsgY29kZTsKfQoKZnVuY3Rpb24gY3JlYXRlUmVnaXN0cnlXcmFwcGVyKGtsYXNzLCBoYXNoKSB7CiAgdmFyICRzdXBlciA9IGtsYXNzLmV4dGVuZDsKICBrbGFzcy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjaGlsZCA9ICRzdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKGNoaWxkLnByb3RvdHlwZS5uYW1lKSB7CiAgICAgIGhhc2hbY2hpbGQucHJvdG90eXBlLm5hbWVdID0gY2hpbGQ7CiAgICB9CiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKfQoKZnVuY3Rpb24gcmVnaXN0cnlHZXQob2JqZWN0LCB0eXBlLCBuYW1lLCBpZ25vcmVFcnJvcnMpIHsKICB2YXIgdGFyZ2V0ID0gb2JqZWN0W3R5cGVdLAogICAgICB2YWx1ZTsKICBpZiAoXy5pbmRleE9mKG5hbWUsICcuJykgPj0gMCkgewogICAgdmFyIGJpdHMgPSBuYW1lLnNwbGl0KC9cLi8pOwogICAgbmFtZSA9IGJpdHMucG9wKCk7CiAgICBfLmVhY2goYml0cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIHRhcmdldCA9IHRhcmdldFtrZXldOwogICAgfSk7CiAgfQogIHRhcmdldCAmJiAodmFsdWUgPSB0YXJnZXRbbmFtZV0pOwogIGlmICghdmFsdWUgJiYgIWlnbm9yZUVycm9ycykgewogICAgdGhyb3cgbmV3IEVycm9yKHR5cGUgKyAnOiAnICsgbmFtZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIGFzc2lnblZpZXcoYXR0cmlidXRlTmFtZSwgb3B0aW9ucykgewogIHZhciBWaWV3Q2xhc3M7CiAgLy8gaWYgYXR0cmlidXRlIGlzIHRoZSBuYW1lIG9mIHZpZXcgdG8gZmV0Y2gKICBpZiAoXy5pc1N0cmluZyh0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgVmlld0NsYXNzID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0NsYXNzKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdmlldyBiYXNlZCBvbiB0aGUgbmFtZQogIH0gZWxzZSBpZiAodGhpcy5uYW1lICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIFZpZXdDbGFzcyA9IFRob3JheC5VdGlsLmdldFZpZXdDbGFzcyh0aGlzLm5hbWUgKyAob3B0aW9ucy5leHRlbnNpb24gfHwgJycpLCB0cnVlKTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAoVmlld0NsYXNzICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRoaXNbYXR0cmlidXRlTmFtZV0gPSBWaWV3Q2xhc3M7CiAgfQogIC8vIGlmIG5vdGhpbmcgd2FzIGZvdW5kIGFuZCBpdCdzIHJlcXVpcmVkLCB0aHJvdwogIGlmIChvcHRpb25zLnJlcXVpcmVkICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRocm93IG5ldyBFcnJvcignVmlldyAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnIHJlcXVpcmVzOiAnICsgYXR0cmlidXRlTmFtZSk7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB2YXIgZXJyID0gbmV3IEVycm9yKCd2aWV3LXJlcXVpcmVzOiAnICsgYXR0cmlidXRlTmFtZSk7CiAgICBlcnIuaW5mbyA9IHsKICAgICAgbmFtZTogdGhpcy5uYW1lIHx8IHRoaXMuY2lkLAogICAgICBwYXJlbnQ6IHRoaXMucGFyZW50ICYmICh0aGlzLnBhcmVudC5uYW1lIHx8IHRoaXMucGFyZW50LmNpZCksCiAgICAgIGhlbHBlck5hbWU6IHRoaXMuX2hlbHBlck5hbWUKICAgIH07CiAgICB0aHJvdyBlcnI7CiAgfQp9CgovLyBnZXRWYWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgXy5yZXN1bHQgYmVjYXVzZSB3ZQovLyBuZWVkIGFuIGV4dHJhIHNjb3BlIHBhcmFtZXRlciwgYW5kIHdpbGwgbWluaWZ5Ci8vIGJldHRlciB0aGFuIF8ucmVzdWx0CmZ1bmN0aW9uIGdldFZhbHVlKG9iamVjdCwgcHJvcCwgc2NvcGUpIHsKICBpZiAoIShvYmplY3QgJiYgb2JqZWN0W3Byb3BdKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKQogICAgPyBvYmplY3RbcHJvcF0uY2FsbChzY29wZSB8fCBvYmplY3QpCiAgICA6IG9iamVjdFtwcm9wXTsKfQoKdmFyIGluaGVyaXRWYXJzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIXNlbGZbb2JqLm5hbWVdKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gcmVzZXRJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICB9KTsKfQpmdW5jdGlvbiB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCBmaWVsZE5hbWUsIGlzU3RhdGljLCBjYWxsYmFjaykgewogIHZhciB0cmVlID0gW107CiAgaWYgKF8uaGFzKHNvdXJjZSwgZmllbGROYW1lKSkgewogICAgdHJlZS5wdXNoKHNvdXJjZSk7CiAgfQogIHZhciBpdGVyYXRlID0gc291cmNlOwogIGlmIChpc1N0YXRpYykgewogICAgd2hpbGUgKGl0ZXJhdGUgPSBpdGVyYXRlLl9fcGFyZW50X18pIHsKICAgICAgaWYgKF8uaGFzKGl0ZXJhdGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaXRlcmF0ZSA9IGl0ZXJhdGUuY29uc3RydWN0b3I7CiAgICB3aGlsZSAoaXRlcmF0ZSkgewogICAgICBpZiAoaXRlcmF0ZS5wcm90b3R5cGUgJiYgXy5oYXMoaXRlcmF0ZS5wcm90b3R5cGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZS5wcm90b3R5cGUpOwogICAgICB9CiAgICAgIGl0ZXJhdGUgPSBpdGVyYXRlLl9fc3VwZXJfXyAmJiBpdGVyYXRlLl9fc3VwZXJfXy5jb25zdHJ1Y3RvcjsKICAgIH0KICB9CgogIHZhciBpID0gdHJlZS5sZW5ndGg7CiAgd2hpbGUgKGktLSkgewogICAgXy5lYWNoKGdldFZhbHVlKHRyZWVbaV0sIGZpZWxkTmFtZSwgc291cmNlKSwgY2FsbGJhY2spOwogIH0KfQoKZnVuY3Rpb24gb2JqZWN0RXZlbnRzKHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzT2JqZWN0KGNhbGxiYWNrKSkgewogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1tldmVudE5hbWVdOwogICAgaWYgKHNwZWMgJiYgc3BlYy5ldmVudCkgewogICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5saXN0ZW5UbyAmJiB0YXJnZXRbZXZlbnROYW1lXSAmJiB0YXJnZXRbZXZlbnROYW1lXS5jaWQpIHsKICAgICAgICBhZGRFdmVudHModGFyZ2V0LCBjYWxsYmFjaywgY29udGV4dCwgZXZlbnROYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZGRFdmVudHModGFyZ2V0WydfJyArIGV2ZW50TmFtZSArICdFdmVudHMnXSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQovLyBpbnRlcm5hbCBsaXN0ZW5UbyBmdW5jdGlvbiB3aWxsIGVycm9yIG9uIGRlc3Ryb3llZAovLyByYWNlIGNvbmRpdGlvbgpmdW5jdGlvbiBsaXN0ZW5UbyhvYmplY3QsIHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIC8vIGdldEV2ZW50Q2FsbGJhY2sgd2lsbCByZXNvbHZlIGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbWV0aG9kCiAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogIHZhciBjYWxsYmFja01ldGhvZCA9IGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIG9iamVjdCksCiAgICAgIGRlc3Ryb3llZENvdW50ID0gMDsKCiAgZnVuY3Rpb24gZXZlbnRIYW5kbGVyKCkgewogICAgaWYgKG9iamVjdC5lbCkgewogICAgICBjYWxsYmFja01ldGhvZC5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgb3VyIGV2ZW50IGhhbmRsZXIgaXMgcmVtb3ZlZCBieSBkZXN0cm95IHdoaWxlIGFub3RoZXIgZXZlbnQgaXMgcHJvY2Vzc2luZyB0aGVuIHdlCiAgICAgIC8vIHdlIG1pZ2h0IHNlZSBvbmUgbGF0ZW50IGV2ZW50IHBlcmNvbGF0ZSB0aHJvdWdoIGR1ZSB0byBjYWNoaW5nIGluIHRoZSBldmVudCBsb29wLiBJZiB3ZQogICAgICAvLyBzZWUgbXVsdGlwbGUgZXZlbnRzIHRoaXMgaXMgYSBjb25jZXJuIGFuZCBhIHNpZ24gdGhhdCBzb21ldGhpbmcgd2FzIG5vdCBjbGVhbmVkIHByb3Blcmx5LgogICAgICBpZiAoZGVzdHJveWVkQ291bnQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Rlc3Ryb3llZC1ldmVudDonICsgb2JqZWN0Lm5hbWUgKyAnOicgKyBldmVudE5hbWUpOwogICAgICB9CiAgICAgIGRlc3Ryb3llZENvdW50Kys7CiAgICB9CiAgfQogIGV2ZW50SGFuZGxlci5fY2FsbGJhY2sgPSBjYWxsYmFja01ldGhvZC5fY2FsbGJhY2sgfHwgY2FsbGJhY2tNZXRob2Q7CiAgZXZlbnRIYW5kbGVyLl90aG9yYXhCaW5kID0gdHJ1ZTsKICBvYmplY3QubGlzdGVuVG8odGFyZ2V0LCBldmVudE5hbWUsIGV2ZW50SGFuZGxlcik7Cn0KCmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCwgbGlzdGVuVG9PYmplY3QpIHsKICBmdW5jdGlvbiBhZGRFdmVudChjYWxsYmFjaywgZXZlbnROYW1lKSB7CiAgICBpZiAobGlzdGVuVG9PYmplY3QpIHsKICAgICAgbGlzdGVuVG8odGFyZ2V0LCB0YXJnZXRbbGlzdGVuVG9PYmplY3RdLCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0IHx8IHRhcmdldCk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dF0pOwogICAgfQogIH0KCiAgXy5lYWNoKHNvdXJjZSwgZnVuY3Rpb24oY2FsbGJhY2ssIGV2ZW50TmFtZSkgewogICAgaWYgKF8uaXNBcnJheShjYWxsYmFjaykpIHsKICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgIGFkZEV2ZW50KGNiLCBldmVudE5hbWUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGFkZEV2ZW50KGNhbGxiYWNrLCBldmVudE5hbWUpOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBnZXRPcHRpb25zRGF0YShvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmRhdGEpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2hhbmRsZWJhcnMtbm8tZGF0YScpKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9Cgp2YXIgdm9pZFRhZ3M7CmZ1bmN0aW9uIGlzVm9pZFRhZyh0YWcpIHsKICBpZiAoIXZvaWRUYWdzKSB7CiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9odG1sL3dnL2RyYWZ0cy9odG1sL21hc3Rlci9zeW50YXguaHRtbCN2b2lkLWVsZW1lbnRzCiAgICB2YXIgdGFncyA9ICdhcmVhLGJhc2UsYnIsY29sLGVtYmVkLGhyLGltZyxpbnB1dCxrZXlnZW4sbGluayxtZW51aXRlbSxtZXRhLHBhcmFtLHNvdXJjZSx0cmFjayx3YnInOwoKICAgIHZvaWRUYWdzID0ge307CiAgICBfLmVhY2godGFncy5zcGxpdCgnLCcpLCBmdW5jdGlvbih0YWcpIHsKICAgICAgdm9pZFRhZ3NbdGFnXSA9IHRydWU7CiAgICB9KTsKICB9CgogIHJldHVybiB2b2lkVGFnc1t0YWddOwp9OwoKVGhvcmF4LlV0aWwgPSB7CiAgZ2V0Vmlld0luc3RhbmNlOiBmdW5jdGlvbihuYW1lLCBhdHRyaWJ1dGVzKSB7CiAgICB2YXIgVmlld0NsYXNzID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0NsYXNzKG5hbWUsIHRydWUpOwogICAgcmV0dXJuIFZpZXdDbGFzcyA/IG5ldyBWaWV3Q2xhc3MoYXR0cmlidXRlcyB8fCB7fSkgOiBuYW1lOwogIH0sCgogIGdldFZpZXdDbGFzczogZnVuY3Rpb24obmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgICBpZiAoXy5pc1N0cmluZyhuYW1lKSkgewogICAgICByZXR1cm4gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBpZ25vcmVFcnJvcnMpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGlnbm9yZUVycm9ycykgewogICAgLy9hcHBlbmQgdGhlIHRlbXBsYXRlIHBhdGggcHJlZml4IGlmIGl0IGlzIG1pc3NpbmcKICAgIHZhciBwYXRoUHJlZml4ID0gVGhvcmF4LnRlbXBsYXRlUGF0aFByZWZpeCwKICAgICAgICB0ZW1wbGF0ZTsKICAgIGlmIChwYXRoUHJlZml4ICYmIGZpbGUuc3Vic3RyKDAsIHBhdGhQcmVmaXgubGVuZ3RoKSAhPT0gcGF0aFByZWZpeCkgewogICAgICBmaWxlID0gcGF0aFByZWZpeCArIGZpbGU7CiAgICB9CgogICAgLy8gV2l0aG91dCBleHRlbnNpb24KICAgIGZpbGUgPSBmaWxlLnJlcGxhY2UoL1wuaGFuZGxlYmFycyQvLCAnJyk7CiAgICB0ZW1wbGF0ZSA9IEhhbmRsZWJhcnMudGVtcGxhdGVzW2ZpbGVdOwogICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAvLyBXaXRoIGV4dGVuc2lvbgogICAgICBmaWxlID0gZmlsZSArICcuaGFuZGxlYmFycyc7CiAgICAgIHRlbXBsYXRlID0gSGFuZGxlYmFycy50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSwgZW5jb2RlKSB7CiAgICBpZiAoaW5wdXQgJiYgaW5wdXQuaW5kZXhPZiAmJiBpbnB1dC5pbmRleE9mKCd7eycpID49IDApIHsKICAgICAgdmFyIHJlID0gLyg/Olx7P1tee10rKXwoPzpce1x7KFtefV0rKVx9XH0pL2csCiAgICAgICAgICBtYXRjaCwKICAgICAgICAgIHJldCA9IFtdOwogICAgICBmdW5jdGlvbiBkZXJlZih0b2tlbiwgc2NvcGUpIHsKICAgICAgICBpZiAodG9rZW4ubWF0Y2goL14oInwnKS8pICYmIHRva2VuLm1hdGNoKC8oInwnKSQvKSkgewogICAgICAgICAgcmV0dXJuIHRva2VuLnJlcGxhY2UoLyheKCJ8Jyl8KCd8IikkKS9nLCAnJyk7CiAgICAgICAgfQogICAgICAgIHZhciBzZWdtZW50cyA9IHRva2VuLnNwbGl0KCcuJyksCiAgICAgICAgICAgIGxlbiA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgc2NvcGUgJiYgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoc2VnbWVudHNbaV0gIT09ICd0aGlzJykgewogICAgICAgICAgICBzY29wZSA9IHNjb3BlW3NlZ21lbnRzW2ldXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGVuY29kZSAmJiBfLmlzU3RyaW5nKHNjb3BlKSkgewogICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzY29wZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBzY29wZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKG1hdGNoID0gcmUuZXhlYyhpbnB1dCkpIHsKICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgIHZhciBwYXJhbXMgPSBtYXRjaFsxXS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciA9IHBhcmFtcy5zaGlmdCgpOwogICAgICAgICAgICBwYXJhbXMgPSBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7IHJldHVybiBkZXJlZihwYXJhbSwgc2NvcGUpOyB9KTsKICAgICAgICAgICAgaWYgKEhhbmRsZWJhcnMuaGVscGVyc1toZWxwZXJdKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0uYXBwbHkoc2NvcGUsIHBhcmFtcykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGRlZmluZWQgZG8gbm90aGluZwogICAgICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0LnB1c2goZGVyZWYocGFyYW1zWzBdLCBzY29wZSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXQucHVzaChtYXRjaFswXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlucHV0ID0gcmV0LmpvaW4oJycpOwogICAgfQogICAgcmV0dXJuIGlucHV0OwogIH0sCiAgdGFnOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBjb250ZW50LCBzY29wZSkgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5vbWl0KGF0dHJpYnV0ZXMsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnLAogICAgICAgIG5vQ2xvc2UgPSBpc1ZvaWRUYWcodGFnKTsKCiAgICBpZiAobm9DbG9zZSAmJiBjb250ZW50KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ3ZvaWQtdGFnLWNvbnRlbnQnKSk7CiAgICB9CgogICAgdmFyIG9wZW5pbmdUYWcgPSAnPCcgKyB0YWcgKyAnICcgKyBfLm1hcChodG1sQXR0cmlidXRlcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICBpZiAoXy5pc1VuZGVmaW5lZCh2YWx1ZSkgfHwga2V5ID09PSAnZXhwYW5kLXRva2VucycpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KICAgICAgdmFyIGZvcm1hdHRlZFZhbHVlID0gdmFsdWU7CiAgICAgIGlmIChzY29wZSkgewogICAgICAgIGZvcm1hdHRlZFZhbHVlID0gVGhvcmF4LlV0aWwuZXhwYW5kVG9rZW4odmFsdWUsIHNjb3BlKTsKICAgICAgfQogICAgICByZXR1cm4gKGtleSA9PT0gJ2NsYXNzTmFtZScgPyAnY2xhc3MnIDoga2V5KSArICc9IicgKyBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24oZm9ybWF0dGVkVmFsdWUpICsgJyInOwogICAgfSkuam9pbignICcpICsgJz4nOwoKICAgIGlmIChub0Nsb3NlKSB7CiAgICAgIHJldHVybiBvcGVuaW5nVGFnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG9wZW5pbmdUYWcgKyAoXy5pc1VuZGVmaW5lZChjb250ZW50KSA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogICAgfQogIH0KfTsKCjs7ClRob3JheC5NaXhpbnMgPSB7fTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgbWl4aW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgIFRob3JheC5NaXhpbnNbbmFtZV0odGhpcyk7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICB2YXIgaXNJbnN0YW5jZSA9ICEhb2JqLmNpZDsKICAgICAgaWYgKG1ldGhvZHMpIHsKICAgICAgICBfLmV4dGVuZChpc0luc3RhbmNlID8gb2JqIDogb2JqLnByb3RvdHlwZSwgbWV0aG9kcyk7CiAgICAgIH0KICAgICAgaWYgKGlzSW5zdGFuY2UpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKG9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqLm9uKCdjb25maWd1cmUnLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBUaG9yYXguTWl4aW5zW25hbWVdKHRoaXMpOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBsaXN0ZW5Ubywgb2JqZWN0RXZlbnRzLCB3YWxrSW5oZXJpdFRyZWUgKi8KLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIF9vbiBtZXRob2QgdG8gY2FsbCBhcyBhICRzdXBlciBtZXRob2QKdmFyIF9vbiA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCmluaGVyaXRWYXJzLmV2ZW50ID0gewogIG5hbWU6ICdfZXZlbnRzJywKCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLmNvbnN0cnVjdG9yLCAnX2V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXZlbnQpOwogICAgfSk7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcywgJ2V2ZW50cycsIGZhbHNlLCBmdW5jdGlvbihoYW5kbGVyLCBldmVudE5hbWUpIHsKICAgICAgc2VsZi5vbihldmVudE5hbWUsIGhhbmRsZXIsIHNlbGYpOwogICAgfSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgY3JlYXRlSW5oZXJpdFZhcnModGhpcyk7CgogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogaGFuZGxlcn0pCiAgICBpZiAoXy5pc09iamVjdChldmVudE5hbWUpKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJyAmJiAhdGhpcy5fZXZlbnRzRGVsZWdhdGVkKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgICB0aGlzLl9ldmVudHNEZWxlZ2F0ZWQgPSB0cnVlOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgLy8gSWYgdGhpcyBpcyByZWN1cnN2aWUgZHVlIHRvIGxpc3RlblRvIGRlbGVnYXRlIGJlbG93IHRoZW4gcGFzcyB0aHJvdWdoIHRvIHN1cGVyIGNsYXNzCiAgICBpZiAocGFyYW1zLmhhbmRsZXIuX3Rob3JheEJpbmQpIHsKICAgICAgcmV0dXJuIF9vbi5jYWxsKHRoaXMsIHBhcmFtcy5uYW1lLCBwYXJhbXMuaGFuZGxlciwgcGFyYW1zLmNvbnRleHQgfHwgdGhpcyk7CiAgICB9CgogICAgdmFyIGJvdW5kSGFuZGxlciA9IGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCBwYXJhbXMudHlwZSArICctZXZlbnQ6JywgcGFyYW1zKTsKCiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICAvLyBJZiB3ZSBoYXZlIG91ciBjb250ZXh0IHNldCB0byBhbiBvdXRzaWRlIHZpZXcgdGhlbiBsaXN0ZW4gcmF0aGVyIHRoYW4gZGlyZWN0bHkgYmluZCBzbwogICAgICAvLyB3ZSBjYW4gY2xlYW51cCBwcm9wZXJseS4KICAgICAgaWYgKHBhcmFtcy5jb250ZXh0ICYmIHBhcmFtcy5jb250ZXh0ICE9PSB0aGlzICYmIHBhcmFtcy5jb250ZXh0IGluc3RhbmNlb2YgVGhvcmF4LlZpZXcpIHsKICAgICAgICBsaXN0ZW5UbyhwYXJhbXMuY29udGV4dCwgdGhpcywgcGFyYW1zLm5hbWUsIGJvdW5kSGFuZGxlciwgcGFyYW1zLmNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIsIHBhcmFtcy5jb250ZXh0IHx8IHRoaXMpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQoKICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgIGlmIChwYXJhbXMuc2VsZWN0b3IpIHsKICAgICAgICB0aGlzLiRlbC5vbihuYW1lLCBwYXJhbXMuc2VsZWN0b3IsIGJvdW5kSGFuZGxlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5wcm90b3R5cGUuYmluZCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC5faXNSZWFkeSB8fCBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsICdpbnB1dCcsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIHJldHVybiBoYW5kbGVyKGV2ZW50KTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBiaW5kRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSwgcGFyYW1zKSB7CiAgZXZlbnROYW1lICs9IHBhcmFtcy5vcmlnaW5hbE5hbWU7CgogIHZhciBjYWxsYmFjayA9IHBhcmFtcy5oYW5kbGVyLAogICAgICBtZXRob2QgPSBfLmlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiB0aGlzW2NhbGxiYWNrXTsKICBpZiAoIW1ldGhvZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFdmVudCAiJyArIGNhbGxiYWNrICsgJyIgZG9lcyBub3QgZXhpc3QgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lKTsKICB9CgogIHZhciBjb250ZXh0ID0gcGFyYW1zLmNvbnRleHQgfHwgdGhpcywKICAgICAgcmV0ID0gVGhvcmF4LmJpbmRTZWN0aW9uKAogICAgICAgICd0aG9yYXgtZXZlbnQnLAogICAgICAgIHt2aWV3OiBjb250ZXh0Lm5hbWUgfHwgY29udGV4dC5jaWQsIGV2ZW50TmFtZTogZXZlbnROYW1lfSwKICAgICAgICBfLmJpbmQobWV0aG9kLCBjb250ZXh0KSk7CgogIC8vIEJhY2tib25lIHdpbGwgZGVsZWdhdGUgdG8gX2NhbGxiYWNrIGluIG9mZiBjYWxscyBzbyB3ZSBzaG91bGQgc3RpbGwgYmUgYWJsZSB0byBzdXBwb3J0CiAgLy8gY2FsbGluZyBvZmYgb24gc3BlY2lmaWMgaGFuZGxlcnMuCiAgcmV0Ll9jYWxsYmFjayA9IG1ldGhvZDsKICByZXQuX3Rob3JheEJpbmQgPSB0cnVlOwogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbShuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgdmFyIHBhcmFtcyA9IHsKICAgIG9yaWdpbmFsTmFtZTogbmFtZSwKICAgIGhhbmRsZXI6IF8uaXNTdHJpbmcoaGFuZGxlcikgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zLCB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSAqLwp2YXIgdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctdG1wJywKICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyA9IHt9OwoKLy8gV2lsbCBiZSBzaGFyZWQgYnkgSGVscGVyVmlldyBhbmQgQ29sbGVjdGlvbkhlbHBlclZpZXcKdmFyIGhlbHBlclZpZXdQcm90b3R5cGUgPSB7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9Cn07CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZChoZWxwZXJWaWV3UHJvdG90eXBlKTsKCi8vIEVuc3VyZSBuZXN0ZWQgaW5saW5lIGhlbHBlcnMgd2lsbCBhbHdheXMgaGF2ZSB0aGlzLnBhcmVudAovLyBzZXQgdG8gdGhlIHZpZXcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUKZnVuY3Rpb24gZ2V0UGFyZW50KHBhcmVudCkgewogIC8vIFRoZSBgdmlld2AgaGVscGVyIGlzIGEgc3BlY2lhbCBjYXNlIGFzIGl0IGVtYmVkcwogIC8vIGEgdmlldyBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9uZQogIHdoaWxlIChwYXJlbnQuX2hlbHBlck5hbWUgJiYgcGFyZW50Ll9oZWxwZXJOYW1lICE9PSAndmlldycpIHsKICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgfQogIHJldHVybiBwYXJlbnQ7Cn0KCmZ1bmN0aW9uIGV4cGFuZEhhc2goY29udGV4dCwgaGFzaCkgewogIGlmIChoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICBoYXNoW2tleV0gPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih2YWx1ZSwgY29udGV4dCk7CiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBWaWV3Q2xhc3MsIGNhbGxiYWNrKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIGlmIChWaWV3Q2xhc3MuZmFjdG9yeSkgewogICAgICBjYWxsYmFjayA9IFZpZXdDbGFzcy5jYWxsYmFjazsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzOwogICAgICBWaWV3Q2xhc3MgPSBUaG9yYXguSGVscGVyVmlldzsKICAgIH0KICB9CgogIHZhciB2aWV3T3B0aW9uV2hpdGVMaXN0ID0gVmlld0NsYXNzLmF0dHJpYnV0ZVdoaXRlTGlzdDsKCiAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcihuYW1lLCBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAKICAgIC8vIEV2YWx1YXRlIGFueSBuZXN0ZWQgcGFyYW1ldGVycyB0aGF0IHdlIG1heSBoYXZlIHRvIGNvbnRlbnQgd2l0aAogICAgdmFyIGV4cGFuZFRva2VucyA9IGV4cGFuZEhhc2godGhpcywgb3B0aW9ucy5oYXNoKTsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIGludmVyc2U6IG9wdGlvbnMuaW52ZXJzZSwKICAgICAgb3B0aW9uczogb3B0aW9ucy5oYXNoLAogICAgICBkZWNsYXJpbmdWaWV3OiBkZWNsYXJpbmdWaWV3LAogICAgICBwYXJlbnQ6IGdldFBhcmVudChkZWNsYXJpbmdWaWV3KSwKICAgICAgX2hlbHBlck5hbWU6IG5hbWUsCiAgICAgIF9oZWxwZXJPcHRpb25zOiB7CiAgICAgICAgb3B0aW9uczogY2xvbmVIZWxwZXJPcHRpb25zKG9wdGlvbnMpLAogICAgICAgIGFyZ3M6IF8uY2xvbmUoYXJncykKICAgICAgfQogICAgfTsKCiAgICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5jbG9uZShvcHRpb25zLmhhc2gpOwoKICAgIC8vIFJlbWFwIGFueSB2aWV3IG9wdGlvbnMgcGVyIHRoZSB3aGl0ZWxpc3QgYW5kIHJlbW92ZSB0aGUgc291cmNlIGZvcm0gdGhlIEhUTUwKICAgIF8uZWFjaCh2aWV3T3B0aW9uV2hpdGVMaXN0LCBmdW5jdGlvbihkZXN0LCBzb3VyY2UpIHsKICAgICAgZGVsZXRlIGh0bWxBdHRyaWJ1dGVzW3NvdXJjZV07CiAgICAgIGlmICghXy5pc1VuZGVmaW5lZChvcHRpb25zLmhhc2hbc291cmNlXSkpIHsKICAgICAgICB2aWV3T3B0aW9uc1tkZXN0XSA9IG9wdGlvbnMuaGFzaFtzb3VyY2VdOwogICAgICB9CiAgICB9KTsKICAgIGlmKGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWUpIHsKICAgICAgdmlld09wdGlvbnMudGFnTmFtZSA9IGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWU7CiAgICB9CgogICAgdmlld09wdGlvbnMuYXR0cmlidXRlcyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXR0cnMgPSAoVmlld0NsYXNzLnByb3RvdHlwZSAmJiBWaWV3Q2xhc3MucHJvdG90eXBlLmF0dHJpYnV0ZXMpIHx8IHt9OwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGF0dHJzKSkgewogICAgICAgIGF0dHJzID0gYXR0cnMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBfLmV4dGVuZChhdHRycywgXy5vbWl0KGh0bWxBdHRyaWJ1dGVzLCBbJ3RhZ05hbWUnXSkpOwogICAgICAvLyBiYWNrYm9uZSB3YW50cyAiY2xhc3MiCiAgICAgIGlmIChhdHRycy5jbGFzc05hbWUpIHsKICAgICAgICBhdHRyc1snY2xhc3MnXSA9IGF0dHJzLmNsYXNzTmFtZTsKICAgICAgICBkZWxldGUgYXR0cnMuY2xhc3NOYW1lOwogICAgICB9CiAgICAgIHJldHVybiBhdHRyczsKICAgIH07CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgLy8gT25seSBhc3NpZ24gaWYgcHJlc2VudCwgYWxsb3cgaGVscGVyIHZpZXcgY2xhc3MgdG8KICAgICAgLy8gZGVjbGFyZSB0ZW1wbGF0ZQogICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IG9wdGlvbnMuZm47CiAgICB9IGVsc2UgaWYgKFZpZXdDbGFzcyAmJiBWaWV3Q2xhc3MucHJvdG90eXBlICYmICFWaWV3Q2xhc3MucHJvdG90eXBlLnRlbXBsYXRlKSB7CiAgICAgIC8vIFZpZXdDbGFzcyBtYXkgYWxzbyBiZSBhbiBpbnN0YW5jZSBvciBvYmplY3Qgd2l0aCBmYWN0b3J5IG1ldGhvZAogICAgICAvLyBzbyBuZWVkIHRvIGRvIHRoaXMgY2hlY2sKICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CgogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYW4gZXhpc3RpbmcgaW5zdGFuY2UgdGhhdCB3ZSBjYW4gcmV1c2UKICAgIHZhciBpbnN0YW5jZSA9IF8uZmluZChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHJldHVybiBjb21wYXJlSGVscGVyT3B0aW9ucyh2aWV3T3B0aW9ucywgY2hpbGQpOwogICAgfSk7CgogICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZSBpZiB3ZSBkb24ndCBhbHJlYWR5IGhhdmUgb25lCiAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgIGlmIChWaWV3Q2xhc3MuZmFjdG9yeSkgewogICAgICAgIGluc3RhbmNlID0gVmlld0NsYXNzLmZhY3RvcnkoYXJncywgdmlld09wdGlvbnMpOwogICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CgogICAgICAgIGluc3RhbmNlLl9oZWxwZXJOYW1lID0gdmlld09wdGlvbnMuX2hlbHBlck5hbWU7CiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck9wdGlvbnMgPSB2aWV3T3B0aW9ucy5faGVscGVyT3B0aW9uczsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnN0YW5jZSA9IG5ldyBWaWV3Q2xhc3Modmlld09wdGlvbnMpOwogICAgICB9CiAgICAgIGlmICghaW5zdGFuY2UuZWwpIHsKICAgICAgICAvLyBWaWV3Q2xhc3MuZmFjdG9yeSBtYXkgcmV0dXJuIGV4aXN0aW5nIG9iamVjdHMgd2hpY2ggbWF5IGhhdmUgYmVlbiBkZXN0cm95ZWQKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc2VydC1kZXN0cm95ZWQtZmFjdG9yeScpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgYW55IHBvc3NpYmxlIGVudHJ5IGluIHByZXZpb3VzIGhlbHBlcnMgaW4gY2FzZSB0aGlzIGlzIGEgY2FjaGVkIHZhbHVlIHJldHVybmVkIGZyb20KICAgICAgLy8gc2xpZ2h0bHkgZGlmZmVyZW50IGRhdGEgdGhhdCBkb2VzIG5vdCBxdWFsaWZ5IGZvciB0aGUgcHJldmlvdXMgaGVscGVycyBkaXJlY3QgcmV1c2UuCiAgICAgIC8vIChpLmUuIHdoZW4gdXNpbmcgYW4gYXJyYXkgdGhhdCBpcyBtb2RpZmllZCBiZXR3ZWVuIHJlbmRlcnMpCiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIWluc3RhbmNlLmVsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnNlcnQtZGVzdHJveWVkJyk7CiAgICAgIH0KCiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5jaGlsZHJlbltpbnN0YW5jZS5jaWRdID0gaW5zdGFuY2U7CiAgICB9CgogICAgaHRtbEF0dHJpYnV0ZXNbdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBpbnN0YW5jZS5jaWQ7CiAgICBpZiAoVmlld0NsYXNzLm1vZGlmeUhUTUxBdHRyaWJ1dGVzKSB7CiAgICAgIFZpZXdDbGFzcy5tb2RpZnlIVE1MQXR0cmlidXRlcyhodG1sQXR0cmlidXRlcywgaW5zdGFuY2UpOwogICAgfQogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzLCAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKICB9KTsKICB2YXIgaGVscGVyID0gSGFuZGxlYmFycy5oZWxwZXJzW25hbWVdOwogIHJldHVybiBoZWxwZXI7Cn07CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciBwbGFjZWhvbGRlcklkID0gZWwuZ2V0QXR0cmlidXRlKHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIHZpZXcgPSB0aGlzLmNoaWxkcmVuW3BsYWNlaG9sZGVySWRdOwogICAgaWYgKHZpZXcpIHsKICAgICAgLy9zZWUgaWYgdGhlIHZpZXcgaGVscGVyIGRlY2xhcmVkIGFuIG92ZXJyaWRlIGZvciB0aGUgdmlldwogICAgICAvL2lmIG5vdCwgZW5zdXJlIHRoZSB2aWV3IGhhcyBiZWVuIHJlbmRlcmVkIGF0IGxlYXN0IG9uY2UKICAgICAgaWYgKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSkgewogICAgICAgIHZpZXcucmVuZGVyKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSk7CiAgICAgICAgZGVsZXRlIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIH0KICAgICAgJChlbCkucmVwbGFjZVdpdGgodmlldy5lbCk7CiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKHZpZXcuZWwpOwogICAgfQogIH0sIHRoaXMpOwp9KTsKCgovKioKICogQ2xvbmVzIHRoZSBoZWxwZXIgb3B0aW9ucywgZHJvcHBpbmcgaXRlbXMgdGhhdCBhcmUga25vd24gdG8gY2hhbmdlCiAqIGJldHdlZW4gcmVuZGVyaW5nIGN5Y2xlcyBhcyBhcHByb3ByaWF0ZS4KICovCmZ1bmN0aW9uIGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSB7CiAgdmFyIHJldCA9IF8ucGljayhvcHRpb25zLCAnZm4nLCAnaW52ZXJzZScsICdoYXNoJywgJ2RhdGEnKTsKICByZXQuZGF0YSA9IF8ub21pdChvcHRpb25zLmRhdGEsICdjaWQnLCAndmlldycsICd5aWVsZCcsICdyb290JywgJ19wYXJlbnQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIGlmIChiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG90aGVyID0gYi5vcHRpb25zW2tleV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAhdmFsdWUuZGVwdGggJiYgb3RoZXIucHJvZ3JhbSA9PT0gdmFsdWUucHJvZ3JhbTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWU7CiAgICAgICAgfSk7Cn0KCjs7Ci8qZ2xvYmFsIGdldFZhbHVlLCBpbmhlcml0VmFycywgd2Fsa0luaGVyaXRUcmVlICovCgpmdW5jdGlvbiBkYXRhT2JqZWN0KHR5cGUsIHNwZWMpIHsKICBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV0gPSBfLmRlZmF1bHRzKHsKICAgIG5hbWU6ICdfJyArIHR5cGUgKyAnRXZlbnRzJywKICAgIGV2ZW50OiB0cnVlCiAgfSwgc3BlYyk7CgogIC8vIEFkZCBhIGNhbGxiYWNrIGluIHRoZSB2aWV3IGNvbnN0cnVjdG9yCiAgc3BlYy5jdG9yID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpc1t0eXBlXSkgewogICAgICAvLyBOZWVkIHRvIG51bGwgdGhpcy5tb2RlbC9jb2xsZWN0aW9uIHNvIHNldE1vZGVsL0NvbGxlY3Rpb24gd2lsbAogICAgICAvLyBub3QgdHJlYXQgaXQgYXMgdGhlIG9sZCBtb2RlbC9jb2xsZWN0aW9uIGFuZCBpbW1lZGlhdGVseSByZXR1cm4KICAgICAgdmFyIG9iamVjdCA9IHRoaXNbdHlwZV07CiAgICAgIHRoaXNbdHlwZV0gPSBudWxsOwogICAgICB0aGlzW3NwZWMuc2V0XShvYmplY3QpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICB2YXIgb2xkID0gdGhpc1t0eXBlXSwKICAgICAgICAkZWwgPSBnZXRWYWx1ZSh0aGlzLCBzcGVjLiRlbCk7CgogICAgaWYgKGRhdGFPYmplY3QgPT09IG9sZCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmIChvbGQpIHsKICAgICAgdGhpcy51bmJpbmREYXRhT2JqZWN0KG9sZCk7CiAgICB9CgogICAgaWYgKGRhdGFPYmplY3QpIHsKICAgICAgdGhpc1t0eXBlXSA9IGRhdGFPYmplY3Q7CgogICAgICBpZiAoc3BlYy5sb2FkaW5nKSB7CiAgICAgICAgc3BlYy5sb2FkaW5nLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuYmluZERhdGFPYmplY3QodHlwZSwgZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucykpOwogICAgICAkZWwgJiYgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbCAmJiAkZWwucmVtb3ZlQXR0cihzcGVjLmNpZEF0dHJOYW1lKTsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOmRhdGEtb2JqZWN0JywgdHlwZSwgZGF0YU9iamVjdCwgb2xkKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgVGhvcmF4LlZpZXcucHJvdG90eXBlW3NwZWMuc2V0XSA9IHNldE9iamVjdDsKfQoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgZ2V0T2JqZWN0T3B0aW9uczogZnVuY3Rpb24oZGF0YU9iamVjdCkgewogICAgcmV0dXJuIGRhdGFPYmplY3QgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICB9LAoKICBiaW5kRGF0YU9iamVjdDogZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgaWYgKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IGRhdGFPYmplY3Q7CgogICAgdmFyIG9wdGlvbnMgPSB0aGlzLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyhkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgaW5oZXJpdFZhcnNbdHlwZV0uZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBvcHRpb25zOwoKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzKTsKCiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdOwogICAgc3BlYy5iaW5kQ2FsbGJhY2sgJiYgc3BlYy5iaW5kQ2FsbGJhY2suY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKCiAgICBpZiAoZGF0YU9iamVjdC5zaG91bGRGZXRjaCAmJiBkYXRhT2JqZWN0LnNob3VsZEZldGNoKG9wdGlvbnMpKSB7CiAgICAgIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAvLyB3YW50IHRvIHRyaWdnZXIgYnVpbHQgaW4gcmVuZGVyaW5nIHdpdGhvdXQgdHJpZ2dlcmluZyBldmVudCBvbiBtb2RlbAogICAgICBpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UuY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgdGhpcy5zdG9wTGlzdGVuaW5nKGRhdGFPYmplY3QpOwogICAgZGVsZXRlIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBfbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnM6IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zOwogIH0KfSk7CgpmdW5jdGlvbiBiaW5kRXZlbnRzKHR5cGUsIHRhcmdldCwgc291cmNlKSB7CiAgdmFyIGNvbnRleHQgPSB0aGlzOwogIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsICdfJyArIHR5cGUgKyAnRXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIGxpc3RlblRvKGNvbnRleHQsIHRhcmdldCwgZXZlbnRbMF0sIGV2ZW50WzFdLCBldmVudFsyXSB8fCBjb250ZXh0KTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0gZWxzZSB7CiAgICByZXR1cm4gY29udGV4dFtjYWxsYmFja107CiAgfQp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldFZhbHVlLCBpbmhlcml0VmFycyAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB1bmRlZmluZWQsICAgIC8vIERlZmF1bHQgdG8gZGVmZXJyZWQgcmVuZGVyaW5nCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgaW52YWxpZDogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwsIG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNlcmlhbGl6aW5nKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKG1vZGVsKSB8fCB7fTsKICAvLyAhbW9kZWxPcHRpb25zIHdpbGwgYmUgdHJ1ZSB3aGVuIHNldE1vZGVsKGZhbHNlKSBpcyBjYWxsZWQKICB0aGlzLmNvbmRpdGlvbmFsUmVuZGVyKG1vZGVsT3B0aW9ucy5yZW5kZXIpOwp9CgpUaG9yYXguVmlldy5vbih7CiAgbW9kZWw6IHsKICAgIGludmFsaWQ6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuZ2V0T2JqZWN0T3B0aW9ucyhtb2RlbCkuaW52YWxpZCkgewogICAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIGVycm9ycywgbW9kZWwpOwogICAgICB9CiAgICB9LAogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCByZXNwLCBtb2RlbCk7CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICAvLyBJbmRpcmVjdCByZWZlcm5lY2UgdG8gYWxsb3cgZm9yIG92ZXJyaWRlcwogICAgICBpbmhlcml0VmFycy5tb2RlbC5jaGFuZ2UuY2FsbCh0aGlzLCBtb2RlbCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9KTsKCiQuZm4ubW9kZWwgPSBmdW5jdGlvbih2aWV3KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgbW9kZWxFbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBtb2RlbENpZCA9IG1vZGVsRWxlbWVudCAmJiBtb2RlbEVsZW1lbnQuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChtb2RlbENpZCkgewogICAgdmFyIHZpZXcgPSB2aWV3IHx8ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3ICYmIHZpZXcubW9kZWwgJiYgdmlldy5tb2RlbC5jaWQgPT09IG1vZGVsQ2lkKSB7CiAgICAgIHJldHVybiB2aWV3Lm1vZGVsIHx8IGZhbHNlOwogICAgfQogICAgdmFyIGNvbGxlY3Rpb24gPSAkdGhpcy5jb2xsZWN0aW9uKHZpZXcpOwogICAgaWYgKGNvbGxlY3Rpb24pIHsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZ2V0KG1vZGVsQ2lkKTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgYXNzaWduVmlldywgYXNzaWduVGVtcGxhdGUsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0RXZlbnRDYWxsYmFjaywgZ2V0VmFsdWUsIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKi8KdmFyIF9mZXRjaCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmZldGNoLAogICAgX3NldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnNldCwKICAgIF9yZXBsYWNlSFRNTCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fcmVwbGFjZUhUTUwsCiAgICBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tY2lkJywKICAgIGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVtcHR5JywKICAgIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZWxlbWVudCcsCiAgICBFTEVNRU5UX05PREVfVFlQRSA9IDE7CgpUaG9yYXguQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICBtb2RlbDogVGhvcmF4Lk1vZGVsIHx8IEJhY2tib25lLk1vZGVsLAogIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjb2xsZWN0aW9uJyk7CiAgICByZXR1cm4gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICBzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgdGhpcy5fZmV0Y2hlZCA9ICEhbW9kZWxzOwogICAgcmV0dXJuIF9zZXQuY2FsbCh0aGlzLCBtb2RlbHMsIG9wdGlvbnMpOwogIH0KfSk7CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBnZXRDb2xsZWN0aW9uVmlld3M6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pIHsKICAgIHJldHVybiBfLmZpbHRlcih0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIFRob3JheC5Db2xsZWN0aW9uVmlldykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiAhY29sbGVjdGlvbiB8fCAoY2hpbGQuY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbik7CiAgICB9KTsKICB9LAogIHVwZGF0ZUZpbHRlcjogZnVuY3Rpb24oY29sbGVjdGlvbikgewogICAgXy5pbnZva2UodGhpcy5nZXRDb2xsZWN0aW9uVmlld3MoY29sbGVjdGlvbiksICd1cGRhdGVGaWx0ZXInKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgYmluZENhbGxiYWNrOiBvblNldENvbGxlY3Rpb24sCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdW5kZWZpbmVkLCAgICAvLyBEZWZhdWx0IHRvIGRlZmVycmVkIHJlbmRlcmluZwogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGludmFsaWQ6IHRydWUsCiAgICBjaGFuZ2U6IHRydWUgICAgICAgICAgLy8gV2V0aGVyIG9yIG5vdCB0byByZS1yZW5kZXIgb24gbW9kZWw6Y2hhbmdlCiAgfSwKICBjaGFuZ2U6IG9uQ29sbGVjdGlvblJlc2V0LAogICRlbDogJ2dldENvbGxlY3Rpb25FbGVtZW50JywKICBjaWRBdHRyTmFtZTogY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUKfSk7CgpUaG9yYXguQ29sbGVjdGlvblZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICBfY29sbGVjdGlvblNlbGVjdG9yOiAnWycgKyBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgKyAnXScsCgogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5nZXRPYmplY3RPcHRpb25zKHRoaXMuY29sbGVjdGlvbikgJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNob3VsZFJlbmRlciA9IHRoaXMuc2hvdWxkUmVuZGVyKCk7CgogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKCFzaG91bGRSZW5kZXIpIHsKICAgICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uKCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgY29sbGVjdGlvbiA9IHRoaXMuY29sbGVjdGlvbjsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZmlsdGVyOiB0cnVlCiAgICB9KTsKICAgIC8vaWYgaW5kZXggYXJndW1lbnQgaXMgYSB2aWV3CiAgICBpbmRleCAmJiBpbmRleC5lbCAmJiAoaW5kZXggPSAkZWwuY2hpbGRyZW4oKS5pbmRleE9mKGluZGV4LmVsKSArIDEpOwogICAgLy9pZiBhcmd1bWVudCBpcyBhIHZpZXcsIG9yIGh0bWwgc3RyaW5nCiAgICBpZiAobW9kZWwuZWwgfHwgXy5pc1N0cmluZyhtb2RlbCkpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICAvLyBVc2luZyBjYWxsIGhlcmUgdG8gYXZvaWQgdjggcHJvdG90eXBlIGlubGluZSBvcHRpbWl6YXRpb24gYnVnIHRoYXQgaGVscGVyIHZpZXdzCiAgICAgIC8vIGV4cG9zZSB1bmRlciBBbmRyb2lkIDQuMyAoYXQgbWluaW11bSkKICAgICAgLy8gaHR0cHM6Ly90d2l0dGVyLmNvbS9rcGRlY2tlci9zdGF0dXMvNDIyMTQ5NjM0OTI5MDgyMzcwCiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtLmNhbGwodGhpcywgbW9kZWwsIGluZGV4KTsKICAgIH0KCiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaWYgKGl0ZW1WaWV3LmNpZCkgewogICAgICAgIGl0ZW1WaWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaXRlbVZpZXcpOwogICAgICB9CgogICAgICAvL2lmIHRoZSByZW5kZXJlcidzIG91dHB1dCB3YXNuJ3QgY29udGFpbmVkIGluIGEgdGFnLCB3cmFwIGl0IGluIGEgZGl2CiAgICAgIC8vcGxhaW4gdGV4dCwgb3IgYSBtaXh0dXJlIG9mIHRvcCBsZXZlbCB0ZXh0IG5vZGVzIGFuZCBlbGVtZW50IG5vZGVzCiAgICAgIC8vd2lsbCBnZXQgd3JhcHBlZAogICAgICBpZiAoXy5pc1N0cmluZyhpdGVtVmlldykgJiYgIWl0ZW1WaWV3Lm1hdGNoKC9eXHMqPC9tKSkgewogICAgICAgIGl0ZW1WaWV3ID0gJzxkaXY+JyArIGl0ZW1WaWV3ICsgJzwvZGl2Pic7CiAgICAgIH0KICAgICAgdmFyIGl0ZW1FbGVtZW50ID0gaXRlbVZpZXcuJGVsIHx8ICQoJC50cmltKGl0ZW1WaWV3KSkuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICAgIC8vZmlsdGVyIG91dCB0b3AgbGV2ZWwgd2hpdGVzcGFjZSBub2RlcwogICAgICAgIHJldHVybiB0aGlzLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREVfVFlQRTsKICAgICAgfSk7CgogICAgICBpZiAobW9kZWwpIHsKICAgICAgICBpdGVtRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfQogICAgICB2YXIgcHJldmlvdXNNb2RlbCA9IGluZGV4ID4gMCA/IGNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5jaGlsZHJlbignWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgcHJldmlvdXNNb2RlbC5jaWQgKyAnIl0nKS5sYXN0KCk7CiAgICAgICAgbGFzdC5hZnRlcihpdGVtRWxlbWVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJywgbnVsbCwgZnVuY3Rpb24oZWwpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB9KTsKCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOml0ZW0nLCB0aGlzLCBjb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5maWx0ZXIpIHsKICAgICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpdGVtVmlldzsKICB9LAoKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwoKICAgIC8vIE5PUCBGb3Igdmlld3MKICAgIGlmICh2aWV3RWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucmVtb3ZlSXRlbSh2aWV3RWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAoKICByZW1vdmVJdGVtOiBmdW5jdGlvbihtb2RlbCkgewogICAgdmFyIHZpZXdFbCA9IG1vZGVsOwogICAgaWYgKG1vZGVsLmNpZCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB2aWV3RWwgPSAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJyk7CiAgICB9CiAgICBpZiAoIXZpZXdFbC5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciB2aWV3Q2lkcyA9IHZpZXdFbC5maW5kKCdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nKS5tYXAoZnVuY3Rpb24oaSwgZWwpIHsKICAgICAgcmV0dXJuICQoZWwpLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpOwogICAgfSk7CgogICAgdmlld0VsLnJlbW92ZSgpOwoKICAgIHZpZXdDaWRzLnB1c2godmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpKTsKICAgIF8uZWFjaCh2aWV3Q2lkcywgZnVuY3Rpb24oY2lkKSB7CiAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bY2lkXTsKICAgICAgaWYgKGNoaWxkKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICByZW5kZXJDb2xsZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5pc0VtcHR5KCkpIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIGFzc2lnblZpZXcuY2FsbCh0aGlzLCAnZW1wdHlWaWV3JywgewogICAgICAgIGV4dGVuc2lvbjogJy1lbXB0eScKICAgICAgfSk7CiAgICB9CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVZpZXcpIHsKICAgICAgYXNzaWduVmlldy5jYWxsKHRoaXMsICdpdGVtVmlldycsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgaWYgKCF0aGlzLml0ZW1UZW1wbGF0ZSAmJiAhdGhpcy5pdGVtVmlldykgewogICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHRoaXMsICdpdGVtVGVtcGxhdGUnLCB7CiAgICAgICAgZXh0ZW5zaW9uOiAnLWl0ZW0nLAogICAgICAgIC8vIG9ubHkgcmVxdWlyZSBhbiBpdGVtVGVtcGxhdGUgaWYgYW4gaXRlbVZpZXcKICAgICAgICAvLyBpcyBub3QgcHJlc2VudAogICAgICAgIHJlcXVpcmVkOiAhdGhpcy5pdGVtVmlldwogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLml0ZW1WaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgfTsKICAgICAgaWYgKHRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLml0ZW1UZW1wbGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFVzaW5nIGNhbGwgaGVyZSB0byBhdm9pZCB2OCBwcm90b3R5cGUgaW5saW5lIG9wdGltaXphdGlvbiBidWcgdGhhdCBoZWxwZXIgdmlld3MKICAgICAgLy8gZXhwb3NlIHVuZGVyIEFuZHJvaWQgNC4zIChhdCBtaW5pbXVtKQogICAgICAvLyBodHRwczovL3R3aXR0ZXIuY29tL2twZGVja2VyL3N0YXR1cy80MjIxNDk2MzQ5MjkwODIzNzAKICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5pdGVtVGVtcGxhdGUsIHRoaXMuaXRlbUNvbnRleHQuY2FsbCh0aGlzLCBtb2RlbCwgaSkpOwogICAgfQogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKG1vZGVsIC8qLCBpICovKSB7CiAgICByZXR1cm4gbW9kZWwuYXR0cmlidXRlczsKICB9LAogIGFwcGVuZEVtcHR5OiBmdW5jdGlvbigpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAkZWwuZW1wdHkoKTsKCiAgICAvLyBVc2luZyBjYWxsIGhlcmUgdG8gYXZvaWQgdjggcHJvdG90eXBlIGlubGluZSBvcHRpbWl6YXRpb24gYnVnIHRoYXQgaGVscGVyIHZpZXdzCiAgICAvLyBleHBvc2UgdW5kZXIgQW5kcm9pZCA0LjMgKGF0IG1pbmltdW0pCiAgICAvLyBodHRwczovL3R3aXR0ZXIuY29tL2twZGVja2VyL3N0YXR1cy80MjIxNDk2MzQ5MjkwODIzNzAKICAgIHZhciBlbXB0eUNvbnRlbnQgPSB0aGlzLnJlbmRlckVtcHR5LmNhbGwodGhpcyk7CiAgICBlbXB0eUNvbnRlbnQgJiYgdGhpcy5hcHBlbmRJdGVtKGVtcHR5Q29udGVudCwgMCwgewogICAgICBzaWxlbnQ6IHRydWUsCiAgICAgIGZpbHRlcjogZmFsc2UKICAgIH0pOwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgfSwKICBnZXRDb2xsZWN0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZWxlbWVudCA9IHRoaXMuJCh0aGlzLl9jb2xsZWN0aW9uU2VsZWN0b3IpOwogICAgcmV0dXJuIGVsZW1lbnQubGVuZ3RoID09PSAwID8gdGhpcy4kZWwgOiBlbGVtZW50OwogIH0sCgogIHVwZGF0ZUZpbHRlcjogZnVuY3Rpb24oKSB7CiAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICByZXNldDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBzb3J0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9iamVjdE9wdGlvbnModGhpcy5jb2xsZWN0aW9uKTsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jaGFuZ2UpIHsKICAgICAgICB0aGlzLnVwZGF0ZUl0ZW0obW9kZWwpOwogICAgICB9CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwsIGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5yZW1vdmVJdGVtKG1vZGVsKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGNvbGxlY3Rpb246IHsKICAgIGludmFsaWQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuZ2V0T2JqZWN0T3B0aW9ucyhjb2xsZWN0aW9uKS5pbnZhbGlkKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgbWVzc2FnZSwgY29sbGVjdGlvbik7CiAgICAgIH0KICAgIH0sCiAgICBlcnJvcjogZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgcmVzcCwgY29sbGVjdGlvbik7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICAvLyBVbmRlZmluZWQgdG8gZm9yY2UgY29uZGl0aW9uYWwgcmVuZGVyCiAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9iamVjdE9wdGlvbnMoY29sbGVjdGlvbikgfHwgdW5kZWZpbmVkOwogIGlmICh0aGlzLnNob3VsZFJlbmRlcihvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uICYmIHRoaXMucmVuZGVyQ29sbGVjdGlvbigpOwogIH0KfQoKLy8gRXZlbiBpZiB0aGUgdmlldyBpcyBub3QgYSBDb2xsZWN0aW9uVmlldwovLyBlbnN1cmVSZW5kZXJlZCgpIHRvIHByb3ZpZGUgc2ltaWxhciBiZWhhdmlvcgovLyB0byBhIG1vZGVsCmZ1bmN0aW9uIG9uU2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKSB7CiAgLy8gVW5kZWZpbmVkIHRvIGZvcmNlIGNvbmRpdGlvbmFsIHJlbmRlcgogIHZhciBvcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKGNvbGxlY3Rpb24pIHx8IHVuZGVmaW5lZDsKICBpZiAodGhpcy5zaG91bGRSZW5kZXIob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIC8vIEVuc3VyZSB0aGF0IHNvbWV0aGluZyBpcyB0aGVyZSBpZiB3ZSBhcmUgZ29pbmcgdG8gcmVuZGVyIHRoZSBjb2xsZWN0aW9uLgogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogIH0KfQoKZnVuY3Rpb24gYXBwbHlWaXNpYmlsaXR5RmlsdGVyKCkgewogIGlmICh0aGlzLml0ZW1GaWx0ZXIpIHsKICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGFwcGx5SXRlbVZpc2libGl0eUZpbHRlciwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIC8vIFVzaW5nIGNhbGwgaGVyZSB0byBhdm9pZCB2OCBwcm90b3R5cGUgaW5saW5lIG9wdGltaXphdGlvbiBidWcgdGhhdCBoZWxwZXIgdmlld3MKICAvLyBleHBvc2UgdW5kZXIgQW5kcm9pZCA0LjMgKGF0IG1pbmltdW0pCiAgLy8gaHR0cHM6Ly90d2l0dGVyLmNvbS9rcGRlY2tlci9zdGF0dXMvNDIyMTQ5NjM0OTI5MDgyMzcwCiAgcmV0dXJuIHRoaXMuaXRlbUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsLCB0aGlzLmNvbGxlY3Rpb24uaW5kZXhPZihtb2RlbCkpOwp9CgpmdW5jdGlvbiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5KCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5lbXB0eUNsYXNzICYmICRlbC5yZW1vdmVDbGFzcyh0aGlzLmVtcHR5Q2xhc3MpOwogICRlbC5yZW1vdmVBdHRyKGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUpOwogICRlbC5lbXB0eSgpOwp9CgpmdW5jdGlvbiBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5KCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5lbXB0eUNsYXNzICYmICRlbC5hZGRDbGFzcyh0aGlzLmVtcHR5Q2xhc3MpOwogICRlbC5hdHRyKGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUsIHRydWUpOwogIHRoaXMuYXBwZW5kRW1wdHkoKTsKfQoKLy8kKHNlbGVjdG9yKS5jb2xsZWN0aW9uKCkgaGVscGVyCiQuZm4uY29sbGVjdGlvbiA9IGZ1bmN0aW9uKHZpZXcpIHsKICBpZiAodmlldyAmJiB2aWV3LmNvbGxlY3Rpb24pIHsKICAgIHJldHVybiB2aWV3LmNvbGxlY3Rpb247CiAgfQogIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgIGNvbGxlY3Rpb25FbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIGNvbGxlY3Rpb25DaWQgPSBjb2xsZWN0aW9uRWxlbWVudCAmJiBjb2xsZWN0aW9uRWxlbWVudC5hdHRyKGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lKTsKICBpZiAoY29sbGVjdGlvbkNpZCkgewogICAgdmlldyA9ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3KSB7CiAgICAgIHJldHVybiB2aWV3LmNvbGxlY3Rpb247CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGluaGVyaXRWYXJzICovCgppbmhlcml0VmFycy5tb2RlbC5kZWZhdWx0T3B0aW9ucy5wb3B1bGF0ZSA9IHRydWU7Cgp2YXIgb2xkTW9kZWxDaGFuZ2UgPSBpbmhlcml0VmFycy5tb2RlbC5jaGFuZ2U7CmluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZSA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgdGhpcy5faXNDaGFuZ2luZyA9IHRydWU7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB0aGlzLl9pc0NoYW5naW5nID0gZmFsc2U7CgogIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2VyaWFsaXppbmcpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBwb3B1bGF0ZSA9IHBvcHVsYXRlT3B0aW9ucyh0aGlzKTsKICBpZiAodGhpcy5fcmVuZGVyQ291bnQgJiYgcG9wdWxhdGUpIHsKICAgIHRoaXMucG9wdWxhdGUoIXBvcHVsYXRlLmNvbnRleHQgJiYgdGhpcy5tb2RlbC5hdHRyaWJ1dGVzLCBwb3B1bGF0ZSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgLy9zZXJpYWxpemVzIGEgZm9ybSBwcmVzZW50IGluIHRoZSB2aWV3LCByZXR1cm5pbmcgdGhlIHNlcmlhbGl6ZWQgZGF0YQogIC8vYXMgYW4gb2JqZWN0CiAgLy9wYXNzIHtzZXQ6ZmFsc2V9IHRvIG5vdCB1cGRhdGUgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgLy9jYW4gcGFzcyBvcHRpb25zLCBjYWxsYmFjayBvciBldmVudCBpbiBhbnkgb3JkZXIKICBzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrLCBvcHRpb25zLCBldmVudDsKICAgIC8vaWdub3JlIHVuZGVmaW5lZCBhcmd1bWVudHMgaW4gY2FzZSBldmVudCB3YXMgbnVsbAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgaWYgKCdzdG9wUHJvcGFnYXRpb24nIGluIGFyZ3VtZW50c1tpXSAmJiAncHJldmVudERlZmF1bHQnIGluIGFyZ3VtZW50c1tpXSkgewogICAgICAgICAgZXZlbnQgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGV2ZW50ICYmICF0aGlzLl9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbihldmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNldDogdHJ1ZSwKICAgICAgdmFsaWRhdGU6IHRydWUsCiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0KHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgdmFyIHZhbHVlID0gdmlldy5fZ2V0SW5wdXRWYWx1ZShlbGVtZW50LCBvcHRpb25zLCBlcnJvcnMpOwogICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIGVsZW1lbnQubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmICghb3B0aW9ucy5fc2lsZW50KSB7CiAgICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnQsIHNlcmlhbGl6aW5nOiB0cnVlfSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgdmFsdWUsCiAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgZWFjaE5hbWVkSW5wdXQodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUoYXR0cmlidXRlcywgZWxlbWVudC5uYW1lLCB7bW9kZTogJ3BvcHVsYXRlJ30sIGZ1bmN0aW9uKG9iamVjdCwga2V5KSB7CiAgICAgICAgdmFsdWUgPSBvYmplY3QgJiYgb2JqZWN0W2tleV07CgogICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgdmFyIGlzQmluYXJ5ID0gZWxlbWVudC50eXBlID09PSAnY2hlY2tib3gnIHx8IGVsZW1lbnQudHlwZSA9PT0gJ3JhZGlvJzsKICAgICAgICAgIGlmIChpc0JpbmFyeSAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQmluYXJ5KSB7CiAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlID09IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgICsrdGhpcy5fcG9wdWxhdGVDb3VudDsKICAgIGlmICghb3B0aW9ucy5fc2lsZW50KSB7CiAgICAgIHRoaXMudHJpZ2dlcigncG9wdWxhdGUnLCBhdHRyaWJ1dGVzKTsKICAgIH0KICB9LAoKICAvL3BlcmZvcm0gZm9ybSB2YWxpZGF0aW9uLCBpbXBsZW1lbnRlZCBieSBjaGlsZCBjbGFzcwogIHZhbGlkYXRlSW5wdXQ6IGZ1bmN0aW9uKC8qIGF0dHJpYnV0ZXMsIG9wdGlvbnMsIGVycm9ycyAqLykge30sCgogIF9nZXRJbnB1dFZhbHVlOiBmdW5jdGlvbihpbnB1dCAvKiAsIG9wdGlvbnMsIGVycm9ycyAqLykgewogICAgaWYgKGlucHV0LnR5cGUgPT09ICdjaGVja2JveCcgfHwgaW5wdXQudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBpZiAoaW5wdXQuY2hlY2tlZCkgewogICAgICAgIHJldHVybiBpbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgfHwgdHJ1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpbnB1dC5tdWx0aXBsZSA9PT0gdHJ1ZSkgewogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICQoJ29wdGlvbicsIGlucHV0KS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB2YWx1ZXMucHVzaCh0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgfQogIH0sCgogIF9wb3B1bGF0ZUNvdW50OiAwCn0pOwoKLy8gS2VlcGluZyBzdGF0ZSBpbiB0aGUgdmlld3MKVGhvcmF4LlZpZXcub24oewogICdiZWZvcmU6cmVuZGVyZWQnOiBmdW5jdGlvbigpIHsKICAgIC8vIERvIG5vdCBzdG9yZSBwcmV2aW91cyBvcHRpb25zIGlmIHdlIGhhdmUgbm90IHJlbmRlcmVkIG9yIGlmIHdlIGhhdmUgY2hhbmdlZCB0aGUgYXNzb2NpYXRlZAogICAgLy8gbW9kZWwgc2luY2UgdGhlIGxhc3QgcmVuZGVyCiAgICBpZiAoIXRoaXMuX3JlbmRlckNvdW50IHx8ICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuY2lkKSAhPT0gdGhpcy5fZm9ybU1vZGVsQ2lkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5nZXRPYmplY3RPcHRpb25zKHRoaXMubW9kZWwpOwogICAgLy8gV2hlbiB3ZSBoYXZlIHByZXZpb3VzbHkgcG9wdWxhdGVkIGFuZCByZW5kZXJlZCB0aGUgdmlldywgcmV1c2UgdGhlIHVzZXIgZGF0YQogICAgdGhpcy5wcmV2aW91c0Zvcm1EYXRhID0gZmlsdGVyT2JqZWN0KAogICAgICB0aGlzLnNlcmlhbGl6ZShfLmV4dGVuZCh7IHNldDogZmFsc2UsIHZhbGlkYXRlOiBmYWxzZSwgX3NpbGVudDogdHJ1ZSB9LCBtb2RlbE9wdGlvbnMpKSwKICAgICAgZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPSBudWxsOyB9CiAgICApOwogIH0sCiAgcmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIHBvcHVsYXRlID0gcG9wdWxhdGVPcHRpb25zKHRoaXMpOwoKICAgIGlmIChwb3B1bGF0ZSAmJiAhdGhpcy5faXNDaGFuZ2luZyAmJiAhdGhpcy5fcG9wdWxhdGVDb3VudCkgewogICAgICB0aGlzLnBvcHVsYXRlKCFwb3B1bGF0ZS5jb250ZXh0ICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcywgcG9wdWxhdGUpOwogICAgfQogICAgaWYgKHRoaXMucHJldmlvdXNGb3JtRGF0YSkgewogICAgICB0aGlzLnBvcHVsYXRlKHRoaXMucHJldmlvdXNGb3JtRGF0YSwgXy5leHRlbmQoe19zaWxlbnQ6IHRydWV9LCBwb3B1bGF0ZSkpOwogICAgfQoKICAgIHRoaXMuX2Zvcm1Nb2RlbENpZCA9IHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5jaWQ7CiAgICB0aGlzLnByZXZpb3VzRm9ybURhdGEgPSBudWxsOwogIH0KfSk7CgpmdW5jdGlvbiBmaWx0ZXJPYmplY3Qob2JqZWN0LCBjYWxsYmFjaykgewogIF8uZWFjaChvYmplY3QsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICBpZiAoXy5pc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGZpbHRlck9iamVjdCh2YWx1ZSwgY2FsbGJhY2spOwogICAgfQogICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkgPT09IGZhbHNlKSB7CiAgICAgIGRlbGV0ZSBvYmplY3Rba2V5XTsKICAgIH0KICB9KTsKICByZXR1cm4gb2JqZWN0Owp9CgpUaG9yYXguVmlldy5vbih7CiAgaW52YWxpZDogb25FcnJvck9ySW52YWxpZERhdGEsCiAgZXJyb3I6IG9uRXJyb3JPckludmFsaWREYXRhLAogIGRlYWN0aXZhdGVkOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLiRlbCkgewogICAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uRXJyb3JPckludmFsaWREYXRhICgpIHsKICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogIC8vIElmIHdlIGVycm9yZWQgd2l0aCBhIG1vZGVsIHdlIHdhbnQgdG8gcmVzZXQgdGhlIGNvbnRlbnQgYnV0IGxlYXZlIHRoZSBVSQogIC8vIGludGFjdC4gSWYgdGhlIHVzZXIgdXBkYXRlcyB0aGUgZGF0YSBhbmQgc2VyaWFsaXplcyBhbnkgb3ZlcndyaXR0ZW4gZGF0YQogIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5wcmV2aW91c0F0dHJpYnV0ZXMpIHsKICAgIHRoaXMubW9kZWwuc2V0KHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKCksIHsKICAgICAgc2lsZW50OiB0cnVlCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGVhY2hOYW1lZElucHV0KHZpZXcsIG9wdGlvbnMsIGl0ZXJhdG9yKSB7CiAgdmFyIGkgPSAwOwoKICAkKCdzZWxlY3QsaW5wdXQsdGV4dGFyZWEnLCBvcHRpb25zLnJvb3QgfHwgdmlldy5lbCkuZWFjaChmdW5jdGlvbigpIHsKICAgIGlmICghb3B0aW9ucy5jaGlsZHJlbikgewogICAgICBpZiAodmlldyAhPT0gJCh0aGlzKS52aWV3KHtoZWxwZXI6IGZhbHNlfSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnR5cGUgIT09ICdidXR0b24nICYmIHRoaXMudHlwZSAhPT0gJ2NhbmNlbCcgJiYgdGhpcy50eXBlICE9PSAnc3VibWl0JyAmJiB0aGlzLm5hbWUpIHsKICAgICAgaXRlcmF0b3IodGhpcywgaSk7CiAgICAgICsraTsKICAgIH0KICB9KTsKfQoKLy9jYWxscyBhIGNhbGxiYWNrIHdpdGggdGhlIGNvcnJlY3Qgb2JqZWN0IGZyYWdtZW50IGFuZCBrZXkgZnJvbSBhIGNvbXBvdW5kIG5hbWUKZnVuY3Rpb24gb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgdmFyIGtleSwKICAgICAgb2JqZWN0ID0gYXR0cmlidXRlcywKICAgICAga2V5cyA9IG5hbWUuc3BsaXQoJ1snKSwKICAgICAgbW9kZSA9IG9wdGlvbnMubW9kZTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aCAtIDE7ICsraSkgewogICAga2V5ID0ga2V5c1tpXS5yZXBsYWNlKCddJywgJycpOwogICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICBpZiAobW9kZSA9PT0gJ3NlcmlhbGl6ZScpIHsKICAgICAgICBvYmplY3Rba2V5XSA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjYWxsYmFjayh1bmRlZmluZWQsIGtleSk7CiAgICAgIH0KICAgIH0KICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogIH0KICBrZXkgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV0ucmVwbGFjZSgnXScsICcnKTsKICBjYWxsYmFjayhvYmplY3QsIGtleSk7Cn0KCmZ1bmN0aW9uIHJlc2V0U3VibWl0U3RhdGUoKSB7CiAgdGhpcy4kKCdmb3JtJykucmVtb3ZlQXR0cignZGF0YS1zdWJtaXQtd2FpdCcpOwp9CgpmdW5jdGlvbiBwb3B1bGF0ZU9wdGlvbnModmlldykgewogIHZhciBtb2RlbE9wdGlvbnMgPSB2aWV3LmdldE9iamVjdE9wdGlvbnModmlldy5tb2RlbCkgfHwge307CiAgcmV0dXJuIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwp2YXIgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWxheW91dC1jaWQnOwoKVGhvcmF4LkxheW91dFZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMudGVtcGxhdGUgPT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICAvLyBpZiB0aGVyZSBpcyBubyB0ZW1wbGF0ZSBzZXRWaWV3IHdpbGwgYXBwZW5kIHRvIHRoaXMuJGVsCiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYSB0ZW1wbGF0ZSB3YXMgc3BlY2lmaWVkIGlzIG11c3QgZGVjbGFyZSBhIGxheW91dC1lbGVtZW50CiAgICAgIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmIChfLmlzU3RyaW5nKHZpZXcpKSB7CiAgICAgIHZpZXcgPSBuZXcgKFRob3JheC5VdGlsLnJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgdmlldywgZmFsc2UpKSgpOwogICAgfQogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgdmFyIG9sZFZpZXcgPSB0aGlzLl92aWV3LCBhcHBlbmQsIHJlbW92ZSwgY29tcGxldGU7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OnN0YXJ0Jywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CgogICAgcmVtb3ZlID0gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICBpZiAob2xkVmlldykgewogICAgICAgIG9sZFZpZXcuJGVsICYmIG9sZFZpZXcuJGVsLnJlbW92ZSgpOwogICAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKG9sZFZpZXcsICdkZWFjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKG9sZFZpZXcpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICBhcHBlbmQgPSBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICAgIHRyaWdnZXJMaWZlY3ljbGVFdmVudC5jYWxsKHRoaXMsICdhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5fdmlldy5hcHBlbmRUbyh0YXJnZXRFbGVtZW50KTsKICAgICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl92aWV3ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICBjb21wbGV0ZSA9IF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzplbmQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKICAgIH0sIHRoaXMpOwoKICAgIGlmICghb3B0aW9ucy50cmFuc2l0aW9uKSB7CiAgICAgIHJlbW92ZSgpOwogICAgICBhcHBlbmQoKTsKICAgICAgY29tcGxldGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIG9wdGlvbnMudHJhbnNpdGlvbih2aWV3LCBvbGRWaWV3LCBhcHBlbmQsIHJlbW92ZSwgY29tcGxldGUpOwogICAgfQoKICAgIHJldHVybiB2aWV3OwogIH0sCgogIGdldFZpZXc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXc7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xheW91dC1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIExheW91dFZpZXcKICBpZiAoIXZpZXcuZ2V0VmlldykgewogICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbGF5b3V0LWVsZW1lbnQtaGVscGVyJykpOwogIH0KICBvcHRpb25zLmhhc2hbbGF5b3V0Q2lkQXR0cmlidXRlTmFtZV0gPSB2aWV3LmNpZDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQoZXZlbnROYW1lLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy50YXJnZXQgPSB0aGlzOwogIHRoaXMudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQudHJpZ2dlcihldmVudE5hbWUsIG9wdGlvbnMpOwogIH0pOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLyogZ2xvYmFsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwoKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3ID0gVGhvcmF4LkNvbGxlY3Rpb25WaWV3LmV4dGVuZCh7CiAgLy8gRm9yd2FyZCByZW5kZXIgZXZlbnRzIHRvIHRoZSBwYXJlbnQKICBldmVudHM6IHsKICAgICdyZW5kZXJlZDppdGVtJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDppdGVtJyksCiAgICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6Y29sbGVjdGlvbicpLAogICAgJ3JlbmRlcmVkOmVtcHR5JzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDplbXB0eScpCiAgfSwKCiAgLy8gVGhvcmF4LkNvbGxlY3Rpb25WaWV3IGFsbG93cyBhIGNvbGxlY3Rpb25TZWxlY3RvcgogIC8vIHRvIGJlIHNwZWNpZmllZCwgZGlzYWxsb3cgaW4gYSBjb2xsZWN0aW9uIGhlbHBlcgogIC8vIGFzIGl0IHdpbGwgY2F1c2UgcHJvYmxlbXMgd2hlbiBuZXNldGVkCiAgZ2V0Q29sbGVjdGlvbkVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuJGVsOwogIH0sCgogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAvLyBuZWVkIHRvIGZldGNoIHRlbXBsYXRlcyBpZiB0ZW1wbGF0ZSBuYW1lIHdhcyBwYXNzZWQKICAgIGlmIChvcHRpb25zLm9wdGlvbnNbJ2l0ZW0tdGVtcGxhdGUnXSkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKG9wdGlvbnMub3B0aW9uc1snaXRlbS10ZW1wbGF0ZSddKTsKICAgIH0KICAgIGlmIChvcHRpb25zLm9wdGlvbnNbJ2VtcHR5LXRlbXBsYXRlJ10pIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUob3B0aW9ucy5vcHRpb25zWydlbXB0eS10ZW1wbGF0ZSddKTsKICAgIH0KCiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CgogICAgdmFyIHNob3VsZEJpbmRJdGVtQ29udGV4dCA9IF8uaXNGdW5jdGlvbihvcHRpb25zLml0ZW1Db250ZXh0KSwKICAgICAgICBzaG91bGRCaW5kSXRlbUZpbHRlciA9IF8uaXNGdW5jdGlvbihvcHRpb25zLml0ZW1GaWx0ZXIpOwoKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5IZWxwZXJWaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAKICAgIGlmIChzaG91bGRCaW5kSXRlbUNvbnRleHQpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IF8uYmluZCh0aGlzLml0ZW1Db250ZXh0LCB0aGlzLnBhcmVudCk7CiAgICB9IGVsc2UgaWYgKF8uaXNTdHJpbmcodGhpcy5pdGVtQ29udGV4dCkpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IF8uYmluZCh0aGlzLnBhcmVudFt0aGlzLml0ZW1Db250ZXh0XSwgdGhpcy5wYXJlbnQpOwogICAgfQoKICAgIGlmIChzaG91bGRCaW5kSXRlbUZpbHRlcikgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBfLmJpbmQodGhpcy5pdGVtRmlsdGVyLCB0aGlzLnBhcmVudCk7CiAgICB9IGVsc2UgaWYgKF8uaXNTdHJpbmcodGhpcy5pdGVtRmlsdGVyKSkgewogICAgICB0aGlzLml0ZW1GaWx0ZXIgPSBfLmJpbmQodGhpcy5wYXJlbnRbdGhpcy5pdGVtRmlsdGVyXSwgdGhpcy5wYXJlbnQpOwogICAgfQoKICAgIGlmICh0aGlzLnBhcmVudC5uYW1lKSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVZpZXcgJiYgIXRoaXMucGFyZW50LnJlbmRlckVtcHR5KSB7CiAgICAgICAgdGhpcy5lbXB0eVZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3Q2xhc3ModGhpcy5wYXJlbnQubmFtZSArICctZW1wdHknLCB0cnVlKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5wYXJlbnQucmVuZGVyRW1wdHkpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVmlldyAmJiAhdGhpcy5wYXJlbnQucmVuZGVySXRlbSkgewogICAgICAgIHRoaXMuaXRlbVZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3Q2xhc3ModGhpcy5wYXJlbnQubmFtZSArICctaXRlbScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUgJiYgIXRoaXMucGFyZW50LnJlbmRlckl0ZW0pIHsKICAgICAgICAvLyBpdGVtIHRlbXBsYXRlIG11c3QgYmUgcHJlc2VudCBpZiBhbiBpdGVtVmlldyBpcyBub3QKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCAhIXRoaXMuaXRlbVZpZXcpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oKSB7CiAgICBfLmVhY2goZm9yd2FyZGFibGVQcm9wZXJ0aWVzLCBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CiAgICB9LCB0aGlzKTsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBfLmVhY2goWydpdGVtRmlsdGVyJywgJ2l0ZW1Db250ZXh0JywgJ3JlbmRlckl0ZW0nLCAncmVuZGVyRW1wdHknXSwgZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIGlmIChzZWxmLnBhcmVudFtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgc2VsZltwcm9wZXJ0eU5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc2VsZi5wYXJlbnRbcHJvcGVydHlOYW1lXS5hcHBseShzZWxmLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgaGVscGVyVmlld1Byb3RvdHlwZSk7CgoKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LmF0dHJpYnV0ZVdoaXRlTGlzdCA9IHsKICAnaXRlbS1jb250ZXh0JzogJ2l0ZW1Db250ZXh0JywKICAnaXRlbS1maWx0ZXInOiAnaXRlbUZpbHRlcicsCiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Owp9Cgp2YXIgZm9yd2FyZGFibGVQcm9wZXJ0aWVzID0gWwogICdpdGVtVGVtcGxhdGUnLAogICdpdGVtVmlldycsCiAgJ2VtcHR5VGVtcGxhdGUnLAogICdlbXB0eVZpZXcnCl07CgpmdW5jdGlvbiBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5KHByb3BlcnR5TmFtZSkgewogIHZhciBwYXJlbnQgPSBnZXRQYXJlbnQodGhpcyk7CiAgaWYgKCF0aGlzW3Byb3BlcnR5TmFtZV0pIHsKICAgIHZhciBwcm9wID0gcGFyZW50W3Byb3BlcnR5TmFtZV07CiAgICBpZiAocHJvcCl7CiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHByb3A7CiAgICB9CiAgfQp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignY29sbGVjdGlvbicsIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldywgZnVuY3Rpb24oY29sbGVjdGlvbiwgdmlldykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSB2aWV3LnBhcmVudC5jb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiAmJiB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogICAgLy8gcHJvcGFnYXRlIGZ1dHVyZSBjaGFuZ2VzIHRvIHRoZSBwYXJlbnQncyBjb2xsZWN0aW9uIG9iamVjdAogICAgLy8gdG8gdGhlIGhlbHBlciB2aWV3CiAgICB2aWV3Lmxpc3RlblRvKHZpZXcucGFyZW50LCAnY2hhbmdlOmRhdGEtb2JqZWN0JywgZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCkgewogICAgICBpZiAodHlwZSA9PT0gJ2NvbGxlY3Rpb24nKSB7CiAgICAgICAgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICAgICAgdmlldy5zZXRDb2xsZWN0aW9uKGRhdGFPYmplY3QpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29sbGVjdGlvbiAmJiB2aWV3LnNldENvbGxlY3Rpb24oY29sbGVjdGlvbik7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY29sbGVjdGlvbi1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIGlmICghZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJDb2xsZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCdjb2xsZWN0aW9uLWVsZW1lbnQtaGVscGVyJykpOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgaGFzaFtjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBoYXNoLCAnJywgdGhpcykpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VtcHR5JywgZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gZGF0YU9iamVjdDsKICB9CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBkYXRhT2JqZWN0ID0gdmlldy5tb2RlbDsKICB9CiAgLy8gbGlzdGVuZXJzIGZvciB0aGUgZW1wdHkgaGVscGVyIHJhdGhlciB0aGFuIGxpc3RlbmVycwogIC8vIHRoYXQgYXJlIHRoZW1zZWx2ZXMgZW1wdHkKICBpZiAoIXZpZXcuX2VtcHR5TGlzdGVuZXJzKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVycyA9IHt9OwogIH0KICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIGNvbGxlY3Rpb24KICBpZiAoZGF0YU9iamVjdCAmJiAhdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdICYmIGRhdGFPYmplY3QubW9kZWxzICYmICgnbGVuZ3RoJyBpbiBkYXRhT2JqZWN0KSkgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdID0gdHJ1ZTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3JlbW92ZScsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDApIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3Jlc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICB9KTsKICB9CiAgcmV0dXJuICFkYXRhT2JqZWN0IHx8IGRhdGFPYmplY3QuaXNFbXB0eSgpID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB1cmwgPSB1cmwgfHwgJyc7CgogIHZhciBmcmFnbWVudDsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgIGZyYWdtZW50ID0gXy5tYXAoXy5oZWFkKGFyZ3VtZW50cywgYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBlbmNvZGVVUklDb21wb25lbnQpLmpvaW4oJy8nKTsKICB9IGVsc2UgewogICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHNbMV0sCiAgICAgICAgaGFzaCA9IChvcHRpb25zICYmIG9wdGlvbnMuaGFzaCkgfHwgb3B0aW9uczsKICAgIGlmIChoYXNoICYmIGhhc2hbJ2V4cGFuZC10b2tlbnMnXSkgewogICAgICBmcmFnbWVudCA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHVybCwgdGhpcywgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBmcmFnbWVudCA9IHVybDsKICAgIH0KICB9CiAgaWYgKEJhY2tib25lLmhpc3RvcnkuX2hhc1B1c2hTdGF0ZSkgewogICAgdmFyIHJvb3QgPSBCYWNrYm9uZS5oaXN0b3J5Lm9wdGlvbnMucm9vdDsKICAgIGlmIChyb290ID09PSAnLycgJiYgZnJhZ21lbnQuc3Vic3RyKDAsIDEpID09PSAnLycpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHJvb3QgKyBmcmFnbWVudDsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuICcjJyArIGZyYWdtZW50OwogIH0KfSk7Cgo7OwovKmdsb2JhbCB2aWV3VGVtcGxhdGVPdmVycmlkZXMsIGNyZWF0ZUVycm9yTWVzc2FnZSAqLwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcigndmlldycsIHsKICBmYWN0b3J5OiBmdW5jdGlvbihhcmdzLCBvcHRpb25zKSB7CiAgICB2YXIgVmlldyA9IGFyZ3MubGVuZ3RoID49IDEgPyBhcmdzWzBdIDogVGhvcmF4LlZpZXc7CiAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKFZpZXcsIG9wdGlvbnMub3B0aW9ucyk7CiAgfSwKICAvLyBlbnN1cmUgZ2VuZXJhdGVkIHBsYWNlaG9sZGVyIHRhZyBpbiB0ZW1wbGF0ZQogIC8vIHdpbGwgbWF0Y2ggdGFnIG9mIHZpZXcgaW5zdGFuY2UKICBtb2RpZnlIVE1MQXR0cmlidXRlczogZnVuY3Rpb24oaHRtbEF0dHJpYnV0ZXMsIGluc3RhbmNlKSB7CiAgICBodG1sQXR0cmlidXRlcy50YWdOYW1lID0gaW5zdGFuY2UuZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogIH0sCiAgY2FsbGJhY2s6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CiAgICAvLyB2aWV3IHdpbGwgYmUgdGhlIGFyZ3VtZW50IHBhc3NlZCB0byB0aGUgaGVscGVyLCBpZiBpdCB3YXMKICAgIC8vIGEgc3RyaW5nLCBhIG5ldyBpbnN0YW5jZSB3YXMgY3JlYXRlZCBvbiB0aGUgZmx5LCBvayB0byBwYXNzCiAgICAvLyBoYXNoIGFyZ3VtZW50cywgb3RoZXJ3aXNlIG5lZWQgdG8gdGhyb3cgYXMgdGVtcGxhdGVzIHNob3VsZAogICAgLy8gbm90IGludHJvZHVjZSBzaWRlIGVmZmVjdHMgdG8gZXhpc3RpbmcgdmlldyBpbnN0YW5jZXMKICAgIGlmICghXy5pc1N0cmluZyh2aWV3KSAmJiBvcHRpb25zLmhhc2ggJiYgXy5rZXlzKG9wdGlvbnMuaGFzaCkubGVuZ3RoID4gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCd2aWV3LWhlbHBlci1oYXNoLWFyZ3MnKSk7CiAgICB9CiAgICBpZiAob3B0aW9ucy5mbikgewogICAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0gPSBvcHRpb25zLmZuOwogICAgfQogIH0KfSk7Cgo7OwovKiBnbG9iYWwgY3JlYXRlRXJyb3JNZXNzYWdlICovCgp2YXIgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jYWxsLW1ldGhvZCcsCiAgICB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdHJpZ2dlci1ldmVudCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdidXR0b24nLCBmdW5jdGlvbihtZXRob2QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IG1ldGhvZDsKICAgIG1ldGhvZCA9IG9wdGlvbnMuaGFzaC5tZXRob2Q7CiAgfQogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIW1ldGhvZCAmJiAhb3B0aW9ucy5oYXNoLnRyaWdnZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2J1dHRvbi10cmlnZ2VyJykpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2J1dHRvbic7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIG1ldGhvZCAmJiAoaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSBtZXRob2QpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xpbmsnLCBmdW5jdGlvbigpIHsKICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgLy8gdXJsIGlzIGFuIGFycmF5IHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHVybCBoZWxwZXIKICAgICAgdXJsID0gYXJncy5sZW5ndGggPT09IDAgPyBbaGFzaC5ocmVmXSA6IGFyZ3MsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghdXJsWzBdICYmIHVybFswXSAhPT0gJycpIHsKICAgIHRocm93IG5ldyBFcnJvcihjcmVhdGVFcnJvck1lc3NhZ2UoJ2xpbmstaHJlZicpKTsKICB9CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgdXJsLnB1c2gob3B0aW9ucyk7CiAgaGFzaC5ocmVmID0gSGFuZGxlYmFycy5oZWxwZXJzLnVybC5hcHBseSh0aGlzLCB1cmwpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgdmlldyA9ICR0aGlzLnZpZXcoe2hlbHBlcjogZmFsc2V9KSwKICAgICAgbWV0aG9kTmFtZSA9ICR0aGlzLmF0dHIoY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUpLAogICAgICBldmVudE5hbWUgPSAkdGhpcy5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0aGlzLnRhZ05hbWUgPT09ICdBJyAmJiBtZXRob2RSZXNwb25zZSA9PT0gZmFsc2UgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKdmFyIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWU7CgpmdW5jdGlvbiByZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSA9IFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lIHx8ICdjbGljayc7CiAgJChkb2N1bWVudCkub24obGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgpmdW5jdGlvbiB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgJiYgJChkb2N1bWVudCkub2ZmKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgaWYgKCFUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSkgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0pOwoKOzsKdmFyIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1lbGVtZW50LXRtcCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbGVtZW50JywgZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgb3B0aW9ucy5oYXNoW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcob3B0aW9ucy5oYXNoKSk7Cn0pOwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgJGVsID0gJChlbCksCiAgICAgICAgY2lkID0gJGVsLmF0dHIoZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSksCiAgICAgICAgZWxlbWVudCA9IHRoaXMuX2VsZW1lbnRzQnlDaWRbY2lkXTsKICAgIC8vIEEgY2FsbGJhY2sgZnVuY3Rpb24gbWF5IGJlIHNwZWNpZmllZCBhcyB0aGUgdmFsdWUKICAgIGlmIChfLmlzRnVuY3Rpb24oZWxlbWVudCkpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgICRlbC5yZXBsYWNlV2l0aChlbGVtZW50KTsKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVsZW1lbnQpOwogIH0sIHRoaXMpOwp9KTsKCjs7Ci8qIGdsb2JhbCBjcmVhdGVFcnJvck1lc3NhZ2UgKi8KCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1cGVyJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgcGFyZW50ID0gZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3RvciAmJiBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yLl9fc3VwZXJfXzsKICBpZiAocGFyZW50KSB7CiAgICB2YXIgdGVtcGxhdGUgPSBwYXJlbnQudGVtcGxhdGU7CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmICghcGFyZW50Lm5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JNZXNzYWdlKCdzdXBlci1wYXJlbnQnKSk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBwYXJlbnQubmFtZTsKICAgIH0KICAgIGlmIChfLmlzU3RyaW5nKHRlbXBsYXRlKSkgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRlbXBsYXRlLCBmYWxzZSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycywgY3JlYXRlRXJyb3JNZXNzYWdlICovCgp2YXIgbG9hZFN0YXJ0ID0gJ2xvYWQ6c3RhcnQnLAogICAgbG9hZEVuZCA9ICdsb2FkOmVuZCcsCiAgICByb290T2JqZWN0OwoKVGhvcmF4LnNldFJvb3RPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICByb290T2JqZWN0ID0gb2JqOwp9OwoKVGhvcmF4LmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgY29udGV4dCkgewogIHZhciBsb2FkQ291bnRlciA9IF8udW5pcXVlSWQoJ2xvYWQnKTsKICByZXR1cm4gZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICB2YXIgc2VsZiA9IGNvbnRleHQgfHwgdGhpczsKICAgIHNlbGYuX2xvYWRJbmZvID0gc2VsZi5fbG9hZEluZm8gfHwge307CiAgICB2YXIgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl07CgogICAgZnVuY3Rpb24gc3RhcnRMb2FkVGltZW91dCgpIHsKCiAgICAgIC8vIElmIHRoZSB0aW1lb3V0IGhhcyBiZWVuIHNldCBhbHJlYWR5IGJ1dCBoYXMgbm90IHRyaWdnZXJlZCB5ZXQgZG8gbm90aGluZwogICAgICAvLyBPdGhlcndpc2Ugc2V0IGEgbmV3IHRpbWVvdXQgKGVpdGhlciBpbml0aWFsIG9yIGZvciBnb2luZyBmcm9tIGJhY2tncm91bmQgdG8KICAgICAgLy8gbm9uLWJhY2tncm91bmQgbG9hZGluZykKICAgICAgaWYgKGxvYWRJbmZvLnRpbWVvdXQgJiYgIWxvYWRJbmZvLnJ1bikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxvYWRpbmdUaW1lb3V0ID0gc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiAhPT0gdW5kZWZpbmVkID8KICAgICAgICBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uIDogVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dER1cmF0aW9uOwogICAgICBsb2FkSW5mby50aW1lb3V0ID0gc2V0VGltZW91dCgKICAgICAgICAgIFRob3JheC5iaW5kU2VjdGlvbignbG9hZC1zdGFydCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBXZSBoYXZlIGEgc2xpZ2h0IHJhY2UgY29uZHRpb24gaW4gaGVyZSB3aGVyZSB0aGUgZW5kIGV2ZW50IG1heSBoYXZlIG9jY3VycmVkCiAgICAgICAgICAgIC8vIGJ1dCB0aGUgZW5kIHRpbWVvdXQgaGFzIG5vdCBleGVjdXRlZC4gUmF0aGVyIHRoYW4ga2lsbGluZyBhIGN1bXVsYXRpdmUgdGltZW91dAogICAgICAgICAgICAvLyBpbW1lZGlhdGVseSB3ZSdsbCBwcm90ZWN0IGZyb20gdGhhdCBjYXNlIGhlcmUKICAgICAgICAgICAgaWYgKGxvYWRJbmZvLmV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICAgIHN0YXJ0LmNhbGwoc2VsZiwgbG9hZEluZm8ubWVzc2FnZSwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgaXNMb2FkaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBsb2FkSW5mby5ldmVudHMubGVuZ3RoOwogICAgICAgIH0sCgogICAgICAgIGNpZDogbG9hZENvdW50ZXIsCiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBQcmV2ZW50IGJpbmRzIHRvIHRoZSBzYW1lIG9iamVjdCBtdWx0aXBsZSB0aW1lcyBhcyB0aGlzIGNhbiBjYXVzZSB2ZXJ5IGJhZCB0aGluZ3MKICAgIC8vIHRvIGhhcHBlbiBmb3IgdGhlIGxvYWQ7bG9hZDtlbmQ7ZW5kIGV4ZWN1dGlvbiBmbG93LgogICAgaWYgKF8uaW5kZXhPZihsb2FkSW5mby5ldmVudHMsIG9iamVjdCkgPj0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKCiAgICBvYmplY3Qub24obG9hZEVuZCwgZnVuY3Rpb24gZW5kQ2FsbGJhY2soKSB7CiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IF8uaW5kZXhPZihldmVudHMsIG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwICYmICFvYmplY3QuaXNMb2FkaW5nKCkpIHsKICAgICAgICBldmVudHMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgaWYgKF8uaW5kZXhPZihldmVudHMsIG9iamVjdCkgPCAwKSB7CiAgICAgICAgICAvLyBMYXN0IGNhbGxiYWNrIGZvciB0aGlzIHBhcnRpY2xhciBvYmplY3QsIHJlbW92ZSB0aGUgYmluZAogICAgICAgICAgb2JqZWN0Lm9mZihsb2FkRW5kLCBlbmRDYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoCiAgICAgICAgICBUaG9yYXguYmluZFNlY3Rpb24oJ2xvYWQtZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChsb2FkSW5mby5ydW4pIHsKICAgICAgICAgICAgICAgIC8vIEVtaXQgdGhlIGVuZCBiZWhhdmlvciwgYnV0IG9ubHkgaWYgdGhlcmUgaXMgYSBwYWlyZWQgc3RhcnQKICAgICAgICAgICAgICAgIGVuZCAmJiBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSksCiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgKiAxMDAwKTsKICAgICAgfQogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBIZWxwZXIgbWV0aG9kIGZvciBwcm9wYWdhdGluZyBsb2FkOnN0YXJ0IGV2ZW50cyB0byBvdGhlciBvYmplY3RzLgogKgogKiBGb3J3YXJkcyBsb2FkOnN0YXJ0IGV2ZW50cyB0aGF0IG9jY3VyIG9uIGBzb3VyY2VgIHRvIGBkZXN0YC4KICovClRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyA9IGZ1bmN0aW9uKHNvdXJjZSwgZGVzdCwgb25jZSkgewogIGZ1bmN0aW9uIGxvYWQobWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpIHsKICAgIGlmIChvbmNlKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICAgIGRlc3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KTsKICB9CiAgc291cmNlLm9uKGxvYWRTdGFydCwgbG9hZCk7CiAgcmV0dXJuIHsKICAgIG9mZjogZnVuY3Rpb24oKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICB9Owp9OwoKLy8KLy8gRGF0YSBsb2FkIGV2ZW50IGdlbmVyYXRpb24KLy8KCi8qKgogKiBNaXhpbmcgZm9yIGdlbmVyYXRpbmcgbG9hZDpzdGFydCBhbmQgbG9hZDplbmQgZXZlbnRzLgogKi8KVGhvcmF4Lm1peGluTG9hZGFibGUgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgLy9sb2FkaW5nIGNvbmZpZwogICAgX2xvYWRpbmdDbGFzc05hbWU6ICdsb2FkaW5nJywKICAgIF9sb2FkaW5nVGltZW91dER1cmF0aW9uOiAwLjMzLAogICAgX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb246IDAuMTAsCgogICAgLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgogICAgb25Mb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgdGhhdC5faXNMb2FkaW5nID0gdHJ1ZTsKICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcnMKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdzdGFydCcsIGJhY2tncm91bmQpOwogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IGZhbHNlOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVyCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnZW5kJyk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBfbG9hZENvdW50OiAwLAoKICAgIGlzTG9hZGluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9sb2FkQ291bnQgPiAwOwogICAgfSwKCiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdGhpcy5fbG9hZENvdW50Kys7CgogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgdGhhdCk7CiAgICB9LAogICAgbG9hZEVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2xvYWRDb3VudC0tOwoKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkRW5kLCB0aGF0KTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5WaWV3LnByb3RvdHlwZSk7ClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5WaWV3LnByb3RvdHlwZSk7CgoKaWYgKFRob3JheC5IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgppZiAoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgLy8gRGVmZXIgaGVyZSB0byBtYWludGFpbiBhc3luYyBjYWxsYmFjayBiZWhhdmlvciBmb3IgYWxsIGxvYWRpbmcgY2FzZXMKICAgIHJldHVybiBfLmRlZmVyKGNhbGxiYWNrLCB0aGlzKTsKICB9CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmdW5jdGlvbigpIHsKICAgICAgc3VjY2Vzc0NhbGxiYWNrLmNhbmNlbCgpOwogICAgICBpZiAoIXJvdXRlQ2hhbmdlZCAmJiBmYWlsYmFjaykgewogICAgICAgIGZhaWxiYWNrLmFwcGx5KHNlbGYsIFt0cnVlXS5jb25jYXQoXy50b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgfQogICAgfQogIH0sIG9wdGlvbnMpKTsKfQoKZnVuY3Rpb24gZmV0Y2hRdWV1ZShvcHRpb25zLCAkc3VwZXIpIHsKICBpZiAob3B0aW9ucy5yZXNldFF1ZXVlKSB7CiAgICAvLyBXQVJOOiBTaG91bGQgZW5zdXJlIHRoYXQgbG9hZGVycyBhcmUgcHJvdGVjdGVkIGZyb20gb3V0IG9mIGJhbmQgZGF0YQogICAgLy8gICAgd2hlbiB1c2luZyB0aGlzIG9wdGlvbgogICAgdGhpcy5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogIH0gZWxzZSBpZiAodGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBjb25jdXJyZW50IHNldC9yZXNldCBmZXRjaCBldmVudHMgYXJlIG5vdCBhZHZpc2VkCiAgICB2YXIgcmVzZXQgPSAodGhpcy5mZXRjaFF1ZXVlWzBdIHx8IHt9KS5yZXNldDsKICAgIGlmIChyZXNldCAhPT0gb3B0aW9ucy5yZXNldCkgewogICAgICAvLyBmZXRjaCB3aXRoIGNvbmN1cnJlbnQgc2V0ICYgcmVzZXQgbm90IGFsbG93ZWQKICAgICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZUVycm9yTWVzc2FnZSgnbWl4ZWQtZmV0Y2gnKSk7CiAgICB9CiAgfQoKICBpZiAoIXRoaXMuZmV0Y2hRdWV1ZSkgewogICAgLy8gS2ljayBvZmYgdGhlIHJlcXVlc3QKICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IFtvcHRpb25zXTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHsKICAgICAgc3VjY2VzczogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdzdWNjZXNzJyksCiAgICAgIGVycm9yOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2Vycm9yJyksCiAgICAgIGNvbXBsZXRlOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2NvbXBsZXRlJykKICAgIH0sIG9wdGlvbnMpOwoKICAgIC8vIEhhbmRsZSBjYWxsZXJzIHRoYXQgZG8gbm90IHBhc3MgaW4gYSBzdXBlciBjbGFzcyBhbmQgd2lzaCB0byBpbXBsZW1lbnQgdGhlaXIgb3duCiAgICAvLyBmZXRjaCBiZWhhdmlvcgogICAgaWYgKCRzdXBlcikgewogICAgICB2YXIgcHJvbWlzZSA9ICRzdXBlci5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAodGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAgICAgLy8gZW5zdXJlIHRoZSBmZXRjaFF1ZXVlIGhhcyBub3QgYmVlbiBjbGVhcmVkIG91dCAtIGh0dHBzOi8vZ2l0aHViLmNvbS93YWxtYXJ0bGFicy90aG9yYXgvaXNzdWVzLzMwNAogICAgICAgIC8vIFRoaXMgY2FuIG9jY3VyIGluIHNvbWUgZW52aXJvbm1lbnRzIGlmIHRoZSByZXF1ZXN0IGZhaWxzIHN5bmMgdG8gdGhpcyBjYWxsLCBjYXVzaW5nIHRoZSAKICAgICAgICAvLyBlcnJvciBoYW5kbGVyIHRvIGNsZWFyIG91dCB0aGUgZmV0Y2hRdWV1ZSBiZWZvcmUgd2UgZ2V0IHRvIHRoaXMgcG9pbnQuCiAgICAgICAgdGhpcy5mZXRjaFF1ZXVlLl9wcm9taXNlID0gcHJvbWlzZTsKICAgICAgfQogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBDdXJyZW50bHkgZmV0Y2hpbmcuIFF1ZXVlIGFuZCBwcm9jZXNzIG9uY2UgY29tcGxldGUKICAgIHRoaXMuZmV0Y2hRdWV1ZS5wdXNoKG9wdGlvbnMpOwogICAgcmV0dXJuIHRoaXMuZmV0Y2hRdWV1ZS5fcHJvbWlzZTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKERhdGFDbGFzcyA9PT0gVGhvcmF4LkNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoIV8uZmluZChbJ3Jlc2V0JywgJ3JlbW92ZScsICdhZGQnLCAndXBkYXRlJ10sIGZ1bmN0aW9uKGtleSkgeyByZXR1cm4gIV8uaXNVbmRlZmluZWQob3B0aW9uc1trZXldKTsgfSkpIHsKICAgICAgICAgIC8vIHVzZSBiYWNrYm9uZSA8IDEuMCBiZWhhdmlvciB0byBhbGxvdyB0cmlnZ2VyaW5nIG9mIHJlc2V0IGV2ZW50cwogICAgICAgICAgb3B0aW9ucy5yZXNldCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMubG9hZFRyaWdnZXJlZCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgZnVuY3Rpb24gZW5kV3JhcHBlcihtZXRob2QpIHsKICAgICAgICAgIHZhciAkc3VwZXIgPSBvcHRpb25zW21ldGhvZF07CiAgICAgICAgICBvcHRpb25zW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5sb2FkRW5kKCk7CiAgICAgICAgICAgICRzdXBlciAmJiAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBlbmRXcmFwcGVyKCdzdWNjZXNzJyk7CiAgICAgICAgZW5kV3JhcHBlcignZXJyb3InKTsKICAgICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmICFfLmlzRnVuY3Rpb24oZmFpbGJhY2spKSB7CiAgICAgICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBpZiAoIW9wdGlvbnMuYmFja2dyb3VuZCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpICYmIHJvb3RPYmplY3QpIHsKICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZ2xvYmFsIHNjb3BlIHNlZXMgdGhlIHByb3BlciBsb2FkIGV2ZW50cyBoZXJlCiAgICAgICAgLy8gaWYgd2UgYXJlIGxvYWRpbmcgaW4gc3RhbmRhbG9uZSBtb2RlCiAgICAgICAgaWYgKHRoaXMuaXNMb2FkaW5nKCkpIHsKICAgICAgICAgIC8vIHRyaWdnZXIgZGlyZWN0bHkgYmVjYXVzZSBsb2FkOnN0YXJ0IGhhcyBhbHJlYWR5IGJlZW4gdHJpZ2dlcmVkCiAgICAgICAgICByb290T2JqZWN0LnRyaWdnZXIobG9hZFN0YXJ0LCBvcHRpb25zLm1lc3NhZ2UsIG9wdGlvbnMuYmFja2dyb3VuZCwgdGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGxvYWREYXRhLmNhbGwodGhpcywgY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKTsKICAgIH0KICB9KTsKfSk7CgpUaG9yYXguVXRpbC5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwoKLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgpUaG9yYXguVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKLy8gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3IGluaGVyaXRzIGZyb20gQ29sbGVjdGlvblZpZXcKLy8gbm90IEhlbHBlclZpZXcgc28gbmVlZCB0byBzZXQgaXQgbWFudWFsbHkKVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldyk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldykgewogIF8uZXh0ZW5kKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5hdHRyaWJ1dGVXaGl0ZUxpc3QsIHsKICAgICdsb2FkaW5nLXRlbXBsYXRlJzogJ2xvYWRpbmdUZW1wbGF0ZScsCiAgICAnbG9hZGluZy12aWV3JzogJ2xvYWRpbmdWaWV3JywKICAgICdsb2FkaW5nLXBsYWNlbWVudCc6ICdsb2FkaW5nUGxhY2VtZW50JwogIH0pOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ2xvYWQ6c3RhcnQnOiBUaG9yYXgubG9hZEhhbmRsZXIoCiAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkU3RhcnQobWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRFbmQob2JqZWN0KTsKICAgICAgfSksCgogIGNvbGxlY3Rpb246IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfSwKICBtb2RlbDogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgdmlldy5vZmYoJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHZpZXcub24oJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHJldHVybiB2aWV3Ll9pc0xvYWRpbmcgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCmZ1bmN0aW9uIG9uTG9hZFN0YXRlQ2hhbmdlKCkgewogIHRoaXMucmVuZGVyKCk7Cn0KOzsKLypnbG9iYWwgcHVzaERvbUV2ZW50cyAqLwp2YXIgaXNpT1MgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oaVBob25lfGlQb2R8aVBhZCkvaSksCiAgICBpc0FuZHJvaWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYW5kcm9pZCIpID4gLTEgPyAxIDogMCwKICAgIG1pbmltdW1TY3JvbGxZT2Zmc2V0ID0gaXNBbmRyb2lkID8gMSA6IDA7CgpUaG9yYXguVXRpbC5zY3JvbGxUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICB5ID0geSB8fCBtaW5pbXVtU2Nyb2xsWU9mZnNldDsKICBmdW5jdGlvbiBfc2Nyb2xsVG8oKSB7CiAgICB3aW5kb3cuc2Nyb2xsVG8oeCwgeSk7CiAgfQogIGlmIChpc2lPUykgewogICAgLy8gYSBkZWZlciBpcyByZXF1aXJlZCBmb3IgaW9zCiAgICBfLmRlZmVyKF9zY3JvbGxUbyk7CiAgfSBlbHNlIHsKICAgIF9zY3JvbGxUbygpOwogIH0KICByZXR1cm4gW3gsIHldOwp9OwoKVGhvcmF4LkxheW91dFZpZXcub24oJ2NoYW5nZTp2aWV3OmVuZCcsIGZ1bmN0aW9uKG5ld1ZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpIHsKICBvcHRpb25zICYmIG9wdGlvbnMuc2Nyb2xsICYmIFRob3JheC5VdGlsLnNjcm9sbFRvKDAsIDApOwp9KTsKClRob3JheC5VdGlsLnNjcm9sbFRvVG9wID0gZnVuY3Rpb24oKSB7CiAgLy8gYW5kcm9pZCB3aWxsIHVzZSBoZWlnaHQgb2YgMSBiZWNhdXNlIG9mIG1pbmltdW1TY3JvbGxZT2Zmc2V0IGluIHNjcm9sbFRvKCkKICByZXR1cm4gdGhpcy5zY3JvbGxUbygwLCAwKTsKfTsKCnB1c2hEb21FdmVudHMoWwogICdzaW5nbGVUYXAnLCAnZG91YmxlVGFwJywgJ2xvbmdUYXAnLAogICdzd2lwZScsCiAgJ3N3aXBlVXAnLCAnc3dpcGVEb3duJywKICAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnCl0pOwoKLy9idWlsdCBpbiBkb20gZXZlbnRzClRob3JheC5WaWV3Lm9uKHsKICAnc3VibWl0IGZvcm0nOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgLy8gSGlkZSBhbnkgdmlydHVhbCBrZXlib2FyZHMgdGhhdCBtYXkgYmUgbGluZ2VyaW5nIGFyb3VuZAogICAgdmFyIGZvY3VzZWQgPSAkKCc6Zm9jdXMnKVswXTsKICAgIGZvY3VzZWQgJiYgZm9jdXNlZC5ibHVyKCk7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCAqLwoKLy8gVGhpcyBkb2Vzbid0IHdvcmsgb24gSFRDIGRldmljZXMgd2l0aCBBbmRyb2lkIDQuMC4KLy8gTm90IG11Y2ggY2FuIGJlIGRvbmUgYWJvdXQgaXQgYXMgaXQgc2VlbXMgdG8gYmUgYSBicm93c2VyIGJ1ZwovLyAoaXQgZG9lc24ndCB1cGRhdGUgdmlzdWFsIHN0eWxpbmcgd2hpbGUgeW91IGhvbGQgeW91ciBmaW5nZXIgb24gdGhlIHNjcmVlbikKJC5mbi50YXBIb2xkQW5kRW5kID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNhbGxiYWNrU3RhcnQsIGNhbGxiYWNrRW5kKSB7CiAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciB0YXBIb2xkU3RhcnQsCiAgICAgICAgdGltZXIsCiAgICAgICAgdGFyZ2V0OwoKICAgIGZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoZXZlbnQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKCiAgICAgIGlmICh0YXBIb2xkU3RhcnQgJiYgdGFyZ2V0KSB7CiAgICAgICAgY2FsbGJhY2tFbmQodGFyZ2V0KTsKICAgICAgfQoKICAgICAgdGFyZ2V0ID0gdW5kZWZpbmVkOwogICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZTsKICAgIH0KCiAgICAkKHRoaXMpLm9uKCd0b3VjaHN0YXJ0Jywgc2VsZWN0b3IsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKCQoZXZlbnQuY3VycmVudFRhcmdldCkuYXR0cignZGF0YS1uby10YXAtaGlnaGxpZ2h0JykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNsZWFyVGFwVGltZXIoKTsKCiAgICAgICAgdGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldDsKICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0YXBIb2xkU3RhcnQgPSB0cnVlOwogICAgICAgICAgY2FsbGJhY2tTdGFydCh0YXJnZXQpOwogICAgICAgIH0sIDUwKTsKICAgICAgfSkKICAgICAgLm9uKCd0b3VjaG1vdmUgdG91Y2hlbmQnLCBjbGVhclRhcFRpbWVyKTsKCiAgICAkKGRvY3VtZW50KS5vbigndG91Y2hjYW5jZWwnLCBjbGVhclRhcFRpbWVyKTsKICB9KTsKfTsKCi8vb25seSBlbmFibGUgb24gYW5kcm9pZAp2YXIgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gIWlzQW5kcm9pZDsKVGhvcmF4LmNvbmZpZ3VyZVRhcEhpZ2hsaWdodCA9IGZ1bmN0aW9uKHVzZU5hdGl2ZSwgaGlnaGxpZ2h0Q2xhc3MpIHsKICB1c2VOYXRpdmVIaWdobGlnaHQgPSB1c2VOYXRpdmU7CiAgaGlnaGxpZ2h0Q2xhc3MgPSBoaWdobGlnaHRDbGFzcyB8fCAndGFwLWhpZ2hsaWdodCc7CgogIGlmICghdXNlTmF0aXZlKSB7CiAgICBmdW5jdGlvbiBfdGFwSGlnaGxpZ2h0U3RhcnQodGFyZ2V0KSB7CiAgICAgIHZhciB0YWdOYW1lID0gdGFyZ2V0ICYmIHRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgICAgLy8gd2Ugd2FudCB0byBnaXZlIHByaW9yaXR5IHRvIGFueSBwYXJlbnQgdGhhdCBtYXkgcHJvdmlkZSBhIGZvY3VzIG9wZXJhdGlvbi4KICAgICAgaWYgKHRhZ05hbWUgPT09ICdpbnB1dCcgfHwgdGFnTmFtZSA9PT0gJ3NlbGVjdCcgfHwgdGFnTmFtZSA9PT0gJ3RleHRhcmVhJykgewogICAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyhoaWdobGlnaHRDbGFzcyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBfdGFwSGlnaGxpZ2h0RW5kKCkgewogICAgICAkKCcuJyArIGhpZ2hsaWdodENsYXNzKS5yZW1vdmVDbGFzcyhoaWdobGlnaHRDbGFzcyk7CiAgICB9CiAgICAkKGRvY3VtZW50LmJvZHkpLnRhcEhvbGRBbmRFbmQoCiAgICAgICAgICAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnLAogICAgICAgICAgX3RhcEhpZ2hsaWdodFN0YXJ0LAogICAgICAgICAgX3RhcEhpZ2hsaWdodEVuZCk7CiAgfQp9OwoKdmFyIE5BVElWRV9UQVBQQUJMRSA9IHsKICAnQSc6IHRydWUsCiAgJ0lOUFVUJzogdHJ1ZSwKICAnQlVUVE9OJzogdHJ1ZSwKICAnU0VMRUNUJzogdHJ1ZSwKICAnVEVYVEFSRUEnOiB0cnVlCn07CgovLyBPdXQgaGVyZSBzbyB3ZSBkbyBub3QgcmV0YWluIGEgc2NvcGUKZnVuY3Rpb24gTk9QKCl7fQoKZnVuY3Rpb24gZml4dXBUYXBIaWdobGlnaHQoKSB7CiAgXy5lYWNoKHRoaXMuX2RvbUV2ZW50cyB8fCBbXSwgZnVuY3Rpb24oYmluZCkgewogICAgdmFyIGNvbXBvbmVudHMgPSBiaW5kLnNwbGl0KCcgJyksCiAgICAgICAgc2VsZWN0b3IgPSBjb21wb25lbnRzLnNsaWNlKDEpLmpvaW4oJyAnKSB8fCB1bmRlZmluZWQ7ICAvLyBOZWVkZWQgdG8gbWFrZSB6ZXB0byBoYXBweQoKICAgIGlmIChjb21wb25lbnRzWzBdID09PSAnY2xpY2snKSB7CiAgICAgIC8vICFzZWxlY3RvciBjYXNlIGlzIGZvciByb290IGNsaWNrIGhhbmRsZXJzIG9uIHRoZSB2aWV3LCBpLmUuICdjbGljaycKICAgICAgJChzZWxlY3RvciB8fCB0aGlzLmVsLCBzZWxlY3RvciAmJiB0aGlzLmVsKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyICRlbCA9ICQoZWwpLmF0dHIoJ2RhdGEtdGFwcGFibGUnLCB0cnVlKTsKCiAgICAgICAgaWYgKHVzZU5hdGl2ZUhpZ2hsaWdodCAmJiAhTkFUSVZFX1RBUFBBQkxFW2VsLnRhZ05hbWVdKSB7CiAgICAgICAgICAvLyBBZGQgYW4gZXhwbGljaXQgTk9QIGJpbmQgdG8gYWxsb3cgdGFwLWhpZ2hsaWdodCBzdXBwb3J0CiAgICAgICAgICAkZWwub24oJ2NsaWNrJywgTk9QKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHRoaXMpOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ3JlbmRlcmVkJzogZml4dXBUYXBIaWdobGlnaHQsCiAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmaXh1cFRhcEhpZ2hsaWdodCwKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0LAogICdyZW5kZXJlZDplbXB0eSc6IGZpeHVwVGFwSGlnaGxpZ2h0Cn0pOwoKdmFyIF9hZGRFdmVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fYWRkRXZlbnQ7ClRob3JheC5WaWV3LnByb3RvdHlwZS5fYWRkRXZlbnQgPSBmdW5jdGlvbihwYXJhbXMpIHsKICB0aGlzLl9kb21FdmVudHMgPSB0aGlzLl9kb21FdmVudHMgfHwgW107CiAgaWYgKHBhcmFtcy50eXBlID09PSAiRE9NIikgewogICAgdGhpcy5fZG9tRXZlbnRzLnB1c2gocGFyYW1zLm9yaWdpbmFsTmFtZSk7CiAgfQogIHJldHVybiBfYWRkRXZlbnQuY2FsbCh0aGlzLCBwYXJhbXMpOwp9OwoKOzsKCgp9KSgpOwoKLy9AIHNvdXJjZU1hcHBpbmdVUkw9dGhvcmF4LW1vYmlsZS5qcy5tYXAKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 15:34:45 GMT",
                    "Content-Length": "268000",
                    "Date": "Sat, 08 Nov 2014 15:34:45 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}