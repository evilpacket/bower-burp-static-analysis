{
    "url": "http://localhost:9999/basisjs/backbone-basis-templates/bbt.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.href</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>baseEl.setAttribute(\"href\", location.href);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/basisjs/backbone-basis-templates/bbt.js",
                "path": "/basisjs/backbone-basis-templates/bbt.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9iYXNpc2pzL2JhY2tib25lLWJhc2lzLXRlbXBsYXRlcy9iYnQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjExNDY4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDExOjEyOjE0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMToxMjoxMiBHTVQNCg0KLy8gcmVzb3VyY2VzICg3KToKLy8gIFtmdW5jdGlvbl0gYmJ0LmpzIC0+IDAuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL3RlbXBsYXRlL2h0bWwuanMgLT4gMS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZG9tL2V2ZW50LmpzIC0+IDIuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2wxMG4uanMgLT4gMy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZXZlbnQuanMgLT4gNC5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdGVtcGxhdGUuanMgLT4gNS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdGVtcGxhdGUvaHRtbGZnZW4uanMgLT4gNi5qcwovLwovLyBmaWxlbGlzdCAoMSk6IAovLyAgIGJidC5qcwooZnVuY3Rpb24oKXsKInVzZSBzdHJpY3QiOwoKdmFyIF9fbmFtZXNwYWNlX21hcF9fID0geyIwLmpzIjoiYmJ0IiwiMS5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWwiLCIyLmpzIjoiYmFzaXMuZG9tLmV2ZW50IiwiMy5qcyI6ImJhc2lzLmwxMG4iLCI0LmpzIjoiYmFzaXMuZXZlbnQiLCI1LmpzIjoiYmFzaXMudGVtcGxhdGUiLCI2LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4ifTsKdmFyIGJidDsKCnZhciBfX3Jlc291cmNlc19fID0gewogICIwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzEuanMiKTsKICAgIHZhciBzcmNNYXAgPSBbXTsKICAgIHZhciB0bXBsTWFwID0gW107CiAgICBmdW5jdGlvbiB0ZW1wbGF0ZVdyYXBwZXIoc3JjKSB7CiAgICAgIHZhciBpbmRleCA9IHNyY01hcC5pbmRleE9mKHNyYyk7CiAgICAgIGlmIChpbmRleCAhPSAtMSkgcmV0dXJuIHRtcGxNYXBbaW5kZXhdOwogICAgICB2YXIgdGVtcGxhdGUgPSBuZXcgYmFzaXMudGVtcGxhdGUuaHRtbC5UZW1wbGF0ZShzcmMpOwogICAgICBzcmNNYXAucHVzaChzcmMpOwogICAgICB0bXBsTWFwLnB1c2godGVtcGxhdGUpOwogICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9CiAgICB2YXIgYmFja2JvbmVUZW1wbGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBhY3Rpb25Qcm94eShhY3Rpb25OYW1lLCBldmVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpc1thY3Rpb25OYW1lXSA9PSAiZnVuY3Rpb24iKSB0aGlzW2FjdGlvbk5hbWVdKGV2ZW50KTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1cGRhdGVCaW5kKGJpbmROYW1lKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSB0aGlzLmJpbmRpbmcgJiYgdGhpcy5iaW5kaW5nW2JpbmROYW1lXTsKICAgICAgICB2YXIgZ2V0dGVyID0gYmluZGluZyAmJiBiaW5kaW5nLmdldHRlcjsKICAgICAgICBpZiAoZ2V0dGVyICYmIHRoaXMudG1wbCkgdGhpcy50bXBsLnNldChiaW5kTmFtZSwgZ2V0dGVyKHRoaXMpKTsKICAgICAgfQogICAgICB2YXIgZ19iaW5kaW5ncyA9IHt9OwogICAgICB2YXIgZ19zZWVkID0gMTsKICAgICAgdmFyIEJJTkRJTkdfVEVNUExBVEVfSU5URVJGQUNFID0gewogICAgICAgIGF0dGFjaDogZnVuY3Rpb24ob2JqZWN0LCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICBmb3IgKHZhciBldmVudCBpbiBoYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IGV2ZW50LnNwbGl0KCI6Iik7CiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBvYmplY3RbcGFydHNbMF1dLm9uKHBhcnRzWzFdLCBoYW5kbGVyW2V2ZW50XS5iaW5kKGNvbnRleHQsIG9iamVjdCkpOyBlbHNlIG9iamVjdC5vbihldmVudCwgaGFuZGxlcltldmVudF0sIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGV2ZW50IGluIGhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIHBhcnRzID0gZXZlbnQuc3BsaXQoIjoiKTsKICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIG9iamVjdFtwYXJ0c1swXV0ub2ZmKHBhcnRzWzFdLCBoYW5kbGVyW2V2ZW50XSwgY29udGV4dCk7IGVsc2Ugb2JqZWN0Lm9mZihldmVudCwgaGFuZGxlcltldmVudF0sIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciB0bXBsID0gdGVtcGxhdGVXcmFwcGVyKHNvdXJjZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGJpbmRpbmc7CiAgICAgICAgICBpZiAodGhpcy5iaW5kaW5nKSB7CiAgICAgICAgICAgIGJpbmRpbmcgPSBnX2JpbmRpbmdzW3RoaXMuYmluZGluZy5pZF9dOwogICAgICAgICAgICBpZiAoIWJpbmRpbmcpIHsKICAgICAgICAgICAgICBpZiAoIXRoaXMuYmluZGluZy5pZF8pIHRoaXMuYmluZGluZy5pZF8gPSBnX3NlZWQrKzsKICAgICAgICAgICAgICBiaW5kaW5nID0gZ19iaW5kaW5nc1t0aGlzLmJpbmRpbmcuaWRfXSA9IHsKICAgICAgICAgICAgICAgIGJpbmRpbmdJZDogdGhpcy5iaW5kaW5nLmlkXwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYmluZGluZykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmluZGluZ1trZXldKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5iaW5kaW5nW2tleV0gPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IHRoaXMuYmluZGluZ1trZXldLm1hdGNoKC9ebW9kZWw6KC4qKSQvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgYmluZGluZ1trZXldID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiAibW9kZWw6Y2hhbmdlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3Lm1vZGVsLmdldChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIH0obVsxXSB8fCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nW2tleV0gPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3W2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgfShrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuYmluZGluZ1trZXldID09ICJzdHJpbmciIHx8IHR5cGVvZiB0aGlzLmJpbmRpbmdba2V5XSA9PSAib2JqZWN0IikgYmluZGluZ1trZXldID0gdGhpcy5iaW5kaW5nW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudG1wbCA9IHRtcGwuY3JlYXRlSW5zdGFuY2UodGhpcywgYWN0aW9uUHJveHksIG51bGwsIGJpbmRpbmcsIEJJTkRJTkdfVEVNUExBVEVfSU5URVJGQUNFKTsKICAgICAgICAgIHRoaXMudXBkYXRlQmluZCA9IHVwZGF0ZUJpbmQ7CiAgICAgICAgICByZXR1cm4gdGhpcy50bXBsLmVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIGdsb2JhbFsiYmJ0Il0gPSBtb2R1bGUuZXhwb3J0cyA9IGJhc2lzLm9iamVjdC5leHRlbmQoYmFja2JvbmVUZW1wbGF0ZSwgewogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXM7CiAgICAgICAgaWYgKGNvbmZpZy5ub0NvbmZsaWN0KSB7CiAgICAgICAgICBkZWxldGUgd2luZG93LmJ0OwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9LAogICAgICB0ZW1wbGF0ZTogYmFja2JvbmVUZW1wbGF0ZQogICAgfSk7CiAgfSwKICAiMS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi82LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIGRvbUV2ZW50ID0gYmFzaXMuZG9tLmV2ZW50OwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgY2FtZWxpemUgPSBiYXNpcy5zdHJpbmcuY2FtZWxpemU7CiAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbjsKICAgIHZhciBnZXRGdW5jdGlvbnMgPSBiYXNpcy50ZW1wbGF0ZS5odG1sZmdlbi5nZXRGdW5jdGlvbnM7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaENvbmZpZzsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGVTd2l0Y2hlcjsKICAgIHZhciBUZW1wbGF0ZSA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlOwogICAgdmFyIFRZUEVfRUxFTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfRUxFTUVOVDsKICAgIHZhciBUWVBFX0FUVFJJQlVURSA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQVRUUklCVVRFOwogICAgdmFyIFRZUEVfVEVYVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfVEVYVDsKICAgIHZhciBUWVBFX0NPTU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0NPTU1FTlQ7CiAgICB2YXIgVE9LRU5fVFlQRSA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1RZUEU7CiAgICB2YXIgVE9LRU5fQklORElOR1MgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9CSU5ESU5HUzsKICAgIHZhciBUT0tFTl9SRUZTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fUkVGUzsKICAgIHZhciBBVFRSX05BTUUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX05BTUU7CiAgICB2YXIgQVRUUl9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfVkFMVUU7CiAgICB2YXIgQVRUUl9OQU1FX0JZX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX05BTUVfQllfVFlQRTsKICAgIHZhciBFTEVNRU5UX05BTUUgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX05BTUU7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgZXZlbnRBdHRyID0gL15ldmVudC0oLispKy87CiAgICB2YXIgYmFzaXNUZW1wbGF0ZUlkTWFya2VyID0gImJhc2lzVGVtcGxhdGVJZF8iICsgYmFzaXMuZ2VuVUlEKCk7CiAgICB2YXIgdG1wbEV2ZW50TGlzdGVuZXJzID0ge307CiAgICB2YXIgdGVtcGxhdGVzID0ge307CiAgICB2YXIgbmFtZXNwYWNlVVJJID0gewogICAgICBzdmc6ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgIH07CiAgICB2YXIgYWZ0ZXJFdmVudEFjdGlvbiA9IHt9OwogICAgdmFyIGluc2lkZUVsZW1lbnRFdmVudCA9IHt9OwogICAgdmFyIE1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgPSAib25tb3VzZWVudGVyIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB2YXIgQ0FQVFVSRV9GQUxMQkFDSyA9ICFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICYmICJfX2Jhc2lzVGVtcGxhdGUiICsgcGFyc2VJbnQoMWU5ICogTWF0aC5yYW5kb20oKSk7CiAgICBpZiAoQ0FQVFVSRV9GQUxMQkFDSykgZ2xvYmFsW0NBUFRVUkVfRkFMTEJBQ0tdID0gZnVuY3Rpb24oZXZlbnROYW1lLCBldmVudCkgewogICAgICBkb21FdmVudC5maXJlRXZlbnQoZG9jdW1lbnQsIGV2ZW50TmFtZSk7CiAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gdHJ1ZTsKICAgICAgdmFyIGxpc3RlbmVyID0gdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV07CiAgICAgIGlmIChsaXN0ZW5lcikgbGlzdGVuZXIobmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KSk7CiAgICB9OwogICAgdmFyIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiYSIpKTsKICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiYSIpKTsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpLmNoaWxkTm9kZXMubGVuZ3RoID09IDE7CiAgICB9KCk7CiAgICB2YXIgU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgImEiKTsKICAgICAgcmV0dXJuICFlbGVtZW50LmNsYXNzTmFtZTsKICAgIH0oKTsKICAgIHZhciBTRVRfU1RZTEVfQVRUUklCVVRFX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgic3R5bGUiLCAicG9zaXRpb246YWJzb2x1dGUiKTsKICAgICAgcmV0dXJuIGVsZW1lbnQuc3R5bGUucG9zaXRpb24gIT0gImFic29sdXRlIjsKICAgIH0oKTsKICAgIHZhciBJU19TRVRfU1RZTEVfU0FGRSA9ICEhZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5jb2xvciA9ICJ4IjsKICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0oKTsKICAgIGlmICh0eXBlb2YgTm9kZSAhPSAidW5kZWZpbmVkIiAmJiAhTm9kZS5wcm90b3R5cGUuY29udGFpbnMpIE5vZGUucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuICEhKHRoaXMuY29tcGFyZURvY3VtZW50UG9zaXRpb24oY2hpbGQpICYgMTYpOwogICAgfTsKICAgIHZhciBsMTBuVGVtcGxhdGVzID0ge307CiAgICBmdW5jdGlvbiBnZXRMMTBuVGVtcGxhdGUodG9rZW4pIHsKICAgICAgdmFyIHRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuZ2V0TDEwblRlbXBsYXRlKHRva2VuKTsKICAgICAgdmFyIGlkID0gdGVtcGxhdGUudGVtcGxhdGVJZDsKICAgICAgdmFyIGh0bWxUZW1wbGF0ZSA9IGwxMG5UZW1wbGF0ZXNbaWRdOwogICAgICBpZiAoIWh0bWxUZW1wbGF0ZSkgaHRtbFRlbXBsYXRlID0gbDEwblRlbXBsYXRlc1tpZF0gPSBuZXcgSHRtbFRlbXBsYXRlKHRlbXBsYXRlLnNvdXJjZSk7CiAgICAgIHJldHVybiBodG1sVGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoYXR0ck5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT0gImNsaWNrIiAmJiBldmVudC53aGljaCA9PSAzKSByZXR1cm47CiAgICAgICAgdmFyIGJ1YmJsZSA9IGluc2lkZUVsZW1lbnRFdmVudFtldmVudC50eXBlXSB8fCBldmVudC50eXBlICE9ICJtb3VzZWVudGVyIiAmJiBldmVudC50eXBlICE9ICJtb3VzZWxlYXZlIjsKICAgICAgICB2YXIgYXR0ckN1cnNvciA9IGV2ZW50LnNlbmRlcjsKICAgICAgICB2YXIgYXR0cjsKICAgICAgICB3aGlsZSAoYXR0ckN1cnNvcikgewogICAgICAgICAgYXR0ciA9IGF0dHJDdXJzb3IuZ2V0QXR0cmlidXRlICYmIGF0dHJDdXJzb3IuZ2V0QXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgIGlmICghYnViYmxlIHx8IHR5cGVvZiBhdHRyID09ICJzdHJpbmciKSBicmVhazsKICAgICAgICAgIGF0dHJDdXJzb3IgPSBhdHRyQ3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYXR0ciA9PSAic3RyaW5nIikgewogICAgICAgICAgdmFyIGN1cnNvciA9IGF0dHJDdXJzb3I7CiAgICAgICAgICB2YXIgYWN0aW9uVGFyZ2V0ID0gY3Vyc29yOwogICAgICAgICAgdmFyIHJlZklkOwogICAgICAgICAgdmFyIHRtcGxSZWY7CiAgICAgICAgICBpZiAoaW5zaWRlRWxlbWVudEV2ZW50W2V2ZW50LnR5cGVdKSB7CiAgICAgICAgICAgIHZhciByZWxUYXJnZXQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICBpZiAocmVsVGFyZ2V0ICYmIChjdXJzb3IgPT09IHJlbFRhcmdldCB8fCBjdXJzb3IuY29udGFpbnMocmVsVGFyZ2V0KSkpIGN1cnNvciA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICAgIHJlZklkID0gY3Vyc29yW2Jhc2lzVGVtcGxhdGVJZE1hcmtlcl07CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmSWQgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodG1wbFJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bXBsUmVmICYmIHRtcGxSZWYuYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gYXR0ci50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICBldmVudC5hY3Rpb25UYXJnZXQgPSBhY3Rpb25UYXJnZXQ7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb25OYW1lOyBhY3Rpb25OYW1lID0gYWN0aW9uc1tpKytdOyApIHN3aXRjaCAoYWN0aW9uTmFtZSkgewogICAgICAgICAgICAgIGNhc2UgInByZXZlbnQtZGVmYXVsdCI6CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic3RvcC1wcm9wYWdhdGlvbiI6CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0bXBsUmVmLmFjdGlvbi5jYWxsKHRtcGxSZWYuY29udGV4dCwgYWN0aW9uTmFtZSwgZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudC50eXBlIGluIGFmdGVyRXZlbnRBY3Rpb24pIGFmdGVyRXZlbnRBY3Rpb25bZXZlbnQudHlwZV0oZXZlbnQsIGF0dHJDdXJzb3IpOwogICAgICB9OwogICAgfQogICAgdmFyIGJ1aWxkSHRtbCA9IGZ1bmN0aW9uKHRva2VucywgcGFyZW50KSB7CiAgICAgIGZ1bmN0aW9uIGVtdWxhdGVFdmVudChvcmlnRXZlbnROYW1lLCBlbXVsRXZlbnROYW1lKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGVtdWxFdmVudE5hbWUpOwogICAgICAgIGluc2lkZUVsZW1lbnRFdmVudFtvcmlnRXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgYWZ0ZXJFdmVudEFjdGlvbltlbXVsRXZlbnROYW1lXSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICBldmVudC50eXBlID0gb3JpZ0V2ZW50TmFtZTsKICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgfTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW29yaWdFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQsIGN1cnNvcikgewogICAgICAgICAgY3Vyc29yID0gY3Vyc29yICYmIGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKGN1cnNvcikgewogICAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgICBldmVudC5zZW5kZXIgPSBjdXJzb3I7CiAgICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKSB7CiAgICAgICAgaWYgKCF0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSkgewogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBjcmVhdGVFdmVudEhhbmRsZXIoImV2ZW50LSIgKyBldmVudE5hbWUpOwogICAgICAgICAgaWYgKCFDQVBUVVJFX0ZBTExCQUNLKSB7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlZW50ZXIiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3ZlciIpOwogICAgICAgICAgICBpZiAoIU1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgJiYgZXZlbnROYW1lID09ICJtb3VzZWxlYXZlIikgcmV0dXJuIGVtdWxhdGVFdmVudChldmVudE5hbWUsICJtb3VzZW91dCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmFtZXMgPSBkb21FdmVudC5icm93c2VyRXZlbnRzKGV2ZW50TmFtZSksIGJyb3dzZXJFdmVudE5hbWU7IGJyb3dzZXJFdmVudE5hbWUgPSBuYW1lc1tpXTsgaSsrKSBkb21FdmVudC5hZGRHbG9iYWxIYW5kbGVyKGJyb3dzZXJFdmVudE5hbWUsIHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhY3Rpb25zKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSk7CiAgICAgICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIHJlc3VsdC5zZXRBdHRyaWJ1dGUoIm9uIiArIGV2ZW50TmFtZSwgQ0FQVFVSRV9GQUxMQkFDSyArICcoIicgKyBldmVudE5hbWUgKyAnIixldmVudCknKTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKCJldmVudC0iICsgZXZlbnROYW1lLCBhY3Rpb25zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAoU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAiY2xhc3MiKSBuYW1lID0gImNsYXNzTmFtZSI7CiAgICAgICAgaWYgKFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHICYmIG5hbWUgPT0gInN0eWxlIikgcmV0dXJuIHJlc3VsdC5zdHlsZS5jc3NUZXh0ID0gdmFsdWU7CiAgICAgICAgcmVzdWx0LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHBhcmVudCB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGZvciAodmFyIGkgPSBwYXJlbnQgPyA0IDogMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgdmFyIHRhZ05hbWUgPSB0b2tlbltFTEVNRU5UX05BTUVdOwogICAgICAgICAgICB2YXIgcGFydHMgPSB0YWdOYW1lLnNwbGl0KC86Lyk7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gcGFydHMubGVuZ3RoID4gMSA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUklbcGFydHNbMF1dLCB0YWdOYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgICAgICAgICAgIGJ1aWxkSHRtbCh0b2tlbiwgZWxlbWVudCk7CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gdG9rZW5bQVRUUl9WQUxVRV07CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBhdHRyTmFtZS5yZXBsYWNlKC9eZXZlbnQtLywgIiIpOwogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9IGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhdHRyTmFtZSAhPSAiY2xhc3MiICYmIGF0dHJOYW1lICE9ICJzdHlsZSIgPyAhdG9rZW5bVE9LRU5fQklORElOR1NdIDogYXR0clZhbHVlKSBzZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFIC0gMV07CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0sIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZSh0b2tlblsxXSwgdG9rZW5bMl0gfHwgdG9rZW5bMV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0b2tlbltDT01NRU5UX1ZBTFVFXSB8fCAodG9rZW5bVE9LRU5fUkVGU10gPyAieyIgKyB0b2tlbltUT0tFTl9SRUZTXS5qb2luKCJ8IikgKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgaWYgKENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgJiYgaSAmJiB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpKTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRva2VuW1RFWFRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSB8fCAodG9rZW5bVE9LRU5fQklORElOR1NdID8gInsiICsgdG9rZW5bVE9LRU5fQklORElOR1NdICsgIn0iIDogIiIpKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXBhcmVudCAmJiB0b2tlbnMubGVuZ3RoID09IDEpIHJlc3VsdCA9IHJlc3VsdC5maXJzdENoaWxkOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZUJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlSWQgPSByZWZJZCAmIDQwOTU7CiAgICAgIHZhciBvYmplY3QgPSB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0LnRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIGluc3RhbmNlSWQgPSByZWZJZCA+PiAxMjsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QuaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZU9iamVjdEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5jb250ZXh0OwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZVRtcGxCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZVJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpOwogICAgICByZXR1cm4gdGVtcGxhdGVSZWYgJiYgdGVtcGxhdGVSZWYudG1wbDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlYnVnSW5mb0J5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZyAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZygpOwogICAgfQogICAgdmFyIGJ1aWxkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIFdISVRFU1BBQ0UgPSAvXHMrLzsKICAgICAgdmFyIFczQ19ET01fTk9ERV9TVVBQT1JURUQgPSB0eXBlb2YgTm9kZSA9PSAiZnVuY3Rpb24iICYmIGRvY3VtZW50IGluc3RhbmNlb2YgTm9kZTsKICAgICAgdmFyIENMQVNTTElTVF9TVVBQT1JURUQgPSBnbG9iYWwuRE9NVG9rZW5MaXN0ICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QgaW5zdGFuY2VvZiBnbG9iYWwuRE9NVG9rZW5MaXN0OwogICAgICB2YXIgYmluZF9ub2RlID0gVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgTm9kZSA/IG5ld1ZhbHVlIDogZG9tUmVmOwogICAgICAgIGlmIChuZXdOb2RlICE9PSBvbGROb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJvYmplY3QiID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG5ld05vZGUgPSBkb21SZWY7CiAgICAgICAgICAgIGlmIChvbGROb2RlICE9PSBuZXdOb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfZWxlbWVudCA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmICYmIHR5cGVvZiBuZXdWYWx1ZSA9PSAic3RyaW5nIikgZG9tUmVmLmlubmVySFRNTCA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9jb21tZW50ID0gYmluZF9ub2RlOwogICAgICB2YXIgYmluZF90ZXh0Tm9kZSA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmKSBkb21SZWYubm9kZVZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJDbGFzcyA9IENMQVNTTElTVF9TVVBQT1JURUQgPyBmdW5jdGlvbihkb21SZWYsIG9sZENsYXNzLCBuZXdWYWx1ZSwgcHJlZml4LCBhbmltKSB7CiAgICAgICAgdmFyIG5ld0NsYXNzID0gbmV3VmFsdWUgPyBwcmVmaXggKyBuZXdWYWx1ZSA6ICIiOwogICAgICAgIGlmIChuZXdDbGFzcyAhPSBvbGRDbGFzcykgewogICAgICAgICAgaWYgKG9sZENsYXNzKSBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QuYWRkKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gZG9tUmVmLmNsYXNzTmFtZTsKICAgICAgICAgIHZhciBjbGFzc05hbWVJc09iamVjdCA9IHR5cGVvZiBjbGFzc05hbWUgIT0gInN0cmluZyI7CiAgICAgICAgICB2YXIgY2xhc3NMaXN0OwogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBjbGFzc05hbWUgPSBjbGFzc05hbWUuYmFzZVZhbDsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTmFtZS5zcGxpdChXSElURVNQQUNFKTsKICAgICAgICAgIGlmIChvbGRDbGFzcykgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgb2xkQ2xhc3MpOwogICAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICAgIGNsYXNzTGlzdC5wdXNoKG5ld0NsYXNzKTsKICAgICAgICAgICAgaWYgKGFuaW0pIHsKICAgICAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNsYXNzTGlzdCA9IChjbGFzc05hbWVJc09iamVjdCA/IGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA6IGRvbVJlZi5jbGFzc05hbWUpLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgICAgICAgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgbmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICAgIGlmIChjbGFzc05hbWVJc09iamVjdCkgZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsgZWxzZSBkb21SZWYuY2xhc3NOYW1lID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJTdHlsZSA9IElTX1NFVF9TVFlMRV9TQUZFID8gZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgcHJvcGVydHlOYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkb21SZWYuc3R5bGVbY2FtZWxpemUocHJvcGVydHlOYW1lKV0gPSBuZXdWYWx1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ciA9IGZ1bmN0aW9uKGRvbVJlZiwgYXR0ck5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIGlmIChuZXdWYWx1ZSkgZG9tUmVmLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpOyBlbHNlIGRvbVJlZi5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3VmFsdWU7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF0dGFjaCgpIHsKICAgICAgICB0aGlzLnNldCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlc29sdmVWYWx1ZShiaW5kaW5nTmFtZSwgdmFsdWUsIEF0dGFjaGVzKSB7CiAgICAgICAgdmFyIGJyaWRnZSA9IHZhbHVlICYmIHZhbHVlLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgdmFyIG9sZEF0dGFjaCA9IHRoaXMuYXR0YWNoZXMgJiYgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV07CiAgICAgICAgdmFyIHRtcGwgPSBudWxsOwogICAgICAgIGlmIChicmlkZ2UgfHwgb2xkQXR0YWNoKSB7CiAgICAgICAgICBpZiAoYnJpZGdlKSB7CiAgICAgICAgICAgIGlmICghb2xkQXR0YWNoIHx8IHZhbHVlICE9PSBvbGRBdHRhY2gudmFsdWUpIHsKICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoLnRtcGwpIHsKICAgICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PSAibWFya3VwIiAmJiB2YWx1ZSBpbnN0YW5jZW9mIGJhc2lzLmwxMG4uVG9rZW4pIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0ludGVyZmFjZSA9IHRoaXMuYmluZGluZ0ludGVyZmFjZTsKICAgICAgICAgICAgICAgIHRtcGwgPSB0ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZShjb250ZXh0LCBudWxsLCBmdW5jdGlvbiBvblJlYnVpbGQoKSB7CiAgICAgICAgICAgICAgICAgIHRtcGwgPSBuZXdBdHRhY2gudG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUF0dGFjaC5jYWxsKG5ld0F0dGFjaCk7CiAgICAgICAgICAgICAgICB9LCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmF0dGFjaGVzKSB0aGlzLmF0dGFjaGVzID0gbmV3IEF0dGFjaGVzOwogICAgICAgICAgICAgIHZhciBuZXdBdHRhY2ggPSB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGJpbmRpbmdOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgdG1wbDogdG1wbCwKICAgICAgICAgICAgICAgIHNldDogdGhpcy50bXBsLnNldAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYnJpZGdlLmF0dGFjaCh2YWx1ZSwgdXBkYXRlQXR0YWNoLCBuZXdBdHRhY2gpOwogICAgICAgICAgICB9IGVsc2UgdG1wbCA9IHZhbHVlICYmIHZhbHVlLnR5cGUgPT0gIm1hcmt1cCIgPyBvbGRBdHRhY2gudG1wbCA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bXBsKSByZXR1cm4gdG1wbC5lbGVtZW50OwogICAgICAgICAgICB2YWx1ZSA9IGJyaWRnZS5nZXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZEF0dGFjaCkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICBnZXRMMTBuVGVtcGxhdGUob2xkQXR0YWNoLnZhbHVlKS5jbGVhckluc3RhbmNlKG9sZEF0dGFjaC50bXBsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ1VwZGF0ZXIobmFtZXMsIGdldHRlcnMpIHsKICAgICAgICB2YXIgbmFtZTEgPSBuYW1lc1swXTsKICAgICAgICB2YXIgbmFtZTIgPSBuYW1lc1sxXTsKICAgICAgICB2YXIgZ2V0dGVyMSA9IGdldHRlcnNbbmFtZTFdOwogICAgICAgIHZhciBnZXR0ZXIyID0gZ2V0dGVyc1tuYW1lMl07CiAgICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJpbmRpbmdVcGRhdGVyMShvYmplY3QpIHsKICAgICAgICAgICAgICB0aGlzKG5hbWUxLCBnZXR0ZXIxKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIyKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMiwgZ2V0dGVyMihvYmplY3QpKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZhciBnZXR0ZXJzXyA9IG5hbWVzLm1hcChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcnNbbmFtZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXJOKG9iamVjdCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHRoaXMobmFtZXNbaV0sIGdldHRlcnNfW2ldKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGV2ZW50cykgZXZlbnRzW25hbWVdID0gY3JlYXRlQmluZGluZ1VwZGF0ZXIoZXZlbnRzW25hbWVdLCBnZXR0ZXJzKTsKICAgICAgICByZXR1cm4gbmFtZSA/IGV2ZW50cyA6IG51bGw7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ0Z1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgYmluZGluZ0NhY2hlID0ge307CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGdldEJpbmRpbmcoYmluZGluZ3MsIG9iaiwgc2V0LCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICBpZiAoIWJpbmRpbmdzKSByZXR1cm4ge307CiAgICAgICAgICB2YXIgY2FjaGVJZCA9ICJiaW5kaW5nSWQiIGluIGJpbmRpbmdzID8gYmluZGluZ3MuYmluZGluZ0lkIDogbnVsbDsKICAgICAgICAgIGlmICghY2FjaGVJZCkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlLmdldEJpbmRpbmc6IGJpbmRpbmdzIGhhcyBubyBiaW5kaW5nSWQgcHJvcGVydHksIGNhY2hlIGlzIG5vdCB1c2VkIik7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gYmluZGluZ0NhY2hlW2NhY2hlSWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIHZhciBnZXR0ZXJzID0ge307CiAgICAgICAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGJpbmRpbmdOYW1lOyBiaW5kaW5nTmFtZSA9IGtleXNbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgICAgIGlmIChnZXR0ZXIpIHsKICAgICAgICAgICAgICAgIGdldHRlcnNbYmluZGluZ05hbWVdID0gZ2V0dGVyOwogICAgICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kaW5nTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZy5ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TGlzdCA9IFN0cmluZyhiaW5kaW5nLmV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudExpc3Rbal07IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudHNbZXZlbnROYW1lXSkgZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChiaW5kaW5nTmFtZSk7IGVsc2UgZXZlbnRzW2V2ZW50TmFtZV0gPSBbIGJpbmRpbmdOYW1lIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgIG5hbWVzOiBuYW1lcywKICAgICAgICAgICAgICBzeW5jOiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycyksCiAgICAgICAgICAgICAgaGFuZGxlcjogbWFrZUhhbmRsZXIoZXZlbnRzLCBnZXR0ZXJzKQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoY2FjaGVJZCkgYmluZGluZ0NhY2hlW2NhY2hlSWRdID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9iaiAmJiBzZXQpIHJlc3VsdC5zeW5jLmNhbGwoc2V0LCBvYmopOwogICAgICAgICAgaWYgKCFiaW5kaW5nSW50ZXJmYWNlKSByZXR1cm47CiAgICAgICAgICBpZiAocmVzdWx0LmhhbmRsZXIpIGJpbmRpbmdJbnRlcmZhY2UuYXR0YWNoKG9iaiwgcmVzdWx0LmhhbmRsZXIsIHNldCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LmhhbmRsZXI7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgdG9vbHMgPSB7CiAgICAgICAgYmluZF90ZXh0Tm9kZTogYmluZF90ZXh0Tm9kZSwKICAgICAgICBiaW5kX25vZGU6IGJpbmRfbm9kZSwKICAgICAgICBiaW5kX2VsZW1lbnQ6IGJpbmRfZWxlbWVudCwKICAgICAgICBiaW5kX2NvbW1lbnQ6IGJpbmRfY29tbWVudCwKICAgICAgICBiaW5kX2F0dHI6IGJpbmRfYXR0ciwKICAgICAgICBiaW5kX2F0dHJDbGFzczogYmluZF9hdHRyQ2xhc3MsCiAgICAgICAgYmluZF9hdHRyU3R5bGU6IGJpbmRfYXR0clN0eWxlLAogICAgICAgIHJlc29sdmU6IHJlc29sdmVWYWx1ZSwKICAgICAgICBsMTBuVG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICBjcmVhdGVCaW5kaW5nRnVuY3Rpb246IGNyZWF0ZUJpbmRpbmdGdW5jdGlvbgogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zKSB7CiAgICAgICAgdmFyIGZuID0gZ2V0RnVuY3Rpb25zKHRva2VucywgdHJ1ZSwgdGhpcy5zb3VyY2UudXJsLCB0b2tlbnMuc291cmNlXywgIUNMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcsIGJhc2lzVGVtcGxhdGVJZE1hcmtlcik7CiAgICAgICAgdmFyIGNyZWF0ZUluc3RhbmNlOwogICAgICAgIHZhciBpbnN0YW5jZXMgPSB7fTsKICAgICAgICB2YXIgbDEwbk1hcCA9IHt9OwogICAgICAgIHZhciBsMTBuTGlua3MgPSBbXTsKICAgICAgICB2YXIgc2VlZCA9IDA7CiAgICAgICAgdmFyIHByb3RvID0gYnVpbGRIdG1sKHRva2Vucyk7CiAgICAgICAgdmFyIGlkID0gdGhpcy50ZW1wbGF0ZUlkOwogICAgICAgIHRlbXBsYXRlc1tpZF0gPSB7CiAgICAgICAgICB0ZW1wbGF0ZTogdGhpcywKICAgICAgICAgIGluc3RhbmNlczogaW5zdGFuY2VzCiAgICAgICAgfTsKICAgICAgICBpZiAoZm4uY3JlYXRlTDEwblN5bmMpIHsKICAgICAgICAgIHZhciBsMTBuUHJvdG9TeW5jID0gZm4uY3JlYXRlTDEwblN5bmMocHJvdG8sIGwxMG5NYXAsIGJpbmRfYXR0ciwgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBmbi5sMTBuS2V5c1tpXTsgaSsrKSBsMTBuUHJvdG9TeW5jKGtleSwgbDEwblRva2VuKGtleSkudmFsdWUpOwogICAgICAgICAgaWYgKGZuLmwxMG5LZXlzKSBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBmbi5sMTBuS2V5c1tpXTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBsaW5rID0gewogICAgICAgICAgICAgIHBhdGg6IGtleSwKICAgICAgICAgICAgICB0b2tlbjogbDEwblRva2VuKGtleSksCiAgICAgICAgICAgICAgaGFuZGxlcjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGwxMG5Qcm90b1N5bmModGhpcy5wYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2VzKSBpbnN0YW5jZXNba2V5XS50bXBsLnNldCh0aGlzLnBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGxpbmsudG9rZW4uYXR0YWNoKGxpbmsuaGFuZGxlciwgbGluayk7CiAgICAgICAgICAgIGwxMG5MaW5rcy5wdXNoKGxpbmspOwogICAgICAgICAgICBsaW5rID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY3JlYXRlSW5zdGFuY2UgPSBmbi5jcmVhdGVJbnN0YW5jZShpZCwgaW5zdGFuY2VzLCBwcm90bywgdG9vbHMsIGwxMG5NYXAsIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjcmVhdGVJbnN0YW5jZTogZnVuY3Rpb24ob2JqLCBvbkFjdGlvbiwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2VJZCA9IHNlZWQrKzsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY3JlYXRlSW5zdGFuY2UoaW5zdGFuY2VJZCwgb2JqLCBvbkFjdGlvbiwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgIGluc3RhbmNlc1tpbnN0YW5jZUlkXSA9IGluc3RhbmNlOwogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UudG1wbDsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXN0cm95SW5zdGFuY2U6IGZ1bmN0aW9uKHRtcGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlSWQgPSB0bXBsLnRlbXBsYXRlSWRfOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5oYW5kbGVyKSBpbnN0YW5jZS5iaW5kaW5nSW50ZXJmYWNlLmRldGFjaChpbnN0YW5jZS5jb250ZXh0LCBpbnN0YW5jZS5oYW5kbGVyLCBpbnN0YW5jZS50bXBsLnNldCk7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlLmF0dGFjaGVzKSByZXNvbHZlVmFsdWUuY2FsbChpbnN0YW5jZSwga2V5LCBudWxsKTsKICAgICAgICAgICAgICBkZWxldGUgaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAga2V5czogZm4ua2V5cywKICAgICAgICAgIGluc3RhbmNlc186IGluc3RhbmNlcywKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKHJlYnVpbGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpbms7IGxpbmsgPSBsMTBuTGlua3NbaV07IGkrKykgbGluay50b2tlbi5kZXRhY2gobGluay5oYW5kbGVyLCBsaW5rKTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlcykgewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlc1trZXldOwogICAgICAgICAgICAgIGlmIChyZWJ1aWxkICYmIGluc3RhbmNlLnJlYnVpbGQpIGluc3RhbmNlLnJlYnVpbGQuY2FsbChpbnN0YW5jZS5jb250ZXh0KTsKICAgICAgICAgICAgICBpZiAoIXJlYnVpbGQgfHwga2V5IGluIGluc3RhbmNlcykgewogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhbmRsZXIpIGluc3RhbmNlLmJpbmRpbmdJbnRlcmZhY2UuZGV0YWNoKGluc3RhbmNlLmNvbnRleHQsIGluc3RhbmNlLmhhbmRsZXIsIGluc3RhbmNlLnRtcGwuc2V0KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZS5hdHRhY2hlcykgcmVzb2x2ZVZhbHVlLmNhbGwoa2V5LCBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRlbXBsYXRlc1tpZF0gJiYgdGVtcGxhdGVzW2lkXS5pbnN0YW5jZXMgPT09IGluc3RhbmNlcykgZGVsZXRlIHRlbXBsYXRlc1tpZF07CiAgICAgICAgICAgIGZuID0gbnVsbDsKICAgICAgICAgICAgcHJvdG8gPSBudWxsOwogICAgICAgICAgICBsMTBuTWFwID0gbnVsbDsKICAgICAgICAgICAgbDEwbkxpbmtzID0gbnVsbDsKICAgICAgICAgICAgbDEwblByb3RvU3luYyA9IG51bGw7CiAgICAgICAgICAgIGluc3RhbmNlcyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBIdG1sVGVtcGxhdGUgPSBUZW1wbGF0ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZSIsCiAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSHRtbFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgSHRtbFRlbXBsYXRlU3dpdGNoZXIodmFsdWUpOwogICAgICAgIHJldHVybiBuZXcgSHRtbFRlbXBsYXRlKHZhbHVlKTsKICAgICAgfSwKICAgICAgYnVpbGRlcjogYnVpbGRlcgogICAgfSk7CiAgICB2YXIgSHRtbFRlbXBsYXRlU3dpdGNoZXIgPSBUZW1wbGF0ZVN3aXRjaGVyLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRlbXBsYXRlU3dpdGNoZXIiLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBIdG1sVGVtcGxhdGUKICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIG1hcmtlcjogYmFzaXNUZW1wbGF0ZUlkTWFya2VyLAogICAgICBUZW1wbGF0ZTogSHRtbFRlbXBsYXRlLAogICAgICBUZW1wbGF0ZVN3aXRjaGVyOiBIdG1sVGVtcGxhdGVTd2l0Y2hlcgogICAgfTsKICAgIGJhc2lzLnRlbXBsYXRlLmV4dGVuZCh7CiAgICAgIGdldERlYnVnSW5mb0J5SWQ6IGdldERlYnVnSW5mb0J5SWQsCiAgICAgIGJ1aWxkSHRtbDogYnVpbGRIdG1sLAogICAgICByZXNvbHZlVGVtcGxhdGVCeUlkOiByZXNvbHZlVGVtcGxhdGVCeUlkLAogICAgICByZXNvbHZlT2JqZWN0QnlJZDogcmVzb2x2ZU9iamVjdEJ5SWQsCiAgICAgIHJlc29sdmVUbXBsQnlJZDogcmVzb2x2ZVRtcGxCeUlkCiAgICB9KTsKICB9LAogICIyLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyICRudWxsID0gYmFzaXMuZm4uJG51bGw7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBXM0NTVVBQT1JUID0gISFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyOwogICAgdmFyIEVWRU5UX0hPTERFUiA9ICJfX2Jhc2lzRXZlbnRzIjsKICAgIHZhciBLRVkgPSB7CiAgICAgIEJBQ0tTUEFDRTogOCwKICAgICAgVEFCOiA5LAogICAgICBDVFJMX0VOVEVSOiAxMCwKICAgICAgRU5URVI6IDEzLAogICAgICBTSElGVDogMTYsCiAgICAgIENUUkw6IDE3LAogICAgICBBTFQ6IDE4LAogICAgICBFU0M6IDI3LAogICAgICBFU0NBUEU6IDI3LAogICAgICBTUEFDRTogMzIsCiAgICAgIFBBR0VVUDogMzMsCiAgICAgIFBBR0VET1dOOiAzNCwKICAgICAgRU5EOiAzNSwKICAgICAgSE9NRTogMzYsCiAgICAgIExFRlQ6IDM3LAogICAgICBVUDogMzgsCiAgICAgIFJJR0hUOiAzOSwKICAgICAgRE9XTjogNDAsCiAgICAgIElOU0VSVDogNDUsCiAgICAgIERFTEVURTogNDYsCiAgICAgIEYxOiAxMTIsCiAgICAgIEYyOiAxMTMsCiAgICAgIEYzOiAxMTQsCiAgICAgIEY0OiAxMTUsCiAgICAgIEY1OiAxMTYsCiAgICAgIEY2OiAxMTcsCiAgICAgIEY3OiAxMTgsCiAgICAgIEY4OiAxMTksCiAgICAgIEY5OiAxMjAsCiAgICAgIEYxMDogMTIxLAogICAgICBGMTE6IDEyMiwKICAgICAgRjEyOiAxMjMKICAgIH07CiAgICB2YXIgTU9VU0VfTEVGVCA9IHsKICAgICAgVkFMVUU6IDEsCiAgICAgIEJJVDogMQogICAgfTsKICAgIHZhciBNT1VTRV9NSURETEUgPSB7CiAgICAgIFZBTFVFOiAyLAogICAgICBCSVQ6IDQKICAgIH07CiAgICB2YXIgTU9VU0VfUklHSFQgPSB7CiAgICAgIFZBTFVFOiAzLAogICAgICBCSVQ6IDIKICAgIH07CiAgICB2YXIgQlJPV1NFUl9FVkVOVFMgPSB7CiAgICAgIG1vdXNld2hlZWw6IFsgIm1vdXNld2hlZWwiLCAiRE9NTW91c2VTY3JvbGwiIF0KICAgIH07CiAgICBmdW5jdGlvbiBicm93c2VyRXZlbnRzKGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gQlJPV1NFUl9FVkVOVFNbZXZlbnROYW1lXSB8fCBbIGV2ZW50TmFtZSBdOwogICAgfQogICAgdmFyIEV2ZW50ID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXZlbnQiLAogICAgICBLRVk6IEtFWSwKICAgICAgaW5pdDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnQpIGlmIChuYW1lICE9ICJyZXR1cm5WYWx1ZSIgJiYgbmFtZSAhPSAia2V5TG9jYXRpb24iICYmIG5hbWUgIT0gImxheWVyWCIgJiYgbmFtZSAhPSAibGF5ZXJZIikgaWYgKHR5cGVvZiBldmVudFtuYW1lXSAhPSAiZnVuY3Rpb24iICYmIG5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgdGhpc1tuYW1lXSA9IGV2ZW50W25hbWVdOwogICAgICAgIHZhciB0YXJnZXQgPSBzZW5kZXIoZXZlbnQpOwogICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQodGhpcywgewogICAgICAgICAgZXZlbnRfOiBldmVudCwKICAgICAgICAgIHNlbmRlcjogdGFyZ2V0LAogICAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgICBrZXk6IGtleShldmVudCksCiAgICAgICAgICBjaGFyQ29kZTogY2hhckNvZGUoZXZlbnQpLAogICAgICAgICAgbW91c2VMZWZ0OiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTEVGVCksCiAgICAgICAgICBtb3VzZU1pZGRsZTogbW91c2VCdXR0b24oZXZlbnQsIE1PVVNFX01JRERMRSksCiAgICAgICAgICBtb3VzZVJpZ2h0OiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfUklHSFQpLAogICAgICAgICAgbW91c2VYOiBtb3VzZVgoZXZlbnQpLAogICAgICAgICAgbW91c2VZOiBtb3VzZVkoZXZlbnQpLAogICAgICAgICAgd2hlZWxEZWx0YTogd2hlZWxEZWx0YShldmVudCkKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgc3RvcEJ1YmJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgY2FuY2VsQnViYmxlKHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgY2FuY2VsRGVmYXVsdCh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIGRpZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9wQnViYmxlKCk7CiAgICAgICAgdGhpcy5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHdyYXAoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50IGluc3RhbmNlb2YgRXZlbnQgPyBldmVudC5ldmVudF8gOiBldmVudCB8fCBnbG9iYWwuZXZlbnQ7CiAgICB9CiAgICBmdW5jdGlvbiBnZXROb2RlKHJlZikgewogICAgICByZXR1cm4gdHlwZW9mIHJlZiA9PSAic3RyaW5nIiA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJlZikgOiByZWY7CiAgICB9CiAgICBmdW5jdGlvbiBzZW5kZXIoZXZlbnQpIHsKICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09IDMgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgIH0KICAgIGZ1bmN0aW9uIGNhbmNlbEJ1YmJsZShldmVudCkgewogICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgZWxzZSBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsRGVmYXVsdChldmVudCkgewogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IGVsc2UgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgIH0KICAgIGZ1bmN0aW9uIGtpbGwoZXZlbnQsIG5vZGUpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIGlmIChub2RlKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50LCBraWxsKTsgZWxzZSB7CiAgICAgICAgY2FuY2VsRGVmYXVsdChldmVudCk7CiAgICAgICAgY2FuY2VsQnViYmxlKGV2ZW50KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24ga2V5KGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5rZXlDb2RlIHx8IGV2ZW50LndoaWNoIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBjaGFyQ29kZShldmVudCkgewogICAgICByZXR1cm4gZXZlbnQuY2hhckNvZGUgfHwgZXZlbnQua2V5Q29kZSB8fCAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VCdXR0b24oZXZlbnQsIGJ1dHRvbikgewogICAgICBpZiAodHlwZW9mIGV2ZW50LndoaWNoID09ICJudW1iZXIiKSByZXR1cm4gZXZlbnQud2hpY2ggPT0gYnV0dG9uLlZBTFVFOyBlbHNlIHJldHVybiAhIShldmVudC5idXR0b24gJiBidXR0b24uQklUKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1vdXNlWChldmVudCkgewogICAgICBpZiAoZXZlbnQuY2hhbmdlZFRvdWNoZXMpIHJldHVybiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWDsgZWxzZSBpZiAoInBhZ2VYIiBpbiBldmVudCkgcmV0dXJuIGV2ZW50LnBhZ2VYOyBlbHNlIHJldHVybiAiY2xpZW50WCIgaW4gZXZlbnQgPyBldmVudC5jbGllbnRYICsgKGRvY3VtZW50LmNvbXBhdE1vZGUgPT0gIkNTUzFDb21wYXQiID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgOiBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQpIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIG1vdXNlWShldmVudCkgewogICAgICBpZiAoZXZlbnQuY2hhbmdlZFRvdWNoZXMpIHJldHVybiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWTsgZWxzZSBpZiAoInBhZ2VZIiBpbiBldmVudCkgcmV0dXJuIGV2ZW50LnBhZ2VZOyBlbHNlIHJldHVybiAiY2xpZW50WSIgaW4gZXZlbnQgPyBldmVudC5jbGllbnRZICsgKGRvY3VtZW50LmNvbXBhdE1vZGUgPT0gIkNTUzFDb21wYXQiID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wKSA6IDA7CiAgICB9CiAgICBmdW5jdGlvbiB3aGVlbERlbHRhKGV2ZW50KSB7CiAgICAgIHZhciBkZWx0YSA9IDA7CiAgICAgIGlmICgid2hlZWxEZWx0YSIgaW4gZXZlbnQpIGRlbHRhID0gZXZlbnQud2hlZWxEZWx0YTsgZWxzZSBpZiAoZXZlbnQudHlwZSA9PSAiRE9NTW91c2VTY3JvbGwiKSBkZWx0YSA9IC1ldmVudC5kZXRhaWw7CiAgICAgIHJldHVybiBkZWx0YSAmJiBkZWx0YSAvIE1hdGguYWJzKGRlbHRhKTsKICAgIH0KICAgIHZhciBnbG9iYWxIYW5kbGVycyA9IHt9OwogICAgdmFyIGNhcHR1cmVIYW5kbGVycyA9IHt9OwogICAgdmFyIG5vQ2FwdHVyZVNjaGVtZSA9ICFXM0NTVVBQT1JUOwogICAgZnVuY3Rpb24gb2JzZXJ2ZUdsb2JhbEV2ZW50cyhldmVudCkgewogICAgICB2YXIgaGFuZGxlcnMgPSBhcnJheUZyb20oZ2xvYmFsSGFuZGxlcnNbZXZlbnQudHlwZV0pOwogICAgICB2YXIgY2FwdHVyZUhhbmRsZXIgPSBjYXB0dXJlSGFuZGxlcnNbZXZlbnQudHlwZV07CiAgICAgIHZhciB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwogICAgICBpZiAoY2FwdHVyZUhhbmRsZXIpIHsKICAgICAgICBjYXB0dXJlSGFuZGxlci5oYW5kbGVyLmNhbGwoY2FwdHVyZUhhbmRsZXIudGhpc09iamVjdCwgd3JhcHBlZEV2ZW50KTsKICAgICAgICBraWxsKGV2ZW50KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IGhhbmRsZXJzLmxlbmd0aDsgaS0tID4gMDsgKSB7CiAgICAgICAgICB2YXIgaGFuZGxlck9iamVjdCA9IGhhbmRsZXJzW2ldOwogICAgICAgICAgaGFuZGxlck9iamVjdC5oYW5kbGVyLmNhbGwoaGFuZGxlck9iamVjdC50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gY2FwdHVyZUV2ZW50KGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBpZiAoY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0pIHJlbGVhc2VFdmVudChldmVudFR5cGUpOwogICAgICBhZGRHbG9iYWxIYW5kbGVyKGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCk7CiAgICAgIGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdID0gewogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgdGhpc09iamVjdDogdGhpc09iamVjdAogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSkgewogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoaGFuZGxlck9iamVjdCkgewogICAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyT2JqZWN0LmhhbmRsZXIsIGhhbmRsZXJPYmplY3QudGhpc09iamVjdCk7CiAgICAgICAgZGVsZXRlIGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRHbG9iYWxIYW5kbGVyKGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICB2YXIgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGhhbmRsZXJzW2ldOyBpKyspIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgYWRkSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXSA9IFtdOwogICAgICB9CiAgICAgIGhhbmRsZXJzLnB1c2goewogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgdGhpc09iamVjdDogdGhpc09iamVjdAogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZUdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgewogICAgICAgICAgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHsKICAgICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICBpZiAoIWhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGRlbGV0ZSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgICAgIGlmIChub0NhcHR1cmVTY2hlbWUpIHJlbW92ZUhhbmRsZXIoZG9jdW1lbnQsIGV2ZW50VHlwZSwgJG51bGwpOyBlbHNlIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBvYnNlcnZlR2xvYmFsRXZlbnRzLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKCFub2RlKSB0aHJvdyAiYmFzaXMuZXZlbnQuYWRkSGFuZGxlcjogY2FuJ3QgYXR0YWNoIGV2ZW50IGxpc3RlbmVyIHRvIHVuZGVmaW5lZCI7CiAgICAgIGlmICh0eXBlb2YgaGFuZGxlciAhPSAiZnVuY3Rpb24iKSB0aHJvdyAiYmFzaXMuZXZlbnQuYWRkSGFuZGxlcjogaGFuZGxlciBpcyBub3QgYSBmdW5jdGlvbiI7CiAgICAgIGlmICghbm9kZVtFVkVOVF9IT0xERVJdKSBub2RlW0VWRU5UX0hPTERFUl0gPSB7fTsKICAgICAgdmFyIGhhbmRsZXJPYmplY3QgPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKCFldmVudFR5cGVIYW5kbGVycykgewogICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXSA9IFsgaGFuZGxlck9iamVjdCBdOwogICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSAmJiBldmVudCAmJiBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnQucmV0dXJuVmFsdWUgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KTsKICAgICAgICAgICAgICBpZiAoZXZlbnQuY2FuY2VsQnViYmxlID09PSB0cnVlKSByZXR1cm47CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgZXZlbnQucmV0dXJuVmFsdWUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgd3JhcHBlZEV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KSwgaXRlbTsgaXRlbSA9IGV2ZW50VHlwZUhhbmRsZXJzW2krK107ICkgaXRlbS5oYW5kbGVyLmNhbGwoaXRlbS50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIH07CiAgICAgICAgaWYgKFczQ1NVUFBPUlQpIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCwgZmFsc2UpOyBlbHNlIG5vZGUuYXR0YWNoRXZlbnQoIm9uIiArIGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGV2ZW50VHlwZUhhbmRsZXJzW2ldOyBpKyspIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSByZXR1cm47CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMucHVzaChoYW5kbGVyT2JqZWN0KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYWRkSGFuZGxlcnMobm9kZSwgaGFuZGxlcnMsIHRoaXNPYmplY3QpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBoYW5kbGVycykgYWRkSGFuZGxlcihub2RlLCBldmVudFR5cGUsIGhhbmRsZXJzW2V2ZW50VHlwZV0sIHRoaXNPYmplY3QpOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlSGFuZGxlcihub2RlLCBldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICBpZiAoZXZlbnRUeXBlSGFuZGxlcnMpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgewogICAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzLmxlbmd0aCkgY2xlYXJIYW5kbGVycyhub2RlLCBldmVudFR5cGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gY2xlYXJIYW5kbGVycyhub2RlLCBldmVudFR5cGUpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBldmVudFR5cGUgIT0gInN0cmluZyIpIHsKICAgICAgICAgIGZvciAoZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBldmVudFR5cGVIYW5kbGVycyA9IGhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICBpZiAoZXZlbnRUeXBlSGFuZGxlcnMpIHsKICAgICAgICAgICAgaWYgKG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcikgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5kZXRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICAgICAgICBkZWxldGUgaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVFdmVudChub2RlLCBldmVudFR5cGUsIGV2ZW50KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICB2YXIgaGFuZGxlcnMgPSBub2RlW0VWRU5UX0hPTERFUl07CiAgICAgIGlmIChoYW5kbGVycyAmJiBoYW5kbGVyc1tldmVudFR5cGVdKSBoYW5kbGVyc1tldmVudFR5cGVdLmZpcmVFdmVudChldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBvblVubG9hZChoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGFkZEhhbmRsZXIoZ2xvYmFsLCAidW5sb2FkIiwgaGFuZGxlciwgdGhpc09iamVjdCk7CiAgICB9CiAgICB2YXIgdGFnTmFtZUV2ZW50TWFwID0ge307CiAgICBmdW5jdGlvbiBnZXRFdmVudEluZm8oZXZlbnROYW1lLCB0YWdOYW1lKSB7CiAgICAgIGlmICghdGFnTmFtZSkgdGFnTmFtZSA9ICJkaXYiOwogICAgICB2YXIgaWQgPSB0YWdOYW1lICsgIi0iICsgZXZlbnROYW1lOwogICAgICBpZiAodGFnTmFtZUV2ZW50TWFwW2lkXSkgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF07IGVsc2UgewogICAgICAgIHZhciBzdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICB2YXIgYnViYmxlID0gZmFsc2U7CiAgICAgICAgaWYgKCFXM0NTVVBQT1JUKSB7CiAgICAgICAgICB2YXIgb25ldmVudCA9ICJvbiIgKyBldmVudE5hbWU7CiAgICAgICAgICB2YXIgaG9zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgdmFyIHRhcmdldCA9IGhvc3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKSk7CiAgICAgICAgICBob3N0W29uZXZlbnRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGJ1YmJsZSA9IHRydWU7CiAgICAgICAgICB9OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGFyZ2V0LmZpcmVFdmVudChvbmV2ZW50KTsKICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YWdOYW1lRXZlbnRNYXBbaWRdID0gewogICAgICAgICAgc3VwcG9ydGVkOiBzdXBwb3J0ZWQsCiAgICAgICAgICBidWJibGU6IGJ1YmJsZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHdyYXBFdmVudEZ1bmN0aW9uKGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCwgYXJnKSB7CiAgICAgICAgcmV0dXJuIGZuKHdyYXAoZXZlbnQpLCBhcmcpOwogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFczQ1NVUFBPUlQ6IFczQ1NVUFBPUlQsCiAgICAgIGJyb3dzZXJFdmVudHM6IGJyb3dzZXJFdmVudHMsCiAgICAgIGdldEV2ZW50SW5mbzogZ2V0RXZlbnRJbmZvLAogICAgICBLRVk6IEtFWSwKICAgICAgTU9VU0VfTEVGVDogTU9VU0VfTEVGVCwKICAgICAgTU9VU0VfUklHSFQ6IE1PVVNFX1JJR0hULAogICAgICBNT1VTRV9NSURETEU6IE1PVVNFX01JRERMRSwKICAgICAgRXZlbnQ6IEV2ZW50LAogICAgICBzZW5kZXI6IHdyYXBFdmVudEZ1bmN0aW9uKHNlbmRlciksCiAgICAgIGNhbmNlbEJ1YmJsZTogd3JhcEV2ZW50RnVuY3Rpb24oY2FuY2VsQnViYmxlKSwKICAgICAgY2FuY2VsRGVmYXVsdDogd3JhcEV2ZW50RnVuY3Rpb24oY2FuY2VsRGVmYXVsdCksCiAgICAgIGtpbGw6IHdyYXBFdmVudEZ1bmN0aW9uKGtpbGwpLAogICAgICBrZXk6IHdyYXBFdmVudEZ1bmN0aW9uKGtleSksCiAgICAgIGNoYXJDb2RlOiB3cmFwRXZlbnRGdW5jdGlvbihjaGFyQ29kZSksCiAgICAgIG1vdXNlQnV0dG9uOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZUJ1dHRvbiksCiAgICAgIG1vdXNlWDogd3JhcEV2ZW50RnVuY3Rpb24obW91c2VYKSwKICAgICAgbW91c2VZOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVkpLAogICAgICB3aGVlbERlbHRhOiB3cmFwRXZlbnRGdW5jdGlvbih3aGVlbERlbHRhKSwKICAgICAgYWRkR2xvYmFsSGFuZGxlcjogYWRkR2xvYmFsSGFuZGxlciwKICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcjogcmVtb3ZlR2xvYmFsSGFuZGxlciwKICAgICAgY2FwdHVyZUV2ZW50OiBjYXB0dXJlRXZlbnQsCiAgICAgIHJlbGVhc2VFdmVudDogcmVsZWFzZUV2ZW50LAogICAgICBhZGRIYW5kbGVyOiBhZGRIYW5kbGVyLAogICAgICBhZGRIYW5kbGVyczogYWRkSGFuZGxlcnMsCiAgICAgIHJlbW92ZUhhbmRsZXI6IHJlbW92ZUhhbmRsZXIsCiAgICAgIGNsZWFySGFuZGxlcnM6IGNsZWFySGFuZGxlcnMsCiAgICAgIGZpcmVFdmVudDogZmlyZUV2ZW50LAogICAgICBvblVubG9hZDogb25VbmxvYWQsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiMy5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmwxMG4iXSA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICByZXR1cm4gcmVzb2x2ZURpY3Rpb25hcnkodXJsKS51cGRhdGUoYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzb24iXShjb250ZW50LCB1cmwpKTsKICAgIH07CiAgICBmdW5jdGlvbiBvd25LZXlzKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB0b2tlbkluZGV4ID0gW107CiAgICB2YXIgdG9rZW5Db21wdXRlRm4gPSB7fTsKICAgIHZhciB0b2tlbkNvbXB1dGVzID0ge307CiAgICB2YXIgdXBkYXRlVG9rZW4gPSBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0OwogICAgdmFyIENvbXB1dGVUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db21wdXRlVG9rZW4iLAogICAgICBpbml0OiBmdW5jdGlvbih2YWx1ZSwgdG9rZW4pIHsKICAgICAgICB0b2tlbi5jb21wdXRlVG9rZW5zW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy50b2tlbi50eXBlID09ICJwbHVyYWwiID8gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbCh0aGlzLnZhbHVlKSA6IHRoaXMudmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXMudG9rZW4uZGljdGlvbmFyeS5nZXRWYWx1ZSh0aGlzLnRva2VuLm5hbWUgKyAiLiIgKyBrZXkpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY29tcHV0ZVRva2VucykgdGhpcy5jb21wdXRlVG9rZW5zW2tleV0uYXBwbHkoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuYXBwbHkuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbjogVmFsdWUgZm9yIGwxMG4gdG9rZW4gY2FuJ3QgYmUgc2V0IGRpcmVjdGx5LCBidXQgdGhyb3VnaCBkaWN0aW9uYXJ5IHVwZGF0ZSBvbmx5Iik7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyW2Jhc2lzLmdldHRlci5JRF0pLmpvaW4oIl8iKTsKICAgICAgICBpZiAodG9rZW5Db21wdXRlRm5bZW51bUlkXSkgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF07CiAgICAgICAgdmFyIHRva2VuID0gdGhpczsKICAgICAgICB2YXIgb2JqZWN0VG9rZW5NYXAgPSB7fTsKICAgICAgICB2YXIgdXBkYXRlVmFsdWUgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHVwZGF0ZVRva2VuLmNhbGwodGhpcywgZ2V0dGVyKG9iamVjdCkpOwogICAgICAgIH07CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgZGVsZXRlIG9iamVjdFRva2VuTWFwW29iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKGV2ZW50TmFtZSAhPSAiZGVzdHJveSIpIGhhbmRsZXJbZXZlbnROYW1lXSA9IHVwZGF0ZVZhbHVlOwogICAgICAgIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRW1pdHRlciA9PSBmYWxzZSkgdGhyb3cgImJhc2lzLmwxMG4uVG9rZW4jY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBFbWl0dGVyIjsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgIGlmICghY29tcHV0ZVRva2VuKSB7CiAgICAgICAgICAgIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXSA9IG5ldyBDb21wdXRlVG9rZW4oZ2V0dGVyKG9iamVjdCksIHRva2VuKTsKICAgICAgICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoaGFuZGxlciwgY29tcHV0ZVRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlVG9rZW47CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgY29tcHV0ZVRva2VuOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgQ29tcHV0ZVRva2VuKHZhbHVlLCB0aGlzKTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAodGhpcy50eXBlID09ICJwbHVyYWwiKSBuYW1lID0gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbChuYW1lKTsKICAgICAgICBpZiAodGhpcy5kaWN0aW9uYXJ5KSByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5LnRva2VuKHRoaXMubmFtZSArICIuIiArIG5hbWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jb21wdXRlVG9rZW5zKSB0aGlzLmNvbXB1dGVUb2tlbnNba2V5XS5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5jb21wdXRlVG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUb2tlbihwYXRoKSB7CiAgICAgIGlmIChwYXRoLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFtwYXJzZUludChwYXRoLnN1YnN0cigxKSwgMzYpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLm1hdGNoKC9eKC4rPylAKC4rKSQvKTsKICAgICAgICBpZiAocGFydHMpIHJldHVybiByZXNvbHZlRGljdGlvbmFyeShiYXNpcy5wYXRoLnJlc29sdmUocGFydHNbMl0pKS50b2tlbihwYXJ0c1sxXSk7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4udG9rZW4gYWNjZXB0cyB0b2tlbiByZWZlcmVuY2VzIGluIGZvcm1hdCBgdG9rZW4ucGF0aEBwYXRoL3RvL2RpY3QubDEwbmAgb25seSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZGljdGlvbmFyaWVzID0gW107CiAgICB2YXIgZGljdGlvbmFyeUJ5VXJsID0ge307CiAgICB2YXIgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyID0gbmV3IGJhc2lzLlRva2VuOwogICAgZnVuY3Rpb24gd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlbnMsIHBhdGgpIHsKICAgICAgdmFyIGN1bHR1cmVWYWx1ZXMgPSBkaWN0aW9uYXJ5LmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV07CiAgICAgIHBhdGggPSBwYXRoID8gcGF0aCArICIuIiA6ICIiOwogICAgICBmb3IgKHZhciBuYW1lIGluIHRva2VucykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodG9rZW5zLCBuYW1lKSkgewogICAgICAgIHZhciB0b2tlbk5hbWUgPSBwYXRoICsgbmFtZTsKICAgICAgICB2YXIgdG9rZW5WYWx1ZSA9IHRva2Vuc1tuYW1lXTsKICAgICAgICBjdWx0dXJlVmFsdWVzW3Rva2VuTmFtZV0gPSB0b2tlblZhbHVlOwogICAgICAgIGlmICh0b2tlblZhbHVlICYmICh0eXBlb2YgdG9rZW5WYWx1ZSA9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KHRva2VuVmFsdWUpKSkgd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlblZhbHVlLCB0b2tlbk5hbWUpOwogICAgICB9CiAgICB9CiAgICB2YXIgRGljdGlvbmFyeSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRpY3Rpb25hcnkiLAogICAgICB0b2tlbnM6IG51bGwsCiAgICAgIHR5cGVzOiBudWxsLAogICAgICBjdWx0dXJlVmFsdWVzOiBudWxsLAogICAgICBpbmRleDogTmFOLAogICAgICByZXNvdXJjZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29udGVudCkgewogICAgICAgIHRoaXMudG9rZW5zID0ge307CiAgICAgICAgdGhpcy50eXBlcyA9IHt9OwogICAgICAgIHRoaXMuY3VsdHVyZVZhbHVlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXggPSBkaWN0aW9uYXJpZXMucHVzaCh0aGlzKSAtIDE7CiAgICAgICAgaWYgKGJhc2lzLnJlc291cmNlLmlzUmVzb3VyY2UoY29udGVudCkpIHsKICAgICAgICAgIHZhciByZXNvdXJjZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdKSB7CiAgICAgICAgICAgIGRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdID0gdGhpczsKICAgICAgICAgICAgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLnNldChyZXNvdXJjZS51cmwpOwogICAgICAgICAgfQogICAgICAgICAgcmVzb3VyY2UuZmV0Y2goKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVzZSBvYmplY3QgYXMgY29udGVudCBvZiBkaWN0aW9uYXJ5IGlzIGV4cGVyaW1lbnRhbCBhbmQgbm90IHByb2R1Y3Rpb24tcmVhZHkiKTsKICAgICAgICAgIHRoaXMudXBkYXRlKGNvbnRlbnQgfHwge30pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhKSBkYXRhID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgZm9yICh2YXIgY3VsdHVyZSBpbiBkYXRhKSBpZiAoIS9eX3xfJC8udGVzdChjdWx0dXJlKSkgewogICAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzW2N1bHR1cmVdID0ge307CiAgICAgICAgICB3YWxrVG9rZW5zKHRoaXMsIGN1bHR1cmUsIGRhdGFbY3VsdHVyZV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnR5cGVzID0gZGF0YS5fbWV0YSAmJiBkYXRhLl9tZXRhLnR5cGUgfHwge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMudG9rZW5zKSB0aGlzLnRva2Vuc1trZXldLnNldFR5cGUodGhpcy50eXBlc1trZXldKTsKICAgICAgICB0aGlzLnN5bmNWYWx1ZXMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgc3luY1ZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgdG9rZW5OYW1lIGluIHRoaXMudG9rZW5zKSB1cGRhdGVUb2tlbi5jYWxsKHRoaXMudG9rZW5zW3Rva2VuTmFtZV0sIHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICI0LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB7CiAgICAgICAgICAgIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICAgIHNlbmRlcjogdGhpcywKICAgICAgICAgICAgICB0eXBlOiBldmVudE5hbWUsCiAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgIjUuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIHBhdGggPSBiYXNpcy5wYXRoOwogICAgdmFyIGFycmF5U2VhcmNoID0gYmFzaXMuYXJyYXkuc2VhcmNoOwogICAgdmFyIGFycmF5QWRkID0gYmFzaXMuYXJyYXkuYWRkOwogICAgdmFyIGFycmF5UmVtb3ZlID0gYmFzaXMuYXJyYXkucmVtb3ZlOwogICAgdmFyIHRlbXBsYXRlTGlzdCA9IFtdOwogICAgdmFyIHRtcGxGaWxlc01hcCA9IHt9OwogICAgdmFyIERFQ0xBUkFUSU9OX1ZFUlNJT04gPSAyOwogICAgdmFyIFRZUEVfRUxFTUVOVCA9IDE7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSAyOwogICAgdmFyIFRZUEVfQVRUUklCVVRFX0NMQVNTID0gNDsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9TVFlMRSA9IDU7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfRVZFTlQgPSA2OwogICAgdmFyIFRZUEVfVEVYVCA9IDM7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gODsKICAgIHZhciBUT0tFTl9UWVBFID0gMDsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IDE7CiAgICB2YXIgVE9LRU5fUkVGUyA9IDI7CiAgICB2YXIgQVRUUl9OQU1FID0gMzsKICAgIHZhciBBVFRSX1ZBTFVFID0gNDsKICAgIHZhciBBVFRSX0VWRU5UX1JYID0gL15ldmVudC0oLispJC87CiAgICB2YXIgQVRUUl9OQU1FX0JZX1RZUEUgPSB7CiAgICAgIDQ6ICJjbGFzcyIsCiAgICAgIDU6ICJzdHlsZSIKICAgIH07CiAgICB2YXIgQVRUUl9UWVBFX0JZX05BTUUgPSB7CiAgICAgICJjbGFzcyI6IFRZUEVfQVRUUklCVVRFX0NMQVNTLAogICAgICBzdHlsZTogVFlQRV9BVFRSSUJVVEVfU1RZTEUKICAgIH07CiAgICB2YXIgQVRUUl9WQUxVRV9JTkRFWCA9IHsKICAgICAgMjogQVRUUl9WQUxVRSwKICAgICAgNDogQVRUUl9WQUxVRSAtIDEsCiAgICAgIDU6IEFUVFJfVkFMVUUgLSAxLAogICAgICA2OiAyCiAgICB9OwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IDM7CiAgICB2YXIgRUxFTUVOVF9BVFRSUyA9IDQ7CiAgICB2YXIgRUxFTUVOVF9DSElMRFMgPSA1OwogICAgdmFyIFRFWFRfVkFMVUUgPSAzOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSAzOwogICAgdmFyIFNZTlRBWF9FUlJPUiA9ICJJbnZhbGlkIG9yIHVuc3VwcG9ydGVkIHN5bnRheCI7CiAgICB2YXIgVEVYVCA9IC8oKD86LnxbXHJcbl0pKj8pKFx7KD86bDEwbjooW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKD86XC5bYS16QS1aX11bYS16QS1aMC05X1wtXSopKig/OlwuXHtbYS16QS1aX11bYS16QS1aMC05X1wtXSpcfSk/KVx9KT98PChcL3whLS0oXHMqXHspPyk/fCQpL2c7CiAgICB2YXIgVEFHX05BTUUgPSAvKFthLXpfXVthLXowLTlcLV9dKikoOnxce3xccyooXC8/Pik/KS9pZzsKICAgIHZhciBBVFRSSUJVVEVfTkFNRV9PUl9FTkQgPSAvKFthLXpfXVthLXowLTlfXC1dKikoOnxce3w9fFxzKil8KFwvPz4pL2lnOwogICAgdmFyIENPTU1FTlQgPSAvKC58W1xyXG5dKSo/LS0+L2c7CiAgICB2YXIgQ0xPU0VfVEFHID0gLyhbYS16X11bYS16MC05X1wtXSooPzo6W2Etel9dW2EtejAtOV9cLV0qKT8pPi9pZzsKICAgIHZhciBSRUZFUkVOQ0UgPSAvKFthLXpfXVthLXowLTlfXSopKFx8fFx9XHMqKS9pZzsKICAgIHZhciBBVFRSSUJVVEVfVkFMVUUgPSAvIigoPzooXFwiKXxbXiJdKSo/KSJccyovZzsKICAgIHZhciBCUkVBS19UQUdfUEFSU0UgPSAvXi9nOwogICAgdmFyIFNJTkdMRVRPTl9UQUcgPSAvXihhcmVhfGJhc2V8YnJ8Y29sfGNvbW1hbmR8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbXxzb3VyY2UpJC9pOwogICAgdmFyIFRBR19JR05PUkVfQ09OVEVOVCA9IHsKICAgICAgdGV4dDogLygoPzoufFtcclxuXSkqPykoPzo8XC9iOnRleHQ+fCQpL2csCiAgICAgIHN0eWxlOiAvKCg/Oi58W1xyXG5dKSo/KSg/OjxcL2I6c3R5bGU+fCQpL2cKICAgIH07CiAgICB2YXIgcXVvdGVVbmVzY2FwZSA9IC9cXCIvZzsKICAgIHZhciB0b2tlbml6ZSA9IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciB0YWdTdGFjayA9IFtdOwogICAgICB2YXIgbGFzdFRhZyA9IHsKICAgICAgICBjaGlsZHM6IHJlc3VsdAogICAgICB9OwogICAgICB2YXIgc291cmNlVGV4dDsKICAgICAgdmFyIHRva2VuOwogICAgICB2YXIgYnVmZmVyUG9zOwogICAgICB2YXIgc3RhcnRQb3M7CiAgICAgIHZhciBwYXJzZVRhZyA9IGZhbHNlOwogICAgICB2YXIgdGV4dFN0YXRlRW5kUG9zID0gMDsKICAgICAgdmFyIHRleHRFbmRQb3M7CiAgICAgIHZhciBzdGF0ZSA9IFRFWFQ7CiAgICAgIHZhciBwb3MgPSAwOwogICAgICB2YXIgbTsKICAgICAgc291cmNlID0gc291cmNlLnRyaW0oKTsKICAgICAgcmVzdWx0Lndhcm5zID0gW107CiAgICAgIHdoaWxlIChwb3MgPCBzb3VyY2UubGVuZ3RoIHx8IHN0YXRlICE9IFRFWFQpIHsKICAgICAgICBzdGF0ZS5sYXN0SW5kZXggPSBwb3M7CiAgICAgICAgc3RhcnRQb3MgPSBwb3M7CiAgICAgICAgbSA9IHN0YXRlLmV4ZWMoc291cmNlKTsKICAgICAgICBpZiAoIW0gfHwgbS5pbmRleCAhPT0gcG9zKSB7CiAgICAgICAgICBpZiAoc3RhdGUgPT0gUkVGRVJFTkNFICYmIHRva2VuICYmIHRva2VuLnR5cGUgPT0gVFlQRV9DT01NRU5UKSB7CiAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyc2VUYWcpIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgIGlmICh0b2tlbikgbGFzdFRhZy5jaGlsZHMucG9wKCk7CiAgICAgICAgICBpZiAodG9rZW4gPSBsYXN0VGFnLmNoaWxkcy5wb3AoKSkgewogICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX1RFWFQgJiYgIXRva2VuLnJlZnMpIHRleHRTdGF0ZUVuZFBvcyAtPSAibGVuIiBpbiB0b2tlbiA/IHRva2VuLmxlbiA6IHRva2VuLnZhbHVlLmxlbmd0aDsgZWxzZSBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgcG9zID0gc3RhdGUubGFzdEluZGV4OwogICAgICAgIHN3aXRjaCAoc3RhdGUpIHsKICAgICAgICAgIGNhc2UgVEVYVDoKICAgICAgICAgICAgdGV4dEVuZFBvcyA9IHN0YXJ0UG9zICsgbVsxXS5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0ZXh0U3RhdGVFbmRQb3MgIT0gdGV4dEVuZFBvcykgewogICAgICAgICAgICAgIHNvdXJjZVRleHQgPSB0ZXh0U3RhdGVFbmRQb3MgPT0gc3RhcnRQb3MgPyBtWzFdIDogc291cmNlLnN1YnN0cmluZyh0ZXh0U3RhdGVFbmRQb3MsIHRleHRFbmRQb3MpOwogICAgICAgICAgICAgIHRva2VuID0gc291cmNlVGV4dC5yZXBsYWNlKC9ccyooXHJcbj98XG5ccj8pXHMqL2csICIiKTsKICAgICAgICAgICAgICBpZiAodG9rZW4pIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgbGVuOiBzb3VyY2VUZXh0Lmxlbmd0aCwKICAgICAgICAgICAgICAgIHZhbHVlOiB0b2tlbgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRleHRTdGF0ZUVuZFBvcyA9IHRleHRFbmRQb3M7CiAgICAgICAgICAgIGlmIChtWzNdKSB7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICByZWZzOiBbICJsMTBuOiIgKyBtWzNdIF0sCiAgICAgICAgICAgICAgICB2YWx1ZTogIntsMTBuOiIgKyBtWzNdICsgIn0iCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVsyXSA9PSAieyIpIHsKICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3MgLSAxOwogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBzdGF0ZSA9IFJFRkVSRU5DRTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtWzRdKSB7CiAgICAgICAgICAgICAgaWYgKG1bNF0gPT0gIi8iKSB7CiAgICAgICAgICAgICAgICB0b2tlbiA9IG51bGw7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IENMT1NFX1RBRzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9DT01NRU5UCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChtWzVdKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvcyAtIG1bNV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBzdGF0ZSA9IFJFRkVSRU5DRTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvczsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChtWzJdKSB7CiAgICAgICAgICAgICAgcGFyc2VUYWcgPSB0cnVlOwogICAgICAgICAgICAgIHRhZ1N0YWNrLnB1c2gobGFzdFRhZyk7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgIGF0dHJzOiBbXSwKICAgICAgICAgICAgICAgIGNoaWxkczogW10KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBsYXN0VGFnID0gdG9rZW47CiAgICAgICAgICAgICAgc3RhdGUgPSBUQUdfTkFNRTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ0xPU0VfVEFHOgogICAgICAgICAgICBpZiAobVsxXSAhPT0gKGxhc3RUYWcucHJlZml4ID8gbGFzdFRhZy5wcmVmaXggKyAiOiIgOiAiIikgKyBsYXN0VGFnLm5hbWUpIHsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIHZhbHVlOiAiPC8iICsgbVswXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUQUdfTkFNRToKICAgICAgICAgIGNhc2UgQVRUUklCVVRFX05BTUVfT1JfRU5EOgogICAgICAgICAgICBpZiAobVsyXSA9PSAiOiIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4ucHJlZml4KSBzdGF0ZSA9IEJSRUFLX1RBR19QQVJTRTsgZWxzZSB0b2tlbi5wcmVmaXggPSBtWzFdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzFdKSB7CiAgICAgICAgICAgICAgdG9rZW4ubmFtZSA9IG1bMV07CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEUpIGxhc3RUYWcuYXR0cnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMl0gPT0gInsiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9FTEVNRU5UKSBzdGF0ZSA9IFJFRkVSRU5DRTsgZWxzZSBzdGF0ZSA9IEJSRUFLX1RBR19QQVJTRTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVszXSkgewogICAgICAgICAgICAgIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKG1bM10gPT0gIi8+IiB8fCAhbGFzdFRhZy5wcmVmaXggJiYgU0lOR0xFVE9OX1RBRy50ZXN0KGxhc3RUYWcubmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChtWzNdICE9ICIvPiIpIHJlc3VsdC53YXJucy5wdXNoKCJUYWcgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiBkb2Vzbid0IGNsb3NlZCBleHBsaWNpdCAodXNlIGAvPmAgYXMgdGFnIGVuZGluZykiKTsKICAgICAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGxhc3RUYWcucHJlZml4ID09ICJiIiAmJiBsYXN0VGFnLm5hbWUgaW4gVEFHX0lHTk9SRV9DT05URU5UKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gVEFHX0lHTk9SRV9DT05URU5UW2xhc3RUYWcubmFtZV07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMl0gPT0gIj0iKSB7CiAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfVkFMVUU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDT01NRU5UOgogICAgICAgICAgICB0b2tlbi52YWx1ZSA9IHNvdXJjZS5zdWJzdHJpbmcoYnVmZmVyUG9zLCBwb3MgLSAzKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgUkVGRVJFTkNFOgogICAgICAgICAgICBpZiAodG9rZW4ucmVmcykgdG9rZW4ucmVmcy5wdXNoKG1bMV0pOyBlbHNlIHRva2VuLnJlZnMgPSBbIG1bMV0gXTsKICAgICAgICAgICAgaWYgKG1bMl0gIT0gInwiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgICBwb3MgLT0gbVsyXS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBzb3VyY2Uuc3Vic3RyaW5nKGJ1ZmZlclBvcywgcG9zKTsKICAgICAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9DT01NRU5UKSB7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50eXBlID09IFRZUEVfQVRUUklCVVRFICYmIHNvdXJjZVtwb3NdID09ICI9IikgewogICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9WQUxVRTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBBVFRSSUJVVEVfVkFMVUU6CiAgICAgICAgICAgIHRva2VuLnZhbHVlID0gbVsxXS5yZXBsYWNlKHF1b3RlVW5lc2NhcGUsICciJyk7CiAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVEFHX0lHTk9SRV9DT05URU5ULnRleHQ6CiAgICAgICAgICBjYXNlIFRBR19JR05PUkVfQ09OVEVOVC5zdHlsZToKICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgIHZhbHVlOiBtWzFdCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyAiUGFyc2VyIGJ1ZyI7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZSA9PSBURVhUKSB0ZXh0U3RhdGVFbmRQb3MgPSBwb3M7CiAgICAgIH0KICAgICAgaWYgKHRleHRTdGF0ZUVuZFBvcyAhPSBwb3MpIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICB2YWx1ZTogc291cmNlLnN1YnN0cmluZyh0ZXh0U3RhdGVFbmRQb3MsIHBvcykKICAgICAgfSk7CiAgICAgIGlmIChsYXN0VGFnLm5hbWUpIHJlc3VsdC53YXJucy5wdXNoKCJObyBjbG9zZSB0YWcgZm9yIDwiICsgbGFzdFRhZy5uYW1lICsgIj4iKTsKICAgICAgaWYgKCFyZXN1bHQud2FybnMubGVuZ3RoKSBkZWxldGUgcmVzdWx0Lndhcm5zOwogICAgICByZXN1bHQudGVtcGxhdGVUb2tlbnMgPSB0cnVlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIHZhciB0b2tlblRlbXBsYXRlID0ge307CiAgICB2YXIgTDEwblByb3h5VG9rZW4gPSBiYXNpcy5Ub2tlbi5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5MMTBuUHJveHlUb2tlbiIsCiAgICAgIHRva2VuOiBudWxsLAogICAgICB1cmw6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbih0b2tlbikgewogICAgICAgIHRoaXMudXJsID0gdG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwgKyAiOiIgKyB0b2tlbi5uYW1lOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICB0aGlzLnNldCgpOwogICAgICAgIHRva2VuLmF0dGFjaCh0aGlzLnNldCwgdGhpcyk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLlRva2VuLnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIgPyBwcm9jZXNzTWFya3VwKHRoaXMudG9rZW4udmFsdWUsIHRoaXMudG9rZW4ubmFtZSArICJAIiArIHRoaXMudG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwpIDogIiIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMudG9rZW4gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHByb2Nlc3NNYXJrdXAodmFsdWUsIGlkKSB7CiAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9ImJhc2lzanMtbWFya3VwIiBkYXRhLWJhc2lzanMtbDEwbj0iJyArIGlkICsgJyI+JyArIFN0cmluZyh2YWx1ZSkgKyAiPC9zcGFuPiI7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRMMTBuVGVtcGxhdGUodG9rZW4pIHsKICAgICAgaWYgKHR5cGVvZiB0b2tlbiA9PSAic3RyaW5nIikgdG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKHRva2VuKTsKICAgICAgaWYgKCF0b2tlbikgcmV0dXJuIG51bGw7CiAgICAgIHZhciBpZCA9IHRva2VuLmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRva2VuVGVtcGxhdGVbaWRdOwogICAgICBpZiAoIXRlbXBsYXRlKSB0ZW1wbGF0ZSA9IHRva2VuVGVtcGxhdGVbaWRdID0gbmV3IFRlbXBsYXRlKG5ldyBMMTBuUHJveHlUb2tlbih0b2tlbikpOwogICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5Jc29sYXRlTWFya2VyKCkgewogICAgICByZXR1cm4gImkiICsgYmFzaXMuZ2VuVUlEKCkgKyAiX18iOwogICAgfQogICAgZnVuY3Rpb24gaXNvbGF0ZUNzcyhjc3MsIHByZWZpeCkgewogICAgICBmdW5jdGlvbiBhZGRNYXRjaChwcmVmaXgpIHsKICAgICAgICBpZiAoaSA+IGxhc3RNYXRjaFBvcykgewogICAgICAgICAgcmVzdWx0LnB1c2goKHByZWZpeCB8fCAiIikgKyBjc3Muc3Vic3RyaW5nKGxhc3RNYXRjaFBvcywgaSkpOwogICAgICAgICAgbGFzdE1hdGNoUG9zID0gaTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgc3ltID0gY3NzLnNwbGl0KCIiKTsKICAgICAgdmFyIGxlbiA9IHN5bS5sZW5ndGg7CiAgICAgIHZhciBsYXN0TWF0Y2hQb3MgPSAwOwogICAgICB2YXIgYmxvY2tTY29wZSA9IGZhbHNlOwogICAgICB2YXIgc3RyU3ltOwogICAgICBpZiAoIXByZWZpeCkgcHJlZml4ID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgc3dpdGNoIChzeW1baV0pIHsKICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgIHN0clN5bSA9IHN5bVtpXTsKICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgewogICAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxcIikgaSsrOyBlbHNlIGlmIChzeW1baV0gPT0gc3RyU3ltKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICIvIjoKICAgICAgICAgICAgaWYgKHN5bVtpICsgMV0gPT0gIioiKSB7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIHdoaWxlICgrK2kgPCBsZW4pIGlmIChzeW1baV0gPT0gIioiICYmIHN5bVtpICsgMV0gPT0gIi8iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ7IjoKICAgICAgICAgICAgYmxvY2tTY29wZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAifSI6CiAgICAgICAgICAgIGJsb2NrU2NvcGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICIuIjoKICAgICAgICAgICAgaWYgKCFibG9ja1Njb3BlKSB7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIGFkZE1hdGNoKCk7CiAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgaWYgKCEvW2EtejAtOVwtXF9dLy50ZXN0KHN5bVtpXSkpIHsKICAgICAgICAgICAgICAgIGFkZE1hdGNoKHByZWZpeCk7CiAgICAgICAgICAgICAgICBpIC09IDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFkZE1hdGNoKCk7CiAgICAgIHJldHVybiByZXN1bHQuam9pbigiIik7CiAgICB9CiAgICB2YXIgbWFrZURlY2xhcmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBJREVOVCA9IC9eW2Etel9dW2EtejAtOV9cLV0qJC9pOwogICAgICB2YXIgQ0xBU1NfQVRUUl9QQVJUUyA9IC8oXFMrKS9nOwogICAgICB2YXIgQ0xBU1NfQVRUUl9CSU5ESU5HID0gL14oKD86W2Etel9dW2EtejAtOV9cLV0qKT8oPzo6KD86W2Etel9dW2EtejAtOV9cLV0qKT8pPylceygoYW5pbTopP1thLXpfXVthLXowLTlfXC1dKilcfSQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfUEFSVFMgPSAvXHMqW146XSs/XHMqOig/OlwoLio/XCl8Ii4qPyJ8Jy4qPyd8W147XSs/KSsoPzo7fCQpL2dpOwogICAgICB2YXIgU1RZTEVfUFJPUEVSVFkgPSAvXHMqKFteOl0rPylccyo6KCg/OlwoLio/XCl8Ii4qPyJ8Jy4qPyd8W147XSs/KSspOz8kL2k7CiAgICAgIHZhciBTVFlMRV9BVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKilcfS9pOwogICAgICB2YXIgQVRUUl9CSU5ESU5HID0gL1x7KFthLXpfXVthLXowLTlfXSp8bDEwbjpbYS16X11bYS16MC05X10qKD86XC5bYS16X11bYS16MC05X10qKSooPzpcLlx7W2Etel9dW2EtejAtOV9dKlx9KT8pXH0vaTsKICAgICAgdmFyIE5BTUVEX0NIQVJBQ1RFUl9SRUYgPSAvJihbYS16XSt8I1swLTldK3wjeFswLTlhLWZdezEsNH0pOz8vZ2k7CiAgICAgIHZhciB0b2tlbk1hcCA9IGJhc2lzLk5PREVfRU5WID8gX19ub2RlanNSZXF1aXJlKCIuL3RlbXBsYXRlL2h0bWxlbnRpdHkuanNvbiIpIDoge307CiAgICAgIHZhciB0b2tlbkVsZW1lbnQgPSAhYmFzaXMuTk9ERV9FTlYgPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSA6IG51bGw7CiAgICAgIHZhciBpbmNsdWRlU3RhY2sgPSBbXTsKICAgICAgdmFyIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9IHt9OwogICAgICBmdW5jdGlvbiBuYW1lKHRva2VuKSB7CiAgICAgICAgcmV0dXJuICh0b2tlbi5wcmVmaXggPyB0b2tlbi5wcmVmaXggKyAiOiIgOiAiIikgKyB0b2tlbi5uYW1lOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5hbWVkQ2hhclJlcGxhY2UobSwgdG9rZW4pIHsKICAgICAgICBpZiAoIXRva2VuTWFwW3Rva2VuXSkgewogICAgICAgICAgaWYgKHRva2VuLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gU3RyaW5nLmZyb21DaGFyQ29kZSh0b2tlbi5jaGFyQXQoMSkgPT0gIngiIHx8IHRva2VuLmNoYXJBdCgxKSA9PSAiWCIgPyBwYXJzZUludCh0b2tlbi5zdWJzdHIoMiksIDE2KSA6IHRva2VuLnN1YnN0cigxKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodG9rZW5FbGVtZW50KSB7CiAgICAgICAgICAgICAgdG9rZW5FbGVtZW50LmlubmVySFRNTCA9IG07CiAgICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gdG9rZW5FbGVtZW50LmZpcnN0Q2hpbGQgPyB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgOiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbk1hcFt0b2tlbl0gfHwgbTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1bnRva2VuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoTkFNRURfQ0hBUkFDVEVSX1JFRiwgbmFtZWRDaGFyUmVwbGFjZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVmTGlzdCh0b2tlbikgewogICAgICAgIHZhciBhcnJheSA9IHRva2VuLnJlZnM7CiAgICAgICAgaWYgKCFhcnJheSB8fCAhYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYnVpbGRBdHRyRXhwcmVzc2lvbihwYXJ0cykgewogICAgICAgIHZhciBiaW5kTmFtZTsKICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBhcnRzLmxlbmd0aDsgaisrKSBpZiAoaiAlIDIpIHsKICAgICAgICAgIGJpbmROYW1lID0gcGFydHNbal07CiAgICAgICAgICBpZiAoIW1hcFtiaW5kTmFtZV0pIHsKICAgICAgICAgICAgbWFwW2JpbmROYW1lXSA9IG5hbWVzLmxlbmd0aDsKICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleHByZXNzaW9uLnB1c2gobWFwW2JpbmROYW1lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChwYXJ0c1tqXSkgZXhwcmVzc2lvbi5wdXNoKHVudG9rZW4ocGFydHNbal0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFsgbmFtZXMsIGV4cHJlc3Npb24gXTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzQXR0cihuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBiaW5kaW5ncyA9IDA7CiAgICAgICAgdmFyIHBhcnRzOwogICAgICAgIHZhciBtOwogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChDTEFTU19BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gW107CiAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChtID0gcGFydC5tYXRjaChDTEFTU19BVFRSX0JJTkRJTkcpKSBiaW5kaW5ncy5wdXNoKFsgbVsxXSB8fCAiIiwgbVsyXSBdKTsgZWxzZSBuZXdWYWx1ZS5wdXNoKHBhcnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWUgPSBuZXdWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gW107CiAgICAgICAgICAgICAgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChTVFlMRV9BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtID0gcGFydC5tYXRjaChTVFlMRV9QUk9QRVJUWSk7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBtWzFdOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBtWzJdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlUGFydHMgPSB2YWx1ZS5zcGxpdChTVFlMRV9BVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWVQYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cHIgPSBidWlsZEF0dHJFeHByZXNzaW9uKHZhbHVlUGFydHMpOwogICAgICAgICAgICAgICAgICAgIGV4cHIucHVzaChwcm9wZXJ0eU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBwcm9wcy5wdXNoKHByb3BlcnR5TmFtZSArICI6ICIgKyB1bnRva2VuKHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgvXFMvLnRlc3QodmFsdWUpKSBiYXNpcy5kZXYud2FybigiQmFkIHZhbHVlIGZvciBzdHlsZSBhdHRyaWJ1dGUgKHZhbHVlIGlnbm9yZWQpOiIsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSBwcm9wcy5qb2luKCI7ICIpOwogICAgICAgICAgICAgIGlmICh2YWx1ZSkgdmFsdWUgKz0gIjsiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHBhcnRzID0gdmFsdWUuc3BsaXQoQVRUUl9CSU5ESU5HKTsKICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkgYmluZGluZ3MgPSBidWlsZEF0dHJFeHByZXNzaW9uKHBhcnRzKTsgZWxzZSB2YWx1ZSA9IHVudG9rZW4odmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYmluZGluZ3MgJiYgIWJpbmRpbmdzLmxlbmd0aCkgYmluZGluZ3MgPSAwOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBiaW5kaW5nOiBiaW5kaW5ncywKICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgIHR5cGU6IEFUVFJfVFlQRV9CWV9OQU1FW25hbWVdIHx8IDIKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGF0dHJzKHRva2VuLCBkZWNsVG9rZW4sIG9wdGltaXplU2l6ZSkgewogICAgICAgIHZhciBhdHRycyA9IHRva2VuLmF0dHJzOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgc3R5bGVBdHRyOwogICAgICAgIHZhciBkaXNwbGF5OwogICAgICAgIHZhciBtOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRyOyBhdHRyID0gYXR0cnNbaV07IGkrKykgewogICAgICAgICAgaWYgKGF0dHIucHJlZml4ID09ICJiIikgewogICAgICAgICAgICBzd2l0Y2ggKGF0dHIubmFtZSkgewogICAgICAgICAgICAgIGNhc2UgInJlZiI6CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IChhdHRyLnZhbHVlIHx8ICIiKS50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZWZzLmxlbmd0aDsgaisrKSBhZGRUb2tlblJlZihkZWNsVG9rZW4sIHJlZnNbal0pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic2hvdyI6CiAgICAgICAgICAgICAgY2FzZSAiaGlkZSI6CiAgICAgICAgICAgICAgICBkaXNwbGF5ID0gYXR0cjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG0gPSBhdHRyLm5hbWUubWF0Y2goQVRUUl9FVkVOVF9SWCkpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2gobVsxXSA9PSBhdHRyLnZhbHVlID8gWyBUWVBFX0FUVFJJQlVURV9FVkVOVCwgbVsxXSBdIDogWyBUWVBFX0FUVFJJQlVURV9FVkVOVCwgbVsxXSwgYXR0ci52YWx1ZSBdKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0ci5uYW1lLCBhdHRyLnZhbHVlKTsKICAgICAgICAgIHZhciBpdGVtID0gWyBwYXJzZWQudHlwZSwgcGFyc2VkLmJpbmRpbmcsIHJlZkxpc3QoYXR0cikgXTsKICAgICAgICAgIGlmIChwYXJzZWQudHlwZSA9PSAyKSBpdGVtLnB1c2gobmFtZShhdHRyKSk7CiAgICAgICAgICBpZiAocGFyc2VkLnZhbHVlICYmICghb3B0aW1pemVTaXplIHx8ICFwYXJzZWQuYmluZGluZyB8fCBwYXJzZWQudHlwZSAhPSAyKSkgaXRlbS5wdXNoKHBhcnNlZC52YWx1ZSk7CiAgICAgICAgICBpZiAocGFyc2VkLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfU1RZTEUpIHN0eWxlQXR0ciA9IGl0ZW07CiAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpc3BsYXkpIHsKICAgICAgICAgIGlmICghc3R5bGVBdHRyKSB7CiAgICAgICAgICAgIHN0eWxlQXR0ciA9IFsgVFlQRV9BVFRSSUJVVEVfU1RZTEUsIDAsIDAgXTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goc3R5bGVBdHRyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghc3R5bGVBdHRyWzFdKSBzdHlsZUF0dHJbMV0gPSBbXTsKICAgICAgICAgIHZhciBkaXNwbGF5RXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24oKGRpc3BsYXkudmFsdWUgfHwgZGlzcGxheS5uYW1lKS5zcGxpdChBVFRSX0JJTkRJTkcpKTsKICAgICAgICAgIGlmIChkaXNwbGF5RXhwclswXS5sZW5ndGggLSBkaXNwbGF5RXhwclsxXS5sZW5ndGgpIHsKICAgICAgICAgICAgc3R5bGVBdHRyWzNdID0gKHN0eWxlQXR0clszXSA/IHN0eWxlQXR0clszXSArICI7ICIgOiAiIikgKyAoZGlzcGxheS5uYW1lID09ICJzaG93IiBeIGRpc3BsYXkudmFsdWUgPT09ICIiID8gIiIgOiAiZGlzcGxheTogbm9uZSIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGRpc3BsYXkubmFtZSA9PSAic2hvdyIpIHN0eWxlQXR0clszXSA9IChzdHlsZUF0dHJbM10gPyBzdHlsZUF0dHJbM10gKyAiOyAiIDogIiIpICsgImRpc3BsYXk6IG5vbmUiOwogICAgICAgICAgICBzdHlsZUF0dHJbMV0ucHVzaChkaXNwbGF5RXhwci5jb25jYXQoImRpc3BsYXkiLCBkaXNwbGF5Lm5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPyByZXN1bHQgOiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFRva2VuUmVmKHRva2VuLCByZWZOYW1lKSB7CiAgICAgICAgaWYgKCF0b2tlbltUT0tFTl9SRUZTXSkgdG9rZW5bVE9LRU5fUkVGU10gPSBbXTsKICAgICAgICBhcnJheUFkZCh0b2tlbltUT0tFTl9SRUZTXSwgcmVmTmFtZSk7CiAgICAgICAgaWYgKHJlZk5hbWUgIT0gImVsZW1lbnQiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXS5sZW5ndGggPT0gMSA/IHJlZk5hbWUgOiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlbW92ZVRva2VuUmVmKHRva2VuLCByZWZOYW1lKSB7CiAgICAgICAgdmFyIGlkeCA9IHRva2VuW1RPS0VOX1JFRlNdLmluZGV4T2YocmVmTmFtZSk7CiAgICAgICAgaWYgKGlkeCAhPSAtMSkgewogICAgICAgICAgdmFyIGluZGV4QmluZGluZyA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiOwogICAgICAgICAgdG9rZW5bVE9LRU5fUkVGU10uc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICBpZiAoaW5kZXhCaW5kaW5nKSBpZiAoaWR4ID09IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDEpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHJlZk5hbWU7CiAgICAgICAgICBpZiAoIXRva2VuW1RPS0VOX1JFRlNdLmxlbmd0aCkgdG9rZW5bVE9LRU5fUkVGU10gPSAwOyBlbHNlIHsKICAgICAgICAgICAgaWYgKGluZGV4QmluZGluZykgdG9rZW5bVE9LRU5fQklORElOR1NdIC09IGlkeCA8IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRva2VuQXR0cnModG9rZW4pIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgaWYgKHRva2VuLmF0dHJzKSBmb3IgKHZhciBpID0gMCwgYXR0cjsgYXR0ciA9IHRva2VuLmF0dHJzW2ldOyBpKyspIHJlc3VsdFtuYW1lKGF0dHIpXSA9IGF0dHIudmFsdWU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRVbmlxdWUoYXJyYXksIGl0ZW1zKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgYXJyYXlBZGQoYXJyYXksIGl0ZW1zW2ldKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRTdHlsZXMoYXJyYXksIGl0ZW1zLCBwcmVmaXgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGl0ZW1zW2ldOyBpKyspIGlmIChpdGVtWzFdICE9PSBzdHlsZU5hbWVzcGFjZUlzb2xhdGUpIGl0ZW1bMV0gPSBwcmVmaXggKyBpdGVtWzFdOwogICAgICAgIGFycmF5LnVuc2hpZnQuYXBwbHkoYXJyYXksIGl0ZW1zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRTdHlsZSh0ZW1wbGF0ZSwgdG9rZW4sIHNyYywgaXNvbGF0ZVByZWZpeCkgewogICAgICAgIHZhciB1cmw7CiAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHNyYykpIGJhc2lzLmRldi53YXJuKCJCYWQgdXNhZ2U6IDxiOiIgKyB0b2tlbi5uYW1lICsgJyBzcmM9IicgKyBzcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgIHVybCA9IHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgc3JjKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICB1cmwgPSBiYXNpcy5yZXNvdXJjZS52aXJ0dWFsKCJjc3MiLCB0ZXh0ID8gdGV4dC52YWx1ZSA6ICIiLCB0ZW1wbGF0ZS5zb3VyY2VVcmwpLnVybDsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGUucmVzb3VyY2VzLnB1c2goWyB1cmwsIGlzb2xhdGVQcmVmaXggXSk7CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzKHRva2VucywgdGVtcGxhdGUsIG9wdGlvbnMsIGNvbnRleHQpIHsKICAgICAgICBmdW5jdGlvbiBtb2RpZnlBdHRyKHRva2VuLCBuYW1lLCBhY3Rpb24pIHsKICAgICAgICAgIHZhciBhdHRycyA9IHRva2VuQXR0cnModG9rZW4pOwogICAgICAgICAgaWYgKG5hbWUpIGF0dHJzLm5hbWUgPSBuYW1lOwogICAgICAgICAgaWYgKCFhdHRycy5uYW1lKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkluc3RydWN0aW9uIDxiOiIgKyB0b2tlbi5uYW1lICsgIj4gaGFzIG5vIGF0dHJpYnV0ZSBuYW1lIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghSURFTlQudGVzdChhdHRycy5uYW1lKSkgewogICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJCYWQgYXR0cmlidXRlIG5hbWUgYCIgKyBhdHRycy5uYW1lICsgImAiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluY2x1ZGVkVG9rZW4gPSB0b2tlblJlZk1hcFthdHRycy5yZWYgfHwgImVsZW1lbnQiXTsKICAgICAgICAgIGlmIChpbmNsdWRlZFRva2VuKSB7CiAgICAgICAgICAgIGlmIChpbmNsdWRlZFRva2VuLnRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgIHZhciBpdEF0dHJzID0gaW5jbHVkZWRUb2tlbi50b2tlbjsKICAgICAgICAgICAgICB2YXIgaXNFdmVudCA9IGF0dHJzLm5hbWUubWF0Y2goQVRUUl9FVkVOVF9SWCk7CiAgICAgICAgICAgICAgdmFyIGl0VHlwZSA9IGlzRXZlbnQgPyBUWVBFX0FUVFJJQlVURV9FVkVOVCA6IEFUVFJfVFlQRV9CWV9OQU1FW2F0dHJzLm5hbWVdIHx8IFRZUEVfQVRUUklCVVRFOwogICAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUVfSU5ERVhbaXRUeXBlXSB8fCBBVFRSX1ZBTFVFOwogICAgICAgICAgICAgIHZhciBpdEF0dHJUb2tlbiA9IGl0QXR0cnMgJiYgYXJyYXlTZWFyY2goaXRBdHRycywgYXR0cnMubmFtZSwgZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0FUVFJJQlVURV9FVkVOVCkgcmV0dXJuICJldmVudC0iICsgdG9rZW5bMV07CiAgICAgICAgICAgICAgICByZXR1cm4gQVRUUl9OQU1FX0JZX1RZUEVbdG9rZW5bVE9LRU5fVFlQRV1dIHx8IHRva2VuW0FUVFJfTkFNRV07CiAgICAgICAgICAgICAgfSwgRUxFTUVOVF9BVFRSUyk7CiAgICAgICAgICAgICAgaWYgKCFpdEF0dHJUb2tlbiAmJiBhY3Rpb24gIT0gInJlbW92ZSIpIHsKICAgICAgICAgICAgICAgIGlmIChpc0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuID0gWyBpdFR5cGUsIGlzRXZlbnRbMV0gXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuID0gWyBpdFR5cGUsIDAsIDAsIGl0VHlwZSA9PSBUWVBFX0FUVFJJQlVURSA/IGF0dHJzLm5hbWUgOiAiIiBdOwogICAgICAgICAgICAgICAgICBpZiAoaXRUeXBlID09IFRZUEVfQVRUUklCVVRFKSBpdEF0dHJUb2tlbi5wdXNoKCIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghaXRBdHRycykgewogICAgICAgICAgICAgICAgICBpdEF0dHJzID0gW107CiAgICAgICAgICAgICAgICAgIGluY2x1ZGVkVG9rZW4udG9rZW4ucHVzaChpdEF0dHJzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGl0QXR0cnMucHVzaChpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjbGFzc09yU3R5bGUgPSBhdHRycy5uYW1lID09ICJjbGFzcyIgfHwgYXR0cnMubmFtZSA9PSAic3R5bGUiOwogICAgICAgICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICJzZXQiOgogICAgICAgICAgICAgICAgICBpZiAoaXRBdHRyVG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0cnMudmFsdWUgPT0gaXNFdmVudFsxXSkgaXRBdHRyVG9rZW4ubGVuZ3RoID0gMjsgZWxzZSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSBhdHRycy52YWx1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHJzLm5hbWUsIGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdID0gcGFyc2VkLmJpbmRpbmc7CiAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5vcHRpbWl6ZVNpemUgfHwgIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSB8fCBjbGFzc09yU3R5bGUpIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IHBhcnNlZC52YWx1ZSB8fCAiIjsgZWxzZSBpdEF0dHJUb2tlbi5sZW5ndGggPSB2YWx1ZUlkeDsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzT3JTdHlsZSkgaWYgKCFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gJiYgIWl0QXR0clRva2VuW3ZhbHVlSWR4XSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQiOgogICAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0cnMubmFtZSwgYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICBpZiAoIWlzRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VkLmJpbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRyQmluZGluZ3MgPSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ckJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYXR0cnMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRCaW5kaW5nTWFwID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgb2xkQmluZGluZzsgb2xkQmluZGluZyA9IGF0dHJCaW5kaW5nc1tpXTsgaSsrKSBvbGRCaW5kaW5nTWFwW29sZEJpbmRpbmdbMl1dID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuZXdCaW5kaW5nOyBuZXdCaW5kaW5nID0gcGFyc2VkLmJpbmRpbmdbaV07IGkrKykgaWYgKG5ld0JpbmRpbmdbMl0gaW4gb2xkQmluZGluZ01hcCkgYXR0ckJpbmRpbmdzW29sZEJpbmRpbmdNYXBbbmV3QmluZGluZ1syXV1dID0gbmV3QmluZGluZzsgZWxzZSBhdHRyQmluZGluZ3MucHVzaChuZXdCaW5kaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJCaW5kaW5ncy5wdXNoLmFwcGx5KGF0dHJCaW5kaW5ncywgcGFyc2VkLmJpbmRpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5iaW5kaW5nWzBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUFkZCh0aGlzLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGF0dHJCaW5kaW5nc1swXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnNlZC5iaW5kaW5nWzFdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlZC5iaW5kaW5nWzFdW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSB2YWx1ZSA9IGF0dHJCaW5kaW5nc1swXS5pbmRleE9mKHBhcnNlZC5iaW5kaW5nWzBdW3ZhbHVlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJCaW5kaW5nc1sxXS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdID0gcGFyc2VkLmJpbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2xhc3NPclN0eWxlKSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU11bMV0udW5zaGlmdChpdEF0dHJUb2tlblt2YWx1ZUlkeF0pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsYXNzT3JTdHlsZSAmJiBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10pIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXVsxXS5wdXNoKGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZC52YWx1ZSkgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gKGl0QXR0clRva2VuW3ZhbHVlSWR4XSB8fCAiIikgKyAoaXRBdHRyVG9rZW5bdmFsdWVJZHhdICYmIChpc0V2ZW50IHx8IGNsYXNzT3JTdHlsZSkgPyAiICIgOiAiIikgKyBwYXJzZWQudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChjbGFzc09yU3R5bGUpIGlmICghaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdICYmICFpdEF0dHJUb2tlblt2YWx1ZUlkeF0pIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlIjoKICAgICAgICAgICAgICAgICAgaWYgKGl0QXR0clRva2VuKSBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJBdHRyaWJ1dGUgbW9kaWZpY2F0b3IgaXMgbm90IHJlZmVyZW5jZSB0byBlbGVtZW50IHRva2VuIChyZWZlcmVuY2UgbmFtZTogIiArIChhdHRycy5yZWYgfHwgImVsZW1lbnQiKSArICIpIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCB0b2tlbiwgaXRlbTsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgdmFyIHJlZnMgPSByZWZMaXN0KHRva2VuKTsKICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMSA/IHJlZnNbMF0gOiAwOwogICAgICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICAgIGlmICh0b2tlbi5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxBdHRycyA9IHRva2VuQXR0cnModG9rZW4pOwogICAgICAgICAgICAgICAgc3dpdGNoICh0b2tlbi5uYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOYW1lc3BhY2UgPSBlbEF0dHJzLm5hbWVzcGFjZSB8fCBlbEF0dHJzLm5zOwogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUlzb2xhdGUgPSBzdHlsZU5hbWVzcGFjZSA/IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA6IGNvbnRleHQgJiYgY29udGV4dC5pc29sYXRlIHx8ICIiOwogICAgICAgICAgICAgICAgICAgIHZhciBzcmMgPSBhZGRTdHlsZSh0ZW1wbGF0ZSwgdG9rZW4sIGVsQXR0cnMuc3JjLCBzdHlsZUlzb2xhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYyBpbiBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgPT0gZmFsc2UpIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuc3R5bGVOU1ByZWZpeFtzdHlsZU5hbWVzcGFjZV0gPSBzdHlsZU5hbWVzcGFjZUlzb2xhdGVbc3JjXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImlzb2xhdGUiOgogICAgICAgICAgICAgICAgICAgIGlmICghdGVtcGxhdGUuaXNvbGF0ZSkgdGVtcGxhdGUuaXNvbGF0ZSA9IGVsQXR0cnMucHJlZml4IHx8IG9wdGlvbnMuaXNvbGF0ZSB8fCBnZW5Jc29sYXRlTWFya2VyKCk7IGVsc2UgYmFzaXMuZGV2Lndhcm4oIjxiOmlzb2xhdGU+IGlzIHNldCBhbHJlYWR5IHRvIGAiICsgdGVtcGxhdGUuaXNvbGF0ZSArICJgIik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImwxMG4iOgogICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQpIHRlbXBsYXRlLndhcm5zLnB1c2goIjxiOmwxMG4+IG11c3QgYmUgZGVjbGFyZWQgYmVmb3JlIGFueSBgbDEwbjpgIHRva2VuIChpbnN0cnVjdGlvbiBpZ25vcmVkKSIpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnNyYykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGVsQXR0cnMuc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIGVsQXR0cnMuc3JjICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kaWN0VVJJID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkksIGVsQXR0cnMuc3JjKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImRlZmluZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCJuYW1lIiBpbiBlbEF0dHJzICYmICF0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZWxBdHRycy50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2wiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSA9IFsgZWxBdHRyc1siZGVmYXVsdCJdID09ICJ0cnVlIiA/IDEgOiAwIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVudW0iOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBlbEF0dHJzLnZhbHVlcyA/IGVsQXR0cnMudmFsdWVzLnRyaW0oKS5zcGxpdCgiICIpIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyB2YWx1ZXMuaW5kZXhPZihlbEF0dHJzWyJkZWZhdWx0Il0pICsgMSwgdmFsdWVzIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGRlZmluZSB0eXBlIGAiICsgZWxBdHRycy50eXBlICsgImAgZm9yICIgKyBlbEF0dHJzLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSBiYXNpcy5vYmplY3QuZXh0ZW5kKHRleHQsIHsKICAgICAgICAgICAgICAgICAgICAgIHJlZnM6IChlbEF0dHJzLnJlZiB8fCAiIikudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAibm90cmltIiBpbiBlbEF0dHJzID8gdGV4dC52YWx1ZSA6IHRleHQudmFsdWUucmVwbGFjZSgvXlxzKltcclxuXSt8W1xyXG5dXHMqJC9nLCAiIikKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaW5jbHVkZSI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlU3JjID0gZWxBdHRycy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlU3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNUZW1wbGF0ZVJlZiA9IC9eI1xkKyQvLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGlzRG9jdW1lbnRJZFJlZiA9IC9eaWQ6Ly50ZXN0KHRlbXBsYXRlU3JjKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSBpc1RlbXBsYXRlUmVmID8gdGVtcGxhdGVTcmMuc3Vic3RyKDEpIDogdGVtcGxhdGVTcmM7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IHRlbXBsYXRlTGlzdFt1cmxdOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RvY3VtZW50SWRSZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHVybC5zdWJzdHIoMykpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvXlthLXowLTlcLl0rJC9pLnRlc3QodXJsKSAmJiAhL1wudG1wbCQvLnRlc3QodXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IGdldFNvdXJjZUJ5UGF0aCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHVybCkpIGJhc2lzLmRldi53YXJuKCdCYWQgdXNhZ2U6IDxiOmluY2x1ZGUgc3JjPSInICsgdXJsICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UocGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkkgKyB1cmwpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgnPGI6aW5jbHVkZSBzcmM9IicgKyB0ZW1wbGF0ZVNyYyArICciPiBpcyBub3QgcmVzb2x2ZWQsIGluc3RydWN0aW9uIGlnbm9yZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oJzxiOmluY2x1ZGUgc3JjPSInICsgdGVtcGxhdGVTcmMgKyAnIj4gaXMgbm90IHJlc29sdmVkLCBpbnN0cnVjdGlvbiBpZ25vcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNvbGF0ZVByZWZpeCA9ICJpc29sYXRlIiBpbiBlbEF0dHJzID8gZWxBdHRycy5pc29sYXRlIHx8IGdlbklzb2xhdGVNYXJrZXIoKSA6ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVjbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0RvY3VtZW50SWRSZWYpIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVGVtcGxhdGVSZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2Uuc291cmNlLmJpbmRpbmdCcmlkZ2UpIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlLnNvdXJjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjbCA9IGdldERlY2xGcm9tU291cmNlKHJlc291cmNlLnNvdXJjZSwgcmVzb3VyY2UuYmFzZVVSSSwgdHJ1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjbCA9IGdldERlY2xGcm9tU291cmNlKHJlc291cmNlLCByZXNvdXJjZS51cmwgPyBwYXRoLmRpcm5hbWUocmVzb3VyY2UudXJsKSArICIvIiA6ICIiLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5yZXNvdXJjZXMgJiYgIm5vLXN0eWxlIiBpbiBlbEF0dHJzID09IGZhbHNlKSBhZGRTdHlsZXModGVtcGxhdGUucmVzb3VyY2VzLCBkZWNsLnJlc291cmNlcywgaXNvbGF0ZVByZWZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLmRlcHMpIGFkZFVuaXF1ZSh0ZW1wbGF0ZS5kZXBzLCBkZWNsLmRlcHMpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5sMTBuKSBhZGRVbmlxdWUodGVtcGxhdGUubDEwbiwgZGVjbC5sMTBuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmTWFwID0gbm9ybWFsaXplUmVmcyhkZWNsLnRva2Vucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnN0cnVjdGlvbnMgPSAodG9rZW4uY2hpbGRzIHx8IFtdKS5zbGljZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOU1ByZWZpeE1hcCA9IGJhc2lzLm9iamVjdC5zbGljZShkZWNsLnN0eWxlTlNQcmVmaXgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRyc1siY2xhc3MiXSkgaW5zdHJ1Y3Rpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICJiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiYXBwZW5kLWNsYXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyczogWyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJ2YWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZWxBdHRyc1siY2xhc3MiXQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gXQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuaWQpIGluc3RydWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4OiAiYiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInNldC1hdHRyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyczogWyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiaWQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAidmFsdWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVsQXR0cnMuaWQKICAgICAgICAgICAgICAgICAgICAgICAgICB9IF0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnJlZikgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIGVsQXR0cnMucmVmLnRyaW0oKS5zcGxpdCgvXHMrLykubWFwKGZ1bmN0aW9uKHJlZk5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUb2tlblJlZih0b2tlblJlZk1hcC5lbGVtZW50LnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjaGlsZDsgY2hpbGQgPSBpbnN0cnVjdGlvbnNbal07IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50eXBlID09IFRZUEVfRUxFTUVOVCAmJiBjaGlsZC5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlTmFtZXNwYWNlID0gY2hpbGRBdHRycy5uYW1lc3BhY2UgfHwgY2hpbGRBdHRycy5uczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVJc29sYXRlID0gc3R5bGVOYW1lc3BhY2UgPyBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgOiBpc29sYXRlUHJlZml4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcmMgPSBhZGRTdHlsZSh0ZW1wbGF0ZSwgY2hpbGQsIGNoaWxkQXR0cnMuc3JjLCBzdHlsZUlzb2xhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYyBpbiBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgPT0gZmFsc2UpIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVOU1ByZWZpeE1hcFtzdHlsZU5hbWVzcGFjZV0gPSBzdHlsZU5hbWVzcGFjZUlzb2xhdGVbc3JjXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJiZWZvcmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZnRlciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VPclJlbW92ZSA9IGNoaWxkLm5hbWUgPT0gInJlcGxhY2UiIHx8IGNoaWxkLm5hbWUgPT0gInJlbW92ZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyB8fCAhcmVwbGFjZU9yUmVtb3ZlID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gdG9rZW5SZWYub3duZXIuaW5kZXhPZih0b2tlblJlZi50b2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gWyBwb3MgKyAoY2hpbGQubmFtZSA9PSAiYWZ0ZXIiKSwgcmVwbGFjZU9yUmVtb3ZlIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lICE9ICJyZW1vdmUiKSBhcmdzID0gYXJncy5jb25jYXQocHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuUmVmLm93bmVyLnNwbGljZS5hcHBseSh0b2tlblJlZi5vd25lciwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJwcmVwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcyA9IHByb2Nlc3MoY2hpbGQuY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQubmFtZSA9PSAicHJlcGVuZCIpIHRva2VuLnNwbGljZS5hcHBseSh0b2tlbiwgWyBFTEVNRU5UX0FUVFJTLCAwIF0uY29uY2F0KGNoaWxkcykpOyBlbHNlIHRva2VuLnB1c2guYXBwbHkodG9rZW4sIGNoaWxkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJyZW1vdmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJhcHBlbmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZGQtcmVmIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIGNoaWxkQXR0cnMubmFtZSkgYWRkVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4pIHJlbW92ZVRva2VuUmVmKHRva2VuLCBjaGlsZEF0dHJzLm5hbWUgfHwgY2hpbGRBdHRycy5yZWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVua25vd24gaW5zdHJ1Y3Rpb24gdGFnIDxiOiIgKyBjaGlsZC5uYW1lICsgIj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgZGVjbC50b2tlbnMucHVzaC5hcHBseShkZWNsLnRva2VucywgcHJvY2VzcyhbIGNoaWxkIF0sIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIHJlbW92ZVRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sICJlbGVtZW50Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2lzLm9iamVjdC5jb21wbGV0ZSh0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4LCBzdHlsZU5TUHJlZml4TWFwKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzb2xhdGVQcmVmaXgpIGlzb2xhdGVUb2tlbnMoZGVjbC50b2tlbnMsIGlzb2xhdGVQcmVmaXgpOyBlbHNlIGlmIChkZWNsLmlzb2xhdGUgJiYgIXRlbXBsYXRlLmlzb2xhdGUpIHRlbXBsYXRlLmlzb2xhdGUgPSBvcHRpb25zLmlzb2xhdGUgfHwgZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaC5hcHBseShyZXN1bHQsIGRlY2wudG9rZW5zKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IGluY2x1ZGVTdGFjay5zbGljZShpbmNsdWRlU3RhY2suaW5kZXhPZihyZXNvdXJjZSkgfHwgMCkuY29uY2F0KHJlc291cmNlKS5tYXAoZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXMgPSByZXMuc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMgaW5zdGFuY2VvZiBMMTBuUHJveHlUb2tlbikgcmV0dXJuICJ7bDEwbjoiICsgcmVzLnRva2VuLm5hbWUgKyAiQCIgKyByZXMudG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwgKyAifSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy51cmwgfHwgIltpbmxpbmUgdGVtcGxhdGVdIjsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlJlY3Vyc2lvbjogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlY3Vyc2lvbiBpbiB0ZW1wbGF0ZTogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMSwgYmluZGluZ3MsIHJlZnMsIG5hbWUodG9rZW4pIF07CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIGF0dHJzKHRva2VuLCBpdGVtLCBvcHRpb25zLm9wdGltaXplU2l6ZSkgfHwgW10pOwogICAgICAgICAgICAgIGl0ZW0ucHVzaC5hcHBseShpdGVtLCBwcm9jZXNzKHRva2VuLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgaWYgKHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMiAmJiBhcnJheVNlYXJjaChyZWZzLCAiZWxlbWVudCIpKSBiaW5kaW5ncyA9IHJlZnNbKyFyZWZzLmxhc3RTZWFyY2hJbmRleF07CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBhYnNsMTBuKGJpbmRpbmdzLCB0ZW1wbGF0ZS5kaWN0VVJJKTsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGwxMG5CaW5kaW5nLnNwbGl0KC9bOkBce10vKTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHMubGVuZ3RoID09IDMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0c1syXSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHJlZnMsIGJpbmRpbmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVmcy5sZW5ndGggPT0gMCkgcmVmcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSAwOwogICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gdG9rZW4udmFsdWUucmVwbGFjZSgvXH0kLywgIkB1bmRlZmluZWR9Iik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5JZCA9IHBhcnRzLnNsaWNlKDEpLmpvaW4oIkAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihsMTBuSWQpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVGVtcGxhdGUgPSBnZXRMMTBuVGVtcGxhdGUobDEwblRva2VuKTsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChsMTBuVGVtcGxhdGUgJiYgbDEwblRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1tpLS1dID0gdG9rZW5pemUoJzxiOmluY2x1ZGUgc3JjPSIjJyArIGwxMG5UZW1wbGF0ZS50ZW1wbGF0ZUlkICsgJyIvPicpWzBdOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGFycmF5QWRkKHRlbXBsYXRlLmwxMG4sIGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMywgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICAgIGlmIChvcHRpb25zLm9wdGltaXplU2l6ZSAmJiAhYmluZGluZ3MgJiYgIXJlZnMpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGl0ZW0gPSBbIDgsIGJpbmRpbmdzLCByZWZzIF07CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSkgaWYgKCFyZWZzIHx8IHRva2VuLnZhbHVlICE9ICJ7IiArIHJlZnMuam9pbigifCIpICsgIn0iKSBpdGVtLnB1c2godW50b2tlbih0b2tlbi52YWx1ZSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGl0ZW1baXRlbS5sZW5ndGggLSAxXSA9PT0gMCkgaXRlbS5wb3AoKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWJzbDEwbih2YWx1ZSwgZGljdFVSSSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gInN0cmluZyIpIHJldHVybiB2YWx1ZTsKICAgICAgICB2YXIgcGFydHMgPSB2YWx1ZS5zcGxpdCgiOiIpOwogICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMiAmJiBwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHNbMV0uaW5kZXhPZigiQCIpID09IC0xKSBwYXJ0c1sxXSA9IHBhcnRzWzFdICsgIkAiICsgZGljdFVSSTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbigiOiIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVJlZnModG9rZW5zLCBkaWN0VVJJLCBtYXAsIHN0SWR4KSB7CiAgICAgICAgaWYgKCFtYXApIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSBjb250aW51ZTsKICAgICAgICAgIHZhciByZWZzID0gdG9rZW5bVE9LRU5fUkVGU107CiAgICAgICAgICBpZiAocmVmcykgewogICAgICAgICAgICBmb3IgKHZhciBqID0gcmVmcy5sZW5ndGggLSAxLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tqXTsgai0tKSB7CiAgICAgICAgICAgICAgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hcFtyZWZOYW1lXSkgcmVtb3ZlVG9rZW5SZWYobWFwW3JlZk5hbWVdLnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdID09IHJlZk5hbWUpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGogKyAxOwogICAgICAgICAgICAgIG1hcFtyZWZOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0b2tlbnMsCiAgICAgICAgICAgICAgICB0b2tlbjogdG9rZW4KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICAgIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGFic2wxMG4odG9rZW5bVE9LRU5fQklORElOR1NdLCBkaWN0VVJJKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0FUVFJJQlVURToKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSB0b2tlbltUT0tFTl9CSU5ESU5HU11bMF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSBhcnJheVtqXSA9IGFic2wxMG4oYXJyYXlbal0sIGRpY3RVUkkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgbm9ybWFsaXplUmVmcyh0b2tlbiwgZGljdFVSSSwgbWFwLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhcHBseURlZmluZXModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgc3RJZHgpIHsKICAgICAgICB2YXIgdW5wcmVkaWN0YWJsZSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgdG9rZW5UeXBlID0gdG9rZW5bVE9LRU5fVFlQRV07CiAgICAgICAgICBpZiAodG9rZW5UeXBlID09IFRZUEVfRUxFTUVOVCkgdW5wcmVkaWN0YWJsZSArPSBhcHBseURlZmluZXModG9rZW4sIHRlbXBsYXRlLCBvcHRpb25zLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MgfHwgdG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUVfSU5ERVhbdG9rZW5UeXBlXTsKICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0F0dHJWYWx1ZSA9ICh0b2tlblt2YWx1ZUlkeF0gfHwgIiIpLnRyaW0oKS5zcGxpdCgiICIpOwogICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kOyBiaW5kID0gYmluZGluZ3Nba107IGsrKykgewogICAgICAgICAgICAgICAgaWYgKGJpbmQubGVuZ3RoID4gMikgY29udGludWU7CiAgICAgICAgICAgICAgICB2YXIgYmluZE5hbWUgPSBiaW5kWzFdLnNwbGl0KCI6IikucG9wKCk7CiAgICAgICAgICAgICAgICB2YXIgYmluZERlZiA9IHRlbXBsYXRlLmRlZmluZXNbYmluZE5hbWVdOwogICAgICAgICAgICAgICAgaWYgKGJpbmREZWYpIHsKICAgICAgICAgICAgICAgICAgYmluZC5wdXNoLmFwcGx5KGJpbmQsIGJpbmREZWYpOwogICAgICAgICAgICAgICAgICBiaW5kRGVmLnVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBpZiAoYmluZERlZlswXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmLmxlbmd0aCA9PSAxKSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kTmFtZSk7IGVsc2UgYXJyYXlBZGQobmV3QXR0clZhbHVlLCBiaW5kWzBdICsgYmluZERlZlsxXVtiaW5kRGVmWzBdIC0gMV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJVbnByZWRpY3RhYmxlIHZhbHVlIGAiICsgYmluZE5hbWUgKyAiYCBpbiBjbGFzcyBiaW5kaW5nOiAiICsgYmluZFswXSArICJ7IiArIGJpbmRbMV0gKyAifSIpOwogICAgICAgICAgICAgICAgICB1bnByZWRpY3RhYmxlKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRva2VuW3ZhbHVlSWR4XSA9IG5ld0F0dHJWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub3B0aW1pemVTaXplICYmICF0b2tlblt2YWx1ZUlkeF0pIHRva2VuLmxlbmd0aCA9IHZhbHVlSWR4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bnByZWRpY3RhYmxlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzb2xhdGVUb2tlbnModG9rZW5zLCBpc29sYXRlLCB0ZW1wbGF0ZSwgc3RJZHgpIHsKICAgICAgICBmdW5jdGlvbiBwcm9jZXNzTmFtZShuYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID09IDEpIHJldHVybiBpc29sYXRlICsgcGFydHNbMF07CiAgICAgICAgICBpZiAoIXRlbXBsYXRlKSByZXR1cm4gbmFtZTsKICAgICAgICAgIGlmICghcGFydHNbMF0pIHJldHVybiBwYXJ0c1sxXTsKICAgICAgICAgIGlmIChwYXJ0c1swXSBpbiB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4ID09IGZhbHNlKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIk5hbWVzcGFjZSBgIiArIHBhcnRzWzBdICsgImAgaXMgbm90IGRlZmluZWQgaW4gdGVtcGxhdGUsIG5vIHByZWZpeCBhZGRlZCIpOwogICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4W3BhcnRzWzBdXSArIHBhcnRzWzFdOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gc3RJZHggfHwgMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB0b2tlblR5cGUgPSB0b2tlbltUT0tFTl9UWVBFXTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9FTEVNRU5UKSBpc29sYXRlVG9rZW5zKHRva2VuLCBpc29sYXRlLCB0ZW1wbGF0ZSwgRUxFTUVOVF9BVFRSUyk7CiAgICAgICAgICBpZiAodG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFX0NMQVNTIHx8IHRva2VuVHlwZSA9PSBUWVBFX0FUVFJJQlVURSAmJiB0b2tlbltBVFRSX05BTUVdID09ICJjbGFzcyIpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gdG9rZW5bVE9LRU5fQklORElOR1NdOwogICAgICAgICAgICB2YXIgdmFsdWVJbmRleCA9IEFUVFJfVkFMVUVfSU5ERVhbdG9rZW5UeXBlXTsKICAgICAgICAgICAgaWYgKHRva2VuW3ZhbHVlSW5kZXhdKSB0b2tlblt2YWx1ZUluZGV4XSA9IHRva2VuW3ZhbHVlSW5kZXhdLnNwbGl0KC9ccysvKS5tYXAocHJvY2Vzc05hbWUpLmpvaW4oIiAiKTsKICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSBmb3IgKHZhciBrID0gMCwgYmluZDsgYmluZCA9IGJpbmRpbmdzW2tdOyBrKyspIGJpbmRbMF0gPSBwcm9jZXNzTmFtZShiaW5kWzBdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1ha2VEZWNsYXJhdGlvbihzb3VyY2UsIGJhc2VVUkksIG9wdGlvbnMsIHNvdXJjZVVybCwgc291cmNlT3JpZ2luKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIHdhcm5zID0gW107CiAgICAgICAgdmFyIHNvdXJjZV87CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICAgIHNvdXJjZVVybDogc291cmNlVXJsLAogICAgICAgICAgYmFzZVVSSTogYmFzZVVSSSB8fCAiIiwKICAgICAgICAgIHRva2VuczogbnVsbCwKICAgICAgICAgIHJlc291cmNlczogW10sCiAgICAgICAgICBzdHlsZU5TUHJlZml4OiB7fSwKICAgICAgICAgIGRlcHM6IFtdLAogICAgICAgICAgbDEwbjogW10sCiAgICAgICAgICBkZWZpbmVzOiB7fSwKICAgICAgICAgIHVucHJlZGljdGFibGU6IHRydWUsCiAgICAgICAgICB3YXJuczogd2FybnMsCiAgICAgICAgICBpc29sYXRlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgcmVzdWx0LmRpY3RVUkkgPSBzb3VyY2VVcmwgPyBiYXNpcy5wYXRoLnJlc29sdmUoc291cmNlVXJsKSA6IGJhc2VVUkkgfHwgIiI7CiAgICAgICAgaWYgKHJlc3VsdC5kaWN0VVJJKSB7CiAgICAgICAgICB2YXIgZXh0bmFtZSA9IGJhc2lzLnBhdGguZXh0bmFtZShyZXN1bHQuZGljdFVSSSk7CiAgICAgICAgICBpZiAoZXh0bmFtZSAmJiBleHRuYW1lICE9ICIubDEwbiIpIHJlc3VsdC5kaWN0VVJJID0gcmVzdWx0LmRpY3RVUkkuc3Vic3RyKDAsIHJlc3VsdC5kaWN0VVJJLmxlbmd0aCAtIGV4dG5hbWUubGVuZ3RoKSArICIubDEwbiI7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlLnRlbXBsYXRlVG9rZW5zKSB7CiAgICAgICAgICBzb3VyY2VfID0gc291cmNlOwogICAgICAgICAgc291cmNlID0gdG9rZW5pemUoU3RyaW5nKHNvdXJjZSkpOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlLndhcm5zKSB3YXJucy5wdXNoLmFwcGx5KHdhcm5zLCBzb3VyY2Uud2FybnMpOwogICAgICAgIGluY2x1ZGVTdGFjay5wdXNoKHNvdXJjZU9yaWdpbiAhPT0gdHJ1ZSAmJiBzb3VyY2VPcmlnaW4gfHwge30pOwogICAgICAgIHJlc3VsdC50b2tlbnMgPSBwcm9jZXNzKHNvdXJjZSwgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBpbmNsdWRlU3RhY2sucG9wKCk7CiAgICAgICAgaWYgKCFyZXN1bHQudG9rZW5zKSByZXN1bHQudG9rZW5zID0gWyBbIDMsIDAsIDAsICIiIF0gXTsKICAgICAgICBpZiAoc291cmNlXykgcmVzdWx0LnRva2Vucy5zb3VyY2VfID0gc291cmNlXzsKICAgICAgICBhZGRUb2tlblJlZihyZXN1bHQudG9rZW5zWzBdLCAiZWxlbWVudCIpOwogICAgICAgIG5vcm1hbGl6ZVJlZnMocmVzdWx0LnRva2VucywgcmVzdWx0LmRpY3RVUkkpOwogICAgICAgIHJlc3VsdC51bnByZWRpY3RhYmxlID0gISFhcHBseURlZmluZXMocmVzdWx0LnRva2VucywgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBpZiAoL15bXmEtel0vaS50ZXN0KHJlc3VsdC5pc29sYXRlKSkgYmFzaXMuZGV2LmVycm9yKCJiYXNpcy50ZW1wbGF0ZTogaXNvbGF0aW9uIHByZWZpeCBgIiArIHJlc3VsdC5pc29sYXRlICsgImAgc2hvdWxkIG5vdCBzdGFydHMgd2l0aCBzeW1ib2wgb3RoZXIgdGhhbiBsZXR0ZXIsIG90aGVyd2lzZSBpdCBsZWFkcyB0byBpbmNvcnJlY3QgY3NzIGNsYXNzIG5hbWVzIGFuZCBicm9rZW4gc3R5bGVzIik7CiAgICAgICAgaWYgKGluY2x1ZGVTdGFjay5sZW5ndGggPT0gMCkgewogICAgICAgICAgaXNvbGF0ZVRva2VucyhyZXN1bHQudG9rZW5zLCByZXN1bHQuaXNvbGF0ZSB8fCAiIiwgcmVzdWx0KTsKICAgICAgICAgIGlmIChyZXN1bHQuaXNvbGF0ZSkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSByZXN1bHQucmVzb3VyY2VzW2ldOyBpKyspIGlmIChpdGVtWzFdICE9PSBzdHlsZU5hbWVzcGFjZUlzb2xhdGUpIGl0ZW1bMV0gPSByZXN1bHQuaXNvbGF0ZSArIGl0ZW1bMV07CiAgICAgICAgICByZXN1bHQucmVzb3VyY2VzID0gcmVzdWx0LnJlc291cmNlcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgICByZXR1cm4gIWJhc2lzLmFycmF5LnNlYXJjaChhcnJheSwgU3RyaW5nKGl0ZW0pLCBTdHJpbmcsIGlkeCArIDEpOwogICAgICAgICAgfSkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgdmFyIHVybCA9IGl0ZW1bMF07CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gaXRlbVsxXTsKICAgICAgICAgICAgaWYgKGlzb2xhdGUgPT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXNvbGF0ZSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVt1cmxdOwogICAgICAgICAgICBpZiAoIWlzb2xhdGUpIHJldHVybiB1cmw7CiAgICAgICAgICAgIHZhciByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlLnZpcnR1YWwoImNzcyIsICIiKS5yZWFkeShmdW5jdGlvbihjc3NSZXNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZVJlc291cmNlKCk7CiAgICAgICAgICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZChjc3NSZXNvdXJjZSwgewogICAgICAgICAgICAgICAgdXJsOiB1cmwgKyAiP2lzb2xhdGUtcHJlZml4PSIgKyBpc29sYXRlLAogICAgICAgICAgICAgICAgYmFzZVVSSTogYmFzaXMucGF0aC5kaXJuYW1lKHVybCkgKyAiLyIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBzb3VyY2VSZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHVybCkucmVhZHkoZnVuY3Rpb24oY3NzUmVzb3VyY2UpIHsKICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9IGlzb2xhdGVDc3MoY3NzUmVzb3VyY2UuY3NzVGV4dCB8fCAiIiwgaXNvbGF0ZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidG9hID09ICJmdW5jdGlvbiIpIGNzc1RleHQgKz0gIlxuLyojIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvbi9qc29uO2Jhc2U2NCwiICsgYnRvYSgneyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIicgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVybCArICciXSwnICsgJyJtYXBwaW5ncyI6IkFBQUEnICsgYmFzaXMuc3RyaW5nLnJlcGVhdCgiO0FBQ0EiLCBjc3NUZXh0LnNwbGl0KCJcbiIpLmxlbmd0aCkgKyAnIn0nKSArICIgKi8iOwogICAgICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShjc3NUZXh0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXNvdXJjZS51cmw7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlc3VsdC5kZWZpbmVzKSBpZiAoIXJlc3VsdC5kZWZpbmVzW2tleV0udXNlZCkgd2FybnMucHVzaCgiVW51c2VkIGRlZmluZSBmb3IgIiArIGtleSk7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5kZWZpbmVzOwogICAgICAgIGRlbGV0ZSByZXN1bHQubDEwblJlc29sdmVkOwogICAgICAgIGlmICghd2FybnMubGVuZ3RoKSByZXN1bHQud2FybnMgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSgpOwogICAgZnVuY3Rpb24gc3RhcnRVc2VSZXNvdXJjZSh1cmkpIHsKICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJpKS5mZXRjaCgpOwogICAgICBpZiAodHlwZW9mIHJlc291cmNlLnN0YXJ0VXNlID09ICJmdW5jdGlvbiIpIHJlc291cmNlLnN0YXJ0VXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wVXNlUmVzb3VyY2UodXJpKSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHVyaSkuZmV0Y2goKTsKICAgICAgaWYgKHR5cGVvZiByZXNvdXJjZS5zdG9wVXNlID09ICJmdW5jdGlvbiIpIHJlc291cmNlLnN0b3BVc2UoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHRlbXBsYXRlU291cmNlVXBkYXRlKCkgewogICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICBmb3IgKHZhciBpID0gMCwgYXR0YWNoOyBhdHRhY2ggPSB0aGlzLmF0dGFjaGVzX1tpXTsgaSsrKSBhdHRhY2guaGFuZGxlci5jYWxsKGF0dGFjaC5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVjbChhcnJheSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGlmIChhcnJheS5zb3VyY2VfKSByZXN1bHQuc291cmNlXyA9IGFycmF5LnNvdXJjZV87CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHJlc3VsdC5wdXNoKEFycmF5LmlzQXJyYXkoYXJyYXlbaV0pID8gY2xvbmVEZWNsKGFycmF5W2ldKSA6IGFycmF5W2ldKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlY2xGcm9tU291cmNlKHNvdXJjZSwgYmFzZVVSSSwgY2xvbmUsIG9wdGlvbnMpIHsKICAgICAgdmFyIHJlc3VsdCA9IHNvdXJjZTsKICAgICAgdmFyIHNvdXJjZVVybDsKICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gImZ1bmN0aW9uIikgewogICAgICAgIGJhc2VVUkkgPSAiYmFzZVVSSSIgaW4gc291cmNlID8gc291cmNlLmJhc2VVUkkgOiBiYXNlVVJJOwogICAgICAgIHNvdXJjZVVybCA9ICJ1cmwiIGluIHNvdXJjZSA/IHNvdXJjZS51cmwgOiBzb3VyY2VVcmw7CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0KCk7CiAgICAgIH0KICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQuZ2V0KCk7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkgewogICAgICAgIGlmIChjbG9uZSkgcmVzdWx0ID0gY2xvbmVEZWNsKHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgdG9rZW5zOiByZXN1bHQKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ICE9ICJvYmplY3QiIHx8ICFBcnJheS5pc0FycmF5KHJlc3VsdC50b2tlbnMpKSByZXN1bHQgPSBTdHJpbmcocmVzdWx0KTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAic3RyaW5nIikgcmVzdWx0ID0gbWFrZURlY2xhcmF0aW9uKHJlc3VsdCwgYmFzZVVSSSwgb3B0aW9ucywgc291cmNlVXJsLCBzb3VyY2UpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gbDEwbkhhbmRsZXIodmFsdWUpIHsKICAgICAgaWYgKHRoaXMudHlwZSAhPSAibWFya3VwIiAmJiB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcy50ZW1wbGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGJ1aWxkVGVtcGxhdGUoKSB7CiAgICAgIHZhciBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UodGhpcy5zb3VyY2UsIHRoaXMuYmFzZVVSSSwgZmFsc2UsIHsKICAgICAgICBpc29sYXRlOiB0aGlzLmdldElzb2xhdGVQcmVmaXgoKQogICAgICB9KTsKICAgICAgdmFyIGRlc3Ryb3lCdWlsZGVyID0gdGhpcy5kZXN0cm95QnVpbGRlcjsKICAgICAgdmFyIGZ1bmNzID0gdGhpcy5idWlsZGVyKGRlY2wudG9rZW5zLCB0aGlzKTsKICAgICAgdmFyIGRlcHMgPSB0aGlzLmRlcHNfOwogICAgICB2YXIgbDEwbiA9IHRoaXMubDEwbl87CiAgICAgIGlmIChkZXBzKSB7CiAgICAgICAgdGhpcy5kZXBzXyA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGRlcDsgZGVwID0gZGVwc1tpXTsgaSsrKSBkZXAuYmluZGluZ0JyaWRnZS5kZXRhY2goZGVwLCBidWlsZFRlbXBsYXRlLCB0aGlzKTsKICAgICAgfQogICAgICBpZiAobDEwbikgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBsMTBuW2ldOyBpKyspIGl0ZW0udG9rZW4uYmluZGluZ0JyaWRnZS5kZXRhY2goaXRlbS50b2tlbiwgbDEwbkhhbmRsZXIsIGl0ZW0pOwogICAgICBpZiAoZGVjbC5kZXBzICYmIGRlY2wuZGVwcy5sZW5ndGgpIHsKICAgICAgICBkZXBzID0gZGVjbC5kZXBzOwogICAgICAgIHRoaXMuZGVwc18gPSBkZXBzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZXA7IGRlcCA9IGRlcHNbaV07IGkrKykgZGVwLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKGRlcCwgYnVpbGRUZW1wbGF0ZSwgdGhpcyk7CiAgICAgIH0KICAgICAgaWYgKGRlY2wubDEwbikgewogICAgICAgIGwxMG4gPSBkZWNsLmwxMG47CiAgICAgICAgdGhpcy5sMTBuXyA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGwxMG5baV07IGkrKykgewogICAgICAgICAgdmFyIGwxMG5Ub2tlbiA9IGJhc2lzLmwxMG4udG9rZW4oa2V5KTsKICAgICAgICAgIGwxMG5Ub2tlbi5iaW5kaW5nQnJpZGdlLmF0dGFjaChsMTBuVG9rZW4sIGwxMG5IYW5kbGVyLCB0aGlzLmwxMG5fW2tleV0gPSB7CiAgICAgICAgICAgIHRlbXBsYXRlOiB0aGlzLAogICAgICAgICAgICB0b2tlbjogbDEwblRva2VuLAogICAgICAgICAgICB0eXBlOiBsMTBuVG9rZW4udHlwZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuY3JlYXRlSW5zdGFuY2UgPSBmdW5jcy5jcmVhdGVJbnN0YW5jZTsKICAgICAgdGhpcy5jbGVhckluc3RhbmNlID0gZnVuY3MuZGVzdHJveUluc3RhbmNlOwogICAgICB0aGlzLmdldEJpbmRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmFtZXM6IGZ1bmNzLmtleXMKICAgICAgICB9OwogICAgICB9OwogICAgICB0aGlzLmRlc3Ryb3lCdWlsZGVyID0gZnVuY3MuZGVzdHJveTsKICAgICAgdGhpcy5pbnN0YW5jZXNfID0gZnVuY3MuaW5zdGFuY2VzXzsKICAgICAgdGhpcy5kZWNsXyA9IGRlY2w7CiAgICAgIHZhciBkZWNsUmVzb3VyY2VzID0gZGVjbC5yZXNvdXJjZXMgJiYgZGVjbC5yZXNvdXJjZXMubGVuZ3RoID4gMCA/IGRlY2wucmVzb3VyY2VzIDogbnVsbDsKICAgICAgaWYgKGRlY2xSZXNvdXJjZXMpIGZvciAodmFyIGkgPSAwLCByZXM7IHJlcyA9IGRlY2xSZXNvdXJjZXNbaV07IGkrKykgc3RhcnRVc2VSZXNvdXJjZShyZXMpOwogICAgICBpZiAodGhpcy5yZXNvdXJjZXMpIGZvciAodmFyIGkgPSAwLCByZXM7IHJlcyA9IHRoaXMucmVzb3VyY2VzW2ldOyBpKyspIHN0b3BVc2VSZXNvdXJjZShyZXMpOwogICAgICB0aGlzLnJlc291cmNlcyA9IGRlY2xSZXNvdXJjZXM7CiAgICAgIGlmIChkZXN0cm95QnVpbGRlcikgZGVzdHJveUJ1aWxkZXIodHJ1ZSk7CiAgICB9CiAgICB2YXIgc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzID0ge307CiAgICBmdW5jdGlvbiBnZXRUZW1wbGF0ZUJ5RG9jdW1lbnRJZChpZCkgewogICAgICB2YXIgcmVzb2x2ZXIgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKGlkKTsKICAgICAgaWYgKHJlc29sdmVyLnRlbXBsYXRlKSByZXR1cm4gcmVzb2x2ZXIudGVtcGxhdGU7CiAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICB2YXIgc291cmNlID0gIiI7CiAgICAgIGlmIChob3N0ICYmIGhvc3QudGFnTmFtZSA9PSAiU0NSSVBUIiAmJiBob3N0LnR5cGUgPT0gInRleHQvYmFzaXMtdGVtcGxhdGUiKSBzb3VyY2UgPSBob3N0LnRleHRDb250ZW50IHx8IGhvc3QudGV4dDsgZWxzZSBpZiAoIWhvc3QpIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBzY3JpcHQgZWxlbWVudCB3aXRoIGlkIGAiICsgaWQgKyAiYCBub3QgZm91bmQiKTsgZWxzZSBiYXNpcy5kZXYud2FybignVGVtcGxhdGUgc2hvdWxkIGJlIGRlY2xhcmVkIGluIDxzY3JpcHQgdHlwZT0idGV4dC9iYXNpcy10ZW1wbGF0ZSI+IGVsZW1lbnQgKGlkIGAnICsgc291cmNlSWQgKyAiYCkiKTsKICAgICAgcmV0dXJuIHJlc29sdmVyLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHNvdXJjZUlkKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHNvdXJjZUJ5RG9jdW1lbnRJZFJlc29sdmVyc1tzb3VyY2VJZF07CiAgICAgIGlmICghcmVzb2x2ZXIpIHsKICAgICAgICByZXNvbHZlciA9IHNvdXJjZUJ5RG9jdW1lbnRJZFJlc29sdmVyc1tzb3VyY2VJZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBnZXRUZW1wbGF0ZUJ5RG9jdW1lbnRJZChzb3VyY2VJZCkuc291cmNlOwogICAgICAgIH07CiAgICAgICAgcmVzb2x2ZXIuaWQgPSBzb3VyY2VJZDsKICAgICAgICByZXNvbHZlci51cmwgPSAnPHNjcmlwdCBpZD0iJyArIHNvdXJjZUlkICsgJyIvPic7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc29sdmVyOwogICAgfQogICAgdmFyIFRlbXBsYXRlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZTogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBpZiAodGVtcGxhdGVMaXN0Lmxlbmd0aCA9PSA0MDk2KSB0aHJvdyAiVG9vIG1hbnkgdGVtcGxhdGVzIChtYXhpbXVtIDQwOTYpIjsKICAgICAgICB0aGlzLmF0dGFjaGVzXyA9IFtdOwogICAgICAgIHRoaXMuc2V0U291cmNlKHNvdXJjZSB8fCAiIik7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUlkID0gdGVtcGxhdGVMaXN0LnB1c2godGhpcykgLSAxOwogICAgICB9LAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgcmV0dXJuOwogICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnB1c2goewogICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24odGVtcGxhdGUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaXN0ZW5lcjsgbGlzdGVuZXIgPSB0ZW1wbGF0ZS5hdHRhY2hlc19baV07IGkrKykgaWYgKGxpc3RlbmVyLmhhbmRsZXIgPT0gaGFuZGxlciAmJiBsaXN0ZW5lci5jb250ZXh0ID09IGNvbnRleHQpIHsKICAgICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHt9CiAgICAgIH0sCiAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5zdGFuY2Uob2JqZWN0LCBhY3Rpb25DYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkge30sCiAgICAgIGdldElzb2xhdGVQcmVmaXg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiaSIgKyB0aGlzLnRlbXBsYXRlSWQgKyAiX18iOwogICAgICB9LAogICAgICBnZXRCaW5kaW5nOiBmdW5jdGlvbihiaW5kaW5ncykgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5nZXRCaW5kaW5nKGJpbmRpbmdzKTsKICAgICAgfSwKICAgICAgc2V0U291cmNlOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgb2xkU291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgaWYgKG9sZFNvdXJjZSAhPSBzb3VyY2UpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHZhciBtID0gc291cmNlLm1hdGNoKC9eKFthLXpdKyk6Lyk7CiAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IG1bMV07CiAgICAgICAgICAgICAgc291cmNlID0gc291cmNlLnN1YnN0cihtWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgc3dpdGNoIChwcmVmaXgpIHsKICAgICAgICAgICAgICAgIGNhc2UgImZpbGUiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZShzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImlkIjoKICAgICAgICAgICAgICAgICAgc291cmNlID0gcmVzb2x2ZVNvdXJjZUJ5RG9jdW1lbnRJZChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInRva2VucyI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnN0cmluZy50b09iamVjdChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBzb3VyY2UuaXNEZWNsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyYXciOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInBhdGgiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgoc291cmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLlRlbXBsYXRlLnNldFNvdXJjZTogVW5rbm93biBwcmVmaXggIiArIHByZWZpeCArICIgZm9yIHRlbXBsYXRlIHNvdXJjZSB3YXMgaW5nbm9yZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU291cmNlICYmIG9sZFNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIHZhciB0bXBsTGlzdCA9IG9sZFNvdXJjZS51cmwgJiYgdG1wbEZpbGVzTWFwW29sZFNvdXJjZS51cmxdOwogICAgICAgICAgICBpZiAodG1wbExpc3QpIHsKICAgICAgICAgICAgICBhcnJheVJlbW92ZSh0bXBsTGlzdCwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0bXBsTGlzdC5sZW5ndGgpIGRlbGV0ZSB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gIiI7CiAgICAgICAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZFNvdXJjZSwgdGVtcGxhdGVTb3VyY2VVcGRhdGUsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgICBpZiAoc291cmNlLnVybCkgewogICAgICAgICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGguZGlybmFtZShzb3VyY2UudXJsKSArICIvIjsKICAgICAgICAgICAgICBpZiAoIXRtcGxGaWxlc01hcFtzb3VyY2UudXJsXSkgdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdID0gW107CiAgICAgICAgICAgICAgYXJyYXlBZGQodG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UuYmluZGluZ0JyaWRnZS5hdHRhY2goc291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIHRlbXBsYXRlU291cmNlVXBkYXRlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgdGhpcy5kZXN0cm95QnVpbGRlcigpOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB0aGlzLmdldEJpbmRpbmcgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnN0YW5jZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmRlY2xfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCBjb25maWcpOwogICAgfTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHJ1bGVSZXRfOiBudWxsLAogICAgICB0ZW1wbGF0ZXNfOiBudWxsLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBUZW1wbGF0ZSwKICAgICAgcnVsZUV2ZW50czogbnVsbCwKICAgICAgcnVsZTogU3RyaW5nLAogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICB0aGlzLnJ1bGVSZXRfID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZXNfID0gW107CiAgICAgICAgdGhpcy5ydWxlID0gY29uZmlnLnJ1bGU7CiAgICAgICAgdmFyIGV2ZW50cyA9IGNvbmZpZy5ldmVudHM7CiAgICAgICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnJ1bGVFdmVudHMgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSB0aGlzLnJ1bGVFdmVudHNbZXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGNsZWFuZXIuYWRkKHRoaXMpOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB2YXIgcmV0ID0gdGhpcy5ydWxlKG9iamVjdCk7CiAgICAgICAgdmFyIGlkeCA9IHRoaXMucnVsZVJldF8uaW5kZXhPZihyZXQpOwogICAgICAgIGlmIChpZHggPT0gLTEpIHsKICAgICAgICAgIHRoaXMucnVsZVJldF8ucHVzaChyZXQpOwogICAgICAgICAgaWR4ID0gdGhpcy50ZW1wbGF0ZXNfLnB1c2gobmV3IHRoaXMudGVtcGxhdGVDbGFzcyhyZXQpKSAtIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc19baWR4XTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5ydWxlID0gbnVsbDsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBudWxsOwogICAgICAgIHRoaXMucnVsZVJldF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHN3aXRjaGVyKGV2ZW50cywgcnVsZSkgewogICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgIHZhciBydWxlID0gYXJncy5wb3AoKTsKICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaENvbmZpZyh7CiAgICAgICAgcnVsZTogcnVsZSwKICAgICAgICBldmVudHM6IGFyZ3Muam9pbigiICIpLnRyaW0oKS5zcGxpdCgvXHMrLykKICAgICAgfSk7CiAgICB9CiAgICB2YXIgVGhlbWUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UaGVtZSIsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoCiAgICB9KTsKICAgIHZhciBTb3VyY2VXcmFwcGVyID0gQ2xhc3MoYmFzaXMuVG9rZW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlNvdXJjZVdyYXBwZXIiLAogICAgICBwYXRoOiAiIiwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlLCBwYXRoKSB7CiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsICIiKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UgPyB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZ2V0KHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudCA9IGdldFRoZW1lU291cmNlKGN1cnJlbnRUaGVtZU5hbWUsIHRoaXMucGF0aCk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT0gY29udGVudCkgewogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMudmFsdWUgPSBjb250ZW50OwogICAgICAgICAgdGhpcy51cmwgPSBjb250ZW50ICYmIGNvbnRlbnQudXJsIHx8ICIiOwogICAgICAgICAgdGhpcy5iYXNlVVJJID0gKHR5cGVvZiBjb250ZW50ID09ICJvYmplY3QiIHx8IHR5cGVvZiBjb250ZW50ID09ICJmdW5jdGlvbiIpICYmICJiYXNlVVJJIiBpbiBjb250ZW50ID8gY29udGVudC5iYXNlVVJJIDogcGF0aC5kaXJuYW1lKHRoaXMudXJsKSArICIvIjsKICAgICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmF0dGFjaCh0aGlzLnZhbHVlLCBTb3VyY2VXcmFwcGVyLnByb3RvdHlwZS5hcHBseSwgdGhpcyk7CiAgICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVybCA9IG51bGw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gbnVsbDsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgdGhpcy5hcHBseSwgdGhpcyk7CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBnZXRTb3VyY2VCeVBhdGgoKSB7CiAgICAgIHZhciBwYXRoID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5qb2luKCIuIik7CiAgICAgIHZhciBzb3VyY2UgPSBzb3VyY2VCeVBhdGhbcGF0aF07CiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgc291cmNlID0gbmV3IFNvdXJjZVdyYXBwZXIoIiIsIHBhdGgpOwogICAgICAgIHNvdXJjZUJ5UGF0aFtwYXRoXSA9IHNvdXJjZTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgZnVuY3Rpb24gbm9ybWFsaXplKGxpc3QpIHsKICAgICAgdmFyIHVzZWQgPSB7fTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGlmICghdXNlZFtsaXN0W2ldXSkgewogICAgICAgIHVzZWRbbGlzdFtpXV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKGxpc3RbaV0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRGYWxsYmFjayh0aGVtZU5hbWUsIGxpc3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICByZXN1bHQuc291cmNlID0gbm9ybWFsaXplKGxpc3QpLmpvaW4oIi8iKTsKICAgICAgdmFyIHVzZWQgPSB7CiAgICAgICAgYmFzZTogdHJ1ZQogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbmFtZSA9IGxpc3RbaV0gfHwgImJhc2UiOwogICAgICAgIGlmIChuYW1lID09IHRoZW1lTmFtZSB8fCB1c2VkW25hbWVdKSBjb250aW51ZTsKICAgICAgICB2YXIgdGhlbWUgPSBnZXRUaGVtZShuYW1lKTsKICAgICAgICB1c2VkW25hbWVdID0gdHJ1ZTsKICAgICAgICByZXN1bHQucHVzaChuYW1lKTsKICAgICAgICBsaXN0LnNwbGljZS5hcHBseShsaXN0LCBbIGkgKyAxLCAwIF0uY29uY2F0KHRoZW1lc1tuYW1lXS5mYWxsYmFjaykpOwogICAgICB9CiAgICAgIHJlc3VsdC51bnNoaWZ0KHRoZW1lTmFtZSk7CiAgICAgIGlmICh0aGVtZU5hbWUgIT0gImJhc2UiKSByZXN1bHQucHVzaCgiYmFzZSIpOwogICAgICByZXN1bHQudmFsdWUgPSByZXN1bHQuam9pbigiLyIpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgewogICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1tuYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIG1hcDsgbWFwID0gc291cmNlTGlzdFtpXTsgaSsrKSBpZiAobWFwLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gbWFwW3BhdGhdOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiB0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpIHsKICAgICAgcmV0dXJuIHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjay5pbmRleE9mKHRoZW1lTmFtZSkgIT0gLTE7CiAgICB9CiAgICBmdW5jdGlvbiBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKSB7CiAgICAgIGdldFNvdXJjZUJ5UGF0aChwYXRoKS5zZXQoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWUoY2hhbmdlZCkgewogICAgICBiYXNpcy5kZXYubG9nKCJyZS1hcHBseSB0ZW1wbGF0ZXMiKTsKICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWUobmFtZSkgewogICAgICBpZiAoIW5hbWUpIG5hbWUgPSAiYmFzZSI7CiAgICAgIGlmICh0aGVtZXNbbmFtZV0pIHJldHVybiB0aGVtZXNbbmFtZV0udGhlbWU7CiAgICAgIGlmICghL14oW2EtejAtOVxfXC1dKykkLy50ZXN0KG5hbWUpKSB0aHJvdyAiQmFkIG5hbWUgZm9yIHRoZW1lIC0gIiArIG5hbWU7CiAgICAgIHZhciBzb3VyY2VzID0ge307CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gWyBzb3VyY2VzIF07CiAgICAgIHZhciB0aGVtZUludGVyZmFjZSA9IG5ldyBUaGVtZTsKICAgICAgdGhlbWVzW25hbWVdID0gewogICAgICAgIHRoZW1lOiB0aGVtZUludGVyZmFjZSwKICAgICAgICBzb3VyY2VzOiBzb3VyY2VzLAogICAgICAgIHNvdXJjZXNMaXN0OiBzb3VyY2VMaXN0LAogICAgICAgIGZhbGxiYWNrOiBbXQogICAgICB9OwogICAgICB2YXIgYWRkU291cmNlID0gZnVuY3Rpb24ocGF0aCwgc291cmNlKSB7CiAgICAgICAgaWYgKHBhdGggaW4gc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgc291cmNlc1twYXRoXSA9IHNvdXJjZTsKICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgfSBlbHNlIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBwYXRoIGAiICsgcGF0aCArICJgIGlzIGFscmVhZHkgZGVmaW5lZCBmb3IgdGhlbWUgYCIgKyBuYW1lICsgImAgKGRlZmluaXRpb24gaWdub3JlZCkuIik7CiAgICAgICAgcmV0dXJuIGdldFNvdXJjZUJ5UGF0aChwYXRoKTsKICAgICAgfTsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGVtZUludGVyZmFjZSwgewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgZmFsbGJhY2s6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhlbWVJbnRlcmZhY2UgIT09IGJhc2VUaGVtZSAmJiBhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV3RmFsbGJhY2sgPSB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiLyIpIDogW107CiAgICAgICAgICAgIHZhciBjaGFuZ2VkID0ge307CiAgICAgICAgICAgIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgbmV3RmFsbGJhY2spOwogICAgICAgICAgICBpZiAodGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZSAhPSBuZXdGYWxsYmFjay5zb3VyY2UpIHsKICAgICAgICAgICAgICB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlID0gbmV3RmFsbGJhY2suc291cmNlOwogICAgICAgICAgICAgIGJhc2lzLmRldi5sb2coImZhbGxiYWNrIGNoYW5nZWQiKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gdGhlbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyRmFsbGJhY2sgPSB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgKGN1ckZhbGxiYWNrLnNvdXJjZSB8fCAiIikuc3BsaXQoIi8iKSk7CiAgICAgICAgICAgICAgICBpZiAobmV3RmFsbGJhY2sudmFsdWUgIT0gY3VyRmFsbGJhY2sudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY2hhbmdlZFt0aGVtZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbWVzW3RoZW1lTmFtZV0uZmFsbGJhY2sgPSBuZXdGYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZUxpc3QgPSB0aGVtZXNbdGhlbWVOYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgICAgICAgICAgICAgc291cmNlTGlzdC5sZW5ndGggPSBuZXdGYWxsYmFjay5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlTGlzdC5sZW5ndGg7IGkrKykgc291cmNlTGlzdFtpXSA9IHRoZW1lc1tuZXdGYWxsYmFja1tpXV0uc291cmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFjayA9IHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgZm9yICh2YXIgdGhlbWVOYW1lIGluIGNoYW5nZWQpIHsKICAgICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QodGhlbWVOYW1lKSkgewogICAgICAgICAgICAgICAgc3luY0N1cnJlbnRUaGVtZSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNsaWNlKDEpOwogICAgICAgICAgcmVzdWx0LnNvdXJjZSA9IHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgZGVmaW5lOiBmdW5jdGlvbih3aGF0LCB3aGVyZXdpdGgpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAiZnVuY3Rpb24iKSB3aGF0ID0gd2hhdCgpOwogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hlcmV3aXRoID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHdoYXQ7CiAgICAgICAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSB3aGVyZXdpdGg7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXN1bHRba2V5XSA9IGFkZFNvdXJjZShuYW1lc3BhY2UgKyAiLiIgKyBrZXksIGRpY3Rpb25hcnlba2V5XSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHdoYXQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWRkU291cmNlKHdoYXQsIHdoZXJld2l0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoYXQ7CiAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgYWRkU291cmNlKHBhdGgsIGRpY3Rpb25hcnlbcGF0aF0pOwogICAgICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZmlyc3QgYXJndW1lbnQgZm9yIGJhc2lzLnRlbXBsYXRlLlRoZW1lI2RlZmluZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobmFtZSAhPSBjdXJyZW50VGhlbWVOYW1lKSB7CiAgICAgICAgICAgIGN1cnJlbnRUaGVtZU5hbWUgPSBuYW1lOwogICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBoYW5kbGVyOyBoYW5kbGVyID0gdGhlbWVDaGFuZ2VIYW5kbGVyc1tpXTsgaSsrKSBoYW5kbGVyLmZuLmNhbGwoaGFuZGxlci5jb250ZXh0LCBuYW1lKTsKICAgICAgICAgICAgYmFzaXMuZGV2LmluZm8oIlRlbXBsYXRlIHRoZW1lIHN3aXRjaGVkIHRvIGAiICsgbmFtZSArICJgIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICAgICAgfSwKICAgICAgICBnZXRTb3VyY2U6IGZ1bmN0aW9uKHBhdGgsIHdpdGhGYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHdpdGhGYWxsYmFjayA/IGdldFRoZW1lU291cmNlKG5hbWUsIHBhdGgpIDogc291cmNlc1twYXRoXTsKICAgICAgICB9LAogICAgICAgIGRyb3A6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgIGlmIChzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGgpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2VzW3BhdGhdOwogICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QobmFtZSkpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKG5hbWUsIFtdKTsKICAgICAgc291cmNlTGlzdC5wdXNoKHRoZW1lcy5iYXNlLnNvdXJjZXMpOwogICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICB9CiAgICB2YXIgdGhlbWVzID0ge307CiAgICB2YXIgc291cmNlQnlQYXRoID0ge307CiAgICB2YXIgYmFzZVRoZW1lID0gZ2V0VGhlbWUoKTsKICAgIHZhciBjdXJyZW50VGhlbWVOYW1lID0gImJhc2UiOwogICAgdmFyIHRoZW1lQ2hhbmdlSGFuZGxlcnMgPSBbXTsKICAgIGZ1bmN0aW9uIG9uVGhlbWVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgdGhlbWVDaGFuZ2VIYW5kbGVycy5wdXNoKHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudFRoZW1lTmFtZSk7CiAgICB9CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIHBhdGggaW4gc291cmNlQnlQYXRoKSBzb3VyY2VCeVBhdGhbcGF0aF0uZGVzdHJveSgpOwogICAgICAgIHRoZW1lcyA9IG51bGw7CiAgICAgICAgc291cmNlQnlQYXRoID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdGVtcGxhdGU7IHRlbXBsYXRlID0gdGVtcGxhdGVMaXN0W2ldOyBpKyspIHRlbXBsYXRlLmRlc3Ryb3koKTsKICAgICAgICB0ZW1wbGF0ZUxpc3QgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUNMQVJBVElPTl9WRVJTSU9OOiBERUNMQVJBVElPTl9WRVJTSU9OLAogICAgICBUWVBFX0VMRU1FTlQ6IFRZUEVfRUxFTUVOVCwKICAgICAgVFlQRV9BVFRSSUJVVEU6IFRZUEVfQVRUUklCVVRFLAogICAgICBUWVBFX0FUVFJJQlVURV9DTEFTUzogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIFRZUEVfQVRUUklCVVRFX1NUWUxFOiBUWVBFX0FUVFJJQlVURV9TVFlMRSwKICAgICAgVFlQRV9BVFRSSUJVVEVfRVZFTlQ6IFRZUEVfQVRUUklCVVRFX0VWRU5ULAogICAgICBUWVBFX1RFWFQ6IFRZUEVfVEVYVCwKICAgICAgVFlQRV9DT01NRU5UOiBUWVBFX0NPTU1FTlQsCiAgICAgIFRPS0VOX1RZUEU6IFRPS0VOX1RZUEUsCiAgICAgIFRPS0VOX0JJTkRJTkdTOiBUT0tFTl9CSU5ESU5HUywKICAgICAgVE9LRU5fUkVGUzogVE9LRU5fUkVGUywKICAgICAgQVRUUl9OQU1FOiBBVFRSX05BTUUsCiAgICAgIEFUVFJfVkFMVUU6IEFUVFJfVkFMVUUsCiAgICAgIEFUVFJfTkFNRV9CWV9UWVBFOiBBVFRSX05BTUVfQllfVFlQRSwKICAgICAgRUxFTUVOVF9OQU1FOiBFTEVNRU5UX05BTUUsCiAgICAgIEVMRU1FTlRfQVRUUlM6IEVMRU1FTlRfQVRUUlMsCiAgICAgIEVMRU1FTlRfQ0hJTERTOiBFTEVNRU5UX0NISUxEUywKICAgICAgVEVYVF9WQUxVRTogVEVYVF9WQUxVRSwKICAgICAgQ09NTUVOVF9WQUxVRTogQ09NTUVOVF9WQUxVRSwKICAgICAgTDEwblByb3h5VG9rZW46IEwxMG5Qcm94eVRva2VuLAogICAgICBUZW1wbGF0ZVN3aXRjaENvbmZpZzogVGVtcGxhdGVTd2l0Y2hDb25maWcsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IFRlbXBsYXRlU3dpdGNoZXIsCiAgICAgIFRlbXBsYXRlOiBUZW1wbGF0ZSwKICAgICAgU291cmNlV3JhcHBlcjogU291cmNlV3JhcHBlciwKICAgICAgc3dpdGNoZXI6IHN3aXRjaGVyLAogICAgICB0b2tlbml6ZTogdG9rZW5pemUsCiAgICAgIGlzb2xhdGVDc3M6IGlzb2xhdGVDc3MsCiAgICAgIGdldERlY2xGcm9tU291cmNlOiBnZXREZWNsRnJvbVNvdXJjZSwKICAgICAgbWFrZURlY2xhcmF0aW9uOiBtYWtlRGVjbGFyYXRpb24sCiAgICAgIGdldEwxMG5UZW1wbGF0ZTogZ2V0TDEwblRlbXBsYXRlLAogICAgICBUaGVtZTogVGhlbWUsCiAgICAgIHRoZW1lOiBnZXRUaGVtZSwKICAgICAgZ2V0VGhlbWVMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXModGhlbWVzKTsKICAgICAgfSwKICAgICAgY3VycmVudFRoZW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLnRoZW1lOwogICAgICB9LAogICAgICBzZXRUaGVtZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBnZXRUaGVtZShuYW1lKS5hcHBseSgpOwogICAgICB9LAogICAgICBvblRoZW1lQ2hhbmdlOiBvblRoZW1lQ2hhbmdlLAogICAgICBkZWZpbmU6IGJhc2VUaGVtZS5kZWZpbmUsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoLAogICAgICBnZXRQYXRoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLm9iamVjdC5rZXlzKHNvdXJjZUJ5UGF0aCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9FTEVNRU5UOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gYmFzaXMudGVtcGxhdGUuVFlQRV9BVFRSSUJVVEU7CiAgICB2YXIgVFlQRV9URVhUID0gYmFzaXMudGVtcGxhdGUuVFlQRV9URVhUOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQ09NTUVOVDsKICAgIHZhciBUT0tFTl9UWVBFID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fVFlQRTsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX0JJTkRJTkdTOwogICAgdmFyIFRPS0VOX1JFRlMgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9SRUZTOwogICAgdmFyIEFUVFJfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRTsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRV9CWV9UWVBFOwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfTkFNRTsKICAgIHZhciBFTEVNRU5UX0FUVFJTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9BVFRSUzsKICAgIHZhciBFTEVNRU5UX0NISUxEUyA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfQ0hJTERTOwogICAgdmFyIFRFWFRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5URVhUX1ZBTFVFOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5DT01NRU5UX1ZBTFVFOwogICAgdmFyIHRtcGxGdW5jdGlvbnMgPSB7fTsKICAgIHZhciBpbmxpbmVTZWVkID0gMTsKICAgIHZhciBidWlsZFBhdGhlcyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgUEFUSF9SRUZfTkFNRSA9ICJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ekFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaIi5zcGxpdCgiIik7CiAgICAgIHZhciBwYXRoTGlzdDsKICAgICAgdmFyIHJlZkxpc3Q7CiAgICAgIHZhciBiaW5kaW5nTGlzdDsKICAgICAgdmFyIG1hcmtlZEVsZW1lbnRMaXN0OwogICAgICB2YXIgcm9vdFBhdGg7CiAgICAgIHZhciBhdHRyRXhwcklkOwogICAgICBmdW5jdGlvbiBwdXRSZWZzKHJlZnMsIHBhdGhJZHgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgcmVmTmFtZTsgcmVmTmFtZSA9IHJlZnNbaV07IGkrKykgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpID09IC0xKSByZWZMaXN0LnB1c2gocmVmTmFtZSArICI6IiArIHBhdGhJZHgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHB1dFBhdGgocGF0aCkgewogICAgICAgIHZhciBsZW4gPSBwYXRoTGlzdC5sZW5ndGg7CiAgICAgICAgdmFyIHBhdGhSZWYgPSBQQVRIX1JFRl9OQU1FW2xlbl0gfHwgInIiICsgbGVuOwogICAgICAgIHBhdGhMaXN0LnB1c2gocGF0aFJlZiArICI9IiArIHBhdGgpOwogICAgICAgIHJldHVybiBwYXRoUmVmOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHB1dEJpbmRpbmcoYmluZGluZykgewogICAgICAgIGJpbmRpbmdMaXN0LnB1c2goYmluZGluZyk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgICB2YXIgbG9jYWxQYXRoOwogICAgICAgIHZhciByZWZzOwogICAgICAgIHZhciBteVJlZjsKICAgICAgICB2YXIgZXhwbGljaXRSZWY7CiAgICAgICAgdmFyIGJpbmRpbmdzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjcCA9IDAsIGNsb3NlVGV4dCA9IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrLCBjcCsrLCBleHBsaWNpdFJlZiA9IGZhbHNlKSB7CiAgICAgICAgICBpZiAoIWkpIGxvY2FsUGF0aCA9IHBhdGggKyAiLmZpcnN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgaWYgKCF0b2tlbnNbaSArIDFdKSBsb2NhbFBhdGggPSBwYXRoICsgIi5sYXN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gdG9rZW5zW2kgLSAxXVtUT0tFTl9UWVBFXSAmJiB0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQpIGNsb3NlVGV4dCsrOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHBhdGggKyAiLmNoaWxkTm9kZXNbIiArIChub1RleHRCdWcgPyBjcCA6IGNwICsgKGNsb3NlVGV4dCA/ICIgKyAiICsgY2xvc2VUZXh0ICsgIiAqIFRFWFRfQlVHIiA6ICIiKSkgKyAiXSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWZzID0gdG9rZW5bVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIHB1dFJlZnMocmVmcywgbG9jYWxQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXVt0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxXTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHV0QmluZGluZyhbIHRva2VuW1RPS0VOX1RZUEVdLCBsb2NhbFBhdGgsIHRva2VuW1RPS0VOX0JJTkRJTkdTXSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgbXlSZWYgPSAtMTsKICAgICAgICAgICAgaWYgKHBhdGggPT0gcm9vdFBhdGgpIG1hcmtlZEVsZW1lbnRMaXN0LnB1c2gobG9jYWxQYXRoICsgIi4iICsgdGVtcGxhdGVNYXJrZXIpOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmKSB7CiAgICAgICAgICAgICAgbG9jYWxQYXRoID0gcHV0UGF0aChsb2NhbFBhdGgpOwogICAgICAgICAgICAgIG15UmVmID0gcGF0aExpc3QubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhdHRycyA9IFtdOwogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IEVMRU1FTlRfQVRUUlMsIHQ7IHQgPSB0b2tlbltqXTsgaisrKSBpZiAodFtUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQgfHwgdFtUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQgfHwgdFtUT0tFTl9UWVBFXSA9PSBUWVBFX0NPTU1FTlQpIGNoaWxkcmVuLnB1c2godCk7IGVsc2UgYXR0cnMucHVzaCh0KTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJbVE9LRU5fVFlQRV0gPT0gNikgY29udGludWU7CiAgICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gQVRUUl9OQU1FX0JZX1RZUEVbYXR0cltUT0tFTl9UWVBFXV0gfHwgYXR0cltBVFRSX05BTUVdOwogICAgICAgICAgICAgIGlmIChyZWZzID0gYXR0cltUT0tFTl9SRUZTXSkgewogICAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgICAgcHV0UmVmcyhyZWZzLCBwdXRQYXRoKGxvY2FsUGF0aCArICcuZ2V0QXR0cmlidXRlTm9kZSgiJyArIGF0dHJOYW1lICsgJyIpJykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYmluZGluZ3MgPSBhdHRyW1RPS0VOX0JJTkRJTkdTXSkgewogICAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpdGNoIChhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmRpbmc7IGJpbmRpbmcgPSBiaW5kaW5nc1trXTsgaysrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kaW5nWzFdLCBhdHRyTmFtZSwgYmluZGluZ1swXSBdLmNvbmNhdChiaW5kaW5nLnNsaWNlKDIpKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgcHJvcGVydHk7IHByb3BlcnR5ID0gYmluZGluZ3Nba107IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgYXR0ckV4cHJJZCsrOwogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IDAsIGJpbmROYW1lOyBiaW5kTmFtZSA9IHByb3BlcnR5WzBdW21dOyBtKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmROYW1lLCBhdHRyTmFtZSwgcHJvcGVydHlbMF0sIHByb3BlcnR5WzFdLCBwcm9wZXJ0eVsyXSwgcHJvcGVydHlbM10sIGF0dHJFeHBySWQgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGF0dHJFeHBySWQrKzsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgYmluZE5hbWU7IGJpbmROYW1lID0gYmluZGluZ3NbMF1ba107IGsrKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZE5hbWUsIGF0dHJOYW1lLCBiaW5kaW5nc1swXSwgYmluZGluZ3NbMV0sIHRva2VuW0VMRU1FTlRfTkFNRV0sIGF0dHJFeHBySWQgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGgpIHByb2Nlc3NUb2tlbnMoY2hpbGRyZW4sIGxvY2FsUGF0aCwgbm9UZXh0QnVnKTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZiAmJiBteVJlZiA9PSBwYXRoTGlzdC5sZW5ndGgpIHBhdGhMaXN0LnBvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zLCBwYXRoLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKSB7CiAgICAgICAgcGF0aExpc3QgPSBbXTsKICAgICAgICByZWZMaXN0ID0gW107CiAgICAgICAgYmluZGluZ0xpc3QgPSBbXTsKICAgICAgICBtYXJrZWRFbGVtZW50TGlzdCA9IFtdOwogICAgICAgIHJvb3RQYXRoID0gcGF0aCB8fCAiXyI7CiAgICAgICAgYXR0ckV4cHJJZCA9IDA7CiAgICAgICAgcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHJvb3RQYXRoLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcGF0aDogcGF0aExpc3QsCiAgICAgICAgICByZWY6IHJlZkxpc3QsCiAgICAgICAgICBiaW5kaW5nOiBiaW5kaW5nTGlzdCwKICAgICAgICAgIG1hcmtlZEVsZW1lbnRMaXN0OiBtYXJrZWRFbGVtZW50TGlzdAogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgYnVpbGRCaW5kaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgTDEwTl9CSU5ESU5HID0gL1wuXHsoW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKVx9LzsKICAgICAgdmFyIFNQRUNJQUxfQVRUUl9NQVAgPSB7CiAgICAgICAgZGlzYWJsZWQ6ICIqIiwKICAgICAgICBjaGVja2VkOiBbICJpbnB1dCIgXSwKICAgICAgICBpbmRldGVybWluYXRlOiBbICJpbnB1dCIgXSwKICAgICAgICB2YWx1ZTogWyAiaW5wdXQiLCAidGV4dGFyZWEiLCAic2VsZWN0IiBdLAogICAgICAgIG1pbmxlbmd0aDogWyAiaW5wdXQiIF0sCiAgICAgICAgbWF4bGVuZ3RoOiBbICJpbnB1dCIgXSwKICAgICAgICByZWFkb25seTogWyAiaW5wdXQiIF0sCiAgICAgICAgc2VsZWN0ZWQ6IFsgIm9wdGlvbiIgXSwKICAgICAgICBtdWx0aXBsZTogWyAic2VsZWN0IiBdCiAgICAgIH07CiAgICAgIHZhciBTUEVDSUFMX0FUVFJfU0lOR0xFID0gewogICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgIGNoZWNrZWQ6IHRydWUsCiAgICAgICAgc2VsZWN0ZWQ6IHRydWUsCiAgICAgICAgcmVhZG9ubHk6IHRydWUsCiAgICAgICAgbXVsdGlwbGU6IHRydWUsCiAgICAgICAgaW5kZXRlcm1pbmF0ZTogdHJ1ZQogICAgICB9OwogICAgICB2YXIgYmluZEZ1bmN0aW9ucyA9IHsKICAgICAgICAxOiAiYmluZF9lbGVtZW50IiwKICAgICAgICAzOiAiYmluZF90ZXh0Tm9kZSIsCiAgICAgICAgODogImJpbmRfY29tbWVudCIKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBzcGVjaWFsLCBsMTBuKSB7CiAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBbXTsKICAgICAgICB2YXIgc3ltYm9scyA9IGJpbmRpbmdbNV07CiAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSBiaW5kaW5nWzRdOwogICAgICAgIHZhciBleHByVmFyOwogICAgICAgIHZhciBjb2xvblBvczsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN5bWJvbHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICh0eXBlb2Ygc3ltYm9sc1tqXSA9PSAic3RyaW5nIikgZXhwcmVzc2lvbi5wdXNoKCciJyArIHN5bWJvbHNbal0ucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIicpOyBlbHNlIHsKICAgICAgICAgICAgZXhwclZhciA9IGRpY3Rpb25hcnlbc3ltYm9sc1tqXV07CiAgICAgICAgICAgIGNvbG9uUG9zID0gZXhwclZhci5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgIGlmIChjb2xvblBvcyA9PSAtMSkgewogICAgICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChzcGVjaWFsID09ICJsMTBuIiA/ICcieycgKyBleHByVmFyICsgJ30iJyA6IHNwZWNpYWwgPT0gImJvb2wiID8gIihfXyIgKyBleHByVmFyICsgJ3x8IiIpJyA6ICJfXyIgKyBleHByVmFyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgYmluZGluZ05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBsMTBuUGF0aCA9IGV4cHJWYXIuc3Vic3RyKGNvbG9uUG9zICsgMSkucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICAgIGJpbmRpbmdOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAoYmluZGluZ05hbWUpIGV4cHJlc3Npb24ucHVzaChsMTBuW2V4cHJWYXIuc3Vic3RyKGNvbG9uUG9zICsgMSldKTsgZWxzZSBleHByZXNzaW9uLnB1c2goJ19fbDEwblsiJyArIGwxMG5QYXRoICsgJyJdJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV4cHJlc3Npb24ubGVuZ3RoID09IDEpIGV4cHJlc3Npb24ucHVzaCgnIiInKTsKICAgICAgICByZXR1cm4gZXhwcmVzc2lvbi5qb2luKCIrIik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgZnVuY3Rpb24gcHV0QmluZENvZGUodHlwZSkgewogICAgICAgICAgdG9vbHNVc2VkW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgIGJpbmRDb2RlLnB1c2goYmluZFZhciArICI9IiArIHR5cGUgKyAiKCIgKyBiYXNpcy5hcnJheShhcmd1bWVudHMsIDEpICsgIik7Iik7CiAgICAgICAgfQogICAgICAgIHZhciBiaW5kTWFwID0ge307CiAgICAgICAgdmFyIGJpbmRDb2RlOwogICAgICAgIHZhciBiaW5kVmFyOwogICAgICAgIHZhciB2YXJMaXN0ID0gW107CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciB2YXJOYW1lOwogICAgICAgIHZhciBsMTBuTWFwOwogICAgICAgIHZhciBsMTBuQ29tcHV0ZSA9IFtdOwogICAgICAgIHZhciBsMTBuQmluZGluZ3MgPSB7fTsKICAgICAgICB2YXIgbDEwbkJpbmRTZWVkID0gMTsKICAgICAgICB2YXIgc3BlY2lhbEF0dHI7CiAgICAgICAgdmFyIGF0dHJFeHBySWQ7CiAgICAgICAgdmFyIGF0dHJFeHByTWFwID0ge307CiAgICAgICAgdmFyIGRlYnVnTGlzdCA9IFtdOwogICAgICAgIHZhciB0b29sc1VzZWQgPSB7CiAgICAgICAgICByZXNvbHZlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgYmluZGluZzsgYmluZGluZyA9IGJpbmRpbmdzW2ldOyBpKyspIHsKICAgICAgICAgIHZhciBiaW5kVHlwZSA9IGJpbmRpbmdbMF07CiAgICAgICAgICB2YXIgZG9tUmVmID0gYmluZGluZ1sxXTsKICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRpbmdbMl07CiAgICAgICAgICBpZiAoWyAiZ2V0IiwgInNldCIsICJ0ZW1wbGF0ZUlkXyIgXS5pbmRleE9mKGJpbmROYW1lKSAhPSAtMSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmluZGluZyBuYW1lIGAiICsgYmluZE5hbWUgKyAiYCBpcyBwcm9oaWJpdGVkLCBiaW5kaW5nIGlnbm9yZWQiKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZVBhcnQgPSBiaW5kTmFtZS5zcGxpdCgiOiIpOwogICAgICAgICAgdmFyIGFuaW0gPSBuYW1lUGFydFswXSA9PSAiYW5pbSI7CiAgICAgICAgICBpZiAoYW5pbSkgYmluZE5hbWUgPSBuYW1lUGFydFsxXTsKICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV07CiAgICAgICAgICBiaW5kVmFyID0gIl8iICsgaTsKICAgICAgICAgIHZhck5hbWUgPSAiX18iICsgYmluZE5hbWU7CiAgICAgICAgICBpZiAobmFtZVBhcnRbMF0gPT0gImwxMG4iICYmIG5hbWVQYXJ0WzFdKSB7CiAgICAgICAgICAgIHZhciBsMTBuRnVsbFBhdGggPSBuYW1lUGFydFsxXTsKICAgICAgICAgICAgdmFyIGwxMG5CaW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGwxMG5OYW1lID0gbDEwbkZ1bGxQYXRoLnJlcGxhY2UoTDEwTl9CSU5ESU5HLCBmdW5jdGlvbihtLCBuYW1lKSB7CiAgICAgICAgICAgICAgbDEwbkJpbmRpbmcgPSBuYW1lOwogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChsMTBuQmluZGluZykgewogICAgICAgICAgICAgIGlmIChsMTBuRnVsbFBhdGggaW4gbDEwbkJpbmRpbmdzID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXJOYW1lID0gIiRsMTBuXyIgKyBsMTBuQmluZFNlZWQrKzsKICAgICAgICAgICAgICAgIGwxMG5CaW5kaW5nc1tsMTBuRnVsbFBhdGhdID0gdmFyTmFtZTsKICAgICAgICAgICAgICAgIGwxMG5Db21wdXRlLnB1c2goJ3NldCgiJyArIHZhck5hbWUgKyAnIiwnICsgdmFyTmFtZSArICIpIik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSArICc9dG9vbHMubDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIikuY29tcHV0ZVRva2VuKCknKTsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuQmluZGluZ107CiAgICAgICAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuQmluZGluZ10gPSBbXTsKICAgICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKCJfXyIgKyBsMTBuQmluZGluZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiaW5kQ29kZS5wdXNoKHZhck5hbWUgKyAiLnNldChfXyIgKyBsMTBuQmluZGluZyArICIpOyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBiaW5kTmFtZSA9IGwxMG5CaW5kaW5nc1tsMTBuRnVsbFBhdGhdOwogICAgICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgICAgIHZhck5hbWUgPSAiX18iICsgYmluZE5hbWU7CiAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdID0gW107CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChiaW5kVHlwZSA9PSBUWVBFX1RFWFQpIHsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGRvbVJlZik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXR0ck5hbWUgPSAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIic7CiAgICAgICAgICAgICAgICBkZWJ1Z0xpc3QucHVzaCgieyIgKyBbICdiaW5kaW5nOiInICsgbDEwbkZ1bGxQYXRoICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJhdHRyOiIgKyBhdHRyTmFtZSwgInZhbDoiICsgYmluZFZhciwgJ2F0dGFjaG1lbnQ6aW5zdGFuY2UuYXR0YWNoZXMmJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0mJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0udmFsdWUnIF0gKyAifSIpOwogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ciIsIGRvbVJlZiwgYXR0ck5hbWUsIGJpbmRWYXIsIGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWwxMG5NYXApIGwxMG5NYXAgPSB7fTsKICAgICAgICAgICAgaWYgKCFiaW5kTWFwW2wxMG5OYW1lXSkgewogICAgICAgICAgICAgIGJpbmRNYXBbbDEwbk5hbWVdID0gW107CiAgICAgICAgICAgICAgbDEwbk1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbbDEwbk5hbWVdOwogICAgICAgICAgICBiaW5kQ29kZS5sMTBuID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgJ3ZhbDpfX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScsICdhdHRhY2htZW50OmwxMG5Ub2tlbigiJyArIGwxMG5OYW1lICsgJyIpJyBdICsgIn0iKTsKICAgICAgICAgICAgICB0b29sc1VzZWQubDEwblRva2VuID0gdHJ1ZTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKGRvbVJlZiArICIubm9kZVZhbHVlPXZhbHVlOyIpOwogICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2goZG9tUmVmICsgJy5ub2RlVmFsdWU9X19sMTBuWyInICsgbDEwbk5hbWUgKyAnIl0nICsgKGwxMG5CaW5kaW5nID8gIltfXyIgKyBsMTBuQmluZGluZyArICJdIiA6ICIiKSArICI7Iik7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbDEwbk1hcFtsMTBuTmFtZV0ucHVzaCgiYmluZF9hdHRyKCIgKyBbIGRvbVJlZiwgJyInICsgYmluZGluZ1tBVFRSX05BTUVdICsgJyInLCAiTmFOIiwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAibDEwbiIsIGwxMG5CaW5kaW5ncykgXSArICIpOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgdmFyTGlzdC5wdXNoKHZhck5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpbmRUeXBlICE9IFRZUEVfQVRUUklCVVRFKSB7CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAidmFsOiIgKyAoYmluZENvZGUubm9kZUJpbmQgPyB2YXJOYW1lIDogYmluZFZhciksICJ1cGRhdGVzOiQkIiArIGJpbmROYW1lLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgIGlmICghYmluZENvZGUubm9kZUJpbmQpIHsKICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGRvbVJlZik7CiAgICAgICAgICAgICAgcHV0QmluZENvZGUoYmluZEZ1bmN0aW9uc1tiaW5kVHlwZV0sIGRvbVJlZiwgYmluZFZhciwgInZhbHVlIik7CiAgICAgICAgICAgICAgYmluZENvZGUubm9kZUJpbmQgPSBiaW5kVmFyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN3aXRjaCAoYmluZFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBkb21SZWYsICJ2YWx1ZSE9PW51bGw/U3RyaW5nKHZhbHVlKTpudWxsIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYmluZGluZ1tBVFRSX05BTUVdOwogICAgICAgICAgICBzd2l0Y2ggKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRFeHByID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVFeHByID0gInZhbHVlIjsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXggPSBiaW5kaW5nWzRdOwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdMZW5ndGggPSBiaW5kaW5nLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID49IDYpIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNiB8fCB0eXBlb2YgYmluZGluZ1s2XSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID09IDYpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9ICd2YWx1ZT8iJyArIGJpbmROYW1lICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZE5hbWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZGluZ1s2XSArICciOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IGJpbmRpbmdbNl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICghYmluZGluZ1s2XS5sZW5ndGgpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID09IDcpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9IGJpbmRpbmdbNl0ubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3ZhbHVlPT0iJyArIHZhbCArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0pLmpvaW4oInx8IikgKyAnP3ZhbHVlOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IHByZWZpeCArIGJpbmRpbmdbNl1bYmluZGluZ1s1XSAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSAiIjsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9IGJpbmRpbmdbNl0ubWFwKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyI/IicgKyB0aGlzW2lkeF0gKyAnIic7CiAgICAgICAgICAgICAgICAgICAgICB9LCBiaW5kaW5nWzddKS5qb2luKCI6IikgKyAnOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IGJpbmRpbmdbN11bYmluZGluZ1s1XSAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3R5cGVvZiB2YWx1ZT09InN0cmluZyJ8fHR5cGVvZiB2YWx1ZT09Im51bWJlciI/dmFsdWU6KHZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIiknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIgKyAnPSInICsgZGVmYXVsdEV4cHIgKyAnIicpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ckNsYXNzIiwgZG9tUmVmLCBiaW5kVmFyLCB2YWx1ZUV4cHIsICciJyArIHByZWZpeCArICciJywgYW5pbSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICB2YXIgZXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncyk7CiAgICAgICAgICAgICAgICBhdHRyRXhwcklkID0gYmluZGluZ1s4XTsKICAgICAgICAgICAgICAgIGlmICghYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0pIHsKICAgICAgICAgICAgICAgICAgYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0gPSBiaW5kVmFyOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIChiaW5kaW5nWzddID09ICJoaWRlIiA/ICciIicgOiAnIm5vbmUiJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbN10pIGV4cHIgPSBleHByLnJlcGxhY2UoL1wrIiIkLywgIiIpICsgKGJpbmRpbmdbN10gPT0gImhpZGUiID8gJz8ibm9uZSI6IiInIDogJz8iIjoibm9uZSInKTsKICAgICAgICAgICAgICAgIGJpbmRWYXIgPSBhdHRyRXhwck1hcFthdHRyRXhwcklkXTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKCJiaW5kX2F0dHJTdHlsZSIsIGRvbVJlZiwgJyInICsgYmluZGluZ1s2XSArICciJywgYmluZFZhciwgZXhwcik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc3BlY2lhbEF0dHIgPSBTUEVDSUFMX0FUVFJfTUFQW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgIGF0dHJFeHBySWQgPSBiaW5kaW5nWzddOwogICAgICAgICAgICAgICAgaWYgKCFhdHRyRXhwck1hcFthdHRyRXhwcklkXSkgewogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgImwxMG4iLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgICAgYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0gPSBiaW5kVmFyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYmluZFZhciA9IGF0dHJFeHByTWFwW2F0dHJFeHBySWRdOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ciIsIGRvbVJlZiwgJyInICsgYXR0ck5hbWUgKyAnIicsIGJpbmRWYXIsIHNwZWNpYWxBdHRyICYmIFNQRUNJQUxfQVRUUl9TSU5HTEVbYXR0ck5hbWVdID8gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAiYm9vbCIsIGwxMG5CaW5kaW5ncykgKyAnPyInICsgYXR0ck5hbWUgKyAnIjoiIicgOiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIGZhbHNlLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWFsQXR0ciAmJiAoc3BlY2lhbEF0dHIgPT0gIioiIHx8IHNwZWNpYWxBdHRyLmluZGV4T2YoYmluZGluZ1s2XS50b0xvd2VyQ2FzZSgpKSAhPSAtMSkpIGJpbmRDb2RlLnB1c2goImlmKCIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICIhPSIgKyBiaW5kVmFyICsgIikiICsgZG9tUmVmICsgIi4iICsgYXR0ck5hbWUgKyAiPSIgKyAoU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyAiISEiICsgYmluZFZhciA6IGJpbmRWYXIpICsgIjsiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWJ1Z0xpc3QucHVzaCgieyIgKyBbICdiaW5kaW5nOiInICsgYmluZE5hbWUgKyAnIicsICJkb206IiArIGRvbVJlZiwgJ2F0dHI6IicgKyBhdHRyTmFtZSArICciJywgInZhbDoiICsgYmluZFZhciwgJ2F0dGFjaG1lbnQ6aW5zdGFuY2UuYXR0YWNoZXMmJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0mJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0udmFsdWUnIF0gKyAifSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgiO2Z1bmN0aW9uIHNldChiaW5kTmFtZSx2YWx1ZSl7IiArICdpZih0eXBlb2YgYmluZE5hbWUhPSJzdHJpbmciKScpOwogICAgICAgIGZvciAodmFyIGJpbmROYW1lIGluIGJpbmRNYXApIGlmIChiaW5kTWFwW2JpbmROYW1lXS5ub2RlQmluZCkgewogICAgICAgICAgcmVzdWx0LnB1c2goImlmKGJpbmROYW1lPT09IiArIGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kICsgIikiICsgJ2JpbmROYW1lPSInICsgYmluZE5hbWUgKyAnIjsnICsgImVsc2UgIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCJyZXR1cm47Iik7CiAgICAgICAgcmVzdWx0LnB1c2goInZhbHVlPXJlc29sdmUuY2FsbChpbnN0YW5jZSxiaW5kTmFtZSx2YWx1ZSxBdHRhY2hlcyk7IiArICJzd2l0Y2goYmluZE5hbWUpeyIpOwogICAgICAgIGZvciAodmFyIGJpbmROYW1lIGluIGJpbmRNYXApIHsKICAgICAgICAgIGlmIChiaW5kTmFtZS5pbmRleE9mKCJAIikgPT0gLTEpIHZhckxpc3QucHVzaCgiJCQiICsgYmluZE5hbWUgKyAiPTAiKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKCdjYXNlIicgKyBiaW5kTmFtZSArICciOicgKyAoYmluZE1hcFtiaW5kTmFtZV0ubDEwbiA/IGJpbmRNYXBbYmluZE5hbWVdLmpvaW4oIiIpIDogImlmKF9fIiArIGJpbmROYW1lICsgIiE9PXZhbHVlKSIgKyAieyIgKyAiJCQiICsgYmluZE5hbWUgKyAiKys7IiArICJfXyIgKyBiaW5kTmFtZSArICI9dmFsdWU7IiArIGJpbmRNYXBbYmluZE5hbWVdLmpvaW4oIiIpICsgIn0iKSArICJicmVhazsiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goIn19Iik7CiAgICAgICAgdmFyIHRvb2xzVmFyTGlzdCA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiB0b29sc1VzZWQpIHRvb2xzVmFyTGlzdC5wdXNoKGtleSArICI9dG9vbHMuIiArIGtleSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRlYnVnTGlzdDogZGVidWdMaXN0LAogICAgICAgICAga2V5czogYmFzaXMub2JqZWN0LmtleXMoYmluZE1hcCkuZmlsdGVyKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICByZXR1cm4ga2V5LmluZGV4T2YoIkAiKSA9PSAtMTsKICAgICAgICAgIH0pLAogICAgICAgICAgdG9vbHM6IHRvb2xzVmFyTGlzdCwKICAgICAgICAgIHZhcnM6IHZhckxpc3QsCiAgICAgICAgICBzZXQ6IHJlc3VsdC5qb2luKCIiKSwKICAgICAgICAgIGwxMG46IGwxMG5NYXAsCiAgICAgICAgICBsMTBuQ29tcHV0ZTogbDEwbkNvbXB1dGUKICAgICAgICB9OwogICAgICB9OwogICAgfSgpOwogICAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKGFyZ3MsIGJvZHkpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGFyZ3MsIGJvZHkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2LmVycm9yKCJDYW4ndCBidWlsZCB0ZW1wbGF0ZSBmdW5jdGlvbjogIiArIGUgKyAiXG4iLCAiZnVuY3Rpb24oIiArIGFyZ3MgKyAiKXtcbiIgKyBib2R5ICsgIlxufSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZ2V0RnVuY3Rpb25zID0gZnVuY3Rpb24odG9rZW5zLCBkZWJ1ZywgdXJpLCBzb3VyY2UsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgdmFyIGZuID0gdG1wbEZ1bmN0aW9uc1t1cmkgJiYgYmFzaXMucGF0aC5yZWxhdGl2ZSh1cmkpXTsKICAgICAgaWYgKGZuKSByZXR1cm4gZm47CiAgICAgIHZhciBwYXRocyA9IGJ1aWxkUGF0aGVzKHRva2VucywgIl8iLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKTsKICAgICAgdmFyIGJpbmRpbmdzID0gYnVpbGRCaW5kaW5ncyhwYXRocy5iaW5kaW5nKTsKICAgICAgdmFyIG9iamVjdFJlZnMgPSBwYXRocy5tYXJrZWRFbGVtZW50TGlzdC5qb2luKCI9Iik7CiAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgdmFyIGZuQm9keTsKICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICBrZXlzOiBiaW5kaW5ncy5rZXlzLAogICAgICAgIGwxMG5LZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kaW5ncy5sMTBuKQogICAgICB9OwogICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PSAxKSBwYXRocy5wYXRoWzBdID0gImE9XyI7CiAgICAgIGlmICghdXJpKSB1cmkgPSBiYXNpcy5wYXRoLmJhc2VVUkkgKyAiaW5saW5lX3RlbXBsYXRlIiArIGlubGluZVNlZWQrKyArICIudG1wbCI7CiAgICAgIGlmIChiaW5kaW5ncy5sMTBuKSB7CiAgICAgICAgdmFyIGNvZGUgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYmluZGluZ3MubDEwbikgY29kZS5wdXNoKCdjYXNlIicgKyBrZXkgKyAnIjonICsgJ2lmKHZhbHVlPT1udWxsKXZhbHVlPSJ7JyArIGtleSArICd9IjsnICsgIl9fbDEwblt0b2tlbl09dmFsdWU7IiArIGJpbmRpbmdzLmwxMG5ba2V5XS5qb2luKCIiKSArICJicmVhazsiKTsKICAgICAgICByZXN1bHQuY3JlYXRlTDEwblN5bmMgPSBjb21waWxlRnVuY3Rpb24oWyAiXyIsICJfX2wxMG4iLCAiYmluZF9hdHRyIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciAiICsgcGF0aHMucGF0aCArICI7IiArICJyZXR1cm4gZnVuY3Rpb24odG9rZW4sIHZhbHVlKXsiICsgInN3aXRjaCh0b2tlbil7IiArIGNvZGUuam9pbigiIikgKyAifSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpICsgIl9sMTBuIik7CiAgICAgIH0KICAgICAgcmVzdWx0LmNyZWF0ZUluc3RhbmNlID0gY29tcGlsZUZ1bmN0aW9uKFsgInRpZCIsICJtYXAiLCAicHJvdG8iLCAidG9vbHMiLCAiX19sMTBuIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciBnZXRCaW5kaW5ncz10b29scy5jcmVhdGVCaW5kaW5nRnVuY3Rpb24oWyIgKyBiaW5kaW5ncy5rZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gJyInICsga2V5ICsgJyInOwogICAgICB9KSArICJdKSwiICsgKGJpbmRpbmdzLnRvb2xzLmxlbmd0aCA/IGJpbmRpbmdzLnRvb2xzICsgIiwiIDogIiIpICsgIkF0dGFjaGVzPWZ1bmN0aW9uKCl7fTsiICsgIkF0dGFjaGVzLnByb3RvdHlwZT17IiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBrZXkgKyAiOm51bGwiOwogICAgICB9KSArICJ9OyIgKyAicmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlXyhpZCxvYmosb25BY3Rpb24sb25SZWJ1aWxkLGJpbmRpbmdzLGJpbmRpbmdJbnRlcmZhY2UpeyIgKyAidmFyIF89cHJvdG8uY2xvbmVOb2RlKHRydWUpLCIgKyBwYXRocy5wYXRoLmNvbmNhdChiaW5kaW5ncy52YXJzKSArICIsIiArICJpbnN0YW5jZT17IiArICJjb250ZXh0Om9iaiwiICsgImFjdGlvbjpvbkFjdGlvbiwiICsgInJlYnVpbGQ6b25SZWJ1aWxkLCIgKyAoZGVidWcgPyAiZGVidWc6ZnVuY3Rpb24gZGVidWcoKXtyZXR1cm5bIiArIGJpbmRpbmdzLmRlYnVnTGlzdCArICJdfSwiIDogIiIpICsgImhhbmRsZXI6bnVsbCwiICsgImJpbmRpbmdzOmJpbmRpbmdzLCIgKyAiYmluZGluZ0ludGVyZmFjZTpiaW5kaW5nSW50ZXJmYWNlLCIgKyAiYXR0YWNoZXM6bnVsbCwiICsgInRtcGw6eyIgKyBbIHBhdGhzLnJlZiwgInRlbXBsYXRlSWRfOmlkIiwgInNldDpzZXQiIF0gKyAifSIgKyAifSIgKyAob2JqZWN0UmVmcyA/ICI7aWYob2JqfHxvbkFjdGlvbikiICsgb2JqZWN0UmVmcyArICI9KGlkPDwxMil8dGlkIiA6ICIiKSArIGJpbmRpbmdzLnNldCArICI7aWYoYmluZGluZ3MpaW5zdGFuY2UuaGFuZGxlcj1nZXRCaW5kaW5ncyhiaW5kaW5ncyxvYmosc2V0LGJpbmRpbmdJbnRlcmZhY2UpIiArICI7IiArIGJpbmRpbmdzLmwxMG5Db21wdXRlICsgIjtyZXR1cm4gaW5zdGFuY2UiICsgIn0iICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVyaSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldEZ1bmN0aW9uczogZ2V0RnVuY3Rpb25zCiAgICB9OwogIH0KfTsKCihmdW5jdGlvbiBjcmVhdGVCYXNpc0luc3RhbmNlKGdsb2JhbCwgX19iYXNpc0ZpbGVuYW1lLCBfX2NvbmZpZykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgVkVSU0lPTiA9ICIxLjMuMyI7CiAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogIHZhciB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CiAgZnVuY3Rpb24gZ2VuVUlEKGxlbikgewogICAgZnVuY3Rpb24gYmFzZTM2KHZhbCkgewogICAgICByZXR1cm4gTWF0aC5yb3VuZCh2YWwpLnRvU3RyaW5nKDM2KTsKICAgIH0KICAgIHZhciByZXN1bHQgPSBiYXNlMzYoMTAgKyAyNSAqIE1hdGgucmFuZG9tKCkpOwogICAgaWYgKCFsZW4pIGxlbiA9IDE2OwogICAgd2hpbGUgKHJlc3VsdC5sZW5ndGggPCBsZW4pIHJlc3VsdCArPSBiYXNlMzYobmV3IERhdGUgKiBNYXRoLnJhbmRvbSgpKTsKICAgIHJldHVybiByZXN1bHQuc3Vic3RyKDAsIGxlbik7CiAgfQogIGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzb3VyY2UpIHsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGNvbXBsZXRlKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgaWYgKGtleSBpbiBkZXN0ID09IGZhbHNlKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiBkZXN0OwogIH0KICBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goa2V5KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKG9iamVjdFtrZXldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNwbGljZShzb3VyY2UsIGtleXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICgha2V5cykgcmV0dXJuIGV4dGVuZChyZXN1bHQsIHNvdXJjZSk7CiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107ICkgaWYgKGtleSBpbiBzb3VyY2UpIHsKICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgZGVsZXRlIHNvdXJjZVtrZXldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gbWVyZ2UoKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgZXh0ZW5kKHJlc3VsdCwgYXJndW1lbnRzW2ldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGl0ZXJhdGUob2JqZWN0LCBjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCBrZXksIG9iamVjdFtrZXldKSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiAkdW5kZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzTnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgdmFsdWUgPT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNOb3ROdWxsKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc1NhbWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdGhpczsKICB9CiAgZnVuY3Rpb24gJGlzTm90U2FtZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB0aGlzOwogIH0KICBmdW5jdGlvbiAkc2VsZih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBmdW5jdGlvbiAkY29uc3QodmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9CiAgZnVuY3Rpb24gJGZhbHNlKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiAkdHJ1ZSgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiAkbnVsbCgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiAkdW5kZWYoKSB7fQogIHZhciBnZXR0ZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBJRCA9ICJiYXNpc0dldHRlcklkIiArIGdlblVJRCgpICsgIl8iOwogICAgdmFyIG1vZGlmaWNhdG9yU2VlZCA9IDE7CiAgICB2YXIgc2ltcGxlUGF0aCA9IC9eW2EteiRfXVthLXokXzAtOV0qKFwuW2EteiRfXVthLXokXzAtOV0qKSokL2k7CiAgICB2YXIgZ2V0dGVyTWFwID0gW107CiAgICB2YXIgcGF0aENhY2hlID0ge307CiAgICB2YXIgbW9kQ2FjaGUgPSB7fTsKICAgIGZ1bmN0aW9uIGJ1aWxkRnVuY3Rpb24ocGF0aCkgewogICAgICBpZiAoc2ltcGxlUGF0aC50ZXN0KHBhdGgpKSB7CiAgICAgICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdCgiLiIpOwogICAgICAgIHZhciBmb28gPSBwYXJ0c1swXTsKICAgICAgICB2YXIgYmFyID0gcGFydHNbMV07CiAgICAgICAgdmFyIGJheiA9IHBhcnRzWzJdOwogICAgICAgIHZhciBmbjsKICAgICAgICBzd2l0Y2ggKHBhcnRzLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXVtiYXJdIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXVtiYXJdW2Jhel0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtmb29dW2Jhcl1bYmF6XTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAzLCBrZXk7IGtleSA9IHBhcnRzW2ldOyBpKyspIG9iamVjdCA9IG9iamVjdFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmbiA9IEZ1bmN0aW9uKCJwYXJ0cyIsICJyZXR1cm4gIiArIGZuLnRvU3RyaW5nKCkucmVwbGFjZSgvKGZvb3xiYXJ8YmF6KS9nLCBmdW5jdGlvbihtLCB3KSB7CiAgICAgICAgICByZXR1cm4gJyInICsgcGFydHNbdyA9PSAiZm9vIiA/IDAgOiB3ID09ICJiYXIiID8gMSA6IDJdICsgJyInOwogICAgICAgIH0pLnJlcGxhY2UoL1xbXCIoW14iXSspXCJcXS9nLCAiLiQxIikpKHBhcnRzKTsKICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigib2JqZWN0IiwgInJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdC4iICsgcGF0aCArICIgOiBvYmplY3QiKTsKICAgIH0KICAgIHZhciBnZXR0ZXJGbiA9IGZ1bmN0aW9uKHBhdGgsIG1vZGlmaWNhdG9yKSB7CiAgICAgIHZhciBmdW5jOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgZ2V0dGVySWQ7CiAgICAgIGlmICghcGF0aCB8fCBwYXRoID09PSBudWxsR2V0dGVyKSByZXR1cm4gbnVsbEdldHRlcjsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBnZXR0ZXJJZCA9IHBhdGhbSURdOwogICAgICAgIGlmIChnZXR0ZXJJZCkgewogICAgICAgICAgZnVuYyA9IGdldHRlck1hcFtNYXRoLmFicyhnZXR0ZXJJZCkgLSAxXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gcGF0aChvYmplY3QpOwogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgcGF0aFtJRF0gPSAtZ2V0dGVySWQ7CiAgICAgICAgICBmdW5jW0lEXSA9IGdldHRlcklkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmdW5jID0gcGF0aENhY2hlW3BhdGhdOwogICAgICAgIGlmIChmdW5jKSB7CiAgICAgICAgICBnZXR0ZXJJZCA9IGZ1bmNbSURdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gYnVpbGRGdW5jdGlvbihwYXRoKTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgZnVuY1tJRF0gPSBnZXR0ZXJJZDsKICAgICAgICAgIHBhdGhDYWNoZVtwYXRoXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBtb2RUeXBlID0gbW9kaWZpY2F0b3IgIT0gbnVsbCAmJiB0eXBlb2YgbW9kaWZpY2F0b3I7CiAgICAgIGlmICghbW9kVHlwZSkgcmV0dXJuIGZ1bmM7CiAgICAgIHZhciBtb2RMaXN0ID0gbW9kQ2FjaGVbZ2V0dGVySWRdOwogICAgICB2YXIgbW9kSWQ7CiAgICAgIGlmIChtb2RUeXBlID09ICJzdHJpbmciKSBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvcjsgZWxzZSBpZiAobW9kVHlwZSA9PSAiZnVuY3Rpb24iKSBtb2RJZCA9IG1vZGlmaWNhdG9yLmJhc2lzTW9kSWRfOyBlbHNlIGlmIChtb2RUeXBlICE9ICJvYmplY3QiKSB7CiAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuZ2V0dGVyOiB3cm9uZyBtb2RpZmljYXRvciB0eXBlLCBtb2RpZmljYXRvciBub3QgdXNlZCwgcGF0aDogIiwgcGF0aCwgIiwgbW9kaWZpY2F0b3I6IiwgbW9kaWZpY2F0b3IpOwogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIGlmIChtb2RJZCAmJiBtb2RMaXN0ICYmIG1vZExpc3RbbW9kSWRdKSByZXR1cm4gbW9kTGlzdFttb2RJZF07CiAgICAgIGlmICh0eXBlb2YgZnVuYy5iYXNlID09ICJmdW5jdGlvbiIpIGZ1bmMgPSBmdW5jLmJhc2U7CiAgICAgIHN3aXRjaCAobW9kVHlwZSkgewogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ0Z1bmN0aW9ucy5mb3JtYXQobW9kaWZpY2F0b3IsIGZ1bmMob2JqZWN0KSk7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKCFtb2RJZCkgewogICAgICAgICAgICBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvclNlZWQrKzsKICAgICAgICAgICAgbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF8gPSBtb2RJZDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3IoZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcltmdW5jKG9iamVjdCldOwogICAgICAgICAgfTsKICAgICAgfQogICAgICByZXN1bHQuYmFzZSA9IGZ1bmMuYmFzZSB8fCBmdW5jOwogICAgICByZXN1bHQuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgaWYgKG1vZElkKSB7CiAgICAgICAgaWYgKCFtb2RMaXN0KSB7CiAgICAgICAgICBtb2RMaXN0ID0ge307CiAgICAgICAgICBtb2RDYWNoZVtnZXR0ZXJJZF0gPSBtb2RMaXN0OwogICAgICAgIH0KICAgICAgICBtb2RMaXN0W21vZElkXSA9IHJlc3VsdDsKICAgICAgICByZXN1bHQubW9kID0gbW9kaWZpY2F0b3I7CiAgICAgICAgcmVzdWx0W0lEXSA9IGdldHRlck1hcC5wdXNoKHJlc3VsdCk7CiAgICAgIH0gZWxzZSB7fQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGdldHRlckZuLklEID0gSUQ7CiAgICByZXR1cm4gZ2V0dGVyRm47CiAgfSgpOwogIHZhciBudWxsR2V0dGVyID0gZXh0ZW5kKGZ1bmN0aW9uKCkge30sIHsKICAgIF9fZXh0ZW5kX186IGdldHRlcgogIH0pOwogIGZ1bmN0aW9uIHdyYXBwZXIoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgZnVuY3Rpb24gbGF6eUluaXQoaW5pdCwgdGhpc09iamVjdCkgewogICAgdmFyIGluaXRlZCA9IDA7CiAgICB2YXIgc2VsZjsKICAgIHZhciBkYXRhOwogICAgcmV0dXJuIHNlbGYgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoaW5pdGVkKyspKSB7CiAgICAgICAgc2VsZi5pbml0ZWQgPSB0cnVlOwogICAgICAgIHNlbGYuZGF0YSA9IGRhdGEgPSBpbml0LmFwcGx5KHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gInVuZGVmaW5lZCIpIGNvbnNvbGVNZXRob2RzLndhcm4oImxhenlJbml0IGZ1bmN0aW9uIHJldHVybnMgbm90aGluZzpcbiIgKyBpbml0KTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGxhenlJbml0QW5kUnVuKGluaXQsIHJ1biwgdGhpc09iamVjdCkgewogICAgdmFyIGluaXRlZCA9IDA7CiAgICB2YXIgc2VsZjsKICAgIHZhciBkYXRhOwogICAgcmV0dXJuIHNlbGYgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoaW5pdGVkKyspKSB7CiAgICAgICAgc2VsZi5pbml0ZWQgPSB0cnVlOwogICAgICAgIHNlbGYuZGF0YSA9IGRhdGEgPSBpbml0LmNhbGwodGhpc09iamVjdCB8fCB0aGlzKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gInVuZGVmaW5lZCIpIGNvbnNvbGVNZXRob2RzLndhcm4oImxhenlJbml0QW5kUnVuIGZ1bmN0aW9uIHJldHVybnMgbm90aGluZzpcbiIgKyBpbml0KTsKICAgICAgfQogICAgICBydW4uYXBwbHkoZGF0YSwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KICBmdW5jdGlvbiBydW5PbmNlKHJ1biwgdGhpc09iamVjdCkgewogICAgdmFyIGZpcmVkID0gMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoZmlyZWQrKykpIHJldHVybiBydW4uYXBwbHkodGhpc09iamVjdCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9CiAgdmFyIGNvbnNvbGVNZXRob2RzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgbG9nOiAkdW5kZWYsCiAgICAgIGluZm86ICR1bmRlZiwKICAgICAgd2FybjogJHVuZGVmLAogICAgICBlcnJvcjogJHVuZGVmCiAgICB9OwogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiKSBpdGVyYXRlKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgbWV0aG9kc1ttZXRob2ROYW1lXSA9ICJiaW5kIiBpbiBGdW5jdGlvbi5wcm90b3R5cGUgJiYgdHlwZW9mIGNvbnNvbGVbbWV0aG9kTmFtZV0gPT0gImZ1bmN0aW9uIiA/IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoY29uc29sZVttZXRob2ROYW1lXSwgY29uc29sZSkgOiBmdW5jdGlvbigpIHsKICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW21ldGhvZE5hbWVdLCBjb25zb2xlLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gbWV0aG9kczsKICB9KCk7CiAgdmFyIHNldEltbWVkaWF0ZSA9IGdsb2JhbC5zZXRJbW1lZGlhdGUgfHwgZ2xvYmFsLm1zU2V0SW1tZWRpYXRlOwogIHZhciBjbGVhckltbWVkaWF0ZSA9IGdsb2JhbC5jbGVhckltbWVkaWF0ZSB8fCBnbG9iYWwubXNTZXRJbW1lZGlhdGU7CiAgaWYgKHNldEltbWVkaWF0ZSkgc2V0SW1tZWRpYXRlID0gc2V0SW1tZWRpYXRlLmJpbmQoZ2xvYmFsKTsKICBpZiAoY2xlYXJJbW1lZGlhdGUpIGNsZWFySW1tZWRpYXRlID0gY2xlYXJJbW1lZGlhdGUuYmluZChnbG9iYWwpOwogIGlmICghc2V0SW1tZWRpYXRlKSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgTUVTU0FHRV9OQU1FID0gImJhc2lzanMuc2V0SW1tZWRpYXRlIjsKICAgIHZhciBydW5UYXNrID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXNrQnlJZCA9IHt9OwogICAgICB2YXIgdGFza0lkID0gMTsKICAgICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodHlwZW9mIGZuICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnNldEltbWVkaWF0ZSgpIGFuZCBiYXNpcy5uZXh0VGljaygpIGFjY2VwdCBmdW5jdGlvbnMgb25seSAoY2FsbCBpZ25vcmVkKSIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0YXNrQnlJZFsrK3Rhc2tJZF0gPSB7CiAgICAgICAgICBmbjogZm4sCiAgICAgICAgICBhcmdzOiBhcnJheUZyb20oYXJndW1lbnRzLCAxKQogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgIHJldHVybiB0YXNrSWQ7CiAgICAgIH07CiAgICAgIGNsZWFySW1tZWRpYXRlID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oaWQpIHsKICAgICAgICB2YXIgdGFzayA9IHRhc2tCeUlkW2lkXTsKICAgICAgICBpZiAodGFzaykgewogICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICAgIHJldHVybiB0YXNrLmZuLmFwcGx5KHVuZGVmaW5lZCwgdGFzay5hcmdzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgfSwgMCk7CiAgICB9OwogICAgaWYgKGdsb2JhbC5wcm9jZXNzICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09ICJmdW5jdGlvbiIpIHsKICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBpZiAoZ2xvYmFsLk1lc3NhZ2VDaGFubmVsKSB7CiAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgZ2xvYmFsLk1lc3NhZ2VDaGFubmVsOwogICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXNrSWQgPSBldmVudC5kYXRhOwogICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh0YXNrSWQpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBvc3RNZXNzYWdlU3VwcG9ydGVkID0gZ2xvYmFsLnBvc3RNZXNzYWdlICYmICFnbG9iYWwuaW1wb3J0U2NyaXB0czsKICAgICAgICBpZiAocG9zdE1lc3NhZ2VTdXBwb3J0ZWQpIHsKICAgICAgICAgIHZhciBvbGRPbk1lc3NhZ2UgPSBnbG9iYWwub25tZXNzYWdlOwogICAgICAgICAgZ2xvYmFsLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICAgIGdsb2JhbC5wb3N0TWVzc2FnZSgiIiwgIioiKTsKICAgICAgICAgIGdsb2JhbC5vbm1lc3NhZ2UgPSBvbGRPbk1lc3NhZ2U7CiAgICAgICAgfQogICAgICAgIGlmIChwb3N0TWVzc2FnZVN1cHBvcnRlZCkgewogICAgICAgICAgdmFyIHNldEltbWVkaWF0ZUhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQuc291cmNlID09IGdsb2JhbCkgewogICAgICAgICAgICAgIHZhciB0YXNrSWQgPSBTdHJpbmcoZXZlbnQuZGF0YSkuc3BsaXQoTUVTU0FHRV9OQU1FKVsxXTsKICAgICAgICAgICAgICBpZiAodGFza0lkKSBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIpIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgc2V0SW1tZWRpYXRlSGFuZGxlciwgdHJ1ZSk7IGVsc2UgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbm1lc3NhZ2UiLCBzZXRJbW1lZGlhdGVIYW5kbGVyKTsKICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKE1FU1NBR0VfTkFNRSArIHRhc2tJZCwgIioiKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjcmVhdGVTY3JpcHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgICAgfTsKICAgICAgICAgIGlmIChkb2N1bWVudCAmJiAib25yZWFkeXN0YXRlY2hhbmdlIiBpbiBjcmVhdGVTY3JpcHQoKSkgewogICAgICAgICAgICB2YXIgZGVmYXVsdEFkZFRvUXVldWUgPSBhZGRUb1F1ZXVlOwogICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24gYmVmb3JlSGVhZFJlYWR5KHRhc2tJZCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRJbnRlcmZhY2UgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGFkZFRvUXVldWUgPSBkZWZhdWx0QWRkVG9RdWV1ZTsKICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2NyaXB0RWwgPSBjcmVhdGVTY3JpcHQoKTsKICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChhZGRUb1F1ZXVlID09PSBiZWZvcmVIZWFkUmVhZHkpIGRlZmF1bHRBZGRUb1F1ZXVlKHRhc2tJZCk7IGVsc2UgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5PREVfRU5WID0gdHlwZW9mIHByb2Nlc3MgPT0gIm9iamVjdCIgJiYgdG9TdHJpbmcuY2FsbChwcm9jZXNzKSA9PSAiW29iamVjdCBwcm9jZXNzXSI7CiAgdmFyIHBhdGhVdGlscyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIEFCU09MVVRFX1JYID0gL14oW15cL10rOnxcLykvOwogICAgdmFyIFBST1RPQ09MX1JYID0gL15bYS16QS1aMC05XC1dKzpcLz8vOwogICAgdmFyIE9SSUdJTl9SWCA9IC9eKD86W2EtekEtWjAtOVwtXSs6KT9cL1wvW15cL10rXC8/LzsKICAgIHZhciBTRUFSQ0hfSEFTSF9SWCA9IC9bXD8jXS4qJC87CiAgICB2YXIgYmFzZVVSSTsKICAgIHZhciBvcmlnaW47CiAgICB2YXIgdXRpbHM7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIHBhdGggPSAocHJvY2Vzcy5iYXNpc2pzQmFzZVVSSSB8fCByZXF1aXJlKCJwYXRoIikucmVzb2x2ZSgiLiIpKS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICBiYXNlVVJJID0gcGF0aC5yZXBsYWNlKC9eW15cL10qLywgIiIpOwogICAgICBvcmlnaW4gPSBwYXRoLnJlcGxhY2UoL1wvLiovLCAiIik7CiAgICB9IGVsc2UgewogICAgICBiYXNlVVJJID0gbG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10rJC8sICIiKTsKICAgICAgb3JpZ2luID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdDsKICAgIH0KICAgIHV0aWxzID0gewogICAgICBiYXNlVVJJOiBiYXNlVVJJLAogICAgICBvcmlnaW46IG9yaWdpbiwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgcGF0aCA9IChwYXRoIHx8ICIiKS5yZXBsYWNlKFBST1RPQ09MX1JYLCAiLyIpLnJlcGxhY2UoT1JJR0lOX1JYLCAiLyIpLnJlcGxhY2UoU0VBUkNIX0hBU0hfUlgsICIiKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdCgiLyIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChwYXJ0c1tpXSA9PSAiLi4iKSB7CiAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSB8fCByZXN1bHRbMF0pIHJlc3VsdC5wb3AoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgocGFydHNbaV0gfHwgIWkpICYmIHBhcnRzW2ldICE9ICIuIikgcmVzdWx0LnB1c2gocGFydHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oIi8iKSB8fCAocGF0aFswXSA9PT0gIi8iID8gIi8iIDogIiIpOwogICAgICB9LAogICAgICBkaXJuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKTsKICAgICAgICByZXR1cm4gcmVzdWx0LnJlcGxhY2UoL1wvKFteXC9dKikkfF5bXlwvXSskLywgIiIpIHx8IChyZXN1bHRbMF0gPT0gIi8iID8gIi8iIDogIi4iKTsKICAgICAgfSwKICAgICAgZXh0bmFtZTogZnVuY3Rpb24ocGF0aCkgewogICAgICAgIHZhciBleHQgPSB1dGlscy5ub3JtYWxpemUocGF0aCkubWF0Y2goL1teXC9dKFwuW15cL1wuXSopJC8pOwogICAgICAgIHJldHVybiBleHQgPyBleHRbMV0gOiAiIjsKICAgICAgfSwKICAgICAgYmFzZW5hbWU6IGZ1bmN0aW9uKHBhdGgsIGV4dCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cXFwvXSokLyk7CiAgICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZSA/IGZpbGVuYW1lWzBdIDogIiI7CiAgICAgICAgaWYgKGV4dCA9PSB1dGlscy5leHRuYW1lKGZpbGVuYW1lKSkgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHJpbmcoMCwgZmlsZW5hbWUubGVuZ3RoIC0gZXh0Lmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIGZpbGVuYW1lOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihmcm9tLCB0bykgewogICAgICAgIHZhciBhcmdzID0gYXJyYXlGcm9tKGFyZ3VtZW50cykucmV2ZXJzZSgpOwogICAgICAgIHZhciBwYXRoID0gW107CiAgICAgICAgdmFyIGFic29sdXRlRm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgIWFic29sdXRlRm91bmQgJiYgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIGlmICh0eXBlb2YgYXJnc1tpXSA9PSAic3RyaW5nIikgewogICAgICAgICAgcGF0aC51bnNoaWZ0KGFyZ3NbaV0pOwogICAgICAgICAgYWJzb2x1dGVGb3VuZCA9IEFCU09MVVRFX1JYLnRlc3QoYXJnc1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghYWJzb2x1dGVGb3VuZCkgcGF0aC51bnNoaWZ0KGJhc2VVUkkgPT0gIi8iID8gIiIgOiBiYXNlVVJJKTsKICAgICAgICByZXR1cm4gdXRpbHMubm9ybWFsaXplKHBhdGguam9pbigiLyIpKTsKICAgICAgfSwKICAgICAgcmVsYXRpdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0byAhPSAic3RyaW5nIikgewogICAgICAgICAgdG8gPSBmcm9tOwogICAgICAgICAgZnJvbSA9IGJhc2VVUkk7CiAgICAgICAgfQogICAgICAgIGZyb20gPSB1dGlscy5ub3JtYWxpemUoZnJvbSk7CiAgICAgICAgdG8gPSB1dGlscy5ub3JtYWxpemUodG8pOwogICAgICAgIGlmIChmcm9tWzBdID09ICIvIiAmJiB0b1swXSAhPSAiLyIpIHJldHVybiBmcm9tOwogICAgICAgIGlmICh0b1swXSA9PSAiLyIgJiYgZnJvbVswXSAhPSAiLyIpIHJldHVybiB0bzsKICAgICAgICB2YXIgYmFzZSA9IGZyb20ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcGF0aCA9IHRvLnJlcGxhY2UoL15cLyQvLCAiIikuc3BsaXQoL1wvLyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBpID0gMDsKICAgICAgICB3aGlsZSAocGF0aFtpXSA9PSBiYXNlW2ldICYmIHR5cGVvZiBiYXNlW2ldID09ICJzdHJpbmciKSBpKys7CiAgICAgICAgZm9yICh2YXIgaiA9IGJhc2UubGVuZ3RoIC0gaTsgaiA+IDA7IGotLSkgcmVzdWx0LnB1c2goIi4uIik7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQocGF0aC5zbGljZShpKS5maWx0ZXIoQm9vbGVhbikpLmpvaW4oIi8iKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiB1dGlsczsKICB9KCk7CiAgdmFyIGJhc2lzRmlsZW5hbWUgPSBfX2Jhc2lzRmlsZW5hbWUgfHwgIiI7CiAgdmFyIGNvbmZpZyA9IF9fY29uZmlnIHx8IHsKICAgIG5vQ29uZmxpY3Q6IHRydWUsCiAgICBtb2R1bGVzOiB7fSwKICAgIGF1dG9sb2FkOiBbICIuLzAuanMiIF0KICB9OwogIGZ1bmN0aW9uIGZldGNoQ29uZmlnKCkgewogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnOwogICAgaWYgKCFjb25maWcpIHsKICAgICAgaWYgKE5PREVfRU5WKSB7CiAgICAgICAgYmFzaXNGaWxlbmFtZSA9IF9fZmlsZW5hbWUucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgc2NyaXB0cyA9IGRvY3VtZW50LnNjcmlwdHM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNjcmlwdEVsOyBzY3JpcHRFbCA9IHNjcmlwdHNbaV07IGkrKykgewogICAgICAgICAgdmFyIGNvbmZpZ0F0dHJWYWx1ZSA9IHNjcmlwdEVsLmhhc0F0dHJpYnV0ZSgiYmFzaXMtY29uZmlnIikgPyBzY3JpcHRFbC5nZXRBdHRyaWJ1dGUoImJhc2lzLWNvbmZpZyIpIDogc2NyaXB0RWwuZ2V0QXR0cmlidXRlKCJkYXRhLWJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgc2NyaXB0RWwucmVtb3ZlQXR0cmlidXRlKCJiYXNpcy1jb25maWciKTsKICAgICAgICAgIHNjcmlwdEVsLnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1iYXNpcy1jb25maWciKTsKICAgICAgICAgIGlmIChjb25maWdBdHRyVmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgYmFzaXNGaWxlbmFtZSA9IHBhdGhVdGlscy5ub3JtYWxpemUoc2NyaXB0RWwuc3JjKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb25maWcgPSBGdW5jdGlvbigicmV0dXJueyIgKyBjb25maWdBdHRyVmFsdWUgKyAifSIpKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMtY29uZmlnOiBiYXNpcy5qcyBjb25maWcgcGFyc2UgZmF1bHQ6ICIgKyBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwcm9jZXNzQ29uZmlnKGNvbmZpZyk7CiAgfQogIGZ1bmN0aW9uIHByb2Nlc3NDb25maWcoY29uZmlnLCB2ZXJib3NlKSB7CiAgICBjb25maWcgPSBzbGljZShjb25maWcpOwogICAgaWYgKCJleHRQcm90byIgaW4gY29uZmlnKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy1jb25maWc6IGBleHRQcm90b2Agb3B0aW9uIGluIGJhc2lzLWNvbmZpZyBpcyBub3Qgc3VwcG9ydCBhbnltb3JlIik7CiAgICBpZiAoInBhdGgiIGluIGNvbmZpZykgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMtY29uZmlnOiBgcGF0aGAgb3B0aW9uIGluIGJhc2lzLWNvbmZpZyBpcyBkZXByZWNhdGVkLCB1c2UgYG1vZHVsZXNgIGluc3RlYWQiKTsKICAgIHZhciBhdXRvbG9hZCA9IFtdOwogICAgdmFyIG1vZHVsZXMgPSBtZXJnZShjb25maWcucGF0aCwgY29uZmlnLm1vZHVsZXMsIHsKICAgICAgYmFzaXM6IGJhc2lzRmlsZW5hbWUKICAgIH0pOwogICAgY29uZmlnLm1vZHVsZXMgPSB7fTsKICAgIGlmIChjb25maWcuYXV0b2xvYWQpIHsKICAgICAgdmFyIG0gPSBTdHJpbmcoY29uZmlnLmF1dG9sb2FkKS5tYXRjaCgvXigoPzpbXlwvXSpcLykqKShbYS16JF9dW2EtejAtOSRfXSopKCg/OlwuW2EteiRfXVthLXowLTkkX10qKSopJC9pKTsKICAgICAgaWYgKG0pIHsKICAgICAgICBtb2R1bGVzW21bMl1dID0gewogICAgICAgICAgYXV0b2xvYWQ6IHRydWUsCiAgICAgICAgICBmaWxlbmFtZTogbVsxXSArIG1bMl0gKyAobVszXSB8fCAiLmpzIikKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLWNvbmZpZzogd3JvbmcgYGF1dG9sb2FkYCB2YWx1ZSAoc2V0dGluZyBpZ25vcmVkKTogIiArIGNvbmZpZy5hdXRvbG9hZCk7CiAgICAgIH0KICAgICAgZGVsZXRlIGNvbmZpZy5hdXRvbG9hZDsKICAgIH0KICAgIGZvciAodmFyIG5hbWUgaW4gbW9kdWxlcykgewogICAgICB2YXIgbW9kdWxlID0gbW9kdWxlc1tuYW1lXTsKICAgICAgaWYgKHR5cGVvZiBtb2R1bGUgPT0gInN0cmluZyIpIG1vZHVsZSA9IHsKICAgICAgICBmaWxlbmFtZTogbW9kdWxlLnJlcGxhY2UoL1wvJC8sICIvIiArIG5hbWUgKyAiLmpzIikKICAgICAgfTsKICAgICAgdmFyIGZpbGVuYW1lID0gbW9kdWxlLmZpbGVuYW1lOwogICAgICB2YXIgcGF0aCA9IG1vZHVsZS5wYXRoOwogICAgICBpZiAoZmlsZW5hbWUgJiYgIXBhdGgpIHsKICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgICAgICBwYXRoID0gZmlsZW5hbWUuc3Vic3RyKDAsIGZpbGVuYW1lLmxlbmd0aCAtIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKS5sZW5ndGgpOwogICAgICAgIGZpbGVuYW1lID0gIi4uLyIgKyBwYXRoVXRpbHMuYmFzZW5hbWUoZmlsZW5hbWUpOwogICAgICB9CiAgICAgIHBhdGggPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoKTsKICAgICAgaWYgKCFmaWxlbmFtZSAmJiBwYXRoKSB7CiAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMuYmFzZW5hbWUocGF0aCk7CiAgICAgICAgcGF0aCA9IHBhdGhVdGlscy5kaXJuYW1lKHBhdGgpOwogICAgICB9CiAgICAgIGlmICghcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSArPSAiLmpzIjsKICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoLCBmaWxlbmFtZSk7CiAgICAgIGNvbmZpZy5tb2R1bGVzW25hbWVdID0gewogICAgICAgIHBhdGg6IHBhdGgsCiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lCiAgICAgIH07CiAgICAgIGlmIChtb2R1bGUuYXV0b2xvYWQpIHsKICAgICAgICBjb25maWcuYXV0b2xvYWQgPSBhdXRvbG9hZDsKICAgICAgICBhdXRvbG9hZC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29uZmlnOwogIH0KICB2YXIgQ2xhc3MgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZVNlZWQgPSB7CiAgICAgIGlkOiAxCiAgICB9OwogICAgdmFyIGNsYXNzU2VlZCA9IDE7CiAgICB2YXIgY2xhc3NlcyA9IFtdOwogICAgdmFyIFNFTEYgPSB7fTsKICAgIGZ1bmN0aW9uIGlzQ2xhc3Mob2JqZWN0KSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICJmdW5jdGlvbiIgJiYgISFvYmplY3QuYmFzaXNDbGFzc0lkXzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU3ViY2xhc3NPZihzdXBlckNsYXNzKSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yICYmIGN1cnNvciAhPT0gc3VwZXJDbGFzcykgY3Vyc29yID0gY3Vyc29yLnN1cGVyQ2xhc3NfOwogICAgICByZXR1cm4gY3Vyc29yID09PSBzdXBlckNsYXNzOwogICAgfQogICAgZnVuY3Rpb24gZGV2VmVyYm9zZU5hbWUobmFtZSwgYXJncywgZm4pIHsKICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oa2V5cyhhcmdzKSwgJ3JldHVybiB7IicgKyBuYW1lICsgJyI6ICcgKyBmbiArICdcbn1bIicgKyBuYW1lICsgJyJdJykpLmFwcGx5KG51bGwsIHZhbHVlcyhhcmdzKSk7CiAgICB9CiAgICB2YXIgVE9TVFJJTkdfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB7CiAgICAgICAgdG9TdHJpbmc6IDEKICAgICAgfSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0oKTsKICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzKFN1cGVyQ2xhc3MsIGV4dGVuc2lvbnMpIHsKICAgICAgdmFyIGNsYXNzSWQgPSBjbGFzc1NlZWQrKzsKICAgICAgaWYgKHR5cGVvZiBTdXBlckNsYXNzICE9ICJmdW5jdGlvbiIpIFN1cGVyQ2xhc3MgPSBCYXNlQ2xhc3M7CiAgICAgIHZhciBjbGFzc05hbWUgPSAiIjsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIGlmICh0eXBlb2YgZXh0ZW5zaW9uICE9ICJmdW5jdGlvbiIgJiYgZXh0ZW5zaW9uLmNsYXNzTmFtZSkgY2xhc3NOYW1lID0gZXh0ZW5zaW9uLmNsYXNzTmFtZTsKICAgICAgaWYgKCFjbGFzc05hbWUpIGNsYXNzTmFtZSA9IFN1cGVyQ2xhc3MuY2xhc3NOYW1lICsgIi5fQ2xhc3MiICsgY2xhc3NJZDsKICAgICAgdmFyIE5ld0NsYXNzUHJvdG8gPSBmdW5jdGlvbigpIHt9OwogICAgICBOZXdDbGFzc1Byb3RvID0gZGV2VmVyYm9zZU5hbWUoY2xhc3NOYW1lLCB7fSwgTmV3Q2xhc3NQcm90byk7CiAgICAgIE5ld0NsYXNzUHJvdG8ucHJvdG90eXBlID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CiAgICAgIHZhciBuZXdQcm90byA9IG5ldyBOZXdDbGFzc1Byb3RvOwogICAgICB2YXIgbmV3Q2xhc3NQcm9wcyA9IHsKICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZSwKICAgICAgICBiYXNpc0NsYXNzSWRfOiBjbGFzc0lkLAogICAgICAgIHN1cGVyQ2xhc3NfOiBTdXBlckNsYXNzLAogICAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogISFTdXBlckNsYXNzLmV4dGVuZENvbnN0cnVjdG9yXywKICAgICAgICBpc1N1YmNsYXNzT2Y6IGlzU3ViY2xhc3NPZiwKICAgICAgICBzdWJjbGFzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3MuYXBwbHkobnVsbCwgWyBuZXdDbGFzcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSkpOwogICAgICAgIH0sCiAgICAgICAgZXh0ZW5kOiBleHRlbmRDbGFzcywKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSBTRUxGICYmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3ModmFsdWUpKSkgcmV0dXJuIEJhc2VDbGFzcy5jcmVhdGUuY2FsbChudWxsLCBuZXdDbGFzcywgdmFsdWUpOyBlbHNlIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIHByb3RvdHlwZTogbmV3UHJvdG8KICAgICAgfTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIG5ld0NsYXNzUHJvcHMuZXh0ZW5kKGV4dGVuc2lvbik7CiAgICAgIGlmIChuZXdQcm90by5pbml0ICE9PSBCYXNlQ2xhc3MucHJvdG90eXBlLmluaXQgJiYgIS9eZnVuY3Rpb25bXihdKlwoXCkvLnRlc3QobmV3UHJvdG8uaW5pdCkgJiYgbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8pIGNvbnNvbGVNZXRob2RzLndhcm4oInByb2JhYmx5IHdyb25nIGV4dGVuZENvbnN0cnVjdG9yXyB2YWx1ZSBmb3IgIiArIG5ld0NsYXNzUHJvcHMuY2xhc3NOYW1lKTsKICAgICAgdmFyIG5ld0NsYXNzID0gbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8gPyBmdW5jdGlvbihleHRlbmQpIHsKICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKICAgICAgICB2YXIgcHJvcDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5kKSB7CiAgICAgICAgICBwcm9wID0gdGhpc1trZXldOwogICAgICAgICAgdGhpc1trZXldID0gcHJvcCAmJiBwcm9wLl9fZXh0ZW5kX18gPyBwcm9wLl9fZXh0ZW5kX18oZXh0ZW5kW2tleV0pIDogZXh0ZW5kW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfTsKICAgICAgbmV3Q2xhc3MgPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHsKICAgICAgICBpbnN0YW5jZVNlZWQ6IGluc3RhbmNlU2VlZAogICAgICB9LCBuZXdDbGFzcyk7CiAgICAgIG5ld1Byb3RvLmNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CiAgICAgIGZvciAodmFyIGtleSBpbiBuZXdQcm90bykgaWYgKG5ld1Byb3RvW2tleV0gPT09IFNFTEYpIG5ld1Byb3RvW2tleV0gPSBuZXdDbGFzczsKICAgICAgZXh0ZW5kKG5ld0NsYXNzLCBuZXdDbGFzc1Byb3BzKTsKICAgICAgY2xhc3Nlcy5wdXNoKG5ld0NsYXNzKTsKICAgICAgcmV0dXJuIG5ld0NsYXNzOwogICAgfQogICAgZnVuY3Rpb24gZXh0ZW5kQ2xhc3Moc291cmNlKSB7CiAgICAgIHZhciBwcm90byA9IHRoaXMucHJvdG90eXBlOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iICYmICFpc0NsYXNzKHNvdXJjZSkpIHNvdXJjZSA9IHNvdXJjZSh0aGlzLnN1cGVyQ2xhc3NfLnByb3RvdHlwZSwgc2xpY2UocHJvdG8pKTsKICAgICAgaWYgKHNvdXJjZS5wcm90b3R5cGUpIHNvdXJjZSA9IHNvdXJjZS5wcm90b3R5cGU7CiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB2YXIgcHJvdG9WYWx1ZSA9IHByb3RvW2tleV07CiAgICAgICAgaWYgKGtleSA9PSAiY2xhc3NOYW1lIiB8fCBrZXkgPT0gImV4dGVuZENvbnN0cnVjdG9yXyIpIHRoaXNba2V5XSA9IHZhbHVlOyBlbHNlIHsKICAgICAgICAgIGlmIChwcm90b1ZhbHVlICYmIHByb3RvVmFsdWUuX19leHRlbmRfXykgcHJvdG9ba2V5XSA9IHByb3RvVmFsdWUuX19leHRlbmRfXyh2YWx1ZSk7IGVsc2UgewogICAgICAgICAgICBwcm90b1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChUT1NUUklOR19CVUcgJiYgc291cmNlW2tleSA9ICJ0b1N0cmluZyJdICE9PSB0b1N0cmluZykgcHJvdG9ba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHZhciBCYXNlQ2xhc3MgPSBleHRlbmQoY3JlYXRlQ2xhc3MsIHsKICAgICAgY2xhc3NOYW1lOiAiYmFzaXMuQ2xhc3MiLAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IGZhbHNlLAogICAgICBwcm90b3R5cGU6IHsKICAgICAgICBiYXNpc09iamVjdElkOiAwLAogICAgICAgIGNvbnN0cnVjdG9yOiBudWxsLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgcG9zdEluaXQ6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICJbb2JqZWN0ICIgKyAodGhpcy5jb25zdHJ1Y3RvciB8fCB0aGlzKS5jbGFzc05hbWUgKyAiXSI7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gdGhpcykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodGhpcywgcHJvcCkpIHRoaXNbcHJvcF0gPSBudWxsOwogICAgICAgICAgdGhpcy5kZXN0cm95ID0gJHVuZGVmOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgY3VzdG9tRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24sIGZuLCBkZXZOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgX19leHRlbmRfXzogZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CiAgICAgICAgICBpZiAoIWV4dGVuc2lvbikgcmV0dXJuIGV4dGVuc2lvbjsKICAgICAgICAgIGlmIChleHRlbnNpb24gJiYgZXh0ZW5zaW9uLl9fZXh0ZW5kX18pIHJldHVybiBleHRlbnNpb247CiAgICAgICAgICB2YXIgQmFzZSA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgICBCYXNlID0gZGV2VmVyYm9zZU5hbWUoZGV2TmFtZSB8fCAiY3VzdG9tRXh0ZW5kUHJvcGVydHkiLCB7fSwgQmFzZSk7CiAgICAgICAgICBCYXNlLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEJhc2U7CiAgICAgICAgICBmbihyZXN1bHQsIGV4dGVuc2lvbik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfS5fX2V4dGVuZF9fKGV4dGVuc2lvbiB8fCB7fSk7CiAgICB9OwogICAgdmFyIGV4dGVuc2libGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBleHRlbmQsICJleHRlbnNpYmxlUHJvcGVydHkiKTsKICAgIH07CiAgICB2YXIgbmVzdGVkRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgcmV0dXJuIGN1c3RvbUV4dGVuZFByb3BlcnR5KGV4dGVuc2lvbiwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbnNpb24pIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5zaW9uKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSByZXN1bHRba2V5XTsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUgJiYgdmFsdWUuX19leHRlbmRfXyA/IHZhbHVlLl9fZXh0ZW5kX18oZXh0ZW5zaW9uW2tleV0pIDogZXh0ZW5zaWJsZVByb3BlcnR5KGV4dGVuc2lvbltrZXldKTsKICAgICAgICB9CiAgICAgIH0sICJuZXN0ZWRFeHRlbmRQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBvbmVGdW5jdGlvblByb3BlcnR5ID0gZnVuY3Rpb24oZm4sIGtleXMpIHsKICAgICAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlCiAgICAgICAgfTsKICAgICAgICBpZiAoa2V5cykgewogICAgICAgICAgaWYgKGtleXMuX19leHRlbmRfXykgcmV0dXJuIGtleXM7CiAgICAgICAgICB2YXIgQ2xzID0gZGV2VmVyYm9zZU5hbWUoIm9uZUZ1bmN0aW9uUHJvcGVydHkiLCB7fSwgZnVuY3Rpb24oKSB7fSk7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2xzOwogICAgICAgICAgcmVzdWx0Ll9fZXh0ZW5kX18gPSBjcmVhdGU7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4ga2V5cykgaWYgKGtleXNba2V5XSkgcmVzdWx0W2tleV0gPSBmbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgcmV0dXJuIGNyZWF0ZShrZXlzIHx8IHt9KTsKICAgIH07CiAgICByZXR1cm4gZXh0ZW5kKEJhc2VDbGFzcywgewogICAgICBhbGxfOiBjbGFzc2VzLAogICAgICBTRUxGOiBTRUxGLAogICAgICBjcmVhdGU6IGNyZWF0ZUNsYXNzLAogICAgICBpc0NsYXNzOiBpc0NsYXNzLAogICAgICBjdXN0b21FeHRlbmRQcm9wZXJ0eTogY3VzdG9tRXh0ZW5kUHJvcGVydHksCiAgICAgIGV4dGVuc2libGVQcm9wZXJ0eTogZXh0ZW5zaWJsZVByb3BlcnR5LAogICAgICBuZXN0ZWRFeHRlbmRQcm9wZXJ0eTogbmVzdGVkRXh0ZW5kUHJvcGVydHksCiAgICAgIG9uZUZ1bmN0aW9uUHJvcGVydHk6IG9uZUZ1bmN0aW9uUHJvcGVydHkKICAgIH0pOwogIH0oKTsKICB2YXIgVG9rZW4gPSBDbGFzcyhudWxsLCB7CiAgICBjbGFzc05hbWU6ICJiYXNpcy5Ub2tlbiIsCiAgICB2YWx1ZTogbnVsbCwKICAgIGhhbmRsZXI6IG51bGwsCiAgICBkZWZlcnJlZFRva2VuOiBudWxsLAogICAgYmluZGluZ0JyaWRnZTogewogICAgICBhdHRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KSB7CiAgICAgICAgaG9zdC5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICB9LAogICAgICBkZXRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KSB7CiAgICAgICAgaG9zdC5kZXRhY2goZm4sIGNvbnRleHQpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGhvc3QpIHsKICAgICAgICByZXR1cm4gaG9zdC5nZXQoKTsKICAgICAgfQogICAgfSwKICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgIH0KICAgIH0sCiAgICBhdHRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGlmIChjdXJzb3IuZm4gPT09IGZuICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5Ub2tlbiNhdHRhY2g6IGR1cGxpY2F0ZSBmbiAmIGNvbnRleHQgcGFpciIpOwogICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgZm46IGZuLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgaGFuZGxlcjogdGhpcy5oYW5kbGVyCiAgICAgIH07CiAgICB9LAogICAgZGV0YWNoOiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgdmFyIHByZXY7CiAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICBjdXJzb3IuZm4gPSAkdW5kZWY7CiAgICAgICAgcHJldi5oYW5kbGVyID0gY3Vyc29yLmhhbmRsZXI7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2RldGFjaDogZm4gJiBjb250ZXh0IHBhaXIgbm90IGZvdW5kLCBub3RoaW5nIHdhcyByZW1vdmVkIik7CiAgICB9LAogICAgYXBwbHk6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwogICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBjdXJzb3IuZm4uY2FsbChjdXJzb3IuY29udGV4dCwgdmFsdWUpOwogICAgfSwKICAgIGRlZmVycmVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy5kZWZlcnJlZFRva2VuOwogICAgICBpZiAoIXRva2VuKSB7CiAgICAgICAgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW4gPSBuZXcgRGVmZXJyZWRUb2tlbih0aGlzLnZhbHVlKTsKICAgICAgICB0aGlzLmF0dGFjaCh0b2tlbi5zZXQsIHRva2VuKTsKICAgICAgfQogICAgICByZXR1cm4gdG9rZW47CiAgICB9LAogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmRlZmVycmVkVG9rZW4pIHsKICAgICAgICB0aGlzLmRlZmVycmVkVG9rZW4uZGVzdHJveSgpOwogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbiA9IG51bGw7CiAgICAgIH0KICAgICAgdGhpcy5oYW5kbGVyID0gbnVsbDsKICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICAgIHRoaXMuYXR0YWNoID0gJHVuZGVmOwogICAgICB0aGlzLmRldGFjaCA9ICR1bmRlZjsKICAgIH0KICB9KTsKICB2YXIgYXdhaXRUb0FwcGx5ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdG9rZW5zID0ge307CiAgICB2YXIgdGltZXI7CiAgICBmdW5jdGlvbiBhcHBseVRva2VucygpIHsKICAgICAgdmFyIGxpc3QgPSB0b2tlbnM7CiAgICAgIHRva2VucyA9IHt9OwogICAgICB0aW1lciA9IG51bGw7CiAgICAgIGZvciAodmFyIGtleSBpbiBsaXN0KSBsaXN0W2tleV0uYXBwbHkoKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih0b2tlbikgewogICAgICBpZiAodG9rZW4uYmFzaXNPYmplY3RJZCBpbiB0b2tlbnMpIHJldHVybjsKICAgICAgdG9rZW5zW3Rva2VuLmJhc2lzT2JqZWN0SWRdID0gdG9rZW47CiAgICAgIGlmICghdGltZXIpIHNldEltbWVkaWF0ZShhcHBseVRva2Vucyk7CiAgICB9OwogIH0oKTsKICB2YXIgRGVmZXJyZWRUb2tlbiA9IFRva2VuLnN1YmNsYXNzKHsKICAgIGNsYXNzTmFtZTogImJhc2lzLkRlZmVycmVkVG9rZW4iLAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgYXdhaXRUb0FwcGx5KHRoaXMpOwogICAgICB9CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICB2YXIgcmVzb3VyY2VzID0ge307CiAgdmFyIHJlc291cmNlQ29udGVudENhY2hlID0ge307CiAgdmFyIHJlc291cmNlUGF0Y2ggPSB7fTsKICB2YXIgdmlydHVhbFJlc291cmNlU2VlZCA9IDE7CiAgdmFyIHJlc291cmNlUmVzb2x2aW5nU3RhY2sgPSBbXTsKICB2YXIgcmVxdWlyZXM7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX3Jlc291cmNlc19fICE9ICJ1bmRlZmluZWQiID8gX19yZXNvdXJjZXNfXyA6IG51bGw7CiAgICBpZiAobWFwKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBtYXApIHJlc291cmNlQ29udGVudENhY2hlW3BhdGhVdGlscy5yZXNvbHZlKGtleSldID0gbWFwW2tleV07CiAgICB9CiAgfSkoKTsKICBmdW5jdGlvbiBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSkgewogICAgdmFyIHBhdGNoZXMgPSByZXNvdXJjZVBhdGNoW3Jlc291cmNlLnVybF07CiAgICBpZiAocGF0Y2hlcykgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnNvbGVNZXRob2RzLmluZm8oIkFwcGx5IHBhdGNoIGZvciAiICsgcmVzb3VyY2UudXJsKTsKICAgICAgcGF0Y2hlc1tpXShyZXNvdXJjZS5nZXQoKSwgcmVzb3VyY2UudXJsKTsKICAgIH0KICB9CiAgdmFyIGdldFJlc291cmNlQ29udGVudCA9IGZ1bmN0aW9uKHVybCwgaWdub3JlQ2FjaGUpIHsKICAgIGlmIChpZ25vcmVDYWNoZSB8fCAhcmVzb3VyY2VDb250ZW50Q2FjaGUuaGFzT3duUHJvcGVydHkodXJsKSkgewogICAgICB2YXIgcmVzb3VyY2VDb250ZW50ID0gIiI7CiAgICAgIGlmICghTk9ERV9FTlYpIHsKICAgICAgICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgICAgIHJlcS5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCAobmV3IERhdGUoMCkpLnRvR01UU3RyaW5nKCkpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJYLUJhc2lzLVJlc291cmNlIiwgMSk7CiAgICAgICAgcmVxLnNlbmQoIiIpOwogICAgICAgIGlmIChyZXEuc3RhdHVzID49IDIwMCAmJiByZXEuc3RhdHVzIDwgNDAwKSByZXNvdXJjZUNvbnRlbnQgPSByZXEucmVzcG9uc2VUZXh0OyBlbHNlIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJiYXNpcy5yZXNvdXJjZTogVW5hYmxlIHRvIGxvYWQgIiArIHVybCArICIgKHN0YXR1cyBjb2RlICIgKyByZXEuc3RhdHVzICsgIikiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc291cmNlQ29udGVudCA9IHByb2Nlc3MuYmFzaXNqc1JlYWRGaWxlID8gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUodXJsKSA6IHJlcXVpcmUoImZzIikucmVhZEZpbGVTeW5jKHVybCwgInV0Zi04Iik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsLCBlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzb3VyY2VDb250ZW50Q2FjaGVbdXJsXSA9IHJlc291cmNlQ29udGVudDsKICAgIH0KICAgIHJldHVybiByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdOwogIH07CiAgdmFyIGNyZWF0ZVJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwsIGNvbnRlbnQpIHsKICAgIHZhciBjb250ZW50VHlwZSA9IHBhdGhVdGlscy5leHRuYW1lKHJlc291cmNlVXJsKTsKICAgIHZhciBjb250ZW50V3JhcHBlciA9IGdldFJlc291cmNlLmV4dGVuc2lvbnNbY29udGVudFR5cGVdOwogICAgdmFyIGlzVmlydHVhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxOwogICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CiAgICB2YXIgd3JhcHBlZCA9IGZhbHNlOwogICAgdmFyIHdyYXBwZWRDb250ZW50OwogICAgaWYgKGlzVmlydHVhbCkgcmVzb3VyY2VVcmwgKz0gIiN2aXJ0dWFsIjsKICAgIHZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAocmVzb2x2ZWQpIHJldHVybiBjb250ZW50OwogICAgICB2YXIgdXJsQ29udGVudCA9IGlzVmlydHVhbCA/IGNvbnRlbnQgOiBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpOwogICAgICB2YXIgaWR4ID0gcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5pbmRleE9mKHJlc291cmNlVXJsKTsKICAgICAgaWYgKGlkeCAhPSAtMSkgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2UgcmVjdXJzaW9uOiIsIHJlc291cmNlUmVzb2x2aW5nU3RhY2suc2xpY2UoaWR4KS5jb25jYXQocmVzb3VyY2VVcmwpLm1hcChwYXRoVXRpbHMucmVsYXRpdmUsIHBhdGhVdGlscykuam9pbigiIC0+ICIpKTsKICAgICAgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wdXNoKHJlc291cmNlVXJsKTsKICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyKSB7CiAgICAgICAgaWYgKCF3cmFwcGVkKSB7CiAgICAgICAgICB3cmFwcGVkID0gdHJ1ZTsKICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50V3JhcHBlcih1cmxDb250ZW50LCByZXNvdXJjZVVybCk7CiAgICAgICAgICB3cmFwcGVkQ29udGVudCA9IHVybENvbnRlbnQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICB9CiAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnBvcCgpOwogICAgICByZXR1cm4gY29udGVudDsKICAgIH07CiAgICBleHRlbmQocmVzb3VyY2UsIGV4dGVuZChuZXcgVG9rZW4sIHsKICAgICAgdXJsOiByZXNvdXJjZVVybCwKICAgICAgdHlwZTogY29udGVudFR5cGUsCiAgICAgIHZpcnR1YWw6IGlzVmlydHVhbCwKICAgICAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByZXNvdXJjZSgpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJbYmFzaXMucmVzb3VyY2UgIiArIHJlc291cmNlVXJsICsgIl0iOwogICAgICB9LAogICAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgIH0sCiAgICAgIGhhc0NoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBjb250ZW50V3JhcHBlciA/IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSAhPT0gd3JhcHBlZENvbnRlbnQgOiBmYWxzZTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihuZXdDb250ZW50KSB7CiAgICAgICAgaWYgKCFyZXNvbHZlZCB8fCBpc1ZpcnR1YWwgfHwgbmV3Q29udGVudCAhPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0pIHsKICAgICAgICAgIGlmICghaXNWaXJ0dWFsKSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gPSBuZXdDb250ZW50OwogICAgICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyKSB7CiAgICAgICAgICAgIGlmICghd3JhcHBlZCAmJiBpc1ZpcnR1YWwpIGNvbnRlbnQgPSBuZXdDb250ZW50OwogICAgICAgICAgICBpZiAod3JhcHBlZCAmJiAhY29udGVudFdyYXBwZXIucGVybWFuZW50KSB7CiAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKG5ld0NvbnRlbnQsIHJlc291cmNlVXJsLCBjb250ZW50KTsKICAgICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoaXNWaXJ0dWFsKSByZXR1cm47CiAgICAgICAgdmFyIG9sZENvbnRlbnQgPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF07CiAgICAgICAgdmFyIG5ld0NvbnRlbnQgPSBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwsIHRydWUpOwogICAgICAgIGlmIChuZXdDb250ZW50ICE9IG9sZENvbnRlbnQpIHsKICAgICAgICAgIHJlc29sdmVkID0gZmFsc2U7CiAgICAgICAgICByZXNvdXJjZS51cGRhdGUobmV3Q29udGVudCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmIChpc1ZpcnR1YWwpIGlmIChzb3VyY2UpIHJldHVybiBjb250ZW50V3JhcHBlciA/IHdyYXBwZWRDb250ZW50IDogY29udGVudDsKICAgICAgICByZXR1cm4gc291cmNlID8gZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsKSA6IHJlc291cmNlKCk7CiAgICAgIH0sCiAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgZm4uY2FsbChjb250ZXh0LCByZXNvdXJjZSgpKTsKICAgICAgICAgIGlmIChjb250ZW50V3JhcHBlciAmJiBjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmVzb3VyY2UuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgIH0KICAgIH0pKTsKICAgIHJlc291cmNlc1tyZXNvdXJjZVVybF0gPSByZXNvdXJjZTsKICAgIHJldHVybiByZXNvdXJjZTsKICB9OwogIHZhciBnZXRSZXNvdXJjZSA9IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICB2YXIgcmVzb3VyY2UgPSByZXNvdXJjZXNbcmVzb3VyY2VVcmxdOwogICAgaWYgKHJlc291cmNlKSByZXR1cm4gcmVzb3VyY2U7CiAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlKCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgcmVzb3VyY2VVcmwgPSBwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCk7CiAgICByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CiAgICByZXR1cm4gcmVzb3VyY2UgfHwgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2VVcmwpOwogIH07CiAgZXh0ZW5kKGdldFJlc291cmNlLCB7CiAgICBpc1Jlc291cmNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPyByZXNvdXJjZXNbdmFsdWUudXJsXSA9PT0gdmFsdWUgOiBmYWxzZTsKICAgIH0sCiAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICB2YXIgcmVzb3VyY2UgPSBnZXRSZXNvdXJjZS5nZXQocmVzb3VyY2VVcmwpOwogICAgICByZXR1cm4gcmVzb3VyY2UgPyByZXNvdXJjZS5pc1Jlc29sdmVkKCkgOiBmYWxzZTsKICAgIH0sCiAgICBleGlzdHM6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZXhpc3RzKCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICByZXR1cm4gcmVzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlLmdldCgnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmVzb3VyY2VVcmwgPSBwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCk7CiAgICAgIGlmICghZ2V0UmVzb3VyY2UuZXhpc3RzKHJlc291cmNlVXJsKSkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBnZXRSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgICB9LAogICAgZ2V0RmlsZXM6IGZ1bmN0aW9uKGNhY2hlKSB7CiAgICAgIHJldHVybiBrZXlzKGNhY2hlID8gcmVzb3VyY2VDb250ZW50Q2FjaGUgOiByZXNvdXJjZXMpLm1hcChwYXRoVXRpbHMucmVsYXRpdmUpOwogICAgfSwKICAgIHZpcnR1YWw6IGZ1bmN0aW9uKHR5cGUsIGNvbnRlbnQsIG93bmVyVXJsKSB7CiAgICAgIHJldHVybiBjcmVhdGVSZXNvdXJjZSgob3duZXJVcmwgPyBvd25lclVybCArICI6IiA6IHBhdGhVdGlscy5ub3JtYWxpemUocGF0aFV0aWxzLmJhc2VVUkkgPT0gIi8iID8gIiIgOiBwYXRoVXRpbHMuYmFzZVVSSSkgKyAiLyIpICsgInZpcnR1YWwtcmVzb3VyY2UiICsgdmlydHVhbFJlc291cmNlU2VlZCsrICsgIi4iICsgdHlwZSwgY29udGVudCk7CiAgICB9LAogICAgZXh0ZW5zaW9uczogewogICAgICAiLmpzIjogZXh0ZW5kKGZ1bmN0aW9uKGNvbnRlbnQsIGZpbGVuYW1lKSB7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV07CiAgICAgICAgaWYgKCFuYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpbXBsaWNpdE5hbWVzcGFjZSA9IHRydWU7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRGaWxlbmFtZSA9IHBhdGhVdGlscy5kaXJuYW1lKGZpbGVuYW1lKSArICIvIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKTsKICAgICAgICAgIGZvciAodmFyIG5zIGluIG5zUm9vdFBhdGgpIHsKICAgICAgICAgICAgdmFyIHBhdGggPSBuc1Jvb3RQYXRoW25zXSArIG5zICsgIi8iOwogICAgICAgICAgICBpZiAocmVzb2x2ZWRGaWxlbmFtZS5zdWJzdHIoMCwgcGF0aC5sZW5ndGgpID09IHBhdGgpIHsKICAgICAgICAgICAgICBpbXBsaWNpdE5hbWVzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIHJlc29sdmVkRmlsZW5hbWUgPSByZXNvbHZlZEZpbGVuYW1lLnN1YnN0cihuc1Jvb3RQYXRoW25zXS5sZW5ndGgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lc3BhY2UgPSByZXNvbHZlZEZpbGVuYW1lLnJlcGxhY2UoL1wuL2csICJfIikucmVwbGFjZSgvXlwvL2csICIiKS5yZXBsYWNlKC9cLy9nLCAiLiIpOwogICAgICAgICAgaWYgKGltcGxpY2l0TmFtZXNwYWNlKSBuYW1lc3BhY2UgPSAiaW1wbGljaXQuIiArIG5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlcXVpcmVzKSBhcnJheUZ1bmN0aW9ucy5hZGQocmVxdWlyZXMsIG5hbWVzcGFjZSk7CiAgICAgICAgaWYgKCFuYW1lc3BhY2VzW25hbWVzcGFjZV0pIHsKICAgICAgICAgIHZhciBucyA9IGdldE5hbWVzcGFjZShuYW1lc3BhY2UpOwogICAgICAgICAgdmFyIHNhdmVkUmVxdWlyZXMgPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gW107CiAgICAgICAgICBucy5leHBvcnRzID0gcnVuU2NyaXB0SW5Db250ZXh0KHsKICAgICAgICAgICAgcGF0aDogbnMucGF0aCwKICAgICAgICAgICAgZXhwb3J0czogbnMuZXhwb3J0cwogICAgICAgICAgfSwgZmlsZW5hbWUsIGNvbnRlbnQpLmV4cG9ydHM7CiAgICAgICAgICBpZiAobnMuZXhwb3J0cyAmJiBucy5leHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5zLCBucy5leHBvcnRzKTsKICAgICAgICAgIG5zLmZpbGVuYW1lXyA9IGZpbGVuYW1lOwogICAgICAgICAgbnMuc291cmNlXyA9IGNvbnRlbnQ7CiAgICAgICAgICBucy5yZXF1aXJlc18gPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gc2F2ZWRSZXF1aXJlczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5hbWVzcGFjZXNbbmFtZXNwYWNlXS5leHBvcnRzOwogICAgICB9LCB7CiAgICAgICAgcGVybWFuZW50OiB0cnVlCiAgICAgIH0pLAogICAgICAiLmNzcyI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCwgY3NzUmVzb3VyY2UpIHsKICAgICAgICBpZiAoIWNzc1Jlc291cmNlKSBjc3NSZXNvdXJjZSA9IG5ldyBDc3NSZXNvdXJjZSh1cmwpOwogICAgICAgIGNzc1Jlc291cmNlLnVwZGF0ZUNzc1RleHQoY29udGVudCk7CiAgICAgICAgcmV0dXJuIGNzc1Jlc291cmNlOwogICAgICB9LAogICAgICAiLmpzb24iOiBmdW5jdGlvbihjb250ZW50LCB1cmwpIHsKICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT0gIm9iamVjdCIpIHJldHVybiBjb250ZW50OwogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnRlbnQgPSBTdHJpbmcoY29udGVudCk7CiAgICAgICAgICByZXN1bHQgPSBiYXNpcy5qc29uLnBhcnNlKGNvbnRlbnQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnJlc291cmNlOiBDYW4ndCBwYXJzZSBKU09OIGZyb20gIiArIHVybCwgewogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgY29udGVudDogY29udGVudAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQgfHwgbnVsbDsKICAgICAgfQogICAgfQogIH0pOwogIGZ1bmN0aW9uIGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIGFyZ3MsIGJvZHkpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSArICJcblxuLy8jIHNvdXJjZVVSTD0iICsgcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGlmIChkb2N1bWVudCAmJiAibGluZSIgaW4gZSA9PSBmYWxzZSAmJiAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSB7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgZnVuY3Rpb24gb25lcnJvcihldmVudCkgewogICAgICAgICAgaWYgKGV2ZW50LmZpbGVuYW1lID09IHBhdGhVdGlscy5vcmlnaW4gKyBzb3VyY2VVUkwpIHsKICAgICAgICAgICAgZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgb25lcnJvcik7CiAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgZXZlbnQuZmlsZW5hbWUgKyAiOiIgKyBldmVudC5saW5lbm8gKyAiOiAiICsgZSk7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5zcmMgPSBzb3VyY2VVUkw7CiAgICAgICAgc2NyaXB0LmFzeW5jID0gZmFsc2U7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgfQogICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiQ29tcGlsYXRpb24gZXJyb3IgYXQgIiArIHNvdXJjZVVSTCArICgibGluZSIgaW4gZSA/ICI6IiArIChlLmxpbmUgLSAxKSA6ICIiKSArICI6ICIgKyBlKTsKICAgIH0KICB9CiAgdmFyIHJ1blNjcmlwdEluQ29udGV4dCA9IGZ1bmN0aW9uKGNvbnRleHQsIHNvdXJjZVVSTCwgc291cmNlQ29kZSkgewogICAgdmFyIGJhc2VVUkwgPSBwYXRoVXRpbHMuZGlybmFtZShzb3VyY2VVUkwpICsgIi8iOwogICAgdmFyIGNvbXBpbGVkU291cmNlQ29kZSA9IHNvdXJjZUNvZGU7CiAgICBpZiAoIWNvbnRleHQuZXhwb3J0cykgY29udGV4dC5leHBvcnRzID0ge307CiAgICBpZiAodHlwZW9mIGNvbXBpbGVkU291cmNlQ29kZSAhPSAiZnVuY3Rpb24iKSBjb21waWxlZFNvdXJjZUNvZGUgPSBjb21waWxlRnVuY3Rpb24oc291cmNlVVJMLCBbICJleHBvcnRzIiwgIm1vZHVsZSIsICJiYXNpcyIsICJnbG9iYWwiLCAiX19maWxlbmFtZSIsICJfX2Rpcm5hbWUiLCAicmVzb3VyY2UiLCAicmVxdWlyZSIgXSwgJyJ1c2Ugc3RyaWN0IjtcbicgKyBzb3VyY2VDb2RlKTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlID09ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZS5jYWxsKGNvbnRleHQuZXhwb3J0cywgY29udGV4dC5leHBvcnRzLCBjb250ZXh0LCBiYXNpcywgZ2xvYmFsLCBzb3VyY2VVUkwsIGJhc2VVUkwsIGZ1bmN0aW9uKHJlbGF0aXZlUGF0aCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVsYXRpdmVQYXRoKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiByZXNvdXJjZSgnIiArIHJlbGF0aXZlUGF0aCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJldHVybiBnZXRSZXNvdXJjZShwYXRoVXRpbHMucmVzb2x2ZShiYXNlVVJMLCByZWxhdGl2ZVBhdGgpKTsKICAgIH0sIGZ1bmN0aW9uKHJlbGF0aXZlUGF0aCwgYmFzZSkgewogICAgICByZXR1cm4gcmVxdWlyZU5hbWVzcGFjZShyZWxhdGl2ZVBhdGgsIGJhc2UgfHwgYmFzZVVSTCk7CiAgICB9KTsKICAgIHJldHVybiBjb250ZXh0OwogIH07CiAgdmFyIG5hbWVzcGFjZXMgPSB7fTsKICB2YXIgbmFtZXNwYWNlMmZpbGVuYW1lID0ge307CiAgdmFyIGZpbGVuYW1lMm5hbWVzcGFjZSA9IHt9OwogIHZhciBuc1Jvb3RQYXRoID0ge307CiAgaXRlcmF0ZShjb25maWcubW9kdWxlcywgZnVuY3Rpb24obmFtZSwgbW9kdWxlKSB7CiAgICBuc1Jvb3RQYXRoW25hbWVdID0gbW9kdWxlLnBhdGggKyAiLyI7CiAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZV0gPSBtb2R1bGUuZmlsZW5hbWU7CiAgICBmaWxlbmFtZTJuYW1lc3BhY2VbbW9kdWxlLmZpbGVuYW1lXSA9IG5hbWU7CiAgfSk7CiAgKGZ1bmN0aW9uKG1hcCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX25hbWVzcGFjZV9tYXBfXyAhPSAidW5kZWZpbmVkIiA/IF9fbmFtZXNwYWNlX21hcF9fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGtleSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IG1hcFtrZXldOwogICAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV0gPSBmaWxlbmFtZTsKICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5hbWVzcGFjZSA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLk5hbWVzcGFjZSIsCiAgICBpbml0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZXhwb3J0cyA9IHsKICAgICAgICBwYXRoOiB0aGlzLm5hbWUKICAgICAgfTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAiW2Jhc2lzLm5hbWVzcGFjZSAiICsgdGhpcy5wYXRoICsgIl0iOwogICAgfSwKICAgIGV4dGVuZDogZnVuY3Rpb24obmFtZXMpIHsKICAgICAgZXh0ZW5kKHRoaXMuZXhwb3J0cywgbmFtZXMpOwogICAgICByZXR1cm4gY29tcGxldGUodGhpcywgbmFtZXMpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHJlc29sdmVOU0ZpbGVuYW1lKG5hbWVzcGFjZSkgewogICAgaWYgKG5hbWVzcGFjZSBpbiBuYW1lc3BhY2UyZmlsZW5hbWUgPT0gZmFsc2UpIHsKICAgICAgdmFyIHBhcnRzID0gbmFtZXNwYWNlLnNwbGl0KCIuIik7CiAgICAgIHZhciBuYW1lc3BhY2VSb290ID0gcGFydHMuc2hpZnQoKTsKICAgICAgdmFyIGZpbGVuYW1lID0gcGFydHMuam9pbigiLyIpICsgIi5qcyI7CiAgICAgIGlmIChuYW1lc3BhY2VSb290IGluIG5zUm9vdFBhdGggPT0gZmFsc2UpIG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gPSBwYXRoVXRpbHMuYmFzZVVSSSArIG5hbWVzcGFjZVJvb3QgKyAiLyI7CiAgICAgIGlmIChuYW1lc3BhY2VSb290ID09IG5hbWVzcGFjZSkgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdLnJlcGxhY2UoL1wvJC8sICIiKSArICIuanMiOyBlbHNlIGZpbGVuYW1lID0gbnNSb290UGF0aFtuYW1lc3BhY2VSb290XSArIGZpbGVuYW1lOwogICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICBmaWxlbmFtZTJuYW1lc3BhY2VbZmlsZW5hbWVdID0gbmFtZXNwYWNlOwogICAgfQogICAgcmV0dXJuIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdOwogIH0KICBmdW5jdGlvbiBnZXRSb290TmFtZXNwYWNlKG5hbWUpIHsKICAgIHZhciBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdOwogICAgaWYgKCFuYW1lc3BhY2UpIHsKICAgICAgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXSA9IG5ldyBOYW1lc3BhY2UobmFtZSk7CiAgICAgIG5hbWVzcGFjZS5uYW1lc3BhY2VzXyA9IHt9OwogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc19bbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgIGlmICghY29uZmlnLm5vQ29uZmxpY3QpIGdsb2JhbFtuYW1lXSA9IG5hbWVzcGFjZTsKICAgIH0KICAgIGlmIChuYW1lID09ICJiYnQiICYmICFiYnQpIGJidCA9IG5hbWVzcGFjZXNbbmFtZV07CiAgICByZXR1cm4gbmFtZXNwYWNlOwogIH0KICBmdW5jdGlvbiBnZXROYW1lc3BhY2UocGF0aCkgewogICAgcGF0aCA9IHBhdGguc3BsaXQoIi4iKTsKICAgIHZhciByb290TnMgPSBnZXRSb290TmFtZXNwYWNlKHBhdGhbMF0pOwogICAgdmFyIGN1cnNvciA9IHJvb3ROczsKICAgIGZvciAodmFyIGkgPSAxLCBuYW1lOyBuYW1lID0gcGF0aFtpXTsgaSsrKSB7CiAgICAgIGlmICghY3Vyc29yW25hbWVdKSB7CiAgICAgICAgdmFyIG5zcGF0aCA9IHBhdGguc2xpY2UoMCwgaSArIDEpLmpvaW4oIi4iKTsKICAgICAgICBjdXJzb3JbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5zcGF0aCk7CiAgICAgICAgcm9vdE5zLm5hbWVzcGFjZXNfW25zcGF0aF0gPSBjdXJzb3JbbmFtZV07CiAgICAgIH0KICAgICAgY3Vyc29yID0gY3Vyc29yW25hbWVdOwogICAgfQogICAgbmFtZXNwYWNlc1twYXRoLmpvaW4oIi4iKV0gPSBjdXJzb3I7CiAgICByZXR1cm4gY3Vyc29yOwogIH0KICB2YXIgcmVxdWlyZU5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKE5PREVfRU5WKSB7CiAgICAgIHZhciBtb2R1bGVQcm90byA9IG1vZHVsZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpIHx8IHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSA9PSAiLmpzIikgewogICAgICAgICAgdmFyIF9jb21waWxlID0gbW9kdWxlUHJvdG8uX2NvbXBpbGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0TmFtZXNwYWNlKGZpbGVuYW1lKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNpcyA9IGJhc2lzOwogICAgICAgICAgICBjb250ZW50ID0gInZhciBfX25vZGVqc1JlcXVpcmUgPSByZXF1aXJlO1xuIiArICJ2YXIgYmFzaXMgPSBtb2R1bGUuYmFzaXM7XG4iICsgJ3ZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKXsgcmV0dXJuIGJhc2lzLnJlc291cmNlKF9fZGlybmFtZSArICIvIiArIGZpbGVuYW1lKSB9O1xuJyArICJ2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBiYXNlVVJJKXsgcmV0dXJuIGJhc2lzLnJlcXVpcmUoZmlsZW5hbWUsIGJhc2VVUkkgfHwgX19kaXJuYW1lKSB9O1xuIiArIGNvbnRlbnQ7CiAgICAgICAgICAgIF9jb21waWxlLmNhbGwoZXh0ZW5kKHRoaXMsIG5hbWVzcGFjZSksIGNvbnRlbnQsIGZpbGVuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXhwb3J0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIi8iKSk7CiAgICAgICAgICBuYW1lc3BhY2UuZXhwb3J0cyA9IGV4cG9ydHM7CiAgICAgICAgICBpZiAoZXhwb3J0cyAmJiBleHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5hbWVzcGFjZSwgZXhwb3J0cyk7CiAgICAgICAgICBtb2R1bGVQcm90by5fY29tcGlsZSA9IF9jb21waWxlOwogICAgICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogcmVxdWlyZSgnIiArIGZpbGVuYW1lICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2UoZmlsZW5hbWUpLmZldGNoKCk7CiAgICAgIH07CiAgICB9CiAgfSgpOwogIGZ1bmN0aW9uIHBhdGNoKGZpbGVuYW1lLCBwYXRjaEZuKSB7CiAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gIi5qcyIpIHsKICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZmlsZW5hbWUpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnBhdGNoKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgIH0KICAgIGlmICghcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0pIHJlc291cmNlUGF0Y2hbZmlsZW5hbWVdID0gWyBwYXRjaEZuIF07IGVsc2UgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0ucHVzaChwYXRjaEZuKTsKICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChmaWxlbmFtZSk7CiAgICBpZiAocmVzb3VyY2UgJiYgcmVzb3VyY2UuaXNSZXNvbHZlZCgpKSBwYXRjaEZuKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogIH0KICBjb21wbGV0ZShGdW5jdGlvbi5wcm90b3R5cGUsIHsKICAgIGJpbmQ6IGZ1bmN0aW9uKHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGZuID0gdGhpczsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMsIDEpOwogICAgICByZXR1cm4gcGFyYW1zLmxlbmd0aCA/IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBwYXJhbXMuY29uY2F0LmFwcGx5KHBhcmFtcywgYXJndW1lbnRzKSk7CiAgICAgIH0gOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpc09iamVjdCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShBcnJheSwgewogICAgaXNBcnJheTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAiW29iamVjdCBBcnJheV0iOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIGFycmF5RnJvbShvYmplY3QsIG9mZnNldCkgewogICAgaWYgKG9iamVjdCAhPSBudWxsKSB7CiAgICAgIHZhciBsZW4gPSBvYmplY3QubGVuZ3RoOwogICAgICBpZiAodHlwZW9mIGxlbiA9PSAidW5kZWZpbmVkIiB8fCB0b1N0cmluZy5jYWxsKG9iamVjdCkgPT0gIltvYmplY3QgRnVuY3Rpb25dIikgcmV0dXJuIFsgb2JqZWN0IF07CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwOwogICAgICBpZiAobGVuIC0gb2Zmc2V0ID4gMCkgewogICAgICAgIGZvciAodmFyIHJlc3VsdCA9IFtdLCBrID0gMCwgaSA9IG9mZnNldDsgaSA8IGxlbjsgKSByZXN1bHRbaysrXSA9IG9iamVjdFtpKytdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQXJyYXkobGVuZ3RoLCBmaWxsVmFsdWUsIHRoaXNPYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBpc0Z1bmMgPSB0eXBlb2YgZmlsbFZhbHVlID09ICJmdW5jdGlvbiI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSByZXN1bHRbaV0gPSBpc0Z1bmMgPyBmaWxsVmFsdWUuY2FsbCh0aGlzT2JqZWN0LCBpLCByZXN1bHQpIDogZmlsbFZhbHVlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgY29tcGxldGUoQXJyYXkucHJvdG90eXBlLCB7CiAgICBpbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpIHsKICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCkgfHwgMDsKICAgICAgaWYgKG9mZnNldCA8IDApIHJldHVybiAtMTsKICAgICAgZm9yICg7IG9mZnNldCA8IHRoaXMubGVuZ3RoOyBvZmZzZXQrKykgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGxhc3RJbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKTsKICAgICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID49IGxlbikgb2Zmc2V0ID0gbGVuIC0gMTsgZWxzZSBvZmZzZXQgPSAob2Zmc2V0ICsgbGVuKSAlIGxlbjsKICAgICAgZm9yICg7IG9mZnNldCA+PSAwOyBvZmZzZXQtLSkgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGZvckVhY2g6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgfSwKICAgIGV2ZXJ5OiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiAhY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBzb21lOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXN1bHQucHVzaCh0aGlzW2ldKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIHJlc3VsdFtpXSA9IGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAogICAgcmVkdWNlOiBmdW5jdGlvbihjYWxsYmFjaywgaW5pdGlhbFZhbHVlKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgdmFyIGFyZ3NMZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICBpZiAobGVuID09IDAgJiYgYXJnc0xlbiA9PSAxKSB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgaW5pdGVkID0gMDsKICAgICAgaWYgKGFyZ3NMZW4gPiAxKSB7CiAgICAgICAgcmVzdWx0ID0gaW5pdGlhbFZhbHVlOwogICAgICAgIGluaXRlZCA9IDE7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgaWYgKGluaXRlZCsrKSByZXN1bHQgPSBjYWxsYmFjay5jYWxsKG51bGwsIHJlc3VsdCwgdGhpc1tpXSwgaSwgdGhpcyk7IGVsc2UgcmVzdWx0ID0gdGhpc1tpXTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9KTsKICB2YXIgYXJyYXlGdW5jdGlvbnMgPSB7CiAgICBmcm9tOiBhcnJheUZyb20sCiAgICBjcmVhdGU6IGNyZWF0ZUFycmF5LAogICAgZmxhdHRlbjogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLmNvbmNhdC5hcHBseShbXSwgdGhpc18pOwogICAgfSwKICAgIHJlcGVhdDogZnVuY3Rpb24odGhpc18sIGNvdW50KSB7CiAgICAgIHJldHVybiBhcnJheUZ1bmN0aW9ucy5mbGF0dGVuKGNyZWF0ZUFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgfHwgMCwgdGhpc18pKTsKICAgIH0sCiAgICBzZWFyY2g6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSwgZ2V0dGVyXywgb2Zmc2V0KSB7CiAgICAgIHRoaXNfLmxhc3RTZWFyY2hJbmRleCA9IC0xOwogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8gfHwgJHNlbGYpOwogICAgICBmb3IgKHZhciBpbmRleCA9IHBhcnNlSW50KG9mZnNldCwgMTApIHx8IDAsIGxlbiA9IHRoaXNfLmxlbmd0aDsgaW5kZXggPCBsZW47IGluZGV4KyspIGlmIChnZXR0ZXJfKHRoaXNfW2luZGV4XSkgPT09IHZhbHVlKSByZXR1cm4gdGhpc19bdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gaW5kZXhdOwogICAgfSwKICAgIGxhc3RTZWFyY2g6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSwgZ2V0dGVyXywgb2Zmc2V0KSB7CiAgICAgIHRoaXNfLmxhc3RTZWFyY2hJbmRleCA9IC0xOwogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8gfHwgJHNlbGYpOwogICAgICB2YXIgbGVuID0gdGhpc18ubGVuZ3RoOwogICAgICB2YXIgaW5kZXggPSBpc05hTihvZmZzZXQpIHx8IG9mZnNldCA9PSBudWxsID8gbGVuIDogcGFyc2VJbnQob2Zmc2V0LCAxMCk7CiAgICAgIGZvciAodmFyIGkgPSBpbmRleCA+IGxlbiA/IGxlbiA6IGluZGV4OyBpLS0gPiAwOyApIGlmIChnZXR0ZXJfKHRoaXNfW2ldKSA9PT0gdmFsdWUpIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpXTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICByZXR1cm4gdGhpc18uaW5kZXhPZih2YWx1ZSkgPT0gLTEgJiYgISF0aGlzXy5wdXNoKHZhbHVlKTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICB2YXIgaW5kZXggPSB0aGlzXy5pbmRleE9mKHZhbHVlKTsKICAgICAgcmV0dXJuIGluZGV4ICE9IC0xICYmICEhdGhpc18uc3BsaWNlKGluZGV4LCAxKTsKICAgIH0sCiAgICBoYXM6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICByZXR1cm4gdGhpc18uaW5kZXhPZih2YWx1ZSkgIT0gLTE7CiAgICB9LAogICAgc29ydEFzT2JqZWN0OiBmdW5jdGlvbigpIHsKICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuYXJyYXkuc29ydEFzT2JqZWN0IGlzIGRlcHJlY2F0ZWQsIHVzZSBiYXNpcy5hcnJheS5zb3J0IGluc3RlYWQiKTsKICAgICAgcmV0dXJuIGFycmF5RnVuY3Rpb25zLnNvcnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICBzb3J0OiBmdW5jdGlvbih0aGlzXywgZ2V0dGVyXywgY29tcGFyYXRvciwgZGVzYykgewogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8pOwogICAgICBkZXNjID0gZGVzYyA/IC0xIDogMTsKICAgICAgcmV0dXJuIHRoaXNfLm1hcChmdW5jdGlvbihpdGVtLCBpbmRleCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpOiBpbmRleCwKICAgICAgICAgIHY6IGdldHRlcl8oaXRlbSkKICAgICAgICB9OwogICAgICB9KS5zb3J0KGNvbXBhcmF0b3IgfHwgZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBkZXNjICogKGEudiA+IGIudiB8fCAtKGEudiA8IGIudikgfHwgKGEuaSA+IGIuaSA/IDEgOiAtMSkpOwogICAgICB9KS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB0aGlzW2l0ZW0uaV07CiAgICAgIH0sIHRoaXNfKTsKICAgIH0KICB9OwogIGlmICghWyAxLCAyIF0uc3BsaWNlKDEpLmxlbmd0aCkgewogICAgdmFyIG5hdGl2ZUFycmF5U3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDIpIHBhcmFtc1sxXSA9IHRoaXMubGVuZ3RoOwogICAgICByZXR1cm4gbmF0aXZlQXJyYXlTcGxpY2UuYXBwbHkodGhpcywgcGFyYW1zKTsKICAgIH07CiAgfQogIHZhciBFU0NBUEVfRk9SX1JFR0VYUCA9IC8oW1wvXFxcKFwpXFtcXVw/XHtcfVx8XCpcK1wtXC5cXlwkXSkvZzsKICB2YXIgRk9STUFUX1JFR0VYUCA9IC9ceyhbYS16XGRfXSspKD86OihbXC4wXSkoXGQrKXw6KFw/KSk/XH0vZ2k7CiAgY29tcGxldGUoU3RyaW5nLCB7CiAgICB0b0xvd2VyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICB0b1VwcGVyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltKCk7CiAgICB9LAogICAgdHJpbUxlZnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1MZWZ0KCk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShTdHJpbmcucHJvdG90eXBlLCB7CiAgICB0cmltTGVmdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcGxhY2UoL15ccysvLCAiIik7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sICIiKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudHJpbUxlZnQoKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICB2YXIgc3RyaW5nRnVuY3Rpb25zID0gewogICAgdG9PYmplY3Q6IGZ1bmN0aW9uKHRoaXNfLCByZXRocm93KSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAwLCIgKyB0aGlzXykpKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAocmV0aHJvdykgdGhyb3cgZTsKICAgICAgfQogICAgfSwKICAgIHJlcGVhdDogZnVuY3Rpb24odGhpc18sIGNvdW50KSB7CiAgICAgIHJldHVybiAobmV3IEFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgKyAxIHx8IDApKS5qb2luKHRoaXNfKTsKICAgIH0sCiAgICBxdzogZnVuY3Rpb24odGhpc18pIHsKICAgICAgdmFyIHRyaW1tZWQgPSB0aGlzXy50cmltKCk7CiAgICAgIHJldHVybiB0cmltbWVkID8gdHJpbW1lZC5zcGxpdCgvXHMrLykgOiBbXTsKICAgIH0sCiAgICBmb3JSZWdFeHA6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKEVTQ0FQRV9GT1JfUkVHRVhQLCAiXFwkMSIpOwogICAgfSwKICAgIGZvcm1hdDogZnVuY3Rpb24odGhpc18sIGZpcnN0KSB7CiAgICAgIHZhciBkYXRhID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICh0eXBlb2YgZmlyc3QgPT0gIm9iamVjdCIpIGV4dGVuZChkYXRhLCBmaXJzdCk7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKEZPUk1BVF9SRUdFWFAsIGZ1bmN0aW9uKG0sIGtleSwgbnVtRm9ybWF0LCBudW0sIG5vTnVsbCkgewogICAgICAgIHZhciB2YWx1ZSA9IGtleSBpbiBkYXRhID8gZGF0YVtrZXldIDogbm9OdWxsID8gIiIgOiBtOwogICAgICAgIGlmIChudW1Gb3JtYXQgJiYgIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgdmFsdWUgPSBOdW1iZXIodmFsdWUpOwogICAgICAgICAgcmV0dXJuIG51bUZvcm1hdCA9PSAiLiIgPyB2YWx1ZS50b0ZpeGVkKG51bSkgOiBudW1iZXJGdW5jdGlvbnMubGVhZCh2YWx1ZSwgbnVtKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9KTsKICAgIH0sCiAgICBjYXBpdGFsaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aGlzXy5zdWJzdHIoMSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICBjYW1lbGl6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoLy0oLikvZywgZnVuY3Rpb24obSwgY2hyKSB7CiAgICAgICAgcmV0dXJuIGNoci50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBkYXNoZXJpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihtKSB7CiAgICAgICAgcmV0dXJuICItIiArIG0udG9Mb3dlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgU3RyaW5nKHZhbHVlKSA9PSAiIjsKICAgIH0sCiAgICBpc05vdEVtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiBTdHJpbmcodmFsdWUpICE9ICIiOwogICAgfQogIH07CiAgaWYgKCJ8fHwiLnNwbGl0KC9cfC8pLmxlbmd0aCArICJ8fHwiLnNwbGl0KC8oXHwpLykubGVuZ3RoICE9IDExKSB7CiAgICB2YXIgbmF0aXZlU3RyaW5nU3BsaXQgPSBTdHJpbmcucHJvdG90eXBlLnNwbGl0OwogICAgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCA9IGZ1bmN0aW9uKHBhdHRlcm4sIGNvdW50KSB7CiAgICAgIGlmICghcGF0dGVybiB8fCBwYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwID09IGZhbHNlIHx8IHBhdHRlcm4uc291cmNlID09ICIiKSByZXR1cm4gbmF0aXZlU3RyaW5nU3BsaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG1hdGNoOwogICAgICBpZiAoIXBhdHRlcm4uZ2xvYmFsKSBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnNvdXJjZSwgL1wvKFttaV0qKSQvLmV4ZWMocGF0dGVybilbMV0gKyAiZyIpOwogICAgICB3aGlsZSAobWF0Y2ggPSBwYXR0ZXJuLmV4ZWModGhpcykpIHsKICAgICAgICBtYXRjaFswXSA9IHRoaXMuc3Vic3RyaW5nKHBvcywgbWF0Y2guaW5kZXgpOwogICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgbWF0Y2gpOwogICAgICAgIHBvcyA9IHBhdHRlcm4ubGFzdEluZGV4OwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3Vic3RyKHBvcykpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgaWYgKCIxMiIuc3Vic3RyKC0xKSAhPSAiMiIpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTdWJzdHIgPSBTdHJpbmcucHJvdG90eXBlLnN1YnN0cjsKICAgIFN0cmluZy5wcm90b3R5cGUuc3Vic3RyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbmF0aXZlU3RyaW5nU3Vic3RyLmNhbGwodGhpcywgc3RhcnQgPCAwID8gTWF0aC5tYXgoMCwgdGhpcy5sZW5ndGggKyBzdGFydCkgOiBzdGFydCwgZW5kKTsKICAgIH07CiAgfQogIHZhciBudW1iZXJGdW5jdGlvbnMgPSB7CiAgICBmaXQ6IGZ1bmN0aW9uKHRoaXNfLCBtaW4sIG1heCkgewogICAgICBpZiAoIWlzTmFOKG1pbikgJiYgdGhpc18gPCBtaW4pIHJldHVybiBOdW1iZXIobWluKTsKICAgICAgaWYgKCFpc05hTihtYXgpICYmIHRoaXNfID4gbWF4KSByZXR1cm4gTnVtYmVyKG1heCk7CiAgICAgIHJldHVybiB0aGlzXzsKICAgIH0sCiAgICBsZWFkOiBmdW5jdGlvbih0aGlzXywgbGVuLCBsZWFkQ2hhcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gKGxlbiAtPSBudW1iZXIubGVuZ3RoIC0gMSkgPiAxID8gKG5ldyBBcnJheShsZW4pKS5qb2luKGxlYWRDaGFyIHx8IDApICsgbnVtYmVyIDogbnVtYmVyOwogICAgICB9KTsKICAgIH0sCiAgICBncm91cDogZnVuY3Rpb24odGhpc18sIGxlbiwgc3BsaXR0ZXIpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzXykucmVwbGFjZSgvXGQrLywgZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIG51bWJlci5yZXBsYWNlKC9cZC9nLCBmdW5jdGlvbihtLCBwb3MpIHsKICAgICAgICAgIHJldHVybiAhcG9zICsgKG51bWJlci5sZW5ndGggLSBwb3MpICUgKGxlbiB8fCAzKSA/IG0gOiAoc3BsaXR0ZXIgfHwgIiAiKSArIG07CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIGZvcm1hdDogZnVuY3Rpb24odGhpc18sIHByZWMsIGdzLCBwcmVmaXgsIHBvc3RmaXgsIGNvbW1hKSB7CiAgICAgIHZhciByZXMgPSB0aGlzXy50b0ZpeGVkKHByZWMpOwogICAgICBpZiAoZ3MgfHwgY29tbWEpIHJlcyA9IHJlcy5yZXBsYWNlKC8oXGQrKShcLj8pLywgZnVuY3Rpb24obSwgbnVtYmVyLCBjKSB7CiAgICAgICAgcmV0dXJuIChncyA/IGJhc2lzLm51bWJlci5ncm91cChOdW1iZXIobnVtYmVyKSwgMywgZ3MpIDogbnVtYmVyKSArIChjID8gY29tbWEgfHwgYyA6ICIiKTsKICAgICAgfSk7CiAgICAgIGlmIChwcmVmaXgpIHJlcyA9IHJlcy5yZXBsYWNlKC9eLT8vLCAiJCYiICsgKHByZWZpeCB8fCAiIikpOwogICAgICByZXR1cm4gcmVzICsgKHBvc3RmaXggfHwgIiIpOwogICAgfQogIH07CiAgY29tcGxldGUoRGF0ZSwgewogICAgbm93OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIE51bWJlcihuZXcgRGF0ZSk7CiAgICB9CiAgfSk7CiAgdmFyIHJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBpc1JlYWR5KCkgewogICAgICByZXR1cm4gZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiICYmICEhZG9jdW1lbnQuYm9keTsKICAgIH0KICAgIHZhciBmaXJlZCA9ICFkb2N1bWVudCB8fCBpc1JlYWR5KCk7CiAgICB2YXIgZGVmZXJyZWRIYW5kbGVyOwogICAgZnVuY3Rpb24gcnVuUmVhZHlIYW5kbGVyKGhhbmRsZXIpIHsKICAgICAgaGFuZGxlci5jYWxsYmFjay5jYWxsKGhhbmRsZXIuY29udGV4dCk7CiAgICB9CiAgICBmdW5jdGlvbiBmaXJlSGFuZGxlcnMoKSB7CiAgICAgIGlmIChpc1JlYWR5KCkpIGlmICghKGZpcmVkKyspKSB3aGlsZSAoZGVmZXJyZWRIYW5kbGVyKSB7CiAgICAgICAgcnVuUmVhZHlIYW5kbGVyKGRlZmVycmVkSGFuZGxlcik7CiAgICAgICAgZGVmZXJyZWRIYW5kbGVyID0gZGVmZXJyZWRIYW5kbGVyLm5leHQ7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CiAgICAgIHRyeSB7CiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKCJsZWZ0Iik7CiAgICAgICAgZmlyZUhhbmRsZXJzKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBzZXRUaW1lb3V0KGRvU2Nyb2xsQ2hlY2ssIDEpOwogICAgICB9CiAgICB9CiAgICBpZiAoIWZpcmVkKSB7CiAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZpcmVIYW5kbGVycywgZmFsc2UpOwogICAgICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBmaXJlSGFuZGxlcnMpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIWdsb2JhbC5mcmFtZUVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKSBkb1Njcm9sbENoZWNrKCk7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZmlyZWQpIHsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgbmV4dDogZGVmZXJyZWRIYW5kbGVyCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHJ1blJlYWR5SGFuZGxlcih7CiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9OwogIH0oKTsKICB2YXIgZG9jdW1lbnRJbnRlcmZhY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0aW1lcjsKICAgIHZhciByZWZlcmVuY2UgPSB7fTsKICAgIHZhciBjYWxsYmFja3MgPSB7CiAgICAgIGhlYWQ6IFtdLAogICAgICBib2R5OiBbXQogICAgfTsKICAgIGZ1bmN0aW9uIGdldFBhcmVudChuYW1lKSB7CiAgICAgIGlmIChkb2N1bWVudCAmJiAhcmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgcmVmZXJlbmNlW25hbWVdID0gZG9jdW1lbnRbbmFtZV0gfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSlbMF07CiAgICAgICAgaWYgKHJlZmVyZW5jZVtuYW1lXSkgewogICAgICAgICAgdmFyIGl0ZW1zID0gY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZGVsZXRlIGNhbGxiYWNrc1tuYW1lXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjYjsgY2IgPSBpdGVtc1tpXTsgaSsrKSBjYlswXS5jYWxsKGNiWzFdLCByZWZlcmVuY2VbbmFtZV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVmZXJlbmNlW25hbWVdOwogICAgfQogICAgZnVuY3Rpb24gYWRkKCkgewogICAgICB2YXIgbmFtZSA9IHRoaXNbMF07CiAgICAgIHZhciBub2RlID0gdGhpc1sxXTsKICAgICAgdmFyIHJlZiA9IHRoaXNbMl07CiAgICAgIHJlbW92ZShub2RlKTsKICAgICAgdmFyIHBhcmVudCA9IGdldFBhcmVudChuYW1lKTsKICAgICAgaWYgKHBhcmVudCkgewogICAgICAgIGlmIChyZWYgPT09IHRydWUpIHJlZiA9IHBhcmVudC5maXJzdENoaWxkOwogICAgICAgIGlmICghcmVmIHx8IHJlZi5wYXJlbnROb2RlICE9PSBwYXJlbnQpIHJlZiA9IG51bGw7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCByZWYpOwogICAgICB9IGVsc2UgY2FsbGJhY2tzW25hbWVdLnB1c2goWyBhZGQsIFsgbmFtZSwgbm9kZSwgcmVmIF0gXSk7CiAgICB9CiAgICBmdW5jdGlvbiBkb2NSZWFkeShuYW1lLCBmbiwgY29udGV4dCkgewogICAgICBpZiAoY2FsbGJhY2tzW25hbWVdKSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGZuLCBjb250ZXh0IF0pOyBlbHNlIGZuLmNhbGwoY29udGV4dCwgcmVmZXJlbmNlW25hbWVdKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZShub2RlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBjYWxsYmFja3MpIHsKICAgICAgICB2YXIgZW50cnkgPSBhcnJheUZ1bmN0aW9ucy5zZWFyY2goY2FsbGJhY2tzW2tleV0sIG5vZGUsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiBpdGVtWzFdICYmIGl0ZW1bMV1bMV07CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGVudHJ5KSBhcnJheUZ1bmN0aW9ucy5yZW1vdmUoY2FsbGJhY2tzW2tleV0sIGVudHJ5KTsKICAgICAgfQogICAgICBpZiAobm9kZSAmJiBub2RlLnBhcmVudE5vZGUgJiYgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoZWNrUGFyZW50cygpIHsKICAgICAgaWYgKHRpbWVyICYmIGdldFBhcmVudCgiaGVhZCIpICYmIGdldFBhcmVudCgiYm9keSIpKSB0aW1lciA9IGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgaWYgKGRvY3VtZW50ICYmICghZ2V0UGFyZW50KCJoZWFkIikgfHwgIWdldFBhcmVudCgiYm9keSIpKSkgewogICAgICB0aW1lciA9IHNldEludGVydmFsKGNoZWNrUGFyZW50cywgNSk7CiAgICAgIHJlYWR5KGNoZWNrUGFyZW50cyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBoZWFkOiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiaGVhZCIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJoZWFkIiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYm9keTogewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgZG9jUmVhZHkoImJvZHkiLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZikgewogICAgICAgICAgYWRkLmNhbGwoWyAiYm9keSIsIG5vZGUsIHJlZiBdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogcmVtb3ZlCiAgICB9OwogIH0oKTsKICB2YXIgY2xlYW5lciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG9iamVjdHMgPSBbXTsKICAgIGZ1bmN0aW9uIGRlc3Ryb3kobG9nKSB7CiAgICAgIHZhciBsb2dEZXN0cm95ID0gbG9nICYmIHR5cGVvZiBsb2cgPT0gImJvb2xlYW4iOwogICAgICByZXN1bHQuZ2xvYmFsRGVzdHJveSA9IHRydWU7CiAgICAgIHJlc3VsdC5hZGQgPSAkdW5kZWY7CiAgICAgIHJlc3VsdC5yZW1vdmUgPSAkdW5kZWY7CiAgICAgIHZhciBvYmplY3Q7CiAgICAgIHdoaWxlIChvYmplY3QgPSBvYmplY3RzLnBvcCgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZGVzdHJveSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobG9nRGVzdHJveSkgY29uc29sZU1ldGhvZHMubG9nKCJkZXN0cm95IiwgIlsiICsgU3RyaW5nKG9iamVjdC5jbGFzc05hbWUpICsgIl0iLCBvYmplY3QpOwogICAgICAgICAgICBvYmplY3QuZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKFN0cmluZyhvYmplY3QpLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIG9iamVjdFtwcm9wXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9iamVjdHMubGVuZ3RoID0gMDsKICAgIH0KICAgIGlmICgiYXR0YWNoRXZlbnQiIGluIGdsb2JhbCkgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlc3Ryb3kpOyBlbHNlIGlmICgiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigidW5sb2FkIiwgZGVzdHJveSwgZmFsc2UpOyBlbHNlIHJldHVybiB7CiAgICAgIGFkZDogJHVuZGVmLAogICAgICByZW1vdmU6ICR1bmRlZgogICAgfTsKICAgIHZhciByZXN1bHQgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCAhPSBudWxsKSBvYmplY3RzLnB1c2gob2JqZWN0KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBhcnJheUZ1bmN0aW9ucy5yZW1vdmUob2JqZWN0cywgb2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIHJlc3VsdC5kZXN0cm95XyA9IGRlc3Ryb3k7CiAgICByZXN1bHQub2JqZWN0c18gPSBvYmplY3RzOwogICAgcmV0dXJuIHJlc3VsdDsKICB9KCk7CiAgdmFyIENzc1Jlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgU1RZTEVfQVBQRU5EX0JVR0dZID0gZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSgpOwogICAgdmFyIGJhc2VFbCA9IGRvY3VtZW50ICYmIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJhc2UiKTsKICAgIGZ1bmN0aW9uIHNldEJhc2UoYmFzZVVSSSkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgYmFzZVVSSSk7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKGJhc2VFbCwgdHJ1ZSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXN0b3JlQmFzZSgpIHsKICAgICAgYmFzZUVsLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGxvY2F0aW9uLmhyZWYpOwogICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoYmFzZUVsKTsKICAgIH0KICAgIGZ1bmN0aW9uIGluamVjdFN0eWxlVG9IZWFkKCkgewogICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CiAgICAgIGlmICghdGhpcy5lbGVtZW50KSB7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICBpZiAoIVNUWUxFX0FQUEVORF9CVUdHWSkgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgic3JjIiwgdGhpcy51cmwpOwogICAgICB9CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKHRoaXMuZWxlbWVudCk7CiAgICAgIHRoaXMuc3luY0Nzc1RleHQoKTsKICAgICAgcmVzdG9yZUJhc2UoKTsKICAgIH0KICAgIHJldHVybiBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogImJhc2lzLkNzc1Jlc291cmNlIiwKICAgICAgaW5Vc2U6IDAsCiAgICAgIHVybDogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBjc3NUZXh0OiB1bmRlZmluZWQsCiAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHRoaXMudXJsID0gdXJsOwogICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGhVdGlscy5kaXJuYW1lKHVybCkgKyAiLyI7CiAgICAgIH0sCiAgICAgIHVwZGF0ZUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgICAgICBpZiAodGhpcy5jc3NUZXh0ICE9IGNzc1RleHQpIHsKICAgICAgICAgIHRoaXMuY3NzVGV4dCA9IGNzc1RleHQ7CiAgICAgICAgICBpZiAodGhpcy5pblVzZSAmJiB0aGlzLmVsZW1lbnQpIHsKICAgICAgICAgICAgc2V0QmFzZSh0aGlzLmJhc2VVUkkpOwogICAgICAgICAgICB0aGlzLnN5bmNDc3NUZXh0KCk7CiAgICAgICAgICAgIHJlc3RvcmVCYXNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBzeW5jQ3NzVGV4dDogU1RZTEVfQVBQRU5EX0JVR0dZID8gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuY3NzVGV4dDsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwogICAgICAgIGNzc1RleHQgKz0gIlxuLyojIHNvdXJjZVVSTD0iICsgcGF0aFV0aWxzLm9yaWdpbiArIHRoaXMudXJsICsgIiAqLyI7CiAgICAgICAgdGhpcy5lbGVtZW50LmZpcnN0Q2hpbGQubm9kZVZhbHVlID0gY3NzVGV4dDsKICAgICAgfSwKICAgICAgc3RhcnRVc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5pblVzZSkgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShpbmplY3RTdHlsZVRvSGVhZCwgdGhpcyk7CiAgICAgICAgdGhpcy5pblVzZSArPSAxOwogICAgICB9LAogICAgICBzdG9wVXNlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5pblVzZSkgewogICAgICAgICAgdGhpcy5pblVzZSAtPSAxOwogICAgICAgICAgaWYgKCF0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHRoaXMuZWxlbWVudCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5lbGVtZW50KSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMuY3NzVGV4dCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogIH0oKTsKICB2YXIgYmFzaXMgPSBnZXROYW1lc3BhY2UoImJhc2lzIikuZXh0ZW5kKHsKICAgIGZpbGVuYW1lXzogYmFzaXNGaWxlbmFtZSwKICAgIHByb2Nlc3NDb25maWc6IHByb2Nlc3NDb25maWcsCiAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgTk9ERV9FTlY6IE5PREVfRU5WLAogICAgY29uZmlnOiBjb25maWcsCiAgICBjcmVhdGVTYW5kYm94OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJhc2lzSW5zdGFuY2UoZ2xvYmFsLCBiYXNpc0ZpbGVuYW1lLCBjb21wbGV0ZSh7CiAgICAgICAgbm9Db25mbGljdDogdHJ1ZQogICAgICB9LCBjb25maWcpKTsKICAgIH0sCiAgICByZXNvbHZlTlNGaWxlbmFtZTogcmVzb2x2ZU5TRmlsZW5hbWUsCiAgICBwYXRjaDogcGF0Y2gsCiAgICBuYW1lc3BhY2U6IGdldE5hbWVzcGFjZSwKICAgIHJlcXVpcmU6IHJlcXVpcmVOYW1lc3BhY2UsCiAgICByZXNvdXJjZTogZ2V0UmVzb3VyY2UsCiAgICBhc3NldDogZnVuY3Rpb24odXJsKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9LAogICAgc2V0SW1tZWRpYXRlOiBzZXRJbW1lZGlhdGUsCiAgICBjbGVhckltbWVkaWF0ZTogY2xlYXJJbW1lZGlhdGUsCiAgICBuZXh0VGljazogZnVuY3Rpb24oKSB7CiAgICAgIHNldEltbWVkaWF0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSwKICAgIENsYXNzOiBDbGFzcywKICAgIFRva2VuOiBUb2tlbiwKICAgIERlZmVycmVkVG9rZW46IERlZmVycmVkVG9rZW4sCiAgICBnZW5VSUQ6IGdlblVJRCwKICAgIGdldHRlcjogZ2V0dGVyLAogICAgcmVhZHk6IHJlYWR5LAogICAgY2xlYW5lcjogY2xlYW5lciwKICAgIGNvbnNvbGU6IGNvbnNvbGVNZXRob2RzLAogICAgcGF0aDogcGF0aFV0aWxzLAogICAgZG9jOiBkb2N1bWVudEludGVyZmFjZSwKICAgIG9iamVjdDogewogICAgICBleHRlbmQ6IGV4dGVuZCwKICAgICAgY29tcGxldGU6IGNvbXBsZXRlLAogICAgICBrZXlzOiBrZXlzLAogICAgICB2YWx1ZXM6IHZhbHVlcywKICAgICAgc2xpY2U6IHNsaWNlLAogICAgICBzcGxpY2U6IHNwbGljZSwKICAgICAgbWVyZ2U6IG1lcmdlLAogICAgICBpdGVyYXRlOiBpdGVyYXRlCiAgICB9LAogICAgZm46IHsKICAgICAgJHVuZGVmaW5lZDogJHVuZGVmaW5lZCwKICAgICAgJGRlZmluZWQ6ICRkZWZpbmVkLAogICAgICAkaXNOdWxsOiAkaXNOdWxsLAogICAgICAkaXNOb3ROdWxsOiAkaXNOb3ROdWxsLAogICAgICAkaXNTYW1lOiAkaXNTYW1lLAogICAgICAkaXNOb3RTYW1lOiAkaXNOb3RTYW1lLAogICAgICAkc2VsZjogJHNlbGYsCiAgICAgICRjb25zdDogJGNvbnN0LAogICAgICAkZmFsc2U6ICRmYWxzZSwKICAgICAgJHRydWU6ICR0cnVlLAogICAgICAkbnVsbDogJG51bGwsCiAgICAgICR1bmRlZjogJHVuZGVmLAogICAgICBnZXR0ZXI6IGdldHRlciwKICAgICAgbnVsbEdldHRlcjogbnVsbEdldHRlciwKICAgICAgd3JhcHBlcjogd3JhcHBlciwKICAgICAgbGF6eUluaXQ6IGxhenlJbml0LAogICAgICBsYXp5SW5pdEFuZFJ1bjogbGF6eUluaXRBbmRSdW4sCiAgICAgIHJ1bk9uY2U6IHJ1bk9uY2UKICAgIH0sCiAgICBhcnJheTogZXh0ZW5kKGFycmF5RnJvbSwgYXJyYXlGdW5jdGlvbnMpLAogICAgc3RyaW5nOiBzdHJpbmdGdW5jdGlvbnMsCiAgICBudW1iZXI6IG51bWJlckZ1bmN0aW9ucywKICAgIGJvb2w6IHsKICAgICAgaW52ZXJ0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICBqc29uOiB7CiAgICAgIHBhcnNlOiB0eXBlb2YgSlNPTiAhPSAidW5kZWZpbmVkIiA/IEpTT04ucGFyc2UgOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyaW5nRnVuY3Rpb25zLnRvT2JqZWN0KHN0ciwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICB9KTsKICBnZXROYW1lc3BhY2UoImJhc2lzLmRldiIpLmV4dGVuZChjb25zb2xlTWV0aG9kcyk7CiAgaWYgKGNvbmZpZy5hdXRvbG9hZCkgY29uZmlnLmF1dG9sb2FkLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgcmVxdWlyZU5hbWVzcGFjZShuYW1lKTsKICB9KTsKICByZXR1cm4gYmFzaXM7Cn0pKHRoaXMpOwp9KS5jYWxsKHRoaXMpOw==",
                "body": "Ly8gcmVzb3VyY2VzICg3KToKLy8gIFtmdW5jdGlvbl0gYmJ0LmpzIC0+IDAuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL3RlbXBsYXRlL2h0bWwuanMgLT4gMS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZG9tL2V2ZW50LmpzIC0+IDIuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2wxMG4uanMgLT4gMy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZXZlbnQuanMgLT4gNC5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdGVtcGxhdGUuanMgLT4gNS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdGVtcGxhdGUvaHRtbGZnZW4uanMgLT4gNi5qcwovLwovLyBmaWxlbGlzdCAoMSk6IAovLyAgIGJidC5qcwooZnVuY3Rpb24oKXsKInVzZSBzdHJpY3QiOwoKdmFyIF9fbmFtZXNwYWNlX21hcF9fID0geyIwLmpzIjoiYmJ0IiwiMS5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWwiLCIyLmpzIjoiYmFzaXMuZG9tLmV2ZW50IiwiMy5qcyI6ImJhc2lzLmwxMG4iLCI0LmpzIjoiYmFzaXMuZXZlbnQiLCI1LmpzIjoiYmFzaXMudGVtcGxhdGUiLCI2LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4ifTsKdmFyIGJidDsKCnZhciBfX3Jlc291cmNlc19fID0gewogICIwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzEuanMiKTsKICAgIHZhciBzcmNNYXAgPSBbXTsKICAgIHZhciB0bXBsTWFwID0gW107CiAgICBmdW5jdGlvbiB0ZW1wbGF0ZVdyYXBwZXIoc3JjKSB7CiAgICAgIHZhciBpbmRleCA9IHNyY01hcC5pbmRleE9mKHNyYyk7CiAgICAgIGlmIChpbmRleCAhPSAtMSkgcmV0dXJuIHRtcGxNYXBbaW5kZXhdOwogICAgICB2YXIgdGVtcGxhdGUgPSBuZXcgYmFzaXMudGVtcGxhdGUuaHRtbC5UZW1wbGF0ZShzcmMpOwogICAgICBzcmNNYXAucHVzaChzcmMpOwogICAgICB0bXBsTWFwLnB1c2godGVtcGxhdGUpOwogICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9CiAgICB2YXIgYmFja2JvbmVUZW1wbGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBhY3Rpb25Qcm94eShhY3Rpb25OYW1lLCBldmVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpc1thY3Rpb25OYW1lXSA9PSAiZnVuY3Rpb24iKSB0aGlzW2FjdGlvbk5hbWVdKGV2ZW50KTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1cGRhdGVCaW5kKGJpbmROYW1lKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSB0aGlzLmJpbmRpbmcgJiYgdGhpcy5iaW5kaW5nW2JpbmROYW1lXTsKICAgICAgICB2YXIgZ2V0dGVyID0gYmluZGluZyAmJiBiaW5kaW5nLmdldHRlcjsKICAgICAgICBpZiAoZ2V0dGVyICYmIHRoaXMudG1wbCkgdGhpcy50bXBsLnNldChiaW5kTmFtZSwgZ2V0dGVyKHRoaXMpKTsKICAgICAgfQogICAgICB2YXIgZ19iaW5kaW5ncyA9IHt9OwogICAgICB2YXIgZ19zZWVkID0gMTsKICAgICAgdmFyIEJJTkRJTkdfVEVNUExBVEVfSU5URVJGQUNFID0gewogICAgICAgIGF0dGFjaDogZnVuY3Rpb24ob2JqZWN0LCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICBmb3IgKHZhciBldmVudCBpbiBoYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IGV2ZW50LnNwbGl0KCI6Iik7CiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBvYmplY3RbcGFydHNbMF1dLm9uKHBhcnRzWzFdLCBoYW5kbGVyW2V2ZW50XS5iaW5kKGNvbnRleHQsIG9iamVjdCkpOyBlbHNlIG9iamVjdC5vbihldmVudCwgaGFuZGxlcltldmVudF0sIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGV2ZW50IGluIGhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIHBhcnRzID0gZXZlbnQuc3BsaXQoIjoiKTsKICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIG9iamVjdFtwYXJ0c1swXV0ub2ZmKHBhcnRzWzFdLCBoYW5kbGVyW2V2ZW50XSwgY29udGV4dCk7IGVsc2Ugb2JqZWN0Lm9mZihldmVudCwgaGFuZGxlcltldmVudF0sIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciB0bXBsID0gdGVtcGxhdGVXcmFwcGVyKHNvdXJjZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGJpbmRpbmc7CiAgICAgICAgICBpZiAodGhpcy5iaW5kaW5nKSB7CiAgICAgICAgICAgIGJpbmRpbmcgPSBnX2JpbmRpbmdzW3RoaXMuYmluZGluZy5pZF9dOwogICAgICAgICAgICBpZiAoIWJpbmRpbmcpIHsKICAgICAgICAgICAgICBpZiAoIXRoaXMuYmluZGluZy5pZF8pIHRoaXMuYmluZGluZy5pZF8gPSBnX3NlZWQrKzsKICAgICAgICAgICAgICBiaW5kaW5nID0gZ19iaW5kaW5nc1t0aGlzLmJpbmRpbmcuaWRfXSA9IHsKICAgICAgICAgICAgICAgIGJpbmRpbmdJZDogdGhpcy5iaW5kaW5nLmlkXwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYmluZGluZykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmluZGluZ1trZXldKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5iaW5kaW5nW2tleV0gPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IHRoaXMuYmluZGluZ1trZXldLm1hdGNoKC9ebW9kZWw6KC4qKSQvKTsKICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgYmluZGluZ1trZXldID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiAibW9kZWw6Y2hhbmdlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3Lm1vZGVsLmdldChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIH0obVsxXSB8fCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nW2tleV0gPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3W2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgfShrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuYmluZGluZ1trZXldID09ICJzdHJpbmciIHx8IHR5cGVvZiB0aGlzLmJpbmRpbmdba2V5XSA9PSAib2JqZWN0IikgYmluZGluZ1trZXldID0gdGhpcy5iaW5kaW5nW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudG1wbCA9IHRtcGwuY3JlYXRlSW5zdGFuY2UodGhpcywgYWN0aW9uUHJveHksIG51bGwsIGJpbmRpbmcsIEJJTkRJTkdfVEVNUExBVEVfSU5URVJGQUNFKTsKICAgICAgICAgIHRoaXMudXBkYXRlQmluZCA9IHVwZGF0ZUJpbmQ7CiAgICAgICAgICByZXR1cm4gdGhpcy50bXBsLmVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIGdsb2JhbFsiYmJ0Il0gPSBtb2R1bGUuZXhwb3J0cyA9IGJhc2lzLm9iamVjdC5leHRlbmQoYmFja2JvbmVUZW1wbGF0ZSwgewogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXM7CiAgICAgICAgaWYgKGNvbmZpZy5ub0NvbmZsaWN0KSB7CiAgICAgICAgICBkZWxldGUgd2luZG93LmJ0OwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9LAogICAgICB0ZW1wbGF0ZTogYmFja2JvbmVUZW1wbGF0ZQogICAgfSk7CiAgfSwKICAiMS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi82LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIGRvbUV2ZW50ID0gYmFzaXMuZG9tLmV2ZW50OwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgY2FtZWxpemUgPSBiYXNpcy5zdHJpbmcuY2FtZWxpemU7CiAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbjsKICAgIHZhciBnZXRGdW5jdGlvbnMgPSBiYXNpcy50ZW1wbGF0ZS5odG1sZmdlbi5nZXRGdW5jdGlvbnM7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaENvbmZpZzsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGVTd2l0Y2hlcjsKICAgIHZhciBUZW1wbGF0ZSA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlOwogICAgdmFyIFRZUEVfRUxFTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfRUxFTUVOVDsKICAgIHZhciBUWVBFX0FUVFJJQlVURSA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQVRUUklCVVRFOwogICAgdmFyIFRZUEVfVEVYVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfVEVYVDsKICAgIHZhciBUWVBFX0NPTU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0NPTU1FTlQ7CiAgICB2YXIgVE9LRU5fVFlQRSA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1RZUEU7CiAgICB2YXIgVE9LRU5fQklORElOR1MgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9CSU5ESU5HUzsKICAgIHZhciBUT0tFTl9SRUZTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fUkVGUzsKICAgIHZhciBBVFRSX05BTUUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX05BTUU7CiAgICB2YXIgQVRUUl9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfVkFMVUU7CiAgICB2YXIgQVRUUl9OQU1FX0JZX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX05BTUVfQllfVFlQRTsKICAgIHZhciBFTEVNRU5UX05BTUUgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX05BTUU7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgZXZlbnRBdHRyID0gL15ldmVudC0oLispKy87CiAgICB2YXIgYmFzaXNUZW1wbGF0ZUlkTWFya2VyID0gImJhc2lzVGVtcGxhdGVJZF8iICsgYmFzaXMuZ2VuVUlEKCk7CiAgICB2YXIgdG1wbEV2ZW50TGlzdGVuZXJzID0ge307CiAgICB2YXIgdGVtcGxhdGVzID0ge307CiAgICB2YXIgbmFtZXNwYWNlVVJJID0gewogICAgICBzdmc6ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgIH07CiAgICB2YXIgYWZ0ZXJFdmVudEFjdGlvbiA9IHt9OwogICAgdmFyIGluc2lkZUVsZW1lbnRFdmVudCA9IHt9OwogICAgdmFyIE1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgPSAib25tb3VzZWVudGVyIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB2YXIgQ0FQVFVSRV9GQUxMQkFDSyA9ICFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICYmICJfX2Jhc2lzVGVtcGxhdGUiICsgcGFyc2VJbnQoMWU5ICogTWF0aC5yYW5kb20oKSk7CiAgICBpZiAoQ0FQVFVSRV9GQUxMQkFDSykgZ2xvYmFsW0NBUFRVUkVfRkFMTEJBQ0tdID0gZnVuY3Rpb24oZXZlbnROYW1lLCBldmVudCkgewogICAgICBkb21FdmVudC5maXJlRXZlbnQoZG9jdW1lbnQsIGV2ZW50TmFtZSk7CiAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gdHJ1ZTsKICAgICAgdmFyIGxpc3RlbmVyID0gdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV07CiAgICAgIGlmIChsaXN0ZW5lcikgbGlzdGVuZXIobmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KSk7CiAgICB9OwogICAgdmFyIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiYSIpKTsKICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiYSIpKTsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpLmNoaWxkTm9kZXMubGVuZ3RoID09IDE7CiAgICB9KCk7CiAgICB2YXIgU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgImEiKTsKICAgICAgcmV0dXJuICFlbGVtZW50LmNsYXNzTmFtZTsKICAgIH0oKTsKICAgIHZhciBTRVRfU1RZTEVfQVRUUklCVVRFX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgic3R5bGUiLCAicG9zaXRpb246YWJzb2x1dGUiKTsKICAgICAgcmV0dXJuIGVsZW1lbnQuc3R5bGUucG9zaXRpb24gIT0gImFic29sdXRlIjsKICAgIH0oKTsKICAgIHZhciBJU19TRVRfU1RZTEVfU0FGRSA9ICEhZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5jb2xvciA9ICJ4IjsKICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0oKTsKICAgIGlmICh0eXBlb2YgTm9kZSAhPSAidW5kZWZpbmVkIiAmJiAhTm9kZS5wcm90b3R5cGUuY29udGFpbnMpIE5vZGUucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuICEhKHRoaXMuY29tcGFyZURvY3VtZW50UG9zaXRpb24oY2hpbGQpICYgMTYpOwogICAgfTsKICAgIHZhciBsMTBuVGVtcGxhdGVzID0ge307CiAgICBmdW5jdGlvbiBnZXRMMTBuVGVtcGxhdGUodG9rZW4pIHsKICAgICAgdmFyIHRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuZ2V0TDEwblRlbXBsYXRlKHRva2VuKTsKICAgICAgdmFyIGlkID0gdGVtcGxhdGUudGVtcGxhdGVJZDsKICAgICAgdmFyIGh0bWxUZW1wbGF0ZSA9IGwxMG5UZW1wbGF0ZXNbaWRdOwogICAgICBpZiAoIWh0bWxUZW1wbGF0ZSkgaHRtbFRlbXBsYXRlID0gbDEwblRlbXBsYXRlc1tpZF0gPSBuZXcgSHRtbFRlbXBsYXRlKHRlbXBsYXRlLnNvdXJjZSk7CiAgICAgIHJldHVybiBodG1sVGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoYXR0ck5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT0gImNsaWNrIiAmJiBldmVudC53aGljaCA9PSAzKSByZXR1cm47CiAgICAgICAgdmFyIGJ1YmJsZSA9IGluc2lkZUVsZW1lbnRFdmVudFtldmVudC50eXBlXSB8fCBldmVudC50eXBlICE9ICJtb3VzZWVudGVyIiAmJiBldmVudC50eXBlICE9ICJtb3VzZWxlYXZlIjsKICAgICAgICB2YXIgYXR0ckN1cnNvciA9IGV2ZW50LnNlbmRlcjsKICAgICAgICB2YXIgYXR0cjsKICAgICAgICB3aGlsZSAoYXR0ckN1cnNvcikgewogICAgICAgICAgYXR0ciA9IGF0dHJDdXJzb3IuZ2V0QXR0cmlidXRlICYmIGF0dHJDdXJzb3IuZ2V0QXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgIGlmICghYnViYmxlIHx8IHR5cGVvZiBhdHRyID09ICJzdHJpbmciKSBicmVhazsKICAgICAgICAgIGF0dHJDdXJzb3IgPSBhdHRyQ3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYXR0ciA9PSAic3RyaW5nIikgewogICAgICAgICAgdmFyIGN1cnNvciA9IGF0dHJDdXJzb3I7CiAgICAgICAgICB2YXIgYWN0aW9uVGFyZ2V0ID0gY3Vyc29yOwogICAgICAgICAgdmFyIHJlZklkOwogICAgICAgICAgdmFyIHRtcGxSZWY7CiAgICAgICAgICBpZiAoaW5zaWRlRWxlbWVudEV2ZW50W2V2ZW50LnR5cGVdKSB7CiAgICAgICAgICAgIHZhciByZWxUYXJnZXQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICBpZiAocmVsVGFyZ2V0ICYmIChjdXJzb3IgPT09IHJlbFRhcmdldCB8fCBjdXJzb3IuY29udGFpbnMocmVsVGFyZ2V0KSkpIGN1cnNvciA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICAgIHJlZklkID0gY3Vyc29yW2Jhc2lzVGVtcGxhdGVJZE1hcmtlcl07CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmSWQgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodG1wbFJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bXBsUmVmICYmIHRtcGxSZWYuYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gYXR0ci50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICBldmVudC5hY3Rpb25UYXJnZXQgPSBhY3Rpb25UYXJnZXQ7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb25OYW1lOyBhY3Rpb25OYW1lID0gYWN0aW9uc1tpKytdOyApIHN3aXRjaCAoYWN0aW9uTmFtZSkgewogICAgICAgICAgICAgIGNhc2UgInByZXZlbnQtZGVmYXVsdCI6CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic3RvcC1wcm9wYWdhdGlvbiI6CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0bXBsUmVmLmFjdGlvbi5jYWxsKHRtcGxSZWYuY29udGV4dCwgYWN0aW9uTmFtZSwgZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudC50eXBlIGluIGFmdGVyRXZlbnRBY3Rpb24pIGFmdGVyRXZlbnRBY3Rpb25bZXZlbnQudHlwZV0oZXZlbnQsIGF0dHJDdXJzb3IpOwogICAgICB9OwogICAgfQogICAgdmFyIGJ1aWxkSHRtbCA9IGZ1bmN0aW9uKHRva2VucywgcGFyZW50KSB7CiAgICAgIGZ1bmN0aW9uIGVtdWxhdGVFdmVudChvcmlnRXZlbnROYW1lLCBlbXVsRXZlbnROYW1lKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGVtdWxFdmVudE5hbWUpOwogICAgICAgIGluc2lkZUVsZW1lbnRFdmVudFtvcmlnRXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgYWZ0ZXJFdmVudEFjdGlvbltlbXVsRXZlbnROYW1lXSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICBldmVudC50eXBlID0gb3JpZ0V2ZW50TmFtZTsKICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgfTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW29yaWdFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQsIGN1cnNvcikgewogICAgICAgICAgY3Vyc29yID0gY3Vyc29yICYmIGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKGN1cnNvcikgewogICAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgICBldmVudC5zZW5kZXIgPSBjdXJzb3I7CiAgICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKSB7CiAgICAgICAgaWYgKCF0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSkgewogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBjcmVhdGVFdmVudEhhbmRsZXIoImV2ZW50LSIgKyBldmVudE5hbWUpOwogICAgICAgICAgaWYgKCFDQVBUVVJFX0ZBTExCQUNLKSB7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlZW50ZXIiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3ZlciIpOwogICAgICAgICAgICBpZiAoIU1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgJiYgZXZlbnROYW1lID09ICJtb3VzZWxlYXZlIikgcmV0dXJuIGVtdWxhdGVFdmVudChldmVudE5hbWUsICJtb3VzZW91dCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmFtZXMgPSBkb21FdmVudC5icm93c2VyRXZlbnRzKGV2ZW50TmFtZSksIGJyb3dzZXJFdmVudE5hbWU7IGJyb3dzZXJFdmVudE5hbWUgPSBuYW1lc1tpXTsgaSsrKSBkb21FdmVudC5hZGRHbG9iYWxIYW5kbGVyKGJyb3dzZXJFdmVudE5hbWUsIHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhY3Rpb25zKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSk7CiAgICAgICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIHJlc3VsdC5zZXRBdHRyaWJ1dGUoIm9uIiArIGV2ZW50TmFtZSwgQ0FQVFVSRV9GQUxMQkFDSyArICcoIicgKyBldmVudE5hbWUgKyAnIixldmVudCknKTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKCJldmVudC0iICsgZXZlbnROYW1lLCBhY3Rpb25zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAoU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAiY2xhc3MiKSBuYW1lID0gImNsYXNzTmFtZSI7CiAgICAgICAgaWYgKFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHICYmIG5hbWUgPT0gInN0eWxlIikgcmV0dXJuIHJlc3VsdC5zdHlsZS5jc3NUZXh0ID0gdmFsdWU7CiAgICAgICAgcmVzdWx0LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHBhcmVudCB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGZvciAodmFyIGkgPSBwYXJlbnQgPyA0IDogMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgdmFyIHRhZ05hbWUgPSB0b2tlbltFTEVNRU5UX05BTUVdOwogICAgICAgICAgICB2YXIgcGFydHMgPSB0YWdOYW1lLnNwbGl0KC86Lyk7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gcGFydHMubGVuZ3RoID4gMSA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUklbcGFydHNbMF1dLCB0YWdOYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgICAgICAgICAgIGJ1aWxkSHRtbCh0b2tlbiwgZWxlbWVudCk7CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gdG9rZW5bQVRUUl9WQUxVRV07CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBhdHRyTmFtZS5yZXBsYWNlKC9eZXZlbnQtLywgIiIpOwogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9IGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhdHRyTmFtZSAhPSAiY2xhc3MiICYmIGF0dHJOYW1lICE9ICJzdHlsZSIgPyAhdG9rZW5bVE9LRU5fQklORElOR1NdIDogYXR0clZhbHVlKSBzZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFIC0gMV07CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0sIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZSh0b2tlblsxXSwgdG9rZW5bMl0gfHwgdG9rZW5bMV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0b2tlbltDT01NRU5UX1ZBTFVFXSB8fCAodG9rZW5bVE9LRU5fUkVGU10gPyAieyIgKyB0b2tlbltUT0tFTl9SRUZTXS5qb2luKCJ8IikgKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgaWYgKENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgJiYgaSAmJiB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpKTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRva2VuW1RFWFRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSB8fCAodG9rZW5bVE9LRU5fQklORElOR1NdID8gInsiICsgdG9rZW5bVE9LRU5fQklORElOR1NdICsgIn0iIDogIiIpKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXBhcmVudCAmJiB0b2tlbnMubGVuZ3RoID09IDEpIHJlc3VsdCA9IHJlc3VsdC5maXJzdENoaWxkOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZUJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlSWQgPSByZWZJZCAmIDQwOTU7CiAgICAgIHZhciBvYmplY3QgPSB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0LnRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIGluc3RhbmNlSWQgPSByZWZJZCA+PiAxMjsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QuaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZU9iamVjdEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5jb250ZXh0OwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZVRtcGxCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZVJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpOwogICAgICByZXR1cm4gdGVtcGxhdGVSZWYgJiYgdGVtcGxhdGVSZWYudG1wbDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlYnVnSW5mb0J5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZyAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZygpOwogICAgfQogICAgdmFyIGJ1aWxkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIFdISVRFU1BBQ0UgPSAvXHMrLzsKICAgICAgdmFyIFczQ19ET01fTk9ERV9TVVBQT1JURUQgPSB0eXBlb2YgTm9kZSA9PSAiZnVuY3Rpb24iICYmIGRvY3VtZW50IGluc3RhbmNlb2YgTm9kZTsKICAgICAgdmFyIENMQVNTTElTVF9TVVBQT1JURUQgPSBnbG9iYWwuRE9NVG9rZW5MaXN0ICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QgaW5zdGFuY2VvZiBnbG9iYWwuRE9NVG9rZW5MaXN0OwogICAgICB2YXIgYmluZF9ub2RlID0gVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgTm9kZSA/IG5ld1ZhbHVlIDogZG9tUmVmOwogICAgICAgIGlmIChuZXdOb2RlICE9PSBvbGROb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJvYmplY3QiID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG5ld05vZGUgPSBkb21SZWY7CiAgICAgICAgICAgIGlmIChvbGROb2RlICE9PSBuZXdOb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfZWxlbWVudCA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmICYmIHR5cGVvZiBuZXdWYWx1ZSA9PSAic3RyaW5nIikgZG9tUmVmLmlubmVySFRNTCA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9jb21tZW50ID0gYmluZF9ub2RlOwogICAgICB2YXIgYmluZF90ZXh0Tm9kZSA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmKSBkb21SZWYubm9kZVZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJDbGFzcyA9IENMQVNTTElTVF9TVVBQT1JURUQgPyBmdW5jdGlvbihkb21SZWYsIG9sZENsYXNzLCBuZXdWYWx1ZSwgcHJlZml4LCBhbmltKSB7CiAgICAgICAgdmFyIG5ld0NsYXNzID0gbmV3VmFsdWUgPyBwcmVmaXggKyBuZXdWYWx1ZSA6ICIiOwogICAgICAgIGlmIChuZXdDbGFzcyAhPSBvbGRDbGFzcykgewogICAgICAgICAgaWYgKG9sZENsYXNzKSBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QuYWRkKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gZG9tUmVmLmNsYXNzTmFtZTsKICAgICAgICAgIHZhciBjbGFzc05hbWVJc09iamVjdCA9IHR5cGVvZiBjbGFzc05hbWUgIT0gInN0cmluZyI7CiAgICAgICAgICB2YXIgY2xhc3NMaXN0OwogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBjbGFzc05hbWUgPSBjbGFzc05hbWUuYmFzZVZhbDsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTmFtZS5zcGxpdChXSElURVNQQUNFKTsKICAgICAgICAgIGlmIChvbGRDbGFzcykgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgb2xkQ2xhc3MpOwogICAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICAgIGNsYXNzTGlzdC5wdXNoKG5ld0NsYXNzKTsKICAgICAgICAgICAgaWYgKGFuaW0pIHsKICAgICAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNsYXNzTGlzdCA9IChjbGFzc05hbWVJc09iamVjdCA/IGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA6IGRvbVJlZi5jbGFzc05hbWUpLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgICAgICAgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgbmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICAgIGlmIChjbGFzc05hbWVJc09iamVjdCkgZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsgZWxzZSBkb21SZWYuY2xhc3NOYW1lID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJTdHlsZSA9IElTX1NFVF9TVFlMRV9TQUZFID8gZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgcHJvcGVydHlOYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkb21SZWYuc3R5bGVbY2FtZWxpemUocHJvcGVydHlOYW1lKV0gPSBuZXdWYWx1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ciA9IGZ1bmN0aW9uKGRvbVJlZiwgYXR0ck5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIGlmIChuZXdWYWx1ZSkgZG9tUmVmLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpOyBlbHNlIGRvbVJlZi5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3VmFsdWU7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF0dGFjaCgpIHsKICAgICAgICB0aGlzLnNldCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlc29sdmVWYWx1ZShiaW5kaW5nTmFtZSwgdmFsdWUsIEF0dGFjaGVzKSB7CiAgICAgICAgdmFyIGJyaWRnZSA9IHZhbHVlICYmIHZhbHVlLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgdmFyIG9sZEF0dGFjaCA9IHRoaXMuYXR0YWNoZXMgJiYgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV07CiAgICAgICAgdmFyIHRtcGwgPSBudWxsOwogICAgICAgIGlmIChicmlkZ2UgfHwgb2xkQXR0YWNoKSB7CiAgICAgICAgICBpZiAoYnJpZGdlKSB7CiAgICAgICAgICAgIGlmICghb2xkQXR0YWNoIHx8IHZhbHVlICE9PSBvbGRBdHRhY2gudmFsdWUpIHsKICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoLnRtcGwpIHsKICAgICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PSAibWFya3VwIiAmJiB2YWx1ZSBpbnN0YW5jZW9mIGJhc2lzLmwxMG4uVG9rZW4pIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0ludGVyZmFjZSA9IHRoaXMuYmluZGluZ0ludGVyZmFjZTsKICAgICAgICAgICAgICAgIHRtcGwgPSB0ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZShjb250ZXh0LCBudWxsLCBmdW5jdGlvbiBvblJlYnVpbGQoKSB7CiAgICAgICAgICAgICAgICAgIHRtcGwgPSBuZXdBdHRhY2gudG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUF0dGFjaC5jYWxsKG5ld0F0dGFjaCk7CiAgICAgICAgICAgICAgICB9LCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmF0dGFjaGVzKSB0aGlzLmF0dGFjaGVzID0gbmV3IEF0dGFjaGVzOwogICAgICAgICAgICAgIHZhciBuZXdBdHRhY2ggPSB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGJpbmRpbmdOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgdG1wbDogdG1wbCwKICAgICAgICAgICAgICAgIHNldDogdGhpcy50bXBsLnNldAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYnJpZGdlLmF0dGFjaCh2YWx1ZSwgdXBkYXRlQXR0YWNoLCBuZXdBdHRhY2gpOwogICAgICAgICAgICB9IGVsc2UgdG1wbCA9IHZhbHVlICYmIHZhbHVlLnR5cGUgPT0gIm1hcmt1cCIgPyBvbGRBdHRhY2gudG1wbCA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bXBsKSByZXR1cm4gdG1wbC5lbGVtZW50OwogICAgICAgICAgICB2YWx1ZSA9IGJyaWRnZS5nZXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZEF0dGFjaCkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICBnZXRMMTBuVGVtcGxhdGUob2xkQXR0YWNoLnZhbHVlKS5jbGVhckluc3RhbmNlKG9sZEF0dGFjaC50bXBsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ1VwZGF0ZXIobmFtZXMsIGdldHRlcnMpIHsKICAgICAgICB2YXIgbmFtZTEgPSBuYW1lc1swXTsKICAgICAgICB2YXIgbmFtZTIgPSBuYW1lc1sxXTsKICAgICAgICB2YXIgZ2V0dGVyMSA9IGdldHRlcnNbbmFtZTFdOwogICAgICAgIHZhciBnZXR0ZXIyID0gZ2V0dGVyc1tuYW1lMl07CiAgICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJpbmRpbmdVcGRhdGVyMShvYmplY3QpIHsKICAgICAgICAgICAgICB0aGlzKG5hbWUxLCBnZXR0ZXIxKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIyKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMiwgZ2V0dGVyMihvYmplY3QpKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZhciBnZXR0ZXJzXyA9IG5hbWVzLm1hcChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcnNbbmFtZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXJOKG9iamVjdCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHRoaXMobmFtZXNbaV0sIGdldHRlcnNfW2ldKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGV2ZW50cykgZXZlbnRzW25hbWVdID0gY3JlYXRlQmluZGluZ1VwZGF0ZXIoZXZlbnRzW25hbWVdLCBnZXR0ZXJzKTsKICAgICAgICByZXR1cm4gbmFtZSA/IGV2ZW50cyA6IG51bGw7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ0Z1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgYmluZGluZ0NhY2hlID0ge307CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGdldEJpbmRpbmcoYmluZGluZ3MsIG9iaiwgc2V0LCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICBpZiAoIWJpbmRpbmdzKSByZXR1cm4ge307CiAgICAgICAgICB2YXIgY2FjaGVJZCA9ICJiaW5kaW5nSWQiIGluIGJpbmRpbmdzID8gYmluZGluZ3MuYmluZGluZ0lkIDogbnVsbDsKICAgICAgICAgIGlmICghY2FjaGVJZCkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlLmdldEJpbmRpbmc6IGJpbmRpbmdzIGhhcyBubyBiaW5kaW5nSWQgcHJvcGVydHksIGNhY2hlIGlzIG5vdCB1c2VkIik7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gYmluZGluZ0NhY2hlW2NhY2hlSWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIHZhciBnZXR0ZXJzID0ge307CiAgICAgICAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGJpbmRpbmdOYW1lOyBiaW5kaW5nTmFtZSA9IGtleXNbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgICAgIGlmIChnZXR0ZXIpIHsKICAgICAgICAgICAgICAgIGdldHRlcnNbYmluZGluZ05hbWVdID0gZ2V0dGVyOwogICAgICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kaW5nTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZy5ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TGlzdCA9IFN0cmluZyhiaW5kaW5nLmV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudExpc3Rbal07IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudHNbZXZlbnROYW1lXSkgZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChiaW5kaW5nTmFtZSk7IGVsc2UgZXZlbnRzW2V2ZW50TmFtZV0gPSBbIGJpbmRpbmdOYW1lIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgIG5hbWVzOiBuYW1lcywKICAgICAgICAgICAgICBzeW5jOiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycyksCiAgICAgICAgICAgICAgaGFuZGxlcjogbWFrZUhhbmRsZXIoZXZlbnRzLCBnZXR0ZXJzKQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoY2FjaGVJZCkgYmluZGluZ0NhY2hlW2NhY2hlSWRdID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9iaiAmJiBzZXQpIHJlc3VsdC5zeW5jLmNhbGwoc2V0LCBvYmopOwogICAgICAgICAgaWYgKCFiaW5kaW5nSW50ZXJmYWNlKSByZXR1cm47CiAgICAgICAgICBpZiAocmVzdWx0LmhhbmRsZXIpIGJpbmRpbmdJbnRlcmZhY2UuYXR0YWNoKG9iaiwgcmVzdWx0LmhhbmRsZXIsIHNldCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LmhhbmRsZXI7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgdG9vbHMgPSB7CiAgICAgICAgYmluZF90ZXh0Tm9kZTogYmluZF90ZXh0Tm9kZSwKICAgICAgICBiaW5kX25vZGU6IGJpbmRfbm9kZSwKICAgICAgICBiaW5kX2VsZW1lbnQ6IGJpbmRfZWxlbWVudCwKICAgICAgICBiaW5kX2NvbW1lbnQ6IGJpbmRfY29tbWVudCwKICAgICAgICBiaW5kX2F0dHI6IGJpbmRfYXR0ciwKICAgICAgICBiaW5kX2F0dHJDbGFzczogYmluZF9hdHRyQ2xhc3MsCiAgICAgICAgYmluZF9hdHRyU3R5bGU6IGJpbmRfYXR0clN0eWxlLAogICAgICAgIHJlc29sdmU6IHJlc29sdmVWYWx1ZSwKICAgICAgICBsMTBuVG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICBjcmVhdGVCaW5kaW5nRnVuY3Rpb246IGNyZWF0ZUJpbmRpbmdGdW5jdGlvbgogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zKSB7CiAgICAgICAgdmFyIGZuID0gZ2V0RnVuY3Rpb25zKHRva2VucywgdHJ1ZSwgdGhpcy5zb3VyY2UudXJsLCB0b2tlbnMuc291cmNlXywgIUNMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcsIGJhc2lzVGVtcGxhdGVJZE1hcmtlcik7CiAgICAgICAgdmFyIGNyZWF0ZUluc3RhbmNlOwogICAgICAgIHZhciBpbnN0YW5jZXMgPSB7fTsKICAgICAgICB2YXIgbDEwbk1hcCA9IHt9OwogICAgICAgIHZhciBsMTBuTGlua3MgPSBbXTsKICAgICAgICB2YXIgc2VlZCA9IDA7CiAgICAgICAgdmFyIHByb3RvID0gYnVpbGRIdG1sKHRva2Vucyk7CiAgICAgICAgdmFyIGlkID0gdGhpcy50ZW1wbGF0ZUlkOwogICAgICAgIHRlbXBsYXRlc1tpZF0gPSB7CiAgICAgICAgICB0ZW1wbGF0ZTogdGhpcywKICAgICAgICAgIGluc3RhbmNlczogaW5zdGFuY2VzCiAgICAgICAgfTsKICAgICAgICBpZiAoZm4uY3JlYXRlTDEwblN5bmMpIHsKICAgICAgICAgIHZhciBsMTBuUHJvdG9TeW5jID0gZm4uY3JlYXRlTDEwblN5bmMocHJvdG8sIGwxMG5NYXAsIGJpbmRfYXR0ciwgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBmbi5sMTBuS2V5c1tpXTsgaSsrKSBsMTBuUHJvdG9TeW5jKGtleSwgbDEwblRva2VuKGtleSkudmFsdWUpOwogICAgICAgICAgaWYgKGZuLmwxMG5LZXlzKSBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBmbi5sMTBuS2V5c1tpXTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBsaW5rID0gewogICAgICAgICAgICAgIHBhdGg6IGtleSwKICAgICAgICAgICAgICB0b2tlbjogbDEwblRva2VuKGtleSksCiAgICAgICAgICAgICAgaGFuZGxlcjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGwxMG5Qcm90b1N5bmModGhpcy5wYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2VzKSBpbnN0YW5jZXNba2V5XS50bXBsLnNldCh0aGlzLnBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGxpbmsudG9rZW4uYXR0YWNoKGxpbmsuaGFuZGxlciwgbGluayk7CiAgICAgICAgICAgIGwxMG5MaW5rcy5wdXNoKGxpbmspOwogICAgICAgICAgICBsaW5rID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY3JlYXRlSW5zdGFuY2UgPSBmbi5jcmVhdGVJbnN0YW5jZShpZCwgaW5zdGFuY2VzLCBwcm90bywgdG9vbHMsIGwxMG5NYXAsIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjcmVhdGVJbnN0YW5jZTogZnVuY3Rpb24ob2JqLCBvbkFjdGlvbiwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2VJZCA9IHNlZWQrKzsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY3JlYXRlSW5zdGFuY2UoaW5zdGFuY2VJZCwgb2JqLCBvbkFjdGlvbiwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgIGluc3RhbmNlc1tpbnN0YW5jZUlkXSA9IGluc3RhbmNlOwogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UudG1wbDsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXN0cm95SW5zdGFuY2U6IGZ1bmN0aW9uKHRtcGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlSWQgPSB0bXBsLnRlbXBsYXRlSWRfOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBpbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5oYW5kbGVyKSBpbnN0YW5jZS5iaW5kaW5nSW50ZXJmYWNlLmRldGFjaChpbnN0YW5jZS5jb250ZXh0LCBpbnN0YW5jZS5oYW5kbGVyLCBpbnN0YW5jZS50bXBsLnNldCk7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlLmF0dGFjaGVzKSByZXNvbHZlVmFsdWUuY2FsbChpbnN0YW5jZSwga2V5LCBudWxsKTsKICAgICAgICAgICAgICBkZWxldGUgaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAga2V5czogZm4ua2V5cywKICAgICAgICAgIGluc3RhbmNlc186IGluc3RhbmNlcywKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKHJlYnVpbGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpbms7IGxpbmsgPSBsMTBuTGlua3NbaV07IGkrKykgbGluay50b2tlbi5kZXRhY2gobGluay5oYW5kbGVyLCBsaW5rKTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlcykgewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlc1trZXldOwogICAgICAgICAgICAgIGlmIChyZWJ1aWxkICYmIGluc3RhbmNlLnJlYnVpbGQpIGluc3RhbmNlLnJlYnVpbGQuY2FsbChpbnN0YW5jZS5jb250ZXh0KTsKICAgICAgICAgICAgICBpZiAoIXJlYnVpbGQgfHwga2V5IGluIGluc3RhbmNlcykgewogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhbmRsZXIpIGluc3RhbmNlLmJpbmRpbmdJbnRlcmZhY2UuZGV0YWNoKGluc3RhbmNlLmNvbnRleHQsIGluc3RhbmNlLmhhbmRsZXIsIGluc3RhbmNlLnRtcGwuc2V0KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZS5hdHRhY2hlcykgcmVzb2x2ZVZhbHVlLmNhbGwoa2V5LCBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRlbXBsYXRlc1tpZF0gJiYgdGVtcGxhdGVzW2lkXS5pbnN0YW5jZXMgPT09IGluc3RhbmNlcykgZGVsZXRlIHRlbXBsYXRlc1tpZF07CiAgICAgICAgICAgIGZuID0gbnVsbDsKICAgICAgICAgICAgcHJvdG8gPSBudWxsOwogICAgICAgICAgICBsMTBuTWFwID0gbnVsbDsKICAgICAgICAgICAgbDEwbkxpbmtzID0gbnVsbDsKICAgICAgICAgICAgbDEwblByb3RvU3luYyA9IG51bGw7CiAgICAgICAgICAgIGluc3RhbmNlcyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBIdG1sVGVtcGxhdGUgPSBUZW1wbGF0ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZSIsCiAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSHRtbFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgSHRtbFRlbXBsYXRlU3dpdGNoZXIodmFsdWUpOwogICAgICAgIHJldHVybiBuZXcgSHRtbFRlbXBsYXRlKHZhbHVlKTsKICAgICAgfSwKICAgICAgYnVpbGRlcjogYnVpbGRlcgogICAgfSk7CiAgICB2YXIgSHRtbFRlbXBsYXRlU3dpdGNoZXIgPSBUZW1wbGF0ZVN3aXRjaGVyLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRlbXBsYXRlU3dpdGNoZXIiLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBIdG1sVGVtcGxhdGUKICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIG1hcmtlcjogYmFzaXNUZW1wbGF0ZUlkTWFya2VyLAogICAgICBUZW1wbGF0ZTogSHRtbFRlbXBsYXRlLAogICAgICBUZW1wbGF0ZVN3aXRjaGVyOiBIdG1sVGVtcGxhdGVTd2l0Y2hlcgogICAgfTsKICAgIGJhc2lzLnRlbXBsYXRlLmV4dGVuZCh7CiAgICAgIGdldERlYnVnSW5mb0J5SWQ6IGdldERlYnVnSW5mb0J5SWQsCiAgICAgIGJ1aWxkSHRtbDogYnVpbGRIdG1sLAogICAgICByZXNvbHZlVGVtcGxhdGVCeUlkOiByZXNvbHZlVGVtcGxhdGVCeUlkLAogICAgICByZXNvbHZlT2JqZWN0QnlJZDogcmVzb2x2ZU9iamVjdEJ5SWQsCiAgICAgIHJlc29sdmVUbXBsQnlJZDogcmVzb2x2ZVRtcGxCeUlkCiAgICB9KTsKICB9LAogICIyLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyICRudWxsID0gYmFzaXMuZm4uJG51bGw7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBXM0NTVVBQT1JUID0gISFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyOwogICAgdmFyIEVWRU5UX0hPTERFUiA9ICJfX2Jhc2lzRXZlbnRzIjsKICAgIHZhciBLRVkgPSB7CiAgICAgIEJBQ0tTUEFDRTogOCwKICAgICAgVEFCOiA5LAogICAgICBDVFJMX0VOVEVSOiAxMCwKICAgICAgRU5URVI6IDEzLAogICAgICBTSElGVDogMTYsCiAgICAgIENUUkw6IDE3LAogICAgICBBTFQ6IDE4LAogICAgICBFU0M6IDI3LAogICAgICBFU0NBUEU6IDI3LAogICAgICBTUEFDRTogMzIsCiAgICAgIFBBR0VVUDogMzMsCiAgICAgIFBBR0VET1dOOiAzNCwKICAgICAgRU5EOiAzNSwKICAgICAgSE9NRTogMzYsCiAgICAgIExFRlQ6IDM3LAogICAgICBVUDogMzgsCiAgICAgIFJJR0hUOiAzOSwKICAgICAgRE9XTjogNDAsCiAgICAgIElOU0VSVDogNDUsCiAgICAgIERFTEVURTogNDYsCiAgICAgIEYxOiAxMTIsCiAgICAgIEYyOiAxMTMsCiAgICAgIEYzOiAxMTQsCiAgICAgIEY0OiAxMTUsCiAgICAgIEY1OiAxMTYsCiAgICAgIEY2OiAxMTcsCiAgICAgIEY3OiAxMTgsCiAgICAgIEY4OiAxMTksCiAgICAgIEY5OiAxMjAsCiAgICAgIEYxMDogMTIxLAogICAgICBGMTE6IDEyMiwKICAgICAgRjEyOiAxMjMKICAgIH07CiAgICB2YXIgTU9VU0VfTEVGVCA9IHsKICAgICAgVkFMVUU6IDEsCiAgICAgIEJJVDogMQogICAgfTsKICAgIHZhciBNT1VTRV9NSURETEUgPSB7CiAgICAgIFZBTFVFOiAyLAogICAgICBCSVQ6IDQKICAgIH07CiAgICB2YXIgTU9VU0VfUklHSFQgPSB7CiAgICAgIFZBTFVFOiAzLAogICAgICBCSVQ6IDIKICAgIH07CiAgICB2YXIgQlJPV1NFUl9FVkVOVFMgPSB7CiAgICAgIG1vdXNld2hlZWw6IFsgIm1vdXNld2hlZWwiLCAiRE9NTW91c2VTY3JvbGwiIF0KICAgIH07CiAgICBmdW5jdGlvbiBicm93c2VyRXZlbnRzKGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gQlJPV1NFUl9FVkVOVFNbZXZlbnROYW1lXSB8fCBbIGV2ZW50TmFtZSBdOwogICAgfQogICAgdmFyIEV2ZW50ID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXZlbnQiLAogICAgICBLRVk6IEtFWSwKICAgICAgaW5pdDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnQpIGlmIChuYW1lICE9ICJyZXR1cm5WYWx1ZSIgJiYgbmFtZSAhPSAia2V5TG9jYXRpb24iICYmIG5hbWUgIT0gImxheWVyWCIgJiYgbmFtZSAhPSAibGF5ZXJZIikgaWYgKHR5cGVvZiBldmVudFtuYW1lXSAhPSAiZnVuY3Rpb24iICYmIG5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgdGhpc1tuYW1lXSA9IGV2ZW50W25hbWVdOwogICAgICAgIHZhciB0YXJnZXQgPSBzZW5kZXIoZXZlbnQpOwogICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQodGhpcywgewogICAgICAgICAgZXZlbnRfOiBldmVudCwKICAgICAgICAgIHNlbmRlcjogdGFyZ2V0LAogICAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgICBrZXk6IGtleShldmVudCksCiAgICAgICAgICBjaGFyQ29kZTogY2hhckNvZGUoZXZlbnQpLAogICAgICAgICAgbW91c2VMZWZ0OiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTEVGVCksCiAgICAgICAgICBtb3VzZU1pZGRsZTogbW91c2VCdXR0b24oZXZlbnQsIE1PVVNFX01JRERMRSksCiAgICAgICAgICBtb3VzZVJpZ2h0OiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfUklHSFQpLAogICAgICAgICAgbW91c2VYOiBtb3VzZVgoZXZlbnQpLAogICAgICAgICAgbW91c2VZOiBtb3VzZVkoZXZlbnQpLAogICAgICAgICAgd2hlZWxEZWx0YTogd2hlZWxEZWx0YShldmVudCkKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgc3RvcEJ1YmJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgY2FuY2VsQnViYmxlKHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgY2FuY2VsRGVmYXVsdCh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIGRpZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9wQnViYmxlKCk7CiAgICAgICAgdGhpcy5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHdyYXAoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50IGluc3RhbmNlb2YgRXZlbnQgPyBldmVudC5ldmVudF8gOiBldmVudCB8fCBnbG9iYWwuZXZlbnQ7CiAgICB9CiAgICBmdW5jdGlvbiBnZXROb2RlKHJlZikgewogICAgICByZXR1cm4gdHlwZW9mIHJlZiA9PSAic3RyaW5nIiA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJlZikgOiByZWY7CiAgICB9CiAgICBmdW5jdGlvbiBzZW5kZXIoZXZlbnQpIHsKICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09IDMgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgIH0KICAgIGZ1bmN0aW9uIGNhbmNlbEJ1YmJsZShldmVudCkgewogICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgZWxzZSBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsRGVmYXVsdChldmVudCkgewogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IGVsc2UgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgIH0KICAgIGZ1bmN0aW9uIGtpbGwoZXZlbnQsIG5vZGUpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIGlmIChub2RlKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50LCBraWxsKTsgZWxzZSB7CiAgICAgICAgY2FuY2VsRGVmYXVsdChldmVudCk7CiAgICAgICAgY2FuY2VsQnViYmxlKGV2ZW50KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24ga2V5KGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5rZXlDb2RlIHx8IGV2ZW50LndoaWNoIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBjaGFyQ29kZShldmVudCkgewogICAgICByZXR1cm4gZXZlbnQuY2hhckNvZGUgfHwgZXZlbnQua2V5Q29kZSB8fCAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VCdXR0b24oZXZlbnQsIGJ1dHRvbikgewogICAgICBpZiAodHlwZW9mIGV2ZW50LndoaWNoID09ICJudW1iZXIiKSByZXR1cm4gZXZlbnQud2hpY2ggPT0gYnV0dG9uLlZBTFVFOyBlbHNlIHJldHVybiAhIShldmVudC5idXR0b24gJiBidXR0b24uQklUKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1vdXNlWChldmVudCkgewogICAgICBpZiAoZXZlbnQuY2hhbmdlZFRvdWNoZXMpIHJldHVybiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWDsgZWxzZSBpZiAoInBhZ2VYIiBpbiBldmVudCkgcmV0dXJuIGV2ZW50LnBhZ2VYOyBlbHNlIHJldHVybiAiY2xpZW50WCIgaW4gZXZlbnQgPyBldmVudC5jbGllbnRYICsgKGRvY3VtZW50LmNvbXBhdE1vZGUgPT0gIkNTUzFDb21wYXQiID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgOiBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQpIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIG1vdXNlWShldmVudCkgewogICAgICBpZiAoZXZlbnQuY2hhbmdlZFRvdWNoZXMpIHJldHVybiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWTsgZWxzZSBpZiAoInBhZ2VZIiBpbiBldmVudCkgcmV0dXJuIGV2ZW50LnBhZ2VZOyBlbHNlIHJldHVybiAiY2xpZW50WSIgaW4gZXZlbnQgPyBldmVudC5jbGllbnRZICsgKGRvY3VtZW50LmNvbXBhdE1vZGUgPT0gIkNTUzFDb21wYXQiID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wKSA6IDA7CiAgICB9CiAgICBmdW5jdGlvbiB3aGVlbERlbHRhKGV2ZW50KSB7CiAgICAgIHZhciBkZWx0YSA9IDA7CiAgICAgIGlmICgid2hlZWxEZWx0YSIgaW4gZXZlbnQpIGRlbHRhID0gZXZlbnQud2hlZWxEZWx0YTsgZWxzZSBpZiAoZXZlbnQudHlwZSA9PSAiRE9NTW91c2VTY3JvbGwiKSBkZWx0YSA9IC1ldmVudC5kZXRhaWw7CiAgICAgIHJldHVybiBkZWx0YSAmJiBkZWx0YSAvIE1hdGguYWJzKGRlbHRhKTsKICAgIH0KICAgIHZhciBnbG9iYWxIYW5kbGVycyA9IHt9OwogICAgdmFyIGNhcHR1cmVIYW5kbGVycyA9IHt9OwogICAgdmFyIG5vQ2FwdHVyZVNjaGVtZSA9ICFXM0NTVVBQT1JUOwogICAgZnVuY3Rpb24gb2JzZXJ2ZUdsb2JhbEV2ZW50cyhldmVudCkgewogICAgICB2YXIgaGFuZGxlcnMgPSBhcnJheUZyb20oZ2xvYmFsSGFuZGxlcnNbZXZlbnQudHlwZV0pOwogICAgICB2YXIgY2FwdHVyZUhhbmRsZXIgPSBjYXB0dXJlSGFuZGxlcnNbZXZlbnQudHlwZV07CiAgICAgIHZhciB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwogICAgICBpZiAoY2FwdHVyZUhhbmRsZXIpIHsKICAgICAgICBjYXB0dXJlSGFuZGxlci5oYW5kbGVyLmNhbGwoY2FwdHVyZUhhbmRsZXIudGhpc09iamVjdCwgd3JhcHBlZEV2ZW50KTsKICAgICAgICBraWxsKGV2ZW50KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IGhhbmRsZXJzLmxlbmd0aDsgaS0tID4gMDsgKSB7CiAgICAgICAgICB2YXIgaGFuZGxlck9iamVjdCA9IGhhbmRsZXJzW2ldOwogICAgICAgICAgaGFuZGxlck9iamVjdC5oYW5kbGVyLmNhbGwoaGFuZGxlck9iamVjdC50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gY2FwdHVyZUV2ZW50KGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBpZiAoY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0pIHJlbGVhc2VFdmVudChldmVudFR5cGUpOwogICAgICBhZGRHbG9iYWxIYW5kbGVyKGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCk7CiAgICAgIGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdID0gewogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgdGhpc09iamVjdDogdGhpc09iamVjdAogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSkgewogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoaGFuZGxlck9iamVjdCkgewogICAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyT2JqZWN0LmhhbmRsZXIsIGhhbmRsZXJPYmplY3QudGhpc09iamVjdCk7CiAgICAgICAgZGVsZXRlIGNhcHR1cmVIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRHbG9iYWxIYW5kbGVyKGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICB2YXIgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGhhbmRsZXJzW2ldOyBpKyspIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgYWRkSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXSA9IFtdOwogICAgICB9CiAgICAgIGhhbmRsZXJzLnB1c2goewogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgdGhpc09iamVjdDogdGhpc09iamVjdAogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZUdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgewogICAgICAgICAgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHsKICAgICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICBpZiAoIWhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGRlbGV0ZSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgICAgIGlmIChub0NhcHR1cmVTY2hlbWUpIHJlbW92ZUhhbmRsZXIoZG9jdW1lbnQsIGV2ZW50VHlwZSwgJG51bGwpOyBlbHNlIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBvYnNlcnZlR2xvYmFsRXZlbnRzLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKCFub2RlKSB0aHJvdyAiYmFzaXMuZXZlbnQuYWRkSGFuZGxlcjogY2FuJ3QgYXR0YWNoIGV2ZW50IGxpc3RlbmVyIHRvIHVuZGVmaW5lZCI7CiAgICAgIGlmICh0eXBlb2YgaGFuZGxlciAhPSAiZnVuY3Rpb24iKSB0aHJvdyAiYmFzaXMuZXZlbnQuYWRkSGFuZGxlcjogaGFuZGxlciBpcyBub3QgYSBmdW5jdGlvbiI7CiAgICAgIGlmICghbm9kZVtFVkVOVF9IT0xERVJdKSBub2RlW0VWRU5UX0hPTERFUl0gPSB7fTsKICAgICAgdmFyIGhhbmRsZXJPYmplY3QgPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKCFldmVudFR5cGVIYW5kbGVycykgewogICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXSA9IFsgaGFuZGxlck9iamVjdCBdOwogICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSAmJiBldmVudCAmJiBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnQucmV0dXJuVmFsdWUgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KTsKICAgICAgICAgICAgICBpZiAoZXZlbnQuY2FuY2VsQnViYmxlID09PSB0cnVlKSByZXR1cm47CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgZXZlbnQucmV0dXJuVmFsdWUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgd3JhcHBlZEV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KSwgaXRlbTsgaXRlbSA9IGV2ZW50VHlwZUhhbmRsZXJzW2krK107ICkgaXRlbS5oYW5kbGVyLmNhbGwoaXRlbS50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIH07CiAgICAgICAgaWYgKFczQ1NVUFBPUlQpIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCwgZmFsc2UpOyBlbHNlIG5vZGUuYXR0YWNoRXZlbnQoIm9uIiArIGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGV2ZW50VHlwZUhhbmRsZXJzW2ldOyBpKyspIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSByZXR1cm47CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMucHVzaChoYW5kbGVyT2JqZWN0KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYWRkSGFuZGxlcnMobm9kZSwgaGFuZGxlcnMsIHRoaXNPYmplY3QpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBoYW5kbGVycykgYWRkSGFuZGxlcihub2RlLCBldmVudFR5cGUsIGhhbmRsZXJzW2V2ZW50VHlwZV0sIHRoaXNPYmplY3QpOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlSGFuZGxlcihub2RlLCBldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICBpZiAoZXZlbnRUeXBlSGFuZGxlcnMpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgewogICAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICAgIGV2ZW50VHlwZUhhbmRsZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzLmxlbmd0aCkgY2xlYXJIYW5kbGVycyhub2RlLCBldmVudFR5cGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gY2xlYXJIYW5kbGVycyhub2RlLCBldmVudFR5cGUpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBldmVudFR5cGUgIT0gInN0cmluZyIpIHsKICAgICAgICAgIGZvciAoZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBldmVudFR5cGVIYW5kbGVycyA9IGhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICBpZiAoZXZlbnRUeXBlSGFuZGxlcnMpIHsKICAgICAgICAgICAgaWYgKG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcikgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5kZXRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICAgICAgICBkZWxldGUgaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVFdmVudChub2RlLCBldmVudFR5cGUsIGV2ZW50KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICB2YXIgaGFuZGxlcnMgPSBub2RlW0VWRU5UX0hPTERFUl07CiAgICAgIGlmIChoYW5kbGVycyAmJiBoYW5kbGVyc1tldmVudFR5cGVdKSBoYW5kbGVyc1tldmVudFR5cGVdLmZpcmVFdmVudChldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBvblVubG9hZChoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGFkZEhhbmRsZXIoZ2xvYmFsLCAidW5sb2FkIiwgaGFuZGxlciwgdGhpc09iamVjdCk7CiAgICB9CiAgICB2YXIgdGFnTmFtZUV2ZW50TWFwID0ge307CiAgICBmdW5jdGlvbiBnZXRFdmVudEluZm8oZXZlbnROYW1lLCB0YWdOYW1lKSB7CiAgICAgIGlmICghdGFnTmFtZSkgdGFnTmFtZSA9ICJkaXYiOwogICAgICB2YXIgaWQgPSB0YWdOYW1lICsgIi0iICsgZXZlbnROYW1lOwogICAgICBpZiAodGFnTmFtZUV2ZW50TWFwW2lkXSkgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF07IGVsc2UgewogICAgICAgIHZhciBzdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICB2YXIgYnViYmxlID0gZmFsc2U7CiAgICAgICAgaWYgKCFXM0NTVVBQT1JUKSB7CiAgICAgICAgICB2YXIgb25ldmVudCA9ICJvbiIgKyBldmVudE5hbWU7CiAgICAgICAgICB2YXIgaG9zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgdmFyIHRhcmdldCA9IGhvc3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKSk7CiAgICAgICAgICBob3N0W29uZXZlbnRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGJ1YmJsZSA9IHRydWU7CiAgICAgICAgICB9OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGFyZ2V0LmZpcmVFdmVudChvbmV2ZW50KTsKICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YWdOYW1lRXZlbnRNYXBbaWRdID0gewogICAgICAgICAgc3VwcG9ydGVkOiBzdXBwb3J0ZWQsCiAgICAgICAgICBidWJibGU6IGJ1YmJsZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHdyYXBFdmVudEZ1bmN0aW9uKGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCwgYXJnKSB7CiAgICAgICAgcmV0dXJuIGZuKHdyYXAoZXZlbnQpLCBhcmcpOwogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFczQ1NVUFBPUlQ6IFczQ1NVUFBPUlQsCiAgICAgIGJyb3dzZXJFdmVudHM6IGJyb3dzZXJFdmVudHMsCiAgICAgIGdldEV2ZW50SW5mbzogZ2V0RXZlbnRJbmZvLAogICAgICBLRVk6IEtFWSwKICAgICAgTU9VU0VfTEVGVDogTU9VU0VfTEVGVCwKICAgICAgTU9VU0VfUklHSFQ6IE1PVVNFX1JJR0hULAogICAgICBNT1VTRV9NSURETEU6IE1PVVNFX01JRERMRSwKICAgICAgRXZlbnQ6IEV2ZW50LAogICAgICBzZW5kZXI6IHdyYXBFdmVudEZ1bmN0aW9uKHNlbmRlciksCiAgICAgIGNhbmNlbEJ1YmJsZTogd3JhcEV2ZW50RnVuY3Rpb24oY2FuY2VsQnViYmxlKSwKICAgICAgY2FuY2VsRGVmYXVsdDogd3JhcEV2ZW50RnVuY3Rpb24oY2FuY2VsRGVmYXVsdCksCiAgICAgIGtpbGw6IHdyYXBFdmVudEZ1bmN0aW9uKGtpbGwpLAogICAgICBrZXk6IHdyYXBFdmVudEZ1bmN0aW9uKGtleSksCiAgICAgIGNoYXJDb2RlOiB3cmFwRXZlbnRGdW5jdGlvbihjaGFyQ29kZSksCiAgICAgIG1vdXNlQnV0dG9uOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZUJ1dHRvbiksCiAgICAgIG1vdXNlWDogd3JhcEV2ZW50RnVuY3Rpb24obW91c2VYKSwKICAgICAgbW91c2VZOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVkpLAogICAgICB3aGVlbERlbHRhOiB3cmFwRXZlbnRGdW5jdGlvbih3aGVlbERlbHRhKSwKICAgICAgYWRkR2xvYmFsSGFuZGxlcjogYWRkR2xvYmFsSGFuZGxlciwKICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcjogcmVtb3ZlR2xvYmFsSGFuZGxlciwKICAgICAgY2FwdHVyZUV2ZW50OiBjYXB0dXJlRXZlbnQsCiAgICAgIHJlbGVhc2VFdmVudDogcmVsZWFzZUV2ZW50LAogICAgICBhZGRIYW5kbGVyOiBhZGRIYW5kbGVyLAogICAgICBhZGRIYW5kbGVyczogYWRkSGFuZGxlcnMsCiAgICAgIHJlbW92ZUhhbmRsZXI6IHJlbW92ZUhhbmRsZXIsCiAgICAgIGNsZWFySGFuZGxlcnM6IGNsZWFySGFuZGxlcnMsCiAgICAgIGZpcmVFdmVudDogZmlyZUV2ZW50LAogICAgICBvblVubG9hZDogb25VbmxvYWQsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiMy5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmwxMG4iXSA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICByZXR1cm4gcmVzb2x2ZURpY3Rpb25hcnkodXJsKS51cGRhdGUoYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzb24iXShjb250ZW50LCB1cmwpKTsKICAgIH07CiAgICBmdW5jdGlvbiBvd25LZXlzKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB0b2tlbkluZGV4ID0gW107CiAgICB2YXIgdG9rZW5Db21wdXRlRm4gPSB7fTsKICAgIHZhciB0b2tlbkNvbXB1dGVzID0ge307CiAgICB2YXIgdXBkYXRlVG9rZW4gPSBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0OwogICAgdmFyIENvbXB1dGVUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db21wdXRlVG9rZW4iLAogICAgICBpbml0OiBmdW5jdGlvbih2YWx1ZSwgdG9rZW4pIHsKICAgICAgICB0b2tlbi5jb21wdXRlVG9rZW5zW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy50b2tlbi50eXBlID09ICJwbHVyYWwiID8gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbCh0aGlzLnZhbHVlKSA6IHRoaXMudmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXMudG9rZW4uZGljdGlvbmFyeS5nZXRWYWx1ZSh0aGlzLnRva2VuLm5hbWUgKyAiLiIgKyBrZXkpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY29tcHV0ZVRva2VucykgdGhpcy5jb21wdXRlVG9rZW5zW2tleV0uYXBwbHkoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuYXBwbHkuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbjogVmFsdWUgZm9yIGwxMG4gdG9rZW4gY2FuJ3QgYmUgc2V0IGRpcmVjdGx5LCBidXQgdGhyb3VnaCBkaWN0aW9uYXJ5IHVwZGF0ZSBvbmx5Iik7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyW2Jhc2lzLmdldHRlci5JRF0pLmpvaW4oIl8iKTsKICAgICAgICBpZiAodG9rZW5Db21wdXRlRm5bZW51bUlkXSkgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF07CiAgICAgICAgdmFyIHRva2VuID0gdGhpczsKICAgICAgICB2YXIgb2JqZWN0VG9rZW5NYXAgPSB7fTsKICAgICAgICB2YXIgdXBkYXRlVmFsdWUgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHVwZGF0ZVRva2VuLmNhbGwodGhpcywgZ2V0dGVyKG9iamVjdCkpOwogICAgICAgIH07CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgZGVsZXRlIG9iamVjdFRva2VuTWFwW29iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKGV2ZW50TmFtZSAhPSAiZGVzdHJveSIpIGhhbmRsZXJbZXZlbnROYW1lXSA9IHVwZGF0ZVZhbHVlOwogICAgICAgIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRW1pdHRlciA9PSBmYWxzZSkgdGhyb3cgImJhc2lzLmwxMG4uVG9rZW4jY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBFbWl0dGVyIjsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgIGlmICghY29tcHV0ZVRva2VuKSB7CiAgICAgICAgICAgIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXSA9IG5ldyBDb21wdXRlVG9rZW4oZ2V0dGVyKG9iamVjdCksIHRva2VuKTsKICAgICAgICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoaGFuZGxlciwgY29tcHV0ZVRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlVG9rZW47CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgY29tcHV0ZVRva2VuOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgQ29tcHV0ZVRva2VuKHZhbHVlLCB0aGlzKTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAodGhpcy50eXBlID09ICJwbHVyYWwiKSBuYW1lID0gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbChuYW1lKTsKICAgICAgICBpZiAodGhpcy5kaWN0aW9uYXJ5KSByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5LnRva2VuKHRoaXMubmFtZSArICIuIiArIG5hbWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jb21wdXRlVG9rZW5zKSB0aGlzLmNvbXB1dGVUb2tlbnNba2V5XS5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5jb21wdXRlVG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUb2tlbihwYXRoKSB7CiAgICAgIGlmIChwYXRoLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFtwYXJzZUludChwYXRoLnN1YnN0cigxKSwgMzYpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLm1hdGNoKC9eKC4rPylAKC4rKSQvKTsKICAgICAgICBpZiAocGFydHMpIHJldHVybiByZXNvbHZlRGljdGlvbmFyeShiYXNpcy5wYXRoLnJlc29sdmUocGFydHNbMl0pKS50b2tlbihwYXJ0c1sxXSk7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4udG9rZW4gYWNjZXB0cyB0b2tlbiByZWZlcmVuY2VzIGluIGZvcm1hdCBgdG9rZW4ucGF0aEBwYXRoL3RvL2RpY3QubDEwbmAgb25seSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZGljdGlvbmFyaWVzID0gW107CiAgICB2YXIgZGljdGlvbmFyeUJ5VXJsID0ge307CiAgICB2YXIgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyID0gbmV3IGJhc2lzLlRva2VuOwogICAgZnVuY3Rpb24gd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlbnMsIHBhdGgpIHsKICAgICAgdmFyIGN1bHR1cmVWYWx1ZXMgPSBkaWN0aW9uYXJ5LmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV07CiAgICAgIHBhdGggPSBwYXRoID8gcGF0aCArICIuIiA6ICIiOwogICAgICBmb3IgKHZhciBuYW1lIGluIHRva2VucykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodG9rZW5zLCBuYW1lKSkgewogICAgICAgIHZhciB0b2tlbk5hbWUgPSBwYXRoICsgbmFtZTsKICAgICAgICB2YXIgdG9rZW5WYWx1ZSA9IHRva2Vuc1tuYW1lXTsKICAgICAgICBjdWx0dXJlVmFsdWVzW3Rva2VuTmFtZV0gPSB0b2tlblZhbHVlOwogICAgICAgIGlmICh0b2tlblZhbHVlICYmICh0eXBlb2YgdG9rZW5WYWx1ZSA9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KHRva2VuVmFsdWUpKSkgd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlblZhbHVlLCB0b2tlbk5hbWUpOwogICAgICB9CiAgICB9CiAgICB2YXIgRGljdGlvbmFyeSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRpY3Rpb25hcnkiLAogICAgICB0b2tlbnM6IG51bGwsCiAgICAgIHR5cGVzOiBudWxsLAogICAgICBjdWx0dXJlVmFsdWVzOiBudWxsLAogICAgICBpbmRleDogTmFOLAogICAgICByZXNvdXJjZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29udGVudCkgewogICAgICAgIHRoaXMudG9rZW5zID0ge307CiAgICAgICAgdGhpcy50eXBlcyA9IHt9OwogICAgICAgIHRoaXMuY3VsdHVyZVZhbHVlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXggPSBkaWN0aW9uYXJpZXMucHVzaCh0aGlzKSAtIDE7CiAgICAgICAgaWYgKGJhc2lzLnJlc291cmNlLmlzUmVzb3VyY2UoY29udGVudCkpIHsKICAgICAgICAgIHZhciByZXNvdXJjZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdKSB7CiAgICAgICAgICAgIGRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdID0gdGhpczsKICAgICAgICAgICAgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLnNldChyZXNvdXJjZS51cmwpOwogICAgICAgICAgfQogICAgICAgICAgcmVzb3VyY2UuZmV0Y2goKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVzZSBvYmplY3QgYXMgY29udGVudCBvZiBkaWN0aW9uYXJ5IGlzIGV4cGVyaW1lbnRhbCBhbmQgbm90IHByb2R1Y3Rpb24tcmVhZHkiKTsKICAgICAgICAgIHRoaXMudXBkYXRlKGNvbnRlbnQgfHwge30pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhKSBkYXRhID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgZm9yICh2YXIgY3VsdHVyZSBpbiBkYXRhKSBpZiAoIS9eX3xfJC8udGVzdChjdWx0dXJlKSkgewogICAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzW2N1bHR1cmVdID0ge307CiAgICAgICAgICB3YWxrVG9rZW5zKHRoaXMsIGN1bHR1cmUsIGRhdGFbY3VsdHVyZV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnR5cGVzID0gZGF0YS5fbWV0YSAmJiBkYXRhLl9tZXRhLnR5cGUgfHwge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMudG9rZW5zKSB0aGlzLnRva2Vuc1trZXldLnNldFR5cGUodGhpcy50eXBlc1trZXldKTsKICAgICAgICB0aGlzLnN5bmNWYWx1ZXMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgc3luY1ZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgdG9rZW5OYW1lIGluIHRoaXMudG9rZW5zKSB1cGRhdGVUb2tlbi5jYWxsKHRoaXMudG9rZW5zW3Rva2VuTmFtZV0sIHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICI0LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB7CiAgICAgICAgICAgIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICAgIHNlbmRlcjogdGhpcywKICAgICAgICAgICAgICB0eXBlOiBldmVudE5hbWUsCiAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgIjUuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIHBhdGggPSBiYXNpcy5wYXRoOwogICAgdmFyIGFycmF5U2VhcmNoID0gYmFzaXMuYXJyYXkuc2VhcmNoOwogICAgdmFyIGFycmF5QWRkID0gYmFzaXMuYXJyYXkuYWRkOwogICAgdmFyIGFycmF5UmVtb3ZlID0gYmFzaXMuYXJyYXkucmVtb3ZlOwogICAgdmFyIHRlbXBsYXRlTGlzdCA9IFtdOwogICAgdmFyIHRtcGxGaWxlc01hcCA9IHt9OwogICAgdmFyIERFQ0xBUkFUSU9OX1ZFUlNJT04gPSAyOwogICAgdmFyIFRZUEVfRUxFTUVOVCA9IDE7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSAyOwogICAgdmFyIFRZUEVfQVRUUklCVVRFX0NMQVNTID0gNDsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9TVFlMRSA9IDU7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfRVZFTlQgPSA2OwogICAgdmFyIFRZUEVfVEVYVCA9IDM7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gODsKICAgIHZhciBUT0tFTl9UWVBFID0gMDsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IDE7CiAgICB2YXIgVE9LRU5fUkVGUyA9IDI7CiAgICB2YXIgQVRUUl9OQU1FID0gMzsKICAgIHZhciBBVFRSX1ZBTFVFID0gNDsKICAgIHZhciBBVFRSX0VWRU5UX1JYID0gL15ldmVudC0oLispJC87CiAgICB2YXIgQVRUUl9OQU1FX0JZX1RZUEUgPSB7CiAgICAgIDQ6ICJjbGFzcyIsCiAgICAgIDU6ICJzdHlsZSIKICAgIH07CiAgICB2YXIgQVRUUl9UWVBFX0JZX05BTUUgPSB7CiAgICAgICJjbGFzcyI6IFRZUEVfQVRUUklCVVRFX0NMQVNTLAogICAgICBzdHlsZTogVFlQRV9BVFRSSUJVVEVfU1RZTEUKICAgIH07CiAgICB2YXIgQVRUUl9WQUxVRV9JTkRFWCA9IHsKICAgICAgMjogQVRUUl9WQUxVRSwKICAgICAgNDogQVRUUl9WQUxVRSAtIDEsCiAgICAgIDU6IEFUVFJfVkFMVUUgLSAxLAogICAgICA2OiAyCiAgICB9OwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IDM7CiAgICB2YXIgRUxFTUVOVF9BVFRSUyA9IDQ7CiAgICB2YXIgRUxFTUVOVF9DSElMRFMgPSA1OwogICAgdmFyIFRFWFRfVkFMVUUgPSAzOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSAzOwogICAgdmFyIFNZTlRBWF9FUlJPUiA9ICJJbnZhbGlkIG9yIHVuc3VwcG9ydGVkIHN5bnRheCI7CiAgICB2YXIgVEVYVCA9IC8oKD86LnxbXHJcbl0pKj8pKFx7KD86bDEwbjooW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKD86XC5bYS16QS1aX11bYS16QS1aMC05X1wtXSopKig/OlwuXHtbYS16QS1aX11bYS16QS1aMC05X1wtXSpcfSk/KVx9KT98PChcL3whLS0oXHMqXHspPyk/fCQpL2c7CiAgICB2YXIgVEFHX05BTUUgPSAvKFthLXpfXVthLXowLTlcLV9dKikoOnxce3xccyooXC8/Pik/KS9pZzsKICAgIHZhciBBVFRSSUJVVEVfTkFNRV9PUl9FTkQgPSAvKFthLXpfXVthLXowLTlfXC1dKikoOnxce3w9fFxzKil8KFwvPz4pL2lnOwogICAgdmFyIENPTU1FTlQgPSAvKC58W1xyXG5dKSo/LS0+L2c7CiAgICB2YXIgQ0xPU0VfVEFHID0gLyhbYS16X11bYS16MC05X1wtXSooPzo6W2Etel9dW2EtejAtOV9cLV0qKT8pPi9pZzsKICAgIHZhciBSRUZFUkVOQ0UgPSAvKFthLXpfXVthLXowLTlfXSopKFx8fFx9XHMqKS9pZzsKICAgIHZhciBBVFRSSUJVVEVfVkFMVUUgPSAvIigoPzooXFwiKXxbXiJdKSo/KSJccyovZzsKICAgIHZhciBCUkVBS19UQUdfUEFSU0UgPSAvXi9nOwogICAgdmFyIFNJTkdMRVRPTl9UQUcgPSAvXihhcmVhfGJhc2V8YnJ8Y29sfGNvbW1hbmR8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbXxzb3VyY2UpJC9pOwogICAgdmFyIFRBR19JR05PUkVfQ09OVEVOVCA9IHsKICAgICAgdGV4dDogLygoPzoufFtcclxuXSkqPykoPzo8XC9iOnRleHQ+fCQpL2csCiAgICAgIHN0eWxlOiAvKCg/Oi58W1xyXG5dKSo/KSg/OjxcL2I6c3R5bGU+fCQpL2cKICAgIH07CiAgICB2YXIgcXVvdGVVbmVzY2FwZSA9IC9cXCIvZzsKICAgIHZhciB0b2tlbml6ZSA9IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciB0YWdTdGFjayA9IFtdOwogICAgICB2YXIgbGFzdFRhZyA9IHsKICAgICAgICBjaGlsZHM6IHJlc3VsdAogICAgICB9OwogICAgICB2YXIgc291cmNlVGV4dDsKICAgICAgdmFyIHRva2VuOwogICAgICB2YXIgYnVmZmVyUG9zOwogICAgICB2YXIgc3RhcnRQb3M7CiAgICAgIHZhciBwYXJzZVRhZyA9IGZhbHNlOwogICAgICB2YXIgdGV4dFN0YXRlRW5kUG9zID0gMDsKICAgICAgdmFyIHRleHRFbmRQb3M7CiAgICAgIHZhciBzdGF0ZSA9IFRFWFQ7CiAgICAgIHZhciBwb3MgPSAwOwogICAgICB2YXIgbTsKICAgICAgc291cmNlID0gc291cmNlLnRyaW0oKTsKICAgICAgcmVzdWx0Lndhcm5zID0gW107CiAgICAgIHdoaWxlIChwb3MgPCBzb3VyY2UubGVuZ3RoIHx8IHN0YXRlICE9IFRFWFQpIHsKICAgICAgICBzdGF0ZS5sYXN0SW5kZXggPSBwb3M7CiAgICAgICAgc3RhcnRQb3MgPSBwb3M7CiAgICAgICAgbSA9IHN0YXRlLmV4ZWMoc291cmNlKTsKICAgICAgICBpZiAoIW0gfHwgbS5pbmRleCAhPT0gcG9zKSB7CiAgICAgICAgICBpZiAoc3RhdGUgPT0gUkVGRVJFTkNFICYmIHRva2VuICYmIHRva2VuLnR5cGUgPT0gVFlQRV9DT01NRU5UKSB7CiAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyc2VUYWcpIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgIGlmICh0b2tlbikgbGFzdFRhZy5jaGlsZHMucG9wKCk7CiAgICAgICAgICBpZiAodG9rZW4gPSBsYXN0VGFnLmNoaWxkcy5wb3AoKSkgewogICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX1RFWFQgJiYgIXRva2VuLnJlZnMpIHRleHRTdGF0ZUVuZFBvcyAtPSAibGVuIiBpbiB0b2tlbiA/IHRva2VuLmxlbiA6IHRva2VuLnZhbHVlLmxlbmd0aDsgZWxzZSBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgcG9zID0gc3RhdGUubGFzdEluZGV4OwogICAgICAgIHN3aXRjaCAoc3RhdGUpIHsKICAgICAgICAgIGNhc2UgVEVYVDoKICAgICAgICAgICAgdGV4dEVuZFBvcyA9IHN0YXJ0UG9zICsgbVsxXS5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0ZXh0U3RhdGVFbmRQb3MgIT0gdGV4dEVuZFBvcykgewogICAgICAgICAgICAgIHNvdXJjZVRleHQgPSB0ZXh0U3RhdGVFbmRQb3MgPT0gc3RhcnRQb3MgPyBtWzFdIDogc291cmNlLnN1YnN0cmluZyh0ZXh0U3RhdGVFbmRQb3MsIHRleHRFbmRQb3MpOwogICAgICAgICAgICAgIHRva2VuID0gc291cmNlVGV4dC5yZXBsYWNlKC9ccyooXHJcbj98XG5ccj8pXHMqL2csICIiKTsKICAgICAgICAgICAgICBpZiAodG9rZW4pIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgbGVuOiBzb3VyY2VUZXh0Lmxlbmd0aCwKICAgICAgICAgICAgICAgIHZhbHVlOiB0b2tlbgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRleHRTdGF0ZUVuZFBvcyA9IHRleHRFbmRQb3M7CiAgICAgICAgICAgIGlmIChtWzNdKSB7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICByZWZzOiBbICJsMTBuOiIgKyBtWzNdIF0sCiAgICAgICAgICAgICAgICB2YWx1ZTogIntsMTBuOiIgKyBtWzNdICsgIn0iCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVsyXSA9PSAieyIpIHsKICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3MgLSAxOwogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBzdGF0ZSA9IFJFRkVSRU5DRTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtWzRdKSB7CiAgICAgICAgICAgICAgaWYgKG1bNF0gPT0gIi8iKSB7CiAgICAgICAgICAgICAgICB0b2tlbiA9IG51bGw7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IENMT1NFX1RBRzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9DT01NRU5UCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChtWzVdKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvcyAtIG1bNV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBzdGF0ZSA9IFJFRkVSRU5DRTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvczsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChtWzJdKSB7CiAgICAgICAgICAgICAgcGFyc2VUYWcgPSB0cnVlOwogICAgICAgICAgICAgIHRhZ1N0YWNrLnB1c2gobGFzdFRhZyk7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgIGF0dHJzOiBbXSwKICAgICAgICAgICAgICAgIGNoaWxkczogW10KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBsYXN0VGFnID0gdG9rZW47CiAgICAgICAgICAgICAgc3RhdGUgPSBUQUdfTkFNRTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ0xPU0VfVEFHOgogICAgICAgICAgICBpZiAobVsxXSAhPT0gKGxhc3RUYWcucHJlZml4ID8gbGFzdFRhZy5wcmVmaXggKyAiOiIgOiAiIikgKyBsYXN0VGFnLm5hbWUpIHsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIHZhbHVlOiAiPC8iICsgbVswXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUQUdfTkFNRToKICAgICAgICAgIGNhc2UgQVRUUklCVVRFX05BTUVfT1JfRU5EOgogICAgICAgICAgICBpZiAobVsyXSA9PSAiOiIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4ucHJlZml4KSBzdGF0ZSA9IEJSRUFLX1RBR19QQVJTRTsgZWxzZSB0b2tlbi5wcmVmaXggPSBtWzFdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzFdKSB7CiAgICAgICAgICAgICAgdG9rZW4ubmFtZSA9IG1bMV07CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEUpIGxhc3RUYWcuYXR0cnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMl0gPT0gInsiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9FTEVNRU5UKSBzdGF0ZSA9IFJFRkVSRU5DRTsgZWxzZSBzdGF0ZSA9IEJSRUFLX1RBR19QQVJTRTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVszXSkgewogICAgICAgICAgICAgIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKG1bM10gPT0gIi8+IiB8fCAhbGFzdFRhZy5wcmVmaXggJiYgU0lOR0xFVE9OX1RBRy50ZXN0KGxhc3RUYWcubmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChtWzNdICE9ICIvPiIpIHJlc3VsdC53YXJucy5wdXNoKCJUYWcgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiBkb2Vzbid0IGNsb3NlZCBleHBsaWNpdCAodXNlIGAvPmAgYXMgdGFnIGVuZGluZykiKTsKICAgICAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGxhc3RUYWcucHJlZml4ID09ICJiIiAmJiBsYXN0VGFnLm5hbWUgaW4gVEFHX0lHTk9SRV9DT05URU5UKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gVEFHX0lHTk9SRV9DT05URU5UW2xhc3RUYWcubmFtZV07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMl0gPT0gIj0iKSB7CiAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfVkFMVUU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDT01NRU5UOgogICAgICAgICAgICB0b2tlbi52YWx1ZSA9IHNvdXJjZS5zdWJzdHJpbmcoYnVmZmVyUG9zLCBwb3MgLSAzKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgUkVGRVJFTkNFOgogICAgICAgICAgICBpZiAodG9rZW4ucmVmcykgdG9rZW4ucmVmcy5wdXNoKG1bMV0pOyBlbHNlIHRva2VuLnJlZnMgPSBbIG1bMV0gXTsKICAgICAgICAgICAgaWYgKG1bMl0gIT0gInwiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgICBwb3MgLT0gbVsyXS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBzb3VyY2Uuc3Vic3RyaW5nKGJ1ZmZlclBvcywgcG9zKTsKICAgICAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9DT01NRU5UKSB7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50eXBlID09IFRZUEVfQVRUUklCVVRFICYmIHNvdXJjZVtwb3NdID09ICI9IikgewogICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9WQUxVRTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBBVFRSSUJVVEVfVkFMVUU6CiAgICAgICAgICAgIHRva2VuLnZhbHVlID0gbVsxXS5yZXBsYWNlKHF1b3RlVW5lc2NhcGUsICciJyk7CiAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVEFHX0lHTk9SRV9DT05URU5ULnRleHQ6CiAgICAgICAgICBjYXNlIFRBR19JR05PUkVfQ09OVEVOVC5zdHlsZToKICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgIHZhbHVlOiBtWzFdCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyAiUGFyc2VyIGJ1ZyI7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZSA9PSBURVhUKSB0ZXh0U3RhdGVFbmRQb3MgPSBwb3M7CiAgICAgIH0KICAgICAgaWYgKHRleHRTdGF0ZUVuZFBvcyAhPSBwb3MpIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICB2YWx1ZTogc291cmNlLnN1YnN0cmluZyh0ZXh0U3RhdGVFbmRQb3MsIHBvcykKICAgICAgfSk7CiAgICAgIGlmIChsYXN0VGFnLm5hbWUpIHJlc3VsdC53YXJucy5wdXNoKCJObyBjbG9zZSB0YWcgZm9yIDwiICsgbGFzdFRhZy5uYW1lICsgIj4iKTsKICAgICAgaWYgKCFyZXN1bHQud2FybnMubGVuZ3RoKSBkZWxldGUgcmVzdWx0Lndhcm5zOwogICAgICByZXN1bHQudGVtcGxhdGVUb2tlbnMgPSB0cnVlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIHZhciB0b2tlblRlbXBsYXRlID0ge307CiAgICB2YXIgTDEwblByb3h5VG9rZW4gPSBiYXNpcy5Ub2tlbi5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5MMTBuUHJveHlUb2tlbiIsCiAgICAgIHRva2VuOiBudWxsLAogICAgICB1cmw6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbih0b2tlbikgewogICAgICAgIHRoaXMudXJsID0gdG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwgKyAiOiIgKyB0b2tlbi5uYW1lOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICB0aGlzLnNldCgpOwogICAgICAgIHRva2VuLmF0dGFjaCh0aGlzLnNldCwgdGhpcyk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLlRva2VuLnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIgPyBwcm9jZXNzTWFya3VwKHRoaXMudG9rZW4udmFsdWUsIHRoaXMudG9rZW4ubmFtZSArICJAIiArIHRoaXMudG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwpIDogIiIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMudG9rZW4gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHByb2Nlc3NNYXJrdXAodmFsdWUsIGlkKSB7CiAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9ImJhc2lzanMtbWFya3VwIiBkYXRhLWJhc2lzanMtbDEwbj0iJyArIGlkICsgJyI+JyArIFN0cmluZyh2YWx1ZSkgKyAiPC9zcGFuPiI7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRMMTBuVGVtcGxhdGUodG9rZW4pIHsKICAgICAgaWYgKHR5cGVvZiB0b2tlbiA9PSAic3RyaW5nIikgdG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKHRva2VuKTsKICAgICAgaWYgKCF0b2tlbikgcmV0dXJuIG51bGw7CiAgICAgIHZhciBpZCA9IHRva2VuLmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRva2VuVGVtcGxhdGVbaWRdOwogICAgICBpZiAoIXRlbXBsYXRlKSB0ZW1wbGF0ZSA9IHRva2VuVGVtcGxhdGVbaWRdID0gbmV3IFRlbXBsYXRlKG5ldyBMMTBuUHJveHlUb2tlbih0b2tlbikpOwogICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5Jc29sYXRlTWFya2VyKCkgewogICAgICByZXR1cm4gImkiICsgYmFzaXMuZ2VuVUlEKCkgKyAiX18iOwogICAgfQogICAgZnVuY3Rpb24gaXNvbGF0ZUNzcyhjc3MsIHByZWZpeCkgewogICAgICBmdW5jdGlvbiBhZGRNYXRjaChwcmVmaXgpIHsKICAgICAgICBpZiAoaSA+IGxhc3RNYXRjaFBvcykgewogICAgICAgICAgcmVzdWx0LnB1c2goKHByZWZpeCB8fCAiIikgKyBjc3Muc3Vic3RyaW5nKGxhc3RNYXRjaFBvcywgaSkpOwogICAgICAgICAgbGFzdE1hdGNoUG9zID0gaTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgc3ltID0gY3NzLnNwbGl0KCIiKTsKICAgICAgdmFyIGxlbiA9IHN5bS5sZW5ndGg7CiAgICAgIHZhciBsYXN0TWF0Y2hQb3MgPSAwOwogICAgICB2YXIgYmxvY2tTY29wZSA9IGZhbHNlOwogICAgICB2YXIgc3RyU3ltOwogICAgICBpZiAoIXByZWZpeCkgcHJlZml4ID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgc3dpdGNoIChzeW1baV0pIHsKICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgIHN0clN5bSA9IHN5bVtpXTsKICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgewogICAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxcIikgaSsrOyBlbHNlIGlmIChzeW1baV0gPT0gc3RyU3ltKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICIvIjoKICAgICAgICAgICAgaWYgKHN5bVtpICsgMV0gPT0gIioiKSB7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIHdoaWxlICgrK2kgPCBsZW4pIGlmIChzeW1baV0gPT0gIioiICYmIHN5bVtpICsgMV0gPT0gIi8iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ7IjoKICAgICAgICAgICAgYmxvY2tTY29wZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAifSI6CiAgICAgICAgICAgIGJsb2NrU2NvcGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICIuIjoKICAgICAgICAgICAgaWYgKCFibG9ja1Njb3BlKSB7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIGFkZE1hdGNoKCk7CiAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgaWYgKCEvW2EtejAtOVwtXF9dLy50ZXN0KHN5bVtpXSkpIHsKICAgICAgICAgICAgICAgIGFkZE1hdGNoKHByZWZpeCk7CiAgICAgICAgICAgICAgICBpIC09IDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFkZE1hdGNoKCk7CiAgICAgIHJldHVybiByZXN1bHQuam9pbigiIik7CiAgICB9CiAgICB2YXIgbWFrZURlY2xhcmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBJREVOVCA9IC9eW2Etel9dW2EtejAtOV9cLV0qJC9pOwogICAgICB2YXIgQ0xBU1NfQVRUUl9QQVJUUyA9IC8oXFMrKS9nOwogICAgICB2YXIgQ0xBU1NfQVRUUl9CSU5ESU5HID0gL14oKD86W2Etel9dW2EtejAtOV9cLV0qKT8oPzo6KD86W2Etel9dW2EtejAtOV9cLV0qKT8pPylceygoYW5pbTopP1thLXpfXVthLXowLTlfXC1dKilcfSQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfUEFSVFMgPSAvXHMqW146XSs/XHMqOig/OlwoLio/XCl8Ii4qPyJ8Jy4qPyd8W147XSs/KSsoPzo7fCQpL2dpOwogICAgICB2YXIgU1RZTEVfUFJPUEVSVFkgPSAvXHMqKFteOl0rPylccyo6KCg/OlwoLio/XCl8Ii4qPyJ8Jy4qPyd8W147XSs/KSspOz8kL2k7CiAgICAgIHZhciBTVFlMRV9BVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKilcfS9pOwogICAgICB2YXIgQVRUUl9CSU5ESU5HID0gL1x7KFthLXpfXVthLXowLTlfXSp8bDEwbjpbYS16X11bYS16MC05X10qKD86XC5bYS16X11bYS16MC05X10qKSooPzpcLlx7W2Etel9dW2EtejAtOV9dKlx9KT8pXH0vaTsKICAgICAgdmFyIE5BTUVEX0NIQVJBQ1RFUl9SRUYgPSAvJihbYS16XSt8I1swLTldK3wjeFswLTlhLWZdezEsNH0pOz8vZ2k7CiAgICAgIHZhciB0b2tlbk1hcCA9IGJhc2lzLk5PREVfRU5WID8gX19ub2RlanNSZXF1aXJlKCIuL3RlbXBsYXRlL2h0bWxlbnRpdHkuanNvbiIpIDoge307CiAgICAgIHZhciB0b2tlbkVsZW1lbnQgPSAhYmFzaXMuTk9ERV9FTlYgPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSA6IG51bGw7CiAgICAgIHZhciBpbmNsdWRlU3RhY2sgPSBbXTsKICAgICAgdmFyIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9IHt9OwogICAgICBmdW5jdGlvbiBuYW1lKHRva2VuKSB7CiAgICAgICAgcmV0dXJuICh0b2tlbi5wcmVmaXggPyB0b2tlbi5wcmVmaXggKyAiOiIgOiAiIikgKyB0b2tlbi5uYW1lOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5hbWVkQ2hhclJlcGxhY2UobSwgdG9rZW4pIHsKICAgICAgICBpZiAoIXRva2VuTWFwW3Rva2VuXSkgewogICAgICAgICAgaWYgKHRva2VuLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gU3RyaW5nLmZyb21DaGFyQ29kZSh0b2tlbi5jaGFyQXQoMSkgPT0gIngiIHx8IHRva2VuLmNoYXJBdCgxKSA9PSAiWCIgPyBwYXJzZUludCh0b2tlbi5zdWJzdHIoMiksIDE2KSA6IHRva2VuLnN1YnN0cigxKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodG9rZW5FbGVtZW50KSB7CiAgICAgICAgICAgICAgdG9rZW5FbGVtZW50LmlubmVySFRNTCA9IG07CiAgICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gdG9rZW5FbGVtZW50LmZpcnN0Q2hpbGQgPyB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgOiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbk1hcFt0b2tlbl0gfHwgbTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1bnRva2VuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoTkFNRURfQ0hBUkFDVEVSX1JFRiwgbmFtZWRDaGFyUmVwbGFjZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVmTGlzdCh0b2tlbikgewogICAgICAgIHZhciBhcnJheSA9IHRva2VuLnJlZnM7CiAgICAgICAgaWYgKCFhcnJheSB8fCAhYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYnVpbGRBdHRyRXhwcmVzc2lvbihwYXJ0cykgewogICAgICAgIHZhciBiaW5kTmFtZTsKICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBhcnRzLmxlbmd0aDsgaisrKSBpZiAoaiAlIDIpIHsKICAgICAgICAgIGJpbmROYW1lID0gcGFydHNbal07CiAgICAgICAgICBpZiAoIW1hcFtiaW5kTmFtZV0pIHsKICAgICAgICAgICAgbWFwW2JpbmROYW1lXSA9IG5hbWVzLmxlbmd0aDsKICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleHByZXNzaW9uLnB1c2gobWFwW2JpbmROYW1lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChwYXJ0c1tqXSkgZXhwcmVzc2lvbi5wdXNoKHVudG9rZW4ocGFydHNbal0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFsgbmFtZXMsIGV4cHJlc3Npb24gXTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzQXR0cihuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBiaW5kaW5ncyA9IDA7CiAgICAgICAgdmFyIHBhcnRzOwogICAgICAgIHZhciBtOwogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChDTEFTU19BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gW107CiAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChtID0gcGFydC5tYXRjaChDTEFTU19BVFRSX0JJTkRJTkcpKSBiaW5kaW5ncy5wdXNoKFsgbVsxXSB8fCAiIiwgbVsyXSBdKTsgZWxzZSBuZXdWYWx1ZS5wdXNoKHBhcnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWUgPSBuZXdWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gW107CiAgICAgICAgICAgICAgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChTVFlMRV9BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtID0gcGFydC5tYXRjaChTVFlMRV9QUk9QRVJUWSk7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBtWzFdOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBtWzJdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlUGFydHMgPSB2YWx1ZS5zcGxpdChTVFlMRV9BVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWVQYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cHIgPSBidWlsZEF0dHJFeHByZXNzaW9uKHZhbHVlUGFydHMpOwogICAgICAgICAgICAgICAgICAgIGV4cHIucHVzaChwcm9wZXJ0eU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBwcm9wcy5wdXNoKHByb3BlcnR5TmFtZSArICI6ICIgKyB1bnRva2VuKHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgvXFMvLnRlc3QodmFsdWUpKSBiYXNpcy5kZXYud2FybigiQmFkIHZhbHVlIGZvciBzdHlsZSBhdHRyaWJ1dGUgKHZhbHVlIGlnbm9yZWQpOiIsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSBwcm9wcy5qb2luKCI7ICIpOwogICAgICAgICAgICAgIGlmICh2YWx1ZSkgdmFsdWUgKz0gIjsiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHBhcnRzID0gdmFsdWUuc3BsaXQoQVRUUl9CSU5ESU5HKTsKICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkgYmluZGluZ3MgPSBidWlsZEF0dHJFeHByZXNzaW9uKHBhcnRzKTsgZWxzZSB2YWx1ZSA9IHVudG9rZW4odmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYmluZGluZ3MgJiYgIWJpbmRpbmdzLmxlbmd0aCkgYmluZGluZ3MgPSAwOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBiaW5kaW5nOiBiaW5kaW5ncywKICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgIHR5cGU6IEFUVFJfVFlQRV9CWV9OQU1FW25hbWVdIHx8IDIKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGF0dHJzKHRva2VuLCBkZWNsVG9rZW4sIG9wdGltaXplU2l6ZSkgewogICAgICAgIHZhciBhdHRycyA9IHRva2VuLmF0dHJzOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgc3R5bGVBdHRyOwogICAgICAgIHZhciBkaXNwbGF5OwogICAgICAgIHZhciBtOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRyOyBhdHRyID0gYXR0cnNbaV07IGkrKykgewogICAgICAgICAgaWYgKGF0dHIucHJlZml4ID09ICJiIikgewogICAgICAgICAgICBzd2l0Y2ggKGF0dHIubmFtZSkgewogICAgICAgICAgICAgIGNhc2UgInJlZiI6CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IChhdHRyLnZhbHVlIHx8ICIiKS50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZWZzLmxlbmd0aDsgaisrKSBhZGRUb2tlblJlZihkZWNsVG9rZW4sIHJlZnNbal0pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAic2hvdyI6CiAgICAgICAgICAgICAgY2FzZSAiaGlkZSI6CiAgICAgICAgICAgICAgICBkaXNwbGF5ID0gYXR0cjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG0gPSBhdHRyLm5hbWUubWF0Y2goQVRUUl9FVkVOVF9SWCkpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2gobVsxXSA9PSBhdHRyLnZhbHVlID8gWyBUWVBFX0FUVFJJQlVURV9FVkVOVCwgbVsxXSBdIDogWyBUWVBFX0FUVFJJQlVURV9FVkVOVCwgbVsxXSwgYXR0ci52YWx1ZSBdKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0ci5uYW1lLCBhdHRyLnZhbHVlKTsKICAgICAgICAgIHZhciBpdGVtID0gWyBwYXJzZWQudHlwZSwgcGFyc2VkLmJpbmRpbmcsIHJlZkxpc3QoYXR0cikgXTsKICAgICAgICAgIGlmIChwYXJzZWQudHlwZSA9PSAyKSBpdGVtLnB1c2gobmFtZShhdHRyKSk7CiAgICAgICAgICBpZiAocGFyc2VkLnZhbHVlICYmICghb3B0aW1pemVTaXplIHx8ICFwYXJzZWQuYmluZGluZyB8fCBwYXJzZWQudHlwZSAhPSAyKSkgaXRlbS5wdXNoKHBhcnNlZC52YWx1ZSk7CiAgICAgICAgICBpZiAocGFyc2VkLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfU1RZTEUpIHN0eWxlQXR0ciA9IGl0ZW07CiAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpc3BsYXkpIHsKICAgICAgICAgIGlmICghc3R5bGVBdHRyKSB7CiAgICAgICAgICAgIHN0eWxlQXR0ciA9IFsgVFlQRV9BVFRSSUJVVEVfU1RZTEUsIDAsIDAgXTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goc3R5bGVBdHRyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghc3R5bGVBdHRyWzFdKSBzdHlsZUF0dHJbMV0gPSBbXTsKICAgICAgICAgIHZhciBkaXNwbGF5RXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24oKGRpc3BsYXkudmFsdWUgfHwgZGlzcGxheS5uYW1lKS5zcGxpdChBVFRSX0JJTkRJTkcpKTsKICAgICAgICAgIGlmIChkaXNwbGF5RXhwclswXS5sZW5ndGggLSBkaXNwbGF5RXhwclsxXS5sZW5ndGgpIHsKICAgICAgICAgICAgc3R5bGVBdHRyWzNdID0gKHN0eWxlQXR0clszXSA/IHN0eWxlQXR0clszXSArICI7ICIgOiAiIikgKyAoZGlzcGxheS5uYW1lID09ICJzaG93IiBeIGRpc3BsYXkudmFsdWUgPT09ICIiID8gIiIgOiAiZGlzcGxheTogbm9uZSIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGRpc3BsYXkubmFtZSA9PSAic2hvdyIpIHN0eWxlQXR0clszXSA9IChzdHlsZUF0dHJbM10gPyBzdHlsZUF0dHJbM10gKyAiOyAiIDogIiIpICsgImRpc3BsYXk6IG5vbmUiOwogICAgICAgICAgICBzdHlsZUF0dHJbMV0ucHVzaChkaXNwbGF5RXhwci5jb25jYXQoImRpc3BsYXkiLCBkaXNwbGF5Lm5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPyByZXN1bHQgOiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFRva2VuUmVmKHRva2VuLCByZWZOYW1lKSB7CiAgICAgICAgaWYgKCF0b2tlbltUT0tFTl9SRUZTXSkgdG9rZW5bVE9LRU5fUkVGU10gPSBbXTsKICAgICAgICBhcnJheUFkZCh0b2tlbltUT0tFTl9SRUZTXSwgcmVmTmFtZSk7CiAgICAgICAgaWYgKHJlZk5hbWUgIT0gImVsZW1lbnQiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXS5sZW5ndGggPT0gMSA/IHJlZk5hbWUgOiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlbW92ZVRva2VuUmVmKHRva2VuLCByZWZOYW1lKSB7CiAgICAgICAgdmFyIGlkeCA9IHRva2VuW1RPS0VOX1JFRlNdLmluZGV4T2YocmVmTmFtZSk7CiAgICAgICAgaWYgKGlkeCAhPSAtMSkgewogICAgICAgICAgdmFyIGluZGV4QmluZGluZyA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiOwogICAgICAgICAgdG9rZW5bVE9LRU5fUkVGU10uc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICBpZiAoaW5kZXhCaW5kaW5nKSBpZiAoaWR4ID09IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDEpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHJlZk5hbWU7CiAgICAgICAgICBpZiAoIXRva2VuW1RPS0VOX1JFRlNdLmxlbmd0aCkgdG9rZW5bVE9LRU5fUkVGU10gPSAwOyBlbHNlIHsKICAgICAgICAgICAgaWYgKGluZGV4QmluZGluZykgdG9rZW5bVE9LRU5fQklORElOR1NdIC09IGlkeCA8IHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRva2VuQXR0cnModG9rZW4pIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgaWYgKHRva2VuLmF0dHJzKSBmb3IgKHZhciBpID0gMCwgYXR0cjsgYXR0ciA9IHRva2VuLmF0dHJzW2ldOyBpKyspIHJlc3VsdFtuYW1lKGF0dHIpXSA9IGF0dHIudmFsdWU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRVbmlxdWUoYXJyYXksIGl0ZW1zKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgYXJyYXlBZGQoYXJyYXksIGl0ZW1zW2ldKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRTdHlsZXMoYXJyYXksIGl0ZW1zLCBwcmVmaXgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGl0ZW1zW2ldOyBpKyspIGlmIChpdGVtWzFdICE9PSBzdHlsZU5hbWVzcGFjZUlzb2xhdGUpIGl0ZW1bMV0gPSBwcmVmaXggKyBpdGVtWzFdOwogICAgICAgIGFycmF5LnVuc2hpZnQuYXBwbHkoYXJyYXksIGl0ZW1zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRTdHlsZSh0ZW1wbGF0ZSwgdG9rZW4sIHNyYywgaXNvbGF0ZVByZWZpeCkgewogICAgICAgIHZhciB1cmw7CiAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHNyYykpIGJhc2lzLmRldi53YXJuKCJCYWQgdXNhZ2U6IDxiOiIgKyB0b2tlbi5uYW1lICsgJyBzcmM9IicgKyBzcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgIHVybCA9IHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgc3JjKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICB1cmwgPSBiYXNpcy5yZXNvdXJjZS52aXJ0dWFsKCJjc3MiLCB0ZXh0ID8gdGV4dC52YWx1ZSA6ICIiLCB0ZW1wbGF0ZS5zb3VyY2VVcmwpLnVybDsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGUucmVzb3VyY2VzLnB1c2goWyB1cmwsIGlzb2xhdGVQcmVmaXggXSk7CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzKHRva2VucywgdGVtcGxhdGUsIG9wdGlvbnMsIGNvbnRleHQpIHsKICAgICAgICBmdW5jdGlvbiBtb2RpZnlBdHRyKHRva2VuLCBuYW1lLCBhY3Rpb24pIHsKICAgICAgICAgIHZhciBhdHRycyA9IHRva2VuQXR0cnModG9rZW4pOwogICAgICAgICAgaWYgKG5hbWUpIGF0dHJzLm5hbWUgPSBuYW1lOwogICAgICAgICAgaWYgKCFhdHRycy5uYW1lKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkluc3RydWN0aW9uIDxiOiIgKyB0b2tlbi5uYW1lICsgIj4gaGFzIG5vIGF0dHJpYnV0ZSBuYW1lIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghSURFTlQudGVzdChhdHRycy5uYW1lKSkgewogICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJCYWQgYXR0cmlidXRlIG5hbWUgYCIgKyBhdHRycy5uYW1lICsgImAiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluY2x1ZGVkVG9rZW4gPSB0b2tlblJlZk1hcFthdHRycy5yZWYgfHwgImVsZW1lbnQiXTsKICAgICAgICAgIGlmIChpbmNsdWRlZFRva2VuKSB7CiAgICAgICAgICAgIGlmIChpbmNsdWRlZFRva2VuLnRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgIHZhciBpdEF0dHJzID0gaW5jbHVkZWRUb2tlbi50b2tlbjsKICAgICAgICAgICAgICB2YXIgaXNFdmVudCA9IGF0dHJzLm5hbWUubWF0Y2goQVRUUl9FVkVOVF9SWCk7CiAgICAgICAgICAgICAgdmFyIGl0VHlwZSA9IGlzRXZlbnQgPyBUWVBFX0FUVFJJQlVURV9FVkVOVCA6IEFUVFJfVFlQRV9CWV9OQU1FW2F0dHJzLm5hbWVdIHx8IFRZUEVfQVRUUklCVVRFOwogICAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUVfSU5ERVhbaXRUeXBlXSB8fCBBVFRSX1ZBTFVFOwogICAgICAgICAgICAgIHZhciBpdEF0dHJUb2tlbiA9IGl0QXR0cnMgJiYgYXJyYXlTZWFyY2goaXRBdHRycywgYXR0cnMubmFtZSwgZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0FUVFJJQlVURV9FVkVOVCkgcmV0dXJuICJldmVudC0iICsgdG9rZW5bMV07CiAgICAgICAgICAgICAgICByZXR1cm4gQVRUUl9OQU1FX0JZX1RZUEVbdG9rZW5bVE9LRU5fVFlQRV1dIHx8IHRva2VuW0FUVFJfTkFNRV07CiAgICAgICAgICAgICAgfSwgRUxFTUVOVF9BVFRSUyk7CiAgICAgICAgICAgICAgaWYgKCFpdEF0dHJUb2tlbiAmJiBhY3Rpb24gIT0gInJlbW92ZSIpIHsKICAgICAgICAgICAgICAgIGlmIChpc0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuID0gWyBpdFR5cGUsIGlzRXZlbnRbMV0gXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuID0gWyBpdFR5cGUsIDAsIDAsIGl0VHlwZSA9PSBUWVBFX0FUVFJJQlVURSA/IGF0dHJzLm5hbWUgOiAiIiBdOwogICAgICAgICAgICAgICAgICBpZiAoaXRUeXBlID09IFRZUEVfQVRUUklCVVRFKSBpdEF0dHJUb2tlbi5wdXNoKCIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghaXRBdHRycykgewogICAgICAgICAgICAgICAgICBpdEF0dHJzID0gW107CiAgICAgICAgICAgICAgICAgIGluY2x1ZGVkVG9rZW4udG9rZW4ucHVzaChpdEF0dHJzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGl0QXR0cnMucHVzaChpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjbGFzc09yU3R5bGUgPSBhdHRycy5uYW1lID09ICJjbGFzcyIgfHwgYXR0cnMubmFtZSA9PSAic3R5bGUiOwogICAgICAgICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICJzZXQiOgogICAgICAgICAgICAgICAgICBpZiAoaXRBdHRyVG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0cnMudmFsdWUgPT0gaXNFdmVudFsxXSkgaXRBdHRyVG9rZW4ubGVuZ3RoID0gMjsgZWxzZSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSBhdHRycy52YWx1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHJzLm5hbWUsIGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdID0gcGFyc2VkLmJpbmRpbmc7CiAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5vcHRpbWl6ZVNpemUgfHwgIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSB8fCBjbGFzc09yU3R5bGUpIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IHBhcnNlZC52YWx1ZSB8fCAiIjsgZWxzZSBpdEF0dHJUb2tlbi5sZW5ndGggPSB2YWx1ZUlkeDsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzT3JTdHlsZSkgaWYgKCFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gJiYgIWl0QXR0clRva2VuW3ZhbHVlSWR4XSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQiOgogICAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0cnMubmFtZSwgYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICBpZiAoIWlzRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VkLmJpbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRyQmluZGluZ3MgPSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ckJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYXR0cnMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRCaW5kaW5nTWFwID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgb2xkQmluZGluZzsgb2xkQmluZGluZyA9IGF0dHJCaW5kaW5nc1tpXTsgaSsrKSBvbGRCaW5kaW5nTWFwW29sZEJpbmRpbmdbMl1dID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuZXdCaW5kaW5nOyBuZXdCaW5kaW5nID0gcGFyc2VkLmJpbmRpbmdbaV07IGkrKykgaWYgKG5ld0JpbmRpbmdbMl0gaW4gb2xkQmluZGluZ01hcCkgYXR0ckJpbmRpbmdzW29sZEJpbmRpbmdNYXBbbmV3QmluZGluZ1syXV1dID0gbmV3QmluZGluZzsgZWxzZSBhdHRyQmluZGluZ3MucHVzaChuZXdCaW5kaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJCaW5kaW5ncy5wdXNoLmFwcGx5KGF0dHJCaW5kaW5ncywgcGFyc2VkLmJpbmRpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5iaW5kaW5nWzBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUFkZCh0aGlzLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGF0dHJCaW5kaW5nc1swXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnNlZC5iaW5kaW5nWzFdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlZC5iaW5kaW5nWzFdW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSB2YWx1ZSA9IGF0dHJCaW5kaW5nc1swXS5pbmRleE9mKHBhcnNlZC5iaW5kaW5nWzBdW3ZhbHVlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJCaW5kaW5nc1sxXS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdID0gcGFyc2VkLmJpbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2xhc3NPclN0eWxlKSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU11bMV0udW5zaGlmdChpdEF0dHJUb2tlblt2YWx1ZUlkeF0pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsYXNzT3JTdHlsZSAmJiBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10pIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXVsxXS5wdXNoKGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZC52YWx1ZSkgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gKGl0QXR0clRva2VuW3ZhbHVlSWR4XSB8fCAiIikgKyAoaXRBdHRyVG9rZW5bdmFsdWVJZHhdICYmIChpc0V2ZW50IHx8IGNsYXNzT3JTdHlsZSkgPyAiICIgOiAiIikgKyBwYXJzZWQudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChjbGFzc09yU3R5bGUpIGlmICghaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdICYmICFpdEF0dHJUb2tlblt2YWx1ZUlkeF0pIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlIjoKICAgICAgICAgICAgICAgICAgaWYgKGl0QXR0clRva2VuKSBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJBdHRyaWJ1dGUgbW9kaWZpY2F0b3IgaXMgbm90IHJlZmVyZW5jZSB0byBlbGVtZW50IHRva2VuIChyZWZlcmVuY2UgbmFtZTogIiArIChhdHRycy5yZWYgfHwgImVsZW1lbnQiKSArICIpIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCB0b2tlbiwgaXRlbTsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgdmFyIHJlZnMgPSByZWZMaXN0KHRva2VuKTsKICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMSA/IHJlZnNbMF0gOiAwOwogICAgICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICAgIGlmICh0b2tlbi5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxBdHRycyA9IHRva2VuQXR0cnModG9rZW4pOwogICAgICAgICAgICAgICAgc3dpdGNoICh0b2tlbi5uYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOYW1lc3BhY2UgPSBlbEF0dHJzLm5hbWVzcGFjZSB8fCBlbEF0dHJzLm5zOwogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUlzb2xhdGUgPSBzdHlsZU5hbWVzcGFjZSA/IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA6IGNvbnRleHQgJiYgY29udGV4dC5pc29sYXRlIHx8ICIiOwogICAgICAgICAgICAgICAgICAgIHZhciBzcmMgPSBhZGRTdHlsZSh0ZW1wbGF0ZSwgdG9rZW4sIGVsQXR0cnMuc3JjLCBzdHlsZUlzb2xhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYyBpbiBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgPT0gZmFsc2UpIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuc3R5bGVOU1ByZWZpeFtzdHlsZU5hbWVzcGFjZV0gPSBzdHlsZU5hbWVzcGFjZUlzb2xhdGVbc3JjXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImlzb2xhdGUiOgogICAgICAgICAgICAgICAgICAgIGlmICghdGVtcGxhdGUuaXNvbGF0ZSkgdGVtcGxhdGUuaXNvbGF0ZSA9IGVsQXR0cnMucHJlZml4IHx8IG9wdGlvbnMuaXNvbGF0ZSB8fCBnZW5Jc29sYXRlTWFya2VyKCk7IGVsc2UgYmFzaXMuZGV2Lndhcm4oIjxiOmlzb2xhdGU+IGlzIHNldCBhbHJlYWR5IHRvIGAiICsgdGVtcGxhdGUuaXNvbGF0ZSArICJgIik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImwxMG4iOgogICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQpIHRlbXBsYXRlLndhcm5zLnB1c2goIjxiOmwxMG4+IG11c3QgYmUgZGVjbGFyZWQgYmVmb3JlIGFueSBgbDEwbjpgIHRva2VuIChpbnN0cnVjdGlvbiBpZ25vcmVkKSIpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnNyYykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGVsQXR0cnMuc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIGVsQXR0cnMuc3JjICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kaWN0VVJJID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkksIGVsQXR0cnMuc3JjKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImRlZmluZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCJuYW1lIiBpbiBlbEF0dHJzICYmICF0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZWxBdHRycy50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2wiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSA9IFsgZWxBdHRyc1siZGVmYXVsdCJdID09ICJ0cnVlIiA/IDEgOiAwIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVudW0iOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBlbEF0dHJzLnZhbHVlcyA/IGVsQXR0cnMudmFsdWVzLnRyaW0oKS5zcGxpdCgiICIpIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyB2YWx1ZXMuaW5kZXhPZihlbEF0dHJzWyJkZWZhdWx0Il0pICsgMSwgdmFsdWVzIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGRlZmluZSB0eXBlIGAiICsgZWxBdHRycy50eXBlICsgImAgZm9yICIgKyBlbEF0dHJzLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSBiYXNpcy5vYmplY3QuZXh0ZW5kKHRleHQsIHsKICAgICAgICAgICAgICAgICAgICAgIHJlZnM6IChlbEF0dHJzLnJlZiB8fCAiIikudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAibm90cmltIiBpbiBlbEF0dHJzID8gdGV4dC52YWx1ZSA6IHRleHQudmFsdWUucmVwbGFjZSgvXlxzKltcclxuXSt8W1xyXG5dXHMqJC9nLCAiIikKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaW5jbHVkZSI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlU3JjID0gZWxBdHRycy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlU3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNUZW1wbGF0ZVJlZiA9IC9eI1xkKyQvLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGlzRG9jdW1lbnRJZFJlZiA9IC9eaWQ6Ly50ZXN0KHRlbXBsYXRlU3JjKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSBpc1RlbXBsYXRlUmVmID8gdGVtcGxhdGVTcmMuc3Vic3RyKDEpIDogdGVtcGxhdGVTcmM7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IHRlbXBsYXRlTGlzdFt1cmxdOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RvY3VtZW50SWRSZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHVybC5zdWJzdHIoMykpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvXlthLXowLTlcLl0rJC9pLnRlc3QodXJsKSAmJiAhL1wudG1wbCQvLnRlc3QodXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IGdldFNvdXJjZUJ5UGF0aCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHVybCkpIGJhc2lzLmRldi53YXJuKCdCYWQgdXNhZ2U6IDxiOmluY2x1ZGUgc3JjPSInICsgdXJsICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UocGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkkgKyB1cmwpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgnPGI6aW5jbHVkZSBzcmM9IicgKyB0ZW1wbGF0ZVNyYyArICciPiBpcyBub3QgcmVzb2x2ZWQsIGluc3RydWN0aW9uIGlnbm9yZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oJzxiOmluY2x1ZGUgc3JjPSInICsgdGVtcGxhdGVTcmMgKyAnIj4gaXMgbm90IHJlc29sdmVkLCBpbnN0cnVjdGlvbiBpZ25vcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNvbGF0ZVByZWZpeCA9ICJpc29sYXRlIiBpbiBlbEF0dHJzID8gZWxBdHRycy5pc29sYXRlIHx8IGdlbklzb2xhdGVNYXJrZXIoKSA6ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVjbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0RvY3VtZW50SWRSZWYpIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVGVtcGxhdGVSZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2Uuc291cmNlLmJpbmRpbmdCcmlkZ2UpIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlLnNvdXJjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjbCA9IGdldERlY2xGcm9tU291cmNlKHJlc291cmNlLnNvdXJjZSwgcmVzb3VyY2UuYmFzZVVSSSwgdHJ1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjbCA9IGdldERlY2xGcm9tU291cmNlKHJlc291cmNlLCByZXNvdXJjZS51cmwgPyBwYXRoLmRpcm5hbWUocmVzb3VyY2UudXJsKSArICIvIiA6ICIiLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5yZXNvdXJjZXMgJiYgIm5vLXN0eWxlIiBpbiBlbEF0dHJzID09IGZhbHNlKSBhZGRTdHlsZXModGVtcGxhdGUucmVzb3VyY2VzLCBkZWNsLnJlc291cmNlcywgaXNvbGF0ZVByZWZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLmRlcHMpIGFkZFVuaXF1ZSh0ZW1wbGF0ZS5kZXBzLCBkZWNsLmRlcHMpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5sMTBuKSBhZGRVbmlxdWUodGVtcGxhdGUubDEwbiwgZGVjbC5sMTBuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmTWFwID0gbm9ybWFsaXplUmVmcyhkZWNsLnRva2Vucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnN0cnVjdGlvbnMgPSAodG9rZW4uY2hpbGRzIHx8IFtdKS5zbGljZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOU1ByZWZpeE1hcCA9IGJhc2lzLm9iamVjdC5zbGljZShkZWNsLnN0eWxlTlNQcmVmaXgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRyc1siY2xhc3MiXSkgaW5zdHJ1Y3Rpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICJiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiYXBwZW5kLWNsYXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyczogWyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJ2YWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZWxBdHRyc1siY2xhc3MiXQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gXQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuaWQpIGluc3RydWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4OiAiYiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInNldC1hdHRyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyczogWyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiaWQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAidmFsdWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVsQXR0cnMuaWQKICAgICAgICAgICAgICAgICAgICAgICAgICB9IF0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnJlZikgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIGVsQXR0cnMucmVmLnRyaW0oKS5zcGxpdCgvXHMrLykubWFwKGZ1bmN0aW9uKHJlZk5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUb2tlblJlZih0b2tlblJlZk1hcC5lbGVtZW50LnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjaGlsZDsgY2hpbGQgPSBpbnN0cnVjdGlvbnNbal07IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50eXBlID09IFRZUEVfRUxFTUVOVCAmJiBjaGlsZC5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlTmFtZXNwYWNlID0gY2hpbGRBdHRycy5uYW1lc3BhY2UgfHwgY2hpbGRBdHRycy5uczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVJc29sYXRlID0gc3R5bGVOYW1lc3BhY2UgPyBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgOiBpc29sYXRlUHJlZml4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcmMgPSBhZGRTdHlsZSh0ZW1wbGF0ZSwgY2hpbGQsIGNoaWxkQXR0cnMuc3JjLCBzdHlsZUlzb2xhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYyBpbiBzdHlsZU5hbWVzcGFjZUlzb2xhdGUgPT0gZmFsc2UpIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdID0gZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVOU1ByZWZpeE1hcFtzdHlsZU5hbWVzcGFjZV0gPSBzdHlsZU5hbWVzcGFjZUlzb2xhdGVbc3JjXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJiZWZvcmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZnRlciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VPclJlbW92ZSA9IGNoaWxkLm5hbWUgPT0gInJlcGxhY2UiIHx8IGNoaWxkLm5hbWUgPT0gInJlbW92ZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyB8fCAhcmVwbGFjZU9yUmVtb3ZlID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gdG9rZW5SZWYub3duZXIuaW5kZXhPZih0b2tlblJlZi50b2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gWyBwb3MgKyAoY2hpbGQubmFtZSA9PSAiYWZ0ZXIiKSwgcmVwbGFjZU9yUmVtb3ZlIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lICE9ICJyZW1vdmUiKSBhcmdzID0gYXJncy5jb25jYXQocHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuUmVmLm93bmVyLnNwbGljZS5hcHBseSh0b2tlblJlZi5vd25lciwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJwcmVwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcyA9IHByb2Nlc3MoY2hpbGQuY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQubmFtZSA9PSAicHJlcGVuZCIpIHRva2VuLnNwbGljZS5hcHBseSh0b2tlbiwgWyBFTEVNRU5UX0FUVFJTLCAwIF0uY29uY2F0KGNoaWxkcykpOyBlbHNlIHRva2VuLnB1c2guYXBwbHkodG9rZW4sIGNoaWxkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJyZW1vdmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJhcHBlbmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZGQtcmVmIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIGNoaWxkQXR0cnMubmFtZSkgYWRkVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4pIHJlbW92ZVRva2VuUmVmKHRva2VuLCBjaGlsZEF0dHJzLm5hbWUgfHwgY2hpbGRBdHRycy5yZWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVua25vd24gaW5zdHJ1Y3Rpb24gdGFnIDxiOiIgKyBjaGlsZC5uYW1lICsgIj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgZGVjbC50b2tlbnMucHVzaC5hcHBseShkZWNsLnRva2VucywgcHJvY2VzcyhbIGNoaWxkIF0sIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIHJlbW92ZVRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sICJlbGVtZW50Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2lzLm9iamVjdC5jb21wbGV0ZSh0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4LCBzdHlsZU5TUHJlZml4TWFwKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzb2xhdGVQcmVmaXgpIGlzb2xhdGVUb2tlbnMoZGVjbC50b2tlbnMsIGlzb2xhdGVQcmVmaXgpOyBlbHNlIGlmIChkZWNsLmlzb2xhdGUgJiYgIXRlbXBsYXRlLmlzb2xhdGUpIHRlbXBsYXRlLmlzb2xhdGUgPSBvcHRpb25zLmlzb2xhdGUgfHwgZ2VuSXNvbGF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaC5hcHBseShyZXN1bHQsIGRlY2wudG9rZW5zKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IGluY2x1ZGVTdGFjay5zbGljZShpbmNsdWRlU3RhY2suaW5kZXhPZihyZXNvdXJjZSkgfHwgMCkuY29uY2F0KHJlc291cmNlKS5tYXAoZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXMgPSByZXMuc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMgaW5zdGFuY2VvZiBMMTBuUHJveHlUb2tlbikgcmV0dXJuICJ7bDEwbjoiICsgcmVzLnRva2VuLm5hbWUgKyAiQCIgKyByZXMudG9rZW4uZGljdGlvbmFyeS5yZXNvdXJjZS51cmwgKyAifSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy51cmwgfHwgIltpbmxpbmUgdGVtcGxhdGVdIjsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlJlY3Vyc2lvbjogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlY3Vyc2lvbiBpbiB0ZW1wbGF0ZTogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMSwgYmluZGluZ3MsIHJlZnMsIG5hbWUodG9rZW4pIF07CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIGF0dHJzKHRva2VuLCBpdGVtLCBvcHRpb25zLm9wdGltaXplU2l6ZSkgfHwgW10pOwogICAgICAgICAgICAgIGl0ZW0ucHVzaC5hcHBseShpdGVtLCBwcm9jZXNzKHRva2VuLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgaWYgKHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMiAmJiBhcnJheVNlYXJjaChyZWZzLCAiZWxlbWVudCIpKSBiaW5kaW5ncyA9IHJlZnNbKyFyZWZzLmxhc3RTZWFyY2hJbmRleF07CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBhYnNsMTBuKGJpbmRpbmdzLCB0ZW1wbGF0ZS5kaWN0VVJJKTsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGwxMG5CaW5kaW5nLnNwbGl0KC9bOkBce10vKTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHMubGVuZ3RoID09IDMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0c1syXSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHJlZnMsIGJpbmRpbmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVmcy5sZW5ndGggPT0gMCkgcmVmcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSAwOwogICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gdG9rZW4udmFsdWUucmVwbGFjZSgvXH0kLywgIkB1bmRlZmluZWR9Iik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5JZCA9IHBhcnRzLnNsaWNlKDEpLmpvaW4oIkAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihsMTBuSWQpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVGVtcGxhdGUgPSBnZXRMMTBuVGVtcGxhdGUobDEwblRva2VuKTsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChsMTBuVGVtcGxhdGUgJiYgbDEwblRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1tpLS1dID0gdG9rZW5pemUoJzxiOmluY2x1ZGUgc3JjPSIjJyArIGwxMG5UZW1wbGF0ZS50ZW1wbGF0ZUlkICsgJyIvPicpWzBdOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGFycmF5QWRkKHRlbXBsYXRlLmwxMG4sIGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMywgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICAgIGlmIChvcHRpb25zLm9wdGltaXplU2l6ZSAmJiAhYmluZGluZ3MgJiYgIXJlZnMpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGl0ZW0gPSBbIDgsIGJpbmRpbmdzLCByZWZzIF07CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSkgaWYgKCFyZWZzIHx8IHRva2VuLnZhbHVlICE9ICJ7IiArIHJlZnMuam9pbigifCIpICsgIn0iKSBpdGVtLnB1c2godW50b2tlbih0b2tlbi52YWx1ZSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGl0ZW1baXRlbS5sZW5ndGggLSAxXSA9PT0gMCkgaXRlbS5wb3AoKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWJzbDEwbih2YWx1ZSwgZGljdFVSSSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gInN0cmluZyIpIHJldHVybiB2YWx1ZTsKICAgICAgICB2YXIgcGFydHMgPSB2YWx1ZS5zcGxpdCgiOiIpOwogICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMiAmJiBwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHNbMV0uaW5kZXhPZigiQCIpID09IC0xKSBwYXJ0c1sxXSA9IHBhcnRzWzFdICsgIkAiICsgZGljdFVSSTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbigiOiIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVJlZnModG9rZW5zLCBkaWN0VVJJLCBtYXAsIHN0SWR4KSB7CiAgICAgICAgaWYgKCFtYXApIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSBjb250aW51ZTsKICAgICAgICAgIHZhciByZWZzID0gdG9rZW5bVE9LRU5fUkVGU107CiAgICAgICAgICBpZiAocmVmcykgewogICAgICAgICAgICBmb3IgKHZhciBqID0gcmVmcy5sZW5ndGggLSAxLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tqXTsgai0tKSB7CiAgICAgICAgICAgICAgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hcFtyZWZOYW1lXSkgcmVtb3ZlVG9rZW5SZWYobWFwW3JlZk5hbWVdLnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdID09IHJlZk5hbWUpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGogKyAxOwogICAgICAgICAgICAgIG1hcFtyZWZOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0b2tlbnMsCiAgICAgICAgICAgICAgICB0b2tlbjogdG9rZW4KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICAgIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGFic2wxMG4odG9rZW5bVE9LRU5fQklORElOR1NdLCBkaWN0VVJJKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0FUVFJJQlVURToKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSB0b2tlbltUT0tFTl9CSU5ESU5HU11bMF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSBhcnJheVtqXSA9IGFic2wxMG4oYXJyYXlbal0sIGRpY3RVUkkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgbm9ybWFsaXplUmVmcyh0b2tlbiwgZGljdFVSSSwgbWFwLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhcHBseURlZmluZXModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgc3RJZHgpIHsKICAgICAgICB2YXIgdW5wcmVkaWN0YWJsZSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgdG9rZW5UeXBlID0gdG9rZW5bVE9LRU5fVFlQRV07CiAgICAgICAgICBpZiAodG9rZW5UeXBlID09IFRZUEVfRUxFTUVOVCkgdW5wcmVkaWN0YWJsZSArPSBhcHBseURlZmluZXModG9rZW4sIHRlbXBsYXRlLCBvcHRpb25zLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MgfHwgdG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUVfSU5ERVhbdG9rZW5UeXBlXTsKICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0F0dHJWYWx1ZSA9ICh0b2tlblt2YWx1ZUlkeF0gfHwgIiIpLnRyaW0oKS5zcGxpdCgiICIpOwogICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kOyBiaW5kID0gYmluZGluZ3Nba107IGsrKykgewogICAgICAgICAgICAgICAgaWYgKGJpbmQubGVuZ3RoID4gMikgY29udGludWU7CiAgICAgICAgICAgICAgICB2YXIgYmluZE5hbWUgPSBiaW5kWzFdLnNwbGl0KCI6IikucG9wKCk7CiAgICAgICAgICAgICAgICB2YXIgYmluZERlZiA9IHRlbXBsYXRlLmRlZmluZXNbYmluZE5hbWVdOwogICAgICAgICAgICAgICAgaWYgKGJpbmREZWYpIHsKICAgICAgICAgICAgICAgICAgYmluZC5wdXNoLmFwcGx5KGJpbmQsIGJpbmREZWYpOwogICAgICAgICAgICAgICAgICBiaW5kRGVmLnVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBpZiAoYmluZERlZlswXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmLmxlbmd0aCA9PSAxKSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kTmFtZSk7IGVsc2UgYXJyYXlBZGQobmV3QXR0clZhbHVlLCBiaW5kWzBdICsgYmluZERlZlsxXVtiaW5kRGVmWzBdIC0gMV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJVbnByZWRpY3RhYmxlIHZhbHVlIGAiICsgYmluZE5hbWUgKyAiYCBpbiBjbGFzcyBiaW5kaW5nOiAiICsgYmluZFswXSArICJ7IiArIGJpbmRbMV0gKyAifSIpOwogICAgICAgICAgICAgICAgICB1bnByZWRpY3RhYmxlKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRva2VuW3ZhbHVlSWR4XSA9IG5ld0F0dHJWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub3B0aW1pemVTaXplICYmICF0b2tlblt2YWx1ZUlkeF0pIHRva2VuLmxlbmd0aCA9IHZhbHVlSWR4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bnByZWRpY3RhYmxlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzb2xhdGVUb2tlbnModG9rZW5zLCBpc29sYXRlLCB0ZW1wbGF0ZSwgc3RJZHgpIHsKICAgICAgICBmdW5jdGlvbiBwcm9jZXNzTmFtZShuYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID09IDEpIHJldHVybiBpc29sYXRlICsgcGFydHNbMF07CiAgICAgICAgICBpZiAoIXRlbXBsYXRlKSByZXR1cm4gbmFtZTsKICAgICAgICAgIGlmICghcGFydHNbMF0pIHJldHVybiBwYXJ0c1sxXTsKICAgICAgICAgIGlmIChwYXJ0c1swXSBpbiB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4ID09IGZhbHNlKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIk5hbWVzcGFjZSBgIiArIHBhcnRzWzBdICsgImAgaXMgbm90IGRlZmluZWQgaW4gdGVtcGxhdGUsIG5vIHByZWZpeCBhZGRlZCIpOwogICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4W3BhcnRzWzBdXSArIHBhcnRzWzFdOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gc3RJZHggfHwgMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB0b2tlblR5cGUgPSB0b2tlbltUT0tFTl9UWVBFXTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9FTEVNRU5UKSBpc29sYXRlVG9rZW5zKHRva2VuLCBpc29sYXRlLCB0ZW1wbGF0ZSwgRUxFTUVOVF9BVFRSUyk7CiAgICAgICAgICBpZiAodG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFX0NMQVNTIHx8IHRva2VuVHlwZSA9PSBUWVBFX0FUVFJJQlVURSAmJiB0b2tlbltBVFRSX05BTUVdID09ICJjbGFzcyIpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gdG9rZW5bVE9LRU5fQklORElOR1NdOwogICAgICAgICAgICB2YXIgdmFsdWVJbmRleCA9IEFUVFJfVkFMVUVfSU5ERVhbdG9rZW5UeXBlXTsKICAgICAgICAgICAgaWYgKHRva2VuW3ZhbHVlSW5kZXhdKSB0b2tlblt2YWx1ZUluZGV4XSA9IHRva2VuW3ZhbHVlSW5kZXhdLnNwbGl0KC9ccysvKS5tYXAocHJvY2Vzc05hbWUpLmpvaW4oIiAiKTsKICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSBmb3IgKHZhciBrID0gMCwgYmluZDsgYmluZCA9IGJpbmRpbmdzW2tdOyBrKyspIGJpbmRbMF0gPSBwcm9jZXNzTmFtZShiaW5kWzBdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1ha2VEZWNsYXJhdGlvbihzb3VyY2UsIGJhc2VVUkksIG9wdGlvbnMsIHNvdXJjZVVybCwgc291cmNlT3JpZ2luKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIHdhcm5zID0gW107CiAgICAgICAgdmFyIHNvdXJjZV87CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICAgIHNvdXJjZVVybDogc291cmNlVXJsLAogICAgICAgICAgYmFzZVVSSTogYmFzZVVSSSB8fCAiIiwKICAgICAgICAgIHRva2VuczogbnVsbCwKICAgICAgICAgIHJlc291cmNlczogW10sCiAgICAgICAgICBzdHlsZU5TUHJlZml4OiB7fSwKICAgICAgICAgIGRlcHM6IFtdLAogICAgICAgICAgbDEwbjogW10sCiAgICAgICAgICBkZWZpbmVzOiB7fSwKICAgICAgICAgIHVucHJlZGljdGFibGU6IHRydWUsCiAgICAgICAgICB3YXJuczogd2FybnMsCiAgICAgICAgICBpc29sYXRlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgcmVzdWx0LmRpY3RVUkkgPSBzb3VyY2VVcmwgPyBiYXNpcy5wYXRoLnJlc29sdmUoc291cmNlVXJsKSA6IGJhc2VVUkkgfHwgIiI7CiAgICAgICAgaWYgKHJlc3VsdC5kaWN0VVJJKSB7CiAgICAgICAgICB2YXIgZXh0bmFtZSA9IGJhc2lzLnBhdGguZXh0bmFtZShyZXN1bHQuZGljdFVSSSk7CiAgICAgICAgICBpZiAoZXh0bmFtZSAmJiBleHRuYW1lICE9ICIubDEwbiIpIHJlc3VsdC5kaWN0VVJJID0gcmVzdWx0LmRpY3RVUkkuc3Vic3RyKDAsIHJlc3VsdC5kaWN0VVJJLmxlbmd0aCAtIGV4dG5hbWUubGVuZ3RoKSArICIubDEwbiI7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlLnRlbXBsYXRlVG9rZW5zKSB7CiAgICAgICAgICBzb3VyY2VfID0gc291cmNlOwogICAgICAgICAgc291cmNlID0gdG9rZW5pemUoU3RyaW5nKHNvdXJjZSkpOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlLndhcm5zKSB3YXJucy5wdXNoLmFwcGx5KHdhcm5zLCBzb3VyY2Uud2FybnMpOwogICAgICAgIGluY2x1ZGVTdGFjay5wdXNoKHNvdXJjZU9yaWdpbiAhPT0gdHJ1ZSAmJiBzb3VyY2VPcmlnaW4gfHwge30pOwogICAgICAgIHJlc3VsdC50b2tlbnMgPSBwcm9jZXNzKHNvdXJjZSwgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBpbmNsdWRlU3RhY2sucG9wKCk7CiAgICAgICAgaWYgKCFyZXN1bHQudG9rZW5zKSByZXN1bHQudG9rZW5zID0gWyBbIDMsIDAsIDAsICIiIF0gXTsKICAgICAgICBpZiAoc291cmNlXykgcmVzdWx0LnRva2Vucy5zb3VyY2VfID0gc291cmNlXzsKICAgICAgICBhZGRUb2tlblJlZihyZXN1bHQudG9rZW5zWzBdLCAiZWxlbWVudCIpOwogICAgICAgIG5vcm1hbGl6ZVJlZnMocmVzdWx0LnRva2VucywgcmVzdWx0LmRpY3RVUkkpOwogICAgICAgIHJlc3VsdC51bnByZWRpY3RhYmxlID0gISFhcHBseURlZmluZXMocmVzdWx0LnRva2VucywgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBpZiAoL15bXmEtel0vaS50ZXN0KHJlc3VsdC5pc29sYXRlKSkgYmFzaXMuZGV2LmVycm9yKCJiYXNpcy50ZW1wbGF0ZTogaXNvbGF0aW9uIHByZWZpeCBgIiArIHJlc3VsdC5pc29sYXRlICsgImAgc2hvdWxkIG5vdCBzdGFydHMgd2l0aCBzeW1ib2wgb3RoZXIgdGhhbiBsZXR0ZXIsIG90aGVyd2lzZSBpdCBsZWFkcyB0byBpbmNvcnJlY3QgY3NzIGNsYXNzIG5hbWVzIGFuZCBicm9rZW4gc3R5bGVzIik7CiAgICAgICAgaWYgKGluY2x1ZGVTdGFjay5sZW5ndGggPT0gMCkgewogICAgICAgICAgaXNvbGF0ZVRva2VucyhyZXN1bHQudG9rZW5zLCByZXN1bHQuaXNvbGF0ZSB8fCAiIiwgcmVzdWx0KTsKICAgICAgICAgIGlmIChyZXN1bHQuaXNvbGF0ZSkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSByZXN1bHQucmVzb3VyY2VzW2ldOyBpKyspIGlmIChpdGVtWzFdICE9PSBzdHlsZU5hbWVzcGFjZUlzb2xhdGUpIGl0ZW1bMV0gPSByZXN1bHQuaXNvbGF0ZSArIGl0ZW1bMV07CiAgICAgICAgICByZXN1bHQucmVzb3VyY2VzID0gcmVzdWx0LnJlc291cmNlcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgICByZXR1cm4gIWJhc2lzLmFycmF5LnNlYXJjaChhcnJheSwgU3RyaW5nKGl0ZW0pLCBTdHJpbmcsIGlkeCArIDEpOwogICAgICAgICAgfSkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgdmFyIHVybCA9IGl0ZW1bMF07CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gaXRlbVsxXTsKICAgICAgICAgICAgaWYgKGlzb2xhdGUgPT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXNvbGF0ZSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVt1cmxdOwogICAgICAgICAgICBpZiAoIWlzb2xhdGUpIHJldHVybiB1cmw7CiAgICAgICAgICAgIHZhciByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlLnZpcnR1YWwoImNzcyIsICIiKS5yZWFkeShmdW5jdGlvbihjc3NSZXNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZVJlc291cmNlKCk7CiAgICAgICAgICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZChjc3NSZXNvdXJjZSwgewogICAgICAgICAgICAgICAgdXJsOiB1cmwgKyAiP2lzb2xhdGUtcHJlZml4PSIgKyBpc29sYXRlLAogICAgICAgICAgICAgICAgYmFzZVVSSTogYmFzaXMucGF0aC5kaXJuYW1lKHVybCkgKyAiLyIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBzb3VyY2VSZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHVybCkucmVhZHkoZnVuY3Rpb24oY3NzUmVzb3VyY2UpIHsKICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9IGlzb2xhdGVDc3MoY3NzUmVzb3VyY2UuY3NzVGV4dCB8fCAiIiwgaXNvbGF0ZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidG9hID09ICJmdW5jdGlvbiIpIGNzc1RleHQgKz0gIlxuLyojIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvbi9qc29uO2Jhc2U2NCwiICsgYnRvYSgneyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIicgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVybCArICciXSwnICsgJyJtYXBwaW5ncyI6IkFBQUEnICsgYmFzaXMuc3RyaW5nLnJlcGVhdCgiO0FBQ0EiLCBjc3NUZXh0LnNwbGl0KCJcbiIpLmxlbmd0aCkgKyAnIn0nKSArICIgKi8iOwogICAgICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShjc3NUZXh0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXNvdXJjZS51cmw7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlc3VsdC5kZWZpbmVzKSBpZiAoIXJlc3VsdC5kZWZpbmVzW2tleV0udXNlZCkgd2FybnMucHVzaCgiVW51c2VkIGRlZmluZSBmb3IgIiArIGtleSk7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5kZWZpbmVzOwogICAgICAgIGRlbGV0ZSByZXN1bHQubDEwblJlc29sdmVkOwogICAgICAgIGlmICghd2FybnMubGVuZ3RoKSByZXN1bHQud2FybnMgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSgpOwogICAgZnVuY3Rpb24gc3RhcnRVc2VSZXNvdXJjZSh1cmkpIHsKICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJpKS5mZXRjaCgpOwogICAgICBpZiAodHlwZW9mIHJlc291cmNlLnN0YXJ0VXNlID09ICJmdW5jdGlvbiIpIHJlc291cmNlLnN0YXJ0VXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wVXNlUmVzb3VyY2UodXJpKSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHVyaSkuZmV0Y2goKTsKICAgICAgaWYgKHR5cGVvZiByZXNvdXJjZS5zdG9wVXNlID09ICJmdW5jdGlvbiIpIHJlc291cmNlLnN0b3BVc2UoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHRlbXBsYXRlU291cmNlVXBkYXRlKCkgewogICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICBmb3IgKHZhciBpID0gMCwgYXR0YWNoOyBhdHRhY2ggPSB0aGlzLmF0dGFjaGVzX1tpXTsgaSsrKSBhdHRhY2guaGFuZGxlci5jYWxsKGF0dGFjaC5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVjbChhcnJheSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGlmIChhcnJheS5zb3VyY2VfKSByZXN1bHQuc291cmNlXyA9IGFycmF5LnNvdXJjZV87CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHJlc3VsdC5wdXNoKEFycmF5LmlzQXJyYXkoYXJyYXlbaV0pID8gY2xvbmVEZWNsKGFycmF5W2ldKSA6IGFycmF5W2ldKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlY2xGcm9tU291cmNlKHNvdXJjZSwgYmFzZVVSSSwgY2xvbmUsIG9wdGlvbnMpIHsKICAgICAgdmFyIHJlc3VsdCA9IHNvdXJjZTsKICAgICAgdmFyIHNvdXJjZVVybDsKICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gImZ1bmN0aW9uIikgewogICAgICAgIGJhc2VVUkkgPSAiYmFzZVVSSSIgaW4gc291cmNlID8gc291cmNlLmJhc2VVUkkgOiBiYXNlVVJJOwogICAgICAgIHNvdXJjZVVybCA9ICJ1cmwiIGluIHNvdXJjZSA/IHNvdXJjZS51cmwgOiBzb3VyY2VVcmw7CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0KCk7CiAgICAgIH0KICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQuZ2V0KCk7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkgewogICAgICAgIGlmIChjbG9uZSkgcmVzdWx0ID0gY2xvbmVEZWNsKHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgdG9rZW5zOiByZXN1bHQKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ICE9ICJvYmplY3QiIHx8ICFBcnJheS5pc0FycmF5KHJlc3VsdC50b2tlbnMpKSByZXN1bHQgPSBTdHJpbmcocmVzdWx0KTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAic3RyaW5nIikgcmVzdWx0ID0gbWFrZURlY2xhcmF0aW9uKHJlc3VsdCwgYmFzZVVSSSwgb3B0aW9ucywgc291cmNlVXJsLCBzb3VyY2UpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gbDEwbkhhbmRsZXIodmFsdWUpIHsKICAgICAgaWYgKHRoaXMudHlwZSAhPSAibWFya3VwIiAmJiB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcy50ZW1wbGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGJ1aWxkVGVtcGxhdGUoKSB7CiAgICAgIHZhciBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UodGhpcy5zb3VyY2UsIHRoaXMuYmFzZVVSSSwgZmFsc2UsIHsKICAgICAgICBpc29sYXRlOiB0aGlzLmdldElzb2xhdGVQcmVmaXgoKQogICAgICB9KTsKICAgICAgdmFyIGRlc3Ryb3lCdWlsZGVyID0gdGhpcy5kZXN0cm95QnVpbGRlcjsKICAgICAgdmFyIGZ1bmNzID0gdGhpcy5idWlsZGVyKGRlY2wudG9rZW5zLCB0aGlzKTsKICAgICAgdmFyIGRlcHMgPSB0aGlzLmRlcHNfOwogICAgICB2YXIgbDEwbiA9IHRoaXMubDEwbl87CiAgICAgIGlmIChkZXBzKSB7CiAgICAgICAgdGhpcy5kZXBzXyA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGRlcDsgZGVwID0gZGVwc1tpXTsgaSsrKSBkZXAuYmluZGluZ0JyaWRnZS5kZXRhY2goZGVwLCBidWlsZFRlbXBsYXRlLCB0aGlzKTsKICAgICAgfQogICAgICBpZiAobDEwbikgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBsMTBuW2ldOyBpKyspIGl0ZW0udG9rZW4uYmluZGluZ0JyaWRnZS5kZXRhY2goaXRlbS50b2tlbiwgbDEwbkhhbmRsZXIsIGl0ZW0pOwogICAgICBpZiAoZGVjbC5kZXBzICYmIGRlY2wuZGVwcy5sZW5ndGgpIHsKICAgICAgICBkZXBzID0gZGVjbC5kZXBzOwogICAgICAgIHRoaXMuZGVwc18gPSBkZXBzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZXA7IGRlcCA9IGRlcHNbaV07IGkrKykgZGVwLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKGRlcCwgYnVpbGRUZW1wbGF0ZSwgdGhpcyk7CiAgICAgIH0KICAgICAgaWYgKGRlY2wubDEwbikgewogICAgICAgIGwxMG4gPSBkZWNsLmwxMG47CiAgICAgICAgdGhpcy5sMTBuXyA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGwxMG5baV07IGkrKykgewogICAgICAgICAgdmFyIGwxMG5Ub2tlbiA9IGJhc2lzLmwxMG4udG9rZW4oa2V5KTsKICAgICAgICAgIGwxMG5Ub2tlbi5iaW5kaW5nQnJpZGdlLmF0dGFjaChsMTBuVG9rZW4sIGwxMG5IYW5kbGVyLCB0aGlzLmwxMG5fW2tleV0gPSB7CiAgICAgICAgICAgIHRlbXBsYXRlOiB0aGlzLAogICAgICAgICAgICB0b2tlbjogbDEwblRva2VuLAogICAgICAgICAgICB0eXBlOiBsMTBuVG9rZW4udHlwZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuY3JlYXRlSW5zdGFuY2UgPSBmdW5jcy5jcmVhdGVJbnN0YW5jZTsKICAgICAgdGhpcy5jbGVhckluc3RhbmNlID0gZnVuY3MuZGVzdHJveUluc3RhbmNlOwogICAgICB0aGlzLmdldEJpbmRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmFtZXM6IGZ1bmNzLmtleXMKICAgICAgICB9OwogICAgICB9OwogICAgICB0aGlzLmRlc3Ryb3lCdWlsZGVyID0gZnVuY3MuZGVzdHJveTsKICAgICAgdGhpcy5pbnN0YW5jZXNfID0gZnVuY3MuaW5zdGFuY2VzXzsKICAgICAgdGhpcy5kZWNsXyA9IGRlY2w7CiAgICAgIHZhciBkZWNsUmVzb3VyY2VzID0gZGVjbC5yZXNvdXJjZXMgJiYgZGVjbC5yZXNvdXJjZXMubGVuZ3RoID4gMCA/IGRlY2wucmVzb3VyY2VzIDogbnVsbDsKICAgICAgaWYgKGRlY2xSZXNvdXJjZXMpIGZvciAodmFyIGkgPSAwLCByZXM7IHJlcyA9IGRlY2xSZXNvdXJjZXNbaV07IGkrKykgc3RhcnRVc2VSZXNvdXJjZShyZXMpOwogICAgICBpZiAodGhpcy5yZXNvdXJjZXMpIGZvciAodmFyIGkgPSAwLCByZXM7IHJlcyA9IHRoaXMucmVzb3VyY2VzW2ldOyBpKyspIHN0b3BVc2VSZXNvdXJjZShyZXMpOwogICAgICB0aGlzLnJlc291cmNlcyA9IGRlY2xSZXNvdXJjZXM7CiAgICAgIGlmIChkZXN0cm95QnVpbGRlcikgZGVzdHJveUJ1aWxkZXIodHJ1ZSk7CiAgICB9CiAgICB2YXIgc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzID0ge307CiAgICBmdW5jdGlvbiBnZXRUZW1wbGF0ZUJ5RG9jdW1lbnRJZChpZCkgewogICAgICB2YXIgcmVzb2x2ZXIgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKGlkKTsKICAgICAgaWYgKHJlc29sdmVyLnRlbXBsYXRlKSByZXR1cm4gcmVzb2x2ZXIudGVtcGxhdGU7CiAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICB2YXIgc291cmNlID0gIiI7CiAgICAgIGlmIChob3N0ICYmIGhvc3QudGFnTmFtZSA9PSAiU0NSSVBUIiAmJiBob3N0LnR5cGUgPT0gInRleHQvYmFzaXMtdGVtcGxhdGUiKSBzb3VyY2UgPSBob3N0LnRleHRDb250ZW50IHx8IGhvc3QudGV4dDsgZWxzZSBpZiAoIWhvc3QpIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBzY3JpcHQgZWxlbWVudCB3aXRoIGlkIGAiICsgaWQgKyAiYCBub3QgZm91bmQiKTsgZWxzZSBiYXNpcy5kZXYud2FybignVGVtcGxhdGUgc2hvdWxkIGJlIGRlY2xhcmVkIGluIDxzY3JpcHQgdHlwZT0idGV4dC9iYXNpcy10ZW1wbGF0ZSI+IGVsZW1lbnQgKGlkIGAnICsgc291cmNlSWQgKyAiYCkiKTsKICAgICAgcmV0dXJuIHJlc29sdmVyLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHNvdXJjZUlkKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHNvdXJjZUJ5RG9jdW1lbnRJZFJlc29sdmVyc1tzb3VyY2VJZF07CiAgICAgIGlmICghcmVzb2x2ZXIpIHsKICAgICAgICByZXNvbHZlciA9IHNvdXJjZUJ5RG9jdW1lbnRJZFJlc29sdmVyc1tzb3VyY2VJZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBnZXRUZW1wbGF0ZUJ5RG9jdW1lbnRJZChzb3VyY2VJZCkuc291cmNlOwogICAgICAgIH07CiAgICAgICAgcmVzb2x2ZXIuaWQgPSBzb3VyY2VJZDsKICAgICAgICByZXNvbHZlci51cmwgPSAnPHNjcmlwdCBpZD0iJyArIHNvdXJjZUlkICsgJyIvPic7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc29sdmVyOwogICAgfQogICAgdmFyIFRlbXBsYXRlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZTogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBpZiAodGVtcGxhdGVMaXN0Lmxlbmd0aCA9PSA0MDk2KSB0aHJvdyAiVG9vIG1hbnkgdGVtcGxhdGVzIChtYXhpbXVtIDQwOTYpIjsKICAgICAgICB0aGlzLmF0dGFjaGVzXyA9IFtdOwogICAgICAgIHRoaXMuc2V0U291cmNlKHNvdXJjZSB8fCAiIik7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUlkID0gdGVtcGxhdGVMaXN0LnB1c2godGhpcykgLSAxOwogICAgICB9LAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgcmV0dXJuOwogICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnB1c2goewogICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24odGVtcGxhdGUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaXN0ZW5lcjsgbGlzdGVuZXIgPSB0ZW1wbGF0ZS5hdHRhY2hlc19baV07IGkrKykgaWYgKGxpc3RlbmVyLmhhbmRsZXIgPT0gaGFuZGxlciAmJiBsaXN0ZW5lci5jb250ZXh0ID09IGNvbnRleHQpIHsKICAgICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHt9CiAgICAgIH0sCiAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5zdGFuY2Uob2JqZWN0LCBhY3Rpb25DYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkge30sCiAgICAgIGdldElzb2xhdGVQcmVmaXg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiaSIgKyB0aGlzLnRlbXBsYXRlSWQgKyAiX18iOwogICAgICB9LAogICAgICBnZXRCaW5kaW5nOiBmdW5jdGlvbihiaW5kaW5ncykgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5nZXRCaW5kaW5nKGJpbmRpbmdzKTsKICAgICAgfSwKICAgICAgc2V0U291cmNlOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgb2xkU291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgaWYgKG9sZFNvdXJjZSAhPSBzb3VyY2UpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHZhciBtID0gc291cmNlLm1hdGNoKC9eKFthLXpdKyk6Lyk7CiAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IG1bMV07CiAgICAgICAgICAgICAgc291cmNlID0gc291cmNlLnN1YnN0cihtWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgc3dpdGNoIChwcmVmaXgpIHsKICAgICAgICAgICAgICAgIGNhc2UgImZpbGUiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZShzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImlkIjoKICAgICAgICAgICAgICAgICAgc291cmNlID0gcmVzb2x2ZVNvdXJjZUJ5RG9jdW1lbnRJZChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInRva2VucyI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnN0cmluZy50b09iamVjdChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBzb3VyY2UuaXNEZWNsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyYXciOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInBhdGgiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgoc291cmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLlRlbXBsYXRlLnNldFNvdXJjZTogVW5rbm93biBwcmVmaXggIiArIHByZWZpeCArICIgZm9yIHRlbXBsYXRlIHNvdXJjZSB3YXMgaW5nbm9yZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU291cmNlICYmIG9sZFNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIHZhciB0bXBsTGlzdCA9IG9sZFNvdXJjZS51cmwgJiYgdG1wbEZpbGVzTWFwW29sZFNvdXJjZS51cmxdOwogICAgICAgICAgICBpZiAodG1wbExpc3QpIHsKICAgICAgICAgICAgICBhcnJheVJlbW92ZSh0bXBsTGlzdCwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0bXBsTGlzdC5sZW5ndGgpIGRlbGV0ZSB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gIiI7CiAgICAgICAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZFNvdXJjZSwgdGVtcGxhdGVTb3VyY2VVcGRhdGUsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgICBpZiAoc291cmNlLnVybCkgewogICAgICAgICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGguZGlybmFtZShzb3VyY2UudXJsKSArICIvIjsKICAgICAgICAgICAgICBpZiAoIXRtcGxGaWxlc01hcFtzb3VyY2UudXJsXSkgdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdID0gW107CiAgICAgICAgICAgICAgYXJyYXlBZGQodG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UuYmluZGluZ0JyaWRnZS5hdHRhY2goc291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIHRlbXBsYXRlU291cmNlVXBkYXRlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgdGhpcy5kZXN0cm95QnVpbGRlcigpOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB0aGlzLmdldEJpbmRpbmcgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnN0YW5jZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmRlY2xfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCBjb25maWcpOwogICAgfTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHJ1bGVSZXRfOiBudWxsLAogICAgICB0ZW1wbGF0ZXNfOiBudWxsLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBUZW1wbGF0ZSwKICAgICAgcnVsZUV2ZW50czogbnVsbCwKICAgICAgcnVsZTogU3RyaW5nLAogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICB0aGlzLnJ1bGVSZXRfID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZXNfID0gW107CiAgICAgICAgdGhpcy5ydWxlID0gY29uZmlnLnJ1bGU7CiAgICAgICAgdmFyIGV2ZW50cyA9IGNvbmZpZy5ldmVudHM7CiAgICAgICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnJ1bGVFdmVudHMgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSB0aGlzLnJ1bGVFdmVudHNbZXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGNsZWFuZXIuYWRkKHRoaXMpOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB2YXIgcmV0ID0gdGhpcy5ydWxlKG9iamVjdCk7CiAgICAgICAgdmFyIGlkeCA9IHRoaXMucnVsZVJldF8uaW5kZXhPZihyZXQpOwogICAgICAgIGlmIChpZHggPT0gLTEpIHsKICAgICAgICAgIHRoaXMucnVsZVJldF8ucHVzaChyZXQpOwogICAgICAgICAgaWR4ID0gdGhpcy50ZW1wbGF0ZXNfLnB1c2gobmV3IHRoaXMudGVtcGxhdGVDbGFzcyhyZXQpKSAtIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc19baWR4XTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5ydWxlID0gbnVsbDsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBudWxsOwogICAgICAgIHRoaXMucnVsZVJldF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHN3aXRjaGVyKGV2ZW50cywgcnVsZSkgewogICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgIHZhciBydWxlID0gYXJncy5wb3AoKTsKICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaENvbmZpZyh7CiAgICAgICAgcnVsZTogcnVsZSwKICAgICAgICBldmVudHM6IGFyZ3Muam9pbigiICIpLnRyaW0oKS5zcGxpdCgvXHMrLykKICAgICAgfSk7CiAgICB9CiAgICB2YXIgVGhlbWUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UaGVtZSIsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoCiAgICB9KTsKICAgIHZhciBTb3VyY2VXcmFwcGVyID0gQ2xhc3MoYmFzaXMuVG9rZW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlNvdXJjZVdyYXBwZXIiLAogICAgICBwYXRoOiAiIiwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlLCBwYXRoKSB7CiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsICIiKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UgPyB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZ2V0KHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudCA9IGdldFRoZW1lU291cmNlKGN1cnJlbnRUaGVtZU5hbWUsIHRoaXMucGF0aCk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT0gY29udGVudCkgewogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMudmFsdWUgPSBjb250ZW50OwogICAgICAgICAgdGhpcy51cmwgPSBjb250ZW50ICYmIGNvbnRlbnQudXJsIHx8ICIiOwogICAgICAgICAgdGhpcy5iYXNlVVJJID0gKHR5cGVvZiBjb250ZW50ID09ICJvYmplY3QiIHx8IHR5cGVvZiBjb250ZW50ID09ICJmdW5jdGlvbiIpICYmICJiYXNlVVJJIiBpbiBjb250ZW50ID8gY29udGVudC5iYXNlVVJJIDogcGF0aC5kaXJuYW1lKHRoaXMudXJsKSArICIvIjsKICAgICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmF0dGFjaCh0aGlzLnZhbHVlLCBTb3VyY2VXcmFwcGVyLnByb3RvdHlwZS5hcHBseSwgdGhpcyk7CiAgICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVybCA9IG51bGw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gbnVsbDsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgdGhpcy5hcHBseSwgdGhpcyk7CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBnZXRTb3VyY2VCeVBhdGgoKSB7CiAgICAgIHZhciBwYXRoID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5qb2luKCIuIik7CiAgICAgIHZhciBzb3VyY2UgPSBzb3VyY2VCeVBhdGhbcGF0aF07CiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgc291cmNlID0gbmV3IFNvdXJjZVdyYXBwZXIoIiIsIHBhdGgpOwogICAgICAgIHNvdXJjZUJ5UGF0aFtwYXRoXSA9IHNvdXJjZTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgZnVuY3Rpb24gbm9ybWFsaXplKGxpc3QpIHsKICAgICAgdmFyIHVzZWQgPSB7fTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGlmICghdXNlZFtsaXN0W2ldXSkgewogICAgICAgIHVzZWRbbGlzdFtpXV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKGxpc3RbaV0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRGYWxsYmFjayh0aGVtZU5hbWUsIGxpc3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICByZXN1bHQuc291cmNlID0gbm9ybWFsaXplKGxpc3QpLmpvaW4oIi8iKTsKICAgICAgdmFyIHVzZWQgPSB7CiAgICAgICAgYmFzZTogdHJ1ZQogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbmFtZSA9IGxpc3RbaV0gfHwgImJhc2UiOwogICAgICAgIGlmIChuYW1lID09IHRoZW1lTmFtZSB8fCB1c2VkW25hbWVdKSBjb250aW51ZTsKICAgICAgICB2YXIgdGhlbWUgPSBnZXRUaGVtZShuYW1lKTsKICAgICAgICB1c2VkW25hbWVdID0gdHJ1ZTsKICAgICAgICByZXN1bHQucHVzaChuYW1lKTsKICAgICAgICBsaXN0LnNwbGljZS5hcHBseShsaXN0LCBbIGkgKyAxLCAwIF0uY29uY2F0KHRoZW1lc1tuYW1lXS5mYWxsYmFjaykpOwogICAgICB9CiAgICAgIHJlc3VsdC51bnNoaWZ0KHRoZW1lTmFtZSk7CiAgICAgIGlmICh0aGVtZU5hbWUgIT0gImJhc2UiKSByZXN1bHQucHVzaCgiYmFzZSIpOwogICAgICByZXN1bHQudmFsdWUgPSByZXN1bHQuam9pbigiLyIpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgewogICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1tuYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIG1hcDsgbWFwID0gc291cmNlTGlzdFtpXTsgaSsrKSBpZiAobWFwLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gbWFwW3BhdGhdOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiB0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpIHsKICAgICAgcmV0dXJuIHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjay5pbmRleE9mKHRoZW1lTmFtZSkgIT0gLTE7CiAgICB9CiAgICBmdW5jdGlvbiBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKSB7CiAgICAgIGdldFNvdXJjZUJ5UGF0aChwYXRoKS5zZXQoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWUoY2hhbmdlZCkgewogICAgICBiYXNpcy5kZXYubG9nKCJyZS1hcHBseSB0ZW1wbGF0ZXMiKTsKICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWUobmFtZSkgewogICAgICBpZiAoIW5hbWUpIG5hbWUgPSAiYmFzZSI7CiAgICAgIGlmICh0aGVtZXNbbmFtZV0pIHJldHVybiB0aGVtZXNbbmFtZV0udGhlbWU7CiAgICAgIGlmICghL14oW2EtejAtOVxfXC1dKykkLy50ZXN0KG5hbWUpKSB0aHJvdyAiQmFkIG5hbWUgZm9yIHRoZW1lIC0gIiArIG5hbWU7CiAgICAgIHZhciBzb3VyY2VzID0ge307CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gWyBzb3VyY2VzIF07CiAgICAgIHZhciB0aGVtZUludGVyZmFjZSA9IG5ldyBUaGVtZTsKICAgICAgdGhlbWVzW25hbWVdID0gewogICAgICAgIHRoZW1lOiB0aGVtZUludGVyZmFjZSwKICAgICAgICBzb3VyY2VzOiBzb3VyY2VzLAogICAgICAgIHNvdXJjZXNMaXN0OiBzb3VyY2VMaXN0LAogICAgICAgIGZhbGxiYWNrOiBbXQogICAgICB9OwogICAgICB2YXIgYWRkU291cmNlID0gZnVuY3Rpb24ocGF0aCwgc291cmNlKSB7CiAgICAgICAgaWYgKHBhdGggaW4gc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgc291cmNlc1twYXRoXSA9IHNvdXJjZTsKICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgfSBlbHNlIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBwYXRoIGAiICsgcGF0aCArICJgIGlzIGFscmVhZHkgZGVmaW5lZCBmb3IgdGhlbWUgYCIgKyBuYW1lICsgImAgKGRlZmluaXRpb24gaWdub3JlZCkuIik7CiAgICAgICAgcmV0dXJuIGdldFNvdXJjZUJ5UGF0aChwYXRoKTsKICAgICAgfTsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGVtZUludGVyZmFjZSwgewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgZmFsbGJhY2s6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhlbWVJbnRlcmZhY2UgIT09IGJhc2VUaGVtZSAmJiBhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV3RmFsbGJhY2sgPSB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiLyIpIDogW107CiAgICAgICAgICAgIHZhciBjaGFuZ2VkID0ge307CiAgICAgICAgICAgIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgbmV3RmFsbGJhY2spOwogICAgICAgICAgICBpZiAodGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZSAhPSBuZXdGYWxsYmFjay5zb3VyY2UpIHsKICAgICAgICAgICAgICB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlID0gbmV3RmFsbGJhY2suc291cmNlOwogICAgICAgICAgICAgIGJhc2lzLmRldi5sb2coImZhbGxiYWNrIGNoYW5nZWQiKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gdGhlbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyRmFsbGJhY2sgPSB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgKGN1ckZhbGxiYWNrLnNvdXJjZSB8fCAiIikuc3BsaXQoIi8iKSk7CiAgICAgICAgICAgICAgICBpZiAobmV3RmFsbGJhY2sudmFsdWUgIT0gY3VyRmFsbGJhY2sudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY2hhbmdlZFt0aGVtZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbWVzW3RoZW1lTmFtZV0uZmFsbGJhY2sgPSBuZXdGYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZUxpc3QgPSB0aGVtZXNbdGhlbWVOYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgICAgICAgICAgICAgc291cmNlTGlzdC5sZW5ndGggPSBuZXdGYWxsYmFjay5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlTGlzdC5sZW5ndGg7IGkrKykgc291cmNlTGlzdFtpXSA9IHRoZW1lc1tuZXdGYWxsYmFja1tpXV0uc291cmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFjayA9IHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgZm9yICh2YXIgdGhlbWVOYW1lIGluIGNoYW5nZWQpIHsKICAgICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QodGhlbWVOYW1lKSkgewogICAgICAgICAgICAgICAgc3luY0N1cnJlbnRUaGVtZSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNsaWNlKDEpOwogICAgICAgICAgcmVzdWx0LnNvdXJjZSA9IHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgZGVmaW5lOiBmdW5jdGlvbih3aGF0LCB3aGVyZXdpdGgpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAiZnVuY3Rpb24iKSB3aGF0ID0gd2hhdCgpOwogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hlcmV3aXRoID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHdoYXQ7CiAgICAgICAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSB3aGVyZXdpdGg7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXN1bHRba2V5XSA9IGFkZFNvdXJjZShuYW1lc3BhY2UgKyAiLiIgKyBrZXksIGRpY3Rpb25hcnlba2V5XSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHdoYXQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWRkU291cmNlKHdoYXQsIHdoZXJld2l0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoYXQ7CiAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgYWRkU291cmNlKHBhdGgsIGRpY3Rpb25hcnlbcGF0aF0pOwogICAgICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZmlyc3QgYXJndW1lbnQgZm9yIGJhc2lzLnRlbXBsYXRlLlRoZW1lI2RlZmluZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobmFtZSAhPSBjdXJyZW50VGhlbWVOYW1lKSB7CiAgICAgICAgICAgIGN1cnJlbnRUaGVtZU5hbWUgPSBuYW1lOwogICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBoYW5kbGVyOyBoYW5kbGVyID0gdGhlbWVDaGFuZ2VIYW5kbGVyc1tpXTsgaSsrKSBoYW5kbGVyLmZuLmNhbGwoaGFuZGxlci5jb250ZXh0LCBuYW1lKTsKICAgICAgICAgICAgYmFzaXMuZGV2LmluZm8oIlRlbXBsYXRlIHRoZW1lIHN3aXRjaGVkIHRvIGAiICsgbmFtZSArICJgIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICAgICAgfSwKICAgICAgICBnZXRTb3VyY2U6IGZ1bmN0aW9uKHBhdGgsIHdpdGhGYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHdpdGhGYWxsYmFjayA/IGdldFRoZW1lU291cmNlKG5hbWUsIHBhdGgpIDogc291cmNlc1twYXRoXTsKICAgICAgICB9LAogICAgICAgIGRyb3A6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgIGlmIChzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGgpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2VzW3BhdGhdOwogICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QobmFtZSkpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKG5hbWUsIFtdKTsKICAgICAgc291cmNlTGlzdC5wdXNoKHRoZW1lcy5iYXNlLnNvdXJjZXMpOwogICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICB9CiAgICB2YXIgdGhlbWVzID0ge307CiAgICB2YXIgc291cmNlQnlQYXRoID0ge307CiAgICB2YXIgYmFzZVRoZW1lID0gZ2V0VGhlbWUoKTsKICAgIHZhciBjdXJyZW50VGhlbWVOYW1lID0gImJhc2UiOwogICAgdmFyIHRoZW1lQ2hhbmdlSGFuZGxlcnMgPSBbXTsKICAgIGZ1bmN0aW9uIG9uVGhlbWVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgdGhlbWVDaGFuZ2VIYW5kbGVycy5wdXNoKHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudFRoZW1lTmFtZSk7CiAgICB9CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIHBhdGggaW4gc291cmNlQnlQYXRoKSBzb3VyY2VCeVBhdGhbcGF0aF0uZGVzdHJveSgpOwogICAgICAgIHRoZW1lcyA9IG51bGw7CiAgICAgICAgc291cmNlQnlQYXRoID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdGVtcGxhdGU7IHRlbXBsYXRlID0gdGVtcGxhdGVMaXN0W2ldOyBpKyspIHRlbXBsYXRlLmRlc3Ryb3koKTsKICAgICAgICB0ZW1wbGF0ZUxpc3QgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUNMQVJBVElPTl9WRVJTSU9OOiBERUNMQVJBVElPTl9WRVJTSU9OLAogICAgICBUWVBFX0VMRU1FTlQ6IFRZUEVfRUxFTUVOVCwKICAgICAgVFlQRV9BVFRSSUJVVEU6IFRZUEVfQVRUUklCVVRFLAogICAgICBUWVBFX0FUVFJJQlVURV9DTEFTUzogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIFRZUEVfQVRUUklCVVRFX1NUWUxFOiBUWVBFX0FUVFJJQlVURV9TVFlMRSwKICAgICAgVFlQRV9BVFRSSUJVVEVfRVZFTlQ6IFRZUEVfQVRUUklCVVRFX0VWRU5ULAogICAgICBUWVBFX1RFWFQ6IFRZUEVfVEVYVCwKICAgICAgVFlQRV9DT01NRU5UOiBUWVBFX0NPTU1FTlQsCiAgICAgIFRPS0VOX1RZUEU6IFRPS0VOX1RZUEUsCiAgICAgIFRPS0VOX0JJTkRJTkdTOiBUT0tFTl9CSU5ESU5HUywKICAgICAgVE9LRU5fUkVGUzogVE9LRU5fUkVGUywKICAgICAgQVRUUl9OQU1FOiBBVFRSX05BTUUsCiAgICAgIEFUVFJfVkFMVUU6IEFUVFJfVkFMVUUsCiAgICAgIEFUVFJfTkFNRV9CWV9UWVBFOiBBVFRSX05BTUVfQllfVFlQRSwKICAgICAgRUxFTUVOVF9OQU1FOiBFTEVNRU5UX05BTUUsCiAgICAgIEVMRU1FTlRfQVRUUlM6IEVMRU1FTlRfQVRUUlMsCiAgICAgIEVMRU1FTlRfQ0hJTERTOiBFTEVNRU5UX0NISUxEUywKICAgICAgVEVYVF9WQUxVRTogVEVYVF9WQUxVRSwKICAgICAgQ09NTUVOVF9WQUxVRTogQ09NTUVOVF9WQUxVRSwKICAgICAgTDEwblByb3h5VG9rZW46IEwxMG5Qcm94eVRva2VuLAogICAgICBUZW1wbGF0ZVN3aXRjaENvbmZpZzogVGVtcGxhdGVTd2l0Y2hDb25maWcsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IFRlbXBsYXRlU3dpdGNoZXIsCiAgICAgIFRlbXBsYXRlOiBUZW1wbGF0ZSwKICAgICAgU291cmNlV3JhcHBlcjogU291cmNlV3JhcHBlciwKICAgICAgc3dpdGNoZXI6IHN3aXRjaGVyLAogICAgICB0b2tlbml6ZTogdG9rZW5pemUsCiAgICAgIGlzb2xhdGVDc3M6IGlzb2xhdGVDc3MsCiAgICAgIGdldERlY2xGcm9tU291cmNlOiBnZXREZWNsRnJvbVNvdXJjZSwKICAgICAgbWFrZURlY2xhcmF0aW9uOiBtYWtlRGVjbGFyYXRpb24sCiAgICAgIGdldEwxMG5UZW1wbGF0ZTogZ2V0TDEwblRlbXBsYXRlLAogICAgICBUaGVtZTogVGhlbWUsCiAgICAgIHRoZW1lOiBnZXRUaGVtZSwKICAgICAgZ2V0VGhlbWVMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXModGhlbWVzKTsKICAgICAgfSwKICAgICAgY3VycmVudFRoZW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLnRoZW1lOwogICAgICB9LAogICAgICBzZXRUaGVtZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBnZXRUaGVtZShuYW1lKS5hcHBseSgpOwogICAgICB9LAogICAgICBvblRoZW1lQ2hhbmdlOiBvblRoZW1lQ2hhbmdlLAogICAgICBkZWZpbmU6IGJhc2VUaGVtZS5kZWZpbmUsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoLAogICAgICBnZXRQYXRoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLm9iamVjdC5rZXlzKHNvdXJjZUJ5UGF0aCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9FTEVNRU5UOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gYmFzaXMudGVtcGxhdGUuVFlQRV9BVFRSSUJVVEU7CiAgICB2YXIgVFlQRV9URVhUID0gYmFzaXMudGVtcGxhdGUuVFlQRV9URVhUOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQ09NTUVOVDsKICAgIHZhciBUT0tFTl9UWVBFID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fVFlQRTsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX0JJTkRJTkdTOwogICAgdmFyIFRPS0VOX1JFRlMgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9SRUZTOwogICAgdmFyIEFUVFJfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRTsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRV9CWV9UWVBFOwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfTkFNRTsKICAgIHZhciBFTEVNRU5UX0FUVFJTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9BVFRSUzsKICAgIHZhciBFTEVNRU5UX0NISUxEUyA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfQ0hJTERTOwogICAgdmFyIFRFWFRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5URVhUX1ZBTFVFOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5DT01NRU5UX1ZBTFVFOwogICAgdmFyIHRtcGxGdW5jdGlvbnMgPSB7fTsKICAgIHZhciBpbmxpbmVTZWVkID0gMTsKICAgIHZhciBidWlsZFBhdGhlcyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgUEFUSF9SRUZfTkFNRSA9ICJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ekFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaIi5zcGxpdCgiIik7CiAgICAgIHZhciBwYXRoTGlzdDsKICAgICAgdmFyIHJlZkxpc3Q7CiAgICAgIHZhciBiaW5kaW5nTGlzdDsKICAgICAgdmFyIG1hcmtlZEVsZW1lbnRMaXN0OwogICAgICB2YXIgcm9vdFBhdGg7CiAgICAgIHZhciBhdHRyRXhwcklkOwogICAgICBmdW5jdGlvbiBwdXRSZWZzKHJlZnMsIHBhdGhJZHgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgcmVmTmFtZTsgcmVmTmFtZSA9IHJlZnNbaV07IGkrKykgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpID09IC0xKSByZWZMaXN0LnB1c2gocmVmTmFtZSArICI6IiArIHBhdGhJZHgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHB1dFBhdGgocGF0aCkgewogICAgICAgIHZhciBsZW4gPSBwYXRoTGlzdC5sZW5ndGg7CiAgICAgICAgdmFyIHBhdGhSZWYgPSBQQVRIX1JFRl9OQU1FW2xlbl0gfHwgInIiICsgbGVuOwogICAgICAgIHBhdGhMaXN0LnB1c2gocGF0aFJlZiArICI9IiArIHBhdGgpOwogICAgICAgIHJldHVybiBwYXRoUmVmOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHB1dEJpbmRpbmcoYmluZGluZykgewogICAgICAgIGJpbmRpbmdMaXN0LnB1c2goYmluZGluZyk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgICB2YXIgbG9jYWxQYXRoOwogICAgICAgIHZhciByZWZzOwogICAgICAgIHZhciBteVJlZjsKICAgICAgICB2YXIgZXhwbGljaXRSZWY7CiAgICAgICAgdmFyIGJpbmRpbmdzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjcCA9IDAsIGNsb3NlVGV4dCA9IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrLCBjcCsrLCBleHBsaWNpdFJlZiA9IGZhbHNlKSB7CiAgICAgICAgICBpZiAoIWkpIGxvY2FsUGF0aCA9IHBhdGggKyAiLmZpcnN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgaWYgKCF0b2tlbnNbaSArIDFdKSBsb2NhbFBhdGggPSBwYXRoICsgIi5sYXN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gdG9rZW5zW2kgLSAxXVtUT0tFTl9UWVBFXSAmJiB0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQpIGNsb3NlVGV4dCsrOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHBhdGggKyAiLmNoaWxkTm9kZXNbIiArIChub1RleHRCdWcgPyBjcCA6IGNwICsgKGNsb3NlVGV4dCA/ICIgKyAiICsgY2xvc2VUZXh0ICsgIiAqIFRFWFRfQlVHIiA6ICIiKSkgKyAiXSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWZzID0gdG9rZW5bVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIHB1dFJlZnMocmVmcywgbG9jYWxQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXVt0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxXTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHV0QmluZGluZyhbIHRva2VuW1RPS0VOX1RZUEVdLCBsb2NhbFBhdGgsIHRva2VuW1RPS0VOX0JJTkRJTkdTXSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgbXlSZWYgPSAtMTsKICAgICAgICAgICAgaWYgKHBhdGggPT0gcm9vdFBhdGgpIG1hcmtlZEVsZW1lbnRMaXN0LnB1c2gobG9jYWxQYXRoICsgIi4iICsgdGVtcGxhdGVNYXJrZXIpOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmKSB7CiAgICAgICAgICAgICAgbG9jYWxQYXRoID0gcHV0UGF0aChsb2NhbFBhdGgpOwogICAgICAgICAgICAgIG15UmVmID0gcGF0aExpc3QubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhdHRycyA9IFtdOwogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IEVMRU1FTlRfQVRUUlMsIHQ7IHQgPSB0b2tlbltqXTsgaisrKSBpZiAodFtUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQgfHwgdFtUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQgfHwgdFtUT0tFTl9UWVBFXSA9PSBUWVBFX0NPTU1FTlQpIGNoaWxkcmVuLnB1c2godCk7IGVsc2UgYXR0cnMucHVzaCh0KTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJbVE9LRU5fVFlQRV0gPT0gNikgY29udGludWU7CiAgICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gQVRUUl9OQU1FX0JZX1RZUEVbYXR0cltUT0tFTl9UWVBFXV0gfHwgYXR0cltBVFRSX05BTUVdOwogICAgICAgICAgICAgIGlmIChyZWZzID0gYXR0cltUT0tFTl9SRUZTXSkgewogICAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgICAgcHV0UmVmcyhyZWZzLCBwdXRQYXRoKGxvY2FsUGF0aCArICcuZ2V0QXR0cmlidXRlTm9kZSgiJyArIGF0dHJOYW1lICsgJyIpJykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYmluZGluZ3MgPSBhdHRyW1RPS0VOX0JJTkRJTkdTXSkgewogICAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpdGNoIChhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmRpbmc7IGJpbmRpbmcgPSBiaW5kaW5nc1trXTsgaysrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kaW5nWzFdLCBhdHRyTmFtZSwgYmluZGluZ1swXSBdLmNvbmNhdChiaW5kaW5nLnNsaWNlKDIpKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgcHJvcGVydHk7IHByb3BlcnR5ID0gYmluZGluZ3Nba107IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgYXR0ckV4cHJJZCsrOwogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IDAsIGJpbmROYW1lOyBiaW5kTmFtZSA9IHByb3BlcnR5WzBdW21dOyBtKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmROYW1lLCBhdHRyTmFtZSwgcHJvcGVydHlbMF0sIHByb3BlcnR5WzFdLCBwcm9wZXJ0eVsyXSwgcHJvcGVydHlbM10sIGF0dHJFeHBySWQgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGF0dHJFeHBySWQrKzsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgYmluZE5hbWU7IGJpbmROYW1lID0gYmluZGluZ3NbMF1ba107IGsrKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZE5hbWUsIGF0dHJOYW1lLCBiaW5kaW5nc1swXSwgYmluZGluZ3NbMV0sIHRva2VuW0VMRU1FTlRfTkFNRV0sIGF0dHJFeHBySWQgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGgpIHByb2Nlc3NUb2tlbnMoY2hpbGRyZW4sIGxvY2FsUGF0aCwgbm9UZXh0QnVnKTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZiAmJiBteVJlZiA9PSBwYXRoTGlzdC5sZW5ndGgpIHBhdGhMaXN0LnBvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zLCBwYXRoLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKSB7CiAgICAgICAgcGF0aExpc3QgPSBbXTsKICAgICAgICByZWZMaXN0ID0gW107CiAgICAgICAgYmluZGluZ0xpc3QgPSBbXTsKICAgICAgICBtYXJrZWRFbGVtZW50TGlzdCA9IFtdOwogICAgICAgIHJvb3RQYXRoID0gcGF0aCB8fCAiXyI7CiAgICAgICAgYXR0ckV4cHJJZCA9IDA7CiAgICAgICAgcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHJvb3RQYXRoLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcGF0aDogcGF0aExpc3QsCiAgICAgICAgICByZWY6IHJlZkxpc3QsCiAgICAgICAgICBiaW5kaW5nOiBiaW5kaW5nTGlzdCwKICAgICAgICAgIG1hcmtlZEVsZW1lbnRMaXN0OiBtYXJrZWRFbGVtZW50TGlzdAogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgYnVpbGRCaW5kaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgTDEwTl9CSU5ESU5HID0gL1wuXHsoW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKVx9LzsKICAgICAgdmFyIFNQRUNJQUxfQVRUUl9NQVAgPSB7CiAgICAgICAgZGlzYWJsZWQ6ICIqIiwKICAgICAgICBjaGVja2VkOiBbICJpbnB1dCIgXSwKICAgICAgICBpbmRldGVybWluYXRlOiBbICJpbnB1dCIgXSwKICAgICAgICB2YWx1ZTogWyAiaW5wdXQiLCAidGV4dGFyZWEiLCAic2VsZWN0IiBdLAogICAgICAgIG1pbmxlbmd0aDogWyAiaW5wdXQiIF0sCiAgICAgICAgbWF4bGVuZ3RoOiBbICJpbnB1dCIgXSwKICAgICAgICByZWFkb25seTogWyAiaW5wdXQiIF0sCiAgICAgICAgc2VsZWN0ZWQ6IFsgIm9wdGlvbiIgXSwKICAgICAgICBtdWx0aXBsZTogWyAic2VsZWN0IiBdCiAgICAgIH07CiAgICAgIHZhciBTUEVDSUFMX0FUVFJfU0lOR0xFID0gewogICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgIGNoZWNrZWQ6IHRydWUsCiAgICAgICAgc2VsZWN0ZWQ6IHRydWUsCiAgICAgICAgcmVhZG9ubHk6IHRydWUsCiAgICAgICAgbXVsdGlwbGU6IHRydWUsCiAgICAgICAgaW5kZXRlcm1pbmF0ZTogdHJ1ZQogICAgICB9OwogICAgICB2YXIgYmluZEZ1bmN0aW9ucyA9IHsKICAgICAgICAxOiAiYmluZF9lbGVtZW50IiwKICAgICAgICAzOiAiYmluZF90ZXh0Tm9kZSIsCiAgICAgICAgODogImJpbmRfY29tbWVudCIKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBzcGVjaWFsLCBsMTBuKSB7CiAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBbXTsKICAgICAgICB2YXIgc3ltYm9scyA9IGJpbmRpbmdbNV07CiAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSBiaW5kaW5nWzRdOwogICAgICAgIHZhciBleHByVmFyOwogICAgICAgIHZhciBjb2xvblBvczsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN5bWJvbHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICh0eXBlb2Ygc3ltYm9sc1tqXSA9PSAic3RyaW5nIikgZXhwcmVzc2lvbi5wdXNoKCciJyArIHN5bWJvbHNbal0ucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIicpOyBlbHNlIHsKICAgICAgICAgICAgZXhwclZhciA9IGRpY3Rpb25hcnlbc3ltYm9sc1tqXV07CiAgICAgICAgICAgIGNvbG9uUG9zID0gZXhwclZhci5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgIGlmIChjb2xvblBvcyA9PSAtMSkgewogICAgICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChzcGVjaWFsID09ICJsMTBuIiA/ICcieycgKyBleHByVmFyICsgJ30iJyA6IHNwZWNpYWwgPT0gImJvb2wiID8gIihfXyIgKyBleHByVmFyICsgJ3x8IiIpJyA6ICJfXyIgKyBleHByVmFyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgYmluZGluZ05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBsMTBuUGF0aCA9IGV4cHJWYXIuc3Vic3RyKGNvbG9uUG9zICsgMSkucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICAgIGJpbmRpbmdOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAoYmluZGluZ05hbWUpIGV4cHJlc3Npb24ucHVzaChsMTBuW2V4cHJWYXIuc3Vic3RyKGNvbG9uUG9zICsgMSldKTsgZWxzZSBleHByZXNzaW9uLnB1c2goJ19fbDEwblsiJyArIGwxMG5QYXRoICsgJyJdJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV4cHJlc3Npb24ubGVuZ3RoID09IDEpIGV4cHJlc3Npb24ucHVzaCgnIiInKTsKICAgICAgICByZXR1cm4gZXhwcmVzc2lvbi5qb2luKCIrIik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgZnVuY3Rpb24gcHV0QmluZENvZGUodHlwZSkgewogICAgICAgICAgdG9vbHNVc2VkW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgIGJpbmRDb2RlLnB1c2goYmluZFZhciArICI9IiArIHR5cGUgKyAiKCIgKyBiYXNpcy5hcnJheShhcmd1bWVudHMsIDEpICsgIik7Iik7CiAgICAgICAgfQogICAgICAgIHZhciBiaW5kTWFwID0ge307CiAgICAgICAgdmFyIGJpbmRDb2RlOwogICAgICAgIHZhciBiaW5kVmFyOwogICAgICAgIHZhciB2YXJMaXN0ID0gW107CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciB2YXJOYW1lOwogICAgICAgIHZhciBsMTBuTWFwOwogICAgICAgIHZhciBsMTBuQ29tcHV0ZSA9IFtdOwogICAgICAgIHZhciBsMTBuQmluZGluZ3MgPSB7fTsKICAgICAgICB2YXIgbDEwbkJpbmRTZWVkID0gMTsKICAgICAgICB2YXIgc3BlY2lhbEF0dHI7CiAgICAgICAgdmFyIGF0dHJFeHBySWQ7CiAgICAgICAgdmFyIGF0dHJFeHByTWFwID0ge307CiAgICAgICAgdmFyIGRlYnVnTGlzdCA9IFtdOwogICAgICAgIHZhciB0b29sc1VzZWQgPSB7CiAgICAgICAgICByZXNvbHZlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgYmluZGluZzsgYmluZGluZyA9IGJpbmRpbmdzW2ldOyBpKyspIHsKICAgICAgICAgIHZhciBiaW5kVHlwZSA9IGJpbmRpbmdbMF07CiAgICAgICAgICB2YXIgZG9tUmVmID0gYmluZGluZ1sxXTsKICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRpbmdbMl07CiAgICAgICAgICBpZiAoWyAiZ2V0IiwgInNldCIsICJ0ZW1wbGF0ZUlkXyIgXS5pbmRleE9mKGJpbmROYW1lKSAhPSAtMSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmluZGluZyBuYW1lIGAiICsgYmluZE5hbWUgKyAiYCBpcyBwcm9oaWJpdGVkLCBiaW5kaW5nIGlnbm9yZWQiKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZVBhcnQgPSBiaW5kTmFtZS5zcGxpdCgiOiIpOwogICAgICAgICAgdmFyIGFuaW0gPSBuYW1lUGFydFswXSA9PSAiYW5pbSI7CiAgICAgICAgICBpZiAoYW5pbSkgYmluZE5hbWUgPSBuYW1lUGFydFsxXTsKICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV07CiAgICAgICAgICBiaW5kVmFyID0gIl8iICsgaTsKICAgICAgICAgIHZhck5hbWUgPSAiX18iICsgYmluZE5hbWU7CiAgICAgICAgICBpZiAobmFtZVBhcnRbMF0gPT0gImwxMG4iICYmIG5hbWVQYXJ0WzFdKSB7CiAgICAgICAgICAgIHZhciBsMTBuRnVsbFBhdGggPSBuYW1lUGFydFsxXTsKICAgICAgICAgICAgdmFyIGwxMG5CaW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGwxMG5OYW1lID0gbDEwbkZ1bGxQYXRoLnJlcGxhY2UoTDEwTl9CSU5ESU5HLCBmdW5jdGlvbihtLCBuYW1lKSB7CiAgICAgICAgICAgICAgbDEwbkJpbmRpbmcgPSBuYW1lOwogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChsMTBuQmluZGluZykgewogICAgICAgICAgICAgIGlmIChsMTBuRnVsbFBhdGggaW4gbDEwbkJpbmRpbmdzID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXJOYW1lID0gIiRsMTBuXyIgKyBsMTBuQmluZFNlZWQrKzsKICAgICAgICAgICAgICAgIGwxMG5CaW5kaW5nc1tsMTBuRnVsbFBhdGhdID0gdmFyTmFtZTsKICAgICAgICAgICAgICAgIGwxMG5Db21wdXRlLnB1c2goJ3NldCgiJyArIHZhck5hbWUgKyAnIiwnICsgdmFyTmFtZSArICIpIik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSArICc9dG9vbHMubDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIikuY29tcHV0ZVRva2VuKCknKTsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuQmluZGluZ107CiAgICAgICAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuQmluZGluZ10gPSBbXTsKICAgICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKCJfXyIgKyBsMTBuQmluZGluZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiaW5kQ29kZS5wdXNoKHZhck5hbWUgKyAiLnNldChfXyIgKyBsMTBuQmluZGluZyArICIpOyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBiaW5kTmFtZSA9IGwxMG5CaW5kaW5nc1tsMTBuRnVsbFBhdGhdOwogICAgICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgICAgIHZhck5hbWUgPSAiX18iICsgYmluZE5hbWU7CiAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdID0gW107CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChiaW5kVHlwZSA9PSBUWVBFX1RFWFQpIHsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGRvbVJlZik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXR0ck5hbWUgPSAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIic7CiAgICAgICAgICAgICAgICBkZWJ1Z0xpc3QucHVzaCgieyIgKyBbICdiaW5kaW5nOiInICsgbDEwbkZ1bGxQYXRoICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJhdHRyOiIgKyBhdHRyTmFtZSwgInZhbDoiICsgYmluZFZhciwgJ2F0dGFjaG1lbnQ6aW5zdGFuY2UuYXR0YWNoZXMmJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0mJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0udmFsdWUnIF0gKyAifSIpOwogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ciIsIGRvbVJlZiwgYXR0ck5hbWUsIGJpbmRWYXIsIGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWwxMG5NYXApIGwxMG5NYXAgPSB7fTsKICAgICAgICAgICAgaWYgKCFiaW5kTWFwW2wxMG5OYW1lXSkgewogICAgICAgICAgICAgIGJpbmRNYXBbbDEwbk5hbWVdID0gW107CiAgICAgICAgICAgICAgbDEwbk1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbbDEwbk5hbWVdOwogICAgICAgICAgICBiaW5kQ29kZS5sMTBuID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgJ3ZhbDpfX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScsICdhdHRhY2htZW50OmwxMG5Ub2tlbigiJyArIGwxMG5OYW1lICsgJyIpJyBdICsgIn0iKTsKICAgICAgICAgICAgICB0b29sc1VzZWQubDEwblRva2VuID0gdHJ1ZTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKGRvbVJlZiArICIubm9kZVZhbHVlPXZhbHVlOyIpOwogICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2goZG9tUmVmICsgJy5ub2RlVmFsdWU9X19sMTBuWyInICsgbDEwbk5hbWUgKyAnIl0nICsgKGwxMG5CaW5kaW5nID8gIltfXyIgKyBsMTBuQmluZGluZyArICJdIiA6ICIiKSArICI7Iik7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbDEwbk1hcFtsMTBuTmFtZV0ucHVzaCgiYmluZF9hdHRyKCIgKyBbIGRvbVJlZiwgJyInICsgYmluZGluZ1tBVFRSX05BTUVdICsgJyInLCAiTmFOIiwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAibDEwbiIsIGwxMG5CaW5kaW5ncykgXSArICIpOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWJpbmRDb2RlKSB7CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgdmFyTGlzdC5wdXNoKHZhck5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJpbmRUeXBlICE9IFRZUEVfQVRUUklCVVRFKSB7CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAidmFsOiIgKyAoYmluZENvZGUubm9kZUJpbmQgPyB2YXJOYW1lIDogYmluZFZhciksICJ1cGRhdGVzOiQkIiArIGJpbmROYW1lLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgIGlmICghYmluZENvZGUubm9kZUJpbmQpIHsKICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGRvbVJlZik7CiAgICAgICAgICAgICAgcHV0QmluZENvZGUoYmluZEZ1bmN0aW9uc1tiaW5kVHlwZV0sIGRvbVJlZiwgYmluZFZhciwgInZhbHVlIik7CiAgICAgICAgICAgICAgYmluZENvZGUubm9kZUJpbmQgPSBiaW5kVmFyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN3aXRjaCAoYmluZFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBkb21SZWYsICJ2YWx1ZSE9PW51bGw/U3RyaW5nKHZhbHVlKTpudWxsIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYmluZGluZ1tBVFRSX05BTUVdOwogICAgICAgICAgICBzd2l0Y2ggKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRFeHByID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVFeHByID0gInZhbHVlIjsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXggPSBiaW5kaW5nWzRdOwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdMZW5ndGggPSBiaW5kaW5nLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID49IDYpIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNiB8fCB0eXBlb2YgYmluZGluZ1s2XSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID09IDYpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9ICd2YWx1ZT8iJyArIGJpbmROYW1lICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZE5hbWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZGluZ1s2XSArICciOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IGJpbmRpbmdbNl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICghYmluZGluZ1s2XS5sZW5ndGgpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nTGVuZ3RoID09IDcpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9IGJpbmRpbmdbNl0ubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3ZhbHVlPT0iJyArIHZhbCArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0pLmpvaW4oInx8IikgKyAnP3ZhbHVlOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IHByZWZpeCArIGJpbmRpbmdbNl1bYmluZGluZ1s1XSAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSAiIjsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRXhwciA9IGJpbmRpbmdbNl0ubWFwKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyI/IicgKyB0aGlzW2lkeF0gKyAnIic7CiAgICAgICAgICAgICAgICAgICAgICB9LCBiaW5kaW5nWzddKS5qb2luKCI6IikgKyAnOiIiJzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWzVdKSBkZWZhdWx0RXhwciA9IGJpbmRpbmdbN11bYmluZGluZ1s1XSAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3R5cGVvZiB2YWx1ZT09InN0cmluZyJ8fHR5cGVvZiB2YWx1ZT09Im51bWJlciI/dmFsdWU6KHZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIiknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIgKyAnPSInICsgZGVmYXVsdEV4cHIgKyAnIicpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ckNsYXNzIiwgZG9tUmVmLCBiaW5kVmFyLCB2YWx1ZUV4cHIsICciJyArIHByZWZpeCArICciJywgYW5pbSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICB2YXIgZXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncyk7CiAgICAgICAgICAgICAgICBhdHRyRXhwcklkID0gYmluZGluZ1s4XTsKICAgICAgICAgICAgICAgIGlmICghYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0pIHsKICAgICAgICAgICAgICAgICAgYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0gPSBiaW5kVmFyOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIChiaW5kaW5nWzddID09ICJoaWRlIiA/ICciIicgOiAnIm5vbmUiJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbN10pIGV4cHIgPSBleHByLnJlcGxhY2UoL1wrIiIkLywgIiIpICsgKGJpbmRpbmdbN10gPT0gImhpZGUiID8gJz8ibm9uZSI6IiInIDogJz8iIjoibm9uZSInKTsKICAgICAgICAgICAgICAgIGJpbmRWYXIgPSBhdHRyRXhwck1hcFthdHRyRXhwcklkXTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKCJiaW5kX2F0dHJTdHlsZSIsIGRvbVJlZiwgJyInICsgYmluZGluZ1s2XSArICciJywgYmluZFZhciwgZXhwcik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc3BlY2lhbEF0dHIgPSBTUEVDSUFMX0FUVFJfTUFQW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgIGF0dHJFeHBySWQgPSBiaW5kaW5nWzddOwogICAgICAgICAgICAgICAgaWYgKCFhdHRyRXhwck1hcFthdHRyRXhwcklkXSkgewogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICI9IiArIGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgImwxMG4iLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgICAgYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF0gPSBiaW5kVmFyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYmluZFZhciA9IGF0dHJFeHByTWFwW2F0dHJFeHBySWRdOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0ciIsIGRvbVJlZiwgJyInICsgYXR0ck5hbWUgKyAnIicsIGJpbmRWYXIsIHNwZWNpYWxBdHRyICYmIFNQRUNJQUxfQVRUUl9TSU5HTEVbYXR0ck5hbWVdID8gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAiYm9vbCIsIGwxMG5CaW5kaW5ncykgKyAnPyInICsgYXR0ck5hbWUgKyAnIjoiIicgOiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIGZhbHNlLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWFsQXR0ciAmJiAoc3BlY2lhbEF0dHIgPT0gIioiIHx8IHNwZWNpYWxBdHRyLmluZGV4T2YoYmluZGluZ1s2XS50b0xvd2VyQ2FzZSgpKSAhPSAtMSkpIGJpbmRDb2RlLnB1c2goImlmKCIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICIhPSIgKyBiaW5kVmFyICsgIikiICsgZG9tUmVmICsgIi4iICsgYXR0ck5hbWUgKyAiPSIgKyAoU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyAiISEiICsgYmluZFZhciA6IGJpbmRWYXIpICsgIjsiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWJ1Z0xpc3QucHVzaCgieyIgKyBbICdiaW5kaW5nOiInICsgYmluZE5hbWUgKyAnIicsICJkb206IiArIGRvbVJlZiwgJ2F0dHI6IicgKyBhdHRyTmFtZSArICciJywgInZhbDoiICsgYmluZFZhciwgJ2F0dGFjaG1lbnQ6aW5zdGFuY2UuYXR0YWNoZXMmJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0mJmluc3RhbmNlLmF0dGFjaGVzWyInICsgYmluZE5hbWUgKyAnIl0udmFsdWUnIF0gKyAifSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgiO2Z1bmN0aW9uIHNldChiaW5kTmFtZSx2YWx1ZSl7IiArICdpZih0eXBlb2YgYmluZE5hbWUhPSJzdHJpbmciKScpOwogICAgICAgIGZvciAodmFyIGJpbmROYW1lIGluIGJpbmRNYXApIGlmIChiaW5kTWFwW2JpbmROYW1lXS5ub2RlQmluZCkgewogICAgICAgICAgcmVzdWx0LnB1c2goImlmKGJpbmROYW1lPT09IiArIGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kICsgIikiICsgJ2JpbmROYW1lPSInICsgYmluZE5hbWUgKyAnIjsnICsgImVsc2UgIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCJyZXR1cm47Iik7CiAgICAgICAgcmVzdWx0LnB1c2goInZhbHVlPXJlc29sdmUuY2FsbChpbnN0YW5jZSxiaW5kTmFtZSx2YWx1ZSxBdHRhY2hlcyk7IiArICJzd2l0Y2goYmluZE5hbWUpeyIpOwogICAgICAgIGZvciAodmFyIGJpbmROYW1lIGluIGJpbmRNYXApIHsKICAgICAgICAgIGlmIChiaW5kTmFtZS5pbmRleE9mKCJAIikgPT0gLTEpIHZhckxpc3QucHVzaCgiJCQiICsgYmluZE5hbWUgKyAiPTAiKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKCdjYXNlIicgKyBiaW5kTmFtZSArICciOicgKyAoYmluZE1hcFtiaW5kTmFtZV0ubDEwbiA/IGJpbmRNYXBbYmluZE5hbWVdLmpvaW4oIiIpIDogImlmKF9fIiArIGJpbmROYW1lICsgIiE9PXZhbHVlKSIgKyAieyIgKyAiJCQiICsgYmluZE5hbWUgKyAiKys7IiArICJfXyIgKyBiaW5kTmFtZSArICI9dmFsdWU7IiArIGJpbmRNYXBbYmluZE5hbWVdLmpvaW4oIiIpICsgIn0iKSArICJicmVhazsiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goIn19Iik7CiAgICAgICAgdmFyIHRvb2xzVmFyTGlzdCA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiB0b29sc1VzZWQpIHRvb2xzVmFyTGlzdC5wdXNoKGtleSArICI9dG9vbHMuIiArIGtleSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRlYnVnTGlzdDogZGVidWdMaXN0LAogICAgICAgICAga2V5czogYmFzaXMub2JqZWN0LmtleXMoYmluZE1hcCkuZmlsdGVyKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICByZXR1cm4ga2V5LmluZGV4T2YoIkAiKSA9PSAtMTsKICAgICAgICAgIH0pLAogICAgICAgICAgdG9vbHM6IHRvb2xzVmFyTGlzdCwKICAgICAgICAgIHZhcnM6IHZhckxpc3QsCiAgICAgICAgICBzZXQ6IHJlc3VsdC5qb2luKCIiKSwKICAgICAgICAgIGwxMG46IGwxMG5NYXAsCiAgICAgICAgICBsMTBuQ29tcHV0ZTogbDEwbkNvbXB1dGUKICAgICAgICB9OwogICAgICB9OwogICAgfSgpOwogICAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKGFyZ3MsIGJvZHkpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGFyZ3MsIGJvZHkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2LmVycm9yKCJDYW4ndCBidWlsZCB0ZW1wbGF0ZSBmdW5jdGlvbjogIiArIGUgKyAiXG4iLCAiZnVuY3Rpb24oIiArIGFyZ3MgKyAiKXtcbiIgKyBib2R5ICsgIlxufSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZ2V0RnVuY3Rpb25zID0gZnVuY3Rpb24odG9rZW5zLCBkZWJ1ZywgdXJpLCBzb3VyY2UsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgdmFyIGZuID0gdG1wbEZ1bmN0aW9uc1t1cmkgJiYgYmFzaXMucGF0aC5yZWxhdGl2ZSh1cmkpXTsKICAgICAgaWYgKGZuKSByZXR1cm4gZm47CiAgICAgIHZhciBwYXRocyA9IGJ1aWxkUGF0aGVzKHRva2VucywgIl8iLCBub1RleHRCdWcsIHRlbXBsYXRlTWFya2VyKTsKICAgICAgdmFyIGJpbmRpbmdzID0gYnVpbGRCaW5kaW5ncyhwYXRocy5iaW5kaW5nKTsKICAgICAgdmFyIG9iamVjdFJlZnMgPSBwYXRocy5tYXJrZWRFbGVtZW50TGlzdC5qb2luKCI9Iik7CiAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgdmFyIGZuQm9keTsKICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICBrZXlzOiBiaW5kaW5ncy5rZXlzLAogICAgICAgIGwxMG5LZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kaW5ncy5sMTBuKQogICAgICB9OwogICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PSAxKSBwYXRocy5wYXRoWzBdID0gImE9XyI7CiAgICAgIGlmICghdXJpKSB1cmkgPSBiYXNpcy5wYXRoLmJhc2VVUkkgKyAiaW5saW5lX3RlbXBsYXRlIiArIGlubGluZVNlZWQrKyArICIudG1wbCI7CiAgICAgIGlmIChiaW5kaW5ncy5sMTBuKSB7CiAgICAgICAgdmFyIGNvZGUgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYmluZGluZ3MubDEwbikgY29kZS5wdXNoKCdjYXNlIicgKyBrZXkgKyAnIjonICsgJ2lmKHZhbHVlPT1udWxsKXZhbHVlPSJ7JyArIGtleSArICd9IjsnICsgIl9fbDEwblt0b2tlbl09dmFsdWU7IiArIGJpbmRpbmdzLmwxMG5ba2V5XS5qb2luKCIiKSArICJicmVhazsiKTsKICAgICAgICByZXN1bHQuY3JlYXRlTDEwblN5bmMgPSBjb21waWxlRnVuY3Rpb24oWyAiXyIsICJfX2wxMG4iLCAiYmluZF9hdHRyIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciAiICsgcGF0aHMucGF0aCArICI7IiArICJyZXR1cm4gZnVuY3Rpb24odG9rZW4sIHZhbHVlKXsiICsgInN3aXRjaCh0b2tlbil7IiArIGNvZGUuam9pbigiIikgKyAifSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpICsgIl9sMTBuIik7CiAgICAgIH0KICAgICAgcmVzdWx0LmNyZWF0ZUluc3RhbmNlID0gY29tcGlsZUZ1bmN0aW9uKFsgInRpZCIsICJtYXAiLCAicHJvdG8iLCAidG9vbHMiLCAiX19sMTBuIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciBnZXRCaW5kaW5ncz10b29scy5jcmVhdGVCaW5kaW5nRnVuY3Rpb24oWyIgKyBiaW5kaW5ncy5rZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gJyInICsga2V5ICsgJyInOwogICAgICB9KSArICJdKSwiICsgKGJpbmRpbmdzLnRvb2xzLmxlbmd0aCA/IGJpbmRpbmdzLnRvb2xzICsgIiwiIDogIiIpICsgIkF0dGFjaGVzPWZ1bmN0aW9uKCl7fTsiICsgIkF0dGFjaGVzLnByb3RvdHlwZT17IiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBrZXkgKyAiOm51bGwiOwogICAgICB9KSArICJ9OyIgKyAicmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlXyhpZCxvYmosb25BY3Rpb24sb25SZWJ1aWxkLGJpbmRpbmdzLGJpbmRpbmdJbnRlcmZhY2UpeyIgKyAidmFyIF89cHJvdG8uY2xvbmVOb2RlKHRydWUpLCIgKyBwYXRocy5wYXRoLmNvbmNhdChiaW5kaW5ncy52YXJzKSArICIsIiArICJpbnN0YW5jZT17IiArICJjb250ZXh0Om9iaiwiICsgImFjdGlvbjpvbkFjdGlvbiwiICsgInJlYnVpbGQ6b25SZWJ1aWxkLCIgKyAoZGVidWcgPyAiZGVidWc6ZnVuY3Rpb24gZGVidWcoKXtyZXR1cm5bIiArIGJpbmRpbmdzLmRlYnVnTGlzdCArICJdfSwiIDogIiIpICsgImhhbmRsZXI6bnVsbCwiICsgImJpbmRpbmdzOmJpbmRpbmdzLCIgKyAiYmluZGluZ0ludGVyZmFjZTpiaW5kaW5nSW50ZXJmYWNlLCIgKyAiYXR0YWNoZXM6bnVsbCwiICsgInRtcGw6eyIgKyBbIHBhdGhzLnJlZiwgInRlbXBsYXRlSWRfOmlkIiwgInNldDpzZXQiIF0gKyAifSIgKyAifSIgKyAob2JqZWN0UmVmcyA/ICI7aWYob2JqfHxvbkFjdGlvbikiICsgb2JqZWN0UmVmcyArICI9KGlkPDwxMil8dGlkIiA6ICIiKSArIGJpbmRpbmdzLnNldCArICI7aWYoYmluZGluZ3MpaW5zdGFuY2UuaGFuZGxlcj1nZXRCaW5kaW5ncyhiaW5kaW5ncyxvYmosc2V0LGJpbmRpbmdJbnRlcmZhY2UpIiArICI7IiArIGJpbmRpbmdzLmwxMG5Db21wdXRlICsgIjtyZXR1cm4gaW5zdGFuY2UiICsgIn0iICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVyaSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldEZ1bmN0aW9uczogZ2V0RnVuY3Rpb25zCiAgICB9OwogIH0KfTsKCihmdW5jdGlvbiBjcmVhdGVCYXNpc0luc3RhbmNlKGdsb2JhbCwgX19iYXNpc0ZpbGVuYW1lLCBfX2NvbmZpZykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgVkVSU0lPTiA9ICIxLjMuMyI7CiAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogIHZhciB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CiAgZnVuY3Rpb24gZ2VuVUlEKGxlbikgewogICAgZnVuY3Rpb24gYmFzZTM2KHZhbCkgewogICAgICByZXR1cm4gTWF0aC5yb3VuZCh2YWwpLnRvU3RyaW5nKDM2KTsKICAgIH0KICAgIHZhciByZXN1bHQgPSBiYXNlMzYoMTAgKyAyNSAqIE1hdGgucmFuZG9tKCkpOwogICAgaWYgKCFsZW4pIGxlbiA9IDE2OwogICAgd2hpbGUgKHJlc3VsdC5sZW5ndGggPCBsZW4pIHJlc3VsdCArPSBiYXNlMzYobmV3IERhdGUgKiBNYXRoLnJhbmRvbSgpKTsKICAgIHJldHVybiByZXN1bHQuc3Vic3RyKDAsIGxlbik7CiAgfQogIGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzb3VyY2UpIHsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGNvbXBsZXRlKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgaWYgKGtleSBpbiBkZXN0ID09IGZhbHNlKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiBkZXN0OwogIH0KICBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goa2V5KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKG9iamVjdFtrZXldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNwbGljZShzb3VyY2UsIGtleXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICgha2V5cykgcmV0dXJuIGV4dGVuZChyZXN1bHQsIHNvdXJjZSk7CiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107ICkgaWYgKGtleSBpbiBzb3VyY2UpIHsKICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgZGVsZXRlIHNvdXJjZVtrZXldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gbWVyZ2UoKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgZXh0ZW5kKHJlc3VsdCwgYXJndW1lbnRzW2ldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGl0ZXJhdGUob2JqZWN0LCBjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCBrZXksIG9iamVjdFtrZXldKSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiAkdW5kZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzTnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgdmFsdWUgPT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNOb3ROdWxsKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc1NhbWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdGhpczsKICB9CiAgZnVuY3Rpb24gJGlzTm90U2FtZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB0aGlzOwogIH0KICBmdW5jdGlvbiAkc2VsZih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBmdW5jdGlvbiAkY29uc3QodmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9CiAgZnVuY3Rpb24gJGZhbHNlKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiAkdHJ1ZSgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiAkbnVsbCgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiAkdW5kZWYoKSB7fQogIHZhciBnZXR0ZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBJRCA9ICJiYXNpc0dldHRlcklkIiArIGdlblVJRCgpICsgIl8iOwogICAgdmFyIG1vZGlmaWNhdG9yU2VlZCA9IDE7CiAgICB2YXIgc2ltcGxlUGF0aCA9IC9eW2EteiRfXVthLXokXzAtOV0qKFwuW2EteiRfXVthLXokXzAtOV0qKSokL2k7CiAgICB2YXIgZ2V0dGVyTWFwID0gW107CiAgICB2YXIgcGF0aENhY2hlID0ge307CiAgICB2YXIgbW9kQ2FjaGUgPSB7fTsKICAgIGZ1bmN0aW9uIGJ1aWxkRnVuY3Rpb24ocGF0aCkgewogICAgICBpZiAoc2ltcGxlUGF0aC50ZXN0KHBhdGgpKSB7CiAgICAgICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdCgiLiIpOwogICAgICAgIHZhciBmb28gPSBwYXJ0c1swXTsKICAgICAgICB2YXIgYmFyID0gcGFydHNbMV07CiAgICAgICAgdmFyIGJheiA9IHBhcnRzWzJdOwogICAgICAgIHZhciBmbjsKICAgICAgICBzd2l0Y2ggKHBhcnRzLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXVtiYXJdIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXVtiYXJdW2Jhel0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtmb29dW2Jhcl1bYmF6XTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAzLCBrZXk7IGtleSA9IHBhcnRzW2ldOyBpKyspIG9iamVjdCA9IG9iamVjdFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmbiA9IEZ1bmN0aW9uKCJwYXJ0cyIsICJyZXR1cm4gIiArIGZuLnRvU3RyaW5nKCkucmVwbGFjZSgvKGZvb3xiYXJ8YmF6KS9nLCBmdW5jdGlvbihtLCB3KSB7CiAgICAgICAgICByZXR1cm4gJyInICsgcGFydHNbdyA9PSAiZm9vIiA/IDAgOiB3ID09ICJiYXIiID8gMSA6IDJdICsgJyInOwogICAgICAgIH0pLnJlcGxhY2UoL1xbXCIoW14iXSspXCJcXS9nLCAiLiQxIikpKHBhcnRzKTsKICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigib2JqZWN0IiwgInJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdC4iICsgcGF0aCArICIgOiBvYmplY3QiKTsKICAgIH0KICAgIHZhciBnZXR0ZXJGbiA9IGZ1bmN0aW9uKHBhdGgsIG1vZGlmaWNhdG9yKSB7CiAgICAgIHZhciBmdW5jOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgZ2V0dGVySWQ7CiAgICAgIGlmICghcGF0aCB8fCBwYXRoID09PSBudWxsR2V0dGVyKSByZXR1cm4gbnVsbEdldHRlcjsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBnZXR0ZXJJZCA9IHBhdGhbSURdOwogICAgICAgIGlmIChnZXR0ZXJJZCkgewogICAgICAgICAgZnVuYyA9IGdldHRlck1hcFtNYXRoLmFicyhnZXR0ZXJJZCkgLSAxXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gcGF0aChvYmplY3QpOwogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgcGF0aFtJRF0gPSAtZ2V0dGVySWQ7CiAgICAgICAgICBmdW5jW0lEXSA9IGdldHRlcklkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmdW5jID0gcGF0aENhY2hlW3BhdGhdOwogICAgICAgIGlmIChmdW5jKSB7CiAgICAgICAgICBnZXR0ZXJJZCA9IGZ1bmNbSURdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gYnVpbGRGdW5jdGlvbihwYXRoKTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgZnVuY1tJRF0gPSBnZXR0ZXJJZDsKICAgICAgICAgIHBhdGhDYWNoZVtwYXRoXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBtb2RUeXBlID0gbW9kaWZpY2F0b3IgIT0gbnVsbCAmJiB0eXBlb2YgbW9kaWZpY2F0b3I7CiAgICAgIGlmICghbW9kVHlwZSkgcmV0dXJuIGZ1bmM7CiAgICAgIHZhciBtb2RMaXN0ID0gbW9kQ2FjaGVbZ2V0dGVySWRdOwogICAgICB2YXIgbW9kSWQ7CiAgICAgIGlmIChtb2RUeXBlID09ICJzdHJpbmciKSBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvcjsgZWxzZSBpZiAobW9kVHlwZSA9PSAiZnVuY3Rpb24iKSBtb2RJZCA9IG1vZGlmaWNhdG9yLmJhc2lzTW9kSWRfOyBlbHNlIGlmIChtb2RUeXBlICE9ICJvYmplY3QiKSB7CiAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuZ2V0dGVyOiB3cm9uZyBtb2RpZmljYXRvciB0eXBlLCBtb2RpZmljYXRvciBub3QgdXNlZCwgcGF0aDogIiwgcGF0aCwgIiwgbW9kaWZpY2F0b3I6IiwgbW9kaWZpY2F0b3IpOwogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIGlmIChtb2RJZCAmJiBtb2RMaXN0ICYmIG1vZExpc3RbbW9kSWRdKSByZXR1cm4gbW9kTGlzdFttb2RJZF07CiAgICAgIGlmICh0eXBlb2YgZnVuYy5iYXNlID09ICJmdW5jdGlvbiIpIGZ1bmMgPSBmdW5jLmJhc2U7CiAgICAgIHN3aXRjaCAobW9kVHlwZSkgewogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ0Z1bmN0aW9ucy5mb3JtYXQobW9kaWZpY2F0b3IsIGZ1bmMob2JqZWN0KSk7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKCFtb2RJZCkgewogICAgICAgICAgICBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvclNlZWQrKzsKICAgICAgICAgICAgbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF8gPSBtb2RJZDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3IoZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcltmdW5jKG9iamVjdCldOwogICAgICAgICAgfTsKICAgICAgfQogICAgICByZXN1bHQuYmFzZSA9IGZ1bmMuYmFzZSB8fCBmdW5jOwogICAgICByZXN1bHQuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgaWYgKG1vZElkKSB7CiAgICAgICAgaWYgKCFtb2RMaXN0KSB7CiAgICAgICAgICBtb2RMaXN0ID0ge307CiAgICAgICAgICBtb2RDYWNoZVtnZXR0ZXJJZF0gPSBtb2RMaXN0OwogICAgICAgIH0KICAgICAgICBtb2RMaXN0W21vZElkXSA9IHJlc3VsdDsKICAgICAgICByZXN1bHQubW9kID0gbW9kaWZpY2F0b3I7CiAgICAgICAgcmVzdWx0W0lEXSA9IGdldHRlck1hcC5wdXNoKHJlc3VsdCk7CiAgICAgIH0gZWxzZSB7fQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGdldHRlckZuLklEID0gSUQ7CiAgICByZXR1cm4gZ2V0dGVyRm47CiAgfSgpOwogIHZhciBudWxsR2V0dGVyID0gZXh0ZW5kKGZ1bmN0aW9uKCkge30sIHsKICAgIF9fZXh0ZW5kX186IGdldHRlcgogIH0pOwogIGZ1bmN0aW9uIHdyYXBwZXIoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgZnVuY3Rpb24gbGF6eUluaXQoaW5pdCwgdGhpc09iamVjdCkgewogICAgdmFyIGluaXRlZCA9IDA7CiAgICB2YXIgc2VsZjsKICAgIHZhciBkYXRhOwogICAgcmV0dXJuIHNlbGYgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoaW5pdGVkKyspKSB7CiAgICAgICAgc2VsZi5pbml0ZWQgPSB0cnVlOwogICAgICAgIHNlbGYuZGF0YSA9IGRhdGEgPSBpbml0LmFwcGx5KHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gInVuZGVmaW5lZCIpIGNvbnNvbGVNZXRob2RzLndhcm4oImxhenlJbml0IGZ1bmN0aW9uIHJldHVybnMgbm90aGluZzpcbiIgKyBpbml0KTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGxhenlJbml0QW5kUnVuKGluaXQsIHJ1biwgdGhpc09iamVjdCkgewogICAgdmFyIGluaXRlZCA9IDA7CiAgICB2YXIgc2VsZjsKICAgIHZhciBkYXRhOwogICAgcmV0dXJuIHNlbGYgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoaW5pdGVkKyspKSB7CiAgICAgICAgc2VsZi5pbml0ZWQgPSB0cnVlOwogICAgICAgIHNlbGYuZGF0YSA9IGRhdGEgPSBpbml0LmNhbGwodGhpc09iamVjdCB8fCB0aGlzKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gInVuZGVmaW5lZCIpIGNvbnNvbGVNZXRob2RzLndhcm4oImxhenlJbml0QW5kUnVuIGZ1bmN0aW9uIHJldHVybnMgbm90aGluZzpcbiIgKyBpbml0KTsKICAgICAgfQogICAgICBydW4uYXBwbHkoZGF0YSwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KICBmdW5jdGlvbiBydW5PbmNlKHJ1biwgdGhpc09iamVjdCkgewogICAgdmFyIGZpcmVkID0gMDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEoZmlyZWQrKykpIHJldHVybiBydW4uYXBwbHkodGhpc09iamVjdCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9CiAgdmFyIGNvbnNvbGVNZXRob2RzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgbG9nOiAkdW5kZWYsCiAgICAgIGluZm86ICR1bmRlZiwKICAgICAgd2FybjogJHVuZGVmLAogICAgICBlcnJvcjogJHVuZGVmCiAgICB9OwogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiKSBpdGVyYXRlKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgbWV0aG9kc1ttZXRob2ROYW1lXSA9ICJiaW5kIiBpbiBGdW5jdGlvbi5wcm90b3R5cGUgJiYgdHlwZW9mIGNvbnNvbGVbbWV0aG9kTmFtZV0gPT0gImZ1bmN0aW9uIiA/IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoY29uc29sZVttZXRob2ROYW1lXSwgY29uc29sZSkgOiBmdW5jdGlvbigpIHsKICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW21ldGhvZE5hbWVdLCBjb25zb2xlLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gbWV0aG9kczsKICB9KCk7CiAgdmFyIHNldEltbWVkaWF0ZSA9IGdsb2JhbC5zZXRJbW1lZGlhdGUgfHwgZ2xvYmFsLm1zU2V0SW1tZWRpYXRlOwogIHZhciBjbGVhckltbWVkaWF0ZSA9IGdsb2JhbC5jbGVhckltbWVkaWF0ZSB8fCBnbG9iYWwubXNTZXRJbW1lZGlhdGU7CiAgaWYgKHNldEltbWVkaWF0ZSkgc2V0SW1tZWRpYXRlID0gc2V0SW1tZWRpYXRlLmJpbmQoZ2xvYmFsKTsKICBpZiAoY2xlYXJJbW1lZGlhdGUpIGNsZWFySW1tZWRpYXRlID0gY2xlYXJJbW1lZGlhdGUuYmluZChnbG9iYWwpOwogIGlmICghc2V0SW1tZWRpYXRlKSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgTUVTU0FHRV9OQU1FID0gImJhc2lzanMuc2V0SW1tZWRpYXRlIjsKICAgIHZhciBydW5UYXNrID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXNrQnlJZCA9IHt9OwogICAgICB2YXIgdGFza0lkID0gMTsKICAgICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodHlwZW9mIGZuICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnNldEltbWVkaWF0ZSgpIGFuZCBiYXNpcy5uZXh0VGljaygpIGFjY2VwdCBmdW5jdGlvbnMgb25seSAoY2FsbCBpZ25vcmVkKSIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0YXNrQnlJZFsrK3Rhc2tJZF0gPSB7CiAgICAgICAgICBmbjogZm4sCiAgICAgICAgICBhcmdzOiBhcnJheUZyb20oYXJndW1lbnRzLCAxKQogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgIHJldHVybiB0YXNrSWQ7CiAgICAgIH07CiAgICAgIGNsZWFySW1tZWRpYXRlID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oaWQpIHsKICAgICAgICB2YXIgdGFzayA9IHRhc2tCeUlkW2lkXTsKICAgICAgICBpZiAodGFzaykgewogICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICAgIHJldHVybiB0YXNrLmZuLmFwcGx5KHVuZGVmaW5lZCwgdGFzay5hcmdzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgfSwgMCk7CiAgICB9OwogICAgaWYgKGdsb2JhbC5wcm9jZXNzICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09ICJmdW5jdGlvbiIpIHsKICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBpZiAoZ2xvYmFsLk1lc3NhZ2VDaGFubmVsKSB7CiAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgZ2xvYmFsLk1lc3NhZ2VDaGFubmVsOwogICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXNrSWQgPSBldmVudC5kYXRhOwogICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh0YXNrSWQpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBvc3RNZXNzYWdlU3VwcG9ydGVkID0gZ2xvYmFsLnBvc3RNZXNzYWdlICYmICFnbG9iYWwuaW1wb3J0U2NyaXB0czsKICAgICAgICBpZiAocG9zdE1lc3NhZ2VTdXBwb3J0ZWQpIHsKICAgICAgICAgIHZhciBvbGRPbk1lc3NhZ2UgPSBnbG9iYWwub25tZXNzYWdlOwogICAgICAgICAgZ2xvYmFsLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICAgIGdsb2JhbC5wb3N0TWVzc2FnZSgiIiwgIioiKTsKICAgICAgICAgIGdsb2JhbC5vbm1lc3NhZ2UgPSBvbGRPbk1lc3NhZ2U7CiAgICAgICAgfQogICAgICAgIGlmIChwb3N0TWVzc2FnZVN1cHBvcnRlZCkgewogICAgICAgICAgdmFyIHNldEltbWVkaWF0ZUhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQuc291cmNlID09IGdsb2JhbCkgewogICAgICAgICAgICAgIHZhciB0YXNrSWQgPSBTdHJpbmcoZXZlbnQuZGF0YSkuc3BsaXQoTUVTU0FHRV9OQU1FKVsxXTsKICAgICAgICAgICAgICBpZiAodGFza0lkKSBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIpIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgc2V0SW1tZWRpYXRlSGFuZGxlciwgdHJ1ZSk7IGVsc2UgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbm1lc3NhZ2UiLCBzZXRJbW1lZGlhdGVIYW5kbGVyKTsKICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKE1FU1NBR0VfTkFNRSArIHRhc2tJZCwgIioiKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjcmVhdGVTY3JpcHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgICAgfTsKICAgICAgICAgIGlmIChkb2N1bWVudCAmJiAib25yZWFkeXN0YXRlY2hhbmdlIiBpbiBjcmVhdGVTY3JpcHQoKSkgewogICAgICAgICAgICB2YXIgZGVmYXVsdEFkZFRvUXVldWUgPSBhZGRUb1F1ZXVlOwogICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24gYmVmb3JlSGVhZFJlYWR5KHRhc2tJZCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRJbnRlcmZhY2UgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGFkZFRvUXVldWUgPSBkZWZhdWx0QWRkVG9RdWV1ZTsKICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2NyaXB0RWwgPSBjcmVhdGVTY3JpcHQoKTsKICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChhZGRUb1F1ZXVlID09PSBiZWZvcmVIZWFkUmVhZHkpIGRlZmF1bHRBZGRUb1F1ZXVlKHRhc2tJZCk7IGVsc2UgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5PREVfRU5WID0gdHlwZW9mIHByb2Nlc3MgPT0gIm9iamVjdCIgJiYgdG9TdHJpbmcuY2FsbChwcm9jZXNzKSA9PSAiW29iamVjdCBwcm9jZXNzXSI7CiAgdmFyIHBhdGhVdGlscyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIEFCU09MVVRFX1JYID0gL14oW15cL10rOnxcLykvOwogICAgdmFyIFBST1RPQ09MX1JYID0gL15bYS16QS1aMC05XC1dKzpcLz8vOwogICAgdmFyIE9SSUdJTl9SWCA9IC9eKD86W2EtekEtWjAtOVwtXSs6KT9cL1wvW15cL10rXC8/LzsKICAgIHZhciBTRUFSQ0hfSEFTSF9SWCA9IC9bXD8jXS4qJC87CiAgICB2YXIgYmFzZVVSSTsKICAgIHZhciBvcmlnaW47CiAgICB2YXIgdXRpbHM7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIHBhdGggPSAocHJvY2Vzcy5iYXNpc2pzQmFzZVVSSSB8fCByZXF1aXJlKCJwYXRoIikucmVzb2x2ZSgiLiIpKS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICBiYXNlVVJJID0gcGF0aC5yZXBsYWNlKC9eW15cL10qLywgIiIpOwogICAgICBvcmlnaW4gPSBwYXRoLnJlcGxhY2UoL1wvLiovLCAiIik7CiAgICB9IGVsc2UgewogICAgICBiYXNlVVJJID0gbG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10rJC8sICIiKTsKICAgICAgb3JpZ2luID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdDsKICAgIH0KICAgIHV0aWxzID0gewogICAgICBiYXNlVVJJOiBiYXNlVVJJLAogICAgICBvcmlnaW46IG9yaWdpbiwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgcGF0aCA9IChwYXRoIHx8ICIiKS5yZXBsYWNlKFBST1RPQ09MX1JYLCAiLyIpLnJlcGxhY2UoT1JJR0lOX1JYLCAiLyIpLnJlcGxhY2UoU0VBUkNIX0hBU0hfUlgsICIiKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdCgiLyIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChwYXJ0c1tpXSA9PSAiLi4iKSB7CiAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSB8fCByZXN1bHRbMF0pIHJlc3VsdC5wb3AoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgocGFydHNbaV0gfHwgIWkpICYmIHBhcnRzW2ldICE9ICIuIikgcmVzdWx0LnB1c2gocGFydHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oIi8iKSB8fCAocGF0aFswXSA9PT0gIi8iID8gIi8iIDogIiIpOwogICAgICB9LAogICAgICBkaXJuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKTsKICAgICAgICByZXR1cm4gcmVzdWx0LnJlcGxhY2UoL1wvKFteXC9dKikkfF5bXlwvXSskLywgIiIpIHx8IChyZXN1bHRbMF0gPT0gIi8iID8gIi8iIDogIi4iKTsKICAgICAgfSwKICAgICAgZXh0bmFtZTogZnVuY3Rpb24ocGF0aCkgewogICAgICAgIHZhciBleHQgPSB1dGlscy5ub3JtYWxpemUocGF0aCkubWF0Y2goL1teXC9dKFwuW15cL1wuXSopJC8pOwogICAgICAgIHJldHVybiBleHQgPyBleHRbMV0gOiAiIjsKICAgICAgfSwKICAgICAgYmFzZW5hbWU6IGZ1bmN0aW9uKHBhdGgsIGV4dCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cXFwvXSokLyk7CiAgICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZSA/IGZpbGVuYW1lWzBdIDogIiI7CiAgICAgICAgaWYgKGV4dCA9PSB1dGlscy5leHRuYW1lKGZpbGVuYW1lKSkgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHJpbmcoMCwgZmlsZW5hbWUubGVuZ3RoIC0gZXh0Lmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIGZpbGVuYW1lOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihmcm9tLCB0bykgewogICAgICAgIHZhciBhcmdzID0gYXJyYXlGcm9tKGFyZ3VtZW50cykucmV2ZXJzZSgpOwogICAgICAgIHZhciBwYXRoID0gW107CiAgICAgICAgdmFyIGFic29sdXRlRm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgIWFic29sdXRlRm91bmQgJiYgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIGlmICh0eXBlb2YgYXJnc1tpXSA9PSAic3RyaW5nIikgewogICAgICAgICAgcGF0aC51bnNoaWZ0KGFyZ3NbaV0pOwogICAgICAgICAgYWJzb2x1dGVGb3VuZCA9IEFCU09MVVRFX1JYLnRlc3QoYXJnc1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghYWJzb2x1dGVGb3VuZCkgcGF0aC51bnNoaWZ0KGJhc2VVUkkgPT0gIi8iID8gIiIgOiBiYXNlVVJJKTsKICAgICAgICByZXR1cm4gdXRpbHMubm9ybWFsaXplKHBhdGguam9pbigiLyIpKTsKICAgICAgfSwKICAgICAgcmVsYXRpdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0byAhPSAic3RyaW5nIikgewogICAgICAgICAgdG8gPSBmcm9tOwogICAgICAgICAgZnJvbSA9IGJhc2VVUkk7CiAgICAgICAgfQogICAgICAgIGZyb20gPSB1dGlscy5ub3JtYWxpemUoZnJvbSk7CiAgICAgICAgdG8gPSB1dGlscy5ub3JtYWxpemUodG8pOwogICAgICAgIGlmIChmcm9tWzBdID09ICIvIiAmJiB0b1swXSAhPSAiLyIpIHJldHVybiBmcm9tOwogICAgICAgIGlmICh0b1swXSA9PSAiLyIgJiYgZnJvbVswXSAhPSAiLyIpIHJldHVybiB0bzsKICAgICAgICB2YXIgYmFzZSA9IGZyb20ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcGF0aCA9IHRvLnJlcGxhY2UoL15cLyQvLCAiIikuc3BsaXQoL1wvLyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBpID0gMDsKICAgICAgICB3aGlsZSAocGF0aFtpXSA9PSBiYXNlW2ldICYmIHR5cGVvZiBiYXNlW2ldID09ICJzdHJpbmciKSBpKys7CiAgICAgICAgZm9yICh2YXIgaiA9IGJhc2UubGVuZ3RoIC0gaTsgaiA+IDA7IGotLSkgcmVzdWx0LnB1c2goIi4uIik7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQocGF0aC5zbGljZShpKS5maWx0ZXIoQm9vbGVhbikpLmpvaW4oIi8iKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiB1dGlsczsKICB9KCk7CiAgdmFyIGJhc2lzRmlsZW5hbWUgPSBfX2Jhc2lzRmlsZW5hbWUgfHwgIiI7CiAgdmFyIGNvbmZpZyA9IF9fY29uZmlnIHx8IHsKICAgIG5vQ29uZmxpY3Q6IHRydWUsCiAgICBtb2R1bGVzOiB7fSwKICAgIGF1dG9sb2FkOiBbICIuLzAuanMiIF0KICB9OwogIGZ1bmN0aW9uIGZldGNoQ29uZmlnKCkgewogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnOwogICAgaWYgKCFjb25maWcpIHsKICAgICAgaWYgKE5PREVfRU5WKSB7CiAgICAgICAgYmFzaXNGaWxlbmFtZSA9IF9fZmlsZW5hbWUucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgc2NyaXB0cyA9IGRvY3VtZW50LnNjcmlwdHM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNjcmlwdEVsOyBzY3JpcHRFbCA9IHNjcmlwdHNbaV07IGkrKykgewogICAgICAgICAgdmFyIGNvbmZpZ0F0dHJWYWx1ZSA9IHNjcmlwdEVsLmhhc0F0dHJpYnV0ZSgiYmFzaXMtY29uZmlnIikgPyBzY3JpcHRFbC5nZXRBdHRyaWJ1dGUoImJhc2lzLWNvbmZpZyIpIDogc2NyaXB0RWwuZ2V0QXR0cmlidXRlKCJkYXRhLWJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgc2NyaXB0RWwucmVtb3ZlQXR0cmlidXRlKCJiYXNpcy1jb25maWciKTsKICAgICAgICAgIHNjcmlwdEVsLnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1iYXNpcy1jb25maWciKTsKICAgICAgICAgIGlmIChjb25maWdBdHRyVmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgYmFzaXNGaWxlbmFtZSA9IHBhdGhVdGlscy5ub3JtYWxpemUoc2NyaXB0RWwuc3JjKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb25maWcgPSBGdW5jdGlvbigicmV0dXJueyIgKyBjb25maWdBdHRyVmFsdWUgKyAifSIpKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMtY29uZmlnOiBiYXNpcy5qcyBjb25maWcgcGFyc2UgZmF1bHQ6ICIgKyBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwcm9jZXNzQ29uZmlnKGNvbmZpZyk7CiAgfQogIGZ1bmN0aW9uIHByb2Nlc3NDb25maWcoY29uZmlnLCB2ZXJib3NlKSB7CiAgICBjb25maWcgPSBzbGljZShjb25maWcpOwogICAgaWYgKCJleHRQcm90byIgaW4gY29uZmlnKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy1jb25maWc6IGBleHRQcm90b2Agb3B0aW9uIGluIGJhc2lzLWNvbmZpZyBpcyBub3Qgc3VwcG9ydCBhbnltb3JlIik7CiAgICBpZiAoInBhdGgiIGluIGNvbmZpZykgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMtY29uZmlnOiBgcGF0aGAgb3B0aW9uIGluIGJhc2lzLWNvbmZpZyBpcyBkZXByZWNhdGVkLCB1c2UgYG1vZHVsZXNgIGluc3RlYWQiKTsKICAgIHZhciBhdXRvbG9hZCA9IFtdOwogICAgdmFyIG1vZHVsZXMgPSBtZXJnZShjb25maWcucGF0aCwgY29uZmlnLm1vZHVsZXMsIHsKICAgICAgYmFzaXM6IGJhc2lzRmlsZW5hbWUKICAgIH0pOwogICAgY29uZmlnLm1vZHVsZXMgPSB7fTsKICAgIGlmIChjb25maWcuYXV0b2xvYWQpIHsKICAgICAgdmFyIG0gPSBTdHJpbmcoY29uZmlnLmF1dG9sb2FkKS5tYXRjaCgvXigoPzpbXlwvXSpcLykqKShbYS16JF9dW2EtejAtOSRfXSopKCg/OlwuW2EteiRfXVthLXowLTkkX10qKSopJC9pKTsKICAgICAgaWYgKG0pIHsKICAgICAgICBtb2R1bGVzW21bMl1dID0gewogICAgICAgICAgYXV0b2xvYWQ6IHRydWUsCiAgICAgICAgICBmaWxlbmFtZTogbVsxXSArIG1bMl0gKyAobVszXSB8fCAiLmpzIikKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLWNvbmZpZzogd3JvbmcgYGF1dG9sb2FkYCB2YWx1ZSAoc2V0dGluZyBpZ25vcmVkKTogIiArIGNvbmZpZy5hdXRvbG9hZCk7CiAgICAgIH0KICAgICAgZGVsZXRlIGNvbmZpZy5hdXRvbG9hZDsKICAgIH0KICAgIGZvciAodmFyIG5hbWUgaW4gbW9kdWxlcykgewogICAgICB2YXIgbW9kdWxlID0gbW9kdWxlc1tuYW1lXTsKICAgICAgaWYgKHR5cGVvZiBtb2R1bGUgPT0gInN0cmluZyIpIG1vZHVsZSA9IHsKICAgICAgICBmaWxlbmFtZTogbW9kdWxlLnJlcGxhY2UoL1wvJC8sICIvIiArIG5hbWUgKyAiLmpzIikKICAgICAgfTsKICAgICAgdmFyIGZpbGVuYW1lID0gbW9kdWxlLmZpbGVuYW1lOwogICAgICB2YXIgcGF0aCA9IG1vZHVsZS5wYXRoOwogICAgICBpZiAoZmlsZW5hbWUgJiYgIXBhdGgpIHsKICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgICAgICBwYXRoID0gZmlsZW5hbWUuc3Vic3RyKDAsIGZpbGVuYW1lLmxlbmd0aCAtIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKS5sZW5ndGgpOwogICAgICAgIGZpbGVuYW1lID0gIi4uLyIgKyBwYXRoVXRpbHMuYmFzZW5hbWUoZmlsZW5hbWUpOwogICAgICB9CiAgICAgIHBhdGggPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoKTsKICAgICAgaWYgKCFmaWxlbmFtZSAmJiBwYXRoKSB7CiAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMuYmFzZW5hbWUocGF0aCk7CiAgICAgICAgcGF0aCA9IHBhdGhVdGlscy5kaXJuYW1lKHBhdGgpOwogICAgICB9CiAgICAgIGlmICghcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSArPSAiLmpzIjsKICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoLCBmaWxlbmFtZSk7CiAgICAgIGNvbmZpZy5tb2R1bGVzW25hbWVdID0gewogICAgICAgIHBhdGg6IHBhdGgsCiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lCiAgICAgIH07CiAgICAgIGlmIChtb2R1bGUuYXV0b2xvYWQpIHsKICAgICAgICBjb25maWcuYXV0b2xvYWQgPSBhdXRvbG9hZDsKICAgICAgICBhdXRvbG9hZC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29uZmlnOwogIH0KICB2YXIgQ2xhc3MgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZVNlZWQgPSB7CiAgICAgIGlkOiAxCiAgICB9OwogICAgdmFyIGNsYXNzU2VlZCA9IDE7CiAgICB2YXIgY2xhc3NlcyA9IFtdOwogICAgdmFyIFNFTEYgPSB7fTsKICAgIGZ1bmN0aW9uIGlzQ2xhc3Mob2JqZWN0KSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICJmdW5jdGlvbiIgJiYgISFvYmplY3QuYmFzaXNDbGFzc0lkXzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU3ViY2xhc3NPZihzdXBlckNsYXNzKSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yICYmIGN1cnNvciAhPT0gc3VwZXJDbGFzcykgY3Vyc29yID0gY3Vyc29yLnN1cGVyQ2xhc3NfOwogICAgICByZXR1cm4gY3Vyc29yID09PSBzdXBlckNsYXNzOwogICAgfQogICAgZnVuY3Rpb24gZGV2VmVyYm9zZU5hbWUobmFtZSwgYXJncywgZm4pIHsKICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oa2V5cyhhcmdzKSwgJ3JldHVybiB7IicgKyBuYW1lICsgJyI6ICcgKyBmbiArICdcbn1bIicgKyBuYW1lICsgJyJdJykpLmFwcGx5KG51bGwsIHZhbHVlcyhhcmdzKSk7CiAgICB9CiAgICB2YXIgVE9TVFJJTkdfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB7CiAgICAgICAgdG9TdHJpbmc6IDEKICAgICAgfSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0oKTsKICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzKFN1cGVyQ2xhc3MsIGV4dGVuc2lvbnMpIHsKICAgICAgdmFyIGNsYXNzSWQgPSBjbGFzc1NlZWQrKzsKICAgICAgaWYgKHR5cGVvZiBTdXBlckNsYXNzICE9ICJmdW5jdGlvbiIpIFN1cGVyQ2xhc3MgPSBCYXNlQ2xhc3M7CiAgICAgIHZhciBjbGFzc05hbWUgPSAiIjsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIGlmICh0eXBlb2YgZXh0ZW5zaW9uICE9ICJmdW5jdGlvbiIgJiYgZXh0ZW5zaW9uLmNsYXNzTmFtZSkgY2xhc3NOYW1lID0gZXh0ZW5zaW9uLmNsYXNzTmFtZTsKICAgICAgaWYgKCFjbGFzc05hbWUpIGNsYXNzTmFtZSA9IFN1cGVyQ2xhc3MuY2xhc3NOYW1lICsgIi5fQ2xhc3MiICsgY2xhc3NJZDsKICAgICAgdmFyIE5ld0NsYXNzUHJvdG8gPSBmdW5jdGlvbigpIHt9OwogICAgICBOZXdDbGFzc1Byb3RvID0gZGV2VmVyYm9zZU5hbWUoY2xhc3NOYW1lLCB7fSwgTmV3Q2xhc3NQcm90byk7CiAgICAgIE5ld0NsYXNzUHJvdG8ucHJvdG90eXBlID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CiAgICAgIHZhciBuZXdQcm90byA9IG5ldyBOZXdDbGFzc1Byb3RvOwogICAgICB2YXIgbmV3Q2xhc3NQcm9wcyA9IHsKICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZSwKICAgICAgICBiYXNpc0NsYXNzSWRfOiBjbGFzc0lkLAogICAgICAgIHN1cGVyQ2xhc3NfOiBTdXBlckNsYXNzLAogICAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogISFTdXBlckNsYXNzLmV4dGVuZENvbnN0cnVjdG9yXywKICAgICAgICBpc1N1YmNsYXNzT2Y6IGlzU3ViY2xhc3NPZiwKICAgICAgICBzdWJjbGFzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3MuYXBwbHkobnVsbCwgWyBuZXdDbGFzcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSkpOwogICAgICAgIH0sCiAgICAgICAgZXh0ZW5kOiBleHRlbmRDbGFzcywKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSBTRUxGICYmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3ModmFsdWUpKSkgcmV0dXJuIEJhc2VDbGFzcy5jcmVhdGUuY2FsbChudWxsLCBuZXdDbGFzcywgdmFsdWUpOyBlbHNlIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIHByb3RvdHlwZTogbmV3UHJvdG8KICAgICAgfTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIG5ld0NsYXNzUHJvcHMuZXh0ZW5kKGV4dGVuc2lvbik7CiAgICAgIGlmIChuZXdQcm90by5pbml0ICE9PSBCYXNlQ2xhc3MucHJvdG90eXBlLmluaXQgJiYgIS9eZnVuY3Rpb25bXihdKlwoXCkvLnRlc3QobmV3UHJvdG8uaW5pdCkgJiYgbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8pIGNvbnNvbGVNZXRob2RzLndhcm4oInByb2JhYmx5IHdyb25nIGV4dGVuZENvbnN0cnVjdG9yXyB2YWx1ZSBmb3IgIiArIG5ld0NsYXNzUHJvcHMuY2xhc3NOYW1lKTsKICAgICAgdmFyIG5ld0NsYXNzID0gbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8gPyBmdW5jdGlvbihleHRlbmQpIHsKICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKICAgICAgICB2YXIgcHJvcDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5kKSB7CiAgICAgICAgICBwcm9wID0gdGhpc1trZXldOwogICAgICAgICAgdGhpc1trZXldID0gcHJvcCAmJiBwcm9wLl9fZXh0ZW5kX18gPyBwcm9wLl9fZXh0ZW5kX18oZXh0ZW5kW2tleV0pIDogZXh0ZW5kW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfTsKICAgICAgbmV3Q2xhc3MgPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHsKICAgICAgICBpbnN0YW5jZVNlZWQ6IGluc3RhbmNlU2VlZAogICAgICB9LCBuZXdDbGFzcyk7CiAgICAgIG5ld1Byb3RvLmNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CiAgICAgIGZvciAodmFyIGtleSBpbiBuZXdQcm90bykgaWYgKG5ld1Byb3RvW2tleV0gPT09IFNFTEYpIG5ld1Byb3RvW2tleV0gPSBuZXdDbGFzczsKICAgICAgZXh0ZW5kKG5ld0NsYXNzLCBuZXdDbGFzc1Byb3BzKTsKICAgICAgY2xhc3Nlcy5wdXNoKG5ld0NsYXNzKTsKICAgICAgcmV0dXJuIG5ld0NsYXNzOwogICAgfQogICAgZnVuY3Rpb24gZXh0ZW5kQ2xhc3Moc291cmNlKSB7CiAgICAgIHZhciBwcm90byA9IHRoaXMucHJvdG90eXBlOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iICYmICFpc0NsYXNzKHNvdXJjZSkpIHNvdXJjZSA9IHNvdXJjZSh0aGlzLnN1cGVyQ2xhc3NfLnByb3RvdHlwZSwgc2xpY2UocHJvdG8pKTsKICAgICAgaWYgKHNvdXJjZS5wcm90b3R5cGUpIHNvdXJjZSA9IHNvdXJjZS5wcm90b3R5cGU7CiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB2YXIgcHJvdG9WYWx1ZSA9IHByb3RvW2tleV07CiAgICAgICAgaWYgKGtleSA9PSAiY2xhc3NOYW1lIiB8fCBrZXkgPT0gImV4dGVuZENvbnN0cnVjdG9yXyIpIHRoaXNba2V5XSA9IHZhbHVlOyBlbHNlIHsKICAgICAgICAgIGlmIChwcm90b1ZhbHVlICYmIHByb3RvVmFsdWUuX19leHRlbmRfXykgcHJvdG9ba2V5XSA9IHByb3RvVmFsdWUuX19leHRlbmRfXyh2YWx1ZSk7IGVsc2UgewogICAgICAgICAgICBwcm90b1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChUT1NUUklOR19CVUcgJiYgc291cmNlW2tleSA9ICJ0b1N0cmluZyJdICE9PSB0b1N0cmluZykgcHJvdG9ba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHZhciBCYXNlQ2xhc3MgPSBleHRlbmQoY3JlYXRlQ2xhc3MsIHsKICAgICAgY2xhc3NOYW1lOiAiYmFzaXMuQ2xhc3MiLAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IGZhbHNlLAogICAgICBwcm90b3R5cGU6IHsKICAgICAgICBiYXNpc09iamVjdElkOiAwLAogICAgICAgIGNvbnN0cnVjdG9yOiBudWxsLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgcG9zdEluaXQ6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICJbb2JqZWN0ICIgKyAodGhpcy5jb25zdHJ1Y3RvciB8fCB0aGlzKS5jbGFzc05hbWUgKyAiXSI7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gdGhpcykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodGhpcywgcHJvcCkpIHRoaXNbcHJvcF0gPSBudWxsOwogICAgICAgICAgdGhpcy5kZXN0cm95ID0gJHVuZGVmOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgY3VzdG9tRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24sIGZuLCBkZXZOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgX19leHRlbmRfXzogZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CiAgICAgICAgICBpZiAoIWV4dGVuc2lvbikgcmV0dXJuIGV4dGVuc2lvbjsKICAgICAgICAgIGlmIChleHRlbnNpb24gJiYgZXh0ZW5zaW9uLl9fZXh0ZW5kX18pIHJldHVybiBleHRlbnNpb247CiAgICAgICAgICB2YXIgQmFzZSA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgICBCYXNlID0gZGV2VmVyYm9zZU5hbWUoZGV2TmFtZSB8fCAiY3VzdG9tRXh0ZW5kUHJvcGVydHkiLCB7fSwgQmFzZSk7CiAgICAgICAgICBCYXNlLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEJhc2U7CiAgICAgICAgICBmbihyZXN1bHQsIGV4dGVuc2lvbik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfS5fX2V4dGVuZF9fKGV4dGVuc2lvbiB8fCB7fSk7CiAgICB9OwogICAgdmFyIGV4dGVuc2libGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBleHRlbmQsICJleHRlbnNpYmxlUHJvcGVydHkiKTsKICAgIH07CiAgICB2YXIgbmVzdGVkRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgcmV0dXJuIGN1c3RvbUV4dGVuZFByb3BlcnR5KGV4dGVuc2lvbiwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbnNpb24pIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5zaW9uKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSByZXN1bHRba2V5XTsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUgJiYgdmFsdWUuX19leHRlbmRfXyA/IHZhbHVlLl9fZXh0ZW5kX18oZXh0ZW5zaW9uW2tleV0pIDogZXh0ZW5zaWJsZVByb3BlcnR5KGV4dGVuc2lvbltrZXldKTsKICAgICAgICB9CiAgICAgIH0sICJuZXN0ZWRFeHRlbmRQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBvbmVGdW5jdGlvblByb3BlcnR5ID0gZnVuY3Rpb24oZm4sIGtleXMpIHsKICAgICAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlCiAgICAgICAgfTsKICAgICAgICBpZiAoa2V5cykgewogICAgICAgICAgaWYgKGtleXMuX19leHRlbmRfXykgcmV0dXJuIGtleXM7CiAgICAgICAgICB2YXIgQ2xzID0gZGV2VmVyYm9zZU5hbWUoIm9uZUZ1bmN0aW9uUHJvcGVydHkiLCB7fSwgZnVuY3Rpb24oKSB7fSk7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2xzOwogICAgICAgICAgcmVzdWx0Ll9fZXh0ZW5kX18gPSBjcmVhdGU7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4ga2V5cykgaWYgKGtleXNba2V5XSkgcmVzdWx0W2tleV0gPSBmbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgcmV0dXJuIGNyZWF0ZShrZXlzIHx8IHt9KTsKICAgIH07CiAgICByZXR1cm4gZXh0ZW5kKEJhc2VDbGFzcywgewogICAgICBhbGxfOiBjbGFzc2VzLAogICAgICBTRUxGOiBTRUxGLAogICAgICBjcmVhdGU6IGNyZWF0ZUNsYXNzLAogICAgICBpc0NsYXNzOiBpc0NsYXNzLAogICAgICBjdXN0b21FeHRlbmRQcm9wZXJ0eTogY3VzdG9tRXh0ZW5kUHJvcGVydHksCiAgICAgIGV4dGVuc2libGVQcm9wZXJ0eTogZXh0ZW5zaWJsZVByb3BlcnR5LAogICAgICBuZXN0ZWRFeHRlbmRQcm9wZXJ0eTogbmVzdGVkRXh0ZW5kUHJvcGVydHksCiAgICAgIG9uZUZ1bmN0aW9uUHJvcGVydHk6IG9uZUZ1bmN0aW9uUHJvcGVydHkKICAgIH0pOwogIH0oKTsKICB2YXIgVG9rZW4gPSBDbGFzcyhudWxsLCB7CiAgICBjbGFzc05hbWU6ICJiYXNpcy5Ub2tlbiIsCiAgICB2YWx1ZTogbnVsbCwKICAgIGhhbmRsZXI6IG51bGwsCiAgICBkZWZlcnJlZFRva2VuOiBudWxsLAogICAgYmluZGluZ0JyaWRnZTogewogICAgICBhdHRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KSB7CiAgICAgICAgaG9zdC5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICB9LAogICAgICBkZXRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KSB7CiAgICAgICAgaG9zdC5kZXRhY2goZm4sIGNvbnRleHQpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGhvc3QpIHsKICAgICAgICByZXR1cm4gaG9zdC5nZXQoKTsKICAgICAgfQogICAgfSwKICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgIH0KICAgIH0sCiAgICBhdHRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGlmIChjdXJzb3IuZm4gPT09IGZuICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5Ub2tlbiNhdHRhY2g6IGR1cGxpY2F0ZSBmbiAmIGNvbnRleHQgcGFpciIpOwogICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgZm46IGZuLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgaGFuZGxlcjogdGhpcy5oYW5kbGVyCiAgICAgIH07CiAgICB9LAogICAgZGV0YWNoOiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgdmFyIHByZXY7CiAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICBjdXJzb3IuZm4gPSAkdW5kZWY7CiAgICAgICAgcHJldi5oYW5kbGVyID0gY3Vyc29yLmhhbmRsZXI7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2RldGFjaDogZm4gJiBjb250ZXh0IHBhaXIgbm90IGZvdW5kLCBub3RoaW5nIHdhcyByZW1vdmVkIik7CiAgICB9LAogICAgYXBwbHk6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwogICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBjdXJzb3IuZm4uY2FsbChjdXJzb3IuY29udGV4dCwgdmFsdWUpOwogICAgfSwKICAgIGRlZmVycmVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy5kZWZlcnJlZFRva2VuOwogICAgICBpZiAoIXRva2VuKSB7CiAgICAgICAgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW4gPSBuZXcgRGVmZXJyZWRUb2tlbih0aGlzLnZhbHVlKTsKICAgICAgICB0aGlzLmF0dGFjaCh0b2tlbi5zZXQsIHRva2VuKTsKICAgICAgfQogICAgICByZXR1cm4gdG9rZW47CiAgICB9LAogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmRlZmVycmVkVG9rZW4pIHsKICAgICAgICB0aGlzLmRlZmVycmVkVG9rZW4uZGVzdHJveSgpOwogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbiA9IG51bGw7CiAgICAgIH0KICAgICAgdGhpcy5oYW5kbGVyID0gbnVsbDsKICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICAgIHRoaXMuYXR0YWNoID0gJHVuZGVmOwogICAgICB0aGlzLmRldGFjaCA9ICR1bmRlZjsKICAgIH0KICB9KTsKICB2YXIgYXdhaXRUb0FwcGx5ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdG9rZW5zID0ge307CiAgICB2YXIgdGltZXI7CiAgICBmdW5jdGlvbiBhcHBseVRva2VucygpIHsKICAgICAgdmFyIGxpc3QgPSB0b2tlbnM7CiAgICAgIHRva2VucyA9IHt9OwogICAgICB0aW1lciA9IG51bGw7CiAgICAgIGZvciAodmFyIGtleSBpbiBsaXN0KSBsaXN0W2tleV0uYXBwbHkoKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih0b2tlbikgewogICAgICBpZiAodG9rZW4uYmFzaXNPYmplY3RJZCBpbiB0b2tlbnMpIHJldHVybjsKICAgICAgdG9rZW5zW3Rva2VuLmJhc2lzT2JqZWN0SWRdID0gdG9rZW47CiAgICAgIGlmICghdGltZXIpIHNldEltbWVkaWF0ZShhcHBseVRva2Vucyk7CiAgICB9OwogIH0oKTsKICB2YXIgRGVmZXJyZWRUb2tlbiA9IFRva2VuLnN1YmNsYXNzKHsKICAgIGNsYXNzTmFtZTogImJhc2lzLkRlZmVycmVkVG9rZW4iLAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgYXdhaXRUb0FwcGx5KHRoaXMpOwogICAgICB9CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICB2YXIgcmVzb3VyY2VzID0ge307CiAgdmFyIHJlc291cmNlQ29udGVudENhY2hlID0ge307CiAgdmFyIHJlc291cmNlUGF0Y2ggPSB7fTsKICB2YXIgdmlydHVhbFJlc291cmNlU2VlZCA9IDE7CiAgdmFyIHJlc291cmNlUmVzb2x2aW5nU3RhY2sgPSBbXTsKICB2YXIgcmVxdWlyZXM7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX3Jlc291cmNlc19fICE9ICJ1bmRlZmluZWQiID8gX19yZXNvdXJjZXNfXyA6IG51bGw7CiAgICBpZiAobWFwKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBtYXApIHJlc291cmNlQ29udGVudENhY2hlW3BhdGhVdGlscy5yZXNvbHZlKGtleSldID0gbWFwW2tleV07CiAgICB9CiAgfSkoKTsKICBmdW5jdGlvbiBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSkgewogICAgdmFyIHBhdGNoZXMgPSByZXNvdXJjZVBhdGNoW3Jlc291cmNlLnVybF07CiAgICBpZiAocGF0Y2hlcykgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnNvbGVNZXRob2RzLmluZm8oIkFwcGx5IHBhdGNoIGZvciAiICsgcmVzb3VyY2UudXJsKTsKICAgICAgcGF0Y2hlc1tpXShyZXNvdXJjZS5nZXQoKSwgcmVzb3VyY2UudXJsKTsKICAgIH0KICB9CiAgdmFyIGdldFJlc291cmNlQ29udGVudCA9IGZ1bmN0aW9uKHVybCwgaWdub3JlQ2FjaGUpIHsKICAgIGlmIChpZ25vcmVDYWNoZSB8fCAhcmVzb3VyY2VDb250ZW50Q2FjaGUuaGFzT3duUHJvcGVydHkodXJsKSkgewogICAgICB2YXIgcmVzb3VyY2VDb250ZW50ID0gIiI7CiAgICAgIGlmICghTk9ERV9FTlYpIHsKICAgICAgICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgICAgIHJlcS5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCAobmV3IERhdGUoMCkpLnRvR01UU3RyaW5nKCkpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJYLUJhc2lzLVJlc291cmNlIiwgMSk7CiAgICAgICAgcmVxLnNlbmQoIiIpOwogICAgICAgIGlmIChyZXEuc3RhdHVzID49IDIwMCAmJiByZXEuc3RhdHVzIDwgNDAwKSByZXNvdXJjZUNvbnRlbnQgPSByZXEucmVzcG9uc2VUZXh0OyBlbHNlIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJiYXNpcy5yZXNvdXJjZTogVW5hYmxlIHRvIGxvYWQgIiArIHVybCArICIgKHN0YXR1cyBjb2RlICIgKyByZXEuc3RhdHVzICsgIikiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc291cmNlQ29udGVudCA9IHByb2Nlc3MuYmFzaXNqc1JlYWRGaWxlID8gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUodXJsKSA6IHJlcXVpcmUoImZzIikucmVhZEZpbGVTeW5jKHVybCwgInV0Zi04Iik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsLCBlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzb3VyY2VDb250ZW50Q2FjaGVbdXJsXSA9IHJlc291cmNlQ29udGVudDsKICAgIH0KICAgIHJldHVybiByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdOwogIH07CiAgdmFyIGNyZWF0ZVJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwsIGNvbnRlbnQpIHsKICAgIHZhciBjb250ZW50VHlwZSA9IHBhdGhVdGlscy5leHRuYW1lKHJlc291cmNlVXJsKTsKICAgIHZhciBjb250ZW50V3JhcHBlciA9IGdldFJlc291cmNlLmV4dGVuc2lvbnNbY29udGVudFR5cGVdOwogICAgdmFyIGlzVmlydHVhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxOwogICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CiAgICB2YXIgd3JhcHBlZCA9IGZhbHNlOwogICAgdmFyIHdyYXBwZWRDb250ZW50OwogICAgaWYgKGlzVmlydHVhbCkgcmVzb3VyY2VVcmwgKz0gIiN2aXJ0dWFsIjsKICAgIHZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAocmVzb2x2ZWQpIHJldHVybiBjb250ZW50OwogICAgICB2YXIgdXJsQ29udGVudCA9IGlzVmlydHVhbCA/IGNvbnRlbnQgOiBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpOwogICAgICB2YXIgaWR4ID0gcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5pbmRleE9mKHJlc291cmNlVXJsKTsKICAgICAgaWYgKGlkeCAhPSAtMSkgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2UgcmVjdXJzaW9uOiIsIHJlc291cmNlUmVzb2x2aW5nU3RhY2suc2xpY2UoaWR4KS5jb25jYXQocmVzb3VyY2VVcmwpLm1hcChwYXRoVXRpbHMucmVsYXRpdmUsIHBhdGhVdGlscykuam9pbigiIC0+ICIpKTsKICAgICAgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wdXNoKHJlc291cmNlVXJsKTsKICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyKSB7CiAgICAgICAgaWYgKCF3cmFwcGVkKSB7CiAgICAgICAgICB3cmFwcGVkID0gdHJ1ZTsKICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50V3JhcHBlcih1cmxDb250ZW50LCByZXNvdXJjZVVybCk7CiAgICAgICAgICB3cmFwcGVkQ29udGVudCA9IHVybENvbnRlbnQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICB9CiAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnBvcCgpOwogICAgICByZXR1cm4gY29udGVudDsKICAgIH07CiAgICBleHRlbmQocmVzb3VyY2UsIGV4dGVuZChuZXcgVG9rZW4sIHsKICAgICAgdXJsOiByZXNvdXJjZVVybCwKICAgICAgdHlwZTogY29udGVudFR5cGUsCiAgICAgIHZpcnR1YWw6IGlzVmlydHVhbCwKICAgICAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByZXNvdXJjZSgpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJbYmFzaXMucmVzb3VyY2UgIiArIHJlc291cmNlVXJsICsgIl0iOwogICAgICB9LAogICAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgIH0sCiAgICAgIGhhc0NoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBjb250ZW50V3JhcHBlciA/IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSAhPT0gd3JhcHBlZENvbnRlbnQgOiBmYWxzZTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihuZXdDb250ZW50KSB7CiAgICAgICAgaWYgKCFyZXNvbHZlZCB8fCBpc1ZpcnR1YWwgfHwgbmV3Q29udGVudCAhPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0pIHsKICAgICAgICAgIGlmICghaXNWaXJ0dWFsKSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gPSBuZXdDb250ZW50OwogICAgICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyKSB7CiAgICAgICAgICAgIGlmICghd3JhcHBlZCAmJiBpc1ZpcnR1YWwpIGNvbnRlbnQgPSBuZXdDb250ZW50OwogICAgICAgICAgICBpZiAod3JhcHBlZCAmJiAhY29udGVudFdyYXBwZXIucGVybWFuZW50KSB7CiAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKG5ld0NvbnRlbnQsIHJlc291cmNlVXJsLCBjb250ZW50KTsKICAgICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoaXNWaXJ0dWFsKSByZXR1cm47CiAgICAgICAgdmFyIG9sZENvbnRlbnQgPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF07CiAgICAgICAgdmFyIG5ld0NvbnRlbnQgPSBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwsIHRydWUpOwogICAgICAgIGlmIChuZXdDb250ZW50ICE9IG9sZENvbnRlbnQpIHsKICAgICAgICAgIHJlc29sdmVkID0gZmFsc2U7CiAgICAgICAgICByZXNvdXJjZS51cGRhdGUobmV3Q29udGVudCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmIChpc1ZpcnR1YWwpIGlmIChzb3VyY2UpIHJldHVybiBjb250ZW50V3JhcHBlciA/IHdyYXBwZWRDb250ZW50IDogY29udGVudDsKICAgICAgICByZXR1cm4gc291cmNlID8gZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsKSA6IHJlc291cmNlKCk7CiAgICAgIH0sCiAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgZm4uY2FsbChjb250ZXh0LCByZXNvdXJjZSgpKTsKICAgICAgICAgIGlmIChjb250ZW50V3JhcHBlciAmJiBjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmVzb3VyY2UuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgIH0KICAgIH0pKTsKICAgIHJlc291cmNlc1tyZXNvdXJjZVVybF0gPSByZXNvdXJjZTsKICAgIHJldHVybiByZXNvdXJjZTsKICB9OwogIHZhciBnZXRSZXNvdXJjZSA9IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICB2YXIgcmVzb3VyY2UgPSByZXNvdXJjZXNbcmVzb3VyY2VVcmxdOwogICAgaWYgKHJlc291cmNlKSByZXR1cm4gcmVzb3VyY2U7CiAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlKCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgcmVzb3VyY2VVcmwgPSBwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCk7CiAgICByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CiAgICByZXR1cm4gcmVzb3VyY2UgfHwgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2VVcmwpOwogIH07CiAgZXh0ZW5kKGdldFJlc291cmNlLCB7CiAgICBpc1Jlc291cmNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPyByZXNvdXJjZXNbdmFsdWUudXJsXSA9PT0gdmFsdWUgOiBmYWxzZTsKICAgIH0sCiAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICB2YXIgcmVzb3VyY2UgPSBnZXRSZXNvdXJjZS5nZXQocmVzb3VyY2VVcmwpOwogICAgICByZXR1cm4gcmVzb3VyY2UgPyByZXNvdXJjZS5pc1Jlc29sdmVkKCkgOiBmYWxzZTsKICAgIH0sCiAgICBleGlzdHM6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZXhpc3RzKCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICByZXR1cm4gcmVzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlLmdldCgnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmVzb3VyY2VVcmwgPSBwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCk7CiAgICAgIGlmICghZ2V0UmVzb3VyY2UuZXhpc3RzKHJlc291cmNlVXJsKSkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBnZXRSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgICB9LAogICAgZ2V0RmlsZXM6IGZ1bmN0aW9uKGNhY2hlKSB7CiAgICAgIHJldHVybiBrZXlzKGNhY2hlID8gcmVzb3VyY2VDb250ZW50Q2FjaGUgOiByZXNvdXJjZXMpLm1hcChwYXRoVXRpbHMucmVsYXRpdmUpOwogICAgfSwKICAgIHZpcnR1YWw6IGZ1bmN0aW9uKHR5cGUsIGNvbnRlbnQsIG93bmVyVXJsKSB7CiAgICAgIHJldHVybiBjcmVhdGVSZXNvdXJjZSgob3duZXJVcmwgPyBvd25lclVybCArICI6IiA6IHBhdGhVdGlscy5ub3JtYWxpemUocGF0aFV0aWxzLmJhc2VVUkkgPT0gIi8iID8gIiIgOiBwYXRoVXRpbHMuYmFzZVVSSSkgKyAiLyIpICsgInZpcnR1YWwtcmVzb3VyY2UiICsgdmlydHVhbFJlc291cmNlU2VlZCsrICsgIi4iICsgdHlwZSwgY29udGVudCk7CiAgICB9LAogICAgZXh0ZW5zaW9uczogewogICAgICAiLmpzIjogZXh0ZW5kKGZ1bmN0aW9uKGNvbnRlbnQsIGZpbGVuYW1lKSB7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV07CiAgICAgICAgaWYgKCFuYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpbXBsaWNpdE5hbWVzcGFjZSA9IHRydWU7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRGaWxlbmFtZSA9IHBhdGhVdGlscy5kaXJuYW1lKGZpbGVuYW1lKSArICIvIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKTsKICAgICAgICAgIGZvciAodmFyIG5zIGluIG5zUm9vdFBhdGgpIHsKICAgICAgICAgICAgdmFyIHBhdGggPSBuc1Jvb3RQYXRoW25zXSArIG5zICsgIi8iOwogICAgICAgICAgICBpZiAocmVzb2x2ZWRGaWxlbmFtZS5zdWJzdHIoMCwgcGF0aC5sZW5ndGgpID09IHBhdGgpIHsKICAgICAgICAgICAgICBpbXBsaWNpdE5hbWVzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIHJlc29sdmVkRmlsZW5hbWUgPSByZXNvbHZlZEZpbGVuYW1lLnN1YnN0cihuc1Jvb3RQYXRoW25zXS5sZW5ndGgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lc3BhY2UgPSByZXNvbHZlZEZpbGVuYW1lLnJlcGxhY2UoL1wuL2csICJfIikucmVwbGFjZSgvXlwvL2csICIiKS5yZXBsYWNlKC9cLy9nLCAiLiIpOwogICAgICAgICAgaWYgKGltcGxpY2l0TmFtZXNwYWNlKSBuYW1lc3BhY2UgPSAiaW1wbGljaXQuIiArIG5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlcXVpcmVzKSBhcnJheUZ1bmN0aW9ucy5hZGQocmVxdWlyZXMsIG5hbWVzcGFjZSk7CiAgICAgICAgaWYgKCFuYW1lc3BhY2VzW25hbWVzcGFjZV0pIHsKICAgICAgICAgIHZhciBucyA9IGdldE5hbWVzcGFjZShuYW1lc3BhY2UpOwogICAgICAgICAgdmFyIHNhdmVkUmVxdWlyZXMgPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gW107CiAgICAgICAgICBucy5leHBvcnRzID0gcnVuU2NyaXB0SW5Db250ZXh0KHsKICAgICAgICAgICAgcGF0aDogbnMucGF0aCwKICAgICAgICAgICAgZXhwb3J0czogbnMuZXhwb3J0cwogICAgICAgICAgfSwgZmlsZW5hbWUsIGNvbnRlbnQpLmV4cG9ydHM7CiAgICAgICAgICBpZiAobnMuZXhwb3J0cyAmJiBucy5leHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5zLCBucy5leHBvcnRzKTsKICAgICAgICAgIG5zLmZpbGVuYW1lXyA9IGZpbGVuYW1lOwogICAgICAgICAgbnMuc291cmNlXyA9IGNvbnRlbnQ7CiAgICAgICAgICBucy5yZXF1aXJlc18gPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gc2F2ZWRSZXF1aXJlczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5hbWVzcGFjZXNbbmFtZXNwYWNlXS5leHBvcnRzOwogICAgICB9LCB7CiAgICAgICAgcGVybWFuZW50OiB0cnVlCiAgICAgIH0pLAogICAgICAiLmNzcyI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCwgY3NzUmVzb3VyY2UpIHsKICAgICAgICBpZiAoIWNzc1Jlc291cmNlKSBjc3NSZXNvdXJjZSA9IG5ldyBDc3NSZXNvdXJjZSh1cmwpOwogICAgICAgIGNzc1Jlc291cmNlLnVwZGF0ZUNzc1RleHQoY29udGVudCk7CiAgICAgICAgcmV0dXJuIGNzc1Jlc291cmNlOwogICAgICB9LAogICAgICAiLmpzb24iOiBmdW5jdGlvbihjb250ZW50LCB1cmwpIHsKICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT0gIm9iamVjdCIpIHJldHVybiBjb250ZW50OwogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnRlbnQgPSBTdHJpbmcoY29udGVudCk7CiAgICAgICAgICByZXN1bHQgPSBiYXNpcy5qc29uLnBhcnNlKGNvbnRlbnQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnJlc291cmNlOiBDYW4ndCBwYXJzZSBKU09OIGZyb20gIiArIHVybCwgewogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgY29udGVudDogY29udGVudAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQgfHwgbnVsbDsKICAgICAgfQogICAgfQogIH0pOwogIGZ1bmN0aW9uIGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIGFyZ3MsIGJvZHkpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSArICJcblxuLy8jIHNvdXJjZVVSTD0iICsgcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGlmIChkb2N1bWVudCAmJiAibGluZSIgaW4gZSA9PSBmYWxzZSAmJiAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSB7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgZnVuY3Rpb24gb25lcnJvcihldmVudCkgewogICAgICAgICAgaWYgKGV2ZW50LmZpbGVuYW1lID09IHBhdGhVdGlscy5vcmlnaW4gKyBzb3VyY2VVUkwpIHsKICAgICAgICAgICAgZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgb25lcnJvcik7CiAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgZXZlbnQuZmlsZW5hbWUgKyAiOiIgKyBldmVudC5saW5lbm8gKyAiOiAiICsgZSk7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5zcmMgPSBzb3VyY2VVUkw7CiAgICAgICAgc2NyaXB0LmFzeW5jID0gZmFsc2U7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgfQogICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiQ29tcGlsYXRpb24gZXJyb3IgYXQgIiArIHNvdXJjZVVSTCArICgibGluZSIgaW4gZSA/ICI6IiArIChlLmxpbmUgLSAxKSA6ICIiKSArICI6ICIgKyBlKTsKICAgIH0KICB9CiAgdmFyIHJ1blNjcmlwdEluQ29udGV4dCA9IGZ1bmN0aW9uKGNvbnRleHQsIHNvdXJjZVVSTCwgc291cmNlQ29kZSkgewogICAgdmFyIGJhc2VVUkwgPSBwYXRoVXRpbHMuZGlybmFtZShzb3VyY2VVUkwpICsgIi8iOwogICAgdmFyIGNvbXBpbGVkU291cmNlQ29kZSA9IHNvdXJjZUNvZGU7CiAgICBpZiAoIWNvbnRleHQuZXhwb3J0cykgY29udGV4dC5leHBvcnRzID0ge307CiAgICBpZiAodHlwZW9mIGNvbXBpbGVkU291cmNlQ29kZSAhPSAiZnVuY3Rpb24iKSBjb21waWxlZFNvdXJjZUNvZGUgPSBjb21waWxlRnVuY3Rpb24oc291cmNlVVJMLCBbICJleHBvcnRzIiwgIm1vZHVsZSIsICJiYXNpcyIsICJnbG9iYWwiLCAiX19maWxlbmFtZSIsICJfX2Rpcm5hbWUiLCAicmVzb3VyY2UiLCAicmVxdWlyZSIgXSwgJyJ1c2Ugc3RyaWN0IjtcbicgKyBzb3VyY2VDb2RlKTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlID09ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZS5jYWxsKGNvbnRleHQuZXhwb3J0cywgY29udGV4dC5leHBvcnRzLCBjb250ZXh0LCBiYXNpcywgZ2xvYmFsLCBzb3VyY2VVUkwsIGJhc2VVUkwsIGZ1bmN0aW9uKHJlbGF0aXZlUGF0aCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVsYXRpdmVQYXRoKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiByZXNvdXJjZSgnIiArIHJlbGF0aXZlUGF0aCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJldHVybiBnZXRSZXNvdXJjZShwYXRoVXRpbHMucmVzb2x2ZShiYXNlVVJMLCByZWxhdGl2ZVBhdGgpKTsKICAgIH0sIGZ1bmN0aW9uKHJlbGF0aXZlUGF0aCwgYmFzZSkgewogICAgICByZXR1cm4gcmVxdWlyZU5hbWVzcGFjZShyZWxhdGl2ZVBhdGgsIGJhc2UgfHwgYmFzZVVSTCk7CiAgICB9KTsKICAgIHJldHVybiBjb250ZXh0OwogIH07CiAgdmFyIG5hbWVzcGFjZXMgPSB7fTsKICB2YXIgbmFtZXNwYWNlMmZpbGVuYW1lID0ge307CiAgdmFyIGZpbGVuYW1lMm5hbWVzcGFjZSA9IHt9OwogIHZhciBuc1Jvb3RQYXRoID0ge307CiAgaXRlcmF0ZShjb25maWcubW9kdWxlcywgZnVuY3Rpb24obmFtZSwgbW9kdWxlKSB7CiAgICBuc1Jvb3RQYXRoW25hbWVdID0gbW9kdWxlLnBhdGggKyAiLyI7CiAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZV0gPSBtb2R1bGUuZmlsZW5hbWU7CiAgICBmaWxlbmFtZTJuYW1lc3BhY2VbbW9kdWxlLmZpbGVuYW1lXSA9IG5hbWU7CiAgfSk7CiAgKGZ1bmN0aW9uKG1hcCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX25hbWVzcGFjZV9tYXBfXyAhPSAidW5kZWZpbmVkIiA/IF9fbmFtZXNwYWNlX21hcF9fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGtleSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IG1hcFtrZXldOwogICAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV0gPSBmaWxlbmFtZTsKICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5hbWVzcGFjZSA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLk5hbWVzcGFjZSIsCiAgICBpbml0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZXhwb3J0cyA9IHsKICAgICAgICBwYXRoOiB0aGlzLm5hbWUKICAgICAgfTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAiW2Jhc2lzLm5hbWVzcGFjZSAiICsgdGhpcy5wYXRoICsgIl0iOwogICAgfSwKICAgIGV4dGVuZDogZnVuY3Rpb24obmFtZXMpIHsKICAgICAgZXh0ZW5kKHRoaXMuZXhwb3J0cywgbmFtZXMpOwogICAgICByZXR1cm4gY29tcGxldGUodGhpcywgbmFtZXMpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHJlc29sdmVOU0ZpbGVuYW1lKG5hbWVzcGFjZSkgewogICAgaWYgKG5hbWVzcGFjZSBpbiBuYW1lc3BhY2UyZmlsZW5hbWUgPT0gZmFsc2UpIHsKICAgICAgdmFyIHBhcnRzID0gbmFtZXNwYWNlLnNwbGl0KCIuIik7CiAgICAgIHZhciBuYW1lc3BhY2VSb290ID0gcGFydHMuc2hpZnQoKTsKICAgICAgdmFyIGZpbGVuYW1lID0gcGFydHMuam9pbigiLyIpICsgIi5qcyI7CiAgICAgIGlmIChuYW1lc3BhY2VSb290IGluIG5zUm9vdFBhdGggPT0gZmFsc2UpIG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gPSBwYXRoVXRpbHMuYmFzZVVSSSArIG5hbWVzcGFjZVJvb3QgKyAiLyI7CiAgICAgIGlmIChuYW1lc3BhY2VSb290ID09IG5hbWVzcGFjZSkgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdLnJlcGxhY2UoL1wvJC8sICIiKSArICIuanMiOyBlbHNlIGZpbGVuYW1lID0gbnNSb290UGF0aFtuYW1lc3BhY2VSb290XSArIGZpbGVuYW1lOwogICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICBmaWxlbmFtZTJuYW1lc3BhY2VbZmlsZW5hbWVdID0gbmFtZXNwYWNlOwogICAgfQogICAgcmV0dXJuIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdOwogIH0KICBmdW5jdGlvbiBnZXRSb290TmFtZXNwYWNlKG5hbWUpIHsKICAgIHZhciBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdOwogICAgaWYgKCFuYW1lc3BhY2UpIHsKICAgICAgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXSA9IG5ldyBOYW1lc3BhY2UobmFtZSk7CiAgICAgIG5hbWVzcGFjZS5uYW1lc3BhY2VzXyA9IHt9OwogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc19bbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgIGlmICghY29uZmlnLm5vQ29uZmxpY3QpIGdsb2JhbFtuYW1lXSA9IG5hbWVzcGFjZTsKICAgIH0KICAgIGlmIChuYW1lID09ICJiYnQiICYmICFiYnQpIGJidCA9IG5hbWVzcGFjZXNbbmFtZV07CiAgICByZXR1cm4gbmFtZXNwYWNlOwogIH0KICBmdW5jdGlvbiBnZXROYW1lc3BhY2UocGF0aCkgewogICAgcGF0aCA9IHBhdGguc3BsaXQoIi4iKTsKICAgIHZhciByb290TnMgPSBnZXRSb290TmFtZXNwYWNlKHBhdGhbMF0pOwogICAgdmFyIGN1cnNvciA9IHJvb3ROczsKICAgIGZvciAodmFyIGkgPSAxLCBuYW1lOyBuYW1lID0gcGF0aFtpXTsgaSsrKSB7CiAgICAgIGlmICghY3Vyc29yW25hbWVdKSB7CiAgICAgICAgdmFyIG5zcGF0aCA9IHBhdGguc2xpY2UoMCwgaSArIDEpLmpvaW4oIi4iKTsKICAgICAgICBjdXJzb3JbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5zcGF0aCk7CiAgICAgICAgcm9vdE5zLm5hbWVzcGFjZXNfW25zcGF0aF0gPSBjdXJzb3JbbmFtZV07CiAgICAgIH0KICAgICAgY3Vyc29yID0gY3Vyc29yW25hbWVdOwogICAgfQogICAgbmFtZXNwYWNlc1twYXRoLmpvaW4oIi4iKV0gPSBjdXJzb3I7CiAgICByZXR1cm4gY3Vyc29yOwogIH0KICB2YXIgcmVxdWlyZU5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKE5PREVfRU5WKSB7CiAgICAgIHZhciBtb2R1bGVQcm90byA9IG1vZHVsZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpIHx8IHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSA9PSAiLmpzIikgewogICAgICAgICAgdmFyIF9jb21waWxlID0gbW9kdWxlUHJvdG8uX2NvbXBpbGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0TmFtZXNwYWNlKGZpbGVuYW1lKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNpcyA9IGJhc2lzOwogICAgICAgICAgICBjb250ZW50ID0gInZhciBfX25vZGVqc1JlcXVpcmUgPSByZXF1aXJlO1xuIiArICJ2YXIgYmFzaXMgPSBtb2R1bGUuYmFzaXM7XG4iICsgJ3ZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKXsgcmV0dXJuIGJhc2lzLnJlc291cmNlKF9fZGlybmFtZSArICIvIiArIGZpbGVuYW1lKSB9O1xuJyArICJ2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBiYXNlVVJJKXsgcmV0dXJuIGJhc2lzLnJlcXVpcmUoZmlsZW5hbWUsIGJhc2VVUkkgfHwgX19kaXJuYW1lKSB9O1xuIiArIGNvbnRlbnQ7CiAgICAgICAgICAgIF9jb21waWxlLmNhbGwoZXh0ZW5kKHRoaXMsIG5hbWVzcGFjZSksIGNvbnRlbnQsIGZpbGVuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXhwb3J0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIi8iKSk7CiAgICAgICAgICBuYW1lc3BhY2UuZXhwb3J0cyA9IGV4cG9ydHM7CiAgICAgICAgICBpZiAoZXhwb3J0cyAmJiBleHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5hbWVzcGFjZSwgZXhwb3J0cyk7CiAgICAgICAgICBtb2R1bGVQcm90by5fY29tcGlsZSA9IF9jb21waWxlOwogICAgICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogcmVxdWlyZSgnIiArIGZpbGVuYW1lICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2UoZmlsZW5hbWUpLmZldGNoKCk7CiAgICAgIH07CiAgICB9CiAgfSgpOwogIGZ1bmN0aW9uIHBhdGNoKGZpbGVuYW1lLCBwYXRjaEZuKSB7CiAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gIi5qcyIpIHsKICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZmlsZW5hbWUpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnBhdGNoKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgIH0KICAgIGlmICghcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0pIHJlc291cmNlUGF0Y2hbZmlsZW5hbWVdID0gWyBwYXRjaEZuIF07IGVsc2UgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0ucHVzaChwYXRjaEZuKTsKICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChmaWxlbmFtZSk7CiAgICBpZiAocmVzb3VyY2UgJiYgcmVzb3VyY2UuaXNSZXNvbHZlZCgpKSBwYXRjaEZuKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogIH0KICBjb21wbGV0ZShGdW5jdGlvbi5wcm90b3R5cGUsIHsKICAgIGJpbmQ6IGZ1bmN0aW9uKHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGZuID0gdGhpczsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMsIDEpOwogICAgICByZXR1cm4gcGFyYW1zLmxlbmd0aCA/IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBwYXJhbXMuY29uY2F0LmFwcGx5KHBhcmFtcywgYXJndW1lbnRzKSk7CiAgICAgIH0gOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpc09iamVjdCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShBcnJheSwgewogICAgaXNBcnJheTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAiW29iamVjdCBBcnJheV0iOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIGFycmF5RnJvbShvYmplY3QsIG9mZnNldCkgewogICAgaWYgKG9iamVjdCAhPSBudWxsKSB7CiAgICAgIHZhciBsZW4gPSBvYmplY3QubGVuZ3RoOwogICAgICBpZiAodHlwZW9mIGxlbiA9PSAidW5kZWZpbmVkIiB8fCB0b1N0cmluZy5jYWxsKG9iamVjdCkgPT0gIltvYmplY3QgRnVuY3Rpb25dIikgcmV0dXJuIFsgb2JqZWN0IF07CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwOwogICAgICBpZiAobGVuIC0gb2Zmc2V0ID4gMCkgewogICAgICAgIGZvciAodmFyIHJlc3VsdCA9IFtdLCBrID0gMCwgaSA9IG9mZnNldDsgaSA8IGxlbjsgKSByZXN1bHRbaysrXSA9IG9iamVjdFtpKytdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQXJyYXkobGVuZ3RoLCBmaWxsVmFsdWUsIHRoaXNPYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBpc0Z1bmMgPSB0eXBlb2YgZmlsbFZhbHVlID09ICJmdW5jdGlvbiI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSByZXN1bHRbaV0gPSBpc0Z1bmMgPyBmaWxsVmFsdWUuY2FsbCh0aGlzT2JqZWN0LCBpLCByZXN1bHQpIDogZmlsbFZhbHVlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgY29tcGxldGUoQXJyYXkucHJvdG90eXBlLCB7CiAgICBpbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpIHsKICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCkgfHwgMDsKICAgICAgaWYgKG9mZnNldCA8IDApIHJldHVybiAtMTsKICAgICAgZm9yICg7IG9mZnNldCA8IHRoaXMubGVuZ3RoOyBvZmZzZXQrKykgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGxhc3RJbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKTsKICAgICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID49IGxlbikgb2Zmc2V0ID0gbGVuIC0gMTsgZWxzZSBvZmZzZXQgPSAob2Zmc2V0ICsgbGVuKSAlIGxlbjsKICAgICAgZm9yICg7IG9mZnNldCA+PSAwOyBvZmZzZXQtLSkgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGZvckVhY2g6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgfSwKICAgIGV2ZXJ5OiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiAhY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBzb21lOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcyAmJiBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXN1bHQucHVzaCh0aGlzW2ldKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIHJlc3VsdFtpXSA9IGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAogICAgcmVkdWNlOiBmdW5jdGlvbihjYWxsYmFjaywgaW5pdGlhbFZhbHVlKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgdmFyIGFyZ3NMZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICBpZiAobGVuID09IDAgJiYgYXJnc0xlbiA9PSAxKSB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgaW5pdGVkID0gMDsKICAgICAgaWYgKGFyZ3NMZW4gPiAxKSB7CiAgICAgICAgcmVzdWx0ID0gaW5pdGlhbFZhbHVlOwogICAgICAgIGluaXRlZCA9IDE7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgaWYgKGluaXRlZCsrKSByZXN1bHQgPSBjYWxsYmFjay5jYWxsKG51bGwsIHJlc3VsdCwgdGhpc1tpXSwgaSwgdGhpcyk7IGVsc2UgcmVzdWx0ID0gdGhpc1tpXTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9KTsKICB2YXIgYXJyYXlGdW5jdGlvbnMgPSB7CiAgICBmcm9tOiBhcnJheUZyb20sCiAgICBjcmVhdGU6IGNyZWF0ZUFycmF5LAogICAgZmxhdHRlbjogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLmNvbmNhdC5hcHBseShbXSwgdGhpc18pOwogICAgfSwKICAgIHJlcGVhdDogZnVuY3Rpb24odGhpc18sIGNvdW50KSB7CiAgICAgIHJldHVybiBhcnJheUZ1bmN0aW9ucy5mbGF0dGVuKGNyZWF0ZUFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgfHwgMCwgdGhpc18pKTsKICAgIH0sCiAgICBzZWFyY2g6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSwgZ2V0dGVyXywgb2Zmc2V0KSB7CiAgICAgIHRoaXNfLmxhc3RTZWFyY2hJbmRleCA9IC0xOwogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8gfHwgJHNlbGYpOwogICAgICBmb3IgKHZhciBpbmRleCA9IHBhcnNlSW50KG9mZnNldCwgMTApIHx8IDAsIGxlbiA9IHRoaXNfLmxlbmd0aDsgaW5kZXggPCBsZW47IGluZGV4KyspIGlmIChnZXR0ZXJfKHRoaXNfW2luZGV4XSkgPT09IHZhbHVlKSByZXR1cm4gdGhpc19bdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gaW5kZXhdOwogICAgfSwKICAgIGxhc3RTZWFyY2g6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSwgZ2V0dGVyXywgb2Zmc2V0KSB7CiAgICAgIHRoaXNfLmxhc3RTZWFyY2hJbmRleCA9IC0xOwogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8gfHwgJHNlbGYpOwogICAgICB2YXIgbGVuID0gdGhpc18ubGVuZ3RoOwogICAgICB2YXIgaW5kZXggPSBpc05hTihvZmZzZXQpIHx8IG9mZnNldCA9PSBudWxsID8gbGVuIDogcGFyc2VJbnQob2Zmc2V0LCAxMCk7CiAgICAgIGZvciAodmFyIGkgPSBpbmRleCA+IGxlbiA/IGxlbiA6IGluZGV4OyBpLS0gPiAwOyApIGlmIChnZXR0ZXJfKHRoaXNfW2ldKSA9PT0gdmFsdWUpIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpXTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICByZXR1cm4gdGhpc18uaW5kZXhPZih2YWx1ZSkgPT0gLTEgJiYgISF0aGlzXy5wdXNoKHZhbHVlKTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICB2YXIgaW5kZXggPSB0aGlzXy5pbmRleE9mKHZhbHVlKTsKICAgICAgcmV0dXJuIGluZGV4ICE9IC0xICYmICEhdGhpc18uc3BsaWNlKGluZGV4LCAxKTsKICAgIH0sCiAgICBoYXM6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSkgewogICAgICByZXR1cm4gdGhpc18uaW5kZXhPZih2YWx1ZSkgIT0gLTE7CiAgICB9LAogICAgc29ydEFzT2JqZWN0OiBmdW5jdGlvbigpIHsKICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuYXJyYXkuc29ydEFzT2JqZWN0IGlzIGRlcHJlY2F0ZWQsIHVzZSBiYXNpcy5hcnJheS5zb3J0IGluc3RlYWQiKTsKICAgICAgcmV0dXJuIGFycmF5RnVuY3Rpb25zLnNvcnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICBzb3J0OiBmdW5jdGlvbih0aGlzXywgZ2V0dGVyXywgY29tcGFyYXRvciwgZGVzYykgewogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8pOwogICAgICBkZXNjID0gZGVzYyA/IC0xIDogMTsKICAgICAgcmV0dXJuIHRoaXNfLm1hcChmdW5jdGlvbihpdGVtLCBpbmRleCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpOiBpbmRleCwKICAgICAgICAgIHY6IGdldHRlcl8oaXRlbSkKICAgICAgICB9OwogICAgICB9KS5zb3J0KGNvbXBhcmF0b3IgfHwgZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBkZXNjICogKGEudiA+IGIudiB8fCAtKGEudiA8IGIudikgfHwgKGEuaSA+IGIuaSA/IDEgOiAtMSkpOwogICAgICB9KS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB0aGlzW2l0ZW0uaV07CiAgICAgIH0sIHRoaXNfKTsKICAgIH0KICB9OwogIGlmICghWyAxLCAyIF0uc3BsaWNlKDEpLmxlbmd0aCkgewogICAgdmFyIG5hdGl2ZUFycmF5U3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDIpIHBhcmFtc1sxXSA9IHRoaXMubGVuZ3RoOwogICAgICByZXR1cm4gbmF0aXZlQXJyYXlTcGxpY2UuYXBwbHkodGhpcywgcGFyYW1zKTsKICAgIH07CiAgfQogIHZhciBFU0NBUEVfRk9SX1JFR0VYUCA9IC8oW1wvXFxcKFwpXFtcXVw/XHtcfVx8XCpcK1wtXC5cXlwkXSkvZzsKICB2YXIgRk9STUFUX1JFR0VYUCA9IC9ceyhbYS16XGRfXSspKD86OihbXC4wXSkoXGQrKXw6KFw/KSk/XH0vZ2k7CiAgY29tcGxldGUoU3RyaW5nLCB7CiAgICB0b0xvd2VyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICB0b1VwcGVyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltKCk7CiAgICB9LAogICAgdHJpbUxlZnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1MZWZ0KCk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShTdHJpbmcucHJvdG90eXBlLCB7CiAgICB0cmltTGVmdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcGxhY2UoL15ccysvLCAiIik7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sICIiKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudHJpbUxlZnQoKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICB2YXIgc3RyaW5nRnVuY3Rpb25zID0gewogICAgdG9PYmplY3Q6IGZ1bmN0aW9uKHRoaXNfLCByZXRocm93KSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAwLCIgKyB0aGlzXykpKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAocmV0aHJvdykgdGhyb3cgZTsKICAgICAgfQogICAgfSwKICAgIHJlcGVhdDogZnVuY3Rpb24odGhpc18sIGNvdW50KSB7CiAgICAgIHJldHVybiAobmV3IEFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgKyAxIHx8IDApKS5qb2luKHRoaXNfKTsKICAgIH0sCiAgICBxdzogZnVuY3Rpb24odGhpc18pIHsKICAgICAgdmFyIHRyaW1tZWQgPSB0aGlzXy50cmltKCk7CiAgICAgIHJldHVybiB0cmltbWVkID8gdHJpbW1lZC5zcGxpdCgvXHMrLykgOiBbXTsKICAgIH0sCiAgICBmb3JSZWdFeHA6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKEVTQ0FQRV9GT1JfUkVHRVhQLCAiXFwkMSIpOwogICAgfSwKICAgIGZvcm1hdDogZnVuY3Rpb24odGhpc18sIGZpcnN0KSB7CiAgICAgIHZhciBkYXRhID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICh0eXBlb2YgZmlyc3QgPT0gIm9iamVjdCIpIGV4dGVuZChkYXRhLCBmaXJzdCk7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKEZPUk1BVF9SRUdFWFAsIGZ1bmN0aW9uKG0sIGtleSwgbnVtRm9ybWF0LCBudW0sIG5vTnVsbCkgewogICAgICAgIHZhciB2YWx1ZSA9IGtleSBpbiBkYXRhID8gZGF0YVtrZXldIDogbm9OdWxsID8gIiIgOiBtOwogICAgICAgIGlmIChudW1Gb3JtYXQgJiYgIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgdmFsdWUgPSBOdW1iZXIodmFsdWUpOwogICAgICAgICAgcmV0dXJuIG51bUZvcm1hdCA9PSAiLiIgPyB2YWx1ZS50b0ZpeGVkKG51bSkgOiBudW1iZXJGdW5jdGlvbnMubGVhZCh2YWx1ZSwgbnVtKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9KTsKICAgIH0sCiAgICBjYXBpdGFsaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aGlzXy5zdWJzdHIoMSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICBjYW1lbGl6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoLy0oLikvZywgZnVuY3Rpb24obSwgY2hyKSB7CiAgICAgICAgcmV0dXJuIGNoci50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBkYXNoZXJpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihtKSB7CiAgICAgICAgcmV0dXJuICItIiArIG0udG9Mb3dlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgU3RyaW5nKHZhbHVlKSA9PSAiIjsKICAgIH0sCiAgICBpc05vdEVtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiBTdHJpbmcodmFsdWUpICE9ICIiOwogICAgfQogIH07CiAgaWYgKCJ8fHwiLnNwbGl0KC9cfC8pLmxlbmd0aCArICJ8fHwiLnNwbGl0KC8oXHwpLykubGVuZ3RoICE9IDExKSB7CiAgICB2YXIgbmF0aXZlU3RyaW5nU3BsaXQgPSBTdHJpbmcucHJvdG90eXBlLnNwbGl0OwogICAgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCA9IGZ1bmN0aW9uKHBhdHRlcm4sIGNvdW50KSB7CiAgICAgIGlmICghcGF0dGVybiB8fCBwYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwID09IGZhbHNlIHx8IHBhdHRlcm4uc291cmNlID09ICIiKSByZXR1cm4gbmF0aXZlU3RyaW5nU3BsaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG1hdGNoOwogICAgICBpZiAoIXBhdHRlcm4uZ2xvYmFsKSBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnNvdXJjZSwgL1wvKFttaV0qKSQvLmV4ZWMocGF0dGVybilbMV0gKyAiZyIpOwogICAgICB3aGlsZSAobWF0Y2ggPSBwYXR0ZXJuLmV4ZWModGhpcykpIHsKICAgICAgICBtYXRjaFswXSA9IHRoaXMuc3Vic3RyaW5nKHBvcywgbWF0Y2guaW5kZXgpOwogICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgbWF0Y2gpOwogICAgICAgIHBvcyA9IHBhdHRlcm4ubGFzdEluZGV4OwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3Vic3RyKHBvcykpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgaWYgKCIxMiIuc3Vic3RyKC0xKSAhPSAiMiIpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTdWJzdHIgPSBTdHJpbmcucHJvdG90eXBlLnN1YnN0cjsKICAgIFN0cmluZy5wcm90b3R5cGUuc3Vic3RyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbmF0aXZlU3RyaW5nU3Vic3RyLmNhbGwodGhpcywgc3RhcnQgPCAwID8gTWF0aC5tYXgoMCwgdGhpcy5sZW5ndGggKyBzdGFydCkgOiBzdGFydCwgZW5kKTsKICAgIH07CiAgfQogIHZhciBudW1iZXJGdW5jdGlvbnMgPSB7CiAgICBmaXQ6IGZ1bmN0aW9uKHRoaXNfLCBtaW4sIG1heCkgewogICAgICBpZiAoIWlzTmFOKG1pbikgJiYgdGhpc18gPCBtaW4pIHJldHVybiBOdW1iZXIobWluKTsKICAgICAgaWYgKCFpc05hTihtYXgpICYmIHRoaXNfID4gbWF4KSByZXR1cm4gTnVtYmVyKG1heCk7CiAgICAgIHJldHVybiB0aGlzXzsKICAgIH0sCiAgICBsZWFkOiBmdW5jdGlvbih0aGlzXywgbGVuLCBsZWFkQ2hhcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gKGxlbiAtPSBudW1iZXIubGVuZ3RoIC0gMSkgPiAxID8gKG5ldyBBcnJheShsZW4pKS5qb2luKGxlYWRDaGFyIHx8IDApICsgbnVtYmVyIDogbnVtYmVyOwogICAgICB9KTsKICAgIH0sCiAgICBncm91cDogZnVuY3Rpb24odGhpc18sIGxlbiwgc3BsaXR0ZXIpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzXykucmVwbGFjZSgvXGQrLywgZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIG51bWJlci5yZXBsYWNlKC9cZC9nLCBmdW5jdGlvbihtLCBwb3MpIHsKICAgICAgICAgIHJldHVybiAhcG9zICsgKG51bWJlci5sZW5ndGggLSBwb3MpICUgKGxlbiB8fCAzKSA/IG0gOiAoc3BsaXR0ZXIgfHwgIiAiKSArIG07CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIGZvcm1hdDogZnVuY3Rpb24odGhpc18sIHByZWMsIGdzLCBwcmVmaXgsIHBvc3RmaXgsIGNvbW1hKSB7CiAgICAgIHZhciByZXMgPSB0aGlzXy50b0ZpeGVkKHByZWMpOwogICAgICBpZiAoZ3MgfHwgY29tbWEpIHJlcyA9IHJlcy5yZXBsYWNlKC8oXGQrKShcLj8pLywgZnVuY3Rpb24obSwgbnVtYmVyLCBjKSB7CiAgICAgICAgcmV0dXJuIChncyA/IGJhc2lzLm51bWJlci5ncm91cChOdW1iZXIobnVtYmVyKSwgMywgZ3MpIDogbnVtYmVyKSArIChjID8gY29tbWEgfHwgYyA6ICIiKTsKICAgICAgfSk7CiAgICAgIGlmIChwcmVmaXgpIHJlcyA9IHJlcy5yZXBsYWNlKC9eLT8vLCAiJCYiICsgKHByZWZpeCB8fCAiIikpOwogICAgICByZXR1cm4gcmVzICsgKHBvc3RmaXggfHwgIiIpOwogICAgfQogIH07CiAgY29tcGxldGUoRGF0ZSwgewogICAgbm93OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIE51bWJlcihuZXcgRGF0ZSk7CiAgICB9CiAgfSk7CiAgdmFyIHJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBpc1JlYWR5KCkgewogICAgICByZXR1cm4gZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiICYmICEhZG9jdW1lbnQuYm9keTsKICAgIH0KICAgIHZhciBmaXJlZCA9ICFkb2N1bWVudCB8fCBpc1JlYWR5KCk7CiAgICB2YXIgZGVmZXJyZWRIYW5kbGVyOwogICAgZnVuY3Rpb24gcnVuUmVhZHlIYW5kbGVyKGhhbmRsZXIpIHsKICAgICAgaGFuZGxlci5jYWxsYmFjay5jYWxsKGhhbmRsZXIuY29udGV4dCk7CiAgICB9CiAgICBmdW5jdGlvbiBmaXJlSGFuZGxlcnMoKSB7CiAgICAgIGlmIChpc1JlYWR5KCkpIGlmICghKGZpcmVkKyspKSB3aGlsZSAoZGVmZXJyZWRIYW5kbGVyKSB7CiAgICAgICAgcnVuUmVhZHlIYW5kbGVyKGRlZmVycmVkSGFuZGxlcik7CiAgICAgICAgZGVmZXJyZWRIYW5kbGVyID0gZGVmZXJyZWRIYW5kbGVyLm5leHQ7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CiAgICAgIHRyeSB7CiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKCJsZWZ0Iik7CiAgICAgICAgZmlyZUhhbmRsZXJzKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBzZXRUaW1lb3V0KGRvU2Nyb2xsQ2hlY2ssIDEpOwogICAgICB9CiAgICB9CiAgICBpZiAoIWZpcmVkKSB7CiAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZpcmVIYW5kbGVycywgZmFsc2UpOwogICAgICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBmaXJlSGFuZGxlcnMpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIWdsb2JhbC5mcmFtZUVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKSBkb1Njcm9sbENoZWNrKCk7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZmlyZWQpIHsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgbmV4dDogZGVmZXJyZWRIYW5kbGVyCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHJ1blJlYWR5SGFuZGxlcih7CiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9OwogIH0oKTsKICB2YXIgZG9jdW1lbnRJbnRlcmZhY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0aW1lcjsKICAgIHZhciByZWZlcmVuY2UgPSB7fTsKICAgIHZhciBjYWxsYmFja3MgPSB7CiAgICAgIGhlYWQ6IFtdLAogICAgICBib2R5OiBbXQogICAgfTsKICAgIGZ1bmN0aW9uIGdldFBhcmVudChuYW1lKSB7CiAgICAgIGlmIChkb2N1bWVudCAmJiAhcmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgcmVmZXJlbmNlW25hbWVdID0gZG9jdW1lbnRbbmFtZV0gfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSlbMF07CiAgICAgICAgaWYgKHJlZmVyZW5jZVtuYW1lXSkgewogICAgICAgICAgdmFyIGl0ZW1zID0gY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZGVsZXRlIGNhbGxiYWNrc1tuYW1lXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjYjsgY2IgPSBpdGVtc1tpXTsgaSsrKSBjYlswXS5jYWxsKGNiWzFdLCByZWZlcmVuY2VbbmFtZV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVmZXJlbmNlW25hbWVdOwogICAgfQogICAgZnVuY3Rpb24gYWRkKCkgewogICAgICB2YXIgbmFtZSA9IHRoaXNbMF07CiAgICAgIHZhciBub2RlID0gdGhpc1sxXTsKICAgICAgdmFyIHJlZiA9IHRoaXNbMl07CiAgICAgIHJlbW92ZShub2RlKTsKICAgICAgdmFyIHBhcmVudCA9IGdldFBhcmVudChuYW1lKTsKICAgICAgaWYgKHBhcmVudCkgewogICAgICAgIGlmIChyZWYgPT09IHRydWUpIHJlZiA9IHBhcmVudC5maXJzdENoaWxkOwogICAgICAgIGlmICghcmVmIHx8IHJlZi5wYXJlbnROb2RlICE9PSBwYXJlbnQpIHJlZiA9IG51bGw7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCByZWYpOwogICAgICB9IGVsc2UgY2FsbGJhY2tzW25hbWVdLnB1c2goWyBhZGQsIFsgbmFtZSwgbm9kZSwgcmVmIF0gXSk7CiAgICB9CiAgICBmdW5jdGlvbiBkb2NSZWFkeShuYW1lLCBmbiwgY29udGV4dCkgewogICAgICBpZiAoY2FsbGJhY2tzW25hbWVdKSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGZuLCBjb250ZXh0IF0pOyBlbHNlIGZuLmNhbGwoY29udGV4dCwgcmVmZXJlbmNlW25hbWVdKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZShub2RlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBjYWxsYmFja3MpIHsKICAgICAgICB2YXIgZW50cnkgPSBhcnJheUZ1bmN0aW9ucy5zZWFyY2goY2FsbGJhY2tzW2tleV0sIG5vZGUsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiBpdGVtWzFdICYmIGl0ZW1bMV1bMV07CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGVudHJ5KSBhcnJheUZ1bmN0aW9ucy5yZW1vdmUoY2FsbGJhY2tzW2tleV0sIGVudHJ5KTsKICAgICAgfQogICAgICBpZiAobm9kZSAmJiBub2RlLnBhcmVudE5vZGUgJiYgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoZWNrUGFyZW50cygpIHsKICAgICAgaWYgKHRpbWVyICYmIGdldFBhcmVudCgiaGVhZCIpICYmIGdldFBhcmVudCgiYm9keSIpKSB0aW1lciA9IGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgaWYgKGRvY3VtZW50ICYmICghZ2V0UGFyZW50KCJoZWFkIikgfHwgIWdldFBhcmVudCgiYm9keSIpKSkgewogICAgICB0aW1lciA9IHNldEludGVydmFsKGNoZWNrUGFyZW50cywgNSk7CiAgICAgIHJlYWR5KGNoZWNrUGFyZW50cyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBoZWFkOiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiaGVhZCIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJoZWFkIiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYm9keTogewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgZG9jUmVhZHkoImJvZHkiLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZikgewogICAgICAgICAgYWRkLmNhbGwoWyAiYm9keSIsIG5vZGUsIHJlZiBdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogcmVtb3ZlCiAgICB9OwogIH0oKTsKICB2YXIgY2xlYW5lciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG9iamVjdHMgPSBbXTsKICAgIGZ1bmN0aW9uIGRlc3Ryb3kobG9nKSB7CiAgICAgIHZhciBsb2dEZXN0cm95ID0gbG9nICYmIHR5cGVvZiBsb2cgPT0gImJvb2xlYW4iOwogICAgICByZXN1bHQuZ2xvYmFsRGVzdHJveSA9IHRydWU7CiAgICAgIHJlc3VsdC5hZGQgPSAkdW5kZWY7CiAgICAgIHJlc3VsdC5yZW1vdmUgPSAkdW5kZWY7CiAgICAgIHZhciBvYmplY3Q7CiAgICAgIHdoaWxlIChvYmplY3QgPSBvYmplY3RzLnBvcCgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZGVzdHJveSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobG9nRGVzdHJveSkgY29uc29sZU1ldGhvZHMubG9nKCJkZXN0cm95IiwgIlsiICsgU3RyaW5nKG9iamVjdC5jbGFzc05hbWUpICsgIl0iLCBvYmplY3QpOwogICAgICAgICAgICBvYmplY3QuZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKFN0cmluZyhvYmplY3QpLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIG9iamVjdFtwcm9wXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9iamVjdHMubGVuZ3RoID0gMDsKICAgIH0KICAgIGlmICgiYXR0YWNoRXZlbnQiIGluIGdsb2JhbCkgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlc3Ryb3kpOyBlbHNlIGlmICgiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigidW5sb2FkIiwgZGVzdHJveSwgZmFsc2UpOyBlbHNlIHJldHVybiB7CiAgICAgIGFkZDogJHVuZGVmLAogICAgICByZW1vdmU6ICR1bmRlZgogICAgfTsKICAgIHZhciByZXN1bHQgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCAhPSBudWxsKSBvYmplY3RzLnB1c2gob2JqZWN0KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBhcnJheUZ1bmN0aW9ucy5yZW1vdmUob2JqZWN0cywgb2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIHJlc3VsdC5kZXN0cm95XyA9IGRlc3Ryb3k7CiAgICByZXN1bHQub2JqZWN0c18gPSBvYmplY3RzOwogICAgcmV0dXJuIHJlc3VsdDsKICB9KCk7CiAgdmFyIENzc1Jlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgU1RZTEVfQVBQRU5EX0JVR0dZID0gZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSgpOwogICAgdmFyIGJhc2VFbCA9IGRvY3VtZW50ICYmIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJhc2UiKTsKICAgIGZ1bmN0aW9uIHNldEJhc2UoYmFzZVVSSSkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgYmFzZVVSSSk7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKGJhc2VFbCwgdHJ1ZSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXN0b3JlQmFzZSgpIHsKICAgICAgYmFzZUVsLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGxvY2F0aW9uLmhyZWYpOwogICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoYmFzZUVsKTsKICAgIH0KICAgIGZ1bmN0aW9uIGluamVjdFN0eWxlVG9IZWFkKCkgewogICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CiAgICAgIGlmICghdGhpcy5lbGVtZW50KSB7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICBpZiAoIVNUWUxFX0FQUEVORF9CVUdHWSkgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgic3JjIiwgdGhpcy51cmwpOwogICAgICB9CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKHRoaXMuZWxlbWVudCk7CiAgICAgIHRoaXMuc3luY0Nzc1RleHQoKTsKICAgICAgcmVzdG9yZUJhc2UoKTsKICAgIH0KICAgIHJldHVybiBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogImJhc2lzLkNzc1Jlc291cmNlIiwKICAgICAgaW5Vc2U6IDAsCiAgICAgIHVybDogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBjc3NUZXh0OiB1bmRlZmluZWQsCiAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHRoaXMudXJsID0gdXJsOwogICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGhVdGlscy5kaXJuYW1lKHVybCkgKyAiLyI7CiAgICAgIH0sCiAgICAgIHVwZGF0ZUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgICAgICBpZiAodGhpcy5jc3NUZXh0ICE9IGNzc1RleHQpIHsKICAgICAgICAgIHRoaXMuY3NzVGV4dCA9IGNzc1RleHQ7CiAgICAgICAgICBpZiAodGhpcy5pblVzZSAmJiB0aGlzLmVsZW1lbnQpIHsKICAgICAgICAgICAgc2V0QmFzZSh0aGlzLmJhc2VVUkkpOwogICAgICAgICAgICB0aGlzLnN5bmNDc3NUZXh0KCk7CiAgICAgICAgICAgIHJlc3RvcmVCYXNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBzeW5jQ3NzVGV4dDogU1RZTEVfQVBQRU5EX0JVR0dZID8gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuY3NzVGV4dDsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwogICAgICAgIGNzc1RleHQgKz0gIlxuLyojIHNvdXJjZVVSTD0iICsgcGF0aFV0aWxzLm9yaWdpbiArIHRoaXMudXJsICsgIiAqLyI7CiAgICAgICAgdGhpcy5lbGVtZW50LmZpcnN0Q2hpbGQubm9kZVZhbHVlID0gY3NzVGV4dDsKICAgICAgfSwKICAgICAgc3RhcnRVc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5pblVzZSkgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShpbmplY3RTdHlsZVRvSGVhZCwgdGhpcyk7CiAgICAgICAgdGhpcy5pblVzZSArPSAxOwogICAgICB9LAogICAgICBzdG9wVXNlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5pblVzZSkgewogICAgICAgICAgdGhpcy5pblVzZSAtPSAxOwogICAgICAgICAgaWYgKCF0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHRoaXMuZWxlbWVudCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5lbGVtZW50KSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMuY3NzVGV4dCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogIH0oKTsKICB2YXIgYmFzaXMgPSBnZXROYW1lc3BhY2UoImJhc2lzIikuZXh0ZW5kKHsKICAgIGZpbGVuYW1lXzogYmFzaXNGaWxlbmFtZSwKICAgIHByb2Nlc3NDb25maWc6IHByb2Nlc3NDb25maWcsCiAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgTk9ERV9FTlY6IE5PREVfRU5WLAogICAgY29uZmlnOiBjb25maWcsCiAgICBjcmVhdGVTYW5kYm94OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJhc2lzSW5zdGFuY2UoZ2xvYmFsLCBiYXNpc0ZpbGVuYW1lLCBjb21wbGV0ZSh7CiAgICAgICAgbm9Db25mbGljdDogdHJ1ZQogICAgICB9LCBjb25maWcpKTsKICAgIH0sCiAgICByZXNvbHZlTlNGaWxlbmFtZTogcmVzb2x2ZU5TRmlsZW5hbWUsCiAgICBwYXRjaDogcGF0Y2gsCiAgICBuYW1lc3BhY2U6IGdldE5hbWVzcGFjZSwKICAgIHJlcXVpcmU6IHJlcXVpcmVOYW1lc3BhY2UsCiAgICByZXNvdXJjZTogZ2V0UmVzb3VyY2UsCiAgICBhc3NldDogZnVuY3Rpb24odXJsKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9LAogICAgc2V0SW1tZWRpYXRlOiBzZXRJbW1lZGlhdGUsCiAgICBjbGVhckltbWVkaWF0ZTogY2xlYXJJbW1lZGlhdGUsCiAgICBuZXh0VGljazogZnVuY3Rpb24oKSB7CiAgICAgIHNldEltbWVkaWF0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSwKICAgIENsYXNzOiBDbGFzcywKICAgIFRva2VuOiBUb2tlbiwKICAgIERlZmVycmVkVG9rZW46IERlZmVycmVkVG9rZW4sCiAgICBnZW5VSUQ6IGdlblVJRCwKICAgIGdldHRlcjogZ2V0dGVyLAogICAgcmVhZHk6IHJlYWR5LAogICAgY2xlYW5lcjogY2xlYW5lciwKICAgIGNvbnNvbGU6IGNvbnNvbGVNZXRob2RzLAogICAgcGF0aDogcGF0aFV0aWxzLAogICAgZG9jOiBkb2N1bWVudEludGVyZmFjZSwKICAgIG9iamVjdDogewogICAgICBleHRlbmQ6IGV4dGVuZCwKICAgICAgY29tcGxldGU6IGNvbXBsZXRlLAogICAgICBrZXlzOiBrZXlzLAogICAgICB2YWx1ZXM6IHZhbHVlcywKICAgICAgc2xpY2U6IHNsaWNlLAogICAgICBzcGxpY2U6IHNwbGljZSwKICAgICAgbWVyZ2U6IG1lcmdlLAogICAgICBpdGVyYXRlOiBpdGVyYXRlCiAgICB9LAogICAgZm46IHsKICAgICAgJHVuZGVmaW5lZDogJHVuZGVmaW5lZCwKICAgICAgJGRlZmluZWQ6ICRkZWZpbmVkLAogICAgICAkaXNOdWxsOiAkaXNOdWxsLAogICAgICAkaXNOb3ROdWxsOiAkaXNOb3ROdWxsLAogICAgICAkaXNTYW1lOiAkaXNTYW1lLAogICAgICAkaXNOb3RTYW1lOiAkaXNOb3RTYW1lLAogICAgICAkc2VsZjogJHNlbGYsCiAgICAgICRjb25zdDogJGNvbnN0LAogICAgICAkZmFsc2U6ICRmYWxzZSwKICAgICAgJHRydWU6ICR0cnVlLAogICAgICAkbnVsbDogJG51bGwsCiAgICAgICR1bmRlZjogJHVuZGVmLAogICAgICBnZXR0ZXI6IGdldHRlciwKICAgICAgbnVsbEdldHRlcjogbnVsbEdldHRlciwKICAgICAgd3JhcHBlcjogd3JhcHBlciwKICAgICAgbGF6eUluaXQ6IGxhenlJbml0LAogICAgICBsYXp5SW5pdEFuZFJ1bjogbGF6eUluaXRBbmRSdW4sCiAgICAgIHJ1bk9uY2U6IHJ1bk9uY2UKICAgIH0sCiAgICBhcnJheTogZXh0ZW5kKGFycmF5RnJvbSwgYXJyYXlGdW5jdGlvbnMpLAogICAgc3RyaW5nOiBzdHJpbmdGdW5jdGlvbnMsCiAgICBudW1iZXI6IG51bWJlckZ1bmN0aW9ucywKICAgIGJvb2w6IHsKICAgICAgaW52ZXJ0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICBqc29uOiB7CiAgICAgIHBhcnNlOiB0eXBlb2YgSlNPTiAhPSAidW5kZWZpbmVkIiA/IEpTT04ucGFyc2UgOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyaW5nRnVuY3Rpb25zLnRvT2JqZWN0KHN0ciwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICB9KTsKICBnZXROYW1lc3BhY2UoImJhc2lzLmRldiIpLmV4dGVuZChjb25zb2xlTWV0aG9kcyk7CiAgaWYgKGNvbmZpZy5hdXRvbG9hZCkgY29uZmlnLmF1dG9sb2FkLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgcmVxdWlyZU5hbWVzcGFjZShuYW1lKTsKICB9KTsKICByZXR1cm4gYmFzaXM7Cn0pKHRoaXMpOwp9KS5jYWxsKHRoaXMpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 11:12:12 GMT",
                    "Content-Length": "211468",
                    "Date": "Thu, 06 Nov 2014 11:12:14 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}