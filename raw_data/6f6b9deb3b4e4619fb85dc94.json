{
    "url": "http://localhost:9999/krasimir/absurd/tasks/tmp/absurd-client-code.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statement:<ul><li>window.location.href = window.location.href.replace(/#(.*)$/, '') + '#' + path;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/krasimir/absurd/tasks/tmp/absurd-client-code.js",
                "path": "/krasimir/absurd/tasks/tmp/absurd-client-code.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rcmFzaW1pci9hYnN1cmQvdGFza3MvdG1wL2Fic3VyZC1jbGllbnQtY29kZS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzM4MjINCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMDY6MDU6MTUgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjA1OjE1IEdNVA0KDQp2YXIgbGliID0geyAKICAgIGFwaToge30sCiAgICBoZWxwZXJzOiB7fSwKICAgIHBsdWdpbnM6IHt9LAogICAgcHJvY2Vzc29yczogeyAKICAgICAgICBjc3M6IHsgcGx1Z2luczoge319LAogICAgICAgIGh0bWw6IHsgCiAgICAgICAgICAgIHBsdWdpbnM6IHt9LAogICAgICAgICAgICBoZWxwZXJzOiB7fQogICAgICAgIH0sCiAgICAgICAgY29tcG9uZW50OiB7IHBsdWdpbnM6IHt9fQogICAgfQp9Owp2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKHYpIHsKICAgIC8vIGNzcyBwcmVwcm9jZXNzb3IKICAgIGlmKHYuaW5kZXhPZignY3NzL0NTUy5qcycpID4gMCB8fCB2ID09ICcvLi4vQ1NTLmpzJykgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5jc3MuQ1NTOwogICAgfSBlbHNlIGlmKHYuaW5kZXhPZignaHRtbC9IVE1MLmpzJykgPiAwKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmh0bWwuSFRNTDsKICAgIH0gZWxzZSBpZih2LmluZGV4T2YoJ2NvbXBvbmVudC9Db21wb25lbnQuanMnKSA+IDApIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuY29tcG9uZW50LkNvbXBvbmVudDsKICAgIH0gZWxzZSBpZih2ID09ICdqcy1iZWF1dGlmeScpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgICAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYodiA9PSAnLi9oZWxwZXJzL1Byb3BBbmFseXplcicpIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuaHRtbC5oZWxwZXJzLlByb3BBbmFseXplcjsKICAgIH0gZWxzZSBpZih2ID09ICcuLi8uLi9oZWxwZXJzL1RyYW5zZm9ybVVwcGVyY2FzZScpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuVHJhbnNmb3JtVXBwZXJjYXNlOwogICAgfSBlbHNlIGlmKHYgPT0gJy4vaGVscGVycy9UZW1wbGF0ZUVuZ2luZScgfHwgdiA9PSAnLi4vaHRtbC9oZWxwZXJzL1RlbXBsYXRlRW5naW5lJykgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5odG1sLmhlbHBlcnMuVGVtcGxhdGVFbmdpbmU7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vaGVscGVycy9FeHRlbmQnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLkV4dGVuZDsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL0Nsb25lJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5DbG9uZTsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL1ByZWZpeGVzJyB8fCB2ID09ICcvLi4vLi4vLi4vaGVscGVycy9QcmVmaXhlcycpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuUHJlZml4ZXM7CiAgICB9IGVsc2UgaWYodiA9PSBfX2Rpcm5hbWUgKyAnLy4uLy4uLy4uLy4uLycpIHsKICAgICAgICByZXR1cm4gQWJzdXJkOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uL2hlbHBlcnMvQ1NTUGFyc2UnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLkNTU1BhcnNlOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7fQogICAgfQp9Owp2YXIgX19kaXJuYW1lID0gIiI7CnZhciBxdWV1ZSAgPSBmdW5jdGlvbihmdW5jcywgc2NvcGUpIHsKCShmdW5jdGlvbiBuZXh0KCkgewoJCWlmKGZ1bmNzLmxlbmd0aCA+IDApIHsKCQkJZnVuY3Muc2hpZnQoKS5hcHBseShzY29wZSB8fCB7fSwgW25leHRdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSk7CgkJfQoJfSkoKTsKfQp2YXIgc3RyMkRPTUVsZW1lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgIHZhciB3cmFwTWFwID0gewogICAgICAgIG9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCiAgICAgICAgbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLAogICAgICAgIGFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKICAgICAgICBwYXJhbTogWyAxLCAiPG9iamVjdD4iLCAiPC9vYmplY3Q+IiBdLAogICAgICAgIHRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAogICAgICAgIHRyOiBbIDIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+IiBdLAogICAgICAgIGNvbDogWyAyLCAiPHRhYmxlPjx0Ym9keT48L3Rib2R5Pjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKICAgICAgICB0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKICAgICAgICBib2R5OiBbMCwgIiIsICIiXSwKICAgICAgICBfZGVmYXVsdDogWyAxLCAiPGRpdj4iLCAiPC9kaXY+IiAgXQogICAgfTsKICAgIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKICAgIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKICAgIHZhciBtYXRjaCA9IC88XHMqXHcuKj8+L2cuZXhlYyhodG1sKTsKICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpZihtYXRjaCAhPSBudWxsKSB7CiAgICAgICAgdmFyIHRhZyA9IG1hdGNoWzBdLnJlcGxhY2UoLzwvZywgJycpLnJlcGxhY2UoLz4vZywgJycpLnNwbGl0KCcgJylbMF07CiAgICAgICAgaWYodGFnLnRvTG93ZXJDYXNlKCkgPT09ICdib2R5JykgewogICAgICAgICAgICB2YXIgZG9tID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlRG9jdW1lbnQoJ2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnLCAnaHRtbCcsIG51bGwpOwogICAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJvZHkiKTsKICAgICAgICAgICAgLy8ga2VlcGluZyB0aGUgYXR0cmlidXRlcwogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWwucmVwbGFjZSgvPGJvZHkvZywgJzxkaXYnKS5yZXBsYWNlKC88XC9ib2R5Pi9nLCAnPC9kaXY+Jyk7CiAgICAgICAgICAgIHZhciBhdHRycyA9IGVsZW1lbnQuZmlyc3RDaGlsZC5hdHRyaWJ1dGVzOwogICAgICAgICAgICBib2R5LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGF0dHJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBib2R5LnNldEF0dHJpYnV0ZShhdHRyc1tpXS5uYW1lLCBhdHRyc1tpXS52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJvZHk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG1hcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0LCBlbGVtZW50OwogICAgICAgICAgICBodG1sID0gbWFwWzFdICsgaHRtbCArIG1hcFsyXTsKICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgICAgdmFyIGogPSBtYXBbMF0rMTsKICAgICAgICAgICAgd2hpbGUoai0tKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5sYXN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5sYXN0Q2hpbGQ7CiAgICB9CiAgICByZXR1cm4gZWxlbWVudDsKfQp2YXIgYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKG9iaiwgZXZ0LCBmbmMpIHsKICAgIGlmIChvYmouYWRkRXZlbnRMaXN0ZW5lcikgeyAvLyBXM0MgbW9kZWwKICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcihldnQsIGZuYywgZmFsc2UpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsgLy8gTWljcm9zb2Z0IG1vZGVsCiAgICAgICAgcmV0dXJuIG9iai5hdHRhY2hFdmVudCgnb24nICsgZXZ0LCBmbmMpOwogICAgfQp9CnZhciByZW1vdmVFbXB0eVRleHROb2RlcyA9IGZ1bmN0aW9uKGVsZW0pIHsKICAgIHZhciBjaGlsZHJlbiA9IGVsZW0uY2hpbGROb2RlczsKICAgIHZhciBjaGlsZDsKICAgIHZhciBsZW4gPSBjaGlsZHJlbi5sZW5ndGg7CiAgICB2YXIgaSA9IDA7CiAgICB2YXIgd2hpdGVzcGFjZSA9IC9eXHMqJC87CiAgICBmb3IoOyBpIDwgbGVuOyBpKyspewogICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgaWYoY2hpbGQubm9kZVR5cGUgPT0gMyl7CiAgICAgICAgICAgIGlmKHdoaXRlc3BhY2UudGVzdChjaGlsZC5ub2RlVmFsdWUpKXsKICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgbGVuLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbTsKfQp2YXIgY3JlYXRlTm9kZSA9IGZ1bmN0aW9uKHR5cGUsIGF0dHJzLCBjb250ZW50KSB7Cgl2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7Cglmb3IodmFyIGk9MDsgaTxhdHRycy5sZW5ndGgsIGE9YXR0cnNbaV07IGkrKykgewoJCW5vZGUuc2V0QXR0cmlidXRlKGEubmFtZSwgYS52YWx1ZSk7Cgl9Cglub2RlLmlubmVySFRNTCA9IGNvbnRlbnQ7CglyZXR1cm4gbm9kZTsKfQp2YXIgcXMgPSBmdW5jdGlvbihzZWxlY3RvciwgcGFyZW50KSB7CiAgICBpZihwYXJlbnQgPT09IGZhbHNlKSB7IHBhcmVudCA9IGRvY3VtZW50OyB9CiAgICBlbHNlIHsgcGFyZW50ID0gcGFyZW50IHx8IHRoaXMuZWwgfHwgZG9jdW1lbnQ7IH0KICAgIHJldHVybiBwYXJlbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7Cn07CnZhciBxc2EgPSBmdW5jdGlvbihzZWxlY3RvciwgcGFyZW50KSB7CiAgICBpZihwYXJlbnQgPT09IGZhbHNlKSB7IHBhcmVudCA9IGRvY3VtZW50OyB9CiAgICBlbHNlIHsgcGFyZW50ID0gcGFyZW50IHx8IHRoaXMuZWwgfHwgZG9jdW1lbnQ7IH0KICAgIHJldHVybiBwYXJlbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7Cn07CnZhciBnZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlUHJvcCwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmKGVsICYmIGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgIHJldHVybiBlbC5jdXJyZW50U3R5bGVbc3R5bGVQcm9wXTsKICAgIH0gZWxzZSBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShzdHlsZVByb3ApOwogICAgfQogICAgcmV0dXJuIG51bGw7Cn07CnZhciBhZGRDbGFzcyA9IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmKGVsLmNsYXNzTGlzdCkgewogICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBlbC5jbGFzc05hbWU7CiAgICAgICAgaWYoY3VycmVudC5pbmRleE9mKGNsYXNzTmFtZSkgPCAwKSB7CiAgICAgICAgICAgIGlmKGN1cnJlbnQgPT0gJycpIGVsLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKICAgICAgICAgICAgZWxzZSBlbC5jbGFzc05hbWUgKz0gJyAnICsgY2xhc3NOYW1lOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9Owp2YXIgcmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWUsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3VycmVudCA9IGVsLmNsYXNzTmFtZS5zcGxpdCgnICcpOwogICAgICAgIHZhciBuZXdDbGFzc2VzID0gW107CiAgICAgICAgZm9yKHZhciBpPTA7IGk8Y3VycmVudC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZihjdXJyZW50W2ldICE9IGNsYXNzTmFtZSkgbmV3Q2xhc3Nlcy5wdXNoKGN1cnJlbnRbaV0pOwogICAgICAgIH0KICAgICAgICBlbC5jbGFzc05hbWUgPSBuZXdDbGFzc2VzLmpvaW4oJyAnKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9CnZhciByZXBsYWNlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWVBLCBjbGFzc05hbWVCLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgdmFyIGN1cnJlbnQgPSBlbC5jbGFzc05hbWUuc3BsaXQoJyAnKSwgZm91bmQgPSBmYWxzZTsKICAgIGZvcih2YXIgaT0wOyBpPGN1cnJlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZihjdXJyZW50W2ldID09IGNsYXNzTmFtZUEpIHsKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBjdXJyZW50W2ldID0gY2xhc3NOYW1lQjsKICAgICAgICB9CiAgICB9CiAgICBpZighZm91bmQpIHsKICAgICAgICByZXR1cm4gYWRkQ2xhc3MoY2xhc3NOYW1lQiwgZWwpOwogICAgfQogICAgZWwuY2xhc3NOYW1lID0gY3VycmVudC5qb2luKCcgJyk7CiAgICByZXR1cm4gdGhpczsKfQp2YXIgdG9nZ2xlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWUsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2xhc3NlcyA9IGVsLmNsYXNzTmFtZS5zcGxpdCgnICcpOwogICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0gLTE7CiAgICAgICAgZm9yICh2YXIgaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgICAgIGlmIChjbGFzc2VzW2ldID09PSBjbGFzc05hbWUpCiAgICAgICAgICAgICAgICBleGlzdGluZ0luZGV4ID0gaTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYoZXhpc3RpbmdJbmRleCA+PSAwKQogICAgICAgICAgICBjbGFzc2VzLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGNsYXNzZXMucHVzaChjbGFzc05hbWUpOwoKICAgICAgICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9CnZhciBiaW5kID0gZnVuY3Rpb24oZnVuYywgc2NvcGUsIGFyZ3MpIHsKICAgIGlmKHNjb3BlIGluc3RhbmNlb2YgQXJyYXkpIHsgYXJncyA9IHNjb3BlOyBzY29wZSA9IHRoaXM7IH0KICAgIGlmKCFzY29wZSkgc2NvcGUgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmMuYXBwbHkoc2NvcGUsIChhcmdzIHx8IFtdKS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpOwogICAgfQp9CnZhciBDb21wb25lbnQgPSBmdW5jdGlvbihjb21wb25lbnROYW1lLCBhYnN1cmQsIGV2ZW50QnVzLCBjbHMpIHsKCXZhciBhcGkgPSBsaWIuaGVscGVycy5FeHRlbmQoewoJCV9fbmFtZTogY29tcG9uZW50TmFtZQoJfSwgY2xzKTsKCXZhciBleHRlbmQgPSBsaWIuaGVscGVycy5FeHRlbmQ7CnZhciBsID0gW107CmFwaS5saXN0ZW5lcnMgPSBsOwphcGkub24gPSBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBzY29wZSkgewoJaWYoIWxbZXZlbnROYW1lXSkgewoJCWxbZXZlbnROYW1lXSA9IFtdOwoJfQoJbFtldmVudE5hbWVdLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgc2NvcGU6IHNjb3BlfSk7CglyZXR1cm4gdGhpczsKfTsKYXBpLm9mZiA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlcikgewoJaWYoIWxbZXZlbnROYW1lXSkgcmV0dXJuIHRoaXM7CglpZighaGFuZGxlcikgbFtldmVudE5hbWVdID0gW107IHJldHVybiB0aGlzOwoJdmFyIG5ld0FyciA9IFtdOwoJZm9yKHZhciBpPTA7IGk8bFtldmVudE5hbWVdLmxlbmd0aDsgaSsrKSB7CgkJaWYobFtldmVudE5hbWVdW2ldLmNhbGxiYWNrICE9PSBoYW5kbGVyKSB7CgkJCW5ld0Fyci5wdXNoKGxbZXZlbnROYW1lXVtpXSk7CgkJfQoJfQoJbFtldmVudE5hbWVdID0gbmV3QXJyOwoJcmV0dXJuIHRoaXM7Cn07CmFwaS5kaXNwYXRjaCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSwgc2NvcGUpIHsKCWlmKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICEoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSkgewoJCWRhdGEudGFyZ2V0ID0gdGhpczsKCX0KCWlmKGxbZXZlbnROYW1lXSkgewoJCWZvcih2YXIgaT0wOyBpPGxbZXZlbnROYW1lXS5sZW5ndGg7IGkrKykgewoJCQl2YXIgY2FsbGJhY2sgPSBsW2V2ZW50TmFtZV1baV0uY2FsbGJhY2s7CgkJCWNhbGxiYWNrLmFwcGx5KHNjb3BlIHx8IGxbZXZlbnROYW1lXVtpXS5zY29wZSB8fCB7fSwgW2RhdGFdKTsKCQl9Cgl9CglpZih0aGlzW2V2ZW50TmFtZV0gJiYgdHlwZW9mIHRoaXNbZXZlbnROYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewoJCXRoaXNbZXZlbnROYW1lXShkYXRhKTsKCX0KCWlmKGV2ZW50QnVzKSBldmVudEJ1cy5kaXNwYXRjaChldmVudE5hbWUsIGRhdGEpOwoJcmV0dXJuIHRoaXM7Cn07CnZhciBzdG9yYWdlID0ge307CmFwaS5zZXQgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CglzdG9yYWdlW2tleV0gPSB2YWx1ZTsKCXJldHVybiB0aGlzOwp9OwphcGkuZ2V0ID0gZnVuY3Rpb24oa2V5KSB7CglyZXR1cm4gc3RvcmFnZVtrZXldOwp9Owp2YXIgQ1NTID0gZmFsc2U7CmFwaS5fX2hhbmRsZUNTUyA9IGZ1bmN0aW9uKG5leHQpIHsKCWlmKHRoaXMuY3NzKSB7CgkJYWJzdXJkLmZsdXNoKCkubW9ycGgoJ2R5bmFtaWMtY3NzJykuYWRkKHRoaXMuY3NzKS5jb21waWxlKGZ1bmN0aW9uKGVyciwgY3NzKSB7CgkJCWlmKCFDU1MpIHsKCQkJCXZhciBzdHlsZSA9IGNyZWF0ZU5vZGUoCgkJCQkJJ3N0eWxlJywgWwoJCQkJCQl7IG5hbWU6ICJpZCIsIHZhbHVlOiBjb21wb25lbnROYW1lICsgJy1jc3MnIH0sCgkJCQkJCXsgbmFtZTogInR5cGUiLCB2YWx1ZTogInRleHQvY3NzIn0KCQkJCQldLAoJCQkJCSBjc3MKCQkJCSk7CgkJCQkocXMoImhlYWQiKSB8fCBxcygiYm9keSIpKS5hcHBlbmRDaGlsZChzdHlsZSk7CgkJCQlDU1MgPSB7IHJhdzogY3NzLCBlbGVtZW50OiBzdHlsZSB9OwoJCQl9IGVsc2UgaWYoQ1NTLnJhdyAhPT0gY3NzKSB7CgkJCQlDU1MucmF3ID0gY3NzOwoJCQkJQ1NTLmVsZW1lbnQuaW5uZXJIVE1MID0gY3NzOwoJCQl9CgkJCW5leHQoKTsKCQl9LCB0aGlzKTsKCX0gZWxzZSB7CgkJbmV4dCgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07CmFwaS5hcHBseUNTUyA9IGZ1bmN0aW9uKGRhdGEsIHByZXZlbnRDb21wb3NpdGlvbiwgc2tpcEF1dG9Qb3B1bGF0aW9uKSB7CglpZih0aGlzLmh0bWwgJiYgdHlwZW9mIHRoaXMuaHRtbCA9PT0gJ3N0cmluZycgJiYgIXByZXZlbnRDb21wb3NpdGlvbikgewoJCXZhciByZXMgPSB7fTsKCQlyZXNbdGhpcy5odG1sXSA9IGRhdGE7CgkJZGF0YSA9IHJlczsKCX0KCXRoaXMuY3NzID0gZGF0YTsKCWlmKCFza2lwQXV0b1BvcHVsYXRpb24pIHsKCQl0aGlzLnBvcHVsYXRlKCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKdmFyIEhUTUxTb3VyY2UgPSBmYWxzZTsKCmFwaS5fX21lcmdlRE9NRWxlbWVudHMgPSBmdW5jdGlvbihlMSwgZTIpIHsJCglyZW1vdmVFbXB0eVRleHROb2RlcyhlMSk7CglyZW1vdmVFbXB0eVRleHROb2RlcyhlMik7CglpZih0eXBlb2YgZTEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBlMiA9PT0gJ3VuZGVmaW5lZCcgfHwgZTEuaXNFcXVhbE5vZGUoZTIpKSByZXR1cm47CgkvLyByZXBsYWNlIHRoZSB3aG9sZSBub2RlCglpZihlMS5ub2RlTmFtZSAhPT0gZTIubm9kZU5hbWUpIHsKCQlpZihlMS5wYXJlbnROb2RlKSB7CgkJCWUxLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGUyLCBlMSk7CgkJfQoJCXJldHVybjsKCX0KCS8vIG5vZGVWYWx1ZQoJaWYoZTEubm9kZVZhbHVlICE9PSBlMi5ub2RlVmFsdWUpIHsKCQllMS5ub2RlVmFsdWUgPSBlMi5ub2RlVmFsdWU7Cgl9CgkvLyBhdHRyaWJ1dGVzCglpZihlMS5hdHRyaWJ1dGVzKSB7CgkJdmFyIGF0dHIxID0gZTEuYXR0cmlidXRlcywgYXR0cjIgPSBlMi5hdHRyaWJ1dGVzLCBhMSwgYTIsIGZvdW5kID0ge307CgkJZm9yKHZhciBpPTA7IGk8YXR0cjEubGVuZ3RoLCBhMT1hdHRyMVtpXTsgaSsrKSB7CgkJCWZvcih2YXIgaj0wOyBqPGF0dHIyLmxlbmd0aCwgYTI9YXR0cjJbal07IGorKykgewoJCQkJaWYoYTEubmFtZSA9PT0gYTIubmFtZSkgewoJCQkJCWUxLnNldEF0dHJpYnV0ZShhMS5uYW1lLCBhMi52YWx1ZSk7CgkJCQkJZm91bmRbYTEubmFtZV0gPSB0cnVlOwoJCQkJCWlmKGExLm5hbWUgPT09ICd2YWx1ZScpIHsKCQkJCQkJZTEudmFsdWUgPSBhMi52YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWYoIWZvdW5kW2ExLm5hbWVdKSB7CgkJCQllMS5yZW1vdmVBdHRyaWJ1dGUoYTEubmFtZSk7CgkJCX0KCQl9CgkJZm9yKHZhciBpPTA7IGk8YXR0cjIubGVuZ3RoLCBhMj1hdHRyMltpXTsgaSsrKSB7CgkJCWlmKCFmb3VuZFthMi5uYW1lXSkgewoJCQkJZTEuc2V0QXR0cmlidXRlKGEyLm5hbWUsIGEyLnZhbHVlKTsKCQkJCWlmKGEyLm5hbWUgPT09ICd2YWx1ZScpIHsKCQkJCQllMS52YWx1ZSA9IGEyLnZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJLy8gY2hpbGRzCgl2YXIgbmV3Tm9kZXNUb01lcmdlID0gW107CglpZihlMS5jaGlsZE5vZGVzLmxlbmd0aCA+PSBlMi5jaGlsZE5vZGVzLmxlbmd0aCkgewoJCWZvcih2YXIgaT0wOyBpPGUxLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYoIWUyLmNoaWxkTm9kZXNbaV0pIHsgZTIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsgfQoJCQluZXdOb2Rlc1RvTWVyZ2UucHVzaChbZTEuY2hpbGROb2Rlc1tpXSwgZTIuY2hpbGROb2Rlc1tpXV0pOwoJCX0KCX0gZWxzZSB7CgkJZm9yKHZhciBpPTA7IGk8ZTIuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewoJCQllMS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiIikpOwkJCQkJCQoJCQluZXdOb2Rlc1RvTWVyZ2UucHVzaChbZTEuY2hpbGROb2Rlc1tpXSwgZTIuY2hpbGROb2Rlc1tpXV0pOwoJCX0KCX0KCWZvcih2YXIgaT0wOyBpPG5ld05vZGVzVG9NZXJnZS5sZW5ndGg7IGkrKykgewoJCWFwaS5fX21lcmdlRE9NRWxlbWVudHMobmV3Tm9kZXNUb01lcmdlW2ldWzBdLCBuZXdOb2Rlc1RvTWVyZ2VbaV1bMV0pOwoJfQp9OwphcGkuX19oYW5kbGVIVE1MID0gZnVuY3Rpb24obmV4dCkgewoJdmFyIHNlbGYgPSB0aGlzOwoJdmFyIGNvbXBpbGUgPSBmdW5jdGlvbigpIHsKCQlhYnN1cmQuZmx1c2goKS5tb3JwaCgiaHRtbCIpLmFkZChIVE1MU291cmNlKS5jb21waWxlKGZ1bmN0aW9uKGVyciwgaHRtbCkgewoJCQlpZighc2VsZi5lbCkgewoJCQkJc2VsZi5lbCA9IHN0cjJET01FbGVtZW50KGh0bWwpOwoJCQl9IGVsc2UgewoJCQkJYXBpLl9fbWVyZ2VET01FbGVtZW50cyhzZWxmLmVsLCBzdHIyRE9NRWxlbWVudChodG1sKSk7CgkJCX0KCQkJbmV4dCgpOwoJCX0sIHNlbGYpOwoJfQoJaWYodGhpcy5odG1sKSB7CgkJaWYodHlwZW9mIHRoaXMuaHRtbCA9PT0gJ3N0cmluZycpIHsKCQkJaWYoIXRoaXMuZWwpIHsKCQkJCXZhciBlbGVtZW50ID0gcXModGhpcy5odG1sKTsKCQkJCWlmKGVsZW1lbnQpIHsKCQkJCQl0aGlzLmVsID0gZWxlbWVudDsKCQkJCQlIVE1MU291cmNlID0geycnOiB0aGlzLmVsLm91dGVySFRNTC5yZXBsYWNlKC8mbHQ7L2csICc8JykucmVwbGFjZSgvJmd0Oy9nLCAnPicpIH07CgkJCQl9CgkJCX0KCQkJY29tcGlsZSgpOwoJCX0gZWxzZSBpZih0eXBlb2YgdGhpcy5odG1sID09PSAnb2JqZWN0JykgewoJCQlIVE1MU291cmNlID0gZXh0ZW5kKHt9LCB0aGlzLmh0bWwpOwoJCQljb21waWxlKCk7CQkKCQl9IGVsc2UgewoJCQluZXh0KCk7CgkJfQoJfSBlbHNlIHsKCQluZXh0KCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKYXBpLmFwcGx5SFRNTCA9IGZ1bmN0aW9uKGRhdGEsIHNraXBBdXRvUG9wdWxhdGlvbikgewoJdGhpcy5odG1sID0gZGF0YTsKCWlmKCFza2lwQXV0b1BvcHVsYXRpb24pIHsKCQl0aGlzLnBvcHVsYXRlKCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKdmFyCWFwcGVuZGVkID0gZmFsc2UKYXBpLl9fYXBwZW5kID0gZnVuY3Rpb24obmV4dCkgewoJaWYoIWFwcGVuZGVkICYmIHRoaXMuZWwgJiYgdGhpcy5nZXQoInBhcmVudCIpKSB7CgkJYXBwZW5kZWQgPSB0cnVlOwoJCXRoaXMuZ2V0KCJwYXJlbnQiKS5hcHBlbmRDaGlsZCh0aGlzLmVsKTsKCX0KCW5leHQoKTsKCXJldHVybiB0aGlzOwp9CnZhciBjYWNoZSA9IHsgZXZlbnRzOiB7fSB9OwphcGkuX19oYW5kbGVFdmVudHMgPSBmdW5jdGlvbihuZXh0KSB7CQkKCWlmKHRoaXMuZWwpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdmFyIHJlZ2lzdGVyRXZlbnQgPSBmdW5jdGlvbihlbCkgewoJCQl2YXIgYXR0clZhbHVlID0gZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWFic3VyZC1ldmVudCcpOwoJCQl2YXIgcHJvY2Vzc0F0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyVmFsdWUpIHsKCQkJCWF0dHJWYWx1ZSA9IGF0dHJWYWx1ZS5zcGxpdCgiOiIpOwoJCQkJaWYoYXR0clZhbHVlLmxlbmd0aCA+PSAyKSB7CgkJCQkJdmFyIGV2ZW50VHlwZSA9IGF0dHJWYWx1ZVswXTsKCQkJCQl2YXIgbWV0aG9kTmFtZSA9IGF0dHJWYWx1ZVsxXTsKCQkJCQlhdHRyVmFsdWUuc3BsaWNlKDAsIDIpOwoJCQkJCXZhciBhcmdzID0gYXR0clZhbHVlOwoJCQkJCWlmKCFjYWNoZS5ldmVudHNbZXZlbnRUeXBlXSB8fCBjYWNoZS5ldmVudHNbZXZlbnRUeXBlXS5pbmRleE9mKGVsKSA8IDApIHsKCQkJCQkJaWYoIWNhY2hlLmV2ZW50c1tldmVudFR5cGVdKSBjYWNoZS5ldmVudHNbZXZlbnRUeXBlXSA9IFtdOwoJCQkJCQljYWNoZS5ldmVudHNbZXZlbnRUeXBlXS5wdXNoKGVsKTsKCQkJCQkJYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnRUeXBlLCBmdW5jdGlvbihlKSB7CgkJCQkJCQlpZih0eXBlb2Ygc2VsZlttZXRob2ROYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJCXZhciBmID0gc2VsZlttZXRob2ROYW1lXTsKCQkJCQkJCQlmLmFwcGx5KHNlbGYsIFtlXS5jb25jYXQoYXJncykpOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJYXR0clZhbHVlID0gYXR0clZhbHVlLnNwbGl0KC8sID8vZyk7CgkJCWZvcih2YXIgaT0wOyBpPGF0dHJWYWx1ZS5sZW5ndGg7IGkrKykgcHJvY2Vzc0F0dHJpYnV0ZXMoYXR0clZhbHVlW2ldKTsKCQl9CgkJaWYodGhpcy5lbC5oYXNBdHRyaWJ1dGUgJiYgdGhpcy5lbC5oYXNBdHRyaWJ1dGUoJ2RhdGEtYWJzdXJkLWV2ZW50JykpIHsKCQkJcmVnaXN0ZXJFdmVudCh0aGlzLmVsKTsKCQl9CgkJdmFyIGVscyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCA/IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYWJzdXJkLWV2ZW50XScpIDogW107CgkJZm9yKHZhciBpPTA7IGk8ZWxzLmxlbmd0aDsgaSsrKSB7CgkJCXJlZ2lzdGVyRXZlbnQoZWxzW2ldKTsKCQl9Cgl9CgluZXh0KCk7CglyZXR1cm4gdGhpczsKfQphcGkuX19nZXRBbmltQW5kVHJhbnNFbmRFdmVudE5hbWUgPSBmdW5jdGlvbihlbCkgewoJaWYoIWVsKSByZXR1cm47CiAgICB2YXIgYTsKICAgIHZhciBhbmltYXRpb25zID0gewogICAgICAnYW5pbWF0aW9uJzogWydhbmltYXRpb25lbmQnLCAndHJhbnNpdGlvbmVuZCddLAogICAgICAnT0FuaW1hdGlvbic6IFsnb0FuaW1hdGlvbkVuZCcsICdvVHJhbnNpdGlvbkVuZCddLAogICAgICAnTW96QW5pbWF0aW9uJzogWydhbmltYXRpb25lbmQnLCAndHJhbnNpdGlvbmVuZCddLAogICAgICAnV2Via2l0QW5pbWF0aW9uJzogWyd3ZWJraXRBbmltYXRpb25FbmQnLCAnd2Via2l0VHJhbnNpdGlvbkVuZCddCiAgICB9CiAgICBmb3IoYSBpbiBhbmltYXRpb25zKXsKICAgICAgICBpZiggZWwuc3R5bGVbYV0gIT09IHVuZGVmaW5lZCApewogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uc1thXTsKICAgICAgICB9CiAgICB9Cn0KYXBpLm9uQW5pbWF0aW9uRW5kID0gZnVuY3Rpb24oZWwsIGZ1bmMpIHsKCWlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCWZ1bmMgPSBlbDsKCQllbCA9IHRoaXMuZWw7Cgl9Cgl2YXIgc2VsZiA9IHRoaXM7Cgl2YXIgZXZlbnROYW1lID0gYXBpLl9fZ2V0QW5pbUFuZFRyYW5zRW5kRXZlbnROYW1lKGVsKTsKCWlmKCFldmVudE5hbWUpIHsgZnVuYy5hcHBseSh0aGlzLCBbe2Vycm9yOiAnQW5pbWF0aW9ucyBub3Qgc3VwcG9ydGVkLid9XSk7IHJldHVybjsgfTsKCXRoaXMuYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnROYW1lWzBdLCBmdW5jdGlvbihlKSB7CgkJZnVuYy5hcHBseShzZWxmLCBbZV0pOwoJfSk7Cn0KYXBpLm9uVHJhbnNpdGlvbkVuZCA9IGZ1bmN0aW9uKGVsLCBmdW5jKSB7CglpZihhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQlmdW5jID0gZWw7CgkJZWwgPSB0aGlzLmVsOwoJfQoJdmFyIHNlbGYgPSB0aGlzOwoJdmFyIGV2ZW50TmFtZSA9IGFwaS5fX2dldEFuaW1BbmRUcmFuc0VuZEV2ZW50TmFtZShlbCk7CglpZighZXZlbnROYW1lKSB7IGZ1bmMuYXBwbHkodGhpcywgW3tlcnJvcjogJ0FuaW1hdGlvbnMgbm90IHN1cHBvcnRlZC4nfV0pOyByZXR1cm47IH07Cgl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoZWwsIGV2ZW50TmFtZVsxXSwgZnVuY3Rpb24oZSkgewoJCWZ1bmMuYXBwbHkoc2VsZiwgW2VdKTsKCX0pOwp9CnZhcglhc3luYyA9IHsgZnVuY3M6IHt9LCBpbmRleDogMCB9OwphcGkuX19oYW5kbGVBc3luY0Z1bmN0aW9ucyA9IGZ1bmN0aW9uKG5leHQpIHsKCWlmKHRoaXMuZWwpIHsKCQl2YXIgZnVuY3MgPSBbXTsKCQlpZih0aGlzLmVsLmhhc0F0dHJpYnV0ZSAmJiB0aGlzLmVsLmhhc0F0dHJpYnV0ZSgiZGF0YS1hYnN1cmQtYXN5bmMiKSkgewoJCQlmdW5jcy5wdXNoKHRoaXMuZWwpOwoJCX0gZWxzZSB7CgkJCXZhciBlbHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwgPyB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWFic3VyZC1hc3luY10nKSA6IFtdOwoJCQlmb3IodmFyIGk9MDsgaTxlbHMubGVuZ3RoOyBpKyspIHsKCQkJCWZ1bmNzLnB1c2goZWxzW2ldKTsKCQkJfQoJCX0JCQoJCWlmKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewoJCQluZXh0KCk7CgkJfSBlbHNlIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkoZnVuY3Rpb24gY2FsbEZ1bmNzKCkgewoJCQkJaWYoZnVuY3MubGVuZ3RoID09PSAwKSB7CQkJCQkJCgkJCQkJbmV4dCgpOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgZWwgPSBmdW5jcy5zaGlmdCgpLAoJCQkJCQl2YWx1ZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS1hYnN1cmQtYXN5bmMiKSwKCQkJCQkJcmVwbGFjZU5vZGVzID0gZnVuY3Rpb24oY2hpbGRFbGVtZW50KSB7CgkJCQkJCQlpZih0eXBlb2YgY2hpbGRFbGVtZW50ID09PSAnc3RyaW5nJykgewoJCQkJCQkJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHN0cjJET01FbGVtZW50KGNoaWxkRWxlbWVudCksIGVsKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoY2hpbGRFbGVtZW50LCBlbCk7CgkJCQkJCQl9CgkJCQkJCQljYWxsRnVuY3MoKTsKCQkJCQkJfTsKCQkJCQlpZih0eXBlb2Ygc2VsZlthc3luYy5mdW5jc1t2YWx1ZV0ubmFtZV0gPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJc2VsZlthc3luYy5mdW5jc1t2YWx1ZV0ubmFtZV0uYXBwbHkoc2VsZiwgW3JlcGxhY2VOb2Rlc10uY29uY2F0KGFzeW5jLmZ1bmNzW3ZhbHVlXS5hcmdzKSk7CgkJCQkJfSBlbHNlIGlmKHR5cGVvZiBhc3luYy5mdW5jc1t2YWx1ZV0uZnVuYyA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQlhc3luYy5mdW5jc1t2YWx1ZV0uZnVuYy5hcHBseShzZWxmLCBbcmVwbGFjZU5vZGVzXS5jb25jYXQoYXN5bmMuZnVuY3NbdmFsdWVdLmFyZ3MpKTsKCQkJCQl9CgkJCQl9CgkJCX0pKCk7CgkJfQkJCQoJfSBlbHNlIHsKCQluZXh0KCk7Cgl9CQoJcmV0dXJuIHRoaXM7CQp9CmFwaS5hc3luYyA9IGZ1bmN0aW9uKCkgewoJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApLAoJCWZ1bmMgPSBhcmdzLnNoaWZ0KCksCgkJaW5kZXggPSAnXycgKyAoYXN5bmMuaW5kZXgrKyk7Cglhc3luYy5mdW5jc1tpbmRleF0gPSB7YXJnczogYXJncywgbmFtZTogZnVuY307CglyZXR1cm4gJzxzY3JpcHQgZGF0YS1hYnN1cmQtYXN5bmM9IicgKyBpbmRleCArICciPjwvc2NyaXB0Pic7Cn07CmFwaS5jaGlsZCA9IGZ1bmN0aW9uKCkgewoJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApLAoJCWNoaWxkcmVuID0gdGhpcy5nZXQoImNoaWxkcmVuIiksCgkJY29tcG9uZW50ID0gY2hpbGRyZW4gJiYgY2hpbGRyZW5bYXJncy5zaGlmdCgpXSwKCQlpbmRleCA9ICdfJyArIChhc3luYy5pbmRleCsrKTsKCWFzeW5jLmZ1bmNzW2luZGV4XSA9IHthcmdzOiBhcmdzLCBmdW5jOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCWNvbXBvbmVudC5wb3B1bGF0ZSh7Y2FsbGJhY2s6IGZ1bmN0aW9uKGRhdGEpIHsKCQkJY2FsbGJhY2soZGF0YS5odG1sLmVsZW1lbnQpOwoJCX19KTsKCX19OwoJcmV0dXJuICc8c2NyaXB0IGRhdGEtYWJzdXJkLWFzeW5jPSInICsgaW5kZXggKyAnIj48L3NjcmlwdD4nOwp9OwphcGkud2lyZSA9IGZ1bmN0aW9uKGV2ZW50KSB7CglhYnN1cmQuY29tcG9uZW50cy5ldmVudHMub24oZXZlbnQsIHRoaXNbZXZlbnRdIHx8IGZ1bmN0aW9uKCkge30sIHRoaXMpOwoJcmV0dXJuIHRoaXM7Cn07CnZhciBpc1BvcHVsYXRlSW5Qcm9ncmVzcyA9IGZhbHNlOwphcGkucG9wdWxhdGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CglpZihpc1BvcHVsYXRlSW5Qcm9ncmVzcykgcmV0dXJuOwoJaXNQb3B1bGF0ZUluUHJvZ3Jlc3MgPSB0cnVlOwoJcXVldWUoWwoJCWFwaS5fX2hhbmRsZUNTUywKCQlhcGkuX19oYW5kbGVIVE1MLAoJCWFwaS5fX2FwcGVuZCwgCgkJYXBpLl9faGFuZGxlRXZlbnRzLAoJCWFwaS5fX2hhbmRsZUFzeW5jRnVuY3Rpb25zLAoJCWZ1bmN0aW9uKCkgewoJCQlpc1BvcHVsYXRlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQlhc3luYyA9IHsgZnVuY3M6IHt9LCBpbmRleDogMCB9CgkJCXZhciBkYXRhID0gewoJCQkJY3NzOiBDU1MsIAoJCQkJaHRtbDogeyAKCQkJCQllbGVtZW50OiB0aGlzLmVsIAoJCQkJfQoJCQl9OwoJCQl0aGlzLmRpc3BhdGNoKCJwb3B1bGF0ZWQiLCBkYXRhKTsKCQkJaWYob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgeyBvcHRpb25zLmNhbGxiYWNrKGRhdGEpOyB9CgkJfQoJXSwgdGhpcyk7CglyZXR1cm4gdGhpczsKfTsKYXBpLnN0cjJET01FbGVtZW50ID0gc3RyMkRPTUVsZW1lbnQ7CmFwaS5hZGRFdmVudExpc3RlbmVyID0gYWRkRXZlbnRMaXN0ZW5lcjsKYXBpLnF1ZXVlID0gcXVldWU7CmFwaS5xcyA9IHFzOwphcGkucXNhID0gcXNhOwphcGkuZ2V0U3R5bGUgPSBnZXRTdHlsZTsKYXBpLmFkZENsYXNzID0gYWRkQ2xhc3M7CmFwaS5yZW1vdmVDbGFzcyA9IHJlbW92ZUNsYXNzOwphcGkucmVwbGFjZUNsYXNzID0gcmVwbGFjZUNsYXNzOwphcGkuYmluZCA9IGJpbmQ7CmFwaS50b2dnbGVDbGFzcyA9IHRvZ2dsZUNsYXNzOwphcGkuY29tcGlsZUhUTUwgPSBmdW5jdGlvbihIVE1MLCBjYWxsYmFjaywgZGF0YSkgewoJYWJzdXJkLmZsdXNoKCkubW9ycGgoImh0bWwiKS5hZGQoSFRNTCkuY29tcGlsZShjYWxsYmFjaywgZGF0YSk7Cn07CmFwaS5jb21waWxlQ1NTID0gZnVuY3Rpb24oQ1NTLCBjYWxsYmFjaywgb3B0aW9ucykgewoJYWJzdXJkLmZsdXNoKCkuYWRkKENTUykuY29tcGlsZShjYWxsYmFjaywgb3B0aW9ucyk7Cn07CmFwaS5kZWxheSA9IGZ1bmN0aW9uKHRpbWUsIGZuLCBhcmdzKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CglzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCWZuLmFwcGx5KHNlbGYsIGFyZ3MpOwoJfSwgdGltZSk7Cn0KCXJldHVybiBhcGk7Cn07CnZhciBpbmplY3RpbmcgPSBmdW5jdGlvbihhYnN1cmQpIHsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdpcycsIHsKCWFwcGVuZGVkOiBmdW5jdGlvbihzZWxlY3RvcikgewoJCWlmKHR5cGVvZiBzZWxlY3RvciA9PSAndW5kZWZpbmVkJykgc2VsZWN0b3IgPSB0aGlzLmhvc3QuaHRtbDsKCQlyZXR1cm4gcXMoc2VsZWN0b3IpID8gdHJ1ZSA6IGZhbHNlOwoJfSwKCWhpZGRlbjogZnVuY3Rpb24oZWwpIHsKCQllbCA9IGVsIHx8IHRoaXMuaG9zdC5lbDsKCQlyZXR1cm4gZWwub2Zmc2V0UGFyZW50ID09PSBudWxsOwoJfQp9KTsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdyb3V0ZXInLCB7Cglyb3V0ZXM6IFtdLAoJbW9kZTogbnVsbCwKCXJvb3Q6ICcvJywKCWdldEZyYWdtZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgZnJhZ21lbnQgPSAnJzsKCQlpZih0aGlzLm1vZGUgPT09ICdoaXN0b3J5JykgewoJCQlpZighbG9jYXRpb24pIHJldHVybiAnJzsKCQkJZnJhZ21lbnQgPSB0aGlzLmNsZWFyU2xhc2hlcyhkZWNvZGVVUkkobG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2gpKTsKCQkJZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKC9cPyguKikkLywgJycpOwoJCQlmcmFnbWVudCA9IHRoaXMucm9vdCAhPSAnLycgPyBmcmFnbWVudC5yZXBsYWNlKHRoaXMucm9vdCwgJycpIDogZnJhZ21lbnQ7CgkJfSBlbHNlIHsKCQkJaWYoIXdpbmRvdykgcmV0dXJuICcnOwoJCQl2YXIgbWF0Y2ggPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJCWZyYWdtZW50ID0gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJCX0KCQlyZXR1cm4gdGhpcy5jbGVhclNsYXNoZXMoZnJhZ21lbnQpOwoJfSwKICAgIGNsZWFyU2xhc2hlczogZnVuY3Rpb24ocGF0aCkgewogICAgCXJldHVybiBwYXRoLnRvU3RyaW5nKCkucmVwbGFjZSgvXC8kLywgJycpLnJlcGxhY2UoL15cLy8sICcnKTsKICAgIH0sCglhZGQ6IGZ1bmN0aW9uKHJlLCBoYW5kbGVyKSB7CgkJaWYodHlwZW9mIHJlID09ICdmdW5jdGlvbicpIHsKCQkJaGFuZGxlciA9IHJlOwoJCQlyZSA9ICcnOwoJCX0KCQl0aGlzLnJvdXRlcy5wdXNoKHsgcmU6IHJlLCBoYW5kbGVyOiBoYW5kbGVyfSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJcmVtb3ZlOiBmdW5jdGlvbihwYXJhbSkgewoJCWZvcih2YXIgaT0wLCByOyBpPHRoaXMucm91dGVzLmxlbmd0aCwgciA9IHRoaXMucm91dGVzW2ldOyBpKyspIHsKCQkJaWYoci5oYW5kbGVyID09PSBwYXJhbSB8fCByLnJlID09PSBwYXJhbSkgewoJCQkJdGhpcy5yb3V0ZXMuc3BsaWNlKGksIDEpOyAKCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCWZsdXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnJvdXRlcyA9IFtdOwoJCXRoaXMubW9kZSA9IG51bGw7CgkJdGhpcy5yb290ID0gJy8nOwoJCXJldHVybiB0aGlzOwoJfSwKCWNvbmZpZzogZnVuY3Rpb24ob3B0aW9ucykgewoJCXRoaXMubW9kZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5tb2RlICYmIG9wdGlvbnMubW9kZSA9PSAnaGlzdG9yeScgJiYgISEoaGlzdG9yeS5wdXNoU3RhdGUpID8gJ2hpc3RvcnknIDogJ2hhc2gnOwoJCXRoaXMucm9vdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5yb290ID8gJy8nICsgdGhpcy5jbGVhclNsYXNoZXMob3B0aW9ucy5yb290KSArICcvJyA6ICcvJzsKCQlyZXR1cm4gdGhpczsKCX0sCglsaXN0ZW46IGZ1bmN0aW9uKGxvb3BJbnRlcnZhbCkgewoJCXZhciBzZWxmID0gdGhpczsKCQl2YXIgY3VycmVudCA9IHNlbGYuZ2V0RnJhZ21lbnQoKTsKCQl2YXIgZm4gPSBmdW5jdGlvbigpIHsKCQkJaWYoY3VycmVudCAhPT0gc2VsZi5nZXRGcmFnbWVudCgpKSB7CgkJCQljdXJyZW50ID0gc2VsZi5nZXRGcmFnbWVudCgpOwoJCQkJc2VsZi5jaGVjayhjdXJyZW50KTsKCQkJfQoJCX0KCQljbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwoJCXRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmbiwgbG9vcEludGVydmFsIHx8IDUwKTsKCQlyZXR1cm4gdGhpczsKCX0sCgljaGVjazogZnVuY3Rpb24oZikgewoJCXZhciBmcmFnbWVudCA9IGYgfHwgdGhpcy5nZXRGcmFnbWVudCgpOwoJCWZvcih2YXIgaT0wOyBpPHRoaXMucm91dGVzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBtYXRjaCA9IGZyYWdtZW50Lm1hdGNoKHRoaXMucm91dGVzW2ldLnJlKTsKCQkJaWYobWF0Y2gpIHsKCQkJCW1hdGNoLnNoaWZ0KCk7CgkJCQl0aGlzLnJvdXRlc1tpXS5oYW5kbGVyLmFwcGx5KHRoaXMuaG9zdCB8fCB7fSwgbWF0Y2gpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0JCQkKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoJbmF2aWdhdGU6IGZ1bmN0aW9uKHBhdGgpIHsKCQlwYXRoID0gcGF0aCA/IHBhdGggOiAnJzsKCQlpZih0aGlzLm1vZGUgPT09ICdoaXN0b3J5JykgewoJCQloaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBudWxsLCB0aGlzLnJvb3QgKyB0aGlzLmNsZWFyU2xhc2hlcyhwYXRoKSk7CgkJfSBlbHNlIHsKCQkJd2luZG93LmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwoJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyMoLiopJC8sICcnKSArICcjJyArIHBhdGg7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9KTsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdhamF4JywgewoJcmVxdWVzdDogZnVuY3Rpb24ob3BzKSB7CgoJCWlmKHR5cGVvZiBvcHMgPT0gJ3N0cmluZycpIG9wcyA9IHsgdXJsOiBvcHMgfTsKCQlvcHMudXJsID0gb3BzLnVybCB8fCAnJzsKCQlvcHMubWV0aG9kID0gb3BzLm1ldGhvZCB8fCAnZ2V0JwoJCW9wcy5kYXRhID0gb3BzLmRhdGEgfHwge307CgoJCXZhciBnZXRQYXJhbXMgPSBmdW5jdGlvbihkYXRhLCB1cmwpIHsKCQkJdmFyIGFyciA9IFtdLCBzdHI7CgkJCWZvcih2YXIgbmFtZSBpbiBkYXRhKSB7CgkJCQlhcnIucHVzaChuYW1lICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFbbmFtZV0pKTsKCQkJfQoJCQlzdHIgPSBhcnIuam9pbignJicpOwoJCQlpZihzdHIgIT0gJycpIHsKCQkJCXJldHVybiB1cmwgPyAodXJsLmluZGV4T2YoJz8nKSA8IDAgPyAnPycgKyBzdHIgOiAnJicgKyBzdHIpIDogc3RyOwoJCQl9CgkJCXJldHVybiAnJzsKCQl9CgoJCXZhciBhcGkgPSB7CgkJCWhvc3Q6IHRoaXMuaG9zdCB8fCB7fSwKCQkJcHJvY2VzczogZnVuY3Rpb24ob3BzKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQl0aGlzLnhociA9IG51bGw7CgkJCQlpZih3aW5kb3cuQWN0aXZlWE9iamVjdCkgeyB0aGlzLnhociA9IG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOyB9CgkJCQllbHNlIGlmKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgeyB0aGlzLnhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOyB9CgkJCQlpZih0aGlzLnhocikgewoJCQkJCXRoaXMueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCQlpZihzZWxmLnhoci5yZWFkeVN0YXRlID09IDQgJiYgc2VsZi54aHIuc3RhdHVzID09IDIwMCkgewoJCQkJCQkJdmFyIHJlc3VsdCA9IHNlbGYueGhyLnJlc3BvbnNlVGV4dDsKCQkJCQkJCWlmKG9wcy5qc29uID09PSB0cnVlICYmIHR5cGVvZiBKU09OICE9ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkJcmVzdWx0ID0gSlNPTi5wYXJzZShyZXN1bHQpOwoJCQkJCQkJfQoJCQkJCQkJc2VsZi5kb25lQ2FsbGJhY2sgJiYgc2VsZi5kb25lQ2FsbGJhY2suYXBwbHkoc2VsZi5ob3N0LCBbcmVzdWx0LCBzZWxmLnhocl0pOwoJCQkJCQl9IGVsc2UgaWYoc2VsZi54aHIucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQkJCQlzZWxmLmZhaWxDYWxsYmFjayAmJiBzZWxmLmZhaWxDYWxsYmFjay5hcHBseShzZWxmLmhvc3QsIFtzZWxmLnhocl0pOwoJCQkJCQl9CgkJCQkJCXNlbGYuYWx3YXlzQ2FsbGJhY2sgJiYgc2VsZi5hbHdheXNDYWxsYmFjay5hcHBseShzZWxmLmhvc3QsIFtzZWxmLnhocl0pOwoJCQkJCX0KCQkJCQkKCQkJCQlpZihvcHMubWV0aG9kID09ICdnZXQnKSB7CgkJCQkJCXRoaXMueGhyLm9wZW4oIkdFVCIsIG9wcy51cmwgKyBnZXRQYXJhbXMob3BzLmRhdGEsIG9wcy51cmwpLCB0cnVlKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnhoci5vcGVuKG9wcy5tZXRob2QsIG9wcy51cmwsIHRydWUpOwoJCQkJCQl0aGlzLnNldEhlYWRlcnMoewoJCQkJCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQkJCQkJJ0NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQlpZihvcHMuaGVhZGVycyAmJiB0eXBlb2Ygb3BzLmhlYWRlcnMgPT0gJ29iamVjdCcpIHsKCQkJCQkJdGhpcy5zZXRIZWFkZXJzKG9wcy5oZWFkZXJzKTsKCQkJCQl9CQkKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAKCQkJCQkJb3BzLm1ldGhvZCA9PSAnZ2V0JyA/IHNlbGYueGhyLnNlbmQoKSA6IHNlbGYueGhyLnNlbmQoZ2V0UGFyYW1zKG9wcy5kYXRhKSk7IAoJCQkJCX0sIDIwKTsJCgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJZG9uZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXRoaXMuZG9uZUNhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJZmFpbDogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXRoaXMuZmFpbENhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJYWx3YXlzOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCQkJdGhpcy5hbHdheXNDYWxsYmFjayA9IGNhbGxiYWNrOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCXNldEhlYWRlcnM6IGZ1bmN0aW9uKGhlYWRlcnMpIHsKCQkJCWZvcih2YXIgbmFtZSBpbiBoZWFkZXJzKSB7CgkJCQkJdGhpcy54aHIgJiYgdGhpcy54aHIuc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBoZWFkZXJzW25hbWVdKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGFwaS5wcm9jZXNzKG9wcyk7CgoJfQp9KTsKdmFyIGRvbSA9IGZ1bmN0aW9uKGVsLCBwYXJlbnQpIHsKCXZhciBob3N0ID0gZG9tLnByb3RvdHlwZS5ob3N0OwoJdmFyIGFwaSA9IHsgZWw6IG51bGwgfTsKCS8vIGRlZmluaW5nIHRoZSBzY29wZQoJc3dpdGNoKHR5cGVvZiBlbCkgewoJCWNhc2UgJ3VuZGVmaW5lZCc6CgkJCWFwaS5lbCA9IGhvc3QuZWw7CgkJYnJlYWs7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcGFyZW50ID0gcGFyZW50ICYmIHR5cGVvZiBwYXJlbnQgPT09ICdzdHJpbmcnID8gcXMuYXBwbHkoaG9zdCwgW3BhcmVudF0pIDogcGFyZW50OwoJCQlhcGkuZWwgPSBxcyhlbCwgcGFyZW50IHx8IGhvc3QuZWwgfHwgZG9jdW1lbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ29iamVjdCc6IAoJCQlpZih0eXBlb2YgZWwubm9kZU5hbWUgIT0gJ3VuZGVmaW5lZCcpIHsKCSAgICAgICAgICAgIGFwaS5lbCA9IGVsOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAJdmFyIGxvb3AgPSBmdW5jdGlvbih2YWx1ZSwgb2JqKSB7CiAgICAgICAgICAgIAkJb2JqID0gb2JqIHx8IHRoaXM7CiAgICAgICAgICAgIAkJZm9yKHZhciBwcm9wIGluIG9iaikgewogICAgICAgIAkJCQlpZih0eXBlb2Ygb2JqW3Byb3BdLmVsICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgCQkJCQlvYmpbcHJvcF0gPSBvYmpbcHJvcF0udmFsKHZhbHVlKTsKICAgICAgICAJCQkJfSBlbHNlIGlmKHR5cGVvZiBvYmpbcHJvcF0gPT0gJ29iamVjdCcpIHsKICAgICAgICAJCQkJCW9ialtwcm9wXSA9IGxvb3AodmFsdWUsIG9ialtwcm9wXSk7CiAgICAgICAgCQkJCX0KICAgICAgICAgICAgCQl9CiAgICAgICAgICAgIAkJZGVsZXRlIG9iai52YWw7CiAgICAgICAgICAgIAkJcmV0dXJuIG9iajsKCSAgICAgICAgCX0KCSAgICAgICAgICAgIHZhciByZXMgPSB7IHZhbDogbG9vcCB9OwoJICAgICAgICAgICAgZm9yKHZhciBrZXkgaW4gZWwpIHsKCSAgICAgICAgICAgICAgICByZXNba2V5XSA9IGRvbS5hcHBseSh0aGlzLCBbZWxba2V5XV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHJlczsKCSAgICAgICAgfQoJCWJyZWFrOwoJfQoJLy8gZ2V0dGluZyBvciBzZXR0aW5nIGEgdmFsdWUKCWFwaS52YWwgPSBmdW5jdGlvbih2YWx1ZSkgewoJCWlmKCF0aGlzLmVsKSByZXR1cm4gbnVsbDsKCQl2YXIgc2V0ID0gISF2YWx1ZTsKCQl2YXIgdXNlVmFsdWVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCWlmKHNldCkgeyB0aGlzLmVsLnZhbHVlID0gdmFsdWU7IHJldHVybiBhcGk7IH0KCQkJZWxzZSB7IHJldHVybiB0aGlzLmVsLnZhbHVlOyB9CgkJfQogICAgICAgIHN3aXRjaCh0aGlzLmVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAJY2FzZSAnaW5wdXQnOgogICAgICAgIAkJdmFyIHR5cGUgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZSgndHlwZScpOwogICAgICAgIAkJaWYodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgewoJICAgICAgICAgICAgICAgIHZhciBlbHMgPSBxc2EoJ1tuYW1lPSInICsgdGhpcy5lbC5nZXRBdHRyaWJ1dGUoJ25hbWUnKSArICciXScsIHBhcmVudCk7CgkgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGVscy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICBpZihzZXQgJiYgZWxzW2ldLmNoZWNrZWQgJiYgZWxzW2ldLnZhbHVlICE9PSB2YWx1ZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZWxzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnY2hlY2tlZCcpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoc2V0ICYmIGVsc1tpXS52YWx1ZSA9PT0gdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgCWVsc1tpXS5zZXRBdHRyaWJ1dGUoJ2NoZWNrZWQnLCAnY2hlY2tlZCcpOwoJICAgICAgICAgICAgICAgICAgICAJZWxzW2ldLmNoZWNrZWQgPSAnY2hlY2tlZCc7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihlbHNbaV0uY2hlY2tlZCkgewoJICAgICAgICAgICAgICAgICAgICAJdmFsdWVzLnB1c2goZWxzW2ldLnZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZighc2V0KSB7IHJldHVybiB0eXBlID09ICdyYWRpbycgPyB2YWx1ZXNbMF0gOiB2YWx1ZXM7IH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAJcmV0dXJuIHVzZVZhbHVlUHJvcGVydHkuYXBwbHkodGhpcywgW3ZhbHVlXSk7CgkgICAgICAgICAgICB9CiAgICAgICAgCWJyZWFrOwogICAgICAgIAljYXNlICd0ZXh0YXJlYSc6IHJldHVybiB1c2VWYWx1ZVByb3BlcnR5LmFwcGx5KHRoaXMsIFt2YWx1ZV0pOyBicmVhazsKICAgICAgICAJY2FzZSAnc2VsZWN0JzoKICAgICAgICAJCWlmKHNldCkgewogICAgICAgICAgICAJCXZhciBvcHRpb25zID0gcXNhKCdvcHRpb24nLCB0aGlzLmVsKTsKICAgICAgICAgICAgCQlmb3IodmFyIGk9MDsgaTxvcHRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIAkJCWlmKG9wdGlvbnNbaV0uZ2V0QXR0cmlidXRlKCd2YWx1ZScpID09PSB2YWx1ZSkgewogICAgICAgICAgICAJCQkJdGhpcy5lbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICAgICAgCQkJfSBlbHNlIHsKICAgICAgICAgICAgCQkJCW9wdGlvbnNbaV0ucmVtb3ZlQXR0cmlidXRlKCdzZWxlY3RlZCcpOwogICAgICAgICAgICAJCQl9CiAgICAgICAgICAgIAkJfQogICAgICAgICAgICAJfSBlbHNlIHsKICAgICAgICAgICAgICAgIAlyZXR1cm4gdGhpcy5lbC52YWx1ZTsKICAgICAgICAgICAgCX0KICAgICAgICAJYnJlYWs7CiAgICAgICAgCWRlZmF1bHQ6IAogICAgICAgIAkJaWYoc2V0KSB7CiAgICAgICAgCQkJdGhpcy5lbC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICAJCX0gZWxzZSB7CgkgICAgICAgIAkJaWYodHlwZW9mIHRoaXMuZWwudGV4dENvbnRlbnQgIT0gJ3VuZGVmaW5lZCcpIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWwudGV4dENvbnRlbnQ7CgkJICAgICAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiB0aGlzLmVsLmlubmVyVGV4dCAhPSAndW5kZWZpbmVkJykgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHRoaXMuZWwuaW5uZXJUZXh0OwoJCSAgICAgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKCQkgICAgICAgICAgICB9CgkgICAgICAgIAl9CiAgICAgICAgCWJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0ID8gYXBpIDogbnVsbDsKCX0KCS8vIGNoYWluaW5nIGRvbSBtb2R1bGUKCWFwaS5kb20gPSBmdW5jdGlvbihlbCwgcGFyZW50KSB7CgkJcmV0dXJuIGRvbShlbCwgcGFyZW50IHx8IGFwaS5lbCk7Cgl9CglyZXR1cm4gYXBpOwp9CmFic3VyZC5kaS5yZWdpc3RlcignZG9tJywgZG9tKTsKdmFyIG1xID0gZnVuY3Rpb24ocXVlcnksIGNhbGxiYWNrLCB1c2VQb2x5ZmlsbCkgewoJdmFyIGhvc3QgPSBtcS5wcm90b3R5cGUuaG9zdDsKCXZhciBpc01hdGNoTWVkaWFTdXBwb3J0ZWQgPSAhISh3aW5kb3cgJiYgd2luZG93Lm1hdGNoTWVkaWEpICYmICF1c2VQb2x5ZmlsbDsKCWlmKGlzTWF0Y2hNZWRpYVN1cHBvcnRlZCkgewoJCXZhciByZXMgPSB3aW5kb3cubWF0Y2hNZWRpYShxdWVyeSk7CgkJY2FsbGJhY2suYXBwbHkoaG9zdCwgW3Jlcy5tYXRjaGVzLCByZXMubWVkaWFdKTsKCQlyZXMuYWRkTGlzdGVuZXIoZnVuY3Rpb24oY2hhbmdlZCkgewoJCQljYWxsYmFjay5hcHBseShob3N0LCBbY2hhbmdlZC5tYXRjaGVzLCBjaGFuZ2VkLm1lZGlhXSk7CgkJfSk7Cgl9IGVsc2UgewoJCXZhciBpZCA9ICIubWF0Y2gtbWVkaWEtIiArIGFic3VyZC5jb21wb25lbnRzLm51bU9mQ29tcG9uZW50czsKCQl2YXIgY3NzID0ge30sIGh0bWwgPSB7fTsKCQljc3NbaWRdID0geyBkaXNwbGF5OiAnYmxvY2snIH07CgkJY3NzW2lkXVsnQG1lZGlhICcgKyBxdWVyeV0gPSB7IGRpc3BsYXk6ICdub25lJyB9OwoJCWh0bWxbJ3NwYW4nICsgaWRdID0gJyc7CgkJYWJzdXJkLmNvbXBvbmVudChpZCArICctY29tcG9uZW50JywgewoJCQljc3M6IGNzcywKCQkJaHRtbDogaHRtbCwKCQkJaW50ZXJ2YWxpVGltZTogMzAsCgkJCXN0YXR1czogJycsCgkJCWxvb3A6IGZ1bmN0aW9uKGRvbSkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJaWYodGhpcy5lbCkgewoJCQkJCXZhciBkID0gdGhpcy5nZXRTdHlsZSgnZGlzcGxheScpOwoJCQkJCWlmKHRoaXMuc3RhdHVzICE9IGQpIHsKCQkJCQkJdGhpcy5zdGF0dXMgPSBkOwoJCQkJCQljYWxsYmFjay5hcHBseShob3N0LCBbZCA9PT0gJ25vbmUnXSkKCQkJCQl9CgkJCQl9CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvb3AoKTsgfSwgdGhpcy5pbnRlcnZhbGlUaW1lKTsKCQkJfSwKCQkJY29uc3RydWN0b3I6IFsnZG9tJywgZnVuY3Rpb24oZG9tKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQl0aGlzLnNldCgncGFyZW50JywgZG9tKCdib2R5JykuZWwpLnBvcHVsYXRlKCk7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvb3AoKTsgfSwgdGhpcy5pbnRlcnZhbGlUaW1lKTsKCQkJfV0KCQl9KSgpOwoJfQp9OwphYnN1cmQuZGkucmVnaXN0ZXIoJ21xJywgbXEpOwp9CnZhciBjbGllbnQgPSBmdW5jdGlvbigpIHsKCXJldHVybiBmdW5jdGlvbihhcmcpIHsKCgkJLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogQ29waWVkIGRpcmVjdGx5IGZyb20gL2xpYi9BUEkuanMgKi8KCgkJdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKCQkJZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewoJCQkJaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKCQkJCQlkZXN0aW5hdGlvbltrZXldID0gc291cmNlW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGRlc3RpbmF0aW9uOwoJCX07CgoJCXZhciBfYXBpID0geyAKCQkJCWRlZmF1bHRQcm9jZXNzb3I6IGxpYi5wcm9jZXNzb3JzLmNzcy5DU1MoKSAKCQkJfSwKCQkJX3J1bGVzID0ge30sCgkJCV9zdG9yYWdlID0ge30sCgkJCV9wbHVnaW5zID0ge30sCgkJCV9ob29rcyA9IHt9OwoKCQlfYXBpLmdldFJ1bGVzID0gZnVuY3Rpb24oc3R5bGVzaGVldCkgewoJCQlpZih0eXBlb2Ygc3R5bGVzaGVldCA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybiBfcnVsZXM7CgkJCX0gZWxzZSB7CgkJCQlpZih0eXBlb2YgX3J1bGVzW3N0eWxlc2hlZXRdID09PSAndW5kZWZpbmVkJykgewoJCQkJCV9ydWxlc1tzdHlsZXNoZWV0XSA9IFtdOwoJCQkJfQoJCQkJcmV0dXJuIF9ydWxlc1tzdHlsZXNoZWV0XTsKCQkJfQoJCX0KCQlfYXBpLmdldFBsdWdpbnMgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIF9wbHVnaW5zOwkJCgkJfQoJCV9hcGkuZ2V0U3RvcmFnZSA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gX3N0b3JhZ2U7CgkJfQoJCV9hcGkuZmx1c2ggPSBmdW5jdGlvbigpIHsKCQkJX3J1bGVzID0ge307CgkJCV9zdG9yYWdlID0gW107CgkJCV9ob29rcyA9IHt9OwoJCQlfYXBpLmRlZmF1bHRQcm9jZXNzb3IgPSBsaWIucHJvY2Vzc29ycy5jc3MuQ1NTKCk7CgkJCXJldHVybiBfYXBpOwoJCX0KCQlfYXBpWydpbXBvcnQnXSA9IGZ1bmN0aW9uKCkgeyAKCQkJaWYoX2FwaS5jYWxsSG9va3MoImltcG9ydCIsIGFyZ3VtZW50cykpIHJldHVybiBfYXBpOwoJCQlyZXR1cm4gX2FwaTsgCgkJfQoJCV9hcGkuaGFuZGxlY3NzID0gZnVuY3Rpb24ocGFyc2VkLCBwYXRoKSB7CgkJCXZhciBwbHVnaW5zID0gX2FwaS5nZXRQbHVnaW5zKCk7CgkJCWlmKHBhcnNlZCAmJiBwYXJzZWQudHlwZSA9PT0gJ3N0eWxlc2hlZXQnICYmIHBhcnNlZC5zdHlsZXNoZWV0ICYmIHBhcnNlZC5zdHlsZXNoZWV0LnJ1bGVzKSB7CgkJCQl2YXIgcnVsZXMgPSBwYXJzZWQuc3R5bGVzaGVldC5ydWxlczsKCQkJCWZvcih2YXIgaT0wOyBydWxlPXJ1bGVzW2ldOyBpKyspIHsKCQkJCQlzd2l0Y2gocnVsZS50eXBlKSB7CgkJCQkJCWNhc2UgInJ1bGUiOiBfYXBpLmhhbmRsZWNzc3J1bGUocnVsZSk7IGJyZWFrOwoJCQkJCQljYXNlICJpbXBvcnQiOiBfYXBpLmhhbmRsZWNzc2ltcG9ydChydWxlLCBwYXRoKTsgYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlpZihwbHVnaW5zW3J1bGUudHlwZV0pIHsKCQkJCQkJCQlwbHVnaW5zW3J1bGUudHlwZV0oX2FwaSwgcnVsZSk7CgkJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gX2FwaTsKCQl9CgkJX2FwaS5oYW5kbGVjc3NpbXBvcnQgPSBmdW5jdGlvbihydWxlLCBjc3NQYXRoKSB7CgkJCXJldHVybiBfYXBpOwoJCX0KCQlfYXBpLmhhbmRsZWNzc3J1bGUgPSBmdW5jdGlvbihydWxlLCBzdHlsZXNoZWV0KSB7CQkKCQkJdmFyIGFic3VyZE9iaiA9IHt9LCBhYnN1cmRQcm9wcyA9IHt9OwoJCQlpZihydWxlLmRlY2xhcmF0aW9ucyAmJiBydWxlLmRlY2xhcmF0aW9ucy5sZW5ndGggPiAwKSB7CgkJCQlmb3IodmFyIGk9MDsgZGVjbD1ydWxlLmRlY2xhcmF0aW9uc1tpXTsgaSsrKSB7CgkJCQkJaWYoZGVjbC50eXBlID09PSAiZGVjbGFyYXRpb24iKSB7CgkJCQkJCWFic3VyZFByb3BzW2RlY2wucHJvcGVydHldID0gZGVjbC52YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBhYnN1cmRPYmpbcnVsZS5zZWxlY3RvcnMuam9pbigiLCAiKV0gPSBhYnN1cmRQcm9wczsKCQkJCWlmKHJ1bGUuc2VsZWN0b3JzICYmIHJ1bGUuc2VsZWN0b3JzLmxlbmd0aCA+IDApIHsKCQkJCQlmb3IodmFyIGk9MDsgc2VsZWN0b3I9cnVsZS5zZWxlY3RvcnNbaV07IGkrKykgewoJCQkJCQlhYnN1cmRPYmpbc2VsZWN0b3JdID0gZXh0ZW5kKHt9LCBhYnN1cmRQcm9wcyk7CgkJCQkJfQoJCQkJfQoJCQkJX2FwaS5hZGQoYWJzdXJkT2JqLCBzdHlsZXNoZWV0KTsKCQkJfQoJCQlyZXR1cm4gX2FwaTsKCQl9CgoJCS8vIGhvb2tzCgkJX2FwaS5hZGRIb29rID0gZnVuY3Rpb24obWV0aG9kLCBjYWxsYmFjaykgewoJCQlpZighX2hvb2tzW21ldGhvZF0pIF9ob29rc1ttZXRob2RdID0gW107CgkJCXZhciBpc0FscmVhZHlBZGRlZCA9IGZhbHNlOwoJCQlmb3IodmFyIGk9MDsgYz1faG9va3NbbWV0aG9kXVtpXTsgaSsrKSB7CgkJCQlpZihjID09PSBjYWxsYmFjaykgewoJCQkJCWlzQWxyZWFkeUFkZGVkID0gdHJ1ZTsKCQkJCX0KCQkJfQoJCQlpc0FscmVhZHlBZGRlZCA9PT0gZmFsc2UgPyBfaG9va3NbbWV0aG9kXS5wdXNoKGNhbGxiYWNrKSA6IG51bGw7CgkJfQoJCV9hcGkuY2FsbEhvb2tzID0gZnVuY3Rpb24obWV0aG9kLCBhcmdzKSB7CgkJCWlmKF9ob29rc1ttZXRob2RdKSB7CgkJCQlmb3IodmFyIGk9MDsgYz1faG9va3NbbWV0aG9kXVtpXTsgaSsrKSB7CgkJCQkJaWYoYy5hcHBseShfYXBpLCBhcmdzKSA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gaW50ZXJuYWwgdmFyaWFibGVzCgkJX2FwaS5udW1PZkFkZGVkUnVsZXMgPSAwOwoKCQkvLyBhYnN1cmQuY29tcG9uZW50cyBBUEkKCQlfYXBpLmNvbXBvbmVudHMgPSAoZnVuY3Rpb24oYXBpKSB7CgkJCXZhciBleHRlbmQgPSBsaWIuaGVscGVycy5FeHRlbmQsCgkJCQljbG9uZSA9IGxpYi5oZWxwZXJzLkNsb25lLAoJCQkJY29tcHMgPSB7fSwgCgkJCQlpbnN0YW5jZXMgPSBbXSwKCQkJCWV2ZW50cyA9IGV4dGVuZCh7fSwgQ29tcG9uZW50KCkpLAoJCQkJZXhwb3J0cyA9IHt9OwoKCQkJKGZ1bmN0aW9uKGZuKSB7CgkJCQlpZighd2luZG93KSByZXR1cm47CgkJCQlpZiAod2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKCQkJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZuKTsKCQkJCX0gZWxzZSBpZih3aW5kb3cuYXR0YWNoRXZlbnQpIHsKCQkJCQl3aW5kb3cuYXR0YWNoRXZlbnQoJ29ubG9hZCcsIGZuKTsKCQkJCX0KCQkJfSkoZnVuY3Rpb24oKSB7CgkJCQlleHBvcnRzLmJyb2FkY2FzdCgicmVhZHkiKTsKCQkJfSkKCgkJCXJldHVybiBleHBvcnRzID0gewoJCQkJbnVtT2ZDb21wb25lbnRzOiAwLAoJCQkJZXZlbnRzOiBldmVudHMsCgkJCQlyZWdpc3RlcjogZnVuY3Rpb24obmFtZSwgY2xzKSB7CgkJCQkJdGhpcy5udW1PZkNvbXBvbmVudHMgKz0gMTsKCQkJCQlyZXR1cm4gY29tcHNbbmFtZV0gPSBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIGMgPSBleHRlbmQoe30sIENvbXBvbmVudChuYW1lLCBhcGksIGV2ZW50cywgY2xvbmUoY2xzKSkpOwoJCQkJCQlhcGkuZGkucmVzb2x2ZU9iamVjdChjKTsKCQkJCQkJaW5zdGFuY2VzLnB1c2goYyk7CgkJCQkJCWlmKHR5cGVvZiBjLmNvbnN0cnVjdG9yID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQljLmNvbnN0cnVjdG9yLmFwcGx5KGMsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwoJCQkJCQl9CgkJCQkJCXJldHVybiBjOwoJCQkJCX07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbihuYW1lKSB7CgkJCQkJaWYoY29tcHNbbmFtZV0pIHsgcmV0dXJuIGNvbXBzW25hbWVdOyB9CgkJCQkJZWxzZSB7IHRocm93IG5ldyBFcnJvcigiVGhlcmUgaXMgbm8gY29tcG9uZW50IHdpdGggbmFtZSAnIiArIG5hbWUgKyAiJy4iKTsgfQoJCQkJfSwKCQkJCXJlbW92ZTogZnVuY3Rpb24obmFtZSkgewoJCQkJCWlmKGNvbXBzW25hbWVdKSB7IGRlbGV0ZSBjb21wc1tuYW1lXTsgcmV0dXJuIHRydWU7IH0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9LAoJCQkJbGlzdDogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGwgPSBbXTsKCQkJCQlmb3IodmFyIG5hbWUgaW4gY29tcHMpIGwucHVzaChuYW1lKTsKCQkJCQlyZXR1cm4gbDsKCQkJCX0sCgkJCQlmbHVzaDogZnVuY3Rpb24oKSB7CgkJCQkJY29tcHMgPSB7fTsKCQkJCQlpbnN0YW5jZXMgPSBbXTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgkJCQlicm9hZGNhc3Q6IGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7CgkJCQkJZm9yKHZhciBpPTA7IGk8aW5zdGFuY2VzLmxlbmd0aCwgaW5zdGFuY2U9aW5zdGFuY2VzW2ldOyBpKyspIHsKCQkJCQkJaWYodHlwZW9mIGluc3RhbmNlW2V2ZW50XSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJaW5zdGFuY2VbZXZlbnRdKGRhdGEpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgkJfSkoX2FwaSk7CgoJCS8vIGFic3VyZC5jb21wb25lbnQgc2hvcnRjdXQKCQlfYXBpLmNvbXBvbmVudCA9IChmdW5jdGlvbihhcGkpIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKG5hbWUsIGNscykgewoJCQkJaWYodHlwZW9mIGNscyA9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldHVybiBhcGkuY29tcG9uZW50cy5nZXQobmFtZSk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBhcGkuY29tcG9uZW50cy5yZWdpc3RlcihuYW1lLCBjbHMpOwoJCQkJfQoJCQl9CgkJfSkoX2FwaSk7CgoJCS8vIGRlcGVuZGVuY3kgaW5qZWN0b3IKCQlfYXBpLmRpID0gbGliLkRJKF9hcGkpOwoJCWluamVjdGluZyhfYXBpKTsKCgkJLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogQ29waWVkIGRpcmVjdGx5IGZyb20gL2xpYi9BUEkuanMgKi8KCgkJLy8gY2xpZW50IHNpZGUgc3BlY2lmaWMgbWV0aG9kcyAKCQlfYXBpLmNvbXBpbGUgPSBmdW5jdGlvbihjYWxsYmFjaywgb3B0aW9ucykgewoJCQlpZihfYXBpLmNhbGxIb29rcygiY29tcGlsZSIsIGFyZ3VtZW50cykpIHJldHVybiBfYXBpOwoJCQl2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CgkJCQljb21iaW5lU2VsZWN0b3JzOiB0cnVlLAoJCQkJbWluaWZ5OiBmYWxzZSwKCQkJCXByb2Nlc3NvcjogX2FwaS5kZWZhdWx0UHJvY2Vzc29yLAoJCQkJa2VlcENhbWVsQ2FzZTogZmFsc2UsCgkJCQlhcGk6IF9hcGkKCQkJfTsKCQkJb3B0aW9ucyA9IGV4dGVuZChkZWZhdWx0T3B0aW9ucywgb3B0aW9ucyB8fCB7fSk7CgkJCXZhciByZXMgPSBvcHRpb25zLnByb2Nlc3NvcigKCQkJCV9hcGkuZ2V0UnVsZXMoKSwKCQkJCWNhbGxiYWNrIHx8IGZ1bmN0aW9uKCkge30sCgkJCQlvcHRpb25zCgkJCSk7CgkJCV9hcGkuZmx1c2goKTsKCQkJcmV0dXJuIHJlczsKCQl9CgoJCS8vIHJlZ2lzdGVyaW5nIGFwaSBtZXRob2RzCgkJZm9yKHZhciBtZXRob2QgaW4gbGliLmFwaSkgewoJCQlpZihtZXRob2QgIT09ICJjb21waWxlIikgewoJCQkJX2FwaVttZXRob2RdID0gbGliLmFwaVttZXRob2RdKF9hcGkpOwoJCQkJX2FwaVttZXRob2RdID0gKGZ1bmN0aW9uKG1ldGhvZCkgewoJCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIGYgPSBsaWIuYXBpW21ldGhvZF0oX2FwaSk7CgkJCQkJCWlmKF9hcGkuY2FsbEhvb2tzKG1ldGhvZCwgYXJndW1lbnRzKSkgcmV0dXJuIF9hcGk7CgkJCQkJCXJldHVybiBmLmFwcGx5KF9hcGksIGFyZ3VtZW50cyk7CgkJCQkJfQoJCQkJfSkobWV0aG9kKTsJCQoJCQl9CgkJfQoKCQkvLyByZWdpc3RlcmluZyBwbHVnaW5zCgkJZm9yKHZhciBwbHVnaW5OYW1lIGluIGxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zKSB7CgkJCV9hcGkucGx1Z2luKHBsdWdpbk5hbWUsIGxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zW3BsdWdpbk5hbWVdKCkpOwoJCX0KCgkJLy8gYWNjZXB0IGZ1bmN0aW9uCgkJaWYodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIikgewoJCQlhcmcoX2FwaSk7CgkJfQoKCQkvLyBjaGVjayBmb3IgT3JnYW5pYwoJCWlmKHR5cGVvZiBPcmdhbmljICE9ICd1bmRlZmluZWQnKSB7CgkJCU9yZ2FuaWMuaW5pdChfYXBpKTsKCQl9CgoJCS8vIGF0dGFjaGluZyB1dGlscyBmdW5jdGlvbnMKCQlfYXBpLnV0aWxzID0gewoJCQlzdHIyRE9NRWxlbWVudDogc3RyMkRPTUVsZW1lbnQKCQl9CgoJCXJldHVybiBfYXBpOwoKCX0KfTs=",
                "body": "dmFyIGxpYiA9IHsgCiAgICBhcGk6IHt9LAogICAgaGVscGVyczoge30sCiAgICBwbHVnaW5zOiB7fSwKICAgIHByb2Nlc3NvcnM6IHsgCiAgICAgICAgY3NzOiB7IHBsdWdpbnM6IHt9fSwKICAgICAgICBodG1sOiB7IAogICAgICAgICAgICBwbHVnaW5zOiB7fSwKICAgICAgICAgICAgaGVscGVyczoge30KICAgICAgICB9LAogICAgICAgIGNvbXBvbmVudDogeyBwbHVnaW5zOiB7fX0KICAgIH0KfTsKdmFyIHJlcXVpcmUgPSBmdW5jdGlvbih2KSB7CiAgICAvLyBjc3MgcHJlcHJvY2Vzc29yCiAgICBpZih2LmluZGV4T2YoJ2Nzcy9DU1MuanMnKSA+IDAgfHwgdiA9PSAnLy4uL0NTUy5qcycpIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuY3NzLkNTUzsKICAgIH0gZWxzZSBpZih2LmluZGV4T2YoJ2h0bWwvSFRNTC5qcycpID4gMCkgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5odG1sLkhUTUw7CiAgICB9IGVsc2UgaWYodi5pbmRleE9mKCdjb21wb25lbnQvQ29tcG9uZW50LmpzJykgPiAwKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmNvbXBvbmVudC5Db21wb25lbnQ7CiAgICB9IGVsc2UgaWYodiA9PSAnanMtYmVhdXRpZnknKSB7CiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICAgIGh0bWw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmKHYgPT0gJy4vaGVscGVycy9Qcm9wQW5hbHl6ZXInKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmh0bWwuaGVscGVycy5Qcm9wQW5hbHl6ZXI7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vLi4vaGVscGVycy9UcmFuc2Zvcm1VcHBlcmNhc2UnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLlRyYW5zZm9ybVVwcGVyY2FzZTsKICAgIH0gZWxzZSBpZih2ID09ICcuL2hlbHBlcnMvVGVtcGxhdGVFbmdpbmUnIHx8IHYgPT0gJy4uL2h0bWwvaGVscGVycy9UZW1wbGF0ZUVuZ2luZScpIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuaHRtbC5oZWxwZXJzLlRlbXBsYXRlRW5naW5lOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uL2hlbHBlcnMvRXh0ZW5kJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5FeHRlbmQ7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vaGVscGVycy9DbG9uZScpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuQ2xvbmU7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vaGVscGVycy9QcmVmaXhlcycgfHwgdiA9PSAnLy4uLy4uLy4uL2hlbHBlcnMvUHJlZml4ZXMnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLlByZWZpeGVzOwogICAgfSBlbHNlIGlmKHYgPT0gX19kaXJuYW1lICsgJy8uLi8uLi8uLi8uLi8nKSB7CiAgICAgICAgcmV0dXJuIEFic3VyZDsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL0NTU1BhcnNlJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5DU1NQYXJzZTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge30KICAgIH0KfTsKdmFyIF9fZGlybmFtZSA9ICIiOwp2YXIgcXVldWUgID0gZnVuY3Rpb24oZnVuY3MsIHNjb3BlKSB7CgkoZnVuY3Rpb24gbmV4dCgpIHsKCQlpZihmdW5jcy5sZW5ndGggPiAwKSB7CgkJCWZ1bmNzLnNoaWZ0KCkuYXBwbHkoc2NvcGUgfHwge30sIFtuZXh0XS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpOwoJCX0KCX0pKCk7Cn0KdmFyIHN0cjJET01FbGVtZW50ID0gZnVuY3Rpb24oaHRtbCkgewogICB2YXIgd3JhcE1hcCA9IHsKICAgICAgICBvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAogICAgICAgIGxlZ2VuZDogWyAxLCAiPGZpZWxkc2V0PiIsICI8L2ZpZWxkc2V0PiIgXSwKICAgICAgICBhcmVhOiBbIDEsICI8bWFwPiIsICI8L21hcD4iIF0sCiAgICAgICAgcGFyYW06IFsgMSwgIjxvYmplY3Q+IiwgIjwvb2JqZWN0PiIgXSwKICAgICAgICB0aGVhZDogWyAxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiIgXSwKICAgICAgICB0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKICAgICAgICBjb2w6IFsgMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCiAgICAgICAgdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICAgICAgYm9keTogWzAsICIiLCAiIl0sCiAgICAgICAgX2RlZmF1bHQ6IFsgMSwgIjxkaXY+IiwgIjwvZGl2PiIgIF0KICAgIH07CiAgICB3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CiAgICB3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwogICAgd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CiAgICB2YXIgbWF0Y2ggPSAvPFxzKlx3Lio/Pi9nLmV4ZWMoaHRtbCk7CiAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaWYobWF0Y2ggIT0gbnVsbCkgewogICAgICAgIHZhciB0YWcgPSBtYXRjaFswXS5yZXBsYWNlKC88L2csICcnKS5yZXBsYWNlKC8+L2csICcnKS5zcGxpdCgnICcpWzBdOwogICAgICAgIGlmKHRhZy50b0xvd2VyQ2FzZSgpID09PSAnYm9keScpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZURvY3VtZW50KCdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJywgJ2h0bWwnLCBudWxsKTsKICAgICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJib2R5Iik7CiAgICAgICAgICAgIC8vIGtlZXBpbmcgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sLnJlcGxhY2UoLzxib2R5L2csICc8ZGl2JykucmVwbGFjZSgvPFwvYm9keT4vZywgJzwvZGl2PicpOwogICAgICAgICAgICB2YXIgYXR0cnMgPSBlbGVtZW50LmZpcnN0Q2hpbGQuYXR0cmlidXRlczsKICAgICAgICAgICAgYm9keS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICBmb3IodmFyIGk9MDsgaTxhdHRycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgYm9keS5zZXRBdHRyaWJ1dGUoYXR0cnNbaV0ubmFtZSwgYXR0cnNbaV0udmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBib2R5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdCwgZWxlbWVudDsKICAgICAgICAgICAgaHRtbCA9IG1hcFsxXSArIGh0bWwgKyBtYXBbMl07CiAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50CiAgICAgICAgICAgIHZhciBqID0gbWFwWzBdKzE7CiAgICAgICAgICAgIHdoaWxlKGotLSkgewogICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQubGFzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQubGFzdENoaWxkOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnQ7Cn0KdmFyIGFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihvYmosIGV2dCwgZm5jKSB7CiAgICBpZiAob2JqLmFkZEV2ZW50TGlzdGVuZXIpIHsgLy8gVzNDIG1vZGVsCiAgICAgICAgb2JqLmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCBmbmMsIGZhbHNlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAob2JqLmF0dGFjaEV2ZW50KSB7IC8vIE1pY3Jvc29mdCBtb2RlbAogICAgICAgIHJldHVybiBvYmouYXR0YWNoRXZlbnQoJ29uJyArIGV2dCwgZm5jKTsKICAgIH0KfQp2YXIgcmVtb3ZlRW1wdHlUZXh0Tm9kZXMgPSBmdW5jdGlvbihlbGVtKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBlbGVtLmNoaWxkTm9kZXM7CiAgICB2YXIgY2hpbGQ7CiAgICB2YXIgbGVuID0gY2hpbGRyZW4ubGVuZ3RoOwogICAgdmFyIGkgPSAwOwogICAgdmFyIHdoaXRlc3BhY2UgPSAvXlxzKiQvOwogICAgZm9yKDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgIGlmKGNoaWxkLm5vZGVUeXBlID09IDMpewogICAgICAgICAgICBpZih3aGl0ZXNwYWNlLnRlc3QoY2hpbGQubm9kZVZhbHVlKSl7CiAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIGxlbi0tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGVsZW07Cn0KdmFyIGNyZWF0ZU5vZGUgPSBmdW5jdGlvbih0eXBlLCBhdHRycywgY29udGVudCkgewoJdmFyIG5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUpOwoJZm9yKHZhciBpPTA7IGk8YXR0cnMubGVuZ3RoLCBhPWF0dHJzW2ldOyBpKyspIHsKCQlub2RlLnNldEF0dHJpYnV0ZShhLm5hbWUsIGEudmFsdWUpOwoJfQoJbm9kZS5pbm5lckhUTUwgPSBjb250ZW50OwoJcmV0dXJuIG5vZGU7Cn0KdmFyIHFzID0gZnVuY3Rpb24oc2VsZWN0b3IsIHBhcmVudCkgewogICAgaWYocGFyZW50ID09PSBmYWxzZSkgeyBwYXJlbnQgPSBkb2N1bWVudDsgfQogICAgZWxzZSB7IHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLmVsIHx8IGRvY3VtZW50OyB9CiAgICByZXR1cm4gcGFyZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwp9Owp2YXIgcXNhID0gZnVuY3Rpb24oc2VsZWN0b3IsIHBhcmVudCkgewogICAgaWYocGFyZW50ID09PSBmYWxzZSkgeyBwYXJlbnQgPSBkb2N1bWVudDsgfQogICAgZWxzZSB7IHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLmVsIHx8IGRvY3VtZW50OyB9CiAgICByZXR1cm4gcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwp9Owp2YXIgZ2V0U3R5bGUgPSBmdW5jdGlvbihzdHlsZVByb3AsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZihlbCAmJiBlbC5jdXJyZW50U3R5bGUpIHsKICAgICAgICByZXR1cm4gZWwuY3VycmVudFN0eWxlW3N0eWxlUHJvcF07CiAgICB9IGVsc2UgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWwsIG51bGwpLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wKTsKICAgIH0KICAgIHJldHVybiBudWxsOwp9Owp2YXIgYWRkQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWUsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZihlbC5jbGFzc0xpc3QpIHsKICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciBjdXJyZW50ID0gZWwuY2xhc3NOYW1lOwogICAgICAgIGlmKGN1cnJlbnQuaW5kZXhPZihjbGFzc05hbWUpIDwgMCkgewogICAgICAgICAgICBpZihjdXJyZW50ID09ICcnKSBlbC5jbGFzc05hbWUgPSBjbGFzc05hbWU7CiAgICAgICAgICAgIGVsc2UgZWwuY2xhc3NOYW1lICs9ICcgJyArIGNsYXNzTmFtZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKfTsKdmFyIHJlbW92ZUNsYXNzID0gZnVuY3Rpb24oY2xhc3NOYW1lLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBlbC5jbGFzc05hbWUuc3BsaXQoJyAnKTsKICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IFtdOwogICAgICAgIGZvcih2YXIgaT0wOyBpPGN1cnJlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYoY3VycmVudFtpXSAhPSBjbGFzc05hbWUpIG5ld0NsYXNzZXMucHVzaChjdXJyZW50W2ldKTsKICAgICAgICB9CiAgICAgICAgZWwuY2xhc3NOYW1lID0gbmV3Q2xhc3Nlcy5qb2luKCcgJyk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKfQp2YXIgcmVwbGFjZUNsYXNzID0gZnVuY3Rpb24oY2xhc3NOYW1lQSwgY2xhc3NOYW1lQiwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIHZhciBjdXJyZW50ID0gZWwuY2xhc3NOYW1lLnNwbGl0KCcgJyksIGZvdW5kID0gZmFsc2U7CiAgICBmb3IodmFyIGk9MDsgaTxjdXJyZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYoY3VycmVudFtpXSA9PSBjbGFzc05hbWVBKSB7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgY3VycmVudFtpXSA9IGNsYXNzTmFtZUI7CiAgICAgICAgfQogICAgfQogICAgaWYoIWZvdW5kKSB7CiAgICAgICAgcmV0dXJuIGFkZENsYXNzKGNsYXNzTmFtZUIsIGVsKTsKICAgIH0KICAgIGVsLmNsYXNzTmFtZSA9IGN1cnJlbnQuam9pbignICcpOwogICAgcmV0dXJuIHRoaXM7Cn0KdmFyIHRvZ2dsZUNsYXNzID0gZnVuY3Rpb24oY2xhc3NOYW1lLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNsYXNzZXMgPSBlbC5jbGFzc05hbWUuc3BsaXQoJyAnKTsKICAgICAgICB2YXIgZXhpc3RpbmdJbmRleCA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSBjbGFzc2VzLmxlbmd0aDsgaS0tOykgewogICAgICAgICAgICBpZiAoY2xhc3Nlc1tpXSA9PT0gY2xhc3NOYW1lKQogICAgICAgICAgICAgICAgZXhpc3RpbmdJbmRleCA9IGk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKGV4aXN0aW5nSW5kZXggPj0gMCkKICAgICAgICAgICAgY2xhc3Nlcy5zcGxpY2UoZXhpc3RpbmdJbmRleCwgMSk7CiAgICAgICAgZWxzZQogICAgICAgICAgICBjbGFzc2VzLnB1c2goY2xhc3NOYW1lKTsKCiAgICAgICAgZWwuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKfQp2YXIgYmluZCA9IGZ1bmN0aW9uKGZ1bmMsIHNjb3BlLCBhcmdzKSB7CiAgICBpZihzY29wZSBpbnN0YW5jZW9mIEFycmF5KSB7IGFyZ3MgPSBzY29wZTsgc2NvcGUgPSB0aGlzOyB9CiAgICBpZighc2NvcGUpIHNjb3BlID0gdGhpczsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBmdW5jLmFwcGx5KHNjb3BlLCAoYXJncyB8fCBbXSkuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKTsKICAgIH0KfQp2YXIgQ29tcG9uZW50ID0gZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgYWJzdXJkLCBldmVudEJ1cywgY2xzKSB7Cgl2YXIgYXBpID0gbGliLmhlbHBlcnMuRXh0ZW5kKHsKCQlfX25hbWU6IGNvbXBvbmVudE5hbWUKCX0sIGNscyk7Cgl2YXIgZXh0ZW5kID0gbGliLmhlbHBlcnMuRXh0ZW5kOwp2YXIgbCA9IFtdOwphcGkubGlzdGVuZXJzID0gbDsKYXBpLm9uID0gZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaywgc2NvcGUpIHsKCWlmKCFsW2V2ZW50TmFtZV0pIHsKCQlsW2V2ZW50TmFtZV0gPSBbXTsKCX0KCWxbZXZlbnROYW1lXS5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIHNjb3BlOiBzY29wZX0pOwoJcmV0dXJuIHRoaXM7Cn07CmFwaS5vZmYgPSBmdW5jdGlvbihldmVudE5hbWUsIGhhbmRsZXIpIHsKCWlmKCFsW2V2ZW50TmFtZV0pIHJldHVybiB0aGlzOwoJaWYoIWhhbmRsZXIpIGxbZXZlbnROYW1lXSA9IFtdOyByZXR1cm4gdGhpczsKCXZhciBuZXdBcnIgPSBbXTsKCWZvcih2YXIgaT0wOyBpPGxbZXZlbnROYW1lXS5sZW5ndGg7IGkrKykgewoJCWlmKGxbZXZlbnROYW1lXVtpXS5jYWxsYmFjayAhPT0gaGFuZGxlcikgewoJCQluZXdBcnIucHVzaChsW2V2ZW50TmFtZV1baV0pOwoJCX0KCX0KCWxbZXZlbnROYW1lXSA9IG5ld0FycjsKCXJldHVybiB0aGlzOwp9OwphcGkuZGlzcGF0Y2ggPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEsIHNjb3BlKSB7CglpZihkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiAhKGRhdGEgaW5zdGFuY2VvZiBBcnJheSkpIHsKCQlkYXRhLnRhcmdldCA9IHRoaXM7Cgl9CglpZihsW2V2ZW50TmFtZV0pIHsKCQlmb3IodmFyIGk9MDsgaTxsW2V2ZW50TmFtZV0ubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGNhbGxiYWNrID0gbFtldmVudE5hbWVdW2ldLmNhbGxiYWNrOwoJCQljYWxsYmFjay5hcHBseShzY29wZSB8fCBsW2V2ZW50TmFtZV1baV0uc2NvcGUgfHwge30sIFtkYXRhXSk7CgkJfQoJfQoJaWYodGhpc1tldmVudE5hbWVdICYmIHR5cGVvZiB0aGlzW2V2ZW50TmFtZV0gPT09ICdmdW5jdGlvbicpIHsKCQl0aGlzW2V2ZW50TmFtZV0oZGF0YSk7Cgl9CglpZihldmVudEJ1cykgZXZlbnRCdXMuZGlzcGF0Y2goZXZlbnROYW1lLCBkYXRhKTsKCXJldHVybiB0aGlzOwp9Owp2YXIgc3RvcmFnZSA9IHt9OwphcGkuc2V0ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJc3RvcmFnZVtrZXldID0gdmFsdWU7CglyZXR1cm4gdGhpczsKfTsKYXBpLmdldCA9IGZ1bmN0aW9uKGtleSkgewoJcmV0dXJuIHN0b3JhZ2Vba2V5XTsKfTsKdmFyIENTUyA9IGZhbHNlOwphcGkuX19oYW5kbGVDU1MgPSBmdW5jdGlvbihuZXh0KSB7CglpZih0aGlzLmNzcykgewoJCWFic3VyZC5mbHVzaCgpLm1vcnBoKCdkeW5hbWljLWNzcycpLmFkZCh0aGlzLmNzcykuY29tcGlsZShmdW5jdGlvbihlcnIsIGNzcykgewoJCQlpZighQ1NTKSB7CgkJCQl2YXIgc3R5bGUgPSBjcmVhdGVOb2RlKAoJCQkJCSdzdHlsZScsIFsKCQkJCQkJeyBuYW1lOiAiaWQiLCB2YWx1ZTogY29tcG9uZW50TmFtZSArICctY3NzJyB9LAoJCQkJCQl7IG5hbWU6ICJ0eXBlIiwgdmFsdWU6ICJ0ZXh0L2NzcyJ9CgkJCQkJXSwKCQkJCQkgY3NzCgkJCQkpOwoJCQkJKHFzKCJoZWFkIikgfHwgcXMoImJvZHkiKSkuYXBwZW5kQ2hpbGQoc3R5bGUpOwoJCQkJQ1NTID0geyByYXc6IGNzcywgZWxlbWVudDogc3R5bGUgfTsKCQkJfSBlbHNlIGlmKENTUy5yYXcgIT09IGNzcykgewoJCQkJQ1NTLnJhdyA9IGNzczsKCQkJCUNTUy5lbGVtZW50LmlubmVySFRNTCA9IGNzczsKCQkJfQoJCQluZXh0KCk7CgkJfSwgdGhpcyk7Cgl9IGVsc2UgewoJCW5leHQoKTsKCX0KCXJldHVybiB0aGlzOwp9OwphcGkuYXBwbHlDU1MgPSBmdW5jdGlvbihkYXRhLCBwcmV2ZW50Q29tcG9zaXRpb24sIHNraXBBdXRvUG9wdWxhdGlvbikgewoJaWYodGhpcy5odG1sICYmIHR5cGVvZiB0aGlzLmh0bWwgPT09ICdzdHJpbmcnICYmICFwcmV2ZW50Q29tcG9zaXRpb24pIHsKCQl2YXIgcmVzID0ge307CgkJcmVzW3RoaXMuaHRtbF0gPSBkYXRhOwoJCWRhdGEgPSByZXM7Cgl9Cgl0aGlzLmNzcyA9IGRhdGE7CglpZighc2tpcEF1dG9Qb3B1bGF0aW9uKSB7CgkJdGhpcy5wb3B1bGF0ZSgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07CnZhciBIVE1MU291cmNlID0gZmFsc2U7CgphcGkuX19tZXJnZURPTUVsZW1lbnRzID0gZnVuY3Rpb24oZTEsIGUyKSB7CQoJcmVtb3ZlRW1wdHlUZXh0Tm9kZXMoZTEpOwoJcmVtb3ZlRW1wdHlUZXh0Tm9kZXMoZTIpOwoJaWYodHlwZW9mIGUxID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgZTIgPT09ICd1bmRlZmluZWQnIHx8IGUxLmlzRXF1YWxOb2RlKGUyKSkgcmV0dXJuOwoJLy8gcmVwbGFjZSB0aGUgd2hvbGUgbm9kZQoJaWYoZTEubm9kZU5hbWUgIT09IGUyLm5vZGVOYW1lKSB7CgkJaWYoZTEucGFyZW50Tm9kZSkgewoJCQllMS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChlMiwgZTEpOwoJCX0KCQlyZXR1cm47Cgl9CgkvLyBub2RlVmFsdWUKCWlmKGUxLm5vZGVWYWx1ZSAhPT0gZTIubm9kZVZhbHVlKSB7CgkJZTEubm9kZVZhbHVlID0gZTIubm9kZVZhbHVlOwoJfQoJLy8gYXR0cmlidXRlcwoJaWYoZTEuYXR0cmlidXRlcykgewoJCXZhciBhdHRyMSA9IGUxLmF0dHJpYnV0ZXMsIGF0dHIyID0gZTIuYXR0cmlidXRlcywgYTEsIGEyLCBmb3VuZCA9IHt9OwoJCWZvcih2YXIgaT0wOyBpPGF0dHIxLmxlbmd0aCwgYTE9YXR0cjFbaV07IGkrKykgewoJCQlmb3IodmFyIGo9MDsgajxhdHRyMi5sZW5ndGgsIGEyPWF0dHIyW2pdOyBqKyspIHsKCQkJCWlmKGExLm5hbWUgPT09IGEyLm5hbWUpIHsKCQkJCQllMS5zZXRBdHRyaWJ1dGUoYTEubmFtZSwgYTIudmFsdWUpOwoJCQkJCWZvdW5kW2ExLm5hbWVdID0gdHJ1ZTsKCQkJCQlpZihhMS5uYW1lID09PSAndmFsdWUnKSB7CgkJCQkJCWUxLnZhbHVlID0gYTIudmFsdWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCWlmKCFmb3VuZFthMS5uYW1lXSkgewoJCQkJZTEucmVtb3ZlQXR0cmlidXRlKGExLm5hbWUpOwoJCQl9CgkJfQoJCWZvcih2YXIgaT0wOyBpPGF0dHIyLmxlbmd0aCwgYTI9YXR0cjJbaV07IGkrKykgewoJCQlpZighZm91bmRbYTIubmFtZV0pIHsKCQkJCWUxLnNldEF0dHJpYnV0ZShhMi5uYW1lLCBhMi52YWx1ZSk7CgkJCQlpZihhMi5uYW1lID09PSAndmFsdWUnKSB7CgkJCQkJZTEudmFsdWUgPSBhMi52YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCS8vIGNoaWxkcwoJdmFyIG5ld05vZGVzVG9NZXJnZSA9IFtdOwoJaWYoZTEuY2hpbGROb2Rlcy5sZW5ndGggPj0gZTIuY2hpbGROb2Rlcy5sZW5ndGgpIHsKCQlmb3IodmFyIGk9MDsgaTxlMS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCWlmKCFlMi5jaGlsZE5vZGVzW2ldKSB7IGUyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7IH0KCQkJbmV3Tm9kZXNUb01lcmdlLnB1c2goW2UxLmNoaWxkTm9kZXNbaV0sIGUyLmNoaWxkTm9kZXNbaV1dKTsKCQl9Cgl9IGVsc2UgewoJCWZvcih2YXIgaT0wOyBpPGUyLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJZTEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsJCQkJCQkKCQkJbmV3Tm9kZXNUb01lcmdlLnB1c2goW2UxLmNoaWxkTm9kZXNbaV0sIGUyLmNoaWxkTm9kZXNbaV1dKTsKCQl9Cgl9Cglmb3IodmFyIGk9MDsgaTxuZXdOb2Rlc1RvTWVyZ2UubGVuZ3RoOyBpKyspIHsKCQlhcGkuX19tZXJnZURPTUVsZW1lbnRzKG5ld05vZGVzVG9NZXJnZVtpXVswXSwgbmV3Tm9kZXNUb01lcmdlW2ldWzFdKTsKCX0KfTsKYXBpLl9faGFuZGxlSFRNTCA9IGZ1bmN0aW9uKG5leHQpIHsKCXZhciBzZWxmID0gdGhpczsKCXZhciBjb21waWxlID0gZnVuY3Rpb24oKSB7CgkJYWJzdXJkLmZsdXNoKCkubW9ycGgoImh0bWwiKS5hZGQoSFRNTFNvdXJjZSkuY29tcGlsZShmdW5jdGlvbihlcnIsIGh0bWwpIHsKCQkJaWYoIXNlbGYuZWwpIHsKCQkJCXNlbGYuZWwgPSBzdHIyRE9NRWxlbWVudChodG1sKTsKCQkJfSBlbHNlIHsKCQkJCWFwaS5fX21lcmdlRE9NRWxlbWVudHMoc2VsZi5lbCwgc3RyMkRPTUVsZW1lbnQoaHRtbCkpOwoJCQl9CgkJCW5leHQoKTsKCQl9LCBzZWxmKTsKCX0KCWlmKHRoaXMuaHRtbCkgewoJCWlmKHR5cGVvZiB0aGlzLmh0bWwgPT09ICdzdHJpbmcnKSB7CgkJCWlmKCF0aGlzLmVsKSB7CgkJCQl2YXIgZWxlbWVudCA9IHFzKHRoaXMuaHRtbCk7CgkJCQlpZihlbGVtZW50KSB7CgkJCQkJdGhpcy5lbCA9IGVsZW1lbnQ7CgkJCQkJSFRNTFNvdXJjZSA9IHsnJzogdGhpcy5lbC5vdXRlckhUTUwucmVwbGFjZSgvJmx0Oy9nLCAnPCcpLnJlcGxhY2UoLyZndDsvZywgJz4nKSB9OwoJCQkJfQoJCQl9CgkJCWNvbXBpbGUoKTsKCQl9IGVsc2UgaWYodHlwZW9mIHRoaXMuaHRtbCA9PT0gJ29iamVjdCcpIHsKCQkJSFRNTFNvdXJjZSA9IGV4dGVuZCh7fSwgdGhpcy5odG1sKTsKCQkJY29tcGlsZSgpOwkJCgkJfSBlbHNlIHsKCQkJbmV4dCgpOwoJCX0KCX0gZWxzZSB7CgkJbmV4dCgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07CmFwaS5hcHBseUhUTUwgPSBmdW5jdGlvbihkYXRhLCBza2lwQXV0b1BvcHVsYXRpb24pIHsKCXRoaXMuaHRtbCA9IGRhdGE7CglpZighc2tpcEF1dG9Qb3B1bGF0aW9uKSB7CgkJdGhpcy5wb3B1bGF0ZSgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07CnZhcglhcHBlbmRlZCA9IGZhbHNlCmFwaS5fX2FwcGVuZCA9IGZ1bmN0aW9uKG5leHQpIHsKCWlmKCFhcHBlbmRlZCAmJiB0aGlzLmVsICYmIHRoaXMuZ2V0KCJwYXJlbnQiKSkgewoJCWFwcGVuZGVkID0gdHJ1ZTsKCQl0aGlzLmdldCgicGFyZW50IikuYXBwZW5kQ2hpbGQodGhpcy5lbCk7Cgl9CgluZXh0KCk7CglyZXR1cm4gdGhpczsKfQp2YXIgY2FjaGUgPSB7IGV2ZW50czoge30gfTsKYXBpLl9faGFuZGxlRXZlbnRzID0gZnVuY3Rpb24obmV4dCkgewkJCglpZih0aGlzLmVsKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCXZhciByZWdpc3RlckV2ZW50ID0gZnVuY3Rpb24oZWwpIHsKCQkJdmFyIGF0dHJWYWx1ZSA9IGVsLmdldEF0dHJpYnV0ZSgnZGF0YS1hYnN1cmQtZXZlbnQnKTsKCQkJdmFyIHByb2Nlc3NBdHRyaWJ1dGVzID0gZnVuY3Rpb24oYXR0clZhbHVlKSB7CgkJCQlhdHRyVmFsdWUgPSBhdHRyVmFsdWUuc3BsaXQoIjoiKTsKCQkJCWlmKGF0dHJWYWx1ZS5sZW5ndGggPj0gMikgewoJCQkJCXZhciBldmVudFR5cGUgPSBhdHRyVmFsdWVbMF07CgkJCQkJdmFyIG1ldGhvZE5hbWUgPSBhdHRyVmFsdWVbMV07CgkJCQkJYXR0clZhbHVlLnNwbGljZSgwLCAyKTsKCQkJCQl2YXIgYXJncyA9IGF0dHJWYWx1ZTsKCQkJCQlpZighY2FjaGUuZXZlbnRzW2V2ZW50VHlwZV0gfHwgY2FjaGUuZXZlbnRzW2V2ZW50VHlwZV0uaW5kZXhPZihlbCkgPCAwKSB7CgkJCQkJCWlmKCFjYWNoZS5ldmVudHNbZXZlbnRUeXBlXSkgY2FjaGUuZXZlbnRzW2V2ZW50VHlwZV0gPSBbXTsKCQkJCQkJY2FjaGUuZXZlbnRzW2V2ZW50VHlwZV0ucHVzaChlbCk7CgkJCQkJCWFkZEV2ZW50TGlzdGVuZXIoZWwsIGV2ZW50VHlwZSwgZnVuY3Rpb24oZSkgewoJCQkJCQkJaWYodHlwZW9mIHNlbGZbbWV0aG9kTmFtZV0gPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCQl2YXIgZiA9IHNlbGZbbWV0aG9kTmFtZV07CgkJCQkJCQkJZi5hcHBseShzZWxmLCBbZV0uY29uY2F0KGFyZ3MpKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCWF0dHJWYWx1ZSA9IGF0dHJWYWx1ZS5zcGxpdCgvLCA/L2cpOwoJCQlmb3IodmFyIGk9MDsgaTxhdHRyVmFsdWUubGVuZ3RoOyBpKyspIHByb2Nlc3NBdHRyaWJ1dGVzKGF0dHJWYWx1ZVtpXSk7CgkJfQoJCWlmKHRoaXMuZWwuaGFzQXR0cmlidXRlICYmIHRoaXMuZWwuaGFzQXR0cmlidXRlKCdkYXRhLWFic3VyZC1ldmVudCcpKSB7CgkJCXJlZ2lzdGVyRXZlbnQodGhpcy5lbCk7CgkJfQoJCXZhciBlbHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwgPyB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWFic3VyZC1ldmVudF0nKSA6IFtdOwoJCWZvcih2YXIgaT0wOyBpPGVscy5sZW5ndGg7IGkrKykgewoJCQlyZWdpc3RlckV2ZW50KGVsc1tpXSk7CgkJfQoJfQoJbmV4dCgpOwoJcmV0dXJuIHRoaXM7Cn0KYXBpLl9fZ2V0QW5pbUFuZFRyYW5zRW5kRXZlbnROYW1lID0gZnVuY3Rpb24oZWwpIHsKCWlmKCFlbCkgcmV0dXJuOwogICAgdmFyIGE7CiAgICB2YXIgYW5pbWF0aW9ucyA9IHsKICAgICAgJ2FuaW1hdGlvbic6IFsnYW5pbWF0aW9uZW5kJywgJ3RyYW5zaXRpb25lbmQnXSwKICAgICAgJ09BbmltYXRpb24nOiBbJ29BbmltYXRpb25FbmQnLCAnb1RyYW5zaXRpb25FbmQnXSwKICAgICAgJ01vekFuaW1hdGlvbic6IFsnYW5pbWF0aW9uZW5kJywgJ3RyYW5zaXRpb25lbmQnXSwKICAgICAgJ1dlYmtpdEFuaW1hdGlvbic6IFsnd2Via2l0QW5pbWF0aW9uRW5kJywgJ3dlYmtpdFRyYW5zaXRpb25FbmQnXQogICAgfQogICAgZm9yKGEgaW4gYW5pbWF0aW9ucyl7CiAgICAgICAgaWYoIGVsLnN0eWxlW2FdICE9PSB1bmRlZmluZWQgKXsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvbnNbYV07CiAgICAgICAgfQogICAgfQp9CmFwaS5vbkFuaW1hdGlvbkVuZCA9IGZ1bmN0aW9uKGVsLCBmdW5jKSB7CglpZihhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQlmdW5jID0gZWw7CgkJZWwgPSB0aGlzLmVsOwoJfQoJdmFyIHNlbGYgPSB0aGlzOwoJdmFyIGV2ZW50TmFtZSA9IGFwaS5fX2dldEFuaW1BbmRUcmFuc0VuZEV2ZW50TmFtZShlbCk7CglpZighZXZlbnROYW1lKSB7IGZ1bmMuYXBwbHkodGhpcywgW3tlcnJvcjogJ0FuaW1hdGlvbnMgbm90IHN1cHBvcnRlZC4nfV0pOyByZXR1cm47IH07Cgl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoZWwsIGV2ZW50TmFtZVswXSwgZnVuY3Rpb24oZSkgewoJCWZ1bmMuYXBwbHkoc2VsZiwgW2VdKTsKCX0pOwp9CmFwaS5vblRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbihlbCwgZnVuYykgewoJaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJZnVuYyA9IGVsOwoJCWVsID0gdGhpcy5lbDsKCX0KCXZhciBzZWxmID0gdGhpczsKCXZhciBldmVudE5hbWUgPSBhcGkuX19nZXRBbmltQW5kVHJhbnNFbmRFdmVudE5hbWUoZWwpOwoJaWYoIWV2ZW50TmFtZSkgeyBmdW5jLmFwcGx5KHRoaXMsIFt7ZXJyb3I6ICdBbmltYXRpb25zIG5vdCBzdXBwb3J0ZWQuJ31dKTsgcmV0dXJuOyB9OwoJdGhpcy5hZGRFdmVudExpc3RlbmVyKGVsLCBldmVudE5hbWVbMV0sIGZ1bmN0aW9uKGUpIHsKCQlmdW5jLmFwcGx5KHNlbGYsIFtlXSk7Cgl9KTsKfQp2YXIJYXN5bmMgPSB7IGZ1bmNzOiB7fSwgaW5kZXg6IDAgfTsKYXBpLl9faGFuZGxlQXN5bmNGdW5jdGlvbnMgPSBmdW5jdGlvbihuZXh0KSB7CglpZih0aGlzLmVsKSB7CgkJdmFyIGZ1bmNzID0gW107CgkJaWYodGhpcy5lbC5oYXNBdHRyaWJ1dGUgJiYgdGhpcy5lbC5oYXNBdHRyaWJ1dGUoImRhdGEtYWJzdXJkLWFzeW5jIikpIHsKCQkJZnVuY3MucHVzaCh0aGlzLmVsKTsKCQl9IGVsc2UgewoJCQl2YXIgZWxzID0gdGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsID8gdGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1hYnN1cmQtYXN5bmNdJykgOiBbXTsKCQkJZm9yKHZhciBpPTA7IGk8ZWxzLmxlbmd0aDsgaSsrKSB7CgkJCQlmdW5jcy5wdXNoKGVsc1tpXSk7CgkJCX0KCQl9CQkKCQlpZihmdW5jcy5sZW5ndGggPT09IDApIHsKCQkJbmV4dCgpOwoJCX0gZWxzZSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJKGZ1bmN0aW9uIGNhbGxGdW5jcygpIHsKCQkJCWlmKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewkJCQkJCQoJCQkJCW5leHQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdmFyIGVsID0gZnVuY3Muc2hpZnQoKSwKCQkJCQkJdmFsdWUgPSBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtYWJzdXJkLWFzeW5jIiksCgkJCQkJCXJlcGxhY2VOb2RlcyA9IGZ1bmN0aW9uKGNoaWxkRWxlbWVudCkgewoJCQkJCQkJaWYodHlwZW9mIGNoaWxkRWxlbWVudCA9PT0gJ3N0cmluZycpIHsKCQkJCQkJCQllbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChzdHIyRE9NRWxlbWVudChjaGlsZEVsZW1lbnQpLCBlbCk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGNoaWxkRWxlbWVudCwgZWwpOwoJCQkJCQkJfQoJCQkJCQkJY2FsbEZ1bmNzKCk7CgkJCQkJCX07CgkJCQkJaWYodHlwZW9mIHNlbGZbYXN5bmMuZnVuY3NbdmFsdWVdLm5hbWVdID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCXNlbGZbYXN5bmMuZnVuY3NbdmFsdWVdLm5hbWVdLmFwcGx5KHNlbGYsIFtyZXBsYWNlTm9kZXNdLmNvbmNhdChhc3luYy5mdW5jc1t2YWx1ZV0uYXJncykpOwoJCQkJCX0gZWxzZSBpZih0eXBlb2YgYXN5bmMuZnVuY3NbdmFsdWVdLmZ1bmMgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJYXN5bmMuZnVuY3NbdmFsdWVdLmZ1bmMuYXBwbHkoc2VsZiwgW3JlcGxhY2VOb2Rlc10uY29uY2F0KGFzeW5jLmZ1bmNzW3ZhbHVlXS5hcmdzKSk7CgkJCQkJfQoJCQkJfQoJCQl9KSgpOwoJCX0JCQkKCX0gZWxzZSB7CgkJbmV4dCgpOwoJfQkKCXJldHVybiB0aGlzOwkKfQphcGkuYXN5bmMgPSBmdW5jdGlvbigpIHsKCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSwKCQlmdW5jID0gYXJncy5zaGlmdCgpLAoJCWluZGV4ID0gJ18nICsgKGFzeW5jLmluZGV4KyspOwoJYXN5bmMuZnVuY3NbaW5kZXhdID0ge2FyZ3M6IGFyZ3MsIG5hbWU6IGZ1bmN9OwoJcmV0dXJuICc8c2NyaXB0IGRhdGEtYWJzdXJkLWFzeW5jPSInICsgaW5kZXggKyAnIj48L3NjcmlwdD4nOwp9OwphcGkuY2hpbGQgPSBmdW5jdGlvbigpIHsKCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSwKCQljaGlsZHJlbiA9IHRoaXMuZ2V0KCJjaGlsZHJlbiIpLAoJCWNvbXBvbmVudCA9IGNoaWxkcmVuICYmIGNoaWxkcmVuW2FyZ3Muc2hpZnQoKV0sCgkJaW5kZXggPSAnXycgKyAoYXN5bmMuaW5kZXgrKyk7Cglhc3luYy5mdW5jc1tpbmRleF0gPSB7YXJnczogYXJncywgZnVuYzogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQljb21wb25lbnQucG9wdWxhdGUoe2NhbGxiYWNrOiBmdW5jdGlvbihkYXRhKSB7CgkJCWNhbGxiYWNrKGRhdGEuaHRtbC5lbGVtZW50KTsKCQl9fSk7Cgl9fTsKCXJldHVybiAnPHNjcmlwdCBkYXRhLWFic3VyZC1hc3luYz0iJyArIGluZGV4ICsgJyI+PC9zY3JpcHQ+JzsKfTsKYXBpLndpcmUgPSBmdW5jdGlvbihldmVudCkgewoJYWJzdXJkLmNvbXBvbmVudHMuZXZlbnRzLm9uKGV2ZW50LCB0aGlzW2V2ZW50XSB8fCBmdW5jdGlvbigpIHt9LCB0aGlzKTsKCXJldHVybiB0aGlzOwp9Owp2YXIgaXNQb3B1bGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTsKYXBpLnBvcHVsYXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewoJaWYoaXNQb3B1bGF0ZUluUHJvZ3Jlc3MpIHJldHVybjsKCWlzUG9wdWxhdGVJblByb2dyZXNzID0gdHJ1ZTsKCXF1ZXVlKFsKCQlhcGkuX19oYW5kbGVDU1MsCgkJYXBpLl9faGFuZGxlSFRNTCwKCQlhcGkuX19hcHBlbmQsIAoJCWFwaS5fX2hhbmRsZUV2ZW50cywKCQlhcGkuX19oYW5kbGVBc3luY0Z1bmN0aW9ucywKCQlmdW5jdGlvbigpIHsKCQkJaXNQb3B1bGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJYXN5bmMgPSB7IGZ1bmNzOiB7fSwgaW5kZXg6IDAgfQoJCQl2YXIgZGF0YSA9IHsKCQkJCWNzczogQ1NTLCAKCQkJCWh0bWw6IHsgCgkJCQkJZWxlbWVudDogdGhpcy5lbCAKCQkJCX0KCQkJfTsKCQkJdGhpcy5kaXNwYXRjaCgicG9wdWxhdGVkIiwgZGF0YSk7CgkJCWlmKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMuY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsgb3B0aW9ucy5jYWxsYmFjayhkYXRhKTsgfQoJCX0KCV0sIHRoaXMpOwoJcmV0dXJuIHRoaXM7Cn07CmFwaS5zdHIyRE9NRWxlbWVudCA9IHN0cjJET01FbGVtZW50OwphcGkuYWRkRXZlbnRMaXN0ZW5lciA9IGFkZEV2ZW50TGlzdGVuZXI7CmFwaS5xdWV1ZSA9IHF1ZXVlOwphcGkucXMgPSBxczsKYXBpLnFzYSA9IHFzYTsKYXBpLmdldFN0eWxlID0gZ2V0U3R5bGU7CmFwaS5hZGRDbGFzcyA9IGFkZENsYXNzOwphcGkucmVtb3ZlQ2xhc3MgPSByZW1vdmVDbGFzczsKYXBpLnJlcGxhY2VDbGFzcyA9IHJlcGxhY2VDbGFzczsKYXBpLmJpbmQgPSBiaW5kOwphcGkudG9nZ2xlQ2xhc3MgPSB0b2dnbGVDbGFzczsKYXBpLmNvbXBpbGVIVE1MID0gZnVuY3Rpb24oSFRNTCwgY2FsbGJhY2ssIGRhdGEpIHsKCWFic3VyZC5mbHVzaCgpLm1vcnBoKCJodG1sIikuYWRkKEhUTUwpLmNvbXBpbGUoY2FsbGJhY2ssIGRhdGEpOwp9OwphcGkuY29tcGlsZUNTUyA9IGZ1bmN0aW9uKENTUywgY2FsbGJhY2ssIG9wdGlvbnMpIHsKCWFic3VyZC5mbHVzaCgpLmFkZChDU1MpLmNvbXBpbGUoY2FsbGJhY2ssIG9wdGlvbnMpOwp9OwphcGkuZGVsYXkgPSBmdW5jdGlvbih0aW1lLCBmbiwgYXJncykgewoJdmFyIHNlbGYgPSB0aGlzOwoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlmbi5hcHBseShzZWxmLCBhcmdzKTsKCX0sIHRpbWUpOwp9CglyZXR1cm4gYXBpOwp9Owp2YXIgaW5qZWN0aW5nID0gZnVuY3Rpb24oYWJzdXJkKSB7CmFic3VyZC5kaS5yZWdpc3RlcignaXMnLCB7CglhcHBlbmRlZDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCQlpZih0eXBlb2Ygc2VsZWN0b3IgPT0gJ3VuZGVmaW5lZCcpIHNlbGVjdG9yID0gdGhpcy5ob3N0Lmh0bWw7CgkJcmV0dXJuIHFzKHNlbGVjdG9yKSA/IHRydWUgOiBmYWxzZTsKCX0sCgloaWRkZW46IGZ1bmN0aW9uKGVsKSB7CgkJZWwgPSBlbCB8fCB0aGlzLmhvc3QuZWw7CgkJcmV0dXJuIGVsLm9mZnNldFBhcmVudCA9PT0gbnVsbDsKCX0KfSk7CmFic3VyZC5kaS5yZWdpc3Rlcigncm91dGVyJywgewoJcm91dGVzOiBbXSwKCW1vZGU6IG51bGwsCglyb290OiAnLycsCglnZXRGcmFnbWVudDogZnVuY3Rpb24oKSB7CgkJdmFyIGZyYWdtZW50ID0gJyc7CgkJaWYodGhpcy5tb2RlID09PSAnaGlzdG9yeScpIHsKCQkJaWYoIWxvY2F0aW9uKSByZXR1cm4gJyc7CgkJCWZyYWdtZW50ID0gdGhpcy5jbGVhclNsYXNoZXMoZGVjb2RlVVJJKGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoKSk7CgkJCWZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZSgvXD8oLiopJC8sICcnKTsKCQkJZnJhZ21lbnQgPSB0aGlzLnJvb3QgIT0gJy8nID8gZnJhZ21lbnQucmVwbGFjZSh0aGlzLnJvb3QsICcnKSA6IGZyYWdtZW50OwoJCX0gZWxzZSB7CgkJCWlmKCF3aW5kb3cpIHJldHVybiAnJzsKCQkJdmFyIG1hdGNoID0gd2luZG93LmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwoJCQlmcmFnbWVudCA9IG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKCQl9CgkJcmV0dXJuIHRoaXMuY2xlYXJTbGFzaGVzKGZyYWdtZW50KTsKCX0sCiAgICBjbGVhclNsYXNoZXM6IGZ1bmN0aW9uKHBhdGgpIHsKICAgIAlyZXR1cm4gcGF0aC50b1N0cmluZygpLnJlcGxhY2UoL1wvJC8sICcnKS5yZXBsYWNlKC9eXC8vLCAnJyk7CiAgICB9LAoJYWRkOiBmdW5jdGlvbihyZSwgaGFuZGxlcikgewoJCWlmKHR5cGVvZiByZSA9PSAnZnVuY3Rpb24nKSB7CgkJCWhhbmRsZXIgPSByZTsKCQkJcmUgPSAnJzsKCQl9CgkJdGhpcy5yb3V0ZXMucHVzaCh7IHJlOiByZSwgaGFuZGxlcjogaGFuZGxlcn0pOwoJCXJldHVybiB0aGlzOwoJfSwKCXJlbW92ZTogZnVuY3Rpb24ocGFyYW0pIHsKCQlmb3IodmFyIGk9MCwgcjsgaTx0aGlzLnJvdXRlcy5sZW5ndGgsIHIgPSB0aGlzLnJvdXRlc1tpXTsgaSsrKSB7CgkJCWlmKHIuaGFuZGxlciA9PT0gcGFyYW0gfHwgci5yZSA9PT0gcGFyYW0pIHsKCQkJCXRoaXMucm91dGVzLnNwbGljZShpLCAxKTsgCgkJCQlyZXR1cm4gdGhpczsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCglmbHVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yb3V0ZXMgPSBbXTsKCQl0aGlzLm1vZGUgPSBudWxsOwoJCXRoaXMucm9vdCA9ICcvJzsKCQlyZXR1cm4gdGhpczsKCX0sCgljb25maWc6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQl0aGlzLm1vZGUgPSBvcHRpb25zICYmIG9wdGlvbnMubW9kZSAmJiBvcHRpb25zLm1vZGUgPT0gJ2hpc3RvcnknICYmICEhKGhpc3RvcnkucHVzaFN0YXRlKSA/ICdoaXN0b3J5JyA6ICdoYXNoJzsKCQl0aGlzLnJvb3QgPSBvcHRpb25zICYmIG9wdGlvbnMucm9vdCA/ICcvJyArIHRoaXMuY2xlYXJTbGFzaGVzKG9wdGlvbnMucm9vdCkgKyAnLycgOiAnLyc7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJbGlzdGVuOiBmdW5jdGlvbihsb29wSW50ZXJ2YWwpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdmFyIGN1cnJlbnQgPSBzZWxmLmdldEZyYWdtZW50KCk7CgkJdmFyIGZuID0gZnVuY3Rpb24oKSB7CgkJCWlmKGN1cnJlbnQgIT09IHNlbGYuZ2V0RnJhZ21lbnQoKSkgewoJCQkJY3VycmVudCA9IHNlbGYuZ2V0RnJhZ21lbnQoKTsKCQkJCXNlbGYuY2hlY2soY3VycmVudCk7CgkJCX0KCQl9CgkJY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsKTsKCQl0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZm4sIGxvb3BJbnRlcnZhbCB8fCA1MCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJY2hlY2s6IGZ1bmN0aW9uKGYpIHsKCQl2YXIgZnJhZ21lbnQgPSBmIHx8IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCQlmb3IodmFyIGk9MDsgaTx0aGlzLnJvdXRlcy5sZW5ndGg7IGkrKykgewoJCQl2YXIgbWF0Y2ggPSBmcmFnbWVudC5tYXRjaCh0aGlzLnJvdXRlc1tpXS5yZSk7CgkJCWlmKG1hdGNoKSB7CgkJCQltYXRjaC5zaGlmdCgpOwoJCQkJdGhpcy5yb3V0ZXNbaV0uaGFuZGxlci5hcHBseSh0aGlzLmhvc3QgfHwge30sIG1hdGNoKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9CQkJCgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCW5hdmlnYXRlOiBmdW5jdGlvbihwYXRoKSB7CgkJcGF0aCA9IHBhdGggPyBwYXRoIDogJyc7CgkJaWYodGhpcy5tb2RlID09PSAnaGlzdG9yeScpIHsKCQkJaGlzdG9yeS5wdXNoU3RhdGUobnVsbCwgbnVsbCwgdGhpcy5yb290ICsgdGhpcy5jbGVhclNsYXNoZXMocGF0aCkpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCQkJd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5yZXBsYWNlKC8jKC4qKSQvLCAnJykgKyAnIycgKyBwYXRoOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KfSk7CmFic3VyZC5kaS5yZWdpc3RlcignYWpheCcsIHsKCXJlcXVlc3Q6IGZ1bmN0aW9uKG9wcykgewoKCQlpZih0eXBlb2Ygb3BzID09ICdzdHJpbmcnKSBvcHMgPSB7IHVybDogb3BzIH07CgkJb3BzLnVybCA9IG9wcy51cmwgfHwgJyc7CgkJb3BzLm1ldGhvZCA9IG9wcy5tZXRob2QgfHwgJ2dldCcKCQlvcHMuZGF0YSA9IG9wcy5kYXRhIHx8IHt9OwoKCQl2YXIgZ2V0UGFyYW1zID0gZnVuY3Rpb24oZGF0YSwgdXJsKSB7CgkJCXZhciBhcnIgPSBbXSwgc3RyOwoJCQlmb3IodmFyIG5hbWUgaW4gZGF0YSkgewoJCQkJYXJyLnB1c2gobmFtZSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChkYXRhW25hbWVdKSk7CgkJCX0KCQkJc3RyID0gYXJyLmpvaW4oJyYnKTsKCQkJaWYoc3RyICE9ICcnKSB7CgkJCQlyZXR1cm4gdXJsID8gKHVybC5pbmRleE9mKCc/JykgPCAwID8gJz8nICsgc3RyIDogJyYnICsgc3RyKSA6IHN0cjsKCQkJfQoJCQlyZXR1cm4gJyc7CgkJfQoKCQl2YXIgYXBpID0gewoJCQlob3N0OiB0aGlzLmhvc3QgfHwge30sCgkJCXByb2Nlc3M6IGZ1bmN0aW9uKG9wcykgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJdGhpcy54aHIgPSBudWxsOwoJCQkJaWYod2luZG93LkFjdGl2ZVhPYmplY3QpIHsgdGhpcy54aHIgPSBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsgfQoJCQkJZWxzZSBpZih3aW5kb3cuWE1MSHR0cFJlcXVlc3QpIHsgdGhpcy54aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgfQoJCQkJaWYodGhpcy54aHIpIHsKCQkJCQl0aGlzLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJCQkJaWYoc2VsZi54aHIucmVhZHlTdGF0ZSA9PSA0ICYmIHNlbGYueGhyLnN0YXR1cyA9PSAyMDApIHsKCQkJCQkJCXZhciByZXN1bHQgPSBzZWxmLnhoci5yZXNwb25zZVRleHQ7CgkJCQkJCQlpZihvcHMuanNvbiA9PT0gdHJ1ZSAmJiB0eXBlb2YgSlNPTiAhPSAndW5kZWZpbmVkJykgewoJCQkJCQkJCXJlc3VsdCA9IEpTT04ucGFyc2UocmVzdWx0KTsKCQkJCQkJCX0KCQkJCQkJCXNlbGYuZG9uZUNhbGxiYWNrICYmIHNlbGYuZG9uZUNhbGxiYWNrLmFwcGx5KHNlbGYuaG9zdCwgW3Jlc3VsdCwgc2VsZi54aHJdKTsKCQkJCQkJfSBlbHNlIGlmKHNlbGYueGhyLnJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQkJc2VsZi5mYWlsQ2FsbGJhY2sgJiYgc2VsZi5mYWlsQ2FsbGJhY2suYXBwbHkoc2VsZi5ob3N0LCBbc2VsZi54aHJdKTsKCQkJCQkJfQoJCQkJCQlzZWxmLmFsd2F5c0NhbGxiYWNrICYmIHNlbGYuYWx3YXlzQ2FsbGJhY2suYXBwbHkoc2VsZi5ob3N0LCBbc2VsZi54aHJdKTsKCQkJCQl9CgkJCQkJCgkJCQkJaWYob3BzLm1ldGhvZCA9PSAnZ2V0JykgewoJCQkJCQl0aGlzLnhoci5vcGVuKCJHRVQiLCBvcHMudXJsICsgZ2V0UGFyYW1zKG9wcy5kYXRhLCBvcHMudXJsKSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy54aHIub3BlbihvcHMubWV0aG9kLCBvcHMudXJsLCB0cnVlKTsKCQkJCQkJdGhpcy5zZXRIZWFkZXJzKHsKCQkJCQkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJCQkJCSdDb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJwoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJaWYob3BzLmhlYWRlcnMgJiYgdHlwZW9mIG9wcy5oZWFkZXJzID09ICdvYmplY3QnKSB7CgkJCQkJCXRoaXMuc2V0SGVhZGVycyhvcHMuaGVhZGVycyk7CgkJCQkJfQkJCgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsgCgkJCQkJCW9wcy5tZXRob2QgPT0gJ2dldCcgPyBzZWxmLnhoci5zZW5kKCkgOiBzZWxmLnhoci5zZW5kKGdldFBhcmFtcyhvcHMuZGF0YSkpOyAKCQkJCQl9LCAyMCk7CQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCWRvbmU6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCQl0aGlzLmRvbmVDYWxsYmFjayA9IGNhbGxiYWNrOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCWZhaWw6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCQl0aGlzLmZhaWxDYWxsYmFjayA9IGNhbGxiYWNrOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCWFsd2F5czogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXRoaXMuYWx3YXlzQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQlzZXRIZWFkZXJzOiBmdW5jdGlvbihoZWFkZXJzKSB7CgkJCQlmb3IodmFyIG5hbWUgaW4gaGVhZGVycykgewoJCQkJCXRoaXMueGhyICYmIHRoaXMueGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgaGVhZGVyc1tuYW1lXSk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBhcGkucHJvY2VzcyhvcHMpOwoKCX0KfSk7CnZhciBkb20gPSBmdW5jdGlvbihlbCwgcGFyZW50KSB7Cgl2YXIgaG9zdCA9IGRvbS5wcm90b3R5cGUuaG9zdDsKCXZhciBhcGkgPSB7IGVsOiBudWxsIH07CgkvLyBkZWZpbmluZyB0aGUgc2NvcGUKCXN3aXRjaCh0eXBlb2YgZWwpIHsKCQljYXNlICd1bmRlZmluZWQnOgoJCQlhcGkuZWwgPSBob3N0LmVsOwoJCWJyZWFrOwoJCWNhc2UgJ3N0cmluZyc6CgkJCXBhcmVudCA9IHBhcmVudCAmJiB0eXBlb2YgcGFyZW50ID09PSAnc3RyaW5nJyA/IHFzLmFwcGx5KGhvc3QsIFtwYXJlbnRdKSA6IHBhcmVudDsKCQkJYXBpLmVsID0gcXMoZWwsIHBhcmVudCB8fCBob3N0LmVsIHx8IGRvY3VtZW50KTsKCQlicmVhazsKCQljYXNlICdvYmplY3QnOiAKCQkJaWYodHlwZW9mIGVsLm5vZGVOYW1lICE9ICd1bmRlZmluZWQnKSB7CgkgICAgICAgICAgICBhcGkuZWwgPSBlbDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgCXZhciBsb29wID0gZnVuY3Rpb24odmFsdWUsIG9iaikgewogICAgICAgICAgICAJCW9iaiA9IG9iaiB8fCB0aGlzOwogICAgICAgICAgICAJCWZvcih2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAJCQkJaWYodHlwZW9mIG9ialtwcm9wXS5lbCAhPSAndW5kZWZpbmVkJykgewogICAgICAgIAkJCQkJb2JqW3Byb3BdID0gb2JqW3Byb3BdLnZhbCh2YWx1ZSk7CiAgICAgICAgCQkJCX0gZWxzZSBpZih0eXBlb2Ygb2JqW3Byb3BdID09ICdvYmplY3QnKSB7CiAgICAgICAgCQkJCQlvYmpbcHJvcF0gPSBsb29wKHZhbHVlLCBvYmpbcHJvcF0pOwogICAgICAgIAkJCQl9CiAgICAgICAgICAgIAkJfQogICAgICAgICAgICAJCWRlbGV0ZSBvYmoudmFsOwogICAgICAgICAgICAJCXJldHVybiBvYmo7CgkgICAgICAgIAl9CgkgICAgICAgICAgICB2YXIgcmVzID0geyB2YWw6IGxvb3AgfTsKCSAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGVsKSB7CgkgICAgICAgICAgICAgICAgcmVzW2tleV0gPSBkb20uYXBwbHkodGhpcywgW2VsW2tleV1dKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiByZXM7CgkgICAgICAgIH0KCQlicmVhazsKCX0KCS8vIGdldHRpbmcgb3Igc2V0dGluZyBhIHZhbHVlCglhcGkudmFsID0gZnVuY3Rpb24odmFsdWUpIHsKCQlpZighdGhpcy5lbCkgcmV0dXJuIG51bGw7CgkJdmFyIHNldCA9ICEhdmFsdWU7CgkJdmFyIHVzZVZhbHVlUHJvcGVydHkgPSBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZihzZXQpIHsgdGhpcy5lbC52YWx1ZSA9IHZhbHVlOyByZXR1cm4gYXBpOyB9CgkJCWVsc2UgeyByZXR1cm4gdGhpcy5lbC52YWx1ZTsgfQoJCX0KICAgICAgICBzd2l0Y2godGhpcy5lbC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgCWNhc2UgJ2lucHV0JzoKICAgICAgICAJCXZhciB0eXBlID0gdGhpcy5lbC5nZXRBdHRyaWJ1dGUoJ3R5cGUnKTsKICAgICAgICAJCWlmKHR5cGUgPT0gJ3JhZGlvJyB8fCB0eXBlID09ICdjaGVja2JveCcpIHsKCSAgICAgICAgICAgICAgICB2YXIgZWxzID0gcXNhKCdbbmFtZT0iJyArIHRoaXMuZWwuZ2V0QXR0cmlidXRlKCduYW1lJykgKyAnIl0nLCBwYXJlbnQpOwoJICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGk9MDsgaTxlbHMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgICAgICAgICAgaWYoc2V0ICYmIGVsc1tpXS5jaGVja2VkICYmIGVsc1tpXS52YWx1ZSAhPT0gdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGVsc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ2NoZWNrZWQnKTsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKHNldCAmJiBlbHNbaV0udmFsdWUgPT09IHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgICAgIAllbHNbaV0uc2V0QXR0cmlidXRlKCdjaGVja2VkJywgJ2NoZWNrZWQnKTsKCSAgICAgICAgICAgICAgICAgICAgCWVsc1tpXS5jaGVja2VkID0gJ2NoZWNrZWQnOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZWxzW2ldLmNoZWNrZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgCXZhbHVlcy5wdXNoKGVsc1tpXS52YWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYoIXNldCkgeyByZXR1cm4gdHlwZSA9PSAncmFkaW8nID8gdmFsdWVzWzBdIDogdmFsdWVzOyB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgCXJldHVybiB1c2VWYWx1ZVByb3BlcnR5LmFwcGx5KHRoaXMsIFt2YWx1ZV0pOwoJICAgICAgICAgICAgfQogICAgICAgIAlicmVhazsKICAgICAgICAJY2FzZSAndGV4dGFyZWEnOiByZXR1cm4gdXNlVmFsdWVQcm9wZXJ0eS5hcHBseSh0aGlzLCBbdmFsdWVdKTsgYnJlYWs7CiAgICAgICAgCWNhc2UgJ3NlbGVjdCc6CiAgICAgICAgCQlpZihzZXQpIHsKICAgICAgICAgICAgCQl2YXIgb3B0aW9ucyA9IHFzYSgnb3B0aW9uJywgdGhpcy5lbCk7CiAgICAgICAgICAgIAkJZm9yKHZhciBpPTA7IGk8b3B0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAJCQlpZihvcHRpb25zW2ldLmdldEF0dHJpYnV0ZSgndmFsdWUnKSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgCQkJCXRoaXMuZWwuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgIAkJCX0gZWxzZSB7CiAgICAgICAgICAgIAkJCQlvcHRpb25zW2ldLnJlbW92ZUF0dHJpYnV0ZSgnc2VsZWN0ZWQnKTsKICAgICAgICAgICAgCQkJfQogICAgICAgICAgICAJCX0KICAgICAgICAgICAgCX0gZWxzZSB7CiAgICAgICAgICAgICAgICAJcmV0dXJuIHRoaXMuZWwudmFsdWU7CiAgICAgICAgICAgIAl9CiAgICAgICAgCWJyZWFrOwogICAgICAgIAlkZWZhdWx0OiAKICAgICAgICAJCWlmKHNldCkgewogICAgICAgIAkJCXRoaXMuZWwuaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgCQl9IGVsc2UgewoJICAgICAgICAJCWlmKHR5cGVvZiB0aGlzLmVsLnRleHRDb250ZW50ICE9ICd1bmRlZmluZWQnKSB7CgkJICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVsLnRleHRDb250ZW50OwoJCSAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlb2YgdGhpcy5lbC5pbm5lclRleHQgIT0gJ3VuZGVmaW5lZCcpIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzLmVsLmlubmVyVGV4dDsKCQkgICAgICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbC5pbm5lckhUTUw7CgkJICAgICAgICAgICAgfQoJICAgICAgICAJfQogICAgICAgIAlicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldCA/IGFwaSA6IG51bGw7Cgl9CgkvLyBjaGFpbmluZyBkb20gbW9kdWxlCglhcGkuZG9tID0gZnVuY3Rpb24oZWwsIHBhcmVudCkgewoJCXJldHVybiBkb20oZWwsIHBhcmVudCB8fCBhcGkuZWwpOwoJfQoJcmV0dXJuIGFwaTsKfQphYnN1cmQuZGkucmVnaXN0ZXIoJ2RvbScsIGRvbSk7CnZhciBtcSA9IGZ1bmN0aW9uKHF1ZXJ5LCBjYWxsYmFjaywgdXNlUG9seWZpbGwpIHsKCXZhciBob3N0ID0gbXEucHJvdG90eXBlLmhvc3Q7Cgl2YXIgaXNNYXRjaE1lZGlhU3VwcG9ydGVkID0gISEod2luZG93ICYmIHdpbmRvdy5tYXRjaE1lZGlhKSAmJiAhdXNlUG9seWZpbGw7CglpZihpc01hdGNoTWVkaWFTdXBwb3J0ZWQpIHsKCQl2YXIgcmVzID0gd2luZG93Lm1hdGNoTWVkaWEocXVlcnkpOwoJCWNhbGxiYWNrLmFwcGx5KGhvc3QsIFtyZXMubWF0Y2hlcywgcmVzLm1lZGlhXSk7CgkJcmVzLmFkZExpc3RlbmVyKGZ1bmN0aW9uKGNoYW5nZWQpIHsKCQkJY2FsbGJhY2suYXBwbHkoaG9zdCwgW2NoYW5nZWQubWF0Y2hlcywgY2hhbmdlZC5tZWRpYV0pOwoJCX0pOwoJfSBlbHNlIHsKCQl2YXIgaWQgPSAiLm1hdGNoLW1lZGlhLSIgKyBhYnN1cmQuY29tcG9uZW50cy5udW1PZkNvbXBvbmVudHM7CgkJdmFyIGNzcyA9IHt9LCBodG1sID0ge307CgkJY3NzW2lkXSA9IHsgZGlzcGxheTogJ2Jsb2NrJyB9OwoJCWNzc1tpZF1bJ0BtZWRpYSAnICsgcXVlcnldID0geyBkaXNwbGF5OiAnbm9uZScgfTsKCQlodG1sWydzcGFuJyArIGlkXSA9ICcnOwoJCWFic3VyZC5jb21wb25lbnQoaWQgKyAnLWNvbXBvbmVudCcsIHsKCQkJY3NzOiBjc3MsCgkJCWh0bWw6IGh0bWwsCgkJCWludGVydmFsaVRpbWU6IDMwLAoJCQlzdGF0dXM6ICcnLAoJCQlsb29wOiBmdW5jdGlvbihkb20pIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCWlmKHRoaXMuZWwpIHsKCQkJCQl2YXIgZCA9IHRoaXMuZ2V0U3R5bGUoJ2Rpc3BsYXknKTsKCQkJCQlpZih0aGlzLnN0YXR1cyAhPSBkKSB7CgkJCQkJCXRoaXMuc3RhdHVzID0gZDsKCQkJCQkJY2FsbGJhY2suYXBwbHkoaG9zdCwgW2QgPT09ICdub25lJ10pCgkJCQkJfQoJCQkJfQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsgc2VsZi5sb29wKCk7IH0sIHRoaXMuaW50ZXJ2YWxpVGltZSk7CgkJCX0sCgkJCWNvbnN0cnVjdG9yOiBbJ2RvbScsIGZ1bmN0aW9uKGRvbSkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJdGhpcy5zZXQoJ3BhcmVudCcsIGRvbSgnYm9keScpLmVsKS5wb3B1bGF0ZSgpOwoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsgc2VsZi5sb29wKCk7IH0sIHRoaXMuaW50ZXJ2YWxpVGltZSk7CgkJCX1dCgkJfSkoKTsKCX0KfTsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdtcScsIG1xKTsKfQp2YXIgY2xpZW50ID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gZnVuY3Rpb24oYXJnKSB7CgoJCS8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIENvcGllZCBkaXJlY3RseSBmcm9tIC9saWIvQVBJLmpzICovCgoJCXZhciBleHRlbmQgPSBmdW5jdGlvbihkZXN0aW5hdGlvbiwgc291cmNlKSB7CgkJCWZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKCQkJCWlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpKSB7CgkJCQkJZGVzdGluYXRpb25ba2V5XSA9IHNvdXJjZVtrZXldOwoJCQkJfQoJCQl9CgkJCXJldHVybiBkZXN0aW5hdGlvbjsKCQl9OwoKCQl2YXIgX2FwaSA9IHsgCgkJCQlkZWZhdWx0UHJvY2Vzc29yOiBsaWIucHJvY2Vzc29ycy5jc3MuQ1NTKCkgCgkJCX0sCgkJCV9ydWxlcyA9IHt9LAoJCQlfc3RvcmFnZSA9IHt9LAoJCQlfcGx1Z2lucyA9IHt9LAoJCQlfaG9va3MgPSB7fTsKCgkJX2FwaS5nZXRSdWxlcyA9IGZ1bmN0aW9uKHN0eWxlc2hlZXQpIHsKCQkJaWYodHlwZW9mIHN0eWxlc2hlZXQgPT09ICd1bmRlZmluZWQnKSB7CgkJCQlyZXR1cm4gX3J1bGVzOwoJCQl9IGVsc2UgewoJCQkJaWYodHlwZW9mIF9ydWxlc1tzdHlsZXNoZWV0XSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlfcnVsZXNbc3R5bGVzaGVldF0gPSBbXTsKCQkJCX0KCQkJCXJldHVybiBfcnVsZXNbc3R5bGVzaGVldF07CgkJCX0KCQl9CgkJX2FwaS5nZXRQbHVnaW5zID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBfcGx1Z2luczsJCQoJCX0KCQlfYXBpLmdldFN0b3JhZ2UgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIF9zdG9yYWdlOwoJCX0KCQlfYXBpLmZsdXNoID0gZnVuY3Rpb24oKSB7CgkJCV9ydWxlcyA9IHt9OwoJCQlfc3RvcmFnZSA9IFtdOwoJCQlfaG9va3MgPSB7fTsKCQkJX2FwaS5kZWZhdWx0UHJvY2Vzc29yID0gbGliLnByb2Nlc3NvcnMuY3NzLkNTUygpOwoJCQlyZXR1cm4gX2FwaTsKCQl9CgkJX2FwaVsnaW1wb3J0J10gPSBmdW5jdGlvbigpIHsgCgkJCWlmKF9hcGkuY2FsbEhvb2tzKCJpbXBvcnQiLCBhcmd1bWVudHMpKSByZXR1cm4gX2FwaTsKCQkJcmV0dXJuIF9hcGk7IAoJCX0KCQlfYXBpLmhhbmRsZWNzcyA9IGZ1bmN0aW9uKHBhcnNlZCwgcGF0aCkgewoJCQl2YXIgcGx1Z2lucyA9IF9hcGkuZ2V0UGx1Z2lucygpOwoJCQlpZihwYXJzZWQgJiYgcGFyc2VkLnR5cGUgPT09ICdzdHlsZXNoZWV0JyAmJiBwYXJzZWQuc3R5bGVzaGVldCAmJiBwYXJzZWQuc3R5bGVzaGVldC5ydWxlcykgewoJCQkJdmFyIHJ1bGVzID0gcGFyc2VkLnN0eWxlc2hlZXQucnVsZXM7CgkJCQlmb3IodmFyIGk9MDsgcnVsZT1ydWxlc1tpXTsgaSsrKSB7CgkJCQkJc3dpdGNoKHJ1bGUudHlwZSkgewoJCQkJCQljYXNlICJydWxlIjogX2FwaS5oYW5kbGVjc3NydWxlKHJ1bGUpOyBicmVhazsKCQkJCQkJY2FzZSAiaW1wb3J0IjogX2FwaS5oYW5kbGVjc3NpbXBvcnQocnVsZSwgcGF0aCk7IGJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJaWYocGx1Z2luc1tydWxlLnR5cGVdKSB7CgkJCQkJCQkJcGx1Z2luc1tydWxlLnR5cGVdKF9hcGksIHJ1bGUpOwoJCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIF9hcGk7CgkJfQoJCV9hcGkuaGFuZGxlY3NzaW1wb3J0ID0gZnVuY3Rpb24ocnVsZSwgY3NzUGF0aCkgewoJCQlyZXR1cm4gX2FwaTsKCQl9CgkJX2FwaS5oYW5kbGVjc3NydWxlID0gZnVuY3Rpb24ocnVsZSwgc3R5bGVzaGVldCkgewkJCgkJCXZhciBhYnN1cmRPYmogPSB7fSwgYWJzdXJkUHJvcHMgPSB7fTsKCQkJaWYocnVsZS5kZWNsYXJhdGlvbnMgJiYgcnVsZS5kZWNsYXJhdGlvbnMubGVuZ3RoID4gMCkgewoJCQkJZm9yKHZhciBpPTA7IGRlY2w9cnVsZS5kZWNsYXJhdGlvbnNbaV07IGkrKykgewoJCQkJCWlmKGRlY2wudHlwZSA9PT0gImRlY2xhcmF0aW9uIikgewoJCQkJCQlhYnN1cmRQcm9wc1tkZWNsLnByb3BlcnR5XSA9IGRlY2wudmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJLy8gYWJzdXJkT2JqW3J1bGUuc2VsZWN0b3JzLmpvaW4oIiwgIildID0gYWJzdXJkUHJvcHM7CgkJCQlpZihydWxlLnNlbGVjdG9ycyAmJiBydWxlLnNlbGVjdG9ycy5sZW5ndGggPiAwKSB7CgkJCQkJZm9yKHZhciBpPTA7IHNlbGVjdG9yPXJ1bGUuc2VsZWN0b3JzW2ldOyBpKyspIHsKCQkJCQkJYWJzdXJkT2JqW3NlbGVjdG9yXSA9IGV4dGVuZCh7fSwgYWJzdXJkUHJvcHMpOwoJCQkJCX0KCQkJCX0KCQkJCV9hcGkuYWRkKGFic3VyZE9iaiwgc3R5bGVzaGVldCk7CgkJCX0KCQkJcmV0dXJuIF9hcGk7CgkJfQoKCQkvLyBob29rcwoJCV9hcGkuYWRkSG9vayA9IGZ1bmN0aW9uKG1ldGhvZCwgY2FsbGJhY2spIHsKCQkJaWYoIV9ob29rc1ttZXRob2RdKSBfaG9va3NbbWV0aG9kXSA9IFtdOwoJCQl2YXIgaXNBbHJlYWR5QWRkZWQgPSBmYWxzZTsKCQkJZm9yKHZhciBpPTA7IGM9X2hvb2tzW21ldGhvZF1baV07IGkrKykgewoJCQkJaWYoYyA9PT0gY2FsbGJhY2spIHsKCQkJCQlpc0FscmVhZHlBZGRlZCA9IHRydWU7CgkJCQl9CgkJCX0KCQkJaXNBbHJlYWR5QWRkZWQgPT09IGZhbHNlID8gX2hvb2tzW21ldGhvZF0ucHVzaChjYWxsYmFjaykgOiBudWxsOwoJCX0KCQlfYXBpLmNhbGxIb29rcyA9IGZ1bmN0aW9uKG1ldGhvZCwgYXJncykgewoJCQlpZihfaG9va3NbbWV0aG9kXSkgewoJCQkJZm9yKHZhciBpPTA7IGM9X2hvb2tzW21ldGhvZF1baV07IGkrKykgewoJCQkJCWlmKGMuYXBwbHkoX2FwaSwgYXJncykgPT09IHRydWUpIHJldHVybiB0cnVlOwoJCQkJfQoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIGludGVybmFsIHZhcmlhYmxlcwoJCV9hcGkubnVtT2ZBZGRlZFJ1bGVzID0gMDsKCgkJLy8gYWJzdXJkLmNvbXBvbmVudHMgQVBJCgkJX2FwaS5jb21wb25lbnRzID0gKGZ1bmN0aW9uKGFwaSkgewoJCQl2YXIgZXh0ZW5kID0gbGliLmhlbHBlcnMuRXh0ZW5kLAoJCQkJY2xvbmUgPSBsaWIuaGVscGVycy5DbG9uZSwKCQkJCWNvbXBzID0ge30sIAoJCQkJaW5zdGFuY2VzID0gW10sCgkJCQlldmVudHMgPSBleHRlbmQoe30sIENvbXBvbmVudCgpKSwKCQkJCWV4cG9ydHMgPSB7fTsKCgkJCShmdW5jdGlvbihmbikgewoJCQkJaWYoIXdpbmRvdykgcmV0dXJuOwoJCQkJaWYgKHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB7CgkJCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmbik7CgkJCQl9IGVsc2UgaWYod2luZG93LmF0dGFjaEV2ZW50KSB7CgkJCQkJd2luZG93LmF0dGFjaEV2ZW50KCdvbmxvYWQnLCBmbik7CgkJCQl9CgkJCX0pKGZ1bmN0aW9uKCkgewoJCQkJZXhwb3J0cy5icm9hZGNhc3QoInJlYWR5Iik7CgkJCX0pCgoJCQlyZXR1cm4gZXhwb3J0cyA9IHsKCQkJCW51bU9mQ29tcG9uZW50czogMCwKCQkJCWV2ZW50czogZXZlbnRzLAoJCQkJcmVnaXN0ZXI6IGZ1bmN0aW9uKG5hbWUsIGNscykgewoJCQkJCXRoaXMubnVtT2ZDb21wb25lbnRzICs9IDE7CgkJCQkJcmV0dXJuIGNvbXBzW25hbWVdID0gZnVuY3Rpb24oKSB7CgkJCQkJCXZhciBjID0gZXh0ZW5kKHt9LCBDb21wb25lbnQobmFtZSwgYXBpLCBldmVudHMsIGNsb25lKGNscykpKTsKCQkJCQkJYXBpLmRpLnJlc29sdmVPYmplY3QoYyk7CgkJCQkJCWluc3RhbmNlcy5wdXNoKGMpOwoJCQkJCQlpZih0eXBlb2YgYy5jb25zdHJ1Y3RvciA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYy5jb25zdHJ1Y3Rvci5hcHBseShjLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gYzsKCQkJCQl9OwoJCQkJfSwKCQkJCWdldDogZnVuY3Rpb24obmFtZSkgewoJCQkJCWlmKGNvbXBzW25hbWVdKSB7IHJldHVybiBjb21wc1tuYW1lXTsgfQoJCQkJCWVsc2UgeyB0aHJvdyBuZXcgRXJyb3IoIlRoZXJlIGlzIG5vIGNvbXBvbmVudCB3aXRoIG5hbWUgJyIgKyBuYW1lICsgIicuIik7IH0KCQkJCX0sCgkJCQlyZW1vdmU6IGZ1bmN0aW9uKG5hbWUpIHsKCQkJCQlpZihjb21wc1tuYW1lXSkgeyBkZWxldGUgY29tcHNbbmFtZV07IHJldHVybiB0cnVlOyB9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSwKCQkJCWxpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBsID0gW107CgkJCQkJZm9yKHZhciBuYW1lIGluIGNvbXBzKSBsLnB1c2gobmFtZSk7CgkJCQkJcmV0dXJuIGw7CgkJCQl9LAoJCQkJZmx1c2g6IGZ1bmN0aW9uKCkgewoJCQkJCWNvbXBzID0ge307CgkJCQkJaW5zdGFuY2VzID0gW107CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJYnJvYWRjYXN0OiBmdW5jdGlvbihldmVudCwgZGF0YSkgewoJCQkJCWZvcih2YXIgaT0wOyBpPGluc3RhbmNlcy5sZW5ndGgsIGluc3RhbmNlPWluc3RhbmNlc1tpXTsgaSsrKSB7CgkJCQkJCWlmKHR5cGVvZiBpbnN0YW5jZVtldmVudF0gPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWluc3RhbmNlW2V2ZW50XShkYXRhKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfQoJCX0pKF9hcGkpOwoKCQkvLyBhYnN1cmQuY29tcG9uZW50IHNob3J0Y3V0CgkJX2FwaS5jb21wb25lbnQgPSAoZnVuY3Rpb24oYXBpKSB7CgkJCXJldHVybiBmdW5jdGlvbihuYW1lLCBjbHMpIHsKCQkJCWlmKHR5cGVvZiBjbHMgPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXR1cm4gYXBpLmNvbXBvbmVudHMuZ2V0KG5hbWUpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gYXBpLmNvbXBvbmVudHMucmVnaXN0ZXIobmFtZSwgY2xzKTsKCQkJCX0KCQkJfQoJCX0pKF9hcGkpOwoKCQkvLyBkZXBlbmRlbmN5IGluamVjdG9yCgkJX2FwaS5kaSA9IGxpYi5ESShfYXBpKTsKCQlpbmplY3RpbmcoX2FwaSk7CgoJCS8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIENvcGllZCBkaXJlY3RseSBmcm9tIC9saWIvQVBJLmpzICovCgoJCS8vIGNsaWVudCBzaWRlIHNwZWNpZmljIG1ldGhvZHMgCgkJX2FwaS5jb21waWxlID0gZnVuY3Rpb24oY2FsbGJhY2ssIG9wdGlvbnMpIHsKCQkJaWYoX2FwaS5jYWxsSG9va3MoImNvbXBpbGUiLCBhcmd1bWVudHMpKSByZXR1cm4gX2FwaTsKCQkJdmFyIGRlZmF1bHRPcHRpb25zID0gewoJCQkJY29tYmluZVNlbGVjdG9yczogdHJ1ZSwKCQkJCW1pbmlmeTogZmFsc2UsCgkJCQlwcm9jZXNzb3I6IF9hcGkuZGVmYXVsdFByb2Nlc3NvciwKCQkJCWtlZXBDYW1lbENhc2U6IGZhbHNlLAoJCQkJYXBpOiBfYXBpCgkJCX07CgkJCW9wdGlvbnMgPSBleHRlbmQoZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMgfHwge30pOwoJCQl2YXIgcmVzID0gb3B0aW9ucy5wcm9jZXNzb3IoCgkJCQlfYXBpLmdldFJ1bGVzKCksCgkJCQljYWxsYmFjayB8fCBmdW5jdGlvbigpIHt9LAoJCQkJb3B0aW9ucwoJCQkpOwoJCQlfYXBpLmZsdXNoKCk7CgkJCXJldHVybiByZXM7CgkJfQoKCQkvLyByZWdpc3RlcmluZyBhcGkgbWV0aG9kcwoJCWZvcih2YXIgbWV0aG9kIGluIGxpYi5hcGkpIHsKCQkJaWYobWV0aG9kICE9PSAiY29tcGlsZSIpIHsKCQkJCV9hcGlbbWV0aG9kXSA9IGxpYi5hcGlbbWV0aG9kXShfYXBpKTsKCQkJCV9hcGlbbWV0aG9kXSA9IChmdW5jdGlvbihtZXRob2QpIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJCXZhciBmID0gbGliLmFwaVttZXRob2RdKF9hcGkpOwoJCQkJCQlpZihfYXBpLmNhbGxIb29rcyhtZXRob2QsIGFyZ3VtZW50cykpIHJldHVybiBfYXBpOwoJCQkJCQlyZXR1cm4gZi5hcHBseShfYXBpLCBhcmd1bWVudHMpOwoJCQkJCX0KCQkJCX0pKG1ldGhvZCk7CQkKCQkJfQoJCX0KCgkJLy8gcmVnaXN0ZXJpbmcgcGx1Z2lucwoJCWZvcih2YXIgcGx1Z2luTmFtZSBpbiBsaWIucHJvY2Vzc29ycy5jc3MucGx1Z2lucykgewoJCQlfYXBpLnBsdWdpbihwbHVnaW5OYW1lLCBsaWIucHJvY2Vzc29ycy5jc3MucGx1Z2luc1twbHVnaW5OYW1lXSgpKTsKCQl9CgoJCS8vIGFjY2VwdCBmdW5jdGlvbgoJCWlmKHR5cGVvZiBhcmcgPT09ICJmdW5jdGlvbiIpIHsKCQkJYXJnKF9hcGkpOwoJCX0KCgkJLy8gY2hlY2sgZm9yIE9yZ2FuaWMKCQlpZih0eXBlb2YgT3JnYW5pYyAhPSAndW5kZWZpbmVkJykgewoJCQlPcmdhbmljLmluaXQoX2FwaSk7CgkJfQoKCQkvLyBhdHRhY2hpbmcgdXRpbHMgZnVuY3Rpb25zCgkJX2FwaS51dGlscyA9IHsKCQkJc3RyMkRPTUVsZW1lbnQ6IHN0cjJET01FbGVtZW50CgkJfQoKCQlyZXR1cm4gX2FwaTsKCgl9Cn07",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:05:15 GMT",
                    "Content-Length": "33822",
                    "Date": "Thu, 06 Nov 2014 06:05:15 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}