{
    "url": "http://localhost:9999/kirkas/Ascensor.js/dist/jquery.ascensor.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location</b> and written to <b>window.location.replace()</b> via the following statement:<ul><li>window.location.replace(('' + window.location).split('#')[0] + '#' + this.options.ascensorFloorName[floorIndex]);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kirkas/Ascensor.js/dist/jquery.ascensor.js",
                "path": "/kirkas/Ascensor.js/dist/jquery.ascensor.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9raXJrYXMvQXNjZW5zb3IuanMvZGlzdC9qcXVlcnkuYXNjZW5zb3IuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzMyODMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTA6NDQ6MDggR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEwOjQ0OjA3IEdNVA0KDQovKgpBc2NlbnNvci5qcyAKdmVyc2lvbjogMS44LjE0ICgyMDE0LTA4LTI4KQpkZXNjcmlwdGlvbjogQXNjZW5zb3IgaXMgYSBqcXVlcnkgcGx1Z2luIHdoaWNoIGFpbXMgdG8gdHJhaW4gYW5kIGFkYXB0IGNvbnRlbnQgYWNjb3JkaW5nIHRvIGFuIGVsZXZhdG9yIHN5c3RlbQpyZXBvc2l0b3J5OiBodHRwczovL2dpdGh1Yi5jb20va2lya2FzL0FzY2Vuc29yLmpzCmxpY2Vuc2U6IEJTRAphdXRob3I6IEzDqW8gR2FsbGV5IDxjb250YWN0QGtpcmthcy5jaD4KKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogIHZhciBwbHVnaW5OYW1lID0gJ2FzY2Vuc29yJzsKCgogIC8qIERlZmF1bHQgc2V0dGluZ3MgKi8KICB2YXIgZGVmYXVsdHMgPSB7CiAgICBhc2NlbnNvckZsb29yTmFtZTogZmFsc2UsCiAgICBjaGlsZFR5cGU6ICdkaXYnLAogICAgd2luZG93c09uOiAwLAogICAgZGlyZWN0aW9uOiAneScsCiAgICBsb29wOiBmYWxzZSwKICAgIHdpZHRoOiAnMTAwJScsCiAgICBoZWlnaHQ6ICcxMDAlJywKICAgIHRpbWU6IDI1MCwKICAgIGVhc2luZzogJ2xpbmVhcicsCiAgICBrZXlOYXZpZ2F0aW9uOiB0cnVlLAogICAgcXVldWVkOiBmYWxzZSwKICAgIGp1bXA6IGZhbHNlLAogICAgcmVhZHk6IGZhbHNlLAogICAgc3dpcGVOYXZpZ2F0aW9uOiAnbW9iaWxlLW9ubHknLAogICAgc3dpcGVWZWxvY2l0eTogMC43LAogICAgd2hlZWxOYXZpZ2F0aW9uOiBmYWxzZSwKICAgIHdoZWVsTmF2aWdhdGlvbkRlbGF5OiA0MCwKICB9OwoKICAvKiBQbHVnaW4gaW5zdGFuY2UgKi8KICBmdW5jdGlvbiBQbHVnaW4oZWxlbWVudCwgb3B0aW9ucykgewogICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgb3B0aW9ucyk7CiAgICB0aGlzLl9kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgdGhpcy5fbmFtZSA9IHBsdWdpbk5hbWU7CiAgICB0aGlzLmluaXQoKTsKICB9CgogIC8vIEZyb20gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vbG9yZW56b3BvbGlkb3JpLzM3OTQyMjYKICBmdW5jdGlvbiBoYXMzZCgpIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKSwKICAgICAgc3VwcG9ydDNELAogICAgICB0cmFuc2Zvcm1zID0gewogICAgICAgICd3ZWJraXRUcmFuc2Zvcm0nOiAnLXdlYmtpdC10cmFuc2Zvcm0nLAogICAgICAgICdPVHJhbnNmb3JtJzogJy1vLXRyYW5zZm9ybScsCiAgICAgICAgJ21zVHJhbnNmb3JtJzogJy1tcy10cmFuc2Zvcm0nLAogICAgICAgICdNb3pUcmFuc2Zvcm0nOiAnLW1vei10cmFuc2Zvcm0nLAogICAgICAgICd0cmFuc2Zvcm0nOiAndHJhbnNmb3JtJwogICAgICB9OwogICAgZG9jdW1lbnQuYm9keS5pbnNlcnRCZWZvcmUoZWwsIG51bGwpOwogICAgZm9yICh2YXIgdCBpbiB0cmFuc2Zvcm1zKSB7CiAgICAgIGlmIChlbC5zdHlsZVt0XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZWwuc3R5bGVbdF0gPSAndHJhbnNsYXRlM2QoMXB4LDFweCwxcHgpJzsKICAgICAgICBzdXBwb3J0M0QgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCkuZ2V0UHJvcGVydHlWYWx1ZSh0cmFuc2Zvcm1zW3RdKTsKICAgICAgfQogICAgfQogICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7CiAgICByZXR1cm4gKHN1cHBvcnQzRCAhPT0gdW5kZWZpbmVkICYmIHN1cHBvcnQzRC5sZW5ndGggPiAwICYmIHN1cHBvcnQzRCAhPT0gJ25vbmUnKTsKICB9CgoKICAvKiBBZGQgJ2luZGV4T2YnIGhlbHBlciBpbiBjYXNlIG1pc3NpbmcgKElFOCkgKi8KICBpZiAoIUFycmF5LnByb3RvdHlwZS5pbmRleE9mKSB7CiAgICBBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uKGVsdCAvKiwgZnJvbSovICkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGggPj4+IDA7CiAgICAgIHZhciBmcm9tID0gTnVtYmVyKGFyZ3VtZW50c1sxXSkgfHwgMDsKICAgICAgZnJvbSA9IChmcm9tIDwgMCkgPyBNYXRoLmNlaWwoZnJvbSkgOiBNYXRoLmZsb29yKGZyb20pOwogICAgICBpZiAoZnJvbSA8IDApIGZyb20gKz0gbGVuOwogICAgICBmb3IgKDsgZnJvbSA8IGxlbjsgZnJvbSsrKSB7CiAgICAgICAgaWYgKGZyb20gaW4gdGhpcyAmJiB0aGlzW2Zyb21dID09PSBlbHQpIHJldHVybiBmcm9tOwogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH07CiAgfQoKICAvKiBBcnJheSBoZWxwZXIgKi8KICBmdW5jdGlvbiBleGlzdEluQXJyYXkoYXJyYXksIGl0ZW0pIHsKICAgIHZhciBpbmRleCA9IGFycmF5LmluZGV4T2YoaXRlbSk7CiAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8qIFZhbHVlIGhlbHBlciAqLwogIGZ1bmN0aW9uIGlzRmFsc2UodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc1RydWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mKHZhbHVlKSA9PT0gJ251bWJlcic7CiAgfQoKICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdzdHJpbmcnOwogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdvYmplY3QnOwogIH0KCgogIC8qIFBsdWdpbiBzdGFydCAqLwogIFBsdWdpbi5wcm90b3R5cGUgPSB7CgogICAgLyogSW5pdGlhbGl6YXRpb24gb2YgcGx1Z2luICovCiAgICBpbml0OiBmdW5jdGlvbigpIHsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIENvbnN0YW50IGhlbHBlcgogICAgICB0aGlzLkFYSVNfWCA9IDE7CiAgICAgIHRoaXMuQVhJU19ZID0gMDsKCiAgICAgIHRoaXMuZGF0YUF0dHJpYnV0ZU1hcCA9IHsKICAgICAgICAibmV4dCI6ICJhc2NlbnNvci1uZXh0IiwKICAgICAgICAicHJldiI6ICJhc2NlbnNvci1wcmV2IiwKICAgICAgICAiZG93biI6ICJhc2NlbnNvci1kb3duIiwKICAgICAgICAidXAiOiAiYXNjZW5zb3ItdXAiLAogICAgICAgICJsZWZ0IjogImFzY2Vuc29yLWxlZnQiLAogICAgICAgICJyaWdodCI6ICJhc2NlbnNvci1yaWdodCIKICAgICAgfTsKCiAgICAgIC8vIFNldHVwIGdsb2JhbCB2YXJpYWJsZSAtIHNlbGVjdG9yIAogICAgICB0aGlzLm5vZGUgPSAkKHRoaXMuZWxlbWVudCk7CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuID0gdGhpcy5ub2RlLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5jaGlsZFR5cGUpOwogICAgICB0aGlzLmZsb29yQWN0aXZlID0gKGlzTnVtYmVyKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSkpID8gdGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpIDogdGhpcy5vcHRpb25zLndpbmRvd3NPbjsKCiAgICAgIHRoaXMuTkggPSB0aGlzLm5vZGUuaGVpZ2h0KCk7CiAgICAgIHRoaXMuTlcgPSB0aGlzLm5vZGUud2lkdGgoKTsKCiAgICAgIC8vIFNldHVwIGdsb2JhbCB2YXJpYWJsZSAtIGhlbHBlcgogICAgICB2YXIgYW5kcm9pZENvbXBhdGlibGUgPSB0cnVlOwogICAgICB2YXIgdmVyc2lvbiA9IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0FuZHJvaWRccysoW1xkXC5dKykvKTsKICAgICAgaWYgKHZlcnNpb24pIGFuZHJvaWRDb21wYXRpYmxlID0gcGFyc2VGbG9hdCh2ZXJzaW9uWzFdKSA+IDM7CgoKICAgICAgdGhpcy5kaXJlY3Rpb25Jc0FycmF5ID0gaXNPYmplY3QodGhpcy5vcHRpb25zLmRpcmVjdGlvbik7CiAgICAgIHRoaXMuc3VwcG9ydFRyYW5zZm9ybSA9IGhhczNkKCkgJiYgYW5kcm9pZENvbXBhdGlibGU7CgoKCiAgICAgIC8vIENoZWNrIGlmIGZsb29yIG5hbWUgYXJyYXkgJiBub2RlIGNoaWxkcmVuIGxlbmd0aCBtYXRjaAogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSAmJiB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUubGVuZ3RoIDwgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRDb25zb2xlTWVzc2FnZSgiZXJyb3IiLCAiZmxvb3JzIHRvdGFsICgiICsgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoICsgIikgJiBmbG9vciBuYW1lIGFycmF5IGxlbmd0aCAoIiArIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5sZW5ndGggKyAiKSBkb24ndCBtYXRjaCIpOwogICAgICB9CgogICAgICAvLyBDaGVjayBpZiBkaXJlY3Rpb24gYXJyYXkgJiBub2RlIGNoaWxkcmVuIGxlbmd0aCBtYXRjaAogICAgICBpZiAodGhpcy5kaXJlY3Rpb25Jc0FycmF5ICYmIHRoaXMub3B0aW9ucy5kaXJlY3Rpb24ubGVuZ3RoIDwgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRDb25zb2xlTWVzc2FnZSgiZXJyb3IiLCAiZmxvb3JzIHRvdGFsICgiICsgdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoICsgIikgJiBkaXJlY3Rpb24gYXJyYXkgbGVuZ2h0ICgiICsgdGhpcy5vcHRpb25zLmRpcmVjdGlvbi5sZW5ndGggKyAiKSBkb24ndCBtYXRjaCIpOwogICAgICB9CgogICAgICAvLyBTdGFydCB0aGUgbWFnaWMKICAgICAgdGhpcy5zZXR1cCgpOwoKICAgIH0sCgoKICAgIC8qIE1hZ2ljICovCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX3Bvc2l0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLl9iaW5kRXZlbnRzKCk7CiAgICAgIHRoaXMuc2Nyb2xsVG9GbG9vcih0aGlzLmZsb29yQWN0aXZlKTsKCiAgICAgIGlmIChpc09iamVjdCh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmZsb29yQWN0aXZlKTsKICAgICAgfQogICAgICBpZiAoaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMucmVhZHkpKSB0aGlzLm9wdGlvbnMucmVhZHkoKTsKICAgIH0sCgoKICAgIC8qIFNldHVwIFVzZXIgbGlzdGVuZXIgKi8KICAgIF9iaW5kRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgdGhpcy5ub2RlLm9uKCdzY3JvbGxUb0RpcmVjdGlvbicsIGZ1bmN0aW9uKGV2ZW50LCBkaXJlY3Rpb24pIHsKICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKGRpcmVjdGlvbik7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdzY3JvbGxUb1N0YWdlJywgZnVuY3Rpb24oZXZlbnQsIGZsb29yKSB7CiAgICAgICAgaWYgKHR5cGVvZiBmbG9vciA9PSAnc3RyaW5nJykgewogICAgICAgICAgdmFyIGZsb29ySWQgPSAkLmluQXJyYXkoZmxvb3IsIHNlbGYub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSk7CiAgICAgICAgICBpZiAoZmxvb3JJZCAhPT0gLTEpIHNlbGYuc2Nyb2xsVG9GbG9vcihmbG9vcklkKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBmbG9vciA9PSAnbnVtYmVyJykgewogICAgICAgICAgaWYgKGZsb29yID4gc2VsZi5ub2RlQ2hpbGRyZW4ubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICBzZWxmLnNjcm9sbFRvRmxvb3IoZmxvb3IpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ25leHQnLCBmdW5jdGlvbihldmVudCwgZmxvb3IpIHsKICAgICAgICB2YXIgZGF0YUF0dHJpYnV0ZURpcmVjdGlvbiA9IHNlbGYubm9kZUNoaWxkcmVuLmVxKHNlbGYuZmxvb3JBY3RpdmUpLmRhdGEoc2VsZi5kYXRhQXR0cmlidXRlTWFwLm5leHQpOwogICAgICAgIGlmIChkYXRhQXR0cmlidXRlRGlyZWN0aW9uKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pOwogICAgICAgIHNlbGYubmV4dCgpOwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbigncHJldicsIGZ1bmN0aW9uKGV2ZW50LCBmbG9vcikgewogICAgICAgIHZhciBkYXRhQXR0cmlidXRlRGlyZWN0aW9uID0gc2VsZi5ub2RlQ2hpbGRyZW4uZXEoc2VsZi5mbG9vckFjdGl2ZSkuZGF0YShzZWxmLmRhdGFBdHRyaWJ1dGVNYXAucHJldik7CiAgICAgICAgaWYgKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbik7CiAgICAgICAgc2VsZi5wcmV2KCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdyZWZyZXNoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5yZWZyZXNoKCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmRlc3Ryb3koKTsKICAgICAgfSk7CgogICAgICAvLyBzZXR1cCByZXNpemUgJiBrZXkgbGlzdGVuZXIKICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUuYXNjZW5zb3InLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yQWN0aXZlLCBmYWxzZSk7CiAgICAgIH0pOwoKICAgICAgLy8gSWYgZmxvb3JOYW1lLCBhZGQgaGFzaGNoYW5nZSBsaXN0ZW5lcgogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSkgewogICAgICAgICQod2luZG93KS5vbignaGFzaGNoYW5nZS5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLl9oYXNoY2hhbmdlSGFuZGxlcihldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIERldGVjdCBvcmllbnRhdGlvbiBjaGFuZ2UsIGZvciBkZXZpY2UKICAgICAgaWYgKHdpbmRvdy5EZXZpY2VPcmllbnRhdGlvbkV2ZW50KSB7CiAgICAgICAgJCh3aW5kb3cpLm9uKCdvcmllbnRhdGlvbmNoYW5nZS5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vckFjdGl2ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua2V5TmF2aWdhdGlvbikgewogICAgICAgICQoZG9jdW1lbnQpLm9uKCdrZXlkb3duLmFzY2Vuc29yJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNlbGYuX2tleXByZXNzSGFuZGxlcihldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9wdGlvbnMud2hlZWxOYXZpZ2F0aW9uKSB7CiAgICAgICAgdGhpcy5ub2RlLm9uKCdtb3VzZXdoZWVsLmFzY2Vuc29yJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFzZWxmLnNjcm9sbEluQ2hpbGRyZW4pIHNlbGYuX2hhbmRsZU1vdXNlV2hlZWxFdmVudChlKTsKICAgICAgICAgIH0sIDEwKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4ub24oJ3Njcm9sbC5hc2NlbnNvcicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuc2Nyb2xsSW5DaGlsZHJlbiA9IHRydWU7CiAgICAgICAgICBpZiAoc2VsZi5zY3JvbGxUaW1lT3V0KSBjbGVhclRpbWVvdXQoc2VsZi5zY3JvbGxUaW1lT3V0KTsKICAgICAgICAgIHNlbGYuc2Nyb2xsVGltZU91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsSW5DaGlsZHJlbiA9IGZhbHNlOwogICAgICAgICAgfSwgMzAwKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gSWYgc3dpcGUgZXZlbnQgb3B0aW9uIGlzIHRydWUgfHwgc3RyaW5nCiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc3dpcGVOYXZpZ2F0aW9uKSB7CgogICAgICAgIHZhciB0b3VjaEV2ZW50ID0gJ3RvdWNoc3RhcnQuYXNjZW5zb3IgdG91Y2hlbmQuYXNjZW5zb3IgdG91Y2hjYW5jZWwuYXNjZW5zb3InOwoKICAgICAgICAvLyBJZiBtb2JpbGUtb25seSwgb25seSB1c2UgdG91Y2hzdGFydC9lbmQgZXZlbnQJCQkJCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zd2lwZU5hdmlnYXRpb24gIT09ICdtb2JpbGUtb25seScpIHRvdWNoRXZlbnQgKz0gJyBtb3VzZWRvd24uYXNjZW5zb3IgbW91c2V1cC5hc2NlbnNvcic7CgogICAgICAgIC8vIExpc3RlbiB0byB0b3VjaCBldmVudAogICAgICAgIHRoaXMubm9kZS5vbih0b3VjaEV2ZW50LCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgc2VsZi5faGFuZGxlVG91Y2hFdmVudChldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgcmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuID0gdGhpcy5ub2RlLmNoaWxkcmVuKHRoaXMub3B0aW9ucy5jaGlsZFR5cGUpOwogICAgICB0aGlzLl9wb3NpdGlvbkVsZW1lbnQoKTsKICAgIH0sCgogICAgLyogUmVtb3ZlIG1ldGhvZCovCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgIC8vIFVuYmluZCBhbGwgYmluZGVkIGV2ZW50CiAgICAgIHRoaXMubm9kZUNoaWxkcmVuLm9mZignc2Nyb2xsLmFzY2Vuc29yJyk7CiAgICAgIHRoaXMubm9kZS5vZmYoJ21vdXNld2hlZWwuYXNjZW5zb3Igc2Nyb2xsVG9EaXJlY3Rpb24gc2Nyb2xsVG9TdGFnZSBuZXh0IHByZXYgcmVmcmVzaCByZW1vdmUgdG91Y2hzdGFydC5hc2NlbnNvciB0b3VjaGVuZC5hc2NlbnNvciBtb3VzZWRvd24uYXNjZW5zb3IgbW91c2V1cC5hc2NlbnNvciB0b3VjaGNhbmNlbC5hc2NlbnNvcicpOwogICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUuYXNjZW5zb3IgaGFzaGNoYW5nZS5hc2NlbnNvciBvcmllbnRhdGlvbmNoYW5nZS5hc2NlbnNvcicpOwogICAgICAkKGRvY3VtZW50KS5vZmYoJ2tleWRvd24uYXNjZW5zb3InKTsKCiAgICAgIC8vIFJlbW92ZSBjc3MKICAgICAgdGhpcy5ub2RlLmNzcyh7CiAgICAgICAgJ3Bvc2l0aW9uJzogJycsCiAgICAgICAgJ292ZXJmbG93JzogJycsCiAgICAgICAgJ3RvcCc6ICcnLAogICAgICAgICdsZWZ0JzogJycsCiAgICAgICAgJ3dpZHRoJzogJycsCiAgICAgICAgJ2hlaWdodCc6ICcnCiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4uY3NzKHsKICAgICAgICAncG9zaXRpb24nOiAnJywKICAgICAgICAnb3ZlcmZsb3cnOiAnJywKICAgICAgICAndG9wJzogJycsCiAgICAgICAgJ2xlZnQnOiAnJywKICAgICAgICAnd2lkdGgnOiAnJywKICAgICAgICAnaGVpZ2h0JzogJycsCiAgICAgICAgJ3RyYW5zZm9ybSc6ICcnCiAgICAgIH0pOwoKICAgICAgLy8gUmVtb3ZlIHBsdWdpbiBpbnN0YW5jZQogICAgICB0aGlzLm5vZGUucmVtb3ZlRGF0YSgpOwogICAgfSwKCiAgICBfaGFuZGxlTW91c2VXaGVlbEV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICBpZiAodGhpcy5ub2RlLmlzKCc6YW5pbWF0ZWQnKSkgcmV0dXJuOwoKICAgICAgdGhpcy5zY3JvbGxUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICBpZiAoIXRoaXMubGFzdFNjcm9sbFRpbWUgfHwgdGhpcy5zY3JvbGxUaW1lIC0gdGhpcy5sYXN0U2Nyb2xsVGltZSA+IHRoaXMub3B0aW9ucy53aGVlbE5hdmlnYXRpb25EZWxheSkgewogICAgICAgIHRoaXMubGFzdFNjcm9sbFRpbWUgPSB0aGlzLnNjcm9sbFRpbWU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gdGhpcy5zY3JvbGxUaW1lOwoKICAgICAgdmFyIG1vdXNlWCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQud2hlZWxEZWx0YVg7CiAgICAgIHZhciBtb3VzZVkgPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGFZOwoKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWCkgPiBNYXRoLmFicyhtb3VzZVkpICYmIG1vdXNlWCA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2xlZnQnKTsKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWCkgPiBNYXRoLmFicyhtb3VzZVkpICYmIG1vdXNlWCA8IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ3JpZ2h0Jyk7CiAgICAgIGlmIChNYXRoLmFicyhtb3VzZVkpID4gTWF0aC5hYnMobW91c2VYKSAmJiBtb3VzZVkgPiAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCd1cCcpOwogICAgICBpZiAoTWF0aC5hYnMobW91c2VZKSA+IE1hdGguYWJzKG1vdXNlWCkgJiYgbW91c2VZIDwgMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbignZG93bicpOwoKICAgIH0sCgoKICAgIC8qIFRvdWNoIGV2ZW50IGhhbmRsZXIgKi8KICAgIF9oYW5kbGVUb3VjaEV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkgewoKICAgICAgICAvLyBPbiB0b3VjaC9tb3VzZSBkb3duCiAgICAgICAgY2FzZSAndG91Y2hzdGFydCc6CiAgICAgICAgY2FzZSAnbW91c2Vkb3duJzoKCiAgICAgICAgICAvLyBzYXZlIHRpbWUgJiBvcmlnaW5hbCBwb3NpdGlvbiBmb3IgWC9ZCiAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRYID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoc3RhcnQnKSA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LnBhZ2VYOwogICAgICAgICAgdGhpcy50b3VjaFN0YXJ0WSA9IChldmVudC50eXBlID09ICd0b3VjaHN0YXJ0JykgPyBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF0ucGFnZVkgOiBldmVudC5wYWdlWTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIC8vIE9uIHRvdWNoL21vdXNlZG93bgogICAgICAgIGNhc2UgJ3RvdWNoZW5kJzoKICAgICAgICBjYXNlICd0b3VjaGNhbmNlbCc6CiAgICAgICAgY2FzZSAnbW91c2V1cCc6CgogICAgICAgICAgLy8gU2F2ZSB0aW1lICYgZmluYWwgcG9zaXRpb24gZm9yIFgvWQogICAgICAgICAgdGhpcy50b3VjaEVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgIHRoaXMudG91Y2hFbmRYID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoZW5kJyB8fCBldmVudC50eXBlID09ICd0b3VjaGNhbmNlbCcpID8gZXZlbnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LnBhZ2VYOwogICAgICAgICAgdGhpcy50b3VjaEVuZFkgPSAoZXZlbnQudHlwZSA9PSAndG91Y2hlbmQnIHx8IGV2ZW50LnR5cGUgPT0gJ3RvdWNoY2FuY2VsJykgPyBldmVudC5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZIDogZXZlbnQucGFnZVk7CgogICAgICAgICAgLy8gY2FsY3VsYXRlIGRpc3RhbmNlLCBkdXJhdGlvbiAmIHZlbG9jaXR5LgogICAgICAgICAgdmFyIGRpc3RhbmNlWCA9IHRoaXMudG91Y2hTdGFydFggLSB0aGlzLnRvdWNoRW5kWDsKICAgICAgICAgIHZhciBkaXN0YW5jZVkgPSB0aGlzLnRvdWNoU3RhcnRZIC0gdGhpcy50b3VjaEVuZFk7CiAgICAgICAgICB2YXIgZHVyYXRpb24gPSB0aGlzLnRvdWNoRW5kVGltZSAtIHRoaXMudG91Y2hTdGFydFRpbWU7CiAgICAgICAgICB2YXIgdmVsb2NpdHlYID0gTWF0aC5hYnMoZGlzdGFuY2VYKSAvIGR1cmF0aW9uOwogICAgICAgICAgdmFyIHZlbG9jaXR5WSA9IE1hdGguYWJzKGRpc3RhbmNlWSkgLyBkdXJhdGlvbjsKCiAgICAgICAgICAvLyBJZiB2ZWxvY2l0eSwgdXNlIGFic29sdXRlIGRpc3RhbmNlIHRvIGRldGVybWluZSBheGlzCiAgICAgICAgICAvLyBhbmQgY29tcGFyZSBkaXN0YW5jZSB0byAwIGRldGVybWluZSBkaXJlY3Rpb24KICAgICAgICAgIGlmICh2ZWxvY2l0eVggPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpID4gTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVggPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdsZWZ0Jyk7CiAgICAgICAgICBpZiAodmVsb2NpdHlYID4gdGhpcy5vcHRpb25zLnN3aXBlVmVsb2NpdHkgJiYgTWF0aC5hYnMoZGlzdGFuY2VYKSA+IE1hdGguYWJzKGRpc3RhbmNlWSkgJiYgZGlzdGFuY2VYID4gMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbigncmlnaHQnKTsKICAgICAgICAgIGlmICh2ZWxvY2l0eVkgPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpIDwgTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVkgPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCd1cCcpOwogICAgICAgICAgaWYgKHZlbG9jaXR5WSA+IHRoaXMub3B0aW9ucy5zd2lwZVZlbG9jaXR5ICYmIE1hdGguYWJzKGRpc3RhbmNlWCkgPCBNYXRoLmFicyhkaXN0YW5jZVkpICYmIGRpc3RhbmNlWSA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2Rvd24nKTsKCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSwKCgoKICAgIC8qIFBvc2l0aW9uIGZsb29yIG9uIGRvbSAqLwogICAgX3Bvc2l0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMuZGlyZWN0aW9uSXNBcnJheSkgdGhpcy5fZ2VuZXJhdGVGbG9vck1hcCgpOwoKICAgICAgLy8gU2V0dXAgZmxvb3Igc2l6ZSAmIHBvc2l0aW9uCiAgICAgIHRoaXMubm9kZS5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgJ292ZXJmbG93JzogJ2hpZGRlbicsCiAgICAgICAgJ3RvcCc6ICcwJywKICAgICAgICAnbGVmdCc6ICcwJywKICAgICAgICAnd2lkdGgnOiB0aGlzLm9wdGlvbnMud2lkdGgsCiAgICAgICAgJ2hlaWdodCc6IHRoaXMub3B0aW9ucy5oZWlnaHQKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgJ292ZXJmbG93JzogJ2F1dG8nLAogICAgICAgICd0b3AnOiAnMCcsCiAgICAgICAgJ2xlZnQnOiAnMCcsCiAgICAgICAgJ3dpZHRoJzogJzEwMCUnLAogICAgICAgICdoZWlnaHQnOiAnMTAwJScKICAgICAgfSk7CgogICAgICAvLyBwbGFjZSBlbGVtZW50IGNvcnJlY3RseQogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaWYgKHNlbGYuc3VwcG9ydFRyYW5zZm9ybSkgewogICAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgICAndHJhbnNmb3JtJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd5JykgcmV0dXJuICd0cmFuc2xhdGVZKCcgKyBpbmRleCAqIDEwMCArICclKSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd4JykgcmV0dXJuICd0cmFuc2xhdGVYKCcgKyBpbmRleCAqIDEwMCArICclKSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgcmV0dXJuICd0cmFuc2xhdGVZKCcgKyBzZWxmLm9wdGlvbnMuZGlyZWN0aW9uW2luZGV4XVtzZWxmLkFYSVNfWV0gKiAxMDAgKyAnJSkgdHJhbnNsYXRlWCgnICsgc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1hdICogMTAwICsgJyUpJzsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQodGhpcykuY3NzKHsKICAgICAgICAgICAgJ3RvcCc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneScpIHJldHVybiBpbmRleCAqIDEwMCArICclJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSByZXR1cm4gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1ldICogMTAwICsgJyUnOwogICAgICAgICAgICB9LAogICAgICAgICAgICAnbGVmdCc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneCcpIHJldHVybiBpbmRleCAqIDEwMCArICclJzsKICAgICAgICAgICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSByZXR1cm4gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1hdICogMTAwICsgJyUnOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgoKICAgIC8qIEhlbHBlciA6IFJldHVybiBmbG9vciBpbmRleCBmcm9tIGhhc2guICovCiAgICBfZ2V0Rmxvb3JGcm9tSGFzaDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLl9nZXRIYXNoKCkpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lICYmIGV4aXN0SW5BcnJheSh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUsIHRoaXMuX2dldEhhc2goKSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUuaW5kZXhPZih0aGlzLl9nZXRIYXNoKCkpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgOiBSZXR1cm4gZmxvb3IgaW5kZXggZnJvbSBoYXNoLiAqLwogICAgX2dldEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2gpIHsKICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KCcjJykucG9wKCk7CiAgICAgICAgcmV0dXJuIGhhc2g7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCgogICAgLyogSGFubGRlcjogSGFuZGxlIHdpbmRvdyBoYXNoY2FuZ2UgZXZlbnQgKi8KICAgIF9oYXNoY2hhbmdlSGFuZGxlcjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgaWYgKGlzTnVtYmVyKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSkgJiYgdGhpcy5fZ2V0Rmxvb3JGcm9tSGFzaCgpICE9PSB0aGlzLmZsb29yQWN0aXZlICYmICF0aGlzLm5vZGUuaXMoJzphbmltYXRlZCcpKSB7CiAgICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qIFdpbGwgdXBkYXRlIGhhc2ggbG9jYXRpb24gaWYgZmxvb3IgbmFtZSBhcmUgc2V0dXAuICovCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24oZmxvb3JJbmRleCkgewogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSAmJiB0aGlzLl9nZXRIYXNoKCkgIT09IHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZVtmbG9vckluZGV4XSkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCgnJyArIHdpbmRvdy5sb2NhdGlvbikuc3BsaXQoJyMnKVswXSArICcjJyArIHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZVtmbG9vckluZGV4XSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qIEV2ZW50IGhlbHBlciwgbGV0IGFzY2Vuc29yIGNyZWF0ZSBvd24gZXZlbnQsIHdpdGggZmxvb3IgaW5mb3JtYXRpb24gKi8KICAgIF9lbWl0RXZlbnQ6IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZnJvbSwgdG8pIHsKICAgICAgdGhpcy5ub2RlLnRyaWdnZXIoZXZlbnROYW1lLCBmbG9vciA9IHsKICAgICAgICBmcm9tOiBmcm9tLAogICAgICAgIHRvOiB0bwogICAgICB9KTsKICAgIH0sCgoKICAgIC8qIFdhcm4gaGFuZGxlciAqLwogICAgX2VtaXRDb25zb2xlTWVzc2FnZTogZnVuY3Rpb24odHlwZSwgd2FybikgewogICAgICBpZiAodHlwZSA9PSAiZXJyb3IiKSBjb25zb2xlLmVycm9yKCJBc2NlbnNvci5qczogIiArIHdhcm4pOwogICAgICBpZiAodHlwZSA9PSAid2FybiIpIGNvbnNvbGUud2FybigiQXNjZW5zb3IuanM6ICIgKyB3YXJuKTsKICAgIH0sCgoKICAgIC8qIEtleXByZXNzIEhhbmRsZXIgKi8KICAgIF9rZXlwcmVzc0hhbmRsZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIga2V5ID0gZS5rZXlDb2RlIHx8IGUud2hpY2g7CiAgICAgIGlmICghJCgnaW5wdXQsIHRleHRhcmVhLCBidXR0b24nKS5pcygnOmZvY3VzJykpIHsKICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgY2FzZSA0MDoKICAgICAgICAgIGNhc2UgODM6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ2Rvd24nKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM4OgogICAgICAgICAgY2FzZSA4NzoKICAgICAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbigndXAnKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzNzoKICAgICAgICAgIGNhc2UgNjU6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ2xlZnQnKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzOToKICAgICAgICAgIGNhc2UgNjg6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ3JpZ2h0Jyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCgogICAgLyogUmVzaXplIGhhbmRsZXIuIFVwZGF0ZSBzY3JvbGxUb3AgJiBzY3JvbGxMZWZ0IHBvc2l0aW9uICovCiAgICBzY3JvbGxUb0Zsb29yOiBmdW5jdGlvbihmbG9vcikgewoKICAgICAgLy8gSWYgZmxvb3Igc2VuZCBpcyBhIHRyaW5nLCBjaGVjayBpZiBpdCBtYXRjaCBhbnkgb2YgYXNjZW5zb3JGbG9vck5hbWUsIHRoZW4gdXNlIHBvaXN0aW9uIGluIGFycmF5CiAgICAgIGlmIChpc1N0cmluZyhmbG9vcikgJiYgZXhpc3RJbkFycmF5KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSwgZmxvb3IpKSBmbG9vciA9IHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZS5pbmRleE9mKGZsb29yKTsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFuaW1hdGUgPSAoZmxvb3IgPT09IHRoaXMuZmxvb3JBY3RpdmUpID8gZmFsc2UgOiB0cnVlOwoKICAgICAgaWYgKHRoaXMuTlcgIT09IHRoaXMubm9kZS53aWR0aCgpKSB0aGlzLk5XID0gdGhpcy5ub2RlLndpZHRoKCk7CiAgICAgIGlmICh0aGlzLk5IICE9PSB0aGlzLm5vZGUuaGVpZ2h0KCkpIHRoaXMuTkggPSB0aGlzLm5vZGUuaGVpZ2h0KCk7CgogICAgICAvLyBNYWtlIHN1cmUgcG9zaXRpb24gaXMgY29ycmVjdAogICAgICB2YXIgYW5pbWF0aW9uT2JqZWN0ID0gdGhpcy5fZ2V0QW5pbWF0aW9uU2V0dGluZ3MoZmxvb3IpOwoKICAgICAgaWYgKGFuaW1hdGUpIHsKICAgICAgICB0aGlzLl9lbWl0RXZlbnQoJ3Njcm9sbFN0YXJ0Jywgc2VsZi5mbG9vckFjdGl2ZSwgZmxvb3IpOwogICAgICAgIHRoaXMubm9kZS5zdG9wKCkuYW5pbWF0ZShhbmltYXRpb25PYmplY3QucHJvcGVydHksIHNlbGYub3B0aW9ucy50aW1lLCBzZWxmLm9wdGlvbnMuZWFzaW5nLCBhbmltYXRpb25PYmplY3QuY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubm9kZS5zdG9wKCkuc2Nyb2xsVG9wKGFuaW1hdGlvbk9iamVjdC5kZWZhdWx0cy5zY3JvbGxUb3ApLnNjcm9sbExlZnQoYW5pbWF0aW9uT2JqZWN0LmRlZmF1bHRzLnNjcm9sbExlZnQpOwogICAgICB9CgogICAgICB0aGlzLmZsb29yQWN0aXZlID0gZmxvb3I7CiAgICAgIHRoaXMubm9kZS5kYXRhKCdjdXJyZW50LWZsb29yJywgdGhpcy5mbG9vckFjdGl2ZSk7CgogICAgfSwKCgogICAgLyogUHJldiBmdW5jdGlvbiAqLwogICAgcHJldjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXJnZXRGbG9vciA9IHRoaXMuZmxvb3JBY3RpdmUgLSAxOwogICAgICBpZiAodGFyZ2V0Rmxvb3IgPCAwKSB7CiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMubG9vcCkgcmV0dXJuOwogICAgICAgIHRhcmdldEZsb29yID0gdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoIC0gMTsKICAgICAgfQogICAgICB0aGlzLnNjcm9sbFRvRmxvb3IodGFyZ2V0Rmxvb3IpOwogICAgfSwKCgogICAgLyogUHJldiBmdW5jdGlvbiAqLwogICAgbmV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0YXJnZXRGbG9vciA9IHRoaXMuZmxvb3JBY3RpdmUgKyAxOwogICAgICBpZiAodGFyZ2V0Rmxvb3IgPiB0aGlzLm5vZGVDaGlsZHJlbi5sZW5ndGggLSAxKSB7CiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMubG9vcCkgcmV0dXJuOwogICAgICAgIHRhcmdldEZsb29yID0gMDsKICAgICAgfQoKICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRhcmdldEZsb29yKTsKICAgIH0sCgoKICAgIC8qIEhlbHBlciB0byBnZW5lcmF0ZSBhbmltYXRpb24gc2V0dGluZ3MgKi8KICAgIF9nZXRBbmltYXRpb25TZXR0aW5nczogZnVuY3Rpb24oZmxvb3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgc2F2ZUZsb29yQWN0aXZlID0gc2VsZi5mbG9vckFjdGl2ZTsKICAgICAgLy8gQ3JlYXRlIGFuaW1hdGlvbiBzZXR0aW5nIG9iamVjdAogICAgICB2YXIgYW5pbWF0aW9uU2V0dGluZ3MgPSB7CiAgICAgICAgcHJvcGVydHk6IHt9LAogICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuX2VtaXRFdmVudCgnc2Nyb2xsRW5kJywgc2F2ZUZsb29yQWN0aXZlLCBmbG9vcik7CiAgICAgICAgICBzZWxmLl91cGRhdGVIYXNoKGZsb29yKTsKICAgICAgICB9LAogICAgICAgIGRlZmF1bHRzOiB7fQogICAgICB9OwoKCiAgICAgIC8vIENyZWF0ZSBhIHNlY29uZCBzZXR0aW5nIG9iamVjdAogICAgICAvLyBpbiBjYXNlIHRoZSBxdWV1ZWQgb3B0aW9uIGlzIHNldAogICAgICB2YXIgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MgPSB7CiAgICAgICAgcHJvcGVydHk6IHt9LAogICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuX2VtaXRFdmVudCgnc2Nyb2xsRW5kJywgc2F2ZUZsb29yQWN0aXZlLCBmbG9vcik7CiAgICAgICAgICBzZWxmLl91cGRhdGVIYXNoKGZsb29yKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhbmltYXRpb25TZXR0aW5ncy5kZWZhdWx0cy5zY3JvbGxUb3AgPSBmbG9vciAqIHNlbGYuTkg7CiAgICAgIGFuaW1hdGlvblNldHRpbmdzLmRlZmF1bHRzLnNjcm9sbExlZnQgPSBmbG9vciAqIHNlbGYuTlc7CgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgdmVydGljYWwKICAgICAgLy8gPT4gc2V0IHNjcm9sbFRvcCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3knKSB7CiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsVG9wID0gZmxvb3IgKiBzZWxmLk5IOwogICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgfQoKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyBob3Jpem9udGFsCQogICAgICAvLyA9PiBzZXQgc2Nyb2xsbGVmdCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICBlbHNlIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneCcpIHsKICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gZmxvb3IgKiBzZWxmLk5XOwogICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgfQoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIGEgbWFwCiAgICAgIGVsc2UgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgewoKICAgICAgICAvLyA9PiBTYXZlIHZhbHVlCiAgICAgICAgdmFyIHNjcm9sbFRvcFZhbHVlID0gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltmbG9vcl1bc2VsZi5BWElTX1ldICogc2VsZi5OSDsKICAgICAgICB2YXIgc2Nyb2xsTGVmdFZhbHVlID0gc2VsZi5vcHRpb25zLmRpcmVjdGlvbltmbG9vcl1bc2VsZi5BWElTX1hdICogc2VsZi5OVzsKCiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wVmFsdWU7CiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKCgogICAgICAgIC8vIElmIHRoZSBxdWV1ZWQgb3B0aW9uIGlzIHNldAogICAgICAgIGlmIChzZWxmLm9wdGlvbnMucXVldWVkKSB7CgogICAgICAgICAgLy8gPT4gQ2hlY2sgZmxvb3IgcG9zaXRpb24sIHRvIGF2b2lkIGFuaW1hdGlvbiBpZiBhbHJlYWR5IG9uIHNhbWUgZmxvb3IKICAgICAgICAgIHZhciBzYW1lWHBvc2l0aW9uID0gdGhpcy5ub2RlLnNjcm9sbExlZnQoKSA9PT0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgdmFyIHNhbWVZcG9zaXRpb24gPSB0aGlzLm5vZGUuc2Nyb2xsVG9wKCkgPT09IHNjcm9sbFRvcFZhbHVlOwoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIGhvcml6b250YWwgJiBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbFRvcCBwcm9wZXJ0eSAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5xdWV1ZWQgPT09ICd4JyAmJiBzYW1lWHBvc2l0aW9uKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIElmIHF1ZXVlZCBkaXJlY3Rpb24gaXMgaG9yaXpvbnRhbCAmIE5PVCBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbExlZnQgcHJvcGVydHkKICAgICAgICAgIC8vID0+IFNldCBjYWxsYmFjayB0byBhIHNlY29uZCBhbmltYXRpb24gKHNjcm9sbFRvcCkKICAgICAgICAgIC8vID0+IHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICAgIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYubm9kZS5zdG9wKCkuYW5pbWF0ZShzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eSwgc2VsZi5vcHRpb25zLnRpbWUsIHNlbGYub3B0aW9ucy5lYXNpbmcsIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIHZlcnRpY2FsICYgb24gdGhlIHNhbWUgZmxvb3IKICAgICAgICAgIC8vID0+IFNldCBzY3JvbGxUb3Agc2Nyb2xsTGVmdCAmIHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5xdWV1ZWQgPT09ICd5JyAmJiBzYW1lWXBvc2l0aW9uKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICAgIH0KCgogICAgICAgICAgLy8gSWYgcXVldWVkIGRpcmVjdGlvbiBpcyB2ZXJ0aWNhbCAmIE5PVCBvbiB0aGUgc2FtZSBmbG9vcgogICAgICAgICAgLy8gPT4gU2V0IHNjcm9sbFRvcCBwcm9wZXJ0eQogICAgICAgICAgLy8gPT4gU2V0IGNhbGxiYWNrIHRvIGEgc2Vjb25kIGFuaW1hdGlvbiAoc2Nyb2xsTGVmdCkKICAgICAgICAgIC8vID0+IHJldHVybiBhbmltYXRpb25TZXR0aW5ncwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgICBzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYubm9kZS5zdG9wKCkuYW5pbWF0ZShzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eSwgc2VsZi5vcHRpb25zLnRpbWUsIHNlbGYub3B0aW9ucy5lYXNpbmcsIHNlY29uZEFuaW1hdGlvblNldHRpbmdzLmNhbGxiYWNrKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIElmIHF1ZXVkIG9wdGlvbiBpcyBub3Qgc2V0LCAKICAgICAgICAvLyA9PiBzZXQgc2Nyb2xsVG9wICYgU2Nyb2xsTGVmdCBwcm9wZXJ0eSAKICAgICAgICAvLyA9PiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICBlbHNlIHsKICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgIH0sCgoKICAgIC8qIEhlbHBlciB0byBoYW5kbGUgZGlyZWN0aW9uIGNvcnJlY3RseS4gKi8KICAgIHNjcm9sbFRvRGlyZWN0aW9uOiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gSWYgYSBkYXRhIGF0dHJpYnV0ZSB3aXRoIGN1cnJlbnQgZGlyZWN0aW9uCiAgICAgIC8vIGlzIGZvdW5kLCB1c2UgaXQuCiAgICAgIHZhciBkYXRhQXR0cmlidXRlRGlyZWN0aW9uID0gdGhpcy5ub2RlQ2hpbGRyZW4uZXEodGhpcy5mbG9vckFjdGl2ZSkuZGF0YSh0aGlzLmRhdGFBdHRyaWJ1dGVNYXBbZGlyZWN0aW9uXSk7CiAgICAgIGlmIChkYXRhQXR0cmlidXRlRGlyZWN0aW9uKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pOwoKCiAgICAgIHZhciBkaXJlY3Rpb25Jc0hvcml6b250YWwgPSAoZGlyZWN0aW9uID09ICdyaWdodCcgfHwgZGlyZWN0aW9uID09ICdsZWZ0Jyk7CiAgICAgIHZhciBkaXJlY3Rpb25Jc1ZlcnRpY2FsID0gKGRpcmVjdGlvbiA9PSAnZG93bicgfHwgZGlyZWN0aW9uID09ICd1cCcpOwoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIHggb3IgeSBhbmQgdGhlcmUgaXMgCiAgICAgIC8vIGRpcmVjdGlvbiBhcmUgb3BwcHNpdGUsIHJldHVybiBoZXJlCiAgICAgIGlmICgoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneScgJiYgZGlyZWN0aW9uSXNIb3Jpem9udGFsKSB8fCAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneCcgJiYgZGlyZWN0aW9uSXNWZXJ0aWNhbCkpIHJldHVybjsKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyB4IG9yIHgsIGFuZCAKICAgICAgLy8gZGlyZWN0aW9uIG1hdGNoLCB1c2UgcHJldi9uZXh0CiAgICAgIGlmICgoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneScgJiYgZGlyZWN0aW9uID09ICdkb3duJykgfHwgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3gnICYmIGRpcmVjdGlvbiA9PSAncmlnaHQnKSkgcmV0dXJuIHNlbGYubmV4dCgpOwogICAgICBpZiAoKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3knICYmIGRpcmVjdGlvbiA9PSAndXAnKSB8fCAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PSAneCcgJiYgZGlyZWN0aW9uID09ICdsZWZ0JykpIHJldHVybiBzZWxmLnByZXYoKTsKCgogICAgICBpZiAoc2VsZi5kaXJlY3Rpb25Jc0FycmF5KSB7CgogICAgICAgIHZhciBmbG9vck9iamVjdCA9IHNlbGYuZmxvb3JNYXBbc2VsZi5mbG9vckFjdGl2ZV07CgogICAgICAgIC8vIElmIGV4aXN0aW5nLCByZXR1cm4gYXBwZW5kaW5nIGZsb29yCiAgICAgICAgdmFyIGRpcmVjdEZsb29yID0gZmxvb3JPYmplY3RbZGlyZWN0aW9uXTsKICAgICAgICBpZiAoaXNOdW1iZXIoZGlyZWN0Rmxvb3IpKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRpcmVjdEZsb29yKTsKCiAgICAgICAgLy8gSnVtcCBpcyBzZXQgdG8gdHJ1ZSwgdXNlIHRoZSAKICAgICAgICAvLyBjbG9zZXN0IGZsb29yIGluIHRoYXQgc2FtZSBkaXJlY3Rpb24KICAgICAgICB2YXIgY2xvc2VzdEZsb29yID0gZmxvb3JPYmplY3QuY2xvc2VzdFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc1RydWUoc2VsZi5vcHRpb25zLmp1bXApICYmIGlzTnVtYmVyKGNsb3Nlc3RGbG9vcikpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoY2xvc2VzdEZsb29yKTsKCiAgICAgICAgLy8gSWYgbG9vcCBpcyBzZXQgdG8gdHJ1ZSwgdXNlCiAgICAgICAgLy8JdGhlIGZ1cnRoZXN0IGZsb29yCiAgICAgICAgdmFyIGZ1cnRoZXN0Rmxvb3IgPSBmbG9vck9iamVjdC5mdXJ0aGVzdFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc051bWJlcihmdXJ0aGVzdEZsb29yKSAmJiAoaXNUcnVlKHNlbGYub3B0aW9ucy5sb29wKSB8fCAoZGlyZWN0aW9uSXNIb3Jpem9udGFsICYmIHNlbGYub3B0aW9ucy5sb29wID09ICdsb29wLXgnKSB8fCAoZGlyZWN0aW9uSXNWZXJ0aWNhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnbG9vcC15JykpKSB7CiAgICAgICAgICByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGZ1cnRoZXN0Rmxvb3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgSW5jcmVtZW50IGV4aXN0ICYgb3B0aW9uIGlzIHNldAogICAgICAgIHZhciBpbmNyZW1lbnRGbG9vciA9IGZsb29yT2JqZWN0LmluY3JlbWVudFtkaXJlY3Rpb25dOwogICAgICAgIGlmIChpc051bWJlcihpbmNyZW1lbnRGbG9vcikpIHsKCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudCcgfHwgZGlyZWN0aW9uSXNWZXJ0aWNhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXknIHx8IGRpcmVjdGlvbklzSG9yaXpvbnRhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50LXgnKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3IoaW5jcmVtZW50Rmxvb3IpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSnVtcCBmcm9tIGxhc3QgdG8gZmlyc3Qgb3IgZmlyc3QgdG8gbGFzdAogICAgICAgIGlmICgoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC14JyAmJiBkaXJlY3Rpb25Jc0hvcml6b250YWwpIHx8IHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQnKSB7CiAgICAgICAgICBpZiAoc2VsZi5mbG9vckFjdGl2ZSA9PSBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3gpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5jbG9zZXN0X3gpOwogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5jbG9zZXN0X3gpIHJldHVybiBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF94KTsKICAgICAgICB9CgogICAgICAgIGlmICgoc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC15JyAmJiBkaXJlY3Rpb25Jc1ZlcnRpY2FsKSB8fCBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50JykgewogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF95KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuY2xvc2VzdF95KTsKICAgICAgICAgIGlmIChzZWxmLmZsb29yQWN0aXZlID09IHNlbGYuZmxvb3JNYXAuY2xvc2VzdF95KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKCgogICAgLyogSGVscGVyIHRvIGdldCB0aGUgZGlyZWN0IGFwcGVuZGluZyBmbG9vciBpbiBvbmUgcHJlY2lzZSBkaXJlY3Rpb24gZGlyZWN0aW9uICovCiAgICBfZ2V0RGlyZWN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBDcmVhdGUgZmxvb3IgdGFyZ2V0IGFycmF5IGJhc2Ugb24gZmxvb3JvYmplY3QKICAgICAgdmFyIGZsb29yVGFyZ2V0ID0gW3RoaXMub3B0aW9ucy5kaXJlY3Rpb25bZmxvb3JJbmRleF1bdGhpcy5BWElTX1ldLCB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uW2Zsb29ySW5kZXhdW3RoaXMuQVhJU19YXV07CgogICAgICAvLyBBZGp1c3QgbWFwIGRlcGVuZGluZyBvbiBkaXJlY3Rpb24KICAgICAgaWYgKGRpcmVjdGlvbiA9PSAncmlnaHQnKSBmbG9vclRhcmdldFt0aGlzLkFYSVNfWF0gKz0gMTsKICAgICAgaWYgKGRpcmVjdGlvbiA9PSAnbGVmdCcpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19YXSAtPSAxOwogICAgICBpZiAoZGlyZWN0aW9uID09ICd1cCcpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19ZXSAtPSAxOwogICAgICBpZiAoZGlyZWN0aW9uID09ICdkb3duJykgZmxvb3JUYXJnZXRbdGhpcy5BWElTX1ldICs9IDE7CgogICAgICAvLyBsb29wYW5kIGNvbXBhcmUgZGlyZWN0aW9uIG1hcAogICAgICB2YXIgZmxvb3JUYXJnZXRJbmRleCA9IGZhbHNlOwogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBtYXApIHsKCiAgICAgICAgLy8gSWYgY3VycmVudCBvYmplY3QgbWFwIHZhbHVlIGFyZSBlcXVhbCB0byB0YXJnZXQgb25lCiAgICAgICAgaWYgKG1hcFtzZWxmLkFYSVNfWV0gPT0gZmxvb3JUYXJnZXRbc2VsZi5BWElTX1ldICYmIG1hcFtzZWxmLkFYSVNfWF0gPT0gZmxvb3JUYXJnZXRbc2VsZi5BWElTX1hdKSB7CgogICAgICAgICAgLy8gR2V0IGluZGV4ICYgYnJlYWsgbG9vcAogICAgICAgICAgZmxvb3JUYXJnZXRJbmRleCA9IGluZGV4OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gZmxvb3JUYXJnZXRJbmRleDsKICAgIH0sCgogICAgLyogUmV0dXJuIGNvcnJlY3QgYXhpcyBkZXBlbmRpbmcgb24gcG9zaXRpb24gKi8KICAgIF9nZXRBeGlzRnJvbURpcmVjdGlvbjogZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGF4aXM7CiAgICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7CiAgICAgICAgY2FzZSAndXAnOgogICAgICAgIGNhc2UgJ2Rvd24nOgogICAgICAgICAgYXhpcyA9IHNlbGYuQVhJU19ZOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgYXhpcyA9IHNlbGYuQVhJU19YOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHJldHVybiBheGlzOwogICAgfSwKCiAgICAvKiBIZWxwZXIgdG8gZ2V0IHRoZSBjbG9zZXN0IGZsb29yIGluIG9uZSBwcmVjaXNlIGRpcmVjdGlvbiBkaXJlY3Rpb24gKi8KICAgIF9nZXRDbG9zZXN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbiwgbGV2ZWwpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgbGV2ZWwgPSBsZXZlbCB8fCAwOwoKICAgICAgLy8gR2V0IGF4aXMgJiBjb21wYXJlLXRvIGZsb29ySW5kZXgKICAgICAgdmFyIGF4aXMgPSB0aGlzLl9nZXRBeGlzRnJvbURpcmVjdGlvbihkaXJlY3Rpb24pOwogICAgICB2YXIgZ29hbCA9IERBW2Zsb29ySW5kZXhdW2F4aXNdOwogICAgICB2YXIgb3Bwb3NpdGVBeGlzID0gKGF4aXMgPT0gdGhpcy5BWElTX1kpID8gdGhpcy5BWElTX1ggOiB0aGlzLkFYSVNfWTsKCiAgICAgIC8vIFNldHVwIGxvb3AgdmFyaWFibGUKICAgICAgdmFyIGNsb3Nlc3RJbmRleCA9IGZhbHNlOwogICAgICB2YXIgY2xvc2VzdE1hcCA9IGZhbHNlOwoKICAgICAgLy8gTG9vcCB0cm91Z2ggZmxvb3IgcG9zaXRpb24gYXJyYXkKICAgICAgJC5lYWNoKERBLCBmdW5jdGlvbihpbmRleCwgbWFwKSB7CgogICAgICAgIC8vIElmIG9uIHNhbWUgYXhpcwogICAgICAgIGlmIChtYXBbb3Bwb3NpdGVBeGlzXSA9PSAoREFbZmxvb3JJbmRleF1bb3Bwb3NpdGVBeGlzXSArIGxldmVsKSkgewoKICAgICAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyBmb3dhcmQgKHJpZ2h0IG9yIGRvd24pIGFuZCB0aGUgdmFsdWUgaXMgYmlnZ2VyIHRoYW4gZ29hbCAKICAgICAgICAgIC8vIG9mIGlmIGRpcmVjdGlvbiBpcyBiYWNrd2FyZCAobGVmdCBvciB1cCkgYW5kIHRoZSB2YWx1ZSBpcyBzbWFsbGVyIHRoYW4gdGhlIGdvYWwKICAgICAgICAgIGlmICgoKGRpcmVjdGlvbiA9PSAncmlnaHQnIHx8IGRpcmVjdGlvbiA9PSAnZG93bicpICYmIG1hcFtheGlzXSA+IGdvYWwpIHx8ICgoZGlyZWN0aW9uID09ICdsZWZ0JyB8fCBkaXJlY3Rpb24gPT0gJ3VwJykgJiYgbWFwW2F4aXNdIDwgZ29hbCkpIHsKCgogICAgICAgICAgICAvLyBObyBwcmV2aW91cyB2YWx1ZSBzZXQgb3IgaWYgdGhlIGN1cnJlbnQKICAgICAgICAgICAgLy8gdmFsdWUgaXMgc21hbGxlciB0aGFuIHRoZSBwcmV2aW91cyBvbmUJCQkJCSAKICAgICAgICAgICAgaWYgKCFjbG9zZXN0TWFwIHx8IE1hdGguYWJzKG1hcFtheGlzXSAtIGdvYWwpIDwgTWF0aC5hYnMoY2xvc2VzdE1hcFtheGlzXSkpIHsKICAgICAgICAgICAgICBjbG9zZXN0SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICBjbG9zZXN0TWFwID0gbWFwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHJldHVybiBpbmRleAogICAgICByZXR1cm4gY2xvc2VzdEluZGV4OwogICAgfSwKCgogICAgLyogSGVscGVyIHRvIGdldCB0aGUgZnVydGhlc3QgZmxvb3IgaW4gb25lIHByZWNpc2UgZGlyZWN0aW9uIGRpcmVjdGlvbiAqLwogICAgX2dldEZ1cnRoZXN0Rmxvb3JJbmRleDogZnVuY3Rpb24oREEsIGZsb29ySW5kZXgsIGRpcmVjdGlvbiwgbGV2ZWwpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgbGV2ZWwgPSBsZXZlbCB8fCAwOwoKICAgICAgLy8gR2V0IGF4aXMgJiBjb21wYXJlLXRvIGZsb29ySW5kZXgKICAgICAgdmFyIGF4aXMgPSB0aGlzLl9nZXRBeGlzRnJvbURpcmVjdGlvbihkaXJlY3Rpb24pOwogICAgICB2YXIgZ29hbCA9IERBW2Zsb29ySW5kZXhdW2F4aXNdOwogICAgICB2YXIgb3Bwb3NpdGVBeGlzID0gKGF4aXMgPT0gdGhpcy5BWElTX1kpID8gdGhpcy5BWElTX1ggOiB0aGlzLkFYSVNfWTsKCiAgICAgIC8vIFNldHVwIGxvb3AgdmFyaWFibGUKICAgICAgdmFyIGZ1cnRoZXN0TWFwID0gZmFsc2U7CiAgICAgIHZhciBmdXJ0aGVzdEluZGV4ID0gZmFsc2U7CgogICAgICAvLyBMb29wIHRyb3VnaCBmbG9vciBwb3NpdGlvbiBhcnJheQogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBtYXApIHsKCiAgICAgICAgLy8gSWYgb24gc2FtZSBheGlzCiAgICAgICAgaWYgKG1hcFtvcHBvc2l0ZUF4aXNdID09IChEQVtmbG9vckluZGV4XVtvcHBvc2l0ZUF4aXNdICsgbGV2ZWwpKSB7CgogICAgICAgICAgLy8gSWYgb24gc2FtZSBheGlzCiAgICAgICAgICBpZiAoIWZ1cnRoZXN0TWFwIHx8IChNYXRoLmFicyhtYXBbYXhpc10gLSBnb2FsKSA+IE1hdGguYWJzKGZ1cnRoZXN0TWFwW2F4aXNdIC0gZ29hbCkpKSB7CiAgICAgICAgICAgIGZ1cnRoZXN0TWFwID0gbWFwOwogICAgICAgICAgICBmdXJ0aGVzdEluZGV4ID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHJldHVybiBpbmRleAogICAgICByZXR1cm4gZnVydGhlc3RJbmRleDsKCiAgICB9LAoKICAgIC8qIFVzZSB0byBhY2Nlc3MgcXVpY2tseSBsYXRlciwgYXZvaWRpbmcgbG9vcGluZyB0aHJvdWdoIGV2ZXJ5IGRpcmVjdGlvbiBldmVyeSB0aW1lICovCiAgICBfZ2VuZXJhdGVGbG9vck1hcDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIHRoaXMuZmxvb3JNYXAgPSBbXTsKCiAgICAgIC8vIENyZWF0ZSBtYXAgb25seSBmb3IgZmxvb3IgcHJlc2VudCBpbiB0aGUgZG9tCiAgICAgIHZhciBEQSA9IGpRdWVyeS5ncmVwKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24sIGZ1bmN0aW9uKGRpcmVjdGlvbkFycmF5LCBpbmRleCkgewogICAgICAgIHJldHVybiBzZWxmLm5vZGVDaGlsZHJlbi5sZW5ndGggPiBpbmRleDsKICAgICAgfSk7CgogICAgICAvLyBMb29wIG9uIHRoZSBkaXJhdGlvbiBhcnJheSBhbmQgZ2V0IAogICAgICAvLyB0aGUgZmxvb3IgSUQgZm9yIGVhY2ggZGlyZWN0aW9uCiAgICAgICQuZWFjaChEQSwgZnVuY3Rpb24oaW5kZXgsIGZsb29ySXRlbSkgewogICAgICAgIHNlbGYuZmxvb3JNYXBbaW5kZXhdID0gewogICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXREaXJlY3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2Rvd24nKSwKICAgICAgICAgICd1cCc6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAndXAnKSwKICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnKSwKICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0RGlyZWN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdsZWZ0JyksCiAgICAgICAgICAnaW5jcmVtZW50JzogewogICAgICAgICAgICAnZG93bic6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJywgMSksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcsIC0xKSwKICAgICAgICAgICAgJ3JpZ2h0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JywgMSksCiAgICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2xlZnQnLCAtMSkKICAgICAgICAgIH0sCiAgICAgICAgICAnY2xvc2VzdCc6IHsKICAgICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXRDbG9zZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJyksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3VwJyksCiAgICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JyksCiAgICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0Q2xvc2VzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcpCiAgICAgICAgICB9LAogICAgICAgICAgJ2Z1cnRoZXN0JzogewogICAgICAgICAgICAnZG93bic6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJyksCiAgICAgICAgICAgICd1cCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcpLAogICAgICAgICAgICAncmlnaHQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAncmlnaHQnKSwKICAgICAgICAgICAgJ2xlZnQnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcpCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBnZXRGdXJ0aGVyRmxvb3JBcnJheShmbG9vckFycmF5LCBheGlzKSB7CiAgICAgICAgdmFyIGZ1cnRoZXJGbG9vciA9IGZhbHNlOwogICAgICAgIGpRdWVyeS5lYWNoKGZsb29yQXJyYXksIGZ1bmN0aW9uKGluZGV4LCBEQSkgewogICAgICAgICAgaWYgKGZ1cnRoZXJGbG9vciA9PT0gZmFsc2UgfHwgZnVydGhlckZsb29yW2F4aXNdIDwgREFbYXhpc10pIHsKICAgICAgICAgICAgZnVydGhlckZsb29yID0gREE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZ1cnRoZXJGbG9vcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKGZsb29yQXJyYXksIGF4aXMpIHsKICAgICAgICB2YXIgZnVydGhlckZsb29yID0gZmFsc2U7CiAgICAgICAgalF1ZXJ5LmVhY2goZmxvb3JBcnJheSwgZnVuY3Rpb24oaW5kZXgsIERBKSB7CiAgICAgICAgICBpZiAoZnVydGhlckZsb29yID09PSBmYWxzZSB8fCBmdXJ0aGVyRmxvb3JbYXhpc10gPiBEQVtheGlzXSkgewogICAgICAgICAgICBmdXJ0aGVyRmxvb3IgPSBEQTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZnVydGhlckZsb29yOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRTYW1lQXhpc0Zsb29yKGZsb29ySXRlbSwgYXhpcykgewogICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChEQSwgZnVuY3Rpb24oREEpIHsKICAgICAgICAgIHZhciBpc09uU2FtZUF4aXMgPSBEQVtheGlzXSA9PSBmbG9vckl0ZW1bYXhpc107CiAgICAgICAgICByZXR1cm4gaXNPblNhbWVBeGlzOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgYXBwcm94aW1hdGVGdXJ0aGVyWCA9IGdldEZ1cnRoZXJGbG9vckFycmF5KERBLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBzYW1lQXhpc1hGdXJ0aGVzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVGdXJ0aGVyWCwgc2VsZi5BWElTX1gpOwogICAgICB2YXIgZnVydGhlclkgPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShzYW1lQXhpc1hGdXJ0aGVzdCwgc2VsZi5BWElTX1kpOwoKICAgICAgdmFyIGFwcHJveGltYXRlRnVydGhlclkgPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShEQSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgc2FtZUF4aXNZRnVydGhlc3QgPSBnZXRTYW1lQXhpc0Zsb29yKGFwcHJveGltYXRlRnVydGhlclksIHNlbGYuQVhJU19ZKTsKICAgICAgdmFyIGZ1cnRoZXJYID0gZ2V0RnVydGhlckZsb29yQXJyYXkoc2FtZUF4aXNZRnVydGhlc3QsIHNlbGYuQVhJU19YKTsKCiAgICAgIHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeCA9IERBLmluZGV4T2YoZnVydGhlclgpOwogICAgICBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3kgPSBEQS5pbmRleE9mKGZ1cnRoZXJZKTsKCiAgICAgIHZhciBhcHByb3hpbWF0ZUNsb3Nlc3RYID0gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKERBLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBzYW1lQXhpc1hDbG9zZXN0ID0gZ2V0U2FtZUF4aXNGbG9vcihhcHByb3hpbWF0ZUNsb3Nlc3RYLCBzZWxmLkFYSVNfWCk7CiAgICAgIHZhciBjbG9zZXN0WSA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhzYW1lQXhpc1hDbG9zZXN0LCBzZWxmLkFYSVNfWSk7CgogICAgICB2YXIgYXBwcm94aW1hdGVDbG9zZXN0WSA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhEQSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgc2FtZUF4aXNZQ2xvc2VzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVDbG9zZXN0WSwgc2VsZi5BWElTX1kpOwogICAgICB2YXIgY2xvc2VzdFggPSBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoc2FtZUF4aXNZQ2xvc2VzdCwgc2VsZi5BWElTX1gpOwoKICAgICAgc2VsZi5mbG9vck1hcC5jbG9zZXN0X3ggPSBEQS5pbmRleE9mKGNsb3Nlc3RYKTsKICAgICAgc2VsZi5mbG9vck1hcC5jbG9zZXN0X3kgPSBEQS5pbmRleE9mKGNsb3Nlc3RZKTsKCgogICAgfSwKCiAgfTsKCiAgJC5mbltwbHVnaW5OYW1lXSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgaWYgKCEkLmRhdGEodGhpcywgcGx1Z2luTmFtZSkpIHsKICAgICAgICAkLmRhdGEodGhpcywgcGx1Z2luTmFtZSwgbmV3IFBsdWdpbih0aGlzLCBvcHRpb25zKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiB0aGlzOwogIH07Cn0pKGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCk7",
                "body": "LyoKQXNjZW5zb3IuanMgCnZlcnNpb246IDEuOC4xNCAoMjAxNC0wOC0yOCkKZGVzY3JpcHRpb246IEFzY2Vuc29yIGlzIGEganF1ZXJ5IHBsdWdpbiB3aGljaCBhaW1zIHRvIHRyYWluIGFuZCBhZGFwdCBjb250ZW50IGFjY29yZGluZyB0byBhbiBlbGV2YXRvciBzeXN0ZW0KcmVwb3NpdG9yeTogaHR0cHM6Ly9naXRodWIuY29tL2tpcmthcy9Bc2NlbnNvci5qcwpsaWNlbnNlOiBCU0QKYXV0aG9yOiBMw6lvIEdhbGxleSA8Y29udGFjdEBraXJrYXMuY2g+CiovCihmdW5jdGlvbigkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHsKICB2YXIgcGx1Z2luTmFtZSA9ICdhc2NlbnNvcic7CgoKICAvKiBEZWZhdWx0IHNldHRpbmdzICovCiAgdmFyIGRlZmF1bHRzID0gewogICAgYXNjZW5zb3JGbG9vck5hbWU6IGZhbHNlLAogICAgY2hpbGRUeXBlOiAnZGl2JywKICAgIHdpbmRvd3NPbjogMCwKICAgIGRpcmVjdGlvbjogJ3knLAogICAgbG9vcDogZmFsc2UsCiAgICB3aWR0aDogJzEwMCUnLAogICAgaGVpZ2h0OiAnMTAwJScsCiAgICB0aW1lOiAyNTAsCiAgICBlYXNpbmc6ICdsaW5lYXInLAogICAga2V5TmF2aWdhdGlvbjogdHJ1ZSwKICAgIHF1ZXVlZDogZmFsc2UsCiAgICBqdW1wOiBmYWxzZSwKICAgIHJlYWR5OiBmYWxzZSwKICAgIHN3aXBlTmF2aWdhdGlvbjogJ21vYmlsZS1vbmx5JywKICAgIHN3aXBlVmVsb2NpdHk6IDAuNywKICAgIHdoZWVsTmF2aWdhdGlvbjogZmFsc2UsCiAgICB3aGVlbE5hdmlnYXRpb25EZWxheTogNDAsCiAgfTsKCiAgLyogUGx1Z2luIGluc3RhbmNlICovCiAgZnVuY3Rpb24gUGx1Z2luKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOwogICAgdGhpcy5fZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgIHRoaXMuX25hbWUgPSBwbHVnaW5OYW1lOwogICAgdGhpcy5pbml0KCk7CiAgfQoKICAvLyBGcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2xvcmVuem9wb2xpZG9yaS8zNzk0MjI2CiAgZnVuY3Rpb24gaGFzM2QoKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyksCiAgICAgIHN1cHBvcnQzRCwKICAgICAgdHJhbnNmb3JtcyA9IHsKICAgICAgICAnd2Via2l0VHJhbnNmb3JtJzogJy13ZWJraXQtdHJhbnNmb3JtJywKICAgICAgICAnT1RyYW5zZm9ybSc6ICctby10cmFuc2Zvcm0nLAogICAgICAgICdtc1RyYW5zZm9ybSc6ICctbXMtdHJhbnNmb3JtJywKICAgICAgICAnTW96VHJhbnNmb3JtJzogJy1tb3otdHJhbnNmb3JtJywKICAgICAgICAndHJhbnNmb3JtJzogJ3RyYW5zZm9ybScKICAgICAgfTsKICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKGVsLCBudWxsKTsKICAgIGZvciAodmFyIHQgaW4gdHJhbnNmb3JtcykgewogICAgICBpZiAoZWwuc3R5bGVbdF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIGVsLnN0eWxlW3RdID0gJ3RyYW5zbGF0ZTNkKDFweCwxcHgsMXB4KSc7CiAgICAgICAgc3VwcG9ydDNEID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpLmdldFByb3BlcnR5VmFsdWUodHJhbnNmb3Jtc1t0XSk7CiAgICAgIH0KICAgIH0KICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZWwpOwogICAgcmV0dXJuIChzdXBwb3J0M0QgIT09IHVuZGVmaW5lZCAmJiBzdXBwb3J0M0QubGVuZ3RoID4gMCAmJiBzdXBwb3J0M0QgIT09ICdub25lJyk7CiAgfQoKCiAgLyogQWRkICdpbmRleE9mJyBoZWxwZXIgaW4gY2FzZSBtaXNzaW5nIChJRTgpICovCiAgaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbihlbHQgLyosIGZyb20qLyApIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoID4+PiAwOwogICAgICB2YXIgZnJvbSA9IE51bWJlcihhcmd1bWVudHNbMV0pIHx8IDA7CiAgICAgIGZyb20gPSAoZnJvbSA8IDApID8gTWF0aC5jZWlsKGZyb20pIDogTWF0aC5mbG9vcihmcm9tKTsKICAgICAgaWYgKGZyb20gPCAwKSBmcm9tICs9IGxlbjsKICAgICAgZm9yICg7IGZyb20gPCBsZW47IGZyb20rKykgewogICAgICAgIGlmIChmcm9tIGluIHRoaXMgJiYgdGhpc1tmcm9tXSA9PT0gZWx0KSByZXR1cm4gZnJvbTsKICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9OwogIH0KCiAgLyogQXJyYXkgaGVscGVyICovCiAgZnVuY3Rpb24gZXhpc3RJbkFycmF5KGFycmF5LCBpdGVtKSB7CiAgICB2YXIgaW5kZXggPSBhcnJheS5pbmRleE9mKGl0ZW0pOwogICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvKiBWYWx1ZSBoZWxwZXIgKi8KICBmdW5jdGlvbiBpc0ZhbHNlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gaXNUcnVlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRydWU7CiAgfQoKICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZih2YWx1ZSkgPT09ICdudW1iZXInOwogIH0KCiAgZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YodmFsdWUpID09PSAnc3RyaW5nJzsKICB9CgogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nOwogIH0KCiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YodmFsdWUpID09PSAnb2JqZWN0JzsKICB9CgoKICAvKiBQbHVnaW4gc3RhcnQgKi8KICBQbHVnaW4ucHJvdG90eXBlID0gewoKICAgIC8qIEluaXRpYWxpemF0aW9uIG9mIHBsdWdpbiAqLwogICAgaW5pdDogZnVuY3Rpb24oKSB7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBDb25zdGFudCBoZWxwZXIKICAgICAgdGhpcy5BWElTX1ggPSAxOwogICAgICB0aGlzLkFYSVNfWSA9IDA7CgogICAgICB0aGlzLmRhdGFBdHRyaWJ1dGVNYXAgPSB7CiAgICAgICAgIm5leHQiOiAiYXNjZW5zb3ItbmV4dCIsCiAgICAgICAgInByZXYiOiAiYXNjZW5zb3ItcHJldiIsCiAgICAgICAgImRvd24iOiAiYXNjZW5zb3ItZG93biIsCiAgICAgICAgInVwIjogImFzY2Vuc29yLXVwIiwKICAgICAgICAibGVmdCI6ICJhc2NlbnNvci1sZWZ0IiwKICAgICAgICAicmlnaHQiOiAiYXNjZW5zb3ItcmlnaHQiCiAgICAgIH07CgogICAgICAvLyBTZXR1cCBnbG9iYWwgdmFyaWFibGUgLSBzZWxlY3RvciAKICAgICAgdGhpcy5ub2RlID0gJCh0aGlzLmVsZW1lbnQpOwogICAgICB0aGlzLm5vZGVDaGlsZHJlbiA9IHRoaXMubm9kZS5jaGlsZHJlbih0aGlzLm9wdGlvbnMuY2hpbGRUeXBlKTsKICAgICAgdGhpcy5mbG9vckFjdGl2ZSA9IChpc051bWJlcih0aGlzLl9nZXRGbG9vckZyb21IYXNoKCkpKSA/IHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSA6IHRoaXMub3B0aW9ucy53aW5kb3dzT247CgogICAgICB0aGlzLk5IID0gdGhpcy5ub2RlLmhlaWdodCgpOwogICAgICB0aGlzLk5XID0gdGhpcy5ub2RlLndpZHRoKCk7CgogICAgICAvLyBTZXR1cCBnbG9iYWwgdmFyaWFibGUgLSBoZWxwZXIKICAgICAgdmFyIGFuZHJvaWRDb21wYXRpYmxlID0gdHJ1ZTsKICAgICAgdmFyIHZlcnNpb24gPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9BbmRyb2lkXHMrKFtcZFwuXSspLyk7CiAgICAgIGlmICh2ZXJzaW9uKSBhbmRyb2lkQ29tcGF0aWJsZSA9IHBhcnNlRmxvYXQodmVyc2lvblsxXSkgPiAzOwoKCiAgICAgIHRoaXMuZGlyZWN0aW9uSXNBcnJheSA9IGlzT2JqZWN0KHRoaXMub3B0aW9ucy5kaXJlY3Rpb24pOwogICAgICB0aGlzLnN1cHBvcnRUcmFuc2Zvcm0gPSBoYXMzZCgpICYmIGFuZHJvaWRDb21wYXRpYmxlOwoKCgogICAgICAvLyBDaGVjayBpZiBmbG9vciBuYW1lIGFycmF5ICYgbm9kZSBjaGlsZHJlbiBsZW5ndGggbWF0Y2gKICAgICAgaWYgKGlzT2JqZWN0KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSkgJiYgdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLmxlbmd0aCA8IHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0Q29uc29sZU1lc3NhZ2UoImVycm9yIiwgImZsb29ycyB0b3RhbCAoIiArIHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCArICIpICYgZmxvb3IgbmFtZSBhcnJheSBsZW5ndGggKCIgKyB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUubGVuZ3RoICsgIikgZG9uJ3QgbWF0Y2giKTsKICAgICAgfQoKICAgICAgLy8gQ2hlY2sgaWYgZGlyZWN0aW9uIGFycmF5ICYgbm9kZSBjaGlsZHJlbiBsZW5ndGggbWF0Y2gKICAgICAgaWYgKHRoaXMuZGlyZWN0aW9uSXNBcnJheSAmJiB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uLmxlbmd0aCA8IHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0Q29uc29sZU1lc3NhZ2UoImVycm9yIiwgImZsb29ycyB0b3RhbCAoIiArIHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCArICIpICYgZGlyZWN0aW9uIGFycmF5IGxlbmdodCAoIiArIHRoaXMub3B0aW9ucy5kaXJlY3Rpb24ubGVuZ3RoICsgIikgZG9uJ3QgbWF0Y2giKTsKICAgICAgfQoKICAgICAgLy8gU3RhcnQgdGhlIG1hZ2ljCiAgICAgIHRoaXMuc2V0dXAoKTsKCiAgICB9LAoKCiAgICAvKiBNYWdpYyAqLwogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9wb3NpdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5fYmluZEV2ZW50cygpOwogICAgICB0aGlzLnNjcm9sbFRvRmxvb3IodGhpcy5mbG9vckFjdGl2ZSk7CgogICAgICBpZiAoaXNPYmplY3QodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lKSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5mbG9vckFjdGl2ZSk7CiAgICAgIH0KICAgICAgaWYgKGlzRnVuY3Rpb24odGhpcy5vcHRpb25zLnJlYWR5KSkgdGhpcy5vcHRpb25zLnJlYWR5KCk7CiAgICB9LAoKCiAgICAvKiBTZXR1cCBVc2VyIGxpc3RlbmVyICovCiAgICBfYmluZEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIHRoaXMubm9kZS5vbignc2Nyb2xsVG9EaXJlY3Rpb24nLCBmdW5jdGlvbihldmVudCwgZGlyZWN0aW9uKSB7CiAgICAgICAgc2VsZi5zY3JvbGxUb0RpcmVjdGlvbihkaXJlY3Rpb24pOwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbignc2Nyb2xsVG9TdGFnZScsIGZ1bmN0aW9uKGV2ZW50LCBmbG9vcikgewogICAgICAgIGlmICh0eXBlb2YgZmxvb3IgPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHZhciBmbG9vcklkID0gJC5pbkFycmF5KGZsb29yLCBzZWxmLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUpOwogICAgICAgICAgaWYgKGZsb29ySWQgIT09IC0xKSBzZWxmLnNjcm9sbFRvRmxvb3IoZmxvb3JJZCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZmxvb3IgPT0gJ251bWJlcicpIHsKICAgICAgICAgIGlmIChmbG9vciA+IHNlbGYubm9kZUNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuOwogICAgICAgICAgc2VsZi5zY3JvbGxUb0Zsb29yKGZsb29yKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlLm9uKCduZXh0JywgZnVuY3Rpb24oZXZlbnQsIGZsb29yKSB7CiAgICAgICAgdmFyIGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24gPSBzZWxmLm5vZGVDaGlsZHJlbi5lcShzZWxmLmZsb29yQWN0aXZlKS5kYXRhKHNlbGYuZGF0YUF0dHJpYnV0ZU1hcC5uZXh0KTsKICAgICAgICBpZiAoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbikgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihkYXRhQXR0cmlidXRlRGlyZWN0aW9uKTsKICAgICAgICBzZWxmLm5leHQoKTsKICAgICAgfSk7CgogICAgICB0aGlzLm5vZGUub24oJ3ByZXYnLCBmdW5jdGlvbihldmVudCwgZmxvb3IpIHsKICAgICAgICB2YXIgZGF0YUF0dHJpYnV0ZURpcmVjdGlvbiA9IHNlbGYubm9kZUNoaWxkcmVuLmVxKHNlbGYuZmxvb3JBY3RpdmUpLmRhdGEoc2VsZi5kYXRhQXR0cmlidXRlTWFwLnByZXYpOwogICAgICAgIGlmIChkYXRhQXR0cmlidXRlRGlyZWN0aW9uKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGRhdGFBdHRyaWJ1dGVEaXJlY3Rpb24pOwogICAgICAgIHNlbGYucHJldigpOwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbigncmVmcmVzaCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYucmVmcmVzaCgpOwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZS5vbigncmVtb3ZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5kZXN0cm95KCk7CiAgICAgIH0pOwoKICAgICAgLy8gc2V0dXAgcmVzaXplICYga2V5IGxpc3RlbmVyCiAgICAgICQod2luZG93KS5vbigncmVzaXplLmFzY2Vuc29yJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBzZWxmLnNjcm9sbFRvRmxvb3Ioc2VsZi5mbG9vckFjdGl2ZSwgZmFsc2UpOwogICAgICB9KTsKCiAgICAgIC8vIElmIGZsb29yTmFtZSwgYWRkIGhhc2hjaGFuZ2UgbGlzdGVuZXIKICAgICAgaWYgKGlzT2JqZWN0KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSkpIHsKICAgICAgICAkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UuYXNjZW5zb3InLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgc2VsZi5faGFzaGNoYW5nZUhhbmRsZXIoZXZlbnQpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICAvLyBEZXRlY3Qgb3JpZW50YXRpb24gY2hhbmdlLCBmb3IgZGV2aWNlCiAgICAgIGlmICh3aW5kb3cuRGV2aWNlT3JpZW50YXRpb25FdmVudCkgewogICAgICAgICQod2luZG93KS5vbignb3JpZW50YXRpb25jaGFuZ2UuYXNjZW5zb3InLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JBY3RpdmUpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLmtleU5hdmlnYXRpb24pIHsKICAgICAgICAkKGRvY3VtZW50KS5vbigna2V5ZG93bi5hc2NlbnNvcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzZWxmLl9rZXlwcmVzc0hhbmRsZXIoZXZlbnQpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLndoZWVsTmF2aWdhdGlvbikgewogICAgICAgIHRoaXMubm9kZS5vbignbW91c2V3aGVlbC5hc2NlbnNvcicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghc2VsZi5zY3JvbGxJbkNoaWxkcmVuKSBzZWxmLl9oYW5kbGVNb3VzZVdoZWVsRXZlbnQoZSk7CiAgICAgICAgICB9LCAxMCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMubm9kZUNoaWxkcmVuLm9uKCdzY3JvbGwuYXNjZW5zb3InLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLnNjcm9sbEluQ2hpbGRyZW4gPSB0cnVlOwogICAgICAgICAgaWYgKHNlbGYuc2Nyb2xsVGltZU91dCkgY2xlYXJUaW1lb3V0KHNlbGYuc2Nyb2xsVGltZU91dCk7CiAgICAgICAgICBzZWxmLnNjcm9sbFRpbWVPdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLnNjcm9sbEluQ2hpbGRyZW4gPSBmYWxzZTsKICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIElmIHN3aXBlIGV2ZW50IG9wdGlvbiBpcyB0cnVlIHx8IHN0cmluZwogICAgICBpZiAodGhpcy5vcHRpb25zLnN3aXBlTmF2aWdhdGlvbikgewoKICAgICAgICB2YXIgdG91Y2hFdmVudCA9ICd0b3VjaHN0YXJ0LmFzY2Vuc29yIHRvdWNoZW5kLmFzY2Vuc29yIHRvdWNoY2FuY2VsLmFzY2Vuc29yJzsKCiAgICAgICAgLy8gSWYgbW9iaWxlLW9ubHksIG9ubHkgdXNlIHRvdWNoc3RhcnQvZW5kIGV2ZW50CQkJCQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc3dpcGVOYXZpZ2F0aW9uICE9PSAnbW9iaWxlLW9ubHknKSB0b3VjaEV2ZW50ICs9ICcgbW91c2Vkb3duLmFzY2Vuc29yIG1vdXNldXAuYXNjZW5zb3InOwoKICAgICAgICAvLyBMaXN0ZW4gdG8gdG91Y2ggZXZlbnQKICAgICAgICB0aGlzLm5vZGUub24odG91Y2hFdmVudCwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNlbGYuX2hhbmRsZVRvdWNoRXZlbnQoZXZlbnQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIHJlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vZGVDaGlsZHJlbiA9IHRoaXMubm9kZS5jaGlsZHJlbih0aGlzLm9wdGlvbnMuY2hpbGRUeXBlKTsKICAgICAgdGhpcy5fcG9zaXRpb25FbGVtZW50KCk7CiAgICB9LAoKICAgIC8qIFJlbW92ZSBtZXRob2QqLwogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAvLyBVbmJpbmQgYWxsIGJpbmRlZCBldmVudAogICAgICB0aGlzLm5vZGVDaGlsZHJlbi5vZmYoJ3Njcm9sbC5hc2NlbnNvcicpOwogICAgICB0aGlzLm5vZGUub2ZmKCdtb3VzZXdoZWVsLmFzY2Vuc29yIHNjcm9sbFRvRGlyZWN0aW9uIHNjcm9sbFRvU3RhZ2UgbmV4dCBwcmV2IHJlZnJlc2ggcmVtb3ZlIHRvdWNoc3RhcnQuYXNjZW5zb3IgdG91Y2hlbmQuYXNjZW5zb3IgbW91c2Vkb3duLmFzY2Vuc29yIG1vdXNldXAuYXNjZW5zb3IgdG91Y2hjYW5jZWwuYXNjZW5zb3InKTsKICAgICAgJCh3aW5kb3cpLm9mZigncmVzaXplLmFzY2Vuc29yIGhhc2hjaGFuZ2UuYXNjZW5zb3Igb3JpZW50YXRpb25jaGFuZ2UuYXNjZW5zb3InKTsKICAgICAgJChkb2N1bWVudCkub2ZmKCdrZXlkb3duLmFzY2Vuc29yJyk7CgogICAgICAvLyBSZW1vdmUgY3NzCiAgICAgIHRoaXMubm9kZS5jc3MoewogICAgICAgICdwb3NpdGlvbic6ICcnLAogICAgICAgICdvdmVyZmxvdyc6ICcnLAogICAgICAgICd0b3AnOiAnJywKICAgICAgICAnbGVmdCc6ICcnLAogICAgICAgICd3aWR0aCc6ICcnLAogICAgICAgICdoZWlnaHQnOiAnJwogICAgICB9KTsKCiAgICAgIHRoaXMubm9kZUNoaWxkcmVuLmNzcyh7CiAgICAgICAgJ3Bvc2l0aW9uJzogJycsCiAgICAgICAgJ292ZXJmbG93JzogJycsCiAgICAgICAgJ3RvcCc6ICcnLAogICAgICAgICdsZWZ0JzogJycsCiAgICAgICAgJ3dpZHRoJzogJycsCiAgICAgICAgJ2hlaWdodCc6ICcnLAogICAgICAgICd0cmFuc2Zvcm0nOiAnJwogICAgICB9KTsKCiAgICAgIC8vIFJlbW92ZSBwbHVnaW4gaW5zdGFuY2UKICAgICAgdGhpcy5ub2RlLnJlbW92ZURhdGEoKTsKICAgIH0sCgogICAgX2hhbmRsZU1vdXNlV2hlZWxFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgaWYgKHRoaXMubm9kZS5pcygnOmFuaW1hdGVkJykpIHJldHVybjsKCiAgICAgIHRoaXMuc2Nyb2xsVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgaWYgKCF0aGlzLmxhc3RTY3JvbGxUaW1lIHx8IHRoaXMuc2Nyb2xsVGltZSAtIHRoaXMubGFzdFNjcm9sbFRpbWUgPiB0aGlzLm9wdGlvbnMud2hlZWxOYXZpZ2F0aW9uRGVsYXkpIHsKICAgICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gdGhpcy5zY3JvbGxUaW1lOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5sYXN0U2Nyb2xsVGltZSA9IHRoaXMuc2Nyb2xsVGltZTsKCiAgICAgIHZhciBtb3VzZVggPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGFYOwogICAgICB2YXIgbW91c2VZID0gZXZlbnQub3JpZ2luYWxFdmVudC53aGVlbERlbHRhWTsKCiAgICAgIGlmIChNYXRoLmFicyhtb3VzZVgpID4gTWF0aC5hYnMobW91c2VZKSAmJiBtb3VzZVggPiAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdsZWZ0Jyk7CiAgICAgIGlmIChNYXRoLmFicyhtb3VzZVgpID4gTWF0aC5hYnMobW91c2VZKSAmJiBtb3VzZVggPCAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdyaWdodCcpOwogICAgICBpZiAoTWF0aC5hYnMobW91c2VZKSA+IE1hdGguYWJzKG1vdXNlWCkgJiYgbW91c2VZID4gMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbigndXAnKTsKICAgICAgaWYgKE1hdGguYWJzKG1vdXNlWSkgPiBNYXRoLmFicyhtb3VzZVgpICYmIG1vdXNlWSA8IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ2Rvd24nKTsKCiAgICB9LAoKCiAgICAvKiBUb3VjaCBldmVudCBoYW5kbGVyICovCiAgICBfaGFuZGxlVG91Y2hFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHsKCiAgICAgICAgLy8gT24gdG91Y2gvbW91c2UgZG93bgogICAgICAgIGNhc2UgJ3RvdWNoc3RhcnQnOgogICAgICAgIGNhc2UgJ21vdXNlZG93bic6CgogICAgICAgICAgLy8gc2F2ZSB0aW1lICYgb3JpZ2luYWwgcG9zaXRpb24gZm9yIFgvWQogICAgICAgICAgdGhpcy50b3VjaFN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdGhpcy50b3VjaFN0YXJ0WCA9IChldmVudC50eXBlID09ICd0b3VjaHN0YXJ0JykgPyBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5wYWdlWDsKICAgICAgICAgIHRoaXMudG91Y2hTdGFydFkgPSAoZXZlbnQudHlwZSA9PSAndG91Y2hzdGFydCcpID8gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWzBdLnBhZ2VZIDogZXZlbnQucGFnZVk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgICAvLyBPbiB0b3VjaC9tb3VzZWRvd24KICAgICAgICBjYXNlICd0b3VjaGVuZCc6CiAgICAgICAgY2FzZSAndG91Y2hjYW5jZWwnOgogICAgICAgIGNhc2UgJ21vdXNldXAnOgoKICAgICAgICAgIC8vIFNhdmUgdGltZSAmIGZpbmFsIHBvc2l0aW9uIGZvciBYL1kKICAgICAgICAgIHRoaXMudG91Y2hFbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICB0aGlzLnRvdWNoRW5kWCA9IChldmVudC50eXBlID09ICd0b3VjaGVuZCcgfHwgZXZlbnQudHlwZSA9PSAndG91Y2hjYW5jZWwnKSA/IGV2ZW50Lm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5wYWdlWDsKICAgICAgICAgIHRoaXMudG91Y2hFbmRZID0gKGV2ZW50LnR5cGUgPT0gJ3RvdWNoZW5kJyB8fCBldmVudC50eXBlID09ICd0b3VjaGNhbmNlbCcpID8gZXZlbnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWSA6IGV2ZW50LnBhZ2VZOwoKICAgICAgICAgIC8vIGNhbGN1bGF0ZSBkaXN0YW5jZSwgZHVyYXRpb24gJiB2ZWxvY2l0eS4KICAgICAgICAgIHZhciBkaXN0YW5jZVggPSB0aGlzLnRvdWNoU3RhcnRYIC0gdGhpcy50b3VjaEVuZFg7CiAgICAgICAgICB2YXIgZGlzdGFuY2VZID0gdGhpcy50b3VjaFN0YXJ0WSAtIHRoaXMudG91Y2hFbmRZOwogICAgICAgICAgdmFyIGR1cmF0aW9uID0gdGhpcy50b3VjaEVuZFRpbWUgLSB0aGlzLnRvdWNoU3RhcnRUaW1lOwogICAgICAgICAgdmFyIHZlbG9jaXR5WCA9IE1hdGguYWJzKGRpc3RhbmNlWCkgLyBkdXJhdGlvbjsKICAgICAgICAgIHZhciB2ZWxvY2l0eVkgPSBNYXRoLmFicyhkaXN0YW5jZVkpIC8gZHVyYXRpb247CgogICAgICAgICAgLy8gSWYgdmVsb2NpdHksIHVzZSBhYnNvbHV0ZSBkaXN0YW5jZSB0byBkZXRlcm1pbmUgYXhpcwogICAgICAgICAgLy8gYW5kIGNvbXBhcmUgZGlzdGFuY2UgdG8gMCBkZXRlcm1pbmUgZGlyZWN0aW9uCiAgICAgICAgICBpZiAodmVsb2NpdHlYID4gdGhpcy5vcHRpb25zLnN3aXBlVmVsb2NpdHkgJiYgTWF0aC5hYnMoZGlzdGFuY2VYKSA+IE1hdGguYWJzKGRpc3RhbmNlWSkgJiYgZGlzdGFuY2VYIDwgMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbignbGVmdCcpOwogICAgICAgICAgaWYgKHZlbG9jaXR5WCA+IHRoaXMub3B0aW9ucy5zd2lwZVZlbG9jaXR5ICYmIE1hdGguYWJzKGRpc3RhbmNlWCkgPiBNYXRoLmFicyhkaXN0YW5jZVkpICYmIGRpc3RhbmNlWCA+IDApIHRoaXMuc2Nyb2xsVG9EaXJlY3Rpb24oJ3JpZ2h0Jyk7CiAgICAgICAgICBpZiAodmVsb2NpdHlZID4gdGhpcy5vcHRpb25zLnN3aXBlVmVsb2NpdHkgJiYgTWF0aC5hYnMoZGlzdGFuY2VYKSA8IE1hdGguYWJzKGRpc3RhbmNlWSkgJiYgZGlzdGFuY2VZIDwgMCkgdGhpcy5zY3JvbGxUb0RpcmVjdGlvbigndXAnKTsKICAgICAgICAgIGlmICh2ZWxvY2l0eVkgPiB0aGlzLm9wdGlvbnMuc3dpcGVWZWxvY2l0eSAmJiBNYXRoLmFicyhkaXN0YW5jZVgpIDwgTWF0aC5hYnMoZGlzdGFuY2VZKSAmJiBkaXN0YW5jZVkgPiAwKSB0aGlzLnNjcm9sbFRvRGlyZWN0aW9uKCdkb3duJyk7CgogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0sCgoKCiAgICAvKiBQb3NpdGlvbiBmbG9vciBvbiBkb20gKi8KICAgIF9wb3NpdGlvbkVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLmRpcmVjdGlvbklzQXJyYXkpIHRoaXMuX2dlbmVyYXRlRmxvb3JNYXAoKTsKCiAgICAgIC8vIFNldHVwIGZsb29yIHNpemUgJiBwb3NpdGlvbgogICAgICB0aGlzLm5vZGUuY3NzKHsKICAgICAgICAncG9zaXRpb24nOiAnYWJzb2x1dGUnLAogICAgICAgICdvdmVyZmxvdyc6ICdoaWRkZW4nLAogICAgICAgICd0b3AnOiAnMCcsCiAgICAgICAgJ2xlZnQnOiAnMCcsCiAgICAgICAgJ3dpZHRoJzogdGhpcy5vcHRpb25zLndpZHRoLAogICAgICAgICdoZWlnaHQnOiB0aGlzLm9wdGlvbnMuaGVpZ2h0CiAgICAgIH0pOwoKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4uY3NzKHsKICAgICAgICAncG9zaXRpb24nOiAnYWJzb2x1dGUnLAogICAgICAgICdvdmVyZmxvdyc6ICdhdXRvJywKICAgICAgICAndG9wJzogJzAnLAogICAgICAgICdsZWZ0JzogJzAnLAogICAgICAgICd3aWR0aCc6ICcxMDAlJywKICAgICAgICAnaGVpZ2h0JzogJzEwMCUnCiAgICAgIH0pOwoKICAgICAgLy8gcGxhY2UgZWxlbWVudCBjb3JyZWN0bHkKICAgICAgdGhpcy5ub2RlQ2hpbGRyZW4uZWFjaChmdW5jdGlvbihpbmRleCkgewogICAgICAgIGlmIChzZWxmLnN1cHBvcnRUcmFuc2Zvcm0pIHsKICAgICAgICAgICQodGhpcykuY3NzKHsKICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneScpIHJldHVybiAndHJhbnNsYXRlWSgnICsgaW5kZXggKiAxMDAgKyAnJSknOwogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09PSAneCcpIHJldHVybiAndHJhbnNsYXRlWCgnICsgaW5kZXggKiAxMDAgKyAnJSknOwogICAgICAgICAgICAgIGlmIChzZWxmLmRpcmVjdGlvbklzQXJyYXkpIHJldHVybiAndHJhbnNsYXRlWSgnICsgc2VsZi5vcHRpb25zLmRpcmVjdGlvbltpbmRleF1bc2VsZi5BWElTX1ldICogMTAwICsgJyUpIHRyYW5zbGF0ZVgoJyArIHNlbGYub3B0aW9ucy5kaXJlY3Rpb25baW5kZXhdW3NlbGYuQVhJU19YXSAqIDEwMCArICclKSc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkKHRoaXMpLmNzcyh7CiAgICAgICAgICAgICd0b3AnOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3knKSByZXR1cm4gaW5kZXggKiAxMDAgKyAnJSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgcmV0dXJuIHNlbGYub3B0aW9ucy5kaXJlY3Rpb25baW5kZXhdW3NlbGYuQVhJU19ZXSAqIDEwMCArICclJzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2xlZnQnOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3gnKSByZXR1cm4gaW5kZXggKiAxMDAgKyAnJSc7CiAgICAgICAgICAgICAgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgcmV0dXJuIHNlbGYub3B0aW9ucy5kaXJlY3Rpb25baW5kZXhdW3NlbGYuQVhJU19YXSAqIDEwMCArICclJzsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgOiBSZXR1cm4gZmxvb3IgaW5kZXggZnJvbSBoYXNoLiAqLwogICAgX2dldEZsb29yRnJvbUhhc2g6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5fZ2V0SGFzaCgpKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSAmJiBleGlzdEluQXJyYXkodGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLCB0aGlzLl9nZXRIYXNoKCkpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLmFzY2Vuc29yRmxvb3JOYW1lLmluZGV4T2YodGhpcy5fZ2V0SGFzaCgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCgogICAgLyogSGVscGVyIDogUmV0dXJuIGZsb29yIGluZGV4IGZyb20gaGFzaC4gKi8KICAgIF9nZXRIYXNoOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoKSB7CiAgICAgICAgdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdCgnIycpLnBvcCgpOwogICAgICAgIHJldHVybiBoYXNoOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgoKICAgIC8qIEhhbmxkZXI6IEhhbmRsZSB3aW5kb3cgaGFzaGNhbmdlIGV2ZW50ICovCiAgICBfaGFzaGNoYW5nZUhhbmRsZXI6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGlmIChpc051bWJlcih0aGlzLl9nZXRGbG9vckZyb21IYXNoKCkpICYmIHRoaXMuX2dldEZsb29yRnJvbUhhc2goKSAhPT0gdGhpcy5mbG9vckFjdGl2ZSAmJiAhdGhpcy5ub2RlLmlzKCc6YW5pbWF0ZWQnKSkgewogICAgICAgIHRoaXMuc2Nyb2xsVG9GbG9vcih0aGlzLl9nZXRGbG9vckZyb21IYXNoKCkpOwogICAgICB9CiAgICB9LAoKCiAgICAvKiBXaWxsIHVwZGF0ZSBoYXNoIGxvY2F0aW9uIGlmIGZsb29yIG5hbWUgYXJlIHNldHVwLiAqLwogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGZsb29ySW5kZXgpIHsKICAgICAgaWYgKGlzT2JqZWN0KHRoaXMub3B0aW9ucy5hc2NlbnNvckZsb29yTmFtZSkgJiYgdGhpcy5fZ2V0SGFzaCgpICE9PSB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWVbZmxvb3JJbmRleF0pIHsKICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZSgoJycgKyB3aW5kb3cubG9jYXRpb24pLnNwbGl0KCcjJylbMF0gKyAnIycgKyB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWVbZmxvb3JJbmRleF0pOwogICAgICB9CiAgICB9LAoKCiAgICAvKiBFdmVudCBoZWxwZXIsIGxldCBhc2NlbnNvciBjcmVhdGUgb3duIGV2ZW50LCB3aXRoIGZsb29yIGluZm9ybWF0aW9uICovCiAgICBfZW1pdEV2ZW50OiBmdW5jdGlvbihldmVudE5hbWUsIGZyb20sIHRvKSB7CiAgICAgIHRoaXMubm9kZS50cmlnZ2VyKGV2ZW50TmFtZSwgZmxvb3IgPSB7CiAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICB0bzogdG8KICAgICAgfSk7CiAgICB9LAoKCiAgICAvKiBXYXJuIGhhbmRsZXIgKi8KICAgIF9lbWl0Q29uc29sZU1lc3NhZ2U6IGZ1bmN0aW9uKHR5cGUsIHdhcm4pIHsKICAgICAgaWYgKHR5cGUgPT0gImVycm9yIikgY29uc29sZS5lcnJvcigiQXNjZW5zb3IuanM6ICIgKyB3YXJuKTsKICAgICAgaWYgKHR5cGUgPT0gIndhcm4iKSBjb25zb2xlLndhcm4oIkFzY2Vuc29yLmpzOiAiICsgd2Fybik7CiAgICB9LAoKCiAgICAvKiBLZXlwcmVzcyBIYW5kbGVyICovCiAgICBfa2V5cHJlc3NIYW5kbGVyOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGtleSA9IGUua2V5Q29kZSB8fCBlLndoaWNoOwogICAgICBpZiAoISQoJ2lucHV0LCB0ZXh0YXJlYSwgYnV0dG9uJykuaXMoJzpmb2N1cycpKSB7CiAgICAgICAgc3dpdGNoIChrZXkpIHsKICAgICAgICAgIGNhc2UgNDA6CiAgICAgICAgICBjYXNlIDgzOgogICAgICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKCdkb3duJyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzODoKICAgICAgICAgIGNhc2UgODc6CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG9EaXJlY3Rpb24oJ3VwJyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzc6CiAgICAgICAgICBjYXNlIDY1OgogICAgICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKCdsZWZ0Jyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzk6CiAgICAgICAgICBjYXNlIDY4OgogICAgICAgICAgICBzZWxmLnNjcm9sbFRvRGlyZWN0aW9uKCdyaWdodCcpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgoKICAgIC8qIFJlc2l6ZSBoYW5kbGVyLiBVcGRhdGUgc2Nyb2xsVG9wICYgc2Nyb2xsTGVmdCBwb3NpdGlvbiAqLwogICAgc2Nyb2xsVG9GbG9vcjogZnVuY3Rpb24oZmxvb3IpIHsKCiAgICAgIC8vIElmIGZsb29yIHNlbmQgaXMgYSB0cmluZywgY2hlY2sgaWYgaXQgbWF0Y2ggYW55IG9mIGFzY2Vuc29yRmxvb3JOYW1lLCB0aGVuIHVzZSBwb2lzdGlvbiBpbiBhcnJheQogICAgICBpZiAoaXNTdHJpbmcoZmxvb3IpICYmIGV4aXN0SW5BcnJheSh0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUsIGZsb29yKSkgZmxvb3IgPSB0aGlzLm9wdGlvbnMuYXNjZW5zb3JGbG9vck5hbWUuaW5kZXhPZihmbG9vcik7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhbmltYXRlID0gKGZsb29yID09PSB0aGlzLmZsb29yQWN0aXZlKSA/IGZhbHNlIDogdHJ1ZTsKCiAgICAgIGlmICh0aGlzLk5XICE9PSB0aGlzLm5vZGUud2lkdGgoKSkgdGhpcy5OVyA9IHRoaXMubm9kZS53aWR0aCgpOwogICAgICBpZiAodGhpcy5OSCAhPT0gdGhpcy5ub2RlLmhlaWdodCgpKSB0aGlzLk5IID0gdGhpcy5ub2RlLmhlaWdodCgpOwoKICAgICAgLy8gTWFrZSBzdXJlIHBvc2l0aW9uIGlzIGNvcnJlY3QKICAgICAgdmFyIGFuaW1hdGlvbk9iamVjdCA9IHRoaXMuX2dldEFuaW1hdGlvblNldHRpbmdzKGZsb29yKTsKCiAgICAgIGlmIChhbmltYXRlKSB7CiAgICAgICAgdGhpcy5fZW1pdEV2ZW50KCdzY3JvbGxTdGFydCcsIHNlbGYuZmxvb3JBY3RpdmUsIGZsb29yKTsKICAgICAgICB0aGlzLm5vZGUuc3RvcCgpLmFuaW1hdGUoYW5pbWF0aW9uT2JqZWN0LnByb3BlcnR5LCBzZWxmLm9wdGlvbnMudGltZSwgc2VsZi5vcHRpb25zLmVhc2luZywgYW5pbWF0aW9uT2JqZWN0LmNhbGxiYWNrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm5vZGUuc3RvcCgpLnNjcm9sbFRvcChhbmltYXRpb25PYmplY3QuZGVmYXVsdHMuc2Nyb2xsVG9wKS5zY3JvbGxMZWZ0KGFuaW1hdGlvbk9iamVjdC5kZWZhdWx0cy5zY3JvbGxMZWZ0KTsKICAgICAgfQoKICAgICAgdGhpcy5mbG9vckFjdGl2ZSA9IGZsb29yOwogICAgICB0aGlzLm5vZGUuZGF0YSgnY3VycmVudC1mbG9vcicsIHRoaXMuZmxvb3JBY3RpdmUpOwoKICAgIH0sCgoKICAgIC8qIFByZXYgZnVuY3Rpb24gKi8KICAgIHByZXY6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0Rmxvb3IgPSB0aGlzLmZsb29yQWN0aXZlIC0gMTsKICAgICAgaWYgKHRhcmdldEZsb29yIDwgMCkgewogICAgICAgIGlmICghdGhpcy5vcHRpb25zLmxvb3ApIHJldHVybjsKICAgICAgICB0YXJnZXRGbG9vciA9IHRoaXMubm9kZUNoaWxkcmVuLmxlbmd0aCAtIDE7CiAgICAgIH0KICAgICAgdGhpcy5zY3JvbGxUb0Zsb29yKHRhcmdldEZsb29yKTsKICAgIH0sCgoKICAgIC8qIFByZXYgZnVuY3Rpb24gKi8KICAgIG5leHQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0Rmxvb3IgPSB0aGlzLmZsb29yQWN0aXZlICsgMTsKICAgICAgaWYgKHRhcmdldEZsb29yID4gdGhpcy5ub2RlQ2hpbGRyZW4ubGVuZ3RoIC0gMSkgewogICAgICAgIGlmICghdGhpcy5vcHRpb25zLmxvb3ApIHJldHVybjsKICAgICAgICB0YXJnZXRGbG9vciA9IDA7CiAgICAgIH0KCiAgICAgIHRoaXMuc2Nyb2xsVG9GbG9vcih0YXJnZXRGbG9vcik7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgdG8gZ2VuZXJhdGUgYW5pbWF0aW9uIHNldHRpbmdzICovCiAgICBfZ2V0QW5pbWF0aW9uU2V0dGluZ3M6IGZ1bmN0aW9uKGZsb29yKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIHNhdmVGbG9vckFjdGl2ZSA9IHNlbGYuZmxvb3JBY3RpdmU7CiAgICAgIC8vIENyZWF0ZSBhbmltYXRpb24gc2V0dGluZyBvYmplY3QKICAgICAgdmFyIGFuaW1hdGlvblNldHRpbmdzID0gewogICAgICAgIHByb3BlcnR5OiB7fSwKICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLl9lbWl0RXZlbnQoJ3Njcm9sbEVuZCcsIHNhdmVGbG9vckFjdGl2ZSwgZmxvb3IpOwogICAgICAgICAgc2VsZi5fdXBkYXRlSGFzaChmbG9vcik7CiAgICAgICAgfSwKICAgICAgICBkZWZhdWx0czoge30KICAgICAgfTsKCgogICAgICAvLyBDcmVhdGUgYSBzZWNvbmQgc2V0dGluZyBvYmplY3QKICAgICAgLy8gaW4gY2FzZSB0aGUgcXVldWVkIG9wdGlvbiBpcyBzZXQKICAgICAgdmFyIHNlY29uZEFuaW1hdGlvblNldHRpbmdzID0gewogICAgICAgIHByb3BlcnR5OiB7fSwKICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLl9lbWl0RXZlbnQoJ3Njcm9sbEVuZCcsIHNhdmVGbG9vckFjdGl2ZSwgZmxvb3IpOwogICAgICAgICAgc2VsZi5fdXBkYXRlSGFzaChmbG9vcik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuZGVmYXVsdHMuc2Nyb2xsVG9wID0gZmxvb3IgKiBzZWxmLk5IOwogICAgICBhbmltYXRpb25TZXR0aW5ncy5kZWZhdWx0cy5zY3JvbGxMZWZ0ID0gZmxvb3IgKiBzZWxmLk5XOwoKICAgICAgLy8gSWYgZGlyZWN0aW9uIGlzIHZlcnRpY2FsCiAgICAgIC8vID0+IHNldCBzY3JvbGxUb3AgcHJvcGVydHkgJiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgaWYgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT09ICd5JykgewogICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbFRvcCA9IGZsb29yICogc2VsZi5OSDsKICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgIH0KCgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgaG9yaXpvbnRhbAkKICAgICAgLy8gPT4gc2V0IHNjcm9sbGxlZnQgcHJvcGVydHkgJiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgZWxzZSBpZiAoc2VsZi5vcHRpb25zLmRpcmVjdGlvbiA9PT0gJ3gnKSB7CiAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IGZsb29yICogc2VsZi5OVzsKICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgIH0KCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyBhIG1hcAogICAgICBlbHNlIGlmIChzZWxmLmRpcmVjdGlvbklzQXJyYXkpIHsKCiAgICAgICAgLy8gPT4gU2F2ZSB2YWx1ZQogICAgICAgIHZhciBzY3JvbGxUb3BWYWx1ZSA9IHNlbGYub3B0aW9ucy5kaXJlY3Rpb25bZmxvb3JdW3NlbGYuQVhJU19ZXSAqIHNlbGYuTkg7CiAgICAgICAgdmFyIHNjcm9sbExlZnRWYWx1ZSA9IHNlbGYub3B0aW9ucy5kaXJlY3Rpb25bZmxvb3JdW3NlbGYuQVhJU19YXSAqIHNlbGYuTlc7CgogICAgICAgIGFuaW1hdGlvblNldHRpbmdzLmRlZmF1bHRzLnNjcm9sbFRvcCA9IHNjcm9sbFRvcFZhbHVlOwogICAgICAgIGFuaW1hdGlvblNldHRpbmdzLmRlZmF1bHRzLnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CgoKICAgICAgICAvLyBJZiB0aGUgcXVldWVkIG9wdGlvbiBpcyBzZXQKICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnF1ZXVlZCkgewoKICAgICAgICAgIC8vID0+IENoZWNrIGZsb29yIHBvc2l0aW9uLCB0byBhdm9pZCBhbmltYXRpb24gaWYgYWxyZWFkeSBvbiBzYW1lIGZsb29yCiAgICAgICAgICB2YXIgc2FtZVhwb3NpdGlvbiA9IHRoaXMubm9kZS5zY3JvbGxMZWZ0KCkgPT09IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgIHZhciBzYW1lWXBvc2l0aW9uID0gdGhpcy5ub2RlLnNjcm9sbFRvcCgpID09PSBzY3JvbGxUb3BWYWx1ZTsKCgogICAgICAgICAgLy8gSWYgcXVldWVkIGRpcmVjdGlvbiBpcyBob3Jpem9udGFsICYgb24gdGhlIHNhbWUgZmxvb3IKICAgICAgICAgIC8vID0+IFNldCBzY3JvbGxUb3AgcHJvcGVydHkgJiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMucXVldWVkID09PSAneCcgJiYgc2FtZVhwb3NpdGlvbikgewogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxUb3AgPSBzY3JvbGxUb3BWYWx1ZTsKICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyBJZiBxdWV1ZWQgZGlyZWN0aW9uIGlzIGhvcml6b250YWwgJiBOT1Qgb24gdGhlIHNhbWUgZmxvb3IKICAgICAgICAgIC8vID0+IFNldCBzY3JvbGxMZWZ0IHByb3BlcnR5CiAgICAgICAgICAvLyA9PiBTZXQgY2FsbGJhY2sgdG8gYSBzZWNvbmQgYW5pbWF0aW9uIChzY3JvbGxUb3ApCiAgICAgICAgICAvLyA9PiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgICBzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxUb3AgPSBzY3JvbGxUb3BWYWx1ZTsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLm5vZGUuc3RvcCgpLmFuaW1hdGUoc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHksIHNlbGYub3B0aW9ucy50aW1lLCBzZWxmLm9wdGlvbnMuZWFzaW5nLCBzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICAgIH0KCgogICAgICAgICAgLy8gSWYgcXVldWVkIGRpcmVjdGlvbiBpcyB2ZXJ0aWNhbCAmIG9uIHRoZSBzYW1lIGZsb29yCiAgICAgICAgICAvLyA9PiBTZXQgc2Nyb2xsVG9wIHNjcm9sbExlZnQgJiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMucXVldWVkID09PSAneScgJiYgc2FtZVlwb3NpdGlvbikgewogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdFZhbHVlOwogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIElmIHF1ZXVlZCBkaXJlY3Rpb24gaXMgdmVydGljYWwgJiBOT1Qgb24gdGhlIHNhbWUgZmxvb3IKICAgICAgICAgIC8vID0+IFNldCBzY3JvbGxUb3AgcHJvcGVydHkKICAgICAgICAgIC8vID0+IFNldCBjYWxsYmFjayB0byBhIHNlY29uZCBhbmltYXRpb24gKHNjcm9sbExlZnQpCiAgICAgICAgICAvLyA9PiByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3MKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxUb3AgPSBzY3JvbGxUb3BWYWx1ZTsKICAgICAgICAgICAgc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHkuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRWYWx1ZTsKICAgICAgICAgICAgYW5pbWF0aW9uU2V0dGluZ3MuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLm5vZGUuc3RvcCgpLmFuaW1hdGUoc2Vjb25kQW5pbWF0aW9uU2V0dGluZ3MucHJvcGVydHksIHNlbGYub3B0aW9ucy50aW1lLCBzZWxmLm9wdGlvbnMuZWFzaW5nLCBzZWNvbmRBbmltYXRpb25TZXR0aW5ncy5jYWxsYmFjayk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25TZXR0aW5nczsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICAvLyBJZiBxdWV1ZCBvcHRpb24gaXMgbm90IHNldCwgCiAgICAgICAgLy8gPT4gc2V0IHNjcm9sbFRvcCAmIFNjcm9sbExlZnQgcHJvcGVydHkgCiAgICAgICAgLy8gPT4gcmV0dXJuIGFuaW1hdGlvblNldHRpbmdzCiAgICAgICAgZWxzZSB7CiAgICAgICAgICBhbmltYXRpb25TZXR0aW5ncy5wcm9wZXJ0eS5zY3JvbGxUb3AgPSBzY3JvbGxUb3BWYWx1ZTsKICAgICAgICAgIGFuaW1hdGlvblNldHRpbmdzLnByb3BlcnR5LnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0VmFsdWU7CiAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gYW5pbWF0aW9uU2V0dGluZ3M7CiAgICB9LAoKCiAgICAvKiBIZWxwZXIgdG8gaGFuZGxlIGRpcmVjdGlvbiBjb3JyZWN0bHkuICovCiAgICBzY3JvbGxUb0RpcmVjdGlvbjogZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIElmIGEgZGF0YSBhdHRyaWJ1dGUgd2l0aCBjdXJyZW50IGRpcmVjdGlvbgogICAgICAvLyBpcyBmb3VuZCwgdXNlIGl0LgogICAgICB2YXIgZGF0YUF0dHJpYnV0ZURpcmVjdGlvbiA9IHRoaXMubm9kZUNoaWxkcmVuLmVxKHRoaXMuZmxvb3JBY3RpdmUpLmRhdGEodGhpcy5kYXRhQXR0cmlidXRlTWFwW2RpcmVjdGlvbl0pOwogICAgICBpZiAoZGF0YUF0dHJpYnV0ZURpcmVjdGlvbikgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihkYXRhQXR0cmlidXRlRGlyZWN0aW9uKTsKCgogICAgICB2YXIgZGlyZWN0aW9uSXNIb3Jpem9udGFsID0gKGRpcmVjdGlvbiA9PSAncmlnaHQnIHx8IGRpcmVjdGlvbiA9PSAnbGVmdCcpOwogICAgICB2YXIgZGlyZWN0aW9uSXNWZXJ0aWNhbCA9IChkaXJlY3Rpb24gPT0gJ2Rvd24nIHx8IGRpcmVjdGlvbiA9PSAndXAnKTsKCiAgICAgIC8vIElmIGRpcmVjdGlvbiBpcyB4IG9yIHkgYW5kIHRoZXJlIGlzIAogICAgICAvLyBkaXJlY3Rpb24gYXJlIG9wcHBzaXRlLCByZXR1cm4gaGVyZQogICAgICBpZiAoKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3knICYmIGRpcmVjdGlvbklzSG9yaXpvbnRhbCkgfHwgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3gnICYmIGRpcmVjdGlvbklzVmVydGljYWwpKSByZXR1cm47CgogICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgeCBvciB4LCBhbmQgCiAgICAgIC8vIGRpcmVjdGlvbiBtYXRjaCwgdXNlIHByZXYvbmV4dAogICAgICBpZiAoKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3knICYmIGRpcmVjdGlvbiA9PSAnZG93bicpIHx8IChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd4JyAmJiBkaXJlY3Rpb24gPT0gJ3JpZ2h0JykpIHJldHVybiBzZWxmLm5leHQoKTsKICAgICAgaWYgKChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uID09ICd5JyAmJiBkaXJlY3Rpb24gPT0gJ3VwJykgfHwgKHNlbGYub3B0aW9ucy5kaXJlY3Rpb24gPT0gJ3gnICYmIGRpcmVjdGlvbiA9PSAnbGVmdCcpKSByZXR1cm4gc2VsZi5wcmV2KCk7CgoKICAgICAgaWYgKHNlbGYuZGlyZWN0aW9uSXNBcnJheSkgewoKICAgICAgICB2YXIgZmxvb3JPYmplY3QgPSBzZWxmLmZsb29yTWFwW3NlbGYuZmxvb3JBY3RpdmVdOwoKICAgICAgICAvLyBJZiBleGlzdGluZywgcmV0dXJuIGFwcGVuZGluZyBmbG9vcgogICAgICAgIHZhciBkaXJlY3RGbG9vciA9IGZsb29yT2JqZWN0W2RpcmVjdGlvbl07CiAgICAgICAgaWYgKGlzTnVtYmVyKGRpcmVjdEZsb29yKSkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihkaXJlY3RGbG9vcik7CgogICAgICAgIC8vIEp1bXAgaXMgc2V0IHRvIHRydWUsIHVzZSB0aGUgCiAgICAgICAgLy8gY2xvc2VzdCBmbG9vciBpbiB0aGF0IHNhbWUgZGlyZWN0aW9uCiAgICAgICAgdmFyIGNsb3Nlc3RGbG9vciA9IGZsb29yT2JqZWN0LmNsb3Nlc3RbZGlyZWN0aW9uXTsKICAgICAgICBpZiAoaXNUcnVlKHNlbGYub3B0aW9ucy5qdW1wKSAmJiBpc051bWJlcihjbG9zZXN0Rmxvb3IpKSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGNsb3Nlc3RGbG9vcik7CgogICAgICAgIC8vIElmIGxvb3AgaXMgc2V0IHRvIHRydWUsIHVzZQogICAgICAgIC8vCXRoZSBmdXJ0aGVzdCBmbG9vcgogICAgICAgIHZhciBmdXJ0aGVzdEZsb29yID0gZmxvb3JPYmplY3QuZnVydGhlc3RbZGlyZWN0aW9uXTsKICAgICAgICBpZiAoaXNOdW1iZXIoZnVydGhlc3RGbG9vcikgJiYgKGlzVHJ1ZShzZWxmLm9wdGlvbnMubG9vcCkgfHwgKGRpcmVjdGlvbklzSG9yaXpvbnRhbCAmJiBzZWxmLm9wdGlvbnMubG9vcCA9PSAnbG9vcC14JykgfHwgKGRpcmVjdGlvbklzVmVydGljYWwgJiYgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2xvb3AteScpKSkgewogICAgICAgICAgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihmdXJ0aGVzdEZsb29yKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIEluY3JlbWVudCBleGlzdCAmIG9wdGlvbiBpcyBzZXQKICAgICAgICB2YXIgaW5jcmVtZW50Rmxvb3IgPSBmbG9vck9iamVjdC5pbmNyZW1lbnRbZGlyZWN0aW9uXTsKICAgICAgICBpZiAoaXNOdW1iZXIoaW5jcmVtZW50Rmxvb3IpKSB7CgogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQnIHx8IGRpcmVjdGlvbklzVmVydGljYWwgJiYgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC15JyB8fCBkaXJlY3Rpb25Jc0hvcml6b250YWwgJiYgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudC14JykgewogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKGluY3JlbWVudEZsb29yKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEp1bXAgZnJvbSBsYXN0IHRvIGZpcnN0IG9yIGZpcnN0IHRvIGxhc3QKICAgICAgICBpZiAoKHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQteCcgJiYgZGlyZWN0aW9uSXNIb3Jpem9udGFsKSB8fCBzZWxmLm9wdGlvbnMubG9vcCA9PSAnaW5jcmVtZW50JykgewogICAgICAgICAgaWYgKHNlbGYuZmxvb3JBY3RpdmUgPT0gc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF94KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuY2xvc2VzdF94KTsKICAgICAgICAgIGlmIChzZWxmLmZsb29yQWN0aXZlID09IHNlbGYuZmxvb3JNYXAuY2xvc2VzdF94KSByZXR1cm4gc2VsZi5zY3JvbGxUb0Zsb29yKHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHNlbGYub3B0aW9ucy5sb29wID09ICdpbmNyZW1lbnQteScgJiYgZGlyZWN0aW9uSXNWZXJ0aWNhbCkgfHwgc2VsZi5vcHRpb25zLmxvb3AgPT0gJ2luY3JlbWVudCcpIHsKICAgICAgICAgIGlmIChzZWxmLmZsb29yQWN0aXZlID09IHNlbGYuZmxvb3JNYXAuZnVydGhlc3RfeSkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeSk7CiAgICAgICAgICBpZiAoc2VsZi5mbG9vckFjdGl2ZSA9PSBzZWxmLmZsb29yTWFwLmNsb3Nlc3RfeSkgcmV0dXJuIHNlbGYuc2Nyb2xsVG9GbG9vcihzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3kpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCgoKICAgIC8qIEhlbHBlciB0byBnZXQgdGhlIGRpcmVjdCBhcHBlbmRpbmcgZmxvb3IgaW4gb25lIHByZWNpc2UgZGlyZWN0aW9uIGRpcmVjdGlvbiAqLwogICAgX2dldERpcmVjdEZsb29ySW5kZXg6IGZ1bmN0aW9uKERBLCBmbG9vckluZGV4LCBkaXJlY3Rpb24pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gQ3JlYXRlIGZsb29yIHRhcmdldCBhcnJheSBiYXNlIG9uIGZsb29yb2JqZWN0CiAgICAgIHZhciBmbG9vclRhcmdldCA9IFt0aGlzLm9wdGlvbnMuZGlyZWN0aW9uW2Zsb29ySW5kZXhdW3RoaXMuQVhJU19ZXSwgdGhpcy5vcHRpb25zLmRpcmVjdGlvbltmbG9vckluZGV4XVt0aGlzLkFYSVNfWF1dOwoKICAgICAgLy8gQWRqdXN0IG1hcCBkZXBlbmRpbmcgb24gZGlyZWN0aW9uCiAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ3JpZ2h0JykgZmxvb3JUYXJnZXRbdGhpcy5BWElTX1hdICs9IDE7CiAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ2xlZnQnKSBmbG9vclRhcmdldFt0aGlzLkFYSVNfWF0gLT0gMTsKICAgICAgaWYgKGRpcmVjdGlvbiA9PSAndXAnKSBmbG9vclRhcmdldFt0aGlzLkFYSVNfWV0gLT0gMTsKICAgICAgaWYgKGRpcmVjdGlvbiA9PSAnZG93bicpIGZsb29yVGFyZ2V0W3RoaXMuQVhJU19ZXSArPSAxOwoKICAgICAgLy8gbG9vcGFuZCBjb21wYXJlIGRpcmVjdGlvbiBtYXAKICAgICAgdmFyIGZsb29yVGFyZ2V0SW5kZXggPSBmYWxzZTsKICAgICAgJC5lYWNoKERBLCBmdW5jdGlvbihpbmRleCwgbWFwKSB7CgogICAgICAgIC8vIElmIGN1cnJlbnQgb2JqZWN0IG1hcCB2YWx1ZSBhcmUgZXF1YWwgdG8gdGFyZ2V0IG9uZQogICAgICAgIGlmIChtYXBbc2VsZi5BWElTX1ldID09IGZsb29yVGFyZ2V0W3NlbGYuQVhJU19ZXSAmJiBtYXBbc2VsZi5BWElTX1hdID09IGZsb29yVGFyZ2V0W3NlbGYuQVhJU19YXSkgewoKICAgICAgICAgIC8vIEdldCBpbmRleCAmIGJyZWFrIGxvb3AKICAgICAgICAgIGZsb29yVGFyZ2V0SW5kZXggPSBpbmRleDsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGZsb29yVGFyZ2V0SW5kZXg7CiAgICB9LAoKICAgIC8qIFJldHVybiBjb3JyZWN0IGF4aXMgZGVwZW5kaW5nIG9uIHBvc2l0aW9uICovCiAgICBfZ2V0QXhpc0Zyb21EaXJlY3Rpb246IGZ1bmN0aW9uKGRpcmVjdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBheGlzOwogICAgICBzd2l0Y2ggKGRpcmVjdGlvbikgewogICAgICAgIGNhc2UgJ3VwJzoKICAgICAgICBjYXNlICdkb3duJzoKICAgICAgICAgIGF4aXMgPSBzZWxmLkFYSVNfWTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgIGF4aXMgPSBzZWxmLkFYSVNfWDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICByZXR1cm4gYXhpczsKICAgIH0sCgogICAgLyogSGVscGVyIHRvIGdldCB0aGUgY2xvc2VzdCBmbG9vciBpbiBvbmUgcHJlY2lzZSBkaXJlY3Rpb24gZGlyZWN0aW9uICovCiAgICBfZ2V0Q2xvc2VzdEZsb29ySW5kZXg6IGZ1bmN0aW9uKERBLCBmbG9vckluZGV4LCBkaXJlY3Rpb24sIGxldmVsKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGxldmVsID0gbGV2ZWwgfHwgMDsKCiAgICAgIC8vIEdldCBheGlzICYgY29tcGFyZS10byBmbG9vckluZGV4CiAgICAgIHZhciBheGlzID0gdGhpcy5fZ2V0QXhpc0Zyb21EaXJlY3Rpb24oZGlyZWN0aW9uKTsKICAgICAgdmFyIGdvYWwgPSBEQVtmbG9vckluZGV4XVtheGlzXTsKICAgICAgdmFyIG9wcG9zaXRlQXhpcyA9IChheGlzID09IHRoaXMuQVhJU19ZKSA/IHRoaXMuQVhJU19YIDogdGhpcy5BWElTX1k7CgogICAgICAvLyBTZXR1cCBsb29wIHZhcmlhYmxlCiAgICAgIHZhciBjbG9zZXN0SW5kZXggPSBmYWxzZTsKICAgICAgdmFyIGNsb3Nlc3RNYXAgPSBmYWxzZTsKCiAgICAgIC8vIExvb3AgdHJvdWdoIGZsb29yIHBvc2l0aW9uIGFycmF5CiAgICAgICQuZWFjaChEQSwgZnVuY3Rpb24oaW5kZXgsIG1hcCkgewoKICAgICAgICAvLyBJZiBvbiBzYW1lIGF4aXMKICAgICAgICBpZiAobWFwW29wcG9zaXRlQXhpc10gPT0gKERBW2Zsb29ySW5kZXhdW29wcG9zaXRlQXhpc10gKyBsZXZlbCkpIHsKCiAgICAgICAgICAvLyBJZiBkaXJlY3Rpb24gaXMgZm93YXJkIChyaWdodCBvciBkb3duKSBhbmQgdGhlIHZhbHVlIGlzIGJpZ2dlciB0aGFuIGdvYWwgCiAgICAgICAgICAvLyBvZiBpZiBkaXJlY3Rpb24gaXMgYmFja3dhcmQgKGxlZnQgb3IgdXApIGFuZCB0aGUgdmFsdWUgaXMgc21hbGxlciB0aGFuIHRoZSBnb2FsCiAgICAgICAgICBpZiAoKChkaXJlY3Rpb24gPT0gJ3JpZ2h0JyB8fCBkaXJlY3Rpb24gPT0gJ2Rvd24nKSAmJiBtYXBbYXhpc10gPiBnb2FsKSB8fCAoKGRpcmVjdGlvbiA9PSAnbGVmdCcgfHwgZGlyZWN0aW9uID09ICd1cCcpICYmIG1hcFtheGlzXSA8IGdvYWwpKSB7CgoKICAgICAgICAgICAgLy8gTm8gcHJldmlvdXMgdmFsdWUgc2V0IG9yIGlmIHRoZSBjdXJyZW50CiAgICAgICAgICAgIC8vIHZhbHVlIGlzIHNtYWxsZXIgdGhhbiB0aGUgcHJldmlvdXMgb25lCQkJCQkgCiAgICAgICAgICAgIGlmICghY2xvc2VzdE1hcCB8fCBNYXRoLmFicyhtYXBbYXhpc10gLSBnb2FsKSA8IE1hdGguYWJzKGNsb3Nlc3RNYXBbYXhpc10pKSB7CiAgICAgICAgICAgICAgY2xvc2VzdEluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgY2xvc2VzdE1hcCA9IG1hcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyByZXR1cm4gaW5kZXgKICAgICAgcmV0dXJuIGNsb3Nlc3RJbmRleDsKICAgIH0sCgoKICAgIC8qIEhlbHBlciB0byBnZXQgdGhlIGZ1cnRoZXN0IGZsb29yIGluIG9uZSBwcmVjaXNlIGRpcmVjdGlvbiBkaXJlY3Rpb24gKi8KICAgIF9nZXRGdXJ0aGVzdEZsb29ySW5kZXg6IGZ1bmN0aW9uKERBLCBmbG9vckluZGV4LCBkaXJlY3Rpb24sIGxldmVsKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGxldmVsID0gbGV2ZWwgfHwgMDsKCiAgICAgIC8vIEdldCBheGlzICYgY29tcGFyZS10byBmbG9vckluZGV4CiAgICAgIHZhciBheGlzID0gdGhpcy5fZ2V0QXhpc0Zyb21EaXJlY3Rpb24oZGlyZWN0aW9uKTsKICAgICAgdmFyIGdvYWwgPSBEQVtmbG9vckluZGV4XVtheGlzXTsKICAgICAgdmFyIG9wcG9zaXRlQXhpcyA9IChheGlzID09IHRoaXMuQVhJU19ZKSA/IHRoaXMuQVhJU19YIDogdGhpcy5BWElTX1k7CgogICAgICAvLyBTZXR1cCBsb29wIHZhcmlhYmxlCiAgICAgIHZhciBmdXJ0aGVzdE1hcCA9IGZhbHNlOwogICAgICB2YXIgZnVydGhlc3RJbmRleCA9IGZhbHNlOwoKICAgICAgLy8gTG9vcCB0cm91Z2ggZmxvb3IgcG9zaXRpb24gYXJyYXkKICAgICAgJC5lYWNoKERBLCBmdW5jdGlvbihpbmRleCwgbWFwKSB7CgogICAgICAgIC8vIElmIG9uIHNhbWUgYXhpcwogICAgICAgIGlmIChtYXBbb3Bwb3NpdGVBeGlzXSA9PSAoREFbZmxvb3JJbmRleF1bb3Bwb3NpdGVBeGlzXSArIGxldmVsKSkgewoKICAgICAgICAgIC8vIElmIG9uIHNhbWUgYXhpcwogICAgICAgICAgaWYgKCFmdXJ0aGVzdE1hcCB8fCAoTWF0aC5hYnMobWFwW2F4aXNdIC0gZ29hbCkgPiBNYXRoLmFicyhmdXJ0aGVzdE1hcFtheGlzXSAtIGdvYWwpKSkgewogICAgICAgICAgICBmdXJ0aGVzdE1hcCA9IG1hcDsKICAgICAgICAgICAgZnVydGhlc3RJbmRleCA9IGluZGV4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyByZXR1cm4gaW5kZXgKICAgICAgcmV0dXJuIGZ1cnRoZXN0SW5kZXg7CgogICAgfSwKCiAgICAvKiBVc2UgdG8gYWNjZXNzIHF1aWNrbHkgbGF0ZXIsIGF2b2lkaW5nIGxvb3BpbmcgdGhyb3VnaCBldmVyeSBkaXJlY3Rpb24gZXZlcnkgdGltZSAqLwogICAgX2dlbmVyYXRlRmxvb3JNYXA6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB0aGlzLmZsb29yTWFwID0gW107CgogICAgICAvLyBDcmVhdGUgbWFwIG9ubHkgZm9yIGZsb29yIHByZXNlbnQgaW4gdGhlIGRvbQogICAgICB2YXIgREEgPSBqUXVlcnkuZ3JlcChzZWxmLm9wdGlvbnMuZGlyZWN0aW9uLCBmdW5jdGlvbihkaXJlY3Rpb25BcnJheSwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gc2VsZi5ub2RlQ2hpbGRyZW4ubGVuZ3RoID4gaW5kZXg7CiAgICAgIH0pOwoKICAgICAgLy8gTG9vcCBvbiB0aGUgZGlyYXRpb24gYXJyYXkgYW5kIGdldCAKICAgICAgLy8gdGhlIGZsb29yIElEIGZvciBlYWNoIGRpcmVjdGlvbgogICAgICAkLmVhY2goREEsIGZ1bmN0aW9uKGluZGV4LCBmbG9vckl0ZW0pIHsKICAgICAgICBzZWxmLmZsb29yTWFwW2luZGV4XSA9IHsKICAgICAgICAgICdkb3duJzogc2VsZi5fZ2V0RGlyZWN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdkb3duJyksCiAgICAgICAgICAndXAnOiBzZWxmLl9nZXREaXJlY3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3VwJyksCiAgICAgICAgICAncmlnaHQnOiBzZWxmLl9nZXREaXJlY3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JyksCiAgICAgICAgICAnbGVmdCc6IHNlbGYuX2dldERpcmVjdEZsb29ySW5kZXgoREEsIGluZGV4LCAnbGVmdCcpLAogICAgICAgICAgJ2luY3JlbWVudCc6IHsKICAgICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnZG93bicsIDEpLAogICAgICAgICAgICAndXAnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAndXAnLCAtMSksCiAgICAgICAgICAgICdyaWdodCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdyaWdodCcsIDEpLAogICAgICAgICAgICAnbGVmdCc6IHNlbGYuX2dldEZ1cnRoZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdsZWZ0JywgLTEpCiAgICAgICAgICB9LAogICAgICAgICAgJ2Nsb3Nlc3QnOiB7CiAgICAgICAgICAgICdkb3duJzogc2VsZi5fZ2V0Q2xvc2VzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnZG93bicpLAogICAgICAgICAgICAndXAnOiBzZWxmLl9nZXRDbG9zZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICd1cCcpLAogICAgICAgICAgICAncmlnaHQnOiBzZWxmLl9nZXRDbG9zZXN0Rmxvb3JJbmRleChEQSwgaW5kZXgsICdyaWdodCcpLAogICAgICAgICAgICAnbGVmdCc6IHNlbGYuX2dldENsb3Nlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2xlZnQnKQogICAgICAgICAgfSwKICAgICAgICAgICdmdXJ0aGVzdCc6IHsKICAgICAgICAgICAgJ2Rvd24nOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAnZG93bicpLAogICAgICAgICAgICAndXAnOiBzZWxmLl9nZXRGdXJ0aGVzdEZsb29ySW5kZXgoREEsIGluZGV4LCAndXAnKSwKICAgICAgICAgICAgJ3JpZ2h0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ3JpZ2h0JyksCiAgICAgICAgICAgICdsZWZ0Jzogc2VsZi5fZ2V0RnVydGhlc3RGbG9vckluZGV4KERBLCBpbmRleCwgJ2xlZnQnKQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pOwoKICAgICAgZnVuY3Rpb24gZ2V0RnVydGhlckZsb29yQXJyYXkoZmxvb3JBcnJheSwgYXhpcykgewogICAgICAgIHZhciBmdXJ0aGVyRmxvb3IgPSBmYWxzZTsKICAgICAgICBqUXVlcnkuZWFjaChmbG9vckFycmF5LCBmdW5jdGlvbihpbmRleCwgREEpIHsKICAgICAgICAgIGlmIChmdXJ0aGVyRmxvb3IgPT09IGZhbHNlIHx8IGZ1cnRoZXJGbG9vcltheGlzXSA8IERBW2F4aXNdKSB7CiAgICAgICAgICAgIGZ1cnRoZXJGbG9vciA9IERBOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmdXJ0aGVyRmxvb3I7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldENsb3Nlc3RGbG9vck9uQXhpcyhmbG9vckFycmF5LCBheGlzKSB7CiAgICAgICAgdmFyIGZ1cnRoZXJGbG9vciA9IGZhbHNlOwogICAgICAgIGpRdWVyeS5lYWNoKGZsb29yQXJyYXksIGZ1bmN0aW9uKGluZGV4LCBEQSkgewogICAgICAgICAgaWYgKGZ1cnRoZXJGbG9vciA9PT0gZmFsc2UgfHwgZnVydGhlckZsb29yW2F4aXNdID4gREFbYXhpc10pIHsKICAgICAgICAgICAgZnVydGhlckZsb29yID0gREE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZ1cnRoZXJGbG9vcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0U2FtZUF4aXNGbG9vcihmbG9vckl0ZW0sIGF4aXMpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmdyZXAoREEsIGZ1bmN0aW9uKERBKSB7CiAgICAgICAgICB2YXIgaXNPblNhbWVBeGlzID0gREFbYXhpc10gPT0gZmxvb3JJdGVtW2F4aXNdOwogICAgICAgICAgcmV0dXJuIGlzT25TYW1lQXhpczsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIGFwcHJveGltYXRlRnVydGhlclggPSBnZXRGdXJ0aGVyRmxvb3JBcnJheShEQSwgc2VsZi5BWElTX1gpOwogICAgICB2YXIgc2FtZUF4aXNYRnVydGhlc3QgPSBnZXRTYW1lQXhpc0Zsb29yKGFwcHJveGltYXRlRnVydGhlclgsIHNlbGYuQVhJU19YKTsKICAgICAgdmFyIGZ1cnRoZXJZID0gZ2V0RnVydGhlckZsb29yQXJyYXkoc2FtZUF4aXNYRnVydGhlc3QsIHNlbGYuQVhJU19ZKTsKCiAgICAgIHZhciBhcHByb3hpbWF0ZUZ1cnRoZXJZID0gZ2V0RnVydGhlckZsb29yQXJyYXkoREEsIHNlbGYuQVhJU19ZKTsKICAgICAgdmFyIHNhbWVBeGlzWUZ1cnRoZXN0ID0gZ2V0U2FtZUF4aXNGbG9vcihhcHByb3hpbWF0ZUZ1cnRoZXJZLCBzZWxmLkFYSVNfWSk7CiAgICAgIHZhciBmdXJ0aGVyWCA9IGdldEZ1cnRoZXJGbG9vckFycmF5KHNhbWVBeGlzWUZ1cnRoZXN0LCBzZWxmLkFYSVNfWCk7CgogICAgICBzZWxmLmZsb29yTWFwLmZ1cnRoZXN0X3ggPSBEQS5pbmRleE9mKGZ1cnRoZXJYKTsKICAgICAgc2VsZi5mbG9vck1hcC5mdXJ0aGVzdF95ID0gREEuaW5kZXhPZihmdXJ0aGVyWSk7CgogICAgICB2YXIgYXBwcm94aW1hdGVDbG9zZXN0WCA9IGdldENsb3Nlc3RGbG9vck9uQXhpcyhEQSwgc2VsZi5BWElTX1gpOwogICAgICB2YXIgc2FtZUF4aXNYQ2xvc2VzdCA9IGdldFNhbWVBeGlzRmxvb3IoYXBwcm94aW1hdGVDbG9zZXN0WCwgc2VsZi5BWElTX1gpOwogICAgICB2YXIgY2xvc2VzdFkgPSBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoc2FtZUF4aXNYQ2xvc2VzdCwgc2VsZi5BWElTX1kpOwoKICAgICAgdmFyIGFwcHJveGltYXRlQ2xvc2VzdFkgPSBnZXRDbG9zZXN0Rmxvb3JPbkF4aXMoREEsIHNlbGYuQVhJU19ZKTsKICAgICAgdmFyIHNhbWVBeGlzWUNsb3Nlc3QgPSBnZXRTYW1lQXhpc0Zsb29yKGFwcHJveGltYXRlQ2xvc2VzdFksIHNlbGYuQVhJU19ZKTsKICAgICAgdmFyIGNsb3Nlc3RYID0gZ2V0Q2xvc2VzdEZsb29yT25BeGlzKHNhbWVBeGlzWUNsb3Nlc3QsIHNlbGYuQVhJU19YKTsKCiAgICAgIHNlbGYuZmxvb3JNYXAuY2xvc2VzdF94ID0gREEuaW5kZXhPZihjbG9zZXN0WCk7CiAgICAgIHNlbGYuZmxvb3JNYXAuY2xvc2VzdF95ID0gREEuaW5kZXhPZihjbG9zZXN0WSk7CgoKICAgIH0sCgogIH07CgogICQuZm5bcGx1Z2luTmFtZV0gPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgIGlmICghJC5kYXRhKHRoaXMsIHBsdWdpbk5hbWUpKSB7CiAgICAgICAgJC5kYXRhKHRoaXMsIHBsdWdpbk5hbWUsIG5ldyBQbHVnaW4odGhpcywgb3B0aW9ucykpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gdGhpczsKICB9Owp9KShqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 10:44:07 GMT",
                    "Content-Length": "33283",
                    "Date": "Thu, 06 Nov 2014 10:44:08 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}