{
    "url": "http://localhost:9999/stephenway/utility-belt/js/vendor/html2canvas.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>link.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/stephenway/utility-belt/js/vendor/html2canvas.js",
                "path": "/stephenway/utility-belt/js/vendor/html2canvas.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zdGVwaGVud2F5L3V0aWxpdHktYmVsdC9qcy92ZW5kb3IvaHRtbDJjYW52YXMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODg2MjANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDE6MDg6MjYgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAxOjA4OjI2IEdNVA0KDQovKgogIGh0bWwyY2FudmFzIDAuNC4xIDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDEzIE5pa2xhcyB2b24gSGVydHplbgoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCl7CgoidXNlIHN0cmljdCI7Cgp2YXIgX2h0bWwyY2FudmFzID0ge30sCnByZXZpb3VzRWxlbWVudCwKY29tcHV0ZWRDU1MsCmh0bWwyY2FudmFzOwoKX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsKCl9odG1sMmNhbnZhcy5VdGlsLmxvZyA9IGZ1bmN0aW9uKGEpIHsKICBpZiAoX2h0bWwyY2FudmFzLmxvZ2dpbmcgJiYgd2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUubG9nKSB7CiAgICB3aW5kb3cuY29uc29sZS5sb2coYSk7CiAgfQp9OwoKX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQgPSAoZnVuY3Rpb24oaXNOYXRpdmUpewogIHJldHVybiBmdW5jdGlvbihpbnB1dCkgewogICAgcmV0dXJuIGlzTmF0aXZlID8gaXNOYXRpdmUuYXBwbHkoaW5wdXQpIDogKChpbnB1dCB8fCAnJykgKyAnJykucmVwbGFjZSggL15ccyt8XHMrJC9nICwgJycgKTsKICB9Owp9KShTdHJpbmcucHJvdG90eXBlLnRyaW0pOwoKX2h0bWwyY2FudmFzLlV0aWwuYXNGbG9hdCA9IGZ1bmN0aW9uKHYpIHsKICByZXR1cm4gcGFyc2VGbG9hdCh2KTsKfTsKCihmdW5jdGlvbigpIHsKICAvLyBUT0RPOiBzdXBwb3J0IGFsbCBwb3NzaWJsZSBsZW5ndGggdmFsdWVzCiAgdmFyIFRFWFRfU0hBRE9XX1BST1BFUlRZID0gLygocmdiYXxyZ2IpXChbXlwpXStcKShccy0/XGQrcHgpezAsfSkvZzsKICB2YXIgVEVYVF9TSEFET1dfVkFMVUVTID0gLygtP1xkK3B4KXwoIy4rKXwocmdiXCguK1wpKXwocmdiYVwoLitcKSkvZzsKICBfaHRtbDJjYW52YXMuVXRpbC5wYXJzZVRleHRTaGFkb3dzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlIHx8IHZhbHVlID09PSAnbm9uZScpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQoKICAgIC8vIGZpbmQgbXVsdGlwbGUgc2hhZG93IGRlY2xhcmF0aW9ucwogICAgdmFyIHNoYWRvd3MgPSB2YWx1ZS5tYXRjaChURVhUX1NIQURPV19QUk9QRVJUWSksCiAgICAgIHJlc3VsdHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBzaGFkb3dzICYmIChpIDwgc2hhZG93cy5sZW5ndGgpOyBpKyspIHsKICAgICAgdmFyIHMgPSBzaGFkb3dzW2ldLm1hdGNoKFRFWFRfU0hBRE9XX1ZBTFVFUyk7CiAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgY29sb3I6IHNbMF0sCiAgICAgICAgb2Zmc2V0WDogc1sxXSA/IHNbMV0ucmVwbGFjZSgncHgnLCAnJykgOiAwLAogICAgICAgIG9mZnNldFk6IHNbMl0gPyBzWzJdLnJlcGxhY2UoJ3B4JywgJycpIDogMCwKICAgICAgICBibHVyOiBzWzNdID8gc1szXS5yZXBsYWNlKCdweCcsICcnKSA6IDAKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Owp9KSgpOwoKCl9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICB2YXIgd2hpdGVzcGFjZSA9ICcgXHJcblx0JywKICAgICAgICBtZXRob2QsIGRlZmluaXRpb24sIHByZWZpeCwgcHJlZml4X2ksIGJsb2NrLCByZXN1bHRzID0gW10sCiAgICAgICAgYywgbW9kZSA9IDAsIG51bVBhcmVuID0gMCwgcXVvdGUsIGFyZ3M7CgogICAgdmFyIGFwcGVuZFJlc3VsdCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYobWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGRlZmluaXRpb24uc3Vic3RyKCAwLCAxICkgPT09ICciJykgewogICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uc3Vic3RyKCAxLCBkZWZpbml0aW9uLmxlbmd0aCAtIDIgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZGVmaW5pdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobWV0aG9kLnN1YnN0ciggMCwgMSApID09PSAnLScgJiYKICAgICAgICAgICAgICAgICAgICAocHJlZml4X2kgPSBtZXRob2QuaW5kZXhPZiggJy0nLCAxICkgKyAxKSA+IDApIHsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1ldGhvZC5zdWJzdHIoIDAsIHByZWZpeF9pKTsKICAgICAgICAgICAgICAgIG1ldGhvZCA9IG1ldGhvZC5zdWJzdHIoIHByZWZpeF9pICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICAgICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jaywKICAgICAgICAgICAgICAgIGFyZ3M6IGFyZ3MKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGFyZ3MgPSBbXTsgLy9mb3Igc29tZSBvZGQgcmVhc29uLCBzZXR0aW5nIC5sZW5ndGggPSAwIGRpZG4ndCB3b3JrIGluIHNhZmFyaQogICAgICAgIG1ldGhvZCA9CiAgICAgICAgICAgIHByZWZpeCA9CiAgICAgICAgICAgIGRlZmluaXRpb24gPQogICAgICAgICAgICBibG9jayA9ICcnOwogICAgfTsKCiAgICBhcHBlbmRSZXN1bHQoKTsKICAgIGZvcih2YXIgaSA9IDAsIGlpID0gdmFsdWUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICBjID0gdmFsdWVbaV07CiAgICAgICAgaWYobW9kZSA9PT0gMCAmJiB3aGl0ZXNwYWNlLmluZGV4T2YoIGMgKSA+IC0xKXsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHN3aXRjaChjKSB7CiAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgaWYoIXF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgcXVvdGUgPSBjOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZihxdW90ZSA9PT0gYykgewogICAgICAgICAgICAgICAgICAgIHF1b3RlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnKCc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbnVtUGFyZW4rKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnKSc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYobnVtUGFyZW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZFJlc3VsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBudW1QYXJlbi0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnLCc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kUmVzdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChtb2RlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYobnVtUGFyZW4gPT09IDAgJiYgIW1ldGhvZC5tYXRjaCgvXnVybCQvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICBpZihtb2RlID09PSAwKSB7IG1ldGhvZCArPSBjOyB9CiAgICAgICAgZWxzZSB7IGRlZmluaXRpb24gKz0gYzsgfQogICAgfQogICAgYXBwZW5kUmVzdWx0KCk7CgogICAgcmV0dXJuIHJlc3VsdHM7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogIHZhciBjbGllbnRSZWN0LCBib3VuZHMgPSB7fTsKCiAgaWYgKGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KXsKICAgIGNsaWVudFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgIC8vIFRPRE8gYWRkIHNjcm9sbCBwb3NpdGlvbiB0byBib3VuZHMsIHNvIG5vIHNjcm9sbGluZyBvZiB3aW5kb3cgbmVjZXNzYXJ5CiAgICBib3VuZHMudG9wID0gY2xpZW50UmVjdC50b3A7CiAgICBib3VuZHMuYm90dG9tID0gY2xpZW50UmVjdC5ib3R0b20gfHwgKGNsaWVudFJlY3QudG9wICsgY2xpZW50UmVjdC5oZWlnaHQpOwogICAgYm91bmRzLmxlZnQgPSBjbGllbnRSZWN0LmxlZnQ7CgogICAgYm91bmRzLndpZHRoID0gZWxlbWVudC5vZmZzZXRXaWR0aDsKICAgIGJvdW5kcy5oZWlnaHQgPSBlbGVtZW50Lm9mZnNldEhlaWdodDsKICB9CgogIHJldHVybiBib3VuZHM7Cn07CgovLyBUT0RPIGlkZWFsbHksIHdlJ2Qgd2FudCBldmVyeXRoaW5nIHRvIGdvIHRocm91Z2ggdGhpcyBmdW5jdGlvbiBpbnN0ZWFkIG9mIFV0aWwuQm91bmRzLAovLyBidXQgd291bGQgcmVxdWlyZSBmdXJ0aGVyIHdvcmsgdG8gY2FsY3VsYXRlIHRoZSBjb3JyZWN0IHBvc2l0aW9ucyBmb3IgZWxlbWVudHMgd2l0aCBvZmZzZXRQYXJlbnRzCl9odG1sMmNhbnZhcy5VdGlsLk9mZnNldEJvdW5kcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgdmFyIHBhcmVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50ID8gX2h0bWwyY2FudmFzLlV0aWwuT2Zmc2V0Qm91bmRzKGVsZW1lbnQub2Zmc2V0UGFyZW50KSA6IHt0b3A6IDAsIGxlZnQ6IDB9OwoKICByZXR1cm4gewogICAgdG9wOiBlbGVtZW50Lm9mZnNldFRvcCArIHBhcmVudC50b3AsCiAgICBib3R0b206IGVsZW1lbnQub2Zmc2V0VG9wICsgZWxlbWVudC5vZmZzZXRIZWlnaHQgKyBwYXJlbnQudG9wLAogICAgbGVmdDogZWxlbWVudC5vZmZzZXRMZWZ0ICsgcGFyZW50LmxlZnQsCiAgICB3aWR0aDogZWxlbWVudC5vZmZzZXRXaWR0aCwKICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHQKICB9Owp9OwoKZnVuY3Rpb24gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUsIHZhbHVlICkgewogICAgdmFyIHJzTGVmdCA9IGVsZW1lbnQucnVudGltZVN0eWxlICYmIGVsZW1lbnQucnVudGltZVN0eWxlW2F0dHJpYnV0ZV0sCiAgICAgICAgbGVmdCwKICAgICAgICBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7CgogICAgLy8gQ2hlY2sgaWYgd2UgYXJlIG5vdCBkZWFsaW5nIHdpdGggcGl4ZWxzLCAoT3BlcmEgaGFzIGlzc3VlcyB3aXRoIHRoaXMpCiAgICAvLyBQb3J0ZWQgZnJvbSBqUXVlcnkgY3NzLmpzCiAgICAvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCiAgICAvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgogICAgLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyCiAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKCiAgICBpZiAoICEvXi0/WzAtOV0rXC4/WzAtOV0qKD86cHgpPyQvaS50ZXN0KCB2YWx1ZSApICYmIC9eLT9cZC8udGVzdCh2YWx1ZSkgKSB7CiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIGxlZnQgPSBzdHlsZS5sZWZ0OwoKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICBlbGVtZW50LnJ1bnRpbWVTdHlsZS5sZWZ0ID0gZWxlbWVudC5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgICB9CiAgICAgICAgc3R5bGUubGVmdCA9IGF0dHJpYnV0ZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogKHZhbHVlIHx8IDApOwogICAgICAgIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0OwogICAgICAgIGlmIChyc0xlZnQpIHsKICAgICAgICAgICAgZWxlbWVudC5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKICAgICAgICB9CiAgICB9CgogICAgaWYgKCEvXih0aGlufG1lZGl1bXx0aGljaykkL2kudGVzdCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChwYXJzZUZsb2F0KHZhbHVlKSkgKyAicHgiOwogICAgfQoKICAgIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gYXNJbnQodmFsKSB7CiAgICByZXR1cm4gcGFyc2VJbnQodmFsLCAxMCk7Cn0KCmZ1bmN0aW9uIHBhcnNlQmFja2dyb3VuZFNpemVQb3NpdGlvbih2YWx1ZSwgZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCkgewogICAgdmFsdWUgPSAodmFsdWUgfHwgJycpLnNwbGl0KCcsJyk7CiAgICB2YWx1ZSA9IHZhbHVlW2luZGV4IHx8IDBdIHx8IHZhbHVlWzBdIHx8ICdhdXRvJzsKICAgIHZhbHVlID0gX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQodmFsdWUpLnNwbGl0KCcgJyk7CgogICAgaWYoYXR0cmlidXRlID09PSAnYmFja2dyb3VuZFNpemUnICYmICghdmFsdWVbMF0gfHwgdmFsdWVbMF0ubWF0Y2goL2NvdmVyfGNvbnRhaW58YXV0by8pKSkgewogICAgICAgIC8vdGhlc2UgdmFsdWVzIHdpbGwgYmUgaGFuZGxlZCBpbiB0aGUgcGFyZW50IGZ1bmN0aW9uCiAgICB9IGVsc2UgewogICAgICAgIHZhbHVlWzBdID0gKHZhbHVlWzBdLmluZGV4T2YoICIlIiApID09PSAtMSkgPyB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSArICJYIiwgdmFsdWVbMF0pIDogdmFsdWVbMF07CiAgICAgICAgaWYodmFsdWVbMV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZihhdHRyaWJ1dGUgPT09ICdiYWNrZ3JvdW5kU2l6ZScpIHsKICAgICAgICAgICAgICAgIHZhbHVlWzFdID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSUUgOSBkb2Vzbid0IHJldHVybiBkb3VibGUgZGlnaXQgYWx3YXlzCiAgICAgICAgICAgICAgICB2YWx1ZVsxXSA9IHZhbHVlWzBdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhbHVlWzFdID0gKHZhbHVlWzFdLmluZGV4T2YoIiUiKSA9PT0gLTEpID8gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUgKyAiWSIsIHZhbHVlWzFdKSA6IHZhbHVlWzFdOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgpfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCkgewogICAgaWYgKHByZXZpb3VzRWxlbWVudCAhPT0gZWxlbWVudCkgewogICAgICBjb21wdXRlZENTUyA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCk7CiAgICB9CgogICAgdmFyIHZhbHVlID0gY29tcHV0ZWRDU1NbYXR0cmlidXRlXTsKCiAgICBpZiAoL15iYWNrZ3JvdW5kKFNpemV8UG9zaXRpb24pJC8udGVzdChhdHRyaWJ1dGUpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlQmFja2dyb3VuZFNpemVQb3NpdGlvbih2YWx1ZSwgZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCk7CiAgICB9IGVsc2UgaWYgKC9ib3JkZXIoVG9wfEJvdHRvbSkoTGVmdHxSaWdodClSYWRpdXMvLnRlc3QoYXR0cmlidXRlKSkgewogICAgICB2YXIgYXJyID0gdmFsdWUuc3BsaXQoIiAiKTsKICAgICAgaWYgKGFyci5sZW5ndGggPD0gMSkgewogICAgICAgICAgYXJyWzFdID0gYXJyWzBdOwogICAgICB9CiAgICAgIHJldHVybiBhcnIubWFwKGFzSW50KTsKICAgIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwucmVzaXplQm91bmRzID0gZnVuY3Rpb24oIGN1cnJlbnRfd2lkdGgsIGN1cnJlbnRfaGVpZ2h0LCB0YXJnZXRfd2lkdGgsIHRhcmdldF9oZWlnaHQsIHN0cmV0Y2hfbW9kZSApewogIHZhciB0YXJnZXRfcmF0aW8gPSB0YXJnZXRfd2lkdGggLyB0YXJnZXRfaGVpZ2h0LAogICAgY3VycmVudF9yYXRpbyA9IGN1cnJlbnRfd2lkdGggLyBjdXJyZW50X2hlaWdodCwKICAgIG91dHB1dF93aWR0aCwgb3V0cHV0X2hlaWdodDsKCiAgaWYoIXN0cmV0Y2hfbW9kZSB8fCBzdHJldGNoX21vZGUgPT09ICdhdXRvJykgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgfSBlbHNlIGlmKHRhcmdldF9yYXRpbyA8IGN1cnJlbnRfcmF0aW8gXiBzdHJldGNoX21vZGUgPT09ICdjb250YWluJykgewogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgICBvdXRwdXRfd2lkdGggPSB0YXJnZXRfaGVpZ2h0ICogY3VycmVudF9yYXRpbzsKICB9IGVsc2UgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF93aWR0aCAvIGN1cnJlbnRfcmF0aW87CiAgfQoKICByZXR1cm4gewogICAgd2lkdGg6IG91dHB1dF93aWR0aCwKICAgIGhlaWdodDogb3V0cHV0X2hlaWdodAogIH07Cn07CgpmdW5jdGlvbiBiYWNrZ3JvdW5kQm91bmRzRmFjdG9yeSggcHJvcCwgZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgsIGJhY2tncm91bmRTaXplICkgewogICAgdmFyIGJncG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKCBlbCwgcHJvcCwgaW1hZ2VJbmRleCApICwKICAgIHRvcFBvcywKICAgIGxlZnQsCiAgICBwZXJjZW50YWdlLAogICAgdmFsOwoKICAgIGlmIChiZ3Bvc2l0aW9uLmxlbmd0aCA9PT0gMSl7CiAgICAgIHZhbCA9IGJncG9zaXRpb25bMF07CgogICAgICBiZ3Bvc2l0aW9uID0gW107CgogICAgICBiZ3Bvc2l0aW9uWzBdID0gdmFsOwogICAgICBiZ3Bvc2l0aW9uWzFdID0gdmFsOwogICAgfQoKICAgIGlmIChiZ3Bvc2l0aW9uWzBdLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMSl7CiAgICAgIHBlcmNlbnRhZ2UgPSAocGFyc2VGbG9hdChiZ3Bvc2l0aW9uWzBdKS8xMDApOwogICAgICBsZWZ0ID0gYm91bmRzLndpZHRoICogcGVyY2VudGFnZTsKICAgICAgaWYocHJvcCAhPT0gJ2JhY2tncm91bmRTaXplJykgewogICAgICAgIGxlZnQgLT0gKGJhY2tncm91bmRTaXplIHx8IGltYWdlKS53aWR0aCpwZXJjZW50YWdlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZihwcm9wID09PSAnYmFja2dyb3VuZFNpemUnKSB7CiAgICAgICAgaWYoYmdwb3NpdGlvblswXSA9PT0gJ2F1dG8nKSB7CiAgICAgICAgICBsZWZ0ID0gaW1hZ2Uud2lkdGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgvY29udGFpbnxjb3Zlci8udGVzdChiZ3Bvc2l0aW9uWzBdKSkgewogICAgICAgICAgICB2YXIgcmVzaXplZCA9IF9odG1sMmNhbnZhcy5VdGlsLnJlc2l6ZUJvdW5kcyhpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQsIGJncG9zaXRpb25bMF0pOwogICAgICAgICAgICBsZWZ0ID0gcmVzaXplZC53aWR0aDsKICAgICAgICAgICAgdG9wUG9zID0gcmVzaXplZC5oZWlnaHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWZ0ID0gcGFyc2VJbnQoYmdwb3NpdGlvblswXSwgMTApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZWZ0ID0gcGFyc2VJbnQoIGJncG9zaXRpb25bMF0sIDEwKTsKICAgICAgfQogICAgfQoKCiAgICBpZihiZ3Bvc2l0aW9uWzFdID09PSAnYXV0bycpIHsKICAgICAgdG9wUG9zID0gbGVmdCAvIGltYWdlLndpZHRoICogaW1hZ2UuaGVpZ2h0OwogICAgfSBlbHNlIGlmIChiZ3Bvc2l0aW9uWzFdLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMSl7CiAgICAgIHBlcmNlbnRhZ2UgPSAocGFyc2VGbG9hdChiZ3Bvc2l0aW9uWzFdKS8xMDApOwogICAgICB0b3BQb3MgPSAgYm91bmRzLmhlaWdodCAqIHBlcmNlbnRhZ2U7CiAgICAgIGlmKHByb3AgIT09ICdiYWNrZ3JvdW5kU2l6ZScpIHsKICAgICAgICB0b3BQb3MgLT0gKGJhY2tncm91bmRTaXplIHx8IGltYWdlKS5oZWlnaHQgKiBwZXJjZW50YWdlOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgdG9wUG9zID0gcGFyc2VJbnQoYmdwb3NpdGlvblsxXSwxMCk7CiAgICB9CgogICAgcmV0dXJuIFtsZWZ0LCB0b3BQb3NdOwp9CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kUG9zaXRpb24gPSBmdW5jdGlvbiggZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgsIGJhY2tncm91bmRTaXplICkgewogICAgdmFyIHJlc3VsdCA9IGJhY2tncm91bmRCb3VuZHNGYWN0b3J5KCAnYmFja2dyb3VuZFBvc2l0aW9uJywgZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgsIGJhY2tncm91bmRTaXplICk7CiAgICByZXR1cm4geyBsZWZ0OiByZXN1bHRbMF0sIHRvcDogcmVzdWx0WzFdIH07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kU2l6ZSA9IGZ1bmN0aW9uKCBlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCApIHsKICAgIHZhciByZXN1bHQgPSBiYWNrZ3JvdW5kQm91bmRzRmFjdG9yeSggJ2JhY2tncm91bmRTaXplJywgZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXggKTsKICAgIHJldHVybiB7IHdpZHRoOiByZXN1bHRbMF0sIGhlaWdodDogcmVzdWx0WzFdIH07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQgPSBmdW5jdGlvbiAob3B0aW9ucywgZGVmYXVsdHMpIHsKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICBkZWZhdWx0c1trZXldID0gb3B0aW9uc1trZXldOwogICAgfQogIH0KICByZXR1cm4gZGVmYXVsdHM7Cn07CgoKLyoKICogRGVyaXZlZCBmcm9tIGpRdWVyeS5jb250ZW50cygpCiAqIENvcHlyaWdodCAyMDEwLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwpfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBjaGlsZHJlbjsKICB0cnkgewogICAgY2hpbGRyZW4gPSAoZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJJRlJBTUUiKSA/IGVsZW0uY29udGVudERvY3VtZW50IHx8IGVsZW0uY29udGVudFdpbmRvdy5kb2N1bWVudCA6IChmdW5jdGlvbihhcnJheSkgewogICAgICB2YXIgcmV0ID0gW107CiAgICAgIGlmIChhcnJheSAhPT0gbnVsbCkgewogICAgICAgIChmdW5jdGlvbihmaXJzdCwgc2Vjb25kICkgewogICAgICAgICAgdmFyIGkgPSBmaXJzdC5sZW5ndGgsCiAgICAgICAgICBqID0gMDsKCiAgICAgICAgICBpZiAodHlwZW9mIHNlY29uZC5sZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGwgPSBzZWNvbmQubGVuZ3RoOyBqIDwgbDsgaisrKSB7CiAgICAgICAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqKytdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZmlyc3QubGVuZ3RoID0gaTsKCiAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgfSkocmV0LCBhcnJheSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0pKGVsZW0uY2hpbGROb2Rlcyk7CgogIH0gY2F0Y2ggKGV4KSB7CiAgICBfaHRtbDJjYW52YXMuVXRpbC5sb2coImh0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gZmFpbGVkIHdpdGggZXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICBjaGlsZHJlbiA9IFtdOwogIH0KICByZXR1cm4gY2hpbGRyZW47Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5pc1RyYW5zcGFyZW50ID0gZnVuY3Rpb24oYmFja2dyb3VuZENvbG9yKSB7CiAgcmV0dXJuIChiYWNrZ3JvdW5kQ29sb3IgPT09ICJ0cmFuc3BhcmVudCIgfHwgYmFja2dyb3VuZENvbG9yID09PSAicmdiYSgwLCAwLCAwLCAwKSIpOwp9OwpfaHRtbDJjYW52YXMuVXRpbC5Gb250ID0gKGZ1bmN0aW9uICgpIHsKCiAgdmFyIGZvbnREYXRhID0ge307CgogIHJldHVybiBmdW5jdGlvbihmb250LCBmb250U2l6ZSwgZG9jKSB7CiAgICBpZiAoZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdOwogICAgfQoKICAgIHZhciBjb250YWluZXIgPSBkb2MuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICBpbWcgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW1nJyksCiAgICBzcGFuID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSwKICAgIHNhbXBsZVRleHQgPSAnSGlkZGVuIFRleHQnLAogICAgYmFzZWxpbmUsCiAgICBtaWRkbGUsCiAgICBtZXRyaWNzT2JqOwoKICAgIGNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICBjb250YWluZXIuc3R5bGUuZm9udEZhbWlseSA9IGZvbnQ7CiAgICBjb250YWluZXIuc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgIGNvbnRhaW5lci5zdHlsZS5tYXJnaW4gPSAwOwogICAgY29udGFpbmVyLnN0eWxlLnBhZGRpbmcgPSAwOwoKICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CgogICAgLy8gaHR0cDovL3Byb2JhYmx5cHJvZ3JhbW1pbmcuY29tLzIwMDkvMDMvMTUvdGhlLXRpbmllc3QtZ2lmLWV2ZXIgKGhhbmR0aW55d2hpdGUuZ2lmKQogICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQkFQLy8vd0FBQUN3QUFBQUFBUUFCQUFBQ0FrUUJBRHM9IjsKICAgIGltZy53aWR0aCA9IDE7CiAgICBpbWcuaGVpZ2h0ID0gMTsKCiAgICBpbWcuc3R5bGUubWFyZ2luID0gMDsKICAgIGltZy5zdHlsZS5wYWRkaW5nID0gMDsKICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gImJhc2VsaW5lIjsKCiAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgc3Bhbi5zdHlsZS5mb250U2l6ZSA9IGZvbnRTaXplOwogICAgc3Bhbi5zdHlsZS5tYXJnaW4gPSAwOwogICAgc3Bhbi5zdHlsZS5wYWRkaW5nID0gMDsKCiAgICBzcGFuLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShzYW1wbGVUZXh0KSk7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW1nKTsKICAgIGJhc2VsaW5lID0gKGltZy5vZmZzZXRUb3AgLSBzcGFuLm9mZnNldFRvcCkgKyAxOwoKICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzcGFuKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2FtcGxlVGV4dCkpOwoKICAgIGNvbnRhaW5lci5zdHlsZS5saW5lSGVpZ2h0ID0gIm5vcm1hbCI7CiAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJzdXBlciI7CgogICAgbWlkZGxlID0gKGltZy5vZmZzZXRUb3AtY29udGFpbmVyLm9mZnNldFRvcCkgKyAxOwogICAgbWV0cmljc09iaiA9IHsKICAgICAgYmFzZWxpbmU6IGJhc2VsaW5lLAogICAgICBsaW5lV2lkdGg6IDEsCiAgICAgIG1pZGRsZTogbWlkZGxlCiAgICB9OwoKICAgIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gPSBtZXRyaWNzT2JqOwoKICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CgogICAgcmV0dXJuIG1ldHJpY3NPYmo7CiAgfTsKfSkoKTsKCihmdW5jdGlvbigpewogIHZhciBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgICBHZW5lcmF0ZSA9IHt9OwoKICBfaHRtbDJjYW52YXMuR2VuZXJhdGUgPSBHZW5lcmF0ZTsKCiAgdmFyIHJlR3JhZGllbnRzID0gWwogIC9eKC13ZWJraXQtbGluZWFyLWdyYWRpZW50KVwoKFthLXpcc10rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1vLWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtd2Via2l0LWdyYWRpZW50KVwoKGxpbmVhcnxyYWRpYWwpLFxzKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPyksXHMoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKShbXHdcZFwuXHMsJVwoXClcLV0rKVwpJC8sCiAgL14oLW1vei1saW5lYXItZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtd2Via2l0LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2EtelwtXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW1vei1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzPyhbYS16XC1dKikoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtby1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXpcLV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvCiAgXTsKCiAgLyoKICogVE9ETzogQWRkIElFMTAgdmVuZG9yIHByZWZpeCAoLW1zKSBzdXBwb3J0CiAqIFRPRE86IEFkZCBXM0MgZ3JhZGllbnQgKGxpbmVhci1ncmFkaWVudCkgc3VwcG9ydAogKiBUT0RPOiBBZGQgb2xkIFdlYmtpdCAtd2Via2l0LWdyYWRpZW50KHJhZGlhbCwgLi4uKSBzdXBwb3J0CiAqIFRPRE86IE1heWJlIHNvbWUgUmVnRXhwIG9wdGltaXphdGlvbnMgYXJlIHBvc3NpYmxlIDtvKQogKi8KICBHZW5lcmF0ZS5wYXJzZUdyYWRpZW50ID0gZnVuY3Rpb24oY3NzLCBib3VuZHMpIHsKICAgIHZhciBncmFkaWVudCwgaSwgbGVuID0gcmVHcmFkaWVudHMubGVuZ3RoLCBtMSwgc3RvcCwgbTIsIG0yTGVuLCBzdGVwLCBtMywgdGwsdHIsYnIsYmw7CgogICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKz0xKXsKICAgICAgbTEgPSBjc3MubWF0Y2gocmVHcmFkaWVudHNbaV0pOwogICAgICBpZihtMSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYobTEpIHsKICAgICAgc3dpdGNoKG0xWzFdKSB7CiAgICAgICAgY2FzZSAnLXdlYmtpdC1saW5lYXItZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1vLWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgICAgICB4MDogbnVsbCwKICAgICAgICAgICAgeTA6IG51bGwsCiAgICAgICAgICAgIHgxOiBudWxsLAogICAgICAgICAgICB5MTogbnVsbCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC9cdysvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgc3dpdGNoKG0yW2ldKSB7CiAgICAgICAgICAgICAgICBjYXNlICd0b3AnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IDA7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAwOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nOgogICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGJvdW5kcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gMDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYoZ3JhZGllbnQueDAgPT09IG51bGwgJiYgZ3JhZGllbnQueDEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aCAvIDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZihncmFkaWVudC55MCA9PT0gbnVsbCAmJiBncmFkaWVudC55MSA9PT0gbnVsbCl7IC8vIGNlbnRlcgogICAgICAgICAgICBncmFkaWVudC55MCA9IGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAvIDI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpewogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctd2Via2l0LWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogbTFbMl0gPT09ICdyYWRpYWwnID8gJ2NpcmNsZScgOiBtMVsyXSwgLy8gVE9ETzogQWRkIHJhZGlhbCBncmFkaWVudCBzdXBwb3J0IGZvciBvbGRlciBtb3ppbGxhIGRlZmluaXRpb25zCiAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgeDE6IDAsCiAgICAgICAgICAgIHkxOiAwLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPyxccyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkwID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LngxID0gKG0yWzNdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAobTJbNF0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgbTIgPSBtMVs0XS5tYXRjaCgvKCg/OmZyb218dG98Y29sb3Itc3RvcClcKCg/OlswLTlcLl0rLFxzKT8oPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKVwpKSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKGZyb218dG98Y29sb3Itc3RvcClcKChbMC05XC5dKyk/KD86LFxzKT8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXCkvKTsKICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgaWYobTNbMV0gPT09ICdmcm9tJykgewogICAgICAgICAgICAgICAgc3RvcCA9IDAuMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYobTNbMV0gPT09ICd0bycpIHsKICAgICAgICAgICAgICAgIHN0b3AgPSAxLjA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbM10sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctbW96LWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiAwLAogICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKCiAgICAgICAgICAvLyBtMlsxXSA9PSAwJSAgIC0+IGxlZnQKICAgICAgICAgIC8vIG0yWzFdID09IDUwJSAgLT4gY2VudGVyCiAgICAgICAgICAvLyBtMlsxXSA9PSAxMDAlIC0+IHJpZ2h0CgogICAgICAgICAgLy8gbTJbMl0gPT0gMCUgICAtPiB0b3AKICAgICAgICAgIC8vIG0yWzJdID09IDUwJSAgLT4gY2VudGVyCiAgICAgICAgICAvLyBtMlsyXSA9PSAxMDAlIC0+IGJvdHRvbQoKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aCAtIGdyYWRpZW50LngwOwogICAgICAgICAgICBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQgLSBncmFkaWVudC55MDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9JSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglKT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSl7IC8vIHBlcmNlbnRhZ2UKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJy13ZWJraXQtcmFkaWFsLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctbW96LXJhZGlhbC1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW8tcmFkaWFsLWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogJ2NpcmNsZScsCiAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgeDE6IGJvdW5kcy53aWR0aCwKICAgICAgICAgICAgeTE6IGJvdW5kcy5oZWlnaHQsCiAgICAgICAgICAgIGN4OiAwLAogICAgICAgICAgICBjeTogMCwKICAgICAgICAgICAgcng6IDAsCiAgICAgICAgICAgIHJ5OiAwLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBjZW50ZXIKICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBncmFkaWVudC5jeCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LmN5ID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gc2l6ZQogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvXHcrLyk7CiAgICAgICAgICBtMyA9IG0xWzRdLm1hdGNoKC9bYS16XC1dKi8pOwogICAgICAgICAgaWYobTIgJiYgbTMpewogICAgICAgICAgICBzd2l0Y2gobTNbMF0pewogICAgICAgICAgICAgIGNhc2UgJ2ZhcnRoZXN0LWNvcm5lcic6CiAgICAgICAgICAgICAgY2FzZSAnY292ZXInOiAvLyBpcyBlcXVpdmFsZW50IHRvIGZhcnRoZXN0LWNvcm5lcgogICAgICAgICAgICAgIGNhc2UgJyc6IC8vIG1vemlsbGEgcmVtb3ZlcyAiY292ZXIiIGZyb20gZGVmaW5pdGlvbiA6KAogICAgICAgICAgICAgICAgdGwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIHRyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYmwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWF4KHRsLCB0ciwgYnIsIGJsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3QtY29ybmVyJzoKICAgICAgICAgICAgICAgIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbih0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1zaWRlJzoKICAgICAgICAgICAgICAgIGlmKG0yWzBdID09PSAnY2lyY2xlJyl7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gZWxsaXBzZQoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOwoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgY2FzZSAnY29udGFpbic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gY2xvc2VzdC1zaWRlCiAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciAiMzBweCA0MHB4IiBzaXplcyAod2Via2l0IG9ubHkpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjb2xvciBzdG9wcwogICAgICAgICAgbTIgPSBtMVs1XS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9KD86JXxweCkpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJXxweCk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gcHggLSBzdHVwaWQgb3BlcmEKICAgICAgICAgICAgICAgICAgc3RvcCAvPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3JhZGllbnQ7CiAgfTsKCiAgZnVuY3Rpb24gYWRkU2Nyb2xsU3RvcHMoZ3JhZCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbG9yU3RvcCkgewogICAgICB0cnkgewogICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGNvbG9yU3RvcC5zdG9wLCBjb2xvclN0b3AuY29sb3IpOwogICAgICB9CiAgICAgIGNhdGNoKGUpIHsKICAgICAgICBVdGlsLmxvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBjb2xvclN0b3BdKTsKICAgICAgfQogICAgfTsKICB9CgogIEdlbmVyYXRlLkdyYWRpZW50ID0gZnVuY3Rpb24oc3JjLCBib3VuZHMpIHsKICAgIGlmKGJvdW5kcy53aWR0aCA9PT0gMCB8fCBib3VuZHMuaGVpZ2h0ID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSwKICAgIGdyYWRpZW50LCBncmFkOwoKICAgIGNhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0OwoKICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciBtdWx0aSBkZWZpbmVkIGJhY2tncm91bmQgZ3JhZGllbnRzCiAgICBncmFkaWVudCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5wYXJzZUdyYWRpZW50KHNyYywgYm91bmRzKTsKCiAgICBpZihncmFkaWVudCkgewogICAgICBzd2l0Y2goZ3JhZGllbnQudHlwZSkgewogICAgICAgIGNhc2UgJ2xpbmVhcic6CiAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KGdyYWRpZW50LngwLCBncmFkaWVudC55MCwgZ3JhZGllbnQueDEsIGdyYWRpZW50LnkxKTsKICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMuZm9yRWFjaChhZGRTY3JvbGxTdG9wcyhncmFkKSk7CiAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2NpcmNsZSc6CiAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgMCwgZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCBncmFkaWVudC5yeCk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdlbGxpcHNlJzoKICAgICAgICAgIHZhciBjYW52YXNSYWRpYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgICAgICAgICAgY3R4UmFkaWFsID0gY2FudmFzUmFkaWFsLmdldENvbnRleHQoJzJkJyksCiAgICAgICAgICAgIHJpID0gTWF0aC5tYXgoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5KSwKICAgICAgICAgICAgZGkgPSByaSAqIDI7CgogICAgICAgICAgY2FudmFzUmFkaWFsLndpZHRoID0gY2FudmFzUmFkaWFsLmhlaWdodCA9IGRpOwoKICAgICAgICAgIGdyYWQgPSBjdHhSYWRpYWwuY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCAwLCBncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIHJpKTsKICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMuZm9yRWFjaChhZGRTY3JvbGxTdG9wcyhncmFkKSk7CgogICAgICAgICAgY3R4UmFkaWFsLmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHhSYWRpYWwuZmlsbFJlY3QoMCwgMCwgZGksIGRpKTsKCiAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZGllbnQuY29sb3JTdG9wc1tncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aCAtIDFdLmNvbG9yOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICAgICAgICBjdHguZHJhd0ltYWdlKGNhbnZhc1JhZGlhbCwgZ3JhZGllbnQuY3ggLSBncmFkaWVudC5yeCwgZ3JhZGllbnQuY3kgLSBncmFkaWVudC5yeSwgMiAqIGdyYWRpZW50LnJ4LCAyICogZ3JhZGllbnQucnkpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH07CgogIEdlbmVyYXRlLkxpc3RBbHBoYSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHRtcCA9ICIiLAogICAgbW9kdWx1czsKCiAgICBkbyB7CiAgICAgIG1vZHVsdXMgPSBudW1iZXIgJSAyNjsKICAgICAgdG1wID0gU3RyaW5nLmZyb21DaGFyQ29kZSgobW9kdWx1cykgKyA2NCkgKyB0bXA7CiAgICAgIG51bWJlciA9IG51bWJlciAvIDI2OwogICAgfXdoaWxlKChudW1iZXIqMjYpID4gMjYpOwoKICAgIHJldHVybiB0bXA7CiAgfTsKCiAgR2VuZXJhdGUuTGlzdFJvbWFuID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICB2YXIgcm9tYW5BcnJheSA9IFsiTSIsICJDTSIsICJEIiwgIkNEIiwgIkMiLCAiWEMiLCAiTCIsICJYTCIsICJYIiwgIklYIiwgIlYiLCAiSVYiLCAiSSJdLAogICAgZGVjaW1hbCA9IFsxMDAwLCA5MDAsIDUwMCwgNDAwLCAxMDAsIDkwLCA1MCwgNDAsIDEwLCA5LCA1LCA0LCAxXSwKICAgIHJvbWFuID0gIiIsCiAgICB2LAogICAgbGVuID0gcm9tYW5BcnJheS5sZW5ndGg7CgogICAgaWYgKG51bWJlciA8PSAwIHx8IG51bWJlciA+PSA0MDAwKSB7CiAgICAgIHJldHVybiBudW1iZXI7CiAgICB9CgogICAgZm9yICh2PTA7IHYgPCBsZW47IHYrPTEpIHsKICAgICAgd2hpbGUgKG51bWJlciA+PSBkZWNpbWFsW3ZdKSB7CiAgICAgICAgbnVtYmVyIC09IGRlY2ltYWxbdl07CiAgICAgICAgcm9tYW4gKz0gcm9tYW5BcnJheVt2XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByb21hbjsKICB9Owp9KSgpOwpmdW5jdGlvbiBoMmNSZW5kZXJDb250ZXh0KHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgc3RvcmFnZSA9IFtdOwogIHJldHVybiB7CiAgICBzdG9yYWdlOiBzdG9yYWdlLAogICAgd2lkdGg6IHdpZHRoLAogICAgaGVpZ2h0OiBoZWlnaHQsCiAgICBjbGlwOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJjbGlwIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAidHJhbnNsYXRlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGw6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGwiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgc2F2ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAic2F2ZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICByZXN0b3JlOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJyZXN0b3JlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbFJlY3QiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgY3JlYXRlUGF0dGVybjogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiY3JlYXRlUGF0dGVybiIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBkcmF3U2hhcGU6IGZ1bmN0aW9uKCkgewoKICAgICAgdmFyIHNoYXBlID0gW107CgogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImRyYXdTaGFwZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IHNoYXBlCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBtb3ZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJtb3ZlVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGxpbmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogImxpbmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXJjVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJhcmNUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYmV6aWVyQ3VydmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogImJlemllckN1cnZlVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHF1YWRyYXRpY0N1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJxdWFkcmF0aWNDdXJ2ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0sCiAgICBkcmF3SW1hZ2U6IGZ1bmN0aW9uICgpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJkcmF3SW1hZ2UiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZmlsbFRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsVGV4dCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBzZXRWYXJpYWJsZTogZnVuY3Rpb24gKHZhcmlhYmxlLCB2YWx1ZSkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJ2YXJpYWJsZSIsCiAgICAgICAgbmFtZTogdmFyaWFibGUsCiAgICAgICAgJ2FyZ3VtZW50cyc6IHZhbHVlCiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfTsKfQpfaHRtbDJjYW52YXMuUGFyc2UgPSBmdW5jdGlvbiAoaW1hZ2VzLCBvcHRpb25zKSB7CiAgd2luZG93LnNjcm9sbCgwLDApOwoKICB2YXIgZWxlbWVudCA9ICgoIG9wdGlvbnMuZWxlbWVudHMgPT09IHVuZGVmaW5lZCApID8gZG9jdW1lbnQuYm9keSA6IG9wdGlvbnMuZWxlbWVudHNbMF0pLCAvLyBzZWxlY3QgYm9keSBieSBkZWZhdWx0CiAgbnVtRHJhd3MgPSAwLAogIGRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudCwKICBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgc3VwcG9ydCA9IFV0aWwuU3VwcG9ydChvcHRpb25zLCBkb2MpLAogIGlnbm9yZUVsZW1lbnRzUmVnRXhwID0gbmV3IFJlZ0V4cCgiKCIgKyBvcHRpb25zLmlnbm9yZUVsZW1lbnRzICsgIikiKSwKICBib2R5ID0gZG9jLmJvZHksCiAgZ2V0Q1NTID0gVXRpbC5nZXRDU1MsCiAgcHNldWRvSGlkZSA9ICJfX19odG1sMmNhbnZhc19fX3BzZXVkb2VsZW1lbnQiLAogIGhpZGVQc2V1ZG9FbGVtZW50cyA9IGRvYy5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwoKICBoaWRlUHNldWRvRWxlbWVudHMuaW5uZXJIVE1MID0gJy4nICsgcHNldWRvSGlkZSArICctYmVmb3JlOmJlZm9yZSB7IGNvbnRlbnQ6ICIiICFpbXBvcnRhbnQ7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfScgKwogICcuJyArIHBzZXVkb0hpZGUgKyAnLWFmdGVyOmFmdGVyIHsgY29udGVudDogIiIgIWltcG9ydGFudDsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9JzsKCiAgYm9keS5hcHBlbmRDaGlsZChoaWRlUHNldWRvRWxlbWVudHMpOwoKICBpbWFnZXMgPSBpbWFnZXMgfHwge307CgogIGZ1bmN0aW9uIGRvY3VtZW50V2lkdGggKCkgewogICAgcmV0dXJuIE1hdGgubWF4KAogICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50Lm9mZnNldFdpZHRoKSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50V2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiBkb2N1bWVudEhlaWdodCAoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LnNjcm9sbEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGdldENTU0ludChlbGVtZW50LCBhdHRyaWJ1dGUpIHsKICAgIHZhciB2YWwgPSBwYXJzZUludChnZXRDU1MoZWxlbWVudCwgYXR0cmlidXRlKSwgMTApOwogICAgcmV0dXJuIChpc05hTih2YWwpKSA/IDAgOiB2YWw7IC8vIGJvcmRlcnMgaW4gb2xkIElFIGFyZSB0aHJvd2luZyAnbWVkaXVtJyBmb3IgZGVtby5odG1sCiAgfQoKICBmdW5jdGlvbiByZW5kZXJSZWN0IChjdHgsIHgsIHksIHcsIGgsIGJnY29sb3IpIHsKICAgIGlmIChiZ2NvbG9yICE9PSAidHJhbnNwYXJlbnQiKXsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBiZ2NvbG9yKTsKICAgICAgY3R4LmZpbGxSZWN0KHgsIHksIHcsIGgpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhcGl0YWxpemUobSwgcDEsIHAyKSB7CiAgICBpZiAobS5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBwMSArIHAyLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0ZXh0VHJhbnNmb3JtICh0ZXh0LCB0cmFuc2Zvcm0pIHsKICAgIHN3aXRjaCh0cmFuc2Zvcm0pewogICAgICBjYXNlICJsb3dlcmNhc2UiOgogICAgICAgIHJldHVybiB0ZXh0LnRvTG93ZXJDYXNlKCk7CiAgICAgIGNhc2UgImNhcGl0YWxpemUiOgogICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoIC8oXnxcc3w6fC18XCh8XCkpKFthLXpdKS9nLCBjYXBpdGFsaXplKTsKICAgICAgY2FzZSAidXBwZXJjYXNlIjoKICAgICAgICByZXR1cm4gdGV4dC50b1VwcGVyQ2FzZSgpOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogIH0KCiAgZnVuY3Rpb24gbm9MZXR0ZXJTcGFjaW5nKGxldHRlcl9zcGFjaW5nKSB7CiAgICByZXR1cm4gKC9eKG5vcm1hbHxub25lfDBweCkkLy50ZXN0KGxldHRlcl9zcGFjaW5nKSk7CiAgfQoKICBmdW5jdGlvbiBkcmF3VGV4dChjdXJyZW50VGV4dCwgeCwgeSwgY3R4KXsKICAgIGlmIChjdXJyZW50VGV4dCAhPT0gbnVsbCAmJiBVdGlsLnRyaW1UZXh0KGN1cnJlbnRUZXh0KS5sZW5ndGggPiAwKSB7CiAgICAgIGN0eC5maWxsVGV4dChjdXJyZW50VGV4dCwgeCwgeSk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsLCB0ZXh0X2RlY29yYXRpb24sIGNvbG9yKSB7CiAgICB2YXIgYWxpZ24gPSBmYWxzZSwKICAgIGJvbGQgPSBnZXRDU1MoZWwsICJmb250V2VpZ2h0IiksCiAgICBmYW1pbHkgPSBnZXRDU1MoZWwsICJmb250RmFtaWx5IiksCiAgICBzaXplID0gZ2V0Q1NTKGVsLCAiZm9udFNpemUiKSwKICAgIHNoYWRvd3MgPSBVdGlsLnBhcnNlVGV4dFNoYWRvd3MoZ2V0Q1NTKGVsLCAidGV4dFNoYWRvdyIpKTsKCiAgICBzd2l0Y2gocGFyc2VJbnQoYm9sZCwgMTApKXsKICAgICAgY2FzZSA0MDE6CiAgICAgICAgYm9sZCA9ICJib2xkIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSA0MDA6CiAgICAgICAgYm9sZCA9ICJub3JtYWwiOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgY29sb3IpOwogICAgY3R4LnNldFZhcmlhYmxlKCJmb250IiwgW2dldENTUyhlbCwgImZvbnRTdHlsZSIpLCBnZXRDU1MoZWwsICJmb250VmFyaWFudCIpLCBib2xkLCBzaXplLCBmYW1pbHldLmpvaW4oIiAiKSk7CiAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsIChhbGlnbikgPyAicmlnaHQiIDogImxlZnQiKTsKCiAgICBpZiAoc2hhZG93cy5sZW5ndGgpIHsKICAgICAgLy8gVE9ETzogc3VwcG9ydCBtdWx0aXBsZSB0ZXh0IHNoYWRvd3MKICAgICAgLy8gYXBwbHkgdGhlIGZpcnN0IHRleHQgc2hhZG93CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93Q29sb3IiLCBzaGFkb3dzWzBdLmNvbG9yKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dPZmZzZXRYIiwgc2hhZG93c1swXS5vZmZzZXRYKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dPZmZzZXRZIiwgc2hhZG93c1swXS5vZmZzZXRZKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dCbHVyIiwgc2hhZG93c1swXS5ibHVyKTsKICAgIH0KCiAgICBpZiAodGV4dF9kZWNvcmF0aW9uICE9PSAibm9uZSIpewogICAgICByZXR1cm4gVXRpbC5Gb250KGZhbWlseSwgc2l6ZSwgZG9jKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlclRleHREZWNvcmF0aW9uKGN0eCwgdGV4dF9kZWNvcmF0aW9uLCBib3VuZHMsIG1ldHJpY3MsIGNvbG9yKSB7CiAgICBzd2l0Y2godGV4dF9kZWNvcmF0aW9uKSB7CiAgICAgIGNhc2UgInVuZGVybGluZSI6CiAgICAgICAgLy8gRHJhd3MgYSBsaW5lIGF0IHRoZSBiYXNlbGluZSBvZiB0aGUgZm9udAogICAgICAgIC8vIFRPRE8gQXMgc29tZSBicm93c2VycyBkaXNwbGF5IHRoZSBsaW5lIGFzIG1vcmUgdGhhbiAxcHggaWYgdGhlIGZvbnQtc2l6ZSBpcyBiaWcsIG5lZWQgdG8gdGFrZSB0aGF0IGludG8gYWNjb3VudCBib3RoIGluIHBvc2l0aW9uIGFuZCBzaXplCiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBtZXRyaWNzLmJhc2VsaW5lICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAib3ZlcmxpbmUiOgogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5yb3VuZChib3VuZHMudG9wKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxpbmUtdGhyb3VnaCI6CiAgICAgICAgLy8gVE9ETyB0cnkgYW5kIGZpbmQgZXhhY3QgcG9zaXRpb24gZm9yIGxpbmUtdGhyb3VnaAogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5jZWlsKGJvdW5kcy50b3AgKyBtZXRyaWNzLm1pZGRsZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRUZXh0Qm91bmRzKHN0YXRlLCB0ZXh0LCB0ZXh0RGVjb3JhdGlvbiwgaXNMYXN0LCB0cmFuc2Zvcm0pIHsKICAgIHZhciBib3VuZHM7CiAgICBpZiAoc3VwcG9ydC5yYW5nZUJvdW5kcyAmJiAhdHJhbnNmb3JtKSB7CiAgICAgIGlmICh0ZXh0RGVjb3JhdGlvbiAhPT0gIm5vbmUiIHx8IFV0aWwudHJpbVRleHQodGV4dCkubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgYm91bmRzID0gdGV4dFJhbmdlQm91bmRzKHRleHQsIHN0YXRlLm5vZGUsIHN0YXRlLnRleHRPZmZzZXQpOwogICAgICB9CiAgICAgIHN0YXRlLnRleHRPZmZzZXQgKz0gdGV4dC5sZW5ndGg7CiAgICB9IGVsc2UgaWYgKHN0YXRlLm5vZGUgJiYgdHlwZW9mIHN0YXRlLm5vZGUubm9kZVZhbHVlID09PSAic3RyaW5nIiApewogICAgICB2YXIgbmV3VGV4dE5vZGUgPSAoaXNMYXN0KSA/IHN0YXRlLm5vZGUuc3BsaXRUZXh0KHRleHQubGVuZ3RoKSA6IG51bGw7CiAgICAgIGJvdW5kcyA9IHRleHRXcmFwcGVyQm91bmRzKHN0YXRlLm5vZGUsIHRyYW5zZm9ybSk7CiAgICAgIHN0YXRlLm5vZGUgPSBuZXdUZXh0Tm9kZTsKICAgIH0KICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiB0ZXh0UmFuZ2VCb3VuZHModGV4dCwgdGV4dE5vZGUsIHRleHRPZmZzZXQpIHsKICAgIHZhciByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgcmFuZ2Uuc2V0U3RhcnQodGV4dE5vZGUsIHRleHRPZmZzZXQpOwogICAgcmFuZ2Uuc2V0RW5kKHRleHROb2RlLCB0ZXh0T2Zmc2V0ICsgdGV4dC5sZW5ndGgpOwogICAgcmV0dXJuIHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KCiAgZnVuY3Rpb24gdGV4dFdyYXBwZXJCb3VuZHMob2xkVGV4dE5vZGUsIHRyYW5zZm9ybSkgewogICAgdmFyIHBhcmVudCA9IG9sZFRleHROb2RlLnBhcmVudE5vZGUsCiAgICB3cmFwRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCd3cmFwcGVyJyksCiAgICBiYWNrdXBUZXh0ID0gb2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpOwoKICAgIHdyYXBFbGVtZW50LmFwcGVuZENoaWxkKG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKSk7CiAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBFbGVtZW50LCBvbGRUZXh0Tm9kZSk7CgogICAgdmFyIGJvdW5kcyA9IHRyYW5zZm9ybSA/IFV0aWwuT2Zmc2V0Qm91bmRzKHdyYXBFbGVtZW50KSA6IFV0aWwuQm91bmRzKHdyYXBFbGVtZW50KTsKICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQoYmFja3VwVGV4dCwgd3JhcEVsZW1lbnQpOwogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjaykgewogICAgdmFyIGN0eCA9IHN0YWNrLmN0eCwKICAgIGNvbG9yID0gZ2V0Q1NTKGVsLCAiY29sb3IiKSwKICAgIHRleHREZWNvcmF0aW9uID0gZ2V0Q1NTKGVsLCAidGV4dERlY29yYXRpb24iKSwKICAgIHRleHRBbGlnbiA9IGdldENTUyhlbCwgInRleHRBbGlnbiIpLAogICAgbWV0cmljcywKICAgIHRleHRMaXN0LAogICAgc3RhdGUgPSB7CiAgICAgIG5vZGU6IHRleHROb2RlLAogICAgICB0ZXh0T2Zmc2V0OiAwCiAgICB9OwoKICAgIGlmIChVdGlsLnRyaW1UZXh0KHRleHROb2RlLm5vZGVWYWx1ZSkubGVuZ3RoID4gMCkgewogICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUgPSB0ZXh0VHJhbnNmb3JtKHRleHROb2RlLm5vZGVWYWx1ZSwgZ2V0Q1NTKGVsLCAidGV4dFRyYW5zZm9ybSIpKTsKICAgICAgdGV4dEFsaWduID0gdGV4dEFsaWduLnJlcGxhY2UoWyItd2Via2l0LWF1dG8iXSxbImF1dG8iXSk7CgogICAgICB0ZXh0TGlzdCA9ICghb3B0aW9ucy5sZXR0ZXJSZW5kZXJpbmcgJiYgL14obGVmdHxyaWdodHxqdXN0aWZ5fGF1dG8pJC8udGVzdCh0ZXh0QWxpZ24pICYmIG5vTGV0dGVyU3BhY2luZyhnZXRDU1MoZWwsICJsZXR0ZXJTcGFjaW5nIikpKSA/CiAgICAgIHRleHROb2RlLm5vZGVWYWx1ZS5zcGxpdCgvKFxifCApLykKICAgICAgOiB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoIiIpOwoKICAgICAgbWV0cmljcyA9IHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbCwgdGV4dERlY29yYXRpb24sIGNvbG9yKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaW5lc2UpIHsKICAgICAgICB0ZXh0TGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHdvcmQsIGluZGV4KSB7CiAgICAgICAgICBpZiAoLy4qW1x1NEUwMC1cdTlGQTVdLiokLy50ZXN0KHdvcmQpKSB7CiAgICAgICAgICAgIHdvcmQgPSB3b3JkLnNwbGl0KCIiKTsKICAgICAgICAgICAgd29yZC51bnNoaWZ0KGluZGV4LCAxKTsKICAgICAgICAgICAgdGV4dExpc3Quc3BsaWNlLmFwcGx5KHRleHRMaXN0LCB3b3JkKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGV4dExpc3QuZm9yRWFjaChmdW5jdGlvbih0ZXh0LCBpbmRleCkgewogICAgICAgIHZhciBib3VuZHMgPSBnZXRUZXh0Qm91bmRzKHN0YXRlLCB0ZXh0LCB0ZXh0RGVjb3JhdGlvbiwgKGluZGV4IDwgdGV4dExpc3QubGVuZ3RoIC0gMSksIHN0YWNrLnRyYW5zZm9ybS5tYXRyaXgpOwogICAgICAgIGlmIChib3VuZHMpIHsKICAgICAgICAgIGRyYXdUZXh0KHRleHQsIGJvdW5kcy5sZWZ0LCBib3VuZHMuYm90dG9tLCBjdHgpOwogICAgICAgICAgcmVuZGVyVGV4dERlY29yYXRpb24oY3R4LCB0ZXh0RGVjb3JhdGlvbiwgYm91bmRzLCBtZXRyaWNzLCBjb2xvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxpc3RQb3NpdGlvbiAoZWxlbWVudCwgdmFsKSB7CiAgICB2YXIgYm91bmRFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJib3VuZGVsZW1lbnQiICksCiAgICBvcmlnaW5hbFR5cGUsCiAgICBib3VuZHM7CgogICAgYm91bmRFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiaW5saW5lIjsKCiAgICBvcmlnaW5hbFR5cGUgPSBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGU7CiAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSAibm9uZSI7CgogICAgYm91bmRFbGVtZW50LmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZSh2YWwpKTsKCiAgICBlbGVtZW50Lmluc2VydEJlZm9yZShib3VuZEVsZW1lbnQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7CgogICAgYm91bmRzID0gVXRpbC5Cb3VuZHMoYm91bmRFbGVtZW50KTsKICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoYm91bmRFbGVtZW50KTsKICAgIGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZSA9IG9yaWdpbmFsVHlwZTsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiBlbGVtZW50SW5kZXgoZWwpIHsKICAgIHZhciBpID0gLTEsCiAgICBjb3VudCA9IDEsCiAgICBjaGlsZHMgPSBlbC5wYXJlbnROb2RlLmNoaWxkTm9kZXM7CgogICAgaWYgKGVsLnBhcmVudE5vZGUpIHsKICAgICAgd2hpbGUoY2hpbGRzWysraV0gIT09IGVsKSB7CiAgICAgICAgaWYgKGNoaWxkc1tpXS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGNvdW50OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbGlzdEl0ZW1UZXh0KGVsZW1lbnQsIHR5cGUpIHsKICAgIHZhciBjdXJyZW50SW5kZXggPSBlbGVtZW50SW5kZXgoZWxlbWVudCksIHRleHQ7CiAgICBzd2l0Y2godHlwZSl7CiAgICAgIGNhc2UgImRlY2ltYWwiOgogICAgICAgIHRleHQgPSBjdXJyZW50SW5kZXg7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImRlY2ltYWwtbGVhZGluZy16ZXJvIjoKICAgICAgICB0ZXh0ID0gKGN1cnJlbnRJbmRleC50b1N0cmluZygpLmxlbmd0aCA9PT0gMSkgPyBjdXJyZW50SW5kZXggPSAiMCIgKyBjdXJyZW50SW5kZXgudG9TdHJpbmcoKSA6IGN1cnJlbnRJbmRleC50b1N0cmluZygpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ1cHBlci1yb21hbiI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsb3dlci1yb21hbiI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxvd2VyLWFscGhhIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBwZXItYWxwaGEiOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gdGV4dCArICIuICI7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJMaXN0SXRlbShlbGVtZW50LCBzdGFjaywgZWxCb3VuZHMpIHsKICAgIHZhciB4LAogICAgdGV4dCwKICAgIGN0eCA9IHN0YWNrLmN0eCwKICAgIHR5cGUgPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVR5cGUiKSwKICAgIGxpc3RCb3VuZHM7CgogICAgaWYgKC9eKGRlY2ltYWx8ZGVjaW1hbC1sZWFkaW5nLXplcm98dXBwZXItYWxwaGF8dXBwZXItbGF0aW58dXBwZXItcm9tYW58bG93ZXItYWxwaGF8bG93ZXItZ3JlZWt8bG93ZXItbGF0aW58bG93ZXItcm9tYW4pJC9pLnRlc3QodHlwZSkpIHsKICAgICAgdGV4dCA9IGxpc3RJdGVtVGV4dChlbGVtZW50LCB0eXBlKTsKICAgICAgbGlzdEJvdW5kcyA9IGxpc3RQb3NpdGlvbihlbGVtZW50LCB0ZXh0KTsKICAgICAgc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsZW1lbnQsICJub25lIiwgZ2V0Q1NTKGVsZW1lbnQsICJjb2xvciIpKTsKCiAgICAgIGlmIChnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVBvc2l0aW9uIikgPT09ICJpbnNpZGUiKSB7CiAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAibGVmdCIpOwogICAgICAgIHggPSBlbEJvdW5kcy5sZWZ0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZHJhd1RleHQodGV4dCwgeCwgbGlzdEJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2FkSW1hZ2UgKHNyYyl7CiAgICB2YXIgaW1nID0gaW1hZ2VzW3NyY107CiAgICByZXR1cm4gKGltZyAmJiBpbWcuc3VjY2VlZGVkID09PSB0cnVlKSA/IGltZy5pbWcgOiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGNsaXBCb3VuZHMoc3JjLCBkc3QpewogICAgdmFyIHggPSBNYXRoLm1heChzcmMubGVmdCwgZHN0LmxlZnQpLAogICAgeSA9IE1hdGgubWF4KHNyYy50b3AsIGRzdC50b3ApLAogICAgeDIgPSBNYXRoLm1pbigoc3JjLmxlZnQgKyBzcmMud2lkdGgpLCAoZHN0LmxlZnQgKyBkc3Qud2lkdGgpKSwKICAgIHkyID0gTWF0aC5taW4oKHNyYy50b3AgKyBzcmMuaGVpZ2h0KSwgKGRzdC50b3AgKyBkc3QuaGVpZ2h0KSk7CgogICAgcmV0dXJuIHsKICAgICAgbGVmdDp4LAogICAgICB0b3A6eSwKICAgICAgd2lkdGg6eDIteCwKICAgICAgaGVpZ2h0OnkyLXkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzZXRaKGVsZW1lbnQsIHN0YWNrLCBwYXJlbnRTdGFjayl7CiAgICB2YXIgbmV3Q29udGV4dCwKICAgIGlzUG9zaXRpb25lZCA9IHN0YWNrLmNzc1Bvc2l0aW9uICE9PSAnc3RhdGljJywKICAgIHpJbmRleCA9IGlzUG9zaXRpb25lZCA/IGdldENTUyhlbGVtZW50LCAnekluZGV4JykgOiAnYXV0bycsCiAgICBvcGFjaXR5ID0gZ2V0Q1NTKGVsZW1lbnQsICdvcGFjaXR5JyksCiAgICBpc0Zsb2F0ZWQgPSBnZXRDU1MoZWxlbWVudCwgJ2Nzc0Zsb2F0JykgIT09ICdub25lJzsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9HdWlkZS9DU1MvVW5kZXJzdGFuZGluZ196X2luZGV4L1RoZV9zdGFja2luZ19jb250ZXh0CiAgICAvLyBXaGVuIGEgbmV3IHN0YWNraW5nIGNvbnRleHQgc2hvdWxkIGJlIGNyZWF0ZWQ6CiAgICAvLyB0aGUgcm9vdCBlbGVtZW50IChIVE1MKSwKICAgIC8vIHBvc2l0aW9uZWQgKGFic29sdXRlbHkgb3IgcmVsYXRpdmVseSkgd2l0aCBhIHotaW5kZXggdmFsdWUgb3RoZXIgdGhhbiAiYXV0byIsCiAgICAvLyBlbGVtZW50cyB3aXRoIGFuIG9wYWNpdHkgdmFsdWUgbGVzcyB0aGFuIDEuIChTZWUgdGhlIHNwZWNpZmljYXRpb24gZm9yIG9wYWNpdHkpLAogICAgLy8gb24gbW9iaWxlIFdlYktpdCBhbmQgQ2hyb21lIDIyKywgcG9zaXRpb246IGZpeGVkIGFsd2F5cyBjcmVhdGVzIGEgbmV3IHN0YWNraW5nIGNvbnRleHQsIGV2ZW4gd2hlbiB6LWluZGV4IGlzICJhdXRvIiAoU2VlIHRoaXMgcG9zdCkKCiAgICBzdGFjay56SW5kZXggPSBuZXdDb250ZXh0ID0gaDJjekNvbnRleHQoekluZGV4KTsKICAgIG5ld0NvbnRleHQuaXNQb3NpdGlvbmVkID0gaXNQb3NpdGlvbmVkOwogICAgbmV3Q29udGV4dC5pc0Zsb2F0ZWQgPSBpc0Zsb2F0ZWQ7CiAgICBuZXdDb250ZXh0Lm9wYWNpdHkgPSBvcGFjaXR5OwogICAgbmV3Q29udGV4dC5vd25TdGFja2luZyA9ICh6SW5kZXggIT09ICdhdXRvJyB8fCBvcGFjaXR5IDwgMSk7CgogICAgaWYgKHBhcmVudFN0YWNrKSB7CiAgICAgIHBhcmVudFN0YWNrLnpJbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgaW1hZ2UsIGJvdW5kcywgYm9yZGVycykgewoKICAgIHZhciBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ0xlZnQnKSwKICAgIHBhZGRpbmdUb3AgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdUb3AnKSwKICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ1JpZ2h0JyksCiAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nQm90dG9tJyk7CgogICAgZHJhd0ltYWdlKAogICAgICBjdHgsCiAgICAgIGltYWdlLAogICAgICAwLCAvL3N4CiAgICAgIDAsIC8vc3kKICAgICAgaW1hZ2Uud2lkdGgsIC8vc3cKICAgICAgaW1hZ2UuaGVpZ2h0LCAvL3NoCiAgICAgIGJvdW5kcy5sZWZ0ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgIGJvdW5kcy50b3AgKyBwYWRkaW5nVG9wICsgYm9yZGVyc1swXS53aWR0aCwgLy8gZHkKICAgICAgYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoICsgcGFkZGluZ0xlZnQgKyBwYWRkaW5nUmlnaHQpLCAvL2R3CiAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyRGF0YShlbGVtZW50KSB7CiAgICByZXR1cm4gWyJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiXS5tYXAoZnVuY3Rpb24oc2lkZSkgewogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBnZXRDU1NJbnQoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ1dpZHRoJyksCiAgICAgICAgY29sb3I6IGdldENTUyhlbGVtZW50LCAnYm9yZGVyJyArIHNpZGUgKyAnQ29sb3InKQogICAgICB9OwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRCb3JkZXJSYWRpdXNEYXRhKGVsZW1lbnQpIHsKICAgIHJldHVybiBbIlRvcExlZnQiLCAiVG9wUmlnaHQiLCAiQm90dG9tUmlnaHQiLCAiQm90dG9tTGVmdCJdLm1hcChmdW5jdGlvbihzaWRlKSB7CiAgICAgIHJldHVybiBnZXRDU1MoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ1JhZGl1cycpOwogICAgfSk7CiAgfQoKICB2YXIgZ2V0Q3VydmVQb2ludHMgPSAoZnVuY3Rpb24oa2FwcGEpIHsKCiAgICByZXR1cm4gZnVuY3Rpb24oeCwgeSwgcjEsIHIyKSB7CiAgICAgIHZhciBveCA9IChyMSkgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgaG9yaXpvbnRhbAogICAgICBveSA9IChyMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgdmVydGljYWwKICAgICAgeG0gPSB4ICsgcjEsIC8vIHgtbWlkZGxlCiAgICAgIHltID0geSArIHIyOyAvLyB5LW1pZGRsZQogICAgICByZXR1cm4gewogICAgICAgIHRvcExlZnQ6IGJlemllckN1cnZlKHsKICAgICAgICAgIHg6eCwKICAgICAgICAgIHk6eW0KICAgICAgICB9LCB7CiAgICAgICAgICB4OngsCiAgICAgICAgICB5OnltIC0gb3kKICAgICAgICB9LCB7CiAgICAgICAgICB4OnhtIC0gb3gsCiAgICAgICAgICB5OnkKICAgICAgICB9LCB7CiAgICAgICAgICB4OnhtLAogICAgICAgICAgeTp5CiAgICAgICAgfSksCiAgICAgICAgdG9wUmlnaHQ6IGJlemllckN1cnZlKHsKICAgICAgICAgIHg6eCwKICAgICAgICAgIHk6eQogICAgICAgIH0sIHsKICAgICAgICAgIHg6eCArIG94LAogICAgICAgICAgeTp5CiAgICAgICAgfSwgewogICAgICAgICAgeDp4bSwKICAgICAgICAgIHk6eW0gLSBveQogICAgICAgIH0sIHsKICAgICAgICAgIHg6eG0sCiAgICAgICAgICB5OnltCiAgICAgICAgfSksCiAgICAgICAgYm90dG9tUmlnaHQ6IGJlemllckN1cnZlKHsKICAgICAgICAgIHg6eG0sCiAgICAgICAgICB5OnkKICAgICAgICB9LCB7CiAgICAgICAgICB4OnhtLAogICAgICAgICAgeTp5ICsgb3kKICAgICAgICB9LCB7CiAgICAgICAgICB4OnggKyBveCwKICAgICAgICAgIHk6eW0KICAgICAgICB9LCB7CiAgICAgICAgICB4OngsCiAgICAgICAgICB5OnltCiAgICAgICAgfSksCiAgICAgICAgYm90dG9tTGVmdDogYmV6aWVyQ3VydmUoewogICAgICAgICAgeDp4bSwKICAgICAgICAgIHk6eW0KICAgICAgICB9LCB7CiAgICAgICAgICB4OnhtIC0gb3gsCiAgICAgICAgICB5OnltCiAgICAgICAgfSwgewogICAgICAgICAgeDp4LAogICAgICAgICAgeTp5ICsgb3kKICAgICAgICB9LCB7CiAgICAgICAgICB4OngsCiAgICAgICAgICB5OnkKICAgICAgICB9KQogICAgICB9OwogICAgfTsKICB9KSg0ICogKChNYXRoLnNxcnQoMikgLSAxKSAvIDMpKTsKCiAgZnVuY3Rpb24gYmV6aWVyQ3VydmUoc3RhcnQsIHN0YXJ0Q29udHJvbCwgZW5kQ29udHJvbCwgZW5kKSB7CgogICAgdmFyIGxlcnAgPSBmdW5jdGlvbiAoYSwgYiwgdCkgewogICAgICByZXR1cm4gewogICAgICAgIHg6YS54ICsgKGIueCAtIGEueCkgKiB0LAogICAgICAgIHk6YS55ICsgKGIueSAtIGEueSkgKiB0CiAgICAgIH07CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgc3RhcnRDb250cm9sOiBzdGFydENvbnRyb2wsCiAgICAgIGVuZENvbnRyb2w6IGVuZENvbnRyb2wsCiAgICAgIGVuZDogZW5kLAogICAgICBzdWJkaXZpZGU6IGZ1bmN0aW9uKHQpIHsKICAgICAgICB2YXIgYWIgPSBsZXJwKHN0YXJ0LCBzdGFydENvbnRyb2wsIHQpLAogICAgICAgIGJjID0gbGVycChzdGFydENvbnRyb2wsIGVuZENvbnRyb2wsIHQpLAogICAgICAgIGNkID0gbGVycChlbmRDb250cm9sLCBlbmQsIHQpLAogICAgICAgIGFiYmMgPSBsZXJwKGFiLCBiYywgdCksCiAgICAgICAgYmNjZCA9IGxlcnAoYmMsIGNkLCB0KSwKICAgICAgICBkZXN0ID0gbGVycChhYmJjLCBiY2NkLCB0KTsKICAgICAgICByZXR1cm4gW2JlemllckN1cnZlKHN0YXJ0LCBhYiwgYWJiYywgZGVzdCksIGJlemllckN1cnZlKGRlc3QsIGJjY2QsIGNkLCBlbmQpXTsKICAgICAgfSwKICAgICAgY3VydmVUbzogZnVuY3Rpb24oYm9yZGVyQXJncykgewogICAgICAgIGJvcmRlckFyZ3MucHVzaChbImJlemllckN1cnZlIiwgc3RhcnRDb250cm9sLngsIHN0YXJ0Q29udHJvbC55LCBlbmRDb250cm9sLngsIGVuZENvbnRyb2wueSwgZW5kLngsIGVuZC55XSk7CiAgICAgIH0sCiAgICAgIGN1cnZlVG9SZXZlcnNlZDogZnVuY3Rpb24oYm9yZGVyQXJncykgewogICAgICAgIGJvcmRlckFyZ3MucHVzaChbImJlemllckN1cnZlIiwgZW5kQ29udHJvbC54LCBlbmRDb250cm9sLnksIHN0YXJ0Q29udHJvbC54LCBzdGFydENvbnRyb2wueSwgc3RhcnQueCwgc3RhcnQueV0pOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzMSwgcmFkaXVzMiwgY29ybmVyMSwgY29ybmVyMiwgeCwgeSkgewogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBjb3JuZXIxWzBdLnN0YXJ0LngsIGNvcm5lcjFbMF0uc3RhcnQueV0pOwogICAgICBjb3JuZXIxWzBdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICAgIGNvcm5lcjFbMV0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCB4LCB5XSk7CiAgICB9CgogICAgaWYgKHJhZGl1czJbMF0gPiAwIHx8IHJhZGl1czJbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBjb3JuZXIyWzBdLnN0YXJ0LngsIGNvcm5lcjJbMF0uc3RhcnQueV0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZHJhd1NpZGUoYm9yZGVyRGF0YSwgcmFkaXVzMSwgcmFkaXVzMiwgb3V0ZXIxLCBpbm5lcjEsIG91dGVyMiwgaW5uZXIyKSB7CiAgICB2YXIgYm9yZGVyQXJncyA9IFtdOwoKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgb3V0ZXIxWzFdLnN0YXJ0LngsIG91dGVyMVsxXS5zdGFydC55XSk7CiAgICAgIG91dGVyMVsxXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMxWzBdLCBib3JkZXJEYXRhLmMxWzFdXSk7CiAgICB9CgogICAgaWYgKHJhZGl1czJbMF0gPiAwIHx8IHJhZGl1czJbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBvdXRlcjJbMF0uc3RhcnQueCwgb3V0ZXIyWzBdLnN0YXJ0LnldKTsKICAgICAgb3V0ZXIyWzBdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBpbm5lcjJbMF0uZW5kLngsIGlubmVyMlswXS5lbmQueV0pOwogICAgICBpbm5lcjJbMF0uY3VydmVUb1JldmVyc2VkKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMyWzBdLCBib3JkZXJEYXRhLmMyWzFdXSk7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jM1swXSwgYm9yZGVyRGF0YS5jM1sxXV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgaW5uZXIxWzFdLmVuZC54LCBpbm5lcjFbMV0uZW5kLnldKTsKICAgICAgaW5uZXIxWzFdLmN1cnZlVG9SZXZlcnNlZChib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jNFswXSwgYm9yZGVyRGF0YS5jNFsxXV0pOwogICAgfQoKICAgIHJldHVybiBib3JkZXJBcmdzOwogIH0KCiAgZnVuY3Rpb24gY2FsY3VsYXRlQ3VydmVQb2ludHMoYm91bmRzLCBib3JkZXJSYWRpdXMsIGJvcmRlcnMpIHsKCiAgICB2YXIgeCA9IGJvdW5kcy5sZWZ0LAogICAgeSA9IGJvdW5kcy50b3AsCiAgICB3aWR0aCA9IGJvdW5kcy53aWR0aCwKICAgIGhlaWdodCA9IGJvdW5kcy5oZWlnaHQsCgogICAgdGxoID0gYm9yZGVyUmFkaXVzWzBdWzBdLAogICAgdGx2ID0gYm9yZGVyUmFkaXVzWzBdWzFdLAogICAgdHJoID0gYm9yZGVyUmFkaXVzWzFdWzBdLAogICAgdHJ2ID0gYm9yZGVyUmFkaXVzWzFdWzFdLAogICAgYnJoID0gYm9yZGVyUmFkaXVzWzJdWzBdLAogICAgYnJ2ID0gYm9yZGVyUmFkaXVzWzJdWzFdLAogICAgYmxoID0gYm9yZGVyUmFkaXVzWzNdWzBdLAogICAgYmx2ID0gYm9yZGVyUmFkaXVzWzNdWzFdLAoKICAgIHRvcFdpZHRoID0gd2lkdGggLSB0cmgsCiAgICByaWdodEhlaWdodCA9IGhlaWdodCAtIGJydiwKICAgIGJvdHRvbVdpZHRoID0gd2lkdGggLSBicmgsCiAgICBsZWZ0SGVpZ2h0ID0gaGVpZ2h0IC0gYmx2OwoKICAgIHJldHVybiB7CiAgICAgIHRvcExlZnRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIHRsaCwKICAgICAgICB0bHYKICAgICAgICApLnRvcExlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BMZWZ0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHkgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICAgIE1hdGgubWF4KDAsIHRsaCAtIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIHRsdiAtIGJvcmRlcnNbMF0ud2lkdGgpCiAgICAgICAgKS50b3BMZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wUmlnaHRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIHRvcFdpZHRoLAogICAgICAgIHksCiAgICAgICAgdHJoLAogICAgICAgIHRydgogICAgICAgICkudG9wUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BSaWdodElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgTWF0aC5taW4odG9wV2lkdGgsIHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgKHRvcFdpZHRoID4gd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSA/IDAgOnRyaCAtIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgdHJ2IC0gYm9yZGVyc1swXS53aWR0aAogICAgICAgICkudG9wUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21SaWdodE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm90dG9tV2lkdGgsCiAgICAgICAgeSArIHJpZ2h0SGVpZ2h0LAogICAgICAgIGJyaCwKICAgICAgICBicnYKICAgICAgICApLmJvdHRvbVJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tUmlnaHRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIE1hdGgubWluKGJvdHRvbVdpZHRoLCB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIHkgKyBNYXRoLm1pbihyaWdodEhlaWdodCwgaGVpZ2h0ICsgYm9yZGVyc1swXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYnJoIC0gYm9yZGVyc1sxXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYnJ2IC0gYm9yZGVyc1syXS53aWR0aCkKICAgICAgICApLmJvdHRvbVJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tTGVmdE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4LAogICAgICAgIHkgKyBsZWZ0SGVpZ2h0LAogICAgICAgIGJsaCwKICAgICAgICBibHYKICAgICAgICApLmJvdHRvbUxlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21MZWZ0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHkgKyBsZWZ0SGVpZ2h0LAogICAgICAgIE1hdGgubWF4KDAsIGJsaCAtIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJsdiAtIGJvcmRlcnNbMl0ud2lkdGgpCiAgICAgICAgKS5ib3R0b21MZWZ0LnN1YmRpdmlkZSgwLjUpCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyQ2xpcChlbGVtZW50LCBib3JkZXJQb2ludHMsIGJvcmRlcnMsIHJhZGl1cywgYm91bmRzKSB7CiAgICB2YXIgYmFja2dyb3VuZENsaXAgPSBnZXRDU1MoZWxlbWVudCwgJ2JhY2tncm91bmRDbGlwJyksCiAgICBib3JkZXJBcmdzID0gW107CgogICAgc3dpdGNoKGJhY2tncm91bmRDbGlwKSB7CiAgICAgIGNhc2UgImNvbnRlbnQtYm94IjoKICAgICAgY2FzZSAicGFkZGluZy1ib3giOgogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1swXSwgcmFkaXVzWzFdLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLCBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzFdLCByYWRpdXNbMl0sIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGggLSBib3JkZXJzWzFdLndpZHRoLCBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzJdLCByYWRpdXNbM10sIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCAtIGJvcmRlcnNbMV0ud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0IC0gYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzNdLCByYWRpdXNbMF0sIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQgLSBib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzBdLCByYWRpdXNbMV0sIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzFdLCByYWRpdXNbMl0sIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGgsIGJvdW5kcy50b3ApOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1syXSwgcmFkaXVzWzNdLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbM10sIHJhZGl1c1swXSwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gYm9yZGVyQXJnczsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQm9yZGVycyhlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpewogICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgIHkgPSBib3VuZHMudG9wLAogICAgd2lkdGggPSBib3VuZHMud2lkdGgsCiAgICBoZWlnaHQgPSBib3VuZHMuaGVpZ2h0LAogICAgYm9yZGVyU2lkZSwKICAgIGJ4LAogICAgYnksCiAgICBidywKICAgIGJoLAogICAgYm9yZGVyQXJncywKICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtYmFja2dyb3VuZC8jdGhlLWJvcmRlci1yYWRpdXMKICAgIGJvcmRlclJhZGl1cyA9IGdldEJvcmRlclJhZGl1c0RhdGEoZWxlbWVudCksCiAgICBib3JkZXJQb2ludHMgPSBjYWxjdWxhdGVDdXJ2ZVBvaW50cyhib3VuZHMsIGJvcmRlclJhZGl1cywgYm9yZGVycyksCiAgICBib3JkZXJEYXRhID0gewogICAgICBjbGlwOiBnZXRCb3JkZXJDbGlwKGVsZW1lbnQsIGJvcmRlclBvaW50cywgYm9yZGVycywgYm9yZGVyUmFkaXVzLCBib3VuZHMpLAogICAgICBib3JkZXJzOiBbXQogICAgfTsKCiAgICBmb3IgKGJvcmRlclNpZGUgPSAwOyBib3JkZXJTaWRlIDwgNDsgYm9yZGVyU2lkZSsrKSB7CgogICAgICBpZiAoYm9yZGVyc1tib3JkZXJTaWRlXS53aWR0aCA+IDApIHsKICAgICAgICBieCA9IHg7CiAgICAgICAgYnkgPSB5OwogICAgICAgIGJ3ID0gd2lkdGg7CiAgICAgICAgYmggPSBoZWlnaHQgLSAoYm9yZGVyc1syXS53aWR0aCk7CgogICAgICAgIHN3aXRjaChib3JkZXJTaWRlKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIC8vIHRvcCBib3JkZXIKICAgICAgICAgICAgYmggPSBib3JkZXJzWzBdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4LCBieV0sCiAgICAgICAgICAgICAgYzI6IFtieCArIGJ3LCBieV0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJ3IC0gYm9yZGVyc1sxXS53aWR0aCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJvcmRlcnNbM10ud2lkdGgsIGJ5ICsgYmhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1swXSwgYm9yZGVyUmFkaXVzWzFdLAogICAgICAgICAgICBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgLy8gcmlnaHQgYm9yZGVyCiAgICAgICAgICAgIGJ4ID0geCArIHdpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGgpOwogICAgICAgICAgICBidyA9IGJvcmRlcnNbMV0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYnggKyBidywgYnldLAogICAgICAgICAgICAgIGMyOiBbYnggKyBidywgYnkgKyBiaCArIGJvcmRlcnNbMl0ud2lkdGhdLAogICAgICAgICAgICAgIGMzOiBbYngsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGM0OiBbYngsIGJ5ICsgYm9yZGVyc1swXS53aWR0aF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzFdLCBib3JkZXJSYWRpdXNbMl0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIC8vIGJvdHRvbSBib3JkZXIKICAgICAgICAgICAgYnkgPSAoYnkgKyBoZWlnaHQpIC0gKGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgICAgICBiaCA9IGJvcmRlcnNbMl0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYnggKyBidywgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzI6IFtieCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJvcmRlcnNbM10ud2lkdGgsIGJ5XSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYncgLSBib3JkZXJzWzNdLndpZHRoLCBieV0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzJdLCBib3JkZXJSYWRpdXNbM10sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAvLyBsZWZ0IGJvcmRlcgogICAgICAgICAgICBidyA9IGJvcmRlcnNbM10ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYngsIGJ5ICsgYmggKyBib3JkZXJzWzJdLndpZHRoXSwKICAgICAgICAgICAgICBjMjogW2J4LCBieV0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJ3LCBieSArIGJvcmRlcnNbMF0ud2lkdGhdLAogICAgICAgICAgICAgIGM0OiBbYnggKyBidywgYnkgKyBiaF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzNdLCBib3JkZXJSYWRpdXNbMF0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGJvcmRlckRhdGEuYm9yZGVycy5wdXNoKHsKICAgICAgICAgIGFyZ3M6IGJvcmRlckFyZ3MsCiAgICAgICAgICBjb2xvcjogYm9yZGVyc1tib3JkZXJTaWRlXS5jb2xvcgogICAgICAgIH0pOwoKICAgICAgfQogICAgfQoKICAgIHJldHVybiBib3JkZXJEYXRhOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlU2hhcGUoY3R4LCBhcmdzKSB7CiAgICB2YXIgc2hhcGUgPSBjdHguZHJhd1NoYXBlKCk7CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYm9yZGVyLCBpbmRleCkgewogICAgICBzaGFwZVsoaW5kZXggPT09IDApID8gIm1vdmVUbyIgOiBib3JkZXJbMF0gKyAiVG8iIF0uYXBwbHkobnVsbCwgYm9yZGVyLnNsaWNlKDEpKTsKICAgIH0pOwogICAgcmV0dXJuIHNoYXBlOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQm9yZGVycyhjdHgsIGJvcmRlckFyZ3MsIGNvbG9yKSB7CiAgICBpZiAoY29sb3IgIT09ICJ0cmFuc3BhcmVudCIpIHsKICAgICAgY3R4LnNldFZhcmlhYmxlKCAiZmlsbFN0eWxlIiwgY29sb3IpOwogICAgICBjcmVhdGVTaGFwZShjdHgsIGJvcmRlckFyZ3MpOwogICAgICBjdHguZmlsbCgpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckZvcm1WYWx1ZSAoZWwsIGJvdW5kcywgc3RhY2spewoKICAgIHZhciB2YWx1ZVdyYXAgPSBkb2MuY3JlYXRlRWxlbWVudCgndmFsdWV3cmFwJyksCiAgICBjc3NQcm9wZXJ0eUFycmF5ID0gWydsaW5lSGVpZ2h0JywndGV4dEFsaWduJywnZm9udEZhbWlseScsJ2NvbG9yJywnZm9udFNpemUnLCdwYWRkaW5nTGVmdCcsJ3BhZGRpbmdUb3AnLCd3aWR0aCcsJ2hlaWdodCcsJ2JvcmRlcicsJ2JvcmRlckxlZnRXaWR0aCcsJ2JvcmRlclRvcFdpZHRoJ10sCiAgICB0ZXh0VmFsdWUsCiAgICB0ZXh0Tm9kZTsKCiAgICBjc3NQcm9wZXJ0eUFycmF5LmZvckVhY2goZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YWx1ZVdyYXAuc3R5bGVbcHJvcGVydHldID0gZ2V0Q1NTKGVsLCBwcm9wZXJ0eSk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIC8vIE9sZGVyIElFIGhhcyBpc3N1ZXMgd2l0aCAiYm9yZGVyIgogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUGFyc2U6IEV4Y2VwdGlvbiBjYXVnaHQgaW4gcmVuZGVyRm9ybVZhbHVlOiAiICsgZS5tZXNzYWdlKTsKICAgICAgfQogICAgfSk7CgogICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlckNvbG9yID0gImJsYWNrIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJTdHlsZSA9ICJzb2xpZCI7CiAgICB2YWx1ZVdyYXAuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICB2YWx1ZVdyYXAuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwoKICAgIGlmICgvXihzdWJtaXR8cmVzZXR8YnV0dG9ufHRleHR8cGFzc3dvcmQpJC8udGVzdChlbC50eXBlKSB8fCBlbC5ub2RlTmFtZSA9PT0gIlNFTEVDVCIpewogICAgICB2YWx1ZVdyYXAuc3R5bGUubGluZUhlaWdodCA9IGdldENTUyhlbCwgImhlaWdodCIpOwogICAgfQoKICAgIHZhbHVlV3JhcC5zdHlsZS50b3AgPSBib3VuZHMudG9wICsgInB4IjsKICAgIHZhbHVlV3JhcC5zdHlsZS5sZWZ0ID0gYm91bmRzLmxlZnQgKyAicHgiOwoKICAgIHRleHRWYWx1ZSA9IChlbC5ub2RlTmFtZSA9PT0gIlNFTEVDVCIpID8gKGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0gfHwgMCkudGV4dCA6IGVsLnZhbHVlOwogICAgaWYoIXRleHRWYWx1ZSkgewogICAgICB0ZXh0VmFsdWUgPSBlbC5wbGFjZWhvbGRlcjsKICAgIH0KCiAgICB0ZXh0Tm9kZSA9IGRvYy5jcmVhdGVUZXh0Tm9kZSh0ZXh0VmFsdWUpOwoKICAgIHZhbHVlV3JhcC5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICBib2R5LmFwcGVuZENoaWxkKHZhbHVlV3JhcCk7CgogICAgcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKTsKICAgIGJvZHkucmVtb3ZlQ2hpbGQodmFsdWVXcmFwKTsKICB9CgogIGZ1bmN0aW9uIGRyYXdJbWFnZSAoY3R4KSB7CiAgICBjdHguZHJhd0ltYWdlLmFwcGx5KGN0eCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBudW1EcmF3cys9MTsKICB9CgogIGZ1bmN0aW9uIGdldFBzZXVkb0VsZW1lbnQoZWwsIHdoaWNoKSB7CiAgICB2YXIgZWxTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsLCB3aGljaCk7CiAgICBpZighZWxTdHlsZSB8fCAhZWxTdHlsZS5jb250ZW50IHx8IGVsU3R5bGUuY29udGVudCA9PT0gIm5vbmUiIHx8IGVsU3R5bGUuY29udGVudCA9PT0gIi1tb3otYWx0LWNvbnRlbnQiIHx8IGVsU3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBjb250ZW50ID0gZWxTdHlsZS5jb250ZW50ICsgJycsCiAgICBmaXJzdCA9IGNvbnRlbnQuc3Vic3RyKCAwLCAxICk7CiAgICAvL3N0cmlwcyBxdW90ZXMKICAgIGlmKGZpcnN0ID09PSBjb250ZW50LnN1YnN0ciggY29udGVudC5sZW5ndGggLSAxICkgJiYgZmlyc3QubWF0Y2goLyd8Ii8pKSB7CiAgICAgIGNvbnRlbnQgPSBjb250ZW50LnN1YnN0ciggMSwgY29udGVudC5sZW5ndGggLSAyICk7CiAgICB9CgogICAgdmFyIGlzSW1hZ2UgPSBjb250ZW50LnN1YnN0ciggMCwgMyApID09PSAndXJsJywKICAgIGVscHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBpc0ltYWdlID8gJ2ltZycgOiAnc3BhbicgKTsKCiAgICBlbHBzLmNsYXNzTmFtZSA9IHBzZXVkb0hpZGUgKyAiLWJlZm9yZSAiICsgcHNldWRvSGlkZSArICItYWZ0ZXIiOwoKICAgIE9iamVjdC5rZXlzKGVsU3R5bGUpLmZpbHRlcihpbmRleGVkUHJvcGVydHkpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAvLyBQcmV2ZW50IGFzc2lnbmluZyBvZiByZWFkIG9ubHkgQ1NTIFJ1bGVzLCBleC4gbGVuZ3RoLCBwYXJlbnRSdWxlCiAgICAgIHRyeSB7CiAgICAgICAgZWxwcy5zdHlsZVtwcm9wXSA9IGVsU3R5bGVbcHJvcF07CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBVdGlsLmxvZyhbJ1RyaWVkIHRvIGFzc2lnbiByZWFkb25seSBwcm9wZXJ0eSAnLCBwcm9wLCAnRXJyb3I6JywgZV0pOwogICAgICB9CiAgICB9KTsKCiAgICBpZihpc0ltYWdlKSB7CiAgICAgIGVscHMuc3JjID0gVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdOwogICAgfSBlbHNlIHsKICAgICAgZWxwcy5pbm5lckhUTUwgPSBjb250ZW50OwogICAgfQogICAgcmV0dXJuIGVscHM7CiAgfQoKICBmdW5jdGlvbiBpbmRleGVkUHJvcGVydHkocHJvcGVydHkpIHsKICAgIHJldHVybiAoaXNOYU4od2luZG93LnBhcnNlSW50KHByb3BlcnR5LCAxMCkpKTsKICB9CgogIGZ1bmN0aW9uIGluamVjdFBzZXVkb0VsZW1lbnRzKGVsLCBzdGFjaykgewogICAgdmFyIGJlZm9yZSA9IGdldFBzZXVkb0VsZW1lbnQoZWwsICc6YmVmb3JlJyksCiAgICBhZnRlciA9IGdldFBzZXVkb0VsZW1lbnQoZWwsICc6YWZ0ZXInKTsKICAgIGlmKCFiZWZvcmUgJiYgIWFmdGVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZihiZWZvcmUpIHsKICAgICAgZWwuY2xhc3NOYW1lICs9ICIgIiArIHBzZXVkb0hpZGUgKyAiLWJlZm9yZSI7CiAgICAgIGVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGJlZm9yZSwgZWwpOwogICAgICBwYXJzZUVsZW1lbnQoYmVmb3JlLCBzdGFjaywgdHJ1ZSk7CiAgICAgIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYmVmb3JlKTsKICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lLnJlcGxhY2UocHNldWRvSGlkZSArICItYmVmb3JlIiwgIiIpLnRyaW0oKTsKICAgIH0KCiAgICBpZiAoYWZ0ZXIpIHsKICAgICAgZWwuY2xhc3NOYW1lICs9ICIgIiArIHBzZXVkb0hpZGUgKyAiLWFmdGVyIjsKICAgICAgZWwuYXBwZW5kQ2hpbGQoYWZ0ZXIpOwogICAgICBwYXJzZUVsZW1lbnQoYWZ0ZXIsIHN0YWNrLCB0cnVlKTsKICAgICAgZWwucmVtb3ZlQ2hpbGQoYWZ0ZXIpOwogICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUucmVwbGFjZShwc2V1ZG9IaWRlICsgIi1hZnRlciIsICIiKS50cmltKCk7CiAgICB9CgogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcykgewogICAgdmFyIG9mZnNldFggPSBNYXRoLnJvdW5kKGJvdW5kcy5sZWZ0ICsgYmFja2dyb3VuZFBvc2l0aW9uLmxlZnQpLAogICAgb2Zmc2V0WSA9IE1hdGgucm91bmQoYm91bmRzLnRvcCArIGJhY2tncm91bmRQb3NpdGlvbi50b3ApOwoKICAgIGN0eC5jcmVhdGVQYXR0ZXJuKGltYWdlKTsKICAgIGN0eC50cmFuc2xhdGUob2Zmc2V0WCwgb2Zmc2V0WSk7CiAgICBjdHguZmlsbCgpOwogICAgY3R4LnRyYW5zbGF0ZSgtb2Zmc2V0WCwgLW9mZnNldFkpOwogIH0KCiAgZnVuY3Rpb24gYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLCBsZWZ0LCB0b3AsIHdpZHRoLCBoZWlnaHQpIHsKICAgIHZhciBhcmdzID0gW107CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0KSwgTWF0aC5yb3VuZCh0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0ICsgd2lkdGgpLCBNYXRoLnJvdW5kKHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQgKyB3aWR0aCksIE1hdGgucm91bmQoaGVpZ2h0ICsgdG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCksIE1hdGgucm91bmQoaGVpZ2h0ICsgdG9wKV0pOwogICAgY3JlYXRlU2hhcGUoY3R4LCBhcmdzKTsKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguY2xpcCgpOwogICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcyk7CiAgICBjdHgucmVzdG9yZSgpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZENvbG9yKGN0eCwgYmFja2dyb3VuZEJvdW5kcywgYmdjb2xvcikgewogICAgcmVuZGVyUmVjdCgKICAgICAgY3R4LAogICAgICBiYWNrZ3JvdW5kQm91bmRzLmxlZnQsCiAgICAgIGJhY2tncm91bmRCb3VuZHMudG9wLAogICAgICBiYWNrZ3JvdW5kQm91bmRzLndpZHRoLAogICAgICBiYWNrZ3JvdW5kQm91bmRzLmhlaWdodCwKICAgICAgYmdjb2xvcgogICAgICApOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdGluZyhlbCwgYm91bmRzLCBjdHgsIGltYWdlLCBpbWFnZUluZGV4KSB7CiAgICB2YXIgYmFja2dyb3VuZFNpemUgPSBVdGlsLkJhY2tncm91bmRTaXplKGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4KSwKICAgIGJhY2tncm91bmRQb3NpdGlvbiA9IFV0aWwuQmFja2dyb3VuZFBvc2l0aW9uKGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSksCiAgICBiYWNrZ3JvdW5kUmVwZWF0ID0gZ2V0Q1NTKGVsLCAiYmFja2dyb3VuZFJlcGVhdCIpLnNwbGl0KCIsIikubWFwKFV0aWwudHJpbVRleHQpOwoKICAgIGltYWdlID0gcmVzaXplSW1hZ2UoaW1hZ2UsIGJhY2tncm91bmRTaXplKTsKCiAgICBiYWNrZ3JvdW5kUmVwZWF0ID0gYmFja2dyb3VuZFJlcGVhdFtpbWFnZUluZGV4XSB8fCBiYWNrZ3JvdW5kUmVwZWF0WzBdOwoKICAgIHN3aXRjaCAoYmFja2dyb3VuZFJlcGVhdCkgewogICAgICBjYXNlICJyZXBlYXQteCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wLCA5OTk5OSwgaW1hZ2UuaGVpZ2h0KTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgInJlcGVhdC15IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0LCBib3VuZHMudG9wLCBpbWFnZS53aWR0aCwgOTk5OTkpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAibm8tcmVwZWF0IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCB7CiAgICAgICAgICB0b3A6IGJvdW5kcy50b3AsCiAgICAgICAgICBsZWZ0OiBib3VuZHMubGVmdCwKICAgICAgICAgIHdpZHRoOiBpbWFnZS53aWR0aCwKICAgICAgICAgIGhlaWdodDogaW1hZ2UuaGVpZ2h0CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kSW1hZ2UoZWxlbWVudCwgYm91bmRzLCBjdHgpIHsKICAgIHZhciBiYWNrZ3JvdW5kSW1hZ2UgPSBnZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRJbWFnZSIpLAogICAgYmFja2dyb3VuZEltYWdlcyA9IFV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZEltYWdlKSwKICAgIGltYWdlLAogICAgaW1hZ2VJbmRleCA9IGJhY2tncm91bmRJbWFnZXMubGVuZ3RoOwoKICAgIHdoaWxlKGltYWdlSW5kZXgtLSkgewogICAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBiYWNrZ3JvdW5kSW1hZ2VzW2ltYWdlSW5kZXhdOwoKICAgICAgaWYgKCFiYWNrZ3JvdW5kSW1hZ2UuYXJncyB8fCBiYWNrZ3JvdW5kSW1hZ2UuYXJncy5sZW5ndGggPT09IDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIGtleSA9IGJhY2tncm91bmRJbWFnZS5tZXRob2QgPT09ICd1cmwnID8KICAgICAgYmFja2dyb3VuZEltYWdlLmFyZ3NbMF0gOgogICAgICBiYWNrZ3JvdW5kSW1hZ2UudmFsdWU7CgogICAgICBpbWFnZSA9IGxvYWRJbWFnZShrZXkpOwoKICAgICAgLy8gVE9ETyBhZGQgc3VwcG9ydCBmb3IgYmFja2dyb3VuZC1vcmlnaW4KICAgICAgaWYgKGltYWdlKSB7CiAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdGluZyhlbGVtZW50LCBib3VuZHMsIGN0eCwgaW1hZ2UsIGltYWdlSW5kZXgpOwogICAgICB9IGVsc2UgewogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyBiYWNrZ3JvdW5kOiIsIGJhY2tncm91bmRJbWFnZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc2l6ZUltYWdlKGltYWdlLCBib3VuZHMpIHsKICAgIGlmKGltYWdlLndpZHRoID09PSBib3VuZHMud2lkdGggJiYgaW1hZ2UuaGVpZ2h0ID09PSBib3VuZHMuaGVpZ2h0KSB7CiAgICAgIHJldHVybiBpbWFnZTsKICAgIH0KCiAgICB2YXIgY3R4LCBjYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICBjYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgZHJhd0ltYWdlKGN0eCwgaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOwogICAgcmV0dXJuIGNhbnZhczsKICB9CgogIGZ1bmN0aW9uIHNldE9wYWNpdHkoY3R4LCBlbGVtZW50LCBwYXJlbnRTdGFjaykgewogICAgcmV0dXJuIGN0eC5zZXRWYXJpYWJsZSgiZ2xvYmFsQWxwaGEiLCBnZXRDU1MoZWxlbWVudCwgIm9wYWNpdHkiKSAqICgocGFyZW50U3RhY2spID8gcGFyZW50U3RhY2sub3BhY2l0eSA6IDEpKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVB4KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKCJweCIsICIiKTsKICB9CgogIHZhciB0cmFuc2Zvcm1SZWdFeHAgPSAvKG1hdHJpeClcKCguKylcKS87CgogIGZ1bmN0aW9uIGdldFRyYW5zZm9ybShlbGVtZW50LCBwYXJlbnRTdGFjaykgewogICAgdmFyIHRyYW5zZm9ybSA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItd2Via2l0LXRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1vei10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1vLXRyYW5zZm9ybSIpOwogICAgdmFyIHRyYW5zZm9ybU9yaWdpbiA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLXdlYmtpdC10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbW96LXRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItby10cmFuc2Zvcm0tb3JpZ2luIikgfHwgIjBweCAwcHgiOwoKICAgIHRyYW5zZm9ybU9yaWdpbiA9IHRyYW5zZm9ybU9yaWdpbi5zcGxpdCgiICIpLm1hcChyZW1vdmVQeCkubWFwKFV0aWwuYXNGbG9hdCk7CgogICAgdmFyIG1hdHJpeDsKICAgIGlmICh0cmFuc2Zvcm0gJiYgdHJhbnNmb3JtICE9PSAibm9uZSIpIHsKICAgICAgdmFyIG1hdGNoID0gdHJhbnNmb3JtLm1hdGNoKHRyYW5zZm9ybVJlZ0V4cCk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIHN3aXRjaChtYXRjaFsxXSkgewogICAgICAgICAgY2FzZSAibWF0cml4IjoKICAgICAgICAgICAgbWF0cml4ID0gbWF0Y2hbMl0uc3BsaXQoIiwiKS5tYXAoVXRpbC50cmltVGV4dCkubWFwKFV0aWwuYXNGbG9hdCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG9yaWdpbjogdHJhbnNmb3JtT3JpZ2luLAogICAgICBtYXRyaXg6IG1hdHJpeAogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSkgewogICAgdmFyIGN0eCA9IGgyY1JlbmRlckNvbnRleHQoKCFwYXJlbnRTdGFjaykgPyBkb2N1bWVudFdpZHRoKCkgOiBib3VuZHMud2lkdGggLCAoIXBhcmVudFN0YWNrKSA/IGRvY3VtZW50SGVpZ2h0KCkgOiBib3VuZHMuaGVpZ2h0KSwKICAgIHN0YWNrID0gewogICAgICBjdHg6IGN0eCwKICAgICAgb3BhY2l0eTogc2V0T3BhY2l0eShjdHgsIGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgICAgY3NzUG9zaXRpb246IGdldENTUyhlbGVtZW50LCAicG9zaXRpb24iKSwKICAgICAgYm9yZGVyczogZ2V0Qm9yZGVyRGF0YShlbGVtZW50KSwKICAgICAgdHJhbnNmb3JtOiB0cmFuc2Zvcm0sCiAgICAgIGNsaXA6IChwYXJlbnRTdGFjayAmJiBwYXJlbnRTdGFjay5jbGlwKSA/IFV0aWwuRXh0ZW5kKCB7fSwgcGFyZW50U3RhY2suY2xpcCApIDogbnVsbAogICAgfTsKCiAgICBzZXRaKGVsZW1lbnQsIHN0YWNrLCBwYXJlbnRTdGFjayk7CgogICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uCiAgICBpZiAob3B0aW9ucy51c2VPdmVyZmxvdyA9PT0gdHJ1ZSAmJiAvKGhpZGRlbnxzY3JvbGx8YXV0bykvLnRlc3QoZ2V0Q1NTKGVsZW1lbnQsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbGVtZW50Lm5vZGVOYW1lKSA9PT0gZmFsc2UpewogICAgICBzdGFjay5jbGlwID0gKHN0YWNrLmNsaXApID8gY2xpcEJvdW5kcyhzdGFjay5jbGlwLCBib3VuZHMpIDogYm91bmRzOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGdldEJhY2tncm91bmRCb3VuZHMoYm9yZGVycywgYm91bmRzLCBjbGlwKSB7CiAgICB2YXIgYmFja2dyb3VuZEJvdW5kcyA9IHsKICAgICAgbGVmdDogYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLAogICAgICB0b3A6IGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICB3aWR0aDogYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgaGVpZ2h0OiBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQogICAgfTsKCiAgICBpZiAoY2xpcCkgewogICAgICBiYWNrZ3JvdW5kQm91bmRzID0gY2xpcEJvdW5kcyhiYWNrZ3JvdW5kQm91bmRzLCBjbGlwKTsKICAgIH0KCiAgICByZXR1cm4gYmFja2dyb3VuZEJvdW5kczsKICB9CgogIGZ1bmN0aW9uIGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pIHsKICAgIHZhciBib3VuZHMgPSAodHJhbnNmb3JtLm1hdHJpeCkgPyBVdGlsLk9mZnNldEJvdW5kcyhlbGVtZW50KSA6IFV0aWwuQm91bmRzKGVsZW1lbnQpOwogICAgdHJhbnNmb3JtLm9yaWdpblswXSArPSBib3VuZHMubGVmdDsKICAgIHRyYW5zZm9ybS5vcmlnaW5bMV0gKz0gYm91bmRzLnRvcDsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsZW1lbnQsIHBhcmVudFN0YWNrLCBwc2V1ZG9FbGVtZW50LCBpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICB2YXIgdHJhbnNmb3JtID0gZ2V0VHJhbnNmb3JtKGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgIGJvdW5kcyA9IGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pLAogICAgaW1hZ2UsCiAgICBzdGFjayA9IGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSksCiAgICBib3JkZXJzID0gc3RhY2suYm9yZGVycywKICAgIGN0eCA9IHN0YWNrLmN0eCwKICAgIGJhY2tncm91bmRCb3VuZHMgPSBnZXRCYWNrZ3JvdW5kQm91bmRzKGJvcmRlcnMsIGJvdW5kcywgc3RhY2suY2xpcCksCiAgICBib3JkZXJEYXRhID0gcGFyc2VCb3JkZXJzKGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyksCiAgICBiYWNrZ3JvdW5kQ29sb3IgPSAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbGVtZW50Lm5vZGVOYW1lKSkgPyAiI2VmZWZlZiIgOiBnZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRDb2xvciIpOwoKCiAgICBjcmVhdGVTaGFwZShjdHgsIGJvcmRlckRhdGEuY2xpcCk7CgogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5jbGlwKCk7CgogICAgaWYgKGJhY2tncm91bmRCb3VuZHMuaGVpZ2h0ID4gMCAmJiBiYWNrZ3JvdW5kQm91bmRzLndpZHRoID4gMCAmJiAhaWdub3JlQmFja2dyb3VuZCkgewogICAgICByZW5kZXJCYWNrZ3JvdW5kQ29sb3IoY3R4LCBib3VuZHMsIGJhY2tncm91bmRDb2xvcik7CiAgICAgIHJlbmRlckJhY2tncm91bmRJbWFnZShlbGVtZW50LCBiYWNrZ3JvdW5kQm91bmRzLCBjdHgpOwogICAgfSBlbHNlIGlmIChpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9ICBiYWNrZ3JvdW5kQ29sb3I7CiAgICB9CgogICAgY3R4LnJlc3RvcmUoKTsKCiAgICBib3JkZXJEYXRhLmJvcmRlcnMuZm9yRWFjaChmdW5jdGlvbihib3JkZXIpIHsKICAgICAgcmVuZGVyQm9yZGVycyhjdHgsIGJvcmRlci5hcmdzLCBib3JkZXIuY29sb3IpOwogICAgfSk7CgogICAgaWYgKCFwc2V1ZG9FbGVtZW50KSB7CiAgICAgIGluamVjdFBzZXVkb0VsZW1lbnRzKGVsZW1lbnQsIHN0YWNrKTsKICAgIH0KCiAgICBzd2l0Y2goZWxlbWVudC5ub2RlTmFtZSl7CiAgICAgIGNhc2UgIklNRyI6CiAgICAgICAgaWYgKChpbWFnZSA9IGxvYWRJbWFnZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnc3JjJykpKSkgewogICAgICAgICAgcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBpbWFnZSwgYm91bmRzLCBib3JkZXJzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBFcnJvciBsb2FkaW5nIDxpbWc+OiIgKyBlbGVtZW50LmdldEF0dHJpYnV0ZSgnc3JjJykpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiSU5QVVQiOgogICAgICAgIC8vIFRPRE8gYWRkIGFsbCByZWxldmFudCB0eXBlJ3MsIGkuZS4gSFRNTDUgbmV3IHN0dWZmCiAgICAgICAgLy8gdG9kbyBhZGQgc3VwcG9ydCBmb3IgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGZvciBicm93c2VycyB3aGljaCBzdXBwb3J0IGl0CiAgICAgICAgaWYgKC9eKHRleHR8dXJsfGVtYWlsfHN1Ym1pdHxidXR0b258cmVzZXQpJC8udGVzdChlbGVtZW50LnR5cGUpICYmIChlbGVtZW50LnZhbHVlIHx8IGVsZW1lbnQucGxhY2Vob2xkZXIgfHwgIiIpLmxlbmd0aCA+IDApewogICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsZW1lbnQsIGJvdW5kcywgc3RhY2spOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiVEVYVEFSRUEiOgogICAgICAgIGlmICgoZWxlbWVudC52YWx1ZSB8fCBlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlNFTEVDVCI6CiAgICAgICAgaWYgKChlbGVtZW50Lm9wdGlvbnN8fGVsZW1lbnQucGxhY2Vob2xkZXIgfHwgIiIpLmxlbmd0aCA+IDApewogICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsZW1lbnQsIGJvdW5kcywgc3RhY2spOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiTEkiOgogICAgICAgIHJlbmRlckxpc3RJdGVtKGVsZW1lbnQsIHN0YWNrLCBiYWNrZ3JvdW5kQm91bmRzKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiQ0FOVkFTIjoKICAgICAgICByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIHN0YWNrOwogIH0KCiAgZnVuY3Rpb24gaXNFbGVtZW50VmlzaWJsZShlbGVtZW50KSB7CiAgICByZXR1cm4gKGdldENTUyhlbGVtZW50LCAnZGlzcGxheScpICE9PSAibm9uZSIgJiYgZ2V0Q1NTKGVsZW1lbnQsICd2aXNpYmlsaXR5JykgIT09ICJoaWRkZW4iICYmICFlbGVtZW50Lmhhc0F0dHJpYnV0ZSgiZGF0YS1odG1sMmNhbnZhcy1pZ25vcmUiKSk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUVsZW1lbnQgKGVsZW1lbnQsIHN0YWNrLCBwc2V1ZG9FbGVtZW50KSB7CiAgICBpZiAoaXNFbGVtZW50VmlzaWJsZShlbGVtZW50KSkgewogICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgc3RhY2ssIHBzZXVkb0VsZW1lbnQsIGZhbHNlKSB8fCBzdGFjazsKICAgICAgaWYgKCFpZ25vcmVFbGVtZW50c1JlZ0V4cC50ZXN0KGVsZW1lbnQubm9kZU5hbWUpKSB7CiAgICAgICAgcGFyc2VDaGlsZHJlbihlbGVtZW50LCBzdGFjaywgcHNldWRvRWxlbWVudCk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIHBzZXVkb0VsZW1lbnQpIHsKICAgIFV0aWwuQ2hpbGRyZW4oZWxlbWVudCkuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBub2RlLkVMRU1FTlRfTk9ERSkgewogICAgICAgIHBhcnNlRWxlbWVudChub2RlLCBzdGFjaywgcHNldWRvRWxlbWVudCk7CiAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gbm9kZS5URVhUX05PREUpIHsKICAgICAgICByZW5kZXJUZXh0KGVsZW1lbnQsIG5vZGUsIHN0YWNrKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBpbml0KCkgewogICAgdmFyIGJhY2tncm91bmQgPSBnZXRDU1MoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiksCiAgICAgIHRyYW5zcGFyZW50QmFja2dyb3VuZCA9IChVdGlsLmlzVHJhbnNwYXJlbnQoYmFja2dyb3VuZCkgJiYgZWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keSksCiAgICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBudWxsLCBmYWxzZSwgdHJhbnNwYXJlbnRCYWNrZ3JvdW5kKTsKICAgIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2spOwoKICAgIGlmICh0cmFuc3BhcmVudEJhY2tncm91bmQpIHsKICAgICAgYmFja2dyb3VuZCA9IHN0YWNrLmJhY2tncm91bmRDb2xvcjsKICAgIH0KCiAgICBib2R5LnJlbW92ZUNoaWxkKGhpZGVQc2V1ZG9FbGVtZW50cyk7CiAgICByZXR1cm4gewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IGJhY2tncm91bmQsCiAgICAgIHN0YWNrOiBzdGFjawogICAgfTsKICB9CgogIHJldHVybiBpbml0KCk7Cn07CgpmdW5jdGlvbiBoMmN6Q29udGV4dCh6aW5kZXgpIHsKICByZXR1cm4gewogICAgemluZGV4OiB6aW5kZXgsCiAgICBjaGlsZHJlbjogW10KICB9Owp9CgpfaHRtbDJjYW52YXMuUHJlbG9hZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICB2YXIgaW1hZ2VzID0gewogICAgbnVtTG9hZGVkOiAwLCAgIC8vIGFsc28gZmFpbGVkIGFyZSBjb3VudGVkIGhlcmUKICAgIG51bUZhaWxlZDogMCwKICAgIG51bVRvdGFsOiAwLAogICAgY2xlYW51cERvbmU6IGZhbHNlCiAgfSwKICBwYWdlT3JpZ2luLAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBtZXRob2RzLAogIGksCiAgY291bnQgPSAwLAogIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksCiAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LAogIGRvbUltYWdlcyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ltZycpLCAvLyBGZXRjaCBpbWFnZXMgb2YgdGhlIHByZXNlbnQgZWxlbWVudCBvbmx5CiAgaW1nTGVuID0gZG9tSW1hZ2VzLmxlbmd0aCwKICBsaW5rID0gZG9jLmNyZWF0ZUVsZW1lbnQoImEiKSwKICBzdXBwb3J0Q09SUyA9IChmdW5jdGlvbiggaW1nICl7CiAgICByZXR1cm4gKGltZy5jcm9zc09yaWdpbiAhPT0gdW5kZWZpbmVkKTsKICB9KShuZXcgSW1hZ2UoKSksCiAgdGltZW91dFRpbWVyOwoKICBsaW5rLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICBwYWdlT3JpZ2luICA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CgogIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbih1cmwpewogICAgbGluay5ocmVmID0gdXJsOwogICAgbGluay5ocmVmID0gbGluay5ocmVmOyAvLyBZRVMsIEJFTElFVkUgSVQgT1IgTk9ULCB0aGF0IGlzIHJlcXVpcmVkIGZvciBJRTkgLSBodHRwOi8vanNmaWRkbGUubmV0L25pa2xhc3ZoLzJlNDhiLwogICAgdmFyIG9yaWdpbiA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CiAgICByZXR1cm4gKG9yaWdpbiA9PT0gcGFnZU9yaWdpbik7CiAgfQoKICBmdW5jdGlvbiBzdGFydCgpewogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBzdGFydDogaW1hZ2VzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CiAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7CiAgICAgIFV0aWwubG9nKCJGaW5pc2hlZCBsb2FkaW5nIGltYWdlczogIyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY29tcGxldGUgPT09ICJmdW5jdGlvbiIpewogICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsKICAgICAgfQoKICAgIH0KICB9CgogIC8vIFRPRE8gbW9kaWZ5IHByb3h5IHRvIHNlcnZlIGltYWdlcyB3aXRoIENPUlMgZW5hYmxlZCwgd2hlcmUgYXZhaWxhYmxlCiAgZnVuY3Rpb24gcHJveHlHZXRJbWFnZSh1cmwsIGltZywgaW1hZ2VPYmopewogICAgdmFyIGNhbGxiYWNrX25hbWUsCiAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LAogICAgc2NyaXB0OwoKICAgIGxpbmsuaHJlZiA9IHVybDsKICAgIHVybCA9IGxpbmsuaHJlZjsgLy8gd29yayBhcm91bmQgZm9yIHBhZ2VzIHdpdGggYmFzZSBocmVmPSIiIHNldCAtIFdBUk5JTkc6IHRoaXMgbWF5IGNoYW5nZSB0aGUgdXJsCgogICAgY2FsbGJhY2tfbmFtZSA9ICdodG1sMmNhbnZhc18nICsgKGNvdW50KyspOwogICAgaW1hZ2VPYmouY2FsbGJhY2tuYW1lID0gY2FsbGJhY2tfbmFtZTsKCiAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7CiAgICAgIHNjcmlwdFVybCArPSAiJiI7CiAgICB9IGVsc2UgewogICAgICBzY3JpcHRVcmwgKz0gIj8iOwogICAgfQogICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsKICAgIHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCiAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSBmdW5jdGlvbihhKXsKICAgICAgaWYgKGEuc3Vic3RyaW5nKDAsNikgPT09ICJlcnJvcjoiKXsKICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICAgIHN0YXJ0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgaW1nLnNyYyA9IGE7CiAgICAgIH0KICAgICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gdW5kZWZpbmVkOyAvLyB0byB3b3JrIHdpdGggSUU8OSAgLy8gTk9URTogdGhhdCB0aGUgdW5kZWZpbmVkIGNhbGxiYWNrIHByb3BlcnR5LW5hbWUgc3RpbGwgZXhpc3RzIG9uIHRoZSB3aW5kb3cgb2JqZWN0IChmb3IgSUU8OSkKICAgICAgdHJ5IHsKICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrX25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgIH0gY2F0Y2goZXgpIHt9CiAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIHNjcmlwdCA9IG51bGw7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5zY3JpcHQ7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5jYWxsYmFja25hbWU7CiAgICB9OwoKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCBzY3JpcHRVcmwpOwogICAgaW1hZ2VPYmouc2NyaXB0ID0gc2NyaXB0OwogICAgd2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCB0eXBlKSwKICAgIGNvbnRlbnQgPSBzdHlsZS5jb250ZW50OwogICAgaWYgKGNvbnRlbnQuc3Vic3RyKDAsIDMpID09PSAndXJsJykgewogICAgICBtZXRob2RzLmxvYWRJbWFnZShfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdKTsKICAgIH0KICAgIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKHN0eWxlLmJhY2tncm91bmRJbWFnZSwgZWxlbWVudCk7CiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudEltYWdlcyhlbGVtZW50KSB7CiAgICBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCAiOmJlZm9yZSIpOwogICAgbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgIjphZnRlciIpOwogIH0KCiAgZnVuY3Rpb24gbG9hZEdyYWRpZW50SW1hZ2UoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpIHsKICAgIHZhciBpbWcgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuR3JhZGllbnQoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpOwoKICAgIGlmIChpbWcgIT09IHVuZGVmaW5lZCl7CiAgICAgIGltYWdlc1tiYWNrZ3JvdW5kSW1hZ2VdID0gewogICAgICAgIGltZzogaW1nLAogICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQogICAgICB9OwogICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICBzdGFydCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52YWxpZEJhY2tncm91bmRzKGJhY2tncm91bmRfaW1hZ2UpIHsKICAgIHJldHVybiAoYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZCAmJiBiYWNrZ3JvdW5kX2ltYWdlLmFyZ3MgJiYgYmFja2dyb3VuZF9pbWFnZS5hcmdzLmxlbmd0aCA+IDAgKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKGJhY2tncm91bmRfaW1hZ2UsIGVsKSB7CiAgICB2YXIgYm91bmRzOwoKICAgIF9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRfaW1hZ2UpLmZpbHRlcihpbnZhbGlkQmFja2dyb3VuZHMpLmZvckVhY2goZnVuY3Rpb24oYmFja2dyb3VuZF9pbWFnZSkgewogICAgICBpZiAoYmFja2dyb3VuZF9pbWFnZS5tZXRob2QgPT09ICd1cmwnKSB7CiAgICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5hcmdzWzBdKTsKICAgICAgfSBlbHNlIGlmKGJhY2tncm91bmRfaW1hZ2UubWV0aG9kLm1hdGNoKC9cLT9ncmFkaWVudCQvKSkgewogICAgICAgIGlmKGJvdW5kcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoZWwpOwogICAgICAgIH0KICAgICAgICBsb2FkR3JhZGllbnRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlLnZhbHVlLCBib3VuZHMpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEltYWdlcyAoZWwpIHsKICAgIHZhciBlbE5vZGVUeXBlID0gZmFsc2U7CgogICAgLy8gRmlyZWZveCBmYWlscyB3aXRoIHBlcm1pc3Npb24gZGVuaWVkIG9uIHBhZ2VzIHdpdGggaWZyYW1lcwogICAgdHJ5IHsKICAgICAgVXRpbC5DaGlsZHJlbihlbCkuZm9yRWFjaChnZXRJbWFnZXMpOwogICAgfQogICAgY2F0Y2goIGUgKSB7fQoKICAgIHRyeSB7CiAgICAgIGVsTm9kZVR5cGUgPSBlbC5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsKICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gYWNjZXNzIHNvbWUgZWxlbWVudCdzIG5vZGVUeXBlIC0gRXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICB9CgogICAgaWYgKGVsTm9kZVR5cGUgPT09IDEgfHwgZWxOb2RlVHlwZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxvYWRQc2V1ZG9FbGVtZW50SW1hZ2VzKGVsKTsKICAgICAgdHJ5IHsKICAgICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhVdGlsLmdldENTUyhlbCwgJ2JhY2tncm91bmRJbWFnZScpLCBlbCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGdldCBiYWNrZ3JvdW5kLWltYWdlIC0gRXhjZXB0aW9uOiAiICsgZS5tZXNzYWdlKTsKICAgICAgfQogICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7CiAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICggaW1hZ2VPYmoudGltZXIgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZAogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gdHJ1ZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoaW1nLmNyb3NzT3JpZ2luID09PSAiYW5vbnltb3VzIikgewogICAgICAgIC8vIENPUlMgZmFpbGVkCiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKCiAgICAgICAgLy8gbGV0J3MgdHJ5IHdpdGggcHJveHkgaW5zdGVhZAogICAgICAgIGlmICggb3B0aW9ucy5wcm94eSApIHsKICAgICAgICAgIHZhciBzcmMgPSBpbWcuc3JjOwogICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBpbWFnZU9iai5pbWcgPSBpbWc7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwoKICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIGltZy5zcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgfQoKICBtZXRob2RzID0gewogICAgbG9hZEltYWdlOiBmdW5jdGlvbiggc3JjICkgewogICAgICB2YXIgaW1nLCBpbWFnZU9iajsKICAgICAgaWYgKCBzcmMgJiYgaW1hZ2VzW3NyY10gPT09IHVuZGVmaW5lZCApIHsKICAgICAgICBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsKICAgICAgICAgIGltZy5zcmMgPSBzcmMucmVwbGFjZSgvdXJsXChbJyJdezAsfXxbJyJdezAsfVwpJC9pZywgJycpOwogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgIH0gZWxzZSBpZiAoIGlzU2FtZU9yaWdpbiggc3JjICkgfHwgb3B0aW9ucy5hbGxvd1RhaW50ID09PSAgdHJ1ZSApIHsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgfSBlbHNlIGlmICggc3VwcG9ydENPUlMgJiYgIW9wdGlvbnMuYWxsb3dUYWludCAmJiBvcHRpb25zLnVzZUNPUlMgKSB7CiAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTCgogICAgICAgICAgaW1nLmNyb3NzT3JpZ2luID0gImFub255bW91cyI7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwogICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgcHJveHlHZXRJbWFnZSggc3JjLCBpbWcsIGltYWdlT2JqICk7CiAgICAgICAgfQogICAgICB9CgogICAgfSwKICAgIGNsZWFudXBET006IGZ1bmN0aW9uKGNhdXNlKSB7CiAgICAgIHZhciBpbWcsIHNyYzsKICAgICAgaWYgKCFpbWFnZXMuY2xlYW51cERvbmUpIHsKICAgICAgICBpZiAoY2F1c2UgJiYgdHlwZW9mIGNhdXNlID09PSAic3RyaW5nIikgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGJlY2F1c2U6ICIgKyBjYXVzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBhZnRlciB0aW1lb3V0OiAiICsgb3B0aW9ucy50aW1lb3V0ICsgIiBtcy4iKTsKICAgICAgICB9CgogICAgICAgIGZvciAoc3JjIGluIGltYWdlcykgewogICAgICAgICAgaWYgKGltYWdlcy5oYXNPd25Qcm9wZXJ0eShzcmMpKSB7CiAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLyBjYW5jZWwgcHJveHkgaW1hZ2UgcmVxdWVzdAogICAgICAgICAgICAgIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpCiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV07ICAvLyBmb3IgYWxsIGJyb3dzZXIgdGhhdCBzdXBwb3J0IHRoaXMKICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICAgIGlmIChpbWcuc2NyaXB0ICYmIGltZy5zY3JpcHQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsICJhYm91dDpibGFuayIpOyAgLy8gdHJ5IHRvIGNhbmNlbCBydW5uaW5nIHJlcXVlc3QKICAgICAgICAgICAgICAgIGltZy5zY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpbWcuc2NyaXB0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFuZWQgdXAgZmFpbGVkIGltZzogJyIgKyBzcmMgKyAiJyBTdGVwczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cwogICAgICAgIGlmKHdpbmRvdy5zdG9wICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHdpbmRvdy5zdG9wKCk7CiAgICAgICAgfSBlbHNlIGlmKGRvY3VtZW50LmV4ZWNDb21tYW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoZG9jdW1lbnQuY2xvc2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZG9jdW1lbnQuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsKICAgICAgICBpZiAoIShjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgc3RhcnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgIH0KICAgIH0KICB9OwoKICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgewogICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOwogIH0KCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkIHN0YXJ0czogZmluZGluZyBiYWNrZ3JvdW5kLWltYWdlcycpOwogIGltYWdlcy5maXJzdFJ1biA9IHRydWU7CgogIGdldEltYWdlcyhlbGVtZW50KTsKCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBGaW5kaW5nIGltYWdlcycpOwogIC8vIGxvYWQgPGltZz4gaW1hZ2VzCiAgZm9yIChpID0gMDsgaSA8IGltZ0xlbjsgaSs9MSl7CiAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOwogIH0KCiAgaW1hZ2VzLmZpcnN0UnVuID0gZmFsc2U7CiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBEb25lLicpOwogIGlmIChpbWFnZXMubnVtVG90YWwgPT09IGltYWdlcy5udW1Mb2FkZWQpIHsKICAgIHN0YXJ0KCk7CiAgfQoKICByZXR1cm4gbWV0aG9kczsKfTsKCl9odG1sMmNhbnZhcy5SZW5kZXJlciA9IGZ1bmN0aW9uKHBhcnNlUXVldWUsIG9wdGlvbnMpewoKICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS96aW5kZXguaHRtbAogIGZ1bmN0aW9uIGNyZWF0ZVJlbmRlclF1ZXVlKHBhcnNlUXVldWUpIHsKICAgIHZhciBxdWV1ZSA9IFtdLAogICAgcm9vdENvbnRleHQ7CgogICAgcm9vdENvbnRleHQgPSAoZnVuY3Rpb24gYnVpbGRTdGFja2luZ0NvbnRleHQocm9vdE5vZGUpIHsKICAgICAgdmFyIHJvb3RDb250ZXh0ID0ge307CiAgICAgIGZ1bmN0aW9uIGluc2VydChjb250ZXh0LCBub2RlLCBzcGVjaWFsUGFyZW50KSB7CiAgICAgICAgdmFyIHppID0gKG5vZGUuekluZGV4LnppbmRleCA9PT0gJ2F1dG8nKSA/IDAgOiBOdW1iZXIobm9kZS56SW5kZXguemluZGV4KSwKICAgICAgICBjb250ZXh0Rm9yQ2hpbGRyZW4gPSBjb250ZXh0LCAvLyB0aGUgc3RhY2tpbmcgY29udGV4dCBmb3IgY2hpbGRyZW4KICAgICAgICBpc1Bvc2l0aW9uZWQgPSBub2RlLnpJbmRleC5pc1Bvc2l0aW9uZWQsCiAgICAgICAgaXNGbG9hdGVkID0gbm9kZS56SW5kZXguaXNGbG9hdGVkLAogICAgICAgIHN0dWIgPSB7bm9kZTogbm9kZX0sCiAgICAgICAgY2hpbGRyZW5EZXN0ID0gc3BlY2lhbFBhcmVudDsgLy8gd2hlcmUgY2hpbGRyZW4gd2l0aG91dCB6LWluZGV4IHNob3VsZCBiZSBwdXNoZWQgaW50bwoKICAgICAgICBpZiAobm9kZS56SW5kZXgub3duU3RhY2tpbmcpIHsKICAgICAgICAgIC8vICchJyBjb21lcyBiZWZvcmUgbnVtYmVycyBpbiBzb3J0ZWQgYXJyYXkKICAgICAgICAgIGNvbnRleHRGb3JDaGlsZHJlbiA9IHN0dWIuY29udGV4dCA9IHsgJyEnOiBbe25vZGU6bm9kZSwgY2hpbGRyZW46IFtdfV19OwogICAgICAgICAgY2hpbGRyZW5EZXN0ID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNQb3NpdGlvbmVkIHx8IGlzRmxvYXRlZCkgewogICAgICAgICAgY2hpbGRyZW5EZXN0ID0gc3R1Yi5jaGlsZHJlbiA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKHppID09PSAwICYmIHNwZWNpYWxQYXJlbnQpIHsKICAgICAgICAgIHNwZWNpYWxQYXJlbnQucHVzaChzdHViKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFjb250ZXh0W3ppXSkgeyBjb250ZXh0W3ppXSA9IFtdOyB9CiAgICAgICAgICBjb250ZXh0W3ppXS5wdXNoKHN0dWIpOwogICAgICAgIH0KCiAgICAgICAgbm9kZS56SW5kZXguY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZE5vZGUpIHsKICAgICAgICAgIGluc2VydChjb250ZXh0Rm9yQ2hpbGRyZW4sIGNoaWxkTm9kZSwgY2hpbGRyZW5EZXN0KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpbnNlcnQocm9vdENvbnRleHQsIHJvb3ROb2RlKTsKICAgICAgcmV0dXJuIHJvb3RDb250ZXh0OwogICAgfSkocGFyc2VRdWV1ZSk7CgogICAgZnVuY3Rpb24gc29ydFooY29udGV4dCkgewogICAgICBPYmplY3Qua2V5cyhjb250ZXh0KS5zb3J0KCkuZm9yRWFjaChmdW5jdGlvbih6aSkgewogICAgICAgIHZhciBub25Qb3NpdGlvbmVkID0gW10sCiAgICAgICAgZmxvYXRlZCA9IFtdLAogICAgICAgIHBvc2l0aW9uZWQgPSBbXSwKICAgICAgICBsaXN0ID0gW107CgogICAgICAgIC8vIHBvc2l0aW9uZWQgYWZ0ZXIgc3RhdGljCiAgICAgICAgY29udGV4dFt6aV0uZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICBpZiAodi5ub2RlLnpJbmRleC5pc1Bvc2l0aW9uZWQgfHwgdi5ub2RlLnpJbmRleC5vcGFjaXR5IDwgMSkgewogICAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLWNvbG9yLyN0cmFuc3BhcmVuY3kKICAgICAgICAgICAgLy8gbm9uLXBvc2l0aW9uZWQgZWxlbWVudCB3aXRoIG9wYWN0aXkgPCAxIHNob3VsZCBiZSBzdGFja2VkIGFzIGlmIGl0IHdlcmUgYSBwb3NpdGlvbmVkIGVsZW1lbnQgd2l0aCDigJh6LWluZGV4OiAw4oCZIGFuZCDigJhvcGFjaXR5OiAx4oCZLgogICAgICAgICAgICBwb3NpdGlvbmVkLnB1c2godik7CiAgICAgICAgICB9IGVsc2UgaWYgKHYubm9kZS56SW5kZXguaXNGbG9hdGVkKSB7CiAgICAgICAgICAgIGZsb2F0ZWQucHVzaCh2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5vblBvc2l0aW9uZWQucHVzaCh2KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgKGZ1bmN0aW9uIHdhbGsoYXJyKSB7CiAgICAgICAgICBhcnIuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIGxpc3QucHVzaCh2KTsKICAgICAgICAgICAgaWYgKHYuY2hpbGRyZW4pIHsgd2Fsayh2LmNoaWxkcmVuKTsgfQogICAgICAgICAgfSk7CiAgICAgICAgfSkobm9uUG9zaXRpb25lZC5jb25jYXQoZmxvYXRlZCwgcG9zaXRpb25lZCkpOwoKICAgICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgaWYgKHYuY29udGV4dCkgewogICAgICAgICAgICBzb3J0Wih2LmNvbnRleHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVldWUucHVzaCh2Lm5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICBzb3J0Wihyb290Q29udGV4dCk7CgogICAgcmV0dXJuIHF1ZXVlOwogIH0KCiAgZnVuY3Rpb24gZ2V0UmVuZGVyZXIocmVuZGVyZXJOYW1lKSB7CiAgICB2YXIgcmVuZGVyZXI7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLnJlbmRlcmVyID09PSAic3RyaW5nIiAmJiBfaHRtbDJjYW52YXMuUmVuZGVyZXJbcmVuZGVyZXJOYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJlbmRlcmVyID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyW3JlbmRlcmVyTmFtZV0ob3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXJlck5hbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVuZGVyZXIgPSByZW5kZXJlck5hbWUob3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcmVuZGVyZXIiKTsKICAgIH0KCiAgICBpZiAoIHR5cGVvZiByZW5kZXJlciAhPT0gImZ1bmN0aW9uIiApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJlbmRlcmVyIGRlZmluZWQiKTsKICAgIH0KICAgIHJldHVybiByZW5kZXJlcjsKICB9CgogIHJldHVybiBnZXRSZW5kZXJlcihvcHRpb25zLnJlbmRlcmVyKShwYXJzZVF1ZXVlLCBvcHRpb25zLCBkb2N1bWVudCwgY3JlYXRlUmVuZGVyUXVldWUocGFyc2VRdWV1ZS5zdGFjayksIF9odG1sMmNhbnZhcyk7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5TdXBwb3J0ID0gZnVuY3Rpb24gKG9wdGlvbnMsIGRvYykgewoKICBmdW5jdGlvbiBzdXBwb3J0U1ZHUmVuZGVyaW5nKCkgewogICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpLAogICAgY2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogICAgY3R4ID0gKGNhbnZhcy5nZXRDb250ZXh0ID09PSB1bmRlZmluZWQpID8gZmFsc2UgOiBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIGlmIChjdHggPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5oZWlnaHQgPSAxMDsKICAgIGltZy5zcmMgPSBbCiAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAiPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwKICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nMTAnIGhlaWdodD0nMTAnPiIsCiAgICAiPGRpdiB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J3dpZHRoOjEwO2hlaWdodDoxMDsnPiIsCiAgICAic3VwIiwKICAgICI8L2Rpdj4iLAogICAgIjwvZm9yZWlnbk9iamVjdD4iLAogICAgIjwvc3ZnPiIKICAgIF0uam9pbigiIik7CiAgICB0cnkgewogICAgICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7CiAgICAgIGNhbnZhcy50b0RhdGFVUkwoKTsKICAgIH0gY2F0Y2goZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBfaHRtbDJjYW52YXMuVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQYXJzZTogU1ZHIHBvd2VyZWQgcmVuZGVyaW5nIGF2YWlsYWJsZScpOwogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLyBUZXN0IHdoZXRoZXIgd2UgY2FuIHVzZSByYW5nZXMgdG8gbWVhc3VyZSBib3VuZGluZyBib3hlcwogIC8vIE9wZXJhIGRvZXNuJ3QgcHJvdmlkZSB2YWxpZCBib3VuZHMuaGVpZ2h0L2JvdHRvbSBldmVuIHRob3VnaCBpdCBzdXBwb3J0cyB0aGUgbWV0aG9kLgoKICBmdW5jdGlvbiBzdXBwb3J0UmFuZ2VCb3VuZHMoKSB7CiAgICB2YXIgciwgdGVzdEVsZW1lbnQsIHJhbmdlQm91bmRzLCByYW5nZUhlaWdodCwgc3VwcG9ydCA9IGZhbHNlOwoKICAgIGlmIChkb2MuY3JlYXRlUmFuZ2UpIHsKICAgICAgciA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICBpZiAoci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICB0ZXN0RWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCdib3VuZHRlc3QnKTsKICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTIzcHgiOwogICAgICAgIHRlc3RFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHRlc3RFbGVtZW50KTsKCiAgICAgICAgci5zZWxlY3ROb2RlKHRlc3RFbGVtZW50KTsKICAgICAgICByYW5nZUJvdW5kcyA9IHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgcmFuZ2VIZWlnaHQgPSByYW5nZUJvdW5kcy5oZWlnaHQ7CgogICAgICAgIGlmIChyYW5nZUhlaWdodCA9PT0gMTIzKSB7CiAgICAgICAgICBzdXBwb3J0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZG9jLmJvZHkucmVtb3ZlQ2hpbGQodGVzdEVsZW1lbnQpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHN1cHBvcnQ7CiAgfQoKICByZXR1cm4gewogICAgcmFuZ2VCb3VuZHM6IHN1cHBvcnRSYW5nZUJvdW5kcygpLAogICAgc3ZnUmVuZGVyaW5nOiBvcHRpb25zLnN2Z1JlbmRlcmluZyAmJiBzdXBwb3J0U1ZHUmVuZGVyaW5nKCkKICB9Owp9Owp3aW5kb3cuaHRtbDJjYW52YXMgPSBmdW5jdGlvbihlbGVtZW50cywgb3B0cykgewogIGVsZW1lbnRzID0gKGVsZW1lbnRzLmxlbmd0aCkgPyBlbGVtZW50cyA6IFtlbGVtZW50c107CiAgdmFyIHF1ZXVlLAogIGNhbnZhcywKICBvcHRpb25zID0gewogICAgLy8gZ2VuZXJhbAogICAgbG9nZ2luZzogZmFsc2UsCiAgICBlbGVtZW50czogZWxlbWVudHMsCiAgICBiYWNrZ3JvdW5kOiAiI2ZmZiIsCgogICAgLy8gcHJlbG9hZCBvcHRpb25zCiAgICBwcm94eTogbnVsbCwKICAgIHRpbWVvdXQ6IDAsICAgIC8vIG5vIHRpbWVvdXQKICAgIHVzZUNPUlM6IGZhbHNlLCAvLyB0cnkgdG8gbG9hZCBpbWFnZXMgYXMgQ09SUyAod2hlcmUgYXZhaWxhYmxlKSwgYmVmb3JlIGZhbGxpbmcgYmFjayB0byBwcm94eQogICAgYWxsb3dUYWludDogZmFsc2UsIC8vIHdoZXRoZXIgdG8gYWxsb3cgaW1hZ2VzIHRvIHRhaW50IHRoZSBjYW52YXMsIHdvbid0IG5lZWQgcHJveHkgaWYgc2V0IHRvIHRydWUKCiAgICAvLyBwYXJzZSBvcHRpb25zCiAgICBzdmdSZW5kZXJpbmc6IGZhbHNlLCAvLyB1c2Ugc3ZnIHBvd2VyZWQgcmVuZGVyaW5nIHdoZXJlIGF2YWlsYWJsZSAoRkYxMSspCiAgICBpZ25vcmVFbGVtZW50czogIklGUkFNRXxPQkpFQ1R8UEFSQU0iLAogICAgdXNlT3ZlcmZsb3c6IHRydWUsCiAgICBsZXR0ZXJSZW5kZXJpbmc6IGZhbHNlLAogICAgY2hpbmVzZTogZmFsc2UsCgogICAgLy8gcmVuZGVyIG9wdGlvbnMKCiAgICB3aWR0aDogbnVsbCwKICAgIGhlaWdodDogbnVsbCwKICAgIHRhaW50VGVzdDogdHJ1ZSwgLy8gZG8gYSB0YWludCB0ZXN0IHdpdGggYWxsIGltYWdlcyBiZWZvcmUgYXBwbHlpbmcgdG8gY2FudmFzCiAgICByZW5kZXJlcjogIkNhbnZhcyIKICB9OwoKICBvcHRpb25zID0gX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpOwoKICBfaHRtbDJjYW52YXMubG9nZ2luZyA9IG9wdGlvbnMubG9nZ2luZzsKICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oIGltYWdlcyApIHsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMub25wcmVsb2FkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCBvcHRpb25zLm9ucHJlbG9hZGVkKCBpbWFnZXMgKSA9PT0gZmFsc2UgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBxdWV1ZSA9IF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zICk7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucGFyc2VkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICggb3B0aW9ucy5vbnBhcnNlZCggcXVldWUgKSA9PT0gZmFsc2UgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CgogICAgY2FudmFzID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgb3B0aW9ucyApOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnJlbmRlcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9wdGlvbnMub25yZW5kZXJlZCggY2FudmFzICk7CiAgICB9CgoKICB9OwoKICAvLyBmb3IgcGFnZXMgd2l0aG91dCBpbWFnZXMsIHdlIHN0aWxsIHdhbnQgdGhpcyB0byBiZSBhc3luYywgaS5lLiByZXR1cm4gbWV0aG9kcyBiZWZvcmUgZXhlY3V0aW5nCiAgd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CiAgICBfaHRtbDJjYW52YXMuUHJlbG9hZCggb3B0aW9ucyApOwogIH0sIDAgKTsKCiAgcmV0dXJuIHsKICAgIHJlbmRlcjogZnVuY3Rpb24oIHF1ZXVlLCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcHJlbG9hZDogZnVuY3Rpb24oIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUHJlbG9hZCggX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgbG9nOiBfaHRtbDJjYW52YXMuVXRpbC5sb2cKICB9Owp9OwoKd2luZG93Lmh0bWwyY2FudmFzLmxvZyA9IF9odG1sMmNhbnZhcy5VdGlsLmxvZzsgLy8gZm9yIHJlbmRlcmVycwp3aW5kb3cuaHRtbDJjYW52YXMuUmVuZGVyZXIgPSB7CiAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkCn07Cl9odG1sMmNhbnZhcy5SZW5kZXJlci5DYW52YXMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHZhciBkb2MgPSBkb2N1bWVudCwKICBzYWZlSW1hZ2VzID0gW10sCiAgdGVzdENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIGNhbnZhcyA9IG9wdGlvbnMuY2FudmFzIHx8IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKCiAgZnVuY3Rpb24gY3JlYXRlU2hhcGUoY3R4LCBhcmdzKSB7CiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKSB7CiAgICAgIGN0eFthcmcubmFtZV0uYXBwbHkoY3R4LCBhcmdbJ2FyZ3VtZW50cyddKTsKICAgIH0pOwogICAgY3R4LmNsb3NlUGF0aCgpOwogIH0KCiAgZnVuY3Rpb24gc2FmZUltYWdlKGl0ZW0pIHsKICAgIGlmIChzYWZlSW1hZ2VzLmluZGV4T2YoaXRlbVsnYXJndW1lbnRzJ11bMF0uc3JjICkgPT09IC0xKSB7CiAgICAgIHRlc3RjdHguZHJhd0ltYWdlKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLCAwLCAwKTsKICAgICAgdHJ5IHsKICAgICAgICB0ZXN0Y3R4LmdldEltYWdlRGF0YSgwLCAwLCAxLCAxKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgdGVzdENhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgICB0ZXN0Y3R4ID0gdGVzdENhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBzYWZlSW1hZ2VzLnB1c2goaXRlbVsnYXJndW1lbnRzJ11bMF0uc3JjKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVySXRlbShjdHgsIGl0ZW0pIHsKICAgIHN3aXRjaChpdGVtLnR5cGUpewogICAgICBjYXNlICJ2YXJpYWJsZSI6CiAgICAgICAgY3R4W2l0ZW0ubmFtZV0gPSBpdGVtWydhcmd1bWVudHMnXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgIHN3aXRjaChpdGVtLm5hbWUpIHsKICAgICAgICAgIGNhc2UgImNyZWF0ZVBhdHRlcm4iOgogICAgICAgICAgICBpZiAoaXRlbVsnYXJndW1lbnRzJ11bMF0ud2lkdGggPiAwICYmIGl0ZW1bJ2FyZ3VtZW50cyddWzBdLmhlaWdodCA+IDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGN0eC5jcmVhdGVQYXR0ZXJuKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLCAicmVwZWF0Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IEVycm9yIGNyZWF0aW5nIHBhdHRlcm4iLCBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdTaGFwZSI6CiAgICAgICAgICAgIGNyZWF0ZVNoYXBlKGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdJbWFnZSI6CiAgICAgICAgICAgIGlmIChpdGVtWydhcmd1bWVudHMnXVs4XSA+IDAgJiYgaXRlbVsnYXJndW1lbnRzJ11bN10gPiAwKSB7CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnRhaW50VGVzdCB8fCAob3B0aW9ucy50YWludFRlc3QgJiYgc2FmZUltYWdlKGl0ZW0pKSkgewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZS5hcHBseSggY3R4LCBpdGVtWydhcmd1bWVudHMnXSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGN0eFtpdGVtLm5hbWVdLmFwcGx5KGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBmdW5jdGlvbihwYXJzZWREYXRhLCBvcHRpb25zLCBkb2N1bWVudCwgcXVldWUsIF9odG1sMmNhbnZhcykgewogICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpLAogICAgbmV3Q2FudmFzLAogICAgYm91bmRzLAogICAgZnN0eWxlLAogICAgelN0YWNrID0gcGFyc2VkRGF0YS5zdGFjazsKCiAgICBjYW52YXMud2lkdGggPSBjYW52YXMuc3R5bGUud2lkdGggPSAgb3B0aW9ucy53aWR0aCB8fCB6U3RhY2suY3R4LndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCB6U3RhY2suY3R4LmhlaWdodDsKCiAgICBmc3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgY3R4LmZpbGxTdHlsZSA9IChVdGlsLmlzVHJhbnNwYXJlbnQoelN0YWNrLmJhY2tncm91bmRDb2xvcikgJiYgb3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB1bmRlZmluZWQpID8gb3B0aW9ucy5iYWNrZ3JvdW5kIDogcGFyc2VkRGF0YS5iYWNrZ3JvdW5kQ29sb3I7CiAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgIGN0eC5maWxsU3R5bGUgPSBmc3R5bGU7CgogICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihzdG9yYWdlQ29udGV4dCkgewogICAgICAvLyBzZXQgY29tbW9uIHNldHRpbmdzIGZvciBjYW52YXMKICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwogICAgICBjdHguc2F2ZSgpOwoKICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5tYXRyaXgpIHsKICAgICAgICBjdHgudHJhbnNsYXRlKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMF0sIHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMV0pOwogICAgICAgIGN0eC50cmFuc2Zvcm0uYXBwbHkoY3R4LCBzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ubWF0cml4KTsKICAgICAgICBjdHgudHJhbnNsYXRlKC1zdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzBdLCAtc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblsxXSk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4LnJlY3Qoc3RvcmFnZUNvbnRleHQuY2xpcC5sZWZ0LCBzdG9yYWdlQ29udGV4dC5jbGlwLnRvcCwgc3RvcmFnZUNvbnRleHQuY2xpcC53aWR0aCwgc3RvcmFnZUNvbnRleHQuY2xpcC5oZWlnaHQpOwogICAgICAgIGN0eC5jbGlwKCk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZSkgewogICAgICAgIHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmVuZGVySXRlbShjdHgsIGl0ZW0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CgogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FudmFzIHJlbmRlcmVyIGRvbmUgLSByZXR1cm5pbmcgY2FudmFzIG9iaiIpOwoKICAgIGlmIChvcHRpb25zLmVsZW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbMF0gPT09ICJvYmplY3QiICYmIG9wdGlvbnMuZWxlbWVudHNbMF0ubm9kZU5hbWUgIT09ICJCT0RZIikgewogICAgICAgIC8vIGNyb3AgaW1hZ2UgdG8gdGhlIGJvdW5kcyBvZiBzZWxlY3RlZCAoc2luZ2xlKSBlbGVtZW50CiAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKG9wdGlvbnMuZWxlbWVudHNbMF0pOwogICAgICAgIG5ld0NhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIG5ld0NhbnZhcy53aWR0aCA9IE1hdGguY2VpbChib3VuZHMud2lkdGgpOwogICAgICAgIG5ld0NhbnZhcy5oZWlnaHQgPSBNYXRoLmNlaWwoYm91bmRzLmhlaWdodCk7CiAgICAgICAgY3R4ID0gbmV3Q2FudmFzLmdldENvbnRleHQoIjJkIik7CgogICAgICAgIGN0eC5kcmF3SW1hZ2UoY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGNhbnZhcyA9IG51bGw7CiAgICAgICAgcmV0dXJuIG5ld0NhbnZhczsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjYW52YXM7CiAgfTsKfTsKfSkod2luZG93LGRvY3VtZW50KTs=",
                "body": "LyoKICBodG1sMmNhbnZhcyAwLjQuMSA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMyBOaWtsYXMgdm9uIEhlcnR6ZW4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKKi8KCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpewoKInVzZSBzdHJpY3QiOwoKdmFyIF9odG1sMmNhbnZhcyA9IHt9LApwcmV2aW91c0VsZW1lbnQsCmNvbXB1dGVkQ1NTLApodG1sMmNhbnZhczsKCl9odG1sMmNhbnZhcy5VdGlsID0ge307CgpfaHRtbDJjYW52YXMuVXRpbC5sb2cgPSBmdW5jdGlvbihhKSB7CiAgaWYgKF9odG1sMmNhbnZhcy5sb2dnaW5nICYmIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLmxvZykgewogICAgd2luZG93LmNvbnNvbGUubG9nKGEpOwogIH0KfTsKCl9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0ID0gKGZ1bmN0aW9uKGlzTmF0aXZlKXsKICByZXR1cm4gZnVuY3Rpb24oaW5wdXQpIHsKICAgIHJldHVybiBpc05hdGl2ZSA/IGlzTmF0aXZlLmFwcGx5KGlucHV0KSA6ICgoaW5wdXQgfHwgJycpICsgJycpLnJlcGxhY2UoIC9eXHMrfFxzKyQvZyAsICcnICk7CiAgfTsKfSkoU3RyaW5nLnByb3RvdHlwZS50cmltKTsKCl9odG1sMmNhbnZhcy5VdGlsLmFzRmxvYXQgPSBmdW5jdGlvbih2KSB7CiAgcmV0dXJuIHBhcnNlRmxvYXQodik7Cn07CgooZnVuY3Rpb24oKSB7CiAgLy8gVE9ETzogc3VwcG9ydCBhbGwgcG9zc2libGUgbGVuZ3RoIHZhbHVlcwogIHZhciBURVhUX1NIQURPV19QUk9QRVJUWSA9IC8oKHJnYmF8cmdiKVwoW15cKV0rXCkoXHMtP1xkK3B4KXswLH0pL2c7CiAgdmFyIFRFWFRfU0hBRE9XX1ZBTFVFUyA9IC8oLT9cZCtweCl8KCMuKyl8KHJnYlwoLitcKSl8KHJnYmFcKC4rXCkpL2c7CiAgX2h0bWwyY2FudmFzLlV0aWwucGFyc2VUZXh0U2hhZG93cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSB8fCB2YWx1ZSA9PT0gJ25vbmUnKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgICAvLyBmaW5kIG11bHRpcGxlIHNoYWRvdyBkZWNsYXJhdGlvbnMKICAgIHZhciBzaGFkb3dzID0gdmFsdWUubWF0Y2goVEVYVF9TSEFET1dfUFJPUEVSVFkpLAogICAgICByZXN1bHRzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgc2hhZG93cyAmJiAoaSA8IHNoYWRvd3MubGVuZ3RoKTsgaSsrKSB7CiAgICAgIHZhciBzID0gc2hhZG93c1tpXS5tYXRjaChURVhUX1NIQURPV19WQUxVRVMpOwogICAgICByZXN1bHRzLnB1c2goewogICAgICAgIGNvbG9yOiBzWzBdLAogICAgICAgIG9mZnNldFg6IHNbMV0gPyBzWzFdLnJlcGxhY2UoJ3B4JywgJycpIDogMCwKICAgICAgICBvZmZzZXRZOiBzWzJdID8gc1syXS5yZXBsYWNlKCdweCcsICcnKSA6IDAsCiAgICAgICAgYmx1cjogc1szXSA/IHNbM10ucmVwbGFjZSgncHgnLCAnJykgOiAwCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKfSkoKTsKCgpfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgdmFyIHdoaXRlc3BhY2UgPSAnIFxyXG5cdCcsCiAgICAgICAgbWV0aG9kLCBkZWZpbml0aW9uLCBwcmVmaXgsIHByZWZpeF9pLCBibG9jaywgcmVzdWx0cyA9IFtdLAogICAgICAgIGMsIG1vZGUgPSAwLCBudW1QYXJlbiA9IDAsIHF1b3RlLCBhcmdzOwoKICAgIHZhciBhcHBlbmRSZXN1bHQgPSBmdW5jdGlvbigpewogICAgICAgIGlmKG1ldGhvZCkgewogICAgICAgICAgICBpZihkZWZpbml0aW9uLnN1YnN0ciggMCwgMSApID09PSAnIicpIHsKICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSBkZWZpbml0aW9uLnN1YnN0ciggMSwgZGVmaW5pdGlvbi5sZW5ndGggLSAyICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgYXJncy5wdXNoKGRlZmluaXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG1ldGhvZC5zdWJzdHIoIDAsIDEgKSA9PT0gJy0nICYmCiAgICAgICAgICAgICAgICAgICAgKHByZWZpeF9pID0gbWV0aG9kLmluZGV4T2YoICctJywgMSApICsgMSkgPiAwKSB7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtZXRob2Quc3Vic3RyKCAwLCBwcmVmaXhfaSk7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBtZXRob2Quc3Vic3RyKCBwcmVmaXhfaSApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICAgICAgICBwcmVmaXg6IHByZWZpeCwKICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2ssCiAgICAgICAgICAgICAgICBhcmdzOiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBhcmdzID0gW107IC8vZm9yIHNvbWUgb2RkIHJlYXNvbiwgc2V0dGluZyAubGVuZ3RoID0gMCBkaWRuJ3Qgd29yayBpbiBzYWZhcmkKICAgICAgICBtZXRob2QgPQogICAgICAgICAgICBwcmVmaXggPQogICAgICAgICAgICBkZWZpbml0aW9uID0KICAgICAgICAgICAgYmxvY2sgPSAnJzsKICAgIH07CgogICAgYXBwZW5kUmVzdWx0KCk7CiAgICBmb3IodmFyIGkgPSAwLCBpaSA9IHZhbHVlLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgYyA9IHZhbHVlW2ldOwogICAgICAgIGlmKG1vZGUgPT09IDAgJiYgd2hpdGVzcGFjZS5pbmRleE9mKCBjICkgPiAtMSl7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBzd2l0Y2goYykgewogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIGlmKCFxdW90ZSkgewogICAgICAgICAgICAgICAgICAgIHF1b3RlID0gYzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYocXVvdGUgPT09IGMpIHsKICAgICAgICAgICAgICAgICAgICBxdW90ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJygnOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIG1vZGUgPSAxOwogICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG51bVBhcmVuKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJyknOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmKG51bVBhcmVuID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmRSZXN1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtUGFyZW4tLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJywnOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGFwcGVuZFJlc3VsdCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAobW9kZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmKG51bVBhcmVuID09PSAwICYmICFtZXRob2QubWF0Y2goL151cmwkL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgaWYobW9kZSA9PT0gMCkgeyBtZXRob2QgKz0gYzsgfQogICAgICAgIGVsc2UgeyBkZWZpbml0aW9uICs9IGM7IH0KICAgIH0KICAgIGFwcGVuZFJlc3VsdCgpOwoKICAgIHJldHVybiByZXN1bHRzOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICB2YXIgY2xpZW50UmVjdCwgYm91bmRzID0ge307CgogIGlmIChlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICBjbGllbnRSZWN0ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAvLyBUT0RPIGFkZCBzY3JvbGwgcG9zaXRpb24gdG8gYm91bmRzLCBzbyBubyBzY3JvbGxpbmcgb2Ygd2luZG93IG5lY2Vzc2FyeQogICAgYm91bmRzLnRvcCA9IGNsaWVudFJlY3QudG9wOwogICAgYm91bmRzLmJvdHRvbSA9IGNsaWVudFJlY3QuYm90dG9tIHx8IChjbGllbnRSZWN0LnRvcCArIGNsaWVudFJlY3QuaGVpZ2h0KTsKICAgIGJvdW5kcy5sZWZ0ID0gY2xpZW50UmVjdC5sZWZ0OwoKICAgIGJvdW5kcy53aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7CiAgICBib3VuZHMuaGVpZ2h0ID0gZWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgfQoKICByZXR1cm4gYm91bmRzOwp9OwoKLy8gVE9ETyBpZGVhbGx5LCB3ZSdkIHdhbnQgZXZlcnl0aGluZyB0byBnbyB0aHJvdWdoIHRoaXMgZnVuY3Rpb24gaW5zdGVhZCBvZiBVdGlsLkJvdW5kcywKLy8gYnV0IHdvdWxkIHJlcXVpcmUgZnVydGhlciB3b3JrIHRvIGNhbGN1bGF0ZSB0aGUgY29ycmVjdCBwb3NpdGlvbnMgZm9yIGVsZW1lbnRzIHdpdGggb2Zmc2V0UGFyZW50cwpfaHRtbDJjYW52YXMuVXRpbC5PZmZzZXRCb3VuZHMgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogIHZhciBwYXJlbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudCA/IF9odG1sMmNhbnZhcy5VdGlsLk9mZnNldEJvdW5kcyhlbGVtZW50Lm9mZnNldFBhcmVudCkgOiB7dG9wOiAwLCBsZWZ0OiAwfTsKCiAgcmV0dXJuIHsKICAgIHRvcDogZWxlbWVudC5vZmZzZXRUb3AgKyBwYXJlbnQudG9wLAogICAgYm90dG9tOiBlbGVtZW50Lm9mZnNldFRvcCArIGVsZW1lbnQub2Zmc2V0SGVpZ2h0ICsgcGFyZW50LnRvcCwKICAgIGxlZnQ6IGVsZW1lbnQub2Zmc2V0TGVmdCArIHBhcmVudC5sZWZ0LAogICAgd2lkdGg6IGVsZW1lbnQub2Zmc2V0V2lkdGgsCiAgICBoZWlnaHQ6IGVsZW1lbnQub2Zmc2V0SGVpZ2h0CiAgfTsKfTsKCmZ1bmN0aW9uIHRvUFgoZWxlbWVudCwgYXR0cmlidXRlLCB2YWx1ZSApIHsKICAgIHZhciByc0xlZnQgPSBlbGVtZW50LnJ1bnRpbWVTdHlsZSAmJiBlbGVtZW50LnJ1bnRpbWVTdHlsZVthdHRyaWJ1dGVdLAogICAgICAgIGxlZnQsCiAgICAgICAgc3R5bGUgPSBlbGVtZW50LnN0eWxlOwoKICAgIC8vIENoZWNrIGlmIHdlIGFyZSBub3QgZGVhbGluZyB3aXRoIHBpeGVscywgKE9wZXJhIGhhcyBpc3N1ZXMgd2l0aCB0aGlzKQogICAgLy8gUG9ydGVkIGZyb20galF1ZXJ5IGNzcy5qcwogICAgLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwogICAgLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoKICAgIC8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcgogICAgLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgogICAgaWYgKCAhL14tP1swLTldK1wuP1swLTldKig/OnB4KT8kL2kudGVzdCggdmFsdWUgKSAmJiAvXi0/XGQvLnRlc3QodmFsdWUpICkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICBsZWZ0ID0gc3R5bGUubGVmdDsKCiAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICAgIGlmIChyc0xlZnQpIHsKICAgICAgICAgICAgZWxlbWVudC5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW1lbnQuY3VycmVudFN0eWxlLmxlZnQ7CiAgICAgICAgfQogICAgICAgIHN0eWxlLmxlZnQgPSBhdHRyaWJ1dGUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6ICh2YWx1ZSB8fCAwKTsKICAgICAgICB2YWx1ZSA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgogICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKICAgICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgICBpZiAocnNMZWZ0KSB7CiAgICAgICAgICAgIGVsZW1lbnQucnVudGltZVN0eWxlLmxlZnQgPSByc0xlZnQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICghL14odGhpbnxtZWRpdW18dGhpY2spJC9pLnRlc3QodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQocGFyc2VGbG9hdCh2YWx1ZSkpICsgInB4IjsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7Cn0KCmZ1bmN0aW9uIGFzSW50KHZhbCkgewogICAgcmV0dXJuIHBhcnNlSW50KHZhbCwgMTApOwp9CgpmdW5jdGlvbiBwYXJzZUJhY2tncm91bmRTaXplUG9zaXRpb24odmFsdWUsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIHZhbHVlID0gKHZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpOwogICAgdmFsdWUgPSB2YWx1ZVtpbmRleCB8fCAwXSB8fCB2YWx1ZVswXSB8fCAnYXV0byc7CiAgICB2YWx1ZSA9IF9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0KHZhbHVlKS5zcGxpdCgnICcpOwoKICAgIGlmKGF0dHJpYnV0ZSA9PT0gJ2JhY2tncm91bmRTaXplJyAmJiAoIXZhbHVlWzBdIHx8IHZhbHVlWzBdLm1hdGNoKC9jb3Zlcnxjb250YWlufGF1dG8vKSkpIHsKICAgICAgICAvL3RoZXNlIHZhbHVlcyB3aWxsIGJlIGhhbmRsZWQgaW4gdGhlIHBhcmVudCBmdW5jdGlvbgogICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZVswXSA9ICh2YWx1ZVswXS5pbmRleE9mKCAiJSIgKSA9PT0gLTEpID8gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUgKyAiWCIsIHZhbHVlWzBdKSA6IHZhbHVlWzBdOwogICAgICAgIGlmKHZhbHVlWzFdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYoYXR0cmlidXRlID09PSAnYmFja2dyb3VuZFNpemUnKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVsxXSA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElFIDkgZG9lc24ndCByZXR1cm4gZG91YmxlIGRpZ2l0IGFsd2F5cwogICAgICAgICAgICAgICAgdmFsdWVbMV0gPSB2YWx1ZVswXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YWx1ZVsxXSA9ICh2YWx1ZVsxXS5pbmRleE9mKCIlIikgPT09IC0xKSA/IHRvUFgoZWxlbWVudCwgYXR0cmlidXRlICsgIlkiLCB2YWx1ZVsxXSkgOiB2YWx1ZVsxXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKfQoKX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTID0gZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIGlmIChwcmV2aW91c0VsZW1lbnQgIT09IGVsZW1lbnQpIHsKICAgICAgY29tcHV0ZWRDU1MgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsIG51bGwpOwogICAgfQoKICAgIHZhciB2YWx1ZSA9IGNvbXB1dGVkQ1NTW2F0dHJpYnV0ZV07CgogICAgaWYgKC9eYmFja2dyb3VuZChTaXplfFBvc2l0aW9uKSQvLnRlc3QoYXR0cmlidXRlKSkgewogICAgICAgIHJldHVybiBwYXJzZUJhY2tncm91bmRTaXplUG9zaXRpb24odmFsdWUsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpOwogICAgfSBlbHNlIGlmICgvYm9yZGVyKFRvcHxCb3R0b20pKExlZnR8UmlnaHQpUmFkaXVzLy50ZXN0KGF0dHJpYnV0ZSkpIHsKICAgICAgdmFyIGFyciA9IHZhbHVlLnNwbGl0KCIgIik7CiAgICAgIGlmIChhcnIubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgIGFyclsxXSA9IGFyclswXTsKICAgICAgfQogICAgICByZXR1cm4gYXJyLm1hcChhc0ludCk7CiAgICB9CgogIHJldHVybiB2YWx1ZTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLnJlc2l6ZUJvdW5kcyA9IGZ1bmN0aW9uKCBjdXJyZW50X3dpZHRoLCBjdXJyZW50X2hlaWdodCwgdGFyZ2V0X3dpZHRoLCB0YXJnZXRfaGVpZ2h0LCBzdHJldGNoX21vZGUgKXsKICB2YXIgdGFyZ2V0X3JhdGlvID0gdGFyZ2V0X3dpZHRoIC8gdGFyZ2V0X2hlaWdodCwKICAgIGN1cnJlbnRfcmF0aW8gPSBjdXJyZW50X3dpZHRoIC8gY3VycmVudF9oZWlnaHQsCiAgICBvdXRwdXRfd2lkdGgsIG91dHB1dF9oZWlnaHQ7CgogIGlmKCFzdHJldGNoX21vZGUgfHwgc3RyZXRjaF9tb2RlID09PSAnYXV0bycpIHsKICAgIG91dHB1dF93aWR0aCA9IHRhcmdldF93aWR0aDsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfaGVpZ2h0OwogIH0gZWxzZSBpZih0YXJnZXRfcmF0aW8gPCBjdXJyZW50X3JhdGlvIF4gc3RyZXRjaF9tb2RlID09PSAnY29udGFpbicpIHsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfaGVpZ2h0OwogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X2hlaWdodCAqIGN1cnJlbnRfcmF0aW87CiAgfSBlbHNlIHsKICAgIG91dHB1dF93aWR0aCA9IHRhcmdldF93aWR0aDsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfd2lkdGggLyBjdXJyZW50X3JhdGlvOwogIH0KCiAgcmV0dXJuIHsKICAgIHdpZHRoOiBvdXRwdXRfd2lkdGgsCiAgICBoZWlnaHQ6IG91dHB1dF9oZWlnaHQKICB9Owp9OwoKZnVuY3Rpb24gYmFja2dyb3VuZEJvdW5kc0ZhY3RvcnkoIHByb3AsIGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSApIHsKICAgIHZhciBiZ3Bvc2l0aW9uID0gIF9odG1sMmNhbnZhcy5VdGlsLmdldENTUyggZWwsIHByb3AsIGltYWdlSW5kZXggKSAsCiAgICB0b3BQb3MsCiAgICBsZWZ0LAogICAgcGVyY2VudGFnZSwKICAgIHZhbDsKCiAgICBpZiAoYmdwb3NpdGlvbi5sZW5ndGggPT09IDEpewogICAgICB2YWwgPSBiZ3Bvc2l0aW9uWzBdOwoKICAgICAgYmdwb3NpdGlvbiA9IFtdOwoKICAgICAgYmdwb3NpdGlvblswXSA9IHZhbDsKICAgICAgYmdwb3NpdGlvblsxXSA9IHZhbDsKICAgIH0KCiAgICBpZiAoYmdwb3NpdGlvblswXS50b1N0cmluZygpLmluZGV4T2YoIiUiKSAhPT0gLTEpewogICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblswXSkvMTAwKTsKICAgICAgbGVmdCA9IGJvdW5kcy53aWR0aCAqIHBlcmNlbnRhZ2U7CiAgICAgIGlmKHByb3AgIT09ICdiYWNrZ3JvdW5kU2l6ZScpIHsKICAgICAgICBsZWZ0IC09IChiYWNrZ3JvdW5kU2l6ZSB8fCBpbWFnZSkud2lkdGgqcGVyY2VudGFnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYocHJvcCA9PT0gJ2JhY2tncm91bmRTaXplJykgewogICAgICAgIGlmKGJncG9zaXRpb25bMF0gPT09ICdhdXRvJykgewogICAgICAgICAgbGVmdCA9IGltYWdlLndpZHRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoL2NvbnRhaW58Y292ZXIvLnRlc3QoYmdwb3NpdGlvblswXSkpIHsKICAgICAgICAgICAgdmFyIHJlc2l6ZWQgPSBfaHRtbDJjYW52YXMuVXRpbC5yZXNpemVCb3VuZHMoaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCBiZ3Bvc2l0aW9uWzBdKTsKICAgICAgICAgICAgbGVmdCA9IHJlc2l6ZWQud2lkdGg7CiAgICAgICAgICAgIHRvcFBvcyA9IHJlc2l6ZWQuaGVpZ2h0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVmdCA9IHBhcnNlSW50KGJncG9zaXRpb25bMF0sIDEwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVmdCA9IHBhcnNlSW50KCBiZ3Bvc2l0aW9uWzBdLCAxMCk7CiAgICAgIH0KICAgIH0KCgogICAgaWYoYmdwb3NpdGlvblsxXSA9PT0gJ2F1dG8nKSB7CiAgICAgIHRvcFBvcyA9IGxlZnQgLyBpbWFnZS53aWR0aCAqIGltYWdlLmhlaWdodDsKICAgIH0gZWxzZSBpZiAoYmdwb3NpdGlvblsxXS50b1N0cmluZygpLmluZGV4T2YoIiUiKSAhPT0gLTEpewogICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblsxXSkvMTAwKTsKICAgICAgdG9wUG9zID0gIGJvdW5kcy5oZWlnaHQgKiBwZXJjZW50YWdlOwogICAgICBpZihwcm9wICE9PSAnYmFja2dyb3VuZFNpemUnKSB7CiAgICAgICAgdG9wUG9zIC09IChiYWNrZ3JvdW5kU2l6ZSB8fCBpbWFnZSkuaGVpZ2h0ICogcGVyY2VudGFnZTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIHRvcFBvcyA9IHBhcnNlSW50KGJncG9zaXRpb25bMV0sMTApOwogICAgfQoKICAgIHJldHVybiBbbGVmdCwgdG9wUG9zXTsKfQoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uID0gZnVuY3Rpb24oIGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSApIHsKICAgIHZhciByZXN1bHQgPSBiYWNrZ3JvdW5kQm91bmRzRmFjdG9yeSggJ2JhY2tncm91bmRQb3NpdGlvbicsIGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSApOwogICAgcmV0dXJuIHsgbGVmdDogcmVzdWx0WzBdLCB0b3A6IHJlc3VsdFsxXSB9Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFNpemUgPSBmdW5jdGlvbiggZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXggKSB7CiAgICB2YXIgcmVzdWx0ID0gYmFja2dyb3VuZEJvdW5kc0ZhY3RvcnkoICdiYWNrZ3JvdW5kU2l6ZScsIGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4ICk7CiAgICByZXR1cm4geyB3aWR0aDogcmVzdWx0WzBdLCBoZWlnaHQ6IHJlc3VsdFsxXSB9Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kID0gZnVuY3Rpb24gKG9wdGlvbnMsIGRlZmF1bHRzKSB7CiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgZGVmYXVsdHNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgIH0KICB9CiAgcmV0dXJuIGRlZmF1bHRzOwp9OwoKCi8qCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKICB2YXIgY2hpbGRyZW47CiAgdHJ5IHsKICAgIGNoaWxkcmVuID0gKGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiSUZSQU1FIikgPyBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOiAoZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgdmFyIHJldCA9IFtdOwogICAgICBpZiAoYXJyYXkgIT09IG51bGwpIHsKICAgICAgICAoZnVuY3Rpb24oZmlyc3QsIHNlY29uZCApIHsKICAgICAgICAgIHZhciBpID0gZmlyc3QubGVuZ3RoLAogICAgICAgICAgaiA9IDA7CgogICAgICAgICAgaWYgKHR5cGVvZiBzZWNvbmQubGVuZ3RoID09PSAibnVtYmVyIikgewogICAgICAgICAgICBmb3IgKHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKykgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChzZWNvbmRbal0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbaisrXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7CgogICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgIH0pKHJldCwgYXJyYXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9KShlbGVtLmNoaWxkTm9kZXMpOwoKICB9IGNhdGNoIChleCkgewogICAgX2h0bWwyY2FudmFzLlV0aWwubG9nKCJodG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuIGZhaWxlZCB3aXRoIGV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgY2hpbGRyZW4gPSBbXTsKICB9CiAgcmV0dXJuIGNoaWxkcmVuOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuaXNUcmFuc3BhcmVudCA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikgewogIHJldHVybiAoYmFja2dyb3VuZENvbG9yID09PSAidHJhbnNwYXJlbnQiIHx8IGJhY2tncm91bmRDb2xvciA9PT0gInJnYmEoMCwgMCwgMCwgMCkiKTsKfTsKX2h0bWwyY2FudmFzLlV0aWwuRm9udCA9IChmdW5jdGlvbiAoKSB7CgogIHZhciBmb250RGF0YSA9IHt9OwoKICByZXR1cm4gZnVuY3Rpb24oZm9udCwgZm9udFNpemUsIGRvYykgewogICAgaWYgKGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXTsKICAgIH0KCiAgICB2YXIgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgaW1nID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2ltZycpLAogICAgc3BhbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyksCiAgICBzYW1wbGVUZXh0ID0gJ0hpZGRlbiBUZXh0JywKICAgIGJhc2VsaW5lLAogICAgbWlkZGxlLAogICAgbWV0cmljc09iajsKCiAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7CiAgICBjb250YWluZXIuc3R5bGUubWFyZ2luID0gMDsKICAgIGNvbnRhaW5lci5zdHlsZS5wYWRkaW5nID0gMDsKCiAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpOwoKICAgIC8vIGh0dHA6Ly9wcm9iYWJseXByb2dyYW1taW5nLmNvbS8yMDA5LzAzLzE1L3RoZS10aW5pZXN0LWdpZi1ldmVyIChoYW5kdGlueXdoaXRlLmdpZikKICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUJBUC8vL3dBQUFDd0FBQUFBQVFBQkFBQUNBa1FCQURzPSI7CiAgICBpbWcud2lkdGggPSAxOwogICAgaW1nLmhlaWdodCA9IDE7CgogICAgaW1nLnN0eWxlLm1hcmdpbiA9IDA7CiAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7CiAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJiYXNlbGluZSI7CgogICAgc3Bhbi5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgIHNwYW4uc3R5bGUubWFyZ2luID0gMDsKICAgIHNwYW4uc3R5bGUucGFkZGluZyA9IDA7CgogICAgc3Bhbi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2FtcGxlVGV4dCkpOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwYW4pOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGltZyk7CiAgICBiYXNlbGluZSA9IChpbWcub2Zmc2V0VG9wIC0gc3Bhbi5vZmZzZXRUb3ApICsgMTsKCiAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3Bhbik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHNhbXBsZVRleHQpKTsKCiAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOwogICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAic3VwZXIiOwoKICAgIG1pZGRsZSA9IChpbWcub2Zmc2V0VG9wLWNvbnRhaW5lci5vZmZzZXRUb3ApICsgMTsKICAgIG1ldHJpY3NPYmogPSB7CiAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwKICAgICAgbGluZVdpZHRoOiAxLAogICAgICBtaWRkbGU6IG1pZGRsZQogICAgfTsKCiAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsKCiAgICBkb2MuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgIHJldHVybiBtZXRyaWNzT2JqOwogIH07Cn0pKCk7CgooZnVuY3Rpb24oKXsKICB2YXIgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogICAgR2VuZXJhdGUgPSB7fTsKCiAgX2h0bWwyY2FudmFzLkdlbmVyYXRlID0gR2VuZXJhdGU7CgogIHZhciByZUdyYWRpZW50cyA9IFsKICAvXigtd2Via2l0LWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1ncmFkaWVudClcKChsaW5lYXJ8cmFkaWFsKSxccygoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pLFxzKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXC1dKylcKSQvLAogIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXpcLV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1tb3otcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3Kylccz8oW2EtelwtXSopKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW8tcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3KylccyhbYS16XC1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLwogIF07CgogIC8qCiAqIFRPRE86IEFkZCBJRTEwIHZlbmRvciBwcmVmaXggKC1tcykgc3VwcG9ydAogKiBUT0RPOiBBZGQgVzNDIGdyYWRpZW50IChsaW5lYXItZ3JhZGllbnQpIHN1cHBvcnQKICogVE9ETzogQWRkIG9sZCBXZWJraXQgLXdlYmtpdC1ncmFkaWVudChyYWRpYWwsIC4uLikgc3VwcG9ydAogKiBUT0RPOiBNYXliZSBzb21lIFJlZ0V4cCBvcHRpbWl6YXRpb25zIGFyZSBwb3NzaWJsZSA7bykKICovCiAgR2VuZXJhdGUucGFyc2VHcmFkaWVudCA9IGZ1bmN0aW9uKGNzcywgYm91bmRzKSB7CiAgICB2YXIgZ3JhZGllbnQsIGksIGxlbiA9IHJlR3JhZGllbnRzLmxlbmd0aCwgbTEsIHN0b3AsIG0yLCBtMkxlbiwgc3RlcCwgbTMsIHRsLHRyLGJyLGJsOwoKICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7CiAgICAgIG0xID0gY3NzLm1hdGNoKHJlR3JhZGllbnRzW2ldKTsKICAgICAgaWYobTEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmKG0xKSB7CiAgICAgIHN3aXRjaChtMVsxXSkgewogICAgICAgIGNhc2UgJy13ZWJraXQtbGluZWFyLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctby1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IG51bGwsCiAgICAgICAgICAgIHkwOiBudWxsLAogICAgICAgICAgICB4MTogbnVsbCwKICAgICAgICAgICAgeTE6IG51bGwsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvXHcrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIHN3aXRjaChtMltpXSkgewogICAgICAgICAgICAgICAgY2FzZSAndG9wJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAwOwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IDA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IDA7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmKGdyYWRpZW50LngwID09PSBudWxsICYmIGdyYWRpZW50LngxID09PSBudWxsKXsgLy8gY2VudGVyCiAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOwogICAgICAgICAgfQogICAgICAgICAgaWYoZ3JhZGllbnQueTAgPT09IG51bGwgJiYgZ3JhZGllbnQueTEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQgLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30oPzolfHB4KSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICBzdG9wIC89IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6IG0xWzJdID09PSAncmFkaWFsJyA/ICdjaXJjbGUnIDogbTFbMl0sIC8vIFRPRE86IEFkZCByYWRpYWwgZ3JhZGllbnQgc3VwcG9ydCBmb3Igb2xkZXIgbW96aWxsYSBkZWZpbml0aW9ucwogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiAwLAogICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC54MSA9IChtMlszXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkxID0gKG0yWzRdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbNF0ubWF0Y2goLygoPzpmcm9tfHRvfGNvbG9yLXN0b3ApXCgoPzpbMC05XC5dKyxccyk/KD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XClcKSkrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLyhmcm9tfHRvfGNvbG9yLXN0b3ApXCgoWzAtOVwuXSspPyg/Oixccyk/KCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVwpLyk7CiAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHsKICAgICAgICAgICAgICAgIHN0b3AgPSAwLjA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAndG8nKSB7CiAgICAgICAgICAgICAgICBzdG9wID0gMS4wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLW1vei1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7CgogICAgICAgICAgLy8gbTJbMV0gPT0gMCUgICAtPiBsZWZ0CiAgICAgICAgICAvLyBtMlsxXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMV0gPT0gMTAwJSAtPiByaWdodAoKICAgICAgICAgIC8vIG0yWzJdID09IDAlICAgLT4gdG9wCiAgICAgICAgICAvLyBtMlsyXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMl0gPT0gMTAwJSAtPiBib3R0b20KCiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLSBncmFkaWVudC54MDsKICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSUpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJSk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10peyAvLyBwZXJjZW50YWdlCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctd2Via2l0LXJhZGlhbC1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1vLXJhZGlhbC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdjaXJjbGUnLAogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiBib3VuZHMud2lkdGgsCiAgICAgICAgICAgIHkxOiBib3VuZHMuaGVpZ2h0LAogICAgICAgICAgICBjeDogMCwKICAgICAgICAgICAgY3k6IDAsCiAgICAgICAgICAgIHJ4OiAwLAogICAgICAgICAgICByeTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gY2VudGVyCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQuY3ggPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC5jeSA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHNpemUKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goL1x3Ky8pOwogICAgICAgICAgbTMgPSBtMVs0XS5tYXRjaCgvW2EtelwtXSovKTsKICAgICAgICAgIGlmKG0yICYmIG0zKXsKICAgICAgICAgICAgc3dpdGNoKG0zWzBdKXsKICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1jb3JuZXInOgogICAgICAgICAgICAgIGNhc2UgJ2NvdmVyJzogLy8gaXMgZXF1aXZhbGVudCB0byBmYXJ0aGVzdC1jb3JuZXIKICAgICAgICAgICAgICBjYXNlICcnOiAvLyBtb3ppbGxhIHJlbW92ZXMgImNvdmVyIiBmcm9tIGRlZmluaXRpb24gOigKICAgICAgICAgICAgICAgIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LWNvcm5lcic6CiAgICAgICAgICAgICAgICB0bCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYnIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBibCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4odGwsIHRyLCBiciwgYmwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LXNpZGUnOgogICAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW4nOiAvLyBpcyBlcXVpdmFsZW50IHRvIGNsb3Nlc3Qtc2lkZQogICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICBncmFkaWVudC50eXBlID0gbTJbMF07CgogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgIjMwcHggNDBweCIgc2l6ZXMgKHdlYmtpdCBvbmx5KQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY29sb3Igc3RvcHMKICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpewogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGdyYWRpZW50OwogIH07CgogIGZ1bmN0aW9uIGFkZFNjcm9sbFN0b3BzKGdyYWQpIHsKICAgIHJldHVybiBmdW5jdGlvbihjb2xvclN0b3ApIHsKICAgICAgdHJ5IHsKICAgICAgICBncmFkLmFkZENvbG9yU3RvcChjb2xvclN0b3Auc3RvcCwgY29sb3JTdG9wLmNvbG9yKTsKICAgICAgfQogICAgICBjYXRjaChlKSB7CiAgICAgICAgVXRpbC5sb2coWydmYWlsZWQgdG8gYWRkIGNvbG9yIHN0b3A6ICcsIGUsICc7IHRyaWVkIHRvIGFkZDogJywgY29sb3JTdG9wXSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBHZW5lcmF0ZS5HcmFkaWVudCA9IGZ1bmN0aW9uKHNyYywgYm91bmRzKSB7CiAgICBpZihib3VuZHMud2lkdGggPT09IDAgfHwgYm91bmRzLmhlaWdodCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksCiAgICBncmFkaWVudCwgZ3JhZDsKCiAgICBjYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKCiAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgbXVsdGkgZGVmaW5lZCBiYWNrZ3JvdW5kIGdyYWRpZW50cwogICAgZ3JhZGllbnQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudChzcmMsIGJvdW5kcyk7CgogICAgaWYoZ3JhZGllbnQpIHsKICAgICAgc3dpdGNoKGdyYWRpZW50LnR5cGUpIHsKICAgICAgICBjYXNlICdsaW5lYXInOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChncmFkaWVudC54MCwgZ3JhZGllbnQueTAsIGdyYWRpZW50LngxLCBncmFkaWVudC55MSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdjaXJjbGUnOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIDAsIGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgZ3JhZGllbnQucngpOwogICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5mb3JFYWNoKGFkZFNjcm9sbFN0b3BzKGdyYWQpKTsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnZWxsaXBzZSc6CiAgICAgICAgICB2YXIgY2FudmFzUmFkaWFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCiAgICAgICAgICAgIGN0eFJhZGlhbCA9IGNhbnZhc1JhZGlhbC5nZXRDb250ZXh0KCcyZCcpLAogICAgICAgICAgICByaSA9IE1hdGgubWF4KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSksCiAgICAgICAgICAgIGRpID0gcmkgKiAyOwoKICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsKCiAgICAgICAgICBncmFkID0gY3R4UmFkaWFsLmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgMCwgZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCByaSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwoKICAgICAgICAgIGN0eFJhZGlhbC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4UmFkaWFsLmZpbGxSZWN0KDAsIDAsIGRpLCBkaSk7CgogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbZ3JhZGllbnQuY29sb3JTdG9wcy5sZW5ndGggLSAxXS5jb2xvcjsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgY3R4LmRyYXdJbWFnZShjYW52YXNSYWRpYWwsIGdyYWRpZW50LmN4IC0gZ3JhZGllbnQucngsIGdyYWRpZW50LmN5IC0gZ3JhZGllbnQucnksIDIgKiBncmFkaWVudC5yeCwgMiAqIGdyYWRpZW50LnJ5KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNhbnZhczsKICB9OwoKICBHZW5lcmF0ZS5MaXN0QWxwaGEgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgIHZhciB0bXAgPSAiIiwKICAgIG1vZHVsdXM7CgogICAgZG8gewogICAgICBtb2R1bHVzID0gbnVtYmVyICUgMjY7CiAgICAgIHRtcCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoKG1vZHVsdXMpICsgNjQpICsgdG1wOwogICAgICBudW1iZXIgPSBudW1iZXIgLyAyNjsKICAgIH13aGlsZSgobnVtYmVyKjI2KSA+IDI2KTsKCiAgICByZXR1cm4gdG1wOwogIH07CgogIEdlbmVyYXRlLkxpc3RSb21hbiA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHJvbWFuQXJyYXkgPSBbIk0iLCAiQ00iLCAiRCIsICJDRCIsICJDIiwgIlhDIiwgIkwiLCAiWEwiLCAiWCIsICJJWCIsICJWIiwgIklWIiwgIkkiXSwKICAgIGRlY2ltYWwgPSBbMTAwMCwgOTAwLCA1MDAsIDQwMCwgMTAwLCA5MCwgNTAsIDQwLCAxMCwgOSwgNSwgNCwgMV0sCiAgICByb21hbiA9ICIiLAogICAgdiwKICAgIGxlbiA9IHJvbWFuQXJyYXkubGVuZ3RoOwoKICAgIGlmIChudW1iZXIgPD0gMCB8fCBudW1iZXIgPj0gNDAwMCkgewogICAgICByZXR1cm4gbnVtYmVyOwogICAgfQoKICAgIGZvciAodj0wOyB2IDwgbGVuOyB2Kz0xKSB7CiAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgewogICAgICAgIG51bWJlciAtPSBkZWNpbWFsW3ZdOwogICAgICAgIHJvbWFuICs9IHJvbWFuQXJyYXlbdl07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcm9tYW47CiAgfTsKfSkoKTsKZnVuY3Rpb24gaDJjUmVuZGVyQ29udGV4dCh3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIHN0b3JhZ2UgPSBbXTsKICByZXR1cm4gewogICAgc3RvcmFnZTogc3RvcmFnZSwKICAgIHdpZHRoOiB3aWR0aCwKICAgIGhlaWdodDogaGVpZ2h0LAogICAgY2xpcDogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiY2xpcCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICB0cmFuc2xhdGU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInRyYW5zbGF0ZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInNhdmUiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgcmVzdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAicmVzdG9yZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsUmVjdDogZnVuY3Rpb24gKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGxSZWN0IiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGNyZWF0ZVBhdHRlcm46IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImNyZWF0ZVBhdHRlcm4iLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZHJhd1NoYXBlOiBmdW5jdGlvbigpIHsKCiAgICAgIHZhciBzaGFwZSA9IFtdOwoKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJkcmF3U2hhcGUiLAogICAgICAgICdhcmd1bWVudHMnOiBzaGFwZQogICAgICB9KTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgbW92ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAibW92ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBsaW5lVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJsaW5lVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFyY1RvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAiYXJjVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJiZXppZXJDdXJ2ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAicXVhZHJhdGljQ3VydmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9LAogICAgZHJhd0ltYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZHJhd0ltYWdlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbFRleHQiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgc2V0VmFyaWFibGU6IGZ1bmN0aW9uICh2YXJpYWJsZSwgdmFsdWUpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAidmFyaWFibGUiLAogICAgICAgIG5hbWU6IHZhcmlhYmxlLAogICAgICAgICdhcmd1bWVudHMnOiB2YWx1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH07Cn0KX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKGltYWdlcywgb3B0aW9ucykgewogIHdpbmRvdy5zY3JvbGwoMCwwKTsKCiAgdmFyIGVsZW1lbnQgPSAoKCBvcHRpb25zLmVsZW1lbnRzID09PSB1bmRlZmluZWQgKSA/IGRvY3VtZW50LmJvZHkgOiBvcHRpb25zLmVsZW1lbnRzWzBdKSwgLy8gc2VsZWN0IGJvZHkgYnkgZGVmYXVsdAogIG51bURyYXdzID0gMCwKICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIHN1cHBvcnQgPSBVdGlsLlN1cHBvcnQob3B0aW9ucywgZG9jKSwKICBpZ25vcmVFbGVtZW50c1JlZ0V4cCA9IG5ldyBSZWdFeHAoIigiICsgb3B0aW9ucy5pZ25vcmVFbGVtZW50cyArICIpIiksCiAgYm9keSA9IGRvYy5ib2R5LAogIGdldENTUyA9IFV0aWwuZ2V0Q1NTLAogIHBzZXVkb0hpZGUgPSAiX19faHRtbDJjYW52YXNfX19wc2V1ZG9lbGVtZW50IiwKICBoaWRlUHNldWRvRWxlbWVudHMgPSBkb2MuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKCiAgaGlkZVBzZXVkb0VsZW1lbnRzLmlubmVySFRNTCA9ICcuJyArIHBzZXVkb0hpZGUgKyAnLWJlZm9yZTpiZWZvcmUgeyBjb250ZW50OiAiIiAhaW1wb3J0YW50OyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0nICsKICAnLicgKyBwc2V1ZG9IaWRlICsgJy1hZnRlcjphZnRlciB7IGNvbnRlbnQ6ICIiICFpbXBvcnRhbnQ7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfSc7CgogIGJvZHkuYXBwZW5kQ2hpbGQoaGlkZVBzZXVkb0VsZW1lbnRzKTsKCiAgaW1hZ2VzID0gaW1hZ2VzIHx8IHt9OwoKICBmdW5jdGlvbiBkb2N1bWVudFdpZHRoICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuc2Nyb2xsV2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsV2lkdGgpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRXaWR0aCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKQogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZG9jdW1lbnRIZWlnaHQgKCkgewogICAgcmV0dXJuIE1hdGgubWF4KAogICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkub2Zmc2V0SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50Lm9mZnNldEhlaWdodCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiBnZXRDU1NJbnQoZWxlbWVudCwgYXR0cmlidXRlKSB7CiAgICB2YXIgdmFsID0gcGFyc2VJbnQoZ2V0Q1NTKGVsZW1lbnQsIGF0dHJpYnV0ZSksIDEwKTsKICAgIHJldHVybiAoaXNOYU4odmFsKSkgPyAwIDogdmFsOyAvLyBib3JkZXJzIGluIG9sZCBJRSBhcmUgdGhyb3dpbmcgJ21lZGl1bScgZm9yIGRlbW8uaHRtbAogIH0KCiAgZnVuY3Rpb24gcmVuZGVyUmVjdCAoY3R4LCB4LCB5LCB3LCBoLCBiZ2NvbG9yKSB7CiAgICBpZiAoYmdjb2xvciAhPT0gInRyYW5zcGFyZW50Iil7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgYmdjb2xvcik7CiAgICAgIGN0eC5maWxsUmVjdCh4LCB5LCB3LCBoKTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjYXBpdGFsaXplKG0sIHAxLCBwMikgewogICAgaWYgKG0ubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gcDEgKyBwMi50b1VwcGVyQ2FzZSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGV4dFRyYW5zZm9ybSAodGV4dCwgdHJhbnNmb3JtKSB7CiAgICBzd2l0Y2godHJhbnNmb3JtKXsKICAgICAgY2FzZSAibG93ZXJjYXNlIjoKICAgICAgICByZXR1cm4gdGV4dC50b0xvd2VyQ2FzZSgpOwogICAgICBjYXNlICJjYXBpdGFsaXplIjoKICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKCAvKF58XHN8OnwtfFwofFwpKShbYS16XSkvZywgY2FwaXRhbGl6ZSk7CiAgICAgIGNhc2UgInVwcGVyY2FzZSI6CiAgICAgICAgcmV0dXJuIHRleHQudG9VcHBlckNhc2UoKTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gdGV4dDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG5vTGV0dGVyU3BhY2luZyhsZXR0ZXJfc3BhY2luZykgewogICAgcmV0dXJuICgvXihub3JtYWx8bm9uZXwwcHgpJC8udGVzdChsZXR0ZXJfc3BhY2luZykpOwogIH0KCiAgZnVuY3Rpb24gZHJhd1RleHQoY3VycmVudFRleHQsIHgsIHksIGN0eCl7CiAgICBpZiAoY3VycmVudFRleHQgIT09IG51bGwgJiYgVXRpbC50cmltVGV4dChjdXJyZW50VGV4dCkubGVuZ3RoID4gMCkgewogICAgICBjdHguZmlsbFRleHQoY3VycmVudFRleHQsIHgsIHkpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbCwgdGV4dF9kZWNvcmF0aW9uLCBjb2xvcikgewogICAgdmFyIGFsaWduID0gZmFsc2UsCiAgICBib2xkID0gZ2V0Q1NTKGVsLCAiZm9udFdlaWdodCIpLAogICAgZmFtaWx5ID0gZ2V0Q1NTKGVsLCAiZm9udEZhbWlseSIpLAogICAgc2l6ZSA9IGdldENTUyhlbCwgImZvbnRTaXplIiksCiAgICBzaGFkb3dzID0gVXRpbC5wYXJzZVRleHRTaGFkb3dzKGdldENTUyhlbCwgInRleHRTaGFkb3ciKSk7CgogICAgc3dpdGNoKHBhcnNlSW50KGJvbGQsIDEwKSl7CiAgICAgIGNhc2UgNDAxOgogICAgICAgIGJvbGQgPSAiYm9sZCI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDAwOgogICAgICAgIGJvbGQgPSAibm9ybWFsIjsKICAgICAgICBicmVhazsKICAgIH0KCiAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGNvbG9yKTsKICAgIGN0eC5zZXRWYXJpYWJsZSgiZm9udCIsIFtnZXRDU1MoZWwsICJmb250U3R5bGUiKSwgZ2V0Q1NTKGVsLCAiZm9udFZhcmlhbnQiKSwgYm9sZCwgc2l6ZSwgZmFtaWx5XS5qb2luKCIgIikpOwogICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAoYWxpZ24pID8gInJpZ2h0IiA6ICJsZWZ0Iik7CgogICAgaWYgKHNoYWRvd3MubGVuZ3RoKSB7CiAgICAgIC8vIFRPRE86IHN1cHBvcnQgbXVsdGlwbGUgdGV4dCBzaGFkb3dzCiAgICAgIC8vIGFwcGx5IHRoZSBmaXJzdCB0ZXh0IHNoYWRvdwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd0NvbG9yIiwgc2hhZG93c1swXS5jb2xvcik7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93T2Zmc2V0WCIsIHNoYWRvd3NbMF0ub2Zmc2V0WCk7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93T2Zmc2V0WSIsIHNoYWRvd3NbMF0ub2Zmc2V0WSk7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93Qmx1ciIsIHNoYWRvd3NbMF0uYmx1cik7CiAgICB9CgogICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiKXsKICAgICAgcmV0dXJuIFV0aWwuRm9udChmYW1pbHksIHNpemUsIGRvYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJUZXh0RGVjb3JhdGlvbihjdHgsIHRleHRfZGVjb3JhdGlvbiwgYm91bmRzLCBtZXRyaWNzLCBjb2xvcikgewogICAgc3dpdGNoKHRleHRfZGVjb3JhdGlvbikgewogICAgICBjYXNlICJ1bmRlcmxpbmUiOgogICAgICAgIC8vIERyYXdzIGEgbGluZSBhdCB0aGUgYmFzZWxpbmUgb2YgdGhlIGZvbnQKICAgICAgICAvLyBUT0RPIEFzIHNvbWUgYnJvd3NlcnMgZGlzcGxheSB0aGUgbGluZSBhcyBtb3JlIHRoYW4gMXB4IGlmIHRoZSBmb250LXNpemUgaXMgYmlnLCBuZWVkIHRvIHRha2UgdGhhdCBpbnRvIGFjY291bnQgYm90aCBpbiBwb3NpdGlvbiBhbmQgc2l6ZQogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5yb3VuZChib3VuZHMudG9wICsgbWV0cmljcy5iYXNlbGluZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIm92ZXJsaW5lIjoKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGgucm91bmQoYm91bmRzLnRvcCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsaW5lLXRocm91Z2giOgogICAgICAgIC8vIFRPRE8gdHJ5IGFuZCBmaW5kIGV4YWN0IHBvc2l0aW9uIGZvciBsaW5lLXRocm91Z2gKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGguY2VpbChib3VuZHMudG9wICsgbWV0cmljcy5taWRkbGUgKyBtZXRyaWNzLmxpbmVXaWR0aCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0VGV4dEJvdW5kcyhzdGF0ZSwgdGV4dCwgdGV4dERlY29yYXRpb24sIGlzTGFzdCwgdHJhbnNmb3JtKSB7CiAgICB2YXIgYm91bmRzOwogICAgaWYgKHN1cHBvcnQucmFuZ2VCb3VuZHMgJiYgIXRyYW5zZm9ybSkgewogICAgICBpZiAodGV4dERlY29yYXRpb24gIT09ICJub25lIiB8fCBVdGlsLnRyaW1UZXh0KHRleHQpLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGJvdW5kcyA9IHRleHRSYW5nZUJvdW5kcyh0ZXh0LCBzdGF0ZS5ub2RlLCBzdGF0ZS50ZXh0T2Zmc2V0KTsKICAgICAgfQogICAgICBzdGF0ZS50ZXh0T2Zmc2V0ICs9IHRleHQubGVuZ3RoOwogICAgfSBlbHNlIGlmIChzdGF0ZS5ub2RlICYmIHR5cGVvZiBzdGF0ZS5ub2RlLm5vZGVWYWx1ZSA9PT0gInN0cmluZyIgKXsKICAgICAgdmFyIG5ld1RleHROb2RlID0gKGlzTGFzdCkgPyBzdGF0ZS5ub2RlLnNwbGl0VGV4dCh0ZXh0Lmxlbmd0aCkgOiBudWxsOwogICAgICBib3VuZHMgPSB0ZXh0V3JhcHBlckJvdW5kcyhzdGF0ZS5ub2RlLCB0cmFuc2Zvcm0pOwogICAgICBzdGF0ZS5ub2RlID0gbmV3VGV4dE5vZGU7CiAgICB9CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gdGV4dFJhbmdlQm91bmRzKHRleHQsIHRleHROb2RlLCB0ZXh0T2Zmc2V0KSB7CiAgICB2YXIgcmFuZ2UgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgIHJhbmdlLnNldFN0YXJ0KHRleHROb2RlLCB0ZXh0T2Zmc2V0KTsKICAgIHJhbmdlLnNldEVuZCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCArIHRleHQubGVuZ3RoKTsKICAgIHJldHVybiByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CgogIGZ1bmN0aW9uIHRleHRXcmFwcGVyQm91bmRzKG9sZFRleHROb2RlLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBwYXJlbnQgPSBvbGRUZXh0Tm9kZS5wYXJlbnROb2RlLAogICAgd3JhcEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnd3JhcHBlcicpLAogICAgYmFja3VwVGV4dCA9IG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKTsKCiAgICB3cmFwRWxlbWVudC5hcHBlbmRDaGlsZChvbGRUZXh0Tm9kZS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgcGFyZW50LnJlcGxhY2VDaGlsZCh3cmFwRWxlbWVudCwgb2xkVGV4dE5vZGUpOwoKICAgIHZhciBib3VuZHMgPSB0cmFuc2Zvcm0gPyBVdGlsLk9mZnNldEJvdW5kcyh3cmFwRWxlbWVudCkgOiBVdGlsLkJvdW5kcyh3cmFwRWxlbWVudCk7CiAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGJhY2t1cFRleHQsIHdyYXBFbGVtZW50KTsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spIHsKICAgIHZhciBjdHggPSBzdGFjay5jdHgsCiAgICBjb2xvciA9IGdldENTUyhlbCwgImNvbG9yIiksCiAgICB0ZXh0RGVjb3JhdGlvbiA9IGdldENTUyhlbCwgInRleHREZWNvcmF0aW9uIiksCiAgICB0ZXh0QWxpZ24gPSBnZXRDU1MoZWwsICJ0ZXh0QWxpZ24iKSwKICAgIG1ldHJpY3MsCiAgICB0ZXh0TGlzdCwKICAgIHN0YXRlID0gewogICAgICBub2RlOiB0ZXh0Tm9kZSwKICAgICAgdGV4dE9mZnNldDogMAogICAgfTsKCiAgICBpZiAoVXRpbC50cmltVGV4dCh0ZXh0Tm9kZS5ub2RlVmFsdWUpLmxlbmd0aCA+IDApIHsKICAgICAgdGV4dE5vZGUubm9kZVZhbHVlID0gdGV4dFRyYW5zZm9ybSh0ZXh0Tm9kZS5ub2RlVmFsdWUsIGdldENTUyhlbCwgInRleHRUcmFuc2Zvcm0iKSk7CiAgICAgIHRleHRBbGlnbiA9IHRleHRBbGlnbi5yZXBsYWNlKFsiLXdlYmtpdC1hdXRvIl0sWyJhdXRvIl0pOwoKICAgICAgdGV4dExpc3QgPSAoIW9wdGlvbnMubGV0dGVyUmVuZGVyaW5nICYmIC9eKGxlZnR8cmlnaHR8anVzdGlmeXxhdXRvKSQvLnRlc3QodGV4dEFsaWduKSAmJiBub0xldHRlclNwYWNpbmcoZ2V0Q1NTKGVsLCAibGV0dGVyU3BhY2luZyIpKSkgPwogICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoLyhcYnwgKS8pCiAgICAgIDogdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KCIiKTsKCiAgICAgIG1ldHJpY3MgPSBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWwsIHRleHREZWNvcmF0aW9uLCBjb2xvcik7CgogICAgICBpZiAob3B0aW9ucy5jaGluZXNlKSB7CiAgICAgICAgdGV4dExpc3QuZm9yRWFjaChmdW5jdGlvbih3b3JkLCBpbmRleCkgewogICAgICAgICAgaWYgKC8uKltcdTRFMDAtXHU5RkE1XS4qJC8udGVzdCh3b3JkKSkgewogICAgICAgICAgICB3b3JkID0gd29yZC5zcGxpdCgiIik7CiAgICAgICAgICAgIHdvcmQudW5zaGlmdChpbmRleCwgMSk7CiAgICAgICAgICAgIHRleHRMaXN0LnNwbGljZS5hcHBseSh0ZXh0TGlzdCwgd29yZCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRleHRMaXN0LmZvckVhY2goZnVuY3Rpb24odGV4dCwgaW5kZXgpIHsKICAgICAgICB2YXIgYm91bmRzID0gZ2V0VGV4dEJvdW5kcyhzdGF0ZSwgdGV4dCwgdGV4dERlY29yYXRpb24sIChpbmRleCA8IHRleHRMaXN0Lmxlbmd0aCAtIDEpLCBzdGFjay50cmFuc2Zvcm0ubWF0cml4KTsKICAgICAgICBpZiAoYm91bmRzKSB7CiAgICAgICAgICBkcmF3VGV4dCh0ZXh0LCBib3VuZHMubGVmdCwgYm91bmRzLmJvdHRvbSwgY3R4KTsKICAgICAgICAgIHJlbmRlclRleHREZWNvcmF0aW9uKGN0eCwgdGV4dERlY29yYXRpb24sIGJvdW5kcywgbWV0cmljcywgY29sb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsaXN0UG9zaXRpb24gKGVsZW1lbnQsIHZhbCkgewogICAgdmFyIGJvdW5kRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm91bmRlbGVtZW50IiApLAogICAgb3JpZ2luYWxUeXBlLAogICAgYm91bmRzOwoKICAgIGJvdW5kRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImlubGluZSI7CgogICAgb3JpZ2luYWxUeXBlID0gZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlOwogICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gIm5vbmUiOwoKICAgIGJvdW5kRWxlbWVudC5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUodmFsKSk7CgogICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoYm91bmRFbGVtZW50LCBlbGVtZW50LmZpcnN0Q2hpbGQpOwoKICAgIGJvdW5kcyA9IFV0aWwuQm91bmRzKGJvdW5kRWxlbWVudCk7CiAgICBlbGVtZW50LnJlbW92ZUNoaWxkKGJvdW5kRWxlbWVudCk7CiAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSBvcmlnaW5hbFR5cGU7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gZWxlbWVudEluZGV4KGVsKSB7CiAgICB2YXIgaSA9IC0xLAogICAgY291bnQgPSAxLAogICAgY2hpbGRzID0gZWwucGFyZW50Tm9kZS5jaGlsZE5vZGVzOwoKICAgIGlmIChlbC5wYXJlbnROb2RlKSB7CiAgICAgIHdoaWxlKGNoaWxkc1srK2ldICE9PSBlbCkgewogICAgICAgIGlmIChjaGlsZHNbaV0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjb3VudDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxpc3RJdGVtVGV4dChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgY3VycmVudEluZGV4ID0gZWxlbWVudEluZGV4KGVsZW1lbnQpLCB0ZXh0OwogICAgc3dpdGNoKHR5cGUpewogICAgICBjYXNlICJkZWNpbWFsIjoKICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJkZWNpbWFsLWxlYWRpbmctemVybyI6CiAgICAgICAgdGV4dCA9IChjdXJyZW50SW5kZXgudG9TdHJpbmcoKS5sZW5ndGggPT09IDEpID8gY3VycmVudEluZGV4ID0gIjAiICsgY3VycmVudEluZGV4LnRvU3RyaW5nKCkgOiBjdXJyZW50SW5kZXgudG9TdHJpbmcoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBwZXItcm9tYW4iOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibG93ZXItcm9tYW4iOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsb3dlci1hbHBoYSI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInVwcGVyLWFscGhhIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIHRleHQgKyAiLiAiOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGVsQm91bmRzKSB7CiAgICB2YXIgeCwKICAgIHRleHQsCiAgICBjdHggPSBzdGFjay5jdHgsCiAgICB0eXBlID0gZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVUeXBlIiksCiAgICBsaXN0Qm91bmRzOwoKICAgIGlmICgvXihkZWNpbWFsfGRlY2ltYWwtbGVhZGluZy16ZXJvfHVwcGVyLWFscGhhfHVwcGVyLWxhdGlufHVwcGVyLXJvbWFufGxvd2VyLWFscGhhfGxvd2VyLWdyZWVrfGxvd2VyLWxhdGlufGxvd2VyLXJvbWFuKSQvaS50ZXN0KHR5cGUpKSB7CiAgICAgIHRleHQgPSBsaXN0SXRlbVRleHQoZWxlbWVudCwgdHlwZSk7CiAgICAgIGxpc3RCb3VuZHMgPSBsaXN0UG9zaXRpb24oZWxlbWVudCwgdGV4dCk7CiAgICAgIHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbGVtZW50LCAibm9uZSIsIGdldENTUyhlbGVtZW50LCAiY29sb3IiKSk7CgogICAgICBpZiAoZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVQb3NpdGlvbiIpID09PSAiaW5zaWRlIikgewogICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgImxlZnQiKTsKICAgICAgICB4ID0gZWxCb3VuZHMubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGRyYXdUZXh0KHRleHQsIHgsIGxpc3RCb3VuZHMuYm90dG9tLCBjdHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbG9hZEltYWdlIChzcmMpewogICAgdmFyIGltZyA9IGltYWdlc1tzcmNdOwogICAgcmV0dXJuIChpbWcgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdHJ1ZSkgPyBpbWcuaW1nIDogZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBjbGlwQm91bmRzKHNyYywgZHN0KXsKICAgIHZhciB4ID0gTWF0aC5tYXgoc3JjLmxlZnQsIGRzdC5sZWZ0KSwKICAgIHkgPSBNYXRoLm1heChzcmMudG9wLCBkc3QudG9wKSwKICAgIHgyID0gTWF0aC5taW4oKHNyYy5sZWZ0ICsgc3JjLndpZHRoKSwgKGRzdC5sZWZ0ICsgZHN0LndpZHRoKSksCiAgICB5MiA9IE1hdGgubWluKChzcmMudG9wICsgc3JjLmhlaWdodCksIChkc3QudG9wICsgZHN0LmhlaWdodCkpOwoKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6eCwKICAgICAgdG9wOnksCiAgICAgIHdpZHRoOngyLXgsCiAgICAgIGhlaWdodDp5Mi15CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2V0WihlbGVtZW50LCBzdGFjaywgcGFyZW50U3RhY2spewogICAgdmFyIG5ld0NvbnRleHQsCiAgICBpc1Bvc2l0aW9uZWQgPSBzdGFjay5jc3NQb3NpdGlvbiAhPT0gJ3N0YXRpYycsCiAgICB6SW5kZXggPSBpc1Bvc2l0aW9uZWQgPyBnZXRDU1MoZWxlbWVudCwgJ3pJbmRleCcpIDogJ2F1dG8nLAogICAgb3BhY2l0eSA9IGdldENTUyhlbGVtZW50LCAnb3BhY2l0eScpLAogICAgaXNGbG9hdGVkID0gZ2V0Q1NTKGVsZW1lbnQsICdjc3NGbG9hdCcpICE9PSAnbm9uZSc7CgogICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvR3VpZGUvQ1NTL1VuZGVyc3RhbmRpbmdfel9pbmRleC9UaGVfc3RhY2tpbmdfY29udGV4dAogICAgLy8gV2hlbiBhIG5ldyBzdGFja2luZyBjb250ZXh0IHNob3VsZCBiZSBjcmVhdGVkOgogICAgLy8gdGhlIHJvb3QgZWxlbWVudCAoSFRNTCksCiAgICAvLyBwb3NpdGlvbmVkIChhYnNvbHV0ZWx5IG9yIHJlbGF0aXZlbHkpIHdpdGggYSB6LWluZGV4IHZhbHVlIG90aGVyIHRoYW4gImF1dG8iLAogICAgLy8gZWxlbWVudHMgd2l0aCBhbiBvcGFjaXR5IHZhbHVlIGxlc3MgdGhhbiAxLiAoU2VlIHRoZSBzcGVjaWZpY2F0aW9uIGZvciBvcGFjaXR5KSwKICAgIC8vIG9uIG1vYmlsZSBXZWJLaXQgYW5kIENocm9tZSAyMissIHBvc2l0aW9uOiBmaXhlZCBhbHdheXMgY3JlYXRlcyBhIG5ldyBzdGFja2luZyBjb250ZXh0LCBldmVuIHdoZW4gei1pbmRleCBpcyAiYXV0byIgKFNlZSB0aGlzIHBvc3QpCgogICAgc3RhY2suekluZGV4ID0gbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KHpJbmRleCk7CiAgICBuZXdDb250ZXh0LmlzUG9zaXRpb25lZCA9IGlzUG9zaXRpb25lZDsKICAgIG5ld0NvbnRleHQuaXNGbG9hdGVkID0gaXNGbG9hdGVkOwogICAgbmV3Q29udGV4dC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgIG5ld0NvbnRleHQub3duU3RhY2tpbmcgPSAoekluZGV4ICE9PSAnYXV0bycgfHwgb3BhY2l0eSA8IDEpOwoKICAgIGlmIChwYXJlbnRTdGFjaykgewogICAgICBwYXJlbnRTdGFjay56SW5kZXguY2hpbGRyZW4ucHVzaChzdGFjayk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGltYWdlLCBib3VuZHMsIGJvcmRlcnMpIHsKCiAgICB2YXIgcGFkZGluZ0xlZnQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdMZWZ0JyksCiAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nVG9wJyksCiAgICBwYWRkaW5nUmlnaHQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdSaWdodCcpLAogICAgcGFkZGluZ0JvdHRvbSA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ0JvdHRvbScpOwoKICAgIGRyYXdJbWFnZSgKICAgICAgY3R4LAogICAgICBpbWFnZSwKICAgICAgMCwgLy9zeAogICAgICAwLCAvL3N5CiAgICAgIGltYWdlLndpZHRoLCAvL3N3CiAgICAgIGltYWdlLmhlaWdodCwgLy9zaAogICAgICBib3VuZHMubGVmdCArIHBhZGRpbmdMZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgLy9keAogICAgICBib3VuZHMudG9wICsgcGFkZGluZ1RvcCArIGJvcmRlcnNbMF0ud2lkdGgsIC8vIGR5CiAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdwogICAgICBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoICsgcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pIC8vZGgKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlckRhdGEoZWxlbWVudCkgewogICAgcmV0dXJuIFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il0ubWFwKGZ1bmN0aW9uKHNpZGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogZ2V0Q1NTSW50KGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdXaWR0aCcpLAogICAgICAgIGNvbG9yOiBnZXRDU1MoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ0NvbG9yJykKICAgICAgfTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyUmFkaXVzRGF0YShlbGVtZW50KSB7CiAgICByZXR1cm4gWyJUb3BMZWZ0IiwgIlRvcFJpZ2h0IiwgIkJvdHRvbVJpZ2h0IiwgIkJvdHRvbUxlZnQiXS5tYXAoZnVuY3Rpb24oc2lkZSkgewogICAgICByZXR1cm4gZ2V0Q1NTKGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdSYWRpdXMnKTsKICAgIH0pOwogIH0KCiAgdmFyIGdldEN1cnZlUG9pbnRzID0gKGZ1bmN0aW9uKGthcHBhKSB7CgogICAgcmV0dXJuIGZ1bmN0aW9uKHgsIHksIHIxLCByMikgewogICAgICB2YXIgb3ggPSAocjEpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IGhvcml6b250YWwKICAgICAgb3kgPSAocjIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IHZlcnRpY2FsCiAgICAgIHhtID0geCArIHIxLCAvLyB4LW1pZGRsZQogICAgICB5bSA9IHkgKyByMjsgLy8geS1taWRkbGUKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3BMZWZ0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgICB4OngsCiAgICAgICAgICB5OnltCiAgICAgICAgfSwgewogICAgICAgICAgeDp4LAogICAgICAgICAgeTp5bSAtIG95CiAgICAgICAgfSwgewogICAgICAgICAgeDp4bSAtIG94LAogICAgICAgICAgeTp5CiAgICAgICAgfSwgewogICAgICAgICAgeDp4bSwKICAgICAgICAgIHk6eQogICAgICAgIH0pLAogICAgICAgIHRvcFJpZ2h0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgICB4OngsCiAgICAgICAgICB5OnkKICAgICAgICB9LCB7CiAgICAgICAgICB4OnggKyBveCwKICAgICAgICAgIHk6eQogICAgICAgIH0sIHsKICAgICAgICAgIHg6eG0sCiAgICAgICAgICB5OnltIC0gb3kKICAgICAgICB9LCB7CiAgICAgICAgICB4OnhtLAogICAgICAgICAgeTp5bQogICAgICAgIH0pLAogICAgICAgIGJvdHRvbVJpZ2h0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgICB4OnhtLAogICAgICAgICAgeTp5CiAgICAgICAgfSwgewogICAgICAgICAgeDp4bSwKICAgICAgICAgIHk6eSArIG95CiAgICAgICAgfSwgewogICAgICAgICAgeDp4ICsgb3gsCiAgICAgICAgICB5OnltCiAgICAgICAgfSwgewogICAgICAgICAgeDp4LAogICAgICAgICAgeTp5bQogICAgICAgIH0pLAogICAgICAgIGJvdHRvbUxlZnQ6IGJlemllckN1cnZlKHsKICAgICAgICAgIHg6eG0sCiAgICAgICAgICB5OnltCiAgICAgICAgfSwgewogICAgICAgICAgeDp4bSAtIG94LAogICAgICAgICAgeTp5bQogICAgICAgIH0sIHsKICAgICAgICAgIHg6eCwKICAgICAgICAgIHk6eSArIG95CiAgICAgICAgfSwgewogICAgICAgICAgeDp4LAogICAgICAgICAgeTp5CiAgICAgICAgfSkKICAgICAgfTsKICAgIH07CiAgfSkoNCAqICgoTWF0aC5zcXJ0KDIpIC0gMSkgLyAzKSk7CgogIGZ1bmN0aW9uIGJlemllckN1cnZlKHN0YXJ0LCBzdGFydENvbnRyb2wsIGVuZENvbnRyb2wsIGVuZCkgewoKICAgIHZhciBsZXJwID0gZnVuY3Rpb24gKGEsIGIsIHQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OmEueCArIChiLnggLSBhLngpICogdCwKICAgICAgICB5OmEueSArIChiLnkgLSBhLnkpICogdAogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBzdGFydDogc3RhcnQsCiAgICAgIHN0YXJ0Q29udHJvbDogc3RhcnRDb250cm9sLAogICAgICBlbmRDb250cm9sOiBlbmRDb250cm9sLAogICAgICBlbmQ6IGVuZCwKICAgICAgc3ViZGl2aWRlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgdmFyIGFiID0gbGVycChzdGFydCwgc3RhcnRDb250cm9sLCB0KSwKICAgICAgICBiYyA9IGxlcnAoc3RhcnRDb250cm9sLCBlbmRDb250cm9sLCB0KSwKICAgICAgICBjZCA9IGxlcnAoZW5kQ29udHJvbCwgZW5kLCB0KSwKICAgICAgICBhYmJjID0gbGVycChhYiwgYmMsIHQpLAogICAgICAgIGJjY2QgPSBsZXJwKGJjLCBjZCwgdCksCiAgICAgICAgZGVzdCA9IGxlcnAoYWJiYywgYmNjZCwgdCk7CiAgICAgICAgcmV0dXJuIFtiZXppZXJDdXJ2ZShzdGFydCwgYWIsIGFiYmMsIGRlc3QpLCBiZXppZXJDdXJ2ZShkZXN0LCBiY2NkLCBjZCwgZW5kKV07CiAgICAgIH0sCiAgICAgIGN1cnZlVG86IGZ1bmN0aW9uKGJvcmRlckFyZ3MpIHsKICAgICAgICBib3JkZXJBcmdzLnB1c2goWyJiZXppZXJDdXJ2ZSIsIHN0YXJ0Q29udHJvbC54LCBzdGFydENvbnRyb2wueSwgZW5kQ29udHJvbC54LCBlbmRDb250cm9sLnksIGVuZC54LCBlbmQueV0pOwogICAgICB9LAogICAgICBjdXJ2ZVRvUmV2ZXJzZWQ6IGZ1bmN0aW9uKGJvcmRlckFyZ3MpIHsKICAgICAgICBib3JkZXJBcmdzLnB1c2goWyJiZXppZXJDdXJ2ZSIsIGVuZENvbnRyb2wueCwgZW5kQ29udHJvbC55LCBzdGFydENvbnRyb2wueCwgc3RhcnRDb250cm9sLnksIHN0YXJ0LngsIHN0YXJ0LnldKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1czEsIHJhZGl1czIsIGNvcm5lcjEsIGNvcm5lcjIsIHgsIHkpIHsKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgY29ybmVyMVswXS5zdGFydC54LCBjb3JuZXIxWzBdLnN0YXJ0LnldKTsKICAgICAgY29ybmVyMVswXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgICBjb3JuZXIxWzFdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgeCwgeV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMyWzBdID4gMCB8fCByYWRpdXMyWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgY29ybmVyMlswXS5zdGFydC54LCBjb3JuZXIyWzBdLnN0YXJ0LnldKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRyYXdTaWRlKGJvcmRlckRhdGEsIHJhZGl1czEsIHJhZGl1czIsIG91dGVyMSwgaW5uZXIxLCBvdXRlcjIsIGlubmVyMikgewogICAgdmFyIGJvcmRlckFyZ3MgPSBbXTsKCiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIG91dGVyMVsxXS5zdGFydC54LCBvdXRlcjFbMV0uc3RhcnQueV0pOwogICAgICBvdXRlcjFbMV0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jMVswXSwgYm9yZGVyRGF0YS5jMVsxXV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMyWzBdID4gMCB8fCByYWRpdXMyWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgb3V0ZXIyWzBdLnN0YXJ0LngsIG91dGVyMlswXS5zdGFydC55XSk7CiAgICAgIG91dGVyMlswXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgaW5uZXIyWzBdLmVuZC54LCBpbm5lcjJbMF0uZW5kLnldKTsKICAgICAgaW5uZXIyWzBdLmN1cnZlVG9SZXZlcnNlZChib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jMlswXSwgYm9yZGVyRGF0YS5jMlsxXV0pOwogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzNbMF0sIGJvcmRlckRhdGEuYzNbMV1dKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGlubmVyMVsxXS5lbmQueCwgaW5uZXIxWzFdLmVuZC55XSk7CiAgICAgIGlubmVyMVsxXS5jdXJ2ZVRvUmV2ZXJzZWQoYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzRbMF0sIGJvcmRlckRhdGEuYzRbMV1dKTsKICAgIH0KCiAgICByZXR1cm4gYm9yZGVyQXJnczsKICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZUN1cnZlUG9pbnRzKGJvdW5kcywgYm9yZGVyUmFkaXVzLCBib3JkZXJzKSB7CgogICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgIHkgPSBib3VuZHMudG9wLAogICAgd2lkdGggPSBib3VuZHMud2lkdGgsCiAgICBoZWlnaHQgPSBib3VuZHMuaGVpZ2h0LAoKICAgIHRsaCA9IGJvcmRlclJhZGl1c1swXVswXSwKICAgIHRsdiA9IGJvcmRlclJhZGl1c1swXVsxXSwKICAgIHRyaCA9IGJvcmRlclJhZGl1c1sxXVswXSwKICAgIHRydiA9IGJvcmRlclJhZGl1c1sxXVsxXSwKICAgIGJyaCA9IGJvcmRlclJhZGl1c1syXVswXSwKICAgIGJydiA9IGJvcmRlclJhZGl1c1syXVsxXSwKICAgIGJsaCA9IGJvcmRlclJhZGl1c1szXVswXSwKICAgIGJsdiA9IGJvcmRlclJhZGl1c1szXVsxXSwKCiAgICB0b3BXaWR0aCA9IHdpZHRoIC0gdHJoLAogICAgcmlnaHRIZWlnaHQgPSBoZWlnaHQgLSBicnYsCiAgICBib3R0b21XaWR0aCA9IHdpZHRoIC0gYnJoLAogICAgbGVmdEhlaWdodCA9IGhlaWdodCAtIGJsdjsKCiAgICByZXR1cm4gewogICAgICB0b3BMZWZ0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHgsCiAgICAgICAgeSwKICAgICAgICB0bGgsCiAgICAgICAgdGx2CiAgICAgICAgKS50b3BMZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wTGVmdElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB5ICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgICBNYXRoLm1heCgwLCB0bGggLSBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCB0bHYgLSBib3JkZXJzWzBdLndpZHRoKQogICAgICAgICkudG9wTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcFJpZ2h0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyB0b3BXaWR0aCwKICAgICAgICB5LAogICAgICAgIHRyaCwKICAgICAgICB0cnYKICAgICAgICApLnRvcFJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wUmlnaHRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIE1hdGgubWluKHRvcFdpZHRoLCB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIHkgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICAgICh0b3BXaWR0aCA+IHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCkgPyAwIDp0cmggLSBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHRydiAtIGJvcmRlcnNbMF0ud2lkdGgKICAgICAgICApLnRvcFJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tUmlnaHRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvdHRvbVdpZHRoLAogICAgICAgIHkgKyByaWdodEhlaWdodCwKICAgICAgICBicmgsCiAgICAgICAgYnJ2CiAgICAgICAgKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbVJpZ2h0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBNYXRoLm1pbihib3R0b21XaWR0aCwgd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICB5ICsgTWF0aC5taW4ocmlnaHRIZWlnaHQsIGhlaWdodCArIGJvcmRlcnNbMF0ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJyaCAtIGJvcmRlcnNbMV0ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJydiAtIGJvcmRlcnNbMl0ud2lkdGgpCiAgICAgICAgKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbUxlZnRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCwKICAgICAgICB5ICsgbGVmdEhlaWdodCwKICAgICAgICBibGgsCiAgICAgICAgYmx2CiAgICAgICAgKS5ib3R0b21MZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tTGVmdElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB5ICsgbGVmdEhlaWdodCwKICAgICAgICBNYXRoLm1heCgwLCBibGggLSBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBibHYgLSBib3JkZXJzWzJdLndpZHRoKQogICAgICAgICkuYm90dG9tTGVmdC5zdWJkaXZpZGUoMC41KQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlckNsaXAoZWxlbWVudCwgYm9yZGVyUG9pbnRzLCBib3JkZXJzLCByYWRpdXMsIGJvdW5kcykgewogICAgdmFyIGJhY2tncm91bmRDbGlwID0gZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kQ2xpcCcpLAogICAgYm9yZGVyQXJncyA9IFtdOwoKICAgIHN3aXRjaChiYWNrZ3JvdW5kQ2xpcCkgewogICAgICBjYXNlICJjb250ZW50LWJveCI6CiAgICAgIGNhc2UgInBhZGRpbmctYm94IjoKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMF0sIHJhZGl1c1sxXSwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgYm91bmRzLnRvcCArIGJvcmRlcnNbMF0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1sxXSwgcmFkaXVzWzJdLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoIC0gYm9yZGVyc1sxXS53aWR0aCwgYm91bmRzLnRvcCArIGJvcmRlcnNbMF0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1syXSwgcmFkaXVzWzNdLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGggLSBib3JkZXJzWzFdLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCAtIGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1szXSwgcmFkaXVzWzBdLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3VuZHMubGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0IC0gYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1swXSwgcmFkaXVzWzFdLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3ApOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1sxXSwgcmFkaXVzWzJdLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoLCBib3VuZHMudG9wKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMl0sIHJhZGl1c1szXSwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzNdLCByYWRpdXNbMF0sIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckFyZ3M7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUJvcmRlcnMoZWxlbWVudCwgYm91bmRzLCBib3JkZXJzKXsKICAgIHZhciB4ID0gYm91bmRzLmxlZnQsCiAgICB5ID0gYm91bmRzLnRvcCwKICAgIHdpZHRoID0gYm91bmRzLndpZHRoLAogICAgaGVpZ2h0ID0gYm91bmRzLmhlaWdodCwKICAgIGJvcmRlclNpZGUsCiAgICBieCwKICAgIGJ5LAogICAgYncsCiAgICBiaCwKICAgIGJvcmRlckFyZ3MsCiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLWJhY2tncm91bmQvI3RoZS1ib3JkZXItcmFkaXVzCiAgICBib3JkZXJSYWRpdXMgPSBnZXRCb3JkZXJSYWRpdXNEYXRhKGVsZW1lbnQpLAogICAgYm9yZGVyUG9pbnRzID0gY2FsY3VsYXRlQ3VydmVQb2ludHMoYm91bmRzLCBib3JkZXJSYWRpdXMsIGJvcmRlcnMpLAogICAgYm9yZGVyRGF0YSA9IHsKICAgICAgY2xpcDogZ2V0Qm9yZGVyQ2xpcChlbGVtZW50LCBib3JkZXJQb2ludHMsIGJvcmRlcnMsIGJvcmRlclJhZGl1cywgYm91bmRzKSwKICAgICAgYm9yZGVyczogW10KICAgIH07CgogICAgZm9yIChib3JkZXJTaWRlID0gMDsgYm9yZGVyU2lkZSA8IDQ7IGJvcmRlclNpZGUrKykgewoKICAgICAgaWYgKGJvcmRlcnNbYm9yZGVyU2lkZV0ud2lkdGggPiAwKSB7CiAgICAgICAgYnggPSB4OwogICAgICAgIGJ5ID0geTsKICAgICAgICBidyA9IHdpZHRoOwogICAgICAgIGJoID0gaGVpZ2h0IC0gKGJvcmRlcnNbMl0ud2lkdGgpOwoKICAgICAgICBzd2l0Y2goYm9yZGVyU2lkZSkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAvLyB0b3AgYm9yZGVyCiAgICAgICAgICAgIGJoID0gYm9yZGVyc1swXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCwgYnldLAogICAgICAgICAgICAgIGMyOiBbYnggKyBidywgYnldLAogICAgICAgICAgICAgIGMzOiBbYnggKyBidyAtIGJvcmRlcnNbMV0ud2lkdGgsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGM0OiBbYnggKyBib3JkZXJzWzNdLndpZHRoLCBieSArIGJoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMF0sIGJvcmRlclJhZGl1c1sxXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIC8vIHJpZ2h0IGJvcmRlcgogICAgICAgICAgICBieCA9IHggKyB3aWR0aCAtIChib3JkZXJzWzFdLndpZHRoKTsKICAgICAgICAgICAgYncgPSBib3JkZXJzWzFdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4ICsgYncsIGJ5XSwKICAgICAgICAgICAgICBjMjogW2J4ICsgYncsIGJ5ICsgYmggKyBib3JkZXJzWzJdLndpZHRoXSwKICAgICAgICAgICAgICBjMzogW2J4LCBieSArIGJoXSwKICAgICAgICAgICAgICBjNDogW2J4LCBieSArIGJvcmRlcnNbMF0ud2lkdGhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1sxXSwgYm9yZGVyUmFkaXVzWzJdLAogICAgICAgICAgICBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAvLyBib3R0b20gYm9yZGVyCiAgICAgICAgICAgIGJ5ID0gKGJ5ICsgaGVpZ2h0KSAtIChib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICAgICAgYmggPSBib3JkZXJzWzJdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4ICsgYncsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGMyOiBbYngsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGMzOiBbYnggKyBib3JkZXJzWzNdLndpZHRoLCBieV0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJ3IC0gYm9yZGVyc1szXS53aWR0aCwgYnldCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1syXSwgYm9yZGVyUmFkaXVzWzNdLAogICAgICAgICAgICBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgLy8gbGVmdCBib3JkZXIKICAgICAgICAgICAgYncgPSBib3JkZXJzWzNdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4LCBieSArIGJoICsgYm9yZGVyc1syXS53aWR0aF0sCiAgICAgICAgICAgICAgYzI6IFtieCwgYnldLAogICAgICAgICAgICAgIGMzOiBbYnggKyBidywgYnkgKyBib3JkZXJzWzBdLndpZHRoXSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYncsIGJ5ICsgYmhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1szXSwgYm9yZGVyUmFkaXVzWzBdLAogICAgICAgICAgICBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBib3JkZXJEYXRhLmJvcmRlcnMucHVzaCh7CiAgICAgICAgICBhcmdzOiBib3JkZXJBcmdzLAogICAgICAgICAgY29sb3I6IGJvcmRlcnNbYm9yZGVyU2lkZV0uY29sb3IKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYm9yZGVyRGF0YTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVNoYXBlKGN0eCwgYXJncykgewogICAgdmFyIHNoYXBlID0gY3R4LmRyYXdTaGFwZSgpOwogICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uKGJvcmRlciwgaW5kZXgpIHsKICAgICAgc2hhcGVbKGluZGV4ID09PSAwKSA/ICJtb3ZlVG8iIDogYm9yZGVyWzBdICsgIlRvIiBdLmFwcGx5KG51bGwsIGJvcmRlci5zbGljZSgxKSk7CiAgICB9KTsKICAgIHJldHVybiBzaGFwZTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJvcmRlcnMoY3R4LCBib3JkZXJBcmdzLCBjb2xvcikgewogICAgaWYgKGNvbG9yICE9PSAidHJhbnNwYXJlbnQiKSB7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSggImZpbGxTdHlsZSIsIGNvbG9yKTsKICAgICAgY3JlYXRlU2hhcGUoY3R4LCBib3JkZXJBcmdzKTsKICAgICAgY3R4LmZpbGwoKTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJGb3JtVmFsdWUgKGVsLCBib3VuZHMsIHN0YWNrKXsKCiAgICB2YXIgdmFsdWVXcmFwID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3ZhbHVld3JhcCcpLAogICAgY3NzUHJvcGVydHlBcnJheSA9IFsnbGluZUhlaWdodCcsJ3RleHRBbGlnbicsJ2ZvbnRGYW1pbHknLCdjb2xvcicsJ2ZvbnRTaXplJywncGFkZGluZ0xlZnQnLCdwYWRkaW5nVG9wJywnd2lkdGgnLCdoZWlnaHQnLCdib3JkZXInLCdib3JkZXJMZWZ0V2lkdGgnLCdib3JkZXJUb3BXaWR0aCddLAogICAgdGV4dFZhbHVlLAogICAgdGV4dE5vZGU7CgogICAgY3NzUHJvcGVydHlBcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHByb3BlcnR5KSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFsdWVXcmFwLnN0eWxlW3Byb3BlcnR5XSA9IGdldENTUyhlbCwgcHJvcGVydHkpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAvLyBPbGRlciBJRSBoYXMgaXNzdWVzIHdpdGggImJvcmRlciIKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIiArIGUubWVzc2FnZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJDb2xvciA9ICJibGFjayI7CiAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyU3R5bGUgPSAic29saWQiOwogICAgdmFsdWVXcmFwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgdmFsdWVXcmFwLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKCiAgICBpZiAoL14oc3VibWl0fHJlc2V0fGJ1dHRvbnx0ZXh0fHBhc3N3b3JkKSQvLnRlc3QoZWwudHlwZSkgfHwgZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKXsKICAgICAgdmFsdWVXcmFwLnN0eWxlLmxpbmVIZWlnaHQgPSBnZXRDU1MoZWwsICJoZWlnaHQiKTsKICAgIH0KCiAgICB2YWx1ZVdyYXAuc3R5bGUudG9wID0gYm91bmRzLnRvcCArICJweCI7CiAgICB2YWx1ZVdyYXAuc3R5bGUubGVmdCA9IGJvdW5kcy5sZWZ0ICsgInB4IjsKCiAgICB0ZXh0VmFsdWUgPSAoZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKSA/IChlbC5vcHRpb25zW2VsLnNlbGVjdGVkSW5kZXhdIHx8IDApLnRleHQgOiBlbC52YWx1ZTsKICAgIGlmKCF0ZXh0VmFsdWUpIHsKICAgICAgdGV4dFZhbHVlID0gZWwucGxhY2Vob2xkZXI7CiAgICB9CgogICAgdGV4dE5vZGUgPSBkb2MuY3JlYXRlVGV4dE5vZGUodGV4dFZhbHVlKTsKCiAgICB2YWx1ZVdyYXAuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgYm9keS5hcHBlbmRDaGlsZCh2YWx1ZVdyYXApOwoKICAgIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjayk7CiAgICBib2R5LnJlbW92ZUNoaWxkKHZhbHVlV3JhcCk7CiAgfQoKICBmdW5jdGlvbiBkcmF3SW1hZ2UgKGN0eCkgewogICAgY3R4LmRyYXdJbWFnZS5hcHBseShjdHgsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgbnVtRHJhd3MrPTE7CiAgfQoKICBmdW5jdGlvbiBnZXRQc2V1ZG9FbGVtZW50KGVsLCB3aGljaCkgewogICAgdmFyIGVsU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgd2hpY2gpOwogICAgaWYoIWVsU3R5bGUgfHwgIWVsU3R5bGUuY29udGVudCB8fCBlbFN0eWxlLmNvbnRlbnQgPT09ICJub25lIiB8fCBlbFN0eWxlLmNvbnRlbnQgPT09ICItbW96LWFsdC1jb250ZW50IiB8fCBlbFN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29udGVudCA9IGVsU3R5bGUuY29udGVudCArICcnLAogICAgZmlyc3QgPSBjb250ZW50LnN1YnN0ciggMCwgMSApOwogICAgLy9zdHJpcHMgcXVvdGVzCiAgICBpZihmaXJzdCA9PT0gY29udGVudC5zdWJzdHIoIGNvbnRlbnQubGVuZ3RoIC0gMSApICYmIGZpcnN0Lm1hdGNoKC8nfCIvKSkgewogICAgICBjb250ZW50ID0gY29udGVudC5zdWJzdHIoIDEsIGNvbnRlbnQubGVuZ3RoIC0gMiApOwogICAgfQoKICAgIHZhciBpc0ltYWdlID0gY29udGVudC5zdWJzdHIoIDAsIDMgKSA9PT0gJ3VybCcsCiAgICBlbHBzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggaXNJbWFnZSA/ICdpbWcnIDogJ3NwYW4nICk7CgogICAgZWxwcy5jbGFzc05hbWUgPSBwc2V1ZG9IaWRlICsgIi1iZWZvcmUgIiArIHBzZXVkb0hpZGUgKyAiLWFmdGVyIjsKCiAgICBPYmplY3Qua2V5cyhlbFN0eWxlKS5maWx0ZXIoaW5kZXhlZFByb3BlcnR5KS5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgLy8gUHJldmVudCBhc3NpZ25pbmcgb2YgcmVhZCBvbmx5IENTUyBSdWxlcywgZXguIGxlbmd0aCwgcGFyZW50UnVsZQogICAgICB0cnkgewogICAgICAgIGVscHMuc3R5bGVbcHJvcF0gPSBlbFN0eWxlW3Byb3BdOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgVXRpbC5sb2coWydUcmllZCB0byBhc3NpZ24gcmVhZG9ubHkgcHJvcGVydHkgJywgcHJvcCwgJ0Vycm9yOicsIGVdKTsKICAgICAgfQogICAgfSk7CgogICAgaWYoaXNJbWFnZSkgewogICAgICBlbHBzLnNyYyA9IFV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoY29udGVudClbMF0uYXJnc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIGVscHMuaW5uZXJIVE1MID0gY29udGVudDsKICAgIH0KICAgIHJldHVybiBlbHBzOwogIH0KCiAgZnVuY3Rpb24gaW5kZXhlZFByb3BlcnR5KHByb3BlcnR5KSB7CiAgICByZXR1cm4gKGlzTmFOKHdpbmRvdy5wYXJzZUludChwcm9wZXJ0eSwgMTApKSk7CiAgfQoKICBmdW5jdGlvbiBpbmplY3RQc2V1ZG9FbGVtZW50cyhlbCwgc3RhY2spIHsKICAgIHZhciBiZWZvcmUgPSBnZXRQc2V1ZG9FbGVtZW50KGVsLCAnOmJlZm9yZScpLAogICAgYWZ0ZXIgPSBnZXRQc2V1ZG9FbGVtZW50KGVsLCAnOmFmdGVyJyk7CiAgICBpZighYmVmb3JlICYmICFhZnRlcikgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYoYmVmb3JlKSB7CiAgICAgIGVsLmNsYXNzTmFtZSArPSAiICIgKyBwc2V1ZG9IaWRlICsgIi1iZWZvcmUiOwogICAgICBlbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShiZWZvcmUsIGVsKTsKICAgICAgcGFyc2VFbGVtZW50KGJlZm9yZSwgc3RhY2ssIHRydWUpOwogICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGJlZm9yZSk7CiAgICAgIGVsLmNsYXNzTmFtZSA9IGVsLmNsYXNzTmFtZS5yZXBsYWNlKHBzZXVkb0hpZGUgKyAiLWJlZm9yZSIsICIiKS50cmltKCk7CiAgICB9CgogICAgaWYgKGFmdGVyKSB7CiAgICAgIGVsLmNsYXNzTmFtZSArPSAiICIgKyBwc2V1ZG9IaWRlICsgIi1hZnRlciI7CiAgICAgIGVsLmFwcGVuZENoaWxkKGFmdGVyKTsKICAgICAgcGFyc2VFbGVtZW50KGFmdGVyLCBzdGFjaywgdHJ1ZSk7CiAgICAgIGVsLnJlbW92ZUNoaWxkKGFmdGVyKTsKICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lLnJlcGxhY2UocHNldWRvSGlkZSArICItYWZ0ZXIiLCAiIikudHJpbSgpOwogICAgfQoKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpIHsKICAgIHZhciBvZmZzZXRYID0gTWF0aC5yb3VuZChib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0KSwKICAgIG9mZnNldFkgPSBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wKTsKCiAgICBjdHguY3JlYXRlUGF0dGVybihpbWFnZSk7CiAgICBjdHgudHJhbnNsYXRlKG9mZnNldFgsIG9mZnNldFkpOwogICAgY3R4LmZpbGwoKTsKICAgIGN0eC50cmFuc2xhdGUoLW9mZnNldFgsIC1vZmZzZXRZKTsKICB9CgogIGZ1bmN0aW9uIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICB2YXIgYXJncyA9IFtdOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCksIE1hdGgucm91bmQodG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCArIHdpZHRoKSwgTWF0aC5yb3VuZCh0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0ICsgd2lkdGgpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGNyZWF0ZVNoYXBlKGN0eCwgYXJncyk7CiAgICBjdHguc2F2ZSgpOwogICAgY3R4LmNsaXAoKTsKICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpOwogICAgY3R4LnJlc3RvcmUoKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRDb2xvcihjdHgsIGJhY2tncm91bmRCb3VuZHMsIGJnY29sb3IpIHsKICAgIHJlbmRlclJlY3QoCiAgICAgIGN0eCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5sZWZ0LAogICAgICBiYWNrZ3JvdW5kQm91bmRzLnRvcCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy53aWR0aCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5oZWlnaHQsCiAgICAgIGJnY29sb3IKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcoZWwsIGJvdW5kcywgY3R4LCBpbWFnZSwgaW1hZ2VJbmRleCkgewogICAgdmFyIGJhY2tncm91bmRTaXplID0gVXRpbC5CYWNrZ3JvdW5kU2l6ZShlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCksCiAgICBiYWNrZ3JvdW5kUG9zaXRpb24gPSBVdGlsLkJhY2tncm91bmRQb3NpdGlvbihlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCwgYmFja2dyb3VuZFNpemUpLAogICAgYmFja2dyb3VuZFJlcGVhdCA9IGdldENTUyhlbCwgImJhY2tncm91bmRSZXBlYXQiKS5zcGxpdCgiLCIpLm1hcChVdGlsLnRyaW1UZXh0KTsKCiAgICBpbWFnZSA9IHJlc2l6ZUltYWdlKGltYWdlLCBiYWNrZ3JvdW5kU2l6ZSk7CgogICAgYmFja2dyb3VuZFJlcGVhdCA9IGJhY2tncm91bmRSZXBlYXRbaW1hZ2VJbmRleF0gfHwgYmFja2dyb3VuZFJlcGVhdFswXTsKCiAgICBzd2l0Y2ggKGJhY2tncm91bmRSZXBlYXQpIHsKICAgICAgY2FzZSAicmVwZWF0LXgiOgogICAgICAgIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywKICAgICAgICAgIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgOTk5OTksIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJyZXBlYXQteSI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCwgYm91bmRzLnRvcCwgaW1hZ2Uud2lkdGgsIDk5OTk5KTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgIm5vLXJlcGVhdCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCwgYm91bmRzLnRvcCArIGJhY2tncm91bmRQb3NpdGlvbi50b3AsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0KGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgewogICAgICAgICAgdG9wOiBib3VuZHMudG9wLAogICAgICAgICAgbGVmdDogYm91bmRzLmxlZnQsCiAgICAgICAgICB3aWR0aDogaW1hZ2Uud2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IGltYWdlLmhlaWdodAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZEltYWdlKGVsZW1lbnQsIGJvdW5kcywgY3R4KSB7CiAgICB2YXIgYmFja2dyb3VuZEltYWdlID0gZ2V0Q1NTKGVsZW1lbnQsICJiYWNrZ3JvdW5kSW1hZ2UiKSwKICAgIGJhY2tncm91bmRJbWFnZXMgPSBVdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRJbWFnZSksCiAgICBpbWFnZSwKICAgIGltYWdlSW5kZXggPSBiYWNrZ3JvdW5kSW1hZ2VzLmxlbmd0aDsKCiAgICB3aGlsZShpbWFnZUluZGV4LS0pIHsKICAgICAgYmFja2dyb3VuZEltYWdlID0gYmFja2dyb3VuZEltYWdlc1tpbWFnZUluZGV4XTsKCiAgICAgIGlmICghYmFja2dyb3VuZEltYWdlLmFyZ3MgfHwgYmFja2dyb3VuZEltYWdlLmFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBrZXkgPSBiYWNrZ3JvdW5kSW1hZ2UubWV0aG9kID09PSAndXJsJyA/CiAgICAgIGJhY2tncm91bmRJbWFnZS5hcmdzWzBdIDoKICAgICAgYmFja2dyb3VuZEltYWdlLnZhbHVlOwoKICAgICAgaW1hZ2UgPSBsb2FkSW1hZ2Uoa2V5KTsKCiAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGJhY2tncm91bmQtb3JpZ2luCiAgICAgIGlmIChpbWFnZSkgewogICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcoZWxlbWVudCwgYm91bmRzLCBjdHgsIGltYWdlLCBpbWFnZUluZGV4KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgYmFja2dyb3VuZDoiLCBiYWNrZ3JvdW5kSW1hZ2UpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZXNpemVJbWFnZShpbWFnZSwgYm91bmRzKSB7CiAgICBpZihpbWFnZS53aWR0aCA9PT0gYm91bmRzLndpZHRoICYmIGltYWdlLmhlaWdodCA9PT0gYm91bmRzLmhlaWdodCkgewogICAgICByZXR1cm4gaW1hZ2U7CiAgICB9CgogICAgdmFyIGN0eCwgY2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIGRyYXdJbWFnZShjdHgsIGltYWdlLCAwLCAwLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgIHJldHVybiBjYW52YXM7CiAgfQoKICBmdW5jdGlvbiBzZXRPcGFjaXR5KGN0eCwgZWxlbWVudCwgcGFyZW50U3RhY2spIHsKICAgIHJldHVybiBjdHguc2V0VmFyaWFibGUoImdsb2JhbEFscGhhIiwgZ2V0Q1NTKGVsZW1lbnQsICJvcGFjaXR5IikgKiAoKHBhcmVudFN0YWNrKSA/IHBhcmVudFN0YWNrLm9wYWNpdHkgOiAxKSk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVQeChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgicHgiLCAiIik7CiAgfQoKICB2YXIgdHJhbnNmb3JtUmVnRXhwID0gLyhtYXRyaXgpXCgoLispXCkvOwoKICBmdW5jdGlvbiBnZXRUcmFuc2Zvcm0oZWxlbWVudCwgcGFyZW50U3RhY2spIHsKICAgIHZhciB0cmFuc2Zvcm0gPSBnZXRDU1MoZWxlbWVudCwgInRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLXdlYmtpdC10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tb3otdHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbXMtdHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItby10cmFuc2Zvcm0iKTsKICAgIHZhciB0cmFuc2Zvcm1PcmlnaW4gPSBnZXRDU1MoZWxlbWVudCwgInRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi13ZWJraXQtdHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1vei10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbXMtdHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLW8tdHJhbnNmb3JtLW9yaWdpbiIpIHx8ICIwcHggMHB4IjsKCiAgICB0cmFuc2Zvcm1PcmlnaW4gPSB0cmFuc2Zvcm1PcmlnaW4uc3BsaXQoIiAiKS5tYXAocmVtb3ZlUHgpLm1hcChVdGlsLmFzRmxvYXQpOwoKICAgIHZhciBtYXRyaXg7CiAgICBpZiAodHJhbnNmb3JtICYmIHRyYW5zZm9ybSAhPT0gIm5vbmUiKSB7CiAgICAgIHZhciBtYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCh0cmFuc2Zvcm1SZWdFeHApOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBzd2l0Y2gobWF0Y2hbMV0pIHsKICAgICAgICAgIGNhc2UgIm1hdHJpeCI6CiAgICAgICAgICAgIG1hdHJpeCA9IG1hdGNoWzJdLnNwbGl0KCIsIikubWFwKFV0aWwudHJpbVRleHQpLm1hcChVdGlsLmFzRmxvYXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBvcmlnaW46IHRyYW5zZm9ybU9yaWdpbiwKICAgICAgbWF0cml4OiBtYXRyaXgKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTdGFjayhlbGVtZW50LCBwYXJlbnRTdGFjaywgYm91bmRzLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBjdHggPSBoMmNSZW5kZXJDb250ZXh0KCghcGFyZW50U3RhY2spID8gZG9jdW1lbnRXaWR0aCgpIDogYm91bmRzLndpZHRoICwgKCFwYXJlbnRTdGFjaykgPyBkb2N1bWVudEhlaWdodCgpIDogYm91bmRzLmhlaWdodCksCiAgICBzdGFjayA9IHsKICAgICAgY3R4OiBjdHgsCiAgICAgIG9wYWNpdHk6IHNldE9wYWNpdHkoY3R4LCBlbGVtZW50LCBwYXJlbnRTdGFjayksCiAgICAgIGNzc1Bvc2l0aW9uOiBnZXRDU1MoZWxlbWVudCwgInBvc2l0aW9uIiksCiAgICAgIGJvcmRlcnM6IGdldEJvcmRlckRhdGEoZWxlbWVudCksCiAgICAgIHRyYW5zZm9ybTogdHJhbnNmb3JtLAogICAgICBjbGlwOiAocGFyZW50U3RhY2sgJiYgcGFyZW50U3RhY2suY2xpcCkgPyBVdGlsLkV4dGVuZCgge30sIHBhcmVudFN0YWNrLmNsaXAgKSA6IG51bGwKICAgIH07CgogICAgc2V0WihlbGVtZW50LCBzdGFjaywgcGFyZW50U3RhY2spOwoKICAgIC8vIFRPRE8gY29ycmVjdCBvdmVyZmxvdyBmb3IgYWJzb2x1dGUgY29udGVudCByZXNpZGluZyB1bmRlciBhIHN0YXRpYyBwb3NpdGlvbgogICAgaWYgKG9wdGlvbnMudXNlT3ZlcmZsb3cgPT09IHRydWUgJiYgLyhoaWRkZW58c2Nyb2xsfGF1dG8pLy50ZXN0KGdldENTUyhlbGVtZW50LCAib3ZlcmZsb3ciKSkgPT09IHRydWUgJiYgLyhCT0RZKS9pLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkgPT09IGZhbHNlKXsKICAgICAgc3RhY2suY2xpcCA9IChzdGFjay5jbGlwKSA/IGNsaXBCb3VuZHMoc3RhY2suY2xpcCwgYm91bmRzKSA6IGJvdW5kczsKICAgIH0KCiAgICByZXR1cm4gc3RhY2s7CiAgfQoKICBmdW5jdGlvbiBnZXRCYWNrZ3JvdW5kQm91bmRzKGJvcmRlcnMsIGJvdW5kcywgY2xpcCkgewogICAgdmFyIGJhY2tncm91bmRCb3VuZHMgPSB7CiAgICAgIGxlZnQ6IGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgdG9wOiBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgd2lkdGg6IGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgIGhlaWdodDogYm91bmRzLmhlaWdodCAtIChib3JkZXJzWzBdLndpZHRoICsgYm9yZGVyc1syXS53aWR0aCkKICAgIH07CgogICAgaWYgKGNsaXApIHsKICAgICAgYmFja2dyb3VuZEJvdW5kcyA9IGNsaXBCb3VuZHMoYmFja2dyb3VuZEJvdW5kcywgY2xpcCk7CiAgICB9CgogICAgcmV0dXJuIGJhY2tncm91bmRCb3VuZHM7CiAgfQoKICBmdW5jdGlvbiBnZXRCb3VuZHMoZWxlbWVudCwgdHJhbnNmb3JtKSB7CiAgICB2YXIgYm91bmRzID0gKHRyYW5zZm9ybS5tYXRyaXgpID8gVXRpbC5PZmZzZXRCb3VuZHMoZWxlbWVudCkgOiBVdGlsLkJvdW5kcyhlbGVtZW50KTsKICAgIHRyYW5zZm9ybS5vcmlnaW5bMF0gKz0gYm91bmRzLmxlZnQ7CiAgICB0cmFuc2Zvcm0ub3JpZ2luWzFdICs9IGJvdW5kcy50b3A7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyRWxlbWVudChlbGVtZW50LCBwYXJlbnRTdGFjaywgcHNldWRvRWxlbWVudCwgaWdub3JlQmFja2dyb3VuZCkgewogICAgdmFyIHRyYW5zZm9ybSA9IGdldFRyYW5zZm9ybShlbGVtZW50LCBwYXJlbnRTdGFjayksCiAgICBib3VuZHMgPSBnZXRCb3VuZHMoZWxlbWVudCwgdHJhbnNmb3JtKSwKICAgIGltYWdlLAogICAgc3RhY2sgPSBjcmVhdGVTdGFjayhlbGVtZW50LCBwYXJlbnRTdGFjaywgYm91bmRzLCB0cmFuc2Zvcm0pLAogICAgYm9yZGVycyA9IHN0YWNrLmJvcmRlcnMsCiAgICBjdHggPSBzdGFjay5jdHgsCiAgICBiYWNrZ3JvdW5kQm91bmRzID0gZ2V0QmFja2dyb3VuZEJvdW5kcyhib3JkZXJzLCBib3VuZHMsIHN0YWNrLmNsaXApLAogICAgYm9yZGVyRGF0YSA9IHBhcnNlQm9yZGVycyhlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpLAogICAgYmFja2dyb3VuZENvbG9yID0gKGlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpID8gIiNlZmVmZWYiIDogZ2V0Q1NTKGVsZW1lbnQsICJiYWNrZ3JvdW5kQ29sb3IiKTsKCgogICAgY3JlYXRlU2hhcGUoY3R4LCBib3JkZXJEYXRhLmNsaXApOwoKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguY2xpcCgpOwoKICAgIGlmIChiYWNrZ3JvdW5kQm91bmRzLmhlaWdodCA+IDAgJiYgYmFja2dyb3VuZEJvdW5kcy53aWR0aCA+IDAgJiYgIWlnbm9yZUJhY2tncm91bmQpIHsKICAgICAgcmVuZGVyQmFja2dyb3VuZENvbG9yKGN0eCwgYm91bmRzLCBiYWNrZ3JvdW5kQ29sb3IpOwogICAgICByZW5kZXJCYWNrZ3JvdW5kSW1hZ2UoZWxlbWVudCwgYmFja2dyb3VuZEJvdW5kcywgY3R4KTsKICAgIH0gZWxzZSBpZiAoaWdub3JlQmFja2dyb3VuZCkgewogICAgICBzdGFjay5iYWNrZ3JvdW5kQ29sb3IgPSAgYmFja2dyb3VuZENvbG9yOwogICAgfQoKICAgIGN0eC5yZXN0b3JlKCk7CgogICAgYm9yZGVyRGF0YS5ib3JkZXJzLmZvckVhY2goZnVuY3Rpb24oYm9yZGVyKSB7CiAgICAgIHJlbmRlckJvcmRlcnMoY3R4LCBib3JkZXIuYXJncywgYm9yZGVyLmNvbG9yKTsKICAgIH0pOwoKICAgIGlmICghcHNldWRvRWxlbWVudCkgewogICAgICBpbmplY3RQc2V1ZG9FbGVtZW50cyhlbGVtZW50LCBzdGFjayk7CiAgICB9CgogICAgc3dpdGNoKGVsZW1lbnQubm9kZU5hbWUpewogICAgICBjYXNlICJJTUciOgogICAgICAgIGlmICgoaW1hZ2UgPSBsb2FkSW1hZ2UoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKSkpIHsKICAgICAgICAgIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgaW1hZ2UsIGJvdW5kcywgYm9yZGVycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyA8aW1nPjoiICsgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIklOUFVUIjoKICAgICAgICAvLyBUT0RPIGFkZCBhbGwgcmVsZXZhbnQgdHlwZSdzLCBpLmUuIEhUTUw1IG5ldyBzdHVmZgogICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdAogICAgICAgIGlmICgvXih0ZXh0fHVybHxlbWFpbHxzdWJtaXR8YnV0dG9ufHJlc2V0KSQvLnRlc3QoZWxlbWVudC50eXBlKSAmJiAoZWxlbWVudC52YWx1ZSB8fCBlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlRFWFRBUkVBIjoKICAgICAgICBpZiAoKGVsZW1lbnQudmFsdWUgfHwgZWxlbWVudC5wbGFjZWhvbGRlciB8fCAiIikubGVuZ3RoID4gMCl7CiAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWxlbWVudCwgYm91bmRzLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJTRUxFQ1QiOgogICAgICAgIGlmICgoZWxlbWVudC5vcHRpb25zfHxlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkxJIjoKICAgICAgICByZW5kZXJMaXN0SXRlbShlbGVtZW50LCBzdGFjaywgYmFja2dyb3VuZEJvdW5kcyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkNBTlZBUyI6CiAgICAgICAgcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkgewogICAgcmV0dXJuIChnZXRDU1MoZWxlbWVudCwgJ2Rpc3BsYXknKSAhPT0gIm5vbmUiICYmIGdldENTUyhlbGVtZW50LCAndmlzaWJpbGl0eScpICE9PSAiaGlkZGVuIiAmJiAhZWxlbWVudC5oYXNBdHRyaWJ1dGUoImRhdGEtaHRtbDJjYW52YXMtaWdub3JlIikpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VFbGVtZW50IChlbGVtZW50LCBzdGFjaywgcHNldWRvRWxlbWVudCkgewogICAgaWYgKGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkpIHsKICAgICAgc3RhY2sgPSByZW5kZXJFbGVtZW50KGVsZW1lbnQsIHN0YWNrLCBwc2V1ZG9FbGVtZW50LCBmYWxzZSkgfHwgc3RhY2s7CiAgICAgIGlmICghaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbGVtZW50Lm5vZGVOYW1lKSkgewogICAgICAgIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIHBzZXVkb0VsZW1lbnQpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrLCBwc2V1ZG9FbGVtZW50KSB7CiAgICBVdGlsLkNoaWxkcmVuKGVsZW1lbnQpLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gbm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICBwYXJzZUVsZW1lbnQobm9kZSwgc3RhY2ssIHBzZXVkb0VsZW1lbnQpOwogICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IG5vZGUuVEVYVF9OT0RFKSB7CiAgICAgICAgcmVuZGVyVGV4dChlbGVtZW50LCBub2RlLCBzdGFjayk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gaW5pdCgpIHsKICAgIHZhciBiYWNrZ3JvdW5kID0gZ2V0Q1NTKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgImJhY2tncm91bmRDb2xvciIpLAogICAgICB0cmFuc3BhcmVudEJhY2tncm91bmQgPSAoVXRpbC5pc1RyYW5zcGFyZW50KGJhY2tncm91bmQpICYmIGVsZW1lbnQgPT09IGRvY3VtZW50LmJvZHkpLAogICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgbnVsbCwgZmFsc2UsIHRyYW5zcGFyZW50QmFja2dyb3VuZCk7CiAgICBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrKTsKCiAgICBpZiAodHJhbnNwYXJlbnRCYWNrZ3JvdW5kKSB7CiAgICAgIGJhY2tncm91bmQgPSBzdGFjay5iYWNrZ3JvdW5kQ29sb3I7CiAgICB9CgogICAgYm9keS5yZW1vdmVDaGlsZChoaWRlUHNldWRvRWxlbWVudHMpOwogICAgcmV0dXJuIHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBiYWNrZ3JvdW5kLAogICAgICBzdGFjazogc3RhY2sKICAgIH07CiAgfQoKICByZXR1cm4gaW5pdCgpOwp9OwoKZnVuY3Rpb24gaDJjekNvbnRleHQoemluZGV4KSB7CiAgcmV0dXJuIHsKICAgIHppbmRleDogemluZGV4LAogICAgY2hpbGRyZW46IFtdCiAgfTsKfQoKX2h0bWwyY2FudmFzLlByZWxvYWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgdmFyIGltYWdlcyA9IHsKICAgIG51bUxvYWRlZDogMCwgICAvLyBhbHNvIGZhaWxlZCBhcmUgY291bnRlZCBoZXJlCiAgICBudW1GYWlsZWQ6IDAsCiAgICBudW1Ub3RhbDogMCwKICAgIGNsZWFudXBEb25lOiBmYWxzZQogIH0sCiAgcGFnZU9yaWdpbiwKICBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgbWV0aG9kcywKICBpLAogIGNvdW50ID0gMCwKICBlbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50c1swXSB8fCBkb2N1bWVudC5ib2R5LAogIGRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudCwKICBkb21JbWFnZXMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWcnKSwgLy8gRmV0Y2ggaW1hZ2VzIG9mIHRoZSBwcmVzZW50IGVsZW1lbnQgb25seQogIGltZ0xlbiA9IGRvbUltYWdlcy5sZW5ndGgsCiAgbGluayA9IGRvYy5jcmVhdGVFbGVtZW50KCJhIiksCiAgc3VwcG9ydENPUlMgPSAoZnVuY3Rpb24oIGltZyApewogICAgcmV0dXJuIChpbWcuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCk7CiAgfSkobmV3IEltYWdlKCkpLAogIHRpbWVvdXRUaW1lcjsKCiAgbGluay5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgcGFnZU9yaWdpbiAgPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwoKICBmdW5jdGlvbiBpc1NhbWVPcmlnaW4odXJsKXsKICAgIGxpbmsuaHJlZiA9IHVybDsKICAgIGxpbmsuaHJlZiA9IGxpbmsuaHJlZjsgLy8gWUVTLCBCRUxJRVZFIElUIE9SIE5PVCwgdGhhdCBpcyByZXF1aXJlZCBmb3IgSUU5IC0gaHR0cDovL2pzZmlkZGxlLm5ldC9uaWtsYXN2aC8yZTQ4Yi8KICAgIHZhciBvcmlnaW4gPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwogICAgcmV0dXJuIChvcmlnaW4gPT09IHBhZ2VPcmlnaW4pOwogIH0KCiAgZnVuY3Rpb24gc3RhcnQoKXsKICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogc3RhcnQ6IGltYWdlczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwogICAgaWYgKCFpbWFnZXMuZmlyc3RSdW4gJiYgaW1hZ2VzLm51bUxvYWRlZCA+PSBpbWFnZXMubnVtVG90YWwpewogICAgICBVdGlsLmxvZygiRmluaXNoZWQgbG9hZGluZyBpbWFnZXM6ICMgIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBsZXRlID09PSAiZnVuY3Rpb24iKXsKICAgICAgICBvcHRpb25zLmNvbXBsZXRlKGltYWdlcyk7CiAgICAgIH0KCiAgICB9CiAgfQoKICAvLyBUT0RPIG1vZGlmeSBwcm94eSB0byBzZXJ2ZSBpbWFnZXMgd2l0aCBDT1JTIGVuYWJsZWQsIHdoZXJlIGF2YWlsYWJsZQogIGZ1bmN0aW9uIHByb3h5R2V0SW1hZ2UodXJsLCBpbWcsIGltYWdlT2JqKXsKICAgIHZhciBjYWxsYmFja19uYW1lLAogICAgc2NyaXB0VXJsID0gb3B0aW9ucy5wcm94eSwKICAgIHNjcmlwdDsKCiAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICB1cmwgPSBsaW5rLmhyZWY7IC8vIHdvcmsgYXJvdW5kIGZvciBwYWdlcyB3aXRoIGJhc2UgaHJlZj0iIiBzZXQgLSBXQVJOSU5HOiB0aGlzIG1heSBjaGFuZ2UgdGhlIHVybAoKICAgIGNhbGxiYWNrX25hbWUgPSAnaHRtbDJjYW52YXNfJyArIChjb3VudCsrKTsKICAgIGltYWdlT2JqLmNhbGxiYWNrbmFtZSA9IGNhbGxiYWNrX25hbWU7CgogICAgaWYgKHNjcmlwdFVybC5pbmRleE9mKCI/IikgPiAtMSkgewogICAgICBzY3JpcHRVcmwgKz0gIiYiOwogICAgfSBlbHNlIHsKICAgICAgc2NyaXB0VXJsICs9ICI/IjsKICAgIH0KICAgIHNjcmlwdFVybCArPSAndXJsPScgKyBlbmNvZGVVUklDb21wb25lbnQodXJsKSArICcmY2FsbGJhY2s9JyArIGNhbGxiYWNrX25hbWU7CiAgICBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgogICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gZnVuY3Rpb24oYSl7CiAgICAgIGlmIChhLnN1YnN0cmluZygwLDYpID09PSAiZXJyb3I6Iil7CiAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICBzdGFydCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgIGltZy5zcmMgPSBhOwogICAgICB9CiAgICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpCiAgICAgIHRyeSB7CiAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja19uYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcwogICAgICB9IGNhdGNoKGV4KSB7fQogICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICBzY3JpcHQgPSBudWxsOwogICAgICBkZWxldGUgaW1hZ2VPYmouc2NyaXB0OwogICAgICBkZWxldGUgaW1hZ2VPYmouY2FsbGJhY2tuYW1lOwogICAgfTsKCiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInRleHQvamF2YXNjcmlwdCIpOwogICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgc2NyaXB0VXJsKTsKICAgIGltYWdlT2JqLnNjcmlwdCA9IHNjcmlwdDsKICAgIHdpbmRvdy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CgogIH0KCiAgZnVuY3Rpb24gbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgdHlwZSkgewogICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgdHlwZSksCiAgICBjb250ZW50ID0gc3R5bGUuY29udGVudDsKICAgIGlmIChjb250ZW50LnN1YnN0cigwLCAzKSA9PT0gJ3VybCcpIHsKICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoX2h0bWwyY2FudmFzLlV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoY29udGVudClbMF0uYXJnc1swXSk7CiAgICB9CiAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhzdHlsZS5iYWNrZ3JvdW5kSW1hZ2UsIGVsZW1lbnQpOwogIH0KCiAgZnVuY3Rpb24gbG9hZFBzZXVkb0VsZW1lbnRJbWFnZXMoZWxlbWVudCkgewogICAgbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgIjpiZWZvcmUiKTsKICAgIGxvYWRQc2V1ZG9FbGVtZW50KGVsZW1lbnQsICI6YWZ0ZXIiKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRHcmFkaWVudEltYWdlKGJhY2tncm91bmRJbWFnZSwgYm91bmRzKSB7CiAgICB2YXIgaW1nID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50KGJhY2tncm91bmRJbWFnZSwgYm91bmRzKTsKCiAgICBpZiAoaW1nICE9PSB1bmRlZmluZWQpewogICAgICBpbWFnZXNbYmFja2dyb3VuZEltYWdlXSA9IHsKICAgICAgICBpbWc6IGltZywKICAgICAgICBzdWNjZWVkZWQ6IHRydWUKICAgICAgfTsKICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgc3RhcnQoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGludmFsaWRCYWNrZ3JvdW5kcyhiYWNrZ3JvdW5kX2ltYWdlKSB7CiAgICByZXR1cm4gKGJhY2tncm91bmRfaW1hZ2UgJiYgYmFja2dyb3VuZF9pbWFnZS5tZXRob2QgJiYgYmFja2dyb3VuZF9pbWFnZS5hcmdzICYmIGJhY2tncm91bmRfaW1hZ2UuYXJncy5sZW5ndGggPiAwICk7CiAgfQoKICBmdW5jdGlvbiBsb2FkQmFja2dyb3VuZEltYWdlcyhiYWNrZ3JvdW5kX2ltYWdlLCBlbCkgewogICAgdmFyIGJvdW5kczsKCiAgICBfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlKS5maWx0ZXIoaW52YWxpZEJhY2tncm91bmRzKS5mb3JFYWNoKGZ1bmN0aW9uKGJhY2tncm91bmRfaW1hZ2UpIHsKICAgICAgaWYgKGJhY2tncm91bmRfaW1hZ2UubWV0aG9kID09PSAndXJsJykgewogICAgICAgIG1ldGhvZHMubG9hZEltYWdlKGJhY2tncm91bmRfaW1hZ2UuYXJnc1swXSk7CiAgICAgIH0gZWxzZSBpZihiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZC5tYXRjaCgvXC0/Z3JhZGllbnQkLykpIHsKICAgICAgICBpZihib3VuZHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKGVsKTsKICAgICAgICB9CiAgICAgICAgbG9hZEdyYWRpZW50SW1hZ2UoYmFja2dyb3VuZF9pbWFnZS52YWx1ZSwgYm91bmRzKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRJbWFnZXMgKGVsKSB7CiAgICB2YXIgZWxOb2RlVHlwZSA9IGZhbHNlOwoKICAgIC8vIEZpcmVmb3ggZmFpbHMgd2l0aCBwZXJtaXNzaW9uIGRlbmllZCBvbiBwYWdlcyB3aXRoIGlmcmFtZXMKICAgIHRyeSB7CiAgICAgIFV0aWwuQ2hpbGRyZW4oZWwpLmZvckVhY2goZ2V0SW1hZ2VzKTsKICAgIH0KICAgIGNhdGNoKCBlICkge30KCiAgICB0cnkgewogICAgICBlbE5vZGVUeXBlID0gZWwubm9kZVR5cGU7CiAgICB9IGNhdGNoIChleCkgewogICAgICBlbE5vZGVUeXBlID0gZmFsc2U7CiAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGFjY2VzcyBzb21lIGVsZW1lbnQncyBub2RlVHlwZSAtIEV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgfQoKICAgIGlmIChlbE5vZGVUeXBlID09PSAxIHx8IGVsTm9kZVR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICBsb2FkUHNldWRvRWxlbWVudEltYWdlcyhlbCk7CiAgICAgIHRyeSB7CiAgICAgICAgbG9hZEJhY2tncm91bmRJbWFnZXMoVXRpbC5nZXRDU1MoZWwsICdiYWNrZ3JvdW5kSW1hZ2UnKSwgZWwpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IGZhaWxlZCB0byBnZXQgYmFja2dyb3VuZC1pbWFnZSAtIEV4Y2VwdGlvbjogIiArIGUubWVzc2FnZSk7CiAgICAgIH0KICAgICAgbG9hZEJhY2tncm91bmRJbWFnZXMoZWwpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaikgewogICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIGltYWdlT2JqLnRpbWVyICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgLy8gQ09SUyBzdWNjZWVkZWQKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBpbWFnZU9iai50aW1lciApOwogICAgICB9CgogICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IHRydWU7CiAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgIHN0YXJ0KCk7CiAgICB9OwogICAgaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKGltZy5jcm9zc09yaWdpbiA9PT0gImFub255bW91cyIpIHsKICAgICAgICAvLyBDT1JTIGZhaWxlZAogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7CgogICAgICAgIC8vIGxldCdzIHRyeSB3aXRoIHByb3h5IGluc3RlYWQKICAgICAgICBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICB2YXIgc3JjID0gaW1nLnNyYzsKICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgaW1hZ2VPYmouaW1nID0gaW1nOwogICAgICAgICAgaW1nLnNyYyA9IHNyYzsKCiAgICAgICAgICBwcm94eUdldEltYWdlKCBpbWcuc3JjLCBpbWcsIGltYWdlT2JqICk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgIHN0YXJ0KCk7CiAgICB9OwogIH0KCiAgbWV0aG9kcyA9IHsKICAgIGxvYWRJbWFnZTogZnVuY3Rpb24oIHNyYyApIHsKICAgICAgdmFyIGltZywgaW1hZ2VPYmo7CiAgICAgIGlmICggc3JjICYmIGltYWdlc1tzcmNdID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgaWYgKCBzcmMubWF0Y2goL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaSkgKSB7CiAgICAgICAgICBpbWcuc3JjID0gc3JjLnJlcGxhY2UoL3VybFwoWyciXXswLH18WyciXXswLH1cKSQvaWcsICcnKTsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICB9IGVsc2UgaWYgKCBpc1NhbWVPcmlnaW4oIHNyYyApIHx8IG9wdGlvbnMuYWxsb3dUYWludCA9PT0gIHRydWUgKSB7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwogICAgICAgIH0gZWxzZSBpZiAoIHN1cHBvcnRDT1JTICYmICFvcHRpb25zLmFsbG93VGFpbnQgJiYgb3B0aW9ucy51c2VDT1JTICkgewogICAgICAgICAgLy8gYXR0ZW1wdCB0byBsb2FkIHdpdGggQ09SUwoKICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgICAgaW1nLnNyYyA9IHNyYzsKICAgICAgICB9IGVsc2UgaWYgKCBvcHRpb25zLnByb3h5ICkgewogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIHNyYywgaW1nLCBpbWFnZU9iaiApOwogICAgICAgIH0KICAgICAgfQoKICAgIH0sCiAgICBjbGVhbnVwRE9NOiBmdW5jdGlvbihjYXVzZSkgewogICAgICB2YXIgaW1nLCBzcmM7CiAgICAgIGlmICghaW1hZ2VzLmNsZWFudXBEb25lKSB7CiAgICAgICAgaWYgKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBiZWNhdXNlOiAiICsgY2F1c2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYWZ0ZXIgdGltZW91dDogIiArIG9wdGlvbnMudGltZW91dCArICIgbXMuIik7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHNyYyBpbiBpbWFnZXMpIHsKICAgICAgICAgIGlmIChpbWFnZXMuaGFzT3duUHJvcGVydHkoc3JjKSkgewogICAgICAgICAgICBpbWcgPSBpbWFnZXNbc3JjXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbWcgPT09ICJvYmplY3QiICYmIGltZy5jYWxsYmFja25hbWUgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gY2FuY2VsIHByb3h5IGltYWdlIHJlcXVlc3QKICAgICAgICAgICAgICB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2ltZy5jYWxsYmFja25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgfSBjYXRjaChleCkge30KICAgICAgICAgICAgICBpZiAoaW1nLnNjcmlwdCAmJiBpbWcuc2NyaXB0LnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgIGltZy5zY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCAiYWJvdXQ6YmxhbmsiKTsgIC8vIHRyeSB0byBjYW5jZWwgcnVubmluZyByZXF1ZXN0CiAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1nLnNjcmlwdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbmVkIHVwIGZhaWxlZCBpbWc6ICciICsgc3JjICsgIicgU3RlcHM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBjYW5jZWwgYW55IHBlbmRpbmcgcmVxdWVzdHMKICAgICAgICBpZih3aW5kb3cuc3RvcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB3aW5kb3cuc3RvcCgpOwogICAgICAgIH0gZWxzZSBpZihkb2N1bWVudC5leGVjQ29tbWFuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiU3RvcCIsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRvY3VtZW50LmNsb3NlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRvY3VtZW50LmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIGltYWdlcy5jbGVhbnVwRG9uZSA9IHRydWU7CiAgICAgICAgaWYgKCEoY2F1c2UgJiYgdHlwZW9mIGNhdXNlID09PSAic3RyaW5nIikpIHsKICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHJlbmRlcmluZ0RvbmU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGltZW91dFRpbWVyKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICB9CiAgICB9CiAgfTsKCiAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHsKICAgIHRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG1ldGhvZHMuY2xlYW51cERPTSwgb3B0aW9ucy50aW1lb3V0KTsKICB9CgogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZCBzdGFydHM6IGZpbmRpbmcgYmFja2dyb3VuZC1pbWFnZXMnKTsKICBpbWFnZXMuZmlyc3RSdW4gPSB0cnVlOwoKICBnZXRJbWFnZXMoZWxlbWVudCk7CgogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRmluZGluZyBpbWFnZXMnKTsKICAvLyBsb2FkIDxpbWc+IGltYWdlcwogIGZvciAoaSA9IDA7IGkgPCBpbWdMZW47IGkrPTEpewogICAgbWV0aG9kcy5sb2FkSW1hZ2UoIGRvbUltYWdlc1tpXS5nZXRBdHRyaWJ1dGUoICJzcmMiICkgKTsKICB9CgogIGltYWdlcy5maXJzdFJ1biA9IGZhbHNlOwogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRG9uZS4nKTsKICBpZiAoaW1hZ2VzLm51bVRvdGFsID09PSBpbWFnZXMubnVtTG9hZGVkKSB7CiAgICBzdGFydCgpOwogIH0KCiAgcmV0dXJuIG1ldGhvZHM7Cn07CgpfaHRtbDJjYW52YXMuUmVuZGVyZXIgPSBmdW5jdGlvbihwYXJzZVF1ZXVlLCBvcHRpb25zKXsKCiAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvemluZGV4Lmh0bWwKICBmdW5jdGlvbiBjcmVhdGVSZW5kZXJRdWV1ZShwYXJzZVF1ZXVlKSB7CiAgICB2YXIgcXVldWUgPSBbXSwKICAgIHJvb3RDb250ZXh0OwoKICAgIHJvb3RDb250ZXh0ID0gKGZ1bmN0aW9uIGJ1aWxkU3RhY2tpbmdDb250ZXh0KHJvb3ROb2RlKSB7CiAgICAgIHZhciByb290Q29udGV4dCA9IHt9OwogICAgICBmdW5jdGlvbiBpbnNlcnQoY29udGV4dCwgbm9kZSwgc3BlY2lhbFBhcmVudCkgewogICAgICAgIHZhciB6aSA9IChub2RlLnpJbmRleC56aW5kZXggPT09ICdhdXRvJykgPyAwIDogTnVtYmVyKG5vZGUuekluZGV4LnppbmRleCksCiAgICAgICAgY29udGV4dEZvckNoaWxkcmVuID0gY29udGV4dCwgLy8gdGhlIHN0YWNraW5nIGNvbnRleHQgZm9yIGNoaWxkcmVuCiAgICAgICAgaXNQb3NpdGlvbmVkID0gbm9kZS56SW5kZXguaXNQb3NpdGlvbmVkLAogICAgICAgIGlzRmxvYXRlZCA9IG5vZGUuekluZGV4LmlzRmxvYXRlZCwKICAgICAgICBzdHViID0ge25vZGU6IG5vZGV9LAogICAgICAgIGNoaWxkcmVuRGVzdCA9IHNwZWNpYWxQYXJlbnQ7IC8vIHdoZXJlIGNoaWxkcmVuIHdpdGhvdXQgei1pbmRleCBzaG91bGQgYmUgcHVzaGVkIGludG8KCiAgICAgICAgaWYgKG5vZGUuekluZGV4Lm93blN0YWNraW5nKSB7CiAgICAgICAgICAvLyAnIScgY29tZXMgYmVmb3JlIG51bWJlcnMgaW4gc29ydGVkIGFycmF5CiAgICAgICAgICBjb250ZXh0Rm9yQ2hpbGRyZW4gPSBzdHViLmNvbnRleHQgPSB7ICchJzogW3tub2RlOm5vZGUsIGNoaWxkcmVuOiBbXX1dfTsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgaWYgKGlzUG9zaXRpb25lZCB8fCBpc0Zsb2F0ZWQpIHsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHN0dWIuY2hpbGRyZW4gPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmICh6aSA9PT0gMCAmJiBzcGVjaWFsUGFyZW50KSB7CiAgICAgICAgICBzcGVjaWFsUGFyZW50LnB1c2goc3R1Yik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghY29udGV4dFt6aV0pIHsgY29udGV4dFt6aV0gPSBbXTsgfQogICAgICAgICAgY29udGV4dFt6aV0ucHVzaChzdHViKTsKICAgICAgICB9CgogICAgICAgIG5vZGUuekluZGV4LmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGROb2RlKSB7CiAgICAgICAgICBpbnNlcnQoY29udGV4dEZvckNoaWxkcmVuLCBjaGlsZE5vZGUsIGNoaWxkcmVuRGVzdCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaW5zZXJ0KHJvb3RDb250ZXh0LCByb290Tm9kZSk7CiAgICAgIHJldHVybiByb290Q29udGV4dDsKICAgIH0pKHBhcnNlUXVldWUpOwoKICAgIGZ1bmN0aW9uIHNvcnRaKGNvbnRleHQpIHsKICAgICAgT2JqZWN0LmtleXMoY29udGV4dCkuc29ydCgpLmZvckVhY2goZnVuY3Rpb24oemkpIHsKICAgICAgICB2YXIgbm9uUG9zaXRpb25lZCA9IFtdLAogICAgICAgIGZsb2F0ZWQgPSBbXSwKICAgICAgICBwb3NpdGlvbmVkID0gW10sCiAgICAgICAgbGlzdCA9IFtdOwoKICAgICAgICAvLyBwb3NpdGlvbmVkIGFmdGVyIHN0YXRpYwogICAgICAgIGNvbnRleHRbemldLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgaWYgKHYubm9kZS56SW5kZXguaXNQb3NpdGlvbmVkIHx8IHYubm9kZS56SW5kZXgub3BhY2l0eSA8IDEpIHsKICAgICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1jb2xvci8jdHJhbnNwYXJlbmN5CiAgICAgICAgICAgIC8vIG5vbi1wb3NpdGlvbmVkIGVsZW1lbnQgd2l0aCBvcGFjdGl5IDwgMSBzaG91bGQgYmUgc3RhY2tlZCBhcyBpZiBpdCB3ZXJlIGEgcG9zaXRpb25lZCBlbGVtZW50IHdpdGgg4oCYei1pbmRleDogMOKAmSBhbmQg4oCYb3BhY2l0eTogMeKAmS4KICAgICAgICAgICAgcG9zaXRpb25lZC5wdXNoKHYpOwogICAgICAgICAgfSBlbHNlIGlmICh2Lm5vZGUuekluZGV4LmlzRmxvYXRlZCkgewogICAgICAgICAgICBmbG9hdGVkLnB1c2godik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub25Qb3NpdGlvbmVkLnB1c2godik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIChmdW5jdGlvbiB3YWxrKGFycikgewogICAgICAgICAgYXJyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgICBsaXN0LnB1c2godik7CiAgICAgICAgICAgIGlmICh2LmNoaWxkcmVuKSB7IHdhbGsodi5jaGlsZHJlbik7IH0KICAgICAgICAgIH0pOwogICAgICAgIH0pKG5vblBvc2l0aW9uZWQuY29uY2F0KGZsb2F0ZWQsIHBvc2l0aW9uZWQpKTsKCiAgICAgICAgbGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIGlmICh2LmNvbnRleHQpIHsKICAgICAgICAgICAgc29ydFoodi5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHF1ZXVlLnB1c2godi5ub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgc29ydFoocm9vdENvbnRleHQpOwoKICAgIHJldHVybiBxdWV1ZTsKICB9CgogIGZ1bmN0aW9uIGdldFJlbmRlcmVyKHJlbmRlcmVyTmFtZSkgewogICAgdmFyIHJlbmRlcmVyOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gInN0cmluZyIgJiYgX2h0bWwyY2FudmFzLlJlbmRlcmVyW3JlbmRlcmVyTmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZW5kZXJlciA9IF9odG1sMmNhbnZhcy5SZW5kZXJlcltyZW5kZXJlck5hbWVdKG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcmVuZGVyZXJOYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlbmRlcmVyID0gcmVuZGVyZXJOYW1lKG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlcmVyIik7CiAgICB9CgogICAgaWYgKCB0eXBlb2YgcmVuZGVyZXIgIT09ICJmdW5jdGlvbiIgKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByZW5kZXJlciBkZWZpbmVkIik7CiAgICB9CiAgICByZXR1cm4gcmVuZGVyZXI7CiAgfQoKICByZXR1cm4gZ2V0UmVuZGVyZXIob3B0aW9ucy5yZW5kZXJlcikocGFyc2VRdWV1ZSwgb3B0aW9ucywgZG9jdW1lbnQsIGNyZWF0ZVJlbmRlclF1ZXVlKHBhcnNlUXVldWUuc3RhY2spLCBfaHRtbDJjYW52YXMpOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuU3VwcG9ydCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkb2MpIHsKCiAgZnVuY3Rpb24gc3VwcG9ydFNWR1JlbmRlcmluZygpIHsKICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKSwKICAgIGNhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICAgIGN0eCA9IChjYW52YXMuZ2V0Q29udGV4dCA9PT0gdW5kZWZpbmVkKSA/IGZhbHNlIDogY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBpZiAoY3R4ID09PSBmYWxzZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjYW52YXMud2lkdGggPSBjYW52YXMuaGVpZ2h0ID0gMTA7CiAgICBpbWcuc3JjID0gWwogICAgImRhdGE6aW1hZ2Uvc3ZnK3htbCwiLAogICAgIjxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nMTAnIGhlaWdodD0nMTAnPiIsCiAgICAiPGZvcmVpZ25PYmplY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgIjxkaXYgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnIHN0eWxlPSd3aWR0aDoxMDtoZWlnaHQ6MTA7Jz4iLAogICAgInN1cCIsCiAgICAiPC9kaXY+IiwKICAgICI8L2ZvcmVpZ25PYmplY3Q+IiwKICAgICI8L3N2Zz4iCiAgICBdLmpvaW4oIiIpOwogICAgdHJ5IHsKICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDApOwogICAgICBjYW52YXMudG9EYXRhVVJMKCk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgX2h0bWwyY2FudmFzLlV0aWwubG9nKCdodG1sMmNhbnZhczogUGFyc2U6IFNWRyBwb3dlcmVkIHJlbmRlcmluZyBhdmFpbGFibGUnKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLy8gVGVzdCB3aGV0aGVyIHdlIGNhbiB1c2UgcmFuZ2VzIHRvIG1lYXN1cmUgYm91bmRpbmcgYm94ZXMKICAvLyBPcGVyYSBkb2Vzbid0IHByb3ZpZGUgdmFsaWQgYm91bmRzLmhlaWdodC9ib3R0b20gZXZlbiB0aG91Z2ggaXQgc3VwcG9ydHMgdGhlIG1ldGhvZC4KCiAgZnVuY3Rpb24gc3VwcG9ydFJhbmdlQm91bmRzKCkgewogICAgdmFyIHIsIHRlc3RFbGVtZW50LCByYW5nZUJvdW5kcywgcmFuZ2VIZWlnaHQsIHN1cHBvcnQgPSBmYWxzZTsKCiAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKSB7CiAgICAgIHIgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgICAgaWYgKHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgdGVzdEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnYm91bmR0ZXN0Jyk7CiAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjEyM3B4IjsKICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZCh0ZXN0RWxlbWVudCk7CgogICAgICAgIHIuc2VsZWN0Tm9kZSh0ZXN0RWxlbWVudCk7CiAgICAgICAgcmFuZ2VCb3VuZHMgPSByLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHJhbmdlSGVpZ2h0ID0gcmFuZ2VCb3VuZHMuaGVpZ2h0OwoKICAgICAgICBpZiAocmFuZ2VIZWlnaHQgPT09IDEyMykgewogICAgICAgICAgc3VwcG9ydCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKHRlc3RFbGVtZW50KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzdXBwb3J0OwogIH0KCiAgcmV0dXJuIHsKICAgIHJhbmdlQm91bmRzOiBzdXBwb3J0UmFuZ2VCb3VuZHMoKSwKICAgIHN2Z1JlbmRlcmluZzogb3B0aW9ucy5zdmdSZW5kZXJpbmcgJiYgc3VwcG9ydFNWR1JlbmRlcmluZygpCiAgfTsKfTsKd2luZG93Lmh0bWwyY2FudmFzID0gZnVuY3Rpb24oZWxlbWVudHMsIG9wdHMpIHsKICBlbGVtZW50cyA9IChlbGVtZW50cy5sZW5ndGgpID8gZWxlbWVudHMgOiBbZWxlbWVudHNdOwogIHZhciBxdWV1ZSwKICBjYW52YXMsCiAgb3B0aW9ucyA9IHsKICAgIC8vIGdlbmVyYWwKICAgIGxvZ2dpbmc6IGZhbHNlLAogICAgZWxlbWVudHM6IGVsZW1lbnRzLAogICAgYmFja2dyb3VuZDogIiNmZmYiLAoKICAgIC8vIHByZWxvYWQgb3B0aW9ucwogICAgcHJveHk6IG51bGwsCiAgICB0aW1lb3V0OiAwLCAgICAvLyBubyB0aW1lb3V0CiAgICB1c2VDT1JTOiBmYWxzZSwgLy8gdHJ5IHRvIGxvYWQgaW1hZ2VzIGFzIENPUlMgKHdoZXJlIGF2YWlsYWJsZSksIGJlZm9yZSBmYWxsaW5nIGJhY2sgdG8gcHJveHkKICAgIGFsbG93VGFpbnQ6IGZhbHNlLCAvLyB3aGV0aGVyIHRvIGFsbG93IGltYWdlcyB0byB0YWludCB0aGUgY2FudmFzLCB3b24ndCBuZWVkIHByb3h5IGlmIHNldCB0byB0cnVlCgogICAgLy8gcGFyc2Ugb3B0aW9ucwogICAgc3ZnUmVuZGVyaW5nOiBmYWxzZSwgLy8gdXNlIHN2ZyBwb3dlcmVkIHJlbmRlcmluZyB3aGVyZSBhdmFpbGFibGUgKEZGMTErKQogICAgaWdub3JlRWxlbWVudHM6ICJJRlJBTUV8T0JKRUNUfFBBUkFNIiwKICAgIHVzZU92ZXJmbG93OiB0cnVlLAogICAgbGV0dGVyUmVuZGVyaW5nOiBmYWxzZSwKICAgIGNoaW5lc2U6IGZhbHNlLAoKICAgIC8vIHJlbmRlciBvcHRpb25zCgogICAgd2lkdGg6IG51bGwsCiAgICBoZWlnaHQ6IG51bGwsCiAgICB0YWludFRlc3Q6IHRydWUsIC8vIGRvIGEgdGFpbnQgdGVzdCB3aXRoIGFsbCBpbWFnZXMgYmVmb3JlIGFwcGx5aW5nIHRvIGNhbnZhcwogICAgcmVuZGVyZXI6ICJDYW52YXMiCiAgfTsKCiAgb3B0aW9ucyA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKTsKCiAgX2h0bWwyY2FudmFzLmxvZ2dpbmcgPSBvcHRpb25zLmxvZ2dpbmc7CiAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCBpbWFnZXMgKSB7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucHJlbG9hZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICggb3B0aW9ucy5vbnByZWxvYWRlZCggaW1hZ2VzICkgPT09IGZhbHNlICkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgcXVldWUgPSBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgb3B0aW9ucyApOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnBhcnNlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGNhbnZhcyA9IF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIG9wdGlvbnMgKTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMub25yZW5kZXJlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvcHRpb25zLm9ucmVuZGVyZWQoIGNhbnZhcyApOwogICAgfQoKCiAgfTsKCiAgLy8gZm9yIHBhZ2VzIHdpdGhvdXQgaW1hZ2VzLCB3ZSBzdGlsbCB3YW50IHRoaXMgdG8gYmUgYXN5bmMsIGkuZS4gcmV0dXJuIG1ldGhvZHMgYmVmb3JlIGV4ZWN1dGluZwogIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpewogICAgX2h0bWwyY2FudmFzLlByZWxvYWQoIG9wdGlvbnMgKTsKICB9LCAwICk7CgogIHJldHVybiB7CiAgICByZW5kZXI6IGZ1bmN0aW9uKCBxdWV1ZSwgb3B0cyApIHsKICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiggaW1hZ2VzLCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlBhcnNlKCBpbWFnZXMsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIHByZWxvYWQ6IGZ1bmN0aW9uKCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlByZWxvYWQoIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIGxvZzogX2h0bWwyY2FudmFzLlV0aWwubG9nCiAgfTsKfTsKCndpbmRvdy5odG1sMmNhbnZhcy5sb2cgPSBfaHRtbDJjYW52YXMuVXRpbC5sb2c7IC8vIGZvciByZW5kZXJlcnMKd2luZG93Lmh0bWwyY2FudmFzLlJlbmRlcmVyID0gewogIENhbnZhczogdW5kZWZpbmVkIC8vIFdlIGFyZSBhc3N1bWluZyB0aGlzIHdpbGwgYmUgdXNlZAp9OwpfaHRtbDJjYW52YXMuUmVuZGVyZXIuQ2FudmFzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgZG9jID0gZG9jdW1lbnQsCiAgc2FmZUltYWdlcyA9IFtdLAogIHRlc3RDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICB0ZXN0Y3R4ID0gdGVzdENhbnZhcy5nZXRDb250ZXh0KCIyZCIpLAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBjYW52YXMgPSBvcHRpb25zLmNhbnZhcyB8fCBkb2MuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CgogIGZ1bmN0aW9uIGNyZWF0ZVNoYXBlKGN0eCwgYXJncykgewogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uKGFyZykgewogICAgICBjdHhbYXJnLm5hbWVdLmFwcGx5KGN0eCwgYXJnWydhcmd1bWVudHMnXSk7CiAgICB9KTsKICAgIGN0eC5jbG9zZVBhdGgoKTsKICB9CgogIGZ1bmN0aW9uIHNhZmVJbWFnZShpdGVtKSB7CiAgICBpZiAoc2FmZUltYWdlcy5pbmRleE9mKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLnNyYyApID09PSAtMSkgewogICAgICB0ZXN0Y3R4LmRyYXdJbWFnZShpdGVtWydhcmd1bWVudHMnXVswXSwgMCwgMCk7CiAgICAgIHRyeSB7CiAgICAgICAgdGVzdGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgMSwgMSk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHRlc3RDYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgICAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgc2FmZUltYWdlcy5wdXNoKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLnNyYyk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckl0ZW0oY3R4LCBpdGVtKSB7CiAgICBzd2l0Y2goaXRlbS50eXBlKXsKICAgICAgY2FzZSAidmFyaWFibGUiOgogICAgICAgIGN0eFtpdGVtLm5hbWVdID0gaXRlbVsnYXJndW1lbnRzJ107CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICBzd2l0Y2goaXRlbS5uYW1lKSB7CiAgICAgICAgICBjYXNlICJjcmVhdGVQYXR0ZXJuIjoKICAgICAgICAgICAgaWYgKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLndpZHRoID4gMCAmJiBpdGVtWydhcmd1bWVudHMnXVswXS5oZWlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBjdHguY3JlYXRlUGF0dGVybihpdGVtWydhcmd1bWVudHMnXVswXSwgInJlcGVhdCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBFcnJvciBjcmVhdGluZyBwYXR0ZXJuIiwgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJkcmF3U2hhcGUiOgogICAgICAgICAgICBjcmVhdGVTaGFwZShjdHgsIGl0ZW1bJ2FyZ3VtZW50cyddKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJkcmF3SW1hZ2UiOgogICAgICAgICAgICBpZiAoaXRlbVsnYXJndW1lbnRzJ11bOF0gPiAwICYmIGl0ZW1bJ2FyZ3VtZW50cyddWzddID4gMCkgewogICAgICAgICAgICAgIGlmICghb3B0aW9ucy50YWludFRlc3QgfHwgKG9wdGlvbnMudGFpbnRUZXN0ICYmIHNhZmVJbWFnZShpdGVtKSkpIHsKICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoIGN0eCwgaXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjdHhbaXRlbS5uYW1lXS5hcHBseShjdHgsIGl0ZW1bJ2FyZ3VtZW50cyddKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gZnVuY3Rpb24ocGFyc2VkRGF0YSwgb3B0aW9ucywgZG9jdW1lbnQsIHF1ZXVlLCBfaHRtbDJjYW52YXMpIHsKICAgIHZhciBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKSwKICAgIG5ld0NhbnZhcywKICAgIGJvdW5kcywKICAgIGZzdHlsZSwKICAgIHpTdGFjayA9IHBhcnNlZERhdGEuc3RhY2s7CgogICAgY2FudmFzLndpZHRoID0gY2FudmFzLnN0eWxlLndpZHRoID0gIG9wdGlvbnMud2lkdGggfHwgelN0YWNrLmN0eC53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQ7CgogICAgZnN0eWxlID0gY3R4LmZpbGxTdHlsZTsKICAgIGN0eC5maWxsU3R5bGUgPSAoVXRpbC5pc1RyYW5zcGFyZW50KHpTdGFjay5iYWNrZ3JvdW5kQ29sb3IpICYmIG9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdW5kZWZpbmVkKSA/IG9wdGlvbnMuYmFja2dyb3VuZCA6IHBhcnNlZERhdGEuYmFja2dyb3VuZENvbG9yOwogICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBjdHguZmlsbFN0eWxlID0gZnN0eWxlOwoKICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oc3RvcmFnZUNvbnRleHQpIHsKICAgICAgLy8gc2V0IGNvbW1vbiBzZXR0aW5ncyBmb3IgY2FudmFzCiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsKICAgICAgY3R4LnNhdmUoKTsKCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ubWF0cml4KSB7CiAgICAgICAgY3R4LnRyYW5zbGF0ZShzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzBdLCBzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzFdKTsKICAgICAgICBjdHgudHJhbnNmb3JtLmFwcGx5KGN0eCwgc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm1hdHJpeCk7CiAgICAgICAgY3R4LnRyYW5zbGF0ZSgtc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblswXSwgLXN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMV0pOwogICAgICB9CgogICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY2xpcCl7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5yZWN0KHN0b3JhZ2VDb250ZXh0LmNsaXAubGVmdCwgc3RvcmFnZUNvbnRleHQuY2xpcC50b3AsIHN0b3JhZ2VDb250ZXh0LmNsaXAud2lkdGgsIHN0b3JhZ2VDb250ZXh0LmNsaXAuaGVpZ2h0KTsKICAgICAgICBjdHguY2xpcCgpOwogICAgICB9CgogICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2UpIHsKICAgICAgICBzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIHJlbmRlckl0ZW0oY3R4LCBpdGVtKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0pOwoKICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IENhbnZhcyByZW5kZXJlciBkb25lIC0gcmV0dXJuaW5nIGNhbnZhcyBvYmoiKTsKCiAgICBpZiAob3B0aW9ucy5lbGVtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmVsZW1lbnRzWzBdID09PSAib2JqZWN0IiAmJiBvcHRpb25zLmVsZW1lbnRzWzBdLm5vZGVOYW1lICE9PSAiQk9EWSIpIHsKICAgICAgICAvLyBjcm9wIGltYWdlIHRvIHRoZSBib3VuZHMgb2Ygc2VsZWN0ZWQgKHNpbmdsZSkgZWxlbWVudAogICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyhvcHRpb25zLmVsZW1lbnRzWzBdKTsKICAgICAgICBuZXdDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBuZXdDYW52YXMud2lkdGggPSBNYXRoLmNlaWwoYm91bmRzLndpZHRoKTsKICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gTWF0aC5jZWlsKGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGN0eCA9IG5ld0NhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwoKICAgICAgICBjdHguZHJhd0ltYWdlKGNhbnZhcywgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCwgMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBjYW52YXMgPSBudWxsOwogICAgICAgIHJldHVybiBuZXdDYW52YXM7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH07Cn07Cn0pKHdpbmRvdyxkb2N1bWVudCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 01:08:26 GMT",
                    "Content-Length": "88620",
                    "Date": "Sun, 09 Nov 2014 01:08:26 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}