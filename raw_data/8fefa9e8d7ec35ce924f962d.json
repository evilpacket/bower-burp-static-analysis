{
    "url": "http://localhost:9999/CreateJS/PreloadJS/lib/preloadjs-NEXT.combined.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>host.href = location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CreateJS/PreloadJS/lib/preloadjs-NEXT.combined.js",
                "path": "/CreateJS/PreloadJS/lib/preloadjs-NEXT.combined.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DcmVhdGVKUy9QcmVsb2FkSlMvbGliL3ByZWxvYWRqcy1ORVhULmNvbWJpbmVkLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTYxNzMzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDE5OjM2OjU1IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxOTozNjo1NCBHTVQNCg0KdGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9OwoKKGZ1bmN0aW9uKCkgewoJInVzZSBzdHJpY3QiOwoKCS8qKgoJICogU3RhdGljIGNsYXNzIGhvbGRpbmcgbGlicmFyeSBzcGVjaWZpYyBpbmZvcm1hdGlvbiBzdWNoIGFzIHRoZSB2ZXJzaW9uIGFuZCBidWlsZERhdGUgb2YKCSAqIHRoZSBsaWJyYXJ5LgoJICoKCSAqIFRoZSBvbGQgUHJlbG9hZEpTIGNsYXNzIGhhcyBiZWVuIHJlbmFtZWQgdG8gTG9hZFF1ZXVlLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBjbGFzcyBmb3IgaW5mb3JtYXRpb24gb24gbG9hZGluZyBmaWxlcy4KCSAqIEBjbGFzcyBQcmVsb2FkSlMKCSAqKi8KCXZhciBzID0gY3JlYXRlanMuUHJlbG9hZEpTID0gY3JlYXRlanMuUHJlbG9hZEpTIHx8IHt9OwoKCS8qKgoJICogVGhlIHZlcnNpb24gc3RyaW5nIGZvciB0aGlzIHJlbGVhc2UuCgkgKiBAcHJvcGVydHkgdmVyc2lvbgoJICogQHR5cGUgU3RyaW5nCgkgKiBAc3RhdGljCgkgKiovCglzLnZlcnNpb24gPSAvKnZlcnNpb24qLyJORVhUIjsgLy8gaW5qZWN0ZWQgYnkgYnVpbGQgcHJvY2VzcwoKCS8qKgoJICogVGhlIGJ1aWxkIGRhdGUgZm9yIHRoaXMgcmVsZWFzZSBpbiBVVEMgZm9ybWF0LgoJICogQHByb3BlcnR5IGJ1aWxkRGF0ZQoJICogQHR5cGUgU3RyaW5nCgkgKiBAc3RhdGljCgkgKiovCglzLmJ1aWxkRGF0ZSA9IC8qZGF0ZSovIldlZCwgMjIgT2N0IDIwMTQgMTY6MTE6MzUgR01UIjsgLy8gaW5qZWN0ZWQgYnkgYnVpbGQgcHJvY2VzcwoKfSkoKTsKLyoKKiBFdmVudAoqIFZpc2l0IGh0dHA6Ly9jcmVhdGVqcy5jb20vIGZvciBkb2N1bWVudGF0aW9uLCB1cGRhdGVzIGFuZCBleGFtcGxlcy4KKgoqIENvcHlyaWdodCAoYykgMjAxMCBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgovKioKICogQSBjb2xsZWN0aW9uIG9mIENsYXNzZXMgdGhhdCBhcmUgc2hhcmVkIGFjcm9zcyBhbGwgdGhlIENyZWF0ZUpTIGxpYnJhcmllcy4gIFRoZSBjbGFzc2VzIGFyZSBpbmNsdWRlZCBpbiB0aGUgbWluaWZpZWQKICogZmlsZXMgb2YgZWFjaCBsaWJyYXJ5IGFuZCBhcmUgYXZhaWxhYmxlIG9uIHRoZSBjcmVhdGVzanMgbmFtZXNwYWNlIGRpcmVjdGx5LgogKgogKiA8aDQ+RXhhbXBsZTwvaDQ+CiAqICAgICAgbXlPYmplY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgY3JlYXRlanMucHJveHkobXlNZXRob2QsIHNjb3BlKSk7CiAqCiAqIEBtb2R1bGUgQ3JlYXRlSlMKICogQG1haW4gQ3JlYXRlSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzfHx7fTsKCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCi8qKgogKiBDb250YWlucyBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzIHNoYXJlZCBieSBhbGwgZXZlbnRzIGZvciB1c2Ugd2l0aAogKiB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlciJ9fXt7L2Nyb3NzTGlua319LgogKgogKiBOb3RlIHRoYXQgRXZlbnQgb2JqZWN0cyBhcmUgb2Z0ZW4gcmV1c2VkLCBzbyB5b3Ugc2hvdWxkIG5ldmVyCiAqIHJlbHkgb24gYW4gZXZlbnQgb2JqZWN0J3Mgc3RhdGUgb3V0c2lkZSBvZiB0aGUgY2FsbCBzdGFjayBpdCB3YXMgcmVjZWl2ZWQgaW4uCiAqIEBjbGFzcyBFdmVudAogKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KICogQHBhcmFtIHtCb29sZWFufSBidWJibGVzIEluZGljYXRlcyB3aGV0aGVyIHRoZSBldmVudCB3aWxsIGJ1YmJsZSB0aHJvdWdoIHRoZSBkaXNwbGF5IGxpc3QuCiAqIEBwYXJhbSB7Qm9vbGVhbn0gY2FuY2VsYWJsZSBJbmRpY2F0ZXMgd2hldGhlciB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgb2YgdGhpcyBldmVudCBjYW4gYmUgY2FuY2VsbGVkLgogKiBAY29uc3RydWN0b3IKICoqLwp2YXIgRXZlbnQgPSBmdW5jdGlvbih0eXBlLCBidWJibGVzLCBjYW5jZWxhYmxlKSB7CiAgdGhpcy5pbml0aWFsaXplKHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpOwp9Owp2YXIgcCA9IEV2ZW50LnByb3RvdHlwZTsKRXZlbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRXZlbnQ7CgovLyBldmVudHM6CgovLyBwdWJsaWMgcHJvcGVydGllczoKCgkvKioKCSAqIFRoZSB0eXBlIG9mIGV2ZW50LgoJICogQHByb3BlcnR5IHR5cGUKCSAqIEB0eXBlIFN0cmluZwoJICoqLwoJcC50eXBlID0gbnVsbDsKCgkvKioKCSAqIFRoZSBvYmplY3QgdGhhdCBnZW5lcmF0ZWQgYW4gZXZlbnQuCgkgKiBAcHJvcGVydHkgdGFyZ2V0CgkgKiBAdHlwZSBPYmplY3QKCSAqIEBkZWZhdWx0IG51bGwKCSAqIEByZWFkb25seQoJKi8KCXAudGFyZ2V0ID0gbnVsbDsKCgkvKioKCSAqIFRoZSBjdXJyZW50IHRhcmdldCB0aGF0IGEgYnViYmxpbmcgZXZlbnQgaXMgYmVpbmcgZGlzcGF0Y2hlZCBmcm9tLiBGb3Igbm9uLWJ1YmJsaW5nIGV2ZW50cywgdGhpcyB3aWxsCgkgKiBhbHdheXMgYmUgdGhlIHNhbWUgYXMgdGFyZ2V0LiBGb3IgZXhhbXBsZSwgaWYgY2hpbGRPYmoucGFyZW50ID0gcGFyZW50T2JqLCBhbmQgYSBidWJibGluZyBldmVudAoJICogaXMgZ2VuZXJhdGVkIGZyb20gY2hpbGRPYmosIHRoZW4gYSBsaXN0ZW5lciBvbiBwYXJlbnRPYmogd291bGQgcmVjZWl2ZSB0aGUgZXZlbnQgd2l0aAoJICogdGFyZ2V0PWNoaWxkT2JqICh0aGUgb3JpZ2luYWwgdGFyZ2V0KSBhbmQgY3VycmVudFRhcmdldD1wYXJlbnRPYmogKHdoZXJlIHRoZSBsaXN0ZW5lciB3YXMgYWRkZWQpLgoJICogQHByb3BlcnR5IGN1cnJlbnRUYXJnZXQKCSAqIEB0eXBlIE9iamVjdAoJICogQGRlZmF1bHQgbnVsbAoJICogQHJlYWRvbmx5CgkqLwoJcC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKCgkvKioKCSAqIEZvciBidWJibGluZyBldmVudHMsIHRoaXMgaW5kaWNhdGVzIHRoZSBjdXJyZW50IGV2ZW50IHBoYXNlOjxPTD4KCSAqIAk8TEk+IGNhcHR1cmUgcGhhc2U6IHN0YXJ0aW5nIGZyb20gdGhlIHRvcCBwYXJlbnQgdG8gdGhlIHRhcmdldDwvTEk+CgkgKiAJPExJPiBhdCB0YXJnZXQgcGhhc2U6IGN1cnJlbnRseSBiZWluZyBkaXNwYXRjaGVkIGZyb20gdGhlIHRhcmdldDwvTEk+CgkgKiAJPExJPiBidWJibGluZyBwaGFzZTogZnJvbSB0aGUgdGFyZ2V0IHRvIHRoZSB0b3AgcGFyZW50PC9MST4KCSAqIDwvT0w+CgkgKiBAcHJvcGVydHkgZXZlbnRQaGFzZQoJICogQHR5cGUgTnVtYmVyCgkgKiBAZGVmYXVsdCAwCgkgKiBAcmVhZG9ubHkKCSovCglwLmV2ZW50UGhhc2UgPSAwOwoKCS8qKgoJICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGV2ZW50IHdpbGwgYnViYmxlIHRocm91Z2ggdGhlIGRpc3BsYXkgbGlzdC4KCSAqIEBwcm9wZXJ0eSBidWJibGVzCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHJlYWRvbmx5CgkqLwoJcC5idWJibGVzID0gZmFsc2U7CgoJLyoqCgkgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgb2YgdGhpcyBldmVudCBjYW4gYmUgY2FuY2VsbGVkIHZpYQoJICoge3sjY3Jvc3NMaW5rICJFdmVudC9wcmV2ZW50RGVmYXVsdCJ9fXt7L2Nyb3NzTGlua319LiBUaGlzIGlzIHNldCB2aWEgdGhlIEV2ZW50IGNvbnN0cnVjdG9yLgoJICogQHByb3BlcnR5IGNhbmNlbGFibGUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLmNhbmNlbGFibGUgPSBmYWxzZTsKCgkvKioKCSAqIFRoZSBlcG9jaCB0aW1lIGF0IHdoaWNoIHRoaXMgZXZlbnQgd2FzIGNyZWF0ZWQuCgkgKiBAcHJvcGVydHkgdGltZVN0YW1wCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqIEByZWFkb25seQoJKi8KCXAudGltZVN0YW1wID0gMDsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3ByZXZlbnREZWZhdWx0In19e3svY3Jvc3NMaW5rfX0gaGFzIGJlZW4gY2FsbGVkCgkgKiBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IGRlZmF1bHRQcmV2ZW50ZWQKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3N0b3BQcm9wYWdhdGlvbiJ9fXt7L2Nyb3NzTGlua319IG9yCgkgKiB7eyNjcm9zc0xpbmsgIkV2ZW50L3N0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiJ9fXt7L2Nyb3NzTGlua319IGhhcyBiZWVuIGNhbGxlZCBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IHByb3BhZ2F0aW9uU3RvcHBlZAoJICogQHR5cGUgQm9vbGVhbgoJICogQGRlZmF1bHQgZmFsc2UKCSAqIEByZWFkb25seQoJKi8KCXAucHJvcGFnYXRpb25TdG9wcGVkID0gZmFsc2U7CgoJLyoqCgkgKiBJbmRpY2F0ZXMgaWYge3sjY3Jvc3NMaW5rICJFdmVudC9zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24ifX17ey9jcm9zc0xpbmt9fSBoYXMgYmVlbiBjYWxsZWQKCSAqIG9uIHRoaXMgZXZlbnQuCgkgKiBAcHJvcGVydHkgaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHJlYWRvbmx5CgkqLwoJcC5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSBmYWxzZTsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3JlbW92ZSJ9fXt7L2Nyb3NzTGlua319IGhhcyBiZWVuIGNhbGxlZCBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IHJlbW92ZWQKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLnJlbW92ZWQgPSBmYWxzZTsKCi8vIGNvbnN0cnVjdG9yOgoJLyoqCgkgKiBJbml0aWFsaXphdGlvbiBtZXRob2QuCgkgKiBAbWV0aG9kIGluaXRpYWxpemUKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtCb29sZWFufSBidWJibGVzIEluZGljYXRlcyB3aGV0aGVyIHRoZSBldmVudCB3aWxsIGJ1YmJsZSB0aHJvdWdoIHRoZSBkaXNwbGF5IGxpc3QuCgkgKiBAcGFyYW0ge0Jvb2xlYW59IGNhbmNlbGFibGUgSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGRlZmF1bHQgYmVoYXZpb3VyIG9mIHRoaXMgZXZlbnQgY2FuIGJlIGNhbmNlbGxlZC4KCSAqIEBwcm90ZWN0ZWQKCSAqKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpIHsKCQl0aGlzLnR5cGUgPSB0eXBlOwoJCXRoaXMuYnViYmxlcyA9IGJ1YmJsZXM7CgkJdGhpcy5jYW5jZWxhYmxlID0gY2FuY2VsYWJsZTsKCQl0aGlzLnRpbWVTdGFtcCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7Cgl9OwoKLy8gcHVibGljIG1ldGhvZHM6CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvZGVmYXVsdFByZXZlbnRlZCJ9fXt7L2Nyb3NzTGlua319IHRvIHRydWUuCgkgKiBNaXJyb3JzIHRoZSBET00gZXZlbnQgc3RhbmRhcmQuCgkgKiBAbWV0aG9kIHByZXZlbnREZWZhdWx0CgkgKiovCglwLnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvcHJvcGFnYXRpb25TdG9wcGVkIn19e3svY3Jvc3NMaW5rfX0gdG8gdHJ1ZS4KCSAqIE1pcnJvcnMgdGhlIERPTSBldmVudCBzdGFuZGFyZC4KCSAqIEBtZXRob2Qgc3RvcFByb3BhZ2F0aW9uCgkgKiovCglwLnN0b3BQcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMucHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvcHJvcGFnYXRpb25TdG9wcGVkIn19e3svY3Jvc3NMaW5rfX0gYW5kCgkgKiB7eyNjcm9zc0xpbmsgIkV2ZW50L2ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCJ9fXt7L2Nyb3NzTGlua319IHRvIHRydWUuCgkgKiBNaXJyb3JzIHRoZSBET00gZXZlbnQgc3RhbmRhcmQuCgkgKiBAbWV0aG9kIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbgoJICoqLwoJcC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHRoaXMucHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBDYXVzZXMgdGhlIGFjdGl2ZSBsaXN0ZW5lciB0byBiZSByZW1vdmVkIHZpYSByZW1vdmVFdmVudExpc3RlbmVyKCk7CgkgKgoJICogCQlteUJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uKGV2dCkgewoJICogCQkJLy8gZG8gc3R1ZmYuLi4KCSAqIAkJCWV2dC5yZW1vdmUoKTsgLy8gcmVtb3ZlcyB0aGlzIGxpc3RlbmVyLgoJICogCQl9KTsKCSAqCgkgKiBAbWV0aG9kIHJlbW92ZQoJICoqLwoJcC5yZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl0aGlzLnJlbW92ZWQgPSB0cnVlOwoJfTsKCgkvKioKCSAqIFJldHVybnMgYSBjbG9uZSBvZiB0aGUgRXZlbnQgaW5zdGFuY2UuCgkgKiBAbWV0aG9kIGNsb25lCgkgKiBAcmV0dXJuIHtFdmVudH0gYSBjbG9uZSBvZiB0aGUgRXZlbnQgaW5zdGFuY2UuCgkgKiovCglwLmNsb25lID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIG5ldyBFdmVudCh0aGlzLnR5cGUsIHRoaXMuYnViYmxlcywgdGhpcy5jYW5jZWxhYmxlKTsKCX07CgoJLyoqCgkgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgoJICogQG1ldGhvZCB0b1N0cmluZwoJICogQHJldHVybiB7U3RyaW5nfSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCgkgKiovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICJbRXZlbnQgKHR5cGU9Iit0aGlzLnR5cGUrIildIjsKCX07CgpjcmVhdGVqcy5FdmVudCA9IEV2ZW50Owp9KCkpOwovKg0KKiBFdmVudERpc3BhdGNoZXINCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLg0KKg0KKiBDb3B5cmlnaHQgKGMpIDIwMTAgZ3NraW5uZXIuY29tLCBpbmMuDQoqDQoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uDQoqIG9idGFpbmluZyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uDQoqIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQNCiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsDQoqIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQoqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZQ0KKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZw0KKiBjb25kaXRpb25zOg0KKg0KKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQ0KKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4NCioNCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsDQoqIEVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUw0KKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORA0KKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVA0KKiBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwNCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HDQoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1INCiogT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLg0KKi8NCg0KLyoqDQogKiBAbW9kdWxlIENyZWF0ZUpTDQogKi8NCg0KLy8gbmFtZXNwYWNlOg0KdGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9Ow0KDQooZnVuY3Rpb24oKSB7DQoJInVzZSBzdHJpY3QiOw0KDQovKioNCiAqIEV2ZW50RGlzcGF0Y2hlciBwcm92aWRlcyBtZXRob2RzIGZvciBtYW5hZ2luZyBxdWV1ZXMgb2YgZXZlbnQgbGlzdGVuZXJzIGFuZCBkaXNwYXRjaGluZyBldmVudHMuDQogKg0KICogWW91IGNhbiBlaXRoZXIgZXh0ZW5kIEV2ZW50RGlzcGF0Y2hlciBvciBtaXggaXRzIG1ldGhvZHMgaW50byBhbiBleGlzdGluZyBwcm90b3R5cGUgb3IgaW5zdGFuY2UgYnkgdXNpbmcgdGhlDQogKiBFdmVudERpc3BhdGNoZXIge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvaW5pdGlhbGl6ZSJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4NCiAqIA0KICogVG9nZXRoZXIgd2l0aCB0aGUgQ3JlYXRlSlMgRXZlbnQgY2xhc3MsIEV2ZW50RGlzcGF0Y2hlciBwcm92aWRlcyBhbiBleHRlbmRlZCBldmVudCBtb2RlbCB0aGF0IGlzIGJhc2VkIG9uIHRoZQ0KICogRE9NIExldmVsIDIgZXZlbnQgbW9kZWwsIGluY2x1ZGluZyBhZGRFdmVudExpc3RlbmVyLCByZW1vdmVFdmVudExpc3RlbmVyLCBhbmQgZGlzcGF0Y2hFdmVudC4gSXQgc3VwcG9ydHMNCiAqIGJ1YmJsaW5nIC8gY2FwdHVyZSwgcHJldmVudERlZmF1bHQsIHN0b3BQcm9wYWdhdGlvbiwgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uLCBhbmQgaGFuZGxlRXZlbnQuDQogKiANCiAqIEV2ZW50RGlzcGF0Y2hlciBhbHNvIGV4cG9zZXMgYSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9vbiJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCwgd2hpY2ggbWFrZXMgaXQgZWFzaWVyDQogKiB0byBjcmVhdGUgc2NvcGVkIGxpc3RlbmVycywgbGlzdGVuZXJzIHRoYXQgb25seSBydW4gb25jZSwgYW5kIGxpc3RlbmVycyB3aXRoIGFzc29jaWF0ZWQgYXJiaXRyYXJ5IGRhdGEuIFRoZSANCiAqIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL29mZiJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCBpcyBtZXJlbHkgYW4gYWxpYXMgdG8NCiAqIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL3JlbW92ZUV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fS4NCiAqIA0KICogQW5vdGhlciBhZGRpdGlvbiB0byB0aGUgRE9NIExldmVsIDIgbW9kZWwgaXMgdGhlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL3JlbW92ZUFsbEV2ZW50TGlzdGVuZXJzIn19e3svY3Jvc3NMaW5rfX0NCiAqIG1ldGhvZCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gbGlzdGVuZXJzIGZvciBhbGwgZXZlbnRzLCBvciBsaXN0ZW5lcnMgZm9yIGEgc3BlY2lmaWMgZXZlbnQuIFRoZSBFdmVudCBvYmplY3QgYWxzbyANCiAqIGluY2x1ZGVzIGEge3sjY3Jvc3NMaW5rICJFdmVudC9yZW1vdmUifX17ey9jcm9zc0xpbmt9fSBtZXRob2Qgd2hpY2ggcmVtb3ZlcyB0aGUgYWN0aXZlIGxpc3RlbmVyLg0KICoNCiAqIDxoND5FeGFtcGxlPC9oND4NCiAqIEFkZCBFdmVudERpc3BhdGNoZXIgY2FwYWJpbGl0aWVzIHRvIHRoZSAiTXlDbGFzcyIgY2xhc3MuDQogKg0KICogICAgICBFdmVudERpc3BhdGNoZXIuaW5pdGlhbGl6ZShNeUNsYXNzLnByb3RvdHlwZSk7DQogKg0KICogQWRkIGFuIGV2ZW50IChzZWUge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319KS4NCiAqDQogKiAgICAgIGluc3RhbmNlLmFkZEV2ZW50TGlzdGVuZXIoImV2ZW50TmFtZSIsIGhhbmRsZXJNZXRob2QpOw0KICogICAgICBmdW5jdGlvbiBoYW5kbGVyTWV0aG9kKGV2ZW50KSB7DQogKiAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC50YXJnZXQgKyAiIFdhcyBDbGlja2VkIik7DQogKiAgICAgIH0NCiAqDQogKiA8Yj5NYWludGFpbmluZyBwcm9wZXIgc2NvcGU8L2I+PGJyIC8+DQogKiBTY29wZSAoaWUuICJ0aGlzIikgY2FuIGJlIGJlIGEgY2hhbGxlbmdlIHdpdGggZXZlbnRzLiBVc2luZyB0aGUge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvb24ifX17ey9jcm9zc0xpbmt9fQ0KICogbWV0aG9kIHRvIHN1YnNjcmliZSB0byBldmVudHMgc2ltcGxpZmllcyB0aGlzLg0KICoNCiAqICAgICAgaW5zdGFuY2UuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbihldmVudCkgew0KICogICAgICAgICAgY29uc29sZS5sb2coaW5zdGFuY2UgPT0gdGhpcyk7IC8vIGZhbHNlLCBzY29wZSBpcyBhbWJpZ3VvdXMuDQogKiAgICAgIH0pOw0KICogICAgICANCiAqICAgICAgaW5zdGFuY2Uub24oImNsaWNrIiwgZnVuY3Rpb24oZXZlbnQpIHsNCiAqICAgICAgICAgIGNvbnNvbGUubG9nKGluc3RhbmNlID09IHRoaXMpOyAvLyB0cnVlLCAib24iIHVzZXMgZGlzcGF0Y2hlciBzY29wZSBieSBkZWZhdWx0Lg0KICogICAgICB9KTsNCiAqIA0KICogSWYgeW91IHdhbnQgdG8gdXNlIGFkZEV2ZW50TGlzdGVuZXIgaW5zdGVhZCwgeW91IG1heSB3YW50IHRvIHVzZSBmdW5jdGlvbi5iaW5kKCkgb3IgYSBzaW1pbGFyIHByb3h5IHRvIG1hbmFnZSBzY29wZS4NCiAqICAgICAgDQogKg0KICogQGNsYXNzIEV2ZW50RGlzcGF0Y2hlcg0KICogQGNvbnN0cnVjdG9yDQogKiovDQp2YXIgRXZlbnREaXNwYXRjaGVyID0gZnVuY3Rpb24oKSB7DQovKgl0aGlzLmluaXRpYWxpemUoKTsgKi8gLy8gbm90IG5lZWRlZC4NCn07DQp2YXIgcCA9IEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGU7DQpFdmVudERpc3BhdGNoZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRXZlbnREaXNwYXRjaGVyOw0KDQoNCgkvKioNCgkgKiBTdGF0aWMgaW5pdGlhbGl6ZXIgdG8gbWl4IEV2ZW50RGlzcGF0Y2hlciBtZXRob2RzIGludG8gYSB0YXJnZXQgb2JqZWN0IG9yIHByb3RvdHlwZS4NCgkgKiANCgkgKiAJCUV2ZW50RGlzcGF0Y2hlci5pbml0aWFsaXplKE15Q2xhc3MucHJvdG90eXBlKTsgLy8gYWRkIHRvIHRoZSBwcm90b3R5cGUgb2YgdGhlIGNsYXNzDQoJICogCQlFdmVudERpc3BhdGNoZXIuaW5pdGlhbGl6ZShteU9iamVjdCk7IC8vIGFkZCB0byBhIHNwZWNpZmljIGluc3RhbmNlDQoJICogDQoJICogQG1ldGhvZCBpbml0aWFsaXplDQoJICogQHN0YXRpYw0KCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvYmplY3QgdG8gaW5qZWN0IEV2ZW50RGlzcGF0Y2hlciBtZXRob2RzIGludG8uIFRoaXMgY2FuIGJlIGFuIGluc3RhbmNlIG9yIGENCgkgKiBwcm90b3R5cGUuDQoJICoqLw0KCUV2ZW50RGlzcGF0Y2hlci5pbml0aWFsaXplID0gZnVuY3Rpb24odGFyZ2V0KSB7DQoJCXRhcmdldC5hZGRFdmVudExpc3RlbmVyID0gcC5hZGRFdmVudExpc3RlbmVyOw0KCQl0YXJnZXQub24gPSBwLm9uOw0KCQl0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHRhcmdldC5vZmYgPSAgcC5yZW1vdmVFdmVudExpc3RlbmVyOw0KCQl0YXJnZXQucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMgPSBwLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzOw0KCQl0YXJnZXQuaGFzRXZlbnRMaXN0ZW5lciA9IHAuaGFzRXZlbnRMaXN0ZW5lcjsNCgkJdGFyZ2V0LmRpc3BhdGNoRXZlbnQgPSBwLmRpc3BhdGNoRXZlbnQ7DQoJCXRhcmdldC5fZGlzcGF0Y2hFdmVudCA9IHAuX2Rpc3BhdGNoRXZlbnQ7DQoJCXRhcmdldC53aWxsVHJpZ2dlciA9IHAud2lsbFRyaWdnZXI7DQoJfTsNCgkNCi8vIGNvbnN0cnVjdG9yOg0KDQovLyBwcml2YXRlIHByb3BlcnRpZXM6DQoJLyoqDQoJICogQHByb3RlY3RlZA0KCSAqIEBwcm9wZXJ0eSBfbGlzdGVuZXJzDQoJICogQHR5cGUgT2JqZWN0DQoJICoqLw0KCXAuX2xpc3RlbmVycyA9IG51bGw7DQoNCgkvKioNCgkgKiBAcHJvdGVjdGVkDQoJICogQHByb3BlcnR5IF9jYXB0dXJlTGlzdGVuZXJzDQoJICogQHR5cGUgT2JqZWN0DQoJICoqLw0KCXAuX2NhcHR1cmVMaXN0ZW5lcnMgPSBudWxsOw0KDQovLyBjb25zdHJ1Y3RvcjoNCgkvKioNCgkgKiBJbml0aWFsaXphdGlvbiBtZXRob2QuDQoJICogQG1ldGhvZCBpbml0aWFsaXplDQoJICogQHByb3RlY3RlZA0KCSAqKi8NCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHt9Ow0KDQovLyBwdWJsaWMgbWV0aG9kczoNCgkvKioNCgkgKiBBZGRzIHRoZSBzcGVjaWZpZWQgZXZlbnQgbGlzdGVuZXIuIE5vdGUgdGhhdCBhZGRpbmcgbXVsdGlwbGUgbGlzdGVuZXJzIHRvIHRoZSBzYW1lIGZ1bmN0aW9uIHdpbGwgcmVzdWx0IGluDQoJICogbXVsdGlwbGUgY2FsbGJhY2tzIGdldHRpbmcgZmlyZWQuDQoJICoNCgkgKiA8aDQ+RXhhbXBsZTwvaDQ+DQoJICoNCgkgKiAgICAgIGRpc3BsYXlPYmplY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBoYW5kbGVDbGljayk7DQoJICogICAgICBmdW5jdGlvbiBoYW5kbGVDbGljayhldmVudCkgew0KCSAqICAgICAgICAgLy8gQ2xpY2sgaGFwcGVuZWQuDQoJICogICAgICB9DQoJICoNCgkgKiBAbWV0aG9kIGFkZEV2ZW50TGlzdGVuZXINCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEBwYXJhbSB7RnVuY3Rpb24gfCBPYmplY3R9IGxpc3RlbmVyIEFuIG9iamVjdCB3aXRoIGEgaGFuZGxlRXZlbnQgbWV0aG9kLCBvciBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbg0KCSAqIHRoZSBldmVudCBpcyBkaXNwYXRjaGVkLg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmVdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiBAcmV0dXJuIHtGdW5jdGlvbiB8IE9iamVjdH0gUmV0dXJucyB0aGUgbGlzdGVuZXIgZm9yIGNoYWluaW5nIG9yIGFzc2lnbm1lbnQuDQoJICoqLw0KCXAuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlKSB7DQoJCXZhciBsaXN0ZW5lcnM7DQoJCWlmICh1c2VDYXB0dXJlKSB7DQoJCQlsaXN0ZW5lcnMgPSB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzID0gdGhpcy5fY2FwdHVyZUxpc3RlbmVyc3x8e307DQoJCX0gZWxzZSB7DQoJCQlsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnN8fHt9Ow0KCQl9DQoJCXZhciBhcnIgPSBsaXN0ZW5lcnNbdHlwZV07DQoJCWlmIChhcnIpIHsgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlKTsgfQ0KCQlhcnIgPSBsaXN0ZW5lcnNbdHlwZV07IC8vIHJlbW92ZSBtYXkgaGF2ZSBkZWxldGVkIHRoZSBhcnJheQ0KCQlpZiAoIWFycikgeyBsaXN0ZW5lcnNbdHlwZV0gPSBbbGlzdGVuZXJdOyAgfQ0KCQllbHNlIHsgYXJyLnB1c2gobGlzdGVuZXIpOyB9DQoJCXJldHVybiBsaXN0ZW5lcjsNCgl9Ow0KCQ0KCS8qKg0KCSAqIEEgc2hvcnRjdXQgbWV0aG9kIGZvciB1c2luZyBhZGRFdmVudExpc3RlbmVyIHRoYXQgbWFrZXMgaXQgZWFzaWVyIHRvIHNwZWNpZnkgYW4gZXhlY3V0aW9uIHNjb3BlLCBoYXZlIGEgbGlzdGVuZXINCgkgKiBvbmx5IHJ1biBvbmNlLCBhc3NvY2lhdGUgYXJiaXRyYXJ5IGRhdGEgd2l0aCB0aGUgbGlzdGVuZXIsIGFuZCByZW1vdmUgdGhlIGxpc3RlbmVyLg0KCSAqIA0KCSAqIFRoaXMgbWV0aG9kIHdvcmtzIGJ5IGNyZWF0aW5nIGFuIGFub255bW91cyB3cmFwcGVyIGZ1bmN0aW9uIGFuZCBzdWJzY3JpYmluZyBpdCB3aXRoIGFkZEV2ZW50TGlzdGVuZXIuDQoJICogVGhlIGNyZWF0ZWQgYW5vbnltb3VzIGZ1bmN0aW9uIGlzIHJldHVybmVkIGZvciB1c2Ugd2l0aCAucmVtb3ZlRXZlbnRMaXN0ZW5lciAob3IgLm9mZikuDQoJICogDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqIA0KCSAqIAkJdmFyIGxpc3RlbmVyID0gbXlCdG4ub24oImNsaWNrIiwgaGFuZGxlQ2xpY2ssIG51bGwsIGZhbHNlLCB7Y291bnQ6M30pOw0KCSAqIAkJZnVuY3Rpb24gaGFuZGxlQ2xpY2soZXZ0LCBkYXRhKSB7DQoJICogCQkJZGF0YS5jb3VudCAtPSAxOw0KCSAqIAkJCWNvbnNvbGUubG9nKHRoaXMgPT0gbXlCdG4pOyAvLyB0cnVlIC0gc2NvcGUgZGVmYXVsdHMgdG8gdGhlIGRpc3BhdGNoZXINCgkgKiAJCQlpZiAoZGF0YS5jb3VudCA9PSAwKSB7DQoJICogCQkJCWFsZXJ0KCJjbGlja2VkIDMgdGltZXMhIik7DQoJICogCQkJCW15QnRuLm9mZigiY2xpY2siLCBsaXN0ZW5lcik7DQoJICogCQkJCS8vIGFsdGVybmF0ZWx5OiBldnQucmVtb3ZlKCk7DQoJICogCQkJfQ0KCSAqIAkJfQ0KCSAqIA0KCSAqIEBtZXRob2Qgb24NCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEBwYXJhbSB7RnVuY3Rpb24gfCBPYmplY3R9IGxpc3RlbmVyIEFuIG9iamVjdCB3aXRoIGEgaGFuZGxlRXZlbnQgbWV0aG9kLCBvciBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbg0KCSAqIHRoZSBldmVudCBpcyBkaXNwYXRjaGVkLg0KCSAqIEBwYXJhbSB7T2JqZWN0fSBbc2NvcGVdIFRoZSBzY29wZSB0byBleGVjdXRlIHRoZSBsaXN0ZW5lciBpbi4gRGVmYXVsdHMgdG8gdGhlIGRpc3BhdGNoZXIvY3VycmVudFRhcmdldCBmb3IgZnVuY3Rpb24gbGlzdGVuZXJzLCBhbmQgdG8gdGhlIGxpc3RlbmVyIGl0c2VsZiBmb3Igb2JqZWN0IGxpc3RlbmVycyAoaWUuIHVzaW5nIGhhbmRsZUV2ZW50KS4NCgkgKiBAcGFyYW0ge0Jvb2xlYW59IFtvbmNlPWZhbHNlXSBJZiB0cnVlLCB0aGUgbGlzdGVuZXIgd2lsbCByZW1vdmUgaXRzZWxmIGFmdGVyIHRoZSBmaXJzdCB0aW1lIGl0IGlzIHRyaWdnZXJlZC4NCgkgKiBAcGFyYW0geyp9IFtkYXRhXSBBcmJpdHJhcnkgZGF0YSB0aGF0IHdpbGwgYmUgaW5jbHVkZWQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgd2hlbiB0aGUgbGlzdGVuZXIgaXMgY2FsbGVkLg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmU9ZmFsc2VdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYW5vbnltb3VzIGZ1bmN0aW9uIHRoYXQgd2FzIGNyZWF0ZWQgYW5kIGFzc2lnbmVkIGFzIHRoZSBsaXN0ZW5lci4gVGhpcyBpcyBuZWVkZWQgdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lciBsYXRlciB1c2luZyAucmVtb3ZlRXZlbnRMaXN0ZW5lci4NCgkgKiovDQoJcC5vbiA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyLCBzY29wZSwgb25jZSwgZGF0YSwgdXNlQ2FwdHVyZSkgew0KCQlpZiAobGlzdGVuZXIuaGFuZGxlRXZlbnQpIHsNCgkJCXNjb3BlID0gc2NvcGV8fGxpc3RlbmVyOw0KCQkJbGlzdGVuZXIgPSBsaXN0ZW5lci5oYW5kbGVFdmVudDsNCgkJfQ0KCQlzY29wZSA9IHNjb3BlfHx0aGlzOw0KCQlyZXR1cm4gdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKGV2dCkgew0KCQkJCWxpc3RlbmVyLmNhbGwoc2NvcGUsIGV2dCwgZGF0YSk7DQoJCQkJb25jZSYmZXZ0LnJlbW92ZSgpOw0KCQkJfSwgdXNlQ2FwdHVyZSk7DQoJfTsNCg0KCS8qKg0KCSAqIFJlbW92ZXMgdGhlIHNwZWNpZmllZCBldmVudCBsaXN0ZW5lci4NCgkgKg0KCSAqIDxiPkltcG9ydGFudCBOb3RlOjwvYj4gdGhhdCB5b3UgbXVzdCBwYXNzIHRoZSBleGFjdCBmdW5jdGlvbiByZWZlcmVuY2UgdXNlZCB3aGVuIHRoZSBldmVudCB3YXMgYWRkZWQuIElmIGEgcHJveHkNCgkgKiBmdW5jdGlvbiwgb3IgZnVuY3Rpb24gY2xvc3VyZSBpcyB1c2VkIGFzIHRoZSBjYWxsYmFjaywgdGhlIHByb3h5L2Nsb3N1cmUgcmVmZXJlbmNlIG11c3QgYmUgdXNlZCAtIGEgbmV3IHByb3h5IG9yDQoJICogY2xvc3VyZSB3aWxsIG5vdCB3b3JrLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICBkaXNwbGF5T2JqZWN0LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgaGFuZGxlQ2xpY2spOw0KCSAqDQoJICogQG1ldGhvZCByZW1vdmVFdmVudExpc3RlbmVyDQoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHN0cmluZyB0eXBlIG9mIHRoZSBldmVudC4NCgkgKiBAcGFyYW0ge0Z1bmN0aW9uIHwgT2JqZWN0fSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIgZnVuY3Rpb24gb3Igb2JqZWN0Lg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmVdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiovDQoJcC5yZW1vdmVFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIsIHVzZUNhcHR1cmUpIHsNCgkJdmFyIGxpc3RlbmVycyA9IHVzZUNhcHR1cmUgPyB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzIDogdGhpcy5fbGlzdGVuZXJzOw0KCQlpZiAoIWxpc3RlbmVycykgeyByZXR1cm47IH0NCgkJdmFyIGFyciA9IGxpc3RlbmVyc1t0eXBlXTsNCgkJaWYgKCFhcnIpIHsgcmV0dXJuOyB9DQoJCWZvciAodmFyIGk9MCxsPWFyci5sZW5ndGg7IGk8bDsgaSsrKSB7DQoJCQlpZiAoYXJyW2ldID09IGxpc3RlbmVyKSB7DQoJCQkJaWYgKGw9PTEpIHsgZGVsZXRlKGxpc3RlbmVyc1t0eXBlXSk7IH0gLy8gYWxsb3dzIGZvciBmYXN0ZXIgY2hlY2tzLg0KCQkJCWVsc2UgeyBhcnIuc3BsaWNlKGksMSk7IH0NCgkJCQlicmVhazsNCgkJCX0NCgkJfQ0KCX07DQoJDQoJLyoqDQoJICogQSBzaG9ydGN1dCB0byB0aGUgcmVtb3ZlRXZlbnRMaXN0ZW5lciBtZXRob2QsIHdpdGggdGhlIHNhbWUgcGFyYW1ldGVycyBhbmQgcmV0dXJuIHZhbHVlLiBUaGlzIGlzIGEgY29tcGFuaW9uIHRvIHRoZQ0KCSAqIC5vbiBtZXRob2QuDQoJICoNCgkgKiBAbWV0aG9kIG9mZg0KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuDQoJICogQHBhcmFtIHtGdW5jdGlvbiB8IE9iamVjdH0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIG9yIG9iamVjdC4NCgkgKiBAcGFyYW0ge0Jvb2xlYW59IFt1c2VDYXB0dXJlXSBGb3IgZXZlbnRzIHRoYXQgYnViYmxlLCBpbmRpY2F0ZXMgd2hldGhlciB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBpbiB0aGUgY2FwdHVyZSBvciBidWJibGluZy90YXJnZXQgcGhhc2UuDQoJICoqLw0KCXAub2ZmID0gcC5yZW1vdmVFdmVudExpc3RlbmVyOw0KDQoJLyoqDQoJICogUmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGZvciB0aGUgc3BlY2lmaWVkIHR5cGUsIG9yIGFsbCBsaXN0ZW5lcnMgb2YgYWxsIHR5cGVzLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICAvLyBSZW1vdmUgYWxsIGxpc3RlbmVycw0KCSAqICAgICAgZGlzcGxheU9iamVjdC5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOw0KCSAqDQoJICogICAgICAvLyBSZW1vdmUgYWxsIGNsaWNrIGxpc3RlbmVycw0KCSAqICAgICAgZGlzcGxheU9iamVjdC5yZW1vdmVBbGxFdmVudExpc3RlbmVycygiY2xpY2siKTsNCgkgKg0KCSAqIEBtZXRob2QgcmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMNCgkgKiBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuIElmIG9taXR0ZWQsIGFsbCBsaXN0ZW5lcnMgZm9yIGFsbCB0eXBlcyB3aWxsIGJlIHJlbW92ZWQuDQoJICoqLw0KCXAucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7DQoJCWlmICghdHlwZSkgeyB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzID0gbnVsbDsgfQ0KCQllbHNlIHsNCgkJCWlmICh0aGlzLl9saXN0ZW5lcnMpIHsgZGVsZXRlKHRoaXMuX2xpc3RlbmVyc1t0eXBlXSk7IH0NCgkJCWlmICh0aGlzLl9jYXB0dXJlTGlzdGVuZXJzKSB7IGRlbGV0ZSh0aGlzLl9jYXB0dXJlTGlzdGVuZXJzW3R5cGVdKTsgfQ0KCQl9DQoJfTsNCg0KCS8qKg0KCSAqIERpc3BhdGNoZXMgdGhlIHNwZWNpZmllZCBldmVudCB0byBhbGwgbGlzdGVuZXJzLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICAvLyBVc2UgYSBzdHJpbmcgZXZlbnQNCgkgKiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgiY29tcGxldGUiKTsNCgkgKg0KCSAqICAgICAgLy8gVXNlIGFuIEV2ZW50IGluc3RhbmNlDQoJICogICAgICB2YXIgZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoInByb2dyZXNzIik7DQoJICogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpOw0KCSAqDQoJICogQG1ldGhvZCBkaXNwYXRjaEV2ZW50DQoJICogQHBhcmFtIHtPYmplY3QgfCBTdHJpbmcgfCBFdmVudH0gZXZlbnRPYmogQW4gb2JqZWN0IHdpdGggYSAidHlwZSIgcHJvcGVydHksIG9yIGEgc3RyaW5nIHR5cGUuDQoJICogV2hpbGUgYSBnZW5lcmljIG9iamVjdCB3aWxsIHdvcmssIGl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBhIENyZWF0ZUpTIEV2ZW50IGluc3RhbmNlLiBJZiBhIHN0cmluZyBpcyB1c2VkLA0KCSAqIGRpc3BhdGNoRXZlbnQgd2lsbCBjb25zdHJ1Y3QgYW4gRXZlbnQgaW5zdGFuY2Ugd2l0aCB0aGUgc3BlY2lmaWVkIHR5cGUuDQoJICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyB0aGUgdmFsdWUgb2YgZXZlbnRPYmouZGVmYXVsdFByZXZlbnRlZC4NCgkgKiovDQoJcC5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnRPYmopIHsNCgkJaWYgKHR5cGVvZiBldmVudE9iaiA9PSAic3RyaW5nIikgew0KCQkJLy8gd29uJ3QgYnViYmxlLCBzbyBza2lwIGV2ZXJ5dGhpbmcgaWYgdGhlcmUncyBubyBsaXN0ZW5lcnM6DQoJCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOw0KCQkJaWYgKCFsaXN0ZW5lcnMgfHwgIWxpc3RlbmVyc1tldmVudE9ial0pIHsgcmV0dXJuIGZhbHNlOyB9DQoJCQlldmVudE9iaiA9IG5ldyBjcmVhdGVqcy5FdmVudChldmVudE9iaik7DQoJCX0gZWxzZSBpZiAoZXZlbnRPYmoudGFyZ2V0ICYmIGV2ZW50T2JqLmNsb25lKSB7DQoJCQkvLyByZWRpc3BhdGNoaW5nIGFuIGFjdGl2ZSBldmVudCBvYmplY3QsIHNvIGNsb25lIGl0Og0KCQkJZXZlbnRPYmogPSBldmVudE9iai5jbG9uZSgpOw0KCQl9DQoJCXRyeSB7IGV2ZW50T2JqLnRhcmdldCA9IHRoaXM7IH0gY2F0Y2ggKGUpIHt9IC8vIHRyeS9jYXRjaCBhbGxvd3MgcmVkaXNwYXRjaGluZyBvZiBuYXRpdmUgZXZlbnRzDQoNCgkJaWYgKCFldmVudE9iai5idWJibGVzIHx8ICF0aGlzLnBhcmVudCkgew0KCQkJdGhpcy5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMik7DQoJCX0gZWxzZSB7DQoJCQl2YXIgdG9wPXRoaXMsIGxpc3Q9W3RvcF07DQoJCQl3aGlsZSAodG9wLnBhcmVudCkgeyBsaXN0LnB1c2godG9wID0gdG9wLnBhcmVudCk7IH0NCgkJCXZhciBpLCBsPWxpc3QubGVuZ3RoOw0KDQoJCQkvLyBjYXB0dXJlICYgYXRUYXJnZXQNCgkJCWZvciAoaT1sLTE7IGk+PTAgJiYgIWV2ZW50T2JqLnByb3BhZ2F0aW9uU3RvcHBlZDsgaS0tKSB7DQoJCQkJbGlzdFtpXS5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMSsoaT09MCkpOw0KCQkJfQ0KCQkJLy8gYnViYmxpbmcNCgkJCWZvciAoaT0xOyBpPGwgJiYgIWV2ZW50T2JqLnByb3BhZ2F0aW9uU3RvcHBlZDsgaSsrKSB7DQoJCQkJbGlzdFtpXS5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMyk7DQoJCQl9DQoJCX0NCgkJcmV0dXJuIGV2ZW50T2JqLmRlZmF1bHRQcmV2ZW50ZWQ7DQoJfTsNCg0KCS8qKg0KCSAqIEluZGljYXRlcyB3aGV0aGVyIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudCB0eXBlLg0KCSAqIEBtZXRob2QgaGFzRXZlbnRMaXN0ZW5lcg0KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuDQoJICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudC4NCgkgKiovDQoJcC5oYXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSkgew0KCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzLCBjYXB0dXJlTGlzdGVuZXJzID0gdGhpcy5fY2FwdHVyZUxpc3RlbmVyczsNCgkJcmV0dXJuICEhKChsaXN0ZW5lcnMgJiYgbGlzdGVuZXJzW3R5cGVdKSB8fCAoY2FwdHVyZUxpc3RlbmVycyAmJiBjYXB0dXJlTGlzdGVuZXJzW3R5cGVdKSk7DQoJfTsNCgkNCgkvKioNCgkgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgbGlzdGVuZXIgZm9yIHRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBvbiB0aGlzIG9iamVjdCBvciBhbnkgb2YgaXRzDQoJICogYW5jZXN0b3JzIChwYXJlbnQsIHBhcmVudCdzIHBhcmVudCwgZXRjKS4gQSByZXR1cm4gdmFsdWUgb2YgdHJ1ZSBpbmRpY2F0ZXMgdGhhdCBpZiBhIGJ1YmJsaW5nIGV2ZW50IG9mIHRoZQ0KCSAqIHNwZWNpZmllZCB0eXBlIGlzIGRpc3BhdGNoZWQgZnJvbSB0aGlzIG9iamVjdCwgaXQgd2lsbCB0cmlnZ2VyIGF0IGxlYXN0IG9uZSBsaXN0ZW5lci4NCgkgKiANCgkgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvaGFzRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319LCBidXQgaXQgc2VhcmNoZXMgdGhlIGVudGlyZQ0KCSAqIGV2ZW50IGZsb3cgZm9yIGEgbGlzdGVuZXIsIG5vdCBqdXN0IHRoaXMgb2JqZWN0Lg0KCSAqIEBtZXRob2Qgd2lsbFRyaWdnZXINCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEByZXR1cm4ge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudC4NCgkgKiovDQoJcC53aWxsVHJpZ2dlciA9IGZ1bmN0aW9uKHR5cGUpIHsNCgkJdmFyIG8gPSB0aGlzOw0KCQl3aGlsZSAobykgew0KCQkJaWYgKG8uaGFzRXZlbnRMaXN0ZW5lcih0eXBlKSkgeyByZXR1cm4gdHJ1ZTsgfQ0KCQkJbyA9IG8ucGFyZW50Ow0KCQl9DQoJCXJldHVybiBmYWxzZTsNCgl9Ow0KDQoJLyoqDQoJICogQG1ldGhvZCB0b1N0cmluZw0KCSAqIEByZXR1cm4ge1N0cmluZ30gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLg0KCSAqKi8NCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7DQoJCXJldHVybiAiW0V2ZW50RGlzcGF0Y2hlcl0iOw0KCX07DQoNCi8vIHByaXZhdGUgbWV0aG9kczoNCgkvKioNCgkgKiBAbWV0aG9kIF9kaXNwYXRjaEV2ZW50DQoJICogQHBhcmFtIHtPYmplY3QgfCBTdHJpbmcgfCBFdmVudH0gZXZlbnRPYmoNCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnRQaGFzZQ0KCSAqIEBwcm90ZWN0ZWQNCgkgKiovDQoJcC5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGV2ZW50T2JqLCBldmVudFBoYXNlKSB7DQoJCXZhciBsLCBsaXN0ZW5lcnMgPSAoZXZlbnRQaGFzZT09MSkgPyB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzIDogdGhpcy5fbGlzdGVuZXJzOw0KCQlpZiAoZXZlbnRPYmogJiYgbGlzdGVuZXJzKSB7DQoJCQl2YXIgYXJyID0gbGlzdGVuZXJzW2V2ZW50T2JqLnR5cGVdOw0KCQkJaWYgKCFhcnJ8fCEobD1hcnIubGVuZ3RoKSkgeyByZXR1cm47IH0NCgkJCXRyeSB7IGV2ZW50T2JqLmN1cnJlbnRUYXJnZXQgPSB0aGlzOyB9IGNhdGNoIChlKSB7fQ0KCQkJdHJ5IHsgZXZlbnRPYmouZXZlbnRQaGFzZSA9IGV2ZW50UGhhc2U7IH0gY2F0Y2ggKGUpIHt9DQoJCQlldmVudE9iai5yZW1vdmVkID0gZmFsc2U7DQoJCQlhcnIgPSBhcnIuc2xpY2UoKTsgLy8gdG8gYXZvaWQgaXNzdWVzIHdpdGggaXRlbXMgYmVpbmcgcmVtb3ZlZCBvciBhZGRlZCBkdXJpbmcgdGhlIGRpc3BhdGNoDQoJCQlmb3IgKHZhciBpPTA7IGk8bCAmJiAhZXZlbnRPYmouaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOyBpKyspIHsNCgkJCQl2YXIgbyA9IGFycltpXTsNCgkJCQlpZiAoby5oYW5kbGVFdmVudCkgeyBvLmhhbmRsZUV2ZW50KGV2ZW50T2JqKTsgfQ0KCQkJCWVsc2UgeyBvKGV2ZW50T2JqKTsgfQ0KCQkJCWlmIChldmVudE9iai5yZW1vdmVkKSB7DQoJCQkJCXRoaXMub2ZmKGV2ZW50T2JqLnR5cGUsIG8sIGV2ZW50UGhhc2U9PTEpOw0KCQkJCQlldmVudE9iai5yZW1vdmVkID0gZmFsc2U7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfTsNCg0KDQpjcmVhdGVqcy5FdmVudERpc3BhdGNoZXIgPSBFdmVudERpc3BhdGNoZXI7DQp9KCkpOw0KLyoKKiBJbmRleE9mCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCiogQ29weXJpZ2h0IChjKSAyMDEwIGdza2lubmVyLmNvbSwgaW5jLgoqIAoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CiogCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKiAKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoqIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCiogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiogRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUgoqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KKi8KCi8qKgogICogQG1vZHVsZSBDcmVhdGVKUwogKi8KCi8vIG5hbWVzcGFjZToKdGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9OwoKLyoqCiAqIEBjbGFzcyBVdGlsaXR5IE1ldGhvZHMKICovCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKgoJICogRW1wbG95cyBEdWZmJ3MgRGV2aWNlIHRvIG1ha2UgYSBtb3JlIHBlcmZvcm1hbnQgaW1wbGVtZW50YXRpb24gb2YgaW5kZXhPZi4KCSAqIHNlZSBodHRwOi8vanNwZXJmLmNvbS9kdWZmcy1pbmRleG9mLzIKCSAqICNtZXRob2QgaW5kZXhPZgoJICogQHBhcmFtIHtBcnJheX0gYXJyYXkgQXJyYXkgdG8gc2VhcmNoIGZvciBzZWFyY2hFbGVtZW50CgkgKiBAcGFyYW0gc2VhcmNoRWxlbWVudCBFbGVtZW50IHRvIHNlYXJjaCBhcnJheSBmb3IuCgkgKiBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIHNwZWNpZmllZCB2YWx1ZSBzZWFyY2hFbGVtZW50IGluIHRoZSBwYXNzZWQgaW4gYXJyYXkgYXIuCgkgKiBAY29uc3RydWN0b3IKCSAqLwoJLyogcmVwbGFjZWQgd2l0aCBzaW1wbGUgZm9yIGxvb3AgZm9yIG5vdywgcGVyaGFwcyB3aWxsIGJlIHJlc2VhcmNoZWQgZnVydGhlcgoJY3JlYXRlanMuaW5kZXhPZiA9IGZ1bmN0aW9uIChhciwgc2VhcmNoRWxlbWVudCkgewoJCXZhciBsID0gYXIubGVuZ3RoOwoKCQl2YXIgbiA9IChsICogMC4xMjUpIF4gMDsJLy8gMC4xMjUgPT0gMS84LCB1c2luZyBtdWx0aXBsaWNhdGlvbiBiZWNhdXNlIGl0J3MgZmFzdGVyIGluIHNvbWUgYnJvd3NlcnMJLy8gXjAgZmxvb3JzIHJlc3VsdAoJCWZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CgkJCWlmKHNlYXJjaEVsZW1lbnQgPT09IGFyW2kqOF0pICAgeyByZXR1cm4gKGkqOCk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrMV0pIHsgcmV0dXJuIChpKjgrMSk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrMl0pIHsgcmV0dXJuIChpKjgrMik7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrM10pIHsgcmV0dXJuIChpKjgrMyk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNF0pIHsgcmV0dXJuIChpKjgrNCk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNV0pIHsgcmV0dXJuIChpKjgrNSk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNl0pIHsgcmV0dXJuIChpKjgrNik7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrN10pIHsgcmV0dXJuIChpKjgrNyk7fQoJCX0KCgkJdmFyIG4gPSBsICUgODsKCQlmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgewoJCQlpZiAoc2VhcmNoRWxlbWVudCA9PT0gYXJbbC1uK2ldKSB7CgkJCQlyZXR1cm4gbC1uK2k7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0KCSovCgoJLyoqCgkgKiBGaW5kcyB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIHNwZWNpZmllZCB2YWx1ZSBzZWFyY2hFbGVtZW50IGluIHRoZSBwYXNzZWQgaW4gYXJyYXksIGFuZCByZXR1cm5zIHRoZSBpbmRleCBvZgoJICogdGhhdCB2YWx1ZS4gIFJldHVybnMgLTEgaWYgdmFsdWUgaXMgbm90IGZvdW5kLgoJICoKCSAqICAgICAgdmFyIGkgPSBjcmVhdGVqcy5pbmRleE9mKG15QXJyYXksIG15RWxlbWVudFRvRmluZCk7CgkgKgoJICogQG1ldGhvZCBpbmRleE9mCgkgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSB0byBzZWFyY2ggZm9yIHNlYXJjaEVsZW1lbnQKCSAqIEBwYXJhbSBzZWFyY2hFbGVtZW50IEVsZW1lbnQgdG8gZmluZCBpbiBhcnJheS4KCSAqIEByZXR1cm4ge051bWJlcn0gVGhlIGZpcnN0IGluZGV4IG9mIHNlYXJjaEVsZW1lbnQgaW4gYXJyYXkuCgkgKi8KCWNyZWF0ZWpzLmluZGV4T2YgPSBmdW5jdGlvbiAoYXJyYXksIHNlYXJjaEVsZW1lbnQpewoJCWZvciAodmFyIGkgPSAwLGw9YXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCWlmIChzZWFyY2hFbGVtZW50ID09PSBhcnJheVtpXSkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfQoKfSgpKTsvKgoqIFByb3h5CiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCiogQ29weXJpZ2h0IChjKSAyMDEwIGdza2lubmVyLmNvbSwgaW5jLgoqIAoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CiogCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKiAKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoqIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCiogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiogRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUgoqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KKi8KCi8qKgogKiBAbW9kdWxlIENyZWF0ZUpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgovKioKICogVmFyaW91cyB1dGlsaXRpZXMgdGhhdCB0aGUgQ3JlYXRlSlMgU3VpdGUgdXNlcy4gVXRpbGl0aWVzIGFyZSBjcmVhdGVkIGFzIHNlcGFyYXRlIGZpbGVzLCBhbmQgd2lsbCBiZSBhdmFpbGFibGUgb24gdGhlCiAqIGNyZWF0ZWpzIG5hbWVzcGFjZSBkaXJlY3RseToKICoKICogPGg0PkV4YW1wbGU8L2g0PgogKiAgICAgIG15T2JqZWN0LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIGNyZWF0ZWpzLnByb3h5KG15TWV0aG9kLCBzY29wZSkpOwogKgogKiBAY2xhc3MgVXRpbGl0eSBNZXRob2RzCiAqIEBtYWluIFV0aWxpdHkgTWV0aG9kcwogKi8KCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEEgZnVuY3Rpb24gcHJveHkgZm9yIG1ldGhvZHMuIEJ5IGRlZmF1bHQsIEphdmFTY3JpcHQgbWV0aG9kcyBkbyBub3QgbWFpbnRhaW4gc2NvcGUsIHNvIHBhc3NpbmcgYSBtZXRob2QgYXMgYQoJICogY2FsbGJhY2sgd2lsbCByZXN1bHQgaW4gdGhlIG1ldGhvZCBnZXR0aW5nIGNhbGxlZCBpbiB0aGUgc2NvcGUgb2YgdGhlIGNhbGxlci4gVXNpbmcgYSBwcm94eSBlbnN1cmVzIHRoYXQgdGhlCgkgKiBtZXRob2QgZ2V0cyBjYWxsZWQgaW4gdGhlIGNvcnJlY3Qgc2NvcGUuCgkgKgoJICogQWRkaXRpb25hbCBhcmd1bWVudHMgY2FuIGJlIHBhc3NlZCB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZnVuY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQuCgkgKgoJICogPGg0PkV4YW1wbGU8L2g0PgoJICogICAgICBteU9iamVjdC5hZGRFdmVudExpc3RlbmVyKCJldmVudCIsIGNyZWF0ZWpzLnByb3h5KG15SGFuZGxlciwgdGhpcywgYXJnMSwgYXJnMikpOwoJICoKCSAqICAgICAgZnVuY3Rpb24gbXlIYW5kbGVyKGFyZzEsIGFyZzIpIHsKCSAqICAgICAgICAgICAvLyBUaGlzIGdldHMgY2FsbGVkIHdoZW4gbXlPYmplY3QubXlDYWxsYmFjayBpcyBleGVjdXRlZC4KCSAqICAgICAgfQoJICoKCSAqIEBtZXRob2QgcHJveHkKCSAqIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZCBUaGUgZnVuY3Rpb24gdG8gY2FsbAoJICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBzY29wZSB0byBjYWxsIHRoZSBtZXRob2QgbmFtZSBvbgoJICogQHBhcmFtIHttaXhlZH0gW2FyZ10gKiBBcmd1bWVudHMgdGhhdCBhcmUgYXBwZW5kZWQgdG8gdGhlIGNhbGxiYWNrIGZvciBhZGRpdGlvbmFsIHBhcmFtcy4KCSAqIEBwdWJsaWMKCSAqIEBzdGF0aWMKCSAqLwoJY3JlYXRlanMucHJveHkgPSBmdW5jdGlvbiAobWV0aG9kLCBzY29wZSkgewoJCXZhciBhQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIG1ldGhvZC5hcHBseShzY29wZSwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKS5jb25jYXQoYUFyZ3MpKTsKCQl9OwoJfQoKfSgpKTsvKgoqIEFic3RyYWN0TG9hZGVyCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCioKKiBDb3B5cmlnaHQgKGMpIDIwMTIgZ3NraW5uZXIuY29tLCBpbmMuCioKKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgoqIG9idGFpbmluZyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uCiogZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dAoqIHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAoqIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlCiogU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKKiBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAoqIEVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUwoqIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5ECiogTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKKiBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwKKiBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKKiBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCiogT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKLyoqCiAqIEBtb2R1bGUgUHJlbG9hZEpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgooZnVuY3Rpb24oKSB7CgkidXNlIHN0cmljdCI7CgkvKioKCSAqIFRoZSBiYXNlIGxvYWRlciwgd2hpY2ggZGVmaW5lcyBhbGwgdGhlIGdlbmVyaWMgY2FsbGJhY2tzIGFuZCBldmVudHMuIEFsbCBsb2FkZXJzIGV4dGVuZCB0aGlzIGNsYXNzLCBpbmNsdWRpbmcgdGhlCgkgKiB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319LgoJICogQGNsYXNzIEFic3RyYWN0TG9hZGVyCgkgKiBAZXh0ZW5kcyBFdmVudERpc3BhdGNoZXIKCSAqLwoJdmFyIEFic3RyYWN0TG9hZGVyID0gZnVuY3Rpb24gKCkgewoJCXRoaXMuaW5pdCgpOwoJfTsKCgl2YXIgcCA9IEFic3RyYWN0TG9hZGVyLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5FdmVudERpc3BhdGNoZXIoKTsKCUFic3RyYWN0TG9hZGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFic3RyYWN0TG9hZGVyOwoJdmFyIHMgPSBBYnN0cmFjdExvYWRlcjsKCgkvKioKCSAqIFRoZSBSZWd1bGFyIEV4cHJlc3Npb24gdXNlZCB0byB0ZXN0IGZpbGUgVVJMUyBmb3IgYW4gYWJzb2x1dGUgcGF0aC4KCSAqIEBwcm9wZXJ0eSBBQlNPTFVURV9QQVRICgkgKiBAc3RhdGljCgkgKiBAdHlwZSB7UmVnRXhwfQoJICogQHNpbmNlIDAuNC4yCgkgKi8KCXMuQUJTT0xVVEVfUEFUVCA9IC9eKD86XHcrOik/XC97Mn0vaTsKCgkvKioKCSAqIFRoZSBSZWd1bGFyIEV4cHJlc3Npb24gdXNlZCB0byB0ZXN0IGZpbGUgVVJMUyBmb3IgYW4gYWJzb2x1dGUgcGF0aC4KCSAqIEBwcm9wZXJ0eSBSRUxBVElWRV9QQVRICgkgKiBAc3RhdGljCgkgKiBAdHlwZSB7UmVnRXhwfQoJICogQHNpbmNlIDAuNC4yCgkgKi8KCXMuUkVMQVRJVkVfUEFUVCA9ICgvXlsuL10qP1wvL2kpOwoKCS8qKgoJICogVGhlIFJlZ3VsYXIgRXhwcmVzc2lvbiB1c2VkIHRvIHRlc3QgZmlsZSBVUkxTIGZvciBhbiBleHRlbnNpb24uIE5vdGUgdGhhdCBVUklzIG11c3QgYWxyZWFkeSBoYXZlIHRoZSBxdWVyeSBzdHJpbmcKCSAqIHJlbW92ZWQuCgkgKiBAcHJvcGVydHkgRVhURU5TSU9OX1BBVFQKCSAqIEBzdGF0aWMKCSAqIEB0eXBlIHtSZWdFeHB9CgkgKiBAc2luY2UgMC40LjIKCSAqLwoJcy5FWFRFTlNJT05fUEFUVCA9IC9cLz9bXi9dK1wuKFx3ezEsNX0pJC9pOwoKCS8qKgoJICogSWYgdGhlIGxvYWRlciBoYXMgY29tcGxldGVkIGxvYWRpbmcuIFRoaXMgcHJvdmlkZXMgYSBxdWljayBjaGVjaywgYnV0IGFsc28gZW5zdXJlcyB0aGF0IHRoZSBkaWZmZXJlbnQgYXBwcm9hY2hlcwoJICogdXNlZCBmb3IgbG9hZGluZyBkbyBub3QgcGlsZSB1cCByZXN1bHRpbmcgaW4gbW9yZSB0aGFuIG9uZSA8Y29kZT5jb21wbGV0ZTwvY29kZT4gZXZlbnQuCgkgKiBAcHJvcGVydHkgbG9hZGVkCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKi8KCXAubG9hZGVkID0gZmFsc2U7CgoJLyoqCgkgKiBEZXRlcm1pbmUgaWYgdGhlIGxvYWRlciB3YXMgY2FuY2VsZWQuIENhbmNlbGVkIGxvYWRzIHdpbGwgbm90IGZpcmUgY29tcGxldGUgZXZlbnRzLiBOb3RlIHRoYXQKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0gcXVldWVzIHNob3VsZCBiZSBjbG9zZWQgdXNpbmcge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9jbG9zZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBpbnN0ZWFkIG9mIHNldHRpbmcgdGhpcyBwcm9wZXJ0eS4KCSAqIEBwcm9wZXJ0eSBjYW5jZWxlZAoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAZGVmYXVsdCBmYWxzZQoJICovCglwLmNhbmNlbGVkID0gZmFsc2U7CgoJLyoqCgkgKiBUaGUgY3VycmVudCBsb2FkIHByb2dyZXNzIChwZXJjZW50YWdlKSBmb3IgdGhpcyBpdGVtLiBUaGlzIHdpbGwgYmUgYSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLgoJICoKCSAqIDxoND5FeGFtcGxlPC9oND4KCSAqCgkgKiAgICAgdmFyIHF1ZXVlID0gbmV3IGNyZWF0ZWpzLkxvYWRRdWV1ZSgpOwoJICogICAgIHF1ZXVlLmxvYWRGaWxlKCJsYXJnZUltYWdlLnBuZyIpOwoJICogICAgIHF1ZXVlLm9uKCJwcm9ncmVzcyIsIGZ1bmN0aW9uKCkgewoJICogICAgICAgICBjb25zb2xlLmxvZygiUHJvZ3Jlc3M6IiwgcXVldWUucHJvZ3Jlc3MsIGV2ZW50LnByb2dyZXNzKTsKCSAqICAgICB9KTsKCSAqCgkgKiBAcHJvcGVydHkgcHJvZ3Jlc3MKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCAwCgkgKi8KCXAucHJvZ3Jlc3MgPSAwOwoKCS8qKgoJICogVGhlIGl0ZW0gdGhpcyBsb2FkZXIgcmVwcmVzZW50cy4gTm90ZSB0aGF0IHRoaXMgaXMgbnVsbCBpbiBhIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0sIGJ1dCB3aWxsCgkgKiBiZSBhdmFpbGFibGUgb24gbG9hZGVycyBzdWNoIGFzIHt7I2Nyb3NzTGluayAiWEhSTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHt7I2Nyb3NzTGluayAiVGFnTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0uCgkgKiBAcHJvcGVydHkgX2l0ZW0KCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9pdGVtID0gbnVsbDsKCi8vIEV2ZW50cwoJLyoqCgkgKiBUaGUgZXZlbnQgdGhhdCBpcyBmaXJlZCB3aGVuIHRoZSBvdmVyYWxsIHByb2dyZXNzIGNoYW5nZXMuCgkgKiBAZXZlbnQgcHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IGRpc3BhdGNoZWQgdGhlIGV2ZW50LgoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHR5cGUuCgkgKiBAcGFyYW0ge051bWJlcn0gbG9hZGVkIFRoZSBhbW91bnQgdGhhdCBoYXMgYmVlbiBsb2FkZWQgc28gZmFyLiBOb3RlIHRoYXQgdGhpcyBpcyBtYXkganVzdCBiZSBhIHBlcmNlbnRhZ2Ugb2YgMSwKCSAqIHNpbmNlIGZpbGUgc2l6ZXMgY2FuIG5vdCBiZSBkZXRlcm1pbmVkIGJlZm9yZSBhIGxvYWQgaXMga2lja2VkIG9mZiwgaWYgYXQgYWxsLgoJICogQHBhcmFtIHtOdW1iZXJ9IHRvdGFsIFRoZSB0b3RhbCBudW1iZXIgb2YgYnl0ZXMuIE5vdGUgdGhhdCB0aGlzIG1heSBqdXN0IGJlIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gcHJvZ3Jlc3MgVGhlIHJhdGlvIHRoYXQgaGFzIGJlZW4gbG9hZGVkIGJldHdlZW4gMCBhbmQgMS4KCSAqIEBzaW5jZSAwLjMuMAoJICovCgoJLyoqCgkgKiBUaGUgZXZlbnQgdGhhdCBpcyBmaXJlZCB3aGVuIGEgbG9hZCBzdGFydHMuCgkgKiBAZXZlbnQgbG9hZHN0YXJ0CgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHNpbmNlIDAuMy4xCgkgKi8KCgkvKioKCSAqIFRoZSBldmVudCB0aGF0IGlzIGZpcmVkIHdoZW4gdGhlIGVudGlyZSBxdWV1ZSBoYXMgYmVlbiBsb2FkZWQuCgkgKiBAZXZlbnQgY29tcGxldGUKCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IGRpc3BhdGNoZWQgdGhlIGV2ZW50LgoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHR5cGUuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8qKgoJICogVGhlIGV2ZW50IHRoYXQgaXMgZmlyZWQgd2hlbiB0aGUgbG9hZGVyIGVuY291bnRlcnMgYW4gZXJyb3IuIElmIHRoZSBlcnJvciB3YXMgZW5jb3VudGVyZWQgYnkgYSBmaWxlLCB0aGUgZXZlbnQgd2lsbAoJICogY29udGFpbiB0aGUgaXRlbSB0aGF0IGNhdXNlZCB0aGUgZXJyb3IuIFRoZXJlIG1heSBiZSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgc3VjaCBhcyB0aGUgZXJyb3IgcmVhc29uIG9uIGV2ZW50CgkgKiBvYmplY3RzLgoJICogQGV2ZW50IGVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtPYmplY3R9IFtpdGVtXSBUaGUgaXRlbSB0aGF0IHdhcyBiZWluZyBsb2FkZWQgdGhhdCBjYXVzZWQgdGhlIGVycm9yLiBUaGUgaXRlbSB3YXMgc3BlY2lmaWVkIGluCgkgKiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fSBvciB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUgb2JqZWN0IHdpbGwgY29udGFpbiB0aGF0IHZhbHVlIGFzIGEgYHNyY2AgcHJvcGVydHkuCgkgKiBAcGFyYW0ge1N0cmluZ30gW2Vycm9yXSBUaGUgZXJyb3Igb2JqZWN0IG9yIHRleHQuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8vVE9ETzogRGVwcmVjYXRlZAoJLyoqCgkgKiBSRU1PVkVELiBVc2Uge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319IGFuZCB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvblByb2dyZXNzCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJwcm9ncmVzcyIgZXZlbnQuCgkgKi8KCS8qKgoJICogUkVNT1ZFRC4gVXNlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL2FkZEV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvbG9hZHN0YXJ0OmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50LgoJICogQHByb3BlcnR5IG9uTG9hZFN0YXJ0CgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJsb2Fkc3RhcnQiIGV2ZW50LgoJICovCgkvKioKCSAqIFJFTU9WRUQuIFVzZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9hZGRFdmVudExpc3RlbmVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHRoZSB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2NvbXBsZXRlOmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50LgoJICogQHByb3BlcnR5IG9uQ29tcGxldGUKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBkZXByZWNhdGVkIFVzZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0aGUgImNvbXBsZXRlIiBldmVudC4KCSAqLwoJLyoqCgkgKiBSRU1PVkVELiBVc2Uge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319IGFuZCB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9lcnJvcjpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkVycm9yCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJlcnJvciIgZXZlbnQuCgkgKi8KCgkvKioKCSAqIEdldCBhIHJlZmVyZW5jZSB0byB0aGUgbWFuaWZlc3QgaXRlbSB0aGF0IGlzIGxvYWRlZCBieSB0aGlzIGxvYWRlci4gSW4gbW9zdCBjYXNlcyB0aGlzIHdpbGwgYmUgdGhlIHZhbHVlIHRoYXQgd2FzCgkgKiBwYXNzZWQgaW50byB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319IHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3IKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319LiBIb3dldmVyIGlmIG9ubHkgYSBTdHJpbmcgcGF0aCB3YXMgcGFzc2VkIGluLCB0aGVuIGl0IHdpbGwKCSAqIGJlIGFuIE9iamVjdCBjcmVhdGVkIGJ5IHRoZSBMb2FkUXVldWUuCgkgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBtYW5pZmVzdCBpdGVtIHRoYXQgdGhpcyBsb2FkZXIgaXMgcmVzcG9uc2libGUgZm9yIGxvYWRpbmcuCgkgKi8KCXAuZ2V0SXRlbSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9pdGVtOwoJfTsKCgkvKioKCSAqIEluaXRpYWxpemUgdGhlIGxvYWRlci4gVGhpcyBpcyBjYWxsZWQgYnkgdGhlIGNvbnN0cnVjdG9yLgoJICogQG1ldGhvZCBpbml0CgkgKiBAcHJpdmF0ZQoJICovCglwLmluaXQgPSBmdW5jdGlvbiAoKSB7fTsKCgkvKioKCSAqIEJlZ2luIGxvYWRpbmcgdGhlIHF1ZXVlZCBpdGVtcy4gVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB3aGVuIGEge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUifX17ey9jcm9zc0xpbmt9fSBpcyBzZXQKCSAqIHVwIGJ1dCBub3Qgc3RhcnRlZCBpbW1lZGlhdGVseS4KCSAqIEBleGFtcGxlCgkgKiAgICAgIHZhciBxdWV1ZSA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoKTsKCSAqICAgICAgcXVldWUuYWRkRXZlbnRMaXN0ZW5lcigiY29tcGxldGUiLCBoYW5kbGVDb21wbGV0ZSk7CgkgKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChmaWxlQXJyYXksIGZhbHNlKTsgLy8gTm90ZSB0aGUgMm5kIGFyZ3VtZW50IHRoYXQgdGVsbHMgdGhlIHF1ZXVlIG5vdCB0byBzdGFydCBsb2FkaW5nIHlldAoJICogICAgICBxdWV1ZS5sb2FkKCk7CgkgKiBAbWV0aG9kIGxvYWQKCSAqLwoJcC5sb2FkID0gZnVuY3Rpb24oKSB7fTsKCgkvKioKCSAqIENsb3NlIHRoZSBhY3RpdmUgcXVldWUuIENsb3NpbmcgYSBxdWV1ZSBjb21wbGV0ZWx5IGVtcHRpZXMgdGhlIHF1ZXVlLCBhbmQgcHJldmVudHMgYW55IHJlbWFpbmluZyBpdGVtcyBmcm9tCgkgKiBzdGFydGluZyB0byBkb3dubG9hZC4gTm90ZSB0aGF0IGN1cnJlbnRseSBhbnkgYWN0aXZlIGxvYWRzIHdpbGwgcmVtYWluIG9wZW4sIGFuZCBldmVudHMgbWF5IGJlIHByb2Nlc3NlZC4KCSAqCgkgKiBUbyBzdG9wIGFuZCByZXN0YXJ0IGEgcXVldWUsIHVzZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0UGF1c2VkIn19e3svY3Jvc3NMaW5rfX0gbWV0aG9kIGluc3RlYWQuCgkgKiBAbWV0aG9kIGNsb3NlCgkgKi8KCXAuY2xvc2UgPSBmdW5jdGlvbigpIHt9OwoKCi8vQ2FsbGJhY2sgcHJveGllcwoJLyoqCgkgKiBEaXNwYXRjaCBhIGxvYWRzdGFydCBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9sb2Fkc3RhcnQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudAoJICogZm9yIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kTG9hZFN0YXJ0CgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3NlbmRMb2FkU3RhcnQgPSBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7IHJldHVybjsgfQoJCXRoaXMuZGlzcGF0Y2hFdmVudCgibG9hZHN0YXJ0Iik7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBwcm9ncmVzcyBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319IGV2ZW50IGZvcgoJICogZGV0YWlscyBvbiB0aGUgZXZlbnQgcGF5bG9hZC4KCSAqIEBtZXRob2QgX3NlbmRQcm9ncmVzcwoJICogQHBhcmFtIHtOdW1iZXIgfCBPYmplY3R9IHZhbHVlIFRoZSBwcm9ncmVzcyBvZiB0aGUgbG9hZGVkIGl0ZW0sIG9yIGFuIG9iamVjdCBjb250YWluaW5nIDxjb2RlPmxvYWRlZDwvY29kZT4KCSAqIGFuZCA8Y29kZT50b3RhbDwvY29kZT4gcHJvcGVydGllcy4KCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZFByb2dyZXNzID0gZnVuY3Rpb24odmFsdWUpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7IHJldHVybjsgfQoJCXZhciBldmVudCA9IG51bGw7CgkJaWYgKHR5cGVvZih2YWx1ZSkgPT0gIm51bWJlciIpIHsKCQkJdGhpcy5wcm9ncmVzcyA9IHZhbHVlOwoJCQlldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgicHJvZ3Jlc3MiKTsKCQkJZXZlbnQubG9hZGVkID0gdGhpcy5wcm9ncmVzczsKCQkJZXZlbnQudG90YWwgPSAxOwoJCX0gZWxzZSB7CgkJCWV2ZW50ID0gdmFsdWU7CgkJCXRoaXMucHJvZ3Jlc3MgPSB2YWx1ZS5sb2FkZWQgLyB2YWx1ZS50b3RhbDsKCQkJaWYgKGlzTmFOKHRoaXMucHJvZ3Jlc3MpIHx8IHRoaXMucHJvZ3Jlc3MgPT0gSW5maW5pdHkpIHsgdGhpcy5wcm9ncmVzcyA9IDA7IH0KCQl9CgkJZXZlbnQucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzOwoJCXRoaXMuaGFzRXZlbnRMaXN0ZW5lcigicHJvZ3Jlc3MiKSAmJiB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoJfTsKCgkvKioKCSAqIERpc3BhdGNoIGEgY29tcGxldGUgZXZlbnQuIFBsZWFzZSBzZWUgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY29tcGxldGU6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudAoJICogZm9yIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kQ29tcGxldGUKCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZENvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuX2lzQ2FuY2VsZWQoKSkgeyByZXR1cm47IH0KCQl0aGlzLmRpc3BhdGNoRXZlbnQoImNvbXBsZXRlIik7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQuIFBsZWFzZSBzZWUgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvZXJyb3I6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudCBmb3IKCSAqIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kRXJyb3IKCSAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgZXZlbnQgb2JqZWN0IGNvbnRhaW5pbmcgc3BlY2lmaWMgZXJyb3IgcHJvcGVydGllcy4KCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZEVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpIHx8ICF0aGlzLmhhc0V2ZW50TGlzdGVuZXIoImVycm9yIikpIHsgcmV0dXJuOyB9CgkJaWYgKGV2ZW50ID09IG51bGwpIHsKCQkJZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJfQoJCXRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGV0ZXJtaW5lIGlmIHRoZSBsb2FkIGhhcyBiZWVuIGNhbmNlbGVkLiBUaGlzIGlzIGltcG9ydGFudCB0byBlbnN1cmUgdGhhdCBtZXRob2QgY2FsbHMgb3IgYXN5bmNocm9ub3VzIGV2ZW50cwoJICogZG8gbm90IGNhdXNlIGlzc3VlcyBhZnRlciB0aGUgcXVldWUgaGFzIGJlZW4gY2xlYW5lZCB1cC4KCSAqIEBtZXRob2QgX2lzQ2FuY2VsZWQKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkZXIgaGFzIGJlZW4gY2FuY2VsZWQuCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX2lzQ2FuY2VsZWQgPSBmdW5jdGlvbigpIHsKCQlpZiAod2luZG93LmNyZWF0ZWpzID09IG51bGwgfHwgdGhpcy5jYW5jZWxlZCkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvKioKCSAqIEBtZXRob2QgX3BhcnNlVVJJCgkgKiBQYXJzZSBhIGZpbGUgcGF0aCB0byBkZXRlcm1pbmUgdGhlIGluZm9ybWF0aW9uIHdlIG5lZWQgdG8gd29yayB3aXRoIGl0LiBDdXJyZW50bHksIFByZWxvYWRKUyBuZWVkcyB0byBrbm93OgoJICogPHVsPgoJICogICAgIDxsaT5JZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZS4gQWJzb2x1dGUgcGF0aHMgc3RhcnQgd2l0aCBhIHByb3RvY29sIChzdWNoIGFzIGBodHRwOi8vYCwgYGZpbGU6Ly9gLCBvcgoJICogICAgIGAvL25ldHdvcmtQYXRoYCk8L2xpPgoJICogICAgIDxsaT5JZiB0aGUgcGF0aCBpcyByZWxhdGl2ZS4gUmVsYXRpdmUgcGF0aHMgc3RhcnQgd2l0aCBgLi4vYCBvciBgL3BhdGhgIChvciBzaW1pbGFyKTwvbGk+CgkgKiAgICAgPGxpPlRoZSBmaWxlIGV4dGVuc2lvbi4gVGhpcyBpcyBkZXRlcm1pbmVkIGJ5IHRoZSBmaWxlbmFtZSB3aXRoIGFuIGV4dGVuc2lvbi4gUXVlcnkgc3RyaW5ncyBhcmUgZHJvcHBlZCwgYW5kCgkgKiAgICAgdGhlIGZpbGUgcGF0aCBpcyBleHBlY3RlZCB0byBmb2xsb3cgdGhlIGZvcm1hdCBgbmFtZS5leHRgLjwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIDxzdHJvbmc+Tm90ZTo8L3N0cm9uZz4gVGhpcyBoYXMgY2hhbmdlZCBmcm9tIGVhcmxpZXIgdmVyc2lvbnMsIHdoaWNoIHVzZWQgYSBzaW5nbGUsIGNvbXBsaWNhdGVkIFJlZ3VsYXIgRXhwcmVzc2lvbiwgd2hpY2gKCSAqIHdhcyBkaWZmaWN1bHQgdG8gbWFpbnRhaW4sIGFuZCBvdmVyLWFnZ3Jlc3NpdmUgaW4gZGV0ZXJtaW5pbmcgYWxsIGZpbGUgcHJvcGVydGllcy4gSXQgaGFzIGJlZW4gc2ltcGxpZmllZCB0bwoJICogb25seSBwdWxsIG91dCB3aGF0IGl0IG5lZWRzLgoJICogQHBhcmFtIHBhdGgKCSAqIEByZXR1cm5zIHtPYmplY3R9IEFuIE9iamVjdCB3aXRoIGFuIGBhYnNvbHV0ZWAgYW5kIGByZWxhdGl2ZWAgQm9vbGVhbiwgYXMgd2VsbCBhcyBhbiBvcHRpb25hbCAnZXh0ZW5zaW9uYCBTdHJpbmcKCSAqIHByb3BlcnR5LCB3aGljaCBpcyB0aGUgbG93ZXJjYXNlIGV4dGVuc2lvbi4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3BhcnNlVVJJID0gZnVuY3Rpb24ocGF0aCkgewoJCXZhciBpbmZvID0geyBhYnNvbHV0ZTogZmFsc2UsIHJlbGF0aXZlOmZhbHNlIH07CgkJaWYgKHBhdGggPT0gbnVsbCkgeyByZXR1cm4gaW5mbzsgfTsKCgkJLy8gRHJvcCB0aGUgcXVlcnkgc3RyaW5nCgkJdmFyIHF1ZXJ5SW5kZXggPSBwYXRoLmluZGV4T2YoIj8iKTsKCQlpZiAocXVlcnlJbmRleCA+IC0xKSB7CgkJCXBhdGggPSBwYXRoLnN1YnN0cigwLHF1ZXJ5SW5kZXgpOwoJCX0KCgkJLy8gQWJzb2x1dGUKCQl2YXIgbWF0Y2g7CgkJaWYgKHMuQUJTT0xVVEVfUEFUVC50ZXN0KHBhdGgpKSB7CgkJCWluZm8uYWJzb2x1dGUgPSB0cnVlOwoKCQkvLyBSZWxhdGl2ZQoJCX0gZWxzZSBpZiAocy5SRUxBVElWRV9QQVRULnRlc3QocGF0aCkpIHsKCQkJaW5mby5yZWxhdGl2ZSA9IHRydWU7CgkJfQoKCQkvLyBFeHRlbnNpb24KCQlpZiAobWF0Y2ggPSBwYXRoLm1hdGNoKHMuRVhURU5TSU9OX1BBVFQpKSB7CgkJCWluZm8uZXh0ZW5zaW9uID0gbWF0Y2hbMV0udG9Mb3dlckNhc2UoKTsKCQl9CgkJcmV0dXJuIGluZm87Cgl9OwoKCS8qKgoJICogRm9ybWF0cyBhbiBvYmplY3QgaW50byBhIHF1ZXJ5IHN0cmluZyBmb3IgZWl0aGVyIGEgUE9TVCBvciBHRVQgcmVxdWVzdC4KCSAqIEBtZXRob2QgX2Zvcm1hdFF1ZXJ5U3RyaW5nCgkgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBjb252ZXJ0IHRvIGEgcXVlcnkgc3RyaW5nLgoJICogQHBhcmFtIHtBcnJheX0gW3F1ZXJ5XSBFeGlzdGluZyBuYW1lL3ZhbHVlIHBhaXJzIHRvIGFwcGVuZCBvbiB0byB0aGlzIHF1ZXJ5LgoJICogQHByaXZhdGUKCSAqLwoJcC5fZm9ybWF0UXVlcnlTdHJpbmcgPSBmdW5jdGlvbihkYXRhLCBxdWVyeSkgewoJCWlmIChkYXRhID09IG51bGwpIHsKCQkJdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBzcGVjaWZ5IGRhdGEuJyk7CgkJfQoJCXZhciBwYXJhbXMgPSBbXTsKCQlmb3IgKHZhciBuIGluIGRhdGEpIHsKCQkJcGFyYW1zLnB1c2gobisnPScrZXNjYXBlKGRhdGFbbl0pKTsKCQl9CgkJaWYgKHF1ZXJ5KSB7CgkJCXBhcmFtcyA9IHBhcmFtcy5jb25jYXQocXVlcnkpOwoJCX0KCQlyZXR1cm4gcGFyYW1zLmpvaW4oJyYnKTsKCX07CgoJLyoqCgkgKiBBIHV0aWxpdHkgbWV0aG9kIHRoYXQgYnVpbGRzIGEgZmlsZSBwYXRoIHVzaW5nIGEgc291cmNlIGFuZCBhIGRhdGEgb2JqZWN0LCBhbmQgZm9ybWF0cyBpdCBpbnRvIGEgbmV3IHBhdGguIEFsbAoJICogb2YgdGhlIGxvYWRlcnMgaW4gUHJlbG9hZEpTIHVzZSB0aGlzIG1ldGhvZCB0byBjb21waWxlIHBhdGhzIHdoZW4gbG9hZGluZy4KCSAqIEBtZXRob2QgYnVpbGRQYXRoCgkgKiBAcGFyYW0ge1N0cmluZ30gc3JjIFRoZSBzb3VyY2UgcGF0aCB0byBhZGQgdmFsdWVzIHRvLgoJICogQHBhcmFtIHtPYmplY3R9IFtkYXRhXSBPYmplY3QgdXNlZCB0byBhcHBlbmQgdmFsdWVzIHRvIHRoaXMgcmVxdWVzdCBhcyBhIHF1ZXJ5IHN0cmluZy4gRXhpc3RpbmcgcGFyYW1ldGVycyBvbiB0aGUKCSAqIHBhdGggd2lsbCBiZSBwcmVzZXJ2ZWQuCgkgKiBAcmV0dXJucyB7c3RyaW5nfSBBIGZvcm1hdHRlZCBzdHJpbmcgdGhhdCBjb250YWlucyB0aGUgcGF0aCBhbmQgdGhlIHN1cHBsaWVkIHBhcmFtZXRlcnMuCgkgKiBAc2luY2UgMC4zLjEKCSAqLwoJcC5idWlsZFBhdGggPSBmdW5jdGlvbihzcmMsIGRhdGEpIHsKCQlpZiAoZGF0YSA9PSBudWxsKSB7CgkJCXJldHVybiBzcmM7CgkJfQoKCQl2YXIgcXVlcnkgPSBbXTsKCQl2YXIgaWR4ID0gc3JjLmluZGV4T2YoJz8nKTsKCgkJaWYgKGlkeCAhPSAtMSkgewoJCQl2YXIgcSA9IHNyYy5zbGljZShpZHgrMSk7CgkJCXF1ZXJ5ID0gcXVlcnkuY29uY2F0KHEuc3BsaXQoJyYnKSk7CgkJfQoKCQlpZiAoaWR4ICE9IC0xKSB7CgkJCXJldHVybiBzcmMuc2xpY2UoMCwgaWR4KSArICc/JyArIHRoaXMuX2Zvcm1hdFF1ZXJ5U3RyaW5nKGRhdGEsIHF1ZXJ5KTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gc3JjICsgJz8nICsgdGhpcy5fZm9ybWF0UXVlcnlTdHJpbmcoZGF0YSwgcXVlcnkpOwoJCX0KCX07CgoJLyoqCgkgKiBAbWV0aG9kIF9pc0Nyb3NzRG9tYWluCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBBIGxvYWQgaXRlbSB3aXRoIGEgYHNyY2AgcHJvcGVydHkKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkIGl0ZW0gaXMgbG9hZGluZyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiB0aGFuIHRoZSBjdXJyZW50IGxvY2F0aW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5faXNDcm9zc0RvbWFpbiA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCXRhcmdldC5ocmVmID0gaXRlbS5zcmM7CgoJCXZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCWhvc3QuaHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJCXZhciBjcm9zc2RvbWFpbiA9ICh0YXJnZXQuaG9zdG5hbWUgIT0gIiIpICYmCgkJCQkodGFyZ2V0LnBvcnQgIT0gaG9zdC5wb3J0IHx8CgkJCQkJCXRhcmdldC5wcm90b2NvbCAhPSBob3N0LnByb3RvY29sIHx8CgkJCQkJCXRhcmdldC5ob3N0bmFtZSAhPSBob3N0Lmhvc3RuYW1lKTsKCQlyZXR1cm4gY3Jvc3Nkb21haW47Cgl9CgoJLyoqCgkgKiBAbWV0aG9kIF9pc0xvY2FsCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBBIGxvYWQgaXRlbSB3aXRoIGEgYHNyY2AgcHJvcGVydHkKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkIGl0ZW0gaXMgbG9hZGluZyBmcm9tIHRoZSAiZmlsZToiIHByb3RvY29sLiBBc3N1bWUgdGhhdCB0aGUgaG9zdCBtdXN0IGJlIGxvY2FsIGFzCgkgKiB3ZWxsLgoJICogQHByaXZhdGUKCSAqLwoJcC5faXNMb2NhbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCXRhcmdldC5ocmVmID0gaXRlbS5zcmM7CgkJcmV0dXJuIHRhcmdldC5ob3N0bmFtZSA9PSAiIiAmJiB0YXJnZXQucHJvdG9jb2wgPT0gImZpbGU6IjsKCX07CgoJLyoqCgkgKiBAbWV0aG9kIHRvU3RyaW5nCgkgKiBAcmV0dXJuIHtTdHJpbmd9IGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KCSAqLwoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBBYnN0cmFjdExvYWRlcl0iOwoJfTsKCgljcmVhdGVqcy5BYnN0cmFjdExvYWRlciA9IEFic3RyYWN0TG9hZGVyOwoKfSgpKTsKLyoKKiBMb2FkUXVldWUKKiBWaXNpdCBodHRwOi8vY3JlYXRlanMuY29tLyBmb3IgZG9jdW1lbnRhdGlvbiwgdXBkYXRlcyBhbmQgZXhhbXBsZXMuCioKKgoqIENvcHlyaWdodCAoYykgMjAxMiBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCi8qKgogKiBQcmVsb2FkSlMgcHJvdmlkZXMgYSBjb25zaXN0ZW50IHdheSB0byBwcmVsb2FkIGNvbnRlbnQgZm9yIHVzZSBpbiBIVE1MIGFwcGxpY2F0aW9ucy4gUHJlbG9hZGluZyBjYW4gYmUgZG9uZSB1c2luZwogKiBIVE1MIHRhZ3MsIGFzIHdlbGwgYXMgWEhSLgogKgogKiBCeSBkZWZhdWx0LCBQcmVsb2FkSlMgd2lsbCB0cnkgYW5kIGxvYWQgY29udGVudCB1c2luZyBYSFIsIHNpbmNlIGl0IHByb3ZpZGVzIGJldHRlciBzdXBwb3J0IGZvciBwcm9ncmVzcyBhbmQKICogY29tcGxldGlvbiBldmVudHMsIDxiPmhvd2V2ZXIgZHVlIHRvIGNyb3NzLWRvbWFpbiBpc3N1ZXMsIGl0IG1heSBzdGlsbCBiZSBwcmVmZXJhYmxlIHRvIHVzZSB0YWctYmFzZWQgbG9hZGluZwogKiBpbnN0ZWFkPC9iPi4gTm90ZSB0aGF0IHNvbWUgY29udGVudCByZXF1aXJlcyBYSFIgdG8gd29yayAocGxhaW4gdGV4dCwgd2ViIGF1ZGlvKSwgYW5kIHNvbWUgcmVxdWlyZXMgdGFncyAoSFRNTCBhdWRpbykuCiAqIE5vdGUgdGhpcyBpcyBoYW5kbGVkIGF1dG9tYXRpY2FsbHkgd2hlcmUgcG9zc2libGUuCiAqCiAqIFByZWxvYWRKUyBjdXJyZW50bHkgc3VwcG9ydHMgYWxsIG1vZGVybiBicm93c2VycywgYW5kIHdlIGhhdmUgZG9uZSBvdXIgYmVzdCB0byBpbmNsdWRlIHN1cHBvcnQgZm9yIG1vc3Qgb2xkZXIKICogYnJvd3NlcnMuIElmIHlvdSBmaW5kIGFuIGlzc3VlIHdpdGggYW55IHNwZWNpZmljIE9TL2Jyb3dzZXIgY29tYmluYXRpb24sIHBsZWFzZSB2aXNpdCBodHRwOi8vY29tbXVuaXR5LmNyZWF0ZWpzLmNvbS8KICogYW5kIHJlcG9ydCBpdC4KICoKICogPGg0PkdldHRpbmcgU3RhcnRlZDwvaDQ+CiAqIFRvIGdldCBzdGFydGVkLCBjaGVjayBvdXQgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0gY2xhc3MsIHdoaWNoIGluY2x1ZGVzIGEgcXVpY2sgb3ZlcnZpZXcgb2YgaG93CiAqIHRvIGxvYWQgZmlsZXMgYW5kIHByb2Nlc3MgcmVzdWx0cy4KICoKICogPGg0PkV4YW1wbGU8L2g0PgogKgogKiAgICAgIHZhciBxdWV1ZSA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoKTsKICogICAgICBxdWV1ZS5pbnN0YWxsUGx1Z2luKGNyZWF0ZWpzLlNvdW5kKTsKICogICAgICBxdWV1ZS5vbigiY29tcGxldGUiLCBoYW5kbGVDb21wbGV0ZSwgdGhpcyk7CiAqICAgICAgcXVldWUubG9hZEZpbGUoe2lkOiJzb3VuZCIsIHNyYzoiaHR0cDovL3BhdGgvdG8vc291bmQubXAzIn0pOwogKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChbCiAqICAgICAgICAgIHtpZDogIm15SW1hZ2UiLCBzcmM6InBhdGgvdG8vbXlJbWFnZS5qcGcifQogKiAgICAgIF0pOwogKiAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbXBsZXRlKCkgewogKiAgICAgICAgICBjcmVhdGVqcy5Tb3VuZC5wbGF5KCJzb3VuZCIpOwogKiAgICAgICAgICB2YXIgaW1hZ2UgPSBxdWV1ZS5nZXRSZXN1bHQoIm15SW1hZ2UiKTsKICogICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbWFnZSk7CiAqICAgICAgfQogKgogKiA8Yj5JbXBvcnRhbnQgbm90ZSBvbiBwbHVnaW5zOjwvYj4gUGx1Z2lucyBtdXN0IGJlIGluc3RhbGxlZCA8aT5iZWZvcmU8L2k+IGl0ZW1zIGFyZSBhZGRlZCB0byB0aGUgcXVldWUsIG90aGVyd2lzZQogKiB0aGV5IHdpbGwgbm90IGJlIHByb2Nlc3NlZCwgZXZlbiBpZiB0aGUgbG9hZCBoYXMgbm90IGFjdHVhbGx5IGtpY2tlZCBvZmYgeWV0LiBQbHVnaW4gZnVuY3Rpb25hbGl0eSBpcyBoYW5kbGVkIHdoZW4KICogdGhlIGl0ZW1zIGFyZSBhZGRlZCB0byB0aGUgTG9hZFF1ZXVlLgogKgogKiA8aDQ+QnJvd3NlciBTdXBwb3J0PC9oND4KICogUHJlbG9hZEpTIGlzIHBhcnRpYWxseSBzdXBwb3J0ZWQgaW4gYWxsIGJyb3dzZXJzLCBhbmQgZnVsbHkgc3VwcG9ydGVkIGluIGFsbCBtb2Rlcm4gYnJvd3NlcnMuIEtub3duIGV4Y2VwdGlvbnM6CiAqIDx1bD48bGk+WEhSIGxvYWRpbmcgb2YgYW55IGNvbnRlbnQgd2lsbCBub3Qgd29yayBpbiBtYW55IG9sZGVyIGJyb3dzZXJzIChTZWUgYSBtYXRyaXggaGVyZTogPGEgaHJlZj0iaHR0cDovL2Nhbml1c2UuY29tL3hocjIiIHRhcmdldD0iX2JsYW5rIj5odHRwOi8vY2FuaXVzZS5jb20veGhyMjwvYT4pLgogKiAgICAgIEluIG1hbnkgY2FzZXMsIHlvdSBjYW4gZmFsbCBiYWNrIG9uIHRhZyBsb2FkaW5nIChpbWFnZXMsIGF1ZGlvLCBDU1MsIHNjcmlwdHMsIFNWRywgYW5kIEpTT05QKS4gVGV4dCBhbmQKICogICAgICBXZWJBdWRpbyB3aWxsIG9ubHkgd29yayB3aXRoIFhIUi48L2xpPgogKiAgICAgIDxsaT5Tb21lIGZvcm1hdHMgaGF2ZSBwb29yIHN1cHBvcnQgZm9yIGNvbXBsZXRlIGV2ZW50cyBpbiBJRSA2LCA3LCBhbmQgOCAoU1ZHLCB0YWcgbG9hZGluZyBvZiBzY3JpcHRzLCBYTUwvSlNPTik8L2xpPgogKiAgICAgIDxsaT5PcGVyYSBoYXMgcG9vciBzdXBwb3J0IGZvciBTVkcgbG9hZGluZyB3aXRoIFhIUjwvbGk+CiAqICAgICAgPGxpPkNTUyBsb2FkaW5nIGluIEFuZHJvaWQgYW5kIFNhZmFyaSB3aWxsIG5vdCB3b3JrIHdpdGggdGFncyAoY3VycmVudGx5LCBhIHdvcmthcm91bmQgaXMgaW4gcHJvZ3Jlc3MpPC9saT4KICogICAgICA8bGk+TG9jYWwgbG9hZGluZyBpcyBub3QgcGVybWl0dGVkIHdpdGggWEhSLCB3aGljaCBpcyByZXF1aXJlZCBieSBzb21lIGZpbGUgZm9ybWF0cy4gV2hlbiB0ZXN0aW5nIGxvY2FsIGNvbnRlbnQKICogICAgICB1c2UgZWl0aGVyIGEgbG9jYWwgc2VydmVyLCBvciBlbmFibGUgdGFnIGxvYWRpbmcsIHdoaWNoIGlzIHN1cHBvcnRlZCBmb3IgbW9zdCBmb3JtYXRzLiBTZWUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0VXNlWEhSIn19e3svY3Jvc3NMaW5rfX0KICogICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi48L2xpPgogKiA8L3VsPgogKgogKiA8aDQ+Q3Jvc3MtZG9tYWluIExvYWRpbmc8L2g0PgogKiBNb3N0IGNvbnRlbnQgdHlwZXMgY2FuIGJlIGxvYWRlZCBjcm9zcy1kb21haW4sIGFzIGxvbmcgYXMgdGhlIHNlcnZlciBzdXBwb3J0cyBDT1JTLiBQcmVsb2FkSlMgYWxzbyBoYXMgaW50ZXJuYWwKICogc3VwcG9ydCBmb3IgaW1hZ2VzIHNlcnZlZCBmcm9tIGEgQ09SUy1lbmFibGVkIHNlcnZlciwgdmlhIHRoZSBgY3Jvc3NPcmlnaW5gIGFyZ3VtZW50IG9uIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319CiAqIGNvbnN0cnVjdG9yLiBJZiBzZXQgdG8gYSBzdHJpbmcgdmFsdWUgKHN1Y2ggYXMgIkFub255bW91cyIpLCB0aGUgImNyb3NzT3JpZ2luIiBwcm9wZXJ0eSBvZiBpbWFnZXMgZ2VuZXJhdGVkIGJ5CiAqIFByZWxvYWRKUyBpcyBzZXQgdG8gdGhhdCB2YWx1ZS4gUGxlYXNlIG5vdGUgdGhhdCBzZXR0aW5nIGEgYGNyb3NzT3JpZ2luYCB2YWx1ZSBvbiBhbiBpbWFnZSB0aGF0IGlzIHNlcnZlZCBmcm9tIGEKICogc2VydmVyIHdpdGhvdXQgQ09SUyB3aWxsIGNhdXNlIG90aGVyIGVycm9ycy4gRm9yIG1vcmUgaW5mbyBvbiBDT1JTLCB2aXNpdCBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1vcmlnaW5fcmVzb3VyY2Vfc2hhcmluZy4KICoKICogQG1vZHVsZSBQcmVsb2FkSlMKICogQG1haW4gUHJlbG9hZEpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgovKgpUT0RPOiBXSU5ET1dTIElTU1VFUwoJKiBObyBlcnJvciBmb3IgSFRNTCBhdWRpbyBpbiBJRSA2NzgKCSogU1ZHIG5vIGZhaWx1cmUgZXJyb3IgaW4gSUUgNjcgKG1heWJlIDgpIFRBR1MgQU5EIFhIUgoJKiBObyBzY3JpcHQgY29tcGxldGUgaGFuZGxlciBpbiBJRSA2NyBUQUdTIChYSFIgaXMgZmluZSkKCSogTm8gWE1ML0pTT04gaW4gSUU2IFRBR1MKCSogTmVlZCB0byBoaWRlIGxvYWRpbmcgU1ZHIGluIE9wZXJhIFRBR1MKCSogTm8gQ1NTIG9ubG9hZC9yZWFkeXN0YXRlY2hhbmdlIGluIFNhZmFyaSBvciBBbmRyb2lkIFRBR1MgKHJlcXVpcmVzIHJ1bGUgY2hlY2tpbmcpCgkqIFNWRyBubyBsb2FkIG9yIGZhaWx1cmUgaW4gT3BlcmEgWEhSCgkqIFJlcG9ydGVkIGlzc3VlcyB3aXRoIElFNy84CiAqLwoKKGZ1bmN0aW9uKCkgewoJInVzZSBzdHJpY3QiOwoKCS8qKgoJICogVGhlIExvYWRRdWV1ZSBjbGFzcyBpcyB0aGUgbWFpbiBBUEkgZm9yIHByZWxvYWRpbmcgY29udGVudC4gTG9hZFF1ZXVlIGlzIGEgbG9hZCBtYW5hZ2VyLCB3aGljaCBjYW4gcHJlbG9hZCBlaXRoZXIKCSAqIGEgc2luZ2xlIGZpbGUsIG9yIHF1ZXVlIG9mIGZpbGVzLgoJICoKCSAqIDxiPkNyZWF0aW5nIGEgUXVldWU8L2I+PGJyIC8+CgkgKiBUbyB1c2UgTG9hZFF1ZXVlLCBjcmVhdGUgYSBMb2FkUXVldWUgaW5zdGFuY2UuIElmIHlvdSB3YW50IHRvIGZvcmNlIHRhZyBsb2FkaW5nIHdoZXJlIHBvc3NpYmxlLCBzZXQgdGhlIHVzZVhIUgoJICogYXJndW1lbnQgdG8gZmFsc2UuCgkgKgoJICogICAgICB2YXIgcXVldWUgPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUpOwoJICoKCSAqIDxiPkxpc3RlbmluZyBmb3IgRXZlbnRzPC9iPjxiciAvPgoJICogQWRkIGFueSBsaXN0ZW5lcnMgeW91IHdhbnQgdG8gdGhlIHF1ZXVlLiBTaW5jZSBQcmVsb2FkSlMgMC4zLjAsIHRoZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlciJ9fXt7L2Nyb3NzTGlua319CgkgKiBsZXRzIHlvdSBhZGQgYXMgbWFueSBsaXN0ZW5lcnMgYXMgeW91IHdhbnQgZm9yIGV2ZW50cy4gWW91IGNhbiBzdWJzY3JpYmUgdG8gdGhlIGZvbGxvd2luZyBldmVudHM6PHVsPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2NvbXBsZXRlOmV2ZW50In19e3svY3Jvc3NMaW5rfX06IGZpcmVkIHdoZW4gYSBxdWV1ZSBjb21wbGV0ZXMgbG9hZGluZyBhbGwKCSAqICAgICBmaWxlczwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvZXJyb3I6ZXZlbnQifX17ey9jcm9zc0xpbmt9fTogZmlyZWQgd2hlbiB0aGUgcXVldWUgZW5jb3VudGVycyBhbiBlcnJvciB3aXRoCgkgKiAgICAgYW55IGZpbGUuPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319OiBQcm9ncmVzcyBmb3IgdGhlIGVudGlyZSBxdWV1ZSBoYXMKCSAqICAgICBjaGFuZ2VkLjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVsb2FkOmV2ZW50In19e3svY3Jvc3NMaW5rfX06IEEgc2luZ2xlIGZpbGUgaGFzIGNvbXBsZXRlZCBsb2FkaW5nLjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVwcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319OiBQcm9ncmVzcyBmb3IgYSBzaW5nbGUgZmlsZSBoYXMgY2hhbmdlcy4gTm90ZQoJICogICAgIHRoYXQgb25seSBmaWxlcyBsb2FkZWQgd2l0aCBYSFIgKG9yIHBvc3NpYmx5IGJ5IHBsdWdpbnMpIHdpbGwgZmlyZSBwcm9ncmVzcyBldmVudHMgb3RoZXIgdGhhbiAwIG9yIDEwMCUuPC9saT4KCSAqIDwvdWw+CgkgKgoJICogICAgICBxdWV1ZS5vbigiZmlsZWxvYWQiLCBoYW5kbGVGaWxlTG9hZCwgdGhpcyk7CgkgKiAgICAgIHF1ZXVlLm9uKCJjb21wbGV0ZSIsIGhhbmRsZUNvbXBsZXRlLCB0aGlzKTsKCSAqCgkgKiA8Yj5BZGRpbmcgZmlsZXMgYW5kIG1hbmlmZXN0czwvYj48YnIgLz4KCSAqIEFkZCBmaWxlcyB5b3Ugd2FudCB0byBsb2FkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3IgYWRkIG11bHRpcGxlIGZpbGVzIGF0IGEKCSAqIHRpbWUgdXNpbmcgYSBsaXN0IG9yIGEgbWFuaWZlc3QgZGVmaW5pdGlvbiB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fS4gRmlsZXMgYXJlCgkgKiBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoZSBhY3RpdmUgcXVldWUsIHNvIHlvdSBjYW4gdXNlIHRoZXNlIG1ldGhvZHMgYXMgbWFueSB0aW1lcyBhcyB5b3UgbGlrZSwgd2hlbmV2ZXIgeW91CgkgKiBsaWtlLgoJICoKCSAqICAgICAgcXVldWUubG9hZEZpbGUoImZpbGVQYXRoL2ZpbGUuanBnIik7CgkgKiAgICAgIHF1ZXVlLmxvYWRGaWxlKHtpZDoiaW1hZ2UiLCBzcmM6ImZpbGVQYXRoL2ZpbGUuanBnIn0pOwoJICogICAgICBxdWV1ZS5sb2FkTWFuaWZlc3QoWyJmaWxlUGF0aC9maWxlLmpwZyIsIHtpZDoiaW1hZ2UiLCBzcmM6ImZpbGVQYXRoL2ZpbGUuanBnIn1dKTsKCSAqCgkgKiBJZiB5b3UgcGFzcyBgZmFsc2VgIGFzIHRoZSBgbG9hZE5vd2AgcGFyYW1ldGVyLCB0aGUgcXVldWUgd2lsbCBub3Qga2ljayBvZiB0aGUgbG9hZCBvZiB0aGUgZmlsZXMsIGJ1dCBpdCB3aWxsIG5vdAoJICogc3RvcCBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQuIENhbGwgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvbG9hZCJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCB0byBiZWdpbgoJICogYSBwYXVzZWQgcXVldWUuIE5vdGUgdGhhdCBhIHBhdXNlZCBxdWV1ZSB3aWxsIGF1dG9tYXRpY2FsbHkgcmVzdW1lIHdoZW4gbmV3IGZpbGVzIGFyZSBhZGRlZCB0byBpdCB3aXRoIGEKCSAqIGBsb2FkTm93YCBhcmd1bWVudCBvZiBgdHJ1ZWAuCgkgKgoJICogICAgICBxdWV1ZS5sb2FkKCk7CgkgKgoJICogPGI+RmlsZSBUeXBlczwvYj48YnIgLz4KCSAqIFRoZSBmaWxlIHR5cGUgb2YgYSBtYW5pZmVzdCBpdGVtIGlzIGF1dG8tZGV0ZXJtaW5lZCBieSB0aGUgZmlsZSBleHRlbnNpb24uIFRoZSBwYXR0ZXJuIG1hdGNoaW5nIGluIFByZWxvYWRKUwoJICogc2hvdWxkIGhhbmRsZSB0aGUgbWFqb3JpdHkgb2Ygc3RhbmRhcmQgZmlsZSBhbmQgdXJsIGZvcm1hdHMsIGFuZCB3b3JrcyB3aXRoIGNvbW1vbiBmaWxlIGV4dGVuc2lvbnMuIElmIHlvdSBoYXZlCgkgKiBlaXRoZXIgYSBub24tc3RhbmRhcmQgZmlsZSBleHRlbnNpb24sIG9yIGFyZSBzZXJ2aW5nIHRoZSBmaWxlIHVzaW5nIGEgcHJveHkgc2NyaXB0LCB0aGVuIHlvdSBjYW4gcGFzcyBpbiBhCgkgKiA8Y29kZT50eXBlPC9jb2RlPiBwcm9wZXJ0eSB3aXRoIGFueSBtYW5pZmVzdCBpdGVtLgoJICoKCSAqICAgICAgcXVldWUubG9hZEZpbGUoe3NyYzoicGF0aC90by9teUZpbGUubXAzeCIsIHR5cGU6Y3JlYXRlanMuTG9hZFF1ZXVlLlNPVU5EfSk7CgkgKgoJICogICAgICAvLyBOb3RlIHRoYXQgUHJlbG9hZEpTIHdpbGwgbm90IHJlYWQgYSBmaWxlIGV4dGVuc2lvbiBmcm9tIHRoZSBxdWVyeSBzdHJpbmcKCSAqICAgICAgcXVldWUubG9hZEZpbGUoe3NyYzoiaHR0cDovL3NlcnZlci5jb20vcHJveHk/ZmlsZT1pbWFnZS5qcGciLCB0eXBlOmNyZWF0ZWpzLkxvYWRRdWV1ZS5JTUFHRX0pOwoJICoKCSAqIFN1cHBvcnRlZCB0eXBlcyBhcmUgZGVmaW5lZCBvbiB0aGUgTG9hZFF1ZXVlIGNsYXNzLCBhbmQgaW5jbHVkZToKCSAqIDx1bD4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvQklOQVJZOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IFJhdyBiaW5hcnkgZGF0YSB2aWEgWEhSPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvQ1NTOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IENTUyBmaWxlczwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL0lNQUdFOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IENvbW1vbiBpbWFnZSBmb3JtYXRzPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvSkFWQVNDUklQVDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKYXZhU2NyaXB0IGZpbGVzPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvSlNPTjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKU09OIGRhdGE8L2xpPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9KU09OUDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKU09OIGZpbGVzIGNyb3NzLWRvbWFpbjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL01BTklGRVNUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IEEgbGlzdCBvZiBmaWxlcyB0byBsb2FkIGluIEpTT04gZm9ybWF0LCBzZWUKCSAqICAgICB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fTwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1NPVU5EOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IEF1ZGlvIGZpbGUgZm9ybWF0czwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1NWRzpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBTVkcgZmlsZXM8L2xpPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9URVhUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IFRleHQgZmlsZXMgLSBYSFIgb25seTwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1hNTDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBYTUwgZGF0YTwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIDxiPkhhbmRsaW5nIFJlc3VsdHM8L2I+PGJyIC8+CgkgKiBXaGVuIGEgZmlsZSBpcyBmaW5pc2hlZCBkb3dubG9hZGluZywgYSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319IGV2ZW50IGlzCgkgKiBkaXNwYXRjaGVkLiBJbiBhbiBleGFtcGxlIGFib3ZlLCB0aGVyZSBpcyBhbiBldmVudCBsaXN0ZW5lciBzbmlwcGV0IGZvciBmaWxlbG9hZC4gTG9hZGVkIGZpbGVzIGFyZSB1c3VhbGx5IGEKCSAqIHJlc29sdmVkIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGltbWVkaWF0ZWx5LCBpbmNsdWRpbmc6CgkgKiA8dWw+CgkgKiAgICAgPGxpPkltYWdlOiBBbiAmbHQ7aW1nIC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPkF1ZGlvOiBBbiAmbHQ7YXVkaW8gLyZndDsgdGFnPC9hPgoJICogICAgIDxsaT5KYXZhU2NyaXB0OiBBICZsdDtzY3JpcHQgLyZndDsgdGFnPC9saT4KCSAqICAgICA8bGk+Q1NTOiBBICZsdDtsaW5rIC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPlhNTDogQW4gWE1MIERPTSBub2RlPC9saT4KCSAqICAgICA8bGk+U1ZHOiBBbiAmbHQ7b2JqZWN0IC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPkpTT046IEEgZm9ybWF0dGVkIEphdmFTY3JpcHQgT2JqZWN0PC9saT4KCSAqICAgICA8bGk+VGV4dDogUmF3IHRleHQ8L2xpPgoJICogICAgIDxsaT5CaW5hcnk6IFRoZSBiaW5hcnkgbG9hZGVkIHJlc3VsdDwvbGk+CgkgKiA8L3VsPgoJICoKCSAqICAgICAgZnVuY3Rpb24gaGFuZGxlRmlsZUxvYWQoZXZlbnQpIHsKCSAqICAgICAgICAgIHZhciBpdGVtID0gZXZlbnQuaXRlbTsgLy8gQSByZWZlcmVuY2UgdG8gdGhlIGl0ZW0gdGhhdCB3YXMgcGFzc2VkIGluIHRvIHRoZSBMb2FkUXVldWUKCSAqICAgICAgICAgIHZhciB0eXBlID0gaXRlbS50eXBlOwoJICoKCSAqICAgICAgICAgIC8vIEFkZCBhbnkgaW1hZ2VzIHRvIHRoZSBwYWdlIGJvZHkuCgkgKiAgICAgICAgICBpZiAodHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSU1BR0UpIHsKCSAqICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGV2ZW50LnJlc3VsdCk7CgkgKiAgICAgICAgICB9CgkgKiAgICAgIH0KCSAqCgkgKiBBdCBhbnkgdGltZSBhZnRlciB0aGUgZmlsZSBoYXMgYmVlbiBsb2FkZWQgKHVzdWFsbHkgYWZ0ZXIgdGhlIHF1ZXVlIGhhcyBjb21wbGV0ZWQpLCBhbnkgcmVzdWx0IGNhbiBiZSBsb29rZWQgdXAKCSAqIHZpYSBpdHMgImlkIiB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9nZXRSZXN1bHQifX17ey9jcm9zc0xpbmt9fS4gSWYgbm8gaWQgd2FzIHByb3ZpZGVkLCB0aGVuIHRoZSAic3JjIiBvcgoJICogZmlsZSBwYXRoIGNhbiBiZSB1c2VkIGluc3RlYWQsIGluY2x1ZGluZyB0aGUgYHBhdGhgIGRlZmluZWQgYnkgYSBtYW5pZmVzdCwgYnV0IDxzdHJvbmc+bm90IGluY2x1ZGluZzwvc3Ryb25nPiBhCgkgKiBiYXNlIHBhdGggZGVmaW5lZCBvbiB0aGUgTG9hZFF1ZXVlLiBJdCBpcyByZWNvbW1lbmRlZCB0byBhbHdheXMgcGFzcyBhbiBpZC4KCSAqCgkgKiAgICAgIHZhciBpbWFnZSA9IHF1ZXVlLmdldFJlc3VsdCgiaW1hZ2UiKTsKCSAqICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbWFnZSk7CgkgKgoJICogUmF3IGxvYWRlZCBjb250ZW50IGNhbiBiZSBhY2Nlc3NlZCB1c2luZyB0aGUgPGNvZGU+cmF3UmVzdWx0PC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fQoJICogZXZlbnQsIG9yIGNhbiBiZSBsb29rZWQgdXAgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZ2V0UmVzdWx0In19e3svY3Jvc3NMaW5rfX0sIHBhc3NpbmcgYHRydWVgIGFzIHRoZSAybmQKCSAqIGFyZ3VtZW50LiBUaGlzIGlzIG9ubHkgYXBwbGljYWJsZSBmb3IgY29udGVudCB0aGF0IGhhcyBiZWVuIHBhcnNlZCBmb3IgdGhlIGJyb3dzZXIsIHNwZWNpZmljYWxseTogSmF2YVNjcmlwdCwKCSAqIENTUywgWE1MLCBTVkcsIGFuZCBKU09OIG9iamVjdHMsIG9yIGFueXRoaW5nIGxvYWRlZCB3aXRoIFhIUi4KCSAqCgkgKiAgICAgIHZhciBpbWFnZSA9IHF1ZXVlLmdldFJlc3VsdCgiaW1hZ2UiLCB0cnVlKTsgLy8gbG9hZCB0aGUgYmluYXJ5IGltYWdlIGRhdGEgbG9hZGVkIHdpdGggWEhSLgoJICoKCSAqIDxiPlBsdWdpbnM8L2I+PGJyIC8+CgkgKiBMb2FkUXVldWUgaGFzIGEgc2ltcGxlIHBsdWdpbiBhcmNoaXRlY3R1cmUgdG8gaGVscCBwcm9jZXNzIGFuZCBwcmVsb2FkIGNvbnRlbnQuIEZvciBleGFtcGxlLCB0byBwcmVsb2FkIGF1ZGlvLAoJICogbWFrZSBzdXJlIHRvIGluc3RhbGwgdGhlIDxhIGhyZWY9Imh0dHA6Ly9zb3VuZGpzLmNvbSI+U291bmRKUzwvYT4gU291bmQgY2xhc3MsIHdoaWNoIHdpbGwgaGVscCBsb2FkIEhUTUwgYXVkaW8sCgkgKiBGbGFzaCBhdWRpbywgYW5kIFdlYkF1ZGlvIGZpbGVzLiBUaGlzIHNob3VsZCBiZSBpbnN0YWxsZWQgPHN0cm9uZz5iZWZvcmU8L3N0cm9uZz4gbG9hZGluZyBhbnkgYXVkaW8gZmlsZXMuCgkgKgoJICogICAgICBxdWV1ZS5pbnN0YWxsUGx1Z2luKGNyZWF0ZWpzLlNvdW5kKTsKCSAqCgkgKiA8aDQ+S25vd24gQnJvd3NlciBJc3N1ZXM8L2g0PgoJICogPHVsPgoJICogICAgIDxsaT5Ccm93c2VycyB3aXRob3V0IGF1ZGlvIHN1cHBvcnQgY2FuIG5vdCBsb2FkIGF1ZGlvIGZpbGVzLjwvbGk+CgkgKiAgICAgPGxpPlNhZmFyaSBvbiBNYWMgT1MgWCBjYW4gb25seSBwbGF5IEhUTUwgYXVkaW8gaWYgUXVpY2tUaW1lIGlzIGluc3RhbGxlZDwvbGk+CgkgKiAgICAgPGxpPkhUTUwgQXVkaW8gdGFncyB3aWxsIG9ubHkgZG93bmxvYWQgdW50aWwgdGhlaXIgPGNvZGU+Y2FuUGxheVRocm91Z2g8L2NvZGU+IGV2ZW50IGlzIGZpcmVkLiBCcm93c2VycyBvdGhlcgoJICogICAgIHRoYW4gQ2hyb21lIHdpbGwgY29udGludWUgdG8gZG93bmxvYWQgaW4gdGhlIGJhY2tncm91bmQuPC9saT4KCSAqICAgICA8bGk+V2hlbiBsb2FkaW5nIHNjcmlwdHMgdXNpbmcgdGFncywgdGhleSBhcmUgYXV0b21hdGljYWxseSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuPC9saT4KCSAqICAgICA8bGk+U2NyaXB0cyBsb2FkZWQgdmlhIFhIUiBtYXkgbm90IGJlIHByb3Blcmx5IGluc3BlY3RhYmxlIHdpdGggYnJvd3NlciB0b29scy48L2xpPgoJICogICAgIDxsaT5JRTYgYW5kIElFNyAoYW5kIHNvbWUgb3RoZXIgYnJvd3NlcnMpIG1heSBub3QgYmUgYWJsZSB0byBsb2FkIFhNTCwgVGV4dCwgb3IgSlNPTiwgc2luY2UgdGhleSByZXF1aXJlCgkgKiAgICAgWEhSIHRvIHdvcmsuPC9saT4KCSAqICAgICA8bGk+Q29udGVudCBsb2FkZWQgdmlhIHRhZ3Mgd2lsbCBub3Qgc2hvdyBwcm9ncmVzcywgYW5kIHdpbGwgY29udGludWUgdG8gZG93bmxvYWQgaW4gdGhlIGJhY2tncm91bmQgd2hlbgoJICogICAgIGNhbmNlbGVkLCBhbHRob3VnaCBubyBldmVudHMgd2lsbCBiZSBkaXNwYXRjaGVkLjwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIEBjbGFzcyBMb2FkUXVldWUKCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZVhIUj10cnVlXSBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHByZWxvYWQgaW5zdGFuY2Ugd2lsbCBmYXZvciBsb2FkaW5nIHdpdGggWEhSIChYTUwgSFRUUAoJICogUmVxdWVzdHMpLCBvciBIVE1MIHRhZ3MuIFdoZW4gdGhpcyBpcyBgZmFsc2VgLCB0aGUgcXVldWUgd2lsbCB1c2UgdGFnIGxvYWRpbmcgd2hlbiBwb3NzaWJsZSwgYW5kIGZhbGwgYmFjayBvbiBYSFIKCSAqIHdoZW4gbmVjZXNzYXJ5LgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aD0iIl0gQSBwYXRoIHRoYXQgd2lsbCBiZSBwcmVwZW5kZWQgb24gdG8gdGhlIHNvdXJjZSBwYXJhbWV0ZXIgb2YgYWxsIGl0ZW1zIGluIHRoZSBxdWV1ZQoJICogYmVmb3JlIHRoZXkgYXJlIGxvYWRlZC4gIFNvdXJjZXMgYmVnaW5uaW5nIHdpdGggYSBwcm90b2NvbCBzdWNoIGFzIGBodHRwOi8vYCBvciBhIHJlbGF0aXZlIHBhdGggc3VjaCBhcyBgLi4vYAoJICogd2lsbCBub3QgcmVjZWl2ZSBhIGJhc2UgcGF0aC4KCSAqIEBwYXJhbSB7U3RyaW5nfEJvb2xlYW59IFtjcm9zc09yaWdpbj0iIl0gQW4gb3B0aW9uYWwgZmxhZyB0byBzdXBwb3J0IGltYWdlcyBsb2FkZWQgZnJvbSBhIENPUlMtZW5hYmxlZCBzZXJ2ZXIuIFRvCgkgKiB1c2UgaXQsIHNldCB0aGlzIHZhbHVlIHRvIGB0cnVlYCwgd2hpY2ggd2lsbCBkZWZhdWx0IHRoZSBjcm9zc09yaWdpbiBwcm9wZXJ0eSBvbiBpbWFnZXMgdG8gIkFub255bW91cyIuIEFueQoJICogc3RyaW5nIHZhbHVlIHdpbGwgYmUgcGFzc2VkIHRocm91Z2gsIGJ1dCBvbmx5ICIiIGFuZCAiQW5vbnltb3VzIiBhcmUgcmVjb21tZW5kZWQuCgkgKiBAY29uc3RydWN0b3IKCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKi8KCXZhciBMb2FkUXVldWUgPSBmdW5jdGlvbih1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbikgewoJCXRoaXMuaW5pdCh1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbik7Cgl9OwoKCXZhciBwID0gTG9hZFF1ZXVlLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5BYnN0cmFjdExvYWRlcigpOwoJTG9hZFF1ZXVlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IExvYWRRdWV1ZTsKCXZhciBzID0gTG9hZFF1ZXVlOwoKCS8qKgoJICogVGltZSBpbiBtaWxsaXNlY29uZHMgdG8gYXNzdW1lIGEgbG9hZCBoYXMgZmFpbGVkLiBBbiB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2Vycm9yOmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50IGlzIGRpc3BhdGNoZWQgaWYgdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCBiZWZvcmUgYW55IGRhdGEgaXMgcmVjZWl2ZWQuCgkgKiBAcHJvcGVydHkgbG9hZFRpbWVvdXQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCA4MDAwCgkgKiBAc3RhdGljCgkgKiBAc2luY2UgMC40LjEKCSAqLwoJcy5sb2FkVGltZW91dCA9IDgwMDA7CgoJLyoqCgkgKiBUaW1lIGluIG1pbGxpc2Vjb25kcyB0byBhc3N1bWUgYSBsb2FkIGhhcyBmYWlsZWQuCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRUaW1lb3V0OnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gcHJvcGVydHkuCgkgKi8KCXMuTE9BRF9USU1FT1VUID0gMDsKCi8vIFByZWxvYWQgVHlwZXMKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IgZ2VuZXJpYyBiaW5hcnkgdHlwZXMuIE5vdGUgdGhhdCBpbWFnZXMgYXJlIGxvYWRlZCBhcyBiaW5hcnkgZmlsZXMgd2hlbiB1c2luZyBYSFIuCgkgKiBAcHJvcGVydHkgQklOQVJZCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgYmluYXJ5CgkgKiBAc3RhdGljCgkgKi8KCXMuQklOQVJZID0gImJpbmFyeSI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBjc3MgZmlsZXMuIENTUyBmaWxlcyBhcmUgbG9hZGVkIHVzaW5nIGEgJmx0O2xpbmsmZ3Q7IHdoZW4gbG9hZGVkIHdpdGggWEhSLCBvciBhCgkgKiAmbHQ7c3R5bGUmZ3Q7IHRhZyB3aGVuIGxvYWRlZCB3aXRoIHRhZ3MuCgkgKiBAcHJvcGVydHkgQ1NTCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgY3NzCgkgKiBAc3RhdGljCgkgKi8KCXMuQ1NTID0gImNzcyI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBpbWFnZSBmaWxlcywgdXN1YWxseSBwbmcsIGdpZiwgb3IganBnL2pwZWcuIEltYWdlcyBhcmUgbG9hZGVkIGludG8gYW4gJmx0O2ltYWdlJmd0OyB0YWcuCgkgKiBAcHJvcGVydHkgSU1BR0UKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAZGVmYXVsdCBpbWFnZQoJICogQHN0YXRpYwoJICovCglzLklNQUdFID0gImltYWdlIjsKCgkvKioKCSAqIFRoZSBwcmVsb2FkIHR5cGUgZm9yIGphdmFzY3JpcHQgZmlsZXMsIHVzdWFsbHkgd2l0aCB0aGUgImpzIiBmaWxlIGV4dGVuc2lvbi4gSmF2YVNjcmlwdCBmaWxlcyBhcmUgbG9hZGVkIGludG8gYQoJICogJmx0O3NjcmlwdCZndDsgdGFnLgoJICoKCSAqIFNpbmNlIHZlcnNpb24gMC40LjErLCBkdWUgdG8gaG93IHRhZy1sb2FkZWQgc2NyaXB0cyB3b3JrLCBhbGwgSmF2YVNjcmlwdCBmaWxlcyBhcmUgYXV0b21hdGljYWxseSBpbmplY3RlZCBpbnRvCgkgKiB0aGUgYm9keSBvZiB0aGUgZG9jdW1lbnQgdG8gbWFpbnRhaW4gcGFyaXR5IGJldHdlZW4gWEhSIGFuZCB0YWctbG9hZGVkIHNjcmlwdHMuIEluIHZlcnNpb24gMC40LjAgYW5kIGVhcmxpZXIsCgkgKiBvbmx5IHRhZy1sb2FkZWQgc2NyaXB0cyBhcmUgaW5qZWN0ZWQuCgkgKiBAcHJvcGVydHkgSkFWQVNDUklQVAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBkZWZhdWx0IGphdmFzY3JpcHQKCSAqIEBzdGF0aWMKCSAqLwoJcy5KQVZBU0NSSVBUID0gImphdmFzY3JpcHQiOwoKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IganNvbiBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIEpTT04gZGF0YSBpcyBsb2FkZWQgYW5kIHBhcnNlZCBpbnRvIGEKCSAqIEphdmFTY3JpcHQgb2JqZWN0LiBOb3RlIHRoYXQgaWYgYSBgY2FsbGJhY2tgIGlzIHByZXNlbnQgb24gdGhlIGxvYWQgaXRlbSwgdGhlIGZpbGUgd2lsbCBiZSBsb2FkZWQgd2l0aCBKU09OUCwKCSAqIG5vIG1hdHRlciB3aGF0IHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS91c2VYSFI6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fSBwcm9wZXJ0eSBpcyBzZXQgdG8sIGFuZCB0aGUgSlNPTgoJICogbXVzdCBjb250YWluIGEgbWF0Y2hpbmcgd3JhcHBlciBmdW5jdGlvbi4KCSAqIEBwcm9wZXJ0eSBKU09OCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQganNvbgoJICogQHN0YXRpYwoJICovCglzLkpTT04gPSAianNvbiI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBqc29ucCBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIEpTT04gZGF0YSBpcyBsb2FkZWQgYW5kIHBhcnNlZCBpbnRvIGEKCSAqIEphdmFTY3JpcHQgb2JqZWN0LiBZb3UgYXJlIHJlcXVpcmVkIHRvIHBhc3MgYSBjYWxsYmFjayBwYXJhbWV0ZXIgdGhhdCBtYXRjaGVzIHRoZSBmdW5jdGlvbiB3cmFwcGVyIGluIHRoZSBKU09OLgoJICogTm90ZSB0aGF0IEpTT05QIHdpbGwgYWx3YXlzIGJlIHVzZWQgaWYgdGhlcmUgaXMgYSBjYWxsYmFjayBwcmVzZW50LCBubyBtYXR0ZXIgd2hhdCB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvdXNlWEhSOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0KCSAqIHByb3BlcnR5IGlzIHNldCB0by4KCSAqIEBwcm9wZXJ0eSBKU09OUAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBkZWZhdWx0IGpzb25wCgkgKiBAc3RhdGljCgkgKi8KCXMuSlNPTlAgPSAianNvbnAiOwoKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IganNvbi1iYXNlZCBtYW5pZmVzdCBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIFRoZSBKU09OIGRhdGEgaXMgbG9hZGVkCgkgKiBhbmQgcGFyc2VkIGludG8gYSBKYXZhU2NyaXB0IG9iamVjdC4gUHJlbG9hZEpTIHdpbGwgdGhlbiBsb29rIGZvciBhICJtYW5pZmVzdCIgcHJvcGVydHkgaW4gdGhlIEpTT04sIHdoaWNoIGlzIGFuCgkgKiBBcnJheSBvZiBmaWxlcyB0byBsb2FkLCBmb2xsb3dpbmcgdGhlIHNhbWUgZm9ybWF0IGFzIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogbWV0aG9kLiBJZiBhICJjYWxsYmFjayIgaXMgc3BlY2lmaWVkIG9uIHRoZSBtYW5pZmVzdCBvYmplY3QsIHRoZW4gaXQgd2lsbCBiZSBsb2FkZWQgdXNpbmcgSlNPTlAgaW5zdGVhZCwKCSAqIHJlZ2FyZGxlc3Mgb2Ygd2hhdCB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvdXNlWEhSOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gcHJvcGVydHkgaXMgc2V0IHRvLgoJICogQHByb3BlcnR5IE1BTklGRVNUCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgbWFuaWZlc3QKCSAqIEBzdGF0aWMKCSAqIEBzaW5jZSAwLjQuMQoJICovCglzLk1BTklGRVNUID0gIm1hbmlmZXN0IjsKCgkvKioKCSAqIFRoZSBwcmVsb2FkIHR5cGUgZm9yIHNvdW5kIGZpbGVzLCB1c3VhbGx5IG1wMywgb2dnLCBvciB3YXYuIFdoZW4gbG9hZGluZyB2aWEgdGFncywgYXVkaW8gaXMgbG9hZGVkIGludG8gYW4KCSAqICZsdDthdWRpbyZndDsgdGFnLgoJICogQHByb3BlcnR5IFNPVU5ECgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgc291bmQKCSAqIEBzdGF0aWMKCSAqLwoJcy5TT1VORCA9ICJzb3VuZCI7CgoJLyoqCiAgICAgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBTVkcgZmlsZXMuCgkgKiBAcHJvcGVydHkgU1ZHCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgc3ZnCgkgKiBAc3RhdGljCgkgKi8KCXMuU1ZHID0gInN2ZyI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciB0ZXh0IGZpbGVzLCB3aGljaCBpcyBhbHNvIHRoZSBkZWZhdWx0IGZpbGUgdHlwZSBpZiB0aGUgdHlwZSBjYW4gbm90IGJlIGRldGVybWluZWQuIFRleHQgaXMKCSAqIGxvYWRlZCBhcyByYXcgdGV4dC4KCSAqIEBwcm9wZXJ0eSBURVhUCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgdGV4dAoJICogQHN0YXRpYwoJICovCglzLlRFWFQgPSAidGV4dCI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciB4bWwgZmlsZXMuIFhNTCBpcyBsb2FkZWQgaW50byBhbiBYTUwgZG9jdW1lbnQuCgkgKiBAcHJvcGVydHkgWE1MCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgeG1sCgkgKiBAc3RhdGljCgkgKi8KCXMuWE1MID0gInhtbCI7CgoJLyoqCgkgKiBEZWZpbmVzIGEgUE9TVCByZXF1ZXN0LCB1c2UgZm9yIGEgbWV0aG9kIHZhbHVlIHdoZW4gbG9hZGluZyBkYXRhLgoJICoKCSAqIEB0eXBlIHtzdHJpbmd9CgkgKi8KCXMuUE9TVCA9ICdQT1NUJzsKCgkvKioKCSAqIERlZmluZXMgYSBHRVQgcmVxdWVzdCwgdXNlIGZvciBhIG1ldGhvZCB2YWx1ZSB3aGVuIGxvYWRpbmcgZGF0YS4KCSAqCgkgKiBAdHlwZSB7c3RyaW5nfQoJICovCglzLkdFVCA9ICdHRVQnOwoKCi8vIFByb3RvdHlwZQoJLyoqCgkgKiBBIHBhdGggdGhhdCB3aWxsIGJlIHByZXBlbmRlZCBvbiB0byB0aGUgaXRlbSdzIGBzcmNgLiBUaGUgYF9iYXNlUGF0aGAgcHJvcGVydHkgd2lsbCBvbmx5IGJlIHVzZWQgaWYgYW4gaXRlbSdzCgkgKiBzb3VyY2UgaXMgcmVsYXRpdmUsIGFuZCBkb2VzIG5vdCBpbmNsdWRlIGEgcHJvdG9jb2wgc3VjaCBhcyBgaHR0cDovL2AsIG9yIGEgcmVsYXRpdmUgcGF0aCBzdWNoIGFzIGAuLi9gLgoJICogQHByb3BlcnR5IF9iYXNlUGF0aAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBwcml2YXRlCgkgKiBAc2luY2UgMC4zLjEKCSAqLwoJcC5fYmFzZVBhdGggPSBudWxsOwoKCS8qKgoJICogQW4gb3B0aW9uYWwgZmxhZyB0byBzZXQgb24gaW1hZ2VzIHRoYXQgYXJlIGxvYWRlZCB1c2luZyBQcmVsb2FkSlMsIHdoaWNoIGVuYWJsZXMgQ09SUyBzdXBwb3J0LiBJbWFnZXMgbG9hZGVkCgkgKiBjcm9zcy1kb21haW4gYnkgc2VydmVycyB0aGF0IHN1cHBvcnQgQ09SUyByZXF1aXJlIHRoZSBjcm9zc09yaWdpbiBmbGFnIHRvIGJlIGxvYWRlZCBhbmQgaW50ZXJhY3RlZCB3aXRoIGJ5CgkgKiBhIGNhbnZhcy4gV2hlbiBsb2FkaW5nIGxvY2FsbHksIG9yIHdpdGggYSBzZXJ2ZXIgd2l0aCBubyBDT1JTIHN1cHBvcnQsIHRoaXMgZmxhZyBjYW4gY2F1c2Ugb3RoZXIgc2VjdXJpdHkgaXNzdWVzLAoJICogc28gaXQgaXMgcmVjb21tZW5kZWQgdG8gb25seSBzZXQgaXQgaWYgeW91IGFyZSBzdXJlIHRoZSBzZXJ2ZXIgc3VwcG9ydHMgaXQuIEN1cnJlbnRseSwgc3VwcG9ydGVkIHZhbHVlcyBhcmUgIiIKCSAqIGFuZCAiQW5vbnltb3VzIi4KCSAqIEBwcm9wZXJ0eSBfY3Jvc3NPcmlnaW4KCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAZGVmYXVsdFZhbHVlICIiCgkgKiBAcHJpdmF0ZQoJICogQHNpbmNlIDAuNC4xCgkgKi8KCXAuX2Nyb3NzT3JpZ2luID0gIiI7CgoJLyoqCgkgKiBVc2UgWE1MSHR0cFJlcXVlc3QgKFhIUikgd2hlbiBwb3NzaWJsZS4gTm90ZSB0aGF0IExvYWRRdWV1ZSB3aWxsIGRlZmF1bHQgdG8gdGFnIGxvYWRpbmcgb3IgWEhSIGxvYWRpbmcgZGVwZW5kaW5nCgkgKiBvbiB0aGUgcmVxdWlyZW1lbnRzIGZvciBhIG1lZGlhIHR5cGUuIEZvciBleGFtcGxlLCBIVE1MIGF1ZGlvIGNhbiBub3QgYmUgbG9hZGVkIHdpdGggWEhSLCBhbmQgV2ViQXVkaW8gY2FuIG5vdCBiZQoJICogbG9hZGVkIHdpdGggdGFncywgc28gaXQgd2lsbCBkZWZhdWx0IHRoZSB0aGUgY29ycmVjdCB0eXBlIGluc3RlYWQgb2YgdXNpbmcgdGhlIHVzZXItZGVmaW5lZCB0eXBlLgoJICoKCSAqIDxiPk5vdGU6IFRoaXMgcHJvcGVydHkgaXMgcmVhZC1vbmx5LjwvYj4gVG8gY2hhbmdlIGl0LCBwbGVhc2UgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zZXRVc2VYSFIifX17ey9jcm9zc0xpbmt9fQoJICogbWV0aG9kLCBvciBzcGVjaWZ5IHRoZSBgdXNlWEhSYCBhcmd1bWVudCBpbiB0aGUgTG9hZFF1ZXVlIGNvbnN0cnVjdG9yLgoJICoKCSAqIEBwcm9wZXJ0eSB1c2VYSFIKCSAqIEB0eXBlIHtCb29sZWFufQoJICogQHJlYWRPbmx5CgkgKiBAZGVmYXVsdCB0cnVlCgkgKi8KCXAudXNlWEhSID0gdHJ1ZTsKCgkvKioKCSAqIERldGVybWluZXMgaWYgdGhlIExvYWRRdWV1ZSB3aWxsIHN0b3AgcHJvY2Vzc2luZyB0aGUgY3VycmVudCBxdWV1ZSB3aGVuIGFuIGVycm9yIGlzIGVuY291bnRlcmVkLgoJICogQHByb3BlcnR5IHN0b3BPbkVycm9yCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKi8KCXAuc3RvcE9uRXJyb3IgPSBmYWxzZTsKCgkvKioKCSAqIEVuc3VyZSBsb2FkZWQgc2NyaXB0cyAiY29tcGxldGUiIGluIHRoZSBvcmRlciB0aGV5IGFyZSBzcGVjaWZpZWQuIExvYWRlZCBzY3JpcHRzIGFyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQgaGVhZAoJICogb25jZSB0aGV5IGFyZSBsb2FkZWQuIFNjcmlwdHMgbG9hZGVkIHZpYSB0YWdzIHdpbGwgbG9hZCBvbmUtYXQtYS10aW1lIHdoZW4gdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAsIHdoZXJlYXMKCSAqIHNjcmlwdHMgbG9hZGVkIHVzaW5nIFhIUiBjYW4gbG9hZCBpbiBhbnkgb3JkZXIsIGJ1dCB3aWxsICJmaW5pc2giIGFuZCBiZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQgaW4gdGhlIG9yZGVyCgkgKiBzcGVjaWZpZWQuCgkgKgoJICogQW55IGl0ZW1zIGNhbiBiZSBzZXQgdG8gbG9hZCBpbiBvcmRlciBieSBzZXR0aW5nIHRoZSBgbWFpbnRhaW5PcmRlcmAgcHJvcGVydHkgb24gdGhlIGxvYWQgaXRlbSwgb3IgYnkgZW5zdXJpbmcKCSAqIHRoYXQgb25seSBvbmUgY29ubmVjdGlvbiBjYW4gYmUgb3BlbiBhdCBhIHRpbWUgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fS4KCSAqIE5vdGUgdGhhdCB3aGVuIHRoZSBgbWFpbnRhaW5TY3JpcHRPcmRlcmAgcHJvcGVydHkgaXMgc2V0IHRvIGB0cnVlYCwgc2NyaXB0cyBpdGVtcyBhcmUgYXV0b21hdGljYWxseSBzZXQgdG8KCSAqIGBtYWludGFpbk9yZGVyPXRydWVgLCBhbmQgY2hhbmdpbmcgdGhlIGBtYWludGFpblNjcmlwdE9yZGVyYCB0byBgZmFsc2VgIGR1cmluZyBhIGxvYWQgd2lsbCBub3QgY2hhbmdlIGl0ZW1zCgkgKiBhbHJlYWR5IGluIGEgcXVldWUuCgkgKgoJICogPGg0PkV4YW1wbGU8L2g0PgoJICoKCSAqICAgICAgdmFyIHF1ZXVlID0gbmV3IGNyZWF0ZWpzLkxvYWRRdWV1ZSgpOwoJICogICAgICBxdWV1ZS5zZXRNYXhDb25uZWN0aW9ucygzKTsgLy8gU2V0IGEgaGlnaGVyIG51bWJlciB0byBsb2FkIG11bHRpcGxlIGl0ZW1zIGF0IG9uY2UKCSAqICAgICAgcXVldWUubWFpbnRhaW5TY3JpcHRPcmRlciA9IHRydWU7IC8vIEVuc3VyZSBzY3JpcHRzIGFyZSBsb2FkZWQgaW4gb3JkZXIKCSAqICAgICAgcXVldWUubG9hZE1hbmlmZXN0KFsKCSAqICAgICAgICAgICJzY3JpcHQxLmpzIiwKCSAqICAgICAgICAgICJzY3JpcHQyLmpzIiwKCSAqICAgICAgICAgICJpbWFnZS5wbmciLCAvLyBMb2FkIGFueSB0aW1lCgkgKiAgICAgICAgICB7c3JjOiAiaW1hZ2UyLnBuZyIsIG1haW50YWluT3JkZXI6IHRydWV9IC8vIFdpbGwgd2FpdCBmb3Igc2NyaXB0Mi5qcwoJICogICAgICAgICAgImltYWdlMy5wbmciLAoJICogICAgICAgICAgInNjcmlwdDMuanMiIC8vIFdpbGwgd2FpdCBmb3IgaW1hZ2UyLnBuZyBiZWZvcmUgbG9hZGluZyAob3IgY29tcGxldGluZyB3aGVuIGxvYWRpbmcgd2l0aCBYSFIpCgkgKiAgICAgIF0pOwoJICoKCSAqIEBwcm9wZXJ0eSBtYWludGFpblNjcmlwdE9yZGVyCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IHRydWUKCSAqLwoJcC5tYWludGFpblNjcmlwdE9yZGVyID0gdHJ1ZTsKCgkvKioKCSAqIFRoZSBuZXh0IHByZWxvYWQgcXVldWUgdG8gcHJvY2VzcyB3aGVuIHRoaXMgb25lIGlzIGNvbXBsZXRlLiBJZiBhbiBlcnJvciBpcyB0aHJvd24gaW4gdGhlIGN1cnJlbnQgcXVldWUsIGFuZAoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc3RvcE9uRXJyb3I6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fSBpcyBgdHJ1ZWAsIHRoZSBuZXh0IHF1ZXVlIHdpbGwgbm90IGJlIHByb2Nlc3NlZC4KCSAqIEBwcm9wZXJ0eSBuZXh0CgkgKiBAdHlwZSB7TG9hZFF1ZXVlfQoJICogQGRlZmF1bHQgbnVsbAoJICovCglwLm5leHQgPSBudWxsOwoKLy8gRXZlbnRzCgkvKioKCSAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbiBpbmRpdmlkdWFsIGZpbGUgaGFzIGxvYWRlZCwgYW5kIGJlZW4gcHJvY2Vzc2VkLgoJICogQGV2ZW50IGZpbGVsb2FkCgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGZpbGUgaXRlbSB3aGljaCB3YXMgc3BlY2lmaWVkIGluIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkRmlsZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBvciB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fSBjYWxsLiBJZiBvbmx5IGEgc3RyaW5nIHBhdGggb3IgdGFnIHdhcyBzcGVjaWZpZWQsIHRoZQoJICogb2JqZWN0IHdpbGwgY29udGFpbiB0aGF0IHZhbHVlIGFzIGEgYHNyY2AgcHJvcGVydHkuCgkgKiBAcGFyYW0ge09iamVjdH0gcmVzdWx0IFRoZSBIVE1MIHRhZyBvciBwYXJzZWQgcmVzdWx0IG9mIHRoZSBsb2FkZWQgaXRlbS4KCSAqIEBwYXJhbSB7T2JqZWN0fSByYXdSZXN1bHQgVGhlIHVucHJvY2Vzc2VkIHJlc3VsdCwgdXN1YWxseSB0aGUgcmF3IHRleHQgb3IgYmluYXJ5IGRhdGEgYmVmb3JlIGl0IGlzIGNvbnZlcnRlZAoJICogdG8gYSB1c2FibGUgb2JqZWN0LgoJICogQHNpbmNlIDAuMy4wCgkgKi8KCgkvKioKCSAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbiBhbiBpbmRpdmlkdWFsIGZpbGUgcHJvZ3Jlc3MgY2hhbmdlcy4KCSAqIEBldmVudCBmaWxlcHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgb2JqZWN0IHRoYXQgZGlzcGF0Y2hlZCB0aGUgZXZlbnQuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBmaWxlIGl0ZW0gd2hpY2ggd2FzIHNwZWNpZmllZCBpbiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0gY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUKCSAqIG9iamVjdCB3aWxsIGNvbnRhaW4gdGhhdCB2YWx1ZSBhcyBhIGBzcmNgIHByb3BlcnR5LgoJICogQHBhcmFtIHtOdW1iZXJ9IGxvYWRlZCBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRoYXQgaGF2ZSBiZWVuIGxvYWRlZC4gTm90ZSB0aGF0IHRoaXMgbWF5IGp1c3QgYmUgYSBwZXJjZW50YWdlIG9mIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gdG90YWwgVGhlIHRvdGFsIG51bWJlciBvZiBieXRlcy4gSWYgaXQgaXMgdW5rbm93biwgdGhlIHZhbHVlIGlzIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gcHJvZ3Jlc3MgVGhlIGFtb3VudCB0aGF0IGhhcyBiZWVuIGxvYWRlZCBiZXR3ZWVuIDAgYW5kIDEuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8qKgoJICogVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGFuIGluZGl2aWR1YWwgZmlsZSBzdGFydHMgdG8gbG9hZC4KCSAqIEBldmVudCBmaWxlc3RhcnQKCSAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgb2JqZWN0IHRoYXQgZGlzcGF0Y2hlZCB0aGUgZXZlbnQuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBmaWxlIGl0ZW0gd2hpY2ggd2FzIHNwZWNpZmllZCBpbiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0gY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUKCSAqIG9iamVjdCB3aWxsIGNvbnRhaW4gdGhhdCB2YWx1ZSBhcyBhIHByb3BlcnR5LgoJICovCgoJLy9UT0RPOiBEZXByZWNhdGVkCgkvKioKCSAqIFJFTU9WRUQuIFVzZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9hZGRFdmVudExpc3RlbmVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkZpbGVMb2FkCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJmaWxlbG9hZCIgZXZlbnQuCgkgKi8KCS8qKgoJICogUkVNT1ZFRC4gVXNlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL2FkZEV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVwcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkZpbGVQcm9ncmVzcwoJICogQHR5cGUge0Z1bmN0aW9ufQoJICogQGRlcHJlY2F0ZWQgVXNlIGFkZEV2ZW50TGlzdGVuZXIgYW5kIHRoZSAiZmlsZXByb2dyZXNzIiBldmVudC4KCSAqLwoKCi8vIFByb3RlY3RlZAoJLyoqCgkgKiBBbiBvYmplY3QgaGFzaCBvZiBjYWxsYmFja3MgdGhhdCBhcmUgZmlyZWQgZm9yIGVhY2ggZmlsZSB0eXBlIGJlZm9yZSB0aGUgZmlsZSBpcyBsb2FkZWQsIGdpdmluZyBwbHVnaW5zIHRoZQoJICogYWJpbGl0eSB0byBvdmVycmlkZSBwcm9wZXJ0aWVzIG9mIHRoZSBsb2FkLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9pbnN0YWxsUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCSAqIEBwcm9wZXJ0eSBfdHlwZUNhbGxiYWNrcwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3R5cGVDYWxsYmFja3MgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgY2FsbGJhY2tzIHRoYXQgYXJlIGZpcmVkIGZvciBlYWNoIGZpbGUgZXh0ZW5zaW9uIGJlZm9yZSB0aGUgZmlsZSBpcyBsb2FkZWQsIGdpdmluZyBwbHVnaW5zIHRoZQoJICogYWJpbGl0eSB0byBvdmVycmlkZSBwcm9wZXJ0aWVzIG9mIHRoZSBsb2FkLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9pbnN0YWxsUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCSAqIEBwcm9wZXJ0eSBfZXh0ZW5zaW9uQ2FsbGJhY2tzCgkgKiBAdHlwZSB7bnVsbH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2V4dGVuc2lvbkNhbGxiYWNrcyA9IG51bGw7CgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHRoZSBsb2FkU3RhcnQgZXZlbnQgd2FzIGRpc3BhdGNoZWQgYWxyZWFkeS4gVGhpcyBldmVudCBpcyBvbmx5IGZpcmVkIG9uZSB0aW1lLCB3aGVuIHRoZSBmaXJzdAoJICogZmlsZSBpcyByZXF1ZXN0ZWQuCgkgKiBAcHJvcGVydHkgX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQKCSAqIEB0eXBlIHtCb29sZWFufQoJICogQGRlZmF1bHQgZmFsc2UKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCgkvKioKCSAqIFRoZSBudW1iZXIgb2YgbWF4aW11bSBvcGVuIGNvbm5lY3Rpb25zIHRoYXQgYSBsb2FkUXVldWUgdHJpZXMgdG8gbWFpbnRhaW4uIFBsZWFzZSBzZWUKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldE1heENvbm5lY3Rpb25zIn19e3svY3Jvc3NMaW5rfX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCgkgKiBAcHJvcGVydHkgX21heENvbm5lY3Rpb25zCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlZmF1bHQgMQoJICogQHByaXZhdGUKCSAqLwoJcC5fbWF4Q29ubmVjdGlvbnMgPSAxOwoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiB0aGVyZSBpcyBjdXJyZW50bHkgYSBzY3JpcHQgbG9hZGluZy4gVGhpcyBoZWxwcyBlbnN1cmUgdGhhdCBvbmx5IGEgc2luZ2xlIHNjcmlwdCBsb2FkcyBhdCBvbmNlIHdoZW4KCSAqIHVzaW5nIGEgc2NyaXB0IHRhZyB0byBkbyBwcmVsb2FkaW5nLgoJICogQHByb3BlcnR5IF9jdXJyZW50bHlMb2FkaW5nU2NyaXB0CgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2N1cnJlbnRseUxvYWRpbmdTY3JpcHQgPSBudWxsOwoKCS8qKgoJICogQW4gYXJyYXkgY29udGFpbmluZyB0aGUgY3VycmVudGx5IGRvd25sb2FkaW5nIGZpbGVzLgoJICogQHByb3BlcnR5IF9jdXJyZW50TG9hZHMKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2N1cnJlbnRMb2FkcyA9IG51bGw7CgoJLyoqCgkgKiBBbiBhcnJheSBjb250YWluaW5nIHRoZSBxdWV1ZWQgaXRlbXMgdGhhdCBoYXZlIG5vdCB5ZXQgc3RhcnRlZCBkb3dubG9hZGluZy4KCSAqIEBwcm9wZXJ0eSBfbG9hZFF1ZXVlCgkgKiBAdHlwZSB7QXJyYXl9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkUXVldWUgPSBudWxsOwoKCS8qKgoJICogQW4gYXJyYXkgY29udGFpbmluZyBkb3dubG9hZHMgdGhhdCBoYXZlIG5vdCBjb21wbGV0ZWQsIHNvIHRoYXQgdGhlIExvYWRRdWV1ZSBjYW4gYmUgcHJvcGVybHkgcmVzZXQuCgkgKiBAcHJvcGVydHkgX2xvYWRRdWV1ZUJhY2t1cAoJICogQHR5cGUge0FycmF5fQoJICogQHByaXZhdGUKCSAqLwoJcC5fbG9hZFF1ZXVlQmFja3VwID0gbnVsbDsKCgkvKioKCSAqIEFuIG9iamVjdCBoYXNoIG9mIGl0ZW1zIHRoYXQgaGF2ZSBmaW5pc2hlZCBkb3dubG9hZGluZywgaW5kZXhlZCBieSBpdGVtIElEcy4KCSAqIEBwcm9wZXJ0eSBfbG9hZEl0ZW1zQnlJZAoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRJdGVtc0J5SWQgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgaXRlbXMgdGhhdCBoYXZlIGZpbmlzaGVkIGRvd25sb2FkaW5nLCBpbmRleGVkIGJ5IGl0ZW0gc291cmNlLgoJICogQHByb3BlcnR5IF9sb2FkSXRlbXNCeVNyYwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRJdGVtc0J5U3JjID0gbnVsbDsKCgkvKioKCSAqIEFuIG9iamVjdCBoYXNoIG9mIGxvYWRlZCBpdGVtcywgaW5kZXhlZCBieSB0aGUgSUQgb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwcm9wZXJ0eSBfbG9hZGVkUmVzdWx0cwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRlZFJlc3VsdHMgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgdW4tcGFyc2VkIGxvYWRlZCBpdGVtcywgaW5kZXhlZCBieSB0aGUgSUQgb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwcm9wZXJ0eSBfbG9hZGVkUmF3UmVzdWx0cwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRlZFJhd1Jlc3VsdHMgPSBudWxsOwoKCS8qKgoJICogVGhlIG51bWJlciBvZiBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZXF1ZXN0ZWQuIFRoaXMgaGVscHMgbWFuYWdlIGFuIG92ZXJhbGwgcHJvZ3Jlc3Mgd2l0aG91dCBrbm93aW5nIGhvdyBsYXJnZQoJICogdGhlIGZpbGVzIGFyZSBiZWZvcmUgdGhleSBhcmUgZG93bmxvYWRlZC4KCSAqIEBwcm9wZXJ0eSBfbnVtSXRlbXMKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCAwCgkgKiBAcHJpdmF0ZQoJICovCglwLl9udW1JdGVtcyA9IDA7CgoJLyoqCgkgKiBUaGUgbnVtYmVyIG9mIGl0ZW1zIHRoYXQgaGF2ZSBjb21wbGV0ZWQgbG9hZGVkLiBUaGlzIGhlbHBzIG1hbmFnZSBhbiBvdmVyYWxsIHByb2dyZXNzIHdpdGhvdXQga25vd2luZyBob3cgbGFyZ2UKCSAqIHRoZSBmaWxlcyBhcmUgYmVmb3JlIHRoZXkgYXJlIGRvd25sb2FkZWQuCgkgKiBAcHJvcGVydHkgX251bUl0ZW1zTG9hZGVkCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlZmF1bHQgMAoJICogQHByaXZhdGUKCSAqLwoJcC5fbnVtSXRlbXNMb2FkZWQgPSAwOwoKCS8qKgoJICogQSBsaXN0IG9mIHNjcmlwdHMgaW4gdGhlIG9yZGVyIHRoZXkgd2VyZSByZXF1ZXN0ZWQuIFRoaXMgaGVscHMgZW5zdXJlIHRoYXQgc2NyaXB0cyBhcmUgImNvbXBsZXRlZCIgaW4gdGhlIHJpZ2h0CgkgKiBvcmRlci4KCSAqIEBwcm9wZXJ0eSBfc2NyaXB0T3JkZXIKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3NjcmlwdE9yZGVyID0gbnVsbDsKCgkvKioKCSAqIEEgbGlzdCBvZiBzY3JpcHRzIHRoYXQgaGF2ZSBiZWVuIGxvYWRlZC4gSXRlbXMgYXJlIGFkZGVkIHRvIHRoaXMgbGlzdCBhcyA8Y29kZT5udWxsPC9jb2RlPiB3aGVuIHRoZXkgYXJlCgkgKiByZXF1ZXN0ZWQsIGNvbnRhaW4gdGhlIGxvYWRlZCBpdGVtIGlmIGl0IGhhcyBjb21wbGV0ZWQsIGJ1dCBub3QgYmVlbiBkaXNwYXRjaGVkIHRvIHRoZSB1c2VyLCBhbmQgPGNvZGU+dHJ1ZTwvdHJ1ZT4KCSAqIG9uY2UgdGhleSBhcmUgY29tcGxldGUgYW5kIGhhdmUgYmVlbiBkaXNwYXRjaGVkLgoJICogQHByb3BlcnR5IF9sb2FkZWRTY3JpcHRzCgkgKiBAdHlwZSB7QXJyYXl9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkZWRTY3JpcHRzID0gbnVsbDsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbih1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbikgewoJCXRoaXMuX251bUl0ZW1zID0gdGhpcy5fbnVtSXRlbXNMb2FkZWQgPSAwOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCXRoaXMuX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCgkJdGhpcy5fY3VycmVudExvYWRzID0gW107CgkJdGhpcy5fbG9hZFF1ZXVlID0gW107CgkJdGhpcy5fbG9hZFF1ZXVlQmFja3VwID0gW107CgkJdGhpcy5fc2NyaXB0T3JkZXIgPSBbXTsKCQl0aGlzLl9sb2FkZWRTY3JpcHRzID0gW107CgkJdGhpcy5fbG9hZEl0ZW1zQnlJZCA9IHt9OwoJCXRoaXMuX2xvYWRJdGVtc0J5U3JjID0ge307CgkJdGhpcy5fbG9hZGVkUmVzdWx0cyA9IHt9OwoJCXRoaXMuX2xvYWRlZFJhd1Jlc3VsdHMgPSB7fTsKCgkJLy8gQ2FsbGJhY2tzIGZvciBwbHVnaW5zCgkJdGhpcy5fdHlwZUNhbGxiYWNrcyA9IHt9OwoJCXRoaXMuX2V4dGVuc2lvbkNhbGxiYWNrcyA9IHt9OwoKCQl0aGlzLl9iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCXRoaXMuc2V0VXNlWEhSKHVzZVhIUik7CgkJdGhpcy5fY3Jvc3NPcmlnaW4gPSAoY3Jvc3NPcmlnaW4gPT09IHRydWUpCgkJCQk/ICJBbm9ueW1vdXMiIDogKGNyb3NzT3JpZ2luID09PSBmYWxzZSB8fCBjcm9zc09yaWdpbiA9PSBudWxsKQoJCQkJPyAiIiA6IGNyb3NzT3JpZ2luOwoJfTsKCgkvKioKCSAqIENoYW5nZSB0aGUgdXNYSFIgdmFsdWUuIE5vdGUgdGhhdCBpZiB0aGlzIGlzIHNldCB0byB0cnVlLCBpdCBtYXkgZmFpbCBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIncyBjYXBhYmlsaXRpZXMuCgkgKiBBZGRpdGlvbmFsbHksIHNvbWUgZmlsZXMgcmVxdWlyZSBYSFIgaW4gb3JkZXIgdG8gbG9hZCwgc3VjaCBhcyBKU09OICh3aXRob3V0IEpTT05QKSwgVGV4dCwgYW5kIFhNTCwgc28gWEhSIHdpbGwKCSAqIGJlIHVzZWQgcmVnYXJkbGVzcyBvZiB3aGF0IGlzIHBhc3NlZCB0byB0aGlzIG1ldGhvZC4KCSAqIEBtZXRob2Qgc2V0VXNlWEhSCgkgKiBAcGFyYW0ge0Jvb2xlYW59IHZhbHVlIFRoZSBuZXcgdXNlWEhSIHZhbHVlIHRvIHNldC4KCSAqIEByZXR1cm4ge0Jvb2xlYW59IFRoZSBuZXcgdXNlWEhSIHZhbHVlLiBJZiBYSFIgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnJvd3NlciwgdGhpcyB3aWxsIHJldHVybiBmYWxzZSwgZXZlbiBpZgoJICogdGhlIHByb3ZpZGVkIHZhbHVlIGFyZ3VtZW50IHdhcyB0cnVlLgoJICogQHNpbmNlIDAuMy4wCgkgKi8KCXAuc2V0VXNlWEhSID0gZnVuY3Rpb24odmFsdWUpIHsKCQkvLyBEZXRlcm1pbmUgaWYgd2UgY2FuIHVzZSBYSFIuIFhIUiBkZWZhdWx0cyB0byBUUlVFLCBidXQgdGhlIGJyb3dzZXIgbWF5IG5vdCBzdXBwb3J0IGl0LgoJCS8vVE9ETzogU2hvdWxkIHdlIGJlIGNoZWNraW5nIGZvciB0aGUgb3RoZXIgWEhSIHR5cGVzPyBNaWdodCBoYXZlIHRvIGRvIGEgdHJ5L2NhdGNoIG9uIHRoZSBkaWZmZXJlbnQgdHlwZXMgc2ltaWxhciB0byBjcmVhdGVYSFIuCgkJdGhpcy51c2VYSFIgPSAodmFsdWUgIT0gZmFsc2UgJiYgd2luZG93LlhNTEh0dHBSZXF1ZXN0ICE9IG51bGwpOwoJCXJldHVybiB0aGlzLnVzZVhIUjsKCX07CgoJLyoqCgkgKiBTdG9wcyBhbGwgcXVldWVkIGFuZCBsb2FkaW5nIGl0ZW1zLCBhbmQgY2xlYXJzIHRoZSBxdWV1ZS4gVGhpcyBhbHNvIHJlbW92ZXMgYWxsIGludGVybmFsIHJlZmVyZW5jZXMgdG8gbG9hZGVkCgkgKiBjb250ZW50LCBhbmQgYWxsb3dzIHRoZSBxdWV1ZSB0byBiZSB1c2VkIGFnYWluLgoJICogQG1ldGhvZCByZW1vdmVBbGwKCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlbW92ZUFsbCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVtb3ZlKCk7Cgl9OwoKCS8qKgoJICogU3RvcHMgYW4gaXRlbSBmcm9tIGJlaW5nIGxvYWRlZCwgYW5kIHJlbW92ZXMgaXQgZnJvbSB0aGUgcXVldWUuIElmIG5vdGhpbmcgaXMgcGFzc2VkLCBhbGwgaXRlbXMgYXJlIHJlbW92ZWQuCgkgKiBUaGlzIGFsc28gcmVtb3ZlcyBpbnRlcm5hbCByZWZlcmVuY2VzIHRvIGxvYWRlZCBpdGVtKHMpLgoJICoKCSAqIDxoND5FeGFtcGxlPC9oND4KCSAqCgkgKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChbCgkgKiAgICAgICAgICB7c3JjOiJ0ZXN0LnBuZyIsIGlkOiJwbmcifSwKCSAqICAgICAgICAgIHtzcmM6InRlc3QuanBnIiwgaWQ6ImpwZyJ9LAoJICogICAgICAgICAge3NyYzoidGVzdC5tcDMiLCBpZDoibXAzIn0KCSAqICAgICAgXSk7CgkgKiAgICAgIHF1ZXVlLnJlbW92ZSgicG5nIik7IC8vIFNpbmdsZSBpdGVtIGJ5IElECgkgKiAgICAgIHF1ZXVlLnJlbW92ZSgicG5nIiwgInRlc3QuanBnIik7IC8vIEl0ZW1zIGFzIGFyZ3VtZW50cy4gTWl4ZWQgaWQgYW5kIHNyYy4KCSAqICAgICAgcXVldWUucmVtb3ZlKFsidGVzdC5wbmciLCAianBnIl0pOyAvLyBJdGVtcyBpbiBhbiBBcnJheS4gTWl4ZWQgaWQgYW5kIHNyYy4KCSAqCgkgKiBAbWV0aG9kIHJlbW92ZQoJICogQHBhcmFtIHtTdHJpbmcgfCBBcnJheX0gaWRzT3JVcmxzKiBUaGUgaWQgb3IgaWRzIHRvIHJlbW92ZSBmcm9tIHRoaXMgcXVldWUuIFlvdSBjYW4gcGFzcyBhbiBpdGVtLCBhbiBhcnJheSBvZgoJICogaXRlbXMsIG9yIG11bHRpcGxlIGl0ZW1zIGFzIGFyZ3VtZW50cy4KCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlbW92ZSA9IGZ1bmN0aW9uKGlkc09yVXJscykgewoJCXZhciBhcmdzID0gbnVsbDsKCgkJaWYgKGlkc09yVXJscyAmJiAhKGlkc09yVXJscyBpbnN0YW5jZW9mIEFycmF5KSkgewoJCQlhcmdzID0gW2lkc09yVXJsc107CgkJfSBlbHNlIGlmIChpZHNPclVybHMpIHsKCQkJYXJncyA9IGlkc09yVXJsczsKCQl9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBpdGVtc1dlcmVSZW1vdmVkID0gZmFsc2U7CgoJCS8vIERlc3Ryb3kgZXZlcnl0aGluZwoJCWlmICghYXJncykgewoJCQl0aGlzLmNsb3NlKCk7CgkJCWZvciAodmFyIG4gaW4gdGhpcy5fbG9hZEl0ZW1zQnlJZCkgewoJCQkJdGhpcy5fZGlzcG9zZUl0ZW0odGhpcy5fbG9hZEl0ZW1zQnlJZFtuXSk7CgkJCX0KCQkJdGhpcy5pbml0KHRoaXMudXNlWEhSLCB0aGlzLl9iYXNlUGF0aCwgdGhpcy5fY3Jvc3NPcmlnaW4pOwoKCQkvLyBSZW1vdmUgc3BlY2lmaWMgaXRlbXMKCQl9IGVsc2UgewoJCQl3aGlsZSAoYXJncy5sZW5ndGgpIHsKCQkJCXZhciBpdGVtID0gYXJncy5wb3AoKTsKCQkJCXZhciByID0gdGhpcy5nZXRSZXN1bHQoaXRlbSk7CgoJCQkJLy9SZW1vdmUgZnJvbSB0aGUgbWFpbiBsb2FkIFF1ZXVlCgkJCQlmb3IgKGkgPSB0aGlzLl9sb2FkUXVldWUubGVuZ3RoLTE7aT49MDtpLS0pIHsKCQkJCQlsb2FkSXRlbSA9IHRoaXMuX2xvYWRRdWV1ZVtpXS5nZXRJdGVtKCk7CgkJCQkJaWYgKGxvYWRJdGVtLmlkID09IGl0ZW0gfHwgbG9hZEl0ZW0uc3JjID09IGl0ZW0pIHsKCQkJCQkJdGhpcy5fbG9hZFF1ZXVlLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJLy9SZW1vdmUgZnJvbSB0aGUgYmFja3VwIHF1ZXVlCgkJCQlmb3IgKGkgPSB0aGlzLl9sb2FkUXVldWVCYWNrdXAubGVuZ3RoLTE7aT49MDtpLS0pIHsKCQkJCQlsb2FkSXRlbSA9IHRoaXMuX2xvYWRRdWV1ZUJhY2t1cFtpXS5nZXRJdGVtKCk7CgkJCQkJaWYgKGxvYWRJdGVtLmlkID09IGl0ZW0gfHwgbG9hZEl0ZW0uc3JjID09IGl0ZW0pIHsKCQkJCQkJdGhpcy5fbG9hZFF1ZXVlQmFja3VwLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKHIpIHsKCQkJCQlkZWxldGUgdGhpcy5fbG9hZEl0ZW1zQnlJZFtyLmlkXTsKCQkJCQlkZWxldGUgdGhpcy5fbG9hZEl0ZW1zQnlTcmNbci5zcmNdOwoJCQkJCXRoaXMuX2Rpc3Bvc2VJdGVtKHIpOwoJCQkJfSBlbHNlIHsKCQkJCQlmb3IgKHZhciBpPXRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGgtMTtpPj0wO2ktLSkgewoJCQkJCQl2YXIgbG9hZEl0ZW0gPSB0aGlzLl9jdXJyZW50TG9hZHNbaV0uZ2V0SXRlbSgpOwoJCQkJCQlpZiAobG9hZEl0ZW0uaWQgPT0gaXRlbSB8fCBsb2FkSXRlbS5zcmMgPT0gaXRlbSkgewoJCQkJCQkJdGhpcy5fY3VycmVudExvYWRzLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQkJaXRlbXNXZXJlUmVtb3ZlZCA9IHRydWU7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gSWYgdGhpcyB3YXMgY2FsbGVkIGR1cmluZyBhIGxvYWQsIHRyeSB0byBsb2FkIHRoZSBuZXh0IGl0ZW0uCgkJCWlmIChpdGVtc1dlcmVSZW1vdmVkKSB7CgkJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCQl9CgkJfQoJfTsKCgkvKioKCSAqIFN0b3BzIGFsbCBvcGVuIGxvYWRzLCBkZXN0cm95cyBhbnkgbG9hZGVkIGl0ZW1zLCBhbmQgcmVzZXRzIHRoZSBxdWV1ZSwgc28gYWxsIGl0ZW1zIGNhbgoJICogYmUgcmVsb2FkZWQgYWdhaW4gYnkgY2FsbGluZyB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2xvYWQifX17ey9jcm9zc0xpbmt9fS4gSXRlbXMgYXJlIG5vdCByZW1vdmVkIGZyb20gdGhlCgkgKiBxdWV1ZS4gVG8gcmVtb3ZlIGl0ZW1zIHVzZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvcmVtb3ZlIn19e3svY3Jvc3NMaW5rfX0gb3IKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3JlbW92ZUFsbCJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4KCSAqIEBtZXRob2QgcmVzZXQKCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlc2V0ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5jbG9zZSgpOwoJCWZvciAodmFyIG4gaW4gdGhpcy5fbG9hZEl0ZW1zQnlJZCkgewoJCQl0aGlzLl9kaXNwb3NlSXRlbSh0aGlzLl9sb2FkSXRlbXNCeUlkW25dKTsKCQl9CgoJCS8vUmVzZXQgdGhlIHF1ZXVlIHRvIGl0cyBzdGFydCBzdGF0ZQoJCXZhciBhID0gW107CgkJZm9yICh2YXIgaT0wLCBsPXRoaXMuX2xvYWRRdWV1ZUJhY2t1cC5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCWEucHVzaCh0aGlzLl9sb2FkUXVldWVCYWNrdXBbaV0uZ2V0SXRlbSgpKTsKCQl9CgoJCXRoaXMubG9hZE1hbmlmZXN0KGEsIGZhbHNlKTsKCX07CgoJLyoqCgkgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyB0eXBlIHNob3VsZCBiZSBsb2FkZWQgYXMgYSBiaW5hcnkgZmlsZS4gQ3VycmVudGx5LCBvbmx5IGltYWdlcyBhbmQgaXRlbXMgbWFya2VkCgkgKiBzcGVjaWZpY2FsbHkgYXMgImJpbmFyeSIgYXJlIGxvYWRlZCBhcyBiaW5hcnkuIE5vdGUgdGhhdCBhdWRpbyBpcyA8Yj5ub3Q8L2I+IGEgYmluYXJ5IHR5cGUsIGFzIHdlIGNhbiBub3QgcGxheQoJICogYmFjayB1c2luZyBhbiBhdWRpbyB0YWcgaWYgaXQgaXMgbG9hZGVkIGFzIGJpbmFyeS4gUGx1Z2lucyBjYW4gY2hhbmdlIHRoZSBpdGVtIHR5cGUgdG8gYmluYXJ5IHRvIGVuc3VyZSB0aGV5IGdldAoJICogYSBiaW5hcnkgcmVzdWx0IHRvIHdvcmsgd2l0aC4gQmluYXJ5IGZpbGVzIGFyZSBsb2FkZWQgdXNpbmcgWEhSMi4KCSAqIEBtZXRob2QgaXNCaW5hcnkKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuCgkgKiBAcmV0dXJuIHtCb29sZWFufSBJZiB0aGUgc3BlY2lmaWVkIHR5cGUgaXMgYmluYXJ5LgoJICogQHByaXZhdGUKCSAqLwoJcy5pc0JpbmFyeSA9IGZ1bmN0aW9uKHR5cGUpIHsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSU1BR0U6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkJJTkFSWToKCQkJCXJldHVybiB0cnVlOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX07CgoKCS8qKgoJICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgdHlwZSBpcyBhIHRleHQgYmFzZWQgYXNzZXQsIGFuZCBzaG91bGQgYmUgbG9hZGVkIGFzIFVURi04LgoJICogQG1ldGhvZCBpc1RleHQKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuCgkgKiBAcmV0dXJuIHtCb29sZWFufSBJZiB0aGUgc3BlY2lmaWVkIHR5cGUgaXMgdGV4dC4KCSAqIEBwcml2YXRlCgkgKi8KCXMuaXNUZXh0ID0gZnVuY3Rpb24odHlwZSkgewoJCXN3aXRjaCAodHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5URVhUOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuWE1MOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5IVE1MOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJCXJldHVybiB0cnVlOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX07CgoJLyoqCgkgKiBSZWdpc3RlciBhIHBsdWdpbi4gUGx1Z2lucyBjYW4gbWFwIHRvIGxvYWQgdHlwZXMgKHNvdW5kLCBpbWFnZSwgZXRjKSwgb3Igc3BlY2lmaWMgZXh0ZW5zaW9ucyAocG5nLCBtcDMsIGV0YykuCgkgKiBDdXJyZW50bHksIG9ubHkgb25lIHBsdWdpbiBjYW4gZXhpc3QgcGVyIHR5cGUvZXh0ZW5zaW9uLgoJICoKCSAqIFdoZW4gYSBwbHVnaW4gaXMgaW5zdGFsbGVkLCBhIDxjb2RlPmdldFByZWxvYWRIYW5kbGVycygpPC9jb2RlPiBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgb24gaXQuIEZvciBtb3JlIGluZm9ybWF0aW9uCgkgKiBvbiB0aGlzIG1ldGhvZCwgY2hlY2sgb3V0IHRoZSB7eyNjcm9zc0xpbmsgIlNhbXBsZVBsdWdpbi9nZXRQcmVsb2FkSGFuZGxlcnMifX17ey9jcm9zc0xpbmt9fSBtZXRob2QgaW4gdGhlCgkgKiB7eyNjcm9zc0xpbmsgIlNhbXBsZVBsdWdpbiJ9fXt7L2Nyb3NzTGlua319IGNsYXNzLgoJICoKCSAqIEJlZm9yZSBhIGZpbGUgaXMgbG9hZGVkLCBhIG1hdGNoaW5nIHBsdWdpbiBoYXMgYW4gb3Bwb3J0dW5pdHkgdG8gbW9kaWZ5IHRoZSBsb2FkLiBJZiBhIGBjYWxsYmFja2AgaXMgcmV0dXJuZWQKCSAqIGZyb20gdGhlIHt7I2Nyb3NzTGluayAiU2FtcGxlUGx1Z2luL2dldFByZWxvYWRIYW5kbGVycyJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCwgaXQgd2lsbCBiZSBpbnZva2VkIGZpcnN0LCBhbmQgaXRzCgkgKiByZXN1bHQgbWF5IGNhbmNlbCBvciBtb2RpZnkgdGhlIGl0ZW0uIFRoZSBjYWxsYmFjayBtZXRob2QgY2FuIGFsc28gcmV0dXJuIGEgYGNvbXBsZXRlSGFuZGxlcmAgdG8gYmUgZmlyZWQgd2hlbgoJICogdGhlIGZpbGUgaXMgbG9hZGVkLCBvciBhIGB0YWdgIG9iamVjdCwgd2hpY2ggd2lsbCBtYW5hZ2UgdGhlIGFjdHVhbCBkb3dubG9hZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlc2UKCSAqIG1ldGhvZHMsIGNoZWNrIG91dCB0aGUge3sjY3Jvc3NMaW5rICJTYW1wbGVQbHVnaW4vcHJlbG9hZEhhbmRsZXIifX17ey9jcm9zc0xpbmt9fSBhbmQge3sjY3Jvc3NMaW5rICJTYW1wbGVQbHVnaW4vZmlsZUxvYWRIYW5kbGVyIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZHMgb24gdGhlIHt7I2Nyb3NzTGluayAiU2FtcGxlUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0uCgkgKgoJICogQG1ldGhvZCBpbnN0YWxsUGx1Z2luCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwbHVnaW4gVGhlIHBsdWdpbiBjbGFzcyB0byBpbnN0YWxsLgoJICovCglwLmluc3RhbGxQbHVnaW4gPSBmdW5jdGlvbihwbHVnaW4pIHsKCQlpZiAocGx1Z2luID09IG51bGwgfHwgcGx1Z2luLmdldFByZWxvYWRIYW5kbGVycyA9PSBudWxsKSB7IHJldHVybjsgfQoJCXZhciBtYXAgPSBwbHVnaW4uZ2V0UHJlbG9hZEhhbmRsZXJzKCk7CgkJbWFwLnNjb3BlID0gcGx1Z2luOwoKCQlpZiAobWFwLnR5cGVzICE9IG51bGwpIHsKCQkJZm9yICh2YXIgaT0wLCBsPW1hcC50eXBlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCQl0aGlzLl90eXBlQ2FsbGJhY2tzW21hcC50eXBlc1tpXV0gPSBtYXA7CgkJCX0KCQl9CgkJaWYgKG1hcC5leHRlbnNpb25zICE9IG51bGwpIHsKCQkJZm9yIChpPTAsIGw9bWFwLmV4dGVuc2lvbnMubGVuZ3RoOyBpPGw7IGkrKykgewoJCQkJdGhpcy5fZXh0ZW5zaW9uQ2FsbGJhY2tzW21hcC5leHRlbnNpb25zW2ldXSA9IG1hcDsKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBTZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGNvbmN1cnJlbnQgY29ubmVjdGlvbnMuIE5vdGUgdGhhdCBicm93c2VycyBhbmQgc2VydmVycyBtYXkgaGF2ZSBhIGJ1aWx0LWluIG1heGltdW0KCSAqIG51bWJlciBvZiBvcGVuIGNvbm5lY3Rpb25zLCBzbyBhbnkgYWRkaXRpb25hbCBjb25uZWN0aW9ucyBtYXkgcmVtYWluIGluIGEgcGVuZGluZyBzdGF0ZSB1bnRpbCB0aGUgYnJvd3NlcgoJICogb3BlbnMgdGhlIGNvbm5lY3Rpb24uIFdoZW4gbG9hZGluZyBzY3JpcHRzIHVzaW5nIHRhZ3MsIGFuZCB3aGVuIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL21haW50YWluU2NyaXB0T3JkZXI6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fQoJICogaXMgYHRydWVgLCBvbmx5IG9uZSBzY3JpcHQgaXMgbG9hZGVkIGF0IGEgdGltZSBkdWUgdG8gYnJvd3NlciBsaW1pdGF0aW9ucy4KCSAqCgkgKiA8aDQ+RXhhbXBsZTwvaDQ+CgkgKgoJICogICAgICB2YXIgcXVldWUgPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKCk7CgkgKiAgICAgIHF1ZXVlLnNldE1heENvbm5lY3Rpb25zKDEwKTsgLy8gQWxsb3cgMTAgY29uY3VycmVudCBsb2FkcwoJICoKCSAqIEBtZXRob2Qgc2V0TWF4Q29ubmVjdGlvbnMKCSAqIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZSBUaGUgbnVtYmVyIG9mIGNvbmN1cnJlbnQgbG9hZHMgdG8gYWxsb3cuIEJ5IGRlZmF1bHQsIG9ubHkgYSBzaW5nbGUgY29ubmVjdGlvbiBwZXIgTG9hZFF1ZXVlCgkgKiBpcyBvcGVuIGF0IGFueSB0aW1lLgoJICovCglwLnNldE1heENvbm5lY3Rpb25zID0gZnVuY3Rpb24gKHZhbHVlKSB7CgkJdGhpcy5fbWF4Q29ubmVjdGlvbnMgPSB2YWx1ZTsKCQlpZiAoIXRoaXMuX3BhdXNlZCAmJiB0aGlzLl9sb2FkUXVldWUubGVuZ3RoID4gMCkgewoJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCX0KCX07CgoJLyoqCgkgKiBMb2FkIGEgc2luZ2xlIGZpbGUuIFRvIGFkZCBtdWx0aXBsZSBmaWxlcyBhdCBvbmNlLCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319CgkgKiBtZXRob2QuCgkgKgoJICogRmlsZXMgYXJlIGFsd2F5cyBhcHBlbmRlZCB0byB0aGUgY3VycmVudCBxdWV1ZSwgc28gdGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMgdG8gYWRkIGZpbGVzLgoJICogVG8gY2xlYXIgdGhlIHF1ZXVlIGZpcnN0LCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY2xvc2UifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuCgkgKiBAbWV0aG9kIGxvYWRGaWxlCgkgKiBAcGFyYW0ge09iamVjdCB8IFN0cmluZ30gZmlsZSBUaGUgZmlsZSBvYmplY3Qgb3IgcGF0aCB0byBsb2FkLiBBIGZpbGUgY2FuIGJlIGVpdGhlcgogICAgICogPHVsPgogICAgICogICAgIDxsaT5BIHN0cmluZyBwYXRoIHRvIGEgcmVzb3VyY2UuIE5vdGUgdGhhdCB0aGlzIGtpbmQgb2YgbG9hZCBpdGVtIHdpbGwgYmUgY29udmVydGVkIHRvIGFuIG9iamVjdCAoc2VlIGJlbG93KQoJICogICAgIGluIHRoZSBiYWNrZ3JvdW5kLjwvbGk+CiAgICAgKiAgICAgPGxpPk9SIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zOjx1bD4KICAgICAqICAgICAgICAgPGxpPnNyYzogVGhlIHNvdXJjZSBvZiB0aGUgZmlsZSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4gVGhpcyBwcm9wZXJ0eSBpcyA8Yj5yZXF1aXJlZDwvYj4uIFRoZSBzb3VyY2UgY2FuCgkgKiAgICAgICAgIGVpdGhlciBiZSBhIHN0cmluZyAocmVjb21tZW5kZWQpLCBvciBhbiBIVE1MIHRhZy48L2xpPgogICAgICogICAgICAgICA8bGk+dHlwZTogVGhlIHR5cGUgb2YgZmlsZSB0aGF0IHdpbGwgYmUgbG9hZGVkIChpbWFnZSwgc291bmQsIGpzb24sIGV0YykuIFByZWxvYWRKUyBkb2VzIGF1dG8tZGV0ZWN0aW9uCgkgKiAgICAgICAgIG9mIHR5cGVzIHVzaW5nIHRoZSBleHRlbnNpb24uIFN1cHBvcnRlZCB0eXBlcyBhcmUgZGVmaW5lZCBvbiBMb2FkUXVldWUsIHN1Y2ggYXMgPGNvZGU+TG9hZFF1ZXVlLklNQUdFPC9jb2RlPi4KCSAqICAgICAgICAgSXQgaXMgcmVjb21tZW5kZWQgdGhhdCBhIHR5cGUgaXMgc3BlY2lmaWVkIHdoZW4gYSBub24tc3RhbmRhcmQgZmlsZSBVUkkgKHN1Y2ggYXMgYSBwaHAgc2NyaXB0KSB1cyB1c2VkLjwvbGk+CiAgICAgKiAgICAgICAgIDxsaT5pZDogQSBzdHJpbmcgaWRlbnRpZmllciB3aGljaCBjYW4gYmUgdXNlZCB0byByZWZlcmVuY2UgdGhlIGxvYWRlZCBvYmplY3QuPC9saT4KCSAqICAgICAgICAgPGxpPm1haW50YWluT3JkZXI6IFNldCB0byBgdHJ1ZWAgdG8gZW5zdXJlIHRoaXMgYXNzZXQgbG9hZHMgaW4gdGhlIG9yZGVyIGRlZmluZWQgaW4gdGhlIG1hbmlmZXN0LiBUaGlzCgkgKiAgICAgICAgIHdpbGwgaGFwcGVuIHdoZW4gdGhlIG1heCBjb25uZWN0aW9ucyBoYXMgYmVlbiBzZXQgYWJvdmUgMSAodXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fSksCgkgKiAgICAgICAgIGFuZCB3aWxsIG9ubHkgYWZmZWN0IG90aGVyIGFzc2V0cyBhbHNvIGRlZmluZWQgYXMgYG1haW50YWluT3JkZXJgLiBFdmVyeXRoaW5nIGVsc2Ugd2lsbCBmaW5pc2ggYXMgaXQgaXMKCSAqICAgICAgICAgbG9hZGVkLiBPcmRlcmVkIGl0ZW1zIGFyZSBjb21iaW5lZCB3aXRoIHNjcmlwdCB0YWdzIGxvYWRpbmcgaW4gb3JkZXIgd2hlbiB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9tYWludGFpblNjcmlwdE9yZGVyOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0KCSAqICAgICAgICAgaXMgc2V0IHRvIGB0cnVlYC48L2xpPgoJICogICAgICAgICA8bGk+Y2FsbGJhY2s6IE9wdGlvbmFsLCB1c2VkIGZvciBKU09OUCByZXF1ZXN0cywgdG8gZGVmaW5lIHdoYXQgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgSlNPTlAgaXMgbG9hZGVkLjwvbGk+CiAgICAgKiAgICAgICAgIDxsaT5kYXRhOiBBbiBhcmJpdHJhcnkgZGF0YSBvYmplY3QsIHdoaWNoIGlzIGluY2x1ZGVkIHdpdGggdGhlIGxvYWRlZCBvYmplY3Q8L2xpPgoJICogICAgICAgICA8bGk+bWV0aG9kOiB1c2VkIHRvIGRlZmluZSBpZiB0aGlzIHJlcXVlc3QgdXNlcyBHRVQgb3IgUE9TVCB3aGVuIHNlbmRpbmcgZGF0YSB0byB0aGUgc2VydmVyLiBUaGUgZGVmYXVsdAoJICogICAgICAgICB2YWx1ZSBpcyAiR0VUIjwvbGk+CgkgKiAgICAgICAgIDxsaT52YWx1ZXM6IE9wdGlvbmFsIG9iamVjdCBvZiBuYW1lL3ZhbHVlIHBhaXJzIHRvIHNlbmQgdG8gdGhlIHNlcnZlci48L2xpPgoJICogICAgICAgICA8bGk+aGVhZGVyczogT3B0aW9uYWwgb2JqZWN0IGhhc2ggb2YgaGVhZGVycyB0byBhdHRhY2ggdG8gYW4gWEhSIHJlcXVlc3QuIFByZWxvYWRKUyB3aWxsIGF1dG9tYXRpY2FsbHkKCSAqICAgICAgICAgYXR0YWNoIHNvbWUgZGVmYXVsdCBoZWFkZXJzIHdoZW4gcmVxdWlyZWQsIGluY2x1ZGluZyBPcmlnaW4sIENvbnRlbnQtVHlwZSwgYW5kIFgtUmVxdWVzdGVkLVdpdGguIFlvdSBtYXkKCSAqICAgICAgICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaGVhZGVycyBpZiBuZWVkZWQuPC9saT4KCSAqICAgICA8L3VsPgogICAgICogPC91bD4KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW2xvYWROb3c9dHJ1ZV0gS2ljayBvZmYgYW4gaW1tZWRpYXRlIGxvYWQgKHRydWUpIG9yIHdhaXQgZm9yIGEgbG9hZCBjYWxsIChmYWxzZSkuIFRoZSBkZWZhdWx0CgkgKiB2YWx1ZSBpcyB0cnVlLiBJZiB0aGUgcXVldWUgaXMgcGF1c2VkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldFBhdXNlZCJ9fXt7L2Nyb3NzTGlua319LCBhbmQgdGhlIHZhbHVlIGlzCgkgKiBgdHJ1ZWAsIHRoZSBxdWV1ZSB3aWxsIHJlc3VtZSBhdXRvbWF0aWNhbGx5LgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aF0gQSBiYXNlIHBhdGggdGhhdCB3aWxsIGJlIHByZXBlbmRlZCB0byBlYWNoIGZpbGUuIFRoZSBiYXNlUGF0aCBhcmd1bWVudCBvdmVycmlkZXMgdGhlCgkgKiBwYXRoIHNwZWNpZmllZCBpbiB0aGUgY29uc3RydWN0b3IuIE5vdGUgdGhhdCBpZiB5b3UgbG9hZCBhIG1hbmlmZXN0IHVzaW5nIGEgZmlsZSBvZiB0eXBlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL01BTklGRVNUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0sCgkgKiBpdHMgZmlsZXMgd2lsbCA8c3Ryb25nPk5PVDwvc3Ryb25nPiB1c2UgdGhlIGJhc2VQYXRoIHBhcmFtZXRlci4gPHN0cm9uZz5UaGUgYmFzZVBhdGggcGFyYW1ldGVyIGlzIGRlcHJlY2F0ZWQuPC9zdHJvbmc+CgkgKiBUaGlzIHBhcmFtZXRlciB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlIGVpdGhlciB1c2UgdGhlIGBiYXNlUGF0aGAgcGFyYW1ldGVyIGluIHRoZSBMb2FkUXVldWUKCSAqIGNvbnN0cnVjdG9yLCBvciBhIGBwYXRoYCBwcm9wZXJ0eSBpbiBhIG1hbmlmZXN0IGRlZmluaXRpb24uCgkgKi8KCXAubG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlLCBsb2FkTm93LCBiYXNlUGF0aCkgewoJCWlmIChmaWxlID09IG51bGwpIHsKCQkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCQlldmVudC50ZXh0ID0gIlBSRUxPQURfTk9fRklMRSI7CgkJCXRoaXMuX3NlbmRFcnJvcihldmVudCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fYWRkSXRlbShmaWxlLCBudWxsLCBiYXNlUGF0aCk7CgoJCWlmIChsb2FkTm93ICE9PSBmYWxzZSkgewoJCQl0aGlzLnNldFBhdXNlZChmYWxzZSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zZXRQYXVzZWQodHJ1ZSk7CgkJfQoJfTsKCgkvKioKCSAqIExvYWQgYW4gYXJyYXkgb2YgZmlsZXMuIFRvIGxvYWQgYSBzaW5nbGUgZmlsZSwgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkRmlsZSJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4KCSAqIFRoZSBmaWxlcyBpbiB0aGUgbWFuaWZlc3QgYXJlIHJlcXVlc3RlZCBpbiB0aGUgc2FtZSBvcmRlciwgYnV0IG1heSBjb21wbGV0ZSBpbiBhIGRpZmZlcmVudCBvcmRlciBpZiB0aGUgbWF4CgkgKiBjb25uZWN0aW9ucyBhcmUgc2V0IGFib3ZlIDEgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fS4gU2NyaXB0cyB3aWxsIGxvYWQKCSAqIGluIHRoZSByaWdodCBvcmRlciBhcyBsb25nIGFzIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL21haW50YWluU2NyaXB0T3JkZXIifX17ey9jcm9zc0xpbmt9fSBpcyB0cnVlICh3aGljaCBpcwoJICogZGVmYXVsdCkuCgkgKgoJICogRmlsZXMgYXJlIGFsd2F5cyBhcHBlbmRlZCB0byB0aGUgY3VycmVudCBxdWV1ZSwgc28gdGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMgdG8gYWRkIGZpbGVzLgoJICogVG8gY2xlYXIgdGhlIHF1ZXVlIGZpcnN0LCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY2xvc2UifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuCgkgKiBAbWV0aG9kIGxvYWRNYW5pZmVzdAoJICogQHBhcmFtIHtBcnJheXxTdHJpbmd8T2JqZWN0fSBtYW5pZmVzdCBBbiBsaXN0IG9mIGZpbGVzIHRvIGxvYWQuIFRoZSBsb2FkTWFuaWZlc3QgY2FsbCBzdXBwb3J0cyBmb3VyIHR5cGVzIG9mCgkgKiBtYW5pZmVzdHM6CgkgKiA8b2w+CgkgKiAgICAgPGxpPkEgc3RyaW5nIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhIG1hbmlmZXN0IGZpbGUsIHdoaWNoIGlzIGEgSlNPTiBmaWxlIHRoYXQgY29udGFpbnMgYSAibWFuaWZlc3QiIHByb3BlcnR5LAoJICogICAgIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwgYW5kIGNhbiBvcHRpb25hbGx5IGNvbnRhaW4gYSAicGF0aCIgcHJvcGVydHksIHdoaWNoIHdpbGwgYmUKCSAqICAgICBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIG9iamVjdCB3aGljaCBkZWZpbmVzIGEgInNyYyIsIHdoaWNoIGlzIGEgSlNPTiBvciBKU09OUCBmaWxlLiBBICJjYWxsYmFjayIgY2FuIGJlIGRlZmluZWQgZm9yIEpTT05QCgkgKiAgICAgZmlsZS4gVGhlIEpTT04vSlNPTlAgZmlsZSBzaG91bGQgY29udGFpbiBhICJtYW5pZmVzdCIgcHJvcGVydHksIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwKCSAqICAgICBhbmQgY2FuIG9wdGlvbmFsbHkgY29udGFpbiBhICJwYXRoIiBwcm9wZXJ0eSwgd2hpY2ggd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIG9iamVjdCB3aGljaCBjb250YWlucyBhICJtYW5pZmVzdCIgcHJvcGVydHksIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwgYW5kIGNhbgoJICogICAgIG9wdGlvbmFsbHkgY29udGFpbiBhICJwYXRoIiBwcm9wZXJ0eSwgd2hpY2ggd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIEFycmF5IG9mIGZpbGVzIHRvIGxvYWQuPC9saT4KCSAqIDwvb2w+CgkgKgoJICogRWFjaCAiZmlsZSIgaW4gYSBtYW5pZmVzdCBjYW4gYmUgZWl0aGVyOgoJICogPHVsPgoJICogICAgIDxsaT5BIHN0cmluZyBwYXRoIHRvIGEgcmVzb3VyY2UgKHN0cmluZykuIE5vdGUgdGhhdCB0aGlzIGtpbmQgb2YgbG9hZCBpdGVtIHdpbGwgYmUgY29udmVydGVkIHRvIGFuIG9iamVjdAoJICogICAgIChzZWUgYmVsb3cpIGluIHRoZSBiYWNrZ3JvdW5kLjwvbGk+CgkgKiAgICAgIDxsaT5PUiBhbiBvYmplY3QgdGhhdCBjb250YWluczo8dWw+CgkgKiAgICAgICAgIDxsaT5zcmM6IFRoZSBzb3VyY2Ugb2YgdGhlIGZpbGUgdGhhdCBpcyBiZWluZyBsb2FkZWQuIFRoaXMgcHJvcGVydHkgaXMgPGI+cmVxdWlyZWQ8L2I+LiBUaGUgc291cmNlIGNhbgoJICogICAgICAgICBlaXRoZXIgYmUgYSBzdHJpbmcgKHJlY29tbWVuZGVkKSwgb3IgYW4gSFRNTCB0YWcuPC9saT4KCSAqICAgICAgICAgPGxpPnR5cGU6IFRoZSB0eXBlIG9mIGZpbGUgdGhhdCB3aWxsIGJlIGxvYWRlZCAoaW1hZ2UsIHNvdW5kLCBqc29uLCBldGMpLiBQcmVsb2FkSlMgZG9lcyBhdXRvLWRldGVjdGlvbgoJICogICAgICAgICBvZiB0eXBlcyB1c2luZyB0aGUgZXh0ZW5zaW9uLiBTdXBwb3J0ZWQgdHlwZXMgYXJlIGRlZmluZWQgb24gTG9hZFF1ZXVlLCBzdWNoIGFzIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL0lNQUdFOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0uCgkgKiAgICAgICAgIEl0IGlzIHJlY29tbWVuZGVkIHRoYXQgYSB0eXBlIGlzIHNwZWNpZmllZCB3aGVuIGEgbm9uLXN0YW5kYXJkIGZpbGUgVVJJIChzdWNoIGFzIGEgcGhwIHNjcmlwdCkgdXMgdXNlZC48L2xpPgoJICogICAgICAgICA8bGk+aWQ6IEEgc3RyaW5nIGlkZW50aWZpZXIgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVmZXJlbmNlIHRoZSBsb2FkZWQgb2JqZWN0LjwvbGk+CgkgKiAgICAgICAgIDxsaT5tYWludGFpbk9yZGVyOiBTZXQgdG8gYHRydWVgIHRvIGVuc3VyZSB0aGlzIGFzc2V0IGxvYWRzIGluIHRoZSBvcmRlciBkZWZpbmVkIGluIHRoZSBtYW5pZmVzdC4gVGhpcwoJICogICAgICAgICB3aWxsIGhhcHBlbiB3aGVuIHRoZSBtYXggY29ubmVjdGlvbnMgaGFzIGJlZW4gc2V0IGFib3ZlIDEgKHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldE1heENvbm5lY3Rpb25zIn19e3svY3Jvc3NMaW5rfX0pLAoJICogICAgICAgICBhbmQgd2lsbCBvbmx5IGFmZmVjdCBvdGhlciBhc3NldHMgYWxzbyBkZWZpbmVkIGFzIGBtYWludGFpbk9yZGVyYC4gRXZlcnl0aGluZyBlbHNlIHdpbGwgZmluaXNoIGFzIGl0IGlzCgkgKiAgICAgICAgIGxvYWRlZC4gT3JkZXJlZCBpdGVtcyBhcmUgY29tYmluZWQgd2l0aCBzY3JpcHQgdGFncyBsb2FkaW5nIGluIG9yZGVyIHdoZW4ge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbWFpbnRhaW5TY3JpcHRPcmRlcjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiAgICAgICAgIGlzIHNldCB0byBgdHJ1ZWAuPC9saT4KCSAqICAgICAgICAgPGxpPmNhbGxiYWNrOiBPcHRpb25hbCwgdXNlZCBmb3IgSlNPTlAgcmVxdWVzdHMsIHRvIGRlZmluZSB3aGF0IG1ldGhvZCB0byBjYWxsIHdoZW4gdGhlIEpTT05QIGlzIGxvYWRlZC48L2xpPgoJICogICAgICAgICA8bGk+ZGF0YTogQW4gYXJiaXRyYXJ5IGRhdGEgb2JqZWN0LCB3aGljaCBpcyBpbmNsdWRlZCB3aXRoIHRoZSBsb2FkZWQgb2JqZWN0PC9saT4KCSAqICAgICAgICAgPGxpPm1ldGhvZDogdXNlZCB0byBkZWZpbmUgaWYgdGhpcyByZXF1ZXN0IHVzZXMgR0VUIG9yIFBPU1Qgd2hlbiBzZW5kaW5nIGRhdGEgdG8gdGhlIHNlcnZlci4gVGhlIGRlZmF1bHQKCSAqICAgICAgICAgdmFsdWUgaXMgIkdFVCI8L2xpPgoJICogICAgICAgICA8bGk+dmFsdWVzOiBPcHRpb25hbCBvYmplY3Qgb2YgbmFtZS92YWx1ZSBwYWlycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuPC9saT4KCSAqICAgICAgICAgPGxpPmhlYWRlcnM6IE9wdGlvbmFsIG9iamVjdCBoYXNoIG9mIGhlYWRlcnMgdG8gYXR0YWNoIHRvIGFuIFhIUiByZXF1ZXN0LiBQcmVsb2FkSlMgd2lsbCBhdXRvbWF0aWNhbGx5CgkgKiAgICAgICAgIGF0dGFjaCBzb21lIGRlZmF1bHQgaGVhZGVycyB3aGVuIHJlcXVpcmVkLCBpbmNsdWRpbmcgT3JpZ2luLCBDb250ZW50LVR5cGUsIGFuZCBYLVJlcXVlc3RlZC1XaXRoLiBZb3UgbWF5CgkgKiAgICAgICAgIG92ZXJyaWRlIHRoZSBkZWZhdWx0IGhlYWRlcnMgaWYgbmVlZGVkLjwvbGk+CgkgKiAgICAgPC91bD4KCSAqIDwvdWw+CgkgKiBAcGFyYW0ge0Jvb2xlYW59IFtsb2FkTm93PXRydWVdIEtpY2sgb2ZmIGFuIGltbWVkaWF0ZSBsb2FkICh0cnVlKSBvciB3YWl0IGZvciBhIGxvYWQgY2FsbCAoZmFsc2UpLiBUaGUgZGVmYXVsdAoJICogdmFsdWUgaXMgdHJ1ZS4gSWYgdGhlIHF1ZXVlIGlzIHBhdXNlZCB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zZXRQYXVzZWQifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhpcyB2YWx1ZSBpcwoJICogYHRydWVgLCB0aGUgcXVldWUgd2lsbCByZXN1bWUgYXV0b21hdGljYWxseS4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbYmFzZVBhdGhdIEEgYmFzZSBwYXRoIHRoYXQgd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlLiBUaGUgYmFzZVBhdGggYXJndW1lbnQgb3ZlcnJpZGVzIHRoZQoJICogcGF0aCBzcGVjaWZpZWQgaW4gdGhlIGNvbnN0cnVjdG9yLiBOb3RlIHRoYXQgaWYgeW91IGxvYWQgYSBtYW5pZmVzdCB1c2luZyBhIGZpbGUgb2YgdHlwZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9NQU5JRkVTVDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319LAoJICogaXRzIGZpbGVzIHdpbGwgPHN0cm9uZz5OT1Q8L3N0cm9uZz4gdXNlIHRoZSBiYXNlUGF0aCBwYXJhbWV0ZXIuIDxzdHJvbmc+VGhlIGJhc2VQYXRoIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLjwvc3Ryb25nPgoJICogVGhpcyBwYXJhbWV0ZXIgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24uIFBsZWFzZSBlaXRoZXIgdXNlIHRoZSBgYmFzZVBhdGhgIHBhcmFtZXRlciBpbiB0aGUgTG9hZFF1ZXVlCgkgKiBjb25zdHJ1Y3Rvciwgb3IgYSBgcGF0aGAgcHJvcGVydHkgaW4gYSBtYW5pZmVzdCBkZWZpbml0aW9uLgoJICovCglwLmxvYWRNYW5pZmVzdCA9IGZ1bmN0aW9uKG1hbmlmZXN0LCBsb2FkTm93LCBiYXNlUGF0aCkgewoJCXZhciBmaWxlTGlzdCA9IG51bGw7CgkJdmFyIHBhdGggPSBudWxsOwoKCQkvLyBBcnJheS1iYXNlZCBsaXN0IG9mIGl0ZW1zCgkJaWYgKG1hbmlmZXN0IGluc3RhbmNlb2YgQXJyYXkpIHsKCQkJaWYgKG1hbmlmZXN0Lmxlbmd0aCA9PSAwKSB7CgkJCQl2YXIgZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJCQlldmVudC50ZXh0ID0gIlBSRUxPQURfTUFOSUZFU1RfRU1QVFkiOwoJCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQkJCXJldHVybjsKCQkJfQoJCQlmaWxlTGlzdCA9IG1hbmlmZXN0OwoKCQkvLyBTdHJpbmctYmFzZWQuIE9ubHkgZmlsZSBtYW5pZmVzdHMgY2FuIGJlIHNwZWNpZmllZCB0aGlzIHdheS4gQW55IG90aGVyIHR5cGVzIHdpbGwgY2F1c2UgYW4gZXJyb3Igd2hlbiBsb2FkZWQuCgkJfSBlbHNlIGlmICh0eXBlb2YobWFuaWZlc3QpID09PSAic3RyaW5nIikgewoJCQlmaWxlTGlzdCA9IFt7CgkJCQlzcmM6IG1hbmlmZXN0LAoJCQkJdHlwZTogcy5NQU5JRkVTVAoJCQl9XTsKCgkJfSBlbHNlIGlmICh0eXBlb2YobWFuaWZlc3QpID09ICJvYmplY3QiKSB7CgoJCQkvLyBBbiBvYmplY3QgdGhhdCBkZWZpbmVzIGEgbWFuaWZlc3QgcGF0aAoJCQlpZiAobWFuaWZlc3Quc3JjICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmIChtYW5pZmVzdC50eXBlID09IG51bGwpIHsKCQkJCQltYW5pZmVzdC50eXBlID0gcy5NQU5JRkVTVDsKCQkJCX0gZWxzZSBpZiAobWFuaWZlc3QudHlwZSAhPSBzLk1BTklGRVNUKSB7CgkJCQkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCQkJCWV2ZW50LnRleHQgPSAiUFJFTE9BRF9NQU5JRkVTVF9FUlJPUiI7CgkJCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQkJCX0KCQkJCWZpbGVMaXN0ID0gW21hbmlmZXN0XTsKCgkJCS8vIEFuIG9iamVjdCB0aGF0IGRlZmluZXMgYSBtYW5pZmVzdAoJCQl9IGVsc2UgaWYgKG1hbmlmZXN0Lm1hbmlmZXN0ICE9PSB1bmRlZmluZWQpIHsKCQkJCWZpbGVMaXN0ID0gbWFuaWZlc3QubWFuaWZlc3Q7CgkJCQlwYXRoID0gbWFuaWZlc3QucGF0aDsKCQkJfQoKCQkvLyBVbnN1cHBvcnRlZC4gVGhpcyB3aWxsIHRocm93IGFuIGVycm9yLgoJCX0gZWxzZSB7CgkJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkJZXZlbnQudGV4dCA9ICJQUkVMT0FEX01BTklGRVNUX05VTEwiOwoJCQl0aGlzLl9zZW5kRXJyb3IoZXZlbnQpOwoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKHZhciBpPTAsIGw9ZmlsZUxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewoJCQl0aGlzLl9hZGRJdGVtKGZpbGVMaXN0W2ldLCBwYXRoLCBiYXNlUGF0aCk7CgkJfQoKCQlpZiAobG9hZE5vdyAhPT0gZmFsc2UpIHsKCQkJdGhpcy5zZXRQYXVzZWQoZmFsc2UpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2V0UGF1c2VkKHRydWUpOwoJCX0KCgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0UGF1c2VkKGZhbHNlKTsKCX07CgoJLyoqCgkgKiBMb29rIHVwIGEgbG9hZCBpdGVtIHVzaW5nIGVpdGhlciB0aGUgImlkIiBvciAic3JjIiB0aGF0IHdhcyBzcGVjaWZpZWQgd2hlbiBsb2FkaW5nIGl0LiBOb3RlIHRoYXQgaWYgbm8gImlkIiB3YXMKCSAqIHN1cHBsaWVkIHdpdGggdGhlIGxvYWQgaXRlbSwgdGhlIElEIHdpbGwgYmUgdGhlICJzcmMiLCBpbmNsdWRpbmcgYSBgcGF0aGAgcHJvcGVydHkgZGVmaW5lZCBieSBhIG1hbmlmZXN0LiBUaGUKCSAqIGBiYXNlUGF0aGAgd2lsbCBub3QgYmUgcGFydCBvZiB0aGUgSUQuCgkgKiBAbWV0aG9kIGdldEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgPGNvZGU+aWQ8L2NvZGU+IG9yIDxjb2RlPnNyYzwvY29kZT4gb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGxvYWQgaXRlbSB0aGF0IHdhcyBpbml0aWFsbHkgcmVxdWVzdGVkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0KCSAqIG9yIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319LiBUaGlzIG9iamVjdCBpcyBhbHNvIHJldHVybmVkIHZpYSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fQoJICogZXZlbnQgYXMgdGhlIGBpdGVtYCBwYXJhbWV0ZXIuCgkgKi8KCXAuZ2V0SXRlbSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHRoaXMuX2xvYWRJdGVtc0J5SWRbdmFsdWVdIHx8IHRoaXMuX2xvYWRJdGVtc0J5U3JjW3ZhbHVlXTsKCX07CgoJLyoqCgkgKiBMb29rIHVwIGEgbG9hZGVkIHJlc3VsdCB1c2luZyBlaXRoZXIgdGhlICJpZCIgb3IgInNyYyIgdGhhdCB3YXMgc3BlY2lmaWVkIHdoZW4gbG9hZGluZyBpdC4gTm90ZSB0aGF0IGlmIG5vICJpZCIKCSAqIHdhcyBzdXBwbGllZCB3aXRoIHRoZSBsb2FkIGl0ZW0sIHRoZSBJRCB3aWxsIGJlIHRoZSAic3JjIiwgaW5jbHVkaW5nIGEgYHBhdGhgIHByb3BlcnR5IGRlZmluZWQgYnkgYSBtYW5pZmVzdC4gVGhlCgkgKiBgYmFzZVBhdGhgIHdpbGwgbm90IGJlIHBhcnQgb2YgdGhlIElELgoJICogQG1ldGhvZCBnZXRSZXN1bHQKCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgPGNvZGU+aWQ8L2NvZGU+IG9yIDxjb2RlPnNyYzwvY29kZT4gb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3Jhd1Jlc3VsdD1mYWxzZV0gUmV0dXJuIGEgcmF3IHJlc3VsdCBpbnN0ZWFkIG9mIGEgZm9ybWF0dGVkIHJlc3VsdC4gVGhpcyBhcHBsaWVzIHRvIGNvbnRlbnQKCSAqIGxvYWRlZCB2aWEgWEhSIHN1Y2ggYXMgc2NyaXB0cywgWE1MLCBDU1MsIGFuZCBJbWFnZXMuIElmIHRoZXJlIGlzIG5vIHJhdyByZXN1bHQsIHRoZSBmb3JtYXR0ZWQgcmVzdWx0IHdpbGwgYmUKCSAqIHJldHVybmVkIGluc3RlYWQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEEgcmVzdWx0IG9iamVjdCBjb250YWluaW5nIHRoZSBjb250ZW50IHRoYXQgd2FzIGxvYWRlZCwgc3VjaCBhczoKICAgICAqIDx1bD4KCSAqICAgICAgPGxpPkFuIGltYWdlIHRhZyAoJmx0O2ltYWdlIC8mZ3Q7KSBmb3IgaW1hZ2VzPC9saT4KCSAqICAgICAgPGxpPkEgc2NyaXB0IHRhZyBmb3IgSmF2YVNjcmlwdCAoJmx0O3NjcmlwdCAvJmd0OykuIE5vdGUgdGhhdCBzY3JpcHRzIGFyZSBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSBIVE1MCgkgKiAgICAgIERPTS48L2xpPgoJICogICAgICA8bGk+QSBzdHlsZSB0YWcgZm9yIENTUyAoJmx0O3N0eWxlIC8mZ3Q7IG9yICZsdDtsaW5rICZndDspPC9saT4KCSAqICAgICAgPGxpPlJhdyB0ZXh0IGZvciBURVhUPC9saT4KCSAqICAgICAgPGxpPkEgZm9ybWF0dGVkIEphdmFTY3JpcHQgb2JqZWN0IGRlZmluZWQgYnkgSlNPTjwvbGk+CgkgKiAgICAgIDxsaT5BbiBYTUwgZG9jdW1lbnQ8L2xpPgoJICogICAgICA8bGk+QSBiaW5hcnkgYXJyYXlidWZmZXIgbG9hZGVkIGJ5IFhIUjwvbGk+CgkgKiAgICAgIDxsaT5BbiBhdWRpbyB0YWcgKCZsdDthdWRpbyAmZ3Q7KSBmb3IgSFRNTCBhdWRpby4gTm90ZSB0aGF0IGl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBTb3VuZEpTIEFQSXMgdG8gcGxheQoJICogICAgICBsb2FkZWQgYXVkaW8uIFNwZWNpZmljYWxseSwgYXVkaW8gbG9hZGVkIGJ5IEZsYXNoIGFuZCBXZWJBdWRpbyB3aWxsIHJldHVybiBhIGxvYWRlciBvYmplY3QgdXNpbmcgdGhpcyBtZXRob2QKCSAqICAgICAgd2hpY2ggY2FuIG5vdCBiZSB1c2VkIHRvIHBsYXkgYXVkaW8gYmFjay48L2xpPgoJICogPC91bD4KICAgICAqIFRoaXMgb2JqZWN0IGlzIGFsc28gcmV0dXJuZWQgdmlhIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319ICBldmVudCBhcyB0aGUgJ2l0ZW1gCgkgKiBwYXJhbWV0ZXIuIE5vdGUgdGhhdCBpZiBhIHJhdyByZXN1bHQgaXMgcmVxdWVzdGVkLCBidXQgbm90IGZvdW5kLCB0aGUgcmVzdWx0IHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZC4KCSAqLwoJcC5nZXRSZXN1bHQgPSBmdW5jdGlvbih2YWx1ZSwgcmF3UmVzdWx0KSB7CgkJdmFyIGl0ZW0gPSB0aGlzLl9sb2FkSXRlbXNCeUlkW3ZhbHVlXSB8fCB0aGlzLl9sb2FkSXRlbXNCeVNyY1t2YWx1ZV07CgkJaWYgKGl0ZW0gPT0gbnVsbCkgeyByZXR1cm4gbnVsbDsgfQoJCXZhciBpZCA9IGl0ZW0uaWQ7CgkJaWYgKHJhd1Jlc3VsdCAmJiB0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2lkXSkgewoJCQlyZXR1cm4gdGhpcy5fbG9hZGVkUmF3UmVzdWx0c1tpZF07CgkJfQoJCXJldHVybiB0aGlzLl9sb2FkZWRSZXN1bHRzW2lkXTsKCX07CgoJLyoqCgkgKiBQYXVzZSBvciByZXN1bWUgdGhlIGN1cnJlbnQgbG9hZC4gQWN0aXZlIGxvYWRzIHdpbGwgbm90IGJlIGNhbmNlbGxlZCwgYnV0IHRoZSBuZXh0IGl0ZW1zIGluIHRoZSBxdWV1ZSB3aWxsIG5vdAoJICogYmUgcHJvY2Vzc2VkIHdoZW4gYWN0aXZlIGxvYWRzIGNvbXBsZXRlLiBMb2FkUXVldWVzIGFyZSBub3QgcGF1c2VkIGJ5IGRlZmF1bHQuCgkgKgoJICogTm90ZSB0aGF0IGlmIG5ldyBpdGVtcyBhcmUgYWRkZWQgdG8gdGhlIHF1ZXVlIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0sCgkgKiBhIHBhdXNlZCBxdWV1ZSB3aWxsIGJlIHJlc3VtZWQsIHVubGVzcyB0aGUgYGxvYWROb3dgIGFyZ3VtZW50IGlzIGBmYWxzZWAuCgkgKiBAbWV0aG9kIHNldFBhdXNlZAoJICogQHBhcmFtIHtCb29sZWFufSB2YWx1ZSBXaGV0aGVyIHRoZSBxdWV1ZSBzaG91bGQgYmUgcGF1c2VkIG9yIG5vdC4KCSAqLwoJcC5zZXRQYXVzZWQgPSBmdW5jdGlvbih2YWx1ZSkgewoJCXRoaXMuX3BhdXNlZCA9IHZhbHVlOwoJCWlmICghdGhpcy5fcGF1c2VkKSB7CgkJCXRoaXMuX2xvYWROZXh0KCk7CgkJfQoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmNsb3NlID0gZnVuY3Rpb24oKSB7CgkJd2hpbGUgKHRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGgpIHsKCQkJdGhpcy5fY3VycmVudExvYWRzLnBvcCgpLmNhbmNlbCgpOwoJCX0KCQl0aGlzLl9zY3JpcHRPcmRlci5sZW5ndGggPSAwOwoJCXRoaXMuX2xvYWRlZFNjcmlwdHMubGVuZ3RoID0gMDsKCQl0aGlzLmxvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCX07CgoKLy9Qcm90ZWN0ZWQgTWV0aG9kcwoJLyoqCgkgKiBBZGQgYW4gaXRlbSB0byB0aGUgcXVldWUuIEl0ZW1zIGFyZSBmb3JtYXR0ZWQgaW50byBhIHVzYWJsZSBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIHByb3BlcnRpZXMgbmVjZXNzYXJ5IHRvCgkgKiBsb2FkIHRoZSBjb250ZW50LiBUaGUgbG9hZCBxdWV1ZSBpcyBwb3B1bGF0ZWQgd2l0aCB0aGUgbG9hZGVyIGluc3RhbmNlIHRoYXQgaGFuZGxlcyBwcmVsb2FkaW5nLCBhbmQgbm90IHRoZSBsb2FkCgkgKiBpdGVtIHRoYXQgd2FzIHBhc3NlZCBpbiBieSB0aGUgdXNlci4gVG8gbG9vayB1cCB0aGUgbG9hZCBpdGVtIGJ5IGlkIG9yIHNyYywgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS5nZXRJdGVtIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZC4KCSAqIEBtZXRob2QgX2FkZEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdH0gdmFsdWUgVGhlIGl0ZW0gdG8gYWRkIHRvIHRoZSBxdWV1ZS4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbcGF0aF0gQW4gb3B0aW9uYWwgcGF0aCBwcmVwZW5kZWQgdG8gdGhlIGBzcmNgLiBUaGUgcGF0aCB3aWxsIG9ubHkgYmUgcHJlcGVuZGVkIGlmIHRoZSBzcmMgaXMKCSAqIHJlbGF0aXZlLCBhbmQgZG9lcyBub3Qgc3RhcnQgd2l0aCBhIHByb3RvY29sIHN1Y2ggYXMgYGh0dHA6Ly9gLCBvciBhIHBhdGggbGlrZSBgLi4vYC4gSWYgdGhlIExvYWRRdWV1ZSB3YXMKCSAqIHByb3ZpZGVkIGEge3sjY3Jvc3NMaW5rICJfYmFzZVBhdGgifX17ey9jcm9zc0xpbmt9fSwgdGhlbiBpdCB3aWxsIG9wdGlvbmFsbHkgYmUgcHJlcGVuZGVkIGFmdGVyLgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aF0gPHN0cm9uZz5EZXByZWNhdGVkPC9zdHJvbmc+QW4gb3B0aW9uYWwgYmFzZVBhdGggcGFzc2VkIGludG8gYSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fSBjYWxsLiBUaGlzIHBhcmFtZXRlciB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdGFnZ2VkCgkgKiB2ZXJzaW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5fYWRkSXRlbSA9IGZ1bmN0aW9uKHZhbHVlLCBwYXRoLCBiYXNlUGF0aCkgewoJCXZhciBpdGVtID0gdGhpcy5fY3JlYXRlTG9hZEl0ZW0odmFsdWUsIHBhdGgsIGJhc2VQYXRoKTsgLy8gYmFzZVBhdGggYW5kIG1hbmlmZXN0IHBhdGggYXJlIGFkZGVkIHRvIHRoZSBzcmMuCgkJaWYgKGl0ZW0gPT0gbnVsbCkgeyByZXR1cm47IH0gLy8gU29tZXRpbWVzIHBsdWdpbnMgb3IgdHlwZXMgc2hvdWxkIGJlIHNraXBwZWQuCgkJdmFyIGxvYWRlciA9IHRoaXMuX2NyZWF0ZUxvYWRlcihpdGVtKTsKCQlpZiAobG9hZGVyICE9IG51bGwpIHsKCQkJaXRlbS5fbG9hZGVyID0gbG9hZGVyOwoJCQl0aGlzLl9sb2FkUXVldWUucHVzaChsb2FkZXIpOwoJCQl0aGlzLl9sb2FkUXVldWVCYWNrdXAucHVzaChsb2FkZXIpOwoKCQkJdGhpcy5fbnVtSXRlbXMrKzsKCQkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCgkJCS8vIE9ubHkgd29ycnkgYWJvdXQgc2NyaXB0IG9yZGVyIHdoZW4gdXNpbmcgWEhSIHRvIGxvYWQgc2NyaXB0cy4gVGFncyBhcmUgb25seSBsb2FkaW5nIG9uZSBhdCBhIHRpbWUuCgkJCWlmICgodGhpcy5tYWludGFpblNjcmlwdE9yZGVyCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUCgkJCQkJLy8mJiBsb2FkZXIgaW5zdGFuY2VvZiBjcmVhdGVqcy5YSFJMb2FkZXIgLy9OT1RFOiBIYXZlIHRvIHRyYWNrIGFsbCBKUyBmaWxlcyB0aGlzIHdheQoJCQkJCSkKCQkJCQl8fCBpdGVtLm1haW50YWluT3JkZXIgPT09IHRydWUpIHsKCQkJCXRoaXMuX3NjcmlwdE9yZGVyLnB1c2goaXRlbSk7CgkJCQl0aGlzLl9sb2FkZWRTY3JpcHRzLnB1c2gobnVsbCk7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGEgcmVmaW5lZCBsb2FkIGl0ZW0sIHdoaWNoIGNvbnRhaW5zIGFsbCB0aGUgcmVxdWlyZWQgcHJvcGVydGllcyAoc3JjLCB0eXBlLCBleHRlbnNpb24sIHRhZykuIFRoZSB0eXBlIG9mCgkgKiBpdGVtIGlzIGRldGVybWluZWQgYnkgYnJvd3NlciBzdXBwb3J0LCByZXF1aXJlbWVudHMgYmFzZWQgb24gdGhlIGZpbGUgdHlwZSwgYW5kIGRldmVsb3BlciBzZXR0aW5ncy4gRm9yIGV4YW1wbGUsCgkgKiBYSFIgaXMgb25seSB1c2VkIGZvciBmaWxlIHR5cGVzIHRoYXQgc3VwcG9ydCBpdCBpbiBuZXcgYnJvd3NlcnMuCgkgKgoJICogQmVmb3JlIHRoZSBpdGVtIGlzIHJldHVybmVkLCBhbnkgcGx1Z2lucyByZWdpc3RlcmVkIHRvIGhhbmRsZSB0aGUgdHlwZSBvciBleHRlbnNpb24gd2lsbCBiZSBmaXJlZCwgd2hpY2ggbWF5CgkgKiBhbHRlciB0aGUgbG9hZCBpdGVtLgoJICogQG1ldGhvZCBfY3JlYXRlTG9hZEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nIHwgT2JqZWN0IHwgSFRNTEF1ZGlvRWxlbWVudCB8IEhUTUxJbWFnZUVsZW1lbnR9IHZhbHVlIFRoZSBpdGVtIHRoYXQgbmVlZHMgdG8gYmUgcHJlbG9hZGVkLgogCSAqIEBwYXJhbSB7U3RyaW5nfSBbcGF0aF0gQSBwYXRoIHRvIHByZXBlbmQgdG8gdGhlIGl0ZW0ncyBzb3VyY2UuIFNvdXJjZXMgYmVnaW5uaW5nIHdpdGggaHR0cDovLyBvciBzaW1pbGFyIHdpbGwKCSAqIG5vdCByZWNlaXZlIGEgcGF0aC4gU2luY2UgUHJlbG9hZEpTIDAuNC4xLCB0aGUgc3JjIHdpbGwgYmUgbW9kaWZpZWQgdG8gaW5jbHVkZSB0aGUgYHBhdGhgIGFuZCB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9fYmFzZVBhdGg6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fQoJICogd2hlbiBpdCBpcyBhZGRlZC4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbYmFzZVBhdGhdIDxzdHJvbmc+RGVwcmVjdGF0ZWQ8L3N0cm9uZz4gQSBiYXNlIHBhdGggdG8gcHJlcGVuZCB0byB0aGUgaXRlbXMgc291cmNlIGluIGFkZGl0aW9uIHRvCgkgKiB0aGUgcGF0aCBhcmd1bWVudC4KCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGxvYWRlciBpbnN0YW5jZSB0aGF0IHdpbGwgYmUgdXNlZC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NyZWF0ZUxvYWRJdGVtID0gZnVuY3Rpb24odmFsdWUsIHBhdGgsIGJhc2VQYXRoKSB7CgkJdmFyIGl0ZW0gPSBudWxsOwoKCQkvLyBDcmVhdGUvbW9kaWZ5IGEgbG9hZCBpdGVtCgkJc3dpdGNoKHR5cGVvZih2YWx1ZSkpIHsKCQkJY2FzZSAic3RyaW5nIjoKCQkJCWl0ZW0gPSB7CgkJCQkJc3JjOiB2YWx1ZQoJCQkJfTsgYnJlYWs7CgkJCWNhc2UgIm9iamVjdCI6CgkJCQlpZiAod2luZG93LkhUTUxBdWRpb0VsZW1lbnQgJiYgdmFsdWUgaW5zdGFuY2VvZiB3aW5kb3cuSFRNTEF1ZGlvRWxlbWVudCkgewoJCQkJCWl0ZW0gPSB7CgkJCQkJCXRhZzogdmFsdWUsCgkJCQkJCXNyYzogaXRlbS50YWcuc3JjLAoJCQkJCQl0eXBlOiBjcmVhdGVqcy5Mb2FkUXVldWUuU09VTkQKCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdmFsdWU7CgkJCQl9CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBudWxsOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIEV4dGVuc2lvbiwgZXRjLgoJCXZhciBtYXRjaCA9IHRoaXMuX3BhcnNlVVJJKGl0ZW0uc3JjKTsKCQlpZiAobWF0Y2guZXh0ZW5zaW9uKSB7IGl0ZW0uZXh0ID0gbWF0Y2guZXh0ZW5zaW9uOyB9CgkJaWYgKGl0ZW0udHlwZSA9PSBudWxsKSB7CgkJCWl0ZW0udHlwZSA9IHRoaXMuX2dldFR5cGVCeUV4dGVuc2lvbihpdGVtLmV4dCk7CgkJfQoKCQkvLyBJbmplY3QgcGF0aCAmIGJhc2VQYXRoCgkJdmFyIGJwID0gIiI7IC8vIFN0b3JlIHRoZSBnZW5lcmF0ZWQgYmFzZVBhdGgKCQl2YXIgdXNlQmFzZVBhdGggPSBiYXNlUGF0aCB8fCB0aGlzLl9iYXNlUGF0aDsKCQl2YXIgYXV0b0lkID0gaXRlbS5zcmM7CgkJaWYgKCFtYXRjaC5hYnNvbHV0ZSAmJiAhbWF0Y2gucmVsYXRpdmUpIHsKCQkJaWYgKHBhdGgpIHsKCQkJCWJwID0gcGF0aDsKCQkJCXZhciBwYXRoTWF0Y2ggPSB0aGlzLl9wYXJzZVVSSShwYXRoKTsKCQkJCWF1dG9JZCA9IHBhdGggKyBhdXRvSWQ7CgkJCQkvLyBBbHNvIGFwcGVuZCBiYXNlUGF0aAoJCQkJaWYgKHVzZUJhc2VQYXRoICE9IG51bGwgJiYgIXBhdGhNYXRjaC5hYnNvbHV0ZSAmJiAhcGF0aE1hdGNoLnJlbGF0aXZlKSB7CgkJCQkJYnAgPSB1c2VCYXNlUGF0aCArIGJwOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHVzZUJhc2VQYXRoICE9IG51bGwpIHsKCQkJCWJwID0gdXNlQmFzZVBhdGg7CgkJCX0KCQl9CgkJaXRlbS5zcmMgPSBicCArIGl0ZW0uc3JjOwoJCWl0ZW0ucGF0aCA9IGJwOwoKCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OIHx8IGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1QpIHsKCQkJaXRlbS5fbG9hZEFzSlNPTlAgPSAoaXRlbS5jYWxsYmFjayAhPSBudWxsKTsKCQl9CgoJCWlmIChpdGVtLnR5cGUgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QICYmIGl0ZW0uY2FsbGJhY2sgPT0gbnVsbCkgewoJCQl0aHJvdyBuZXcgRXJyb3IoJ2NhbGxiYWNrIGlzIHJlcXVpcmVkIGZvciBsb2FkaW5nIEpTT05QIHJlcXVlc3RzLicpOwoJCX0KCgkJLy8gQ3JlYXRlIGEgdGFnIGZvciB0aGUgaXRlbS4gVGhpcyBlbnN1cmVzIHRoZXJlIGlzIHNvbWV0aGluZyB0byBlaXRoZXIgbG9hZCB3aXRoIG9yIHBvcHVsYXRlIHdoZW4gZmluaXNoZWQuCgkJaWYgKGl0ZW0udGFnID09PSB1bmRlZmluZWQgfHwgaXRlbS50YWcgPT09IG51bGwpIHsKCQkJaXRlbS50YWcgPSB0aGlzLl9jcmVhdGVUYWcoaXRlbSk7CgkJfQoKCQkvLyBJZiB0aGVyZSdzIG5vIGlkLCBzZXQgb25lIG5vdy4KCQlpZiAoaXRlbS5pZCA9PT0gdW5kZWZpbmVkIHx8IGl0ZW0uaWQgPT09IG51bGwgfHwgaXRlbS5pZCA9PT0gIiIpIHsKICAgICAgICAgICAgaXRlbS5pZCA9IGF1dG9JZDsKCQl9CgoJCS8vIEdpdmUgcGx1Z2lucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGxvYWRJdGVtOgoJCXZhciBjdXN0b21IYW5kbGVyID0gdGhpcy5fdHlwZUNhbGxiYWNrc1tpdGVtLnR5cGVdIHx8IHRoaXMuX2V4dGVuc2lvbkNhbGxiYWNrc1tpdGVtLmV4dF07CgkJaWYgKGN1c3RvbUhhbmRsZXIpIHsKCQkJLy8gUGx1Z2lucyBhcmUgbm93IHBhc3NlZCBib3RoIHRoZSBmdWxsIHNvdXJjZSwgYXMgd2VsbCBhcyBhIGNvbWJpbmVkIHBhdGgrYmFzZVBhdGggKGFwcHJvcHJpYXRlbHkpCgkJCXZhciByZXN1bHQgPSBjdXN0b21IYW5kbGVyLmNhbGxiYWNrLmNhbGwoY3VzdG9tSGFuZGxlci5zY29wZSwgaXRlbS5zcmMsIGl0ZW0udHlwZSwgaXRlbS5pZCwgaXRlbS5kYXRhLAoJCQkJCWJwLCB0aGlzKTsKCQkJLy8gTk9URTogQmFzZVBhdGggYXJndW1lbnQgaXMgZGVwcmVjYXRlZC4gV2UgcGFzcyBpdCB0byBwbHVnaW5zLmFsbG93IFNvdW5kSlMgdG8gbW9kaWZ5IHRoZSBmaWxlLiB0byBzYW55bW9yZS4gVGhlIGZ1bGwgcGF0aCBpcyBzZW50IHRvIHRoZSBwbHVnaW4KCgkJCS8vIFRoZSBwbHVnaW4gd2lsbCBoYW5kbGUgdGhlIGxvYWQsIG9yIGhhcyBjYW5jZWxlZCBpdC4gSWdub3JlIGl0LgoJCQlpZiAocmVzdWx0ID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIG51bGw7CgoJCQkvLyBMb2FkIGFzIG5vcm1hbDoKCQkJfSBlbHNlIGlmIChyZXN1bHQgPT09IHRydWUpIHsKCQkJCS8vIERvIE5vdGhpbmcKCgkJCS8vIFJlc3VsdCBpcyBhIGxvYWRlciBjbGFzczoKCQkJfSBlbHNlIHsKCQkJCWlmIChyZXN1bHQuc3JjICE9IG51bGwpIHsgaXRlbS5zcmMgPSByZXN1bHQuc3JjOyB9CgkJCQlpZiAocmVzdWx0LmlkICE9IG51bGwpIHsgaXRlbS5pZCA9IHJlc3VsdC5pZDsgfSAvLyBUT0RPOiBFdmFsdWF0ZSB0aGlzLiBBbiBvdmVycmlkZGVuIElEIGNvdWxkIGJlIHByb2JsZW1hdGljCgkJCQlpZiAocmVzdWx0LnRhZyAhPSBudWxsKSB7IC8vIEFzc3VtZXMgdGhhdCB0aGUgcmV0dXJuZWQgdGFnIGVpdGhlciBoYXMgYSBsb2FkIG1ldGhvZCBvciBhIHNyYyBzZXR0ZXIuCgkJCQkJaXRlbS50YWcgPSByZXN1bHQudGFnOwoJCQkJfQogICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5jb21wbGV0ZUhhbmRsZXIgIT0gbnVsbCkgeyBpdGVtLmNvbXBsZXRlSGFuZGxlciA9IHJlc3VsdC5jb21wbGV0ZUhhbmRsZXI7IH0KCgkJCQkvLyBBbGxvdyB0eXBlIG92ZXJyaWRpbmc6CgkJCQlpZiAocmVzdWx0LnR5cGUpIHsgaXRlbS50eXBlID0gcmVzdWx0LnR5cGU7IH0KCgkJCQkvLyBVcGRhdGUgdGhlIGV4dGVuc2lvbiBpbiBjYXNlIHRoZSB0eXBlIGNoYW5nZWQ6CgkJCQltYXRjaCA9IHRoaXMuX3BhcnNlVVJJKGl0ZW0uc3JjKTsKCQkJCWlmIChtYXRjaC5leHRlbnNpb24gIT0gbnVsbCkgewoJCQkJCWl0ZW0uZXh0ID0gbWF0Y2guZXh0ZW5zaW9uOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBTdG9yZSB0aGUgaXRlbSBmb3IgbG9va3VwLiBUaGlzIGFsc28gaGVscHMgY2xlYW4tdXAgbGF0ZXIuCgkJdGhpcy5fbG9hZEl0ZW1zQnlJZFtpdGVtLmlkXSA9IGl0ZW07CgkJdGhpcy5fbG9hZEl0ZW1zQnlTcmNbaXRlbS5zcmNdID0gaXRlbTsKCgkJcmV0dXJuIGl0ZW07Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGEgbG9hZGVyIGZvciBhIGxvYWQgaXRlbS4KCSAqIEBtZXRob2QgX2NyZWF0ZUxvYWRlcgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gQSBmb3JtYXR0ZWQgbG9hZCBpdGVtIHRoYXQgY2FuIGJlIHVzZWQgdG8gZ2VuZXJhdGUgYSBsb2FkZXIuCgkgKiBAcmV0dXJuIHtBYnN0cmFjdExvYWRlcn0gQSBsb2FkZXIgdGhhdCBjYW4gYmUgdXNlZCB0byBsb2FkIGNvbnRlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jcmVhdGVMb2FkZXIgPSBmdW5jdGlvbihpdGVtKSB7CgkJLy8gSW5pdGlhbGx5LCB0cnkgYW5kIHVzZSB0aGUgcHJvdmlkZWQvc3VwcG9ydGVkIFhIUiBtb2RlOgoJCXZhciB1c2VYSFIgPSB0aGlzLnVzZVhIUjsKCgkJLy8gRGV0ZXJtaW5lIHRoZSBYSFIgdXNhZ2Ugb3ZlcnJpZGVzOgoJCXN3aXRjaCAoaXRlbS50eXBlKSB7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQkJdXNlWEhSID0gIWl0ZW0uX2xvYWRBc0pTT05QOwoJCQkJYnJlYWs7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDoKCQkJCXVzZVhIUiA9IHRydWU7IC8vIEFsd2F5cyB1c2UgWEhSMiB3aXRoIHRleHQvWE1MCgkJCQlicmVhazsKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuU09VTkQ6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QOgoJCQkJdXNlWEhSID0gZmFsc2U7IC8vIE5ldmVyIGxvYWQgYXVkaW8gdXNpbmcgWEhSLiBXZWJBdWRpbyB3aWxsIHByb3ZpZGUgaXRzIG93biBsb2FkZXIuCgkJCQlicmVhazsKCQkJY2FzZSBudWxsOgoJCQkJcmV0dXJuIG51bGw7CgkJCS8vIE5vdGU6IElNQUdFLCBDU1MsIFNDUklQVCwgU1ZHIGNhbiBhbGwgdXNlIFRBR1Mgb3IgWEhSLgoJCX0KCgkJaWYgKHVzZVhIUikgewoJCQlyZXR1cm4gbmV3IGNyZWF0ZWpzLlhIUkxvYWRlcihpdGVtLCB0aGlzLl9jcm9zc09yaWdpbik7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBjcmVhdGVqcy5UYWdMb2FkZXIoaXRlbSk7CgkJfQoJfTsKCgoJLyoqCgkgKiBMb2FkIHRoZSBuZXh0IGl0ZW0gaW4gdGhlIHF1ZXVlLiBJZiB0aGUgcXVldWUgaXMgZW1wdHkgKGFsbCBpdGVtcyBoYXZlIGJlZW4gbG9hZGVkKSwgdGhlbiB0aGUgY29tcGxldGUgZXZlbnQKCSAqIGlzIHByb2Nlc3NlZC4gVGhlIHF1ZXVlIHdpbGwgImZpbGwgdXAiIGFueSBlbXB0eSBzbG90cywgdXAgdG8gdGhlIG1heCBjb25uZWN0aW9uIHNwZWNpZmllZCB1c2luZwoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUuc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuIFRoZSBvbmx5IGV4Y2VwdGlvbiBpcyBzY3JpcHRzIHRoYXQgYXJlIGxvYWRlZAoJICogdXNpbmcgdGFncywgd2hpY2ggaGF2ZSB0byBiZSBsb2FkZWQgb25lIGF0IGEgdGltZSB0byBtYWludGFpbiBsb2FkIG9yZGVyLgoJICogQG1ldGhvZCBfbG9hZE5leHQKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWROZXh0ID0gZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuX3BhdXNlZCkgeyByZXR1cm47IH0KCgkJLy8gT25seSBkaXNwYXRjaCBsb2Fkc3RhcnQgZXZlbnQgd2hlbiB0aGUgZmlyc3QgZmlsZSBpcyBsb2FkZWQuCgkJaWYgKCF0aGlzLl9sb2FkU3RhcnRXYXNEaXNwYXRjaGVkKSB7CgkJCXRoaXMuX3NlbmRMb2FkU3RhcnQoKTsKCQkJdGhpcy5fbG9hZFN0YXJ0V2FzRGlzcGF0Y2hlZCA9IHRydWU7CgkJfQoKCQkvLyBUaGUgcXVldWUgaGFzIGNvbXBsZXRlZC4KCQlpZiAodGhpcy5fbnVtSXRlbXMgPT0gdGhpcy5fbnVtSXRlbXNMb2FkZWQpIHsKCQkJdGhpcy5sb2FkZWQgPSB0cnVlOwoJCQl0aGlzLl9zZW5kQ29tcGxldGUoKTsKCgkJCS8vIExvYWQgdGhlIG5leHQgcXVldWUsIGlmIGl0IGhhcyBiZWVuIGRlZmluZWQuCgkJCWlmICh0aGlzLm5leHQgJiYgdGhpcy5uZXh0LmxvYWQpIHsKCQkJCXRoaXMubmV4dC5sb2FkKCk7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLmxvYWRlZCA9IGZhbHNlOwoJCX0KCgkJLy8gTXVzdCBpdGVyYXRlIGZvcndhcmRzIHRvIGxvYWQgaW4gdGhlIHJpZ2h0IG9yZGVyLgoJCWZvciAodmFyIGk9MDsgaTx0aGlzLl9sb2FkUXVldWUubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGggPj0gdGhpcy5fbWF4Q29ubmVjdGlvbnMpIHsgYnJlYWs7IH0KCQkJdmFyIGxvYWRlciA9IHRoaXMuX2xvYWRRdWV1ZVtpXTsKCgkJCS8vIERldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgb25seSBsb2FkaW5nIG9uZSB0YWctc2NyaXB0IGF0IGEgdGltZToKCQkJLy8gTm90ZTogbWFpbnRhaW5PcmRlciBpdGVtcyBkb24ndCBkbyBhbnl0aGluZyBoZXJlIGJlY2F1c2Ugd2UgY2FuIGhvbGQgb250byB0aGVpciBsb2FkZWQgdmFsdWUKCQkJaWYgKCF0aGlzLl9jYW5TdGFydExvYWQobG9hZGVyKSkgeyBjb250aW51ZTsgfQoJCQl0aGlzLl9sb2FkUXVldWUuc3BsaWNlKGksIDEpOwogIAkJCWktLTsKICAgICAgICAgICAgdGhpcy5fbG9hZEl0ZW0obG9hZGVyKTsKCQl9Cgl9OwoKCS8qKgoJICogQmVnaW4gbG9hZGluZyBhbiBpdGVtLiBFdmVudHMgYXJlIG5vdCBhZGRlZCB0byB0aGUgbG9hZGVycyB1bnRpbCB0aGUgbG9hZCBzdGFydHMuCgkgKiBAbWV0aG9kIF9sb2FkSXRlbQoJICogQHBhcmFtIHtBYnN0cmFjdExvYWRlcn0gbG9hZGVyIFRoZSBsb2FkZXIgaW5zdGFuY2UgdG8gc3RhcnQuIEN1cnJlbnRseSwgdGhpcyB3aWxsIGJlIGFuIFhIUkxvYWRlciBvciBUYWdMb2FkZXIuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkSXRlbSA9IGZ1bmN0aW9uKGxvYWRlcikgewoJCWxvYWRlci5vbigicHJvZ3Jlc3MiLCB0aGlzLl9oYW5kbGVQcm9ncmVzcywgdGhpcyk7CgkJbG9hZGVyLm9uKCJjb21wbGV0ZSIsIHRoaXMuX2hhbmRsZUZpbGVDb21wbGV0ZSwgdGhpcyk7CgkJbG9hZGVyLm9uKCJlcnJvciIsIHRoaXMuX2hhbmRsZUZpbGVFcnJvciwgdGhpcyk7CgkJdGhpcy5fY3VycmVudExvYWRzLnB1c2gobG9hZGVyKTsKCQl0aGlzLl9zZW5kRmlsZVN0YXJ0KGxvYWRlci5nZXRJdGVtKCkpOwoJCWxvYWRlci5sb2FkKCk7Cgl9OwoKCS8qKgoJICogVGhlIGNhbGxiYWNrIHRoYXQgaXMgZmlyZWQgd2hlbiBhIGxvYWRlciBlbmNvdW50ZXJzIGFuIGVycm9yLiBUaGUgcXVldWUgd2lsbCBjb250aW51ZSBsb2FkaW5nIHVubGVzcyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zdG9wT25FcnJvcjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiBpcyBzZXQgdG8gYHRydWVgLgoJICogQG1ldGhvZCBfaGFuZGxlRmlsZUVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIGVycm9yIGV2ZW50LCBjb250YWluaW5nIHJlbGV2YW50IGVycm9yIGluZm9ybWF0aW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlRmlsZUVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgbG9hZGVyID0gZXZlbnQudGFyZ2V0OwoJCXRoaXMuX251bUl0ZW1zTG9hZGVkKys7CgoJCXRoaXMuX2ZpbmlzaE9yZGVyZWRJdGVtKGxvYWRlciwgdHJ1ZSk7CgkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCgkJdmFyIG5ld0V2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCW5ld0V2ZW50LnRleHQgPSAiRklMRV9MT0FEX0VSUk9SIjsKCQluZXdFdmVudC5pdGVtID0gbG9hZGVyLmdldEl0ZW0oKTsKCQkvLyBUT0RPOiBQcm9wYWdhdGUgYWN0dWFsIGVycm9yIG1lc3NhZ2UuCgoJCXRoaXMuX3NlbmRFcnJvcihuZXdFdmVudCk7CgoJCWlmICghdGhpcy5zdG9wT25FcnJvcikgewoJCQl0aGlzLl9yZW1vdmVMb2FkSXRlbShsb2FkZXIpOwoJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCX0KCX07CgoJLyoqCgkgKiBBbiBpdGVtIGhhcyBmaW5pc2hlZCBsb2FkaW5nLiBXZSBjYW4gYXNzdW1lIHRoYXQgaXQgaXMgdG90YWxseSBsb2FkZWQsIGhhcyBiZWVuIHBhcnNlZCBmb3IgaW1tZWRpYXRlIHVzZSwgYW5kCgkgKiBpcyBhdmFpbGFibGUgYXMgdGhlICJyZXN1bHQiIHByb3BlcnR5IG9uIHRoZSBsb2FkIGl0ZW0uIFRoZSByYXcgdGV4dCByZXN1bHQgZm9yIGEgcGFyc2VkIGl0ZW0gKHN1Y2ggYXMgSlNPTiwgWE1MLAoJICogQ1NTLCBKYXZhU2NyaXB0LCBldGMpIGlzIGF2YWlsYWJsZSBhcyB0aGUgInJhd1Jlc3VsdCIgZXZlbnQsIGFuZCBjYW4gYWxzbyBiZSBsb29rZWQgdXAgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZ2V0UmVzdWx0In19e3svY3Jvc3NMaW5rfX0uCgkgKiBAbWV0aG9kIF9oYW5kbGVGaWxlQ29tcGxldGUKCSAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgZXZlbnQgb2JqZWN0IGZyb20gdGhlIGxvYWRlci4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUZpbGVDb21wbGV0ZSA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIGxvYWRlciA9IGV2ZW50LnRhcmdldDsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgoJCXRoaXMuX2xvYWRlZFJlc3VsdHNbaXRlbS5pZF0gPSBsb2FkZXIuZ2V0UmVzdWx0KCk7CgkJaWYgKGxvYWRlciBpbnN0YW5jZW9mIGNyZWF0ZWpzLlhIUkxvYWRlcikgewoJCQl0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2l0ZW0uaWRdID0gbG9hZGVyLmdldFJlc3VsdCh0cnVlKTsKCQl9CgoJCS8vIENsZWFuIHVwIHRoZSBsb2FkIGl0ZW0KCQl0aGlzLl9yZW1vdmVMb2FkSXRlbShsb2FkZXIpOwoKCQlpZiAoIXRoaXMuX2ZpbmlzaE9yZGVyZWRJdGVtKGxvYWRlcikpIHsKCQkJLy8gVGhlIGl0ZW0gd2FzIE5PVCBtYW5hZ2VkLCBzbyBwcm9jZXNzIGl0IG5vdwoJCQl0aGlzLl9wcm9jZXNzRmluaXNoZWRMb2FkKGl0ZW0sIGxvYWRlcik7CgkJfQoJfTsKCgkvKioKCSAqIEZsYWcgYW4gaXRlbSBhcyBmaW5pc2hlZC4gSWYgdGhlIGl0ZW0ncyBvcmRlciBpcyBiZWluZyBtYW5hZ2VkLCB0aGVuIHNldCBpdCB1cCB0byBmaW5pc2gKCSAqIEBtZXRob2QgX2ZpbmlzaE9yZGVyZWRJdGVtCgkgKiBAcGFyYW0ge0Fic3RyYWN0TG9hZGVyfSBsb2FkZXIKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBpdGVtJ3Mgb3JkZXIgaXMgYmVpbmcgbWFuYWdlZC4gVGhpcyBhbGxvd3MgdGhlIGNhbGxlciB0byB0YWtlIGFuIGFsdGVybmF0ZQoJICogYmVoYXZpb3VyIGlmIGl0IGlzLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZmluaXNoT3JkZXJlZEl0ZW0gPSBmdW5jdGlvbihsb2FkZXIsIGxvYWRGYWlsZWQpIHsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgoJCWlmICgodGhpcy5tYWludGFpblNjcmlwdE9yZGVyICYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVCkKCQkJCXx8IGl0ZW0ubWFpbnRhaW5PcmRlcikgewoKCQkJLy9UT0RPOiBFdmFsdWF0ZSByZW1vdmFsIG9mIHRoZSBfY3VycmVudGx5TG9hZGluZ1NjcmlwdAoJCQlpZiAobG9hZGVyIGluc3RhbmNlb2YgY3JlYXRlanMuVGFnTG9hZGVyICYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVCkgewoJCQkJdGhpcy5fY3VycmVudGx5TG9hZGluZ1NjcmlwdCA9IGZhbHNlOwoJCQl9CgoJCQl2YXIgaW5kZXggPSBjcmVhdGVqcy5pbmRleE9mKHRoaXMuX3NjcmlwdE9yZGVyLCBpdGVtKTsKCQkJaWYgKGluZGV4ID09IC0xKSB7IHJldHVybiBmYWxzZTsgfSAvLyBUaGlzIGxvYWRlciBubyBsb25nZXIgZXhpc3RzCgkJCXRoaXMuX2xvYWRlZFNjcmlwdHNbaW5kZXhdID0gKGxvYWRGYWlsZWQgPT09IHRydWUpID8gdHJ1ZSA6IGl0ZW07CgoJCQl0aGlzLl9jaGVja1NjcmlwdExvYWRPcmRlcigpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX07CgoJLyoqCgkgKiBFbnN1cmUgdGhlIHNjcmlwdHMgbG9hZCBhbmQgZGlzcGF0Y2ggaW4gdGhlIGNvcnJlY3Qgb3JkZXIuIFdoZW4gdXNpbmcgWEhSLCBzY3JpcHRzIGFyZSBzdG9yZWQgaW4gYW4gYXJyYXkgaW4gdGhlCgkgKiBvcmRlciB0aGV5IHdlcmUgYWRkZWQsIGJ1dCB3aXRoIGEgIm51bGwiIHZhbHVlLiBXaGVuIHRoZXkgYXJlIGNvbXBsZXRlZCwgdGhlIHZhbHVlIGlzIHNldCB0byB0aGUgbG9hZCBpdGVtLAoJICogYW5kIHRoZW4gd2hlbiB0aGV5IGFyZSBwcm9jZXNzZWQgYW5kIGRpc3BhdGNoZWQsIHRoZSB2YWx1ZSBpcyBzZXQgdG8gPGNvZGU+dHJ1ZTwvY29kZT4uIFRoaXMgbWV0aG9kIHNpbXBseQoJICogaXRlcmF0ZXMgdGhlIGFycmF5LCBhbmQgZW5zdXJlcyB0aGF0IGFueSBsb2FkZWQgaXRlbXMgdGhhdCBhcmUgbm90IHByZWNlZGVkIGJ5IGEgPGNvZGU+bnVsbDwvY29kZT4gdmFsdWUgYXJlCgkgKiBkaXNwYXRjaGVkLgoJICogQG1ldGhvZCBfY2hlY2tTY3JpcHRMb2FkT3JkZXIKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NoZWNrU2NyaXB0TG9hZE9yZGVyID0gZnVuY3Rpb24gKCkgewoJCXZhciBsID0gdGhpcy5fbG9hZGVkU2NyaXB0cy5sZW5ndGg7CgoJCWZvciAodmFyIGk9MDtpPGw7aSsrKSB7CgkJCXZhciBpdGVtID0gdGhpcy5fbG9hZGVkU2NyaXB0c1tpXTsKCQkJaWYgKGl0ZW0gPT09IG51bGwpIHsgYnJlYWs7IH0gLy8gVGhpcyBpcyBzdGlsbCBsb2FkaW5nLiBEbyBub3QgcHJvY2VzcyBmdXJ0aGVyLgogCQkJaWYgKGl0ZW0gPT09IHRydWUpIHsgY29udGludWU7IH0gLy8gVGhpcyBoYXMgY29tcGxldGVkLCBhbmQgYmVlbiBwcm9jZXNzZWQuIE1vdmUgb24uCgoJCQl2YXIgbG9hZEl0ZW0gPSB0aGlzLl9sb2FkZWRSZXN1bHRzW2l0ZW0uaWRdOwoJCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUKSB7CgkJCQkvLyBBcHBlbmQgc2NyaXB0IHRhZ3MgdG8gdGhlIGhlYWQgYXV0b21hdGljYWxseS4gVGFncyBkbyB0aGlzIGluIHRoZSBsb2FkZXIsIGJ1dCBYSFIgc2NyaXB0cyBoYXZlIHRvIG1haW50YWluIG9yZGVyLgoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXSkuYXBwZW5kQ2hpbGQobG9hZEl0ZW0pOwoJCQl9CgoJCQl2YXIgbG9hZGVyID0gaXRlbS5fbG9hZGVyOwoJCQl0aGlzLl9wcm9jZXNzRmluaXNoZWRMb2FkKGl0ZW0sIGxvYWRlcik7CgkJCXRoaXMuX2xvYWRlZFNjcmlwdHNbaV0gPSB0cnVlOwoJCX0KCX07CgoJLyoqCgkgKiBAbWV0aG9kIF9wcm9jZXNzRmluaXNoZWRMb2FkCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbQoJICogQHBhcmFtIHtBYnN0cmFjdExvYWRlcn0gbG9hZGVyCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3Byb2Nlc3NGaW5pc2hlZExvYWQgPSBmdW5jdGlvbihpdGVtLCBsb2FkZXIpIHsKCQkvLyBJZiB0aGUgaXRlbSB3YXMgYSBtYW5pZmVzdCwgdGhlbiBxdWV1ZSBpdCB1cCEKCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQl2YXIgcmVzdWx0ID0gbG9hZGVyLmdldFJlc3VsdCgpOwoJCQlpZiAocmVzdWx0ICE9IG51bGwgJiYgcmVzdWx0Lm1hbmlmZXN0ICE9PSB1bmRlZmluZWQpIHsKCQkJCXRoaXMubG9hZE1hbmlmZXN0KHJlc3VsdCwgdHJ1ZSk7CgkJCX0KCQl9CgoJCXRoaXMuX251bUl0ZW1zTG9hZGVkKys7CgkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCQl0aGlzLl9zZW5kRmlsZUNvbXBsZXRlKGl0ZW0sIGxvYWRlcik7CgoJCXRoaXMuX2xvYWROZXh0KCk7Cgl9OwoKCS8qKgoJICogRW5zdXJlIGl0ZW1zIHdpdGggYG1haW50YWluT3JkZXI9dHJ1ZWAgdGhhdCBhcmUgYmVmb3JlIHRoZSBzcGVjaWZpZWQgaXRlbSBoYXZlIGxvYWRlZC4gVGhpcyBvbmx5IGFwcGxpZXMgdG8KCSAqIEphdmFTY3JpcHQgaXRlbXMgdGhhdCBhcmUgYmVpbmcgbG9hZGVkIHdpdGggYSBUYWdMb2FkZXIsIHNpbmNlIHRoZXkgaGF2ZSB0byBiZSBsb2FkZWQgYW5kIGNvbXBsZXRlZCA8c3Ryb25nPmJlZm9yZTwvc3Ryb25nPgoJICogdGhlIHNjcmlwdCBjYW4gZXZlbiBiZSBzdGFydGVkLCBzaW5jZSBpdCBleGlzdCBpbiB0aGUgRE9NIHdoaWxlIGxvYWRpbmcuCgkgKiBAbWV0aG9kIF9jYW5TdGFydExvYWQKCSAqIEBwYXJhbSB7WEhSTG9hZGVyfFRhZ0xvYWRlcn0gbG9hZGVyIFRoZSBsb2FkZXIgZm9yIHRoZSBpdGVtCgkgKiBAcmV0dXJuIHtCb29sZWFufSBXaGV0aGVyIHRoZSBpdGVtIGNhbiBzdGFydCBhIGxvYWQgb3Igbm90LgoJICogQHByaXZhdGUKCSAqLwoJcC5fY2FuU3RhcnRMb2FkID0gZnVuY3Rpb24obG9hZGVyKSB7CgkJaWYgKCF0aGlzLm1haW50YWluU2NyaXB0T3JkZXIgfHwgbG9hZGVyIGluc3RhbmNlb2YgY3JlYXRlanMuWEhSTG9hZGVyKSB7IHJldHVybiB0cnVlOyB9CgkJdmFyIGl0ZW0gPSBsb2FkZXIuZ2V0SXRlbSgpOwoJCWlmIChpdGVtLnR5cGUgIT0gY3JlYXRlanMuTG9hZFF1ZXVlLkpBVkFTQ1JJUFQpIHsgcmV0dXJuIHRydWU7IH0KCQlpZiAodGhpcy5fY3VycmVudGx5TG9hZGluZ1NjcmlwdCkgeyByZXR1cm4gZmFsc2U7IH0KCgkJdmFyIGluZGV4ID0gdGhpcy5fc2NyaXB0T3JkZXIuaW5kZXhPZihpdGVtKTsKCQl2YXIgaSA9IDA7CgkJd2hpbGUgKGkgPCBpbmRleCkgewoJCQl2YXIgY2hlY2tJdGVtID0gdGhpcy5fbG9hZGVkU2NyaXB0c1tpXTsKCQkJaWYgKGNoZWNrSXRlbSA9PSBudWxsKSB7IHJldHVybiBmYWxzZTsgfQoJCQlpKys7CgkJfQoJCXRoaXMuX2N1cnJlbnRseUxvYWRpbmdTY3JpcHQgPSB0cnVlOwoJCXJldHVybiB0cnVlOwoJfTsKCgkvKioKCSAqIEEgbG9hZCBpdGVtIGlzIGNvbXBsZXRlZCBvciB3YXMgY2FuY2VsZWQsIGFuZCBuZWVkcyB0byBiZSByZW1vdmVkIGZyb20gdGhlIExvYWRRdWV1ZS4KCSAqIEBtZXRob2QgX3JlbW92ZUxvYWRJdGVtCgkgKiBAcGFyYW0ge0Fic3RyYWN0TG9hZGVyfSBsb2FkZXIgQSBsb2FkZXIgaW5zdGFuY2UgdG8gcmVtb3ZlLgoJICogQHByaXZhdGUKCSAqLwoJcC5fcmVtb3ZlTG9hZEl0ZW0gPSBmdW5jdGlvbihsb2FkZXIpIHsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgkJZGVsZXRlIGl0ZW0uX2xvYWRlcjsKCQlkZWxldGUgaXRlbS5fbG9hZEFzSlNPTlA7CgoJCXZhciBsID0gdGhpcy5fY3VycmVudExvYWRzLmxlbmd0aDsKCQlmb3IgKHZhciBpPTA7aTxsO2krKykgewoJCQlpZiAodGhpcy5fY3VycmVudExvYWRzW2ldID09IGxvYWRlcikgewoJCQkJdGhpcy5fY3VycmVudExvYWRzLnNwbGljZShpLDEpOyBicmVhazsKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBBbiBpdGVtIGhhcyBkaXNwYXRjaGVkIHByb2dyZXNzLiBQcm9wYWdhdGUgdGhhdCBwcm9ncmVzcywgYW5kIHVwZGF0ZSB0aGUgTG9hZFF1ZXVlIG92ZXJhbGwgcHJvZ3Jlc3MuCgkgKiBAbWV0aG9kIF9oYW5kbGVQcm9ncmVzcwoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBwcm9ncmVzcyBldmVudCBmcm9tIHRoZSBpdGVtLgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlUHJvZ3Jlc3MgPSBmdW5jdGlvbihldmVudCkgewoJCXZhciBsb2FkZXIgPSBldmVudC50YXJnZXQ7CgkJdGhpcy5fc2VuZEZpbGVQcm9ncmVzcyhsb2FkZXIuZ2V0SXRlbSgpLCBsb2FkZXIucHJvZ3Jlc3MpOwoJCXRoaXMuX3VwZGF0ZVByb2dyZXNzKCk7Cgl9OwoKCS8qKgoJICogT3ZlcmFsbCBwcm9ncmVzcyBoYXMgY2hhbmdlZCwgc28gZGV0ZXJtaW5lIHRoZSBuZXcgcHJvZ3Jlc3MgYW1vdW50IGFuZCBkaXNwYXRjaCBpdC4gVGhpcyBjaGFuZ2VzIGFueSB0aW1lIGFuCgkgKiBpdGVtIGRpc3BhdGNoZXMgcHJvZ3Jlc3Mgb3IgY29tcGxldGVzLiBOb3RlIHRoYXQgc2luY2Ugd2UgZG9uJ3Qga25vdyB0aGUgYWN0dWFsIGZpbGVzaXplIG9mIGl0ZW1zIGJlZm9yZSB0aGV5IGFyZQoJICogbG9hZGVkLCBhbmQgZXZlbiB0aGVuIHdlIGNhbiBvbmx5IGdldCB0aGUgc2l6ZSBvZiBpdGVtcyBsb2FkZWQgd2l0aCBYSFIuIEluIHRoaXMgY2FzZSwgd2UgZGVmaW5lIGEgInNsb3QiIGZvcgoJICogZWFjaCBpdGVtICgxIGl0ZW0gaW4gMTAgd291bGQgZ2V0IDEwJSksIGFuZCB0aGVuIGFwcGVuZCBsb2FkZWQgcHJvZ3Jlc3Mgb24gdG9wIG9mIHRoZSBhbHJlYWR5LWxvYWRlZCBpdGVtcy4KCSAqCgkgKiBGb3IgZXhhbXBsZSwgaWYgNS8xMCBpdGVtcyBoYXZlIGxvYWRlZCwgYW5kIGl0ZW0gNiBpcyAyMCUgbG9hZGVkLCB0aGUgdG90YWwgcHJvZ3Jlc3Mgd291bGQgYmU6PHVsPgoJICogICAgICA8bGk+NS8xMCBvZiB0aGUgaXRlbXMgaW4gdGhlIHF1ZXVlICg1MCUpPC9saT4KCSAqICAgICAgPGxpPnBsdXMgMjAlIG9mIGl0ZW0gNidzIHNsb3QgKDIlKTwvbGk+CgkgKiAgICAgIDxsaT5lcXVhbHMgNTIlPC9saT48L3VsPgoJICogQG1ldGhvZCBfdXBkYXRlUHJvZ3Jlc3MKCSAqIEBwcml2YXRlCgkgKi8KCXAuX3VwZGF0ZVByb2dyZXNzID0gZnVuY3Rpb24gKCkgewoJCXZhciBsb2FkZWQgPSB0aGlzLl9udW1JdGVtc0xvYWRlZCAvIHRoaXMuX251bUl0ZW1zOyAvLyBGdWxseSBMb2FkZWQgUHJvZ3Jlc3MKCQl2YXIgcmVtYWluaW5nID0gdGhpcy5fbnVtSXRlbXMtdGhpcy5fbnVtSXRlbXNMb2FkZWQ7CgkJaWYgKHJlbWFpbmluZyA+IDApIHsKCQkJdmFyIGNodW5rID0gMDsKCQkJZm9yICh2YXIgaT0wLCBsPXRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCQljaHVuayArPSB0aGlzLl9jdXJyZW50TG9hZHNbaV0ucHJvZ3Jlc3M7CgkJCX0KCQkJbG9hZGVkICs9IChjaHVuayAvIHJlbWFpbmluZykgKiAocmVtYWluaW5nL3RoaXMuX251bUl0ZW1zKTsKCQl9CgkJdGhpcy5fc2VuZFByb2dyZXNzKGxvYWRlZCk7Cgl9OwoKCS8qKgoJICogQ2xlYW4gb3V0IGl0ZW0gcmVzdWx0cywgdG8gZnJlZSB0aGVtIGZyb20gbWVtb3J5LiBNYWlubHksIHRoZSBsb2FkZWQgaXRlbSBhbmQgcmVzdWx0cyBhcmUgY2xlYXJlZCBmcm9tIGludGVybmFsCgkgKiBoYXNoZXMuCgkgKiBAbWV0aG9kIF9kaXNwb3NlSXRlbQoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdGhhdCB3YXMgcGFzc2VkIGluIGZvciBwcmVsb2FkaW5nLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZGlzcG9zZUl0ZW0gPSBmdW5jdGlvbihpdGVtKSB7CgkJZGVsZXRlIHRoaXMuX2xvYWRlZFJlc3VsdHNbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRlZFJhd1Jlc3VsdHNbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRJdGVtc0J5SWRbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRJdGVtc0J5U3JjW2l0ZW0uc3JjXTsKCX07CgoKCS8qKgoJICogQ3JlYXRlIGFuIEhUTUwgdGFnLiBUaGlzIGlzIGluIExvYWRRdWV1ZSBpbnN0ZWFkIG9mIHt7I2Nyb3NzTGluayAiVGFnTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0gYmVjYXVzZSBubyBtYXR0ZXIKCSAqIGhvdyB3ZSBsb2FkIHRoZSBkYXRhLCB3ZSBtYXkgbmVlZCB0byByZXR1cm4gaXQgaW4gYSB0YWcuCgkgKiBAbWV0aG9kIF9jcmVhdGVUYWcKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuIEl0ZW1zIGFyZSBwYXNzZWQgaW4gYnkgdGhlIGRldmVsb3Blciwgb3IgZGV0ZXJlbWluZWQgYnkgdGhlIGV4dGVuc2lvbi4KCSAqIEByZXR1cm4ge0hUTUxJbWFnZUVsZW1lbnR8SFRNTEF1ZGlvRWxlbWVudHxIVE1MU2NyaXB0RWxlbWVudHxIVE1MTGlua0VsZW1lbnR8T2JqZWN0fSBUaGUgdGFnIHRoYXQgaXMgY3JlYXRlZC4KCSAqIE5vdGUgdGhhdCB0YWdzIGFyZSBub3QgYXBwZW5kZWQgdG8gdGhlIEhUTUwgYm9keS4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NyZWF0ZVRhZyA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFnID0gbnVsbDsKCQlzd2l0Y2ggKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5JTUFHRToKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwoJCQkJaWYgKHRoaXMuX2Nyb3NzT3JpZ2luICE9ICIiICYmICF0aGlzLl9pc0xvY2FsKGl0ZW0pKSB7IHRhZy5jcm9zc09yaWdpbiA9IHRoaXMuX2Nyb3NzT3JpZ2luOyB9CgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TT1VORDoKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImF1ZGlvIik7CgkJCQl0YWcuYXV0b3BsYXkgPSBmYWxzZTsKCQkJCS8vIE5vdGU6IFRoZSB0eXBlIHByb3BlcnR5IGRvZXNuJ3Qgc2VlbSBuZWNlc3NhcnkuCgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1Q6CgkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJCXRhZy50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQlpZiAodGhpcy51c2VYSFIpIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaW5rIik7CgkJCQl9CgkJCQl0YWcucmVsICA9ICJzdHlsZXNoZWV0IjsKCQkJCXRhZy50eXBlID0gInRleHQvY3NzIjsKCQkJCXJldHVybiB0YWc7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJCWlmICh0aGlzLnVzZVhIUikgewoJCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN2ZyIpOwoJCQkJfSBlbHNlIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvYmplY3QiKTsKCQkJCQl0YWcudHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKCQkJCX0KCQkJCXJldHVybiB0YWc7CgkJfQoJCXJldHVybiBudWxsOwoJfTsKCgkvKioKCSAqIERldGVybWluZSB0aGUgdHlwZSBvZiB0aGUgb2JqZWN0IHVzaW5nIGNvbW1vbiBleHRlbnNpb25zLiBOb3RlIHRoYXQgdGhlIHR5cGUgY2FuIGJlIHBhc3NlZCBpbiB3aXRoIHRoZSBsb2FkIGl0ZW0KCSAqIGlmIGl0IGlzIGFuIHVudXN1YWwgZXh0ZW5zaW9uLgoJICogQHBhcmFtIHtTdHJpbmd9IGV4dGVuc2lvbiBUaGUgZmlsZSBleHRlbnNpb24gdG8gdXNlIHRvIGRldGVybWluZSB0aGUgbG9hZCB0eXBlLgoJICogQHJldHVybiB7U3RyaW5nfSBUaGUgZGV0ZXJtaW5lZCBsb2FkIHR5cGUgKGZvciBleGFtcGxlLCA8Y29kZT5Mb2FkUXVldWUuSU1BR0U8L2NvZGU+IG9yIG51bGwgaWYgaXQgY2FuIG5vdCBiZQoJICogZGV0ZXJtaW5lZCBieSB0aGUgZXh0ZW5zaW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZ2V0VHlwZUJ5RXh0ZW5zaW9uID0gZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CgkJaWYgKGV4dGVuc2lvbiA9PSBudWxsKSB7CgkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDsKCQl9CgkJc3dpdGNoIChleHRlbnNpb24udG9Mb3dlckNhc2UoKSkgewoJCQljYXNlICJqcGVnIjoKCQkJY2FzZSAianBnIjoKCQkJY2FzZSAiZ2lmIjoKCQkJY2FzZSAicG5nIjoKCQkJY2FzZSAid2VicCI6CgkJCWNhc2UgImJtcCI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLklNQUdFOwoJCQljYXNlICJvZ2ciOgoJCQljYXNlICJtcDMiOgoJCQljYXNlICJ3YXYiOgoJCQkJcmV0dXJuIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TT1VORDsKCQkJY2FzZSAianNvbiI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLkpTT047CgkJCWNhc2UgInhtbCI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDsKCQkJY2FzZSAiY3NzIjoKCQkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTOwoJCQljYXNlICJqcyI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLkpBVkFTQ1JJUFQ7CgkJCWNhc2UgJ3N2Zyc6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDsKCQl9Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlcHJvZ3Jlc3MgZXZlbnQgKGFuZCBvbkZpbGVQcm9ncmVzcyBjYWxsYmFjaykuIFBsZWFzZSBzZWUgdGhlIDxjb2RlPkxvYWRRdWV1ZS5maWxlcHJvZ3Jlc3M8L2NvZGU+CgkgKiBldmVudCBmb3IgZGV0YWlscyBvbiB0aGUgZXZlbnQgcGF5bG9hZC4KCSAqIEBtZXRob2QgX3NlbmRGaWxlUHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBpdGVtIHRoYXQgaXMgYmVpbmcgbG9hZGVkLgoJICogQHBhcmFtIHtOdW1iZXJ9IHByb2dyZXNzIFRoZSBhbW91bnQgdGhlIGl0ZW0gaGFzIGJlZW4gbG9hZGVkIChiZXR3ZWVuIDAgYW5kIDEpLgoJICogQHByb3RlY3RlZAoJICovCglwLl9zZW5kRmlsZVByb2dyZXNzID0gZnVuY3Rpb24oaXRlbSwgcHJvZ3Jlc3MpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7CgkJCXRoaXMuX2NsZWFuVXAoKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIXRoaXMuaGFzRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIikpIHsgcmV0dXJuOyB9CgoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZmlsZXByb2dyZXNzIik7CgkJZXZlbnQucHJvZ3Jlc3MgPSBwcm9ncmVzczsKCQlldmVudC5sb2FkZWQgPSBwcm9ncmVzczsKCQlldmVudC50b3RhbCA9IDE7CgkJZXZlbnQuaXRlbSA9IGl0ZW07CgoJCXRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlbG9hZCBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudCBmb3IKCSAqIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kRmlsZUNvbXBsZXRlCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBUaGUgaXRlbSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4KCSAqIEBwYXJhbSB7VGFnTG9hZGVyIHwgWEhSTG9hZGVyfSBsb2FkZXIKCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZEZpbGVDb21wbGV0ZSA9IGZ1bmN0aW9uKGl0ZW0sIGxvYWRlcikgewoJCWlmICh0aGlzLl9pc0NhbmNlbGVkKCkpIHsgcmV0dXJuOyB9CgoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZmlsZWxvYWQiKTsKCQlldmVudC5sb2FkZXIgPSBsb2FkZXI7CgkJZXZlbnQuaXRlbSA9IGl0ZW07CgkJZXZlbnQucmVzdWx0ID0gdGhpcy5fbG9hZGVkUmVzdWx0c1tpdGVtLmlkXTsKCQlldmVudC5yYXdSZXN1bHQgPSB0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2l0ZW0uaWRdOwoKICAgICAgICAvLyBUaGlzIGNhbGxzIGEgaGFuZGxlciBzcGVjaWZpZWQgb24gdGhlIGFjdHVhbCBsb2FkIGl0ZW0uIEN1cnJlbnRseSwgdGhlIFNvdW5kSlMgcGx1Z2luIHVzZXMgdGhpcy4KICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZUhhbmRsZXIpIHsKICAgICAgICAgICAgaXRlbS5jb21wbGV0ZUhhbmRsZXIoZXZlbnQpOwogICAgICAgIH0KCgkJdGhpcy5oYXNFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIpICYmIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlc3RhcnQgZXZlbnQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgZmlsZSBzdGFydHMgdG8gbG9hZC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZXN0YXJ0OmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50IGZvciBkZXRhaWxzIG9uIHRoZSBldmVudCBwYXlsb2FkLgoJICogQG1ldGhvZCBfc2VuZEZpbGVTdGFydAoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdGhhdCBpcyBiZWluZyBsb2FkZWQuCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3NlbmRGaWxlU3RhcnQgPSBmdW5jdGlvbihpdGVtKSB7CgkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJmaWxlc3RhcnQiKTsKCQlldmVudC5pdGVtID0gaXRlbTsKCQl0aGlzLmhhc0V2ZW50TGlzdGVuZXIoImZpbGVzdGFydCIpICYmIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogUkVNT1ZFRC4gIFVzZSBjcmVhdGVqcy5wcm94eSBpbnN0ZWFkCgkgKiBAbWV0aG9kIHByb3h5CgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGZ1bmN0aW9uIHRvIGNhbGwKCSAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBUaGUgc2NvcGUgdG8gY2FsbCB0aGUgbWV0aG9kIG5hbWUgb24KCSAqIEBzdGF0aWMKCSAqIEBwcml2YXRlCgkgKiBAZGVwcmVjYXRlZCBJbiBmYXZvdXIgb2YgdGhlIGNyZWF0ZWpzLnByb3h5IG1ldGhvZCAoc2VlIExvYWRRdWV1ZSBzb3VyY2UpLgoJICovCgoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBMb2FkUXVldWVdIjsKCX07CgoJY3JlYXRlanMuTG9hZFF1ZXVlID0gTG9hZFF1ZXVlOwoKCi8vIEhlbHBlciBtZXRob2RzCgoJLy8gQW4gYWRkaXRpb25hbCBtb2R1bGUgdG8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJyb3dzZXIsIHZlcnNpb24sIG9wZXJhdGluZyBzeXN0ZW0sIGFuZCBvdGhlciBlbnZpcm9ubWVudGFsIHZhcmlhYmxlcy4KCXZhciBCcm93c2VyRGV0ZWN0ID0gZnVuY3Rpb24oKSB7fQoKCUJyb3dzZXJEZXRlY3QuaW5pdCA9IGZ1bmN0aW9uKCkgewoJCXZhciBhZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CgkJQnJvd3NlckRldGVjdC5pc0ZpcmVmb3ggPSAoYWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpOwoJCUJyb3dzZXJEZXRlY3QuaXNPcGVyYSA9ICh3aW5kb3cub3BlcmEgIT0gbnVsbCk7CgkJQnJvd3NlckRldGVjdC5pc0Nocm9tZSA9IChhZ2VudC5pbmRleE9mKCJDaHJvbWUiKSA+IC0xKTsKCQlCcm93c2VyRGV0ZWN0LmlzSU9TID0gYWdlbnQuaW5kZXhPZigiaVBvZCIpID4gLTEgfHwgYWdlbnQuaW5kZXhPZigiaVBob25lIikgPiAtMSB8fCBhZ2VudC5pbmRleE9mKCJpUGFkIikgPiAtMTsKCX07CgoJQnJvd3NlckRldGVjdC5pbml0KCk7CgoJY3JlYXRlanMuTG9hZFF1ZXVlLkJyb3dzZXJEZXRlY3QgPSBCcm93c2VyRGV0ZWN0OwoKfSgpKTsKLyoKKiBUYWdMb2FkZXIKKiBWaXNpdCBodHRwOi8vY3JlYXRlanMuY29tLyBmb3IgZG9jdW1lbnRhdGlvbiwgdXBkYXRlcyBhbmQgZXhhbXBsZXMuCioKKgoqIENvcHlyaWdodCAoYykgMjAxMiBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgovKioKICogQG1vZHVsZSBQcmVsb2FkSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzfHx7fTsKCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCS8qKgoJICogQSBwcmVsb2FkZXIgdGhhdCBsb2FkcyBpdGVtcyB1c2luZyBhIHRhZy1iYXNlZCBhcHByb2FjaC4gSFRNTCBhdWRpbyBhbmQgaW1hZ2VzIGNhbiB1c2UgdGhpcyBsb2FkZXIgdG8gbG9hZAoJICogY29udGVudCBjcm9zcy1kb21haW4gd2l0aG91dCBzZWN1cml0eSBlcnJvcnMsIHdoZXJlYXMgYW55dGhpbmcgbG9hZGVkIHdpdGggWEhSIGhhcyBwb3RlbnRpYWwgaXNzdWVzIHdpdGggY3Jvc3MtCgkgKiBkb21haW4gcmVxdWVzdHMuCgkgKgoJICogTm90ZSBmb3IgYXVkaW8gdGFncywgVGFnTG9hZGVyIHJlbGllcyBvbiB0aGUgPGNvZGU+Y2FuUGxheVRocm91Z2g8L2NvZGU+IGV2ZW50LCB3aGljaCBmaXJlcyB3aGVuIHRoZSBidWZmZXIKCSAqIGlzIGZ1bGwgZW5vdWdoIHRvIHBsYXkgdGhlIGF1ZGlvIGFsbCB0aGUgd2F5IHRocm91Z2ggYXQgdGhlIGN1cnJlbnQgZG93bmxvYWQgc3BlZWQuIFRoaXMgY29tcGxldGVseSBwcmVsb2FkcyBtb3N0CgkgKiBzb3VuZCBlZmZlY3RzLCBob3dldmVyIGxvbmdlciB0cmFja3MgbGlrZSBiYWNrZ3JvdW5kIGF1ZGlvIHdpbGwgb25seSBsb2FkIGEgcG9ydGlvbiBiZWZvcmUgdGhlIGV2ZW50IGlzIGZpcmVkLgoJICogTW9zdCBicm93c2VycyAoYWxsIGV4Y2x1ZGluZyBDaHJvbWUpIHdpbGwgY29udGludWUgdG8gcHJlbG9hZCBvbmNlIHRoaXMgaXMgZmlyZWQsIHNvIHRoaXMgaXMgY29uc2lkZXJlZCBnb29kCgkgKiBlbm91Z2ggZm9yIG1vc3QgY2FzZXMuCgkgKiBAY2xhc3MgVGFnTG9hZGVyCgkgKiBAY29uc3RydWN0b3IKCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBUaGUgaXRlbSB0byBsb2FkLiBQbGVhc2Ugc2VlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gZm9yCgkgKiBpbmZvcm1hdGlvbiBvbiBsb2FkIGl0ZW1zLgoJICovCgl2YXIgVGFnTG9hZGVyID0gZnVuY3Rpb24gKGl0ZW0pIHsKCQl0aGlzLmluaXQoaXRlbSk7Cgl9OwoKCXZhciBwID0gVGFnTG9hZGVyLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5BYnN0cmFjdExvYWRlcigpOwoJVGFnTG9hZGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhZ0xvYWRlcjsKCi8vIFByb3RlY3RlZAoKCS8qKgoJICogVGhlIHRpbWVvdXQgdGhhdCBpcyBmaXJlZCBpZiBub3RoaW5nIGlzIGxvYWRlZCBhZnRlciBhIGNlcnRhaW4gZGVsYXkuIFNlZSB0aGUgPGNvZGU+TG9hZFF1ZXVlLkxPQURfVElNRU9VVDwvY29kZT4KCSAqIGZvciB0aGUgdGltZW91dCBkdXJhdGlvbi4KCSAqIEBwcm9wZXJ0eSBfbG9hZFRpbWVvdXQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkVGltZW91dCA9IG51bGw7CgoJLyoqCgkgKiBBIHJlZmVyZW5jZSB0byBhIGJvdW5kIGZ1bmN0aW9uLCB3aGljaCB3ZSBuZWVkIGluIG9yZGVyIHRvIHByb3Blcmx5IHJlbW92ZSB0aGUgZXZlbnQgaGFuZGxlciB3aGVuIHRoZSBsb2FkCgkgKiBjb21wbGV0ZXMuCgkgKiBAcHJvcGVydHkgX3RhZ0NvbXBsZXRlUHJveHkKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3RhZ0NvbXBsZXRlUHJveHkgPSBudWxsOwoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiB0aGUgbG9hZCBpdGVtIGlzIGFuIGF1ZGlvIHRhZywgc2luY2Ugd2UgdGFrZSBzb21lIHNwZWNpZmljIGFwcHJvYWNoZXMgdG8gcHJvcGVybHkgbG9hZCBhdWRpby4KCSAqIEBwcm9wZXJ0eSBfaXNBdWRpbwoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHByb3RlY3RlZAoJICovCglwLl9pc0F1ZGlvID0gZmFsc2U7CgoJLyoqCgkgKiBUaGUgSFRNTCB0YWcgb3IgSmF2YVNjcmlwdCBvYmplY3QgdGhpcyBsb2FkZXIgdXNlcyB0byBwcmVsb2FkIGNvbnRlbnQuIE5vdGUgdGhhdCBhIHRhZyBtYXkgYmUgYSBjdXN0b20gb2JqZWN0CgkgKiB0aGF0IG1hdGNoZXMgdGhlIEFQSSBvZiBhbiBIVE1MIHRhZyAobG9hZCBtZXRob2QsIG9ubG9hZCBjYWxsYmFjaykuIEZvciBleGFtcGxlLCBmbGFzaCBhdWRpbyBmcm9tIFNvdW5kSlMgcGFzc2VzCgkgKiBpbiBhIGN1c3RvbSBvYmplY3QgdG8gaGFuZGxlIHByZWxvYWRpbmcgZm9yIEZsYXNoIGF1ZGlvIGFuZCBXZWJBdWRpby4KCSAqIEBwcm9wZXJ0eSBfdGFnCgkgKiBAdHlwZSB7SFRNTEF1ZGlvRWxlbWVudCB8IE9iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3RhZyA9IG51bGw7CgoJLyoqCgkgKiBXaGVuIGxvYWRpbmcgYSBKU09OUCByZXF1ZXN0IHRoaXMgd2lsbCBiZSB0aGUgcGFyc2VkIEpTT04gcmVzdWx0LgoJICoKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9qc29uUmVzdWx0ID0gbnVsbDsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbiAoaXRlbSkgewoJCXRoaXMuX2l0ZW0gPSBpdGVtOwoJCXRoaXMuX3RhZyA9IGl0ZW0udGFnOwoJCXRoaXMuX2lzQXVkaW8gPSAod2luZG93LkhUTUxBdWRpb0VsZW1lbnQgJiYgaXRlbS50YWcgaW5zdGFuY2VvZiB3aW5kb3cuSFRNTEF1ZGlvRWxlbWVudCk7CgkJdGhpcy5fdGFnQ29tcGxldGVQcm94eSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsIHRoaXMpOwoJfTsKCgkvKioKCSAqIEdldCB0aGUgbG9hZGVkIGNvbnRlbnQuIFRoaXMgaXMgdXN1YWxseSBhbiBIVE1MIHRhZyBvciBvdGhlciB0YWctc3R5bGUgb2JqZWN0IHRoYXQgaGFzIGJlZW4gZnVsbHkgbG9hZGVkLiBJZiB0aGUKCSAqIGxvYWRlciBpcyBub3QgY29tcGxldGUsIHRoaXMgd2lsbCBiZSBudWxsLgoJICogQG1ldGhvZCBnZXRSZXN1bHQKCSAqIEByZXR1cm4ge0hUTUxJbWFnZUVsZW1lbnQgfCBIVE1MQXVkaW9FbGVtZW50IHwgT2JqZWN0fSBUaGUgbG9hZGVkIGFuZCBwYXJzZWQgY29udGVudC4KCSAqLwoJcC5nZXRSZXN1bHQgPSBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5faXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUCB8fCB0aGlzLl9pdGVtLnR5cGUgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUKSB7CgkJCXJldHVybiB0aGlzLl9qc29uUmVzdWx0OwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLl90YWc7CgkJfQoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuY2FuY2VsZWQgPSB0cnVlOwoJCXRoaXMuX2NsZWFuKCk7Cgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtID0gdGhpcy5faXRlbTsKCQl2YXIgdGFnID0gdGhpcy5fdGFnOwoKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOyAvLyBDbGVhciBvdXQgYW55IGV4aXN0aW5nIHRpbWVvdXQKCQl2YXIgZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUuTE9BRF9USU1FT1VUOwoJCWlmIChkdXJhdGlvbiA9PSAwKSB7IGR1cmF0aW9uID0gY3JlYXRlanMuTG9hZFF1ZXVlLmxvYWRUaW1lb3V0OyB9CgkJdGhpcy5fbG9hZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRpbWVvdXQsIHRoaXMpLCBkdXJhdGlvbik7CgoJCWlmICh0aGlzLl9pc0F1ZGlvKSB7CgkJCXRhZy5zcmMgPSBudWxsOyAvLyBVbnNldCB0aGUgc291cmNlIHNvIHdlIGNhbiBzZXQgdGhlIHByZWxvYWQgdHlwZSB0byAiYXV0byIgd2l0aG91dCBraWNraW5nIG9mZiBhIGxvYWQuIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgZm9yIGF1ZGlvIHRhZ3MgcGFzc2VkIGluIGJ5IHRoZSBkZXZlbG9wZXIuCgkJCXRhZy5wcmVsb2FkID0gImF1dG8iOwoJCX0KCgkJLy8gSGFuZGxlcnMgZm9yIGFsbCB0YWdzCgkJdGFnLm9uZXJyb3IgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVFcnJvciwgIHRoaXMpOwoJCS8vIE5vdGU6IFdlIG9ubHkgZ2V0IHByb2dyZXNzIGV2ZW50cyBpbiBDaHJvbWUsIGJ1dCBkbyBub3QgZnVsbHkgbG9hZCB0YWdzIGluIENocm9tZSBkdWUgdG8gaXRzIGJlaGF2aW91ciwgc28gd2UgaWdub3JlIHByb2dyZXNzLgoKCQlpZiAodGhpcy5faXNBdWRpbykgewoJCQl0YWcub25zdGFsbGVkID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlU3RhbGxlZCwgIHRoaXMpOwoJCQkvLyBUaGlzIHdpbGwgdGVsbCB1cyB3aGVuIGF1ZGlvIGlzIGJ1ZmZlcmVkIGVub3VnaCB0byBwbGF5IHRocm91Z2gsIGJ1dCBub3Qgd2hlbiBpdHMgbG9hZGVkLgoJCQkvLyBUaGUgdGFnIGRvZXNuJ3Qga2VlcCBsb2FkaW5nIGluIENocm9tZSBvbmNlIGVub3VnaCBoYXMgYnVmZmVyZWQsIGFuZCB3ZSBoYXZlIGRlY2lkZWQgdGhhdCBiZWhhdmlvdXIgaXMgc3VmZmljaWVudC4KCQkJdGFnLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXl0aHJvdWdoIiwgdGhpcy5fdGFnQ29tcGxldGVQcm94eSwgZmFsc2UpOyAvLyBjYW5wbGF5dGhyb3VnaCBjYWxsYmFjayBkb2Vzbid0IHdvcmsgaW4gQ2hyb21lLCBzbyB3ZSB1c2UgYW4gZXZlbnQuCgkJfSBlbHNlIHsKCQkJdGFnLm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsICB0aGlzKTsKCQkJdGFnLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UsICB0aGlzKTsKCQl9CgoJCXZhciBzcmMgPSB0aGlzLmJ1aWxkUGF0aChpdGVtLnNyYywgaXRlbS52YWx1ZXMpOwoKCQkvLyBTZXQgdGhlIHNyYyBhZnRlciB0aGUgZXZlbnRzIGFyZSBhbGwgYWRkZWQuCgkJc3dpdGNoKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQl0YWcuaHJlZiA9IHNyYzsKCQkJCWJyZWFrOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkc6CgkJCQl0YWcuZGF0YSA9IHNyYzsKCQkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJdGFnLnNyYyA9IHNyYzsKCQl9CgoJCS8vIElmIHdlJ3JlIGxvYWRpbmcgSlNPTlAsIHdlIG5lZWQgdG8gYWRkIG91ciBjYWxsYmFjayBub3cuCgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAKCQkJCXx8IGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTgoJCQkJfHwgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQlpZiAoaXRlbS5jYWxsYmFjayA9PSBudWxsKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ2NhbGxiYWNrIGlzIHJlcXVpcmVkIGZvciBsb2FkaW5nIEpTT05QIHJlcXVlc3RzLicpOwoJCQl9CgoJCQlpZiAod2luZG93W2l0ZW0uY2FsbGJhY2tdICE9IG51bGwpIHsKCQkJCXRocm93IG5ldyBFcnJvcignSlNPTlAgY2FsbGJhY2sgIicgKyBpdGVtLmNhbGxiYWNrICsgJyIgYWxyZWFkeSBleGlzdHMgb24gd2luZG93LiBZb3UgbmVlZCB0byBzcGVjaWZ5IGEgZGlmZmVyZW50IGNhbGxiYWNrLiBPciByZS1uYW1lIHRoZSBjdXJyZW50IG9uZS4nKTsKCQkJfQoKCQkJd2luZG93W2l0ZW0uY2FsbGJhY2tdID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlSlNPTlBMb2FkLCB0aGlzKTsKCQl9CgoJCS8vIElmIGl0cyBTVkcsIGl0IG5lZWRzIHRvIGJlIG9uIHRoZSBET00gdG8gbG9hZCAod2UgcmVtb3ZlIGl0IGJlZm9yZSBzZW5kaW5nIGNvbXBsZXRlKS4KCQkvLyBJdCBpcyBpbXBvcnRhbnQgdGhhdCB0aGlzIGhhcHBlbnMgQUZURVIgc2V0dGluZyB0aGUgc3JjL2RhdGEuCgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuU1ZHIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAgfHwKCQkJaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1QgfHwKCQkJaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTKSB7CgkJCQl0aGlzLl9zdGFydFRhZ1Zpc2liaWxpdHkgPSB0YWcuc3R5bGUudmlzaWJpbGl0eTsKCQkJCXRhZy5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CgkJCQl2YXIgbm9kZSA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCQkJCWlmIChub2RlID09IG51bGwpIHsKCQkJCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkcpIHsKCQkJCQkJdGhpcy5faGFuZGxlU1ZHRXJyb3IoKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW5vZGUgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIik7CgkJCQkJfQoJCQkJfQoJCQkJbm9kZS5hcHBlbmRDaGlsZCh0YWcpOwoJCX0KCgkJLy8gTm90ZTogUHJldmlvdXMgdmVyc2lvbnMgZGlkbid0IHNlZW0gdG8gd29yayB3aGVuIHdlIGNhbGxlZCBsb2FkKCkgZm9yIE9HRyB0YWdzIGluIEZpcmVmb3guIFNlZW1zIGZpeGVkIGluIDE1LjAuMQoJCWlmICh0YWcubG9hZCAhPSBudWxsKSB7CgkJCXRhZy5sb2FkKCk7CgkJfQoJfTsKCglwLl9oYW5kbGVTVkdFcnJvciA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2NsZWFuKCk7CgkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCWV2ZW50LnRleHQgPSAiU1ZHX05PX0JPRFkiOwoJCXRoaXMuX3NlbmRFcnJvcihldmVudCk7Cgl9OwoKCXAuX2hhbmRsZUpTT05QTG9hZCA9IGZ1bmN0aW9uKGRhdGEpIHsKCQl0aGlzLl9qc29uUmVzdWx0ID0gZGF0YTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgYW4gYXVkaW8gdGltZW91dC4gTmV3ZXIgYnJvd3NlcnMgZ2V0IGEgY2FsbGJhY2sgZnJvbSB0aGUgdGFncywgYnV0IG9sZGVyIG9uZXMgbWF5IHJlcXVpcmUgYSBzZXRUaW1lb3V0CgkgKiB0byBoYW5kbGUgaXQuIFRoZSBzZXRUaW1lb3V0IGlzIGFsd2F5cyBydW5uaW5nIHVudGlsIGEgcmVzcG9uc2UgaXMgaGFuZGxlZCBieSB0aGUgYnJvd3Nlci4KCSAqIEBtZXRob2QgX2hhbmRsZVRpbWVvdXQKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVRpbWVvdXQgPSBmdW5jdGlvbigpIHsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQlldmVudC50ZXh0ID0gIlBSRUxPQURfVElNRU9VVCI7CgkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgYSBzdGFsbGVkIGF1ZGlvIGV2ZW50LiBUaGUgbWFpbiBwbGFjZSB3ZSBzZWVtIHRvIGdldCB0aGVzZSBpcyB3aXRoIEhUTUxBdWRpbyBpbiBDaHJvbWUgd2hlbiB3ZSB0cnkgYW5kCgkgKiBwbGF5YmFjayBhdWRpbyB0aGF0IGlzIGFscmVhZHkgaW4gYSBsb2FkLCBidXQgbm90IGNvbXBsZXRlLgoJICogQG1ldGhvZCBfaGFuZGxlU3RhbGxlZAoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlU3RhbGxlZCA9IGZ1bmN0aW9uKCkgewoJCS8vSWdub3JlLCBsZXQgdGhlIHRpbWVvdXQgdGFrZSBjYXJlIG9mIGl0LiBTb21ldGltZXMgaXRzIG5vdCByZWFsbHkgc3RvcHBlZC4KCX07CgoJLyoqCgkgKiBIYW5kbGUgYW4gZXJyb3IgZXZlbnQgZ2VuZXJhdGVkIGJ5IHRoZSB0YWcuCgkgKiBAbWV0aG9kIF9oYW5kbGVFcnJvcgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewoJCXRoaXMuX2NsZWFuKCk7CgoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkvL1RPRE86IFByb3BhZ2F0ZSBhY3R1YWwgZXZlbnQgZXJyb3I/CgkJdGhpcy5fc2VuZEVycm9yKG5ld0V2ZW50KTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgdGhlIHJlYWR5U3RhdGVDaGFuZ2UgZXZlbnQgZnJvbSBhIHRhZy4gV2Ugc29tZXRpbWVzIG5lZWQgdGhpcyBpbiBwbGFjZSBvZiB0aGUgb25sb2FkIGV2ZW50IChtYWlubHkgU0NSSVBUCgkgKiBhbmQgTElOSyB0YWdzKSwgYnV0IG90aGVyIGNhc2VzIG1heSBleGlzdC4KCSAqIEBtZXRob2QgX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoJCS8vIFRoaXMgaXMgc3RyaWN0bHkgZm9yIHRhZ3MgaW4gYnJvd3NlcnMgdGhhdCBkbyBub3Qgc3VwcG9ydCBvbmxvYWQuCgkJdmFyIHRhZyA9IHRoaXMuZ2V0SXRlbSgpLnRhZzsKCgkJLy8gQ29tcGxldGUgaXMgZm9yIG9sZCBJRSBzdXBwb3J0LgoJCWlmICh0YWcucmVhZHlTdGF0ZSA9PSAibG9hZGVkIiB8fCB0YWcucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSB7CgkJCXRoaXMuX2hhbmRsZUxvYWQoKTsKCQl9Cgl9OwoKCS8qKgoJICogSGFuZGxlIGEgbG9hZCAoY29tcGxldGUpIGV2ZW50LiBUaGlzIGlzIGNhbGxlZCBieSB0YWcgY2FsbGJhY2tzLCBidXQgYWxzbyBieSByZWFkeVN0YXRlQ2hhbmdlIGFuZCBjYW5QbGF5VGhyb3VnaAoJICogZXZlbnRzLiBPbmNlIGxvYWRlZCwgdGhlIGl0ZW0gaXMgZGlzcGF0Y2hlZCB0byB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUifX17ey9jcm9zc0xpbmt9fS4KCSAqIEBtZXRob2QgX2hhbmRsZUxvYWQKCSAqIEBwYXJhbSB7T2JqZWN0fSBbZXZlbnRdIEEgbG9hZCBldmVudCBmcm9tIGEgdGFnLiBUaGlzIGlzIHNvbWV0aW1lcyBjYWxsZWQgZnJvbSBvdGhlciBoYW5kbGVycyB3aXRob3V0IGFuIGV2ZW50LgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlTG9hZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJaWYgKHRoaXMuX2lzQ2FuY2VsZWQoKSkgeyByZXR1cm47IH0KCgkJdmFyIGl0ZW0gPSB0aGlzLmdldEl0ZW0oKTsKCQl2YXIgdGFnID0gaXRlbS50YWc7CgoJCWlmICh0aGlzLmxvYWRlZCB8fCB0aGlzLl9pc0F1ZGlvICYmIHRhZy5yZWFkeVN0YXRlICE9PSA0KSB7IHJldHVybjsgfSAvL0xNOiBOb3Qgc3VyZSBpZiB3ZSBzdGlsbCBuZWVkIHRoZSBhdWRpbyBjaGVjay4KCQl0aGlzLmxvYWRlZCA9IHRydWU7CgoJCS8vIFJlbW92ZSBmcm9tIHRoZSBET00KCQlzd2l0Y2ggKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkc6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QOiAvLyBOb3RlOiBSZW1vdmluZyBzY3JpcHQgdGFncyBpcyBhIGZvb2wncyBlcnJhbmQuCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQkvLyBjYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQkvL0xNOiBXZSBtYXkgbmVlZCB0byByZW1vdmUgQ1NTIHRhZ3MgbG9hZGVkIHVzaW5nIGEgTElOSwoJCQkJdGFnLnN0eWxlLnZpc2liaWxpdHkgPSB0aGlzLl9zdGFydFRhZ1Zpc2liaWxpdHk7CgkJCQl0YWcucGFyZW50Tm9kZSAmJiB0YWcucGFyZW50Tm9kZS5jb250YWlucyh0YWcpICYmIHRhZy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhZyk7CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQl9CgoJCXRoaXMuX2NsZWFuKCk7CgkJdGhpcy5fc2VuZENvbXBsZXRlKCk7Cgl9OwoKCS8qKgoJICogQ2xlYW4gdXAgdGhlIGxvYWRlci4KCSAqIFRoaXMgc3RvcHMgYW55IHRpbWVycyBhbmQgcmVtb3ZlcyByZWZlcmVuY2VzIHRvIHByZXZlbnQgZXJyYW50IGNhbGxiYWNrcyBhbmQgY2xlYW4gdXAgbWVtb3J5LgoJICogQG1ldGhvZCBfY2xlYW4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NsZWFuID0gZnVuY3Rpb24oKSB7CgkJY2xlYXJUaW1lb3V0KHRoaXMuX2xvYWRUaW1lb3V0KTsKCgkJLy8gRGVsZXRlIGhhbmRsZXJzLgoJCXZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCk7CgkJdmFyIHRhZyA9IGl0ZW0udGFnOwoJCWlmICh0YWcgIT0gbnVsbCkgewoJCQl0YWcub25sb2FkID0gbnVsbDsKCQkJdGFnLnJlbW92ZUV2ZW50TGlzdGVuZXIgJiYgdGFnLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNhbnBsYXl0aHJvdWdoIiwgdGhpcy5fdGFnQ29tcGxldGVQcm94eSwgZmFsc2UpOwoJCQl0YWcub25zdGFsbGVkID0gbnVsbDsKCQkJdGFnLm9ucHJvZ3Jlc3MgPSBudWxsOwoJCQl0YWcub25lcnJvciA9IG51bGw7CgoJCQkvL1RPRE86IFRlc3QgdGhpcwoJCQlpZiAodGFnLnBhcmVudE5vZGUgIT0gbnVsbAoJCQkJCSYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuU1ZHCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVAoJCQkJCSYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUCkgewoJCQkJIC8vIE5vdGU6IFJlbW92aW5nIHNjcmlwdCB0YWdzIGlzIGEgZm9vbCdzIGVycmFuZC4KCQkJCXRhZy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhZyk7CgkJCX0KCQl9CgoJCXZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCk7CgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAKCQkJfHwgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQl3aW5kb3dbaXRlbS5jYWxsYmFja10gPSBudWxsOwoJCX0KCX07CgoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBUYWdMb2FkZXJdIjsKCX07CgoJY3JlYXRlanMuVGFnTG9hZGVyID0gVGFnTG9hZGVyOwoKfSgpKTsKLyoKICogWEhSTG9hZGVyCiAqIFZpc2l0IGh0dHA6Ly9jcmVhdGVqcy5jb20vIGZvciBkb2N1bWVudGF0aW9uLCB1cGRhdGVzIGFuZCBleGFtcGxlcy4KICoKICoKICogQ29weXJpZ2h0IChjKSAyMDEyIGdza2lubmVyLmNvbSwgaW5jLgogKgogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgogKiBvYnRhaW5pbmcgYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbgogKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiAqIHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAogKiBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKICogU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKICogY29uZGl0aW9uczoKICoKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKICogaW5jbHVkZWQgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAogKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKICogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKICogTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKICogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiAqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwogKiBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCiAqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICovCgovKioKICogQG1vZHVsZSBQcmVsb2FkSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzIHx8IHt9OwoKKGZ1bmN0aW9uICgpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEEgcHJlbG9hZGVyIHRoYXQgbG9hZHMgaXRlbXMgdXNpbmcgWEhSIHJlcXVlc3RzLCB1c3VhbGx5IFhNTEh0dHBSZXF1ZXN0LiBIb3dldmVyIFhEb21haW5SZXF1ZXN0cyB3aWxsIGJlIHVzZWQKCSAqIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgaWYgcG9zc2libGUsIGFuZCBvbGRlciB2ZXJzaW9ucyBvZiBJRSBmYWxsIGJhY2sgb24gdG8gQWN0aXZlWCBvYmplY3RzIHdoZW4gbmVjZXNzYXJ5LgoJICogWEhSIHJlcXVlc3RzIGxvYWQgdGhlIGNvbnRlbnQgYXMgdGV4dCBvciBiaW5hcnkgZGF0YSwgcHJvdmlkZSBwcm9ncmVzcyBhbmQgY29uc2lzdGVudCBjb21wbGV0aW9uIGV2ZW50cywgYW5kCgkgKiBjYW4gYmUgY2FuY2VsZWQgZHVyaW5nIGxvYWQuIE5vdGUgdGhhdCBYSFIgaXMgbm90IHN1cHBvcnRlZCBpbiBJRSA2IG9yIGVhcmxpZXIsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yCgkgKiBjcm9zcy1kb21haW4gbG9hZGluZy4KCSAqIEBjbGFzcyBYSFJMb2FkZXIKCSAqIEBjb25zdHJ1Y3RvcgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIG9iamVjdCB0aGF0IGRlZmluZXMgdGhlIGZpbGUgdG8gbG9hZC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogZm9yIGFuIG92ZXJ2aWV3IG9mIHN1cHBvcnRlZCBmaWxlIHByb3BlcnRpZXMuCgkgKiBAcGFyYW0ge1N0cmluZ30gW2Nyb3NzT3JpZ2luXSBBbiBvcHRpb25hbCBmbGFnIHRvIHN1cHBvcnQgaW1hZ2VzIGxvYWRlZCBmcm9tIGEgQ09SUy1lbmFibGVkIHNlcnZlci4gUGxlYXNlIHNlZQoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvX2Nyb3NzT3JpZ2luOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gZm9yIG1vcmUgaW5mby4KCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKi8KCXZhciBYSFJMb2FkZXIgPSBmdW5jdGlvbiAoaXRlbSwgY3Jvc3NPcmlnaW4pIHsKCQl0aGlzLmluaXQoaXRlbSwgY3Jvc3NPcmlnaW4pOwoJfTsKCgl2YXIgcyA9IFhIUkxvYWRlcjsKCgkvKioKCSAqIEEgbGlzdCBvZiBYTUxIVFRQIG9iamVjdCBJRHMgdG8gdHJ5IHdoZW4gYnVpbGRpbmcgYW4gQWN0aXZlWCBvYmplY3QgZm9yIFhIUiByZXF1ZXN0cyBpbiBlYXJsaWVyIHZlcnNpb25zIG9mIElFLgoJICogQHByb3BlcnR5IEFDVElWRVhfVkVSU0lPTlMKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBzaW5jZSAwLjQuMgoJICogQHByaXZhdGUKCSAqLwoJcy5BQ1RJVkVYX1ZFUlNJT05TID0gWwoJCSJNc3htbDIuWE1MSFRUUC42LjAiLAoJCSJNc3htbDIuWE1MSFRUUC41LjAiLAoJCSJNc3htbDIuWE1MSFRUUC40LjAiLAoJCSJNU1hNTDIuWE1MSFRUUC4zLjAiLAoJCSJNU1hNTDIuWE1MSFRUUCIsCgkJIk1pY3Jvc29mdC5YTUxIVFRQIgoJXTsKCgl2YXIgcCA9IFhIUkxvYWRlci5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQWJzdHJhY3RMb2FkZXIoKTsKCVhIUkxvYWRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBYSFJMb2FkZXI7CgoJLy9Qcm90ZWN0ZWQKCS8qKgoJICogQSByZWZlcmVuY2UgdG8gdGhlIFhIUiByZXF1ZXN0IHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCSAqIEBwcm9wZXJ0eSBfcmVxdWVzdAoJICogQHR5cGUge1hNTEh0dHBSZXF1ZXN0IHwgWERvbWFpblJlcXVlc3QgfCBBY3RpdmVYLlhNTEhUVFB9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9yZXF1ZXN0ID0gbnVsbDsKCgkvKioKCSAqIEEgbWFudWFsIGxvYWQgdGltZW91dCB0aGF0IGlzIHVzZWQgZm9yIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgdGhlIG9uVGltZW91dCBldmVudCBvbiBYSFIgKFhIUiBsZXZlbCAxLAoJICogdHlwaWNhbGx5IElFOSkuCgkgKiBAcHJvcGVydHkgX2xvYWRUaW1lb3V0CgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQHByaXZhdGUKCSAqLwoJcC5fbG9hZFRpbWVvdXQgPSBudWxsOwoKCS8qKgoJICogVGhlIGJyb3dzZXIncyBYSFIgKFhNTEhUVFBSZXF1ZXN0KSB2ZXJzaW9uLiBTdXBwb3J0ZWQgdmVyc2lvbnMgYXJlIDEgYW5kIDIuIFRoZXJlIGlzIG5vIG9mZmljaWFsIHdheSB0byBkZXRlY3QKCSAqIHRoZSB2ZXJzaW9uLCBzbyB3ZSB1c2UgY2FwYWJpbGl0aWVzIHRvIG1ha2UgYSBiZXN0IGd1ZXNzLgoJICogQHByb3BlcnR5IF94aHJMZXZlbAoJICogQHR5cGUge051bWJlcn0KCSAqIEBkZWZhdWx0IDEKCSAqIEBwcml2YXRlCgkgKi8KCXAuX3hockxldmVsID0gMTsKCgkvKioKCSAqIFRoZSByZXNwb25zZSBvZiBhIGxvYWRlZCBmaWxlLiBUaGlzIGlzIHNldCBiZWNhdXNlIGl0IGlzIGV4cGVuc2l2ZSB0byBsb29rIHVwIGNvbnN0YW50bHkuIFRoaXMgcHJvcGVydHkgd2lsbCBiZQoJICogbnVsbCB1bnRpbCB0aGUgZmlsZSBpcyBsb2FkZWQuCgkgKiBAcHJvcGVydHkgX3Jlc3BvbnNlCgkgKiBAdHlwZSB7bWl4ZWR9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9yZXNwb25zZSA9IG51bGw7CgoJLyoqCgkgKiBUaGUgcmVzcG9uc2Ugb2YgdGhlIGxvYWRlZCBmaWxlIGJlZm9yZSBpdCBpcyBtb2RpZmllZC4gSW4gbW9zdCBjYXNlcywgY29udGVudCBpcyBjb252ZXJ0ZWQgZnJvbSByYXcgdGV4dCB0bwoJICogYW4gSFRNTCB0YWcgb3IgYSBmb3JtYXR0ZWQgb2JqZWN0IHdoaWNoIGlzIHNldCB0byB0aGUgPGNvZGU+cmVzdWx0PC9jb2RlPiBwcm9wZXJ0eSwgYnV0IHRoZSBkZXZlbG9wZXIgbWF5IHN0aWxsCgkgKiB3YW50IHRvIGFjY2VzcyB0aGUgcmF3IGNvbnRlbnQgYXMgaXQgd2FzIGxvYWRlZC4KCSAqIEBwcm9wZXJ0eSBfcmF3UmVzcG9uc2UKCSAqIEB0eXBlIHtTdHJpbmd8T2JqZWN0fQoJICogQHByaXZhdGUKCSAqLwoJcC5fcmF3UmVzcG9uc2UgPSBudWxsOwoKCS8qKgoJICogU2VlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL19jcm9zc09yaWdpbjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiBAcHJvcGVydHkgX2Nyb3NzT3JpZ2luCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHRWYWx1ZSAiIgoJICogQHByaXZhdGUKCSAqLwoJcC5fY3Jvc3NPcmlnaW4gPSAiIjsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbiAoaXRlbSwgY3Jvc3NPcmlnaW4pIHsKCQl0aGlzLl9pdGVtID0gaXRlbTsKCQl0aGlzLl9jcm9zc09yaWdpbiA9IGNyb3NzT3JpZ2luOwoJCWlmICghdGhpcy5fY3JlYXRlWEhSKGl0ZW0pKSB7CgkJCS8vVE9ETzogVGhyb3cgZXJyb3I/CgkJfQoJfTsKCgkvKioKCSAqIExvb2sgdXAgdGhlIGxvYWRlZCByZXN1bHQuCgkgKiBAbWV0aG9kIGdldFJlc3VsdAoJICogQHBhcmFtIHtCb29sZWFufSBbcmF3UmVzdWx0PWZhbHNlXSBSZXR1cm4gYSByYXcgcmVzdWx0IGluc3RlYWQgb2YgYSBmb3JtYXR0ZWQgcmVzdWx0LiBUaGlzIGFwcGxpZXMgdG8gY29udGVudAoJICogbG9hZGVkIHZpYSBYSFIgc3VjaCBhcyBzY3JpcHRzLCBYTUwsIENTUywgYW5kIEltYWdlcy4gSWYgdGhlcmUgaXMgbm8gcmF3IHJlc3VsdCwgdGhlIGZvcm1hdHRlZCByZXN1bHQgd2lsbCBiZQoJICogcmV0dXJuZWQgaW5zdGVhZC4KCSAqIEByZXR1cm4ge09iamVjdH0gQSByZXN1bHQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbnRlbnQgdGhhdCB3YXMgbG9hZGVkLCBzdWNoIGFzOgoJICogPHVsPgoJICogICAgICA8bGk+QW4gaW1hZ2UgdGFnICgmbHQ7aW1hZ2UgLyZndDspIGZvciBpbWFnZXM8L2xpPgoJICogICAgICA8bGk+QSBzY3JpcHQgdGFnIGZvciBKYXZhU2NyaXB0ICgmbHQ7c2NyaXB0IC8mZ3Q7KS4gTm90ZSB0aGF0IHNjcmlwdHMgbG9hZGVkIHdpdGggdGFncyBtYXkgYmUgYWRkZWQgdG8gdGhlCgkgKiAgICAgIEhUTUwgaGVhZC48L2xpPgoJICogICAgICA8bGk+QSBzdHlsZSB0YWcgZm9yIENTUyAoJmx0O3N0eWxlIC8mZ3Q7KTwvbGk+CgkgKiAgICAgIDxsaT5SYXcgdGV4dCBmb3IgVEVYVDwvbGk+CgkgKiAgICAgIDxsaT5BIGZvcm1hdHRlZCBKYXZhU2NyaXB0IG9iamVjdCBkZWZpbmVkIGJ5IEpTT048L2xpPgoJICogICAgICA8bGk+QW4gWE1MIGRvY3VtZW50PC9saT4KCSAqICAgICAgPGxpPkFuIGJpbmFyeSBhcnJheWJ1ZmZlciBsb2FkZWQgYnkgWEhSPC9saT4KCSAqIDwvdWw+CgkgKiBOb3RlIHRoYXQgaWYgYSByYXcgcmVzdWx0IGlzIHJlcXVlc3RlZCwgYnV0IG5vdCBmb3VuZCwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGluc3RlYWQuCgkgKi8KCXAuZ2V0UmVzdWx0ID0gZnVuY3Rpb24gKHJhd1Jlc3VsdCkgewoJCWlmIChyYXdSZXN1bHQgJiYgdGhpcy5fcmF3UmVzcG9uc2UpIHsKCQkJcmV0dXJuIHRoaXMuX3Jhd1Jlc3BvbnNlOwoJCX0KCQlyZXR1cm4gdGhpcy5fcmVzcG9uc2U7Cgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAuY2FuY2VsID0gZnVuY3Rpb24gKCkgewoJCXRoaXMuY2FuY2VsZWQgPSB0cnVlOwoJCXRoaXMuX2NsZWFuKCk7CgkJdGhpcy5fcmVxdWVzdC5hYm9ydCgpOwoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKHRoaXMuX3JlcXVlc3QgPT0gbnVsbCkgewoJCQl0aGlzLl9oYW5kbGVFcnJvcigpOwoJCQlyZXR1cm47CgkJfQoKCQkvL0V2ZW50cwoJCXRoaXMuX3JlcXVlc3Qub25sb2Fkc3RhcnQgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVMb2FkU3RhcnQsIHRoaXMpOwoJCXRoaXMuX3JlcXVlc3Qub25wcm9ncmVzcyA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVByb2dyZXNzLCB0aGlzKTsKCQl0aGlzLl9yZXF1ZXN0Lm9uYWJvcnQgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVBYm9ydCwgdGhpcyk7CgkJdGhpcy5fcmVxdWVzdC5vbmVycm9yID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlRXJyb3IsIHRoaXMpOwoJCXRoaXMuX3JlcXVlc3Qub250aW1lb3V0ID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlVGltZW91dCwgdGhpcyk7CgkJLy8gU2V0IHVwIGEgdGltZW91dCBpZiB3ZSBkb24ndCBoYXZlIFhIUjIKCQlpZiAodGhpcy5feGhyTGV2ZWwgPT0gMSkgewoJCQl2YXIgZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUuTE9BRF9USU1FT1VUOwoJCQlpZiAoZHVyYXRpb24gPT0gMCkgewoJCQkJZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUubG9hZFRpbWVvdXQ7CgkJCX0gZWxzZSB7CgkJCQl0cnkgeyBjb25zb2xlLndhcm4oIkxvYWRRdWV1ZS5MT0FEX1RJTUVPVVQgaGFzIGJlZW4gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBMb2FkUXVldWUubG9hZFRpbWVvdXQiKTt9IGNhdGNoKGUpIHt9CgkJCX0KCQkJdGhpcy5fbG9hZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRpbWVvdXQsIHRoaXMpLCBkdXJhdGlvbik7CgkJfQoKCQkvLyBOb3RlOiBXZSBkb24ndCBnZXQgb25sb2FkIGluIGFsbCBicm93c2VycyAoZWFybGllciBGRiBhbmQgSUUpLiBvblJlYWR5U3RhdGVDaGFuZ2UgaGFuZGxlcyB0aGVzZS4KCQl0aGlzLl9yZXF1ZXN0Lm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsIHRoaXMpOwoKCQl0aGlzLl9yZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UsIHRoaXMpOwoKCQkvLyBTb21ldGltZXMgd2UgZ2V0IGJhY2sgNDA0cyBpbW1lZGlhdGVseSwgcGFydGljdWxhcmx5IHdoZW4gdGhlcmUgaXMgYSBjcm9zcyBvcmlnaW4gcmVxdWVzdC4gIC8vIG5vdGUgdGhpcyBkb2VzIG5vdCBjYXRjaCBpbiBDaHJvbWUKCQl0cnkgewoJCQlpZiAoIXRoaXMuX2l0ZW0udmFsdWVzIHx8IHRoaXMuX2l0ZW0ubWV0aG9kID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5HRVQpIHsKCQkJCXRoaXMuX3JlcXVlc3Quc2VuZCgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuX2l0ZW0ubWV0aG9kID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5QT1NUKSB7CgkJCQl0aGlzLl9yZXF1ZXN0LnNlbmQodGhpcy5fZm9ybWF0UXVlcnlTdHJpbmcodGhpcy5faXRlbS52YWx1ZXMpKTsKCQkJfQoJCX0gY2F0Y2ggKGVycm9yKSB7CgkJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkJZXZlbnQuZXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQl9Cgl9OwoKCS8qKgoJICogR2V0IGFsbCB0aGUgcmVzcG9uc2UgaGVhZGVycyBmcm9tIHRoZSBYbWxIdHRwUmVxdWVzdC4KCSAqCgkgKiA8c3Ryb25nPkZyb20gdGhlIGRvY3M6PC9zdHJvbmc+IFJldHVybiBhbGwgdGhlIEhUVFAgaGVhZGVycywgZXhjbHVkaW5nIGhlYWRlcnMgdGhhdCBhcmUgYSBjYXNlLWluc2Vuc2l0aXZlIG1hdGNoCgkgKiBmb3IgU2V0LUNvb2tpZSBvciBTZXQtQ29va2llMiwgYXMgYSBzaW5nbGUgc3RyaW5nLCB3aXRoIGVhY2ggaGVhZGVyIGxpbmUgc2VwYXJhdGVkIGJ5IGEgVSswMDBEIENSIFUrMDAwQSBMRiBwYWlyLAoJICogZXhjbHVkaW5nIHRoZSBzdGF0dXMgbGluZSwgYW5kIHdpdGggZWFjaCBoZWFkZXIgbmFtZSBhbmQgaGVhZGVyIHZhbHVlIHNlcGFyYXRlZCBieSBhIFUrMDAzQSBDT0xPTiBVKzAwMjAgU1BBQ0UKCSAqIHBhaXIuCgkgKiBAbWV0aG9kIGdldEFsbFJlc3BvbnNlSGVhZGVycwoJICogQHJldHVybiB7U3RyaW5nfQoJICogQHNpbmNlIDAuNC4xCgkgKi8KCXAuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzID0gZnVuY3Rpb24gKCkgewoJCWlmICAodGhpcy5fcmVxdWVzdC5nZXRBbGxSZXNwb25zZUhlYWRlcnMgaW5zdGFuY2VvZiBGdW5jdGlvbikgewoJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoKCS8qKgoJICogR2V0IGEgc3BlY2lmaWMgcmVzcG9uc2UgaGVhZGVyIGZyb20gdGhlIFhtbEh0dHBSZXF1ZXN0LgoJICoKCSAqIDxzdHJvbmc+RnJvbSB0aGUgZG9jczo8L3N0cm9uZz4gUmV0dXJucyB0aGUgaGVhZGVyIGZpZWxkIHZhbHVlIGZyb20gdGhlIHJlc3BvbnNlIG9mIHdoaWNoIHRoZSBmaWVsZCBuYW1lIG1hdGNoZXMKCSAqIGhlYWRlciwgdW5sZXNzIHRoZSBmaWVsZCBuYW1lIGlzIFNldC1Db29raWUgb3IgU2V0LUNvb2tpZTIuCgkgKiBAbWV0aG9kIGdldFJlc3BvbnNlSGVhZGVyCgkgKiBAcGFyYW0ge1N0cmluZ30gaGVhZGVyIFRoZSBoZWFkZXIgbmFtZSB0byByZXRyaWV2ZS4KCSAqIEByZXR1cm4ge1N0cmluZ30KCSAqIEBzaW5jZSAwLjQuMQoJICovCglwLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKGhlYWRlcikgewoJCWlmICh0aGlzLl9yZXF1ZXN0LmdldFJlc3BvbnNlSGVhZGVyIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKCQkJcmV0dXJuIHRoaXMuX3JlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyByZXBvcnRlZCBwcm9ncmVzcy4KCSAqIEBtZXRob2QgX2hhbmRsZVByb2dyZXNzCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBwcm9ncmVzcyBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CgkJaWYgKCFldmVudCB8fCBldmVudC5sb2FkZWQgPiAwICYmIGV2ZW50LnRvdGFsID09IDApIHsKCQkJcmV0dXJuOyAvLyBTb21ldGltZXMgd2UgZ2V0IG5vICJ0b3RhbCIsIHNvIGp1c3QgaWdub3JlIHRoZSBwcm9ncmVzcyBldmVudC4KCQl9CgoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgicHJvZ3Jlc3MiKTsKCQluZXdFdmVudC5sb2FkZWQgPSBldmVudC5sb2FkZWQ7CgkJbmV3RXZlbnQudG90YWwgPSBldmVudC50b3RhbDsKCQl0aGlzLl9zZW5kUHJvZ3Jlc3MobmV3RXZlbnQpOwoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgcmVwb3J0ZWQgYSBsb2FkIHN0YXJ0LgoJICogQG1ldGhvZCBfaGFuZGxlTG9hZFN0YXJ0CgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBsb2FkU3RhcnQgZXZlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9oYW5kbGVMb2FkU3RhcnQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoJCXRoaXMuX3NlbmRMb2FkU3RhcnQoKTsKCX07CgoJLyoqCgkgKiBUaGUgWEhSIHJlcXVlc3QgaGFzIHJlcG9ydGVkIGFuIGFib3J0IGV2ZW50LgoJICogQG1ldGhvZCBoYW5kbGVBYm9ydAoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBYSFIgYWJvcnQgZXZlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9oYW5kbGVBYm9ydCA9IGZ1bmN0aW9uIChldmVudCkgewoJCXRoaXMuX2NsZWFuKCk7CgkJdmFyIG5ld0V2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCW5ld0V2ZW50LnRleHQgPSAiWEhSX0FCT1JURUQiOwoJCXRoaXMuX3NlbmRFcnJvcihuZXdFdmVudCk7Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyByZXBvcnRlZCBhbiBlcnJvciBldmVudC4KCSAqIEBtZXRob2QgX2hhbmRsZUVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBlcnJvciBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUVycm9yID0gZnVuY3Rpb24gKGV2ZW50KSB7CgkJdGhpcy5fY2xlYW4oKTsKCQl2YXIgbmV3RXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJLy9UT0RPOiBQcm9wYWdhdGUgZXZlbnQgZXJyb3IKCQl0aGlzLl9zZW5kRXJyb3IobmV3RXZlbnQpOwoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgcmVwb3J0ZWQgYSByZWFkeVN0YXRlIGNoYW5nZS4gTm90ZSB0aGF0IG9sZGVyIGJyb3dzZXJzIChJRSA3ICYgOCkgZG8gbm90IHByb3ZpZGUgYW4gb25sb2FkCgkgKiBldmVudCwgc28gd2UgbXVzdCBtb25pdG9yIHRoZSByZWFkeVN0YXRlQ2hhbmdlIHRvIGRldGVybWluZSBpZiB0aGUgZmlsZSBpcyBsb2FkZWQuCgkgKiBAbWV0aG9kIF9oYW5kbGVSZWFkeVN0YXRlQ2hhbmdlCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiByZWFkeVN0YXRlQ2hhbmdlIGV2ZW50LgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlUmVhZHlTdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChldmVudCkgewoJCWlmICh0aGlzLl9yZXF1ZXN0LnJlYWR5U3RhdGUgPT0gNCkgewoJCQl0aGlzLl9oYW5kbGVMb2FkKCk7CgkJfQoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgY29tcGxldGVkLiBUaGlzIGlzIGNhbGxlZCBieSB0aGUgWEhSIHJlcXVlc3QgZGlyZWN0bHksIG9yIGJ5IGEgcmVhZHlTdGF0ZUNoYW5nZSB0aGF0IGhhcwoJICogPGNvZGU+cmVxdWVzdC5yZWFkeVN0YXRlID09IDQ8L2NvZGU+LiBPbmx5IHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgbWV0aG9kIHdpbGwgYmUgcHJvY2Vzc2VkLgoJICogQG1ldGhvZCBfaGFuZGxlTG9hZAoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBYSFIgbG9hZCBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUxvYWQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQlpZiAodGhpcy5sb2FkZWQpIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLmxvYWRlZCA9IHRydWU7CgoJCWlmICghdGhpcy5fY2hlY2tFcnJvcigpKSB7CgkJCXRoaXMuX2hhbmRsZUVycm9yKCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3Jlc3BvbnNlID0gdGhpcy5fZ2V0UmVzcG9uc2UoKTsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBpc0NvbXBsZXRlID0gdGhpcy5fZ2VuZXJhdGVUYWcoKTsKCQlpZiAoaXNDb21wbGV0ZSkgewoJCQl0aGlzLl9zZW5kQ29tcGxldGUoKTsKCQl9Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyB0aW1lZCBvdXQuIFRoaXMgaXMgY2FsbGVkIGJ5IHRoZSBYSFIgcmVxdWVzdCBkaXJlY3RseSwgb3IgdmlhIGEgPGNvZGU+c2V0VGltZW91dDwvY29kZT4KCSAqIGNhbGxiYWNrLgoJICogQG1ldGhvZCBfaGFuZGxlVGltZW91dAoJICogQHBhcmFtIHtPYmplY3R9IFtldmVudF0gVGhlIFhIUiB0aW1lb3V0IGV2ZW50LiBUaGlzIGlzIG9jY2FzaW9uYWxseSBudWxsIHdoZW4gY2FsbGVkIGJ5IHRoZSBiYWNrdXAgc2V0VGltZW91dC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVRpbWVvdXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQluZXdFdmVudC50ZXh0ID0gIlBSRUxPQURfVElNRU9VVCI7CgkJLy9UT0RPOiBQcm9wYWdhdGUgYWN0dWFsIGV2ZW50IGVycm9yCgkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCX07CgoKLy8gUHJvdGVjdGVkCgkvKioKCSAqIERldGVybWluZSBpZiB0aGVyZSBpcyBhbiBlcnJvciBpbiB0aGUgY3VycmVudCBsb2FkLiBUaGlzIGNoZWNrcyB0aGUgc3RhdHVzIG9mIHRoZSByZXF1ZXN0IGZvciBwcm9ibGVtIGNvZGVzLiBOb3RlCgkgKiB0aGF0IHRoaXMgZG9lcyBub3QgY2hlY2sgZm9yIGFuIGFjdHVhbCByZXNwb25zZS4gQ3VycmVudGx5LCBpdCBvbmx5IGNoZWNrcyBmb3IgNDA0IG9yIDAgZXJyb3IgY29kZS4KCSAqIEBtZXRob2QgX2NoZWNrRXJyb3IKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSByZXF1ZXN0IHN0YXR1cyByZXR1cm5zIGFuIGVycm9yIGNvZGUuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jaGVja0Vycm9yID0gZnVuY3Rpb24gKCkgewoJCS8vTE06IFByb2JhYmx5IG5lZWQgYWRkaXRpb25hbCBoYW5kbGVycyBoZXJlLCBtYXliZSA1MDEKCQl2YXIgc3RhdHVzID0gcGFyc2VJbnQodGhpcy5fcmVxdWVzdC5zdGF0dXMpOwoKCQlzd2l0Y2ggKHN0YXR1cykgewoJCQljYXNlIDQwNDogICAvLyBOb3QgRm91bmQKCQkJY2FzZSAwOiAgICAgLy8gTm90IExvYWRlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX07CgoJLyoqCgkgKiBWYWxpZGF0ZSB0aGUgcmVzcG9uc2UuIERpZmZlcmVudCBicm93c2VycyBoYXZlIGRpZmZlcmVudCBhcHByb2FjaGVzLCBzb21lIG9mIHdoaWNoIHRocm93IGVycm9ycyB3aGVuIGFjY2Vzc2VkCgkgKiBpbiBvdGhlciBicm93c2Vycy4gSWYgdGhlcmUgaXMgbm8gcmVzcG9uc2UsIHRoZSA8Y29kZT5fcmVzcG9uc2U8L2NvZGU+IHByb3BlcnR5IHdpbGwgcmVtYWluIG51bGwuCgkgKiBAbWV0aG9kIF9nZXRSZXNwb25zZQoJICogQHByaXZhdGUKCSAqLwoJcC5fZ2V0UmVzcG9uc2UgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKHRoaXMuX3Jlc3BvbnNlICE9IG51bGwpIHsKCQkJcmV0dXJuIHRoaXMuX3Jlc3BvbnNlOwoJCX0KCgkJaWYgKHRoaXMuX3JlcXVlc3QucmVzcG9uc2UgIT0gbnVsbCkgewoJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5yZXNwb25zZTsKCQl9CgoJCS8vIEFuZHJvaWQgMi4yIHVzZXMgLnJlc3BvbnNlVGV4dAoJCXRyeSB7CgkJCWlmICh0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlVGV4dCAhPSBudWxsKSB7CgkJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5yZXNwb25zZVRleHQ7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJfQoKCQkvLyBXaGVuIGxvYWRpbmcgWE1MLCBJRTkgZG9lcyBub3QgcmV0dXJuIC5yZXNwb25zZSwgaW5zdGVhZCBpdCByZXR1cm5zIHJlc3BvbnNlWE1MLnhtbAoJCS8vVE9ETzogVEVTVAoJCXRyeSB7CgkJCWlmICh0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlWE1MICE9IG51bGwpIHsKCQkJCXJldHVybiB0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlWE1MOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCX0KCQlyZXR1cm4gbnVsbDsKCX07CgoJLyoqCgkgKiBDcmVhdGUgYW4gWEhSIHJlcXVlc3QuIERlcGVuZGluZyBvbiBhIG51bWJlciBvZiBmYWN0b3JzLCB3ZSBnZXQgdG90YWxseSBkaWZmZXJlbnQgcmVzdWx0cy4KCSAqIDxvbD48bGk+U29tZSBicm93c2VycyBnZXQgYW4gPGNvZGU+WERvbWFpblJlcXVlc3Q8L2NvZGU+IHdoZW4gbG9hZGluZyBjcm9zcy1kb21haW4uPC9saT4KCSAqICAgICAgPGxpPlhNTEh0dHBSZXF1ZXN0IGFyZSBjcmVhdGVkIHdoZW4gYXZhaWxhYmxlLjwvbGk+CgkgKiAgICAgIDxsaT5BY3RpdmVYLlhNTEhUVFAgb2JqZWN0cyBhcmUgdXNlZCBpbiBvbGRlciBJRSBicm93c2Vycy48L2xpPgoJICogICAgICA8bGk+VGV4dCByZXF1ZXN0cyBvdmVycmlkZSB0aGUgbWltZSB0eXBlIGlmIHBvc3NpYmxlPC9saT4KCSAqICAgICAgPGxpPk9yaWdpbiBoZWFkZXJzIGFyZSBzZW50IGZvciBjcm9zc2RvbWFpbiByZXF1ZXN0cyBpbiBzb21lIGJyb3dzZXJzLjwvbGk+CgkgKiAgICAgIDxsaT5CaW5hcnkgbG9hZHMgc2V0IHRoZSByZXNwb25zZSB0eXBlIHRvICJhcnJheWJ1ZmZlciI8L2xpPjwvb2w+CgkgKiBAbWV0aG9kIF9jcmVhdGVYSFIKCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSByZXF1ZXN0ZWQgaXRlbSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4KCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIFhIUiByZXF1ZXN0IG9yIGVxdWl2YWxlbnQgd2FzIHN1Y2Nlc3NmdWxseSBjcmVhdGVkLgoJICogQHByaXZhdGUKCSAqLwoJcC5fY3JlYXRlWEhSID0gZnVuY3Rpb24gKGl0ZW0pIHsKCQkvLyBDaGVjayBmb3IgY3Jvc3MtZG9tYWluIGxvYWRzLiBXZSBjYW4ndCBmdWxseSBzdXBwb3J0IHRoZW0sIGJ1dCB3ZSBjYW4gdHJ5LgoJCXZhciBjcm9zc2RvbWFpbiA9IHRoaXMuX2lzQ3Jvc3NEb21haW4oaXRlbSk7CgkJdmFyIGhlYWRlcnMgPSB7fTsKCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0LiBGYWxsYmFjayB0byB3aGF0ZXZlciBzdXBwb3J0IHdlIGhhdmUuCgkJdmFyIHJlcSA9IG51bGw7CgkJaWYgKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgewoJCQlyZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCQkJLy8gVGhpcyBpcyA4IG9yIDksIHNvIHVzZSBYRG9tYWluUmVxdWVzdCBpbnN0ZWFkLgoJCQlpZiAoY3Jvc3Nkb21haW4gJiYgcmVxLndpdGhDcmVkZW50aWFscyA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5YRG9tYWluUmVxdWVzdCkgewoJCQkJcmVxID0gbmV3IFhEb21haW5SZXF1ZXN0KCk7CgkJCX0KCQl9IGVsc2UgeyAvLyBPbGQgSUUgdmVyc2lvbnMgdXNlIGEgZGlmZmVyZW50IGFwcHJvYWNoCgkJCWZvciAodmFyIGkgPSAwLCBsPXMuQUNUSVZFWF9WRVJTSU9OUy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkgICAgICAgICAgICB2YXIgYXhWZXJzaW9uID0gcy5BQ1RJVkVYX1ZFUlNJT05TW2ldOwoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICByZXEgPSBuZXcgQWN0aXZlWE9iamVjdChheFZlcnNpb25zKTsKCQkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgkgICAgICAgIH0KCQkJaWYgKHJlcSA9PSBudWxsKSB7IHJldHVybiBmYWxzZTsgfQoJCX0KCgkJLy8gSUU5IGRvZXNuJ3Qgc3VwcG9ydCBvdmVycmlkZU1pbWVUeXBlKCksIHNvIHdlIG5lZWQgdG8gY2hlY2sgZm9yIGl0LgoJCWlmIChjcmVhdGVqcy5Mb2FkUXVldWUuaXNUZXh0KGl0ZW0udHlwZSkgJiYgcmVxLm92ZXJyaWRlTWltZVR5cGUpIHsKCQkJcmVxLm92ZXJyaWRlTWltZVR5cGUoInRleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgiKTsKCQl9CgoJCS8vIERldGVybWluZSB0aGUgWEhSIGxldmVsCgkJdGhpcy5feGhyTGV2ZWwgPSAodHlwZW9mIHJlcS5yZXNwb25zZVR5cGUgPT09ICJzdHJpbmciKSA/IDIgOiAxOwoKCQl2YXIgc3JjID0gbnVsbDsKCQlpZiAoaXRlbS5tZXRob2QgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLkdFVCkgewoJCQlzcmMgPSB0aGlzLmJ1aWxkUGF0aChpdGVtLnNyYywgaXRlbS52YWx1ZXMpOwoJCX0gZWxzZSB7CgkJCXNyYyA9IGl0ZW0uc3JjOwoJCX0KCgkJLy8gT3BlbiB0aGUgcmVxdWVzdC4gIFNldCBjcm9zcy1kb21haW4gZmxhZ3MgaWYgaXQgaXMgc3VwcG9ydGVkIChYSFIgbGV2ZWwgMSBvbmx5KQoJCXJlcS5vcGVuKGl0ZW0ubWV0aG9kIHx8IGNyZWF0ZWpzLkxvYWRRdWV1ZS5HRVQsIHNyYywgdHJ1ZSk7CgoJCWlmIChjcm9zc2RvbWFpbiAmJiByZXEgaW5zdGFuY2VvZiBYTUxIdHRwUmVxdWVzdCAmJiB0aGlzLl94aHJMZXZlbCA9PSAxKSB7CgkJCWhlYWRlcnNbIk9yaWdpbiJdID0gbG9jYXRpb24ub3JpZ2luOwoJCX0KCgkJLy8gVG8gc2VuZCBkYXRhIHdlIG5lZWQgdG8gc2V0IHRoZSBDb250ZW50LXR5cGUgaGVhZGVyKQoJCWlmIChpdGVtLnZhbHVlcyAmJiBpdGVtLm1ldGhvZCA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuUE9TVCkgewoJCQloZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiOwoJCX0KCgkJaWYgKCFjcm9zc2RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdKSB7CgkJCWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CgkJfQoKCQlpZiAoaXRlbS5oZWFkZXJzKSB7CgkJCWZvciAodmFyIG4gaW4gaXRlbS5oZWFkZXJzKSB7CgkJCQloZWFkZXJzW25dID0gaXRlbS5oZWFkZXJzW25dOwoJCQl9CgkJfQoKCQkvLyBCaW5hcnkgZmlsZXMgYXJlIGxvYWRlZCBkaWZmZXJlbnRseS4KCQlpZiAoY3JlYXRlanMuTG9hZFF1ZXVlLmlzQmluYXJ5KGl0ZW0udHlwZSkpIHsKCQkJcmVxLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CgkJfQoKCQlmb3IgKG4gaW4gaGVhZGVycykgewoJCQlyZXEuc2V0UmVxdWVzdEhlYWRlcihuLCBoZWFkZXJzW25dKQoJCX0KCgkJdGhpcy5fcmVxdWVzdCA9IHJlcTsKCgkJcmV0dXJuIHRydWU7Cgl9OwoKCS8qKgoJICogQSByZXF1ZXN0IGhhcyBjb21wbGV0ZWQgKG9yIGZhaWxlZCBvciBjYW5jZWxlZCksIGFuZCBuZWVkcyB0byBiZSBkaXNwb3NlZC4KCSAqIEBtZXRob2QgX2NsZWFuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jbGVhbiA9IGZ1bmN0aW9uICgpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoKCQl2YXIgcmVxID0gdGhpcy5fcmVxdWVzdDsKCQlyZXEub25sb2Fkc3RhcnQgPSBudWxsOwoJCXJlcS5vbnByb2dyZXNzID0gbnVsbDsKCQlyZXEub25hYm9ydCA9IG51bGw7CgkJcmVxLm9uZXJyb3IgPSBudWxsOwoJCXJlcS5vbmxvYWQgPSBudWxsOwoJCXJlcS5vbnRpbWVvdXQgPSBudWxsOwoJCXJlcS5vbmxvYWRlbmQgPSBudWxsOwoJCXJlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoJfTsKCgkvKioKCSAqIEdlbmVyYXRlIGEgdGFnIGZvciBpdGVtcyB0aGF0IGNhbiBiZSByZXByZXNlbnRlZCBhcyB0YWdzLiBGb3IgZXhhbXBsZSwgSU1BR0UsIFNDUklQVCwgYW5kIExJTksuIFRoaXMgYWxzbyBoYW5kbGVzCgkgKiBYTUwgYW5kIFNWRyBvYmplY3RzLgoJICogQG1ldGhvZCBfZ2VuZXJhdGVUYWcKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIGEgdGFnIHdhcyBnZW5lcmF0ZWQgYW5kIGlzIHJlYWR5IGZvciBpbnN0YW50aWF0aW9uLiBJZiBpdCBzdGlsbCBuZWVkcyBwcm9jZXNzaW5nLCB0aGlzCgkgKiBtZXRob2QgcmV0dXJucyBmYWxzZS4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2dlbmVyYXRlVGFnID0gZnVuY3Rpb24gKCkgewoJCXZhciB0eXBlID0gdGhpcy5faXRlbS50eXBlOwoJCXZhciB0YWcgPSB0aGlzLl9pdGVtLnRhZzsKCgkJc3dpdGNoICh0eXBlKSB7CgkJCS8vIE5vdGU6IEltYWdlcyBuZWVkIHRvIHdhaXQgZm9yIG9ubG9hZCwgYnV0IGRvIHVzZSB0aGUgY2FjaGUuCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLklNQUdFOgoJCQkJdGFnLm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRhZ1JlYWR5LCB0aGlzKTsKCQkJCWlmICh0aGlzLl9jcm9zc09yaWdpbiAhPSAiIikgeyB0YWcuY3Jvc3NPcmlnaW4gPSAiQW5vbnltb3VzIjsgfS8vIFdlIGNhbiBhc3N1bWUgdGhpcywgc2luY2UgWEhSIGltYWdlcyBhcmUgYWx3YXlzIGxvYWRlZCBvbiBhIHNlcnZlci4KCQkJCXRhZy5zcmMgPSB0aGlzLmJ1aWxkUGF0aCh0aGlzLl9pdGVtLnNyYywgdGhpcy5faXRlbS52YWx1ZXMpOwoKCQkJCXRoaXMuX3Jhd1Jlc3BvbnNlID0gdGhpcy5fcmVzcG9uc2U7CgkJCQl0aGlzLl9yZXNwb25zZSA9IHRhZzsKCQkJCXJldHVybiBmYWxzZTsgLy8gSW1hZ2VzIG5lZWQgdG8gZ2V0IGFuIG9ubG9hZCBldmVudCBmaXJzdAoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoJCQkJdGFnLnRleHQgPSB0aGlzLl9yZXNwb25zZTsKCgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB0YWc7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkNTUzoKCQkJCS8vIE1heWJlIGRvIHRoaXMgY29uZGl0aW9uYWxseT8KCQkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsgLy9Ob3RlOiBUaGlzIGlzIHVuYXZvaWRhYmxlIGluIElFNjc4CgkJCQloZWFkLmFwcGVuZENoaWxkKHRhZyk7CgoJCQkJaWYgKHRhZy5zdHlsZVNoZWV0KSB7IC8vIElFCgkJCQkJdGFnLnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aGlzLl9yZXNwb25zZSk7CgkJCQkJdGFnLmFwcGVuZENoaWxkKHRleHROb2RlKTsKCQkJCX0KCgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB0YWc7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDoKCQkJCXZhciB4bWwgPSB0aGlzLl9wYXJzZVhNTCh0aGlzLl9yZXNwb25zZSwgInRleHQveG1sIik7CgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB4bWw7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJCXZhciB4bWwgPSB0aGlzLl9wYXJzZVhNTCh0aGlzLl9yZXNwb25zZSwgImltYWdlL3N2Zyt4bWwiKTsKCQkJCXRoaXMuX3Jhd1Jlc3BvbnNlID0gdGhpcy5fcmVzcG9uc2U7CgkJCQlpZiAoeG1sLmRvY3VtZW50RWxlbWVudCAhPSBudWxsKSB7CgkJCQkJdGFnLmFwcGVuZENoaWxkKHhtbC5kb2N1bWVudEVsZW1lbnQpOwoJCQkJCXRoaXMuX3Jlc3BvbnNlID0gdGFnOwoJCQkJfSBlbHNlIHsgLy8gRm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBTVkcsIGp1c3QgZ2l2ZSB0aGVtIHRoZSBYTUwuIChJRSA5LTgpCgkJCQkJdGhpcy5fcmVzcG9uc2UgPSB4bWw7CgkJCQl9CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQkJdmFyIGpzb24gPSB7fTsKCQkJCXRyeSB7CgkJCQkJanNvbiA9IEpTT04ucGFyc2UodGhpcy5fcmVzcG9uc2UpOwoJCQkJfSBjYXRjaCAoZXJyb3IpIHsKCQkJCQlqc29uID0gZXJyb3I7CgkJCQl9CgoJCQkJdGhpcy5fcmF3UmVzcG9uc2UgPSB0aGlzLl9yZXNwb25zZTsKCQkJCXRoaXMuX3Jlc3BvbnNlID0ganNvbjsKCQkJCXJldHVybiB0cnVlOwoKCQl9CgkJcmV0dXJuIHRydWU7Cgl9OwoKCS8qKgoJICogUGFyc2UgWE1MIHVzaW5nIHRoZSBET00uIFRoaXMgaXMgcmVxdWlyZWQgd2hlbiBwcmVsb2FkaW5nIFhNTCBvciBTVkcuCgkgKiBAbWV0aG9kIF9wYXJzZVhNTAoJICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHJhdyB0ZXh0IG9yIFhNTCB0aGF0IGlzIGxvYWRlZCBieSBYSFIuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgbWltZSB0eXBlIG9mIHRoZSBYTUwuCgkgKiBAcmV0dXJuIHtYTUx9IEFuIFhNTCBkb2N1bWVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3BhcnNlWE1MID0gZnVuY3Rpb24gKHRleHQsIHR5cGUpIHsKCQl2YXIgeG1sID0gbnVsbDsKCQl0cnkgewoJCQkvLyBDb2Nvb25KUyBkb2VzIG5vdCBzdXBwb3J0IFhNTCBwYXJzaW5nIHdpdGggZWl0aGVyIG1ldGhvZC4KCQkJLy8gV2luZG93cyAoPykgT3BlcmEgRE9NUGFyc2VyIHRocm93cyBET01FeGNlcHRpb246IE5PVF9TVVBQT1JURURfRVJSICAvLyBwb3RlbnRpYWwgc29sdXRpb24gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTEyOTAzMQoJCQlpZiAod2luZG93LkRPTVBhcnNlcikgewoJCQkJdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKCQkJCXhtbCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcodGV4dCwgdHlwZSk7CgkJCX0gZWxzZSB7IC8vIElFCgkJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTERPTSIpOwoJCQkJeG1sLmFzeW5jID0gZmFsc2U7CgkJCQl4bWwubG9hZFhNTCh0ZXh0KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHt9CgkJcmV0dXJuIHhtbDsKCX07CgoJLyoqCgkgKiBBIGdlbmVyYXRlZCB0YWcgaXMgbm93IHJlYWR5IGZvciB1c2UuCgkgKiBAbWV0aG9kIF9oYW5kbGVUYWdSZWFkeQoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlVGFnUmVhZHkgPSBmdW5jdGlvbiAoKSB7CgkJdmFyIHRhZyA9IHRoaXMuX2l0ZW0udGFnOwoJCXRhZyAmJiAodGFnLm9ubG9hZCA9IG51bGwpOwoJCXRoaXMuX3NlbmRDb21wbGV0ZSgpOwoJfTsKCglwLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBYSFJMb2FkZXJdIjsKCX07CgoJY3JlYXRlanMuWEhSTG9hZGVyID0gWEhSTG9hZGVyOwoKfSgpKTsKCi8qKgogKiBJbmNsdWRlIGpzb24yIGhlcmUsIHRvIGNvcnJlY3RseSBwYXJzZSBqc29uLgogKiBVc2VkIG9uIGJyb3dzZXJzIHRoYXQgZG9uJ3QgaGF2ZSBhIG5hdGl2ZSBKU09OIG9iamVjdC4KICoKICovCi8qCiBqc29uMi5qcwogMjAxMi0xMC0wOAoKIFB1YmxpYyBEb21haW4uCgogTk8gV0FSUkFOVFkgRVhQUkVTU0VEIE9SIElNUExJRUQuIFVTRSBBVCBZT1VSIE9XTiBSSVNLLgoKIFNlZSBodHRwOi8vd3d3LkpTT04ub3JnL2pzLmh0bWwKCgogVGhpcyBjb2RlIHNob3VsZCBiZSBtaW5pZmllZCBiZWZvcmUgZGVwbG95bWVudC4KIFNlZSBodHRwOi8vamF2YXNjcmlwdC5jcm9ja2ZvcmQuY29tL2pzbWluLmh0bWwKCiBVU0UgWU9VUiBPV04gQ09QWS4gSVQgSVMgRVhUUkVNRUxZIFVOV0lTRSBUTyBMT0FEIENPREUgRlJPTSBTRVJWRVJTIFlPVSBETwogTk9UIENPTlRST0wuCiAqLwoKCi8vIENyZWF0ZSBhIEpTT04gb2JqZWN0IG9ubHkgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuIFdlIGNyZWF0ZSB0aGUKLy8gbWV0aG9kcyBpbiBhIGNsb3N1cmUgdG8gYXZvaWQgY3JlYXRpbmcgZ2xvYmFsIHZhcmlhYmxlcy4KCmlmICh0eXBlb2YgSlNPTiAhPT0gJ29iamVjdCcpIHsKCUpTT04gPSB7fTsKfQoKKGZ1bmN0aW9uICgpIHsKCSd1c2Ugc3RyaWN0JzsKCglmdW5jdGlvbiBmKG4pIHsKCQkvLyBGb3JtYXQgaW50ZWdlcnMgdG8gaGF2ZSBhdCBsZWFzdCB0d28gZGlnaXRzLgoJCXJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKCX0KCglpZiAodHlwZW9mIERhdGUucHJvdG90eXBlLnRvSlNPTiAhPT0gJ2Z1bmN0aW9uJykgewoKCQlEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CgoJCQlyZXR1cm4gaXNGaW5pdGUodGhpcy52YWx1ZU9mKCkpCgkJCQkJPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgKyAnLScgKwoJCQkJCWYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwoJCQkJCWYodGhpcy5nZXRVVENEYXRlKCkpICsgJ1QnICsKCQkJCQlmKHRoaXMuZ2V0VVRDSG91cnMoKSkgKyAnOicgKwoJCQkJCWYodGhpcy5nZXRVVENNaW51dGVzKCkpICsgJzonICsKCQkJCQlmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSArICdaJwoJCQkJCTogbnVsbDsKCQl9OwoKCQlTdHJpbmcucHJvdG90eXBlLnRvSlNPTiA9CgkJCQlOdW1iZXIucHJvdG90eXBlLnRvSlNPTiA9CgkJCQkJCUJvb2xlYW4ucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIChrZXkpIHsKCQkJCQkJCXJldHVybiB0aGlzLnZhbHVlT2YoKTsKCQkJCQkJfTsKCX0KCgl2YXIgY3ggPSAvW1x1MDAwMFx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAoJCQllc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKCQkJZ2FwLAoJCQlpbmRlbnQsCgkJCW1ldGEgPSB7ICAgIC8vIHRhYmxlIG9mIGNoYXJhY3RlciBzdWJzdGl0dXRpb25zCgkJCQknXGInOidcXGInLAoJCQkJJ1x0JzonXFx0JywKCQkJCSdcbic6J1xcbicsCgkJCQknXGYnOidcXGYnLAoJCQkJJ1xyJzonXFxyJywKCQkJCSciJzonXFwiJywKCQkJCSdcXCc6J1xcXFwnCgkJCX0sCgkJCXJlcDsKCgoJZnVuY3Rpb24gcXVvdGUoc3RyaW5nKSB7CgovLyBJZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG5vIGNvbnRyb2wgY2hhcmFjdGVycywgbm8gcXVvdGUgY2hhcmFjdGVycywgYW5kIG5vCi8vIGJhY2tzbGFzaCBjaGFyYWN0ZXJzLCB0aGVuIHdlIGNhbiBzYWZlbHkgc2xhcCBzb21lIHF1b3RlcyBhcm91bmQgaXQuCi8vIE90aGVyd2lzZSB3ZSBtdXN0IGFsc28gcmVwbGFjZSB0aGUgb2ZmZW5kaW5nIGNoYXJhY3RlcnMgd2l0aCBzYWZlIGVzY2FwZQovLyBzZXF1ZW5jZXMuCgoJCWVzY2FwYWJsZS5sYXN0SW5kZXggPSAwOwoJCXJldHVybiBlc2NhcGFibGUudGVzdChzdHJpbmcpID8gJyInICsgc3RyaW5nLnJlcGxhY2UoZXNjYXBhYmxlLCBmdW5jdGlvbiAoYSkgewoJCQl2YXIgYyA9IG1ldGFbYV07CgkJCXJldHVybiB0eXBlb2YgYyA9PT0gJ3N0cmluZycKCQkJCQk/IGMKCQkJCQk6ICdcXHUnICsgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKCQl9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKCX0KCgoJZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgovLyBQcm9kdWNlIGEgc3RyaW5nIGZyb20gaG9sZGVyW2tleV0uCgoJCXZhciBpLCAvLyBUaGUgbG9vcCBjb3VudGVyLgoJCQkJaywgLy8gVGhlIG1lbWJlciBrZXkuCgkJCQl2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgoJCQkJbGVuZ3RoLAoJCQkJbWluZCA9IGdhcCwKCQkJCXBhcnRpYWwsCgkJCQl2YWx1ZSA9IGhvbGRlcltrZXldOwoKLy8gSWYgdGhlIHZhbHVlIGhhcyBhIHRvSlNPTiBtZXRob2QsIGNhbGwgaXQgdG8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgoJCWlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmCgkJCQl0eXBlb2YgdmFsdWUudG9KU09OID09PSAnZnVuY3Rpb24nKSB7CgkJCXZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CgkJfQoKLy8gSWYgd2Ugd2VyZSBjYWxsZWQgd2l0aCBhIHJlcGxhY2VyIGZ1bmN0aW9uLCB0aGVuIGNhbGwgdGhlIHJlcGxhY2VyIHRvCi8vIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKCQlpZiAodHlwZW9mIHJlcCA9PT0gJ2Z1bmN0aW9uJykgewoJCQl2YWx1ZSA9IHJlcC5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CgkJfQoKLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKCQlzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewoJCQljYXNlICdzdHJpbmcnOgoJCQkJcmV0dXJuIHF1b3RlKHZhbHVlKTsKCgkJCWNhc2UgJ251bWJlcic6CgovLyBKU09OIG51bWJlcnMgbXVzdCBiZSBmaW5pdGUuIEVuY29kZSBub24tZmluaXRlIG51bWJlcnMgYXMgbnVsbC4KCgkJCQlyZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCgkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQljYXNlICdudWxsJzoKCi8vIElmIHRoZSB2YWx1ZSBpcyBhIGJvb2xlYW4gb3IgbnVsbCwgY29udmVydCBpdCB0byBhIHN0cmluZy4gTm90ZToKLy8gdHlwZW9mIG51bGwgZG9lcyBub3QgcHJvZHVjZSAnbnVsbCcuIFRoZSBjYXNlIGlzIGluY2x1ZGVkIGhlcmUgaW4KLy8gdGhlIHJlbW90ZSBjaGFuY2UgdGhhdCB0aGlzIGdldHMgZml4ZWQgc29tZWRheS4KCgkJCQlyZXR1cm4gU3RyaW5nKHZhbHVlKTsKCi8vIElmIHRoZSB0eXBlIGlzICdvYmplY3QnLCB3ZSBtaWdodCBiZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IG9yIGFuIGFycmF5IG9yCi8vIG51bGwuCgoJCQljYXNlICdvYmplY3QnOgoKLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAovLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCgkJCQlpZiAoIXZhbHVlKSB7CgkJCQkJcmV0dXJuICdudWxsJzsKCQkJCX0KCi8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCgkJCQlnYXAgKz0gaW5kZW50OwoJCQkJcGFydGlhbCA9IFtdOwoKLy8gSXMgdGhlIHZhbHVlIGFuIGFycmF5PwoKCQkJCWlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKLy8gVGhlIHZhbHVlIGlzIGFuIGFycmF5LiBTdHJpbmdpZnkgZXZlcnkgZWxlbWVudC4gVXNlIG51bGwgYXMgYSBwbGFjZWhvbGRlcgovLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKCQkJCQlsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgkJCQkJZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CgkJCQkJCXBhcnRpYWxbaV0gPSBzdHIoaSwgdmFsdWUpIHx8ICdudWxsJzsKCQkJCQl9CgovLyBKb2luIGFsbCBvZiB0aGUgZWxlbWVudHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywgYW5kIHdyYXAgdGhlbSBpbgovLyBicmFja2V0cy4KCgkJCQkJdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwCgkJCQkJCQk/ICdbXScKCQkJCQkJCTogZ2FwCgkJCQkJCQk/ICdbXG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArICdcbicgKyBtaW5kICsgJ10nCgkJCQkJCQk6ICdbJyArIHBhcnRpYWwuam9pbignLCcpICsgJ10nOwoJCQkJCWdhcCA9IG1pbmQ7CgkJCQkJcmV0dXJuIHY7CgkJCQl9CgovLyBJZiB0aGUgcmVwbGFjZXIgaXMgYW4gYXJyYXksIHVzZSBpdCB0byBzZWxlY3QgdGhlIG1lbWJlcnMgdG8gYmUgc3RyaW5naWZpZWQuCgoJCQkJaWYgKHJlcCAmJiB0eXBlb2YgcmVwID09PSAnb2JqZWN0JykgewoJCQkJCWxlbmd0aCA9IHJlcC5sZW5ndGg7CgkJCQkJZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CgkJCQkJCWlmICh0eXBlb2YgcmVwW2ldID09PSAnc3RyaW5nJykgewoJCQkJCQkJayA9IHJlcFtpXTsKCQkJCQkJCXYgPSBzdHIoaywgdmFsdWUpOwoJCQkJCQkJaWYgKHYpIHsKCQkJCQkJCQlwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgovLyBPdGhlcndpc2UsIGl0ZXJhdGUgdGhyb3VnaCBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG9iamVjdC4KCgkJCQkJZm9yIChrIGluIHZhbHVlKSB7CgkJCQkJCWlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CgkJCQkJCQl2ID0gc3RyKGssIHZhbHVlKTsKCQkJCQkJCWlmICh2KSB7CgkJCQkJCQkJcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgovLyBKb2luIGFsbCBvZiB0aGUgbWVtYmVyIHRleHRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsCi8vIGFuZCB3cmFwIHRoZW0gaW4gYnJhY2VzLgoKCQkJCXYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMAoJCQkJCQk/ICd7fScKCQkJCQkJOiBnYXAKCQkJCQkJPyAne1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKyAnXG4nICsgbWluZCArICd9JwoJCQkJCQk6ICd7JyArIHBhcnRpYWwuam9pbignLCcpICsgJ30nOwoJCQkJZ2FwID0gbWluZDsKCQkJCXJldHVybiB2OwoJCX0KCX0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKCWlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKCQlKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKCQkJdmFyIGk7CgkJCWdhcCA9ICcnOwoJCQlpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgoJCQlpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewoJCQkJZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKCQkJCQlpbmRlbnQgKz0gJyAnOwoJCQkJfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKCQkJfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CgkJCQlpbmRlbnQgPSBzcGFjZTsKCQkJfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKCQkJcmVwID0gcmVwbGFjZXI7CgkJCWlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKCQkJCQkodHlwZW9mIHJlcGxhY2VyICE9PSAnb2JqZWN0JyB8fAoJCQkJCQkJdHlwZW9mIHJlcGxhY2VyLmxlbmd0aCAhPT0gJ251bWJlcicpKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CgkJCX0KCi8vIE1ha2UgYSBmYWtlIHJvb3Qgb2JqZWN0IGNvbnRhaW5pbmcgb3VyIHZhbHVlIHVuZGVyIHRoZSBrZXkgb2YgJycuCi8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgoJCQlyZXR1cm4gc3RyKCcnLCB7Jyc6dmFsdWV9KTsKCQl9OwoJfQoKCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHBhcnNlIG1ldGhvZCwgZ2l2ZSBpdCBvbmUuCgoJaWYgKHR5cGVvZiBKU09OLnBhcnNlICE9PSAnZnVuY3Rpb24nKSB7CgkJSlNPTi5wYXJzZSA9IGZ1bmN0aW9uICh0ZXh0LCByZXZpdmVyKSB7CgovLyBUaGUgcGFyc2UgbWV0aG9kIHRha2VzIGEgdGV4dCBhbmQgYW4gb3B0aW9uYWwgcmV2aXZlciBmdW5jdGlvbiwgYW5kIHJldHVybnMKLy8gYSBKYXZhU2NyaXB0IHZhbHVlIGlmIHRoZSB0ZXh0IGlzIGEgdmFsaWQgSlNPTiB0ZXh0LgoKCQkJdmFyIGo7CgoJCQlmdW5jdGlvbiB3YWxrKGhvbGRlciwga2V5KSB7CgovLyBUaGUgd2FsayBtZXRob2QgaXMgdXNlZCB0byByZWN1cnNpdmVseSB3YWxrIHRoZSByZXN1bHRpbmcgc3RydWN0dXJlIHNvCi8vIHRoYXQgbW9kaWZpY2F0aW9ucyBjYW4gYmUgbWFkZS4KCgkJCQl2YXIgaywgdiwgdmFsdWUgPSBob2xkZXJba2V5XTsKCQkJCWlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CgkJCQkJZm9yIChrIGluIHZhbHVlKSB7CgkJCQkJCWlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CgkJCQkJCQl2ID0gd2Fsayh2YWx1ZSwgayk7CgkJCQkJCQlpZiAodiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCQkJdmFsdWVba10gPSB2OwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlkZWxldGUgdmFsdWVba107CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gcmV2aXZlci5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CgkJCX0KCgovLyBQYXJzaW5nIGhhcHBlbnMgaW4gZm91ciBzdGFnZXMuIEluIHRoZSBmaXJzdCBzdGFnZSwgd2UgcmVwbGFjZSBjZXJ0YWluCi8vIFVuaWNvZGUgY2hhcmFjdGVycyB3aXRoIGVzY2FwZSBzZXF1ZW5jZXMuIEphdmFTY3JpcHQgaGFuZGxlcyBtYW55IGNoYXJhY3RlcnMKLy8gaW5jb3JyZWN0bHksIGVpdGhlciBzaWxlbnRseSBkZWxldGluZyB0aGVtLCBvciB0cmVhdGluZyB0aGVtIGFzIGxpbmUgZW5kaW5ncy4KCgkJCXRleHQgPSBTdHJpbmcodGV4dCk7CgkJCWN4Lmxhc3RJbmRleCA9IDA7CgkJCWlmIChjeC50ZXN0KHRleHQpKSB7CgkJCQl0ZXh0ID0gdGV4dC5yZXBsYWNlKGN4LCBmdW5jdGlvbiAoYSkgewoJCQkJCXJldHVybiAnXFx1JyArCgkJCQkJCQkoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwoJCQkJfSk7CgkJCX0KCi8vIEluIHRoZSBzZWNvbmQgc3RhZ2UsIHdlIHJ1biB0aGUgdGV4dCBhZ2FpbnN0IHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rCi8vIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkgY29uY2VybmVkIHdpdGggJygpJyBhbmQgJ25ldycKLy8gYmVjYXVzZSB0aGV5IGNhbiBjYXVzZSBpbnZvY2F0aW9uLCBhbmQgJz0nIGJlY2F1c2UgaXQgY2FuIGNhdXNlIG11dGF0aW9uLgovLyBCdXQganVzdCB0byBiZSBzYWZlLCB3ZSB3YW50IHRvIHJlamVjdCBhbGwgdW5leHBlY3RlZCBmb3Jtcy4KCi8vIFdlIHNwbGl0IHRoZSBzZWNvbmQgc3RhZ2UgaW50byA0IHJlZ2V4cCBvcGVyYXRpb25zIGluIG9yZGVyIHRvIHdvcmsgYXJvdW5kCi8vIGNyaXBwbGluZyBpbmVmZmljaWVuY2llcyBpbiBJRSdzIGFuZCBTYWZhcmkncyByZWdleHAgZW5naW5lcy4gRmlyc3Qgd2UKLy8gcmVwbGFjZSB0aGUgSlNPTiBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQovLyByZXBsYWNlIGFsbCBzaW1wbGUgdmFsdWUgdG9rZW5zIHdpdGggJ10nIGNoYXJhY3RlcnMuIFRoaXJkLCB3ZSBkZWxldGUgYWxsCi8vIG9wZW4gYnJhY2tldHMgdGhhdCBmb2xsb3cgYSBjb2xvbiBvciBjb21tYSBvciB0aGF0IGJlZ2luIHRoZSB0ZXh0LiBGaW5hbGx5LAovLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgovLyAnLCcgb3IgJzonIG9yICd7JyBvciAnfScuIElmIHRoYXQgaXMgc28sIHRoZW4gdGhlIHRleHQgaXMgc2FmZSBmb3IgZXZhbC4KCgkJCWlmICgvXltcXSw6e31cc10qJC8KCQkJCQkudGVzdCh0ZXh0LnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKQoJCQkJCQkJCSAgLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAnXScpCgkJCQkJCQkJICAucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJykpKSB7CgovLyBJbiB0aGUgdGhpcmQgc3RhZ2Ugd2UgdXNlIHRoZSBldmFsIGZ1bmN0aW9uIHRvIGNvbXBpbGUgdGhlIHRleHQgaW50byBhCi8vIEphdmFTY3JpcHQgc3RydWN0dXJlLiBUaGUgJ3snIG9wZXJhdG9yIGlzIHN1YmplY3QgdG8gYSBzeW50YWN0aWMgYW1iaWd1aXR5Ci8vIGluIEphdmFTY3JpcHQ6IGl0IGNhbiBiZWdpbiBhIGJsb2NrIG9yIGFuIG9iamVjdCBsaXRlcmFsLiBXZSB3cmFwIHRoZSB0ZXh0Ci8vIGluIHBhcmVucyB0byBlbGltaW5hdGUgdGhlIGFtYmlndWl0eS4KCgkJCQlqID0gZXZhbCgnKCcgKyB0ZXh0ICsgJyknKTsKCi8vIEluIHRoZSBvcHRpb25hbCBmb3VydGggc3RhZ2UsIHdlIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIG5ldyBzdHJ1Y3R1cmUsIHBhc3NpbmcKLy8gZWFjaCBuYW1lL3ZhbHVlIHBhaXIgdG8gYSByZXZpdmVyIGZ1bmN0aW9uIGZvciBwb3NzaWJsZSB0cmFuc2Zvcm1hdGlvbi4KCgkJCQlyZXR1cm4gdHlwZW9mIHJldml2ZXIgPT09ICdmdW5jdGlvbicKCQkJCQkJPyB3YWxrKHsnJzpqfSwgJycpCgkJCQkJCTogajsKCQkJfQoKLy8gSWYgdGhlIHRleHQgaXMgbm90IEpTT04gcGFyc2VhYmxlLCB0aGVuIGEgU3ludGF4RXJyb3IgaXMgdGhyb3duLgoKCQkJdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKU09OLnBhcnNlJyk7CgkJfTsKCX0KfSgpKTsK",
                "body": "dGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9OwoKKGZ1bmN0aW9uKCkgewoJInVzZSBzdHJpY3QiOwoKCS8qKgoJICogU3RhdGljIGNsYXNzIGhvbGRpbmcgbGlicmFyeSBzcGVjaWZpYyBpbmZvcm1hdGlvbiBzdWNoIGFzIHRoZSB2ZXJzaW9uIGFuZCBidWlsZERhdGUgb2YKCSAqIHRoZSBsaWJyYXJ5LgoJICoKCSAqIFRoZSBvbGQgUHJlbG9hZEpTIGNsYXNzIGhhcyBiZWVuIHJlbmFtZWQgdG8gTG9hZFF1ZXVlLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBjbGFzcyBmb3IgaW5mb3JtYXRpb24gb24gbG9hZGluZyBmaWxlcy4KCSAqIEBjbGFzcyBQcmVsb2FkSlMKCSAqKi8KCXZhciBzID0gY3JlYXRlanMuUHJlbG9hZEpTID0gY3JlYXRlanMuUHJlbG9hZEpTIHx8IHt9OwoKCS8qKgoJICogVGhlIHZlcnNpb24gc3RyaW5nIGZvciB0aGlzIHJlbGVhc2UuCgkgKiBAcHJvcGVydHkgdmVyc2lvbgoJICogQHR5cGUgU3RyaW5nCgkgKiBAc3RhdGljCgkgKiovCglzLnZlcnNpb24gPSAvKnZlcnNpb24qLyJORVhUIjsgLy8gaW5qZWN0ZWQgYnkgYnVpbGQgcHJvY2VzcwoKCS8qKgoJICogVGhlIGJ1aWxkIGRhdGUgZm9yIHRoaXMgcmVsZWFzZSBpbiBVVEMgZm9ybWF0LgoJICogQHByb3BlcnR5IGJ1aWxkRGF0ZQoJICogQHR5cGUgU3RyaW5nCgkgKiBAc3RhdGljCgkgKiovCglzLmJ1aWxkRGF0ZSA9IC8qZGF0ZSovIldlZCwgMjIgT2N0IDIwMTQgMTY6MTE6MzUgR01UIjsgLy8gaW5qZWN0ZWQgYnkgYnVpbGQgcHJvY2VzcwoKfSkoKTsKLyoKKiBFdmVudAoqIFZpc2l0IGh0dHA6Ly9jcmVhdGVqcy5jb20vIGZvciBkb2N1bWVudGF0aW9uLCB1cGRhdGVzIGFuZCBleGFtcGxlcy4KKgoqIENvcHlyaWdodCAoYykgMjAxMCBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgovKioKICogQSBjb2xsZWN0aW9uIG9mIENsYXNzZXMgdGhhdCBhcmUgc2hhcmVkIGFjcm9zcyBhbGwgdGhlIENyZWF0ZUpTIGxpYnJhcmllcy4gIFRoZSBjbGFzc2VzIGFyZSBpbmNsdWRlZCBpbiB0aGUgbWluaWZpZWQKICogZmlsZXMgb2YgZWFjaCBsaWJyYXJ5IGFuZCBhcmUgYXZhaWxhYmxlIG9uIHRoZSBjcmVhdGVzanMgbmFtZXNwYWNlIGRpcmVjdGx5LgogKgogKiA8aDQ+RXhhbXBsZTwvaDQ+CiAqICAgICAgbXlPYmplY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgY3JlYXRlanMucHJveHkobXlNZXRob2QsIHNjb3BlKSk7CiAqCiAqIEBtb2R1bGUgQ3JlYXRlSlMKICogQG1haW4gQ3JlYXRlSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzfHx7fTsKCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCi8qKgogKiBDb250YWlucyBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzIHNoYXJlZCBieSBhbGwgZXZlbnRzIGZvciB1c2Ugd2l0aAogKiB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlciJ9fXt7L2Nyb3NzTGlua319LgogKgogKiBOb3RlIHRoYXQgRXZlbnQgb2JqZWN0cyBhcmUgb2Z0ZW4gcmV1c2VkLCBzbyB5b3Ugc2hvdWxkIG5ldmVyCiAqIHJlbHkgb24gYW4gZXZlbnQgb2JqZWN0J3Mgc3RhdGUgb3V0c2lkZSBvZiB0aGUgY2FsbCBzdGFjayBpdCB3YXMgcmVjZWl2ZWQgaW4uCiAqIEBjbGFzcyBFdmVudAogKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KICogQHBhcmFtIHtCb29sZWFufSBidWJibGVzIEluZGljYXRlcyB3aGV0aGVyIHRoZSBldmVudCB3aWxsIGJ1YmJsZSB0aHJvdWdoIHRoZSBkaXNwbGF5IGxpc3QuCiAqIEBwYXJhbSB7Qm9vbGVhbn0gY2FuY2VsYWJsZSBJbmRpY2F0ZXMgd2hldGhlciB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgb2YgdGhpcyBldmVudCBjYW4gYmUgY2FuY2VsbGVkLgogKiBAY29uc3RydWN0b3IKICoqLwp2YXIgRXZlbnQgPSBmdW5jdGlvbih0eXBlLCBidWJibGVzLCBjYW5jZWxhYmxlKSB7CiAgdGhpcy5pbml0aWFsaXplKHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpOwp9Owp2YXIgcCA9IEV2ZW50LnByb3RvdHlwZTsKRXZlbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRXZlbnQ7CgovLyBldmVudHM6CgovLyBwdWJsaWMgcHJvcGVydGllczoKCgkvKioKCSAqIFRoZSB0eXBlIG9mIGV2ZW50LgoJICogQHByb3BlcnR5IHR5cGUKCSAqIEB0eXBlIFN0cmluZwoJICoqLwoJcC50eXBlID0gbnVsbDsKCgkvKioKCSAqIFRoZSBvYmplY3QgdGhhdCBnZW5lcmF0ZWQgYW4gZXZlbnQuCgkgKiBAcHJvcGVydHkgdGFyZ2V0CgkgKiBAdHlwZSBPYmplY3QKCSAqIEBkZWZhdWx0IG51bGwKCSAqIEByZWFkb25seQoJKi8KCXAudGFyZ2V0ID0gbnVsbDsKCgkvKioKCSAqIFRoZSBjdXJyZW50IHRhcmdldCB0aGF0IGEgYnViYmxpbmcgZXZlbnQgaXMgYmVpbmcgZGlzcGF0Y2hlZCBmcm9tLiBGb3Igbm9uLWJ1YmJsaW5nIGV2ZW50cywgdGhpcyB3aWxsCgkgKiBhbHdheXMgYmUgdGhlIHNhbWUgYXMgdGFyZ2V0LiBGb3IgZXhhbXBsZSwgaWYgY2hpbGRPYmoucGFyZW50ID0gcGFyZW50T2JqLCBhbmQgYSBidWJibGluZyBldmVudAoJICogaXMgZ2VuZXJhdGVkIGZyb20gY2hpbGRPYmosIHRoZW4gYSBsaXN0ZW5lciBvbiBwYXJlbnRPYmogd291bGQgcmVjZWl2ZSB0aGUgZXZlbnQgd2l0aAoJICogdGFyZ2V0PWNoaWxkT2JqICh0aGUgb3JpZ2luYWwgdGFyZ2V0KSBhbmQgY3VycmVudFRhcmdldD1wYXJlbnRPYmogKHdoZXJlIHRoZSBsaXN0ZW5lciB3YXMgYWRkZWQpLgoJICogQHByb3BlcnR5IGN1cnJlbnRUYXJnZXQKCSAqIEB0eXBlIE9iamVjdAoJICogQGRlZmF1bHQgbnVsbAoJICogQHJlYWRvbmx5CgkqLwoJcC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKCgkvKioKCSAqIEZvciBidWJibGluZyBldmVudHMsIHRoaXMgaW5kaWNhdGVzIHRoZSBjdXJyZW50IGV2ZW50IHBoYXNlOjxPTD4KCSAqIAk8TEk+IGNhcHR1cmUgcGhhc2U6IHN0YXJ0aW5nIGZyb20gdGhlIHRvcCBwYXJlbnQgdG8gdGhlIHRhcmdldDwvTEk+CgkgKiAJPExJPiBhdCB0YXJnZXQgcGhhc2U6IGN1cnJlbnRseSBiZWluZyBkaXNwYXRjaGVkIGZyb20gdGhlIHRhcmdldDwvTEk+CgkgKiAJPExJPiBidWJibGluZyBwaGFzZTogZnJvbSB0aGUgdGFyZ2V0IHRvIHRoZSB0b3AgcGFyZW50PC9MST4KCSAqIDwvT0w+CgkgKiBAcHJvcGVydHkgZXZlbnRQaGFzZQoJICogQHR5cGUgTnVtYmVyCgkgKiBAZGVmYXVsdCAwCgkgKiBAcmVhZG9ubHkKCSovCglwLmV2ZW50UGhhc2UgPSAwOwoKCS8qKgoJICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGV2ZW50IHdpbGwgYnViYmxlIHRocm91Z2ggdGhlIGRpc3BsYXkgbGlzdC4KCSAqIEBwcm9wZXJ0eSBidWJibGVzCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHJlYWRvbmx5CgkqLwoJcC5idWJibGVzID0gZmFsc2U7CgoJLyoqCgkgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgb2YgdGhpcyBldmVudCBjYW4gYmUgY2FuY2VsbGVkIHZpYQoJICoge3sjY3Jvc3NMaW5rICJFdmVudC9wcmV2ZW50RGVmYXVsdCJ9fXt7L2Nyb3NzTGlua319LiBUaGlzIGlzIHNldCB2aWEgdGhlIEV2ZW50IGNvbnN0cnVjdG9yLgoJICogQHByb3BlcnR5IGNhbmNlbGFibGUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLmNhbmNlbGFibGUgPSBmYWxzZTsKCgkvKioKCSAqIFRoZSBlcG9jaCB0aW1lIGF0IHdoaWNoIHRoaXMgZXZlbnQgd2FzIGNyZWF0ZWQuCgkgKiBAcHJvcGVydHkgdGltZVN0YW1wCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqIEByZWFkb25seQoJKi8KCXAudGltZVN0YW1wID0gMDsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3ByZXZlbnREZWZhdWx0In19e3svY3Jvc3NMaW5rfX0gaGFzIGJlZW4gY2FsbGVkCgkgKiBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IGRlZmF1bHRQcmV2ZW50ZWQKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3N0b3BQcm9wYWdhdGlvbiJ9fXt7L2Nyb3NzTGlua319IG9yCgkgKiB7eyNjcm9zc0xpbmsgIkV2ZW50L3N0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiJ9fXt7L2Nyb3NzTGlua319IGhhcyBiZWVuIGNhbGxlZCBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IHByb3BhZ2F0aW9uU3RvcHBlZAoJICogQHR5cGUgQm9vbGVhbgoJICogQGRlZmF1bHQgZmFsc2UKCSAqIEByZWFkb25seQoJKi8KCXAucHJvcGFnYXRpb25TdG9wcGVkID0gZmFsc2U7CgoJLyoqCgkgKiBJbmRpY2F0ZXMgaWYge3sjY3Jvc3NMaW5rICJFdmVudC9zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24ifX17ey9jcm9zc0xpbmt9fSBoYXMgYmVlbiBjYWxsZWQKCSAqIG9uIHRoaXMgZXZlbnQuCgkgKiBAcHJvcGVydHkgaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHJlYWRvbmx5CgkqLwoJcC5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSBmYWxzZTsKCgkvKioKCSAqIEluZGljYXRlcyBpZiB7eyNjcm9zc0xpbmsgIkV2ZW50L3JlbW92ZSJ9fXt7L2Nyb3NzTGlua319IGhhcyBiZWVuIGNhbGxlZCBvbiB0aGlzIGV2ZW50LgoJICogQHByb3BlcnR5IHJlbW92ZWQKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKiBAcmVhZG9ubHkKCSovCglwLnJlbW92ZWQgPSBmYWxzZTsKCi8vIGNvbnN0cnVjdG9yOgoJLyoqCgkgKiBJbml0aWFsaXphdGlvbiBtZXRob2QuCgkgKiBAbWV0aG9kIGluaXRpYWxpemUKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtCb29sZWFufSBidWJibGVzIEluZGljYXRlcyB3aGV0aGVyIHRoZSBldmVudCB3aWxsIGJ1YmJsZSB0aHJvdWdoIHRoZSBkaXNwbGF5IGxpc3QuCgkgKiBAcGFyYW0ge0Jvb2xlYW59IGNhbmNlbGFibGUgSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGRlZmF1bHQgYmVoYXZpb3VyIG9mIHRoaXMgZXZlbnQgY2FuIGJlIGNhbmNlbGxlZC4KCSAqIEBwcm90ZWN0ZWQKCSAqKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHR5cGUsIGJ1YmJsZXMsIGNhbmNlbGFibGUpIHsKCQl0aGlzLnR5cGUgPSB0eXBlOwoJCXRoaXMuYnViYmxlcyA9IGJ1YmJsZXM7CgkJdGhpcy5jYW5jZWxhYmxlID0gY2FuY2VsYWJsZTsKCQl0aGlzLnRpbWVTdGFtcCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7Cgl9OwoKLy8gcHVibGljIG1ldGhvZHM6CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvZGVmYXVsdFByZXZlbnRlZCJ9fXt7L2Nyb3NzTGlua319IHRvIHRydWUuCgkgKiBNaXJyb3JzIHRoZSBET00gZXZlbnQgc3RhbmRhcmQuCgkgKiBAbWV0aG9kIHByZXZlbnREZWZhdWx0CgkgKiovCglwLnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvcHJvcGFnYXRpb25TdG9wcGVkIn19e3svY3Jvc3NMaW5rfX0gdG8gdHJ1ZS4KCSAqIE1pcnJvcnMgdGhlIERPTSBldmVudCBzdGFuZGFyZC4KCSAqIEBtZXRob2Qgc3RvcFByb3BhZ2F0aW9uCgkgKiovCglwLnN0b3BQcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMucHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBTZXRzIHt7I2Nyb3NzTGluayAiRXZlbnQvcHJvcGFnYXRpb25TdG9wcGVkIn19e3svY3Jvc3NMaW5rfX0gYW5kCgkgKiB7eyNjcm9zc0xpbmsgIkV2ZW50L2ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCJ9fXt7L2Nyb3NzTGlua319IHRvIHRydWUuCgkgKiBNaXJyb3JzIHRoZSBET00gZXZlbnQgc3RhbmRhcmQuCgkgKiBAbWV0aG9kIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbgoJICoqLwoJcC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHRoaXMucHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsKCX07CgoJLyoqCgkgKiBDYXVzZXMgdGhlIGFjdGl2ZSBsaXN0ZW5lciB0byBiZSByZW1vdmVkIHZpYSByZW1vdmVFdmVudExpc3RlbmVyKCk7CgkgKgoJICogCQlteUJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uKGV2dCkgewoJICogCQkJLy8gZG8gc3R1ZmYuLi4KCSAqIAkJCWV2dC5yZW1vdmUoKTsgLy8gcmVtb3ZlcyB0aGlzIGxpc3RlbmVyLgoJICogCQl9KTsKCSAqCgkgKiBAbWV0aG9kIHJlbW92ZQoJICoqLwoJcC5yZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl0aGlzLnJlbW92ZWQgPSB0cnVlOwoJfTsKCgkvKioKCSAqIFJldHVybnMgYSBjbG9uZSBvZiB0aGUgRXZlbnQgaW5zdGFuY2UuCgkgKiBAbWV0aG9kIGNsb25lCgkgKiBAcmV0dXJuIHtFdmVudH0gYSBjbG9uZSBvZiB0aGUgRXZlbnQgaW5zdGFuY2UuCgkgKiovCglwLmNsb25lID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIG5ldyBFdmVudCh0aGlzLnR5cGUsIHRoaXMuYnViYmxlcywgdGhpcy5jYW5jZWxhYmxlKTsKCX07CgoJLyoqCgkgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgoJICogQG1ldGhvZCB0b1N0cmluZwoJICogQHJldHVybiB7U3RyaW5nfSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCgkgKiovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICJbRXZlbnQgKHR5cGU9Iit0aGlzLnR5cGUrIildIjsKCX07CgpjcmVhdGVqcy5FdmVudCA9IEV2ZW50Owp9KCkpOwovKg0KKiBFdmVudERpc3BhdGNoZXINCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLg0KKg0KKiBDb3B5cmlnaHQgKGMpIDIwMTAgZ3NraW5uZXIuY29tLCBpbmMuDQoqDQoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uDQoqIG9idGFpbmluZyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uDQoqIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQNCiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsDQoqIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQoqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZQ0KKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZw0KKiBjb25kaXRpb25zOg0KKg0KKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQ0KKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4NCioNCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsDQoqIEVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUw0KKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORA0KKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVA0KKiBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwNCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HDQoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1INCiogT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLg0KKi8NCg0KLyoqDQogKiBAbW9kdWxlIENyZWF0ZUpTDQogKi8NCg0KLy8gbmFtZXNwYWNlOg0KdGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9Ow0KDQooZnVuY3Rpb24oKSB7DQoJInVzZSBzdHJpY3QiOw0KDQovKioNCiAqIEV2ZW50RGlzcGF0Y2hlciBwcm92aWRlcyBtZXRob2RzIGZvciBtYW5hZ2luZyBxdWV1ZXMgb2YgZXZlbnQgbGlzdGVuZXJzIGFuZCBkaXNwYXRjaGluZyBldmVudHMuDQogKg0KICogWW91IGNhbiBlaXRoZXIgZXh0ZW5kIEV2ZW50RGlzcGF0Y2hlciBvciBtaXggaXRzIG1ldGhvZHMgaW50byBhbiBleGlzdGluZyBwcm90b3R5cGUgb3IgaW5zdGFuY2UgYnkgdXNpbmcgdGhlDQogKiBFdmVudERpc3BhdGNoZXIge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvaW5pdGlhbGl6ZSJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4NCiAqIA0KICogVG9nZXRoZXIgd2l0aCB0aGUgQ3JlYXRlSlMgRXZlbnQgY2xhc3MsIEV2ZW50RGlzcGF0Y2hlciBwcm92aWRlcyBhbiBleHRlbmRlZCBldmVudCBtb2RlbCB0aGF0IGlzIGJhc2VkIG9uIHRoZQ0KICogRE9NIExldmVsIDIgZXZlbnQgbW9kZWwsIGluY2x1ZGluZyBhZGRFdmVudExpc3RlbmVyLCByZW1vdmVFdmVudExpc3RlbmVyLCBhbmQgZGlzcGF0Y2hFdmVudC4gSXQgc3VwcG9ydHMNCiAqIGJ1YmJsaW5nIC8gY2FwdHVyZSwgcHJldmVudERlZmF1bHQsIHN0b3BQcm9wYWdhdGlvbiwgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uLCBhbmQgaGFuZGxlRXZlbnQuDQogKiANCiAqIEV2ZW50RGlzcGF0Y2hlciBhbHNvIGV4cG9zZXMgYSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9vbiJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCwgd2hpY2ggbWFrZXMgaXQgZWFzaWVyDQogKiB0byBjcmVhdGUgc2NvcGVkIGxpc3RlbmVycywgbGlzdGVuZXJzIHRoYXQgb25seSBydW4gb25jZSwgYW5kIGxpc3RlbmVycyB3aXRoIGFzc29jaWF0ZWQgYXJiaXRyYXJ5IGRhdGEuIFRoZSANCiAqIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL29mZiJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCBpcyBtZXJlbHkgYW4gYWxpYXMgdG8NCiAqIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL3JlbW92ZUV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fS4NCiAqIA0KICogQW5vdGhlciBhZGRpdGlvbiB0byB0aGUgRE9NIExldmVsIDIgbW9kZWwgaXMgdGhlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL3JlbW92ZUFsbEV2ZW50TGlzdGVuZXJzIn19e3svY3Jvc3NMaW5rfX0NCiAqIG1ldGhvZCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gbGlzdGVuZXJzIGZvciBhbGwgZXZlbnRzLCBvciBsaXN0ZW5lcnMgZm9yIGEgc3BlY2lmaWMgZXZlbnQuIFRoZSBFdmVudCBvYmplY3QgYWxzbyANCiAqIGluY2x1ZGVzIGEge3sjY3Jvc3NMaW5rICJFdmVudC9yZW1vdmUifX17ey9jcm9zc0xpbmt9fSBtZXRob2Qgd2hpY2ggcmVtb3ZlcyB0aGUgYWN0aXZlIGxpc3RlbmVyLg0KICoNCiAqIDxoND5FeGFtcGxlPC9oND4NCiAqIEFkZCBFdmVudERpc3BhdGNoZXIgY2FwYWJpbGl0aWVzIHRvIHRoZSAiTXlDbGFzcyIgY2xhc3MuDQogKg0KICogICAgICBFdmVudERpc3BhdGNoZXIuaW5pdGlhbGl6ZShNeUNsYXNzLnByb3RvdHlwZSk7DQogKg0KICogQWRkIGFuIGV2ZW50IChzZWUge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319KS4NCiAqDQogKiAgICAgIGluc3RhbmNlLmFkZEV2ZW50TGlzdGVuZXIoImV2ZW50TmFtZSIsIGhhbmRsZXJNZXRob2QpOw0KICogICAgICBmdW5jdGlvbiBoYW5kbGVyTWV0aG9kKGV2ZW50KSB7DQogKiAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC50YXJnZXQgKyAiIFdhcyBDbGlja2VkIik7DQogKiAgICAgIH0NCiAqDQogKiA8Yj5NYWludGFpbmluZyBwcm9wZXIgc2NvcGU8L2I+PGJyIC8+DQogKiBTY29wZSAoaWUuICJ0aGlzIikgY2FuIGJlIGJlIGEgY2hhbGxlbmdlIHdpdGggZXZlbnRzLiBVc2luZyB0aGUge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvb24ifX17ey9jcm9zc0xpbmt9fQ0KICogbWV0aG9kIHRvIHN1YnNjcmliZSB0byBldmVudHMgc2ltcGxpZmllcyB0aGlzLg0KICoNCiAqICAgICAgaW5zdGFuY2UuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbihldmVudCkgew0KICogICAgICAgICAgY29uc29sZS5sb2coaW5zdGFuY2UgPT0gdGhpcyk7IC8vIGZhbHNlLCBzY29wZSBpcyBhbWJpZ3VvdXMuDQogKiAgICAgIH0pOw0KICogICAgICANCiAqICAgICAgaW5zdGFuY2Uub24oImNsaWNrIiwgZnVuY3Rpb24oZXZlbnQpIHsNCiAqICAgICAgICAgIGNvbnNvbGUubG9nKGluc3RhbmNlID09IHRoaXMpOyAvLyB0cnVlLCAib24iIHVzZXMgZGlzcGF0Y2hlciBzY29wZSBieSBkZWZhdWx0Lg0KICogICAgICB9KTsNCiAqIA0KICogSWYgeW91IHdhbnQgdG8gdXNlIGFkZEV2ZW50TGlzdGVuZXIgaW5zdGVhZCwgeW91IG1heSB3YW50IHRvIHVzZSBmdW5jdGlvbi5iaW5kKCkgb3IgYSBzaW1pbGFyIHByb3h5IHRvIG1hbmFnZSBzY29wZS4NCiAqICAgICAgDQogKg0KICogQGNsYXNzIEV2ZW50RGlzcGF0Y2hlcg0KICogQGNvbnN0cnVjdG9yDQogKiovDQp2YXIgRXZlbnREaXNwYXRjaGVyID0gZnVuY3Rpb24oKSB7DQovKgl0aGlzLmluaXRpYWxpemUoKTsgKi8gLy8gbm90IG5lZWRlZC4NCn07DQp2YXIgcCA9IEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGU7DQpFdmVudERpc3BhdGNoZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRXZlbnREaXNwYXRjaGVyOw0KDQoNCgkvKioNCgkgKiBTdGF0aWMgaW5pdGlhbGl6ZXIgdG8gbWl4IEV2ZW50RGlzcGF0Y2hlciBtZXRob2RzIGludG8gYSB0YXJnZXQgb2JqZWN0IG9yIHByb3RvdHlwZS4NCgkgKiANCgkgKiAJCUV2ZW50RGlzcGF0Y2hlci5pbml0aWFsaXplKE15Q2xhc3MucHJvdG90eXBlKTsgLy8gYWRkIHRvIHRoZSBwcm90b3R5cGUgb2YgdGhlIGNsYXNzDQoJICogCQlFdmVudERpc3BhdGNoZXIuaW5pdGlhbGl6ZShteU9iamVjdCk7IC8vIGFkZCB0byBhIHNwZWNpZmljIGluc3RhbmNlDQoJICogDQoJICogQG1ldGhvZCBpbml0aWFsaXplDQoJICogQHN0YXRpYw0KCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvYmplY3QgdG8gaW5qZWN0IEV2ZW50RGlzcGF0Y2hlciBtZXRob2RzIGludG8uIFRoaXMgY2FuIGJlIGFuIGluc3RhbmNlIG9yIGENCgkgKiBwcm90b3R5cGUuDQoJICoqLw0KCUV2ZW50RGlzcGF0Y2hlci5pbml0aWFsaXplID0gZnVuY3Rpb24odGFyZ2V0KSB7DQoJCXRhcmdldC5hZGRFdmVudExpc3RlbmVyID0gcC5hZGRFdmVudExpc3RlbmVyOw0KCQl0YXJnZXQub24gPSBwLm9uOw0KCQl0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHRhcmdldC5vZmYgPSAgcC5yZW1vdmVFdmVudExpc3RlbmVyOw0KCQl0YXJnZXQucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMgPSBwLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzOw0KCQl0YXJnZXQuaGFzRXZlbnRMaXN0ZW5lciA9IHAuaGFzRXZlbnRMaXN0ZW5lcjsNCgkJdGFyZ2V0LmRpc3BhdGNoRXZlbnQgPSBwLmRpc3BhdGNoRXZlbnQ7DQoJCXRhcmdldC5fZGlzcGF0Y2hFdmVudCA9IHAuX2Rpc3BhdGNoRXZlbnQ7DQoJCXRhcmdldC53aWxsVHJpZ2dlciA9IHAud2lsbFRyaWdnZXI7DQoJfTsNCgkNCi8vIGNvbnN0cnVjdG9yOg0KDQovLyBwcml2YXRlIHByb3BlcnRpZXM6DQoJLyoqDQoJICogQHByb3RlY3RlZA0KCSAqIEBwcm9wZXJ0eSBfbGlzdGVuZXJzDQoJICogQHR5cGUgT2JqZWN0DQoJICoqLw0KCXAuX2xpc3RlbmVycyA9IG51bGw7DQoNCgkvKioNCgkgKiBAcHJvdGVjdGVkDQoJICogQHByb3BlcnR5IF9jYXB0dXJlTGlzdGVuZXJzDQoJICogQHR5cGUgT2JqZWN0DQoJICoqLw0KCXAuX2NhcHR1cmVMaXN0ZW5lcnMgPSBudWxsOw0KDQovLyBjb25zdHJ1Y3RvcjoNCgkvKioNCgkgKiBJbml0aWFsaXphdGlvbiBtZXRob2QuDQoJICogQG1ldGhvZCBpbml0aWFsaXplDQoJICogQHByb3RlY3RlZA0KCSAqKi8NCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHt9Ow0KDQovLyBwdWJsaWMgbWV0aG9kczoNCgkvKioNCgkgKiBBZGRzIHRoZSBzcGVjaWZpZWQgZXZlbnQgbGlzdGVuZXIuIE5vdGUgdGhhdCBhZGRpbmcgbXVsdGlwbGUgbGlzdGVuZXJzIHRvIHRoZSBzYW1lIGZ1bmN0aW9uIHdpbGwgcmVzdWx0IGluDQoJICogbXVsdGlwbGUgY2FsbGJhY2tzIGdldHRpbmcgZmlyZWQuDQoJICoNCgkgKiA8aDQ+RXhhbXBsZTwvaDQ+DQoJICoNCgkgKiAgICAgIGRpc3BsYXlPYmplY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBoYW5kbGVDbGljayk7DQoJICogICAgICBmdW5jdGlvbiBoYW5kbGVDbGljayhldmVudCkgew0KCSAqICAgICAgICAgLy8gQ2xpY2sgaGFwcGVuZWQuDQoJICogICAgICB9DQoJICoNCgkgKiBAbWV0aG9kIGFkZEV2ZW50TGlzdGVuZXINCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEBwYXJhbSB7RnVuY3Rpb24gfCBPYmplY3R9IGxpc3RlbmVyIEFuIG9iamVjdCB3aXRoIGEgaGFuZGxlRXZlbnQgbWV0aG9kLCBvciBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbg0KCSAqIHRoZSBldmVudCBpcyBkaXNwYXRjaGVkLg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmVdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiBAcmV0dXJuIHtGdW5jdGlvbiB8IE9iamVjdH0gUmV0dXJucyB0aGUgbGlzdGVuZXIgZm9yIGNoYWluaW5nIG9yIGFzc2lnbm1lbnQuDQoJICoqLw0KCXAuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlKSB7DQoJCXZhciBsaXN0ZW5lcnM7DQoJCWlmICh1c2VDYXB0dXJlKSB7DQoJCQlsaXN0ZW5lcnMgPSB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzID0gdGhpcy5fY2FwdHVyZUxpc3RlbmVyc3x8e307DQoJCX0gZWxzZSB7DQoJCQlsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnN8fHt9Ow0KCQl9DQoJCXZhciBhcnIgPSBsaXN0ZW5lcnNbdHlwZV07DQoJCWlmIChhcnIpIHsgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlKTsgfQ0KCQlhcnIgPSBsaXN0ZW5lcnNbdHlwZV07IC8vIHJlbW92ZSBtYXkgaGF2ZSBkZWxldGVkIHRoZSBhcnJheQ0KCQlpZiAoIWFycikgeyBsaXN0ZW5lcnNbdHlwZV0gPSBbbGlzdGVuZXJdOyAgfQ0KCQllbHNlIHsgYXJyLnB1c2gobGlzdGVuZXIpOyB9DQoJCXJldHVybiBsaXN0ZW5lcjsNCgl9Ow0KCQ0KCS8qKg0KCSAqIEEgc2hvcnRjdXQgbWV0aG9kIGZvciB1c2luZyBhZGRFdmVudExpc3RlbmVyIHRoYXQgbWFrZXMgaXQgZWFzaWVyIHRvIHNwZWNpZnkgYW4gZXhlY3V0aW9uIHNjb3BlLCBoYXZlIGEgbGlzdGVuZXINCgkgKiBvbmx5IHJ1biBvbmNlLCBhc3NvY2lhdGUgYXJiaXRyYXJ5IGRhdGEgd2l0aCB0aGUgbGlzdGVuZXIsIGFuZCByZW1vdmUgdGhlIGxpc3RlbmVyLg0KCSAqIA0KCSAqIFRoaXMgbWV0aG9kIHdvcmtzIGJ5IGNyZWF0aW5nIGFuIGFub255bW91cyB3cmFwcGVyIGZ1bmN0aW9uIGFuZCBzdWJzY3JpYmluZyBpdCB3aXRoIGFkZEV2ZW50TGlzdGVuZXIuDQoJICogVGhlIGNyZWF0ZWQgYW5vbnltb3VzIGZ1bmN0aW9uIGlzIHJldHVybmVkIGZvciB1c2Ugd2l0aCAucmVtb3ZlRXZlbnRMaXN0ZW5lciAob3IgLm9mZikuDQoJICogDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqIA0KCSAqIAkJdmFyIGxpc3RlbmVyID0gbXlCdG4ub24oImNsaWNrIiwgaGFuZGxlQ2xpY2ssIG51bGwsIGZhbHNlLCB7Y291bnQ6M30pOw0KCSAqIAkJZnVuY3Rpb24gaGFuZGxlQ2xpY2soZXZ0LCBkYXRhKSB7DQoJICogCQkJZGF0YS5jb3VudCAtPSAxOw0KCSAqIAkJCWNvbnNvbGUubG9nKHRoaXMgPT0gbXlCdG4pOyAvLyB0cnVlIC0gc2NvcGUgZGVmYXVsdHMgdG8gdGhlIGRpc3BhdGNoZXINCgkgKiAJCQlpZiAoZGF0YS5jb3VudCA9PSAwKSB7DQoJICogCQkJCWFsZXJ0KCJjbGlja2VkIDMgdGltZXMhIik7DQoJICogCQkJCW15QnRuLm9mZigiY2xpY2siLCBsaXN0ZW5lcik7DQoJICogCQkJCS8vIGFsdGVybmF0ZWx5OiBldnQucmVtb3ZlKCk7DQoJICogCQkJfQ0KCSAqIAkJfQ0KCSAqIA0KCSAqIEBtZXRob2Qgb24NCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEBwYXJhbSB7RnVuY3Rpb24gfCBPYmplY3R9IGxpc3RlbmVyIEFuIG9iamVjdCB3aXRoIGEgaGFuZGxlRXZlbnQgbWV0aG9kLCBvciBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbg0KCSAqIHRoZSBldmVudCBpcyBkaXNwYXRjaGVkLg0KCSAqIEBwYXJhbSB7T2JqZWN0fSBbc2NvcGVdIFRoZSBzY29wZSB0byBleGVjdXRlIHRoZSBsaXN0ZW5lciBpbi4gRGVmYXVsdHMgdG8gdGhlIGRpc3BhdGNoZXIvY3VycmVudFRhcmdldCBmb3IgZnVuY3Rpb24gbGlzdGVuZXJzLCBhbmQgdG8gdGhlIGxpc3RlbmVyIGl0c2VsZiBmb3Igb2JqZWN0IGxpc3RlbmVycyAoaWUuIHVzaW5nIGhhbmRsZUV2ZW50KS4NCgkgKiBAcGFyYW0ge0Jvb2xlYW59IFtvbmNlPWZhbHNlXSBJZiB0cnVlLCB0aGUgbGlzdGVuZXIgd2lsbCByZW1vdmUgaXRzZWxmIGFmdGVyIHRoZSBmaXJzdCB0aW1lIGl0IGlzIHRyaWdnZXJlZC4NCgkgKiBAcGFyYW0geyp9IFtkYXRhXSBBcmJpdHJhcnkgZGF0YSB0aGF0IHdpbGwgYmUgaW5jbHVkZWQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgd2hlbiB0aGUgbGlzdGVuZXIgaXMgY2FsbGVkLg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmU9ZmFsc2VdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYW5vbnltb3VzIGZ1bmN0aW9uIHRoYXQgd2FzIGNyZWF0ZWQgYW5kIGFzc2lnbmVkIGFzIHRoZSBsaXN0ZW5lci4gVGhpcyBpcyBuZWVkZWQgdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lciBsYXRlciB1c2luZyAucmVtb3ZlRXZlbnRMaXN0ZW5lci4NCgkgKiovDQoJcC5vbiA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyLCBzY29wZSwgb25jZSwgZGF0YSwgdXNlQ2FwdHVyZSkgew0KCQlpZiAobGlzdGVuZXIuaGFuZGxlRXZlbnQpIHsNCgkJCXNjb3BlID0gc2NvcGV8fGxpc3RlbmVyOw0KCQkJbGlzdGVuZXIgPSBsaXN0ZW5lci5oYW5kbGVFdmVudDsNCgkJfQ0KCQlzY29wZSA9IHNjb3BlfHx0aGlzOw0KCQlyZXR1cm4gdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKGV2dCkgew0KCQkJCWxpc3RlbmVyLmNhbGwoc2NvcGUsIGV2dCwgZGF0YSk7DQoJCQkJb25jZSYmZXZ0LnJlbW92ZSgpOw0KCQkJfSwgdXNlQ2FwdHVyZSk7DQoJfTsNCg0KCS8qKg0KCSAqIFJlbW92ZXMgdGhlIHNwZWNpZmllZCBldmVudCBsaXN0ZW5lci4NCgkgKg0KCSAqIDxiPkltcG9ydGFudCBOb3RlOjwvYj4gdGhhdCB5b3UgbXVzdCBwYXNzIHRoZSBleGFjdCBmdW5jdGlvbiByZWZlcmVuY2UgdXNlZCB3aGVuIHRoZSBldmVudCB3YXMgYWRkZWQuIElmIGEgcHJveHkNCgkgKiBmdW5jdGlvbiwgb3IgZnVuY3Rpb24gY2xvc3VyZSBpcyB1c2VkIGFzIHRoZSBjYWxsYmFjaywgdGhlIHByb3h5L2Nsb3N1cmUgcmVmZXJlbmNlIG11c3QgYmUgdXNlZCAtIGEgbmV3IHByb3h5IG9yDQoJICogY2xvc3VyZSB3aWxsIG5vdCB3b3JrLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICBkaXNwbGF5T2JqZWN0LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgaGFuZGxlQ2xpY2spOw0KCSAqDQoJICogQG1ldGhvZCByZW1vdmVFdmVudExpc3RlbmVyDQoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHN0cmluZyB0eXBlIG9mIHRoZSBldmVudC4NCgkgKiBAcGFyYW0ge0Z1bmN0aW9uIHwgT2JqZWN0fSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIgZnVuY3Rpb24gb3Igb2JqZWN0Lg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZUNhcHR1cmVdIEZvciBldmVudHMgdGhhdCBidWJibGUsIGluZGljYXRlcyB3aGV0aGVyIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGluIHRoZSBjYXB0dXJlIG9yIGJ1YmJsaW5nL3RhcmdldCBwaGFzZS4NCgkgKiovDQoJcC5yZW1vdmVFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIsIHVzZUNhcHR1cmUpIHsNCgkJdmFyIGxpc3RlbmVycyA9IHVzZUNhcHR1cmUgPyB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzIDogdGhpcy5fbGlzdGVuZXJzOw0KCQlpZiAoIWxpc3RlbmVycykgeyByZXR1cm47IH0NCgkJdmFyIGFyciA9IGxpc3RlbmVyc1t0eXBlXTsNCgkJaWYgKCFhcnIpIHsgcmV0dXJuOyB9DQoJCWZvciAodmFyIGk9MCxsPWFyci5sZW5ndGg7IGk8bDsgaSsrKSB7DQoJCQlpZiAoYXJyW2ldID09IGxpc3RlbmVyKSB7DQoJCQkJaWYgKGw9PTEpIHsgZGVsZXRlKGxpc3RlbmVyc1t0eXBlXSk7IH0gLy8gYWxsb3dzIGZvciBmYXN0ZXIgY2hlY2tzLg0KCQkJCWVsc2UgeyBhcnIuc3BsaWNlKGksMSk7IH0NCgkJCQlicmVhazsNCgkJCX0NCgkJfQ0KCX07DQoJDQoJLyoqDQoJICogQSBzaG9ydGN1dCB0byB0aGUgcmVtb3ZlRXZlbnRMaXN0ZW5lciBtZXRob2QsIHdpdGggdGhlIHNhbWUgcGFyYW1ldGVycyBhbmQgcmV0dXJuIHZhbHVlLiBUaGlzIGlzIGEgY29tcGFuaW9uIHRvIHRoZQ0KCSAqIC5vbiBtZXRob2QuDQoJICoNCgkgKiBAbWV0aG9kIG9mZg0KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuDQoJICogQHBhcmFtIHtGdW5jdGlvbiB8IE9iamVjdH0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIG9yIG9iamVjdC4NCgkgKiBAcGFyYW0ge0Jvb2xlYW59IFt1c2VDYXB0dXJlXSBGb3IgZXZlbnRzIHRoYXQgYnViYmxlLCBpbmRpY2F0ZXMgd2hldGhlciB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBpbiB0aGUgY2FwdHVyZSBvciBidWJibGluZy90YXJnZXQgcGhhc2UuDQoJICoqLw0KCXAub2ZmID0gcC5yZW1vdmVFdmVudExpc3RlbmVyOw0KDQoJLyoqDQoJICogUmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGZvciB0aGUgc3BlY2lmaWVkIHR5cGUsIG9yIGFsbCBsaXN0ZW5lcnMgb2YgYWxsIHR5cGVzLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICAvLyBSZW1vdmUgYWxsIGxpc3RlbmVycw0KCSAqICAgICAgZGlzcGxheU9iamVjdC5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOw0KCSAqDQoJICogICAgICAvLyBSZW1vdmUgYWxsIGNsaWNrIGxpc3RlbmVycw0KCSAqICAgICAgZGlzcGxheU9iamVjdC5yZW1vdmVBbGxFdmVudExpc3RlbmVycygiY2xpY2siKTsNCgkgKg0KCSAqIEBtZXRob2QgcmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMNCgkgKiBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuIElmIG9taXR0ZWQsIGFsbCBsaXN0ZW5lcnMgZm9yIGFsbCB0eXBlcyB3aWxsIGJlIHJlbW92ZWQuDQoJICoqLw0KCXAucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7DQoJCWlmICghdHlwZSkgeyB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzID0gbnVsbDsgfQ0KCQllbHNlIHsNCgkJCWlmICh0aGlzLl9saXN0ZW5lcnMpIHsgZGVsZXRlKHRoaXMuX2xpc3RlbmVyc1t0eXBlXSk7IH0NCgkJCWlmICh0aGlzLl9jYXB0dXJlTGlzdGVuZXJzKSB7IGRlbGV0ZSh0aGlzLl9jYXB0dXJlTGlzdGVuZXJzW3R5cGVdKTsgfQ0KCQl9DQoJfTsNCg0KCS8qKg0KCSAqIERpc3BhdGNoZXMgdGhlIHNwZWNpZmllZCBldmVudCB0byBhbGwgbGlzdGVuZXJzLg0KCSAqDQoJICogPGg0PkV4YW1wbGU8L2g0Pg0KCSAqDQoJICogICAgICAvLyBVc2UgYSBzdHJpbmcgZXZlbnQNCgkgKiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCgiY29tcGxldGUiKTsNCgkgKg0KCSAqICAgICAgLy8gVXNlIGFuIEV2ZW50IGluc3RhbmNlDQoJICogICAgICB2YXIgZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoInByb2dyZXNzIik7DQoJICogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpOw0KCSAqDQoJICogQG1ldGhvZCBkaXNwYXRjaEV2ZW50DQoJICogQHBhcmFtIHtPYmplY3QgfCBTdHJpbmcgfCBFdmVudH0gZXZlbnRPYmogQW4gb2JqZWN0IHdpdGggYSAidHlwZSIgcHJvcGVydHksIG9yIGEgc3RyaW5nIHR5cGUuDQoJICogV2hpbGUgYSBnZW5lcmljIG9iamVjdCB3aWxsIHdvcmssIGl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBhIENyZWF0ZUpTIEV2ZW50IGluc3RhbmNlLiBJZiBhIHN0cmluZyBpcyB1c2VkLA0KCSAqIGRpc3BhdGNoRXZlbnQgd2lsbCBjb25zdHJ1Y3QgYW4gRXZlbnQgaW5zdGFuY2Ugd2l0aCB0aGUgc3BlY2lmaWVkIHR5cGUuDQoJICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyB0aGUgdmFsdWUgb2YgZXZlbnRPYmouZGVmYXVsdFByZXZlbnRlZC4NCgkgKiovDQoJcC5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnRPYmopIHsNCgkJaWYgKHR5cGVvZiBldmVudE9iaiA9PSAic3RyaW5nIikgew0KCQkJLy8gd29uJ3QgYnViYmxlLCBzbyBza2lwIGV2ZXJ5dGhpbmcgaWYgdGhlcmUncyBubyBsaXN0ZW5lcnM6DQoJCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOw0KCQkJaWYgKCFsaXN0ZW5lcnMgfHwgIWxpc3RlbmVyc1tldmVudE9ial0pIHsgcmV0dXJuIGZhbHNlOyB9DQoJCQlldmVudE9iaiA9IG5ldyBjcmVhdGVqcy5FdmVudChldmVudE9iaik7DQoJCX0gZWxzZSBpZiAoZXZlbnRPYmoudGFyZ2V0ICYmIGV2ZW50T2JqLmNsb25lKSB7DQoJCQkvLyByZWRpc3BhdGNoaW5nIGFuIGFjdGl2ZSBldmVudCBvYmplY3QsIHNvIGNsb25lIGl0Og0KCQkJZXZlbnRPYmogPSBldmVudE9iai5jbG9uZSgpOw0KCQl9DQoJCXRyeSB7IGV2ZW50T2JqLnRhcmdldCA9IHRoaXM7IH0gY2F0Y2ggKGUpIHt9IC8vIHRyeS9jYXRjaCBhbGxvd3MgcmVkaXNwYXRjaGluZyBvZiBuYXRpdmUgZXZlbnRzDQoNCgkJaWYgKCFldmVudE9iai5idWJibGVzIHx8ICF0aGlzLnBhcmVudCkgew0KCQkJdGhpcy5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMik7DQoJCX0gZWxzZSB7DQoJCQl2YXIgdG9wPXRoaXMsIGxpc3Q9W3RvcF07DQoJCQl3aGlsZSAodG9wLnBhcmVudCkgeyBsaXN0LnB1c2godG9wID0gdG9wLnBhcmVudCk7IH0NCgkJCXZhciBpLCBsPWxpc3QubGVuZ3RoOw0KDQoJCQkvLyBjYXB0dXJlICYgYXRUYXJnZXQNCgkJCWZvciAoaT1sLTE7IGk+PTAgJiYgIWV2ZW50T2JqLnByb3BhZ2F0aW9uU3RvcHBlZDsgaS0tKSB7DQoJCQkJbGlzdFtpXS5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMSsoaT09MCkpOw0KCQkJfQ0KCQkJLy8gYnViYmxpbmcNCgkJCWZvciAoaT0xOyBpPGwgJiYgIWV2ZW50T2JqLnByb3BhZ2F0aW9uU3RvcHBlZDsgaSsrKSB7DQoJCQkJbGlzdFtpXS5fZGlzcGF0Y2hFdmVudChldmVudE9iaiwgMyk7DQoJCQl9DQoJCX0NCgkJcmV0dXJuIGV2ZW50T2JqLmRlZmF1bHRQcmV2ZW50ZWQ7DQoJfTsNCg0KCS8qKg0KCSAqIEluZGljYXRlcyB3aGV0aGVyIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudCB0eXBlLg0KCSAqIEBtZXRob2QgaGFzRXZlbnRMaXN0ZW5lcg0KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBzdHJpbmcgdHlwZSBvZiB0aGUgZXZlbnQuDQoJICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudC4NCgkgKiovDQoJcC5oYXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSkgew0KCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzLCBjYXB0dXJlTGlzdGVuZXJzID0gdGhpcy5fY2FwdHVyZUxpc3RlbmVyczsNCgkJcmV0dXJuICEhKChsaXN0ZW5lcnMgJiYgbGlzdGVuZXJzW3R5cGVdKSB8fCAoY2FwdHVyZUxpc3RlbmVycyAmJiBjYXB0dXJlTGlzdGVuZXJzW3R5cGVdKSk7DQoJfTsNCgkNCgkvKioNCgkgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgbGlzdGVuZXIgZm9yIHRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBvbiB0aGlzIG9iamVjdCBvciBhbnkgb2YgaXRzDQoJICogYW5jZXN0b3JzIChwYXJlbnQsIHBhcmVudCdzIHBhcmVudCwgZXRjKS4gQSByZXR1cm4gdmFsdWUgb2YgdHJ1ZSBpbmRpY2F0ZXMgdGhhdCBpZiBhIGJ1YmJsaW5nIGV2ZW50IG9mIHRoZQ0KCSAqIHNwZWNpZmllZCB0eXBlIGlzIGRpc3BhdGNoZWQgZnJvbSB0aGlzIG9iamVjdCwgaXQgd2lsbCB0cmlnZ2VyIGF0IGxlYXN0IG9uZSBsaXN0ZW5lci4NCgkgKiANCgkgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvaGFzRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319LCBidXQgaXQgc2VhcmNoZXMgdGhlIGVudGlyZQ0KCSAqIGV2ZW50IGZsb3cgZm9yIGEgbGlzdGVuZXIsIG5vdCBqdXN0IHRoaXMgb2JqZWN0Lg0KCSAqIEBtZXRob2Qgd2lsbFRyaWdnZXINCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgc3RyaW5nIHR5cGUgb2YgdGhlIGV2ZW50Lg0KCSAqIEByZXR1cm4ge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBsaXN0ZW5lciBmb3IgdGhlIHNwZWNpZmllZCBldmVudC4NCgkgKiovDQoJcC53aWxsVHJpZ2dlciA9IGZ1bmN0aW9uKHR5cGUpIHsNCgkJdmFyIG8gPSB0aGlzOw0KCQl3aGlsZSAobykgew0KCQkJaWYgKG8uaGFzRXZlbnRMaXN0ZW5lcih0eXBlKSkgeyByZXR1cm4gdHJ1ZTsgfQ0KCQkJbyA9IG8ucGFyZW50Ow0KCQl9DQoJCXJldHVybiBmYWxzZTsNCgl9Ow0KDQoJLyoqDQoJICogQG1ldGhvZCB0b1N0cmluZw0KCSAqIEByZXR1cm4ge1N0cmluZ30gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLg0KCSAqKi8NCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7DQoJCXJldHVybiAiW0V2ZW50RGlzcGF0Y2hlcl0iOw0KCX07DQoNCi8vIHByaXZhdGUgbWV0aG9kczoNCgkvKioNCgkgKiBAbWV0aG9kIF9kaXNwYXRjaEV2ZW50DQoJICogQHBhcmFtIHtPYmplY3QgfCBTdHJpbmcgfCBFdmVudH0gZXZlbnRPYmoNCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnRQaGFzZQ0KCSAqIEBwcm90ZWN0ZWQNCgkgKiovDQoJcC5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGV2ZW50T2JqLCBldmVudFBoYXNlKSB7DQoJCXZhciBsLCBsaXN0ZW5lcnMgPSAoZXZlbnRQaGFzZT09MSkgPyB0aGlzLl9jYXB0dXJlTGlzdGVuZXJzIDogdGhpcy5fbGlzdGVuZXJzOw0KCQlpZiAoZXZlbnRPYmogJiYgbGlzdGVuZXJzKSB7DQoJCQl2YXIgYXJyID0gbGlzdGVuZXJzW2V2ZW50T2JqLnR5cGVdOw0KCQkJaWYgKCFhcnJ8fCEobD1hcnIubGVuZ3RoKSkgeyByZXR1cm47IH0NCgkJCXRyeSB7IGV2ZW50T2JqLmN1cnJlbnRUYXJnZXQgPSB0aGlzOyB9IGNhdGNoIChlKSB7fQ0KCQkJdHJ5IHsgZXZlbnRPYmouZXZlbnRQaGFzZSA9IGV2ZW50UGhhc2U7IH0gY2F0Y2ggKGUpIHt9DQoJCQlldmVudE9iai5yZW1vdmVkID0gZmFsc2U7DQoJCQlhcnIgPSBhcnIuc2xpY2UoKTsgLy8gdG8gYXZvaWQgaXNzdWVzIHdpdGggaXRlbXMgYmVpbmcgcmVtb3ZlZCBvciBhZGRlZCBkdXJpbmcgdGhlIGRpc3BhdGNoDQoJCQlmb3IgKHZhciBpPTA7IGk8bCAmJiAhZXZlbnRPYmouaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOyBpKyspIHsNCgkJCQl2YXIgbyA9IGFycltpXTsNCgkJCQlpZiAoby5oYW5kbGVFdmVudCkgeyBvLmhhbmRsZUV2ZW50KGV2ZW50T2JqKTsgfQ0KCQkJCWVsc2UgeyBvKGV2ZW50T2JqKTsgfQ0KCQkJCWlmIChldmVudE9iai5yZW1vdmVkKSB7DQoJCQkJCXRoaXMub2ZmKGV2ZW50T2JqLnR5cGUsIG8sIGV2ZW50UGhhc2U9PTEpOw0KCQkJCQlldmVudE9iai5yZW1vdmVkID0gZmFsc2U7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfTsNCg0KDQpjcmVhdGVqcy5FdmVudERpc3BhdGNoZXIgPSBFdmVudERpc3BhdGNoZXI7DQp9KCkpOw0KLyoKKiBJbmRleE9mCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCiogQ29weXJpZ2h0IChjKSAyMDEwIGdza2lubmVyLmNvbSwgaW5jLgoqIAoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CiogCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKiAKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoqIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCiogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiogRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUgoqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KKi8KCi8qKgogICogQG1vZHVsZSBDcmVhdGVKUwogKi8KCi8vIG5hbWVzcGFjZToKdGhpcy5jcmVhdGVqcyA9IHRoaXMuY3JlYXRlanN8fHt9OwoKLyoqCiAqIEBjbGFzcyBVdGlsaXR5IE1ldGhvZHMKICovCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKgoJICogRW1wbG95cyBEdWZmJ3MgRGV2aWNlIHRvIG1ha2UgYSBtb3JlIHBlcmZvcm1hbnQgaW1wbGVtZW50YXRpb24gb2YgaW5kZXhPZi4KCSAqIHNlZSBodHRwOi8vanNwZXJmLmNvbS9kdWZmcy1pbmRleG9mLzIKCSAqICNtZXRob2QgaW5kZXhPZgoJICogQHBhcmFtIHtBcnJheX0gYXJyYXkgQXJyYXkgdG8gc2VhcmNoIGZvciBzZWFyY2hFbGVtZW50CgkgKiBAcGFyYW0gc2VhcmNoRWxlbWVudCBFbGVtZW50IHRvIHNlYXJjaCBhcnJheSBmb3IuCgkgKiBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIHNwZWNpZmllZCB2YWx1ZSBzZWFyY2hFbGVtZW50IGluIHRoZSBwYXNzZWQgaW4gYXJyYXkgYXIuCgkgKiBAY29uc3RydWN0b3IKCSAqLwoJLyogcmVwbGFjZWQgd2l0aCBzaW1wbGUgZm9yIGxvb3AgZm9yIG5vdywgcGVyaGFwcyB3aWxsIGJlIHJlc2VhcmNoZWQgZnVydGhlcgoJY3JlYXRlanMuaW5kZXhPZiA9IGZ1bmN0aW9uIChhciwgc2VhcmNoRWxlbWVudCkgewoJCXZhciBsID0gYXIubGVuZ3RoOwoKCQl2YXIgbiA9IChsICogMC4xMjUpIF4gMDsJLy8gMC4xMjUgPT0gMS84LCB1c2luZyBtdWx0aXBsaWNhdGlvbiBiZWNhdXNlIGl0J3MgZmFzdGVyIGluIHNvbWUgYnJvd3NlcnMJLy8gXjAgZmxvb3JzIHJlc3VsdAoJCWZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CgkJCWlmKHNlYXJjaEVsZW1lbnQgPT09IGFyW2kqOF0pICAgeyByZXR1cm4gKGkqOCk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrMV0pIHsgcmV0dXJuIChpKjgrMSk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrMl0pIHsgcmV0dXJuIChpKjgrMik7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrM10pIHsgcmV0dXJuIChpKjgrMyk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNF0pIHsgcmV0dXJuIChpKjgrNCk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNV0pIHsgcmV0dXJuIChpKjgrNSk7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrNl0pIHsgcmV0dXJuIChpKjgrNik7fQoJCQlpZihzZWFyY2hFbGVtZW50ID09PSBhcltpKjgrN10pIHsgcmV0dXJuIChpKjgrNyk7fQoJCX0KCgkJdmFyIG4gPSBsICUgODsKCQlmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgewoJCQlpZiAoc2VhcmNoRWxlbWVudCA9PT0gYXJbbC1uK2ldKSB7CgkJCQlyZXR1cm4gbC1uK2k7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0KCSovCgoJLyoqCgkgKiBGaW5kcyB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIHNwZWNpZmllZCB2YWx1ZSBzZWFyY2hFbGVtZW50IGluIHRoZSBwYXNzZWQgaW4gYXJyYXksIGFuZCByZXR1cm5zIHRoZSBpbmRleCBvZgoJICogdGhhdCB2YWx1ZS4gIFJldHVybnMgLTEgaWYgdmFsdWUgaXMgbm90IGZvdW5kLgoJICoKCSAqICAgICAgdmFyIGkgPSBjcmVhdGVqcy5pbmRleE9mKG15QXJyYXksIG15RWxlbWVudFRvRmluZCk7CgkgKgoJICogQG1ldGhvZCBpbmRleE9mCgkgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSB0byBzZWFyY2ggZm9yIHNlYXJjaEVsZW1lbnQKCSAqIEBwYXJhbSBzZWFyY2hFbGVtZW50IEVsZW1lbnQgdG8gZmluZCBpbiBhcnJheS4KCSAqIEByZXR1cm4ge051bWJlcn0gVGhlIGZpcnN0IGluZGV4IG9mIHNlYXJjaEVsZW1lbnQgaW4gYXJyYXkuCgkgKi8KCWNyZWF0ZWpzLmluZGV4T2YgPSBmdW5jdGlvbiAoYXJyYXksIHNlYXJjaEVsZW1lbnQpewoJCWZvciAodmFyIGkgPSAwLGw9YXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCWlmIChzZWFyY2hFbGVtZW50ID09PSBhcnJheVtpXSkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfQoKfSgpKTsvKgoqIFByb3h5CiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCiogQ29weXJpZ2h0IChjKSAyMDEwIGdza2lubmVyLmNvbSwgaW5jLgoqIAoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CiogCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKiAKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKKiBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoqIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCiogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiogV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiogRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUgoqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KKi8KCi8qKgogKiBAbW9kdWxlIENyZWF0ZUpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgovKioKICogVmFyaW91cyB1dGlsaXRpZXMgdGhhdCB0aGUgQ3JlYXRlSlMgU3VpdGUgdXNlcy4gVXRpbGl0aWVzIGFyZSBjcmVhdGVkIGFzIHNlcGFyYXRlIGZpbGVzLCBhbmQgd2lsbCBiZSBhdmFpbGFibGUgb24gdGhlCiAqIGNyZWF0ZWpzIG5hbWVzcGFjZSBkaXJlY3RseToKICoKICogPGg0PkV4YW1wbGU8L2g0PgogKiAgICAgIG15T2JqZWN0LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIGNyZWF0ZWpzLnByb3h5KG15TWV0aG9kLCBzY29wZSkpOwogKgogKiBAY2xhc3MgVXRpbGl0eSBNZXRob2RzCiAqIEBtYWluIFV0aWxpdHkgTWV0aG9kcwogKi8KCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEEgZnVuY3Rpb24gcHJveHkgZm9yIG1ldGhvZHMuIEJ5IGRlZmF1bHQsIEphdmFTY3JpcHQgbWV0aG9kcyBkbyBub3QgbWFpbnRhaW4gc2NvcGUsIHNvIHBhc3NpbmcgYSBtZXRob2QgYXMgYQoJICogY2FsbGJhY2sgd2lsbCByZXN1bHQgaW4gdGhlIG1ldGhvZCBnZXR0aW5nIGNhbGxlZCBpbiB0aGUgc2NvcGUgb2YgdGhlIGNhbGxlci4gVXNpbmcgYSBwcm94eSBlbnN1cmVzIHRoYXQgdGhlCgkgKiBtZXRob2QgZ2V0cyBjYWxsZWQgaW4gdGhlIGNvcnJlY3Qgc2NvcGUuCgkgKgoJICogQWRkaXRpb25hbCBhcmd1bWVudHMgY2FuIGJlIHBhc3NlZCB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZnVuY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQuCgkgKgoJICogPGg0PkV4YW1wbGU8L2g0PgoJICogICAgICBteU9iamVjdC5hZGRFdmVudExpc3RlbmVyKCJldmVudCIsIGNyZWF0ZWpzLnByb3h5KG15SGFuZGxlciwgdGhpcywgYXJnMSwgYXJnMikpOwoJICoKCSAqICAgICAgZnVuY3Rpb24gbXlIYW5kbGVyKGFyZzEsIGFyZzIpIHsKCSAqICAgICAgICAgICAvLyBUaGlzIGdldHMgY2FsbGVkIHdoZW4gbXlPYmplY3QubXlDYWxsYmFjayBpcyBleGVjdXRlZC4KCSAqICAgICAgfQoJICoKCSAqIEBtZXRob2QgcHJveHkKCSAqIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZCBUaGUgZnVuY3Rpb24gdG8gY2FsbAoJICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBzY29wZSB0byBjYWxsIHRoZSBtZXRob2QgbmFtZSBvbgoJICogQHBhcmFtIHttaXhlZH0gW2FyZ10gKiBBcmd1bWVudHMgdGhhdCBhcmUgYXBwZW5kZWQgdG8gdGhlIGNhbGxiYWNrIGZvciBhZGRpdGlvbmFsIHBhcmFtcy4KCSAqIEBwdWJsaWMKCSAqIEBzdGF0aWMKCSAqLwoJY3JlYXRlanMucHJveHkgPSBmdW5jdGlvbiAobWV0aG9kLCBzY29wZSkgewoJCXZhciBhQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIG1ldGhvZC5hcHBseShzY29wZSwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKS5jb25jYXQoYUFyZ3MpKTsKCQl9OwoJfQoKfSgpKTsvKgoqIEFic3RyYWN0TG9hZGVyCiogVmlzaXQgaHR0cDovL2NyZWF0ZWpzLmNvbS8gZm9yIGRvY3VtZW50YXRpb24sIHVwZGF0ZXMgYW5kIGV4YW1wbGVzLgoqCioKKiBDb3B5cmlnaHQgKGMpIDIwMTIgZ3NraW5uZXIuY29tLCBpbmMuCioKKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgoqIG9idGFpbmluZyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uCiogZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dAoqIHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAoqIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlCiogU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKKiBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAoqIEVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUwoqIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5ECiogTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKKiBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwKKiBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKKiBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCiogT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKLyoqCiAqIEBtb2R1bGUgUHJlbG9hZEpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgooZnVuY3Rpb24oKSB7CgkidXNlIHN0cmljdCI7CgkvKioKCSAqIFRoZSBiYXNlIGxvYWRlciwgd2hpY2ggZGVmaW5lcyBhbGwgdGhlIGdlbmVyaWMgY2FsbGJhY2tzIGFuZCBldmVudHMuIEFsbCBsb2FkZXJzIGV4dGVuZCB0aGlzIGNsYXNzLCBpbmNsdWRpbmcgdGhlCgkgKiB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319LgoJICogQGNsYXNzIEFic3RyYWN0TG9hZGVyCgkgKiBAZXh0ZW5kcyBFdmVudERpc3BhdGNoZXIKCSAqLwoJdmFyIEFic3RyYWN0TG9hZGVyID0gZnVuY3Rpb24gKCkgewoJCXRoaXMuaW5pdCgpOwoJfTsKCgl2YXIgcCA9IEFic3RyYWN0TG9hZGVyLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5FdmVudERpc3BhdGNoZXIoKTsKCUFic3RyYWN0TG9hZGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFic3RyYWN0TG9hZGVyOwoJdmFyIHMgPSBBYnN0cmFjdExvYWRlcjsKCgkvKioKCSAqIFRoZSBSZWd1bGFyIEV4cHJlc3Npb24gdXNlZCB0byB0ZXN0IGZpbGUgVVJMUyBmb3IgYW4gYWJzb2x1dGUgcGF0aC4KCSAqIEBwcm9wZXJ0eSBBQlNPTFVURV9QQVRICgkgKiBAc3RhdGljCgkgKiBAdHlwZSB7UmVnRXhwfQoJICogQHNpbmNlIDAuNC4yCgkgKi8KCXMuQUJTT0xVVEVfUEFUVCA9IC9eKD86XHcrOik/XC97Mn0vaTsKCgkvKioKCSAqIFRoZSBSZWd1bGFyIEV4cHJlc3Npb24gdXNlZCB0byB0ZXN0IGZpbGUgVVJMUyBmb3IgYW4gYWJzb2x1dGUgcGF0aC4KCSAqIEBwcm9wZXJ0eSBSRUxBVElWRV9QQVRICgkgKiBAc3RhdGljCgkgKiBAdHlwZSB7UmVnRXhwfQoJICogQHNpbmNlIDAuNC4yCgkgKi8KCXMuUkVMQVRJVkVfUEFUVCA9ICgvXlsuL10qP1wvL2kpOwoKCS8qKgoJICogVGhlIFJlZ3VsYXIgRXhwcmVzc2lvbiB1c2VkIHRvIHRlc3QgZmlsZSBVUkxTIGZvciBhbiBleHRlbnNpb24uIE5vdGUgdGhhdCBVUklzIG11c3QgYWxyZWFkeSBoYXZlIHRoZSBxdWVyeSBzdHJpbmcKCSAqIHJlbW92ZWQuCgkgKiBAcHJvcGVydHkgRVhURU5TSU9OX1BBVFQKCSAqIEBzdGF0aWMKCSAqIEB0eXBlIHtSZWdFeHB9CgkgKiBAc2luY2UgMC40LjIKCSAqLwoJcy5FWFRFTlNJT05fUEFUVCA9IC9cLz9bXi9dK1wuKFx3ezEsNX0pJC9pOwoKCS8qKgoJICogSWYgdGhlIGxvYWRlciBoYXMgY29tcGxldGVkIGxvYWRpbmcuIFRoaXMgcHJvdmlkZXMgYSBxdWljayBjaGVjaywgYnV0IGFsc28gZW5zdXJlcyB0aGF0IHRoZSBkaWZmZXJlbnQgYXBwcm9hY2hlcwoJICogdXNlZCBmb3IgbG9hZGluZyBkbyBub3QgcGlsZSB1cCByZXN1bHRpbmcgaW4gbW9yZSB0aGFuIG9uZSA8Y29kZT5jb21wbGV0ZTwvY29kZT4gZXZlbnQuCgkgKiBAcHJvcGVydHkgbG9hZGVkCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKi8KCXAubG9hZGVkID0gZmFsc2U7CgoJLyoqCgkgKiBEZXRlcm1pbmUgaWYgdGhlIGxvYWRlciB3YXMgY2FuY2VsZWQuIENhbmNlbGVkIGxvYWRzIHdpbGwgbm90IGZpcmUgY29tcGxldGUgZXZlbnRzLiBOb3RlIHRoYXQKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0gcXVldWVzIHNob3VsZCBiZSBjbG9zZWQgdXNpbmcge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9jbG9zZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBpbnN0ZWFkIG9mIHNldHRpbmcgdGhpcyBwcm9wZXJ0eS4KCSAqIEBwcm9wZXJ0eSBjYW5jZWxlZAoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAZGVmYXVsdCBmYWxzZQoJICovCglwLmNhbmNlbGVkID0gZmFsc2U7CgoJLyoqCgkgKiBUaGUgY3VycmVudCBsb2FkIHByb2dyZXNzIChwZXJjZW50YWdlKSBmb3IgdGhpcyBpdGVtLiBUaGlzIHdpbGwgYmUgYSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLgoJICoKCSAqIDxoND5FeGFtcGxlPC9oND4KCSAqCgkgKiAgICAgdmFyIHF1ZXVlID0gbmV3IGNyZWF0ZWpzLkxvYWRRdWV1ZSgpOwoJICogICAgIHF1ZXVlLmxvYWRGaWxlKCJsYXJnZUltYWdlLnBuZyIpOwoJICogICAgIHF1ZXVlLm9uKCJwcm9ncmVzcyIsIGZ1bmN0aW9uKCkgewoJICogICAgICAgICBjb25zb2xlLmxvZygiUHJvZ3Jlc3M6IiwgcXVldWUucHJvZ3Jlc3MsIGV2ZW50LnByb2dyZXNzKTsKCSAqICAgICB9KTsKCSAqCgkgKiBAcHJvcGVydHkgcHJvZ3Jlc3MKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCAwCgkgKi8KCXAucHJvZ3Jlc3MgPSAwOwoKCS8qKgoJICogVGhlIGl0ZW0gdGhpcyBsb2FkZXIgcmVwcmVzZW50cy4gTm90ZSB0aGF0IHRoaXMgaXMgbnVsbCBpbiBhIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0sIGJ1dCB3aWxsCgkgKiBiZSBhdmFpbGFibGUgb24gbG9hZGVycyBzdWNoIGFzIHt7I2Nyb3NzTGluayAiWEhSTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHt7I2Nyb3NzTGluayAiVGFnTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0uCgkgKiBAcHJvcGVydHkgX2l0ZW0KCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9pdGVtID0gbnVsbDsKCi8vIEV2ZW50cwoJLyoqCgkgKiBUaGUgZXZlbnQgdGhhdCBpcyBmaXJlZCB3aGVuIHRoZSBvdmVyYWxsIHByb2dyZXNzIGNoYW5nZXMuCgkgKiBAZXZlbnQgcHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IGRpc3BhdGNoZWQgdGhlIGV2ZW50LgoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHR5cGUuCgkgKiBAcGFyYW0ge051bWJlcn0gbG9hZGVkIFRoZSBhbW91bnQgdGhhdCBoYXMgYmVlbiBsb2FkZWQgc28gZmFyLiBOb3RlIHRoYXQgdGhpcyBpcyBtYXkganVzdCBiZSBhIHBlcmNlbnRhZ2Ugb2YgMSwKCSAqIHNpbmNlIGZpbGUgc2l6ZXMgY2FuIG5vdCBiZSBkZXRlcm1pbmVkIGJlZm9yZSBhIGxvYWQgaXMga2lja2VkIG9mZiwgaWYgYXQgYWxsLgoJICogQHBhcmFtIHtOdW1iZXJ9IHRvdGFsIFRoZSB0b3RhbCBudW1iZXIgb2YgYnl0ZXMuIE5vdGUgdGhhdCB0aGlzIG1heSBqdXN0IGJlIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gcHJvZ3Jlc3MgVGhlIHJhdGlvIHRoYXQgaGFzIGJlZW4gbG9hZGVkIGJldHdlZW4gMCBhbmQgMS4KCSAqIEBzaW5jZSAwLjMuMAoJICovCgoJLyoqCgkgKiBUaGUgZXZlbnQgdGhhdCBpcyBmaXJlZCB3aGVuIGEgbG9hZCBzdGFydHMuCgkgKiBAZXZlbnQgbG9hZHN0YXJ0CgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHNpbmNlIDAuMy4xCgkgKi8KCgkvKioKCSAqIFRoZSBldmVudCB0aGF0IGlzIGZpcmVkIHdoZW4gdGhlIGVudGlyZSBxdWV1ZSBoYXMgYmVlbiBsb2FkZWQuCgkgKiBAZXZlbnQgY29tcGxldGUKCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IGRpc3BhdGNoZWQgdGhlIGV2ZW50LgoJICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHR5cGUuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8qKgoJICogVGhlIGV2ZW50IHRoYXQgaXMgZmlyZWQgd2hlbiB0aGUgbG9hZGVyIGVuY291bnRlcnMgYW4gZXJyb3IuIElmIHRoZSBlcnJvciB3YXMgZW5jb3VudGVyZWQgYnkgYSBmaWxlLCB0aGUgZXZlbnQgd2lsbAoJICogY29udGFpbiB0aGUgaXRlbSB0aGF0IGNhdXNlZCB0aGUgZXJyb3IuIFRoZXJlIG1heSBiZSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgc3VjaCBhcyB0aGUgZXJyb3IgcmVhc29uIG9uIGV2ZW50CgkgKiBvYmplY3RzLgoJICogQGV2ZW50IGVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtPYmplY3R9IFtpdGVtXSBUaGUgaXRlbSB0aGF0IHdhcyBiZWluZyBsb2FkZWQgdGhhdCBjYXVzZWQgdGhlIGVycm9yLiBUaGUgaXRlbSB3YXMgc3BlY2lmaWVkIGluCgkgKiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fSBvciB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUgb2JqZWN0IHdpbGwgY29udGFpbiB0aGF0IHZhbHVlIGFzIGEgYHNyY2AgcHJvcGVydHkuCgkgKiBAcGFyYW0ge1N0cmluZ30gW2Vycm9yXSBUaGUgZXJyb3Igb2JqZWN0IG9yIHRleHQuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8vVE9ETzogRGVwcmVjYXRlZAoJLyoqCgkgKiBSRU1PVkVELiBVc2Uge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319IGFuZCB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvblByb2dyZXNzCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJwcm9ncmVzcyIgZXZlbnQuCgkgKi8KCS8qKgoJICogUkVNT1ZFRC4gVXNlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL2FkZEV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvbG9hZHN0YXJ0OmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50LgoJICogQHByb3BlcnR5IG9uTG9hZFN0YXJ0CgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJsb2Fkc3RhcnQiIGV2ZW50LgoJICovCgkvKioKCSAqIFJFTU9WRUQuIFVzZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9hZGRFdmVudExpc3RlbmVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHRoZSB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2NvbXBsZXRlOmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50LgoJICogQHByb3BlcnR5IG9uQ29tcGxldGUKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBkZXByZWNhdGVkIFVzZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0aGUgImNvbXBsZXRlIiBldmVudC4KCSAqLwoJLyoqCgkgKiBSRU1PVkVELiBVc2Uge3sjY3Jvc3NMaW5rICJFdmVudERpc3BhdGNoZXIvYWRkRXZlbnRMaXN0ZW5lciJ9fXt7L2Nyb3NzTGlua319IGFuZCB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9lcnJvcjpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkVycm9yCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJlcnJvciIgZXZlbnQuCgkgKi8KCgkvKioKCSAqIEdldCBhIHJlZmVyZW5jZSB0byB0aGUgbWFuaWZlc3QgaXRlbSB0aGF0IGlzIGxvYWRlZCBieSB0aGlzIGxvYWRlci4gSW4gbW9zdCBjYXNlcyB0aGlzIHdpbGwgYmUgdGhlIHZhbHVlIHRoYXQgd2FzCgkgKiBwYXNzZWQgaW50byB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319IHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3IKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319LiBIb3dldmVyIGlmIG9ubHkgYSBTdHJpbmcgcGF0aCB3YXMgcGFzc2VkIGluLCB0aGVuIGl0IHdpbGwKCSAqIGJlIGFuIE9iamVjdCBjcmVhdGVkIGJ5IHRoZSBMb2FkUXVldWUuCgkgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBtYW5pZmVzdCBpdGVtIHRoYXQgdGhpcyBsb2FkZXIgaXMgcmVzcG9uc2libGUgZm9yIGxvYWRpbmcuCgkgKi8KCXAuZ2V0SXRlbSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9pdGVtOwoJfTsKCgkvKioKCSAqIEluaXRpYWxpemUgdGhlIGxvYWRlci4gVGhpcyBpcyBjYWxsZWQgYnkgdGhlIGNvbnN0cnVjdG9yLgoJICogQG1ldGhvZCBpbml0CgkgKiBAcHJpdmF0ZQoJICovCglwLmluaXQgPSBmdW5jdGlvbiAoKSB7fTsKCgkvKioKCSAqIEJlZ2luIGxvYWRpbmcgdGhlIHF1ZXVlZCBpdGVtcy4gVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB3aGVuIGEge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUifX17ey9jcm9zc0xpbmt9fSBpcyBzZXQKCSAqIHVwIGJ1dCBub3Qgc3RhcnRlZCBpbW1lZGlhdGVseS4KCSAqIEBleGFtcGxlCgkgKiAgICAgIHZhciBxdWV1ZSA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoKTsKCSAqICAgICAgcXVldWUuYWRkRXZlbnRMaXN0ZW5lcigiY29tcGxldGUiLCBoYW5kbGVDb21wbGV0ZSk7CgkgKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChmaWxlQXJyYXksIGZhbHNlKTsgLy8gTm90ZSB0aGUgMm5kIGFyZ3VtZW50IHRoYXQgdGVsbHMgdGhlIHF1ZXVlIG5vdCB0byBzdGFydCBsb2FkaW5nIHlldAoJICogICAgICBxdWV1ZS5sb2FkKCk7CgkgKiBAbWV0aG9kIGxvYWQKCSAqLwoJcC5sb2FkID0gZnVuY3Rpb24oKSB7fTsKCgkvKioKCSAqIENsb3NlIHRoZSBhY3RpdmUgcXVldWUuIENsb3NpbmcgYSBxdWV1ZSBjb21wbGV0ZWx5IGVtcHRpZXMgdGhlIHF1ZXVlLCBhbmQgcHJldmVudHMgYW55IHJlbWFpbmluZyBpdGVtcyBmcm9tCgkgKiBzdGFydGluZyB0byBkb3dubG9hZC4gTm90ZSB0aGF0IGN1cnJlbnRseSBhbnkgYWN0aXZlIGxvYWRzIHdpbGwgcmVtYWluIG9wZW4sIGFuZCBldmVudHMgbWF5IGJlIHByb2Nlc3NlZC4KCSAqCgkgKiBUbyBzdG9wIGFuZCByZXN0YXJ0IGEgcXVldWUsIHVzZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0UGF1c2VkIn19e3svY3Jvc3NMaW5rfX0gbWV0aG9kIGluc3RlYWQuCgkgKiBAbWV0aG9kIGNsb3NlCgkgKi8KCXAuY2xvc2UgPSBmdW5jdGlvbigpIHt9OwoKCi8vQ2FsbGJhY2sgcHJveGllcwoJLyoqCgkgKiBEaXNwYXRjaCBhIGxvYWRzdGFydCBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9sb2Fkc3RhcnQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudAoJICogZm9yIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kTG9hZFN0YXJ0CgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3NlbmRMb2FkU3RhcnQgPSBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7IHJldHVybjsgfQoJCXRoaXMuZGlzcGF0Y2hFdmVudCgibG9hZHN0YXJ0Iik7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBwcm9ncmVzcyBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319IGV2ZW50IGZvcgoJICogZGV0YWlscyBvbiB0aGUgZXZlbnQgcGF5bG9hZC4KCSAqIEBtZXRob2QgX3NlbmRQcm9ncmVzcwoJICogQHBhcmFtIHtOdW1iZXIgfCBPYmplY3R9IHZhbHVlIFRoZSBwcm9ncmVzcyBvZiB0aGUgbG9hZGVkIGl0ZW0sIG9yIGFuIG9iamVjdCBjb250YWluaW5nIDxjb2RlPmxvYWRlZDwvY29kZT4KCSAqIGFuZCA8Y29kZT50b3RhbDwvY29kZT4gcHJvcGVydGllcy4KCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZFByb2dyZXNzID0gZnVuY3Rpb24odmFsdWUpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7IHJldHVybjsgfQoJCXZhciBldmVudCA9IG51bGw7CgkJaWYgKHR5cGVvZih2YWx1ZSkgPT0gIm51bWJlciIpIHsKCQkJdGhpcy5wcm9ncmVzcyA9IHZhbHVlOwoJCQlldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgicHJvZ3Jlc3MiKTsKCQkJZXZlbnQubG9hZGVkID0gdGhpcy5wcm9ncmVzczsKCQkJZXZlbnQudG90YWwgPSAxOwoJCX0gZWxzZSB7CgkJCWV2ZW50ID0gdmFsdWU7CgkJCXRoaXMucHJvZ3Jlc3MgPSB2YWx1ZS5sb2FkZWQgLyB2YWx1ZS50b3RhbDsKCQkJaWYgKGlzTmFOKHRoaXMucHJvZ3Jlc3MpIHx8IHRoaXMucHJvZ3Jlc3MgPT0gSW5maW5pdHkpIHsgdGhpcy5wcm9ncmVzcyA9IDA7IH0KCQl9CgkJZXZlbnQucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzOwoJCXRoaXMuaGFzRXZlbnRMaXN0ZW5lcigicHJvZ3Jlc3MiKSAmJiB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoJfTsKCgkvKioKCSAqIERpc3BhdGNoIGEgY29tcGxldGUgZXZlbnQuIFBsZWFzZSBzZWUgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY29tcGxldGU6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudAoJICogZm9yIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kQ29tcGxldGUKCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZENvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuX2lzQ2FuY2VsZWQoKSkgeyByZXR1cm47IH0KCQl0aGlzLmRpc3BhdGNoRXZlbnQoImNvbXBsZXRlIik7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQuIFBsZWFzZSBzZWUgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvZXJyb3I6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudCBmb3IKCSAqIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kRXJyb3IKCSAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgZXZlbnQgb2JqZWN0IGNvbnRhaW5pbmcgc3BlY2lmaWMgZXJyb3IgcHJvcGVydGllcy4KCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZEVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpIHx8ICF0aGlzLmhhc0V2ZW50TGlzdGVuZXIoImVycm9yIikpIHsgcmV0dXJuOyB9CgkJaWYgKGV2ZW50ID09IG51bGwpIHsKCQkJZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJfQoJCXRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGV0ZXJtaW5lIGlmIHRoZSBsb2FkIGhhcyBiZWVuIGNhbmNlbGVkLiBUaGlzIGlzIGltcG9ydGFudCB0byBlbnN1cmUgdGhhdCBtZXRob2QgY2FsbHMgb3IgYXN5bmNocm9ub3VzIGV2ZW50cwoJICogZG8gbm90IGNhdXNlIGlzc3VlcyBhZnRlciB0aGUgcXVldWUgaGFzIGJlZW4gY2xlYW5lZCB1cC4KCSAqIEBtZXRob2QgX2lzQ2FuY2VsZWQKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkZXIgaGFzIGJlZW4gY2FuY2VsZWQuCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX2lzQ2FuY2VsZWQgPSBmdW5jdGlvbigpIHsKCQlpZiAod2luZG93LmNyZWF0ZWpzID09IG51bGwgfHwgdGhpcy5jYW5jZWxlZCkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvKioKCSAqIEBtZXRob2QgX3BhcnNlVVJJCgkgKiBQYXJzZSBhIGZpbGUgcGF0aCB0byBkZXRlcm1pbmUgdGhlIGluZm9ybWF0aW9uIHdlIG5lZWQgdG8gd29yayB3aXRoIGl0LiBDdXJyZW50bHksIFByZWxvYWRKUyBuZWVkcyB0byBrbm93OgoJICogPHVsPgoJICogICAgIDxsaT5JZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZS4gQWJzb2x1dGUgcGF0aHMgc3RhcnQgd2l0aCBhIHByb3RvY29sIChzdWNoIGFzIGBodHRwOi8vYCwgYGZpbGU6Ly9gLCBvcgoJICogICAgIGAvL25ldHdvcmtQYXRoYCk8L2xpPgoJICogICAgIDxsaT5JZiB0aGUgcGF0aCBpcyByZWxhdGl2ZS4gUmVsYXRpdmUgcGF0aHMgc3RhcnQgd2l0aCBgLi4vYCBvciBgL3BhdGhgIChvciBzaW1pbGFyKTwvbGk+CgkgKiAgICAgPGxpPlRoZSBmaWxlIGV4dGVuc2lvbi4gVGhpcyBpcyBkZXRlcm1pbmVkIGJ5IHRoZSBmaWxlbmFtZSB3aXRoIGFuIGV4dGVuc2lvbi4gUXVlcnkgc3RyaW5ncyBhcmUgZHJvcHBlZCwgYW5kCgkgKiAgICAgdGhlIGZpbGUgcGF0aCBpcyBleHBlY3RlZCB0byBmb2xsb3cgdGhlIGZvcm1hdCBgbmFtZS5leHRgLjwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIDxzdHJvbmc+Tm90ZTo8L3N0cm9uZz4gVGhpcyBoYXMgY2hhbmdlZCBmcm9tIGVhcmxpZXIgdmVyc2lvbnMsIHdoaWNoIHVzZWQgYSBzaW5nbGUsIGNvbXBsaWNhdGVkIFJlZ3VsYXIgRXhwcmVzc2lvbiwgd2hpY2gKCSAqIHdhcyBkaWZmaWN1bHQgdG8gbWFpbnRhaW4sIGFuZCBvdmVyLWFnZ3Jlc3NpdmUgaW4gZGV0ZXJtaW5pbmcgYWxsIGZpbGUgcHJvcGVydGllcy4gSXQgaGFzIGJlZW4gc2ltcGxpZmllZCB0bwoJICogb25seSBwdWxsIG91dCB3aGF0IGl0IG5lZWRzLgoJICogQHBhcmFtIHBhdGgKCSAqIEByZXR1cm5zIHtPYmplY3R9IEFuIE9iamVjdCB3aXRoIGFuIGBhYnNvbHV0ZWAgYW5kIGByZWxhdGl2ZWAgQm9vbGVhbiwgYXMgd2VsbCBhcyBhbiBvcHRpb25hbCAnZXh0ZW5zaW9uYCBTdHJpbmcKCSAqIHByb3BlcnR5LCB3aGljaCBpcyB0aGUgbG93ZXJjYXNlIGV4dGVuc2lvbi4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3BhcnNlVVJJID0gZnVuY3Rpb24ocGF0aCkgewoJCXZhciBpbmZvID0geyBhYnNvbHV0ZTogZmFsc2UsIHJlbGF0aXZlOmZhbHNlIH07CgkJaWYgKHBhdGggPT0gbnVsbCkgeyByZXR1cm4gaW5mbzsgfTsKCgkJLy8gRHJvcCB0aGUgcXVlcnkgc3RyaW5nCgkJdmFyIHF1ZXJ5SW5kZXggPSBwYXRoLmluZGV4T2YoIj8iKTsKCQlpZiAocXVlcnlJbmRleCA+IC0xKSB7CgkJCXBhdGggPSBwYXRoLnN1YnN0cigwLHF1ZXJ5SW5kZXgpOwoJCX0KCgkJLy8gQWJzb2x1dGUKCQl2YXIgbWF0Y2g7CgkJaWYgKHMuQUJTT0xVVEVfUEFUVC50ZXN0KHBhdGgpKSB7CgkJCWluZm8uYWJzb2x1dGUgPSB0cnVlOwoKCQkvLyBSZWxhdGl2ZQoJCX0gZWxzZSBpZiAocy5SRUxBVElWRV9QQVRULnRlc3QocGF0aCkpIHsKCQkJaW5mby5yZWxhdGl2ZSA9IHRydWU7CgkJfQoKCQkvLyBFeHRlbnNpb24KCQlpZiAobWF0Y2ggPSBwYXRoLm1hdGNoKHMuRVhURU5TSU9OX1BBVFQpKSB7CgkJCWluZm8uZXh0ZW5zaW9uID0gbWF0Y2hbMV0udG9Mb3dlckNhc2UoKTsKCQl9CgkJcmV0dXJuIGluZm87Cgl9OwoKCS8qKgoJICogRm9ybWF0cyBhbiBvYmplY3QgaW50byBhIHF1ZXJ5IHN0cmluZyBmb3IgZWl0aGVyIGEgUE9TVCBvciBHRVQgcmVxdWVzdC4KCSAqIEBtZXRob2QgX2Zvcm1hdFF1ZXJ5U3RyaW5nCgkgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBjb252ZXJ0IHRvIGEgcXVlcnkgc3RyaW5nLgoJICogQHBhcmFtIHtBcnJheX0gW3F1ZXJ5XSBFeGlzdGluZyBuYW1lL3ZhbHVlIHBhaXJzIHRvIGFwcGVuZCBvbiB0byB0aGlzIHF1ZXJ5LgoJICogQHByaXZhdGUKCSAqLwoJcC5fZm9ybWF0UXVlcnlTdHJpbmcgPSBmdW5jdGlvbihkYXRhLCBxdWVyeSkgewoJCWlmIChkYXRhID09IG51bGwpIHsKCQkJdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBzcGVjaWZ5IGRhdGEuJyk7CgkJfQoJCXZhciBwYXJhbXMgPSBbXTsKCQlmb3IgKHZhciBuIGluIGRhdGEpIHsKCQkJcGFyYW1zLnB1c2gobisnPScrZXNjYXBlKGRhdGFbbl0pKTsKCQl9CgkJaWYgKHF1ZXJ5KSB7CgkJCXBhcmFtcyA9IHBhcmFtcy5jb25jYXQocXVlcnkpOwoJCX0KCQlyZXR1cm4gcGFyYW1zLmpvaW4oJyYnKTsKCX07CgoJLyoqCgkgKiBBIHV0aWxpdHkgbWV0aG9kIHRoYXQgYnVpbGRzIGEgZmlsZSBwYXRoIHVzaW5nIGEgc291cmNlIGFuZCBhIGRhdGEgb2JqZWN0LCBhbmQgZm9ybWF0cyBpdCBpbnRvIGEgbmV3IHBhdGguIEFsbAoJICogb2YgdGhlIGxvYWRlcnMgaW4gUHJlbG9hZEpTIHVzZSB0aGlzIG1ldGhvZCB0byBjb21waWxlIHBhdGhzIHdoZW4gbG9hZGluZy4KCSAqIEBtZXRob2QgYnVpbGRQYXRoCgkgKiBAcGFyYW0ge1N0cmluZ30gc3JjIFRoZSBzb3VyY2UgcGF0aCB0byBhZGQgdmFsdWVzIHRvLgoJICogQHBhcmFtIHtPYmplY3R9IFtkYXRhXSBPYmplY3QgdXNlZCB0byBhcHBlbmQgdmFsdWVzIHRvIHRoaXMgcmVxdWVzdCBhcyBhIHF1ZXJ5IHN0cmluZy4gRXhpc3RpbmcgcGFyYW1ldGVycyBvbiB0aGUKCSAqIHBhdGggd2lsbCBiZSBwcmVzZXJ2ZWQuCgkgKiBAcmV0dXJucyB7c3RyaW5nfSBBIGZvcm1hdHRlZCBzdHJpbmcgdGhhdCBjb250YWlucyB0aGUgcGF0aCBhbmQgdGhlIHN1cHBsaWVkIHBhcmFtZXRlcnMuCgkgKiBAc2luY2UgMC4zLjEKCSAqLwoJcC5idWlsZFBhdGggPSBmdW5jdGlvbihzcmMsIGRhdGEpIHsKCQlpZiAoZGF0YSA9PSBudWxsKSB7CgkJCXJldHVybiBzcmM7CgkJfQoKCQl2YXIgcXVlcnkgPSBbXTsKCQl2YXIgaWR4ID0gc3JjLmluZGV4T2YoJz8nKTsKCgkJaWYgKGlkeCAhPSAtMSkgewoJCQl2YXIgcSA9IHNyYy5zbGljZShpZHgrMSk7CgkJCXF1ZXJ5ID0gcXVlcnkuY29uY2F0KHEuc3BsaXQoJyYnKSk7CgkJfQoKCQlpZiAoaWR4ICE9IC0xKSB7CgkJCXJldHVybiBzcmMuc2xpY2UoMCwgaWR4KSArICc/JyArIHRoaXMuX2Zvcm1hdFF1ZXJ5U3RyaW5nKGRhdGEsIHF1ZXJ5KTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gc3JjICsgJz8nICsgdGhpcy5fZm9ybWF0UXVlcnlTdHJpbmcoZGF0YSwgcXVlcnkpOwoJCX0KCX07CgoJLyoqCgkgKiBAbWV0aG9kIF9pc0Nyb3NzRG9tYWluCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBBIGxvYWQgaXRlbSB3aXRoIGEgYHNyY2AgcHJvcGVydHkKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkIGl0ZW0gaXMgbG9hZGluZyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiB0aGFuIHRoZSBjdXJyZW50IGxvY2F0aW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5faXNDcm9zc0RvbWFpbiA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCXRhcmdldC5ocmVmID0gaXRlbS5zcmM7CgoJCXZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCWhvc3QuaHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJCXZhciBjcm9zc2RvbWFpbiA9ICh0YXJnZXQuaG9zdG5hbWUgIT0gIiIpICYmCgkJCQkodGFyZ2V0LnBvcnQgIT0gaG9zdC5wb3J0IHx8CgkJCQkJCXRhcmdldC5wcm90b2NvbCAhPSBob3N0LnByb3RvY29sIHx8CgkJCQkJCXRhcmdldC5ob3N0bmFtZSAhPSBob3N0Lmhvc3RuYW1lKTsKCQlyZXR1cm4gY3Jvc3Nkb21haW47Cgl9CgoJLyoqCgkgKiBAbWV0aG9kIF9pc0xvY2FsCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBBIGxvYWQgaXRlbSB3aXRoIGEgYHNyY2AgcHJvcGVydHkKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBsb2FkIGl0ZW0gaXMgbG9hZGluZyBmcm9tIHRoZSAiZmlsZToiIHByb3RvY29sLiBBc3N1bWUgdGhhdCB0aGUgaG9zdCBtdXN0IGJlIGxvY2FsIGFzCgkgKiB3ZWxsLgoJICogQHByaXZhdGUKCSAqLwoJcC5faXNMb2NhbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoJCXRhcmdldC5ocmVmID0gaXRlbS5zcmM7CgkJcmV0dXJuIHRhcmdldC5ob3N0bmFtZSA9PSAiIiAmJiB0YXJnZXQucHJvdG9jb2wgPT0gImZpbGU6IjsKCX07CgoJLyoqCgkgKiBAbWV0aG9kIHRvU3RyaW5nCgkgKiBAcmV0dXJuIHtTdHJpbmd9IGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KCSAqLwoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBBYnN0cmFjdExvYWRlcl0iOwoJfTsKCgljcmVhdGVqcy5BYnN0cmFjdExvYWRlciA9IEFic3RyYWN0TG9hZGVyOwoKfSgpKTsKLyoKKiBMb2FkUXVldWUKKiBWaXNpdCBodHRwOi8vY3JlYXRlanMuY29tLyBmb3IgZG9jdW1lbnRhdGlvbiwgdXBkYXRlcyBhbmQgZXhhbXBsZXMuCioKKgoqIENvcHlyaWdodCAoYykgMjAxMiBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCi8qKgogKiBQcmVsb2FkSlMgcHJvdmlkZXMgYSBjb25zaXN0ZW50IHdheSB0byBwcmVsb2FkIGNvbnRlbnQgZm9yIHVzZSBpbiBIVE1MIGFwcGxpY2F0aW9ucy4gUHJlbG9hZGluZyBjYW4gYmUgZG9uZSB1c2luZwogKiBIVE1MIHRhZ3MsIGFzIHdlbGwgYXMgWEhSLgogKgogKiBCeSBkZWZhdWx0LCBQcmVsb2FkSlMgd2lsbCB0cnkgYW5kIGxvYWQgY29udGVudCB1c2luZyBYSFIsIHNpbmNlIGl0IHByb3ZpZGVzIGJldHRlciBzdXBwb3J0IGZvciBwcm9ncmVzcyBhbmQKICogY29tcGxldGlvbiBldmVudHMsIDxiPmhvd2V2ZXIgZHVlIHRvIGNyb3NzLWRvbWFpbiBpc3N1ZXMsIGl0IG1heSBzdGlsbCBiZSBwcmVmZXJhYmxlIHRvIHVzZSB0YWctYmFzZWQgbG9hZGluZwogKiBpbnN0ZWFkPC9iPi4gTm90ZSB0aGF0IHNvbWUgY29udGVudCByZXF1aXJlcyBYSFIgdG8gd29yayAocGxhaW4gdGV4dCwgd2ViIGF1ZGlvKSwgYW5kIHNvbWUgcmVxdWlyZXMgdGFncyAoSFRNTCBhdWRpbykuCiAqIE5vdGUgdGhpcyBpcyBoYW5kbGVkIGF1dG9tYXRpY2FsbHkgd2hlcmUgcG9zc2libGUuCiAqCiAqIFByZWxvYWRKUyBjdXJyZW50bHkgc3VwcG9ydHMgYWxsIG1vZGVybiBicm93c2VycywgYW5kIHdlIGhhdmUgZG9uZSBvdXIgYmVzdCB0byBpbmNsdWRlIHN1cHBvcnQgZm9yIG1vc3Qgb2xkZXIKICogYnJvd3NlcnMuIElmIHlvdSBmaW5kIGFuIGlzc3VlIHdpdGggYW55IHNwZWNpZmljIE9TL2Jyb3dzZXIgY29tYmluYXRpb24sIHBsZWFzZSB2aXNpdCBodHRwOi8vY29tbXVuaXR5LmNyZWF0ZWpzLmNvbS8KICogYW5kIHJlcG9ydCBpdC4KICoKICogPGg0PkdldHRpbmcgU3RhcnRlZDwvaDQ+CiAqIFRvIGdldCBzdGFydGVkLCBjaGVjayBvdXQgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlIn19e3svY3Jvc3NMaW5rfX0gY2xhc3MsIHdoaWNoIGluY2x1ZGVzIGEgcXVpY2sgb3ZlcnZpZXcgb2YgaG93CiAqIHRvIGxvYWQgZmlsZXMgYW5kIHByb2Nlc3MgcmVzdWx0cy4KICoKICogPGg0PkV4YW1wbGU8L2g0PgogKgogKiAgICAgIHZhciBxdWV1ZSA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoKTsKICogICAgICBxdWV1ZS5pbnN0YWxsUGx1Z2luKGNyZWF0ZWpzLlNvdW5kKTsKICogICAgICBxdWV1ZS5vbigiY29tcGxldGUiLCBoYW5kbGVDb21wbGV0ZSwgdGhpcyk7CiAqICAgICAgcXVldWUubG9hZEZpbGUoe2lkOiJzb3VuZCIsIHNyYzoiaHR0cDovL3BhdGgvdG8vc291bmQubXAzIn0pOwogKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChbCiAqICAgICAgICAgIHtpZDogIm15SW1hZ2UiLCBzcmM6InBhdGgvdG8vbXlJbWFnZS5qcGcifQogKiAgICAgIF0pOwogKiAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbXBsZXRlKCkgewogKiAgICAgICAgICBjcmVhdGVqcy5Tb3VuZC5wbGF5KCJzb3VuZCIpOwogKiAgICAgICAgICB2YXIgaW1hZ2UgPSBxdWV1ZS5nZXRSZXN1bHQoIm15SW1hZ2UiKTsKICogICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbWFnZSk7CiAqICAgICAgfQogKgogKiA8Yj5JbXBvcnRhbnQgbm90ZSBvbiBwbHVnaW5zOjwvYj4gUGx1Z2lucyBtdXN0IGJlIGluc3RhbGxlZCA8aT5iZWZvcmU8L2k+IGl0ZW1zIGFyZSBhZGRlZCB0byB0aGUgcXVldWUsIG90aGVyd2lzZQogKiB0aGV5IHdpbGwgbm90IGJlIHByb2Nlc3NlZCwgZXZlbiBpZiB0aGUgbG9hZCBoYXMgbm90IGFjdHVhbGx5IGtpY2tlZCBvZmYgeWV0LiBQbHVnaW4gZnVuY3Rpb25hbGl0eSBpcyBoYW5kbGVkIHdoZW4KICogdGhlIGl0ZW1zIGFyZSBhZGRlZCB0byB0aGUgTG9hZFF1ZXVlLgogKgogKiA8aDQ+QnJvd3NlciBTdXBwb3J0PC9oND4KICogUHJlbG9hZEpTIGlzIHBhcnRpYWxseSBzdXBwb3J0ZWQgaW4gYWxsIGJyb3dzZXJzLCBhbmQgZnVsbHkgc3VwcG9ydGVkIGluIGFsbCBtb2Rlcm4gYnJvd3NlcnMuIEtub3duIGV4Y2VwdGlvbnM6CiAqIDx1bD48bGk+WEhSIGxvYWRpbmcgb2YgYW55IGNvbnRlbnQgd2lsbCBub3Qgd29yayBpbiBtYW55IG9sZGVyIGJyb3dzZXJzIChTZWUgYSBtYXRyaXggaGVyZTogPGEgaHJlZj0iaHR0cDovL2Nhbml1c2UuY29tL3hocjIiIHRhcmdldD0iX2JsYW5rIj5odHRwOi8vY2FuaXVzZS5jb20veGhyMjwvYT4pLgogKiAgICAgIEluIG1hbnkgY2FzZXMsIHlvdSBjYW4gZmFsbCBiYWNrIG9uIHRhZyBsb2FkaW5nIChpbWFnZXMsIGF1ZGlvLCBDU1MsIHNjcmlwdHMsIFNWRywgYW5kIEpTT05QKS4gVGV4dCBhbmQKICogICAgICBXZWJBdWRpbyB3aWxsIG9ubHkgd29yayB3aXRoIFhIUi48L2xpPgogKiAgICAgIDxsaT5Tb21lIGZvcm1hdHMgaGF2ZSBwb29yIHN1cHBvcnQgZm9yIGNvbXBsZXRlIGV2ZW50cyBpbiBJRSA2LCA3LCBhbmQgOCAoU1ZHLCB0YWcgbG9hZGluZyBvZiBzY3JpcHRzLCBYTUwvSlNPTik8L2xpPgogKiAgICAgIDxsaT5PcGVyYSBoYXMgcG9vciBzdXBwb3J0IGZvciBTVkcgbG9hZGluZyB3aXRoIFhIUjwvbGk+CiAqICAgICAgPGxpPkNTUyBsb2FkaW5nIGluIEFuZHJvaWQgYW5kIFNhZmFyaSB3aWxsIG5vdCB3b3JrIHdpdGggdGFncyAoY3VycmVudGx5LCBhIHdvcmthcm91bmQgaXMgaW4gcHJvZ3Jlc3MpPC9saT4KICogICAgICA8bGk+TG9jYWwgbG9hZGluZyBpcyBub3QgcGVybWl0dGVkIHdpdGggWEhSLCB3aGljaCBpcyByZXF1aXJlZCBieSBzb21lIGZpbGUgZm9ybWF0cy4gV2hlbiB0ZXN0aW5nIGxvY2FsIGNvbnRlbnQKICogICAgICB1c2UgZWl0aGVyIGEgbG9jYWwgc2VydmVyLCBvciBlbmFibGUgdGFnIGxvYWRpbmcsIHdoaWNoIGlzIHN1cHBvcnRlZCBmb3IgbW9zdCBmb3JtYXRzLiBTZWUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0VXNlWEhSIn19e3svY3Jvc3NMaW5rfX0KICogICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi48L2xpPgogKiA8L3VsPgogKgogKiA8aDQ+Q3Jvc3MtZG9tYWluIExvYWRpbmc8L2g0PgogKiBNb3N0IGNvbnRlbnQgdHlwZXMgY2FuIGJlIGxvYWRlZCBjcm9zcy1kb21haW4sIGFzIGxvbmcgYXMgdGhlIHNlcnZlciBzdXBwb3J0cyBDT1JTLiBQcmVsb2FkSlMgYWxzbyBoYXMgaW50ZXJuYWwKICogc3VwcG9ydCBmb3IgaW1hZ2VzIHNlcnZlZCBmcm9tIGEgQ09SUy1lbmFibGVkIHNlcnZlciwgdmlhIHRoZSBgY3Jvc3NPcmlnaW5gIGFyZ3VtZW50IG9uIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZSJ9fXt7L2Nyb3NzTGlua319CiAqIGNvbnN0cnVjdG9yLiBJZiBzZXQgdG8gYSBzdHJpbmcgdmFsdWUgKHN1Y2ggYXMgIkFub255bW91cyIpLCB0aGUgImNyb3NzT3JpZ2luIiBwcm9wZXJ0eSBvZiBpbWFnZXMgZ2VuZXJhdGVkIGJ5CiAqIFByZWxvYWRKUyBpcyBzZXQgdG8gdGhhdCB2YWx1ZS4gUGxlYXNlIG5vdGUgdGhhdCBzZXR0aW5nIGEgYGNyb3NzT3JpZ2luYCB2YWx1ZSBvbiBhbiBpbWFnZSB0aGF0IGlzIHNlcnZlZCBmcm9tIGEKICogc2VydmVyIHdpdGhvdXQgQ09SUyB3aWxsIGNhdXNlIG90aGVyIGVycm9ycy4gRm9yIG1vcmUgaW5mbyBvbiBDT1JTLCB2aXNpdCBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1vcmlnaW5fcmVzb3VyY2Vfc2hhcmluZy4KICoKICogQG1vZHVsZSBQcmVsb2FkSlMKICogQG1haW4gUHJlbG9hZEpTCiAqLwoKLy8gbmFtZXNwYWNlOgp0aGlzLmNyZWF0ZWpzID0gdGhpcy5jcmVhdGVqc3x8e307CgovKgpUT0RPOiBXSU5ET1dTIElTU1VFUwoJKiBObyBlcnJvciBmb3IgSFRNTCBhdWRpbyBpbiBJRSA2NzgKCSogU1ZHIG5vIGZhaWx1cmUgZXJyb3IgaW4gSUUgNjcgKG1heWJlIDgpIFRBR1MgQU5EIFhIUgoJKiBObyBzY3JpcHQgY29tcGxldGUgaGFuZGxlciBpbiBJRSA2NyBUQUdTIChYSFIgaXMgZmluZSkKCSogTm8gWE1ML0pTT04gaW4gSUU2IFRBR1MKCSogTmVlZCB0byBoaWRlIGxvYWRpbmcgU1ZHIGluIE9wZXJhIFRBR1MKCSogTm8gQ1NTIG9ubG9hZC9yZWFkeXN0YXRlY2hhbmdlIGluIFNhZmFyaSBvciBBbmRyb2lkIFRBR1MgKHJlcXVpcmVzIHJ1bGUgY2hlY2tpbmcpCgkqIFNWRyBubyBsb2FkIG9yIGZhaWx1cmUgaW4gT3BlcmEgWEhSCgkqIFJlcG9ydGVkIGlzc3VlcyB3aXRoIElFNy84CiAqLwoKKGZ1bmN0aW9uKCkgewoJInVzZSBzdHJpY3QiOwoKCS8qKgoJICogVGhlIExvYWRRdWV1ZSBjbGFzcyBpcyB0aGUgbWFpbiBBUEkgZm9yIHByZWxvYWRpbmcgY29udGVudC4gTG9hZFF1ZXVlIGlzIGEgbG9hZCBtYW5hZ2VyLCB3aGljaCBjYW4gcHJlbG9hZCBlaXRoZXIKCSAqIGEgc2luZ2xlIGZpbGUsIG9yIHF1ZXVlIG9mIGZpbGVzLgoJICoKCSAqIDxiPkNyZWF0aW5nIGEgUXVldWU8L2I+PGJyIC8+CgkgKiBUbyB1c2UgTG9hZFF1ZXVlLCBjcmVhdGUgYSBMb2FkUXVldWUgaW5zdGFuY2UuIElmIHlvdSB3YW50IHRvIGZvcmNlIHRhZyBsb2FkaW5nIHdoZXJlIHBvc3NpYmxlLCBzZXQgdGhlIHVzZVhIUgoJICogYXJndW1lbnQgdG8gZmFsc2UuCgkgKgoJICogICAgICB2YXIgcXVldWUgPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUpOwoJICoKCSAqIDxiPkxpc3RlbmluZyBmb3IgRXZlbnRzPC9iPjxiciAvPgoJICogQWRkIGFueSBsaXN0ZW5lcnMgeW91IHdhbnQgdG8gdGhlIHF1ZXVlLiBTaW5jZSBQcmVsb2FkSlMgMC4zLjAsIHRoZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlciJ9fXt7L2Nyb3NzTGlua319CgkgKiBsZXRzIHlvdSBhZGQgYXMgbWFueSBsaXN0ZW5lcnMgYXMgeW91IHdhbnQgZm9yIGV2ZW50cy4gWW91IGNhbiBzdWJzY3JpYmUgdG8gdGhlIGZvbGxvd2luZyBldmVudHM6PHVsPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2NvbXBsZXRlOmV2ZW50In19e3svY3Jvc3NMaW5rfX06IGZpcmVkIHdoZW4gYSBxdWV1ZSBjb21wbGV0ZXMgbG9hZGluZyBhbGwKCSAqICAgICBmaWxlczwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvZXJyb3I6ZXZlbnQifX17ey9jcm9zc0xpbmt9fTogZmlyZWQgd2hlbiB0aGUgcXVldWUgZW5jb3VudGVycyBhbiBlcnJvciB3aXRoCgkgKiAgICAgYW55IGZpbGUuPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJBYnN0cmFjdExvYWRlci9wcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319OiBQcm9ncmVzcyBmb3IgdGhlIGVudGlyZSBxdWV1ZSBoYXMKCSAqICAgICBjaGFuZ2VkLjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVsb2FkOmV2ZW50In19e3svY3Jvc3NMaW5rfX06IEEgc2luZ2xlIGZpbGUgaGFzIGNvbXBsZXRlZCBsb2FkaW5nLjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVwcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319OiBQcm9ncmVzcyBmb3IgYSBzaW5nbGUgZmlsZSBoYXMgY2hhbmdlcy4gTm90ZQoJICogICAgIHRoYXQgb25seSBmaWxlcyBsb2FkZWQgd2l0aCBYSFIgKG9yIHBvc3NpYmx5IGJ5IHBsdWdpbnMpIHdpbGwgZmlyZSBwcm9ncmVzcyBldmVudHMgb3RoZXIgdGhhbiAwIG9yIDEwMCUuPC9saT4KCSAqIDwvdWw+CgkgKgoJICogICAgICBxdWV1ZS5vbigiZmlsZWxvYWQiLCBoYW5kbGVGaWxlTG9hZCwgdGhpcyk7CgkgKiAgICAgIHF1ZXVlLm9uKCJjb21wbGV0ZSIsIGhhbmRsZUNvbXBsZXRlLCB0aGlzKTsKCSAqCgkgKiA8Yj5BZGRpbmcgZmlsZXMgYW5kIG1hbmlmZXN0czwvYj48YnIgLz4KCSAqIEFkZCBmaWxlcyB5b3Ugd2FudCB0byBsb2FkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3IgYWRkIG11bHRpcGxlIGZpbGVzIGF0IGEKCSAqIHRpbWUgdXNpbmcgYSBsaXN0IG9yIGEgbWFuaWZlc3QgZGVmaW5pdGlvbiB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fS4gRmlsZXMgYXJlCgkgKiBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoZSBhY3RpdmUgcXVldWUsIHNvIHlvdSBjYW4gdXNlIHRoZXNlIG1ldGhvZHMgYXMgbWFueSB0aW1lcyBhcyB5b3UgbGlrZSwgd2hlbmV2ZXIgeW91CgkgKiBsaWtlLgoJICoKCSAqICAgICAgcXVldWUubG9hZEZpbGUoImZpbGVQYXRoL2ZpbGUuanBnIik7CgkgKiAgICAgIHF1ZXVlLmxvYWRGaWxlKHtpZDoiaW1hZ2UiLCBzcmM6ImZpbGVQYXRoL2ZpbGUuanBnIn0pOwoJICogICAgICBxdWV1ZS5sb2FkTWFuaWZlc3QoWyJmaWxlUGF0aC9maWxlLmpwZyIsIHtpZDoiaW1hZ2UiLCBzcmM6ImZpbGVQYXRoL2ZpbGUuanBnIn1dKTsKCSAqCgkgKiBJZiB5b3UgcGFzcyBgZmFsc2VgIGFzIHRoZSBgbG9hZE5vd2AgcGFyYW1ldGVyLCB0aGUgcXVldWUgd2lsbCBub3Qga2ljayBvZiB0aGUgbG9hZCBvZiB0aGUgZmlsZXMsIGJ1dCBpdCB3aWxsIG5vdAoJICogc3RvcCBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQuIENhbGwgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvbG9hZCJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCB0byBiZWdpbgoJICogYSBwYXVzZWQgcXVldWUuIE5vdGUgdGhhdCBhIHBhdXNlZCBxdWV1ZSB3aWxsIGF1dG9tYXRpY2FsbHkgcmVzdW1lIHdoZW4gbmV3IGZpbGVzIGFyZSBhZGRlZCB0byBpdCB3aXRoIGEKCSAqIGBsb2FkTm93YCBhcmd1bWVudCBvZiBgdHJ1ZWAuCgkgKgoJICogICAgICBxdWV1ZS5sb2FkKCk7CgkgKgoJICogPGI+RmlsZSBUeXBlczwvYj48YnIgLz4KCSAqIFRoZSBmaWxlIHR5cGUgb2YgYSBtYW5pZmVzdCBpdGVtIGlzIGF1dG8tZGV0ZXJtaW5lZCBieSB0aGUgZmlsZSBleHRlbnNpb24uIFRoZSBwYXR0ZXJuIG1hdGNoaW5nIGluIFByZWxvYWRKUwoJICogc2hvdWxkIGhhbmRsZSB0aGUgbWFqb3JpdHkgb2Ygc3RhbmRhcmQgZmlsZSBhbmQgdXJsIGZvcm1hdHMsIGFuZCB3b3JrcyB3aXRoIGNvbW1vbiBmaWxlIGV4dGVuc2lvbnMuIElmIHlvdSBoYXZlCgkgKiBlaXRoZXIgYSBub24tc3RhbmRhcmQgZmlsZSBleHRlbnNpb24sIG9yIGFyZSBzZXJ2aW5nIHRoZSBmaWxlIHVzaW5nIGEgcHJveHkgc2NyaXB0LCB0aGVuIHlvdSBjYW4gcGFzcyBpbiBhCgkgKiA8Y29kZT50eXBlPC9jb2RlPiBwcm9wZXJ0eSB3aXRoIGFueSBtYW5pZmVzdCBpdGVtLgoJICoKCSAqICAgICAgcXVldWUubG9hZEZpbGUoe3NyYzoicGF0aC90by9teUZpbGUubXAzeCIsIHR5cGU6Y3JlYXRlanMuTG9hZFF1ZXVlLlNPVU5EfSk7CgkgKgoJICogICAgICAvLyBOb3RlIHRoYXQgUHJlbG9hZEpTIHdpbGwgbm90IHJlYWQgYSBmaWxlIGV4dGVuc2lvbiBmcm9tIHRoZSBxdWVyeSBzdHJpbmcKCSAqICAgICAgcXVldWUubG9hZEZpbGUoe3NyYzoiaHR0cDovL3NlcnZlci5jb20vcHJveHk/ZmlsZT1pbWFnZS5qcGciLCB0eXBlOmNyZWF0ZWpzLkxvYWRRdWV1ZS5JTUFHRX0pOwoJICoKCSAqIFN1cHBvcnRlZCB0eXBlcyBhcmUgZGVmaW5lZCBvbiB0aGUgTG9hZFF1ZXVlIGNsYXNzLCBhbmQgaW5jbHVkZToKCSAqIDx1bD4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvQklOQVJZOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IFJhdyBiaW5hcnkgZGF0YSB2aWEgWEhSPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvQ1NTOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IENTUyBmaWxlczwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL0lNQUdFOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IENvbW1vbiBpbWFnZSBmb3JtYXRzPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvSkFWQVNDUklQVDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKYXZhU2NyaXB0IGZpbGVzPC9saT4KCSAqICAgICA8bGk+e3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvSlNPTjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKU09OIGRhdGE8L2xpPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9KU09OUDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBKU09OIGZpbGVzIGNyb3NzLWRvbWFpbjwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL01BTklGRVNUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IEEgbGlzdCBvZiBmaWxlcyB0byBsb2FkIGluIEpTT04gZm9ybWF0LCBzZWUKCSAqICAgICB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fTwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1NPVU5EOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IEF1ZGlvIGZpbGUgZm9ybWF0czwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1NWRzpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBTVkcgZmlsZXM8L2xpPgoJICogICAgIDxsaT57eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9URVhUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX06IFRleHQgZmlsZXMgLSBYSFIgb25seTwvbGk+CgkgKiAgICAgPGxpPnt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL1hNTDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319OiBYTUwgZGF0YTwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIDxiPkhhbmRsaW5nIFJlc3VsdHM8L2I+PGJyIC8+CgkgKiBXaGVuIGEgZmlsZSBpcyBmaW5pc2hlZCBkb3dubG9hZGluZywgYSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319IGV2ZW50IGlzCgkgKiBkaXNwYXRjaGVkLiBJbiBhbiBleGFtcGxlIGFib3ZlLCB0aGVyZSBpcyBhbiBldmVudCBsaXN0ZW5lciBzbmlwcGV0IGZvciBmaWxlbG9hZC4gTG9hZGVkIGZpbGVzIGFyZSB1c3VhbGx5IGEKCSAqIHJlc29sdmVkIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGltbWVkaWF0ZWx5LCBpbmNsdWRpbmc6CgkgKiA8dWw+CgkgKiAgICAgPGxpPkltYWdlOiBBbiAmbHQ7aW1nIC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPkF1ZGlvOiBBbiAmbHQ7YXVkaW8gLyZndDsgdGFnPC9hPgoJICogICAgIDxsaT5KYXZhU2NyaXB0OiBBICZsdDtzY3JpcHQgLyZndDsgdGFnPC9saT4KCSAqICAgICA8bGk+Q1NTOiBBICZsdDtsaW5rIC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPlhNTDogQW4gWE1MIERPTSBub2RlPC9saT4KCSAqICAgICA8bGk+U1ZHOiBBbiAmbHQ7b2JqZWN0IC8mZ3Q7IHRhZzwvbGk+CgkgKiAgICAgPGxpPkpTT046IEEgZm9ybWF0dGVkIEphdmFTY3JpcHQgT2JqZWN0PC9saT4KCSAqICAgICA8bGk+VGV4dDogUmF3IHRleHQ8L2xpPgoJICogICAgIDxsaT5CaW5hcnk6IFRoZSBiaW5hcnkgbG9hZGVkIHJlc3VsdDwvbGk+CgkgKiA8L3VsPgoJICoKCSAqICAgICAgZnVuY3Rpb24gaGFuZGxlRmlsZUxvYWQoZXZlbnQpIHsKCSAqICAgICAgICAgIHZhciBpdGVtID0gZXZlbnQuaXRlbTsgLy8gQSByZWZlcmVuY2UgdG8gdGhlIGl0ZW0gdGhhdCB3YXMgcGFzc2VkIGluIHRvIHRoZSBMb2FkUXVldWUKCSAqICAgICAgICAgIHZhciB0eXBlID0gaXRlbS50eXBlOwoJICoKCSAqICAgICAgICAgIC8vIEFkZCBhbnkgaW1hZ2VzIHRvIHRoZSBwYWdlIGJvZHkuCgkgKiAgICAgICAgICBpZiAodHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSU1BR0UpIHsKCSAqICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGV2ZW50LnJlc3VsdCk7CgkgKiAgICAgICAgICB9CgkgKiAgICAgIH0KCSAqCgkgKiBBdCBhbnkgdGltZSBhZnRlciB0aGUgZmlsZSBoYXMgYmVlbiBsb2FkZWQgKHVzdWFsbHkgYWZ0ZXIgdGhlIHF1ZXVlIGhhcyBjb21wbGV0ZWQpLCBhbnkgcmVzdWx0IGNhbiBiZSBsb29rZWQgdXAKCSAqIHZpYSBpdHMgImlkIiB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9nZXRSZXN1bHQifX17ey9jcm9zc0xpbmt9fS4gSWYgbm8gaWQgd2FzIHByb3ZpZGVkLCB0aGVuIHRoZSAic3JjIiBvcgoJICogZmlsZSBwYXRoIGNhbiBiZSB1c2VkIGluc3RlYWQsIGluY2x1ZGluZyB0aGUgYHBhdGhgIGRlZmluZWQgYnkgYSBtYW5pZmVzdCwgYnV0IDxzdHJvbmc+bm90IGluY2x1ZGluZzwvc3Ryb25nPiBhCgkgKiBiYXNlIHBhdGggZGVmaW5lZCBvbiB0aGUgTG9hZFF1ZXVlLiBJdCBpcyByZWNvbW1lbmRlZCB0byBhbHdheXMgcGFzcyBhbiBpZC4KCSAqCgkgKiAgICAgIHZhciBpbWFnZSA9IHF1ZXVlLmdldFJlc3VsdCgiaW1hZ2UiKTsKCSAqICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbWFnZSk7CgkgKgoJICogUmF3IGxvYWRlZCBjb250ZW50IGNhbiBiZSBhY2Nlc3NlZCB1c2luZyB0aGUgPGNvZGU+cmF3UmVzdWx0PC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fQoJICogZXZlbnQsIG9yIGNhbiBiZSBsb29rZWQgdXAgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZ2V0UmVzdWx0In19e3svY3Jvc3NMaW5rfX0sIHBhc3NpbmcgYHRydWVgIGFzIHRoZSAybmQKCSAqIGFyZ3VtZW50LiBUaGlzIGlzIG9ubHkgYXBwbGljYWJsZSBmb3IgY29udGVudCB0aGF0IGhhcyBiZWVuIHBhcnNlZCBmb3IgdGhlIGJyb3dzZXIsIHNwZWNpZmljYWxseTogSmF2YVNjcmlwdCwKCSAqIENTUywgWE1MLCBTVkcsIGFuZCBKU09OIG9iamVjdHMsIG9yIGFueXRoaW5nIGxvYWRlZCB3aXRoIFhIUi4KCSAqCgkgKiAgICAgIHZhciBpbWFnZSA9IHF1ZXVlLmdldFJlc3VsdCgiaW1hZ2UiLCB0cnVlKTsgLy8gbG9hZCB0aGUgYmluYXJ5IGltYWdlIGRhdGEgbG9hZGVkIHdpdGggWEhSLgoJICoKCSAqIDxiPlBsdWdpbnM8L2I+PGJyIC8+CgkgKiBMb2FkUXVldWUgaGFzIGEgc2ltcGxlIHBsdWdpbiBhcmNoaXRlY3R1cmUgdG8gaGVscCBwcm9jZXNzIGFuZCBwcmVsb2FkIGNvbnRlbnQuIEZvciBleGFtcGxlLCB0byBwcmVsb2FkIGF1ZGlvLAoJICogbWFrZSBzdXJlIHRvIGluc3RhbGwgdGhlIDxhIGhyZWY9Imh0dHA6Ly9zb3VuZGpzLmNvbSI+U291bmRKUzwvYT4gU291bmQgY2xhc3MsIHdoaWNoIHdpbGwgaGVscCBsb2FkIEhUTUwgYXVkaW8sCgkgKiBGbGFzaCBhdWRpbywgYW5kIFdlYkF1ZGlvIGZpbGVzLiBUaGlzIHNob3VsZCBiZSBpbnN0YWxsZWQgPHN0cm9uZz5iZWZvcmU8L3N0cm9uZz4gbG9hZGluZyBhbnkgYXVkaW8gZmlsZXMuCgkgKgoJICogICAgICBxdWV1ZS5pbnN0YWxsUGx1Z2luKGNyZWF0ZWpzLlNvdW5kKTsKCSAqCgkgKiA8aDQ+S25vd24gQnJvd3NlciBJc3N1ZXM8L2g0PgoJICogPHVsPgoJICogICAgIDxsaT5Ccm93c2VycyB3aXRob3V0IGF1ZGlvIHN1cHBvcnQgY2FuIG5vdCBsb2FkIGF1ZGlvIGZpbGVzLjwvbGk+CgkgKiAgICAgPGxpPlNhZmFyaSBvbiBNYWMgT1MgWCBjYW4gb25seSBwbGF5IEhUTUwgYXVkaW8gaWYgUXVpY2tUaW1lIGlzIGluc3RhbGxlZDwvbGk+CgkgKiAgICAgPGxpPkhUTUwgQXVkaW8gdGFncyB3aWxsIG9ubHkgZG93bmxvYWQgdW50aWwgdGhlaXIgPGNvZGU+Y2FuUGxheVRocm91Z2g8L2NvZGU+IGV2ZW50IGlzIGZpcmVkLiBCcm93c2VycyBvdGhlcgoJICogICAgIHRoYW4gQ2hyb21lIHdpbGwgY29udGludWUgdG8gZG93bmxvYWQgaW4gdGhlIGJhY2tncm91bmQuPC9saT4KCSAqICAgICA8bGk+V2hlbiBsb2FkaW5nIHNjcmlwdHMgdXNpbmcgdGFncywgdGhleSBhcmUgYXV0b21hdGljYWxseSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuPC9saT4KCSAqICAgICA8bGk+U2NyaXB0cyBsb2FkZWQgdmlhIFhIUiBtYXkgbm90IGJlIHByb3Blcmx5IGluc3BlY3RhYmxlIHdpdGggYnJvd3NlciB0b29scy48L2xpPgoJICogICAgIDxsaT5JRTYgYW5kIElFNyAoYW5kIHNvbWUgb3RoZXIgYnJvd3NlcnMpIG1heSBub3QgYmUgYWJsZSB0byBsb2FkIFhNTCwgVGV4dCwgb3IgSlNPTiwgc2luY2UgdGhleSByZXF1aXJlCgkgKiAgICAgWEhSIHRvIHdvcmsuPC9saT4KCSAqICAgICA8bGk+Q29udGVudCBsb2FkZWQgdmlhIHRhZ3Mgd2lsbCBub3Qgc2hvdyBwcm9ncmVzcywgYW5kIHdpbGwgY29udGludWUgdG8gZG93bmxvYWQgaW4gdGhlIGJhY2tncm91bmQgd2hlbgoJICogICAgIGNhbmNlbGVkLCBhbHRob3VnaCBubyBldmVudHMgd2lsbCBiZSBkaXNwYXRjaGVkLjwvbGk+CgkgKiA8L3VsPgoJICoKCSAqIEBjbGFzcyBMb2FkUXVldWUKCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3VzZVhIUj10cnVlXSBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHByZWxvYWQgaW5zdGFuY2Ugd2lsbCBmYXZvciBsb2FkaW5nIHdpdGggWEhSIChYTUwgSFRUUAoJICogUmVxdWVzdHMpLCBvciBIVE1MIHRhZ3MuIFdoZW4gdGhpcyBpcyBgZmFsc2VgLCB0aGUgcXVldWUgd2lsbCB1c2UgdGFnIGxvYWRpbmcgd2hlbiBwb3NzaWJsZSwgYW5kIGZhbGwgYmFjayBvbiBYSFIKCSAqIHdoZW4gbmVjZXNzYXJ5LgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aD0iIl0gQSBwYXRoIHRoYXQgd2lsbCBiZSBwcmVwZW5kZWQgb24gdG8gdGhlIHNvdXJjZSBwYXJhbWV0ZXIgb2YgYWxsIGl0ZW1zIGluIHRoZSBxdWV1ZQoJICogYmVmb3JlIHRoZXkgYXJlIGxvYWRlZC4gIFNvdXJjZXMgYmVnaW5uaW5nIHdpdGggYSBwcm90b2NvbCBzdWNoIGFzIGBodHRwOi8vYCBvciBhIHJlbGF0aXZlIHBhdGggc3VjaCBhcyBgLi4vYAoJICogd2lsbCBub3QgcmVjZWl2ZSBhIGJhc2UgcGF0aC4KCSAqIEBwYXJhbSB7U3RyaW5nfEJvb2xlYW59IFtjcm9zc09yaWdpbj0iIl0gQW4gb3B0aW9uYWwgZmxhZyB0byBzdXBwb3J0IGltYWdlcyBsb2FkZWQgZnJvbSBhIENPUlMtZW5hYmxlZCBzZXJ2ZXIuIFRvCgkgKiB1c2UgaXQsIHNldCB0aGlzIHZhbHVlIHRvIGB0cnVlYCwgd2hpY2ggd2lsbCBkZWZhdWx0IHRoZSBjcm9zc09yaWdpbiBwcm9wZXJ0eSBvbiBpbWFnZXMgdG8gIkFub255bW91cyIuIEFueQoJICogc3RyaW5nIHZhbHVlIHdpbGwgYmUgcGFzc2VkIHRocm91Z2gsIGJ1dCBvbmx5ICIiIGFuZCAiQW5vbnltb3VzIiBhcmUgcmVjb21tZW5kZWQuCgkgKiBAY29uc3RydWN0b3IKCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKi8KCXZhciBMb2FkUXVldWUgPSBmdW5jdGlvbih1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbikgewoJCXRoaXMuaW5pdCh1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbik7Cgl9OwoKCXZhciBwID0gTG9hZFF1ZXVlLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5BYnN0cmFjdExvYWRlcigpOwoJTG9hZFF1ZXVlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IExvYWRRdWV1ZTsKCXZhciBzID0gTG9hZFF1ZXVlOwoKCS8qKgoJICogVGltZSBpbiBtaWxsaXNlY29uZHMgdG8gYXNzdW1lIGEgbG9hZCBoYXMgZmFpbGVkLiBBbiB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2Vycm9yOmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50IGlzIGRpc3BhdGNoZWQgaWYgdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCBiZWZvcmUgYW55IGRhdGEgaXMgcmVjZWl2ZWQuCgkgKiBAcHJvcGVydHkgbG9hZFRpbWVvdXQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCA4MDAwCgkgKiBAc3RhdGljCgkgKiBAc2luY2UgMC40LjEKCSAqLwoJcy5sb2FkVGltZW91dCA9IDgwMDA7CgoJLyoqCgkgKiBUaW1lIGluIG1pbGxpc2Vjb25kcyB0byBhc3N1bWUgYSBsb2FkIGhhcyBmYWlsZWQuCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRUaW1lb3V0OnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gcHJvcGVydHkuCgkgKi8KCXMuTE9BRF9USU1FT1VUID0gMDsKCi8vIFByZWxvYWQgVHlwZXMKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IgZ2VuZXJpYyBiaW5hcnkgdHlwZXMuIE5vdGUgdGhhdCBpbWFnZXMgYXJlIGxvYWRlZCBhcyBiaW5hcnkgZmlsZXMgd2hlbiB1c2luZyBYSFIuCgkgKiBAcHJvcGVydHkgQklOQVJZCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgYmluYXJ5CgkgKiBAc3RhdGljCgkgKi8KCXMuQklOQVJZID0gImJpbmFyeSI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBjc3MgZmlsZXMuIENTUyBmaWxlcyBhcmUgbG9hZGVkIHVzaW5nIGEgJmx0O2xpbmsmZ3Q7IHdoZW4gbG9hZGVkIHdpdGggWEhSLCBvciBhCgkgKiAmbHQ7c3R5bGUmZ3Q7IHRhZyB3aGVuIGxvYWRlZCB3aXRoIHRhZ3MuCgkgKiBAcHJvcGVydHkgQ1NTCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgY3NzCgkgKiBAc3RhdGljCgkgKi8KCXMuQ1NTID0gImNzcyI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBpbWFnZSBmaWxlcywgdXN1YWxseSBwbmcsIGdpZiwgb3IganBnL2pwZWcuIEltYWdlcyBhcmUgbG9hZGVkIGludG8gYW4gJmx0O2ltYWdlJmd0OyB0YWcuCgkgKiBAcHJvcGVydHkgSU1BR0UKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAZGVmYXVsdCBpbWFnZQoJICogQHN0YXRpYwoJICovCglzLklNQUdFID0gImltYWdlIjsKCgkvKioKCSAqIFRoZSBwcmVsb2FkIHR5cGUgZm9yIGphdmFzY3JpcHQgZmlsZXMsIHVzdWFsbHkgd2l0aCB0aGUgImpzIiBmaWxlIGV4dGVuc2lvbi4gSmF2YVNjcmlwdCBmaWxlcyBhcmUgbG9hZGVkIGludG8gYQoJICogJmx0O3NjcmlwdCZndDsgdGFnLgoJICoKCSAqIFNpbmNlIHZlcnNpb24gMC40LjErLCBkdWUgdG8gaG93IHRhZy1sb2FkZWQgc2NyaXB0cyB3b3JrLCBhbGwgSmF2YVNjcmlwdCBmaWxlcyBhcmUgYXV0b21hdGljYWxseSBpbmplY3RlZCBpbnRvCgkgKiB0aGUgYm9keSBvZiB0aGUgZG9jdW1lbnQgdG8gbWFpbnRhaW4gcGFyaXR5IGJldHdlZW4gWEhSIGFuZCB0YWctbG9hZGVkIHNjcmlwdHMuIEluIHZlcnNpb24gMC40LjAgYW5kIGVhcmxpZXIsCgkgKiBvbmx5IHRhZy1sb2FkZWQgc2NyaXB0cyBhcmUgaW5qZWN0ZWQuCgkgKiBAcHJvcGVydHkgSkFWQVNDUklQVAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBkZWZhdWx0IGphdmFzY3JpcHQKCSAqIEBzdGF0aWMKCSAqLwoJcy5KQVZBU0NSSVBUID0gImphdmFzY3JpcHQiOwoKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IganNvbiBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIEpTT04gZGF0YSBpcyBsb2FkZWQgYW5kIHBhcnNlZCBpbnRvIGEKCSAqIEphdmFTY3JpcHQgb2JqZWN0LiBOb3RlIHRoYXQgaWYgYSBgY2FsbGJhY2tgIGlzIHByZXNlbnQgb24gdGhlIGxvYWQgaXRlbSwgdGhlIGZpbGUgd2lsbCBiZSBsb2FkZWQgd2l0aCBKU09OUCwKCSAqIG5vIG1hdHRlciB3aGF0IHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS91c2VYSFI6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fSBwcm9wZXJ0eSBpcyBzZXQgdG8sIGFuZCB0aGUgSlNPTgoJICogbXVzdCBjb250YWluIGEgbWF0Y2hpbmcgd3JhcHBlciBmdW5jdGlvbi4KCSAqIEBwcm9wZXJ0eSBKU09OCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQganNvbgoJICogQHN0YXRpYwoJICovCglzLkpTT04gPSAianNvbiI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBqc29ucCBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIEpTT04gZGF0YSBpcyBsb2FkZWQgYW5kIHBhcnNlZCBpbnRvIGEKCSAqIEphdmFTY3JpcHQgb2JqZWN0LiBZb3UgYXJlIHJlcXVpcmVkIHRvIHBhc3MgYSBjYWxsYmFjayBwYXJhbWV0ZXIgdGhhdCBtYXRjaGVzIHRoZSBmdW5jdGlvbiB3cmFwcGVyIGluIHRoZSBKU09OLgoJICogTm90ZSB0aGF0IEpTT05QIHdpbGwgYWx3YXlzIGJlIHVzZWQgaWYgdGhlcmUgaXMgYSBjYWxsYmFjayBwcmVzZW50LCBubyBtYXR0ZXIgd2hhdCB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvdXNlWEhSOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0KCSAqIHByb3BlcnR5IGlzIHNldCB0by4KCSAqIEBwcm9wZXJ0eSBKU09OUAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBkZWZhdWx0IGpzb25wCgkgKiBAc3RhdGljCgkgKi8KCXMuSlNPTlAgPSAianNvbnAiOwoKCS8qKgoJICogVGhlIHByZWxvYWQgdHlwZSBmb3IganNvbi1iYXNlZCBtYW5pZmVzdCBmaWxlcywgdXN1YWxseSB3aXRoIHRoZSAianNvbiIgZmlsZSBleHRlbnNpb24uIFRoZSBKU09OIGRhdGEgaXMgbG9hZGVkCgkgKiBhbmQgcGFyc2VkIGludG8gYSBKYXZhU2NyaXB0IG9iamVjdC4gUHJlbG9hZEpTIHdpbGwgdGhlbiBsb29rIGZvciBhICJtYW5pZmVzdCIgcHJvcGVydHkgaW4gdGhlIEpTT04sIHdoaWNoIGlzIGFuCgkgKiBBcnJheSBvZiBmaWxlcyB0byBsb2FkLCBmb2xsb3dpbmcgdGhlIHNhbWUgZm9ybWF0IGFzIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogbWV0aG9kLiBJZiBhICJjYWxsYmFjayIgaXMgc3BlY2lmaWVkIG9uIHRoZSBtYW5pZmVzdCBvYmplY3QsIHRoZW4gaXQgd2lsbCBiZSBsb2FkZWQgdXNpbmcgSlNPTlAgaW5zdGVhZCwKCSAqIHJlZ2FyZGxlc3Mgb2Ygd2hhdCB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvdXNlWEhSOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gcHJvcGVydHkgaXMgc2V0IHRvLgoJICogQHByb3BlcnR5IE1BTklGRVNUCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgbWFuaWZlc3QKCSAqIEBzdGF0aWMKCSAqIEBzaW5jZSAwLjQuMQoJICovCglzLk1BTklGRVNUID0gIm1hbmlmZXN0IjsKCgkvKioKCSAqIFRoZSBwcmVsb2FkIHR5cGUgZm9yIHNvdW5kIGZpbGVzLCB1c3VhbGx5IG1wMywgb2dnLCBvciB3YXYuIFdoZW4gbG9hZGluZyB2aWEgdGFncywgYXVkaW8gaXMgbG9hZGVkIGludG8gYW4KCSAqICZsdDthdWRpbyZndDsgdGFnLgoJICogQHByb3BlcnR5IFNPVU5ECgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgc291bmQKCSAqIEBzdGF0aWMKCSAqLwoJcy5TT1VORCA9ICJzb3VuZCI7CgoJLyoqCiAgICAgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciBTVkcgZmlsZXMuCgkgKiBAcHJvcGVydHkgU1ZHCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgc3ZnCgkgKiBAc3RhdGljCgkgKi8KCXMuU1ZHID0gInN2ZyI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciB0ZXh0IGZpbGVzLCB3aGljaCBpcyBhbHNvIHRoZSBkZWZhdWx0IGZpbGUgdHlwZSBpZiB0aGUgdHlwZSBjYW4gbm90IGJlIGRldGVybWluZWQuIFRleHQgaXMKCSAqIGxvYWRlZCBhcyByYXcgdGV4dC4KCSAqIEBwcm9wZXJ0eSBURVhUCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgdGV4dAoJICogQHN0YXRpYwoJICovCglzLlRFWFQgPSAidGV4dCI7CgoJLyoqCgkgKiBUaGUgcHJlbG9hZCB0eXBlIGZvciB4bWwgZmlsZXMuIFhNTCBpcyBsb2FkZWQgaW50byBhbiBYTUwgZG9jdW1lbnQuCgkgKiBAcHJvcGVydHkgWE1MCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHQgeG1sCgkgKiBAc3RhdGljCgkgKi8KCXMuWE1MID0gInhtbCI7CgoJLyoqCgkgKiBEZWZpbmVzIGEgUE9TVCByZXF1ZXN0LCB1c2UgZm9yIGEgbWV0aG9kIHZhbHVlIHdoZW4gbG9hZGluZyBkYXRhLgoJICoKCSAqIEB0eXBlIHtzdHJpbmd9CgkgKi8KCXMuUE9TVCA9ICdQT1NUJzsKCgkvKioKCSAqIERlZmluZXMgYSBHRVQgcmVxdWVzdCwgdXNlIGZvciBhIG1ldGhvZCB2YWx1ZSB3aGVuIGxvYWRpbmcgZGF0YS4KCSAqCgkgKiBAdHlwZSB7c3RyaW5nfQoJICovCglzLkdFVCA9ICdHRVQnOwoKCi8vIFByb3RvdHlwZQoJLyoqCgkgKiBBIHBhdGggdGhhdCB3aWxsIGJlIHByZXBlbmRlZCBvbiB0byB0aGUgaXRlbSdzIGBzcmNgLiBUaGUgYF9iYXNlUGF0aGAgcHJvcGVydHkgd2lsbCBvbmx5IGJlIHVzZWQgaWYgYW4gaXRlbSdzCgkgKiBzb3VyY2UgaXMgcmVsYXRpdmUsIGFuZCBkb2VzIG5vdCBpbmNsdWRlIGEgcHJvdG9jb2wgc3VjaCBhcyBgaHR0cDovL2AsIG9yIGEgcmVsYXRpdmUgcGF0aCBzdWNoIGFzIGAuLi9gLgoJICogQHByb3BlcnR5IF9iYXNlUGF0aAoJICogQHR5cGUge1N0cmluZ30KCSAqIEBwcml2YXRlCgkgKiBAc2luY2UgMC4zLjEKCSAqLwoJcC5fYmFzZVBhdGggPSBudWxsOwoKCS8qKgoJICogQW4gb3B0aW9uYWwgZmxhZyB0byBzZXQgb24gaW1hZ2VzIHRoYXQgYXJlIGxvYWRlZCB1c2luZyBQcmVsb2FkSlMsIHdoaWNoIGVuYWJsZXMgQ09SUyBzdXBwb3J0LiBJbWFnZXMgbG9hZGVkCgkgKiBjcm9zcy1kb21haW4gYnkgc2VydmVycyB0aGF0IHN1cHBvcnQgQ09SUyByZXF1aXJlIHRoZSBjcm9zc09yaWdpbiBmbGFnIHRvIGJlIGxvYWRlZCBhbmQgaW50ZXJhY3RlZCB3aXRoIGJ5CgkgKiBhIGNhbnZhcy4gV2hlbiBsb2FkaW5nIGxvY2FsbHksIG9yIHdpdGggYSBzZXJ2ZXIgd2l0aCBubyBDT1JTIHN1cHBvcnQsIHRoaXMgZmxhZyBjYW4gY2F1c2Ugb3RoZXIgc2VjdXJpdHkgaXNzdWVzLAoJICogc28gaXQgaXMgcmVjb21tZW5kZWQgdG8gb25seSBzZXQgaXQgaWYgeW91IGFyZSBzdXJlIHRoZSBzZXJ2ZXIgc3VwcG9ydHMgaXQuIEN1cnJlbnRseSwgc3VwcG9ydGVkIHZhbHVlcyBhcmUgIiIKCSAqIGFuZCAiQW5vbnltb3VzIi4KCSAqIEBwcm9wZXJ0eSBfY3Jvc3NPcmlnaW4KCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAZGVmYXVsdFZhbHVlICIiCgkgKiBAcHJpdmF0ZQoJICogQHNpbmNlIDAuNC4xCgkgKi8KCXAuX2Nyb3NzT3JpZ2luID0gIiI7CgoJLyoqCgkgKiBVc2UgWE1MSHR0cFJlcXVlc3QgKFhIUikgd2hlbiBwb3NzaWJsZS4gTm90ZSB0aGF0IExvYWRRdWV1ZSB3aWxsIGRlZmF1bHQgdG8gdGFnIGxvYWRpbmcgb3IgWEhSIGxvYWRpbmcgZGVwZW5kaW5nCgkgKiBvbiB0aGUgcmVxdWlyZW1lbnRzIGZvciBhIG1lZGlhIHR5cGUuIEZvciBleGFtcGxlLCBIVE1MIGF1ZGlvIGNhbiBub3QgYmUgbG9hZGVkIHdpdGggWEhSLCBhbmQgV2ViQXVkaW8gY2FuIG5vdCBiZQoJICogbG9hZGVkIHdpdGggdGFncywgc28gaXQgd2lsbCBkZWZhdWx0IHRoZSB0aGUgY29ycmVjdCB0eXBlIGluc3RlYWQgb2YgdXNpbmcgdGhlIHVzZXItZGVmaW5lZCB0eXBlLgoJICoKCSAqIDxiPk5vdGU6IFRoaXMgcHJvcGVydHkgaXMgcmVhZC1vbmx5LjwvYj4gVG8gY2hhbmdlIGl0LCBwbGVhc2UgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zZXRVc2VYSFIifX17ey9jcm9zc0xpbmt9fQoJICogbWV0aG9kLCBvciBzcGVjaWZ5IHRoZSBgdXNlWEhSYCBhcmd1bWVudCBpbiB0aGUgTG9hZFF1ZXVlIGNvbnN0cnVjdG9yLgoJICoKCSAqIEBwcm9wZXJ0eSB1c2VYSFIKCSAqIEB0eXBlIHtCb29sZWFufQoJICogQHJlYWRPbmx5CgkgKiBAZGVmYXVsdCB0cnVlCgkgKi8KCXAudXNlWEhSID0gdHJ1ZTsKCgkvKioKCSAqIERldGVybWluZXMgaWYgdGhlIExvYWRRdWV1ZSB3aWxsIHN0b3AgcHJvY2Vzc2luZyB0aGUgY3VycmVudCBxdWV1ZSB3aGVuIGFuIGVycm9yIGlzIGVuY291bnRlcmVkLgoJICogQHByb3BlcnR5IHN0b3BPbkVycm9yCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IGZhbHNlCgkgKi8KCXAuc3RvcE9uRXJyb3IgPSBmYWxzZTsKCgkvKioKCSAqIEVuc3VyZSBsb2FkZWQgc2NyaXB0cyAiY29tcGxldGUiIGluIHRoZSBvcmRlciB0aGV5IGFyZSBzcGVjaWZpZWQuIExvYWRlZCBzY3JpcHRzIGFyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQgaGVhZAoJICogb25jZSB0aGV5IGFyZSBsb2FkZWQuIFNjcmlwdHMgbG9hZGVkIHZpYSB0YWdzIHdpbGwgbG9hZCBvbmUtYXQtYS10aW1lIHdoZW4gdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAsIHdoZXJlYXMKCSAqIHNjcmlwdHMgbG9hZGVkIHVzaW5nIFhIUiBjYW4gbG9hZCBpbiBhbnkgb3JkZXIsIGJ1dCB3aWxsICJmaW5pc2giIGFuZCBiZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQgaW4gdGhlIG9yZGVyCgkgKiBzcGVjaWZpZWQuCgkgKgoJICogQW55IGl0ZW1zIGNhbiBiZSBzZXQgdG8gbG9hZCBpbiBvcmRlciBieSBzZXR0aW5nIHRoZSBgbWFpbnRhaW5PcmRlcmAgcHJvcGVydHkgb24gdGhlIGxvYWQgaXRlbSwgb3IgYnkgZW5zdXJpbmcKCSAqIHRoYXQgb25seSBvbmUgY29ubmVjdGlvbiBjYW4gYmUgb3BlbiBhdCBhIHRpbWUgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fS4KCSAqIE5vdGUgdGhhdCB3aGVuIHRoZSBgbWFpbnRhaW5TY3JpcHRPcmRlcmAgcHJvcGVydHkgaXMgc2V0IHRvIGB0cnVlYCwgc2NyaXB0cyBpdGVtcyBhcmUgYXV0b21hdGljYWxseSBzZXQgdG8KCSAqIGBtYWludGFpbk9yZGVyPXRydWVgLCBhbmQgY2hhbmdpbmcgdGhlIGBtYWludGFpblNjcmlwdE9yZGVyYCB0byBgZmFsc2VgIGR1cmluZyBhIGxvYWQgd2lsbCBub3QgY2hhbmdlIGl0ZW1zCgkgKiBhbHJlYWR5IGluIGEgcXVldWUuCgkgKgoJICogPGg0PkV4YW1wbGU8L2g0PgoJICoKCSAqICAgICAgdmFyIHF1ZXVlID0gbmV3IGNyZWF0ZWpzLkxvYWRRdWV1ZSgpOwoJICogICAgICBxdWV1ZS5zZXRNYXhDb25uZWN0aW9ucygzKTsgLy8gU2V0IGEgaGlnaGVyIG51bWJlciB0byBsb2FkIG11bHRpcGxlIGl0ZW1zIGF0IG9uY2UKCSAqICAgICAgcXVldWUubWFpbnRhaW5TY3JpcHRPcmRlciA9IHRydWU7IC8vIEVuc3VyZSBzY3JpcHRzIGFyZSBsb2FkZWQgaW4gb3JkZXIKCSAqICAgICAgcXVldWUubG9hZE1hbmlmZXN0KFsKCSAqICAgICAgICAgICJzY3JpcHQxLmpzIiwKCSAqICAgICAgICAgICJzY3JpcHQyLmpzIiwKCSAqICAgICAgICAgICJpbWFnZS5wbmciLCAvLyBMb2FkIGFueSB0aW1lCgkgKiAgICAgICAgICB7c3JjOiAiaW1hZ2UyLnBuZyIsIG1haW50YWluT3JkZXI6IHRydWV9IC8vIFdpbGwgd2FpdCBmb3Igc2NyaXB0Mi5qcwoJICogICAgICAgICAgImltYWdlMy5wbmciLAoJICogICAgICAgICAgInNjcmlwdDMuanMiIC8vIFdpbGwgd2FpdCBmb3IgaW1hZ2UyLnBuZyBiZWZvcmUgbG9hZGluZyAob3IgY29tcGxldGluZyB3aGVuIGxvYWRpbmcgd2l0aCBYSFIpCgkgKiAgICAgIF0pOwoJICoKCSAqIEBwcm9wZXJ0eSBtYWludGFpblNjcmlwdE9yZGVyCgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBkZWZhdWx0IHRydWUKCSAqLwoJcC5tYWludGFpblNjcmlwdE9yZGVyID0gdHJ1ZTsKCgkvKioKCSAqIFRoZSBuZXh0IHByZWxvYWQgcXVldWUgdG8gcHJvY2VzcyB3aGVuIHRoaXMgb25lIGlzIGNvbXBsZXRlLiBJZiBhbiBlcnJvciBpcyB0aHJvd24gaW4gdGhlIGN1cnJlbnQgcXVldWUsIGFuZAoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc3RvcE9uRXJyb3I6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fSBpcyBgdHJ1ZWAsIHRoZSBuZXh0IHF1ZXVlIHdpbGwgbm90IGJlIHByb2Nlc3NlZC4KCSAqIEBwcm9wZXJ0eSBuZXh0CgkgKiBAdHlwZSB7TG9hZFF1ZXVlfQoJICogQGRlZmF1bHQgbnVsbAoJICovCglwLm5leHQgPSBudWxsOwoKLy8gRXZlbnRzCgkvKioKCSAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbiBpbmRpdmlkdWFsIGZpbGUgaGFzIGxvYWRlZCwgYW5kIGJlZW4gcHJvY2Vzc2VkLgoJICogQGV2ZW50IGZpbGVsb2FkCgkgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBkaXNwYXRjaGVkIHRoZSBldmVudC4KCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBldmVudCB0eXBlLgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGZpbGUgaXRlbSB3aGljaCB3YXMgc3BlY2lmaWVkIGluIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkRmlsZSJ9fXt7L2Nyb3NzTGlua319CgkgKiBvciB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fSBjYWxsLiBJZiBvbmx5IGEgc3RyaW5nIHBhdGggb3IgdGFnIHdhcyBzcGVjaWZpZWQsIHRoZQoJICogb2JqZWN0IHdpbGwgY29udGFpbiB0aGF0IHZhbHVlIGFzIGEgYHNyY2AgcHJvcGVydHkuCgkgKiBAcGFyYW0ge09iamVjdH0gcmVzdWx0IFRoZSBIVE1MIHRhZyBvciBwYXJzZWQgcmVzdWx0IG9mIHRoZSBsb2FkZWQgaXRlbS4KCSAqIEBwYXJhbSB7T2JqZWN0fSByYXdSZXN1bHQgVGhlIHVucHJvY2Vzc2VkIHJlc3VsdCwgdXN1YWxseSB0aGUgcmF3IHRleHQgb3IgYmluYXJ5IGRhdGEgYmVmb3JlIGl0IGlzIGNvbnZlcnRlZAoJICogdG8gYSB1c2FibGUgb2JqZWN0LgoJICogQHNpbmNlIDAuMy4wCgkgKi8KCgkvKioKCSAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhbiBhbiBpbmRpdmlkdWFsIGZpbGUgcHJvZ3Jlc3MgY2hhbmdlcy4KCSAqIEBldmVudCBmaWxlcHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgb2JqZWN0IHRoYXQgZGlzcGF0Y2hlZCB0aGUgZXZlbnQuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBmaWxlIGl0ZW0gd2hpY2ggd2FzIHNwZWNpZmllZCBpbiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0gY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUKCSAqIG9iamVjdCB3aWxsIGNvbnRhaW4gdGhhdCB2YWx1ZSBhcyBhIGBzcmNgIHByb3BlcnR5LgoJICogQHBhcmFtIHtOdW1iZXJ9IGxvYWRlZCBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRoYXQgaGF2ZSBiZWVuIGxvYWRlZC4gTm90ZSB0aGF0IHRoaXMgbWF5IGp1c3QgYmUgYSBwZXJjZW50YWdlIG9mIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gdG90YWwgVGhlIHRvdGFsIG51bWJlciBvZiBieXRlcy4gSWYgaXQgaXMgdW5rbm93biwgdGhlIHZhbHVlIGlzIDEuCgkgKiBAcGFyYW0ge051bWJlcn0gcHJvZ3Jlc3MgVGhlIGFtb3VudCB0aGF0IGhhcyBiZWVuIGxvYWRlZCBiZXR3ZWVuIDAgYW5kIDEuCgkgKiBAc2luY2UgMC4zLjAKCSAqLwoKCS8qKgoJICogVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGFuIGluZGl2aWR1YWwgZmlsZSBzdGFydHMgdG8gbG9hZC4KCSAqIEBldmVudCBmaWxlc3RhcnQKCSAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgb2JqZWN0IHRoYXQgZGlzcGF0Y2hlZCB0aGUgZXZlbnQuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBmaWxlIGl0ZW0gd2hpY2ggd2FzIHNwZWNpZmllZCBpbiB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0gY2FsbC4gSWYgb25seSBhIHN0cmluZyBwYXRoIG9yIHRhZyB3YXMgc3BlY2lmaWVkLCB0aGUKCSAqIG9iamVjdCB3aWxsIGNvbnRhaW4gdGhhdCB2YWx1ZSBhcyBhIHByb3BlcnR5LgoJICovCgoJLy9UT0RPOiBEZXByZWNhdGVkCgkvKioKCSAqIFJFTU9WRUQuIFVzZSB7eyNjcm9zc0xpbmsgIkV2ZW50RGlzcGF0Y2hlci9hZGRFdmVudExpc3RlbmVyIn19e3svY3Jvc3NMaW5rfX0gYW5kIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkZpbGVMb2FkCgkgKiBAdHlwZSB7RnVuY3Rpb259CgkgKiBAZGVwcmVjYXRlZCBVc2UgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdGhlICJmaWxlbG9hZCIgZXZlbnQuCgkgKi8KCS8qKgoJICogUkVNT1ZFRC4gVXNlIHt7I2Nyb3NzTGluayAiRXZlbnREaXNwYXRjaGVyL2FkZEV2ZW50TGlzdGVuZXIifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2ZpbGVwcm9ncmVzczpldmVudCJ9fXt7L2Nyb3NzTGlua319CgkgKiBldmVudC4KCSAqIEBwcm9wZXJ0eSBvbkZpbGVQcm9ncmVzcwoJICogQHR5cGUge0Z1bmN0aW9ufQoJICogQGRlcHJlY2F0ZWQgVXNlIGFkZEV2ZW50TGlzdGVuZXIgYW5kIHRoZSAiZmlsZXByb2dyZXNzIiBldmVudC4KCSAqLwoKCi8vIFByb3RlY3RlZAoJLyoqCgkgKiBBbiBvYmplY3QgaGFzaCBvZiBjYWxsYmFja3MgdGhhdCBhcmUgZmlyZWQgZm9yIGVhY2ggZmlsZSB0eXBlIGJlZm9yZSB0aGUgZmlsZSBpcyBsb2FkZWQsIGdpdmluZyBwbHVnaW5zIHRoZQoJICogYWJpbGl0eSB0byBvdmVycmlkZSBwcm9wZXJ0aWVzIG9mIHRoZSBsb2FkLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9pbnN0YWxsUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCSAqIEBwcm9wZXJ0eSBfdHlwZUNhbGxiYWNrcwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3R5cGVDYWxsYmFja3MgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgY2FsbGJhY2tzIHRoYXQgYXJlIGZpcmVkIGZvciBlYWNoIGZpbGUgZXh0ZW5zaW9uIGJlZm9yZSB0aGUgZmlsZSBpcyBsb2FkZWQsIGdpdmluZyBwbHVnaW5zIHRoZQoJICogYWJpbGl0eSB0byBvdmVycmlkZSBwcm9wZXJ0aWVzIG9mIHRoZSBsb2FkLiBQbGVhc2Ugc2VlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9pbnN0YWxsUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCSAqIEBwcm9wZXJ0eSBfZXh0ZW5zaW9uQ2FsbGJhY2tzCgkgKiBAdHlwZSB7bnVsbH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2V4dGVuc2lvbkNhbGxiYWNrcyA9IG51bGw7CgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHRoZSBsb2FkU3RhcnQgZXZlbnQgd2FzIGRpc3BhdGNoZWQgYWxyZWFkeS4gVGhpcyBldmVudCBpcyBvbmx5IGZpcmVkIG9uZSB0aW1lLCB3aGVuIHRoZSBmaXJzdAoJICogZmlsZSBpcyByZXF1ZXN0ZWQuCgkgKiBAcHJvcGVydHkgX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQKCSAqIEB0eXBlIHtCb29sZWFufQoJICogQGRlZmF1bHQgZmFsc2UKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCgkvKioKCSAqIFRoZSBudW1iZXIgb2YgbWF4aW11bSBvcGVuIGNvbm5lY3Rpb25zIHRoYXQgYSBsb2FkUXVldWUgdHJpZXMgdG8gbWFpbnRhaW4uIFBsZWFzZSBzZWUKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldE1heENvbm5lY3Rpb25zIn19e3svY3Jvc3NMaW5rfX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCgkgKiBAcHJvcGVydHkgX21heENvbm5lY3Rpb25zCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlZmF1bHQgMQoJICogQHByaXZhdGUKCSAqLwoJcC5fbWF4Q29ubmVjdGlvbnMgPSAxOwoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiB0aGVyZSBpcyBjdXJyZW50bHkgYSBzY3JpcHQgbG9hZGluZy4gVGhpcyBoZWxwcyBlbnN1cmUgdGhhdCBvbmx5IGEgc2luZ2xlIHNjcmlwdCBsb2FkcyBhdCBvbmNlIHdoZW4KCSAqIHVzaW5nIGEgc2NyaXB0IHRhZyB0byBkbyBwcmVsb2FkaW5nLgoJICogQHByb3BlcnR5IF9jdXJyZW50bHlMb2FkaW5nU2NyaXB0CgkgKiBAdHlwZSB7Qm9vbGVhbn0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2N1cnJlbnRseUxvYWRpbmdTY3JpcHQgPSBudWxsOwoKCS8qKgoJICogQW4gYXJyYXkgY29udGFpbmluZyB0aGUgY3VycmVudGx5IGRvd25sb2FkaW5nIGZpbGVzLgoJICogQHByb3BlcnR5IF9jdXJyZW50TG9hZHMKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2N1cnJlbnRMb2FkcyA9IG51bGw7CgoJLyoqCgkgKiBBbiBhcnJheSBjb250YWluaW5nIHRoZSBxdWV1ZWQgaXRlbXMgdGhhdCBoYXZlIG5vdCB5ZXQgc3RhcnRlZCBkb3dubG9hZGluZy4KCSAqIEBwcm9wZXJ0eSBfbG9hZFF1ZXVlCgkgKiBAdHlwZSB7QXJyYXl9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkUXVldWUgPSBudWxsOwoKCS8qKgoJICogQW4gYXJyYXkgY29udGFpbmluZyBkb3dubG9hZHMgdGhhdCBoYXZlIG5vdCBjb21wbGV0ZWQsIHNvIHRoYXQgdGhlIExvYWRRdWV1ZSBjYW4gYmUgcHJvcGVybHkgcmVzZXQuCgkgKiBAcHJvcGVydHkgX2xvYWRRdWV1ZUJhY2t1cAoJICogQHR5cGUge0FycmF5fQoJICogQHByaXZhdGUKCSAqLwoJcC5fbG9hZFF1ZXVlQmFja3VwID0gbnVsbDsKCgkvKioKCSAqIEFuIG9iamVjdCBoYXNoIG9mIGl0ZW1zIHRoYXQgaGF2ZSBmaW5pc2hlZCBkb3dubG9hZGluZywgaW5kZXhlZCBieSBpdGVtIElEcy4KCSAqIEBwcm9wZXJ0eSBfbG9hZEl0ZW1zQnlJZAoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRJdGVtc0J5SWQgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgaXRlbXMgdGhhdCBoYXZlIGZpbmlzaGVkIGRvd25sb2FkaW5nLCBpbmRleGVkIGJ5IGl0ZW0gc291cmNlLgoJICogQHByb3BlcnR5IF9sb2FkSXRlbXNCeVNyYwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRJdGVtc0J5U3JjID0gbnVsbDsKCgkvKioKCSAqIEFuIG9iamVjdCBoYXNoIG9mIGxvYWRlZCBpdGVtcywgaW5kZXhlZCBieSB0aGUgSUQgb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwcm9wZXJ0eSBfbG9hZGVkUmVzdWx0cwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRlZFJlc3VsdHMgPSBudWxsOwoKCS8qKgoJICogQW4gb2JqZWN0IGhhc2ggb2YgdW4tcGFyc2VkIGxvYWRlZCBpdGVtcywgaW5kZXhlZCBieSB0aGUgSUQgb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwcm9wZXJ0eSBfbG9hZGVkUmF3UmVzdWx0cwoJICogQHR5cGUge09iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWRlZFJhd1Jlc3VsdHMgPSBudWxsOwoKCS8qKgoJICogVGhlIG51bWJlciBvZiBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZXF1ZXN0ZWQuIFRoaXMgaGVscHMgbWFuYWdlIGFuIG92ZXJhbGwgcHJvZ3Jlc3Mgd2l0aG91dCBrbm93aW5nIGhvdyBsYXJnZQoJICogdGhlIGZpbGVzIGFyZSBiZWZvcmUgdGhleSBhcmUgZG93bmxvYWRlZC4KCSAqIEBwcm9wZXJ0eSBfbnVtSXRlbXMKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAZGVmYXVsdCAwCgkgKiBAcHJpdmF0ZQoJICovCglwLl9udW1JdGVtcyA9IDA7CgoJLyoqCgkgKiBUaGUgbnVtYmVyIG9mIGl0ZW1zIHRoYXQgaGF2ZSBjb21wbGV0ZWQgbG9hZGVkLiBUaGlzIGhlbHBzIG1hbmFnZSBhbiBvdmVyYWxsIHByb2dyZXNzIHdpdGhvdXQga25vd2luZyBob3cgbGFyZ2UKCSAqIHRoZSBmaWxlcyBhcmUgYmVmb3JlIHRoZXkgYXJlIGRvd25sb2FkZWQuCgkgKiBAcHJvcGVydHkgX251bUl0ZW1zTG9hZGVkCgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQGRlZmF1bHQgMAoJICogQHByaXZhdGUKCSAqLwoJcC5fbnVtSXRlbXNMb2FkZWQgPSAwOwoKCS8qKgoJICogQSBsaXN0IG9mIHNjcmlwdHMgaW4gdGhlIG9yZGVyIHRoZXkgd2VyZSByZXF1ZXN0ZWQuIFRoaXMgaGVscHMgZW5zdXJlIHRoYXQgc2NyaXB0cyBhcmUgImNvbXBsZXRlZCIgaW4gdGhlIHJpZ2h0CgkgKiBvcmRlci4KCSAqIEBwcm9wZXJ0eSBfc2NyaXB0T3JkZXIKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3NjcmlwdE9yZGVyID0gbnVsbDsKCgkvKioKCSAqIEEgbGlzdCBvZiBzY3JpcHRzIHRoYXQgaGF2ZSBiZWVuIGxvYWRlZC4gSXRlbXMgYXJlIGFkZGVkIHRvIHRoaXMgbGlzdCBhcyA8Y29kZT5udWxsPC9jb2RlPiB3aGVuIHRoZXkgYXJlCgkgKiByZXF1ZXN0ZWQsIGNvbnRhaW4gdGhlIGxvYWRlZCBpdGVtIGlmIGl0IGhhcyBjb21wbGV0ZWQsIGJ1dCBub3QgYmVlbiBkaXNwYXRjaGVkIHRvIHRoZSB1c2VyLCBhbmQgPGNvZGU+dHJ1ZTwvdHJ1ZT4KCSAqIG9uY2UgdGhleSBhcmUgY29tcGxldGUgYW5kIGhhdmUgYmVlbiBkaXNwYXRjaGVkLgoJICogQHByb3BlcnR5IF9sb2FkZWRTY3JpcHRzCgkgKiBAdHlwZSB7QXJyYXl9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkZWRTY3JpcHRzID0gbnVsbDsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbih1c2VYSFIsIGJhc2VQYXRoLCBjcm9zc09yaWdpbikgewoJCXRoaXMuX251bUl0ZW1zID0gdGhpcy5fbnVtSXRlbXNMb2FkZWQgPSAwOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCXRoaXMuX2xvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCgkJdGhpcy5fY3VycmVudExvYWRzID0gW107CgkJdGhpcy5fbG9hZFF1ZXVlID0gW107CgkJdGhpcy5fbG9hZFF1ZXVlQmFja3VwID0gW107CgkJdGhpcy5fc2NyaXB0T3JkZXIgPSBbXTsKCQl0aGlzLl9sb2FkZWRTY3JpcHRzID0gW107CgkJdGhpcy5fbG9hZEl0ZW1zQnlJZCA9IHt9OwoJCXRoaXMuX2xvYWRJdGVtc0J5U3JjID0ge307CgkJdGhpcy5fbG9hZGVkUmVzdWx0cyA9IHt9OwoJCXRoaXMuX2xvYWRlZFJhd1Jlc3VsdHMgPSB7fTsKCgkJLy8gQ2FsbGJhY2tzIGZvciBwbHVnaW5zCgkJdGhpcy5fdHlwZUNhbGxiYWNrcyA9IHt9OwoJCXRoaXMuX2V4dGVuc2lvbkNhbGxiYWNrcyA9IHt9OwoKCQl0aGlzLl9iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCXRoaXMuc2V0VXNlWEhSKHVzZVhIUik7CgkJdGhpcy5fY3Jvc3NPcmlnaW4gPSAoY3Jvc3NPcmlnaW4gPT09IHRydWUpCgkJCQk/ICJBbm9ueW1vdXMiIDogKGNyb3NzT3JpZ2luID09PSBmYWxzZSB8fCBjcm9zc09yaWdpbiA9PSBudWxsKQoJCQkJPyAiIiA6IGNyb3NzT3JpZ2luOwoJfTsKCgkvKioKCSAqIENoYW5nZSB0aGUgdXNYSFIgdmFsdWUuIE5vdGUgdGhhdCBpZiB0aGlzIGlzIHNldCB0byB0cnVlLCBpdCBtYXkgZmFpbCBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIncyBjYXBhYmlsaXRpZXMuCgkgKiBBZGRpdGlvbmFsbHksIHNvbWUgZmlsZXMgcmVxdWlyZSBYSFIgaW4gb3JkZXIgdG8gbG9hZCwgc3VjaCBhcyBKU09OICh3aXRob3V0IEpTT05QKSwgVGV4dCwgYW5kIFhNTCwgc28gWEhSIHdpbGwKCSAqIGJlIHVzZWQgcmVnYXJkbGVzcyBvZiB3aGF0IGlzIHBhc3NlZCB0byB0aGlzIG1ldGhvZC4KCSAqIEBtZXRob2Qgc2V0VXNlWEhSCgkgKiBAcGFyYW0ge0Jvb2xlYW59IHZhbHVlIFRoZSBuZXcgdXNlWEhSIHZhbHVlIHRvIHNldC4KCSAqIEByZXR1cm4ge0Jvb2xlYW59IFRoZSBuZXcgdXNlWEhSIHZhbHVlLiBJZiBYSFIgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnJvd3NlciwgdGhpcyB3aWxsIHJldHVybiBmYWxzZSwgZXZlbiBpZgoJICogdGhlIHByb3ZpZGVkIHZhbHVlIGFyZ3VtZW50IHdhcyB0cnVlLgoJICogQHNpbmNlIDAuMy4wCgkgKi8KCXAuc2V0VXNlWEhSID0gZnVuY3Rpb24odmFsdWUpIHsKCQkvLyBEZXRlcm1pbmUgaWYgd2UgY2FuIHVzZSBYSFIuIFhIUiBkZWZhdWx0cyB0byBUUlVFLCBidXQgdGhlIGJyb3dzZXIgbWF5IG5vdCBzdXBwb3J0IGl0LgoJCS8vVE9ETzogU2hvdWxkIHdlIGJlIGNoZWNraW5nIGZvciB0aGUgb3RoZXIgWEhSIHR5cGVzPyBNaWdodCBoYXZlIHRvIGRvIGEgdHJ5L2NhdGNoIG9uIHRoZSBkaWZmZXJlbnQgdHlwZXMgc2ltaWxhciB0byBjcmVhdGVYSFIuCgkJdGhpcy51c2VYSFIgPSAodmFsdWUgIT0gZmFsc2UgJiYgd2luZG93LlhNTEh0dHBSZXF1ZXN0ICE9IG51bGwpOwoJCXJldHVybiB0aGlzLnVzZVhIUjsKCX07CgoJLyoqCgkgKiBTdG9wcyBhbGwgcXVldWVkIGFuZCBsb2FkaW5nIGl0ZW1zLCBhbmQgY2xlYXJzIHRoZSBxdWV1ZS4gVGhpcyBhbHNvIHJlbW92ZXMgYWxsIGludGVybmFsIHJlZmVyZW5jZXMgdG8gbG9hZGVkCgkgKiBjb250ZW50LCBhbmQgYWxsb3dzIHRoZSBxdWV1ZSB0byBiZSB1c2VkIGFnYWluLgoJICogQG1ldGhvZCByZW1vdmVBbGwKCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlbW92ZUFsbCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVtb3ZlKCk7Cgl9OwoKCS8qKgoJICogU3RvcHMgYW4gaXRlbSBmcm9tIGJlaW5nIGxvYWRlZCwgYW5kIHJlbW92ZXMgaXQgZnJvbSB0aGUgcXVldWUuIElmIG5vdGhpbmcgaXMgcGFzc2VkLCBhbGwgaXRlbXMgYXJlIHJlbW92ZWQuCgkgKiBUaGlzIGFsc28gcmVtb3ZlcyBpbnRlcm5hbCByZWZlcmVuY2VzIHRvIGxvYWRlZCBpdGVtKHMpLgoJICoKCSAqIDxoND5FeGFtcGxlPC9oND4KCSAqCgkgKiAgICAgIHF1ZXVlLmxvYWRNYW5pZmVzdChbCgkgKiAgICAgICAgICB7c3JjOiJ0ZXN0LnBuZyIsIGlkOiJwbmcifSwKCSAqICAgICAgICAgIHtzcmM6InRlc3QuanBnIiwgaWQ6ImpwZyJ9LAoJICogICAgICAgICAge3NyYzoidGVzdC5tcDMiLCBpZDoibXAzIn0KCSAqICAgICAgXSk7CgkgKiAgICAgIHF1ZXVlLnJlbW92ZSgicG5nIik7IC8vIFNpbmdsZSBpdGVtIGJ5IElECgkgKiAgICAgIHF1ZXVlLnJlbW92ZSgicG5nIiwgInRlc3QuanBnIik7IC8vIEl0ZW1zIGFzIGFyZ3VtZW50cy4gTWl4ZWQgaWQgYW5kIHNyYy4KCSAqICAgICAgcXVldWUucmVtb3ZlKFsidGVzdC5wbmciLCAianBnIl0pOyAvLyBJdGVtcyBpbiBhbiBBcnJheS4gTWl4ZWQgaWQgYW5kIHNyYy4KCSAqCgkgKiBAbWV0aG9kIHJlbW92ZQoJICogQHBhcmFtIHtTdHJpbmcgfCBBcnJheX0gaWRzT3JVcmxzKiBUaGUgaWQgb3IgaWRzIHRvIHJlbW92ZSBmcm9tIHRoaXMgcXVldWUuIFlvdSBjYW4gcGFzcyBhbiBpdGVtLCBhbiBhcnJheSBvZgoJICogaXRlbXMsIG9yIG11bHRpcGxlIGl0ZW1zIGFzIGFyZ3VtZW50cy4KCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlbW92ZSA9IGZ1bmN0aW9uKGlkc09yVXJscykgewoJCXZhciBhcmdzID0gbnVsbDsKCgkJaWYgKGlkc09yVXJscyAmJiAhKGlkc09yVXJscyBpbnN0YW5jZW9mIEFycmF5KSkgewoJCQlhcmdzID0gW2lkc09yVXJsc107CgkJfSBlbHNlIGlmIChpZHNPclVybHMpIHsKCQkJYXJncyA9IGlkc09yVXJsczsKCQl9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBpdGVtc1dlcmVSZW1vdmVkID0gZmFsc2U7CgoJCS8vIERlc3Ryb3kgZXZlcnl0aGluZwoJCWlmICghYXJncykgewoJCQl0aGlzLmNsb3NlKCk7CgkJCWZvciAodmFyIG4gaW4gdGhpcy5fbG9hZEl0ZW1zQnlJZCkgewoJCQkJdGhpcy5fZGlzcG9zZUl0ZW0odGhpcy5fbG9hZEl0ZW1zQnlJZFtuXSk7CgkJCX0KCQkJdGhpcy5pbml0KHRoaXMudXNlWEhSLCB0aGlzLl9iYXNlUGF0aCwgdGhpcy5fY3Jvc3NPcmlnaW4pOwoKCQkvLyBSZW1vdmUgc3BlY2lmaWMgaXRlbXMKCQl9IGVsc2UgewoJCQl3aGlsZSAoYXJncy5sZW5ndGgpIHsKCQkJCXZhciBpdGVtID0gYXJncy5wb3AoKTsKCQkJCXZhciByID0gdGhpcy5nZXRSZXN1bHQoaXRlbSk7CgoJCQkJLy9SZW1vdmUgZnJvbSB0aGUgbWFpbiBsb2FkIFF1ZXVlCgkJCQlmb3IgKGkgPSB0aGlzLl9sb2FkUXVldWUubGVuZ3RoLTE7aT49MDtpLS0pIHsKCQkJCQlsb2FkSXRlbSA9IHRoaXMuX2xvYWRRdWV1ZVtpXS5nZXRJdGVtKCk7CgkJCQkJaWYgKGxvYWRJdGVtLmlkID09IGl0ZW0gfHwgbG9hZEl0ZW0uc3JjID09IGl0ZW0pIHsKCQkJCQkJdGhpcy5fbG9hZFF1ZXVlLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJLy9SZW1vdmUgZnJvbSB0aGUgYmFja3VwIHF1ZXVlCgkJCQlmb3IgKGkgPSB0aGlzLl9sb2FkUXVldWVCYWNrdXAubGVuZ3RoLTE7aT49MDtpLS0pIHsKCQkJCQlsb2FkSXRlbSA9IHRoaXMuX2xvYWRRdWV1ZUJhY2t1cFtpXS5nZXRJdGVtKCk7CgkJCQkJaWYgKGxvYWRJdGVtLmlkID09IGl0ZW0gfHwgbG9hZEl0ZW0uc3JjID09IGl0ZW0pIHsKCQkJCQkJdGhpcy5fbG9hZFF1ZXVlQmFja3VwLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKHIpIHsKCQkJCQlkZWxldGUgdGhpcy5fbG9hZEl0ZW1zQnlJZFtyLmlkXTsKCQkJCQlkZWxldGUgdGhpcy5fbG9hZEl0ZW1zQnlTcmNbci5zcmNdOwoJCQkJCXRoaXMuX2Rpc3Bvc2VJdGVtKHIpOwoJCQkJfSBlbHNlIHsKCQkJCQlmb3IgKHZhciBpPXRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGgtMTtpPj0wO2ktLSkgewoJCQkJCQl2YXIgbG9hZEl0ZW0gPSB0aGlzLl9jdXJyZW50TG9hZHNbaV0uZ2V0SXRlbSgpOwoJCQkJCQlpZiAobG9hZEl0ZW0uaWQgPT0gaXRlbSB8fCBsb2FkSXRlbS5zcmMgPT0gaXRlbSkgewoJCQkJCQkJdGhpcy5fY3VycmVudExvYWRzLnNwbGljZShpLDEpWzBdLmNhbmNlbCgpOwoJCQkJCQkJaXRlbXNXZXJlUmVtb3ZlZCA9IHRydWU7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gSWYgdGhpcyB3YXMgY2FsbGVkIGR1cmluZyBhIGxvYWQsIHRyeSB0byBsb2FkIHRoZSBuZXh0IGl0ZW0uCgkJCWlmIChpdGVtc1dlcmVSZW1vdmVkKSB7CgkJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCQl9CgkJfQoJfTsKCgkvKioKCSAqIFN0b3BzIGFsbCBvcGVuIGxvYWRzLCBkZXN0cm95cyBhbnkgbG9hZGVkIGl0ZW1zLCBhbmQgcmVzZXRzIHRoZSBxdWV1ZSwgc28gYWxsIGl0ZW1zIGNhbgoJICogYmUgcmVsb2FkZWQgYWdhaW4gYnkgY2FsbGluZyB7eyNjcm9zc0xpbmsgIkFic3RyYWN0TG9hZGVyL2xvYWQifX17ey9jcm9zc0xpbmt9fS4gSXRlbXMgYXJlIG5vdCByZW1vdmVkIGZyb20gdGhlCgkgKiBxdWV1ZS4gVG8gcmVtb3ZlIGl0ZW1zIHVzZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvcmVtb3ZlIn19e3svY3Jvc3NMaW5rfX0gb3IKCSAqIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3JlbW92ZUFsbCJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4KCSAqIEBtZXRob2QgcmVzZXQKCSAqIEBzaW5jZSAwLjMuMAoJICovCglwLnJlc2V0ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5jbG9zZSgpOwoJCWZvciAodmFyIG4gaW4gdGhpcy5fbG9hZEl0ZW1zQnlJZCkgewoJCQl0aGlzLl9kaXNwb3NlSXRlbSh0aGlzLl9sb2FkSXRlbXNCeUlkW25dKTsKCQl9CgoJCS8vUmVzZXQgdGhlIHF1ZXVlIHRvIGl0cyBzdGFydCBzdGF0ZQoJCXZhciBhID0gW107CgkJZm9yICh2YXIgaT0wLCBsPXRoaXMuX2xvYWRRdWV1ZUJhY2t1cC5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCWEucHVzaCh0aGlzLl9sb2FkUXVldWVCYWNrdXBbaV0uZ2V0SXRlbSgpKTsKCQl9CgoJCXRoaXMubG9hZE1hbmlmZXN0KGEsIGZhbHNlKTsKCX07CgoJLyoqCgkgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyB0eXBlIHNob3VsZCBiZSBsb2FkZWQgYXMgYSBiaW5hcnkgZmlsZS4gQ3VycmVudGx5LCBvbmx5IGltYWdlcyBhbmQgaXRlbXMgbWFya2VkCgkgKiBzcGVjaWZpY2FsbHkgYXMgImJpbmFyeSIgYXJlIGxvYWRlZCBhcyBiaW5hcnkuIE5vdGUgdGhhdCBhdWRpbyBpcyA8Yj5ub3Q8L2I+IGEgYmluYXJ5IHR5cGUsIGFzIHdlIGNhbiBub3QgcGxheQoJICogYmFjayB1c2luZyBhbiBhdWRpbyB0YWcgaWYgaXQgaXMgbG9hZGVkIGFzIGJpbmFyeS4gUGx1Z2lucyBjYW4gY2hhbmdlIHRoZSBpdGVtIHR5cGUgdG8gYmluYXJ5IHRvIGVuc3VyZSB0aGV5IGdldAoJICogYSBiaW5hcnkgcmVzdWx0IHRvIHdvcmsgd2l0aC4gQmluYXJ5IGZpbGVzIGFyZSBsb2FkZWQgdXNpbmcgWEhSMi4KCSAqIEBtZXRob2QgaXNCaW5hcnkKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuCgkgKiBAcmV0dXJuIHtCb29sZWFufSBJZiB0aGUgc3BlY2lmaWVkIHR5cGUgaXMgYmluYXJ5LgoJICogQHByaXZhdGUKCSAqLwoJcy5pc0JpbmFyeSA9IGZ1bmN0aW9uKHR5cGUpIHsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSU1BR0U6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkJJTkFSWToKCQkJCXJldHVybiB0cnVlOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX07CgoKCS8qKgoJICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgdHlwZSBpcyBhIHRleHQgYmFzZWQgYXNzZXQsIGFuZCBzaG91bGQgYmUgbG9hZGVkIGFzIFVURi04LgoJICogQG1ldGhvZCBpc1RleHQKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuCgkgKiBAcmV0dXJuIHtCb29sZWFufSBJZiB0aGUgc3BlY2lmaWVkIHR5cGUgaXMgdGV4dC4KCSAqIEBwcml2YXRlCgkgKi8KCXMuaXNUZXh0ID0gZnVuY3Rpb24odHlwZSkgewoJCXN3aXRjaCAodHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5URVhUOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuWE1MOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5IVE1MOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJCXJldHVybiB0cnVlOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX07CgoJLyoqCgkgKiBSZWdpc3RlciBhIHBsdWdpbi4gUGx1Z2lucyBjYW4gbWFwIHRvIGxvYWQgdHlwZXMgKHNvdW5kLCBpbWFnZSwgZXRjKSwgb3Igc3BlY2lmaWMgZXh0ZW5zaW9ucyAocG5nLCBtcDMsIGV0YykuCgkgKiBDdXJyZW50bHksIG9ubHkgb25lIHBsdWdpbiBjYW4gZXhpc3QgcGVyIHR5cGUvZXh0ZW5zaW9uLgoJICoKCSAqIFdoZW4gYSBwbHVnaW4gaXMgaW5zdGFsbGVkLCBhIDxjb2RlPmdldFByZWxvYWRIYW5kbGVycygpPC9jb2RlPiBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgb24gaXQuIEZvciBtb3JlIGluZm9ybWF0aW9uCgkgKiBvbiB0aGlzIG1ldGhvZCwgY2hlY2sgb3V0IHRoZSB7eyNjcm9zc0xpbmsgIlNhbXBsZVBsdWdpbi9nZXRQcmVsb2FkSGFuZGxlcnMifX17ey9jcm9zc0xpbmt9fSBtZXRob2QgaW4gdGhlCgkgKiB7eyNjcm9zc0xpbmsgIlNhbXBsZVBsdWdpbiJ9fXt7L2Nyb3NzTGlua319IGNsYXNzLgoJICoKCSAqIEJlZm9yZSBhIGZpbGUgaXMgbG9hZGVkLCBhIG1hdGNoaW5nIHBsdWdpbiBoYXMgYW4gb3Bwb3J0dW5pdHkgdG8gbW9kaWZ5IHRoZSBsb2FkLiBJZiBhIGBjYWxsYmFja2AgaXMgcmV0dXJuZWQKCSAqIGZyb20gdGhlIHt7I2Nyb3NzTGluayAiU2FtcGxlUGx1Z2luL2dldFByZWxvYWRIYW5kbGVycyJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZCwgaXQgd2lsbCBiZSBpbnZva2VkIGZpcnN0LCBhbmQgaXRzCgkgKiByZXN1bHQgbWF5IGNhbmNlbCBvciBtb2RpZnkgdGhlIGl0ZW0uIFRoZSBjYWxsYmFjayBtZXRob2QgY2FuIGFsc28gcmV0dXJuIGEgYGNvbXBsZXRlSGFuZGxlcmAgdG8gYmUgZmlyZWQgd2hlbgoJICogdGhlIGZpbGUgaXMgbG9hZGVkLCBvciBhIGB0YWdgIG9iamVjdCwgd2hpY2ggd2lsbCBtYW5hZ2UgdGhlIGFjdHVhbCBkb3dubG9hZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlc2UKCSAqIG1ldGhvZHMsIGNoZWNrIG91dCB0aGUge3sjY3Jvc3NMaW5rICJTYW1wbGVQbHVnaW4vcHJlbG9hZEhhbmRsZXIifX17ey9jcm9zc0xpbmt9fSBhbmQge3sjY3Jvc3NMaW5rICJTYW1wbGVQbHVnaW4vZmlsZUxvYWRIYW5kbGVyIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZHMgb24gdGhlIHt7I2Nyb3NzTGluayAiU2FtcGxlUGx1Z2luIn19e3svY3Jvc3NMaW5rfX0uCgkgKgoJICogQG1ldGhvZCBpbnN0YWxsUGx1Z2luCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwbHVnaW4gVGhlIHBsdWdpbiBjbGFzcyB0byBpbnN0YWxsLgoJICovCglwLmluc3RhbGxQbHVnaW4gPSBmdW5jdGlvbihwbHVnaW4pIHsKCQlpZiAocGx1Z2luID09IG51bGwgfHwgcGx1Z2luLmdldFByZWxvYWRIYW5kbGVycyA9PSBudWxsKSB7IHJldHVybjsgfQoJCXZhciBtYXAgPSBwbHVnaW4uZ2V0UHJlbG9hZEhhbmRsZXJzKCk7CgkJbWFwLnNjb3BlID0gcGx1Z2luOwoKCQlpZiAobWFwLnR5cGVzICE9IG51bGwpIHsKCQkJZm9yICh2YXIgaT0wLCBsPW1hcC50eXBlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCQl0aGlzLl90eXBlQ2FsbGJhY2tzW21hcC50eXBlc1tpXV0gPSBtYXA7CgkJCX0KCQl9CgkJaWYgKG1hcC5leHRlbnNpb25zICE9IG51bGwpIHsKCQkJZm9yIChpPTAsIGw9bWFwLmV4dGVuc2lvbnMubGVuZ3RoOyBpPGw7IGkrKykgewoJCQkJdGhpcy5fZXh0ZW5zaW9uQ2FsbGJhY2tzW21hcC5leHRlbnNpb25zW2ldXSA9IG1hcDsKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBTZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGNvbmN1cnJlbnQgY29ubmVjdGlvbnMuIE5vdGUgdGhhdCBicm93c2VycyBhbmQgc2VydmVycyBtYXkgaGF2ZSBhIGJ1aWx0LWluIG1heGltdW0KCSAqIG51bWJlciBvZiBvcGVuIGNvbm5lY3Rpb25zLCBzbyBhbnkgYWRkaXRpb25hbCBjb25uZWN0aW9ucyBtYXkgcmVtYWluIGluIGEgcGVuZGluZyBzdGF0ZSB1bnRpbCB0aGUgYnJvd3NlcgoJICogb3BlbnMgdGhlIGNvbm5lY3Rpb24uIFdoZW4gbG9hZGluZyBzY3JpcHRzIHVzaW5nIHRhZ3MsIGFuZCB3aGVuIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL21haW50YWluU2NyaXB0T3JkZXI6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fQoJICogaXMgYHRydWVgLCBvbmx5IG9uZSBzY3JpcHQgaXMgbG9hZGVkIGF0IGEgdGltZSBkdWUgdG8gYnJvd3NlciBsaW1pdGF0aW9ucy4KCSAqCgkgKiA8aDQ+RXhhbXBsZTwvaDQ+CgkgKgoJICogICAgICB2YXIgcXVldWUgPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKCk7CgkgKiAgICAgIHF1ZXVlLnNldE1heENvbm5lY3Rpb25zKDEwKTsgLy8gQWxsb3cgMTAgY29uY3VycmVudCBsb2FkcwoJICoKCSAqIEBtZXRob2Qgc2V0TWF4Q29ubmVjdGlvbnMKCSAqIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZSBUaGUgbnVtYmVyIG9mIGNvbmN1cnJlbnQgbG9hZHMgdG8gYWxsb3cuIEJ5IGRlZmF1bHQsIG9ubHkgYSBzaW5nbGUgY29ubmVjdGlvbiBwZXIgTG9hZFF1ZXVlCgkgKiBpcyBvcGVuIGF0IGFueSB0aW1lLgoJICovCglwLnNldE1heENvbm5lY3Rpb25zID0gZnVuY3Rpb24gKHZhbHVlKSB7CgkJdGhpcy5fbWF4Q29ubmVjdGlvbnMgPSB2YWx1ZTsKCQlpZiAoIXRoaXMuX3BhdXNlZCAmJiB0aGlzLl9sb2FkUXVldWUubGVuZ3RoID4gMCkgewoJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCX0KCX07CgoJLyoqCgkgKiBMb2FkIGEgc2luZ2xlIGZpbGUuIFRvIGFkZCBtdWx0aXBsZSBmaWxlcyBhdCBvbmNlLCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319CgkgKiBtZXRob2QuCgkgKgoJICogRmlsZXMgYXJlIGFsd2F5cyBhcHBlbmRlZCB0byB0aGUgY3VycmVudCBxdWV1ZSwgc28gdGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMgdG8gYWRkIGZpbGVzLgoJICogVG8gY2xlYXIgdGhlIHF1ZXVlIGZpcnN0LCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY2xvc2UifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuCgkgKiBAbWV0aG9kIGxvYWRGaWxlCgkgKiBAcGFyYW0ge09iamVjdCB8IFN0cmluZ30gZmlsZSBUaGUgZmlsZSBvYmplY3Qgb3IgcGF0aCB0byBsb2FkLiBBIGZpbGUgY2FuIGJlIGVpdGhlcgogICAgICogPHVsPgogICAgICogICAgIDxsaT5BIHN0cmluZyBwYXRoIHRvIGEgcmVzb3VyY2UuIE5vdGUgdGhhdCB0aGlzIGtpbmQgb2YgbG9hZCBpdGVtIHdpbGwgYmUgY29udmVydGVkIHRvIGFuIG9iamVjdCAoc2VlIGJlbG93KQoJICogICAgIGluIHRoZSBiYWNrZ3JvdW5kLjwvbGk+CiAgICAgKiAgICAgPGxpPk9SIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zOjx1bD4KICAgICAqICAgICAgICAgPGxpPnNyYzogVGhlIHNvdXJjZSBvZiB0aGUgZmlsZSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4gVGhpcyBwcm9wZXJ0eSBpcyA8Yj5yZXF1aXJlZDwvYj4uIFRoZSBzb3VyY2UgY2FuCgkgKiAgICAgICAgIGVpdGhlciBiZSBhIHN0cmluZyAocmVjb21tZW5kZWQpLCBvciBhbiBIVE1MIHRhZy48L2xpPgogICAgICogICAgICAgICA8bGk+dHlwZTogVGhlIHR5cGUgb2YgZmlsZSB0aGF0IHdpbGwgYmUgbG9hZGVkIChpbWFnZSwgc291bmQsIGpzb24sIGV0YykuIFByZWxvYWRKUyBkb2VzIGF1dG8tZGV0ZWN0aW9uCgkgKiAgICAgICAgIG9mIHR5cGVzIHVzaW5nIHRoZSBleHRlbnNpb24uIFN1cHBvcnRlZCB0eXBlcyBhcmUgZGVmaW5lZCBvbiBMb2FkUXVldWUsIHN1Y2ggYXMgPGNvZGU+TG9hZFF1ZXVlLklNQUdFPC9jb2RlPi4KCSAqICAgICAgICAgSXQgaXMgcmVjb21tZW5kZWQgdGhhdCBhIHR5cGUgaXMgc3BlY2lmaWVkIHdoZW4gYSBub24tc3RhbmRhcmQgZmlsZSBVUkkgKHN1Y2ggYXMgYSBwaHAgc2NyaXB0KSB1cyB1c2VkLjwvbGk+CiAgICAgKiAgICAgICAgIDxsaT5pZDogQSBzdHJpbmcgaWRlbnRpZmllciB3aGljaCBjYW4gYmUgdXNlZCB0byByZWZlcmVuY2UgdGhlIGxvYWRlZCBvYmplY3QuPC9saT4KCSAqICAgICAgICAgPGxpPm1haW50YWluT3JkZXI6IFNldCB0byBgdHJ1ZWAgdG8gZW5zdXJlIHRoaXMgYXNzZXQgbG9hZHMgaW4gdGhlIG9yZGVyIGRlZmluZWQgaW4gdGhlIG1hbmlmZXN0LiBUaGlzCgkgKiAgICAgICAgIHdpbGwgaGFwcGVuIHdoZW4gdGhlIG1heCBjb25uZWN0aW9ucyBoYXMgYmVlbiBzZXQgYWJvdmUgMSAodXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fSksCgkgKiAgICAgICAgIGFuZCB3aWxsIG9ubHkgYWZmZWN0IG90aGVyIGFzc2V0cyBhbHNvIGRlZmluZWQgYXMgYG1haW50YWluT3JkZXJgLiBFdmVyeXRoaW5nIGVsc2Ugd2lsbCBmaW5pc2ggYXMgaXQgaXMKCSAqICAgICAgICAgbG9hZGVkLiBPcmRlcmVkIGl0ZW1zIGFyZSBjb21iaW5lZCB3aXRoIHNjcmlwdCB0YWdzIGxvYWRpbmcgaW4gb3JkZXIgd2hlbiB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9tYWludGFpblNjcmlwdE9yZGVyOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0KCSAqICAgICAgICAgaXMgc2V0IHRvIGB0cnVlYC48L2xpPgoJICogICAgICAgICA8bGk+Y2FsbGJhY2s6IE9wdGlvbmFsLCB1c2VkIGZvciBKU09OUCByZXF1ZXN0cywgdG8gZGVmaW5lIHdoYXQgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgSlNPTlAgaXMgbG9hZGVkLjwvbGk+CiAgICAgKiAgICAgICAgIDxsaT5kYXRhOiBBbiBhcmJpdHJhcnkgZGF0YSBvYmplY3QsIHdoaWNoIGlzIGluY2x1ZGVkIHdpdGggdGhlIGxvYWRlZCBvYmplY3Q8L2xpPgoJICogICAgICAgICA8bGk+bWV0aG9kOiB1c2VkIHRvIGRlZmluZSBpZiB0aGlzIHJlcXVlc3QgdXNlcyBHRVQgb3IgUE9TVCB3aGVuIHNlbmRpbmcgZGF0YSB0byB0aGUgc2VydmVyLiBUaGUgZGVmYXVsdAoJICogICAgICAgICB2YWx1ZSBpcyAiR0VUIjwvbGk+CgkgKiAgICAgICAgIDxsaT52YWx1ZXM6IE9wdGlvbmFsIG9iamVjdCBvZiBuYW1lL3ZhbHVlIHBhaXJzIHRvIHNlbmQgdG8gdGhlIHNlcnZlci48L2xpPgoJICogICAgICAgICA8bGk+aGVhZGVyczogT3B0aW9uYWwgb2JqZWN0IGhhc2ggb2YgaGVhZGVycyB0byBhdHRhY2ggdG8gYW4gWEhSIHJlcXVlc3QuIFByZWxvYWRKUyB3aWxsIGF1dG9tYXRpY2FsbHkKCSAqICAgICAgICAgYXR0YWNoIHNvbWUgZGVmYXVsdCBoZWFkZXJzIHdoZW4gcmVxdWlyZWQsIGluY2x1ZGluZyBPcmlnaW4sIENvbnRlbnQtVHlwZSwgYW5kIFgtUmVxdWVzdGVkLVdpdGguIFlvdSBtYXkKCSAqICAgICAgICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaGVhZGVycyBpZiBuZWVkZWQuPC9saT4KCSAqICAgICA8L3VsPgogICAgICogPC91bD4KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW2xvYWROb3c9dHJ1ZV0gS2ljayBvZmYgYW4gaW1tZWRpYXRlIGxvYWQgKHRydWUpIG9yIHdhaXQgZm9yIGEgbG9hZCBjYWxsIChmYWxzZSkuIFRoZSBkZWZhdWx0CgkgKiB2YWx1ZSBpcyB0cnVlLiBJZiB0aGUgcXVldWUgaXMgcGF1c2VkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldFBhdXNlZCJ9fXt7L2Nyb3NzTGlua319LCBhbmQgdGhlIHZhbHVlIGlzCgkgKiBgdHJ1ZWAsIHRoZSBxdWV1ZSB3aWxsIHJlc3VtZSBhdXRvbWF0aWNhbGx5LgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aF0gQSBiYXNlIHBhdGggdGhhdCB3aWxsIGJlIHByZXBlbmRlZCB0byBlYWNoIGZpbGUuIFRoZSBiYXNlUGF0aCBhcmd1bWVudCBvdmVycmlkZXMgdGhlCgkgKiBwYXRoIHNwZWNpZmllZCBpbiB0aGUgY29uc3RydWN0b3IuIE5vdGUgdGhhdCBpZiB5b3UgbG9hZCBhIG1hbmlmZXN0IHVzaW5nIGEgZmlsZSBvZiB0eXBlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL01BTklGRVNUOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0sCgkgKiBpdHMgZmlsZXMgd2lsbCA8c3Ryb25nPk5PVDwvc3Ryb25nPiB1c2UgdGhlIGJhc2VQYXRoIHBhcmFtZXRlci4gPHN0cm9uZz5UaGUgYmFzZVBhdGggcGFyYW1ldGVyIGlzIGRlcHJlY2F0ZWQuPC9zdHJvbmc+CgkgKiBUaGlzIHBhcmFtZXRlciB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlIGVpdGhlciB1c2UgdGhlIGBiYXNlUGF0aGAgcGFyYW1ldGVyIGluIHRoZSBMb2FkUXVldWUKCSAqIGNvbnN0cnVjdG9yLCBvciBhIGBwYXRoYCBwcm9wZXJ0eSBpbiBhIG1hbmlmZXN0IGRlZmluaXRpb24uCgkgKi8KCXAubG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlLCBsb2FkTm93LCBiYXNlUGF0aCkgewoJCWlmIChmaWxlID09IG51bGwpIHsKCQkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCQlldmVudC50ZXh0ID0gIlBSRUxPQURfTk9fRklMRSI7CgkJCXRoaXMuX3NlbmRFcnJvcihldmVudCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fYWRkSXRlbShmaWxlLCBudWxsLCBiYXNlUGF0aCk7CgoJCWlmIChsb2FkTm93ICE9PSBmYWxzZSkgewoJCQl0aGlzLnNldFBhdXNlZChmYWxzZSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zZXRQYXVzZWQodHJ1ZSk7CgkJfQoJfTsKCgkvKioKCSAqIExvYWQgYW4gYXJyYXkgb2YgZmlsZXMuIFRvIGxvYWQgYSBzaW5nbGUgZmlsZSwgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkRmlsZSJ9fXt7L2Nyb3NzTGlua319IG1ldGhvZC4KCSAqIFRoZSBmaWxlcyBpbiB0aGUgbWFuaWZlc3QgYXJlIHJlcXVlc3RlZCBpbiB0aGUgc2FtZSBvcmRlciwgYnV0IG1heSBjb21wbGV0ZSBpbiBhIGRpZmZlcmVudCBvcmRlciBpZiB0aGUgbWF4CgkgKiBjb25uZWN0aW9ucyBhcmUgc2V0IGFib3ZlIDEgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fS4gU2NyaXB0cyB3aWxsIGxvYWQKCSAqIGluIHRoZSByaWdodCBvcmRlciBhcyBsb25nIGFzIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL21haW50YWluU2NyaXB0T3JkZXIifX17ey9jcm9zc0xpbmt9fSBpcyB0cnVlICh3aGljaCBpcwoJICogZGVmYXVsdCkuCgkgKgoJICogRmlsZXMgYXJlIGFsd2F5cyBhcHBlbmRlZCB0byB0aGUgY3VycmVudCBxdWV1ZSwgc28gdGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMgdG8gYWRkIGZpbGVzLgoJICogVG8gY2xlYXIgdGhlIHF1ZXVlIGZpcnN0LCB1c2UgdGhlIHt7I2Nyb3NzTGluayAiQWJzdHJhY3RMb2FkZXIvY2xvc2UifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuCgkgKiBAbWV0aG9kIGxvYWRNYW5pZmVzdAoJICogQHBhcmFtIHtBcnJheXxTdHJpbmd8T2JqZWN0fSBtYW5pZmVzdCBBbiBsaXN0IG9mIGZpbGVzIHRvIGxvYWQuIFRoZSBsb2FkTWFuaWZlc3QgY2FsbCBzdXBwb3J0cyBmb3VyIHR5cGVzIG9mCgkgKiBtYW5pZmVzdHM6CgkgKiA8b2w+CgkgKiAgICAgPGxpPkEgc3RyaW5nIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhIG1hbmlmZXN0IGZpbGUsIHdoaWNoIGlzIGEgSlNPTiBmaWxlIHRoYXQgY29udGFpbnMgYSAibWFuaWZlc3QiIHByb3BlcnR5LAoJICogICAgIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwgYW5kIGNhbiBvcHRpb25hbGx5IGNvbnRhaW4gYSAicGF0aCIgcHJvcGVydHksIHdoaWNoIHdpbGwgYmUKCSAqICAgICBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIG9iamVjdCB3aGljaCBkZWZpbmVzIGEgInNyYyIsIHdoaWNoIGlzIGEgSlNPTiBvciBKU09OUCBmaWxlLiBBICJjYWxsYmFjayIgY2FuIGJlIGRlZmluZWQgZm9yIEpTT05QCgkgKiAgICAgZmlsZS4gVGhlIEpTT04vSlNPTlAgZmlsZSBzaG91bGQgY29udGFpbiBhICJtYW5pZmVzdCIgcHJvcGVydHksIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwKCSAqICAgICBhbmQgY2FuIG9wdGlvbmFsbHkgY29udGFpbiBhICJwYXRoIiBwcm9wZXJ0eSwgd2hpY2ggd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIG9iamVjdCB3aGljaCBjb250YWlucyBhICJtYW5pZmVzdCIgcHJvcGVydHksIHdoaWNoIGRlZmluZXMgdGhlIGxpc3Qgb2YgZmlsZXMgdG8gbG9hZCwgYW5kIGNhbgoJICogICAgIG9wdGlvbmFsbHkgY29udGFpbiBhICJwYXRoIiBwcm9wZXJ0eSwgd2hpY2ggd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlIGluIHRoZSBsaXN0LjwvbGk+CgkgKiAgICAgPGxpPkFuIEFycmF5IG9mIGZpbGVzIHRvIGxvYWQuPC9saT4KCSAqIDwvb2w+CgkgKgoJICogRWFjaCAiZmlsZSIgaW4gYSBtYW5pZmVzdCBjYW4gYmUgZWl0aGVyOgoJICogPHVsPgoJICogICAgIDxsaT5BIHN0cmluZyBwYXRoIHRvIGEgcmVzb3VyY2UgKHN0cmluZykuIE5vdGUgdGhhdCB0aGlzIGtpbmQgb2YgbG9hZCBpdGVtIHdpbGwgYmUgY29udmVydGVkIHRvIGFuIG9iamVjdAoJICogICAgIChzZWUgYmVsb3cpIGluIHRoZSBiYWNrZ3JvdW5kLjwvbGk+CgkgKiAgICAgIDxsaT5PUiBhbiBvYmplY3QgdGhhdCBjb250YWluczo8dWw+CgkgKiAgICAgICAgIDxsaT5zcmM6IFRoZSBzb3VyY2Ugb2YgdGhlIGZpbGUgdGhhdCBpcyBiZWluZyBsb2FkZWQuIFRoaXMgcHJvcGVydHkgaXMgPGI+cmVxdWlyZWQ8L2I+LiBUaGUgc291cmNlIGNhbgoJICogICAgICAgICBlaXRoZXIgYmUgYSBzdHJpbmcgKHJlY29tbWVuZGVkKSwgb3IgYW4gSFRNTCB0YWcuPC9saT4KCSAqICAgICAgICAgPGxpPnR5cGU6IFRoZSB0eXBlIG9mIGZpbGUgdGhhdCB3aWxsIGJlIGxvYWRlZCAoaW1hZ2UsIHNvdW5kLCBqc29uLCBldGMpLiBQcmVsb2FkSlMgZG9lcyBhdXRvLWRldGVjdGlvbgoJICogICAgICAgICBvZiB0eXBlcyB1c2luZyB0aGUgZXh0ZW5zaW9uLiBTdXBwb3J0ZWQgdHlwZXMgYXJlIGRlZmluZWQgb24gTG9hZFF1ZXVlLCBzdWNoIGFzIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL0lNQUdFOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0uCgkgKiAgICAgICAgIEl0IGlzIHJlY29tbWVuZGVkIHRoYXQgYSB0eXBlIGlzIHNwZWNpZmllZCB3aGVuIGEgbm9uLXN0YW5kYXJkIGZpbGUgVVJJIChzdWNoIGFzIGEgcGhwIHNjcmlwdCkgdXMgdXNlZC48L2xpPgoJICogICAgICAgICA8bGk+aWQ6IEEgc3RyaW5nIGlkZW50aWZpZXIgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVmZXJlbmNlIHRoZSBsb2FkZWQgb2JqZWN0LjwvbGk+CgkgKiAgICAgICAgIDxsaT5tYWludGFpbk9yZGVyOiBTZXQgdG8gYHRydWVgIHRvIGVuc3VyZSB0aGlzIGFzc2V0IGxvYWRzIGluIHRoZSBvcmRlciBkZWZpbmVkIGluIHRoZSBtYW5pZmVzdC4gVGhpcwoJICogICAgICAgICB3aWxsIGhhcHBlbiB3aGVuIHRoZSBtYXggY29ubmVjdGlvbnMgaGFzIGJlZW4gc2V0IGFib3ZlIDEgKHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL3NldE1heENvbm5lY3Rpb25zIn19e3svY3Jvc3NMaW5rfX0pLAoJICogICAgICAgICBhbmQgd2lsbCBvbmx5IGFmZmVjdCBvdGhlciBhc3NldHMgYWxzbyBkZWZpbmVkIGFzIGBtYWludGFpbk9yZGVyYC4gRXZlcnl0aGluZyBlbHNlIHdpbGwgZmluaXNoIGFzIGl0IGlzCgkgKiAgICAgICAgIGxvYWRlZC4gT3JkZXJlZCBpdGVtcyBhcmUgY29tYmluZWQgd2l0aCBzY3JpcHQgdGFncyBsb2FkaW5nIGluIG9yZGVyIHdoZW4ge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbWFpbnRhaW5TY3JpcHRPcmRlcjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiAgICAgICAgIGlzIHNldCB0byBgdHJ1ZWAuPC9saT4KCSAqICAgICAgICAgPGxpPmNhbGxiYWNrOiBPcHRpb25hbCwgdXNlZCBmb3IgSlNPTlAgcmVxdWVzdHMsIHRvIGRlZmluZSB3aGF0IG1ldGhvZCB0byBjYWxsIHdoZW4gdGhlIEpTT05QIGlzIGxvYWRlZC48L2xpPgoJICogICAgICAgICA8bGk+ZGF0YTogQW4gYXJiaXRyYXJ5IGRhdGEgb2JqZWN0LCB3aGljaCBpcyBpbmNsdWRlZCB3aXRoIHRoZSBsb2FkZWQgb2JqZWN0PC9saT4KCSAqICAgICAgICAgPGxpPm1ldGhvZDogdXNlZCB0byBkZWZpbmUgaWYgdGhpcyByZXF1ZXN0IHVzZXMgR0VUIG9yIFBPU1Qgd2hlbiBzZW5kaW5nIGRhdGEgdG8gdGhlIHNlcnZlci4gVGhlIGRlZmF1bHQKCSAqICAgICAgICAgdmFsdWUgaXMgIkdFVCI8L2xpPgoJICogICAgICAgICA8bGk+dmFsdWVzOiBPcHRpb25hbCBvYmplY3Qgb2YgbmFtZS92YWx1ZSBwYWlycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuPC9saT4KCSAqICAgICAgICAgPGxpPmhlYWRlcnM6IE9wdGlvbmFsIG9iamVjdCBoYXNoIG9mIGhlYWRlcnMgdG8gYXR0YWNoIHRvIGFuIFhIUiByZXF1ZXN0LiBQcmVsb2FkSlMgd2lsbCBhdXRvbWF0aWNhbGx5CgkgKiAgICAgICAgIGF0dGFjaCBzb21lIGRlZmF1bHQgaGVhZGVycyB3aGVuIHJlcXVpcmVkLCBpbmNsdWRpbmcgT3JpZ2luLCBDb250ZW50LVR5cGUsIGFuZCBYLVJlcXVlc3RlZC1XaXRoLiBZb3UgbWF5CgkgKiAgICAgICAgIG92ZXJyaWRlIHRoZSBkZWZhdWx0IGhlYWRlcnMgaWYgbmVlZGVkLjwvbGk+CgkgKiAgICAgPC91bD4KCSAqIDwvdWw+CgkgKiBAcGFyYW0ge0Jvb2xlYW59IFtsb2FkTm93PXRydWVdIEtpY2sgb2ZmIGFuIGltbWVkaWF0ZSBsb2FkICh0cnVlKSBvciB3YWl0IGZvciBhIGxvYWQgY2FsbCAoZmFsc2UpLiBUaGUgZGVmYXVsdAoJICogdmFsdWUgaXMgdHJ1ZS4gSWYgdGhlIHF1ZXVlIGlzIHBhdXNlZCB1c2luZyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zZXRQYXVzZWQifX17ey9jcm9zc0xpbmt9fSBhbmQgdGhpcyB2YWx1ZSBpcwoJICogYHRydWVgLCB0aGUgcXVldWUgd2lsbCByZXN1bWUgYXV0b21hdGljYWxseS4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbYmFzZVBhdGhdIEEgYmFzZSBwYXRoIHRoYXQgd2lsbCBiZSBwcmVwZW5kZWQgdG8gZWFjaCBmaWxlLiBUaGUgYmFzZVBhdGggYXJndW1lbnQgb3ZlcnJpZGVzIHRoZQoJICogcGF0aCBzcGVjaWZpZWQgaW4gdGhlIGNvbnN0cnVjdG9yLiBOb3RlIHRoYXQgaWYgeW91IGxvYWQgYSBtYW5pZmVzdCB1c2luZyBhIGZpbGUgb2YgdHlwZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9NQU5JRkVTVDpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319LAoJICogaXRzIGZpbGVzIHdpbGwgPHN0cm9uZz5OT1Q8L3N0cm9uZz4gdXNlIHRoZSBiYXNlUGF0aCBwYXJhbWV0ZXIuIDxzdHJvbmc+VGhlIGJhc2VQYXRoIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLjwvc3Ryb25nPgoJICogVGhpcyBwYXJhbWV0ZXIgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24uIFBsZWFzZSBlaXRoZXIgdXNlIHRoZSBgYmFzZVBhdGhgIHBhcmFtZXRlciBpbiB0aGUgTG9hZFF1ZXVlCgkgKiBjb25zdHJ1Y3Rvciwgb3IgYSBgcGF0aGAgcHJvcGVydHkgaW4gYSBtYW5pZmVzdCBkZWZpbml0aW9uLgoJICovCglwLmxvYWRNYW5pZmVzdCA9IGZ1bmN0aW9uKG1hbmlmZXN0LCBsb2FkTm93LCBiYXNlUGF0aCkgewoJCXZhciBmaWxlTGlzdCA9IG51bGw7CgkJdmFyIHBhdGggPSBudWxsOwoKCQkvLyBBcnJheS1iYXNlZCBsaXN0IG9mIGl0ZW1zCgkJaWYgKG1hbmlmZXN0IGluc3RhbmNlb2YgQXJyYXkpIHsKCQkJaWYgKG1hbmlmZXN0Lmxlbmd0aCA9PSAwKSB7CgkJCQl2YXIgZXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJCQlldmVudC50ZXh0ID0gIlBSRUxPQURfTUFOSUZFU1RfRU1QVFkiOwoJCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQkJCXJldHVybjsKCQkJfQoJCQlmaWxlTGlzdCA9IG1hbmlmZXN0OwoKCQkvLyBTdHJpbmctYmFzZWQuIE9ubHkgZmlsZSBtYW5pZmVzdHMgY2FuIGJlIHNwZWNpZmllZCB0aGlzIHdheS4gQW55IG90aGVyIHR5cGVzIHdpbGwgY2F1c2UgYW4gZXJyb3Igd2hlbiBsb2FkZWQuCgkJfSBlbHNlIGlmICh0eXBlb2YobWFuaWZlc3QpID09PSAic3RyaW5nIikgewoJCQlmaWxlTGlzdCA9IFt7CgkJCQlzcmM6IG1hbmlmZXN0LAoJCQkJdHlwZTogcy5NQU5JRkVTVAoJCQl9XTsKCgkJfSBlbHNlIGlmICh0eXBlb2YobWFuaWZlc3QpID09ICJvYmplY3QiKSB7CgoJCQkvLyBBbiBvYmplY3QgdGhhdCBkZWZpbmVzIGEgbWFuaWZlc3QgcGF0aAoJCQlpZiAobWFuaWZlc3Quc3JjICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmIChtYW5pZmVzdC50eXBlID09IG51bGwpIHsKCQkJCQltYW5pZmVzdC50eXBlID0gcy5NQU5JRkVTVDsKCQkJCX0gZWxzZSBpZiAobWFuaWZlc3QudHlwZSAhPSBzLk1BTklGRVNUKSB7CgkJCQkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCQkJCWV2ZW50LnRleHQgPSAiUFJFTE9BRF9NQU5JRkVTVF9FUlJPUiI7CgkJCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQkJCX0KCQkJCWZpbGVMaXN0ID0gW21hbmlmZXN0XTsKCgkJCS8vIEFuIG9iamVjdCB0aGF0IGRlZmluZXMgYSBtYW5pZmVzdAoJCQl9IGVsc2UgaWYgKG1hbmlmZXN0Lm1hbmlmZXN0ICE9PSB1bmRlZmluZWQpIHsKCQkJCWZpbGVMaXN0ID0gbWFuaWZlc3QubWFuaWZlc3Q7CgkJCQlwYXRoID0gbWFuaWZlc3QucGF0aDsKCQkJfQoKCQkvLyBVbnN1cHBvcnRlZC4gVGhpcyB3aWxsIHRocm93IGFuIGVycm9yLgoJCX0gZWxzZSB7CgkJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkJZXZlbnQudGV4dCA9ICJQUkVMT0FEX01BTklGRVNUX05VTEwiOwoJCQl0aGlzLl9zZW5kRXJyb3IoZXZlbnQpOwoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKHZhciBpPTAsIGw9ZmlsZUxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewoJCQl0aGlzLl9hZGRJdGVtKGZpbGVMaXN0W2ldLCBwYXRoLCBiYXNlUGF0aCk7CgkJfQoKCQlpZiAobG9hZE5vdyAhPT0gZmFsc2UpIHsKCQkJdGhpcy5zZXRQYXVzZWQoZmFsc2UpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2V0UGF1c2VkKHRydWUpOwoJCX0KCgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0UGF1c2VkKGZhbHNlKTsKCX07CgoJLyoqCgkgKiBMb29rIHVwIGEgbG9hZCBpdGVtIHVzaW5nIGVpdGhlciB0aGUgImlkIiBvciAic3JjIiB0aGF0IHdhcyBzcGVjaWZpZWQgd2hlbiBsb2FkaW5nIGl0LiBOb3RlIHRoYXQgaWYgbm8gImlkIiB3YXMKCSAqIHN1cHBsaWVkIHdpdGggdGhlIGxvYWQgaXRlbSwgdGhlIElEIHdpbGwgYmUgdGhlICJzcmMiLCBpbmNsdWRpbmcgYSBgcGF0aGAgcHJvcGVydHkgZGVmaW5lZCBieSBhIG1hbmlmZXN0LiBUaGUKCSAqIGBiYXNlUGF0aGAgd2lsbCBub3QgYmUgcGFydCBvZiB0aGUgSUQuCgkgKiBAbWV0aG9kIGdldEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgPGNvZGU+aWQ8L2NvZGU+IG9yIDxjb2RlPnNyYzwvY29kZT4gb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGxvYWQgaXRlbSB0aGF0IHdhcyBpbml0aWFsbHkgcmVxdWVzdGVkIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0KCSAqIG9yIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRNYW5pZmVzdCJ9fXt7L2Nyb3NzTGlua319LiBUaGlzIG9iamVjdCBpcyBhbHNvIHJldHVybmVkIHZpYSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fQoJICogZXZlbnQgYXMgdGhlIGBpdGVtYCBwYXJhbWV0ZXIuCgkgKi8KCXAuZ2V0SXRlbSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHRoaXMuX2xvYWRJdGVtc0J5SWRbdmFsdWVdIHx8IHRoaXMuX2xvYWRJdGVtc0J5U3JjW3ZhbHVlXTsKCX07CgoJLyoqCgkgKiBMb29rIHVwIGEgbG9hZGVkIHJlc3VsdCB1c2luZyBlaXRoZXIgdGhlICJpZCIgb3IgInNyYyIgdGhhdCB3YXMgc3BlY2lmaWVkIHdoZW4gbG9hZGluZyBpdC4gTm90ZSB0aGF0IGlmIG5vICJpZCIKCSAqIHdhcyBzdXBwbGllZCB3aXRoIHRoZSBsb2FkIGl0ZW0sIHRoZSBJRCB3aWxsIGJlIHRoZSAic3JjIiwgaW5jbHVkaW5nIGEgYHBhdGhgIHByb3BlcnR5IGRlZmluZWQgYnkgYSBtYW5pZmVzdC4gVGhlCgkgKiBgYmFzZVBhdGhgIHdpbGwgbm90IGJlIHBhcnQgb2YgdGhlIElELgoJICogQG1ldGhvZCBnZXRSZXN1bHQKCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgPGNvZGU+aWQ8L2NvZGU+IG9yIDxjb2RlPnNyYzwvY29kZT4gb2YgdGhlIGxvYWQgaXRlbS4KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW3Jhd1Jlc3VsdD1mYWxzZV0gUmV0dXJuIGEgcmF3IHJlc3VsdCBpbnN0ZWFkIG9mIGEgZm9ybWF0dGVkIHJlc3VsdC4gVGhpcyBhcHBsaWVzIHRvIGNvbnRlbnQKCSAqIGxvYWRlZCB2aWEgWEhSIHN1Y2ggYXMgc2NyaXB0cywgWE1MLCBDU1MsIGFuZCBJbWFnZXMuIElmIHRoZXJlIGlzIG5vIHJhdyByZXN1bHQsIHRoZSBmb3JtYXR0ZWQgcmVzdWx0IHdpbGwgYmUKCSAqIHJldHVybmVkIGluc3RlYWQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEEgcmVzdWx0IG9iamVjdCBjb250YWluaW5nIHRoZSBjb250ZW50IHRoYXQgd2FzIGxvYWRlZCwgc3VjaCBhczoKICAgICAqIDx1bD4KCSAqICAgICAgPGxpPkFuIGltYWdlIHRhZyAoJmx0O2ltYWdlIC8mZ3Q7KSBmb3IgaW1hZ2VzPC9saT4KCSAqICAgICAgPGxpPkEgc2NyaXB0IHRhZyBmb3IgSmF2YVNjcmlwdCAoJmx0O3NjcmlwdCAvJmd0OykuIE5vdGUgdGhhdCBzY3JpcHRzIGFyZSBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSBIVE1MCgkgKiAgICAgIERPTS48L2xpPgoJICogICAgICA8bGk+QSBzdHlsZSB0YWcgZm9yIENTUyAoJmx0O3N0eWxlIC8mZ3Q7IG9yICZsdDtsaW5rICZndDspPC9saT4KCSAqICAgICAgPGxpPlJhdyB0ZXh0IGZvciBURVhUPC9saT4KCSAqICAgICAgPGxpPkEgZm9ybWF0dGVkIEphdmFTY3JpcHQgb2JqZWN0IGRlZmluZWQgYnkgSlNPTjwvbGk+CgkgKiAgICAgIDxsaT5BbiBYTUwgZG9jdW1lbnQ8L2xpPgoJICogICAgICA8bGk+QSBiaW5hcnkgYXJyYXlidWZmZXIgbG9hZGVkIGJ5IFhIUjwvbGk+CgkgKiAgICAgIDxsaT5BbiBhdWRpbyB0YWcgKCZsdDthdWRpbyAmZ3Q7KSBmb3IgSFRNTCBhdWRpby4gTm90ZSB0aGF0IGl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBTb3VuZEpTIEFQSXMgdG8gcGxheQoJICogICAgICBsb2FkZWQgYXVkaW8uIFNwZWNpZmljYWxseSwgYXVkaW8gbG9hZGVkIGJ5IEZsYXNoIGFuZCBXZWJBdWRpbyB3aWxsIHJldHVybiBhIGxvYWRlciBvYmplY3QgdXNpbmcgdGhpcyBtZXRob2QKCSAqICAgICAgd2hpY2ggY2FuIG5vdCBiZSB1c2VkIHRvIHBsYXkgYXVkaW8gYmFjay48L2xpPgoJICogPC91bD4KICAgICAqIFRoaXMgb2JqZWN0IGlzIGFsc28gcmV0dXJuZWQgdmlhIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9maWxlbG9hZDpldmVudCJ9fXt7L2Nyb3NzTGlua319ICBldmVudCBhcyB0aGUgJ2l0ZW1gCgkgKiBwYXJhbWV0ZXIuIE5vdGUgdGhhdCBpZiBhIHJhdyByZXN1bHQgaXMgcmVxdWVzdGVkLCBidXQgbm90IGZvdW5kLCB0aGUgcmVzdWx0IHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZC4KCSAqLwoJcC5nZXRSZXN1bHQgPSBmdW5jdGlvbih2YWx1ZSwgcmF3UmVzdWx0KSB7CgkJdmFyIGl0ZW0gPSB0aGlzLl9sb2FkSXRlbXNCeUlkW3ZhbHVlXSB8fCB0aGlzLl9sb2FkSXRlbXNCeVNyY1t2YWx1ZV07CgkJaWYgKGl0ZW0gPT0gbnVsbCkgeyByZXR1cm4gbnVsbDsgfQoJCXZhciBpZCA9IGl0ZW0uaWQ7CgkJaWYgKHJhd1Jlc3VsdCAmJiB0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2lkXSkgewoJCQlyZXR1cm4gdGhpcy5fbG9hZGVkUmF3UmVzdWx0c1tpZF07CgkJfQoJCXJldHVybiB0aGlzLl9sb2FkZWRSZXN1bHRzW2lkXTsKCX07CgoJLyoqCgkgKiBQYXVzZSBvciByZXN1bWUgdGhlIGN1cnJlbnQgbG9hZC4gQWN0aXZlIGxvYWRzIHdpbGwgbm90IGJlIGNhbmNlbGxlZCwgYnV0IHRoZSBuZXh0IGl0ZW1zIGluIHRoZSBxdWV1ZSB3aWxsIG5vdAoJICogYmUgcHJvY2Vzc2VkIHdoZW4gYWN0aXZlIGxvYWRzIGNvbXBsZXRlLiBMb2FkUXVldWVzIGFyZSBub3QgcGF1c2VkIGJ5IGRlZmF1bHQuCgkgKgoJICogTm90ZSB0aGF0IGlmIG5ldyBpdGVtcyBhcmUgYWRkZWQgdG8gdGhlIHF1ZXVlIHVzaW5nIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZE1hbmlmZXN0In19e3svY3Jvc3NMaW5rfX0sCgkgKiBhIHBhdXNlZCBxdWV1ZSB3aWxsIGJlIHJlc3VtZWQsIHVubGVzcyB0aGUgYGxvYWROb3dgIGFyZ3VtZW50IGlzIGBmYWxzZWAuCgkgKiBAbWV0aG9kIHNldFBhdXNlZAoJICogQHBhcmFtIHtCb29sZWFufSB2YWx1ZSBXaGV0aGVyIHRoZSBxdWV1ZSBzaG91bGQgYmUgcGF1c2VkIG9yIG5vdC4KCSAqLwoJcC5zZXRQYXVzZWQgPSBmdW5jdGlvbih2YWx1ZSkgewoJCXRoaXMuX3BhdXNlZCA9IHZhbHVlOwoJCWlmICghdGhpcy5fcGF1c2VkKSB7CgkJCXRoaXMuX2xvYWROZXh0KCk7CgkJfQoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmNsb3NlID0gZnVuY3Rpb24oKSB7CgkJd2hpbGUgKHRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGgpIHsKCQkJdGhpcy5fY3VycmVudExvYWRzLnBvcCgpLmNhbmNlbCgpOwoJCX0KCQl0aGlzLl9zY3JpcHRPcmRlci5sZW5ndGggPSAwOwoJCXRoaXMuX2xvYWRlZFNjcmlwdHMubGVuZ3RoID0gMDsKCQl0aGlzLmxvYWRTdGFydFdhc0Rpc3BhdGNoZWQgPSBmYWxzZTsKCX07CgoKLy9Qcm90ZWN0ZWQgTWV0aG9kcwoJLyoqCgkgKiBBZGQgYW4gaXRlbSB0byB0aGUgcXVldWUuIEl0ZW1zIGFyZSBmb3JtYXR0ZWQgaW50byBhIHVzYWJsZSBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIHByb3BlcnRpZXMgbmVjZXNzYXJ5IHRvCgkgKiBsb2FkIHRoZSBjb250ZW50LiBUaGUgbG9hZCBxdWV1ZSBpcyBwb3B1bGF0ZWQgd2l0aCB0aGUgbG9hZGVyIGluc3RhbmNlIHRoYXQgaGFuZGxlcyBwcmVsb2FkaW5nLCBhbmQgbm90IHRoZSBsb2FkCgkgKiBpdGVtIHRoYXQgd2FzIHBhc3NlZCBpbiBieSB0aGUgdXNlci4gVG8gbG9vayB1cCB0aGUgbG9hZCBpdGVtIGJ5IGlkIG9yIHNyYywgdXNlIHRoZSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS5nZXRJdGVtIn19e3svY3Jvc3NMaW5rfX0KCSAqIG1ldGhvZC4KCSAqIEBtZXRob2QgX2FkZEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdH0gdmFsdWUgVGhlIGl0ZW0gdG8gYWRkIHRvIHRoZSBxdWV1ZS4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbcGF0aF0gQW4gb3B0aW9uYWwgcGF0aCBwcmVwZW5kZWQgdG8gdGhlIGBzcmNgLiBUaGUgcGF0aCB3aWxsIG9ubHkgYmUgcHJlcGVuZGVkIGlmIHRoZSBzcmMgaXMKCSAqIHJlbGF0aXZlLCBhbmQgZG9lcyBub3Qgc3RhcnQgd2l0aCBhIHByb3RvY29sIHN1Y2ggYXMgYGh0dHA6Ly9gLCBvciBhIHBhdGggbGlrZSBgLi4vYC4gSWYgdGhlIExvYWRRdWV1ZSB3YXMKCSAqIHByb3ZpZGVkIGEge3sjY3Jvc3NMaW5rICJfYmFzZVBhdGgifX17ey9jcm9zc0xpbmt9fSwgdGhlbiBpdCB3aWxsIG9wdGlvbmFsbHkgYmUgcHJlcGVuZGVkIGFmdGVyLgoJICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlUGF0aF0gPHN0cm9uZz5EZXByZWNhdGVkPC9zdHJvbmc+QW4gb3B0aW9uYWwgYmFzZVBhdGggcGFzc2VkIGludG8gYSB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9sb2FkTWFuaWZlc3QifX17ey9jcm9zc0xpbmt9fQoJICogb3Ige3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fSBjYWxsLiBUaGlzIHBhcmFtZXRlciB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdGFnZ2VkCgkgKiB2ZXJzaW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5fYWRkSXRlbSA9IGZ1bmN0aW9uKHZhbHVlLCBwYXRoLCBiYXNlUGF0aCkgewoJCXZhciBpdGVtID0gdGhpcy5fY3JlYXRlTG9hZEl0ZW0odmFsdWUsIHBhdGgsIGJhc2VQYXRoKTsgLy8gYmFzZVBhdGggYW5kIG1hbmlmZXN0IHBhdGggYXJlIGFkZGVkIHRvIHRoZSBzcmMuCgkJaWYgKGl0ZW0gPT0gbnVsbCkgeyByZXR1cm47IH0gLy8gU29tZXRpbWVzIHBsdWdpbnMgb3IgdHlwZXMgc2hvdWxkIGJlIHNraXBwZWQuCgkJdmFyIGxvYWRlciA9IHRoaXMuX2NyZWF0ZUxvYWRlcihpdGVtKTsKCQlpZiAobG9hZGVyICE9IG51bGwpIHsKCQkJaXRlbS5fbG9hZGVyID0gbG9hZGVyOwoJCQl0aGlzLl9sb2FkUXVldWUucHVzaChsb2FkZXIpOwoJCQl0aGlzLl9sb2FkUXVldWVCYWNrdXAucHVzaChsb2FkZXIpOwoKCQkJdGhpcy5fbnVtSXRlbXMrKzsKCQkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCgkJCS8vIE9ubHkgd29ycnkgYWJvdXQgc2NyaXB0IG9yZGVyIHdoZW4gdXNpbmcgWEhSIHRvIGxvYWQgc2NyaXB0cy4gVGFncyBhcmUgb25seSBsb2FkaW5nIG9uZSBhdCBhIHRpbWUuCgkJCWlmICgodGhpcy5tYWludGFpblNjcmlwdE9yZGVyCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUCgkJCQkJLy8mJiBsb2FkZXIgaW5zdGFuY2VvZiBjcmVhdGVqcy5YSFJMb2FkZXIgLy9OT1RFOiBIYXZlIHRvIHRyYWNrIGFsbCBKUyBmaWxlcyB0aGlzIHdheQoJCQkJCSkKCQkJCQl8fCBpdGVtLm1haW50YWluT3JkZXIgPT09IHRydWUpIHsKCQkJCXRoaXMuX3NjcmlwdE9yZGVyLnB1c2goaXRlbSk7CgkJCQl0aGlzLl9sb2FkZWRTY3JpcHRzLnB1c2gobnVsbCk7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGEgcmVmaW5lZCBsb2FkIGl0ZW0sIHdoaWNoIGNvbnRhaW5zIGFsbCB0aGUgcmVxdWlyZWQgcHJvcGVydGllcyAoc3JjLCB0eXBlLCBleHRlbnNpb24sIHRhZykuIFRoZSB0eXBlIG9mCgkgKiBpdGVtIGlzIGRldGVybWluZWQgYnkgYnJvd3NlciBzdXBwb3J0LCByZXF1aXJlbWVudHMgYmFzZWQgb24gdGhlIGZpbGUgdHlwZSwgYW5kIGRldmVsb3BlciBzZXR0aW5ncy4gRm9yIGV4YW1wbGUsCgkgKiBYSFIgaXMgb25seSB1c2VkIGZvciBmaWxlIHR5cGVzIHRoYXQgc3VwcG9ydCBpdCBpbiBuZXcgYnJvd3NlcnMuCgkgKgoJICogQmVmb3JlIHRoZSBpdGVtIGlzIHJldHVybmVkLCBhbnkgcGx1Z2lucyByZWdpc3RlcmVkIHRvIGhhbmRsZSB0aGUgdHlwZSBvciBleHRlbnNpb24gd2lsbCBiZSBmaXJlZCwgd2hpY2ggbWF5CgkgKiBhbHRlciB0aGUgbG9hZCBpdGVtLgoJICogQG1ldGhvZCBfY3JlYXRlTG9hZEl0ZW0KCSAqIEBwYXJhbSB7U3RyaW5nIHwgT2JqZWN0IHwgSFRNTEF1ZGlvRWxlbWVudCB8IEhUTUxJbWFnZUVsZW1lbnR9IHZhbHVlIFRoZSBpdGVtIHRoYXQgbmVlZHMgdG8gYmUgcHJlbG9hZGVkLgogCSAqIEBwYXJhbSB7U3RyaW5nfSBbcGF0aF0gQSBwYXRoIHRvIHByZXBlbmQgdG8gdGhlIGl0ZW0ncyBzb3VyY2UuIFNvdXJjZXMgYmVnaW5uaW5nIHdpdGggaHR0cDovLyBvciBzaW1pbGFyIHdpbGwKCSAqIG5vdCByZWNlaXZlIGEgcGF0aC4gU2luY2UgUHJlbG9hZEpTIDAuNC4xLCB0aGUgc3JjIHdpbGwgYmUgbW9kaWZpZWQgdG8gaW5jbHVkZSB0aGUgYHBhdGhgIGFuZCB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9fYmFzZVBhdGg6cHJvcGVydHkifX17ey9jcm9zc0xpbmt9fQoJICogd2hlbiBpdCBpcyBhZGRlZC4KCSAqIEBwYXJhbSB7U3RyaW5nfSBbYmFzZVBhdGhdIDxzdHJvbmc+RGVwcmVjdGF0ZWQ8L3N0cm9uZz4gQSBiYXNlIHBhdGggdG8gcHJlcGVuZCB0byB0aGUgaXRlbXMgc291cmNlIGluIGFkZGl0aW9uIHRvCgkgKiB0aGUgcGF0aCBhcmd1bWVudC4KCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGxvYWRlciBpbnN0YW5jZSB0aGF0IHdpbGwgYmUgdXNlZC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NyZWF0ZUxvYWRJdGVtID0gZnVuY3Rpb24odmFsdWUsIHBhdGgsIGJhc2VQYXRoKSB7CgkJdmFyIGl0ZW0gPSBudWxsOwoKCQkvLyBDcmVhdGUvbW9kaWZ5IGEgbG9hZCBpdGVtCgkJc3dpdGNoKHR5cGVvZih2YWx1ZSkpIHsKCQkJY2FzZSAic3RyaW5nIjoKCQkJCWl0ZW0gPSB7CgkJCQkJc3JjOiB2YWx1ZQoJCQkJfTsgYnJlYWs7CgkJCWNhc2UgIm9iamVjdCI6CgkJCQlpZiAod2luZG93LkhUTUxBdWRpb0VsZW1lbnQgJiYgdmFsdWUgaW5zdGFuY2VvZiB3aW5kb3cuSFRNTEF1ZGlvRWxlbWVudCkgewoJCQkJCWl0ZW0gPSB7CgkJCQkJCXRhZzogdmFsdWUsCgkJCQkJCXNyYzogaXRlbS50YWcuc3JjLAoJCQkJCQl0eXBlOiBjcmVhdGVqcy5Mb2FkUXVldWUuU09VTkQKCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdmFsdWU7CgkJCQl9CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBudWxsOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIEV4dGVuc2lvbiwgZXRjLgoJCXZhciBtYXRjaCA9IHRoaXMuX3BhcnNlVVJJKGl0ZW0uc3JjKTsKCQlpZiAobWF0Y2guZXh0ZW5zaW9uKSB7IGl0ZW0uZXh0ID0gbWF0Y2guZXh0ZW5zaW9uOyB9CgkJaWYgKGl0ZW0udHlwZSA9PSBudWxsKSB7CgkJCWl0ZW0udHlwZSA9IHRoaXMuX2dldFR5cGVCeUV4dGVuc2lvbihpdGVtLmV4dCk7CgkJfQoKCQkvLyBJbmplY3QgcGF0aCAmIGJhc2VQYXRoCgkJdmFyIGJwID0gIiI7IC8vIFN0b3JlIHRoZSBnZW5lcmF0ZWQgYmFzZVBhdGgKCQl2YXIgdXNlQmFzZVBhdGggPSBiYXNlUGF0aCB8fCB0aGlzLl9iYXNlUGF0aDsKCQl2YXIgYXV0b0lkID0gaXRlbS5zcmM7CgkJaWYgKCFtYXRjaC5hYnNvbHV0ZSAmJiAhbWF0Y2gucmVsYXRpdmUpIHsKCQkJaWYgKHBhdGgpIHsKCQkJCWJwID0gcGF0aDsKCQkJCXZhciBwYXRoTWF0Y2ggPSB0aGlzLl9wYXJzZVVSSShwYXRoKTsKCQkJCWF1dG9JZCA9IHBhdGggKyBhdXRvSWQ7CgkJCQkvLyBBbHNvIGFwcGVuZCBiYXNlUGF0aAoJCQkJaWYgKHVzZUJhc2VQYXRoICE9IG51bGwgJiYgIXBhdGhNYXRjaC5hYnNvbHV0ZSAmJiAhcGF0aE1hdGNoLnJlbGF0aXZlKSB7CgkJCQkJYnAgPSB1c2VCYXNlUGF0aCArIGJwOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHVzZUJhc2VQYXRoICE9IG51bGwpIHsKCQkJCWJwID0gdXNlQmFzZVBhdGg7CgkJCX0KCQl9CgkJaXRlbS5zcmMgPSBicCArIGl0ZW0uc3JjOwoJCWl0ZW0ucGF0aCA9IGJwOwoKCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OIHx8IGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1QpIHsKCQkJaXRlbS5fbG9hZEFzSlNPTlAgPSAoaXRlbS5jYWxsYmFjayAhPSBudWxsKTsKCQl9CgoJCWlmIChpdGVtLnR5cGUgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QICYmIGl0ZW0uY2FsbGJhY2sgPT0gbnVsbCkgewoJCQl0aHJvdyBuZXcgRXJyb3IoJ2NhbGxiYWNrIGlzIHJlcXVpcmVkIGZvciBsb2FkaW5nIEpTT05QIHJlcXVlc3RzLicpOwoJCX0KCgkJLy8gQ3JlYXRlIGEgdGFnIGZvciB0aGUgaXRlbS4gVGhpcyBlbnN1cmVzIHRoZXJlIGlzIHNvbWV0aGluZyB0byBlaXRoZXIgbG9hZCB3aXRoIG9yIHBvcHVsYXRlIHdoZW4gZmluaXNoZWQuCgkJaWYgKGl0ZW0udGFnID09PSB1bmRlZmluZWQgfHwgaXRlbS50YWcgPT09IG51bGwpIHsKCQkJaXRlbS50YWcgPSB0aGlzLl9jcmVhdGVUYWcoaXRlbSk7CgkJfQoKCQkvLyBJZiB0aGVyZSdzIG5vIGlkLCBzZXQgb25lIG5vdy4KCQlpZiAoaXRlbS5pZCA9PT0gdW5kZWZpbmVkIHx8IGl0ZW0uaWQgPT09IG51bGwgfHwgaXRlbS5pZCA9PT0gIiIpIHsKICAgICAgICAgICAgaXRlbS5pZCA9IGF1dG9JZDsKCQl9CgoJCS8vIEdpdmUgcGx1Z2lucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGxvYWRJdGVtOgoJCXZhciBjdXN0b21IYW5kbGVyID0gdGhpcy5fdHlwZUNhbGxiYWNrc1tpdGVtLnR5cGVdIHx8IHRoaXMuX2V4dGVuc2lvbkNhbGxiYWNrc1tpdGVtLmV4dF07CgkJaWYgKGN1c3RvbUhhbmRsZXIpIHsKCQkJLy8gUGx1Z2lucyBhcmUgbm93IHBhc3NlZCBib3RoIHRoZSBmdWxsIHNvdXJjZSwgYXMgd2VsbCBhcyBhIGNvbWJpbmVkIHBhdGgrYmFzZVBhdGggKGFwcHJvcHJpYXRlbHkpCgkJCXZhciByZXN1bHQgPSBjdXN0b21IYW5kbGVyLmNhbGxiYWNrLmNhbGwoY3VzdG9tSGFuZGxlci5zY29wZSwgaXRlbS5zcmMsIGl0ZW0udHlwZSwgaXRlbS5pZCwgaXRlbS5kYXRhLAoJCQkJCWJwLCB0aGlzKTsKCQkJLy8gTk9URTogQmFzZVBhdGggYXJndW1lbnQgaXMgZGVwcmVjYXRlZC4gV2UgcGFzcyBpdCB0byBwbHVnaW5zLmFsbG93IFNvdW5kSlMgdG8gbW9kaWZ5IHRoZSBmaWxlLiB0byBzYW55bW9yZS4gVGhlIGZ1bGwgcGF0aCBpcyBzZW50IHRvIHRoZSBwbHVnaW4KCgkJCS8vIFRoZSBwbHVnaW4gd2lsbCBoYW5kbGUgdGhlIGxvYWQsIG9yIGhhcyBjYW5jZWxlZCBpdC4gSWdub3JlIGl0LgoJCQlpZiAocmVzdWx0ID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIG51bGw7CgoJCQkvLyBMb2FkIGFzIG5vcm1hbDoKCQkJfSBlbHNlIGlmIChyZXN1bHQgPT09IHRydWUpIHsKCQkJCS8vIERvIE5vdGhpbmcKCgkJCS8vIFJlc3VsdCBpcyBhIGxvYWRlciBjbGFzczoKCQkJfSBlbHNlIHsKCQkJCWlmIChyZXN1bHQuc3JjICE9IG51bGwpIHsgaXRlbS5zcmMgPSByZXN1bHQuc3JjOyB9CgkJCQlpZiAocmVzdWx0LmlkICE9IG51bGwpIHsgaXRlbS5pZCA9IHJlc3VsdC5pZDsgfSAvLyBUT0RPOiBFdmFsdWF0ZSB0aGlzLiBBbiBvdmVycmlkZGVuIElEIGNvdWxkIGJlIHByb2JsZW1hdGljCgkJCQlpZiAocmVzdWx0LnRhZyAhPSBudWxsKSB7IC8vIEFzc3VtZXMgdGhhdCB0aGUgcmV0dXJuZWQgdGFnIGVpdGhlciBoYXMgYSBsb2FkIG1ldGhvZCBvciBhIHNyYyBzZXR0ZXIuCgkJCQkJaXRlbS50YWcgPSByZXN1bHQudGFnOwoJCQkJfQogICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5jb21wbGV0ZUhhbmRsZXIgIT0gbnVsbCkgeyBpdGVtLmNvbXBsZXRlSGFuZGxlciA9IHJlc3VsdC5jb21wbGV0ZUhhbmRsZXI7IH0KCgkJCQkvLyBBbGxvdyB0eXBlIG92ZXJyaWRpbmc6CgkJCQlpZiAocmVzdWx0LnR5cGUpIHsgaXRlbS50eXBlID0gcmVzdWx0LnR5cGU7IH0KCgkJCQkvLyBVcGRhdGUgdGhlIGV4dGVuc2lvbiBpbiBjYXNlIHRoZSB0eXBlIGNoYW5nZWQ6CgkJCQltYXRjaCA9IHRoaXMuX3BhcnNlVVJJKGl0ZW0uc3JjKTsKCQkJCWlmIChtYXRjaC5leHRlbnNpb24gIT0gbnVsbCkgewoJCQkJCWl0ZW0uZXh0ID0gbWF0Y2guZXh0ZW5zaW9uOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBTdG9yZSB0aGUgaXRlbSBmb3IgbG9va3VwLiBUaGlzIGFsc28gaGVscHMgY2xlYW4tdXAgbGF0ZXIuCgkJdGhpcy5fbG9hZEl0ZW1zQnlJZFtpdGVtLmlkXSA9IGl0ZW07CgkJdGhpcy5fbG9hZEl0ZW1zQnlTcmNbaXRlbS5zcmNdID0gaXRlbTsKCgkJcmV0dXJuIGl0ZW07Cgl9OwoKCS8qKgoJICogQ3JlYXRlIGEgbG9hZGVyIGZvciBhIGxvYWQgaXRlbS4KCSAqIEBtZXRob2QgX2NyZWF0ZUxvYWRlcgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gQSBmb3JtYXR0ZWQgbG9hZCBpdGVtIHRoYXQgY2FuIGJlIHVzZWQgdG8gZ2VuZXJhdGUgYSBsb2FkZXIuCgkgKiBAcmV0dXJuIHtBYnN0cmFjdExvYWRlcn0gQSBsb2FkZXIgdGhhdCBjYW4gYmUgdXNlZCB0byBsb2FkIGNvbnRlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jcmVhdGVMb2FkZXIgPSBmdW5jdGlvbihpdGVtKSB7CgkJLy8gSW5pdGlhbGx5LCB0cnkgYW5kIHVzZSB0aGUgcHJvdmlkZWQvc3VwcG9ydGVkIFhIUiBtb2RlOgoJCXZhciB1c2VYSFIgPSB0aGlzLnVzZVhIUjsKCgkJLy8gRGV0ZXJtaW5lIHRoZSBYSFIgdXNhZ2Ugb3ZlcnJpZGVzOgoJCXN3aXRjaCAoaXRlbS50eXBlKSB7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQkJdXNlWEhSID0gIWl0ZW0uX2xvYWRBc0pTT05QOwoJCQkJYnJlYWs7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDoKCQkJCXVzZVhIUiA9IHRydWU7IC8vIEFsd2F5cyB1c2UgWEhSMiB3aXRoIHRleHQvWE1MCgkJCQlicmVhazsKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuU09VTkQ6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QOgoJCQkJdXNlWEhSID0gZmFsc2U7IC8vIE5ldmVyIGxvYWQgYXVkaW8gdXNpbmcgWEhSLiBXZWJBdWRpbyB3aWxsIHByb3ZpZGUgaXRzIG93biBsb2FkZXIuCgkJCQlicmVhazsKCQkJY2FzZSBudWxsOgoJCQkJcmV0dXJuIG51bGw7CgkJCS8vIE5vdGU6IElNQUdFLCBDU1MsIFNDUklQVCwgU1ZHIGNhbiBhbGwgdXNlIFRBR1Mgb3IgWEhSLgoJCX0KCgkJaWYgKHVzZVhIUikgewoJCQlyZXR1cm4gbmV3IGNyZWF0ZWpzLlhIUkxvYWRlcihpdGVtLCB0aGlzLl9jcm9zc09yaWdpbik7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBjcmVhdGVqcy5UYWdMb2FkZXIoaXRlbSk7CgkJfQoJfTsKCgoJLyoqCgkgKiBMb2FkIHRoZSBuZXh0IGl0ZW0gaW4gdGhlIHF1ZXVlLiBJZiB0aGUgcXVldWUgaXMgZW1wdHkgKGFsbCBpdGVtcyBoYXZlIGJlZW4gbG9hZGVkKSwgdGhlbiB0aGUgY29tcGxldGUgZXZlbnQKCSAqIGlzIHByb2Nlc3NlZC4gVGhlIHF1ZXVlIHdpbGwgImZpbGwgdXAiIGFueSBlbXB0eSBzbG90cywgdXAgdG8gdGhlIG1heCBjb25uZWN0aW9uIHNwZWNpZmllZCB1c2luZwoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUuc2V0TWF4Q29ubmVjdGlvbnMifX17ey9jcm9zc0xpbmt9fSBtZXRob2QuIFRoZSBvbmx5IGV4Y2VwdGlvbiBpcyBzY3JpcHRzIHRoYXQgYXJlIGxvYWRlZAoJICogdXNpbmcgdGFncywgd2hpY2ggaGF2ZSB0byBiZSBsb2FkZWQgb25lIGF0IGEgdGltZSB0byBtYWludGFpbiBsb2FkIG9yZGVyLgoJICogQG1ldGhvZCBfbG9hZE5leHQKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2xvYWROZXh0ID0gZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuX3BhdXNlZCkgeyByZXR1cm47IH0KCgkJLy8gT25seSBkaXNwYXRjaCBsb2Fkc3RhcnQgZXZlbnQgd2hlbiB0aGUgZmlyc3QgZmlsZSBpcyBsb2FkZWQuCgkJaWYgKCF0aGlzLl9sb2FkU3RhcnRXYXNEaXNwYXRjaGVkKSB7CgkJCXRoaXMuX3NlbmRMb2FkU3RhcnQoKTsKCQkJdGhpcy5fbG9hZFN0YXJ0V2FzRGlzcGF0Y2hlZCA9IHRydWU7CgkJfQoKCQkvLyBUaGUgcXVldWUgaGFzIGNvbXBsZXRlZC4KCQlpZiAodGhpcy5fbnVtSXRlbXMgPT0gdGhpcy5fbnVtSXRlbXNMb2FkZWQpIHsKCQkJdGhpcy5sb2FkZWQgPSB0cnVlOwoJCQl0aGlzLl9zZW5kQ29tcGxldGUoKTsKCgkJCS8vIExvYWQgdGhlIG5leHQgcXVldWUsIGlmIGl0IGhhcyBiZWVuIGRlZmluZWQuCgkJCWlmICh0aGlzLm5leHQgJiYgdGhpcy5uZXh0LmxvYWQpIHsKCQkJCXRoaXMubmV4dC5sb2FkKCk7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLmxvYWRlZCA9IGZhbHNlOwoJCX0KCgkJLy8gTXVzdCBpdGVyYXRlIGZvcndhcmRzIHRvIGxvYWQgaW4gdGhlIHJpZ2h0IG9yZGVyLgoJCWZvciAodmFyIGk9MDsgaTx0aGlzLl9sb2FkUXVldWUubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGggPj0gdGhpcy5fbWF4Q29ubmVjdGlvbnMpIHsgYnJlYWs7IH0KCQkJdmFyIGxvYWRlciA9IHRoaXMuX2xvYWRRdWV1ZVtpXTsKCgkJCS8vIERldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgb25seSBsb2FkaW5nIG9uZSB0YWctc2NyaXB0IGF0IGEgdGltZToKCQkJLy8gTm90ZTogbWFpbnRhaW5PcmRlciBpdGVtcyBkb24ndCBkbyBhbnl0aGluZyBoZXJlIGJlY2F1c2Ugd2UgY2FuIGhvbGQgb250byB0aGVpciBsb2FkZWQgdmFsdWUKCQkJaWYgKCF0aGlzLl9jYW5TdGFydExvYWQobG9hZGVyKSkgeyBjb250aW51ZTsgfQoJCQl0aGlzLl9sb2FkUXVldWUuc3BsaWNlKGksIDEpOwogIAkJCWktLTsKICAgICAgICAgICAgdGhpcy5fbG9hZEl0ZW0obG9hZGVyKTsKCQl9Cgl9OwoKCS8qKgoJICogQmVnaW4gbG9hZGluZyBhbiBpdGVtLiBFdmVudHMgYXJlIG5vdCBhZGRlZCB0byB0aGUgbG9hZGVycyB1bnRpbCB0aGUgbG9hZCBzdGFydHMuCgkgKiBAbWV0aG9kIF9sb2FkSXRlbQoJICogQHBhcmFtIHtBYnN0cmFjdExvYWRlcn0gbG9hZGVyIFRoZSBsb2FkZXIgaW5zdGFuY2UgdG8gc3RhcnQuIEN1cnJlbnRseSwgdGhpcyB3aWxsIGJlIGFuIFhIUkxvYWRlciBvciBUYWdMb2FkZXIuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkSXRlbSA9IGZ1bmN0aW9uKGxvYWRlcikgewoJCWxvYWRlci5vbigicHJvZ3Jlc3MiLCB0aGlzLl9oYW5kbGVQcm9ncmVzcywgdGhpcyk7CgkJbG9hZGVyLm9uKCJjb21wbGV0ZSIsIHRoaXMuX2hhbmRsZUZpbGVDb21wbGV0ZSwgdGhpcyk7CgkJbG9hZGVyLm9uKCJlcnJvciIsIHRoaXMuX2hhbmRsZUZpbGVFcnJvciwgdGhpcyk7CgkJdGhpcy5fY3VycmVudExvYWRzLnB1c2gobG9hZGVyKTsKCQl0aGlzLl9zZW5kRmlsZVN0YXJ0KGxvYWRlci5nZXRJdGVtKCkpOwoJCWxvYWRlci5sb2FkKCk7Cgl9OwoKCS8qKgoJICogVGhlIGNhbGxiYWNrIHRoYXQgaXMgZmlyZWQgd2hlbiBhIGxvYWRlciBlbmNvdW50ZXJzIGFuIGVycm9yLiBUaGUgcXVldWUgd2lsbCBjb250aW51ZSBsb2FkaW5nIHVubGVzcyB7eyNjcm9zc0xpbmsgIkxvYWRRdWV1ZS9zdG9wT25FcnJvcjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiBpcyBzZXQgdG8gYHRydWVgLgoJICogQG1ldGhvZCBfaGFuZGxlRmlsZUVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIGVycm9yIGV2ZW50LCBjb250YWluaW5nIHJlbGV2YW50IGVycm9yIGluZm9ybWF0aW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlRmlsZUVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgbG9hZGVyID0gZXZlbnQudGFyZ2V0OwoJCXRoaXMuX251bUl0ZW1zTG9hZGVkKys7CgoJCXRoaXMuX2ZpbmlzaE9yZGVyZWRJdGVtKGxvYWRlciwgdHJ1ZSk7CgkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCgkJdmFyIG5ld0V2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCW5ld0V2ZW50LnRleHQgPSAiRklMRV9MT0FEX0VSUk9SIjsKCQluZXdFdmVudC5pdGVtID0gbG9hZGVyLmdldEl0ZW0oKTsKCQkvLyBUT0RPOiBQcm9wYWdhdGUgYWN0dWFsIGVycm9yIG1lc3NhZ2UuCgoJCXRoaXMuX3NlbmRFcnJvcihuZXdFdmVudCk7CgoJCWlmICghdGhpcy5zdG9wT25FcnJvcikgewoJCQl0aGlzLl9yZW1vdmVMb2FkSXRlbShsb2FkZXIpOwoJCQl0aGlzLl9sb2FkTmV4dCgpOwoJCX0KCX07CgoJLyoqCgkgKiBBbiBpdGVtIGhhcyBmaW5pc2hlZCBsb2FkaW5nLiBXZSBjYW4gYXNzdW1lIHRoYXQgaXQgaXMgdG90YWxseSBsb2FkZWQsIGhhcyBiZWVuIHBhcnNlZCBmb3IgaW1tZWRpYXRlIHVzZSwgYW5kCgkgKiBpcyBhdmFpbGFibGUgYXMgdGhlICJyZXN1bHQiIHByb3BlcnR5IG9uIHRoZSBsb2FkIGl0ZW0uIFRoZSByYXcgdGV4dCByZXN1bHQgZm9yIGEgcGFyc2VkIGl0ZW0gKHN1Y2ggYXMgSlNPTiwgWE1MLAoJICogQ1NTLCBKYXZhU2NyaXB0LCBldGMpIGlzIGF2YWlsYWJsZSBhcyB0aGUgInJhd1Jlc3VsdCIgZXZlbnQsIGFuZCBjYW4gYWxzbyBiZSBsb29rZWQgdXAgdXNpbmcge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZ2V0UmVzdWx0In19e3svY3Jvc3NMaW5rfX0uCgkgKiBAbWV0aG9kIF9oYW5kbGVGaWxlQ29tcGxldGUKCSAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgZXZlbnQgb2JqZWN0IGZyb20gdGhlIGxvYWRlci4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUZpbGVDb21wbGV0ZSA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIGxvYWRlciA9IGV2ZW50LnRhcmdldDsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgoJCXRoaXMuX2xvYWRlZFJlc3VsdHNbaXRlbS5pZF0gPSBsb2FkZXIuZ2V0UmVzdWx0KCk7CgkJaWYgKGxvYWRlciBpbnN0YW5jZW9mIGNyZWF0ZWpzLlhIUkxvYWRlcikgewoJCQl0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2l0ZW0uaWRdID0gbG9hZGVyLmdldFJlc3VsdCh0cnVlKTsKCQl9CgoJCS8vIENsZWFuIHVwIHRoZSBsb2FkIGl0ZW0KCQl0aGlzLl9yZW1vdmVMb2FkSXRlbShsb2FkZXIpOwoKCQlpZiAoIXRoaXMuX2ZpbmlzaE9yZGVyZWRJdGVtKGxvYWRlcikpIHsKCQkJLy8gVGhlIGl0ZW0gd2FzIE5PVCBtYW5hZ2VkLCBzbyBwcm9jZXNzIGl0IG5vdwoJCQl0aGlzLl9wcm9jZXNzRmluaXNoZWRMb2FkKGl0ZW0sIGxvYWRlcik7CgkJfQoJfTsKCgkvKioKCSAqIEZsYWcgYW4gaXRlbSBhcyBmaW5pc2hlZC4gSWYgdGhlIGl0ZW0ncyBvcmRlciBpcyBiZWluZyBtYW5hZ2VkLCB0aGVuIHNldCBpdCB1cCB0byBmaW5pc2gKCSAqIEBtZXRob2QgX2ZpbmlzaE9yZGVyZWRJdGVtCgkgKiBAcGFyYW0ge0Fic3RyYWN0TG9hZGVyfSBsb2FkZXIKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSBpdGVtJ3Mgb3JkZXIgaXMgYmVpbmcgbWFuYWdlZC4gVGhpcyBhbGxvd3MgdGhlIGNhbGxlciB0byB0YWtlIGFuIGFsdGVybmF0ZQoJICogYmVoYXZpb3VyIGlmIGl0IGlzLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZmluaXNoT3JkZXJlZEl0ZW0gPSBmdW5jdGlvbihsb2FkZXIsIGxvYWRGYWlsZWQpIHsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgoJCWlmICgodGhpcy5tYWludGFpblNjcmlwdE9yZGVyICYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVCkKCQkJCXx8IGl0ZW0ubWFpbnRhaW5PcmRlcikgewoKCQkJLy9UT0RPOiBFdmFsdWF0ZSByZW1vdmFsIG9mIHRoZSBfY3VycmVudGx5TG9hZGluZ1NjcmlwdAoJCQlpZiAobG9hZGVyIGluc3RhbmNlb2YgY3JlYXRlanMuVGFnTG9hZGVyICYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVCkgewoJCQkJdGhpcy5fY3VycmVudGx5TG9hZGluZ1NjcmlwdCA9IGZhbHNlOwoJCQl9CgoJCQl2YXIgaW5kZXggPSBjcmVhdGVqcy5pbmRleE9mKHRoaXMuX3NjcmlwdE9yZGVyLCBpdGVtKTsKCQkJaWYgKGluZGV4ID09IC0xKSB7IHJldHVybiBmYWxzZTsgfSAvLyBUaGlzIGxvYWRlciBubyBsb25nZXIgZXhpc3RzCgkJCXRoaXMuX2xvYWRlZFNjcmlwdHNbaW5kZXhdID0gKGxvYWRGYWlsZWQgPT09IHRydWUpID8gdHJ1ZSA6IGl0ZW07CgoJCQl0aGlzLl9jaGVja1NjcmlwdExvYWRPcmRlcigpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX07CgoJLyoqCgkgKiBFbnN1cmUgdGhlIHNjcmlwdHMgbG9hZCBhbmQgZGlzcGF0Y2ggaW4gdGhlIGNvcnJlY3Qgb3JkZXIuIFdoZW4gdXNpbmcgWEhSLCBzY3JpcHRzIGFyZSBzdG9yZWQgaW4gYW4gYXJyYXkgaW4gdGhlCgkgKiBvcmRlciB0aGV5IHdlcmUgYWRkZWQsIGJ1dCB3aXRoIGEgIm51bGwiIHZhbHVlLiBXaGVuIHRoZXkgYXJlIGNvbXBsZXRlZCwgdGhlIHZhbHVlIGlzIHNldCB0byB0aGUgbG9hZCBpdGVtLAoJICogYW5kIHRoZW4gd2hlbiB0aGV5IGFyZSBwcm9jZXNzZWQgYW5kIGRpc3BhdGNoZWQsIHRoZSB2YWx1ZSBpcyBzZXQgdG8gPGNvZGU+dHJ1ZTwvY29kZT4uIFRoaXMgbWV0aG9kIHNpbXBseQoJICogaXRlcmF0ZXMgdGhlIGFycmF5LCBhbmQgZW5zdXJlcyB0aGF0IGFueSBsb2FkZWQgaXRlbXMgdGhhdCBhcmUgbm90IHByZWNlZGVkIGJ5IGEgPGNvZGU+bnVsbDwvY29kZT4gdmFsdWUgYXJlCgkgKiBkaXNwYXRjaGVkLgoJICogQG1ldGhvZCBfY2hlY2tTY3JpcHRMb2FkT3JkZXIKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NoZWNrU2NyaXB0TG9hZE9yZGVyID0gZnVuY3Rpb24gKCkgewoJCXZhciBsID0gdGhpcy5fbG9hZGVkU2NyaXB0cy5sZW5ndGg7CgoJCWZvciAodmFyIGk9MDtpPGw7aSsrKSB7CgkJCXZhciBpdGVtID0gdGhpcy5fbG9hZGVkU2NyaXB0c1tpXTsKCQkJaWYgKGl0ZW0gPT09IG51bGwpIHsgYnJlYWs7IH0gLy8gVGhpcyBpcyBzdGlsbCBsb2FkaW5nLiBEbyBub3QgcHJvY2VzcyBmdXJ0aGVyLgogCQkJaWYgKGl0ZW0gPT09IHRydWUpIHsgY29udGludWU7IH0gLy8gVGhpcyBoYXMgY29tcGxldGVkLCBhbmQgYmVlbiBwcm9jZXNzZWQuIE1vdmUgb24uCgoJCQl2YXIgbG9hZEl0ZW0gPSB0aGlzLl9sb2FkZWRSZXN1bHRzW2l0ZW0uaWRdOwoJCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUKSB7CgkJCQkvLyBBcHBlbmQgc2NyaXB0IHRhZ3MgdG8gdGhlIGhlYWQgYXV0b21hdGljYWxseS4gVGFncyBkbyB0aGlzIGluIHRoZSBsb2FkZXIsIGJ1dCBYSFIgc2NyaXB0cyBoYXZlIHRvIG1haW50YWluIG9yZGVyLgoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXSkuYXBwZW5kQ2hpbGQobG9hZEl0ZW0pOwoJCQl9CgoJCQl2YXIgbG9hZGVyID0gaXRlbS5fbG9hZGVyOwoJCQl0aGlzLl9wcm9jZXNzRmluaXNoZWRMb2FkKGl0ZW0sIGxvYWRlcik7CgkJCXRoaXMuX2xvYWRlZFNjcmlwdHNbaV0gPSB0cnVlOwoJCX0KCX07CgoJLyoqCgkgKiBAbWV0aG9kIF9wcm9jZXNzRmluaXNoZWRMb2FkCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbQoJICogQHBhcmFtIHtBYnN0cmFjdExvYWRlcn0gbG9hZGVyCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3Byb2Nlc3NGaW5pc2hlZExvYWQgPSBmdW5jdGlvbihpdGVtLCBsb2FkZXIpIHsKCQkvLyBJZiB0aGUgaXRlbSB3YXMgYSBtYW5pZmVzdCwgdGhlbiBxdWV1ZSBpdCB1cCEKCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQl2YXIgcmVzdWx0ID0gbG9hZGVyLmdldFJlc3VsdCgpOwoJCQlpZiAocmVzdWx0ICE9IG51bGwgJiYgcmVzdWx0Lm1hbmlmZXN0ICE9PSB1bmRlZmluZWQpIHsKCQkJCXRoaXMubG9hZE1hbmlmZXN0KHJlc3VsdCwgdHJ1ZSk7CgkJCX0KCQl9CgoJCXRoaXMuX251bUl0ZW1zTG9hZGVkKys7CgkJdGhpcy5fdXBkYXRlUHJvZ3Jlc3MoKTsKCQl0aGlzLl9zZW5kRmlsZUNvbXBsZXRlKGl0ZW0sIGxvYWRlcik7CgoJCXRoaXMuX2xvYWROZXh0KCk7Cgl9OwoKCS8qKgoJICogRW5zdXJlIGl0ZW1zIHdpdGggYG1haW50YWluT3JkZXI9dHJ1ZWAgdGhhdCBhcmUgYmVmb3JlIHRoZSBzcGVjaWZpZWQgaXRlbSBoYXZlIGxvYWRlZC4gVGhpcyBvbmx5IGFwcGxpZXMgdG8KCSAqIEphdmFTY3JpcHQgaXRlbXMgdGhhdCBhcmUgYmVpbmcgbG9hZGVkIHdpdGggYSBUYWdMb2FkZXIsIHNpbmNlIHRoZXkgaGF2ZSB0byBiZSBsb2FkZWQgYW5kIGNvbXBsZXRlZCA8c3Ryb25nPmJlZm9yZTwvc3Ryb25nPgoJICogdGhlIHNjcmlwdCBjYW4gZXZlbiBiZSBzdGFydGVkLCBzaW5jZSBpdCBleGlzdCBpbiB0aGUgRE9NIHdoaWxlIGxvYWRpbmcuCgkgKiBAbWV0aG9kIF9jYW5TdGFydExvYWQKCSAqIEBwYXJhbSB7WEhSTG9hZGVyfFRhZ0xvYWRlcn0gbG9hZGVyIFRoZSBsb2FkZXIgZm9yIHRoZSBpdGVtCgkgKiBAcmV0dXJuIHtCb29sZWFufSBXaGV0aGVyIHRoZSBpdGVtIGNhbiBzdGFydCBhIGxvYWQgb3Igbm90LgoJICogQHByaXZhdGUKCSAqLwoJcC5fY2FuU3RhcnRMb2FkID0gZnVuY3Rpb24obG9hZGVyKSB7CgkJaWYgKCF0aGlzLm1haW50YWluU2NyaXB0T3JkZXIgfHwgbG9hZGVyIGluc3RhbmNlb2YgY3JlYXRlanMuWEhSTG9hZGVyKSB7IHJldHVybiB0cnVlOyB9CgkJdmFyIGl0ZW0gPSBsb2FkZXIuZ2V0SXRlbSgpOwoJCWlmIChpdGVtLnR5cGUgIT0gY3JlYXRlanMuTG9hZFF1ZXVlLkpBVkFTQ1JJUFQpIHsgcmV0dXJuIHRydWU7IH0KCQlpZiAodGhpcy5fY3VycmVudGx5TG9hZGluZ1NjcmlwdCkgeyByZXR1cm4gZmFsc2U7IH0KCgkJdmFyIGluZGV4ID0gdGhpcy5fc2NyaXB0T3JkZXIuaW5kZXhPZihpdGVtKTsKCQl2YXIgaSA9IDA7CgkJd2hpbGUgKGkgPCBpbmRleCkgewoJCQl2YXIgY2hlY2tJdGVtID0gdGhpcy5fbG9hZGVkU2NyaXB0c1tpXTsKCQkJaWYgKGNoZWNrSXRlbSA9PSBudWxsKSB7IHJldHVybiBmYWxzZTsgfQoJCQlpKys7CgkJfQoJCXRoaXMuX2N1cnJlbnRseUxvYWRpbmdTY3JpcHQgPSB0cnVlOwoJCXJldHVybiB0cnVlOwoJfTsKCgkvKioKCSAqIEEgbG9hZCBpdGVtIGlzIGNvbXBsZXRlZCBvciB3YXMgY2FuY2VsZWQsIGFuZCBuZWVkcyB0byBiZSByZW1vdmVkIGZyb20gdGhlIExvYWRRdWV1ZS4KCSAqIEBtZXRob2QgX3JlbW92ZUxvYWRJdGVtCgkgKiBAcGFyYW0ge0Fic3RyYWN0TG9hZGVyfSBsb2FkZXIgQSBsb2FkZXIgaW5zdGFuY2UgdG8gcmVtb3ZlLgoJICogQHByaXZhdGUKCSAqLwoJcC5fcmVtb3ZlTG9hZEl0ZW0gPSBmdW5jdGlvbihsb2FkZXIpIHsKCQl2YXIgaXRlbSA9IGxvYWRlci5nZXRJdGVtKCk7CgkJZGVsZXRlIGl0ZW0uX2xvYWRlcjsKCQlkZWxldGUgaXRlbS5fbG9hZEFzSlNPTlA7CgoJCXZhciBsID0gdGhpcy5fY3VycmVudExvYWRzLmxlbmd0aDsKCQlmb3IgKHZhciBpPTA7aTxsO2krKykgewoJCQlpZiAodGhpcy5fY3VycmVudExvYWRzW2ldID09IGxvYWRlcikgewoJCQkJdGhpcy5fY3VycmVudExvYWRzLnNwbGljZShpLDEpOyBicmVhazsKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBBbiBpdGVtIGhhcyBkaXNwYXRjaGVkIHByb2dyZXNzLiBQcm9wYWdhdGUgdGhhdCBwcm9ncmVzcywgYW5kIHVwZGF0ZSB0aGUgTG9hZFF1ZXVlIG92ZXJhbGwgcHJvZ3Jlc3MuCgkgKiBAbWV0aG9kIF9oYW5kbGVQcm9ncmVzcwoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBwcm9ncmVzcyBldmVudCBmcm9tIHRoZSBpdGVtLgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlUHJvZ3Jlc3MgPSBmdW5jdGlvbihldmVudCkgewoJCXZhciBsb2FkZXIgPSBldmVudC50YXJnZXQ7CgkJdGhpcy5fc2VuZEZpbGVQcm9ncmVzcyhsb2FkZXIuZ2V0SXRlbSgpLCBsb2FkZXIucHJvZ3Jlc3MpOwoJCXRoaXMuX3VwZGF0ZVByb2dyZXNzKCk7Cgl9OwoKCS8qKgoJICogT3ZlcmFsbCBwcm9ncmVzcyBoYXMgY2hhbmdlZCwgc28gZGV0ZXJtaW5lIHRoZSBuZXcgcHJvZ3Jlc3MgYW1vdW50IGFuZCBkaXNwYXRjaCBpdC4gVGhpcyBjaGFuZ2VzIGFueSB0aW1lIGFuCgkgKiBpdGVtIGRpc3BhdGNoZXMgcHJvZ3Jlc3Mgb3IgY29tcGxldGVzLiBOb3RlIHRoYXQgc2luY2Ugd2UgZG9uJ3Qga25vdyB0aGUgYWN0dWFsIGZpbGVzaXplIG9mIGl0ZW1zIGJlZm9yZSB0aGV5IGFyZQoJICogbG9hZGVkLCBhbmQgZXZlbiB0aGVuIHdlIGNhbiBvbmx5IGdldCB0aGUgc2l6ZSBvZiBpdGVtcyBsb2FkZWQgd2l0aCBYSFIuIEluIHRoaXMgY2FzZSwgd2UgZGVmaW5lIGEgInNsb3QiIGZvcgoJICogZWFjaCBpdGVtICgxIGl0ZW0gaW4gMTAgd291bGQgZ2V0IDEwJSksIGFuZCB0aGVuIGFwcGVuZCBsb2FkZWQgcHJvZ3Jlc3Mgb24gdG9wIG9mIHRoZSBhbHJlYWR5LWxvYWRlZCBpdGVtcy4KCSAqCgkgKiBGb3IgZXhhbXBsZSwgaWYgNS8xMCBpdGVtcyBoYXZlIGxvYWRlZCwgYW5kIGl0ZW0gNiBpcyAyMCUgbG9hZGVkLCB0aGUgdG90YWwgcHJvZ3Jlc3Mgd291bGQgYmU6PHVsPgoJICogICAgICA8bGk+NS8xMCBvZiB0aGUgaXRlbXMgaW4gdGhlIHF1ZXVlICg1MCUpPC9saT4KCSAqICAgICAgPGxpPnBsdXMgMjAlIG9mIGl0ZW0gNidzIHNsb3QgKDIlKTwvbGk+CgkgKiAgICAgIDxsaT5lcXVhbHMgNTIlPC9saT48L3VsPgoJICogQG1ldGhvZCBfdXBkYXRlUHJvZ3Jlc3MKCSAqIEBwcml2YXRlCgkgKi8KCXAuX3VwZGF0ZVByb2dyZXNzID0gZnVuY3Rpb24gKCkgewoJCXZhciBsb2FkZWQgPSB0aGlzLl9udW1JdGVtc0xvYWRlZCAvIHRoaXMuX251bUl0ZW1zOyAvLyBGdWxseSBMb2FkZWQgUHJvZ3Jlc3MKCQl2YXIgcmVtYWluaW5nID0gdGhpcy5fbnVtSXRlbXMtdGhpcy5fbnVtSXRlbXNMb2FkZWQ7CgkJaWYgKHJlbWFpbmluZyA+IDApIHsKCQkJdmFyIGNodW5rID0gMDsKCQkJZm9yICh2YXIgaT0wLCBsPXRoaXMuX2N1cnJlbnRMb2Fkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkJCQljaHVuayArPSB0aGlzLl9jdXJyZW50TG9hZHNbaV0ucHJvZ3Jlc3M7CgkJCX0KCQkJbG9hZGVkICs9IChjaHVuayAvIHJlbWFpbmluZykgKiAocmVtYWluaW5nL3RoaXMuX251bUl0ZW1zKTsKCQl9CgkJdGhpcy5fc2VuZFByb2dyZXNzKGxvYWRlZCk7Cgl9OwoKCS8qKgoJICogQ2xlYW4gb3V0IGl0ZW0gcmVzdWx0cywgdG8gZnJlZSB0aGVtIGZyb20gbWVtb3J5LiBNYWlubHksIHRoZSBsb2FkZWQgaXRlbSBhbmQgcmVzdWx0cyBhcmUgY2xlYXJlZCBmcm9tIGludGVybmFsCgkgKiBoYXNoZXMuCgkgKiBAbWV0aG9kIF9kaXNwb3NlSXRlbQoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdGhhdCB3YXMgcGFzc2VkIGluIGZvciBwcmVsb2FkaW5nLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZGlzcG9zZUl0ZW0gPSBmdW5jdGlvbihpdGVtKSB7CgkJZGVsZXRlIHRoaXMuX2xvYWRlZFJlc3VsdHNbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRlZFJhd1Jlc3VsdHNbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRJdGVtc0J5SWRbaXRlbS5pZF07CgkJZGVsZXRlIHRoaXMuX2xvYWRJdGVtc0J5U3JjW2l0ZW0uc3JjXTsKCX07CgoKCS8qKgoJICogQ3JlYXRlIGFuIEhUTUwgdGFnLiBUaGlzIGlzIGluIExvYWRRdWV1ZSBpbnN0ZWFkIG9mIHt7I2Nyb3NzTGluayAiVGFnTG9hZGVyIn19e3svY3Jvc3NMaW5rfX0gYmVjYXVzZSBubyBtYXR0ZXIKCSAqIGhvdyB3ZSBsb2FkIHRoZSBkYXRhLCB3ZSBtYXkgbmVlZCB0byByZXR1cm4gaXQgaW4gYSB0YWcuCgkgKiBAbWV0aG9kIF9jcmVhdGVUYWcKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBpdGVtIHR5cGUuIEl0ZW1zIGFyZSBwYXNzZWQgaW4gYnkgdGhlIGRldmVsb3Blciwgb3IgZGV0ZXJlbWluZWQgYnkgdGhlIGV4dGVuc2lvbi4KCSAqIEByZXR1cm4ge0hUTUxJbWFnZUVsZW1lbnR8SFRNTEF1ZGlvRWxlbWVudHxIVE1MU2NyaXB0RWxlbWVudHxIVE1MTGlua0VsZW1lbnR8T2JqZWN0fSBUaGUgdGFnIHRoYXQgaXMgY3JlYXRlZC4KCSAqIE5vdGUgdGhhdCB0YWdzIGFyZSBub3QgYXBwZW5kZWQgdG8gdGhlIEhUTUwgYm9keS4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NyZWF0ZVRhZyA9IGZ1bmN0aW9uKGl0ZW0pIHsKCQl2YXIgdGFnID0gbnVsbDsKCQlzd2l0Y2ggKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5JTUFHRToKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwoJCQkJaWYgKHRoaXMuX2Nyb3NzT3JpZ2luICE9ICIiICYmICF0aGlzLl9pc0xvY2FsKGl0ZW0pKSB7IHRhZy5jcm9zc09yaWdpbiA9IHRoaXMuX2Nyb3NzT3JpZ2luOyB9CgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TT1VORDoKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImF1ZGlvIik7CgkJCQl0YWcuYXV0b3BsYXkgPSBmYWxzZTsKCQkJCS8vIE5vdGU6IFRoZSB0eXBlIHByb3BlcnR5IGRvZXNuJ3Qgc2VlbSBuZWNlc3NhcnkuCgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1Q6CgkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJCXRhZy50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CgkJCQlyZXR1cm4gdGFnOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQlpZiAodGhpcy51c2VYSFIpIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaW5rIik7CgkJCQl9CgkJCQl0YWcucmVsICA9ICJzdHlsZXNoZWV0IjsKCQkJCXRhZy50eXBlID0gInRleHQvY3NzIjsKCQkJCXJldHVybiB0YWc7CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJCWlmICh0aGlzLnVzZVhIUikgewoJCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN2ZyIpOwoJCQkJfSBlbHNlIHsKCQkJCQl0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvYmplY3QiKTsKCQkJCQl0YWcudHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKCQkJCX0KCQkJCXJldHVybiB0YWc7CgkJfQoJCXJldHVybiBudWxsOwoJfTsKCgkvKioKCSAqIERldGVybWluZSB0aGUgdHlwZSBvZiB0aGUgb2JqZWN0IHVzaW5nIGNvbW1vbiBleHRlbnNpb25zLiBOb3RlIHRoYXQgdGhlIHR5cGUgY2FuIGJlIHBhc3NlZCBpbiB3aXRoIHRoZSBsb2FkIGl0ZW0KCSAqIGlmIGl0IGlzIGFuIHVudXN1YWwgZXh0ZW5zaW9uLgoJICogQHBhcmFtIHtTdHJpbmd9IGV4dGVuc2lvbiBUaGUgZmlsZSBleHRlbnNpb24gdG8gdXNlIHRvIGRldGVybWluZSB0aGUgbG9hZCB0eXBlLgoJICogQHJldHVybiB7U3RyaW5nfSBUaGUgZGV0ZXJtaW5lZCBsb2FkIHR5cGUgKGZvciBleGFtcGxlLCA8Y29kZT5Mb2FkUXVldWUuSU1BR0U8L2NvZGU+IG9yIG51bGwgaWYgaXQgY2FuIG5vdCBiZQoJICogZGV0ZXJtaW5lZCBieSB0aGUgZXh0ZW5zaW9uLgoJICogQHByaXZhdGUKCSAqLwoJcC5fZ2V0VHlwZUJ5RXh0ZW5zaW9uID0gZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CgkJaWYgKGV4dGVuc2lvbiA9PSBudWxsKSB7CgkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDsKCQl9CgkJc3dpdGNoIChleHRlbnNpb24udG9Mb3dlckNhc2UoKSkgewoJCQljYXNlICJqcGVnIjoKCQkJY2FzZSAianBnIjoKCQkJY2FzZSAiZ2lmIjoKCQkJY2FzZSAicG5nIjoKCQkJY2FzZSAid2VicCI6CgkJCWNhc2UgImJtcCI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLklNQUdFOwoJCQljYXNlICJvZ2ciOgoJCQljYXNlICJtcDMiOgoJCQljYXNlICJ3YXYiOgoJCQkJcmV0dXJuIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TT1VORDsKCQkJY2FzZSAianNvbiI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLkpTT047CgkJCWNhc2UgInhtbCI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDsKCQkJY2FzZSAiY3NzIjoKCQkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTOwoJCQljYXNlICJqcyI6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLkpBVkFTQ1JJUFQ7CgkJCWNhc2UgJ3N2Zyc6CgkJCQlyZXR1cm4gY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBjcmVhdGVqcy5Mb2FkUXVldWUuVEVYVDsKCQl9Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlcHJvZ3Jlc3MgZXZlbnQgKGFuZCBvbkZpbGVQcm9ncmVzcyBjYWxsYmFjaykuIFBsZWFzZSBzZWUgdGhlIDxjb2RlPkxvYWRRdWV1ZS5maWxlcHJvZ3Jlc3M8L2NvZGU+CgkgKiBldmVudCBmb3IgZGV0YWlscyBvbiB0aGUgZXZlbnQgcGF5bG9hZC4KCSAqIEBtZXRob2QgX3NlbmRGaWxlUHJvZ3Jlc3MKCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSBpdGVtIHRoYXQgaXMgYmVpbmcgbG9hZGVkLgoJICogQHBhcmFtIHtOdW1iZXJ9IHByb2dyZXNzIFRoZSBhbW91bnQgdGhlIGl0ZW0gaGFzIGJlZW4gbG9hZGVkIChiZXR3ZWVuIDAgYW5kIDEpLgoJICogQHByb3RlY3RlZAoJICovCglwLl9zZW5kRmlsZVByb2dyZXNzID0gZnVuY3Rpb24oaXRlbSwgcHJvZ3Jlc3MpIHsKCQlpZiAodGhpcy5faXNDYW5jZWxlZCgpKSB7CgkJCXRoaXMuX2NsZWFuVXAoKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIXRoaXMuaGFzRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIikpIHsgcmV0dXJuOyB9CgoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZmlsZXByb2dyZXNzIik7CgkJZXZlbnQucHJvZ3Jlc3MgPSBwcm9ncmVzczsKCQlldmVudC5sb2FkZWQgPSBwcm9ncmVzczsKCQlldmVudC50b3RhbCA9IDE7CgkJZXZlbnQuaXRlbSA9IGl0ZW07CgoJCXRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlbG9hZCBldmVudC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZWxvYWQ6ZXZlbnQifX17ey9jcm9zc0xpbmt9fSBldmVudCBmb3IKCSAqIGRldGFpbHMgb24gdGhlIGV2ZW50IHBheWxvYWQuCgkgKiBAbWV0aG9kIF9zZW5kRmlsZUNvbXBsZXRlCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBUaGUgaXRlbSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4KCSAqIEBwYXJhbSB7VGFnTG9hZGVyIHwgWEhSTG9hZGVyfSBsb2FkZXIKCSAqIEBwcm90ZWN0ZWQKCSAqLwoJcC5fc2VuZEZpbGVDb21wbGV0ZSA9IGZ1bmN0aW9uKGl0ZW0sIGxvYWRlcikgewoJCWlmICh0aGlzLl9pc0NhbmNlbGVkKCkpIHsgcmV0dXJuOyB9CgoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZmlsZWxvYWQiKTsKCQlldmVudC5sb2FkZXIgPSBsb2FkZXI7CgkJZXZlbnQuaXRlbSA9IGl0ZW07CgkJZXZlbnQucmVzdWx0ID0gdGhpcy5fbG9hZGVkUmVzdWx0c1tpdGVtLmlkXTsKCQlldmVudC5yYXdSZXN1bHQgPSB0aGlzLl9sb2FkZWRSYXdSZXN1bHRzW2l0ZW0uaWRdOwoKICAgICAgICAvLyBUaGlzIGNhbGxzIGEgaGFuZGxlciBzcGVjaWZpZWQgb24gdGhlIGFjdHVhbCBsb2FkIGl0ZW0uIEN1cnJlbnRseSwgdGhlIFNvdW5kSlMgcGx1Z2luIHVzZXMgdGhpcy4KICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZUhhbmRsZXIpIHsKICAgICAgICAgICAgaXRlbS5jb21wbGV0ZUhhbmRsZXIoZXZlbnQpOwogICAgICAgIH0KCgkJdGhpcy5oYXNFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIpICYmIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogRGlzcGF0Y2ggYSBmaWxlc3RhcnQgZXZlbnQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgZmlsZSBzdGFydHMgdG8gbG9hZC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvZmlsZXN0YXJ0OmV2ZW50In19e3svY3Jvc3NMaW5rfX0KCSAqIGV2ZW50IGZvciBkZXRhaWxzIG9uIHRoZSBldmVudCBwYXlsb2FkLgoJICogQG1ldGhvZCBfc2VuZEZpbGVTdGFydAoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdGhhdCBpcyBiZWluZyBsb2FkZWQuCgkgKiBAcHJvdGVjdGVkCgkgKi8KCXAuX3NlbmRGaWxlU3RhcnQgPSBmdW5jdGlvbihpdGVtKSB7CgkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJmaWxlc3RhcnQiKTsKCQlldmVudC5pdGVtID0gaXRlbTsKCQl0aGlzLmhhc0V2ZW50TGlzdGVuZXIoImZpbGVzdGFydCIpICYmIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7Cgl9OwoKCS8qKgoJICogUkVNT1ZFRC4gIFVzZSBjcmVhdGVqcy5wcm94eSBpbnN0ZWFkCgkgKiBAbWV0aG9kIHByb3h5CgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGZ1bmN0aW9uIHRvIGNhbGwKCSAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBUaGUgc2NvcGUgdG8gY2FsbCB0aGUgbWV0aG9kIG5hbWUgb24KCSAqIEBzdGF0aWMKCSAqIEBwcml2YXRlCgkgKiBAZGVwcmVjYXRlZCBJbiBmYXZvdXIgb2YgdGhlIGNyZWF0ZWpzLnByb3h5IG1ldGhvZCAoc2VlIExvYWRRdWV1ZSBzb3VyY2UpLgoJICovCgoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBMb2FkUXVldWVdIjsKCX07CgoJY3JlYXRlanMuTG9hZFF1ZXVlID0gTG9hZFF1ZXVlOwoKCi8vIEhlbHBlciBtZXRob2RzCgoJLy8gQW4gYWRkaXRpb25hbCBtb2R1bGUgdG8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJyb3dzZXIsIHZlcnNpb24sIG9wZXJhdGluZyBzeXN0ZW0sIGFuZCBvdGhlciBlbnZpcm9ubWVudGFsIHZhcmlhYmxlcy4KCXZhciBCcm93c2VyRGV0ZWN0ID0gZnVuY3Rpb24oKSB7fQoKCUJyb3dzZXJEZXRlY3QuaW5pdCA9IGZ1bmN0aW9uKCkgewoJCXZhciBhZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CgkJQnJvd3NlckRldGVjdC5pc0ZpcmVmb3ggPSAoYWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpOwoJCUJyb3dzZXJEZXRlY3QuaXNPcGVyYSA9ICh3aW5kb3cub3BlcmEgIT0gbnVsbCk7CgkJQnJvd3NlckRldGVjdC5pc0Nocm9tZSA9IChhZ2VudC5pbmRleE9mKCJDaHJvbWUiKSA+IC0xKTsKCQlCcm93c2VyRGV0ZWN0LmlzSU9TID0gYWdlbnQuaW5kZXhPZigiaVBvZCIpID4gLTEgfHwgYWdlbnQuaW5kZXhPZigiaVBob25lIikgPiAtMSB8fCBhZ2VudC5pbmRleE9mKCJpUGFkIikgPiAtMTsKCX07CgoJQnJvd3NlckRldGVjdC5pbml0KCk7CgoJY3JlYXRlanMuTG9hZFF1ZXVlLkJyb3dzZXJEZXRlY3QgPSBCcm93c2VyRGV0ZWN0OwoKfSgpKTsKLyoKKiBUYWdMb2FkZXIKKiBWaXNpdCBodHRwOi8vY3JlYXRlanMuY29tLyBmb3IgZG9jdW1lbnRhdGlvbiwgdXBkYXRlcyBhbmQgZXhhbXBsZXMuCioKKgoqIENvcHlyaWdodCAoYykgMjAxMiBnc2tpbm5lci5jb20sIGluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiogb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiogcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiogY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKKiBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwoqIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAoqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKKiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgovKioKICogQG1vZHVsZSBQcmVsb2FkSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzfHx7fTsKCihmdW5jdGlvbigpIHsKCSJ1c2Ugc3RyaWN0IjsKCS8qKgoJICogQSBwcmVsb2FkZXIgdGhhdCBsb2FkcyBpdGVtcyB1c2luZyBhIHRhZy1iYXNlZCBhcHByb2FjaC4gSFRNTCBhdWRpbyBhbmQgaW1hZ2VzIGNhbiB1c2UgdGhpcyBsb2FkZXIgdG8gbG9hZAoJICogY29udGVudCBjcm9zcy1kb21haW4gd2l0aG91dCBzZWN1cml0eSBlcnJvcnMsIHdoZXJlYXMgYW55dGhpbmcgbG9hZGVkIHdpdGggWEhSIGhhcyBwb3RlbnRpYWwgaXNzdWVzIHdpdGggY3Jvc3MtCgkgKiBkb21haW4gcmVxdWVzdHMuCgkgKgoJICogTm90ZSBmb3IgYXVkaW8gdGFncywgVGFnTG9hZGVyIHJlbGllcyBvbiB0aGUgPGNvZGU+Y2FuUGxheVRocm91Z2g8L2NvZGU+IGV2ZW50LCB3aGljaCBmaXJlcyB3aGVuIHRoZSBidWZmZXIKCSAqIGlzIGZ1bGwgZW5vdWdoIHRvIHBsYXkgdGhlIGF1ZGlvIGFsbCB0aGUgd2F5IHRocm91Z2ggYXQgdGhlIGN1cnJlbnQgZG93bmxvYWQgc3BlZWQuIFRoaXMgY29tcGxldGVseSBwcmVsb2FkcyBtb3N0CgkgKiBzb3VuZCBlZmZlY3RzLCBob3dldmVyIGxvbmdlciB0cmFja3MgbGlrZSBiYWNrZ3JvdW5kIGF1ZGlvIHdpbGwgb25seSBsb2FkIGEgcG9ydGlvbiBiZWZvcmUgdGhlIGV2ZW50IGlzIGZpcmVkLgoJICogTW9zdCBicm93c2VycyAoYWxsIGV4Y2x1ZGluZyBDaHJvbWUpIHdpbGwgY29udGludWUgdG8gcHJlbG9hZCBvbmNlIHRoaXMgaXMgZmlyZWQsIHNvIHRoaXMgaXMgY29uc2lkZXJlZCBnb29kCgkgKiBlbm91Z2ggZm9yIG1vc3QgY2FzZXMuCgkgKiBAY2xhc3MgVGFnTG9hZGVyCgkgKiBAY29uc3RydWN0b3IKCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSBUaGUgaXRlbSB0byBsb2FkLiBQbGVhc2Ugc2VlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL2xvYWRGaWxlIn19e3svY3Jvc3NMaW5rfX0gZm9yCgkgKiBpbmZvcm1hdGlvbiBvbiBsb2FkIGl0ZW1zLgoJICovCgl2YXIgVGFnTG9hZGVyID0gZnVuY3Rpb24gKGl0ZW0pIHsKCQl0aGlzLmluaXQoaXRlbSk7Cgl9OwoKCXZhciBwID0gVGFnTG9hZGVyLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5BYnN0cmFjdExvYWRlcigpOwoJVGFnTG9hZGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhZ0xvYWRlcjsKCi8vIFByb3RlY3RlZAoKCS8qKgoJICogVGhlIHRpbWVvdXQgdGhhdCBpcyBmaXJlZCBpZiBub3RoaW5nIGlzIGxvYWRlZCBhZnRlciBhIGNlcnRhaW4gZGVsYXkuIFNlZSB0aGUgPGNvZGU+TG9hZFF1ZXVlLkxPQURfVElNRU9VVDwvY29kZT4KCSAqIGZvciB0aGUgdGltZW91dCBkdXJhdGlvbi4KCSAqIEBwcm9wZXJ0eSBfbG9hZFRpbWVvdXQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9sb2FkVGltZW91dCA9IG51bGw7CgoJLyoqCgkgKiBBIHJlZmVyZW5jZSB0byBhIGJvdW5kIGZ1bmN0aW9uLCB3aGljaCB3ZSBuZWVkIGluIG9yZGVyIHRvIHByb3Blcmx5IHJlbW92ZSB0aGUgZXZlbnQgaGFuZGxlciB3aGVuIHRoZSBsb2FkCgkgKiBjb21wbGV0ZXMuCgkgKiBAcHJvcGVydHkgX3RhZ0NvbXBsZXRlUHJveHkKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3RhZ0NvbXBsZXRlUHJveHkgPSBudWxsOwoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiB0aGUgbG9hZCBpdGVtIGlzIGFuIGF1ZGlvIHRhZywgc2luY2Ugd2UgdGFrZSBzb21lIHNwZWNpZmljIGFwcHJvYWNoZXMgdG8gcHJvcGVybHkgbG9hZCBhdWRpby4KCSAqIEBwcm9wZXJ0eSBfaXNBdWRpbwoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAZGVmYXVsdCBmYWxzZQoJICogQHByb3RlY3RlZAoJICovCglwLl9pc0F1ZGlvID0gZmFsc2U7CgoJLyoqCgkgKiBUaGUgSFRNTCB0YWcgb3IgSmF2YVNjcmlwdCBvYmplY3QgdGhpcyBsb2FkZXIgdXNlcyB0byBwcmVsb2FkIGNvbnRlbnQuIE5vdGUgdGhhdCBhIHRhZyBtYXkgYmUgYSBjdXN0b20gb2JqZWN0CgkgKiB0aGF0IG1hdGNoZXMgdGhlIEFQSSBvZiBhbiBIVE1MIHRhZyAobG9hZCBtZXRob2QsIG9ubG9hZCBjYWxsYmFjaykuIEZvciBleGFtcGxlLCBmbGFzaCBhdWRpbyBmcm9tIFNvdW5kSlMgcGFzc2VzCgkgKiBpbiBhIGN1c3RvbSBvYmplY3QgdG8gaGFuZGxlIHByZWxvYWRpbmcgZm9yIEZsYXNoIGF1ZGlvIGFuZCBXZWJBdWRpby4KCSAqIEBwcm9wZXJ0eSBfdGFnCgkgKiBAdHlwZSB7SFRNTEF1ZGlvRWxlbWVudCB8IE9iamVjdH0KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3RhZyA9IG51bGw7CgoJLyoqCgkgKiBXaGVuIGxvYWRpbmcgYSBKU09OUCByZXF1ZXN0IHRoaXMgd2lsbCBiZSB0aGUgcGFyc2VkIEpTT04gcmVzdWx0LgoJICoKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9qc29uUmVzdWx0ID0gbnVsbDsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbiAoaXRlbSkgewoJCXRoaXMuX2l0ZW0gPSBpdGVtOwoJCXRoaXMuX3RhZyA9IGl0ZW0udGFnOwoJCXRoaXMuX2lzQXVkaW8gPSAod2luZG93LkhUTUxBdWRpb0VsZW1lbnQgJiYgaXRlbS50YWcgaW5zdGFuY2VvZiB3aW5kb3cuSFRNTEF1ZGlvRWxlbWVudCk7CgkJdGhpcy5fdGFnQ29tcGxldGVQcm94eSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsIHRoaXMpOwoJfTsKCgkvKioKCSAqIEdldCB0aGUgbG9hZGVkIGNvbnRlbnQuIFRoaXMgaXMgdXN1YWxseSBhbiBIVE1MIHRhZyBvciBvdGhlciB0YWctc3R5bGUgb2JqZWN0IHRoYXQgaGFzIGJlZW4gZnVsbHkgbG9hZGVkLiBJZiB0aGUKCSAqIGxvYWRlciBpcyBub3QgY29tcGxldGUsIHRoaXMgd2lsbCBiZSBudWxsLgoJICogQG1ldGhvZCBnZXRSZXN1bHQKCSAqIEByZXR1cm4ge0hUTUxJbWFnZUVsZW1lbnQgfCBIVE1MQXVkaW9FbGVtZW50IHwgT2JqZWN0fSBUaGUgbG9hZGVkIGFuZCBwYXJzZWQgY29udGVudC4KCSAqLwoJcC5nZXRSZXN1bHQgPSBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5faXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUCB8fCB0aGlzLl9pdGVtLnR5cGUgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUKSB7CgkJCXJldHVybiB0aGlzLl9qc29uUmVzdWx0OwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLl90YWc7CgkJfQoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuY2FuY2VsZWQgPSB0cnVlOwoJCXRoaXMuX2NsZWFuKCk7Cgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtID0gdGhpcy5faXRlbTsKCQl2YXIgdGFnID0gdGhpcy5fdGFnOwoKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOyAvLyBDbGVhciBvdXQgYW55IGV4aXN0aW5nIHRpbWVvdXQKCQl2YXIgZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUuTE9BRF9USU1FT1VUOwoJCWlmIChkdXJhdGlvbiA9PSAwKSB7IGR1cmF0aW9uID0gY3JlYXRlanMuTG9hZFF1ZXVlLmxvYWRUaW1lb3V0OyB9CgkJdGhpcy5fbG9hZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRpbWVvdXQsIHRoaXMpLCBkdXJhdGlvbik7CgoJCWlmICh0aGlzLl9pc0F1ZGlvKSB7CgkJCXRhZy5zcmMgPSBudWxsOyAvLyBVbnNldCB0aGUgc291cmNlIHNvIHdlIGNhbiBzZXQgdGhlIHByZWxvYWQgdHlwZSB0byAiYXV0byIgd2l0aG91dCBraWNraW5nIG9mZiBhIGxvYWQuIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgZm9yIGF1ZGlvIHRhZ3MgcGFzc2VkIGluIGJ5IHRoZSBkZXZlbG9wZXIuCgkJCXRhZy5wcmVsb2FkID0gImF1dG8iOwoJCX0KCgkJLy8gSGFuZGxlcnMgZm9yIGFsbCB0YWdzCgkJdGFnLm9uZXJyb3IgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVFcnJvciwgIHRoaXMpOwoJCS8vIE5vdGU6IFdlIG9ubHkgZ2V0IHByb2dyZXNzIGV2ZW50cyBpbiBDaHJvbWUsIGJ1dCBkbyBub3QgZnVsbHkgbG9hZCB0YWdzIGluIENocm9tZSBkdWUgdG8gaXRzIGJlaGF2aW91ciwgc28gd2UgaWdub3JlIHByb2dyZXNzLgoKCQlpZiAodGhpcy5faXNBdWRpbykgewoJCQl0YWcub25zdGFsbGVkID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlU3RhbGxlZCwgIHRoaXMpOwoJCQkvLyBUaGlzIHdpbGwgdGVsbCB1cyB3aGVuIGF1ZGlvIGlzIGJ1ZmZlcmVkIGVub3VnaCB0byBwbGF5IHRocm91Z2gsIGJ1dCBub3Qgd2hlbiBpdHMgbG9hZGVkLgoJCQkvLyBUaGUgdGFnIGRvZXNuJ3Qga2VlcCBsb2FkaW5nIGluIENocm9tZSBvbmNlIGVub3VnaCBoYXMgYnVmZmVyZWQsIGFuZCB3ZSBoYXZlIGRlY2lkZWQgdGhhdCBiZWhhdmlvdXIgaXMgc3VmZmljaWVudC4KCQkJdGFnLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXl0aHJvdWdoIiwgdGhpcy5fdGFnQ29tcGxldGVQcm94eSwgZmFsc2UpOyAvLyBjYW5wbGF5dGhyb3VnaCBjYWxsYmFjayBkb2Vzbid0IHdvcmsgaW4gQ2hyb21lLCBzbyB3ZSB1c2UgYW4gZXZlbnQuCgkJfSBlbHNlIHsKCQkJdGFnLm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsICB0aGlzKTsKCQkJdGFnLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UsICB0aGlzKTsKCQl9CgoJCXZhciBzcmMgPSB0aGlzLmJ1aWxkUGF0aChpdGVtLnNyYywgaXRlbS52YWx1ZXMpOwoKCQkvLyBTZXQgdGhlIHNyYyBhZnRlciB0aGUgZXZlbnRzIGFyZSBhbGwgYWRkZWQuCgkJc3dpdGNoKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQl0YWcuaHJlZiA9IHNyYzsKCQkJCWJyZWFrOwoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkc6CgkJCQl0YWcuZGF0YSA9IHNyYzsKCQkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJdGFnLnNyYyA9IHNyYzsKCQl9CgoJCS8vIElmIHdlJ3JlIGxvYWRpbmcgSlNPTlAsIHdlIG5lZWQgdG8gYWRkIG91ciBjYWxsYmFjayBub3cuCgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAKCQkJCXx8IGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTgoJCQkJfHwgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQlpZiAoaXRlbS5jYWxsYmFjayA9PSBudWxsKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ2NhbGxiYWNrIGlzIHJlcXVpcmVkIGZvciBsb2FkaW5nIEpTT05QIHJlcXVlc3RzLicpOwoJCQl9CgoJCQlpZiAod2luZG93W2l0ZW0uY2FsbGJhY2tdICE9IG51bGwpIHsKCQkJCXRocm93IG5ldyBFcnJvcignSlNPTlAgY2FsbGJhY2sgIicgKyBpdGVtLmNhbGxiYWNrICsgJyIgYWxyZWFkeSBleGlzdHMgb24gd2luZG93LiBZb3UgbmVlZCB0byBzcGVjaWZ5IGEgZGlmZmVyZW50IGNhbGxiYWNrLiBPciByZS1uYW1lIHRoZSBjdXJyZW50IG9uZS4nKTsKCQkJfQoKCQkJd2luZG93W2l0ZW0uY2FsbGJhY2tdID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlSlNPTlBMb2FkLCB0aGlzKTsKCQl9CgoJCS8vIElmIGl0cyBTVkcsIGl0IG5lZWRzIHRvIGJlIG9uIHRoZSBET00gdG8gbG9hZCAod2UgcmVtb3ZlIGl0IGJlZm9yZSBzZW5kaW5nIGNvbXBsZXRlKS4KCQkvLyBJdCBpcyBpbXBvcnRhbnQgdGhhdCB0aGlzIGhhcHBlbnMgQUZURVIgc2V0dGluZyB0aGUgc3JjL2RhdGEuCgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuU1ZHIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAgfHwKCQkJaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuTUFOSUZFU1QgfHwKCQkJaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KQVZBU0NSSVBUIHx8CgkJCWl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTKSB7CgkJCQl0aGlzLl9zdGFydFRhZ1Zpc2liaWxpdHkgPSB0YWcuc3R5bGUudmlzaWJpbGl0eTsKCQkJCXRhZy5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CgkJCQl2YXIgbm9kZSA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCQkJCWlmIChub2RlID09IG51bGwpIHsKCQkJCQlpZiAoaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkcpIHsKCQkJCQkJdGhpcy5faGFuZGxlU1ZHRXJyb3IoKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW5vZGUgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIik7CgkJCQkJfQoJCQkJfQoJCQkJbm9kZS5hcHBlbmRDaGlsZCh0YWcpOwoJCX0KCgkJLy8gTm90ZTogUHJldmlvdXMgdmVyc2lvbnMgZGlkbid0IHNlZW0gdG8gd29yayB3aGVuIHdlIGNhbGxlZCBsb2FkKCkgZm9yIE9HRyB0YWdzIGluIEZpcmVmb3guIFNlZW1zIGZpeGVkIGluIDE1LjAuMQoJCWlmICh0YWcubG9hZCAhPSBudWxsKSB7CgkJCXRhZy5sb2FkKCk7CgkJfQoJfTsKCglwLl9oYW5kbGVTVkdFcnJvciA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2NsZWFuKCk7CgkJdmFyIGV2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCWV2ZW50LnRleHQgPSAiU1ZHX05PX0JPRFkiOwoJCXRoaXMuX3NlbmRFcnJvcihldmVudCk7Cgl9OwoKCXAuX2hhbmRsZUpTT05QTG9hZCA9IGZ1bmN0aW9uKGRhdGEpIHsKCQl0aGlzLl9qc29uUmVzdWx0ID0gZGF0YTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgYW4gYXVkaW8gdGltZW91dC4gTmV3ZXIgYnJvd3NlcnMgZ2V0IGEgY2FsbGJhY2sgZnJvbSB0aGUgdGFncywgYnV0IG9sZGVyIG9uZXMgbWF5IHJlcXVpcmUgYSBzZXRUaW1lb3V0CgkgKiB0byBoYW5kbGUgaXQuIFRoZSBzZXRUaW1lb3V0IGlzIGFsd2F5cyBydW5uaW5nIHVudGlsIGEgcmVzcG9uc2UgaXMgaGFuZGxlZCBieSB0aGUgYnJvd3Nlci4KCSAqIEBtZXRob2QgX2hhbmRsZVRpbWVvdXQKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVRpbWVvdXQgPSBmdW5jdGlvbigpIHsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQlldmVudC50ZXh0ID0gIlBSRUxPQURfVElNRU9VVCI7CgkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgYSBzdGFsbGVkIGF1ZGlvIGV2ZW50LiBUaGUgbWFpbiBwbGFjZSB3ZSBzZWVtIHRvIGdldCB0aGVzZSBpcyB3aXRoIEhUTUxBdWRpbyBpbiBDaHJvbWUgd2hlbiB3ZSB0cnkgYW5kCgkgKiBwbGF5YmFjayBhdWRpbyB0aGF0IGlzIGFscmVhZHkgaW4gYSBsb2FkLCBidXQgbm90IGNvbXBsZXRlLgoJICogQG1ldGhvZCBfaGFuZGxlU3RhbGxlZAoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlU3RhbGxlZCA9IGZ1bmN0aW9uKCkgewoJCS8vSWdub3JlLCBsZXQgdGhlIHRpbWVvdXQgdGFrZSBjYXJlIG9mIGl0LiBTb21ldGltZXMgaXRzIG5vdCByZWFsbHkgc3RvcHBlZC4KCX07CgoJLyoqCgkgKiBIYW5kbGUgYW4gZXJyb3IgZXZlbnQgZ2VuZXJhdGVkIGJ5IHRoZSB0YWcuCgkgKiBAbWV0aG9kIF9oYW5kbGVFcnJvcgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlRXJyb3IgPSBmdW5jdGlvbihldmVudCkgewoJCXRoaXMuX2NsZWFuKCk7CgoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkvL1RPRE86IFByb3BhZ2F0ZSBhY3R1YWwgZXZlbnQgZXJyb3I/CgkJdGhpcy5fc2VuZEVycm9yKG5ld0V2ZW50KTsKCX07CgoJLyoqCgkgKiBIYW5kbGUgdGhlIHJlYWR5U3RhdGVDaGFuZ2UgZXZlbnQgZnJvbSBhIHRhZy4gV2Ugc29tZXRpbWVzIG5lZWQgdGhpcyBpbiBwbGFjZSBvZiB0aGUgb25sb2FkIGV2ZW50IChtYWlubHkgU0NSSVBUCgkgKiBhbmQgTElOSyB0YWdzKSwgYnV0IG90aGVyIGNhc2VzIG1heSBleGlzdC4KCSAqIEBtZXRob2QgX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UKCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoJCS8vIFRoaXMgaXMgc3RyaWN0bHkgZm9yIHRhZ3MgaW4gYnJvd3NlcnMgdGhhdCBkbyBub3Qgc3VwcG9ydCBvbmxvYWQuCgkJdmFyIHRhZyA9IHRoaXMuZ2V0SXRlbSgpLnRhZzsKCgkJLy8gQ29tcGxldGUgaXMgZm9yIG9sZCBJRSBzdXBwb3J0LgoJCWlmICh0YWcucmVhZHlTdGF0ZSA9PSAibG9hZGVkIiB8fCB0YWcucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSB7CgkJCXRoaXMuX2hhbmRsZUxvYWQoKTsKCQl9Cgl9OwoKCS8qKgoJICogSGFuZGxlIGEgbG9hZCAoY29tcGxldGUpIGV2ZW50LiBUaGlzIGlzIGNhbGxlZCBieSB0YWcgY2FsbGJhY2tzLCBidXQgYWxzbyBieSByZWFkeVN0YXRlQ2hhbmdlIGFuZCBjYW5QbGF5VGhyb3VnaAoJICogZXZlbnRzLiBPbmNlIGxvYWRlZCwgdGhlIGl0ZW0gaXMgZGlzcGF0Y2hlZCB0byB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUifX17ey9jcm9zc0xpbmt9fS4KCSAqIEBtZXRob2QgX2hhbmRsZUxvYWQKCSAqIEBwYXJhbSB7T2JqZWN0fSBbZXZlbnRdIEEgbG9hZCBldmVudCBmcm9tIGEgdGFnLiBUaGlzIGlzIHNvbWV0aW1lcyBjYWxsZWQgZnJvbSBvdGhlciBoYW5kbGVycyB3aXRob3V0IGFuIGV2ZW50LgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlTG9hZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJaWYgKHRoaXMuX2lzQ2FuY2VsZWQoKSkgeyByZXR1cm47IH0KCgkJdmFyIGl0ZW0gPSB0aGlzLmdldEl0ZW0oKTsKCQl2YXIgdGFnID0gaXRlbS50YWc7CgoJCWlmICh0aGlzLmxvYWRlZCB8fCB0aGlzLl9pc0F1ZGlvICYmIHRhZy5yZWFkeVN0YXRlICE9PSA0KSB7IHJldHVybjsgfSAvL0xNOiBOb3Qgc3VyZSBpZiB3ZSBzdGlsbCBuZWVkIHRoZSBhdWRpbyBjaGVjay4KCQl0aGlzLmxvYWRlZCA9IHRydWU7CgoJCS8vIFJlbW92ZSBmcm9tIHRoZSBET00KCQlzd2l0Y2ggKGl0ZW0udHlwZSkgewoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5TVkc6CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT05QOiAvLyBOb3RlOiBSZW1vdmluZyBzY3JpcHQgdGFncyBpcyBhIGZvb2wncyBlcnJhbmQuCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQljYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQkvLyBjYXNlIGNyZWF0ZWpzLkxvYWRRdWV1ZS5DU1M6CgkJCQkvL0xNOiBXZSBtYXkgbmVlZCB0byByZW1vdmUgQ1NTIHRhZ3MgbG9hZGVkIHVzaW5nIGEgTElOSwoJCQkJdGFnLnN0eWxlLnZpc2liaWxpdHkgPSB0aGlzLl9zdGFydFRhZ1Zpc2liaWxpdHk7CgkJCQl0YWcucGFyZW50Tm9kZSAmJiB0YWcucGFyZW50Tm9kZS5jb250YWlucyh0YWcpICYmIHRhZy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhZyk7CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQl9CgoJCXRoaXMuX2NsZWFuKCk7CgkJdGhpcy5fc2VuZENvbXBsZXRlKCk7Cgl9OwoKCS8qKgoJICogQ2xlYW4gdXAgdGhlIGxvYWRlci4KCSAqIFRoaXMgc3RvcHMgYW55IHRpbWVycyBhbmQgcmVtb3ZlcyByZWZlcmVuY2VzIHRvIHByZXZlbnQgZXJyYW50IGNhbGxiYWNrcyBhbmQgY2xlYW4gdXAgbWVtb3J5LgoJICogQG1ldGhvZCBfY2xlYW4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2NsZWFuID0gZnVuY3Rpb24oKSB7CgkJY2xlYXJUaW1lb3V0KHRoaXMuX2xvYWRUaW1lb3V0KTsKCgkJLy8gRGVsZXRlIGhhbmRsZXJzLgoJCXZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCk7CgkJdmFyIHRhZyA9IGl0ZW0udGFnOwoJCWlmICh0YWcgIT0gbnVsbCkgewoJCQl0YWcub25sb2FkID0gbnVsbDsKCQkJdGFnLnJlbW92ZUV2ZW50TGlzdGVuZXIgJiYgdGFnLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNhbnBsYXl0aHJvdWdoIiwgdGhpcy5fdGFnQ29tcGxldGVQcm94eSwgZmFsc2UpOwoJCQl0YWcub25zdGFsbGVkID0gbnVsbDsKCQkJdGFnLm9ucHJvZ3Jlc3MgPSBudWxsOwoJCQl0YWcub25lcnJvciA9IG51bGw7CgoJCQkvL1RPRE86IFRlc3QgdGhpcwoJCQlpZiAodGFnLnBhcmVudE5vZGUgIT0gbnVsbAoJCQkJCSYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuU1ZHCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVAoJCQkJCSYmIGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuQ1NTCgkJCQkJJiYgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5KU09OUCkgewoJCQkJIC8vIE5vdGU6IFJlbW92aW5nIHNjcmlwdCB0YWdzIGlzIGEgZm9vbCdzIGVycmFuZC4KCQkJCXRhZy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhZyk7CgkJCX0KCQl9CgoJCXZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCk7CgkJaWYgKGl0ZW0udHlwZSA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuSlNPTlAKCQkJfHwgaXRlbS50eXBlID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5NQU5JRkVTVCkgewoJCQl3aW5kb3dbaXRlbS5jYWxsYmFja10gPSBudWxsOwoJCX0KCX07CgoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBUYWdMb2FkZXJdIjsKCX07CgoJY3JlYXRlanMuVGFnTG9hZGVyID0gVGFnTG9hZGVyOwoKfSgpKTsKLyoKICogWEhSTG9hZGVyCiAqIFZpc2l0IGh0dHA6Ly9jcmVhdGVqcy5jb20vIGZvciBkb2N1bWVudGF0aW9uLCB1cGRhdGVzIGFuZCBleGFtcGxlcy4KICoKICoKICogQ29weXJpZ2h0IChjKSAyMDEyIGdza2lubmVyLmNvbSwgaW5jLgogKgogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgogKiBvYnRhaW5pbmcgYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbgogKiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CiAqIHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAogKiBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKICogU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKICogY29uZGl0aW9uczoKICoKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKICogaW5jbHVkZWQgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAogKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKICogT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKICogTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKICogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiAqIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwogKiBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCiAqIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICovCgovKioKICogQG1vZHVsZSBQcmVsb2FkSlMKICovCgovLyBuYW1lc3BhY2U6CnRoaXMuY3JlYXRlanMgPSB0aGlzLmNyZWF0ZWpzIHx8IHt9OwoKKGZ1bmN0aW9uICgpIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEEgcHJlbG9hZGVyIHRoYXQgbG9hZHMgaXRlbXMgdXNpbmcgWEhSIHJlcXVlc3RzLCB1c3VhbGx5IFhNTEh0dHBSZXF1ZXN0LiBIb3dldmVyIFhEb21haW5SZXF1ZXN0cyB3aWxsIGJlIHVzZWQKCSAqIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgaWYgcG9zc2libGUsIGFuZCBvbGRlciB2ZXJzaW9ucyBvZiBJRSBmYWxsIGJhY2sgb24gdG8gQWN0aXZlWCBvYmplY3RzIHdoZW4gbmVjZXNzYXJ5LgoJICogWEhSIHJlcXVlc3RzIGxvYWQgdGhlIGNvbnRlbnQgYXMgdGV4dCBvciBiaW5hcnkgZGF0YSwgcHJvdmlkZSBwcm9ncmVzcyBhbmQgY29uc2lzdGVudCBjb21wbGV0aW9uIGV2ZW50cywgYW5kCgkgKiBjYW4gYmUgY2FuY2VsZWQgZHVyaW5nIGxvYWQuIE5vdGUgdGhhdCBYSFIgaXMgbm90IHN1cHBvcnRlZCBpbiBJRSA2IG9yIGVhcmxpZXIsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yCgkgKiBjcm9zcy1kb21haW4gbG9hZGluZy4KCSAqIEBjbGFzcyBYSFJMb2FkZXIKCSAqIEBjb25zdHJ1Y3RvcgoJICogQHBhcmFtIHtPYmplY3R9IGl0ZW0gVGhlIG9iamVjdCB0aGF0IGRlZmluZXMgdGhlIGZpbGUgdG8gbG9hZC4gUGxlYXNlIHNlZSB0aGUge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvbG9hZEZpbGUifX17ey9jcm9zc0xpbmt9fQoJICogZm9yIGFuIG92ZXJ2aWV3IG9mIHN1cHBvcnRlZCBmaWxlIHByb3BlcnRpZXMuCgkgKiBAcGFyYW0ge1N0cmluZ30gW2Nyb3NzT3JpZ2luXSBBbiBvcHRpb25hbCBmbGFnIHRvIHN1cHBvcnQgaW1hZ2VzIGxvYWRlZCBmcm9tIGEgQ09SUy1lbmFibGVkIHNlcnZlci4gUGxlYXNlIHNlZQoJICoge3sjY3Jvc3NMaW5rICJMb2FkUXVldWUvX2Nyb3NzT3JpZ2luOnByb3BlcnR5In19e3svY3Jvc3NMaW5rfX0gZm9yIG1vcmUgaW5mby4KCSAqIEBleHRlbmRzIEFic3RyYWN0TG9hZGVyCgkgKi8KCXZhciBYSFJMb2FkZXIgPSBmdW5jdGlvbiAoaXRlbSwgY3Jvc3NPcmlnaW4pIHsKCQl0aGlzLmluaXQoaXRlbSwgY3Jvc3NPcmlnaW4pOwoJfTsKCgl2YXIgcyA9IFhIUkxvYWRlcjsKCgkvKioKCSAqIEEgbGlzdCBvZiBYTUxIVFRQIG9iamVjdCBJRHMgdG8gdHJ5IHdoZW4gYnVpbGRpbmcgYW4gQWN0aXZlWCBvYmplY3QgZm9yIFhIUiByZXF1ZXN0cyBpbiBlYXJsaWVyIHZlcnNpb25zIG9mIElFLgoJICogQHByb3BlcnR5IEFDVElWRVhfVkVSU0lPTlMKCSAqIEB0eXBlIHtBcnJheX0KCSAqIEBzaW5jZSAwLjQuMgoJICogQHByaXZhdGUKCSAqLwoJcy5BQ1RJVkVYX1ZFUlNJT05TID0gWwoJCSJNc3htbDIuWE1MSFRUUC42LjAiLAoJCSJNc3htbDIuWE1MSFRUUC41LjAiLAoJCSJNc3htbDIuWE1MSFRUUC40LjAiLAoJCSJNU1hNTDIuWE1MSFRUUC4zLjAiLAoJCSJNU1hNTDIuWE1MSFRUUCIsCgkJIk1pY3Jvc29mdC5YTUxIVFRQIgoJXTsKCgl2YXIgcCA9IFhIUkxvYWRlci5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQWJzdHJhY3RMb2FkZXIoKTsKCVhIUkxvYWRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBYSFJMb2FkZXI7CgoJLy9Qcm90ZWN0ZWQKCS8qKgoJICogQSByZWZlcmVuY2UgdG8gdGhlIFhIUiByZXF1ZXN0IHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCSAqIEBwcm9wZXJ0eSBfcmVxdWVzdAoJICogQHR5cGUge1hNTEh0dHBSZXF1ZXN0IHwgWERvbWFpblJlcXVlc3QgfCBBY3RpdmVYLlhNTEhUVFB9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9yZXF1ZXN0ID0gbnVsbDsKCgkvKioKCSAqIEEgbWFudWFsIGxvYWQgdGltZW91dCB0aGF0IGlzIHVzZWQgZm9yIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgdGhlIG9uVGltZW91dCBldmVudCBvbiBYSFIgKFhIUiBsZXZlbCAxLAoJICogdHlwaWNhbGx5IElFOSkuCgkgKiBAcHJvcGVydHkgX2xvYWRUaW1lb3V0CgkgKiBAdHlwZSB7TnVtYmVyfQoJICogQHByaXZhdGUKCSAqLwoJcC5fbG9hZFRpbWVvdXQgPSBudWxsOwoKCS8qKgoJICogVGhlIGJyb3dzZXIncyBYSFIgKFhNTEhUVFBSZXF1ZXN0KSB2ZXJzaW9uLiBTdXBwb3J0ZWQgdmVyc2lvbnMgYXJlIDEgYW5kIDIuIFRoZXJlIGlzIG5vIG9mZmljaWFsIHdheSB0byBkZXRlY3QKCSAqIHRoZSB2ZXJzaW9uLCBzbyB3ZSB1c2UgY2FwYWJpbGl0aWVzIHRvIG1ha2UgYSBiZXN0IGd1ZXNzLgoJICogQHByb3BlcnR5IF94aHJMZXZlbAoJICogQHR5cGUge051bWJlcn0KCSAqIEBkZWZhdWx0IDEKCSAqIEBwcml2YXRlCgkgKi8KCXAuX3hockxldmVsID0gMTsKCgkvKioKCSAqIFRoZSByZXNwb25zZSBvZiBhIGxvYWRlZCBmaWxlLiBUaGlzIGlzIHNldCBiZWNhdXNlIGl0IGlzIGV4cGVuc2l2ZSB0byBsb29rIHVwIGNvbnN0YW50bHkuIFRoaXMgcHJvcGVydHkgd2lsbCBiZQoJICogbnVsbCB1bnRpbCB0aGUgZmlsZSBpcyBsb2FkZWQuCgkgKiBAcHJvcGVydHkgX3Jlc3BvbnNlCgkgKiBAdHlwZSB7bWl4ZWR9CgkgKiBAcHJpdmF0ZQoJICovCglwLl9yZXNwb25zZSA9IG51bGw7CgoJLyoqCgkgKiBUaGUgcmVzcG9uc2Ugb2YgdGhlIGxvYWRlZCBmaWxlIGJlZm9yZSBpdCBpcyBtb2RpZmllZC4gSW4gbW9zdCBjYXNlcywgY29udGVudCBpcyBjb252ZXJ0ZWQgZnJvbSByYXcgdGV4dCB0bwoJICogYW4gSFRNTCB0YWcgb3IgYSBmb3JtYXR0ZWQgb2JqZWN0IHdoaWNoIGlzIHNldCB0byB0aGUgPGNvZGU+cmVzdWx0PC9jb2RlPiBwcm9wZXJ0eSwgYnV0IHRoZSBkZXZlbG9wZXIgbWF5IHN0aWxsCgkgKiB3YW50IHRvIGFjY2VzcyB0aGUgcmF3IGNvbnRlbnQgYXMgaXQgd2FzIGxvYWRlZC4KCSAqIEBwcm9wZXJ0eSBfcmF3UmVzcG9uc2UKCSAqIEB0eXBlIHtTdHJpbmd8T2JqZWN0fQoJICogQHByaXZhdGUKCSAqLwoJcC5fcmF3UmVzcG9uc2UgPSBudWxsOwoKCS8qKgoJICogU2VlIHt7I2Nyb3NzTGluayAiTG9hZFF1ZXVlL19jcm9zc09yaWdpbjpwcm9wZXJ0eSJ9fXt7L2Nyb3NzTGlua319CgkgKiBAcHJvcGVydHkgX2Nyb3NzT3JpZ2luCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQGRlZmF1bHRWYWx1ZSAiIgoJICogQHByaXZhdGUKCSAqLwoJcC5fY3Jvc3NPcmlnaW4gPSAiIjsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmluaXQgPSBmdW5jdGlvbiAoaXRlbSwgY3Jvc3NPcmlnaW4pIHsKCQl0aGlzLl9pdGVtID0gaXRlbTsKCQl0aGlzLl9jcm9zc09yaWdpbiA9IGNyb3NzT3JpZ2luOwoJCWlmICghdGhpcy5fY3JlYXRlWEhSKGl0ZW0pKSB7CgkJCS8vVE9ETzogVGhyb3cgZXJyb3I/CgkJfQoJfTsKCgkvKioKCSAqIExvb2sgdXAgdGhlIGxvYWRlZCByZXN1bHQuCgkgKiBAbWV0aG9kIGdldFJlc3VsdAoJICogQHBhcmFtIHtCb29sZWFufSBbcmF3UmVzdWx0PWZhbHNlXSBSZXR1cm4gYSByYXcgcmVzdWx0IGluc3RlYWQgb2YgYSBmb3JtYXR0ZWQgcmVzdWx0LiBUaGlzIGFwcGxpZXMgdG8gY29udGVudAoJICogbG9hZGVkIHZpYSBYSFIgc3VjaCBhcyBzY3JpcHRzLCBYTUwsIENTUywgYW5kIEltYWdlcy4gSWYgdGhlcmUgaXMgbm8gcmF3IHJlc3VsdCwgdGhlIGZvcm1hdHRlZCByZXN1bHQgd2lsbCBiZQoJICogcmV0dXJuZWQgaW5zdGVhZC4KCSAqIEByZXR1cm4ge09iamVjdH0gQSByZXN1bHQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbnRlbnQgdGhhdCB3YXMgbG9hZGVkLCBzdWNoIGFzOgoJICogPHVsPgoJICogICAgICA8bGk+QW4gaW1hZ2UgdGFnICgmbHQ7aW1hZ2UgLyZndDspIGZvciBpbWFnZXM8L2xpPgoJICogICAgICA8bGk+QSBzY3JpcHQgdGFnIGZvciBKYXZhU2NyaXB0ICgmbHQ7c2NyaXB0IC8mZ3Q7KS4gTm90ZSB0aGF0IHNjcmlwdHMgbG9hZGVkIHdpdGggdGFncyBtYXkgYmUgYWRkZWQgdG8gdGhlCgkgKiAgICAgIEhUTUwgaGVhZC48L2xpPgoJICogICAgICA8bGk+QSBzdHlsZSB0YWcgZm9yIENTUyAoJmx0O3N0eWxlIC8mZ3Q7KTwvbGk+CgkgKiAgICAgIDxsaT5SYXcgdGV4dCBmb3IgVEVYVDwvbGk+CgkgKiAgICAgIDxsaT5BIGZvcm1hdHRlZCBKYXZhU2NyaXB0IG9iamVjdCBkZWZpbmVkIGJ5IEpTT048L2xpPgoJICogICAgICA8bGk+QW4gWE1MIGRvY3VtZW50PC9saT4KCSAqICAgICAgPGxpPkFuIGJpbmFyeSBhcnJheWJ1ZmZlciBsb2FkZWQgYnkgWEhSPC9saT4KCSAqIDwvdWw+CgkgKiBOb3RlIHRoYXQgaWYgYSByYXcgcmVzdWx0IGlzIHJlcXVlc3RlZCwgYnV0IG5vdCBmb3VuZCwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGluc3RlYWQuCgkgKi8KCXAuZ2V0UmVzdWx0ID0gZnVuY3Rpb24gKHJhd1Jlc3VsdCkgewoJCWlmIChyYXdSZXN1bHQgJiYgdGhpcy5fcmF3UmVzcG9uc2UpIHsKCQkJcmV0dXJuIHRoaXMuX3Jhd1Jlc3BvbnNlOwoJCX0KCQlyZXR1cm4gdGhpcy5fcmVzcG9uc2U7Cgl9OwoKCS8vIE92ZXJyaWRlcyBhYnN0cmFjdCBtZXRob2QgaW4gQWJzdHJhY3RMb2FkZXIKCXAuY2FuY2VsID0gZnVuY3Rpb24gKCkgewoJCXRoaXMuY2FuY2VsZWQgPSB0cnVlOwoJCXRoaXMuX2NsZWFuKCk7CgkJdGhpcy5fcmVxdWVzdC5hYm9ydCgpOwoJfTsKCgkvLyBPdmVycmlkZXMgYWJzdHJhY3QgbWV0aG9kIGluIEFic3RyYWN0TG9hZGVyCglwLmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKHRoaXMuX3JlcXVlc3QgPT0gbnVsbCkgewoJCQl0aGlzLl9oYW5kbGVFcnJvcigpOwoJCQlyZXR1cm47CgkJfQoKCQkvL0V2ZW50cwoJCXRoaXMuX3JlcXVlc3Qub25sb2Fkc3RhcnQgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVMb2FkU3RhcnQsIHRoaXMpOwoJCXRoaXMuX3JlcXVlc3Qub25wcm9ncmVzcyA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVByb2dyZXNzLCB0aGlzKTsKCQl0aGlzLl9yZXF1ZXN0Lm9uYWJvcnQgPSBjcmVhdGVqcy5wcm94eSh0aGlzLl9oYW5kbGVBYm9ydCwgdGhpcyk7CgkJdGhpcy5fcmVxdWVzdC5vbmVycm9yID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlRXJyb3IsIHRoaXMpOwoJCXRoaXMuX3JlcXVlc3Qub250aW1lb3V0ID0gY3JlYXRlanMucHJveHkodGhpcy5faGFuZGxlVGltZW91dCwgdGhpcyk7CgkJLy8gU2V0IHVwIGEgdGltZW91dCBpZiB3ZSBkb24ndCBoYXZlIFhIUjIKCQlpZiAodGhpcy5feGhyTGV2ZWwgPT0gMSkgewoJCQl2YXIgZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUuTE9BRF9USU1FT1VUOwoJCQlpZiAoZHVyYXRpb24gPT0gMCkgewoJCQkJZHVyYXRpb24gPSBjcmVhdGVqcy5Mb2FkUXVldWUubG9hZFRpbWVvdXQ7CgkJCX0gZWxzZSB7CgkJCQl0cnkgeyBjb25zb2xlLndhcm4oIkxvYWRRdWV1ZS5MT0FEX1RJTUVPVVQgaGFzIGJlZW4gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBMb2FkUXVldWUubG9hZFRpbWVvdXQiKTt9IGNhdGNoKGUpIHt9CgkJCX0KCQkJdGhpcy5fbG9hZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRpbWVvdXQsIHRoaXMpLCBkdXJhdGlvbik7CgkJfQoKCQkvLyBOb3RlOiBXZSBkb24ndCBnZXQgb25sb2FkIGluIGFsbCBicm93c2VycyAoZWFybGllciBGRiBhbmQgSUUpLiBvblJlYWR5U3RhdGVDaGFuZ2UgaGFuZGxlcyB0aGVzZS4KCQl0aGlzLl9yZXF1ZXN0Lm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZUxvYWQsIHRoaXMpOwoKCQl0aGlzLl9yZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVJlYWR5U3RhdGVDaGFuZ2UsIHRoaXMpOwoKCQkvLyBTb21ldGltZXMgd2UgZ2V0IGJhY2sgNDA0cyBpbW1lZGlhdGVseSwgcGFydGljdWxhcmx5IHdoZW4gdGhlcmUgaXMgYSBjcm9zcyBvcmlnaW4gcmVxdWVzdC4gIC8vIG5vdGUgdGhpcyBkb2VzIG5vdCBjYXRjaCBpbiBDaHJvbWUKCQl0cnkgewoJCQlpZiAoIXRoaXMuX2l0ZW0udmFsdWVzIHx8IHRoaXMuX2l0ZW0ubWV0aG9kID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5HRVQpIHsKCQkJCXRoaXMuX3JlcXVlc3Quc2VuZCgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuX2l0ZW0ubWV0aG9kID09IGNyZWF0ZWpzLkxvYWRRdWV1ZS5QT1NUKSB7CgkJCQl0aGlzLl9yZXF1ZXN0LnNlbmQodGhpcy5fZm9ybWF0UXVlcnlTdHJpbmcodGhpcy5faXRlbS52YWx1ZXMpKTsKCQkJfQoJCX0gY2F0Y2ggKGVycm9yKSB7CgkJCXZhciBldmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQkJZXZlbnQuZXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCQl9Cgl9OwoKCS8qKgoJICogR2V0IGFsbCB0aGUgcmVzcG9uc2UgaGVhZGVycyBmcm9tIHRoZSBYbWxIdHRwUmVxdWVzdC4KCSAqCgkgKiA8c3Ryb25nPkZyb20gdGhlIGRvY3M6PC9zdHJvbmc+IFJldHVybiBhbGwgdGhlIEhUVFAgaGVhZGVycywgZXhjbHVkaW5nIGhlYWRlcnMgdGhhdCBhcmUgYSBjYXNlLWluc2Vuc2l0aXZlIG1hdGNoCgkgKiBmb3IgU2V0LUNvb2tpZSBvciBTZXQtQ29va2llMiwgYXMgYSBzaW5nbGUgc3RyaW5nLCB3aXRoIGVhY2ggaGVhZGVyIGxpbmUgc2VwYXJhdGVkIGJ5IGEgVSswMDBEIENSIFUrMDAwQSBMRiBwYWlyLAoJICogZXhjbHVkaW5nIHRoZSBzdGF0dXMgbGluZSwgYW5kIHdpdGggZWFjaCBoZWFkZXIgbmFtZSBhbmQgaGVhZGVyIHZhbHVlIHNlcGFyYXRlZCBieSBhIFUrMDAzQSBDT0xPTiBVKzAwMjAgU1BBQ0UKCSAqIHBhaXIuCgkgKiBAbWV0aG9kIGdldEFsbFJlc3BvbnNlSGVhZGVycwoJICogQHJldHVybiB7U3RyaW5nfQoJICogQHNpbmNlIDAuNC4xCgkgKi8KCXAuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzID0gZnVuY3Rpb24gKCkgewoJCWlmICAodGhpcy5fcmVxdWVzdC5nZXRBbGxSZXNwb25zZUhlYWRlcnMgaW5zdGFuY2VvZiBGdW5jdGlvbikgewoJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoKCS8qKgoJICogR2V0IGEgc3BlY2lmaWMgcmVzcG9uc2UgaGVhZGVyIGZyb20gdGhlIFhtbEh0dHBSZXF1ZXN0LgoJICoKCSAqIDxzdHJvbmc+RnJvbSB0aGUgZG9jczo8L3N0cm9uZz4gUmV0dXJucyB0aGUgaGVhZGVyIGZpZWxkIHZhbHVlIGZyb20gdGhlIHJlc3BvbnNlIG9mIHdoaWNoIHRoZSBmaWVsZCBuYW1lIG1hdGNoZXMKCSAqIGhlYWRlciwgdW5sZXNzIHRoZSBmaWVsZCBuYW1lIGlzIFNldC1Db29raWUgb3IgU2V0LUNvb2tpZTIuCgkgKiBAbWV0aG9kIGdldFJlc3BvbnNlSGVhZGVyCgkgKiBAcGFyYW0ge1N0cmluZ30gaGVhZGVyIFRoZSBoZWFkZXIgbmFtZSB0byByZXRyaWV2ZS4KCSAqIEByZXR1cm4ge1N0cmluZ30KCSAqIEBzaW5jZSAwLjQuMQoJICovCglwLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKGhlYWRlcikgewoJCWlmICh0aGlzLl9yZXF1ZXN0LmdldFJlc3BvbnNlSGVhZGVyIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKCQkJcmV0dXJuIHRoaXMuX3JlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyByZXBvcnRlZCBwcm9ncmVzcy4KCSAqIEBtZXRob2QgX2hhbmRsZVByb2dyZXNzCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBwcm9ncmVzcyBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CgkJaWYgKCFldmVudCB8fCBldmVudC5sb2FkZWQgPiAwICYmIGV2ZW50LnRvdGFsID09IDApIHsKCQkJcmV0dXJuOyAvLyBTb21ldGltZXMgd2UgZ2V0IG5vICJ0b3RhbCIsIHNvIGp1c3QgaWdub3JlIHRoZSBwcm9ncmVzcyBldmVudC4KCQl9CgoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgicHJvZ3Jlc3MiKTsKCQluZXdFdmVudC5sb2FkZWQgPSBldmVudC5sb2FkZWQ7CgkJbmV3RXZlbnQudG90YWwgPSBldmVudC50b3RhbDsKCQl0aGlzLl9zZW5kUHJvZ3Jlc3MobmV3RXZlbnQpOwoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgcmVwb3J0ZWQgYSBsb2FkIHN0YXJ0LgoJICogQG1ldGhvZCBfaGFuZGxlTG9hZFN0YXJ0CgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBsb2FkU3RhcnQgZXZlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9oYW5kbGVMb2FkU3RhcnQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoJCXRoaXMuX3NlbmRMb2FkU3RhcnQoKTsKCX07CgoJLyoqCgkgKiBUaGUgWEhSIHJlcXVlc3QgaGFzIHJlcG9ydGVkIGFuIGFib3J0IGV2ZW50LgoJICogQG1ldGhvZCBoYW5kbGVBYm9ydAoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBYSFIgYWJvcnQgZXZlbnQuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9oYW5kbGVBYm9ydCA9IGZ1bmN0aW9uIChldmVudCkgewoJCXRoaXMuX2NsZWFuKCk7CgkJdmFyIG5ld0V2ZW50ID0gbmV3IGNyZWF0ZWpzLkV2ZW50KCJlcnJvciIpOwoJCW5ld0V2ZW50LnRleHQgPSAiWEhSX0FCT1JURUQiOwoJCXRoaXMuX3NlbmRFcnJvcihuZXdFdmVudCk7Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyByZXBvcnRlZCBhbiBlcnJvciBldmVudC4KCSAqIEBtZXRob2QgX2hhbmRsZUVycm9yCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiBlcnJvciBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUVycm9yID0gZnVuY3Rpb24gKGV2ZW50KSB7CgkJdGhpcy5fY2xlYW4oKTsKCQl2YXIgbmV3RXZlbnQgPSBuZXcgY3JlYXRlanMuRXZlbnQoImVycm9yIik7CgkJLy9UT0RPOiBQcm9wYWdhdGUgZXZlbnQgZXJyb3IKCQl0aGlzLl9zZW5kRXJyb3IobmV3RXZlbnQpOwoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgcmVwb3J0ZWQgYSByZWFkeVN0YXRlIGNoYW5nZS4gTm90ZSB0aGF0IG9sZGVyIGJyb3dzZXJzIChJRSA3ICYgOCkgZG8gbm90IHByb3ZpZGUgYW4gb25sb2FkCgkgKiBldmVudCwgc28gd2UgbXVzdCBtb25pdG9yIHRoZSByZWFkeVN0YXRlQ2hhbmdlIHRvIGRldGVybWluZSBpZiB0aGUgZmlsZSBpcyBsb2FkZWQuCgkgKiBAbWV0aG9kIF9oYW5kbGVSZWFkeVN0YXRlQ2hhbmdlCgkgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgVGhlIFhIUiByZWFkeVN0YXRlQ2hhbmdlIGV2ZW50LgoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlUmVhZHlTdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChldmVudCkgewoJCWlmICh0aGlzLl9yZXF1ZXN0LnJlYWR5U3RhdGUgPT0gNCkgewoJCQl0aGlzLl9oYW5kbGVMb2FkKCk7CgkJfQoJfTsKCgkvKioKCSAqIFRoZSBYSFIgcmVxdWVzdCBoYXMgY29tcGxldGVkLiBUaGlzIGlzIGNhbGxlZCBieSB0aGUgWEhSIHJlcXVlc3QgZGlyZWN0bHksIG9yIGJ5IGEgcmVhZHlTdGF0ZUNoYW5nZSB0aGF0IGhhcwoJICogPGNvZGU+cmVxdWVzdC5yZWFkeVN0YXRlID09IDQ8L2NvZGU+LiBPbmx5IHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgbWV0aG9kIHdpbGwgYmUgcHJvY2Vzc2VkLgoJICogQG1ldGhvZCBfaGFuZGxlTG9hZAoJICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBYSFIgbG9hZCBldmVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZUxvYWQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQlpZiAodGhpcy5sb2FkZWQpIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLmxvYWRlZCA9IHRydWU7CgoJCWlmICghdGhpcy5fY2hlY2tFcnJvcigpKSB7CgkJCXRoaXMuX2hhbmRsZUVycm9yKCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3Jlc3BvbnNlID0gdGhpcy5fZ2V0UmVzcG9uc2UoKTsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBpc0NvbXBsZXRlID0gdGhpcy5fZ2VuZXJhdGVUYWcoKTsKCQlpZiAoaXNDb21wbGV0ZSkgewoJCQl0aGlzLl9zZW5kQ29tcGxldGUoKTsKCQl9Cgl9OwoKCS8qKgoJICogVGhlIFhIUiByZXF1ZXN0IGhhcyB0aW1lZCBvdXQuIFRoaXMgaXMgY2FsbGVkIGJ5IHRoZSBYSFIgcmVxdWVzdCBkaXJlY3RseSwgb3IgdmlhIGEgPGNvZGU+c2V0VGltZW91dDwvY29kZT4KCSAqIGNhbGxiYWNrLgoJICogQG1ldGhvZCBfaGFuZGxlVGltZW91dAoJICogQHBhcmFtIHtPYmplY3R9IFtldmVudF0gVGhlIFhIUiB0aW1lb3V0IGV2ZW50LiBUaGlzIGlzIG9jY2FzaW9uYWxseSBudWxsIHdoZW4gY2FsbGVkIGJ5IHRoZSBiYWNrdXAgc2V0VGltZW91dC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2hhbmRsZVRpbWVvdXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCQl0aGlzLl9jbGVhbigpOwoJCXZhciBuZXdFdmVudCA9IG5ldyBjcmVhdGVqcy5FdmVudCgiZXJyb3IiKTsKCQluZXdFdmVudC50ZXh0ID0gIlBSRUxPQURfVElNRU9VVCI7CgkJLy9UT0RPOiBQcm9wYWdhdGUgYWN0dWFsIGV2ZW50IGVycm9yCgkJdGhpcy5fc2VuZEVycm9yKGV2ZW50KTsKCX07CgoKLy8gUHJvdGVjdGVkCgkvKioKCSAqIERldGVybWluZSBpZiB0aGVyZSBpcyBhbiBlcnJvciBpbiB0aGUgY3VycmVudCBsb2FkLiBUaGlzIGNoZWNrcyB0aGUgc3RhdHVzIG9mIHRoZSByZXF1ZXN0IGZvciBwcm9ibGVtIGNvZGVzLiBOb3RlCgkgKiB0aGF0IHRoaXMgZG9lcyBub3QgY2hlY2sgZm9yIGFuIGFjdHVhbCByZXNwb25zZS4gQ3VycmVudGx5LCBpdCBvbmx5IGNoZWNrcyBmb3IgNDA0IG9yIDAgZXJyb3IgY29kZS4KCSAqIEBtZXRob2QgX2NoZWNrRXJyb3IKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIHRoZSByZXF1ZXN0IHN0YXR1cyByZXR1cm5zIGFuIGVycm9yIGNvZGUuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jaGVja0Vycm9yID0gZnVuY3Rpb24gKCkgewoJCS8vTE06IFByb2JhYmx5IG5lZWQgYWRkaXRpb25hbCBoYW5kbGVycyBoZXJlLCBtYXliZSA1MDEKCQl2YXIgc3RhdHVzID0gcGFyc2VJbnQodGhpcy5fcmVxdWVzdC5zdGF0dXMpOwoKCQlzd2l0Y2ggKHN0YXR1cykgewoJCQljYXNlIDQwNDogICAvLyBOb3QgRm91bmQKCQkJY2FzZSAwOiAgICAgLy8gTm90IExvYWRlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX07CgoJLyoqCgkgKiBWYWxpZGF0ZSB0aGUgcmVzcG9uc2UuIERpZmZlcmVudCBicm93c2VycyBoYXZlIGRpZmZlcmVudCBhcHByb2FjaGVzLCBzb21lIG9mIHdoaWNoIHRocm93IGVycm9ycyB3aGVuIGFjY2Vzc2VkCgkgKiBpbiBvdGhlciBicm93c2Vycy4gSWYgdGhlcmUgaXMgbm8gcmVzcG9uc2UsIHRoZSA8Y29kZT5fcmVzcG9uc2U8L2NvZGU+IHByb3BlcnR5IHdpbGwgcmVtYWluIG51bGwuCgkgKiBAbWV0aG9kIF9nZXRSZXNwb25zZQoJICogQHByaXZhdGUKCSAqLwoJcC5fZ2V0UmVzcG9uc2UgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKHRoaXMuX3Jlc3BvbnNlICE9IG51bGwpIHsKCQkJcmV0dXJuIHRoaXMuX3Jlc3BvbnNlOwoJCX0KCgkJaWYgKHRoaXMuX3JlcXVlc3QucmVzcG9uc2UgIT0gbnVsbCkgewoJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5yZXNwb25zZTsKCQl9CgoJCS8vIEFuZHJvaWQgMi4yIHVzZXMgLnJlc3BvbnNlVGV4dAoJCXRyeSB7CgkJCWlmICh0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlVGV4dCAhPSBudWxsKSB7CgkJCQlyZXR1cm4gdGhpcy5fcmVxdWVzdC5yZXNwb25zZVRleHQ7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJfQoKCQkvLyBXaGVuIGxvYWRpbmcgWE1MLCBJRTkgZG9lcyBub3QgcmV0dXJuIC5yZXNwb25zZSwgaW5zdGVhZCBpdCByZXR1cm5zIHJlc3BvbnNlWE1MLnhtbAoJCS8vVE9ETzogVEVTVAoJCXRyeSB7CgkJCWlmICh0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlWE1MICE9IG51bGwpIHsKCQkJCXJldHVybiB0aGlzLl9yZXF1ZXN0LnJlc3BvbnNlWE1MOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCX0KCQlyZXR1cm4gbnVsbDsKCX07CgoJLyoqCgkgKiBDcmVhdGUgYW4gWEhSIHJlcXVlc3QuIERlcGVuZGluZyBvbiBhIG51bWJlciBvZiBmYWN0b3JzLCB3ZSBnZXQgdG90YWxseSBkaWZmZXJlbnQgcmVzdWx0cy4KCSAqIDxvbD48bGk+U29tZSBicm93c2VycyBnZXQgYW4gPGNvZGU+WERvbWFpblJlcXVlc3Q8L2NvZGU+IHdoZW4gbG9hZGluZyBjcm9zcy1kb21haW4uPC9saT4KCSAqICAgICAgPGxpPlhNTEh0dHBSZXF1ZXN0IGFyZSBjcmVhdGVkIHdoZW4gYXZhaWxhYmxlLjwvbGk+CgkgKiAgICAgIDxsaT5BY3RpdmVYLlhNTEhUVFAgb2JqZWN0cyBhcmUgdXNlZCBpbiBvbGRlciBJRSBicm93c2Vycy48L2xpPgoJICogICAgICA8bGk+VGV4dCByZXF1ZXN0cyBvdmVycmlkZSB0aGUgbWltZSB0eXBlIGlmIHBvc3NpYmxlPC9saT4KCSAqICAgICAgPGxpPk9yaWdpbiBoZWFkZXJzIGFyZSBzZW50IGZvciBjcm9zc2RvbWFpbiByZXF1ZXN0cyBpbiBzb21lIGJyb3dzZXJzLjwvbGk+CgkgKiAgICAgIDxsaT5CaW5hcnkgbG9hZHMgc2V0IHRoZSByZXNwb25zZSB0eXBlIHRvICJhcnJheWJ1ZmZlciI8L2xpPjwvb2w+CgkgKiBAbWV0aG9kIF9jcmVhdGVYSFIKCSAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIFRoZSByZXF1ZXN0ZWQgaXRlbSB0aGF0IGlzIGJlaW5nIGxvYWRlZC4KCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIFhIUiByZXF1ZXN0IG9yIGVxdWl2YWxlbnQgd2FzIHN1Y2Nlc3NmdWxseSBjcmVhdGVkLgoJICogQHByaXZhdGUKCSAqLwoJcC5fY3JlYXRlWEhSID0gZnVuY3Rpb24gKGl0ZW0pIHsKCQkvLyBDaGVjayBmb3IgY3Jvc3MtZG9tYWluIGxvYWRzLiBXZSBjYW4ndCBmdWxseSBzdXBwb3J0IHRoZW0sIGJ1dCB3ZSBjYW4gdHJ5LgoJCXZhciBjcm9zc2RvbWFpbiA9IHRoaXMuX2lzQ3Jvc3NEb21haW4oaXRlbSk7CgkJdmFyIGhlYWRlcnMgPSB7fTsKCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0LiBGYWxsYmFjayB0byB3aGF0ZXZlciBzdXBwb3J0IHdlIGhhdmUuCgkJdmFyIHJlcSA9IG51bGw7CgkJaWYgKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgewoJCQlyZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCQkJLy8gVGhpcyBpcyA4IG9yIDksIHNvIHVzZSBYRG9tYWluUmVxdWVzdCBpbnN0ZWFkLgoJCQlpZiAoY3Jvc3Nkb21haW4gJiYgcmVxLndpdGhDcmVkZW50aWFscyA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5YRG9tYWluUmVxdWVzdCkgewoJCQkJcmVxID0gbmV3IFhEb21haW5SZXF1ZXN0KCk7CgkJCX0KCQl9IGVsc2UgeyAvLyBPbGQgSUUgdmVyc2lvbnMgdXNlIGEgZGlmZmVyZW50IGFwcHJvYWNoCgkJCWZvciAodmFyIGkgPSAwLCBsPXMuQUNUSVZFWF9WRVJTSU9OUy5sZW5ndGg7IGk8bDsgaSsrKSB7CgkgICAgICAgICAgICB2YXIgYXhWZXJzaW9uID0gcy5BQ1RJVkVYX1ZFUlNJT05TW2ldOwoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICByZXEgPSBuZXcgQWN0aXZlWE9iamVjdChheFZlcnNpb25zKTsKCQkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgkgICAgICAgIH0KCQkJaWYgKHJlcSA9PSBudWxsKSB7IHJldHVybiBmYWxzZTsgfQoJCX0KCgkJLy8gSUU5IGRvZXNuJ3Qgc3VwcG9ydCBvdmVycmlkZU1pbWVUeXBlKCksIHNvIHdlIG5lZWQgdG8gY2hlY2sgZm9yIGl0LgoJCWlmIChjcmVhdGVqcy5Mb2FkUXVldWUuaXNUZXh0KGl0ZW0udHlwZSkgJiYgcmVxLm92ZXJyaWRlTWltZVR5cGUpIHsKCQkJcmVxLm92ZXJyaWRlTWltZVR5cGUoInRleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgiKTsKCQl9CgoJCS8vIERldGVybWluZSB0aGUgWEhSIGxldmVsCgkJdGhpcy5feGhyTGV2ZWwgPSAodHlwZW9mIHJlcS5yZXNwb25zZVR5cGUgPT09ICJzdHJpbmciKSA/IDIgOiAxOwoKCQl2YXIgc3JjID0gbnVsbDsKCQlpZiAoaXRlbS5tZXRob2QgPT0gY3JlYXRlanMuTG9hZFF1ZXVlLkdFVCkgewoJCQlzcmMgPSB0aGlzLmJ1aWxkUGF0aChpdGVtLnNyYywgaXRlbS52YWx1ZXMpOwoJCX0gZWxzZSB7CgkJCXNyYyA9IGl0ZW0uc3JjOwoJCX0KCgkJLy8gT3BlbiB0aGUgcmVxdWVzdC4gIFNldCBjcm9zcy1kb21haW4gZmxhZ3MgaWYgaXQgaXMgc3VwcG9ydGVkIChYSFIgbGV2ZWwgMSBvbmx5KQoJCXJlcS5vcGVuKGl0ZW0ubWV0aG9kIHx8IGNyZWF0ZWpzLkxvYWRRdWV1ZS5HRVQsIHNyYywgdHJ1ZSk7CgoJCWlmIChjcm9zc2RvbWFpbiAmJiByZXEgaW5zdGFuY2VvZiBYTUxIdHRwUmVxdWVzdCAmJiB0aGlzLl94aHJMZXZlbCA9PSAxKSB7CgkJCWhlYWRlcnNbIk9yaWdpbiJdID0gbG9jYXRpb24ub3JpZ2luOwoJCX0KCgkJLy8gVG8gc2VuZCBkYXRhIHdlIG5lZWQgdG8gc2V0IHRoZSBDb250ZW50LXR5cGUgaGVhZGVyKQoJCWlmIChpdGVtLnZhbHVlcyAmJiBpdGVtLm1ldGhvZCA9PSBjcmVhdGVqcy5Mb2FkUXVldWUuUE9TVCkgewoJCQloZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiOwoJCX0KCgkJaWYgKCFjcm9zc2RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdKSB7CgkJCWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CgkJfQoKCQlpZiAoaXRlbS5oZWFkZXJzKSB7CgkJCWZvciAodmFyIG4gaW4gaXRlbS5oZWFkZXJzKSB7CgkJCQloZWFkZXJzW25dID0gaXRlbS5oZWFkZXJzW25dOwoJCQl9CgkJfQoKCQkvLyBCaW5hcnkgZmlsZXMgYXJlIGxvYWRlZCBkaWZmZXJlbnRseS4KCQlpZiAoY3JlYXRlanMuTG9hZFF1ZXVlLmlzQmluYXJ5KGl0ZW0udHlwZSkpIHsKCQkJcmVxLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CgkJfQoKCQlmb3IgKG4gaW4gaGVhZGVycykgewoJCQlyZXEuc2V0UmVxdWVzdEhlYWRlcihuLCBoZWFkZXJzW25dKQoJCX0KCgkJdGhpcy5fcmVxdWVzdCA9IHJlcTsKCgkJcmV0dXJuIHRydWU7Cgl9OwoKCS8qKgoJICogQSByZXF1ZXN0IGhhcyBjb21wbGV0ZWQgKG9yIGZhaWxlZCBvciBjYW5jZWxlZCksIGFuZCBuZWVkcyB0byBiZSBkaXNwb3NlZC4KCSAqIEBtZXRob2QgX2NsZWFuCgkgKiBAcHJpdmF0ZQoJICovCglwLl9jbGVhbiA9IGZ1bmN0aW9uICgpIHsKCQljbGVhclRpbWVvdXQodGhpcy5fbG9hZFRpbWVvdXQpOwoKCQl2YXIgcmVxID0gdGhpcy5fcmVxdWVzdDsKCQlyZXEub25sb2Fkc3RhcnQgPSBudWxsOwoJCXJlcS5vbnByb2dyZXNzID0gbnVsbDsKCQlyZXEub25hYm9ydCA9IG51bGw7CgkJcmVxLm9uZXJyb3IgPSBudWxsOwoJCXJlcS5vbmxvYWQgPSBudWxsOwoJCXJlcS5vbnRpbWVvdXQgPSBudWxsOwoJCXJlcS5vbmxvYWRlbmQgPSBudWxsOwoJCXJlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoJfTsKCgkvKioKCSAqIEdlbmVyYXRlIGEgdGFnIGZvciBpdGVtcyB0aGF0IGNhbiBiZSByZXByZXNlbnRlZCBhcyB0YWdzLiBGb3IgZXhhbXBsZSwgSU1BR0UsIFNDUklQVCwgYW5kIExJTksuIFRoaXMgYWxzbyBoYW5kbGVzCgkgKiBYTUwgYW5kIFNWRyBvYmplY3RzLgoJICogQG1ldGhvZCBfZ2VuZXJhdGVUYWcKCSAqIEByZXR1cm4ge0Jvb2xlYW59IElmIGEgdGFnIHdhcyBnZW5lcmF0ZWQgYW5kIGlzIHJlYWR5IGZvciBpbnN0YW50aWF0aW9uLiBJZiBpdCBzdGlsbCBuZWVkcyBwcm9jZXNzaW5nLCB0aGlzCgkgKiBtZXRob2QgcmV0dXJucyBmYWxzZS4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX2dlbmVyYXRlVGFnID0gZnVuY3Rpb24gKCkgewoJCXZhciB0eXBlID0gdGhpcy5faXRlbS50eXBlOwoJCXZhciB0YWcgPSB0aGlzLl9pdGVtLnRhZzsKCgkJc3dpdGNoICh0eXBlKSB7CgkJCS8vIE5vdGU6IEltYWdlcyBuZWVkIHRvIHdhaXQgZm9yIG9ubG9hZCwgYnV0IGRvIHVzZSB0aGUgY2FjaGUuCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLklNQUdFOgoJCQkJdGFnLm9ubG9hZCA9IGNyZWF0ZWpzLnByb3h5KHRoaXMuX2hhbmRsZVRhZ1JlYWR5LCB0aGlzKTsKCQkJCWlmICh0aGlzLl9jcm9zc09yaWdpbiAhPSAiIikgeyB0YWcuY3Jvc3NPcmlnaW4gPSAiQW5vbnltb3VzIjsgfS8vIFdlIGNhbiBhc3N1bWUgdGhpcywgc2luY2UgWEhSIGltYWdlcyBhcmUgYWx3YXlzIGxvYWRlZCBvbiBhIHNlcnZlci4KCQkJCXRhZy5zcmMgPSB0aGlzLmJ1aWxkUGF0aCh0aGlzLl9pdGVtLnNyYywgdGhpcy5faXRlbS52YWx1ZXMpOwoKCQkJCXRoaXMuX3Jhd1Jlc3BvbnNlID0gdGhpcy5fcmVzcG9uc2U7CgkJCQl0aGlzLl9yZXNwb25zZSA9IHRhZzsKCQkJCXJldHVybiBmYWxzZTsgLy8gSW1hZ2VzIG5lZWQgdG8gZ2V0IGFuIG9ubG9hZCBldmVudCBmaXJzdAoKCQkJY2FzZSBjcmVhdGVqcy5Mb2FkUXVldWUuSkFWQVNDUklQVDoKCQkJCXRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoJCQkJdGFnLnRleHQgPSB0aGlzLl9yZXNwb25zZTsKCgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB0YWc7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkNTUzoKCQkJCS8vIE1heWJlIGRvIHRoaXMgY29uZGl0aW9uYWxseT8KCQkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsgLy9Ob3RlOiBUaGlzIGlzIHVuYXZvaWRhYmxlIGluIElFNjc4CgkJCQloZWFkLmFwcGVuZENoaWxkKHRhZyk7CgoJCQkJaWYgKHRhZy5zdHlsZVNoZWV0KSB7IC8vIElFCgkJCQkJdGFnLnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aGlzLl9yZXNwb25zZSk7CgkJCQkJdGFnLmFwcGVuZENoaWxkKHRleHROb2RlKTsKCQkJCX0KCgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB0YWc7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlhNTDoKCQkJCXZhciB4bWwgPSB0aGlzLl9wYXJzZVhNTCh0aGlzLl9yZXNwb25zZSwgInRleHQveG1sIik7CgkJCQl0aGlzLl9yYXdSZXNwb25zZSA9IHRoaXMuX3Jlc3BvbnNlOwoJCQkJdGhpcy5fcmVzcG9uc2UgPSB4bWw7CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLlNWRzoKCQkJCXZhciB4bWwgPSB0aGlzLl9wYXJzZVhNTCh0aGlzLl9yZXNwb25zZSwgImltYWdlL3N2Zyt4bWwiKTsKCQkJCXRoaXMuX3Jhd1Jlc3BvbnNlID0gdGhpcy5fcmVzcG9uc2U7CgkJCQlpZiAoeG1sLmRvY3VtZW50RWxlbWVudCAhPSBudWxsKSB7CgkJCQkJdGFnLmFwcGVuZENoaWxkKHhtbC5kb2N1bWVudEVsZW1lbnQpOwoJCQkJCXRoaXMuX3Jlc3BvbnNlID0gdGFnOwoJCQkJfSBlbHNlIHsgLy8gRm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBTVkcsIGp1c3QgZ2l2ZSB0aGVtIHRoZSBYTUwuIChJRSA5LTgpCgkJCQkJdGhpcy5fcmVzcG9uc2UgPSB4bWw7CgkJCQl9CgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLkpTT046CgkJCWNhc2UgY3JlYXRlanMuTG9hZFF1ZXVlLk1BTklGRVNUOgoJCQkJdmFyIGpzb24gPSB7fTsKCQkJCXRyeSB7CgkJCQkJanNvbiA9IEpTT04ucGFyc2UodGhpcy5fcmVzcG9uc2UpOwoJCQkJfSBjYXRjaCAoZXJyb3IpIHsKCQkJCQlqc29uID0gZXJyb3I7CgkJCQl9CgoJCQkJdGhpcy5fcmF3UmVzcG9uc2UgPSB0aGlzLl9yZXNwb25zZTsKCQkJCXRoaXMuX3Jlc3BvbnNlID0ganNvbjsKCQkJCXJldHVybiB0cnVlOwoKCQl9CgkJcmV0dXJuIHRydWU7Cgl9OwoKCS8qKgoJICogUGFyc2UgWE1MIHVzaW5nIHRoZSBET00uIFRoaXMgaXMgcmVxdWlyZWQgd2hlbiBwcmVsb2FkaW5nIFhNTCBvciBTVkcuCgkgKiBAbWV0aG9kIF9wYXJzZVhNTAoJICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHJhdyB0ZXh0IG9yIFhNTCB0aGF0IGlzIGxvYWRlZCBieSBYSFIuCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgbWltZSB0eXBlIG9mIHRoZSBYTUwuCgkgKiBAcmV0dXJuIHtYTUx9IEFuIFhNTCBkb2N1bWVudC4KCSAqIEBwcml2YXRlCgkgKi8KCXAuX3BhcnNlWE1MID0gZnVuY3Rpb24gKHRleHQsIHR5cGUpIHsKCQl2YXIgeG1sID0gbnVsbDsKCQl0cnkgewoJCQkvLyBDb2Nvb25KUyBkb2VzIG5vdCBzdXBwb3J0IFhNTCBwYXJzaW5nIHdpdGggZWl0aGVyIG1ldGhvZC4KCQkJLy8gV2luZG93cyAoPykgT3BlcmEgRE9NUGFyc2VyIHRocm93cyBET01FeGNlcHRpb246IE5PVF9TVVBQT1JURURfRVJSICAvLyBwb3RlbnRpYWwgc29sdXRpb24gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTEyOTAzMQoJCQlpZiAod2luZG93LkRPTVBhcnNlcikgewoJCQkJdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKCQkJCXhtbCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcodGV4dCwgdHlwZSk7CgkJCX0gZWxzZSB7IC8vIElFCgkJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTERPTSIpOwoJCQkJeG1sLmFzeW5jID0gZmFsc2U7CgkJCQl4bWwubG9hZFhNTCh0ZXh0KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHt9CgkJcmV0dXJuIHhtbDsKCX07CgoJLyoqCgkgKiBBIGdlbmVyYXRlZCB0YWcgaXMgbm93IHJlYWR5IGZvciB1c2UuCgkgKiBAbWV0aG9kIF9oYW5kbGVUYWdSZWFkeQoJICogQHByaXZhdGUKCSAqLwoJcC5faGFuZGxlVGFnUmVhZHkgPSBmdW5jdGlvbiAoKSB7CgkJdmFyIHRhZyA9IHRoaXMuX2l0ZW0udGFnOwoJCXRhZyAmJiAodGFnLm9ubG9hZCA9IG51bGwpOwoJCXRoaXMuX3NlbmRDb21wbGV0ZSgpOwoJfTsKCglwLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewoJCXJldHVybiAiW1ByZWxvYWRKUyBYSFJMb2FkZXJdIjsKCX07CgoJY3JlYXRlanMuWEhSTG9hZGVyID0gWEhSTG9hZGVyOwoKfSgpKTsKCi8qKgogKiBJbmNsdWRlIGpzb24yIGhlcmUsIHRvIGNvcnJlY3RseSBwYXJzZSBqc29uLgogKiBVc2VkIG9uIGJyb3dzZXJzIHRoYXQgZG9uJ3QgaGF2ZSBhIG5hdGl2ZSBKU09OIG9iamVjdC4KICoKICovCi8qCiBqc29uMi5qcwogMjAxMi0xMC0wOAoKIFB1YmxpYyBEb21haW4uCgogTk8gV0FSUkFOVFkgRVhQUkVTU0VEIE9SIElNUExJRUQuIFVTRSBBVCBZT1VSIE9XTiBSSVNLLgoKIFNlZSBodHRwOi8vd3d3LkpTT04ub3JnL2pzLmh0bWwKCgogVGhpcyBjb2RlIHNob3VsZCBiZSBtaW5pZmllZCBiZWZvcmUgZGVwbG95bWVudC4KIFNlZSBodHRwOi8vamF2YXNjcmlwdC5jcm9ja2ZvcmQuY29tL2pzbWluLmh0bWwKCiBVU0UgWU9VUiBPV04gQ09QWS4gSVQgSVMgRVhUUkVNRUxZIFVOV0lTRSBUTyBMT0FEIENPREUgRlJPTSBTRVJWRVJTIFlPVSBETwogTk9UIENPTlRST0wuCiAqLwoKCi8vIENyZWF0ZSBhIEpTT04gb2JqZWN0IG9ubHkgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuIFdlIGNyZWF0ZSB0aGUKLy8gbWV0aG9kcyBpbiBhIGNsb3N1cmUgdG8gYXZvaWQgY3JlYXRpbmcgZ2xvYmFsIHZhcmlhYmxlcy4KCmlmICh0eXBlb2YgSlNPTiAhPT0gJ29iamVjdCcpIHsKCUpTT04gPSB7fTsKfQoKKGZ1bmN0aW9uICgpIHsKCSd1c2Ugc3RyaWN0JzsKCglmdW5jdGlvbiBmKG4pIHsKCQkvLyBGb3JtYXQgaW50ZWdlcnMgdG8gaGF2ZSBhdCBsZWFzdCB0d28gZGlnaXRzLgoJCXJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKCX0KCglpZiAodHlwZW9mIERhdGUucHJvdG90eXBlLnRvSlNPTiAhPT0gJ2Z1bmN0aW9uJykgewoKCQlEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CgoJCQlyZXR1cm4gaXNGaW5pdGUodGhpcy52YWx1ZU9mKCkpCgkJCQkJPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgKyAnLScgKwoJCQkJCWYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwoJCQkJCWYodGhpcy5nZXRVVENEYXRlKCkpICsgJ1QnICsKCQkJCQlmKHRoaXMuZ2V0VVRDSG91cnMoKSkgKyAnOicgKwoJCQkJCWYodGhpcy5nZXRVVENNaW51dGVzKCkpICsgJzonICsKCQkJCQlmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSArICdaJwoJCQkJCTogbnVsbDsKCQl9OwoKCQlTdHJpbmcucHJvdG90eXBlLnRvSlNPTiA9CgkJCQlOdW1iZXIucHJvdG90eXBlLnRvSlNPTiA9CgkJCQkJCUJvb2xlYW4ucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIChrZXkpIHsKCQkJCQkJCXJldHVybiB0aGlzLnZhbHVlT2YoKTsKCQkJCQkJfTsKCX0KCgl2YXIgY3ggPSAvW1x1MDAwMFx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAoJCQllc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKCQkJZ2FwLAoJCQlpbmRlbnQsCgkJCW1ldGEgPSB7ICAgIC8vIHRhYmxlIG9mIGNoYXJhY3RlciBzdWJzdGl0dXRpb25zCgkJCQknXGInOidcXGInLAoJCQkJJ1x0JzonXFx0JywKCQkJCSdcbic6J1xcbicsCgkJCQknXGYnOidcXGYnLAoJCQkJJ1xyJzonXFxyJywKCQkJCSciJzonXFwiJywKCQkJCSdcXCc6J1xcXFwnCgkJCX0sCgkJCXJlcDsKCgoJZnVuY3Rpb24gcXVvdGUoc3RyaW5nKSB7CgovLyBJZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG5vIGNvbnRyb2wgY2hhcmFjdGVycywgbm8gcXVvdGUgY2hhcmFjdGVycywgYW5kIG5vCi8vIGJhY2tzbGFzaCBjaGFyYWN0ZXJzLCB0aGVuIHdlIGNhbiBzYWZlbHkgc2xhcCBzb21lIHF1b3RlcyBhcm91bmQgaXQuCi8vIE90aGVyd2lzZSB3ZSBtdXN0IGFsc28gcmVwbGFjZSB0aGUgb2ZmZW5kaW5nIGNoYXJhY3RlcnMgd2l0aCBzYWZlIGVzY2FwZQovLyBzZXF1ZW5jZXMuCgoJCWVzY2FwYWJsZS5sYXN0SW5kZXggPSAwOwoJCXJldHVybiBlc2NhcGFibGUudGVzdChzdHJpbmcpID8gJyInICsgc3RyaW5nLnJlcGxhY2UoZXNjYXBhYmxlLCBmdW5jdGlvbiAoYSkgewoJCQl2YXIgYyA9IG1ldGFbYV07CgkJCXJldHVybiB0eXBlb2YgYyA9PT0gJ3N0cmluZycKCQkJCQk/IGMKCQkJCQk6ICdcXHUnICsgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKCQl9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKCX0KCgoJZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgovLyBQcm9kdWNlIGEgc3RyaW5nIGZyb20gaG9sZGVyW2tleV0uCgoJCXZhciBpLCAvLyBUaGUgbG9vcCBjb3VudGVyLgoJCQkJaywgLy8gVGhlIG1lbWJlciBrZXkuCgkJCQl2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgoJCQkJbGVuZ3RoLAoJCQkJbWluZCA9IGdhcCwKCQkJCXBhcnRpYWwsCgkJCQl2YWx1ZSA9IGhvbGRlcltrZXldOwoKLy8gSWYgdGhlIHZhbHVlIGhhcyBhIHRvSlNPTiBtZXRob2QsIGNhbGwgaXQgdG8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgoJCWlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmCgkJCQl0eXBlb2YgdmFsdWUudG9KU09OID09PSAnZnVuY3Rpb24nKSB7CgkJCXZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CgkJfQoKLy8gSWYgd2Ugd2VyZSBjYWxsZWQgd2l0aCBhIHJlcGxhY2VyIGZ1bmN0aW9uLCB0aGVuIGNhbGwgdGhlIHJlcGxhY2VyIHRvCi8vIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKCQlpZiAodHlwZW9mIHJlcCA9PT0gJ2Z1bmN0aW9uJykgewoJCQl2YWx1ZSA9IHJlcC5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CgkJfQoKLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKCQlzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewoJCQljYXNlICdzdHJpbmcnOgoJCQkJcmV0dXJuIHF1b3RlKHZhbHVlKTsKCgkJCWNhc2UgJ251bWJlcic6CgovLyBKU09OIG51bWJlcnMgbXVzdCBiZSBmaW5pdGUuIEVuY29kZSBub24tZmluaXRlIG51bWJlcnMgYXMgbnVsbC4KCgkJCQlyZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCgkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQljYXNlICdudWxsJzoKCi8vIElmIHRoZSB2YWx1ZSBpcyBhIGJvb2xlYW4gb3IgbnVsbCwgY29udmVydCBpdCB0byBhIHN0cmluZy4gTm90ZToKLy8gdHlwZW9mIG51bGwgZG9lcyBub3QgcHJvZHVjZSAnbnVsbCcuIFRoZSBjYXNlIGlzIGluY2x1ZGVkIGhlcmUgaW4KLy8gdGhlIHJlbW90ZSBjaGFuY2UgdGhhdCB0aGlzIGdldHMgZml4ZWQgc29tZWRheS4KCgkJCQlyZXR1cm4gU3RyaW5nKHZhbHVlKTsKCi8vIElmIHRoZSB0eXBlIGlzICdvYmplY3QnLCB3ZSBtaWdodCBiZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IG9yIGFuIGFycmF5IG9yCi8vIG51bGwuCgoJCQljYXNlICdvYmplY3QnOgoKLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAovLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCgkJCQlpZiAoIXZhbHVlKSB7CgkJCQkJcmV0dXJuICdudWxsJzsKCQkJCX0KCi8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCgkJCQlnYXAgKz0gaW5kZW50OwoJCQkJcGFydGlhbCA9IFtdOwoKLy8gSXMgdGhlIHZhbHVlIGFuIGFycmF5PwoKCQkJCWlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKLy8gVGhlIHZhbHVlIGlzIGFuIGFycmF5LiBTdHJpbmdpZnkgZXZlcnkgZWxlbWVudC4gVXNlIG51bGwgYXMgYSBwbGFjZWhvbGRlcgovLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKCQkJCQlsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgkJCQkJZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CgkJCQkJCXBhcnRpYWxbaV0gPSBzdHIoaSwgdmFsdWUpIHx8ICdudWxsJzsKCQkJCQl9CgovLyBKb2luIGFsbCBvZiB0aGUgZWxlbWVudHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywgYW5kIHdyYXAgdGhlbSBpbgovLyBicmFja2V0cy4KCgkJCQkJdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwCgkJCQkJCQk/ICdbXScKCQkJCQkJCTogZ2FwCgkJCQkJCQk/ICdbXG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArICdcbicgKyBtaW5kICsgJ10nCgkJCQkJCQk6ICdbJyArIHBhcnRpYWwuam9pbignLCcpICsgJ10nOwoJCQkJCWdhcCA9IG1pbmQ7CgkJCQkJcmV0dXJuIHY7CgkJCQl9CgovLyBJZiB0aGUgcmVwbGFjZXIgaXMgYW4gYXJyYXksIHVzZSBpdCB0byBzZWxlY3QgdGhlIG1lbWJlcnMgdG8gYmUgc3RyaW5naWZpZWQuCgoJCQkJaWYgKHJlcCAmJiB0eXBlb2YgcmVwID09PSAnb2JqZWN0JykgewoJCQkJCWxlbmd0aCA9IHJlcC5sZW5ndGg7CgkJCQkJZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CgkJCQkJCWlmICh0eXBlb2YgcmVwW2ldID09PSAnc3RyaW5nJykgewoJCQkJCQkJayA9IHJlcFtpXTsKCQkJCQkJCXYgPSBzdHIoaywgdmFsdWUpOwoJCQkJCQkJaWYgKHYpIHsKCQkJCQkJCQlwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgovLyBPdGhlcndpc2UsIGl0ZXJhdGUgdGhyb3VnaCBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG9iamVjdC4KCgkJCQkJZm9yIChrIGluIHZhbHVlKSB7CgkJCQkJCWlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CgkJCQkJCQl2ID0gc3RyKGssIHZhbHVlKTsKCQkJCQkJCWlmICh2KSB7CgkJCQkJCQkJcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgovLyBKb2luIGFsbCBvZiB0aGUgbWVtYmVyIHRleHRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsCi8vIGFuZCB3cmFwIHRoZW0gaW4gYnJhY2VzLgoKCQkJCXYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMAoJCQkJCQk/ICd7fScKCQkJCQkJOiBnYXAKCQkJCQkJPyAne1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKyAnXG4nICsgbWluZCArICd9JwoJCQkJCQk6ICd7JyArIHBhcnRpYWwuam9pbignLCcpICsgJ30nOwoJCQkJZ2FwID0gbWluZDsKCQkJCXJldHVybiB2OwoJCX0KCX0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKCWlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKCQlKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKCQkJdmFyIGk7CgkJCWdhcCA9ICcnOwoJCQlpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgoJCQlpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewoJCQkJZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKCQkJCQlpbmRlbnQgKz0gJyAnOwoJCQkJfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKCQkJfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CgkJCQlpbmRlbnQgPSBzcGFjZTsKCQkJfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKCQkJcmVwID0gcmVwbGFjZXI7CgkJCWlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKCQkJCQkodHlwZW9mIHJlcGxhY2VyICE9PSAnb2JqZWN0JyB8fAoJCQkJCQkJdHlwZW9mIHJlcGxhY2VyLmxlbmd0aCAhPT0gJ251bWJlcicpKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CgkJCX0KCi8vIE1ha2UgYSBmYWtlIHJvb3Qgb2JqZWN0IGNvbnRhaW5pbmcgb3VyIHZhbHVlIHVuZGVyIHRoZSBrZXkgb2YgJycuCi8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgoJCQlyZXR1cm4gc3RyKCcnLCB7Jyc6dmFsdWV9KTsKCQl9OwoJfQoKCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHBhcnNlIG1ldGhvZCwgZ2l2ZSBpdCBvbmUuCgoJaWYgKHR5cGVvZiBKU09OLnBhcnNlICE9PSAnZnVuY3Rpb24nKSB7CgkJSlNPTi5wYXJzZSA9IGZ1bmN0aW9uICh0ZXh0LCByZXZpdmVyKSB7CgovLyBUaGUgcGFyc2UgbWV0aG9kIHRha2VzIGEgdGV4dCBhbmQgYW4gb3B0aW9uYWwgcmV2aXZlciBmdW5jdGlvbiwgYW5kIHJldHVybnMKLy8gYSBKYXZhU2NyaXB0IHZhbHVlIGlmIHRoZSB0ZXh0IGlzIGEgdmFsaWQgSlNPTiB0ZXh0LgoKCQkJdmFyIGo7CgoJCQlmdW5jdGlvbiB3YWxrKGhvbGRlciwga2V5KSB7CgovLyBUaGUgd2FsayBtZXRob2QgaXMgdXNlZCB0byByZWN1cnNpdmVseSB3YWxrIHRoZSByZXN1bHRpbmcgc3RydWN0dXJlIHNvCi8vIHRoYXQgbW9kaWZpY2F0aW9ucyBjYW4gYmUgbWFkZS4KCgkJCQl2YXIgaywgdiwgdmFsdWUgPSBob2xkZXJba2V5XTsKCQkJCWlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CgkJCQkJZm9yIChrIGluIHZhbHVlKSB7CgkJCQkJCWlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CgkJCQkJCQl2ID0gd2Fsayh2YWx1ZSwgayk7CgkJCQkJCQlpZiAodiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCQkJdmFsdWVba10gPSB2OwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlkZWxldGUgdmFsdWVba107CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gcmV2aXZlci5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CgkJCX0KCgovLyBQYXJzaW5nIGhhcHBlbnMgaW4gZm91ciBzdGFnZXMuIEluIHRoZSBmaXJzdCBzdGFnZSwgd2UgcmVwbGFjZSBjZXJ0YWluCi8vIFVuaWNvZGUgY2hhcmFjdGVycyB3aXRoIGVzY2FwZSBzZXF1ZW5jZXMuIEphdmFTY3JpcHQgaGFuZGxlcyBtYW55IGNoYXJhY3RlcnMKLy8gaW5jb3JyZWN0bHksIGVpdGhlciBzaWxlbnRseSBkZWxldGluZyB0aGVtLCBvciB0cmVhdGluZyB0aGVtIGFzIGxpbmUgZW5kaW5ncy4KCgkJCXRleHQgPSBTdHJpbmcodGV4dCk7CgkJCWN4Lmxhc3RJbmRleCA9IDA7CgkJCWlmIChjeC50ZXN0KHRleHQpKSB7CgkJCQl0ZXh0ID0gdGV4dC5yZXBsYWNlKGN4LCBmdW5jdGlvbiAoYSkgewoJCQkJCXJldHVybiAnXFx1JyArCgkJCQkJCQkoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwoJCQkJfSk7CgkJCX0KCi8vIEluIHRoZSBzZWNvbmQgc3RhZ2UsIHdlIHJ1biB0aGUgdGV4dCBhZ2FpbnN0IHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rCi8vIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkgY29uY2VybmVkIHdpdGggJygpJyBhbmQgJ25ldycKLy8gYmVjYXVzZSB0aGV5IGNhbiBjYXVzZSBpbnZvY2F0aW9uLCBhbmQgJz0nIGJlY2F1c2UgaXQgY2FuIGNhdXNlIG11dGF0aW9uLgovLyBCdXQganVzdCB0byBiZSBzYWZlLCB3ZSB3YW50IHRvIHJlamVjdCBhbGwgdW5leHBlY3RlZCBmb3Jtcy4KCi8vIFdlIHNwbGl0IHRoZSBzZWNvbmQgc3RhZ2UgaW50byA0IHJlZ2V4cCBvcGVyYXRpb25zIGluIG9yZGVyIHRvIHdvcmsgYXJvdW5kCi8vIGNyaXBwbGluZyBpbmVmZmljaWVuY2llcyBpbiBJRSdzIGFuZCBTYWZhcmkncyByZWdleHAgZW5naW5lcy4gRmlyc3Qgd2UKLy8gcmVwbGFjZSB0aGUgSlNPTiBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQovLyByZXBsYWNlIGFsbCBzaW1wbGUgdmFsdWUgdG9rZW5zIHdpdGggJ10nIGNoYXJhY3RlcnMuIFRoaXJkLCB3ZSBkZWxldGUgYWxsCi8vIG9wZW4gYnJhY2tldHMgdGhhdCBmb2xsb3cgYSBjb2xvbiBvciBjb21tYSBvciB0aGF0IGJlZ2luIHRoZSB0ZXh0LiBGaW5hbGx5LAovLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgovLyAnLCcgb3IgJzonIG9yICd7JyBvciAnfScuIElmIHRoYXQgaXMgc28sIHRoZW4gdGhlIHRleHQgaXMgc2FmZSBmb3IgZXZhbC4KCgkJCWlmICgvXltcXSw6e31cc10qJC8KCQkJCQkudGVzdCh0ZXh0LnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKQoJCQkJCQkJCSAgLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAnXScpCgkJCQkJCQkJICAucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJykpKSB7CgovLyBJbiB0aGUgdGhpcmQgc3RhZ2Ugd2UgdXNlIHRoZSBldmFsIGZ1bmN0aW9uIHRvIGNvbXBpbGUgdGhlIHRleHQgaW50byBhCi8vIEphdmFTY3JpcHQgc3RydWN0dXJlLiBUaGUgJ3snIG9wZXJhdG9yIGlzIHN1YmplY3QgdG8gYSBzeW50YWN0aWMgYW1iaWd1aXR5Ci8vIGluIEphdmFTY3JpcHQ6IGl0IGNhbiBiZWdpbiBhIGJsb2NrIG9yIGFuIG9iamVjdCBsaXRlcmFsLiBXZSB3cmFwIHRoZSB0ZXh0Ci8vIGluIHBhcmVucyB0byBlbGltaW5hdGUgdGhlIGFtYmlndWl0eS4KCgkJCQlqID0gZXZhbCgnKCcgKyB0ZXh0ICsgJyknKTsKCi8vIEluIHRoZSBvcHRpb25hbCBmb3VydGggc3RhZ2UsIHdlIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIG5ldyBzdHJ1Y3R1cmUsIHBhc3NpbmcKLy8gZWFjaCBuYW1lL3ZhbHVlIHBhaXIgdG8gYSByZXZpdmVyIGZ1bmN0aW9uIGZvciBwb3NzaWJsZSB0cmFuc2Zvcm1hdGlvbi4KCgkJCQlyZXR1cm4gdHlwZW9mIHJldml2ZXIgPT09ICdmdW5jdGlvbicKCQkJCQkJPyB3YWxrKHsnJzpqfSwgJycpCgkJCQkJCTogajsKCQkJfQoKLy8gSWYgdGhlIHRleHQgaXMgbm90IEpTT04gcGFyc2VhYmxlLCB0aGVuIGEgU3ludGF4RXJyb3IgaXMgdGhyb3duLgoKCQkJdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKU09OLnBhcnNlJyk7CgkJfTsKCX0KfSgpKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 19:36:54 GMT",
                    "Content-Length": "161733",
                    "Date": "Thu, 06 Nov 2014 19:36:55 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}